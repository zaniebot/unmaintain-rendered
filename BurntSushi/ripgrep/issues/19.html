<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hangs when searching recursively under Cygwin - BurntSushi/ripgrep #19</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Hangs when searching recursively under Cygwin</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/19">#19</a>
        opened by <a href="https://github.com/vadz">@vadz</a>
        on 2016-09-23 16:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/vadz">@vadz</a></div>
            <div class="timeline-body"><p>This is rather mysterious but the first thing I did after installing the Windows binary (<code>ripgrep-0.1.17-x86_64-pc-windows-msvc.zip</code>) was to run <code>rg fun</code> from Cygwin shell inside a relatively big repository and it just hung without outputting anything. Trying to search inside a single file works fine, searching in a single leaf subdirectory does too, but searching under a subdirectory containing other subdirectories outputs a number of matches and then hangs on exit. To emphasize, this only happens in a Cygwin shell, the tool doesn&#x27;t hang when run from the standard Windows DOS window.</p>
<p>Looking at it in process explorer I see that the thread is completely stuck (0% CPU use) and the stack is</p>
<pre><code>ntoskrnl.exe!KiSwapContext+0x7a
ntoskrnl.exe!KiCommitThreadWait+0x1d2
ntoskrnl.exe!KeWaitForSingleObject+0x19f
ntoskrnl.exe!KiSuspendThread+0x54
ntoskrnl.exe!KiDeliverApc+0x21d
ntoskrnl.exe!KiCommitThreadWait+0x3dd
ntoskrnl.exe!KeWaitForSingleObject+0x19f
ntoskrnl.exe!NtReadFile+0x8ae
ntoskrnl.exe!KiSystemServiceCopyEnd+0x13
ntdll.dll!NtReadFile+0xa
KERNELBASE.dll!ReadFile+0x76
kernel32.dll!ReadFileImplementation+0x55
rg.exe+0x124f1f
</code></pre>
<p>which doesn&#x27;t make much sense to me, but maybe it can be useful to you if you have the map file and see what does <code>0x124f1f</code> offset correspond to.</p>
<p>I could try debugging this further later, but unfortunately I really don&#x27;t have time for this now, I just wanted to quickly check a promising new tool...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-24 02:15</div>
            <div class="timeline-body"><p>If you do <code>rg .</code>, does that hang as well?</p>
<p>I&#x27;m wondering if this is a dupe of #27. (I have run <code>rg</code> from a cygwin shell before too, and it worked fine.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vadz">@vadz</a> on 2016-09-24 02:19</div>
            <div class="timeline-body"><p>You&#x27;re right, <code>rg fun .</code> works, so it does seem to be a (time travelling :-) dupe of #27.</p>
<p>I still have trouble understanding what&#x27;s going on with <code>rg fun src</code> though, it&#x27;s weirder than I thought: in this case the <code>rg</code> process exits, but the shell remains waiting for it somehow. Equally (more? less? I&#x27;m not sure of anything any more) weirdly, <code>rg -w fun src</code> works without any problems. And so does <code>rg fun src/common</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-24 02:23</div>
            <div class="timeline-body"><p>I have no clue. I can&#x27;t think of any reason why the presence or absence of <code>-w</code> would have anything to do with the termination of <code>rg</code>. :-(</p>
<p>I will try to fire up a cygwin shell soon and see how rg behaves.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vadz">@vadz</a> on 2016-09-24 02:26</div>
            <div class="timeline-body"><p>TIA! If you&#x27;d like to use exactly the same data as I do for reproducing the problem, I&#x27;m running the command in a checkout of <a href="https://github.com/wxWidgets/wxWidgets.git">wxWidgets</a> in 32 bit Cygwin zsh.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-24 02:27</div>
            <div class="timeline-body"><p>Thank you so much for that tidbit. I&#x27;ve gotten so used to people running <code>rg</code> on their own private data that I didn&#x27;t even think to ask. Yay!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CryZe">@CryZe</a> on 2016-09-25 02:15</div>
            <div class="timeline-body"><p>Seems like I have the same problem with a msys2 shell (the workaround works for me as well).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-25 02:24</div>
            <div class="timeline-body"><p>For the folks on Windows, does <code>rg</code> work in a standard command prompt?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wjrogers">@wjrogers</a> on 2016-09-25 02:45</div>
            <div class="timeline-body"><p>Yes, it works normally in the Windows Command Prompt. It hangs in mintty.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-25 22:37</div>
            <div class="timeline-body"><p>Ah! I can reproduce this, yay. The reason why I hadn&#x27;t seen this before was because I was SSHing into my Windows VM. If I actually open the cygwin terminal and run <code>rg</code> there, it does indeed hang.</p>
<p>FYI, it &quot;hangs&quot; because it&#x27;s sitting waiting for stdin, so something is buggy in the tty detection.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-25 22:55</div>
            <div class="timeline-body"><p>So it occurs to me that I have no clue how to determine whether something is being piped to <code>stdin</code> on Windows or not. I was using <a href="https://github.com/BurntSushi/ripgrep/blob/9395076468b7cff1421392dec118e08073b49214/src/atty.rs#L42-L52">this approach</a>, but it seems to be reporting <code>stdin</code> as a pipe even when there isn&#x27;t one.</p>
<p>I think what I&#x27;m going to do is switch the failure modes. That is, always assume <code>stdin</code> is a tty <em>on Windows</em>. This means the only way to search <code>stdin</code> on Windows is by specifying <code>-</code> in the file path list.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vadz">@vadz</a> on 2016-09-25 23:29</div>
            <div class="timeline-body"><p>Oh, sorry, I should have thought about this, this is actually a pretty well-known issue -- but without any good solution, unfortunately. The problem is that Windows doesn&#x27;t have any concept of PTY, so when a program is running in any kind of terminal emulator, and not the standard console window, its stdin is always connected to a pipe, as far as Windows is concerned. Cygwin applications can distinguish between &quot;real&quot; pipes and normal input from the terminal, but I don&#x27;t know of any way to do this without linking to <code>cygwin1.dll</code>.</p>
<p>I think you should still be able to detect whether stdin is a TTY when running inside the native console and you should be able to check for this (running inside console, I mean). But everything console-related in Windows is pretty hairy, just look at <a href="https://github.com/wxWidgets/wxWidgets/blob/v3.1.0/src/msw/app.cpp#L288">our own code</a> for detecting whether we can <em>write</em> to a console...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-26 00:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-26 00:02</div>
            <div class="timeline-body"><p>I&#x27;ve fixed this, but created a new bug in the process, under the premise that this bug is worse than #94.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/silverwind">@silverwind</a> on 2016-10-07 17:49</div>
            <div class="timeline-body"><p>I think it might be better to revert this fix and instruct Cygwin users to compile from source using <code>cargo</code> from the GNU build of Rust. Using native Windows binaries in Cygwin (which aims to provide POSIX compat first, Windows second) is just bad practice.</p>
<p>Of course, it&#x27;d also be an option to provide prebuilt Cygwin binaries to hopefully solve this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-10-07 19:04</div>
            <div class="timeline-body"><p>Could you please explain why, in detail that would fix this issue? Does it actually fix it for you?</p>
<p>Having <code>rg</code> hang indefinitely on its <em>core use case</em> is unacceptable. Almost any other bug (including butchering handling <code>stdin</code> automatically) is preferable.</p>
<p>Obviously, we&#x27;d like both things to work. As I&#x27;ve stated, I don&#x27;t know how to do that. Others have given me some threads to pull on, but I haven&#x27;t had time to look into it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/silverwind">@silverwind</a> on 2016-10-07 19:40</div>
            <div class="timeline-body"><p>I&#x27;ll try to build with the fix reverted, it&#x27;s just a wild guess at this point.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:00 UTC
    </footer>
</body>
</html>
