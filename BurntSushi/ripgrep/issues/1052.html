<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panic when searching Ruby language interpreter source code - BurntSushi/ripgrep #1052</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Panic when searching Ruby language interpreter source code</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/1052">#1052</a>
        opened by <a href="https://github.com/jackc">@jackc</a>
        on 2018-09-13 17:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jackc">@jackc</a></div>
            <div class="timeline-body"><h4>What version of ripgrep are you using?</h4>
<pre><code>jack@happy:~/Downloads/ruby-2.5.1$ rg --version
ripgrep 0.10.0
-SIMD -AVX (compiled)
+SIMD +AVX (runtime)
</code></pre>
<h4>How did you install ripgrep?</h4>
<p><code>cargo install ripgrep</code></p>
<h4>What operating system are you using ripgrep on?</h4>
<p>Ubuntu 18.04.1</p>
<pre><code>jack@happy:~/Downloads/ruby-2.5.1$ uname -a
Linux happy 4.15.0-33-generic #36-Ubuntu SMP Wed Aug 15 16:00:05 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
</code></pre>
<h4>If this is a bug, what are the steps to reproduce the behavior?</h4>
<p>Download Ruby source code and search in it's directory.</p>
<pre><code>jack@happy:/tmp$ curl --silent https://cache.ruby-lang.org/pub/ruby/2.5/ruby-2.5.1.tar.gz &gt; ruby-2.5.1.tar.gz
jack@happy:/tmp$ tar xf ruby-2.5.1.tar.gz 
jack@happy:/tmp$ cd ruby-2.5.1/
jack@happy:/tmp/ruby-2.5.1$ rg foobarbazquz
thread '&lt;unnamed&gt;' panicked at 'index out of bounds: the len is 1 but the index is 1', /home/jack/.cargo/registry/src/github.com-1ecc6299db9ec823/encoding_rs-0.8.6/src/handles.rs:309:21
note: Run with `RUST_BACKTRACE=1` for a backtrace.
^C
</code></pre>
<p>Process then is hung.</p>
<h4>If this is a bug, what is the actual behavior?</h4>
<p>Command: <code>rg --debug foobarbazquz</code></p>
<p>Output: https://gist.github.com/jackc/06e3cd8ce8ae238e6762249564cc1a76</p>
<h4>If this is a bug, what is the expected behavior?</h4>
<p>Not panic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-09-13 17:30</div>
            <div class="timeline-body"><p>Interesting! It looks like the panic is coming from inside <code>encoding_rs</code>, but it could still be ripgrep's fault. I'll need to dig into this and come up with a smaller reproduction. Thanks for reporting this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @BurntSushi on 2018-09-13 17:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-09-25 01:05</div>
            <div class="timeline-body"><p>A smaller reproduction of this bug:</p>
<pre><code>$ rg ZZZZZ ruby-2.5.1/test/rexml/data/t63-2.svg
</code></pre>
<p>It turns out that this svg file starts with a UTF-16LE BOM, but does not actually appear to be UTF-16. In any case, this trips over a corner case in the streaming transcoder that in turn causes a panic. The fault is either in my implementation of the streaming transcoder (by not upholding some precondition of the transcoder) or in the implementation of the encoding handling itself. Either way, I filed a bug to get to the bottom of it: https://github.com/hsivonen/encoding_rs/issues/34</p>
<p>For now, I <a href="https://github.com/BurntSushi/encoding_rs_io/commit/8405b0f9aeacd35dfdb3f02a522454eb25ee3773">patched this via a work-around in the streaming transcoder</a>, although it's not clear that the root cause has been fixed. PR #1065 brings in the workaround to ripgrep.</p>
<p>Thanks so much for reporting this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2018-09-25 20:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:42:41 UTC
    </footer>
</body>
</html>
