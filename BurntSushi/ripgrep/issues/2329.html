<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ripgrep ignores files matching gitignore patterns even if they are staged or committed - BurntSushi/ripgrep #2329</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ripgrep ignores files matching gitignore patterns even if they are staged or committed</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/2329">#2329</a>
        opened by <a href="https://github.com/Munksgaard">@Munksgaard</a>
        on 2022-10-10 13:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Munksgaard">@Munksgaard</a></div>
            <div class="timeline-body">What version of ripgrep are you using?
<pre><code>$ rg --version
ripgrep 13.0.0
-SIMD -AVX (compiled)
+SIMD +AVX (runtime)
</code></pre>
How did you install ripgrep?
<p>I installed ripgrep through NixOS/nixpkgs</p>
What operating system are you using ripgrep on?
<pre><code>$ uname -a
Linux church 5.15.63 #1-NixOS SMP Thu Aug 25 09:40:49 UTC 2022 x86_64 GNU/Linux
</code></pre>
Describe your bug.
<p>Negated patterns are not implemented correctly</p>
What are the steps to reproduce the behavior?
<p>In <a href="https://github.com/diku-dk/futhark/">our project</a> we have a <a href="https://github.com/diku-dk/futhark/blob/master/.gitignore"><code>.gitignore</code></a> file at the root of the repository. The first few lines serve to ignore all the <em>files</em> in the root. The purpose is to enable using the root as a scratch space for programs, debug-output etc. However, crucially, the <code>.gitignore</code> rules do not prevent git from recognizing when some of the files that actually are checked in are changed.</p>
<p>It seems as if ripgrep does not follow this behavior. Consider the following example:</p>
<pre><code>$ mkdir rgtest
$ cd rgtest/
$ git init
Initialized empty Git repository in /home/munksgaard/rgtest/.git/
$ echo &quot;KAWABUNGA&quot; &gt; README.md
$ git add README.md
$ echo &#x27;# Ignore non-directories in root, so you can use it as scratch space.
/*
!/*/
&#x27; &gt; .gitignore
$ rg KAWABUNGA
$ git status
On branch master

No commits yet

Changes to be committed:
  (use &quot;git rm --cached &lt;file&gt;...&quot; to unstage)
	new file:   README.md


$ echo &quot;Yowza&quot; &gt;&gt; README.md

$ rg Yowza
</code></pre>
<p>Here, because README.md is staged (though the behavior should be the same when it is committed), we actually do want ripgrep to search the text contained therein, but that does not happen.</p>
<p>The culprit is the double lines of</p>
<pre><code>/*
!/*/
</code></pre>
<p>in the <code>.gitignore</code> file. The first line ignores everything in the root, whereas the second line explicitly unignores all directories (and by extension all files contained therein).</p>
<p>In both of the <code>rg</code> calls in the example above I would expect to see the <code>README.md</code> file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Munksgaard">@Munksgaard</a> on 2022-10-10 13:59</div>
            <div class="timeline-body"><p>While similar to #1654, I <em>think</em> this issue is different, because we&#x27;ve not ignored the parent directory of the files in the root (how could we), just all of the files (and directories) therein.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2022-10-10 14:22</div>
            <div class="timeline-body"><p>This is correct and it has nothing to do with the implementation of negated patterns. You should try running ripgrep with <code>--debug</code> (it&#x27;s why it&#x27;s recommended in the issue template). You&#x27;ll see this line:</p>
<pre><code>DEBUG|ignore::walk|crates/ignore/src/walk.rs:1741: ignoring ./README.md: Ignore(IgnoreMatch(Gitignore(Glob { from: Some(&quot;./.gitignore&quot;), original: &quot;/*&quot;, actual: &quot;*&quot;, is_whitelist: false, is_only_dir: false })))
</code></pre>
<p><code>README.md</code> matches <code>/*</code> and does not match <code>/*/</code>, so it is ignored and this is correct.</p>
<p>The issue here is not that negated patterns aren&#x27;t working as you expect, but that ripgrep respects <em>only</em> your gitignore and not what is actually staged or committed in your git repo. In other words, your gitignore file is <em>out of sync</em> with what is tracked by git. This isn&#x27;t necessarily a problem with git because once a file is tracked, it is effectively unignored. But ripgrep doesn&#x27;t (and will never) know it is tracked because all it looks at is the gitignore files.</p>
<p>I suggest explicitly whitelisting files you track in your <code>.gitignore</code>.</p>
<p>Also, as an additional note, your rules here are pretty broad. Namely, <code>!/*/</code> will whitelist hidden directories such as <code>.git</code>, and thus cause ripgrep to search them. You&#x27;ll want to add <code>/.git</code> below <code>!/*/</code> to ignore it again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2022-10-10 14:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wontfix</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2022-10-10 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Munksgaard">@Munksgaard</a> on 2022-10-10 14:24</div>
            <div class="timeline-body"><p>@BurntSushi Thank you for the quick and thorough reply. You&#x27;re right, we should probably just change our <code>.gitignore</code>....</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Negated patterns bug&quot; to &quot;ripgrep ignores files matching gitignore patterns even if they are staged or committed&quot; by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2022-10-10 14:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:12 UTC
    </footer>
</body>
</html>
