<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ignore] Add API for adding glob patterns to ignore - BurntSushi/ripgrep #2705</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ignore] Add API for adding glob patterns to ignore</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/2705">#2705</a>
        opened by <a href="https://github.com/tmccombs">@tmccombs</a>
        on 2024-01-07 09:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tmccombs">@tmccombs</a></div>
            <div class="timeline-body"><h4>Describe your feature request</h4>
<p>In the <code>ignore</code> crate, <code>WalkerBuilder::override</code> allows you to pass in overrides, which use ignore globs with the meaning of &quot;!&quot; inverted. For ripgreps <code>-g</code> option that inversion make sense.</p>
<p>In <code>fd</code>, there is an <code>--exclude</code> option, which takes additional patterns to exclude. In order for that to work we use the override mechanism but currently prepend a &quot;!&quot; to the glob to counteract the inversion that overrides performs.  It would be nice if there was an API that we could use to add an override to exclude instead of include a pattern directly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @BurntSushi on 2024-01-07 13:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-01-07 13:57</div>
            <div class="timeline-body"><p>I personally don't think needing to add a <code>!</code> to the glob justifies a new API for this.</p>
<p>With that said, I am hoping to do a refresh of the <code>ignore</code> crate soonish. Probably within the next year or so. My guess is that the API will be completely redesigned. There is little to like about the current one IMO.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tmccombs">@tmccombs</a> on 2024-01-08 08:11</div>
            <div class="timeline-body"><p>Here's my actual problem:</p>
<p>In order to exclude the <code>.git</code> directory itself when hidden files are shown, and gitignore is active, we add &quot;!.git&quot; to the overrides.</p>
<p>I still think this is a reasonable default to have (and maybe it would make sense for the ignore crate itself to do this?), but there are a few users who do want to include the <code>.git</code> directory in the output. I was hoping that I could get something like <code>--exclude !.git</code> or <code>--include .git</code>  to work where it would negate the <code>!.git</code> in the overrides. However, due to the way overrides are implemented, <code>!.git</code> has higher priority than <code>.git</code> in the overrides.  I could check for the specific string &quot;.git&quot; in the list of options passed to <code>--include</code>, before adding <code>!.git</code>, but that feels kind of hacky, and wouldn't work if the user used something like <code>.git*</code>.</p>
<p>What I <em>really</em> want is a way to add additional rules at the same level as the .gitignore file, at lower priority than the override rules. Or, having native support for .git would be cool too. :)</p>
<p>I'm looking forward to seeing your redesign.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tmccombs">@tmccombs</a> on 2024-01-08 08:52</div>
            <div class="timeline-body"><p>After a bit of experimentation, implementing an <code>--include</code> option that is able to re-include things that have been excluded by other rules, also doesn't work as I hoped. It appears that if I add a non-negated rule, then the results will only include directories, and files that match the included patterns.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-01-08 16:28</div>
            <div class="timeline-body"><blockquote>
<p>However, due to the way overrides are implemented, <code>!.git</code> has higher priority than <code>.git</code> in the overrides.</p>
</blockquote>
<p>That's not quite what's happening. The issue is one of whitelist/blacklist semantics. Namely, if all you have are blacklist rules, then a path passes the filter so long as it doesn't match anything in the blacklist. But if you have any whitelist rules, then a path passes the filter only when it both matches a rule <em>and</em> the <em>last</em> rule it matches is a whitelist rule. That applies when you have 0 or more blacklist rules.</p>
<p>This is easier with examples (using this repo):</p>
<pre><code>$ rg burntsushi -l --hidden
GUIDE.md
CHANGELOG.md
README.md
tests/regression.rs
FAQ.md
.git/rr-cache/347ea8452dc5a9833914ef7fa86e08d8c618a57a/postimage
.git/rr-cache/347ea8452dc5a9833914ef7fa86e08d8c618a57a/preimage

$ rg burntsushi -l --hidden -g '!/.git/'
README.md
FAQ.md
CHANGELOG.md
tests/regression.rs
GUIDE.md

$ rg burntsushi -l --hidden -g '!/.git/' -g '/.git/'
rg: No files were searched, which means ripgrep probably applied a filter you didn't expect.
Running with --debug will show why files are being skipped.

$ rg burntsushi -l --hidden -g '!/.git/' -g '/.git/' -g '/.git/**'
.git/rr-cache/347ea8452dc5a9833914ef7fa86e08d8c618a57a/postimage
.git/rr-cache/347ea8452dc5a9833914ef7fa86e08d8c618a57a/preimage
</code></pre>
<p>The second to last example is the interesting one. The issue is that there is one whitelist pattern, so the only thing ripgrep will search are things matching <code>/.git/</code>. But the only thing that <code>/.git/</code> matches is a directory. But not anything inside that directory. So you need the extra <code>/.git/**</code> rule.</p>
<p>Perhaps this will help with your use case.</p>
<blockquote>
<p>I still think this is a reasonable default to have (and maybe it would make sense for the ignore crate itself to do this?)</p>
</blockquote>
<p>I don't think so. I find this to be surprising behavior personally. If I ask to see hidden files, I want to see all of them, unless I've explicitly configured it to do otherwise.</p>
<p>For example, another approach here is <code>echo /.git/ &gt;&gt; .ignore</code> (or <code>echo /.git/ &gt;&gt; .fdignore</code>). That rule will suppress <code>/.git/</code> when searching hidden folders. And users can opt into it.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:43:45 UTC
    </footer>
</body>
</html>
