<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>remove fish auto-completions from ripgrep release - BurntSushi/ripgrep #1577</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>remove fish auto-completions from ripgrep release</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/1577">#1577</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2020-05-09 02:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>The main issue here is that the Fish project wants to own auto-completions for ripgrep, and generally speaking, I don't want to stop them. In particular, ripgrep's Fish auto-completions are auto-generated by Clap (ripgrep's argv parser). I have no idea how good they are, but they are only provided by ripgrep because it's easy to provide them. Otherwise, I would not maintain them.</p>
<p>The actual reason to drop them is that they are causing problems. See #1485 and https://github.com/fish-shell/fish-shell/pull/6868 in particular.</p>
<p>The plan here is:</p>
<ul>
<li>[x] The ripgrep 12.1.0 release will include a notice that the Fish shell completions will be dropped from the next major version release.</li>
<li>[ ] The ripgrep 13.0.0 release will drop Fish shell completions.</li>
<li>[ ] The Fish project should be <a href="https://github.com/fish-shell/fish-shell/pull/6868#issuecomment-614078903">notified</a> once the ripgrep 13 release is out so that they can merge ripgrep auto-completions as they see fit.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @BurntSushi on 2020-05-09 02:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/igor-raits">@igor-raits</a> on 2020-05-10 07:56</div>
            <div class="timeline-body"><p>@BurntSushi I am probably misunderstanding something, but how do they conflict? The fish autocompletions coming from upstream are located in <code>/usr/share/fish/completions/</code> while distro maintainers are supposed to put their completions into <code>/usr/share/fish/vendor_completions.d/</code> which is for example what Fedora does. The vendor ones override upstream ones.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/igor-raits">@igor-raits</a> on 2020-05-10 08:01</div>
            <div class="timeline-body"><p>It would be nicer if the fish completions would be maintained in upstream rather than fish upstream because that is PITA to upgrade since everyone would need to wait for release of fish to get new completions for new rg version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-05-10 11:51</div>
            <div class="timeline-body"><blockquote>
<p>The vendor ones override upstream ones.</p>
</blockquote>
<p>Right, that's exactly the problem AIUI. See the linked issue for discussion: https://github.com/fish-shell/fish-shell/pull/6868</p>
<p>My perspective on this is that I'm acting on the Fish project's recommendation. So if this isn't the optimal path and you want to convince them to change their recommendation, then I'm happy to oblige.</p>
<blockquote>
<p>It would be nicer if the fish completions would be maintained in upstream rather than fish upstream because that is PITA to upgrade since everyone would need to wait for release of fish to get new completions for new rg version.</p>
</blockquote>
<p>I assumed the Fish project took this into account when making their recommendation? ¯\_(ツ)_/¯</p>
<p>I am happy to keep generating the Fish auto-completions. I don't know what their quality level is though. In theory, I'd also maybe be willing to assume maintenance of manually curated Fish auto-completions like we do for zsh, but under the following conditions:</p>
<ol>
<li>It is easy and obvious to add and remove new flags. The <a href="https://github.com/BurntSushi/ripgrep/blob/1e9a481a66c3804b772c2cdf4fb1e478384fe6e0/complete/_rg">zsh auto-completions have extensive docs (see the bottom)</a> to help navigate the arcane syntax.</li>
<li>CI fails if the auto-completions are out of sync with ripgrep's flags. zsh auto-completions <a href="https://github.com/BurntSushi/ripgrep/blob/1e9a481a66c3804b772c2cdf4fb1e478384fe6e0/ci/test-complete">have this test</a> to ensure that, for example.</li>
</ol>
<p>cc @thomcc @faho</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/faho">@faho</a> on 2020-05-10 13:11</div>
            <div class="timeline-body"><blockquote>
<p>I am happy to keep generating the Fish auto-completions. I don't know what their quality level is though.</p>
</blockquote>
<p>They are... okay? It's not like rg needs a ton, it's not git with tens of subcommands, each accepting different types of arguments. It's mostly flags with simple &quot;always&quot;, &quot;never&quot;, &quot;auto&quot; arguments at most.</p>
<p>There are a few nits, like that it always checks the <code>__fish_use_subcommand</code> condition, which means options will only be completed before the first non-option argument. I'm not sure that's correct?</p>
<p>Also the description wording isn't 100% what I'd use (it is generally understandable and concise enough tho) and the option-arguments don't have descriptions.</p>
<p>So there isn't a whole lot to be gained by manual curation in terms of completion quality.</p>
<blockquote>
<p>It is easy and obvious to add and remove new flags. The zsh auto-completions have extensive docs (see the bottom) to help navigate the arcane syntax.</p>
</blockquote>
<p>Well, I mean:</p>
<pre><code class="language-fish">complete -c rg -n &quot;__fish_use_subcommand&quot; -s A -l after-context -d 'Show NUM lines after each match.'
complete -c rg -n &quot;__fish_use_subcommand&quot; -s B -l before-context -d 'Show NUM lines before each match.'
complete -c rg -n &quot;__fish_use_subcommand&quot; -l color -d 'Controls when to use color.' -r -f -a &quot;never auto always ansi&quot;
</code></pre>
<p>I would imagine for simple options like here it's quite easy.</p>
<blockquote>
<p>CI fails if the auto-completions are out of sync with ripgrep's flags. zsh auto-completions have this test to ensure that, for example.</p>
</blockquote>
<p>If you have fish installed that's doable. Completion can be invoked from a script via <code>complete --do-complete=&quot;the fake commandline&quot;</code>, so <code>complete --do-complete=&quot;rg -&quot;</code> would list all the options, one per line with the description after a tab.</p>
<p>If you don't, you'd have to parse the file yourself. In general, that's a hard problem, but you might be able to get away with it iff you required the completions to fit a very particular style.</p>
<hr />
<blockquote>
<p>The main issue here is that the Fish project wants to own auto-completions for ripgrep</p>
</blockquote>
<p>So, the reason we merged the completions initially (which we have since backed out) was to automatically enable completions for users. The idea being that they'd install ripgrep via <code>cargo install</code>, which won't install the completions, and would then not think to install them themselves.</p>
<p>What instead ended up happening was that users used distro packages, and the distro packages already moved the completions, only to the wrong location.</p>
<p>And that led to ripgrep and fish not being installable together because of file conflicts and took longer than I would have liked to sort out.</p>
<p>Now a few months have passed, and I have since removed the ripgrep completions from fish again, mostly so we wouldn't run into the installability issue again. Distros have also changed to using the correct path in the meantime.</p>
<blockquote>
<p>I assumed the Fish project took this into account when making their recommendation? ¯_(ツ)_/¯</p>
</blockquote>
<p>You probably mean my comment &quot;Ideally we'd just be able to coordinate with rg upstream to drop them, but I'm not entirely sure that'd work out.&quot;.</p>
<p>To be honest, that was in error. I was too focussed on the premise of the PR that shipping the rg completions ourselves would be good, and neglected to look up the backstory of why we shipped rg completions at all (which as it turns out wasn't related to completion quality).</p>
<p>Personally, I don't think the ripgrep completions gain much from being shipped in fish - they aren't super complicated so they won't benefit much from enhancements in fish, but ripgrep might add options quicker than we ship releases.</p>
<p>So if you are happy keeping them, then please keep them!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-05-10 20:24</div>
            <div class="timeline-body"><p>All righty then. Happy to keep auto-generating them. It's really no extra work for me. :-)</p>
<p>I'll leave this issue open for a bit in case others have opinions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chax">@chax</a> on 2020-05-15 23:41</div>
            <div class="timeline-body"><p>Fish developers removed rg completions from their distribution in their last release, see https://github.com/fish-shell/fish-shell/issues/5822
so please don't remove it from your package.
People who package this software should take care where each file (completion or any other file) should be distributed when piece of software is packaged.
Anyways there is special dedicated folder where package's completion should go for fish (/usr/share/fish/vendor_completions.d), and special folder which is dedicated only for fish (/usr/share/fish/completions/), most packagers confuse those two and use wrong folder.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-05-31 23:33</div>
            <div class="timeline-body"><p>I'll keep auto-generating Fish shell completions: https://github.com/fish-shell/fish-shell/pull/6868#issuecomment-636296953</p>
<p>So closing this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2021-05-31 23:33</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:43:10 UTC
    </footer>
</body>
</html>
