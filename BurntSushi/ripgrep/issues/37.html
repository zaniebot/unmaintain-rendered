<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>^O characters in coloured output - BurntSushi/ripgrep #37</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>^O characters in coloured output</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/37">#37</a>
        opened by <a href="https://github.com/uazu">@uazu</a>
        on 2016-09-23 22:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/uazu">@uazu</a></div>
            <div class="timeline-body"><p>Viewing with <code>--color always</code> piped to <code>less -R</code>, colours appear correctly but there are ^O characters (\x0F) inserted regularly, which appear in less as inverted <code>^O</code>. When removed with <code>sed 's/\x0f//g'</code> output appears like screenshot.</p>
<p>Tested release binary version 0.1.16 on Debian Linux, with TERM=screen.linux.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @BurntSushi on 2016-09-24 02:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-24 02:04</div>
            <div class="timeline-body"><p>Yup, I can reproduce it. Setting <code>TERM=screen.linux</code> was key.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-27 01:08</div>
            <div class="timeline-body"><p>N.B. When I'm in a screen session, if I do <code>TERM=xterm rg -p foo | less -R</code> then things appear to work. When <code>TERM=screen</code>, I see the same <code>^0</code> characters as the OP. I wonder if it's a bug in the <code>term</code> library I'm using.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/balta2ar">@balta2ar</a> on 2016-09-27 09:02</div>
            <div class="timeline-body"><p>Same here (ArchLinux, tmux 2.2, rg 0.2.1). In tmux my $TERM is <code>screen-256color</code>, but running <code>TERM=xterm rg temp | less</code> helps.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/uazu">@uazu</a> on 2016-09-27 15:00</div>
            <div class="timeline-body"><p>Yes, I can work around it. ^O is shift-in, i.e. switch to non-graphic character set, so may be part of a generic &quot;reset&quot; sequence. As I need to add <code>--color always</code> to use with less, I need to put a wrapper script around it anyway so I'll add TERM=whatever there. Perhaps it only needs documenting. However if there was a way to just reset colours without also resetting character set that might avoid confusion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-27 15:32</div>
            <div class="timeline-body"><p>@uazu Ah thanks for the explanation. I think other tools seem to work fine, so we should try to fix it. Documenting it as a known bug in the README is also a good idea. By the way, you may also be interested in the <code>-p/--pretty</code> flag. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Screwtapello">@Screwtapello</a> on 2016-10-08 03:56</div>
            <div class="timeline-body"><p>According to <code>less(1)</code>, the <code>-R</code> option tells <code>less</code> to assume all sequences of the form <code>ESC [ ... m</code> are zero-width, and pass them through verbatim. <code>^O</code> is not of that form, so less makes it printable. But where does the <code>^O</code> come from?</p>
<p>Looking at the terminfo database entry for <code>screen</code>, we see:</p>
<pre><code>$ infocmp -1 screen | grep sgr0
    sgr0=\E[m\017,
</code></pre>
<p>...so whenever ripgrep calls <code>.reset()</code>, the term crate looks up the sequence associated with <code>sgr0</code> (&quot;set graphical rendition to 0&quot; i.e. all fancy things turned off), the terminfo database for <code>screen</code> defines <code>sgr0</code> to be &quot;ESC [ m ^O&quot; and so that's what gets written to the screen.</p>
<p>If there's a bug here, I'd say it's in <code>less</code> for half-assing its escape-sequence passthrough.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/uazu">@uazu</a> on 2016-10-09 11:45</div>
            <div class="timeline-body"><p>Well, I now have a wrapper around ripgrep which sets TERM=xterm and pipes to <code>less</code> and everything is fine (and I use ripgrep all the time now -- Thanks!). However, maybe using the 'reset' (sgr0) sequence in this application is overkill, since you don't need to reset everything, but rather just the colours. If there is some other terminfo string that can be used for that then the problem is avoided. Otherwise the TERM=xterm workaround needs to be documented, since I'm sure some other people will want to use <code>ripgrep</code> with <code>less</code> on <code>screen</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Screwtapello">@Screwtapello</a> on 2016-10-09 12:49</div>
            <div class="timeline-body"><p><code>sgr0</code> is definitely the canonical way to do it. And it's not just colours - ripgrep also makes some text bold.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2016-11-20 20:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kaushalmodi">@kaushalmodi</a> on 2016-11-22 09:36</div>
            <div class="timeline-body"><p>Thanks. I confirm the fix.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:41:38 UTC
    </footer>
</body>
</html>
