<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>true colour support - BurntSushi/ripgrep #261</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>true colour support</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/261">#261</a>
        opened by <a href="https://github.com/daxim">@daxim</a>
        on 2016-12-01 11:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/daxim">@daxim</a></div>
            <div class="timeline-body"><p>Let us pick <a href="https://gist.github.com/XVilka/8346728">any RGB colour</a> instead of just eight.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-12-01 11:59</div>
            <div class="timeline-body"><p>I think what we have now is sufficient for the vast majority of use cases. I expended a lot of energy of getting what we have now, and I'm not likely to revisit it myself for quite some time (if ever). If someone else wants to work on this, then I'd be fine with that. But, I would expect to see a specification here before submitting a PR, including the behavior in environments where true color isn't supported and how it will be exposed in the <a href="https://docs.rs/termcolor/0.1.1/termcolor/"><code>termcolor</code></a> library.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @BurntSushi on 2016-12-01 11:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">icebox</span> added by @BurntSushi on 2016-12-01 11:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/daxim">@daxim</a> on 2016-12-02 03:54</div>
            <div class="timeline-body"><p>The <code>termcolor</code> type <code>Color</code> is extended to accept RGB triples, e.g. <code>255;100;0</code>. The same format can be used in user-facing applications like rg in addition to the traditional colour names.</p>
<p>From the library, emit e.g. <code>‚êõ[38;2;255;100;0m</code> for foreground and <code>‚êõ[48;2;255;100;0m</code> for background.</p>
<p>Terminals that do not interpret the code ignore it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/scottchiefbaker">@scottchiefbaker</a> on 2017-01-12 21:45</div>
            <div class="timeline-body"><p>I agree that we need access to more colors. The base eight ANSI colors are pretty limiting.</p>
<p>I like the way <code>ag</code> handles this where you specify your colors in raw ANSI codes. This allows the user to set both the color and the boldness of the text (and anything else ANSI supports). For example my <code>ag</code> alias is this:</p>
<pre><code>alias ag=&quot;ag --color-match '1;38;5;208'&quot;
</code></pre>
<p>This sets the matching text to: bold, orange (256 color pallet).</p>
<p>This would require no more logic from <code>rg</code>, as it would just emit whatever is in the color match BEFORE the actual output.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-01-12 22:43</div>
            <div class="timeline-body"><p>I'm unlikely to work on this any time soon. I think this is strictly &quot;nice to have.&quot;</p>
<p>(For the most part, I'm just in general sick of dealing with terminal/color issues.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-01-12 22:44</div>
            <div class="timeline-body"><p>If someone else wanted to take a crack at this, I'd be happy to mentor it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jdhorwitz">@jdhorwitz</a> on 2017-03-15 16:42</div>
            <div class="timeline-body"><p>@BurntSushi I could take a crack at this if you are still willing to mentor it.  Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-03-15 16:46</div>
            <div class="timeline-body"><p>@jdhorwitz Cool. I think I'd start with this:</p>
<ol>
<li>Write up a specification for how this works. If you're not sure where to start, here's my suggestion: write the documentation you would expect to see, <em>as an end user</em>, once this feature is implemented.</li>
<li>Sketch a rough implementation plan.</li>
</ol>
<p>No need to spend too much time on this, but I think it's useful to think about this a little before writing code so that we can poke at it a bit!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-03-15 16:46</div>
            <div class="timeline-body"><p>(Putting the write up in this issue is cool.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-03-15 16:46</div>
            <div class="timeline-body"><p>And of course, if you need help with the writeup, then ask questions!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/scottchiefbaker">@scottchiefbaker</a> on 2017-03-15 18:44</div>
            <div class="timeline-body"><p>I don't know anything about rust, but I'd be interested in providing feedback on how the feature should look. If you're soliciting feedback, this would be a good place to start a discussion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tiehuis">@tiehuis</a> on 2017-04-14 01:11</div>
            <div class="timeline-body"><h3>Summary</h3>
<ul>
<li>Provide 24-bit rgb and 256 color modes as Ansi color extensions.</li>
<li>Fallback to white for the moment on Windows if an rgb/256 color is specified</li>
<li>Up to the user to ensure that their terminal supports whatever color codes they are providing it</li>
</ul>
<h4>Questions</h4>
<ul>
<li>Provide extended attributes? As @scottchiefbaker mentions. Only issue I see with this is it exposes the underlying implementation for all to see. This ties us explicitly to ANSI codes. Specifying a list of attributes in human readable form may be better. For example <code>--colors 'match:fg:bold+underline,red'</code>.
Wouldn't want to overdo here and make the format too arcane. For now just deal with extended colors.</li>
</ul>
<p>If this all sounds good I can clean up the implementation a bit and we can go from there.</p>
<hr />
<p>I've had a quick look at this and here are my thoughts. I've pushed a sample implementation (see above) which accepts 256-color codes and full rgb color codes too.</p>
<p>Example invocations right now are as follows.</p>
<pre><code># 256-color mode
rg --colors 'match:fg:25'
# truecolor mode
rg --colors 'match:fg:128,0,3'
</code></pre>
<p>Format is just the first thing that came to mind, nothing special or set in stone. For the moment, we just fall back to white on windows if we encounter an rgb or 256-color code that we cannot parse. This is likely sufficient behavior for the moment.</p>
<h2>Terminal Support?</h2>
<p>The main problems I had with this are that different terminal emulators are fickle things and don't parse the 24-bit color codes in a nice way. I've done some tests myself on 4 different terminals to check the difference.</p>
<p>I've tested the following terminals:</p>
<ul>
<li>st 0.7</li>
<li>urxvt 9.22</li>
<li>XTerm(327)</li>
<li>Sakura 3.3.4</li>
</ul>
<p>These are all the latest versions currently on Arch.</p>
<h2>Truecolor Support</h2>
<p><img src="https://i.imgur.com/FCoskIX.png" alt="Truecolor Support (st+urxvt)" />
<img src="https://i.imgur.com/wMxUBCA.png" alt="Truecolor Support (xterm+sakura)" /></p>
<p>All except for urxvt display this in a reasonable manner. urxvt supposedly approximates but it looks this change hasn't yet made it into the stable version available in package managers.</p>
<h3>Buggy urxvt Parsing</h3>
<p>The main problem however is not that urxvt does not display these colors. It is that it will parse rgb color codes incorrectly, treating each rgb component instead as an attribute it does know about.</p>
<p>For example, the following command <code>--colors 'match:fg:31,3,5</code> should display a very dark red. However urxvt will instead parse this as red (31), underline (3), then blink (5) attributes. This provides some interesting results.</p>
<p><img src="https://i.imgur.com/JbZI6rT.gif" alt="urxvt-buggy" /></p>
<h2>256-color Support</h2>
<p><img src="https://i.imgur.com/e44yJRq.png" alt="256-color Support (st+urxvt)" />
<img src="https://i.imgur.com/qGfX6z8.png" alt="256-color Support (xterm+sakura)" /></p>
<p>All support 256-color mode reasonably.</p>
<h2>Should we still want these colors?</h2>
<p>Even though this can produce incorrect colors, I still think it is worthwhile adding with the existing functionality (or similar). These colors could be considered an extension and the assurance that the terminal being printed to supports them should be placed on the user instead. Only potential issue I see is passing an rgb color code and not seeing the expected color (windows or bad terminal) could be considered a defect by an end-user. We would need to clearly indicate this next to the format specification.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/scottchiefbaker">@scottchiefbaker</a> on 2017-04-14 21:16</div>
            <div class="timeline-body"><blockquote>
<p>Xterm,[14] KDE's Konsole,[18] as well as all libvte based terminals[19] (including GNOME Terminal) support ISO-8613-3 24-bit foreground and background color setting[better source needed] Quoting one of the text-files in its source-tree:[20]</p>
</blockquote>
<p>This is from <a href="https://en.wikipedia.org/wiki/ANSI_escape_code">Wikipedia</a>. It's 2017, I think true color is pretty well supported in most modern terminals. It's an accepted ANSI standard now, I don't think we need to worry about XYZ terminal not supporting it. The popular main terminals already support it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/scottchiefbaker">@scottchiefbaker</a> on 2017-04-14 21:21</div>
            <div class="timeline-body"><p>For reference here is a good discussion on terminal support for true color:</p>
<p>https://gist.github.com/XVilka/8346728</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/scottchiefbaker">@scottchiefbaker</a> on 2017-04-14 21:22</div>
            <div class="timeline-body"><p>Not to totally spam this bug but... I really like your implementation details:</p>
<pre><code># 256-color mode
rg --colors 'match:fg:25'
# truecolor mode
rg --colors 'match:fg:128,0,3'
</code></pre>
<p>I think it's intuitive, simple, and backwards compatible with what's already in place. This gets a üëç from me. I'll test this build and report back.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/scottchiefbaker">@scottchiefbaker</a> on 2017-04-17 20:43</div>
            <div class="timeline-body"><p>I was able to build your branch and everything works exactly as expected. It should completely address this issue. You'd get my +1 to merge if you submitted a PR to @BurntSushi</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/parkovski">@parkovski</a> on 2017-11-11 17:30</div>
            <div class="timeline-body"><p>To test and enable this on Windows if it's supported, you'd use the equivalent of this C code:</p>
<pre><code class="language-c">// There are a couple ways to get this handle, just use the one you have.
HANDLE stdout = GetStdHandle(STD_OUTPUT_HANDLE);
DWORD out_mode;
if (!GetConsoleMode(stdin, &amp;out_mode)) {
    // Couldn't get the current mode, assume it's not supported.
}
if (!SetConsoleMode(stdin, out_mode | ENABLE_VIRTUAL_TERMINAL_PROCESSING /* 0x4 */)) {
    // The mode couldn't be set or wasn't recognized, use the console API coloring fallback
}
// If both those calls succeeded, the console will process
// ANSI escaped output and support true color.
</code></pre>
<p>The console mode functions in Rust would be declared as (<code>BOOL</code> and <code>DWORD</code> are always 32 bits):</p>
<pre><code class="language-rust">extern &quot;system&quot; {
    fn GetConsoleMode(handle: std::os::windows::io::RawHandle, mode: *mut u32) -&gt; i32;
    fn SetConsoleMode(handle: std::os::windows::io::RawHandle, mode: u32) -&gt; i32;
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-01-31 02:39</div>
            <div class="timeline-body"><p>This was done by @tiehuis in #766.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2018-01-31 02:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:41:56 UTC
    </footer>
</body>
</html>
