<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ship binaries that work on macOS arm targets - BurntSushi/ripgrep #1737</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ship binaries that work on macOS arm targets</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/1737">#1737</a>
        opened by <a href="https://github.com/nico">@nico</a>
        on 2020-11-21 01:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/nico">@nico</a></div>
            <div class="timeline-body"><p>It'd be nice if there was a prebuilt binary of rg that ran without Rosetta 2 on ARM Macs. There could either be a separate macOS-arm binary, or there could be a single universal binary that runs on both ISAs.</p>
<p>https://github.com/rust-lang/rust/issues/73908 covers support for this in upstream rust. This feature request is probably blocked on that completing.</p>
<p>https://github.com/shepmaster/rust/blob/silicon/silicon/README.md has some notes on cross-compiling.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/shepmaster">@shepmaster</a> on 2020-11-23 15:05</div>
            <div class="timeline-body"><p>FWIW, ripgrep compiles fine on these machines, so that shouldn't be a problem.</p>
<pre><code>% file $(which rg)
~/.cargo/bin/rg: Mach-O 64-bit executable arm64
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @BurntSushi on 2020-11-23 15:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-11-23 15:14</div>
            <div class="timeline-body"><p>Thanks for the feature request. But there are some things I don't understand. Please consider that when filing feature requests, that not every uses macOS. So it would help to provide more details. Some questions I have for example:</p>
<ul>
<li>I have no idea what it means to &quot;run without Rosetta 2.&quot; Probably because I don't know what Rosetta 2 is. But even if I did, I don't know what it means to produce a binary without it.</li>
<li>I don't know what you mean by a &quot;universal binary&quot; in the feature title. Universal in what sense?</li>
</ul>
<p>Either way, I don't see myself spending time on this any time soon. If someone else wanted to work on this, then my requirements are probably the following:</p>
<ol>
<li>It should work with Rust stable. I'm open to something that only works with Rust nightly, but it should be using something that is on track to be stabilized and is unlikely to see major changes.</li>
<li>It should work with <code>cross</code>. @shepmaster's instructions look great, but I'd really prefer that it work like other binaries that are produced via cross compiling.</li>
<li>And finally, that it can be done automatically via GitHub Actions.</li>
</ol>
<p>If these requirements aren't met, then I'd probably say that Rust and macOS arm aren't ready yet. The main thing I want to avoid is adding CI for a binary that breaks frequently.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @BurntSushi on 2020-11-23 15:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/atouchet">@atouchet</a> on 2020-11-23 16:13</div>
            <div class="timeline-body"><p>@BurntSushi</p>
<p>Rosetta 2 is a x86-64 to ARM64 translator. See: https://developer.apple.com/documentation/apple_silicon/about_the_rosetta_translation_environment</p>
<p>Running without Rosetta 2 means running as a native ARM64 application.</p>
<p>Universal binary is Apple's name for fat binaries which include binaries for multiple instruction sets. See: https://developer.apple.com/documentation/xcode/building_a_universal_macos_binary</p>
<p>Universal binary in this sense means that it's packaged with both x86-64 and ARM64 binaries.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-11-23 16:25</div>
            <div class="timeline-body"><p>OK, thanks, that helps clarify things. Unless producing a universal binary with the Rust toolchain is easy, I'd expect to host two binaries: one for x86_64 and one for arm. Just like we do for other platforms.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/shepmaster">@shepmaster</a> on 2020-11-23 16:46</div>
            <div class="timeline-body"><blockquote>
<ul>
<li>It should work with Rust stable.</li>
</ul>
</blockquote>
<p>Not yet. In 6 weeks, perhaps, but right now you need beta.</p>
<blockquote>
<ul>
<li>It should work with <code>cross</code>. @shepmaster's instructions look great, but I'd really prefer that it work like other binaries that are produced via cross compiling.</li>
</ul>
</blockquote>
<p>Perhaps this comment should start some effort in the cross repo. This works today outside of cross, however:</p>
<pre><code>% rustup component add rust-std --toolchain beta --target=aarch64-apple-darwin

% SDKROOT=$(xcrun -sdk macosx11.0 --show-sdk-path) \
MACOSX_DEPLOYMENT_TARGET=$(xcrun -sdk macosx11.0 --show-sdk-platform-version) \
cargo +beta build --target=aarch64-apple-darwin

    Finished dev [unoptimized + debuginfo] target(s) in 29.32s

% file target/aarch64-apple-darwin/debug/rg
target/aarch64-apple-darwin/debug/rg: Mach-O 64-bit executable arm64
</code></pre>
<blockquote>
<ul>
<li>And finally, that it can be done automatically via GitHub Actions.</li>
</ul>
</blockquote>
<p>This should be achievable.</p>
<blockquote>
<p>Unless producing a universal binary with the Rust toolchain is easy</p>
</blockquote>
<p>Depends what &quot;with the Rust toolchain&quot; entails. After doing the above build...</p>
<pre><code>% cargo +beta build --target=x86_64-apple-darwin

% lipo -create -output rg target/{aarch64,x86_64}-apple-darwin/debug/rg

% file rg
rg: Mach-O universal binary with 2 architectures: [x86_64:Mach-O 64-bit executable x86_64] [arm64]
rg (for architecture x86_64):	Mach-O 64-bit executable x86_64
rg (for architecture arm64):	Mach-O 64-bit executable arm64
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-11-23 16:50</div>
            <div class="timeline-body"><p>That looks great! I'd be happy adopting all of that at any time. Looks simple enough, and it being in beta would be fine with me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-11-23 16:50</div>
            <div class="timeline-body"><p>@shepmaster Thank you for answering my questions with great detail. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Make macOS prebuilt binary universal" to "ship binaries that work on macOS arm targets" by @BurntSushi on 2023-07-09 13:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-07-09 13:59</div>
            <div class="timeline-body"><p>I'm not too keen on doing a universal binary here. It seems wasteful? I'd rather just build separate binaries for x86-64 and arm targets like I do for everything else.</p>
<p>It looks like it is possible to build an arm binary by just doing <code>rustup target add aarch64-apple-darwin</code> and then <code>cargo build --release --target aarch64-apple-darwin</code> on a macOS x86-64 host. However, there is no way to run tests and I'd really rather I only ship binaries that I can actually test.</p>
<p>So for now, I'd consider this blocked on GitHub providing macOS arm runners in CI.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vadz">@vadz</a> on 2023-07-09 14:06</div>
            <div class="timeline-body"><p>FWIW https://www.macstadium.com/ provides free access to ARM Macs for open source projects and we used it to set up GitHub self-hosted runner there -- and this seems to work pretty well.</p>
<p>Sorry if this looks like advertisement, I'm not affiliated with MacStadium in any way, I'm just grateful to them for allowing us to build and test under ARM and thought this could be useful for this project too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-07-09 14:08</div>
            <div class="timeline-body"><p>Thanks. Unless it's super easy to do, I'm not inclined to do anything self-hosted here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/claviola">@claviola</a> on 2023-07-11 22:44</div>
            <div class="timeline-body"><blockquote>
<p>FWIW https://www.macstadium.com/ provides free access to ARM Macs for open source projects and we used it to set up GitHub self-hosted runner there -- and this seems to work pretty well.</p>
</blockquote>
<p>Doesn't look like they do anymore. I came across https://www.macstadium.com/opensource, but it 404s - last in the Internet Archive on March of this year: http://web.archive.org/web/20230319190128/https://www.macstadium.com/opensource-application</p>
<p>edit: FWIW this seems to work quite well: https://github.com/joseluisq/rust-linux-darwin-builder
the only downside is that the image is rather large.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/larkost">@larkost</a> on 2023-11-02 21:21</div>
            <div class="timeline-body"><p>It looks like the Apple Silicon workers are now available: https://github.blog/2023-10-02-introducing-the-new-apple-silicon-powered-m1-macos-larger-runner-for-github-actions/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-11-02 21:24</div>
            <div class="timeline-body"><p>@larkost That blog doesn't make it clear, but I believe you need to pay for it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-11-25 18:51</div>
            <div class="timeline-body"><p>My plan is to do this manually on my M2 mac mini until GitHub provides free runners: https://github.com/BurntSushi/ripgrep/blob/a2907db2de20fd33b0bf02d9bd1375da06218865/ci/build-and-publish-m2</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rollup</span> added by @BurntSushi on 2023-11-25 18:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2023-11-25 20:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tekumara">@tekumara</a> on 2024-02-04 04:09</div>
            <div class="timeline-body"><p>Looks like those free runners are finally here ðŸ¥³</p>
<p>https://github.blog/changelog/2024-01-30-github-actions-introducing-the-new-m1-macos-runner-available-to-open-source/</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:43:16 UTC
    </footer>
</body>
</html>
