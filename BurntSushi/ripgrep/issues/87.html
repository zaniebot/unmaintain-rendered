<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>an invalid pattern in gitignore causes all other patterns to be ignored - BurntSushi/ripgrep #87</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>an invalid pattern in gitignore causes all other patterns to be ignored</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/87">#87</a>
        opened by <a href="https://github.com/ahmedelgabri">@ahmedelgabri</a>
        on 2016-09-25 17:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ahmedelgabri">@ahmedelgabri</a></div>
            <div class="timeline-body"><p>I have this line in my project <code>.gitignore</code> but when I do search for a string it still returns results from these paths. While <code>ag</code> respect the ignored paths &amp; doesn't show any results from there. Maybe I'm missing something here?</p>
<pre><code>public/assets/admin
</code></pre>
<p>Here the commands</p>
<pre><code class="language-shell">$ rg -w -tjs document # not very creative :)
$ ag --js &quot;\bdocument\b&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-25 17:59</div>
            <div class="timeline-body"><p>I can't seem to reproduce the problem, could you please give a more detailed test case?</p>
<pre><code>[andrew@Cheetah 87] echo public/assets/admin &gt; .gitignore
[andrew@Cheetah 87] mkdir -p public/assets/admin
[andrew@Cheetah 87] echo document &gt; public/assets/admin/foo
[andrew@Cheetah 87] tree
.
 public
     assets
         admin
             foo

3 directories, 1 file
[andrew@Cheetah 87] rg -w document
No files were searched, which means ripgrep probably applied a filter you didn't expect. Try running again with --debug.
</code></pre>
<p>Note that I've fixed a few bugs with <code>.gitignore</code> on master that haven't made it into a release yet. It doesn't look like this particular case should have been impacted, but I kind of suspect there are some details missing. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-25 17:59</div>
            <div class="timeline-body"><p>Also, please show the output of <code>rg</code> with the <code>--debug</code> flag.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ahmedelgabri">@ahmedelgabri</a> on 2016-09-25 18:25</div>
            <div class="timeline-body"><p>Replicating your example everything works but in my repo the result is different</p>
<p>It's a big repo &amp; the output with <code>--debug</code> is really big but here is one line from the debug that shows the file was <em>whitelisted</em> by pattern which I assume is the <code>-tjs</code> part.</p>
<pre><code>DEBUG:rg::ignore: ./public/assets/admin/application.js whitelisted by Pattern { from: &quot;&lt;filetype&gt;&quot;, original: &quot;&lt;N/A&gt;&quot;, pat: &quot;&lt;N/A&gt;&quot;, whitelist: false, only_dir: false }
</code></pre>
<p>But, I commend out my <code>.gitignore</code> file leaving only the <code>public/assets/admin</code> &amp; it didn't show anything from there. So it seems like it's the project's <code>.gitignore</code> issue, but I'm trying to wrap my head around it since there is only <code>public/assets/admin</code> in that file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-25 18:28</div>
            <div class="timeline-body"><p>Is there any way for you to try current master? It would require installing Rust and compiling ripgrep (instructions in the README).</p>
<p>If not, that's OK, but I'd suggest we stop debugging the issue until I get the next release out for you to try (which should be today). I say this because I've fixed a few bugs related to gitignore.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ahmedelgabri">@ahmedelgabri</a> on 2016-09-25 18:32</div>
            <div class="timeline-body"><p>Ok I'll wait for the new release then. Thanks anyway </p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @BurntSushi on 2016-09-25 22:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-26 02:36</div>
            <div class="timeline-body"><p>I just tagged a new release, <code>0.2.0</code>. CI needs to run, but it should show up soon.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-26 02:53</div>
            <div class="timeline-body"><p>Looks like they're up. The <code>brew</code> formula has been updated.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ahmedelgabri">@ahmedelgabri</a> on 2016-09-26 22:18</div>
            <div class="timeline-body"><p>Here is another test after installing the latest version, same repo different string:</p>
<pre><code class="language-shell">$ brew rm ripgrep &amp;&amp; brew install https://raw.githubusercontent.com/BurntSushi/ripgrep/master/pkg/brew/ripgrep.rb

$ rg -w -tjs &quot;selectize&quot; -c
app/admin/assets/javascripts/application.js:1
app/admin/assets/javascripts/lib/address.js:2
app/admin/assets/javascripts/view/selectize.js:13
app/admin/assets/javascripts/view/tables.js:1
app/services/assets/javascripts/fair.js:1
app/services/assets/javascripts/signup.js:1
app/services/assets/javascripts/input.js:1
node_modules/selectize/dist/js/selectize.js:22
node_modules/selectize/dist/js/standalone/selectize.js:23
node_modules/selectize/examples/js/index.js:1
node_modules/selectize/Gruntfile.js:27
node_modules/selectize/dist/js/selectize.min.js:3
node_modules/selectize/karma.conf.js:4
node_modules/selectize/src/.wrapper.js:1
node_modules/selectize/src/defaults.js:4
node_modules/selectize/src/plugins/drag_drop/plugin.js:1
node_modules/selectize/src/plugins/dropdown_header/plugin.js:5
node_modules/selectize/src/plugins/optgroup_columns/plugin.js:1
node_modules/selectize/src/plugins/remove_button/plugin.js:1
node_modules/selectize/src/plugins/restore_on_backspace/plugin.js:1
node_modules/selectize/src/selectize.jquery.js:7
node_modules/selectize/src/selectize.js:6
node_modules/selectize/test/events_dom.js:3
node_modules/selectize/dist/js/standalone/selectize.min.js:3
node_modules/selectize/test/events.js:57
node_modules/selectize/test/setup.js:37
node_modules/selectize/test/support/base.js:3
node_modules/selectize/test/interaction.js:73
node_modules/selectize/test/api.js:204
node_modules/selectize/test/xss.js:2
public/assets/services/fair.js:2
public/assets/services/signup.js:2
public/assets/admin/application.js:4

# with ag
$ ag --js &quot;\bselectize\b&quot; -l
app/admin/assets/javascripts/application.js
app/admin/assets/javascripts/lib/address.js
app/admin/assets/javascripts/view/selectize.js
app/admin/assets/javascripts/view/tables.js
app/services/assets/javascripts/fair.js
app/services/assets/javascripts/signup.js
app/services/assets/javascripts/input.js
</code></pre>
<p><code>node_modules</code> is in the <code>.gitignore</code> too, the <code>--debug</code> output is way too big because it enters <code>node_modules</code> but simple all line are showing this</p>
<pre><code>DEBUG:rg::ignore: ./node_modules/xregexp/src/addons/matchrecursive.js whitelisted by Pattern { from: &quot;&lt;filetype&gt;&quot;, original: &quot;&lt;N/A&gt;&quot;, pat: &quot;&lt;N/A&gt;&quot;, whitelist: false, only_dir: false }
</code></pre>
<p>Simply any file that matches <code>-tjs</code> even if it is ignored shows as <code>whitelisted by Pattern</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-26 22:51</div>
            <div class="timeline-body"><p>I still can't reproduce this. I tried running <code>rg</code> in my own Javascript repo (with a <code>node_modules</code> directory) using <code>-tjs</code> and I get expected results, with <code>node_modules</code> ignored.</p>
<p>Is there anyway for you to pair down your <code>.gitignore</code> to find a smaller test case? I know that's probably asking a lot, since I expect that might take some time, so I understand if you can't. But it would be very very helpful. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ahmedelgabri">@ahmedelgabri</a> on 2016-09-27 08:38</div>
            <div class="timeline-body"><p>I found the problem! it's in our <code>.gitignore</code> which is this line <code>**no-vcs**</code> commenting this out makes <code>rg</code> works as expected. Not sure if this a bug in <code>rg</code> or an issue with the <code>.gitignore</code> pattern.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-27 11:59</div>
            <div class="timeline-body"><p>@ahmedelgabri Oh! That will do it. The actual problem is that <code>**no-vcs**</code> actually isn't a valid <code>gitignore</code> pattern. From <code>man gitignore</code>:</p>
<pre><code>      Two consecutive asterisks (&quot;**&quot;) in patterns matched against full
       pathname may have special meaning:

       路   A leading &quot;**&quot; followed by a slash means match in all directories.
           For example, &quot;**/foo&quot; matches file or directory &quot;foo&quot; anywhere, the
           same as pattern &quot;foo&quot;. &quot;**/foo/bar&quot; matches file or directory &quot;bar&quot;
           anywhere that is directly under directory &quot;foo&quot;.

       路   A trailing &quot;/**&quot; matches everything inside. For example, &quot;abc/**&quot;
           matches all files inside directory &quot;abc&quot;, relative to the location
           of the .gitignore file, with infinite depth.

       路   A slash followed by two consecutive asterisks then a slash matches
           zero or more directories. For example, &quot;a/**/b&quot; matches &quot;a/b&quot;,
           &quot;a/x/b&quot;, &quot;a/x/y/b&quot; and so on.

       路   Other consecutive asterisks are considered invalid.
</code></pre>
<p><code>rg</code> actually detects that this is an invalid pattern, which is fine, but then it completely drops every other pattern in the file, which is bad. (And it doesn't tell you that it did this either.) So this one pattern essentially killed your entire <code>.gitignore</code>. :-)</p>
<p>To clarify, the correct way to write that pattern is <code>**/no-vcs/**</code>. Or, if you want to match any directory name with <code>no-vcs</code> in it, then, <code>**/*no-vcs*/**</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @BurntSushi on 2016-09-27 11:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @BurntSushi on 2016-09-27 11:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Doesn't respect ignored paths in .ignore or .gitignore?" to "an invalid pattern in gitignore causes all other patterns to be ignored" by @BurntSushi on 2016-09-27 12:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-27 12:00</div>
            <div class="timeline-body"><p>Thank you so much for looking into this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ahmedelgabri">@ahmedelgabri</a> on 2016-09-27 12:04</div>
            <div class="timeline-body"><p>Yeah I'm working with person who added this &amp; we are fixing this, thank you for the clarification!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ahmedelgabri">@ahmedelgabri</a> on 2016-09-27 12:10</div>
            <div class="timeline-body"><p>Here is a couple of ideas on how I'm thinking about dealing with this</p>
<p>1- ignore the faulty pattern &amp; respect the rest <em>(maybe show a warning message too)</em>
2- show a warning message directly &amp; exit the search</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-27 12:26</div>
            <div class="timeline-body"><p>@ahmedelgabri (1) is absolutely the way to go. We should dump the error message from parsing the pattern to the debug output (which is only shown when <code>--debug</code> is passed). The specific place in the code where this needs to happen is in <a href="https://github.com/BurntSushi/ripgrep/blob/67abbf6f22019f353f44bfb04277c69a15d2d6ae/src/gitignore.rs#L262-L276">both of these methods</a>. Specifically, using <code>try!</code> causes the method to stop and report the error. Instead, we should extract the error explicitly, call <code>debug!(&quot;{}&quot;, err)</code> and keep on processing.</p>
<p>I think this means that <code>add_str</code> can't ever fail, but <code>add_path</code> can still fail if it can't read the file. That's OK because sometimes the file doesn't exist. This <a href="https://github.com/BurntSushi/ripgrep/blob/67abbf6f22019f353f44bfb04277c69a15d2d6ae/src/ignore.rs#L359-L372">fact is used</a> to avoid building a matcher for a particular directory if the file doesn't exist.</p>
<p>I'd be happy to mentor this change (even if you don't know Rust). Otherwise, I'm also happy to just fix it. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ahmedelgabri">@ahmedelgabri</a> on 2016-09-27 12:47</div>
            <div class="timeline-body"><p>I have never written a single Rust line in my life, I don't mind trying</p>
<p>But I'll need help starting from setting up my env to maybe even the smallest of stuff </p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-27 12:48</div>
            <div class="timeline-body"><p>The <a href="https://doc.rust-lang.org/book/">Rust book</a> should help get you started!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ahmedelgabri">@ahmedelgabri</a> on 2016-09-27 12:51</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-29 00:38</div>
            <div class="timeline-body"><p>@ahmedelgabri Let me know if there's anything I can do to help. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ahmedelgabri">@ahmedelgabri</a> on 2016-09-30 08:28</div>
            <div class="timeline-body"><p>@BurntSushi sorry didn't have enough time to look into this yet, will see if I can do it over the weekend</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2016-10-10 23:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-10-10 23:28</div>
            <div class="timeline-body"><p>@ahmedelgabri I was touching this code and wanted to get this bug fixed, so I went ahead and did it. If you'd like to work on something else, let me know and I can try to help you get started!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ahmedelgabri">@ahmedelgabri</a> on 2016-10-11 08:02</div>
            <div class="timeline-body"><p>@BurntSushi I'm very sorry. I'm extremely busy these days, didn't have time to do anything. Thanks for fixing this &amp; I'll try to look for something else that I can help with when I have some time.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:41:42 UTC
    </footer>
</body>
</html>
