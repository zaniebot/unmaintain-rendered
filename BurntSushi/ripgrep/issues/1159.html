<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Should use exit code to distinguish between no results and an invocation error - BurntSushi/ripgrep #1159</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Should use exit code to distinguish between no results and an invocation error</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/1159">#1159</a>
        opened by <a href="https://github.com/wincent">@wincent</a>
        on 2019-01-11 11:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/wincent">@wincent</a></div>
            <div class="timeline-body">What version of ripgrep are you using?
<pre><code>ripgrep 0.10.0
-SIMD -AVX (compiled)
+SIMD +AVX (runtime)
</code></pre>
Describe your question, feature request, or bug.
<p>I see that due to <a href="https://github.com/BurntSushi/ripgrep/issues/948">BurntSushi/ripgrep#948</a> ripgrep learnt how to distinguish errors (exit code 2) from no results (exit code 1), like Grep.</p>
<p>However, if you invoke <code>rg</code> with a non-existent flag, you&#x27;ll still get exit code 1, which means that there is no way to programmatically distinguish between no results and a botched invocation.</p>
<pre><code>rg --wat
error: Found argument &#x27;--wat&#x27; which wasn&#x27;t expected, or isn&#x27;t valid in this context

USAGE:

    rg [OPTIONS] PATTERN [PATH ...]
    rg [OPTIONS] [-e PATTERN ...] [-f PATTERNFILE ...] [PATH ...]
    rg [OPTIONS] --files [PATH ...]
    rg [OPTIONS] --type-list
    command | rg [OPTIONS] PATTERN

For more information try --help
zsh: exit 1     rg --wat
</code></pre>
<p>For comparison, <code>grep</code> exits with status 2 for unrecognized flags. <code>ack</code> exits with status 255 for unrecognized flags. <code>ag</code> suffers from the same problem, exiting with 1 indistinctly for bad invocations and for no results (issue: <a href="https://github.com/ggreer/the_silver_searcher/issues/1298">ggreer/the_silver_searcher#1298</a>).</p>
<p>FWIW, I wasn&#x27;t able to get <code>rg</code> (at least not v0.10.0) to return an exit status of 2, despite what <a href="https://github.com/BurntSushi/ripgrep/pull/954">BurntSushi/ripgrep#954</a> ostensibly does:</p>
<pre><code>rg something /non-existent-directory
/non-existent-directory: No such file or directory (os error 2)
zsh: exit 1     rg something /non-existent-directory
</code></pre>
<p>Note that it&#x27;s still exiting with status 1.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-01-11 12:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-01-11 12:08</div>
            <div class="timeline-body"><p>With respect to invalid invocations, yes, that is indeed a bug. It&#x27;s due to the fact that we let our arg parser exit the process for us if there&#x27;s an incorrect argv. Instead, we should use <a href="https://docs.rs/clap/2.32.0/clap/struct.App.html#method.get_matches_safe"><code>App::get_matches_safe</code></a> and handle the error ourselves. That should hopefully be a very simple change.</p>
<p>The latter part of your bug report is more interesting, and it&#x27;s less clear whether there&#x27;s anything to do. Certainly, ripgrep does not match grep&#x27;s behavior, but that is not in and of itself a reason to change something. In particular, ripgrep only emits a <code>2</code> exit code if there was a failure that caused it to exit early, i.e., a catastrophic failure. A failure to read a file or directory is not catastrophic, and in particular, ripgrep continues searching. An example of a catastrophic failure is, say, the inability to parse a given pattern:</p>
<pre><code>$ rg &#x27;bad)&#x27;
regex parse error:
    bad)
       ^
error: unopened group

$ echo $?
2
</code></pre>
<p>Where grep differs on this point is that it seems to emit a <code>2</code> exit status if <em>any</em> error occurred at all, even if a match was found. For example:</p>
<pre><code>$ grep foo does-not-exist UNLICENSE
grep: does-not-exist: No such file or directory

$ echo $?
2

$ grep the does-not-exist UNLICENSE
grep: does-not-exist: No such file or directory
UNLICENSE:This is free and unencumbered software released into the public domain.
UNLICENSE:distribute this software, either in source code form or as a compiled
UNLICENSE:In jurisdictions that recognize copyright laws, the author or authors
UNLICENSE:of this software dedicate any and all copyright interest in the
UNLICENSE:software to the public domain. We make this dedication for the benefit
UNLICENSE:of the public at large and to the detriment of our heirs and

$ echo $?
2
</code></pre>
<p>I don&#x27;t really know what the &quot;right&quot; behavior is here. How do you want to use the exit status specifically?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wincent">@wincent</a> on 2019-01-11 12:14</div>
            <div class="timeline-body"><p>I&#x27;m using ripgrep (or ag, or ack etc) in the <a href="https://github.com/wincent/ferret">Ferret Vim plug-in</a> and I&#x27;d like to provide better feedback when the user does something wrong. Right now it will say &quot;no matches found&quot; even if they passed a bad path or a non-existent option.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-01-11 12:42</div>
            <div class="timeline-body"><p>@wincent That doesn&#x27;t quite cover all our bases though... What do you want to do when a non-catastrophic error occurs but a match was found? Do users see the error messages emitted by ripgrep?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wincent">@wincent</a> on 2019-01-11 13:26</div>
            <div class="timeline-body"><p>I think making 1 what it means in grep makes sense (ie. no matches were found, but there were no errors and nothing obviously wrong that the user should &quot;fix&quot;). 2 to mean something went wrong, catastrophic or otherwise, irrespective of whether any (partial) results happened to get turned up on the way; if the tool really wants to, it can try to parse out the results, or the errors, or both.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-01-11 13:32</div>
            <div class="timeline-body"><p>@wincent Thanks for the comment, but I don&#x27;t think that really helps me make my decision. Could you explain more about the user experience instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wincent">@wincent</a> on 2019-01-11 13:44</div>
            <div class="timeline-body"><p>Right now:</p>
<ul>
<li>If there are no results, the user sees a &quot;no results&quot; message.</li>
<li>If the user passes <code>--bogus-option</code> they also see &quot;no results&quot; because Ferret responds that way to the exit code of 1.</li>
<li>If the user does <code>rg foo non-existent</code> they see &quot;no results&quot; because of the exit code of 1.</li>
<li>If the user does <code>rg foo non-existent .</code> they see the results from &quot;.&quot;.</li>
</ul>
<p>Ideally, I think they&#x27;d instead see:</p>
<ul>
<li>Results if the invocation is correct and has results.</li>
<li>The &quot;no results&quot; message if the invocation is correct but there are no results.</li>
<li>An error message if the invocation is incorrect, even if there are partial results.</li>
</ul>
<p>The first two cases are the common path and already work as expected. It&#x27;s that last one which is rarer, but currently can&#x27;t be handled well because it is ambiguous (Ferret would need to parse the error output. Empty output + exit code 1 means no results; non-empty output plus non-zero exit code means &quot;something went wrong&quot;; but it would be nice to tell this from the code without relying on a fragile parsing heuristic).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-01-11 13:51</div>
            <div class="timeline-body"><p>OK, thanks for explaining that. I now have a more specific question.</p>
<blockquote>
<p>The first two cases are the common path and already work as expected. It&#x27;s that last one which is rarer, but currently can&#x27;t be handled well because it is ambiguous (Ferret would need to parse the error output. Empty output + exit code 1 means no results; non-empty output plus non-zero exit code means &quot;something went wrong&quot;; but it would be nice to tell this from the code without relying on a fragile parsing heuristic).</p>
</blockquote>
<p>What does Ferret do today with error messages that ripgrep writes to stderr? Does it show them to users?</p>
<p>Also, just to make sure we&#x27;re in sync, GNU grep&#x27;s exit status behavior is documented as:</p>
<pre><code>EXIT STATUS
       Normally  the  exit  status  is 0 if a line is selected, 1 if no lines were selected, and 2 if an error
       occurred.  However, if the -q or --quiet or --silent is used and a line is selected, the exit status is
       0 even if an error occurred.
</code></pre>
<p>If ripgrep behaved like the above, would that resolve your concerns?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wincent">@wincent</a> on 2019-01-11 14:01</div>
            <div class="timeline-body"><p>Currently Ferret &quot;swallows&quot; error output. It&#x27;s visible only if the user runs <code>:messages</code> in Vim. If ripgrep behaved like grep that would make it easier to distinguish among the cases, although Ferret doesn&#x27;t use the <code>-q</code> flag so that bit isn&#x27;t relevant to its usage pattern (which is about getting the results, not checking whether results exist).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-01-11 14:10</div>
            <div class="timeline-body"><blockquote>
<p>Currently Ferret &quot;swallows&quot; error output. It&#x27;s visible only if the user runs :messages in Vim.</p>
</blockquote>
<p>It feels to me like this is a fundamental problem here. Even if I change ripgrep&#x27;s approach to handling exit statuses, you still have problems like, &quot;users can&#x27;t tell whether they supplied an invalid regex pattern or whether a search was executed and couldn&#x27;t find any hits but also errored on reading a particular file.&quot; In both of those cases, looking at the messages of stderr clarifies what happened. But otherwise, both instances would produce exactly the same exit status with nothing printed to stdout.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wincent">@wincent</a> on 2019-01-11 14:12</div>
            <div class="timeline-body"><p>If Ripgrep exits with status 2 I will show the error output. Otherwise it goes to the Vim quickfix listing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-01-11 14:14</div>
            <div class="timeline-body"><p>Ah interesting, OK. I <em>think</em> I&#x27;m convinced then, and we can just implement grep&#x27;s exit status semantics.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-01-26 21:01</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:08 UTC
    </footer>
</body>
</html>
