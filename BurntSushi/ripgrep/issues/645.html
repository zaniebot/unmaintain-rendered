<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disable .gitignore files by default, only use .ignore files? - BurntSushi/ripgrep #645</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Disable .gitignore files by default, only use .ignore files?</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/645">#645</a>
        opened by <a href="https://github.com/sunshowers">@sunshowers</a>
        on 2017-10-20 18:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sunshowers">@sunshowers</a></div>
            <div class="timeline-body"><p>Hi! Does ripgrep provide a way to disable gitignore parsing by default and only rely on <code>.ignore</code> files?</p>
<hr />
<p>Some surrounding context:</p>
<p>We've deployed ripgrep to thousands of developers at Facebook and people really love it overall. But we have thousands of files that are tracked but match ignore rules, and ripgrep skips over those files by default.</p>
<p>(Facebook uses Mercurial, but for various reasons the source of truth for ignore rules is still gitignores. We have a script that reads a repo with gitignores and generates a set of hgignores to go along with it. This shouldn't be relevant to the rest of the discussion.)</p>
<p>There's a fundamental incompatibility between the way ripgrep looks at ignore rules and the way VCS systems look at ignore rules. <code>.gitignore</code> (and <code>.hgignore</code>, <code>.svnignore</code> etc) only applies to files <em>not already tracked</em> by the VCS. But since ripgrep is unaware of what files are tracked by the VCS, it applies gitignore rules to all files including tracked ones.</p>
<p>At Facebook we have thousands of files that are tracked but match ignore rules, and ripgrep skips over them by default. I would be very surprised if other repos (especially large ones) wouldn't hit the same issue.</p>
<p>It would be great if we could maintain a separate list of rules in <code>.ignore</code> and then have <code>rg</code> not try and read <code>.gitignore</code> rules at all. Even better if this could be configured per-repository, but a global config would also be OK.</p>
<p>I guess we could deploy <code>rg</code> as a shell script that calls the actual <code>rg</code> binary with <code>--no-ignore-vcs</code>, but then sometimes people do want to apply the ignore rules and there doesn't appear to be a <code>--ignore-vcs</code> flag.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-10-21 01:18</div>
            <div class="timeline-body"><blockquote>
<p>Hi! Does ripgrep provide a way to disable gitignore parsing by default and only rely on .ignore files?</p>
</blockquote>
<p>Hiya! In today's ripgrep, other than <code>--no-ignore-vcs</code>, yes, there is technically a way to do this that I <em>think</em> satisfies your use case. If you <em>start</em> your <code>.ignore</code> file with a blanket whitelist, e.g., <code>!*</code>, then it will override every single gitignore file that ripgrep reads (because any <code>.ignore</code> file takes precedence over all <code>.gitignore</code> files, the exact rules are <a href="https://docs.rs/ignore/0.2.2/ignore/struct.WalkBuilder.html#ignore-rules">documented here</a>). The immediate problem you'll notice with this is that it will whitelist all hidden files as well, which overrides ripgrep's logic to skip hidden files. You can work around this by using the pattern <code>![!.]*</code>, which white lists every file that doesn't start with a <code>.</code>.</p>
<p>Note that it will be interesting to see whether such a rule causes ripgrep to run more slowly on your repo. If your gitignore files are already extensive, then my guess is no, but it's worth checking just in case.</p>
<p>With that said, to respond more generally:</p>
<ul>
<li>I do agree that there is an impedance mismatch here between git and ripgrep for exactly the reason you state.</li>
<li>In general, I think the &quot;right&quot; solution to this is to make <code>--no-ignore-vcs</code> work for you, such that an <code>--ignore-vcs</code> flag is available. This is really part of #196, which is to add config files to ripgrep, which in turn needs precisely this behavior: the ability to override any flag that has been set as a default in the config file. Unfortunately, that issue has been stalled for some time, but it is still something I'd like to do.</li>
</ul>
<p>The other solution that I don't think you mentioned is to add explicit whitelists for files that are tracked by git but would otherwise be ignored. My guess is that you've already considered that solution and ruled it out. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @BurntSushi on 2017-10-21 01:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sunshowers">@sunshowers</a> on 2017-10-22 00:00</div>
            <div class="timeline-body"><p>Thanks! Looks like <code>!*</code> works to disable gitignore parsing, but there doesn't appear to be a difference wrt hidden files caused if I replace <code>!*</code> with <code>![!.]*</code>. I think matching hidden files is OK for us, so consider this problem mostly resolved.</p>
<p>Is the exact syntax for <code>.ignore</code> documented somewhere? I couldn't find any docs in the <code>ignore</code> create.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sunshowers">@sunshowers</a> on 2017-10-22 00:03</div>
            <div class="timeline-body"><p>Looking at <code>--debug</code> output I noticed that <code>.gitignore</code> files were still being parsed. It would be a cool optimization to skip over those files if <code>.ignore</code> is sufficiently broad.</p>
<p>Having this <code>.ignore</code> file doesn't make ripgrep appreciably slower, but skipping over <code>.gitignore</code> files with <code>--no-ignore-vcs</code> causes ripgrep to be around 33% faster for our repo :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sunshowers">@sunshowers</a> on 2017-10-22 00:17</div>
            <div class="timeline-body"><p>Also, for anyone who stumbles on this in the future:</p>
<blockquote>
<p>The other solution that I don't think you mentioned is to add explicit whitelists for files that are tracked by git but would otherwise be ignored. My guess is that you've already considered that solution and ruled it out. :-)</p>
</blockquote>
<p>Yeah, the problem is not with building that list of files (Mercurial makes it really easy to figure that out: <code>hg files -I 'set:hgignore()'</code>). The problem is keeping that list up to date in a repository which thousands of engineers are committing to. :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-10-22 00:29</div>
            <div class="timeline-body"><p>@sid0 Here's an example that shows the difference between <code>!*</code> and <code>![!.]*</code>:</p>
<pre><code>[andrew@Cheetah ripgrep-645] tree
.
├── bar
├── baz
├── foo
└── quux

0 directories, 4 files
[andrew@Cheetah ripgrep-645] tree -a
.
├── bar
├── baz
├── foo
├── .git
│   ├── branches
│   ├── config
│   ├── description
│   ├── HEAD
│   ├── hooks
│   │   ├── applypatch-msg.sample
│   │   ├── commit-msg.sample
│   │   ├── post-update.sample
│   │   ├── pre-applypatch.sample
│   │   ├── pre-commit.sample
│   │   ├── prepare-commit-msg.sample
│   │   ├── pre-push.sample
│   │   ├── pre-rebase.sample
│   │   ├── pre-receive.sample
│   │   └── update.sample
│   ├── info
│   │   └── exclude
│   ├── objects
│   │   ├── info
│   │   └── pack
│   └── refs
│       ├── heads
│       └── tags
├── .gitignore
├── .ignore
└── quux

10 directories, 20 files
[andrew@Cheetah ripgrep-645] cat .gitignore 
quux
bar
[andrew@Cheetah ripgrep-645] cat .ignore
![!.]*
quux
[andrew@Cheetah ripgrep-645] rg -l test
baz
foo
bar
</code></pre>
<p>Now change <code>![!.]*</code> to <code>!*</code>, now ripgrep shows hidden files:</p>
<pre><code>[andrew@Cheetah ripgrep-645] cat .ignore
!*
quux
[andrew@Cheetah ripgrep-645] rg -l test
baz
bar
.git/hooks/pre-applypatch.sample
.git/hooks/pre-rebase.sample
.git/hooks/pre-commit.sample
foo
.git/hooks/applypatch-msg.sample
.git/hooks/commit-msg.sample
.git/hooks/pre-receive.sample
</code></pre>
<blockquote>
<p>Is the exact syntax for .ignore documented somewhere? I couldn't find any docs in the ignore create.</p>
</blockquote>
<p>It should be the same as <code>.gitignore</code>, but the glob implementation itself is in the <code>globset</code> crate, and its syntax is documented here: https://docs.rs/globset/0.2.0/globset/#syntax</p>
<blockquote>
<p>Looking at --debug output I noticed that .gitignore files were still being parsed. It would be a cool optimization to skip over those files if .ignore is sufficiently broad.</p>
</blockquote>
<blockquote>
<p>Having this .ignore file doesn't make ripgrep appreciably slower, but skipping over .gitignore files with --no-ignore-vcs causes ripgrep to be around 33% faster for our repo :)</p>
</blockquote>
<p>Yeah that'd be neat. 33% is quite amazing. Your <code>.gitignore</code> files must be craaaazy! ripgrep (well, <code>globset</code>) already does a ton of optimizations here, and actually avoids compiling a glob matcher (which is actually implemented via translation to a regex) if it doesn't have to, e.g., for simple globs like <code>foo</code> or <code>*.foo</code>.</p>
<p>I'm personally unlikely to implement said optimization because I do still consider <code>--no-ignore-vcs</code> with a corresponding <code>--ignore-vcs</code> to be the &quot;right&quot; answer here. The optimization is probably pretty tricky to implement in the current code as well, since you need to turn it on and off depending on where you are in the directory tree during traversal. (If the <code>.ignore</code> file that contains <code>!*</code> is no longer in scope, then you need to go back to matching gitignores.)</p>
<blockquote>
<p>Yeah, the problem is not with building that list of files (Mercurial makes it really easy to figure that out: <code>hg files -I 'set:hgignore()'</code>). The problem is keeping that list up to date in a repository which thousands of engineers are committing to. :)</p>
</blockquote>
<p>Interesting! My mind has trouble thinking at that level of development scale. Pretty neat tidbit, thanks!</p>
<hr />
<p>My feeling is that this particular issue can be closed, where the <code>--ignore-vcs</code> option is covered by #196, or have I missed anything else?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sunshowers">@sunshowers</a> on 2017-10-22 20:37</div>
            <div class="timeline-body"><blockquote>
<p>Here's an example that shows the difference between !* and ![!.]*:</p>
</blockquote>
<p>Ah, looks like it works for hidden files in the top level but not in subdirectories (try adding e.g. <code>dir1/.foo</code>). But <code>!**/[!.]*</code> works fine for hidden files in subdirectories too. This is a bit weird, I guess.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-10-22 20:49</div>
            <div class="timeline-body"><p>@sid0 Ah right yeah, if a glob doesn't contain a <code>/</code>, then the glob is applied to the entire path (relative to the originating ignore file), so <code>![!.]*</code> only works on top-level items. The <code>!**/[!.]*</code> glob correctly checks the basename of a path. (These are gitignore semantics.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sunshowers">@sunshowers</a> on 2017-10-22 23:15</div>
            <div class="timeline-body"><p>Thanks then!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sunshowers on 2017-10-22 23:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-03-23 15:02</div>
            <div class="timeline-body"><p>@sid0 I forgot to update this issue. The latest release of ripgrep now has a <code>--ignore-vcs</code> flag (to complement the <code>--no-ignore-vcs</code> flag), in addition to support for persistent configuration files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tagwint">@tagwint</a> on 2018-10-25 09:32</div>
            <div class="timeline-body"><p>Hi there,
what would be a suggested way to have .svn folders ignored from grep, yet having other folders started with a dot still be searched ?
I tried
<code>rg --hidden --ignore-vcs something </code>
and this still searches in .svn</p>
<pre><code>rg --version
ripgrep 0.10.0 (rev 8a7db1a918)
-SIMD -AVX (compiled)
+SIMD -AVX (runtime)
</code></pre>
<p>UPD: I ended up with explicitly specifying glob to exclude:
<code>rg --glob &quot;!.svn/&quot; --hidden something</code></p>
<p>since it looks like --ignore-vcs is overridden by --hidden
and the other files/folders with dot  in front (these i want to be included in search) considered hidden</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-10-25 11:10</div>
            <div class="timeline-body"><p>@tagwint You might consider reading the <a href="https://github.com/BurntSushi/ripgrep/blob/master/GUIDE.md#automatic-filtering">GUIDE</a> for help on how to deal with filtering. Improvements are welcome to the guide to make things clearer.</p>
<p>To answer your question, just add <code>.svn</code> to an <code>.ignore</code> file:</p>
<pre><code>$ mkdir .svn .foo
$ echo sherlock &gt; .svn/test
$ echo sherlock &gt; .foo/test
$ rg sherlock -l
$ rg sherlock -l --hidden
.foo/test
.svn/test
$ echo '.svn' &gt; .ignore
$ rg sherlock -l --hidden
.foo/test
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tagwint">@tagwint</a> on 2018-10-26 09:08</div>
            <div class="timeline-body"><p>Thanks for suggestion, @BurntSushi
The GUIDE is good and many cases are explained well, althouth paritcularly --ignore-vcs option is not mentioned in there.
I usually do searches in different servers/locations and cannot expect  .ignore files are present there.
modifying/creating .ignore files in each location would be less efficient than specifying excludes directly in command line. Currently I am quite happy with the approach I described myself and which is efficiently the same as you suggested in your example.
It just feels not quite logical to me that when  --hidden option is there, --ignore-vcs option is not respected
for at least .svn/ folders that are considered vcs related. If --hidden is supposed to win over --ignore-vcs by design (which is rather not obvious), I'd suggest mentioning that in the documentation for completeness reason.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:42:19 UTC
    </footer>
</body>
</html>
