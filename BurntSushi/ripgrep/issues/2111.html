<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>decompression binaries are searched for even when they will never be used - BurntSushi/ripgrep #2111</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>decompression binaries are searched for even when they will never be used</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/2111">#2111</a>
        opened by <a href="https://github.com/Antiever">@Antiever</a>
        on 2021-12-21 14:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Antiever">@Antiever</a></div>
            <div class="timeline-body">Feature request
<p>Switch for turn off tools check</p>
<p>For example, lets say I want to do multiple replacements like so:</p>
<pre><code>rg --passthru &quot;!RE1!&quot; &quot;!file!&quot; -or &quot;!RP1!&quot; |^
rg  --passthru &quot;!RE2!&quot; -or &quot;!RP2!&quot;  |^
...
rg  --passthru &quot;!RE6!&quot; -or &quot;!RP6!&quot;  |^
rg  --passthru &quot;!RE7!&quot; -or &quot;!RP7!&quot;
</code></pre>
<p>and every new instance of rg wiil do:</p>
<pre><code>decompress.rs:482: gzip: could not find executable in PATH
decompress.rs:482: gzip: could not find executable in PATH
decompress.rs:482: bzip2: could not find executable in PATH
decompress.rs:482: bzip2: could not find executable in PATH
decompress.rs:482: xz: could not find executable in PATH
decompress.rs:482: xz: could not find executable in PATH
decompress.rs:482: lz4: could not find executable in PATH
decompress.rs:482: xz: could not find executable in PATH
decompress.rs:482: brotli: could not find executable in PATH
decompress.rs:482: zstd: could not find executable in PATH
decompress.rs:482: zstd: could not find executable in PATH
decompress.rs:482: uncompress: could not find executable in PATH
</code></pre>
<p>So this kind of switch can speed up things a little bit</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-12-21 14:49</div>
            <div class="timeline-body"><p>I don&#x27;t know what you&#x27;re asking for? It looks like you have <code>--search-zip</code> enabled, probably in a config file or alias somewhere. Why not use <code>--no-search-zip</code>?</p>
<p>What does wanting to do &quot;multiple replacements&quot; have to do with this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Antiever">@Antiever</a> on 2021-12-21 15:21</div>
            <div class="timeline-body"><pre><code>&gt;echo 123 | rg --debug --no-search-zip &quot;123&quot; -or &quot;321&quot;

DEBUG|grep_regex::literal|crates\regex\src\literal.rs:58: literal prefixes detected: Literals { lits: [Complete(123)], limit_size: 250, limit_class: 10 }
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: gzip: could not find executable in PATH
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: gzip: could not find executable in PATH
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: bzip2: could not find executable in PATH
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: bzip2: could not find executable in PATH
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: xz: could not find executable in PATH
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: xz: could not find executable in PATH
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: lz4: could not find executable in PATH
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: xz: could not find executable in PATH
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: brotli: could not find executable in PATH
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: zstd: could not find executable in PATH
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: zstd: could not find executable in PATH
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: uncompress: could not find executable in PATH
321
</code></pre>
<p>I have no config file :)</p>
<blockquote>
<p>What does wanting to do &quot;multiple replacements&quot; have to do with this?</p>
</blockquote>
<p>As an example of repeating operation where we can feel useless file system actions</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-12-21 15:43</div>
            <div class="timeline-body"><p>Hmmm, yes, I see now. A benchmark would be useful here to motivate how important this is with respect to how much time ripgrep is taking. It&#x27;s also worth pointing out that these are debug logs, which was not at all clear from your original comment. It&#x27;s really important to present the output of the tool as it is.</p>
<p>Currently, indeed, these binaries are searched for unconditionally. I don&#x27;t think this should happen when<code> --no-search-zip</code> is present (which is also the default), so I&#x27;d consider this a bug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-12-21 15:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Switch for turn off tools check&quot; to &quot;decompression binaries are searched for even when they will never be used&quot; by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-12-21 15:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Antiever">@Antiever</a> on 2021-12-21 16:29</div>
            <div class="timeline-body"><blockquote>
<p>A benchmark would be useful here</p>
</blockquote>
<p>Well it&#x27;s not fatal in general but in a big operations chain we can feel (adds ~30ms at each iteration)
For the example above <strong>85</strong>% of execution time takes by CreateFileW while searching decompression binaries
Not quite what you&#x27;d expect from the fastest engine ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-12-21 16:31</div>
            <div class="timeline-body"><p>How do you know? Are you patching ripgrep to remove the PATH lookups to compare it? Are you using profiling tools? If so, what and how? (I&#x27;m not a Windows user.)</p>
<blockquote>
<p>Not quite what you&#x27;d expect from the fastest engine ;)</p>
</blockquote>
<p>You can say this about literally any bug. There will always be bugs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Antiever">@Antiever</a> on 2021-12-21 16:39</div>
            <div class="timeline-body"><p>Bugs it&#x27;s ok, I know this well (it was just a joke about  fastest engine expectations BTW, no offense) :)
On Windows you can use VTune (it&#x27;s great tool but in this case not a best choice), for quick stack view (with time %) Process Monitor of course
Some other options is UIforETW, Very Sleepy and maybe Luke Stackwalker and we have built-in tool on Windows too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nikgoodley-ibboost">@nikgoodley-ibboost</a> on 2023-11-05 17:10</div>
            <div class="timeline-body"><p>Worth noting that this behaviour seems to contribute to a state in VSCode on Windows that creates unkillable <code>rg.exe</code> processes, forcing a reboot to clear them for upgrades. I couldn&#x27;t replicate with the same rg.exe binary outside of the VSCode environment, so I don&#x27;t think that particular bug is in ripgrep itself, but it unfortunately seems to manifest only due to this check. As it had my attention thought maybe I could add the detail asked for so that this might be picked up?</p>
<p>Regarding the original suggestion I had to dig into this a lot using ProcMon on Windows to see the generated events while investigating the issue mentioned above (<a href="https://github.com/microsoft/vscode/issues/193927">microsoft/vscode#193927</a>), and I see the checks for these compression utilities being the <em>only</em> events generated for a period up to 150ms on my machine as it was. So I&#x27;d add some weight to the comment of @Antiever that it could add significant overhead to the overall timing.</p>
<p>In essence, if you have everything available, early in the PATH, it&#x27;s fairly modest, around 10ms. But this requires installing things most Windows users won&#x27;t have - even users of mingw (Git Bash) which brings brotli and xz - generally wont have zstd and lz4. It takes around 15ms to go through my full PATH stack for each one, so that can easily add 30ms per ms (I&#x27;ve since installed them both via scoop now that I&#x27;m aware of this).</p>
<p>With some further finagling of my machine and PATH to make sure I have everything available near the front of the PATH (on a high-spec machine but one with a fair number of PATH entries) I can reduce this. If I have installed every one of the utilies it takes 10-15ms per &quot;batch&quot; of binary checks. If I miss lz4 and zstd it takes ~35ms. I can&#x27;t comment on whether this is all it&#x27;s doing so maybe the actual impact on real-time is less, but it certainly appears to be serially executed according to Windows events at least in that first batch.</p>
<p>10ms isn&#x27;t much - but this is only after installing libraries SOLELY to satisfy this check despite them not being used in my use cases.</p>
<p>It also seems to be a check run many times. If I run the below monitoring Windows events I see 13 looking for &quot;C:\Windows\lz4.exe&quot; (brotli, zstd, etc.), 26 for &quot;C:\Windows\gzip.exe&quot; amd 39 for <code>xz.exe</code>. The multiples seems to be because of these lines in <code>decompress.rs</code> where ARGS_XZ and ARGS_LZMA both map to the xz process</p>
<pre><code>    add(&quot;*.xz&quot;, ARGS_XZ, &amp;mut cmds);
    add(&quot;*.txz&quot;, ARGS_XZ, &amp;mut cmds);
    ...
    add(&quot;*.lzma&quot;, ARGS_LZMA, &amp;mut cmds);
</code></pre>
<p><code>d:\dev\opt\scoop\apps\vscode-insiders\1.84.0-insider+1696619477016\resources\app\node_modules.asar.unpacked\@vscode\ripgrep\bin\rg.exe --no-search-zip -- egggg . &gt; nul 2&gt;&amp;1</code></p>
<p>However apart from the first &quot;batch&quot; (the 12 checks for 7 binaries, each checking with and without <code>.exe</code>) that doesn&#x27;t seem to affecting timing as all batches after the first seem to be interleaved with actually accessing files so again hard to determine overall impact on time to result but suspect it&#x27;s negligible.</p>
<pre><code>15:21:12.0380088	rg.exe	33732	CreateFile	C:\Windows\gzip	NAME NOT FOUND	Desired Access: Read Attributes, Synchronize, Disposition: Open, Options: Synchronous IO Non-Alert, Attributes: n/a, ShareMode: Read, Write, Delete, AllocationSize: n/a
15:21:12.0381672	rg.exe	33732	CreateFile	C:\Windows\gzip.exe	NAME NOT FOUND	Desired Access: Read Attributes, Synchronize, Disposition: Open, Options: Synchronous IO Non-Alert, Attributes: n/a, ShareMode: Read, Write, Delete, AllocationSize: n/a
15:21:12.0387687	rg.exe	33732	CreateFile	C:\Windows\System32\gzip	NAME NOT FOUND	Desired Access: Read Attributes, Synchronize, Disposition: Open, Options: Synchronous IO Non-Alert, Attributes: n/a, ShareMode: Read, Write, Delete, AllocationSize: n/a
15:21:12.0390636	rg.exe	33732	CreateFile	C:\Windows\System32\gzip.exe	NAME NOT FOUND	Desired Access: Read Attributes, Synchronize, Disposition: Open, Options: Synchronous IO Non-Alert, Attributes: n/a, ShareMode: Read, Write, Delete, AllocationSize: n/a
15:21:12.0391482	rg.exe	33732	CreateFile	C:\Windows\System32\wbem\gzip	NAME NOT FOUND	Desired Access: Read Attributes, Synchronize, Disposition: Open, Options: Synchronous IO Non-Alert, Attributes: n/a, ShareMode: Read, Write, Delete, AllocationSize: n/a
15:21:12.0392555	rg.exe	33732	CreateFile	C:\Windows\System32\wbem\gzip.exe	NAME NOT FOUND	Desired Access: Read Attributes, Synchronize, Disposition: Open, Options: Synchronous IO Non-Alert, Attributes: n/a, ShareMode: Read, Write, Delete, AllocationSize: n/a
15:21:12.0396079	rg.exe	33732	CreateFile	C:\Program Files\Git\usr\bin\gzip	NAME NOT FOUND	Desired Access: Read Attributes, Synchronize, Disposition: Open, Options: Synchronous IO Non-Alert, Attributes: n/a, ShareMode: Read, Write, Delete, AllocationSize: n/a
...
15:21:12.0721815	rg.exe	33732	CreateFile	C:\Program Files\Git\usr\bin\uncompress	SUCCESS	Desired Access: Read Attributes, Synchronize, Disposition: Open, Options: Synchronous IO Non-Alert, Attributes: n/a, ShareMode: Read, Write, Delete, AllocationSize: n/a, OpenResult: Opened
15:21:12.0722041	rg.exe	33732	QueryInformationVolume	C:\Program Files\Git\usr\bin\uncompress	BUFFER OVERFLOW	VolumeCreationTime: 22/12/2020 10:02:21, VolumeSerialNumber: 388A-40A8, SupportsObjects: True, VolumeLabel: WinＡ燸
15:21:12.0722126	rg.exe	33732	QueryAllInformationFile	C:\Program Files\Git\usr\bin\uncompress	BUFFER OVERFLOW	CreationTime: 26/03/2023 12:11:15, LastAccessTime: 21/06/2023 16:27:50, LastWriteTime: 14/03/2023 06:10:34, ChangeTime: 26/03/2023 12:11:15, FileAttributes: A, AllocationSize: 4,096, EndOfFile: 2,346
15:21:12.0722229	rg.exe	33732	CloseFile	C:\Program Files\Git\usr\bin\uncompress	SUCCESS	

</code></pre>
<p>As I say, from a typical user&#x27;s perspective (of the type on Windows who uses ripgrep, so probably has Git Bash but probably hasn&#x27;t tuned their PATH to stop all the Windows application guff that front-runs normally) it certainly appears judging by Windows filesystem calls seems to be adding in the range of 30-150ms where these checks seem to be the only thing done, which can be a material part of the time.</p>
<p>Not sure if I can add anything more. I&#x27;m not really in a position to try compiling with and without these checks nor familiar enough with the code to know how much of the overall duration of a query on Windows is really due to this but I feel like the above is enough to show a real-world, material impact of timing on a typical Windows user&#x27;s setup?</p>
<p>Regarding the VSCode-ripgrep issue I believe it&#x27;s one for them to look into but just to summarise, if it&#x27;s of interest, the replicating conditions are: in VSCode running a search, or multiple searches, which uses rg.exe in the backend seemingly as a Node module, spawning several <code>rg.exe</code> processes concurrently AND having on one&#x27;s PATH a network drive (possibly only a Google Drive mount) that is searched. As far as I can tell this just happens to be the trigger but it&#x27;s unfortunate when it is actually unnecessary given how it&#x27;s used in VSCode.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-10-12 20:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:12 UTC
    </footer>
</body>
</html>
