<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>--files performance regression in 0.8.0 - BurntSushi/ripgrep #820</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>--files performance regression in 0.8.0</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/820">#820</a>
        opened by <a href="https://github.com/chrmarti">@chrmarti</a>
        on 2018-02-19 15:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/chrmarti">@chrmarti</a></div>
            <div class="timeline-body"><h4>What version of ripgrep are you using?</h4>
<p>0.8.0</p>
<h4>What operating system are you using ripgrep on?</h4>
<p>Windows 10</p>
<h4>If this is a bug, what are the steps to reproduce the behavior?</h4>
<p>Using an old commit of the Chromium sources (<code>git clone https://chromium.googlesource.com/chromium/src</code>) as corpus (~230k files).</p>
<p>With 0.8.0 <code>--files</code> runs about 4x longer:</p>
<pre><code>PS C:\devel\testWorkspace&gt; (Measure-Command { &amp; 'C:\devel\ripgrep-0.8.0-x86_64-pc-windows-msvc\rg.exe' --files | Measure-Object –Line | Out-Default }).TotalSeconds

 Lines Words Characters Property
 ----- ----- ---------- --------
234319 [files]

43.309153 [seconds]
</code></pre>
<p>Than with 0.7.1:</p>
<pre><code>PS C:\devel\testWorkspace&gt; (Measure-Command { &amp; 'C:\devel\ripgrep-0.7.1-x86_64-pc-windows-msvc\rg.exe' --files | Measure-Object –Line | Out-Default }).TotalSeconds

 Lines Words Characters Property
 ----- ----- ---------- --------
234319 [files]

11.2432563 [seconds]
</code></pre>
<p>Using Process Monitor it looks like 0.8.0 accesses individual files a lot more:
<img src="https://user-images.githubusercontent.com/9205389/36384556-fa76474a-158f-11e8-9c7a-208f270c1b0f.png" alt="image" /></p>
<p>Than 0.7.1, which seems to only access folders:
<img src="https://user-images.githubusercontent.com/9205389/36384611-27245f16-1590-11e8-8a2e-b54f6abe0b1c.png" alt="image" /></p>
<p>/cc @roblourens</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-02-20 01:55</div>
            <div class="timeline-body"><p>@chrmarti Thanks for another great bug report! I can indeed reproduce this. Your tip about ripgrep stat'ing more files is right on the money. Basically, this is fallout from fixing #705. In particular, in order to fix #705, I had to work-around the corresponding bug in Rust's standard library, and I was apparently careless enough that I introduced an extra stat call for each file that ripgrep visits. This should be possible to fix, but I'll need to take a closer look tomorrow.</p>
<p>Assuming I get this fixed, and after I get some of the PR backlog cleared, I can put out another release.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-02-20 01:57</div>
            <div class="timeline-body"><p>Note that this regression is <em>also</em> in walkdir, so it impacts both single threaded and multi-threaded directory traversal.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @BurntSushi on 2018-02-20 12:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2018-02-21 00:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-02-21 00:59</div>
            <div class="timeline-body"><p>This should be fixed in master. I manually QAed this and confirmed that performance is back to <code>0.7.1</code> levels for your specific test case. (Both single and multi threaded.)</p>
<p>If all goes well, I'm going to try and squeak a 0.8.1 release out tonight.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:42:27 UTC
    </footer>
</body>
</html>
