<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pcre2 reset match \K drops submatches - BurntSushi/ripgrep #2818</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>pcre2 reset match \K drops submatches</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/2818">#2818</a>
        opened by <a href="https://github.com/PiotrSokol">@PiotrSokol</a>
        on 2024-05-25 13:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/PiotrSokol">@PiotrSokol</a></div>
            <div class="timeline-body">Please tick this box to confirm you have reviewed the above.
<ul>
<li>[X] I have a different issue.</li>
</ul>
What version of ripgrep are you using?
<p>ripgrep 14.1.0</p>
<p>features:-simd-accel,+pcre2
simd(compile):+SSE2,+SSSE3,-AVX2
simd(runtime):+SSE2,+SSSE3,+AVX2</p>
<p>PCRE2 10.42 is available (JIT is available)</p>
How did you install ripgrep?
<p>Homebrew</p>
What operating system are you using ripgrep on?
<p>macos 13.4.1</p>
Describe your bug.
<p>First off, thank you for you wonderful work-- I can&#x27;t even explain how insanely helpful <code>rg</code> has been!</p>
<p>I&#x27;m using <code>--pcre2</code> and <code>\K</code> to deal with a (variable-length) lookbehind. rg returns the correct match, but fails to return a submatch.
I compared it to <code>(?&lt;=...)</code> which works fine for fixed-length patterns, see below.
And the problem persists regardless of using <code>--json</code>, I&#x27;m only using it here because it&#x27;s easier to demonstrate.</p>
What are the steps to reproduce the behavior?
<pre><code>echo -e &#x27;foo\nbar&#x27; &gt; test.txt
rg --pcre2 --multiline --json &#x27;foo\n\Kbar&#x27; test.txt
</code></pre>
What is the actual behavior?
<pre><code>{&quot;type&quot;:&quot;begin&quot;,&quot;data&quot;:{&quot;path&quot;:{&quot;text&quot;:&quot;test.txt&quot;}}}
{&quot;type&quot;:&quot;match&quot;,&quot;data&quot;:{&quot;path&quot;:{&quot;text&quot;:&quot;test.txt&quot;},&quot;lines&quot;:{&quot;text&quot;:&quot;bar\n&quot;},&quot;line_number&quot;:2,&quot;absolute_offset&quot;:4,&quot;submatches&quot;:[]}}
{&quot;type&quot;:&quot;end&quot;,&quot;data&quot;:{&quot;path&quot;:{&quot;text&quot;:&quot;test.txt&quot;},&quot;binary_offset&quot;:null,&quot;stats&quot;:{&quot;elapsed&quot;:{&quot;secs&quot;:0,&quot;nanos&quot;:44682,&quot;human&quot;:&quot;0.000045s&quot;},&quot;searches&quot;:1,&quot;searches_with_match&quot;:1,&quot;bytes_searched&quot;:8,&quot;bytes_printed&quot;:183,&quot;matched_lines&quot;:1,&quot;matches&quot;:0}}}
{&quot;data&quot;:{&quot;elapsed_total&quot;:{&quot;human&quot;:&quot;0.001371s&quot;,&quot;nanos&quot;:1370923,&quot;secs&quot;:0},&quot;stats&quot;:{&quot;bytes_printed&quot;:183,&quot;bytes_searched&quot;:8,&quot;elapsed&quot;:{&quot;human&quot;:&quot;0.000045s&quot;,&quot;nanos&quot;:44682,&quot;secs&quot;:0},&quot;matched_lines&quot;:1,&quot;matches&quot;:0,&quot;searches&quot;:1,&quot;searches_with_match&quot;:1}},&quot;type&quot;:&quot;summary&quot;}
</code></pre>
What is the expected behavior?
<p>running</p>
<pre><code>rg --pcre2 --multiline --json &#x27;(?&lt;=foo\n)bar&#x27; test.txt
</code></pre>
<p>returns</p>
<pre><code>{&quot;type&quot;:&quot;begin&quot;,&quot;data&quot;:{&quot;path&quot;:{&quot;text&quot;:&quot;test.txt&quot;}}}
{&quot;type&quot;:&quot;match&quot;,&quot;data&quot;:{&quot;path&quot;:{&quot;text&quot;:&quot;test.txt&quot;},&quot;lines&quot;:{&quot;text&quot;:&quot;bar\n&quot;},&quot;line_number&quot;:2,&quot;absolute_offset&quot;:4,&quot;submatches&quot;:[{&quot;match&quot;:{&quot;text&quot;:&quot;bar&quot;},&quot;start&quot;:0,&quot;end&quot;:3}]}}
{&quot;type&quot;:&quot;end&quot;,&quot;data&quot;:{&quot;path&quot;:{&quot;text&quot;:&quot;test.txt&quot;},&quot;binary_offset&quot;:null,&quot;stats&quot;:{&quot;elapsed&quot;:{&quot;secs&quot;:0,&quot;nanos&quot;:46237,&quot;human&quot;:&quot;0.000046s&quot;},&quot;searches&quot;:1,&quot;searches_with_match&quot;:1,&quot;bytes_searched&quot;:8,&quot;bytes_printed&quot;:225,&quot;matched_lines&quot;:1,&quot;matches&quot;:1}}}
{&quot;data&quot;:{&quot;elapsed_total&quot;:{&quot;human&quot;:&quot;0.001357s&quot;,&quot;nanos&quot;:1356890,&quot;secs&quot;:0},&quot;stats&quot;:{&quot;bytes_printed&quot;:225,&quot;bytes_searched&quot;:8,&quot;elapsed&quot;:{&quot;human&quot;:&quot;0.000046s&quot;,&quot;nanos&quot;:46237,&quot;secs&quot;:0},&quot;matched_lines&quot;:1,&quot;matches&quot;:1,&quot;searches&quot;:1,&quot;searches_with_match&quot;:1}},&quot;type&quot;:&quot;summary&quot;}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-05-25 13:52</div>
            <div class="timeline-body"><p>Thanks for the concise reproduction.</p>
<p>This is probably a <code>wontfix</code>. ripgrep doesn&#x27;t change how it uses PCRE2 APIs based on the presence or absence of <code>\K</code>. So if <code>\K</code> doesn&#x27;t work using standard APIs, then I think that&#x27;s just how the cookie crumbles.</p>
<p>If someone wants to dive in and see if this is actually fixable without needing to know about <code>\K</code> in a generic context, then I&#x27;d probably be willing to accept a patch if it&#x27;s small and non-invasive.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-05-25 13:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wontfix</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-05-25 13:53</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:14 UTC
    </footer>
</body>
</html>
