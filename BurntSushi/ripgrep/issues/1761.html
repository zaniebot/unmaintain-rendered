<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WalkBuilder: Improved API for adding multiple roots - BurntSushi/ripgrep #1761</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>WalkBuilder: Improved API for adding multiple roots</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/1761">#1761</a>
        opened by <a href="https://github.com/ssokolow">@ssokolow</a>
        on 2020-12-13 18:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ssokolow">@ssokolow</a></div>
            <div class="timeline-body"><p>In the creations I'm porting from Python or writing anew, the most common use I have for recursive directory traversal is to turn a mixture of file and directory paths given at the command line into a list of file paths to be processed.</p>
<p>While <code>ignore</code> and <code>walkdir</code> one-up Python's <code>os.walk</code> in one respect (I don't need to call <code>os.path.isdir</code> and bypass <code>os.walk</code> for non-directories), <code>WalkBuilder</code> makes taking a <code>Vec</code> of roots surprisingly un-ergonomic because the first one must be special-cased.</p>
<p>If I'm willing to mutate StructOpt's output (which I'd prefer to avoid), the simplest solution I've found is:</p>
<pre><code class="language-rust">    if let Some(path1) = opts.inpath.pop() {
        let mut builder = WalkBuilder::new(path1);
        for path in opts.inpath {
            builder.add(path);
        }
        for result in builder.build() {
            // TODO: Process each file
        }

    }
</code></pre>
<p>If I'm not willing to mutate it, then it's worse.</p>
<p>It reminds me of the awkwardness of using <code>Iterator::fold</code> when what's really needed is <code>Iterator::fold_first</code>.</p>
<p>I'd like to propose one of the following:</p>
<ul>
<li>Add a <code>WalkBuilder::empty()</code> constructor so I can call <code>add</code> for the first argument too.</li>
<li>Add a <code>WalkBuilder::from_iter()</code> constructor so I can just feed my <code>Vec</code> of roots directly to it.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-12-13 18:47</div>
            <div class="timeline-body"><p>This sounds fine to me, as long as the semantics for an empty walker are clear and the implementation matches those semantics. (The existing code I imagine has never needed to handle that case, since a walker always has at least one root by construction.) I don't expect this to be a challenge or anything, but it's easy to overlook.</p>
<p>PRs are welcome. I'm unlikely to do this myself any time soon, but could do it next time I'm in the code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @BurntSushi on 2020-12-13 18:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ssokolow">@ssokolow</a> on 2020-12-13 19:07</div>
            <div class="timeline-body"><p>Fair enough. I certainly won't have time to work on someone else's codebase until at least the new year, but I'll leave myself a note in case I can find time.</p>
<p>Do you have a preference between <code>WalkBuilder::empty()</code> and <code>WalkBuilder::from_iter()</code> or should I use my own judgment on which one to implement if I get to it first?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-12-13 19:09</div>
            <div class="timeline-body"><p>I like from_iter, but having both doesn't aeem like a terrible idea.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/SpyrosRoum">@SpyrosRoum</a> on 2021-08-15 09:11</div>
            <div class="timeline-body"><p>Hello, I'd like to give this a try, I just have a couple of questions:</p>
<ol>
<li>What should happen if you use <code>WalkBuilder::from_iter()</code> with an empty iterator?
I assume nothing, it would be the same as using <code>WalkBuilder::empty()</code></li>
<li>What should happen if you try to run <code>WalkBuilder::build()</code> but you haven't added any paths? Should it panic?</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kokounet">@kokounet</a> on 2022-03-24 23:25</div>
            <div class="timeline-body"><p>Hello, what's the status of this? I would be interested in this feature as well ðŸ˜„.</p>
<p>My opinion @SpyrosRoum for building an empty <code>WalkBuilder</code> is that it should work fine, but the built <code>Walk</code> should just have no items during iteration, that saves us from having to panic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jar-of-salt">@jar-of-salt</a> on 2026-01-09 02:58</div>
            <div class="timeline-body"><p>I am taking a stab at this, opening a PR shortly.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:43:17 UTC
    </footer>
</body>
</html>
