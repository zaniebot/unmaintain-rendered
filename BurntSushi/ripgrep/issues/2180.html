<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>jemalloc don't works on 16KB page kernel - BurntSushi/ripgrep #2180</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>jemalloc don&#x27;t works on 16KB page kernel</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/2180">#2180</a>
        opened by <a href="https://github.com/12101111">@12101111</a>
        on 2022-04-14 15:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/12101111">@12101111</a></div>
            <div class="timeline-body">What version of ripgrep are you using?
<p>13.0.0</p>
How did you install ripgrep?
<p>Gentoo: emerge sys-apps/ripgrep</p>
What operating system are you using ripgrep on?
<p>Gentoo Base System release 2.8 aarch64
Apple MacBook Pro (16-inch, M1 Max, 2021)
Linux 5.17.0-rc7-asahi-next-20220310+</p>
Describe your bug.
<pre><code>&lt;jemalloc&gt;: Unsupported system page size
&lt;jemalloc&gt;: Unsupported system page size
memory allocation of 5 bytes failed
zsh: abort (core dumped)  rg a
</code></pre>
What are the steps to reproduce the behavior?
<p>Built ripgrep on 4K page kernel, and run it on 16KB page kernel</p>
What is the actual behavior?
<p>It crash.</p>
What is the expected behavior?
<p>Many other malloc implementation does work on 16KB kernel and is better than jemaloc in code size and performance, such as mimalloc or rpmalloc.</p>
<p>See also: https://github.com/AsahiLinux/docs/wiki/Software-known-to-have-issues-with-16k-page-size</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2022-04-14 15:37</div>
            <div class="timeline-body"><p>This is ripgrep&#x27;s tracker, not jemalloc&#x27;s. I think you need to report this issue there.</p>
<p>The best work-around for you at the moment is probably to build ripgrep without jemalloc. Currently, jemalloc is only used when building for Linux with musl as the libc. Otherwise, it uses the system allocator.</p>
<p>You could, for example, remove:</p>
<p>https://github.com/BurntSushi/ripgrep/blob/ced5b92aa93eb47e892bd2fd26ab454008721730/Cargo.toml#L59-L60</p>
<p>and remove:</p>
<p>https://github.com/BurntSushi/ripgrep/blob/ced5b92aa93eb47e892bd2fd26ab454008721730/crates/core/main.rs#L42-L44</p>
<p>And then ripgrep should use whatever system allocator you have setup via your glibc. You might have perf regressions though. glibc&#x27;s allocator has been fine in my experiments, but musl&#x27;s has had noticeable perf problems.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2022-04-14 15:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2022-04-14 15:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wontfix</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2022-04-14 15:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/teohhanhui">@teohhanhui</a> on 2023-04-22 16:14</div>
            <div class="timeline-body"><p>Looks like jemalloc just needs to be configured with <code>--with-lg-page</code> to support 16K page size.</p>
<p>This can be achieved by setting the environment variable:</p>
<p><code>JEMALLOC_SYS_WITH_LG_PAGE=14</code> (16K page size)</p>
<p>Or to support 64K page size as well:</p>
<p><code>JEMALLOC_SYS_WITH_LG_PAGE=16</code> (64K page size)</p>
<p>In either case, it&#x27;d still work for 4K/16K(/64K) page sizes.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:12 UTC
    </footer>
</body>
</html>
