<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panic with --crlf due to integer underflow - BurntSushi/ripgrep #1765</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Panic with --crlf due to integer underflow</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/1765">#1765</a>
        opened by <a href="https://github.com/whatisaphone">@whatisaphone</a>
        on 2020-12-21 13:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/whatisaphone">@whatisaphone</a></div>
            <div class="timeline-body"><h4>What version of ripgrep are you using?</h4>
<p>ripgrep 12.1.1 (rev 7cb211378a)
-SIMD -AVX (compiled)
+SIMD -AVX (runtime)</p>
<h4>How did you install ripgrep?</h4>
<p>scoop install ripgrep</p>
<h4>What operating system are you using ripgrep on?</h4>
<p>Windows 10 Build 19041</p>
<h4>Describe your bug.</h4>
<p>With some regexes, combining --crlf with input that contains unix line endings causes a panic.</p>
<h4>What are the steps to reproduce the behavior?</h4>
<p>Minimal repro:</p>
<pre><code class="language-sh">echo '' | rg --crlf x?
</code></pre>
<p>Don't forget that <code>echo ''</code> writes a line terminator:</p>
<pre><code>echo '' | xxd
00000000: 0a                                       .
</code></pre>
<h4>What is the actual behavior?</h4>
<pre><code>echo '' | RUST_BACKTRACE=full rg --debug --crlf x?
</code></pre>
<pre><code>DEBUG|globset|crates\globset\src\lib.rs:431: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates\globset\src\lib.rs:431: built glob set; 0 literals, 3 basenames, 1 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
thread 'main' panicked at 'index out of bounds: the len is 1 but the index is 18446744073709551615', D:\a\ripgrep\ripgrep\crates\printer\src\standard.rs:1476:38
</code></pre>
<details>
<summary>You'll be disappointed with the stack trace, but I'm including it anyway, as requested</summary>

<pre><code>stack backtrace:
   0:     0x7ff61f25899e - &lt;unknown&gt;
   1:     0x7ff61f276f5c - &lt;unknown&gt;
   2:     0x7ff61f2548ac - &lt;unknown&gt;
   3:     0x7ff61f25bcbb - &lt;unknown&gt;
   4:     0x7ff61f25b908 - &lt;unknown&gt;
   5:     0x7ff61f25c496 - &lt;unknown&gt;
   6:     0x7ff61f25c01f - &lt;unknown&gt;
   7:     0x7ff61f275820 - &lt;unknown&gt;
   8:     0x7ff61f2757e7 - &lt;unknown&gt;
   9:     0x7ff61f030748 - &lt;unknown&gt;
  10:     0x7ff61f01f2c3 - &lt;unknown&gt;
  11:     0x7ff61f03db67 - &lt;unknown&gt;
  12:     0x7ff61f048c3c - &lt;unknown&gt;
  13:     0x7ff61f0109c5 - &lt;unknown&gt;
  14:     0x7ff61efad5b2 - &lt;unknown&gt;
  15:     0x7ff61ef91a57 - &lt;unknown&gt;
  16:     0x7ff61efc3ac4 - &lt;unknown&gt;
  17:     0x7ff61f0ad863 - &lt;unknown&gt;
  18:     0x7ff61f0a9d80 - &lt;unknown&gt;
  19:     0x7ff61eff8f66 - &lt;unknown&gt;
  20:     0x7ff61f25c786 - &lt;unknown&gt;
  21:     0x7ff61f0b1fc7 - &lt;unknown&gt;
  22:     0x7ff61f2c3920 - &lt;unknown&gt;
  23:     0x7ffc0fcb7034 - BaseThreadInitThunk
  24:     0x7ffc1015cec1 - RtlUserThreadStart
1:
</code></pre>
</details>

<h4>What is the expected behavior?</h4>
<p>ripgrep should not panic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @BurntSushi on 2020-12-21 14:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-12-21 14:16</div>
            <div class="timeline-body"><p>Thanks! Yeah, I stripped debug info from ripgrep binaries, which means stack traces are essentially useless from the release binaries. I should probably remove that from the issue template or request folks to compile ripgrep themselves with debug info. But in this case, the reproduction was simple enough:</p>
<pre><code>$ echo '' | rg --crlf 'x?'
thread 'main' panicked at 'index out of bounds: the len is 1 but the index is 18446744073709551615', /home/agallant/rust/ripgrep/crates/printer/src/standard.rs:1476:38
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre>
<p>Looks like it's just a simple bug where I assumed <code>end - 1</code> was always valid:</p>
<p>https://github.com/BurntSushi/ripgrep/blob/a6d05475fb353c756e88f605fd5366a67943e591/crates/printer/src/standard.rs#L1471-L1480</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rollup</span> added by @BurntSushi on 2021-05-31 01:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2021-06-01 01:51</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:43:17 UTC
    </footer>
</body>
</html>
