<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>emit log message when file is skipped becaue it was detected as &quot;binary&quot; data - BurntSushi/ripgrep #2246</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>emit log message when file is skipped becaue it was detected as &quot;binary&quot; data</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/2246">#2246</a>
        opened by <a href="https://github.com/asomers">@asomers</a>
        on 2022-06-24 15:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/asomers">@asomers</a></div>
            <div class="timeline-body"><h4>What version of ripgrep are you using?</h4>
<pre><code>ripgrep 13.0.0
+SIMD -AVX (compiled)
+SIMD +AVX (runtime)
</code></pre>
<h4>How did you install ripgrep?</h4>
<p>Through the FreeBSD ports collection</p>
<h4>What operating system are you using ripgrep on?</h4>
<p>FreeBSD 14.0-CURRENT amd64.  The file system is ZFS.</p>
<h4>Describe your bug.</h4>
<p>I have a directory with 552,900 entries, one for every version of every crate ever published to crates.io.  If I run <code>rg</code> with no PATH arguments, it finishes in about a minute with no results.  However, if I run it with specific PATH arguments then it finds plentiful results.  The likeliest explanation I can think of is that when recursing through <code>.</code>, rg doesn't iterate through every child.</p>
<h4>What are the steps to reproduce the behavior?</h4>
<p>First, create a fresh file system with at least 100 GB of space.  Then download every published crate, using a command similar to the following.  Note that <code>fetch</code> is a FreeBSD-specific command, and may be replaced by curl or wget.</p>
<pre><code>git clone https:â€‹//github.com/rust-lang/crates.io-index index
grep -hr . index/*/ | jq '.name + &quot;-&quot; + .vers + &quot;.tar.gz &quot; + &quot;https://crates.io/api/v1/crates/&quot; + .name + &quot;/&quot; + .vers + &quot;/download&quot;' -r | xargs -P100 -n2 fetch -o
</code></pre>
<p>Run this command to show which files match.  You can CTRL-C it after you're satisfied.</p>
<pre><code>ls | xargs -n 1000 rg -l -z '\bsigevent\b'`
</code></pre>
<p>Then run this command.  It will wrongly produce no output.</p>
<pre><code>rg -l -z '\bsigevent\b'
</code></pre>
<h4>What is the actual behavior?</h4>
<pre><code>&gt; rg --debug -l -z  '\bsigevent\b'
DEBUG|grep_regex::literal|crates/regex/src/literal.rs:180: required literal found: &quot;sigevent&quot;
DEBUG|grep_regex::matcher|crates/regex/src/matcher.rs:50: extracted fast line regex: (?-u:sigevent)
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|ignore::walk|crates/ignore/src/walk.rs:1741: ignoring ./.affected-packages.txt.swp: Ignore(IgnoreMatch(Hidden))
DEBUG|ignore::walk|crates/ignore/src/walk.rs:1741: ignoring ./.summary.txt.swp: Ignore(IgnoreMatch(Hidden))
DEBUG|ignore::walk|crates/ignore/src/walk.rs:1741: ignoring ./index/.git: Ignore(IgnoreMatch(Hidden))
DEBUG|ignore::walk|crates/ignore/src/walk.rs:1741: ignoring ./index/.github: Ignore(IgnoreMatch(Hidden))
</code></pre>
<h4>What is the expected behavior?</h4>
<p>It should have returned about 1353 files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2022-06-24 15:48</div>
            <div class="timeline-body"><p>Seems very likely that smart filtering is being applied here. Is the <code>--debug</code> log you posted complete? Because it should have the answer.</p>
<p>If it is a smart filtering issue then <code>rg -uuu -l -z '\bsigevent\b'</code> should show some results because <code>-uuu</code> disables all smart filtering.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/asomers">@asomers</a> on 2022-06-24 17:04</div>
            <div class="timeline-body"><p>Yep!  Using <code>--binary</code> fixed the problem.  Might I suggest that <code>-z</code> should imply <code>--binary</code> ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2022-06-24 17:09</div>
            <div class="timeline-body"><p>I don't see any reason why <code>-z</code> would imply <code>--binary</code>. All <code>-z</code> does is decompress files. That has nothing to do with whether the binary filter is used or not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2022-06-24 17:10</div>
            <div class="timeline-body"><p>I'll leave this open as a bug for now (not because of <code>-z</code> not implying <code>--binary</code>), but because ideally, there would be something in the <code>--debug</code> logs telling you that files were being skipped because they were detected as binary.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @BurntSushi on 2022-06-24 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Can't recurse over half a million children" to "emit log message when file is skipped becaue it was detected as "binary" data" by @BurntSushi on 2022-06-24 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/asomers">@asomers</a> on 2022-06-24 17:13</div>
            <div class="timeline-body"><p>Well, using <code>-z</code> implies that the user wants to search through binary files, because all compressed files are binary.  Without <code>--binary</code>, ripgrep won't search any compressed files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2022-06-24 17:14</div>
            <div class="timeline-body"><p>The <em>compressed</em> form of the file is binary, sure, but ripgrep isn't searching the compressed data. It's searching the <em>uncompressed</em> data. And that might not be binary.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2022-06-24 17:15</div>
            <div class="timeline-body"><p>It also looks like you might be trying to search <code>.tar.gz</code> files. ripgrep doesn't search archives like you might be expecting it to.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/asomers">@asomers</a> on 2022-06-24 17:39</div>
            <div class="timeline-body"><p>But it does search .tar.gz files.  For example:</p>
<pre><code>&gt; rg --binary -l -z  '\bsigevent\b'
pgx-pg-sys-0.1.1.tar.gz
rust-mio-0.1.0.tar.gz
libc-0.2.80.tar.gz
...
</code></pre>
<p>Do you mean that it won't display the matching lines?  I wouldn't expect that.  That's why I'm using <code>-l</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2022-06-24 17:58</div>
            <div class="timeline-body"><p>I didn't say ripgrep doesn't search .tar.gz files. Please read what I said more carefully. What I said was, ripgrep doesn't search archives like you might be expected it to. ripgrep searches <code>.tar</code> files like any other kind of file. What it doesn't do is extract archives into its constituent parts.</p>
<p>ripgrep sees the <code>.gz</code> extension and decompresses the <code>.tar.gz</code> file. That decompressed file is a tar archive. That tar archive, <em>in its decompressed state</em>, is itself a binary file. ripgrep will treat it like a binary file. This is correct and its <strong>totally and completely orthogonal to whether it was originally compressed or not</strong>.</p>
<p>The fact that a <code>.tar.gz</code> file decompresses to a binary file is a consequent of that specific file. But, say, <code>dict.txt.gz</code> decompresses to a plain text file with no binary data at all.</p>
<p>I don't know how to be any more clear than this. <code>-z/--search-zip</code> and <code>--binary</code> are totally and completely and 100% orthogonal.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/asomers">@asomers</a> on 2022-06-24 18:08</div>
            <div class="timeline-body"><p>Yes, I wasn't expecting ripgrep to extract the tar files.  But that was OK, because I was using <code>-l</code>.  The part I didn't get was the difference between a .tar.gz and a .txt.gz file.  Now I understand why -z shouldn't imply --binary .</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rollup</span> added by @BurntSushi on 2023-11-24 19:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2023-11-25 20:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:43:33 UTC
    </footer>
</body>
</html>
