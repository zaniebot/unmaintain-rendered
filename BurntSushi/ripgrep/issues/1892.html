<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rg 13.0.0 breaks integration with NeoVim - BurntSushi/ripgrep #1892</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>rg 13.0.0 breaks integration with NeoVim</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/1892">#1892</a>
        opened by <a href="https://github.com/datanoise">@datanoise</a>
        on 2021-06-13 19:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/datanoise">@datanoise</a></div>
            <div class="timeline-body"><p>I am using vim-grepper NeoVim plugin that uses new jobstart api to start ripgrep as a background process and uses callback functions to read the produced output. With the new ripgrep version 13.0.0, this plugin stopped working.</p>
<p>I have found that commit 020c5453a588025 cause this problem. Just as the comment to this commit suggested, the ripgrep completely blocks forever without reporting any output. Reverting this change, fixes the problem.</p>
<p>Is there a way to provide the command line option to disable checking for sockets in this method?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-06-13 19:32</div>
            <div class="timeline-body"><p>I'm not keen on adding flags to change stdin detection unless there is absolutely no other way.</p>
<p>I suppose the obvious question here is this: why is ripgrep being started with a socket attached to stdin that shouldn't be searched?</p>
<p>I tried to answer this question myself by looking at the <a href="https://github.com/mhinz/vim-grepper/blob/master/plugin/grepper.vim">plugin's source</a>, but couldn't really make sense of it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/datanoise">@datanoise</a> on 2021-06-13 21:07</div>
            <div class="timeline-body"><p>I believe that is how background job processing is implemented in NeoVim. NeoVim uses libuv with the event loop processing, which AFAIK is socket based.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-06-13 21:10</div>
            <div class="timeline-body"><p>Thanks for responding, but it doesn't really help my understanding here. Why is it attaching a socket to stdin in the first place?</p>
<p>I understand this is probably frustrating since ripgrep changed its behavior and caused a breakage here, but before I'm willing to implement a kludge or break somebody's else's patch, I need to understand whether the plugin itself is working correctly or not. It eould be very surprising to me if &quot;attach a socket to stdin&quot; was an unavoidable consequence of libuv, for example. Either something about my mental model is off, or something isn't quite right on the plugin side of things.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-06-13 21:11</div>
            <div class="timeline-body"><p>And note that a work around is very simple here. No flag is needed. Just pass <code>./</code> to ripgrep.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/datanoise">@datanoise</a> on 2021-06-13 21:33</div>
            <div class="timeline-body"><p>I've just checked and the plugin is working fine with the regular Vim. It must be something related to the way NeoVim implements the communication with the external processes. So I assumed that it is related to libuv, but I'm not 100% sure about it.</p>
<p>Passing <code>./</code> to ripgrep doesn't help with the problem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-06-13 21:36</div>
            <div class="timeline-body"><blockquote>
<p>Passing <code>./</code> to ripgrep doesn't help with the problem.</p>
</blockquote>
<p>That's quite interesting because that should disable stdin detection. Hmmm.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/datanoise">@datanoise</a> on 2021-06-13 21:38</div>
            <div class="timeline-body"><p>Maybe i'm using it incorrectly. Is this a correct way to run it?:</p>
<p><code>rg -H --no-heading --vimgrep is_socket ./</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-06-13 21:45</div>
            <div class="timeline-body"><p>Yes. That should not try to &quot;detect&quot; whether stdin is readable or not. But maybe my understanding is wrong. I'll check the code again once I'm back on a keyboard.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kevinhwang91">@kevinhwang91</a> on 2021-06-14 09:07</div>
            <div class="timeline-body"><pre><code class="language-diff">diff --git a/plugin/grepper.vim b/plugin/grepper.vim
index 73e4e36..40c455f 100644
--- a/plugin/grepper.vim
+++ b/plugin/grepper.vim
@@ -935,6 +935,7 @@ function! s:run(flags)
           \ 'on_stdout': function('s:on_stdout_nvim'),
           \ 'on_stderr': function('s:on_stdout_nvim'),
           \ 'on_exit':   function('s:on_exit'),
+          \ 'pty': 1
           \ }
     if !a:flags.stop
       let opts.stdout_buffered = 1
</code></pre>
<p>should work.
using pty option will close stdin. I'm not instead in a PR for vim-grepper. Free feel to borrow the idea. Because the plugin is not specified to rg, I don't know whether this cause the side effective for other tools.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blueyed">@blueyed</a> on 2021-06-14 13:28</div>
            <div class="timeline-body"><p>Note that this also affects other (Neovim) plugins, which used the workaround to append &quot;.&quot;: https://github.com/nvim-telescope/telescope.nvim/pull/908</p>
<blockquote>
<p>And note that a work around is very simple here. No flag is needed. Just pass <code>./</code> to ripgrep.</p>
</blockquote>
<p>Any specific reason to use <code>./</code>, or is <code>.</code> enough already / the same?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/datanoise">@datanoise</a> on 2021-06-14 13:43</div>
            <div class="timeline-body"><blockquote>
<pre><code class="language-diff">```diff
diff --git a/plugin/grepper.vim b/plugin/grepper.vim
index 73e4e36..40c455f 100644
--- a/plugin/grepper.vim
+++ b/plugin/grepper.vim
@@ -935,6 +935,7 @@ function! s:run(flags)
           \ 'on_stdout': function('s:on_stdout_nvim'),
           \ 'on_stderr': function('s:on_stdout_nvim'),
           \ 'on_exit':   function('s:on_exit'),
+          \ 'pty': 1
           \ }
     if !a:flags.stop
       let opts.stdout_buffered = 1
</code></pre>
<p>should work.
using pty option will close stdin. I'm not instead in a PR for vim-grepper. Free feel to borrow the idea. Because the plugin is not specified to rg, I don't know whether this cause the side effective for other tools.</p>
<pre><code></code></pre>
</blockquote>
<p>Thanks. That fixes the issue. It seems to work fine with other tools like <code>ag</code> and <code>grep</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @datanoise on 2021-06-14 13:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-06-14 23:03</div>
            <div class="timeline-body"><p>OK, doing a bit of a code walkthrough here, this is the implementation of <code>is_stdin_readable</code>:</p>
<p>https://github.com/BurntSushi/ripgrep/blob/7ce66f73cf7e76e9f2557922ac8e650eb02cf4ed/crates/cli/src/lib.rs#L183-L213</p>
<p>On Unix, this is getting a handle to stdin's file descriptor, <code>stat</code>ing it and returning true only if its file type is a regular file, a fifo or a socket. Finally, it only returns true if it knows that stdin is <em>not</em> a tty, which is done via <code>isatty</code>. This might actually be why the <code>pty</code> option works: AIUI, it causes <code>isatty(0)</code> to return <code>true</code> and thus <code>is_readable_stdin</code> would return <code>false</code> regardless of the file type detection.</p>
<p>So where is this used? It's used inside of ripgrep when determining which thing to search <em>when it is otherwise not given at least one thing to search</em> as a positional parameter:</p>
<p>https://github.com/BurntSushi/ripgrep/blob/7ce66f73cf7e76e9f2557922ac8e650eb02cf4ed/crates/core/args.rs#L1325-L1342</p>
<p>Whether <code>search_cwd</code> is true or not, in this case, I believe, depends completely on what <code>is_readable_stdin</code> (as defined above) returns. Namely, none of <code>--file</code>, <code>--files</code>, <code>--type-list</code> or <code>--pcre2-version</code> are given to <code>rg</code> here. Thus, in this case, ripgrep will only search the CWD if it believes that stdin is <em>not</em> readable. If the plugin runs ripgrep in a way that causes stdin to be open, <em>not</em> a tty and report itself as a socket, then indeed, ripgrep will consider stdin readable and choose to search it instead of the CWD.</p>
<p>The part where I'm getting hung up is that the <code>path_default</code> routine is <em>only</em> called when <em>no</em> paths are given to ripgrep:</p>
<p>https://github.com/BurntSushi/ripgrep/blob/7ce66f73cf7e76e9f2557922ac8e650eb02cf4ed/crates/core/args.rs#L554-L559</p>
<p>So, if you provide <code>./</code> (or <code>.</code>, they are indeed the same), then all this business about stdin sniffing is totally skipped. So the fact that <code>./</code> didn't work is quite surprising to me, and if there is an easy way to reproduce that outside of vim in a more controlled experiment, I would consider that a bug. My guess though is that there is probably something else going on.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-07-10 10:24</div>
            <div class="timeline-body"><p>A clarification: folks seem to think that I am holding a line here because I'm insisting on being &quot;technically correct&quot; here. That's <em>not</em> why I'm doing what I'm doing here. The <a href="https://github.com/BurntSushi/ripgrep/commit/020c5453a5880257c87949030550d24c596f5c8d">patch that broke neovim plugin integration</a> was fixing another bug. Perhaps a less prominent one, but not insignificant. So the choice here isn't between &quot;being pragmatic&quot; and &quot;being technically correct.&quot; The choice here is, &quot;who do we break?&quot;</p>
<p>(As far as I can tell anyway.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blueyed">@blueyed</a> on 2021-07-12 12:51</div>
            <div class="timeline-body"><p>@BurntSushi
What do you think of having an explicit flag (or env var) to control this?
The problem with the workaround in vim-grepper (Neovim) to append &quot;.&quot; (automatically always) is bad, since it does not allow to search sub-directories then only (by specifying &quot;pattern subdir&quot;), since it would get turned into &quot;rg â€¦ pattern subdir .&quot;.
(not appending &quot;.&quot; in that case (of having specified (a) subdir(s)) is not trivial, given there is a single input line only etc (https://github.com/mhinz/vim-grepper/issues/162))</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-07-12 13:08</div>
            <div class="timeline-body"><p>I'm not keen on adding flags for this. Especially since it looks like a temporary problem.</p>
<p>@blueyed Does the <a href="https://github.com/BurntSushi/ripgrep/issues/1892#issuecomment-860695447"><code>pty</code> trick above</a> not work for you? (Or maybe that's only available in <code>vim</code> and not <code>neovim</code>?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-07-12 13:09</div>
            <div class="timeline-body"><p>Crazy untested idea: is it possible to connect stdin to <code>/dev/null</code>? Does that work?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blueyed">@blueyed</a> on 2021-07-12 13:19</div>
            <div class="timeline-body"><p>@BurntSushi
I've tried to close stdin in Neovim, but it is likely too late then already (since it can only be done after the process was started; I've created https://github.com/neovim/neovim/issues/15068 to support this).</p>
<p>The pty-trick needs to be extended (https://github.com/mhinz/vim-grepper/issues/244#issuecomment-860755993), but might be what ends in vim-grepper if there is nothing better, like a fix/explicit flag in ripgrep.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wsdjeg">@wsdjeg</a> on 2021-08-07 01:03</div>
            <div class="timeline-body"><p>Why this issue is closed? does this bug have been fixed. I still can reproduce it in my plugin. https://github.com/SpaceVim/SpaceVim/issues/4329</p>
<p>neovim version is: v0.5.0 release</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-08-07 01:24</div>
            <div class="timeline-body"><p>The answer to your question is in the comments above. The problem isn't in ripgrep. Neovim is attaching a readable stdin file descriptor to every subprocess executed. There's even a PR against neovim to fix it. Work arounds have been documented above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wsdjeg">@wsdjeg</a> on 2021-08-07 01:51</div>
            <div class="timeline-body"><p>hmm. I do not know. But why old old version of rg works well for me. I need to lock my rg version to 0.10.0</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-08-07 01:54</div>
            <div class="timeline-body"><p>It's explained above. See the link to the commit that introduced this change for example.</p>
<p>You don't need to use an old version of ripgrep. Certainly not one that is many years old. Just use <code>rg foo ./</code> instead of <code>rg foo</code>.</p>
<p>Again, please read the comments above. It should all be explained. If you have specific questions to things said, feel free to ask.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ddeville">@ddeville</a> on 2021-08-20 21:44</div>
            <div class="timeline-body"><p>To close the loop here (and for those still following this issue), https://github.com/neovim/neovim/pull/14812 landed in Neovim and provides a way for <code>stdin</code> to not be piped when calling <code>jobstart</code>. vim-grepper was updated so that it uses that option in https://github.com/mhinz/vim-grepper/pull/250. This should fix the issue where ripgrep doesn't return any results when used from vim-grepper.</p>
<p>Note that the Neovim fix hasn't been pushed in an official release yet (that is 0.5 doesn't have it) and thus it requires using the nightly 0.6 Neovim build.</p>
<p>Thanks for your help investigating this @BurntSushi!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wsdjeg">@wsdjeg</a> on 2021-08-21 00:13</div>
            <div class="timeline-body"><p>@ddeville thanks, I am using 0.5.0 now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bellini666">@bellini666</a> on 2021-08-30 21:41</div>
            <div class="timeline-body"><p>For anyone comming here using vim-grepper, I have a suggestion to help you guys use it and also apply the workaround suggested by this comment: https://github.com/BurntSushi/ripgrep/issues/1892#issuecomment-894588622</p>
<p>I have a custom function that gets called by some keymappings that I ported from this plugin a while ago: https://github.com/vim-scripts/grep.vim . The function is:</p>
<pre><code class="language-vim">function! s:my_run_grep()
    let l:pattern = trim(input('Search for pattern: ', expand('&lt;cword&gt;')))
    if l:pattern == ''
      return
    endif
    let l:pattern = '&quot;' . substitute(l:pattern, '&quot;', '\&quot;', &quot;g&quot;) . '&quot;'
    echo &quot;\r&quot;

    let l:dirs = trim(input('Limit for directory: ', './', 'dir'))
    if l:dirs != ''
      let l:dirs = '&quot;' . l:dirs . '&quot;'
    endif
    echo &quot;\r&quot;

    let l:files = trim(input('Limit for files pattern: ', '*'))
    if l:files == '*'
      let l:files = ''
    else
      let l:files = '-g &quot;' . l:files . '&quot;'
    endif
    echo &quot;\r&quot;

    :echo &quot;GrepperRg &quot; . l:pattern . &quot; &quot; . l:dirs . &quot; &quot; . l:files
    :execute &quot;GrepperRg &quot; . l:pattern . &quot; &quot; . l:dirs . &quot; &quot; . l:files
endfunction

nnoremap &lt;silent&gt; &lt;Leader&gt;gr :call &lt;SID&gt;my_run_grep()&lt;CR&gt;
</code></pre>
<p>So, when I press <code>&lt;Leader&gt;gr</code> (as in Grep Recursive) I get prompted for the pattern, which is autocompleted by the word in my cursor, the directory that I want to run (by default I set it to <code>./</code> so it works on current neovim version, but I can very easily type and autocomplete other directories) and later to limit for an optional filetype (e.g. <code>*.py</code>). Also, note that the pattern can have spaces in it because of the way that I execute the command</p>
<p>It speeds up a lot of things for me. If I want to grep for the word in my in my cursor without limiting the directories or the filetypes I can just <code>&lt;Leader&gt;gr</code> and then press <code>&lt;Enter&gt;</code> 3 times in a row.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:43:23 UTC
    </footer>
</body>
</html>
