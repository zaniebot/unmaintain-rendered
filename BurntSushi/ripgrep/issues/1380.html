<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search does not stop with --max-count and --context with matches in the context lines - BurntSushi/ripgrep #1380</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Search does not stop with --max-count and --context with matches in the context lines</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/1380">#1380</a>
        opened by <a href="https://github.com/dsvf">@dsvf</a>
        on 2019-09-16 07:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dsvf">@dsvf</a></div>
            <div class="timeline-body"><h4>What version of ripgrep are you using?</h4>
<p>ripgrep 11.0.2
-SIMD -AVX (compiled)
+SIMD -AVX (runtime)</p>
<h4>How did you install ripgrep?</h4>
<p>Github binary release</p>
<h4>What operating system are you using ripgrep on?</h4>
<p>Linux, RHEL 7.7</p>
<h4>Describe your question, feature request, or bug.</h4>
<p>Unexpected behavior when combining --max-count with --context, if there are additional matches in the context. This is not really a bug, more like inconsistent behavior.</p>
<p>I am searching for the first match in one file and want to print the next <em>n</em> lines.
If there are no additional matches in the context, then the search output stops after the first result and prints the next <em>n</em> lines.
If there is an additional match within the next <em>n</em> lines, then (it seems like) rg treats this as a match and restarts its internal context line counter, printing an additional <em>n</em> lines.</p>
<p>I am aware that --max-count is a limit on per-line matches. But it <em>works</em> for some input files and it does not work for some other files, which is unexpected. Also, it appears somewhat similar to #402.</p>
<h4>If this is a bug, what are the steps to reproduce the behavior?</h4>
<pre><code>&gt; cat rgtest.txt
a
b
c
d
e
d
e
d
e
d
e
</code></pre>
<h4>If this is a bug, what is the actual behavior?</h4>
<p>Working as expected: Print first result and next line:</p>
<pre><code>&gt; rg -m 1 -A 1 d rgtest.txt
4:d
5-e
</code></pre>
<p>Working as expected: Do &quot;print first result and next line&quot; twice:</p>
<pre><code>&gt; rg -m 2 -A 1 d rgtest.txt
4:d
5-e
6:d
7-e
</code></pre>
<p>Unexpected: Print first result and next two lines</p>
<pre><code>&gt; rg -m 1 -A 2 d rgtest.txt
4:d
5-e
6:d
7-e
8:d
9-e
10:d
11-e
12-
</code></pre>
<p>Expected result:</p>
<pre><code>4:d
5-e
6:d
</code></pre>
<h4>If this is a bug, what is the expected behavior?</h4>
<p>Not a bug, but a wish for consistency (i.e. <em>please fix it for my specific use case</em>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-09-16 11:42</div>
            <div class="timeline-body"><p>This does actually look like a bug to me. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @BurntSushi on 2019-09-16 11:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jakubadamw">@jakubadamw</a> on 2019-09-22 09:58</div>
            <div class="timeline-body"><p>@BurntSushi, I was looking at what it would take to sensibly fix this and have come up with a rather invasive change that would involve making the <code>matched</code> family of methods in grep-searcher's <code>Sink</code> and <code>Core</code> return an enum of <code>{Quit, MatchAndContext, ContextOnly}</code> (naming to be bikeshedded as needed) instead of a <code>bool</code>.</p>
<p>https://github.com/BurntSushi/ripgrep/blob/8cb7271b647f63420530ac04bc13ed8ea7353690/grep-searcher/src/sink.rs#L121-L125</p>
<p>Does that sound reasonable?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-09-22 12:50</div>
            <div class="timeline-body"><p>I haven't investigated this yet, so I'm not sure if it's reasonable or not. I'd certainly prefer to avoid breaking changes, and in particular, avoid complicating the API like this. But as I said, I haven't dug into this so I'm not sure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rollup</span> added by @BurntSushi on 2021-05-31 00:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2021-06-01 01:51</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:43:01 UTC
    </footer>
</body>
</html>
