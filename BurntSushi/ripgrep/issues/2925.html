<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Default thread heuristic no longer a good choice in Mac OSX Sequoia - BurntSushi/ripgrep #2925</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Default thread heuristic no longer a good choice in Mac OSX Sequoia</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/2925">#2925</a>
        opened by <a href="https://github.com/jchien14">@jchien14</a>
        on 2024-11-07 18:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jchien14">@jchien14</a></div>
            <div class="timeline-body">Please tick this box to confirm you have reviewed the above.
<ul>
<li>[X] I have a different issue.</li>
</ul>
What version of ripgrep are you using?
<p>x86_64 ripgrep 14.1.1</p>
How did you install ripgrep?
<p>Homebrew</p>
What operating system are you using ripgrep on?
<p>macOS 15.1</p>
Describe your bug.
<p>I upgraded from macOS 14.7 to 15.1 last night. Since then, I noticed ripgrep on my repo regressed from ~2s a search to ~10s</p>
<pre><code>rg foo 1.28s user 108.10s system 1104% cpu 9.901 total
rg foo 1.40s user 85.94s system 882% cpu 9.898 total
</code></pre>
<p>From empirically testing, it appears that <code>--threads 3</code> provides the ideal behavior (my CPU has 14 cores)</p>
<pre><code>rg --threads 4 foo  0.78s user 7.55s system 360% cpu 2.307 total
rg --threads 4 foo  0.76s user 7.64s system 392% cpu 2.143 total
rg --threads 4 foo  0.77s user 7.38s system 389% cpu 2.092 total
rg --threads 3 foo  0.76s user 5.48s system 286% cpu 2.179 total
rg --threads 3 foo  0.76s user 5.98s system 290% cpu 2.321 total
rg --threads 3 foo  0.75s user 5.78s system 289% cpu 2.255 total
rg --threads 3 foo  0.78s user 5.89s system 293% cpu 2.270 total
</code></pre>
<p>It looks like the current default is 12. Not sure what changed in 15.1 but two other people reproed this as well upon upgrading, one with a laptop with most system extensions uninstalled, so I don&#x27;t think it&#x27;s a bad interaction with a piece of third-party software on 15.1.</p>
What are the steps to reproduce the behavior?
<p>Run any ripgrep search without specifying the number of threads on 15.1</p>
What is the actual behavior?
<p>Slow query, 10s in a relatively large repository I tested</p>
What is the expected behavior?
<p>~1-2 seconds on OSX. For reference, ripgrepping this repo on Ubuntu is ~600ms</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-11-07 18:17</div>
            <div class="timeline-body"><p>Can you provide a benchmark I can run please?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-11-07 18:18</div>
            <div class="timeline-body"><p>2s -&gt; 10s feels like a mammoth change. Feels like something else is going on here personally.</p>
<p>I doubt the default heuristic is going to change any time soon, so you&#x27;ll definitely want to make a ripgrep config file or something with your preferred default.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jchien14">@jchien14</a> on 2024-11-07 18:25</div>
            <div class="timeline-body"><p>Not sure what you mean by a benchmark -- unfortunately, I don&#x27;t have a framework or anything, just a few reports amongst coworkers.</p>
<p>Here&#x27;s a process sample (16 threads)
<a href="https://github.com/user-attachments/files/17667706/rg_2024-11-07_101925_9S3I.sample.txt">rg_2024-11-07_101925_9S3I.sample.txt</a>
I wonder if 15.1 has worse max parallelism at opening and closing file handles?</p>
<p>Currently working around it with a config file to get the previous performance with the config file, but wanted to document this in case anyone else hits it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-11-07 18:28</div>
            <div class="timeline-body"><p>This is your benchmark:</p>
<blockquote>
<p>I noticed ripgrep on my repo regressed from ~2s a search to ~10s</p>
</blockquote>
<p>But I can&#x27;t run this. Can you share a benchmark that I can run please? For example, consider trying on an open source repository that we can both access. Like maybe the Linux kernel or Chromium.</p>
<p>The first step in diagnosing performance problems is having a shared reality. <em>Sometimes</em> that&#x27;s not possible. But if the problem here is truly as general as &quot;more threads is dramatically slower,&quot; then it should ideally reproduce on another repo.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-11-07 18:28</div>
            <div class="timeline-body"><p>And yes, thank you for reporting this! I appreciate it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jchien14">@jchien14</a> on 2024-11-08 04:00</div>
            <div class="timeline-body"><p>Following the instructions here for a fresh checkout of Chromium on Mac: https://chromium.googlesource.com/chromium/src/+/main/docs/mac_build_instructions.md#Install</p>
<p>Results are quite different:</p>
<pre><code>rg --threads 12 testtesttest  4.67s user 263.67s system 893% cpu 30.029 total
rg --threads 11 testtesttest  5.53s user 194.23s system 709% cpu 28.156 total
rg --threads 10 testtesttest  5.32s user 105.07s system 524% cpu 21.043 total
rg --threads 9 testtesttest  5.02s user 70.38s system 404% cpu 18.660 total
rg --threads 8 testtesttest  4.83s user 57.36s system 327% cpu 18.968 total
rg --threads 7 testtesttest  4.71s user 51.42s system 272% cpu 20.628 total
rg --threads 6 testtesttest  4.60s user 47.50s system 230% cpu 22.561 total
rg --threads 5 testtesttest  4.41s user 43.28s system 184% cpu 25.837 total
rg --threads 4 testtesttest  4.58s user 42.68s system 146% cpu 32.208 total
rg --threads 3 testtesttest  5.20s user 46.57s system 117% cpu 43.994 total
</code></pre>
<p>Don&#x27;t have much time until the weekend to do more samples than n=1, and also investigate the differences in file size/# files that might account for it (the chromium repo is much bigger than the one I was testing on).</p>
<p>It is quite interesting that there&#x27;s appears there&#x27;s an optimum in terms of both wall-time that&#x27;s different than the optimum for CPU usage (for the repo I was testing on they were the same). Performance starts going down significantly after the optimum. Unfortunately, I no longer can test on 14.7 to compare.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-09-23 01:48</div>
            <div class="timeline-body"><p>I did this on my M2 mac mini on a checkout of the Linux kernel:</p>
<pre><code>$ hyperfine -i &#x27;rg ZQZQZQZQZQ&#x27; &#x27;rg ZQZQZQZQZQ -j1&#x27; &#x27;rg ZQZQZQZQZQ -j2&#x27; &#x27;rg ZQZQZQZQZQ -j3&#x27; &#x27;rg ZQZQZQZQZQ -j4&#x27; &#x27;rg ZQZQZQZQZQ -j5&#x27; &#x27;rg ZQZQZQZQZQ -j6&#x27; &#x27;rg ZQZQZQZQZQ -j7&#x27; &#x27;rg ZQZQZQZQZQ -j8&#x27; &#x27;rg ZQZQZQZQZQ -j9&#x27; &#x27;rg ZQZQZQZQZQ -j10&#x27; &#x27;rg ZQZQZQZQZQ -j11&#x27; &#x27;rg ZQZQZQZQZQ -j12&#x27; &#x27;rg ZQZQZQZQZQ -j13&#x27;
</code></pre>
<p>And got this summary:</p>
<pre><code>Summary
  rg ZQZQZQZQZQ -j4 ran
    1.03 ± 0.01 times faster than rg ZQZQZQZQZQ -j5
    1.04 ± 0.01 times faster than rg ZQZQZQZQZQ -j9
    1.04 ± 0.01 times faster than rg ZQZQZQZQZQ -j12
    1.04 ± 0.01 times faster than rg ZQZQZQZQZQ -j10
    1.04 ± 0.01 times faster than rg ZQZQZQZQZQ -j11
    1.04 ± 0.01 times faster than rg ZQZQZQZQZQ
    1.04 ± 0.01 times faster than rg ZQZQZQZQZQ -j8
    1.04 ± 0.01 times faster than rg ZQZQZQZQZQ -j13
    1.05 ± 0.01 times faster than rg ZQZQZQZQZQ -j6
    1.05 ± 0.01 times faster than rg ZQZQZQZQZQ -j7
    1.30 ± 0.01 times faster than rg ZQZQZQZQZQ -j3
    1.81 ± 0.01 times faster than rg ZQZQZQZQZQ -j2
    3.30 ± 0.02 times faster than rg ZQZQZQZQZQ -j1
</code></pre>
<p>So <code>-j4</code> is technically the best here, but its difference with the others (including ripgrep&#x27;s default heuristic) is effectively immaterial. This doesn&#x27;t look like compelling enough evidence for me to change the heuristic.</p>
<p>With that said...</p>
<pre><code>$ sw_vers
ProductName:            macOS
ProductVersion:         13.4
BuildVersion:           22F66
</code></pre>
<p>So... my results above are probably bunk. Sigh.</p>
<p>This one will have to stay open and wait for me to get a chance to update my mac mini. I usually only ssh into it on my LAN, and I&#x27;m not sure how to make it upgrade that way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-09-23 01:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-10-11 01:33</div>
            <div class="timeline-body"><p>OK, so I&#x27;ve finally upgraded my mac mini:</p>
<pre><code>$ sw_vers
ProductName:            macOS
ProductVersion:         26.0.1
BuildVersion:           25A362
</code></pre>
<p>And I re-ran my <code>hyperfine</code> command from above:</p>
<pre><code>Summary
  rg ZQZQZQZQZQ -j4 ran
    1.21 ± 0.01 times faster than rg ZQZQZQZQZQ -j3
    1.35 ± 0.01 times faster than rg ZQZQZQZQZQ -j5
    1.61 ± 0.05 times faster than rg ZQZQZQZQZQ -j2
    1.73 ± 0.04 times faster than rg ZQZQZQZQZQ -j6
    2.19 ± 0.02 times faster than rg ZQZQZQZQZQ -j7
    2.57 ± 0.09 times faster than rg ZQZQZQZQZQ -j8
    2.80 ± 0.64 times faster than rg ZQZQZQZQZQ
    2.86 ± 0.05 times faster than rg ZQZQZQZQZQ -j1
    2.93 ± 0.10 times faster than rg ZQZQZQZQZQ -j9
    3.18 ± 0.09 times faster than rg ZQZQZQZQZQ -j10
    3.22 ± 0.12 times faster than rg ZQZQZQZQZQ -j11
    3.27 ± 0.12 times faster than rg ZQZQZQZQZQ -j12
    3.33 ± 0.14 times faster than rg ZQZQZQZQZQ -j13
</code></pre>
<p>Ummm. Wow. Lol. What a difference.</p>
<p>The problem is that if I run it on something else (like my clone of <code>chromium</code>):</p>
<pre><code>Summary
  rg ZQZQZQZQZQ -j8 ran
    1.69 ± 0.09 times faster than rg ZQZQZQZQZQ -j4
</code></pre>
<p>Then <code>-j8</code> is noticeably faster.</p>
<p>So I&#x27;m afraid there isn&#x27;t really a consistent and obviously better heuristic that I can choose here. So I think I have to defer to the status quo? Not sure.</p>
<p>It&#x27;s also possible Apple fucked something up and they&#x27;ll fix it in a future release. I don&#x27;t know.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-10-11 01:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wontfix</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-10-11 01:34</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:14 UTC
    </footer>
</body>
</html>
