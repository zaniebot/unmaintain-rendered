<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`rg --help | rg` panics - BurntSushi/ripgrep #1125</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>rg --help | rg</code> panics</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/1125">#1125</a>
        opened by <a href="https://github.com/nextzhou">@nextzhou</a>
        on 2018-11-28 09:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/nextzhou">@nextzhou</a></div>
            <div class="timeline-body">What version of ripgrep are you using?
<p>ripgrep 0.10.0
-SIMD -AVX (compiled)
+SIMD +AVX (runtime)</p>
How did you install ripgrep?
<p>cargo install ripgrep</p>
What operating system are you using ripgrep on?
<p>opensuse leap 15
Linux miair 4.12.14-lp150.12.25-default #1 SMP Thu Nov 1 06:14:23 UTC 2018 (3fcf457) x86_64 x86_64 x86_64 GNU/Linux</p>
Describe your question, feature request, or bug.
<p>panic</p>
If this is a bug, what are the steps to reproduce the behavior?
<p><code>$ rg --help | rg</code></p>
If this is a bug, what is the actual behavior?
<pre><code>▶ RUST_BACKTRACE=1 rg --help | rg
error: The following required arguments were not provided:
    &lt;PATTERN&gt;

USAGE:

    rg [OPTIONS] PATTERN [PATH ...]
    rg [OPTIONS] [-e PATTERN ...] [-f PATTERNFILE ...] [PATH ...]
    rg [OPTIONS] --files [PATH ...]
    rg [OPTIONS] --type-list
    command | rg [OPTIONS] PATTERN

For more information try --help
thread &#x27;main&#x27; panicked at &#x27;Error writing Error to stdout: Os { code: 32, kind: BrokenPipe, message: &quot;Broken pipe&quot; }&#x27;, src/libcore/result.rs:1009:5
stack backtrace:
   0: std::sys::unix::backtrace::tracing::imp::unwind_backtrace
             at src/libstd/sys/unix/backtrace/tracing/gcc_s.rs:49
   1: std::sys_common::backtrace::_print
             at src/libstd/sys_common/backtrace.rs:71
   2: std::panicking::default_hook::{{closure}}
             at src/libstd/sys_common/backtrace.rs:59
             at src/libstd/panicking.rs:211
   3: std::panicking::default_hook
             at src/libstd/panicking.rs:227
   4: std::panicking::rust_panic_with_hook
             at src/libstd/panicking.rs:476
   5: std::panicking::continue_panic_fmt
             at src/libstd/panicking.rs:390
   6: rust_begin_unwind
             at src/libstd/panicking.rs:325
   7: core::panicking::panic_fmt
             at src/libcore/panicking.rs:77
   8: core::result::unwrap_failed
             at /rustc/1f57e4841157d5cbd4c4e22018f93bd1801c98c2/src/libcore/macros.rs:26
   9: clap::errors::Error::exit
             at /rustc/1f57e4841157d5cbd4c4e22018f93bd1801c98c2/src/libcore/result.rs:835
             at ./.cargo/registry/src/mirrors.ustc.edu.cn-61ef6e0cd06fb9b8/clap-2.32.0/src/errors.rs:400
  10: clap::app::App::get_matches
             at ./.cargo/registry/src/mirrors.ustc.edu.cn-61ef6e0cd06fb9b8/clap-2.32.0/src/app/mod.rs:1529
             at /rustc/1f57e4841157d5cbd4c4e22018f93bd1801c98c2/src/libcore/result.rs:774
             at ./.cargo/registry/src/mirrors.ustc.edu.cn-61ef6e0cd06fb9b8/clap-2.32.0/src/app/mod.rs:1513
             at ./.cargo/registry/src/mirrors.ustc.edu.cn-61ef6e0cd06fb9b8/clap-2.32.0/src/app/mod.rs:1455
  11: rg::args::Args::parse
             at ./.cargo/registry/src/mirrors.ustc.edu.cn-61ef6e0cd06fb9b8/ripgrep-0.10.0/src/args.rs:131
  12: rg::main
             at ./.cargo/registry/src/mirrors.ustc.edu.cn-61ef6e0cd06fb9b8/ripgrep-0.10.0/src/main.rs:39
  13: std::rt::lang_start::{{closure}}
             at /rustc/1f57e4841157d5cbd4c4e22018f93bd1801c98c2/src/libstd/rt.rs:74
  14: std::panicking::try::do_call
             at src/libstd/rt.rs:59
             at src/libstd/panicking.rs:310
  15: __rust_maybe_catch_panic
             at src/libpanic_unwind/lib.rs:102
  16: std::rt::lang_start_internal
             at src/libstd/panicking.rs:289
             at src/libstd/panic.rs:398
             at src/libstd/rt.rs:58
  17: main
  18: __libc_start_main
  19: _start
             at ../sysdeps/x86_64/start.S:120
</code></pre>
If this is a bug, what is the expected behavior?
<p>print error message</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-11-28 10:25</div>
            <div class="timeline-body"><p>Nice. Thanks for the bug report. This is almost certainly a bug in our arg parser, clap.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sergeevabc">@sergeevabc</a> on 2018-12-01 16:12</div>
            <div class="timeline-body"><p>This does not work either.
<code>rg pattern file | some-command</code>
So, pipes are broken for now?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-12-01 16:24</div>
            <div class="timeline-body"><p>@sergeevabc &quot;does not work&quot; is almost never a satisfactory bug report. I have no idea what you mean. Please consider including a reproducible example, along with input, actual output and expected output. In the future, it would be helpful if you could just do that from the start.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sergeevabc">@sergeevabc</a> on 2018-12-01 18:09</div>
            <div class="timeline-body"><p>Ah, I solved my case, turns out it’s irrelevant to the initial report. Happy troubleshooting nonetheless.</p>
<blockquote>
<p>wget https://moz.com/top500/domains/csv -O csv
rg -N &quot;.*\&quot;(.*)/.*&quot; -r $1 csv | sort</p>
</blockquote>
<p>did not work</p>
<blockquote>
<p>…
rg -N &quot;.*\x22(.*)/.*&quot; -r $1 csv | sort</p>
</blockquote>
<p>worked as soon as <code>\&quot;</code> was replaced with <code>\x22</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-12-01 20:22</div>
            <div class="timeline-body"><p>@sergeevabc I see no panic running any of those commands.</p>
<p>I&#x27;m going to ask you one more time: please do not simply say, &quot;does not work.&quot; Instead, <strong>show the expected output and the actual output</strong>.</p>
<p>If you have an issue unrelated to this one, then <strong>file a new issue and fill out the issue template</strong>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sinistersnare">@sinistersnare</a> on 2018-12-05 20:01</div>
            <div class="timeline-body"><p>Sorry if I am not contributing much but I am getting a similar panic:</p>
<pre><code>client-195:directory sinistersnare$ rg --help | rg &quot;-i&quot;
error: The following required arguments were not provided:
    &lt;PATTERN&gt;

USAGE:

    rg [OPTIONS] PATTERN [PATH ...]
    rg [OPTIONS] [-e PATTERN ...] [-f PATTERNFILE ...] [PATH ...]
    rg [OPTIONS] --files [PATH ...]
    rg [OPTIONS] --type-list
    command | rg [OPTIONS] PATTERN

For more information try --help
thread &#x27;main&#x27; panicked at &#x27;Error writing Error to stdout: Os { code: 32, kind: BrokenPipe, message: &quot;Broken pipe&quot; }&#x27;, libcore/result.rs:945:5
note: Run with `RUST_BACKTRACE=1` for a backtrace.
</code></pre>
<p>but this works:</p>
<pre><code>client-195:directory sinistersnare$ echo &quot;yo&quot; | rg &quot;y&quot;
yo
</code></pre>
<p>And this does not crash:</p>
<pre><code>client-195:directory sinistersnare$ echo &quot;yo&quot; | rg &quot;-i&quot;
error: The following required arguments were not provided:
    &lt;PATTERN&gt;

USAGE:

    rg [OPTIONS] PATTERN [PATH ...]
    rg [OPTIONS] [-e PATTERN ...] [-f PATTERNFILE ...] [PATH ...]
    rg [OPTIONS] --files [PATH ...]
    rg [OPTIONS] --type-list
    command | rg [OPTIONS] PATTERN

For more information try --help
</code></pre>
<p>It seems it is an issue with argument parsing. I hope this helps a little.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rumpelsepp">@rumpelsepp</a> on 2018-12-10 09:49</div>
            <div class="timeline-body"><p>I did a bisect, bb110c1ebeeda452046830b3991f705f5759da92 is the first commit (that builds) that shows the issue. A reproducer is: <code>./target/debug/rg --help | ./target/debug/rg</code></p>
<p>The first <code>rg</code> process dies with broken pipe, because the second process has exited.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;panic&quot; to &quot;`rg --help | rg` panics&quot; by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-01-24 01:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-01-24 01:26</div>
            <div class="timeline-body"><p>I believe the fix here is to use <a href="https://docs.rs/clap/2.32.0/clap/struct.App.html#method.get_matches_safe"><code>clap::App::get_matches_safe</code></a> and print the help message ourselves with proper error handling, as mentioned <a href="https://github.com/BurntSushi/ripgrep/issues/1159#issuecomment-453497493">here</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-01-24 01:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-01-26 21:01</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:07 UTC
    </footer>
</body>
</html>
