<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>&quot;Colour wrapping&quot; - BurntSushi/ripgrep #2161</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>&quot;Colour wrapping&quot;</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/2161">#2161</a>
        opened by <a href="https://github.com/gvanem">@gvanem</a>
        on 2022-03-12 10:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gvanem">@gvanem</a></div>
            <div class="timeline-body"><h4>What version of ripgrep are you using?</h4>
<p>ripgrep 13.0.0, -SIMD -AVX (compiled)</p>
<h4>How did you install ripgrep?</h4>
<p>Built it myself by <code>cargo build  --all --release --features pcre2</code></p>
<h4>What operating system are you using ripgrep on?</h4>
<p>Win-10, 21H1, ver. 19043.1586.</p>
<h4>Describe your bug.</h4>
<p>As part of a <code>pygrep.bat</code> file I use RipGrep like:</p>
<pre><code>setlocal
set RG_COLORS=--colors &quot;match:fg:white&quot; --colors &quot;match:bg:red&quot; ^
              --colors &quot;path:fg:green&quot;  --colors &quot;path:style:intense&quot; ^
              --colors &quot;line:bg:blue&quot;   --colors &quot;line:style:intense&quot;   --colors &quot;line:fg:white&quot; ^
              --colors &quot;column:bg:blue&quot; --colors &quot;column:style:intense&quot; --colors &quot;column:fg:green&quot;

::
:: handle option '-c' to set RG_OPTIONS=-i' etc. etc.
::
rg.exe --after-context=1 --mmap --fixed-strings f:\ProgramFiler\Python27\test %RG_OPTIONS% %RG_COLORS%  %*
</code></pre>
<p>With the Windows console width set to 120,  a command like <code>pygrep.bat IP2Location</code>, shows this:
<img src="https://user-images.githubusercontent.com/945271/158013562-c8e1a670-3278-4df1-ace1-7c85f47dbc0d.png" alt="pygrep-rg-colours" /></p>
<p>the red colour bleeds over to the next line marking a non-match.</p>
<h4>What is the expected behaviour?</h4>
<p>With the WinConsole width set to e.g. 130, there is no problem. A <code>cls &amp; pygrep.bat IP2Location</code>, shows this:
<img src="https://user-images.githubusercontent.com/945271/158013673-1280bf8d-43bf-4264-b068-68c22444f944.png" alt="pygrep-rg-colours-130" /></p>
<p>In lack of a better description, I named this &quot;<em>Colour wrapping</em>&quot;. I've no idea what's the real issue here.
<strong>But</strong> this depends on which Y-position the .bat-file was invoked on. It's as if a 1 line scroll when <code>&quot;match:bg:red&quot;</code> is in
effect causes this <em>bleeding</em>. Since if I increase the console <strong>height</strong> to avoid a scroll, then there's no <em>bleeding</em>.</p>
<p><em>PS</em>. I wrote that <code>netstat.py</code> script using <a href="https://github.com/giampaolo/psutil">psutil</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2022-03-12 13:35</div>
            <div class="timeline-body"><p>This feels more like a rendering bug than a problem with ripgrep. Regardless, I'm not a Windows user. Someone else will have to debug this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gskt17">@gskt17</a> on 2022-03-18 01:00</div>
            <div class="timeline-body"><p>I'm on windows, so I can look into this. That said, I'm also not an expert on Windows. My <em>guess</em> would be this has something to do with the way the Windows console writes wrapped lines; it looks to me like what happened was that after writing the <code>i</code> in <code>IP2Location</code>, the cursor moved down and then back to the beginning of the line, setting the background and foreground colors at each location along the way. I suspect that this is documented behavior somewhere? I think the fix will probably go in <code>termcolor</code> and not <code>rg</code>, if a fix is even possible.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gskt17">@gskt17</a> on 2022-03-18 20:51</div>
            <div class="timeline-body"><p><a href="https://github.com/JanDeDobbeleer/oh-my-posh/issues/65">It seems like this issue is known</a></p>
<p>It may be related to these resizing bugs:</p>
<ul>
<li>https://github.com/microsoft/terminal/issues/32</li>
<li>https://stackoverflow.com/questions/66123718/write-host-with-background-colour-fills-the-entire-line-with-background-colour-w</li>
</ul>
<p>Clearing the remainder of the line when writing a newline (per https://github.com/JanDeDobbeleer/oh-my-posh/issues/65) will apparently produce the correct behavior.</p>
<p>@BurntSushi: <a href="https://docs.microsoft.com/en-us/windows/console/console-virtual-terminal-sequences">Apparently, Windows already has VT100 (ANSI) escape sequence support.</a> They still require accessing the Windows console API to enable, but if I'm reading the docs correctly, they should work the same way any other OS does. I think they probably exist because of the Linux subsystem in Windows 10.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gvanem">@gvanem</a> on 2022-03-19 05:58</div>
            <div class="timeline-body"><p>@gskt17 Your links mentions PowerShell for the most part. I forgot to say I'm using <a href="http://www.jpsoft.com">4NT</a> as my shell.
So the bug is in probably in the underlaying conhost process.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gskt17">@gskt17</a> on 2022-03-29 19:09</div>
            <div class="timeline-body"><p>@gvanem Sorry for late reply, but the bug seems to be present in any shell on Windows, so I think you're correct.</p>
<p>@BurntSushi What would you say the best way to insert a line clear just before a newline is written in the output functions? I think I've found a place but I can't say for sure.</p>
<p>I've hit another snag, too: Windows API doesn't offer the equivalent to &quot;clear to remainder of line,&quot; only VT mode does, so I would need to manually change the remainder of the line on wrapping. I'm going to see about forking <code>termcolor</code> to add some of that functionality. Also, I should note that the bug only takes place on write and resizing the console immediately fixes it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2022-03-29 22:58</div>
            <div class="timeline-body"><p>To be honest, I just don't really have the bandwidth right now to dig into this. The Windows console API is indeed quite limited. On the other hand, it's been quite some time (years now) since Windows supported ANSI color escapes. So if you fix it for ANSI escapes, that might be enough.</p>
<p>The right place for this to go is indeed probably in <code>termcolor</code>, likely all the way down in the lowest levels of the <code>write</code> routine. It should only happen on Windows, and it might be a good idea to provide a way to disable it in the crate API.</p>
<p>Another option here, honestly, is to not fix it. This really seems like a bug in how Windows consoles handle this stuff to me. But if the fix is to do a search for <code>\n</code> on every <code>write</code> call, then I guess it's just yet another penalty that Windows users pay. (They already pay a fair amount. ripgrep is generally much quicker on Linux/macOS in my experience.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ninmonkey">@ninmonkey</a> on 2022-04-03 19:08</div>
            <div class="timeline-body"><blockquote>
<p>Another option here, honestly, is to not fix it... So if you fix it for ANSI escapes</p>
</blockquote>
<h2>The Short Version is that Microsoft says:</h2>
<blockquote>
<p><a href="https://docs.microsoft.com/en-us/windows/console/classic-vs-vt#recommendations">&quot;For all new and ongoing development on Windows, virtual terminal sequences are recommended as the way of interacting with the terminal.&quot;</a></p>
</blockquote>
<ul>
<li>It says: Don't use the console API</li>
<li>Do use <code>VT Sequences</code></li>
<li>On <code>Win10+</code> conhost is <code>xterm</code> compatible</li>
<li>In 2022 the <code>windowsterminal</code> will replace the existing one as the system's default. It is in <code>win11</code></li>
<li>internally the conhost translates to VT Sequences, but it's not perfect. OP's issue seems to</li>
<li>There is <a href="https://docs.microsoft.com/en-us/windows/console/classic-vs-vt#exceptions-for-using-windows-console-apis">A limited subset of Windows Console APIs is still necessary to establish the initial environment</a></li>
</ul>
<p>I didn't see this cleary summarized, so I added extra information so that they may link to it. place.</p>
<h2>Windows <code>xterm</code> compatibility</h2>
<p>| Name                   | xterm compatible?                                                                     |
| ---------------------- | ------------------------------------------------------------------------------------- |
| <code>Windows Console Host</code> | <strong>Yes</strong> for <code>Windows 10</code> and higher                                                   |
| <code>Windows Terminal</code>     | <strong>Yes</strong></br>Supports <strong>24bit color</strong> and <code>utf8</code> support<br> Is the default in <code>win11</code> |</p>
<h2>Quotes from the Documentation</h2>
<ul>
<li><blockquote>
<p><a href="https://docs.microsoft.com/en-us/windows/console/classic-vs-vt">&quot;Our recommendation is to replace the classic Windows Console API with virtual terminal sequences. This article will outline the difference between the two and discuss the reasons for our recommendation.&quot;</a></p>
</blockquote>
</li>
<li><blockquote>
<p><a href="https://docs.microsoft.com/en-us/windows/console/classic-vs-vt#exceptions-for-using-windows-console-apis">&quot;A command-line application desiring full compatibility across platforms and full support of all new features and scenarios both on Windows and elsewhere is therefore recommended to move to virtual terminal sequences and adjust the architecture of command-line applications to align with all platforms&quot;</a>.</p>
</blockquote>
</li>
<li><blockquote>
<p><a href="https://devblogs.microsoft.com/commandline/windows-terminal-as-your-default-command-line-experience/">Over the course of 2022, we are planning to make Windows Terminal the default experience on Windows 11 devices</a>, Windows terminal is the new default console in windows11</p>
</blockquote>
</li>
<li><blockquote>
<p>Applications that use the <a href="https://docs.microsoft.com/en-us/windows/console/getconsolescreenbufferinfoex">GetConsoleScreenBufferInfo family of APIs</a> to retrieve the active console colors in [Win32 format and then attempt to transform them into cross-platform VT sequences (for example, by transforming <code>BACKGROUND_RED</code> to <code>\x1b[41m</code>) may interfere with Terminal's ability to detect what background color the application is attempting to use.](https://docs.microsoft.com/en-us/windows/terminal/troubleshooting#technical-notes)</p>
</blockquote>
</li>
<li><blockquote>
<p>Application developers are encouraged to choose either Windows API functions or VT sequences for adjusting colors and not attempt to mix them.</p>
</blockquote>
</li>
</ul>
<p>That red one sounds like @gvanem OP's bug, and fits with the StackOverflow threads about bugs when resizing the window.</p>
<ul>
<li><blockquote>
<p>Future planning and <code>pseudoconsole</code>: There are <strong>no plans to remove the Windows console APIs</strong> from the platform.</p>
</blockquote>
</li>
<li><blockquote>
<p>On the contrary, <a href="https://docs.microsoft.com/en-us/windows/console/classic-vs-vt#future-planning-and-pseudoconsole">the<code> Windows Console host</code> has provided the <code>pseudoconsole</code> technology to translate existing Windows command-line application</a> calls into <code>virtual terminal sequences</code> and forward them to another hosting environment remotely or across platforms</p>
</blockquote>
</li>
</ul>
<hr />
<blockquote>
<p>@gskt17 should work like any other platform</p>
</blockquote>
<p>The last link had a little bit on the origin</p>
<h2>issues</h2>
<ul>
<li><p><a href="https://github.com/JanDeDobbeleer/oh-my-posh/issues/65">Long lines that wrap in terminal cause a background &quot;highlight&quot; on the next line</a></p>
</li>
<li></li>
</ul>
<p>@BurntSushi</p>
<blockquote>
<p>Windows users pay. (They already pay a fair amount. ripgrep is generally much quicker on Linux/macOS in my experience.)</p>
</blockquote>
<p>Fairly recently -- maybe the last 5?, 10? years -- Microsoft has turned around. Instead of competing, they started integrating open source projects.  Powershell being both open source and cross platform is pretty neat. ripgrep works great on windows.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2022-04-03 19:31</div>
            <div class="timeline-body"><p>I agree it works great. I'm speaking from experience benchmarking equivalent corpora with similar CPUs. Windows tends to be quite a bit slower.</p>
<p>It has been only a couple years since I've performed said benchmarks. And I do not claim to know why there is a difference, although I have a variety of guesses. Windows requires additional work in some cases with interacting with its system APIs (not console APIs).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-11-24 20:04</div>
            <div class="timeline-body"><p>This issue does not appear actionable on my end.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2023-11-24 20:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wontfix</span> added by @BurntSushi on 2023-11-24 20:04</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:43:31 UTC
    </footer>
</body>
</html>
