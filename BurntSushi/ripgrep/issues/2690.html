<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory not freed in ignore crate when ignore flags are enabled - BurntSushi/ripgrep #2690</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Memory not freed in ignore crate when ignore flags are enabled</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/2690">#2690</a>
        opened by <a href="https://github.com/fe9lix">@fe9lix</a>
        on 2023-12-18 18:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/fe9lix">@fe9lix</a></div>
            <div class="timeline-body">Please tick this box to confirm you have reviewed the above.
<ul>
<li>[X] I have a different issue.</li>
</ul>
What version of ripgrep are you using?
<p>ignore crate 0.4.21</p>
How did you install ripgrep?
<p>cargo add ignore</p>
What operating system are you using ripgrep on?
<p>macOS Sonoma 14.1.1</p>
Describe your bug.
<p>ignore&#x27;s WalkParallel does not seem to free memory when ignore flags are enabled.</p>
What are the steps to reproduce the behavior?
<ul>
<li><p>Run the &quot;stress test&quot; example project (adjust the path and timeout) and observe the memory growth over time in some process monitoring tool. I&#x27;m compiling for the ARM aarch64-apple-darwin target and running it on an M1 Macbook Pro.</p>
</li>
<li><p>Run heap profiling tools to confirm the leaks. I used Instruments&#x27; Allocations and Leaks via <code>cargo instruments</code> on macOS (latest stable Rust toolchain) and LeakSanitizer via the the nightly toolchain and compiled for x86 (<code>RUSTFLAGS=&quot;-Z sanitizer=leak&quot; cargo run --target x86_64-apple-darwin</code>). Visual output with stack traces is appended for both the leaking and non-leaking versions (ignore flags disabled), the text output of LeakSanitizer is attached, and the visual and text output of heaptrack (linux VM only).</p>
</li>
</ul>
<p><a href="https://github.com/BurntSushi/ripgrep/files/13726976/ignore-mem.zip">ignore-mem.zip</a></p>
What is the actual behavior?
<p>Memory usage increases over time, unbounded â€“ but only when the ignore flags are enabled. The memory growth increases faster when custom overrides are enabled. There is <em>no</em> continuous memory growth when the ignore flags are disabled (regardless of whether custom overrides are enabled or not).</p>
What is the expected behavior?
<p>I would expect that memory usage would be bounded and not grow over time when the threads have been joined and the WalkParallel instance is dropped in the example project. Memory would stay around a baseline level as the allocator reuses freed memory. This happens when the ignore flags are disabled. To exclude memory fragmentation as a possible cause, I&#x27;ve also tested this with jemalloc and observed the same behavior (with a different baseline memory usage and allocation pattern but still unbounded growth).</p>
<p>Since I&#x27;ve also tested older version of this crate and observed the same behavior, it makes me think that I&#x27;m 1) missing something obvious, or 2) misusing the crate and its API, 3) holding misconceptions about how memory is supposed to be managed in the example. If so, I&#x27;d be happy to be pointed in the right direction how to correctly use the crate for a long-running process that walks different subdirectory trees at certain points in time, while keeping memory bounded within a baseline range.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-01-06 17:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-01-06 17:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Nicolecolwell">@Nicolecolwell</a> on 2024-03-24 11:24</div>
            <div class="timeline-body"><p>Ignore</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:13 UTC
    </footer>
</body>
</html>
