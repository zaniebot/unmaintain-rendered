<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMD Graceful Downgrade - BurntSushi/ripgrep #703</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>SIMD Graceful Downgrade</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/703">#703</a>
        opened by <a href="https://github.com/hlieberman">@hlieberman</a>
        on 2017-12-02 19:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/hlieberman">@hlieberman</a></div>
            <div class="timeline-body"><p>Hello @BurntSushi!</p>
<p>I&#x27;m interested in getting ripgrep added to Debian (where it will trickle through to Ubuntu)!  One of the things I&#x27;ve been watching for is support for SIMD landing in Rust&#x27;s stable branch, as well as an ability to have a single binary that supports graceful downgrades to the minimal version of SIMD that they support.  (AVX -&gt; SSE -&gt; none.)</p>
<p>I know most of that is blocked on upstream Rust, or worse, upstream LLVM.  I could build a version that simply doesn&#x27;t support SIMD at all, but I understand a lot of the benefit of ripgrep comes from there.  What are your thoughts?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-12-02 21:58</div>
            <div class="timeline-body"><p>TL;DR ripgrep without SIMD should be just fine for now.</p>
<p>Overall, I&#x27;d say this is a dupe of #135.</p>
<p>Graceful downgrades with a single binary is indeed the intended course of action here. If you&#x27;re forced to use stable Rust (which I suspect you are), then that is blocked on Rust and there&#x27;s really nothing we can do about it on the ripgrep end of things. (Note that I&#x27;m <a href="https://github.com/rust-lang-nursery/stdsimd">helping that effort upstream</a>.)</p>
<p>Today, however, it would be possible for me to put up release artifacts with graceful downgrade, but that requires switching the regex crate (and <code>bytecount</code>) over to <code>stdsimd</code>, which I haven&#x27;t gotten to yet. But of course, that doesn&#x27;t help you because I produce the release artifacts using nightly Rust. :-)</p>
<p>AFAIK, the ripgrep in other package repos is compiled without SIMD (e.g. Archlinux or Homebrew).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">duplicate</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-12-02 21:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-12-02 21:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-12-02 22:01</div>
            <div class="timeline-body"><blockquote>
<p>but I understand a lot of the benefit of ripgrep comes from there</p>
</blockquote>
<p>Broadly speaking, there are two cases where SIMD in ripgrep helps:</p>
<ol>
<li>When searching for a small number of short patterns simultaneously. e.g., <code>foo|bar|quux</code> will be faster with SIMD than without. Note that it&#x27;s not like this becomes dog slow without SIMD, it&#x27;s still going to use a heavily optimized DFA. :-)</li>
<li>When searching a large file while also enabling line numbers. This might be surprising, but ripgrep uses the <code>bytecount</code> crate to count lines, which has heavily optimized SSE and AVX routines. Again, even without SIMD here (which was the case in the benchmarks on the introductory blog post), ripgrep is still going to use an optimized routine to count lines.</li>
</ol>
<p>Other than those two things, there shouldn&#x27;t be a performance difference. ripgrep without SIMD still uses <code>memchr</code> (which uses SIMD by virtue of <code>libc</code> on Linux), parallel search and heavily optimized support for processing <code>gitignore</code> files quickly.</p>
<p>So I&#x27;d say &quot;ripgrep gets faster in some cases with SIMD&quot; today. Note that over time, I&#x27;d expect the number of cases to rise as I add more SIMD based optimizations, but I&#x27;d measure that on a scale of years. Hopefully SIMD will be in stable Rust before then. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hlieberman">@hlieberman</a> on 2017-12-02 23:17</div>
            <div class="timeline-body"><p>Sounds good.  A follow-up question: what are your thoughts about potentially having to support dependencies at versions greater than the ones that you have specified in the cargo file?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-12-03 00:05</div>
            <div class="timeline-body"><p>@hlieberman I think the answer there is just keep upgrading the <code>Cargo.toml</code>/<code>Cargo.lock</code>. I try to be careful about upgrading deps that increase the minimum Rust version so that such things can be managed, but otherwise I&#x27;m typically happy to just keeping moving the ball forward.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-12-06 12:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-03-13 03:22</div>
            <div class="timeline-body"><p>This should be fixed by <a href="https://github.com/BurntSushi/ripgrep/pull/857">BurntSushi/ripgrep#857</a> in the next release.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:05 UTC
    </footer>
</body>
</html>
