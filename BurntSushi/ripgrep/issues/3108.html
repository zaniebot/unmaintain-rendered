<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`-q` inverts status code from `--files-without-match` - BurntSushi/ripgrep #3108</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>-q</code> inverts status code from <code>--files-without-match</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/3108">#3108</a>
        opened by <a href="https://github.com/BatmanAoD">@BatmanAoD</a>
        on 2025-07-24 16:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BatmanAoD">@BatmanAoD</a></div>
            <div class="timeline-body"><h3>Please tick this box to confirm you have reviewed the above.</h3>
<ul>
<li>[x] I have a different issue.</li>
</ul>
<h3>What version of ripgrep are you using?</h3>
<p>ripgrep 14.1.0 (rev e50df40a19)</p>
<p>features:-simd-accel,+pcre2
simd(compile):+NEON
simd(runtime):+NEON</p>
<p>PCRE2 10.42 is available (JIT is available)</p>
<h3>How did you install ripgrep?</h3>
<p><code>cargo binstall</code></p>
<h3>What operating system are you using ripgrep on?</h3>
<p>macOS Seqouia 15.5, ARM</p>
<h3>Describe your bug.</h3>
<p>The exit code from <code>rg -q --files-without-match</code> is inverted from the exit code from <code>rg --files-without-match</code>. As far as I can tell, this is not documented, so I don't believe it's intentional. There is a parenthetical in the <code>-q</code> helptext that says the exit code &quot;will be an error code if no matches are found&quot;, but since it's a parenthetical, I interpret that as explaining the default exit code behavior.</p>
<p>If this is the intended behavior, I think that should be more explicit in the helptext; perhaps something like:</p>
<blockquote>
<p>The exit code will be an error code if no matches are found. This overrides other flags that may change the exit code, such as --files-without-match.</p>
</blockquote>
<h3>What are the steps to reproduce the behavior?</h3>
<pre><code class="language-sh">$&gt; echo haystack ...... | rg -q needle; echo $?
1
$&gt; echo haystack needle | rg -q needle; echo $?
0
$&gt; echo haystack ...... | rg --files-without-match needle &gt; /dev/null; echo $?
0
$&gt; echo haystack needle | rg --files-without-match needle &gt; /dev/null; echo $?
1
$&gt; echo haystack ...... | rg -q --files-without-match needle &gt; /dev/null; echo $?
1
$&gt; echo haystack needle | rg -q --files-without-match needle &gt; /dev/null; echo $?
0
</code></pre>
<h3>What is the actual behavior?</h3>
<p><code>-q</code> inverts the exit code, effectively ignoring <code>--files-without-match</code>.</p>
<h3>What is the expected behavior?</h3>
<p>I would expect <code>-q</code> not to change the exit code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @BurntSushi on 2025-07-24 16:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-24 16:29</div>
            <div class="timeline-body"><p>This is definitely a bug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/emrebengue">@emrebengue</a> on 2025-07-25 03:08</div>
            <div class="timeline-body"><p>I think the issue is the ExitCode logic in run function inside <code>crates/core/main.rs</code>.</p>
<p>I do not quite understand why this behaviour happens. When you look at <code>ripgrep/crates/printer/src/summary.rs</code> you will see that has_match() correctly returns true IF config.kind is SummaryKind::PathWithoutMatch and match_count is 0. Which is the correct logic because it is expected to return true if the path/file does not contain a match.</p>
<p>But this creates an issue when it comes to ExitCode logic.
Adding the following logic to crates/core/main.rs inside <code>run</code> function seems to fix the bug for now.</p>
<pre><code>if args.mode() == Mode::Search(SearchMode::FilesWithoutMatch)
        &amp;&amp; args.quiet()
    {
        matched = !matched;
    }
</code></pre>
<pre><code>fn run(result: crate::flags::ParseResult&lt;HiArgs&gt;) -&gt; anyhow::Result&lt;ExitCode&gt; {
    use crate::flags::{Mode, ParseResult};

    let args = match result {
        ParseResult::Err(err) =&gt; return Err(err),
        ParseResult::Special(mode) =&gt; return special(mode),
        ParseResult::Ok(args) =&gt; args,
    };
    let mut matched = match args.mode() {
        Mode::Search(_) if !args.matches_possible() =&gt; false,
        Mode::Search(mode) if args.threads() == 1 =&gt; search(&amp;args, mode)?,
        Mode::Search(mode) =&gt; search_parallel(&amp;args, mode)?,
        Mode::Files if args.threads() == 1 =&gt; files(&amp;args)?,
        Mode::Files =&gt; files_parallel(&amp;args)?,
        Mode::Types =&gt; return types(&amp;args),
        Mode::Generate(mode) =&gt; return generate(mode),
    };
    if args.mode() == Mode::Search(SearchMode::FilesWithoutMatch)
        &amp;&amp; args.quiet()
    {
        matched = !matched;
    }
    Ok(if matched &amp;&amp; (args.quiet() || !messages::errored()) {
        ExitCode::from(0)
    } else if messages::errored() {
        ExitCode::from(2)
    } else {
        ExitCode::from(1)
    })
}
</code></pre>
<p>If someone can elaborate on this bug, it would be appreciated.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/emrebengue">@emrebengue</a> on 2025-07-25 06:28</div>
            <div class="timeline-body"><p>It can be refactored as:</p>
<pre><code>fn run(result: crate::flags::ParseResult&lt;HiArgs&gt;) -&gt; anyhow::Result&lt;ExitCode&gt; {
    use crate::flags::{Mode, ParseResult};

    let args = match result {
        ParseResult::Err(err) =&gt; return Err(err),
        ParseResult::Special(mode) =&gt; return special(mode),
        ParseResult::Ok(args) =&gt; args,
    };
    let matched = match args.mode() {
        Mode::Search(_) if !args.matches_possible() =&gt; false,
        Mode::Search(mode) if args.threads() == 1 =&gt; search(&amp;args, mode)?,
        Mode::Search(mode) =&gt; search_parallel(&amp;args, mode)?,
        Mode::Files if args.threads() == 1 =&gt; files(&amp;args)?,
        Mode::Files =&gt; files_parallel(&amp;args)?,
        Mode::Types =&gt; return types(&amp;args),
        Mode::Generate(mode) =&gt; return generate(mode),
    };
    Ok(
        if exit_success(
            matched,
            &amp;args.mode(),
            args.quiet(),
            messages::errored(),
        ) {
            ExitCode::from(0)
        } else if messages::errored() {
            ExitCode::from(2)
        } else {
            ExitCode::from(1)
        },
    )
}

fn exit_success(
    matched: bool,
    mode: &amp;Mode,
    quiet: bool,
    errored: bool,
) -&gt; bool {
    if errored {
        return false;
    }
    match mode {
        Mode::Search(SearchMode::FilesWithoutMatch) if quiet =&gt; !matched,
        _ =&gt; matched,
    }
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wislertt">@wislertt</a> on 2025-08-02 14:23</div>
            <div class="timeline-body"><p>@BurntSushi @emrebengue Fixed this issue in PR #3118. Would appreciate a review when you have a moment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rollup</span> added by @BurntSushi on 2025-08-20 01:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2025-09-20 01:08</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:43:57 UTC
    </footer>
</body>
</html>
