<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rg 0.8.1: regression in glob pattern matching - BurntSushi/ripgrep #830</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>rg 0.8.1: regression in glob pattern matching</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/830">#830</a>
        opened by <a href="https://github.com/mario-grgic">@mario-grgic</a>
        on 2018-02-22 20:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mario-grgic">@mario-grgic</a></div>
            <div class="timeline-body"><h4>What version of ripgrep are you using?</h4>
<pre><code>$ rg --version
ripgrep 0.8.1 (rev c8e9f25b85)
+SIMD -AVX
</code></pre>
<h4>What operating system are you using ripgrep on?</h4>
<pre><code>$ uname -a
Darwin Jupiter.local 17.4.0 Darwin Kernel Version 17.4.0: Sun Dec 17 09:19:54 PST 2017; root:xnu-4570.41.2~1/RELEASE_X86_64 x86_64
</code></pre>
<h4>Describe your question, feature request, or bug.</h4>
<p>I'm using ripgrep to search for files excluding certain directories. For example:</p>
<pre><code>rg --files --no-ignore --hidden --follow -g '!{.git,node_modules}/*'
</code></pre>
<p>This used to exclude .git, and node_modules directories in current directory and all subdirectories in ripgrep 0.7.1. But ripgrep 0.8.1 lists the contents of .git and node_modules directories in subdirectories of current directory.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-02-22 21:21</div>
            <div class="timeline-body"><p>I can't reproduce this. Could you please show the output of the command with the <code>--debug</code> flag as the issue template requested? Thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mario-grgic">@mario-grgic</a> on 2018-02-22 21:55</div>
            <div class="timeline-body"><p>The following script will create a test directory structure:</p>
<pre><code class="language-sh">#!/bin/sh

mkdir -p test/a/b/c/
mkdir -p test/a/exclude
mkdir -p test/a/b/exclude
touch test/a/exclude/file1
touch test/a/b/exclude/file2
</code></pre>
<pre><code>cd test
$ rg --debug --files --no-ignore --hidden --follow -g '!exclude/*'
DEBUG/globset/globset/src/lib.rs:396: glob converted to regex: Glob { glob: &quot;exclude/*&quot;, re: &quot;(?-u)^exclude/[^/]*$&quot;, opts: GlobOptions { case_insensitive: false, literal_separator: true }, tokens: Tokens([Literal('e'), Literal('x'), Literal('c'), Literal('l'), Literal('u'), Literal('d'), Literal('e'), Literal('/'), ZeroOrMore]) }
DEBUG/globset/globset/src/lib.rs:401: built glob set; 0 literals, 0 basenames, 0 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 1 regexes
DEBUG/grep::search/grep/src/search.rs:195: regex ast:
Repeat {
    e: Literal {
        chars: [
            'z'
        ],
        casei: false
    },
    r: Range {
        min: 0,
        max: Some(
            0
        )
    },
    greedy: true
}
a/exclude/file1
a/b/exclude/file2
</code></pre>
<p>And with ripgrep version 0.7.1:</p>
<pre><code>$ rg --debug --files --no-ignore --hidden --follow -g '!exclude/*'
DEBUG:globset: glob converted to regex: Glob { glob: &quot;**/exclude/*&quot;, re: &quot;(?-u)^(?:/?|.*/)exclude/[^/]*$&quot;, opts: GlobOptions { case_insensitive: false, literal_separator: true }, tokens: Tokens([RecursivePrefix, Literal('e'), Literal('x'), Literal('c'), Literal('l'), Literal('u'), Literal('d'), Literal('e'), Literal('/'), ZeroOrMore]) }
DEBUG:globset: built glob set; 0 literals, 0 basenames, 0 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 1 regexes
DEBUG:grep::search: regex ast:
Repeat {
    e: Literal {
        chars: [
            'z'
        ],
        casei: false
    },
    r: Range {
        min: 0,
        max: Some(
            0
        )
    },
    greedy: true
}
DEBUG:ignore::walk: ignoring ./a/exclude/file1: Ignore(IgnoreMatch(Override(Glob(Matched(Glob { from: None, original: &quot;!exclude/*&quot;, actual: &quot;**/exclude/*&quot;, is_whitelist: true, is_only_dir: false })))))
DEBUG:ignore::walk: ignoring ./a/b/exclude/file2: Ignore(IgnoreMatch(Override(Glob(Matched(Glob { from: None, original: &quot;!exclude/*&quot;, actual: &quot;**/exclude/*&quot;, is_whitelist: true, is_only_dir: false })))))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-02-22 22:08</div>
            <div class="timeline-body"><p>@mario-grgic Much better, thank you. :-) I can reproduce that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-02-22 22:25</div>
            <div class="timeline-body"><p>TL;DR - Use <code>-g '!exclude'</code> instead of <code>-g '!exclude/*'</code>.</p>
<p>OK, so I fear this change may have actually been intended. Specifically, this is a result of fixing #761, which was done in #762. Basically, the idea here is that if a glob contains a <code>/</code>, then a <code>*</code> in the glob <em>must not match a <code>/</code></em>. In your case, you have a glob <code>exclude/*</code> (which contains a slash), which means it is specifically limited to matching things like <code>exclude/foo</code>, but specifically not <code>a/exclude/foo</code> or <code>a/b/exclude/foo</code> because that would imply an implicit <code>*</code> prefix that matches through a <code>/</code> character. As #762 notes, the <code>man gitignore</code> documentation specifically calls out exactly this example.</p>
<p>Given that the <code>-g/--glob</code> flag is documented to follow <code>gitignore</code> semantics and given that I believe this behavior is consistent with gitignore behavior, I think that this actually isn't a bug, and you were instead previously relying on the behavior of a bug. You can trivially work around this by using <code>-g '!exclude'</code> instead of <code>-g '!exclude/*'</code>, which I believe accomplishes the same thing.</p>
<p>It is plausible that we might want to use semantics other than <code>gitignore</code> for the <code>-g/--glob</code> flags, but that is itself a much larger change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mario-grgic">@mario-grgic</a> on 2018-02-22 22:51</div>
            <div class="timeline-body"><p>Ok, thank you for the clarification.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @mario-grgic on 2018-02-22 22:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @BurntSushi on 2018-02-22 22:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wontfix</span> added by @BurntSushi on 2018-02-22 22:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tandrewnichols">@tandrewnichols</a> on 2018-03-14 02:28</div>
            <div class="timeline-body"><p>Is this documented anywhere? I just seriously wasted like 3 days trying to figure out why files were not being excluded. The man page only says &quot;Precede a glob with a ! to exclude it.&quot; And basically every blog post/explanation I saw online about how to set up ripgrep used the <code>!somewhere/*</code> pattern.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-03-14 02:42</div>
            <div class="timeline-body"><blockquote>
<p>Is this documented anywhere?</p>
</blockquote>
<p>Yes, in <code>man gitignore</code>. The man page for ripgrep says, &quot;Globbing rules match .gitignore globs.&quot; in the documentation for the <code>-g/--glob</code> flag.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-03-14 02:48</div>
            <div class="timeline-body"><p>@tandrewnichols If there's a short FAQ entry that could be written about fzf setup, then that might be a good way to combat the existing false info. I don't use fzf though, so I can't/won't write those docs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tandrewnichols">@tandrewnichols</a> on 2018-03-14 03:01</div>
            <div class="timeline-body"><p>Well . . . fine, but: a) even with that in the man, I'm not going to think to check some other tool's man page to understand how something works, b) it's an extra thing to run if my first hunch is &quot;this is a problem with ripgrep&quot;, c) I don't know that it's common knowledge that gitignore HAS a man page . . . I didn't know that, d) the man for gitignore is dense enough that a tl;dr would be nice, e) most people assume they understand gitignore syntax already, so even with that note they won't think to check man gitignore, f) even if, barring all this, you actually look up the man for gitignore, you still have to understand what it means, and phrases like <code>Otherwise, Git treats the pattern as a shell glob suitable for consumption by fnmatch(3) with the FNM_PATHNAME flag</code> make that virtually untenable. I guess what I'm asking is, like, maybe one example of negating a file path would be nice. It could be as simple as:</p>
<pre><code class="language-bash"># Exclude node_modules from a search
rg -g '!node_modules` banana
</code></pre>
<p>Per your last, I don't think there's anything specifically about fzf here. I mean, you're correct that the things I was reading online were about integrating ripgrep with fzf, and that definitely muddied the situation for me in terms of debugging, but I couldn't get glob exclusion working even with a <code>.ripgreprc</code> just in my shell.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tandrewnichols">@tandrewnichols</a> on 2018-03-14 03:05</div>
            <div class="timeline-body"><p>Maybe I'm projecting with that list and the average bash user <em>does</em> think to check <code>man gitignore</code> in that case, idk. I know I'm no bash expert, but I wouldn't call myself a novice either. And probably the average user of this tool is using it specifically because they don't want to have to understand shell-y things, so a little pointer in this case seems like it could be useful (especially since some other analogous tools like grep have explicit <code>--exclude</code> and <code>--exclude-dir</code> flags so the concept of negating will be new in that case).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tandrewnichols">@tandrewnichols</a> on 2018-03-14 03:07</div>
            <div class="timeline-body"><p>And by the way, I mean this all as a positive critique because ripgrep is a great tool. It's the first &quot;grep replacement&quot; I've used that I've actually <em>used</em> and stuck with. It really is excellent work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-03-14 03:30</div>
            <div class="timeline-body"><p>Sure, what you're saying is reasonable, but docs for this sort of thing are hard. Even if I translated the gitignore docs and POSIX globbing into one place in ripgrep's man page, it isn't clear to me that that would have saved you any time. Fundamentally, this particular bug is a subtle corner case. Subtle enough that even I missed it. :-)</p>
<p>That's probably why the existing docs are so terse. But perhaps there is a middle ground. If you file another issue, perhaps with more examples or ideas of what to include, then it has a chance of getting acted upon. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tandrewnichols">@tandrewnichols</a> on 2018-03-14 13:22</div>
            <div class="timeline-body"><p>I've thought more about it, specifically from a maintainer perspective, because I have some published tools as well, and documentation is always the worst part, and it's especially hard to keep up to date, but definitely the worst kind of documentation is stuff duplicated from elsewhere, so in that way, it makes sense not to spend effort duplicating docs that are elsewhere. A compromise that just came to me this morning is to modify (or add to) the man entry to say something like &quot;See <code>man gitignore</code> for more on globstar patterns&quot; which gives you slightly more to go on in terms of debugging without requiring much in the way of changes. If that sounds reasonable (and I have some time), I could look at working at PR for that.</p>
<p>I also just noticed this morning on twitter that you were the one that recently liked my post about ripgrep + fzf. Which explains a lot, because I was like, &quot;I don't think I mentioned fzf, how did this guy know I was using fzf???&quot; Haha, I get it now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-03-14 13:32</div>
            <div class="timeline-body"><p>@tandrewnichols Hah! That sounds reasonable. We might also consider linking or copying this (which are docs for the globbing library that ripgrep uses): https://docs.rs/globset/0.3.0/globset/#syntax</p>
<blockquote>
<p>I also just noticed this morning on twitter that you were the one that recently liked my post about ripgrep + fzf. Which explains a lot, because I was like, &quot;I don't think I mentioned fzf, how did this guy know I was using fzf???&quot; Haha, I get it now.</p>
</blockquote>
<p>:P Actually, the tweet didn't give it away, I didn't make the connection until just now when you mentioned it. This issue got linked from https://github.com/junegunn/fzf.vim/issues/315, which shows up in the Github UI for this issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tandrewnichols">@tandrewnichols</a> on 2018-03-14 13:34</div>
            <div class="timeline-body"><p>ü§¶‚Äç‚ôÇÔ∏è Yeah, that makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tinmarino">@tinmarino</a> on 2021-03-16 12:18</div>
            <div class="timeline-body"><p>You can use <code>**</code> to match any path including slash &lt;= also from <code>man gitignore</code></p>
<pre><code class="language-bash"># List all files except in a test directory
rg --files -g '!**/test/**'
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:42:28 UTC
    </footer>
</body>
</html>
