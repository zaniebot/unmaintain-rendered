<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rg -Ff fails to find a match in a case where it should - BurntSushi/ripgrep #1334</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>rg -Ff fails to find a match in a case where it should</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/1334">#1334</a>
        opened by <a href="https://github.com/elindsey">@elindsey</a>
        on 2019-07-30 01:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/elindsey">@elindsey</a></div>
            <div class="timeline-body"><h4>What version of ripgrep are you using?</h4>
<pre><code>$ rg --version
ripgrep 11.0.1
-SIMD -AVX (compiled)
+SIMD +AVX (runtime)
</code></pre>
<h4>How did you install ripgrep?</h4>
<p>brew install ripgrep</p>
<h4>What operating system are you using ripgrep on?</h4>
<p>macos 10.14.6</p>
<h4>Describe your question, feature request, or bug.</h4>
<p>With specific types of input files, I'm seeing rg -Ff return no matches in cases where it should return a match.</p>
<h4>If this is a bug, what are the steps to reproduce the behavior?</h4>
<p>patterns contains the same ip prefix 40 times:</p>
<pre><code>$ cat patterns 
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
1.208.0.0/12
</code></pre>
<p>corpus is a single line containing the prefix from the patterns file:</p>
<pre><code>$ cat corpus 
1.208.0.0/12
</code></pre>
<p>this is expected to produce a match, but does not:</p>
<pre><code>$ rg -Ff patterns corpus 
(no matches)
</code></pre>
<p>treating patterns as non fixed string finds a match:</p>
<pre><code>$ rg -f patterns corpus 
1:1.208.0.0/12
</code></pre>
<p>and strangely, removing a single line from patterns will also find a match:</p>
<pre><code>$ head -n 39 patterns &gt; fewerpatterns
$ rg -Ff fewerpatterns corpus 
1:1.208.0.0/12
</code></pre>
<p>I haven't dug in enough to see if this purely a result of 39 vs 40 lines, or if it's 39 vs 40 lines and the size of the '1.208.0.0/12' string, but I do seem to be crossing some boundary into buggy behavior with this specific test.</p>
<p><a href="https://github.com/BurntSushi/ripgrep/files/3444753/corpus.txt">corpus.txt</a>
<a href="https://github.com/BurntSushi/ripgrep/files/3444754/fewerpatterns.txt">fewerpatterns.txt</a>
<a href="https://github.com/BurntSushi/ripgrep/files/3444755/patterns.txt">patterns.txt</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @BurntSushi on 2019-08-01 20:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2019-08-01 21:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-08-01 21:00</div>
            <div class="timeline-body"><p>Ah thanks for this bug report! Literal optimizations are going to be the death me. I introduced this regression when I added an optimization for the <code>-F</code> flag to bypass the regex engine entirely and use Aho-Corasick. There are a number of cases where Aho-Corasick can't be used directly, which I thought I had handled, but one slipped by: ripgrep escapes patterns when the <code>-F</code> flag is set before passing them down to the matcher, and those same escaped patterns were being handed to the Aho-Corasick builder directly. So you were <em>actually</em> searching for the literal <code>1\.208\.0\.0/12</code>, which is obviously wrong.</p>
<p>The offending line of code is here, which also explains why <code>40</code> was a magic number: https://github.com/BurntSushi/ripgrep/blob/bc37c32717301abf26e5aecc942688d2ddd63692/grep-regex/src/matcher.rs#L75</p>
<p>(Specifically, the regex engine, currently, can often search for a small number of literals more quickly than Aho-Corasick, so we were diverting to the regex engine for a smaller number of literals, in which case, using escaped literals is correct.)</p>
<p>This is basically one giant mess because all of this should be pushed down into the regex engine, but there's a lot of refactoring work that needs to be done before that can happen. So I tried to paper over it at a higher level and got bit here.</p>
<p>Anyway, this should be fixed on master. I'm going to see about getting a patch release out soon.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/elindsey">@elindsey</a> on 2019-08-01 21:14</div>
            <div class="timeline-body"><p>Thanks Andrew! I really appreciate both the fix and the explanation - interesting edge case. üòÅ</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:42:58 UTC
    </footer>
</body>
</html>
