<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adjacent replaced multiline matches result in wrong line numbers - BurntSushi/ripgrep #2779</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Adjacent replaced multiline matches result in wrong line numbers</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/2779">#2779</a>
        opened by <a href="https://github.com/meedstrom">@meedstrom</a>
        on 2024-04-11 10:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/meedstrom">@meedstrom</a></div>
            <div class="timeline-body">Please tick this box to confirm you have reviewed the above.
<ul>
<li>[X] I have a different issue.</li>
</ul>
What version of ripgrep are you using?
<p>ripgrep 13.0.0
-SIMD -AVX (compiled)
+SIMD +AVX (runtime)</p>
How did you install ripgrep?
<p>APT</p>
What operating system are you using ripgrep on?
<p>Kubuntu 23.10</p>
Describe your bug.
<p>This is similar to #2420, and I understand why that&#x27;s WONTFIX. This is different though.</p>
<p>Using a multiline regexp, when the regexp matches strings that come immediately one after another, it bungles the line numbers of all of them.  Easier to show you with a reproduction example:</p>
What are the steps to reproduce the behavior?
<p>Save a file <code>test.txt</code> containing:</p>
<pre><code>:properties:
:id: fnord
:end:
:properties:
:id: boccob
:end:
:properties:
:id: d321fdddffff
:end:
:properties:
:id: clowns
:end:
</code></pre>
<p>Then run</p>
<pre><code>rg -nU &#x27;^:properties:\n:id: (.*)\n:end:&#x27; -r &#x27;$1&#x27; test.txt
</code></pre>
What is the actual behavior?
<p>The result is</p>
<pre><code>1:fnord
2:boccob
3:d321fdddffff
4:clowns
</code></pre>
<p>Only the first hit is correct.</p>
<p>You can see that the line numbers will be correctly reported if you modify the file to add a newline after each instance of &quot;:end:&quot;.</p>
What is the expected behavior?
<p>Expected the result:</p>
<pre><code>1:fnord
4:boccob
7:d321fdddffff
10:clowns
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-04-11 11:33</div>
            <div class="timeline-body"><blockquote>
<p>Using a multiline regexp, when the regexp matches strings that come immediately one after another, it bungles the line numbers of all of them.</p>
</blockquote>
<p>This is an incomplete description of the problem you&#x27;re reporting. It isn&#x27;t <em>just</em> when a regex matches strings that are adjacent, it&#x27;s <em>also</em> required that you use the <code>-r/--replace</code> flag to replace matches with something else. This can be easily demonstrated by omitting the <code>-r/--replace</code> flag and observing that the line numbers are correct:</p>
<pre><code>$ rg -nU &#x27;^:properties:\n:id: (.*)\n:end:&#x27; test.txt
1::properties:
2::id: fnord
3::end:
4::properties:
5::id: boccob
6::end:
7::properties:
8::id: d321fdddffff
9::end:
10::properties:
11::id: clowns
12::end:
</code></pre>
<p>Indeed though, the adjacency part of this seems important. If instead I use the following haystack as <code>test2.txt</code>:</p>
<pre><code>:properties:
:id: fnord
:end:
ZZZ
:properties:
:id: boccob
:end:
ZZZ
:properties:
:id: d321fdddffff
:end:
ZZZ
:properties:
:id: clowns
:end:
</code></pre>
<p>Then the line numbers change:</p>
<pre><code>$ rg -nU &#x27;^:properties:\n:id: (.*)\n:end:&#x27; -r &#x27;$1&#x27; test2.txt
1:fnord
5:boccob
9:d321fdddffff
13:clowns
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-04-11 11:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/meedstrom">@meedstrom</a> on 2024-04-25 06:04</div>
            <div class="timeline-body"><p>As you say, I forgot to mertion the <code>--replace</code>. Changed the title.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Consecutive multiline matches mis-report line numbers&quot; to &quot;Adjacent replaced multiline matches result in wrong line numbers&quot; by <a href="https://github.com/meedstrom">@meedstrom</a> on 2024-04-25 06:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/meedstrom">@meedstrom</a> on 2024-04-26 17:07</div>
            <div class="timeline-body"><p>I&#x27;m not proficient with Rust, but I could try to look for the problem. Any pointers on where to look?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-04-26 17:08</div>
            <div class="timeline-body"><p>Likely in <code>grep-printer</code>. Look at the &quot;standard&quot; printer.</p>
<p>That&#x27;s where I would start anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/WalterScottYoung">@WalterScottYoung</a> on 2024-11-29 09:32</div>
            <div class="timeline-body"><p>It seems that the problem is we didn&#x27;t keep track of line number when doing replace using regex package.</p>
<p>Within a call of StandardSink::replace, if there are multiple matches we didn&#x27;t record the line number corresponding to each matches, instead we output the data after replace to sink, in which the line number was counted by number of &#x27;\n&#x27; which is wrong because some &#x27;\n&#x27; was modified when we do StandardSink::replace.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/WalterScottYoung">@WalterScottYoung</a> on 2024-11-29 09:42</div>
            <div class="timeline-body"><p>With that said, it minght be hard to get the line number of the replaced result, and it requires some changes in apis to pass  the corresponding line number of each replaced result to sink to be used in printing. I wonder would it be easier to do what the the documentation says (<a href="https://github.com/BurntSushi/ripgrep/issues/2852">BurntSushi/ripgrep#2852</a>), and don&#x27;t print line number but print index of matches in multi-line search.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:13 UTC
    </footer>
</body>
</html>
