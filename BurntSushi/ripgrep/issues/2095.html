<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`--multiline` with `--replace` causes duplicate output - BurntSushi/ripgrep #2095</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>--multiline</code> with <code>--replace</code> causes duplicate output</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/2095">#2095</a>
        opened by <a href="https://github.com/balupton">@balupton</a>
        on 2021-12-02 09:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/balupton">@balupton</a></div>
            <div class="timeline-body">What version of ripgrep are you using?
<pre><code>ripgrep 13.0.0
-SIMD -AVX (compiled)
+SIMD +AVX (runtime)
</code></pre>
How did you install ripgrep?
<p>cargo</p>
What operating system are you using ripgrep on?
<pre><code>Darwin redacted 21.1.0 Darwin Kernel Version 21.1.0: Wed Oct 13 17:33:23 PDT 2021; root:xnu-8019.41.5~1/RELEASE_X86_64 x86_64
</code></pre>
Describe your bug.
<pre><code>cat &lt;&lt;EOF &gt; test.bash
#!/usr/bin/env bash

zero=one

a=one

if true; then
	a=(
		a
		b
		c
	)
	true
fi

a=two

b=one
EOF

# all of these are the same


rg  --multiline --only-matching &#x27;^(?P&lt;indent&gt;\s*)a=(?P&lt;value&gt;(?ms:[(].*?[)])|.*?)$&#x27; --replace &#x27;${value}&#x27; ./test.bash

rg  --multiline --only-matching &#x27;^(?P&lt;indent&gt;\s*)a=(?P&lt;value&gt;[(](?ms:.*?)[)]|.*?)$&#x27; --replace &#x27;${value}&#x27;  test.bash

rg  --multiline --only-matching &#x27;^(?P&lt;indent&gt;\s*)a=(?P&lt;value&gt;[(](?ms:.*?)[)]|[^(].*?)$&#x27; --replace &#x27;${value}&#x27;  test.bash

rg  --multiline --only-matching &#x27;^(?P&lt;indent&gt;\s*)a=(?P&lt;value&gt;[(](?ms:.*?)[)]|[^(](?-ms:.*?))$&#x27; --replace &#x27;${value}&#x27; test.bash

rg  --multiline --only-matching &#x27;^(?-ms:(?P&lt;indent&gt;\s*)a=(?P&lt;value&gt;[(](?ms:.*?)[)]|[^(].*?))$&#x27; --replace &#x27;${value}&#x27; test.bash

rg  --multiline --only-matching &#x27;(?-ms:^(?P&lt;indent&gt;\s*)a=(?P&lt;value&gt;[(](?ms:.*?)[)]|[^(].*?)$)&#x27; --replace &#x27;${value}&#x27; test.bash
# ^ this fails, rg really doesn&#x27;t like flag modifiers prior to ^ and $

rg --multiline --only-matching &#x27;(?ms:^(?P&lt;indent&gt;\s*)a=(?P&lt;value&gt;[(].*?[)]|[^\n]*)$)&#x27; --replace &#x27;${value}&#x27; ./test.bash

rg --multiline --only-matching &#x27;(?ms:^(?P&lt;indent&gt;\s*)a=(?P&lt;value&gt;[(].*?[)]|(?-ms:.*))$)&#x27; --replace &#x27;${value}&#x27; ./test.bash

rg --multiline --only-matching &#x27;(?m:^(?P&lt;indent&gt;\s*)a=(?P&lt;value&gt;[(](?s:.*?)[)]|.*)$)&#x27; --replace &#x27;${value}&#x27; ./test.bash
</code></pre>
<p>outputs:</p>
<pre><code>4:one
7:(
8:		q
9:		r
10:		s
11:	)
14:two
8:(
9:		q
10:		r
11:		s
12:	)
15:two
15:two
</code></pre>
<p>Instead of:</p>
<pre><code>4:one
7:(
8:		q
9:		r
10:		s
11:	)
14:two
</code></pre>
What are the steps to reproduce the behavior?
<p>see above</p>
What is the actual behavior?
<p>see above</p>
What is the expected behavior?
<p>see above</p>
What do you think ripgrep should have done?
<p>It would be good if the <code>--multiline</code> handling could be disabled, in favour of the rust regex localised flag applied <code>(?ms:</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/balupton">@balupton</a> on 2021-12-02 10:14</div>
            <div class="timeline-body"><p>Without the <code>--replace</code>, it works fine, no duplicates, but returns the entire match:</p>
<pre><code>rg --multiline --only-matching &#x27;(?ms:^(?P&lt;indent&gt;\s*)a=(?P&lt;value&gt;[(].*?[)]|[^\n]*)$)&#x27;  ./test.bash

rg --multiline --only-matching &#x27;(?ms:^(?P&lt;indent&gt;\s*)a=(?P&lt;value&gt;[(].*?[)]|(?-ms:.*))$)&#x27;  ./test.bash

rg --multiline --only-matching &#x27;(?m:^(?P&lt;indent&gt;\s*)a=(?P&lt;value&gt;[(](?s:.*?)[)]|.*)$)&#x27; ./test.bash
</code></pre>
<p>output:</p>
<pre><code>5:a=one
8:	a=(
9:		a
10:		b
11:		c
12:	)
16:a=two
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;`--multiline` is causing duplicate output&quot; to &quot;`--multiline` with `--replace` causes duplicate output&quot; by <a href="https://github.com/balupton">@balupton</a> on 2021-12-02 10:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/balupton">@balupton</a> on 2021-12-02 10:50</div>
            <div class="timeline-body"><p>For the meantime, <code>--max-count=1</code> is a suitable workaround.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-12-02 15:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-12-02 15:46</div>
            <div class="timeline-body"><p>Yup, looks like a bug to me. Thanks for the report!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ghost">@ghost</a> on 2022-02-23 20:27</div>
            <div class="timeline-body"><p>I ran into this problem when working on a unified diff printer. It seems the replacement bytes retain the remainder of the subject buffer instead of only until the match end. I tried to fix it and it worked, but I&#x27;m not sure if my fix is a proper one.
See <a href="https://github.com/BurntSushi/ripgrep/pull/2149">BurntSushi/ripgrep#2149</a>/files#diff-cbced35c4a7b8ae41aa579dd0395a63152e23d6edf91d2e1035f189d1d3337da</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2022-05-11 18:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:11 UTC
    </footer>
</body>
</html>
