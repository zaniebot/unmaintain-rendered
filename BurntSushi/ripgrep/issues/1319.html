<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>match bug - BurntSushi/ripgrep #1319</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>match bug</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/1319">#1319</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2019-07-05 17:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><pre><code>$ rg --version
ripgrep 11.0.1 (rev 7bf7ceb5d3)
-SIMD -AVX (compiled)
+SIMD +AVX (runtime)
</code></pre>
<p>This matches:</p>
<pre><code>$ echo 'CCAGCTACTCGGGAGGCTGAGGCTGGAGGATCGCTTGAGTCCAGGAGTTC' | egrep 'CCAGCTACTCGGGAGGCTGAGGCTGGAGGATCGCTTGAGTCCAGGAG[ATCG]{2}C'
CCAGCTACTCGGGAGGCTGAGGCTGGAGGATCGCTTGAGTCCAGGAGTTC
</code></pre>
<p>But this doesn't:</p>
<pre><code>$ echo 'CCAGCTACTCGGGAGGCTGAGGCTGGAGGATCGCTTGAGTCCAGGAGTTC' | rg 'CCAGCTACTCGGGAGGCTGAGGCTGGAGGATCGCTTGAGTCCAGGAG[ATCG]{2}C'
</code></pre>
<p>To minimize, this doesn't match:</p>
<pre><code>$ rg 'TTGAGTCCAGGAG[ATCG]{2}C' /tmp/subject
</code></pre>
<p>But this does:</p>
<pre><code>$ rg 'TGAGTCCAGGAG[ATCG]{2}C' /tmp/subject
1:CCAGCTACTCGGGAGGCTGAGGCTGGAGGATCGCTTGAGTCCAGGAGTTC
</code></pre>
<p>The only difference between the latter two is that the latter removes the first
<code>T</code> from the regex.</p>
<p>From inspecting the <code>--trace</code> output, I note that from the former regex, it
says this:</p>
<pre><code>DEBUG|grep_regex::literal|grep-regex/src/literal.rs:105: required literals found: [Complete(TTGAGTCCAGGAGAC), Complete(TTGAGTCCAGGAGCC), Complete(TTGAGTCCAGGAGGC), Complete(TTGAGTCCAGGAGTC)]
TRACE|grep_regex::matcher|grep-regex/src/matcher.rs:52: extracted fast line regex: (?-u:TTGAGTCCAGGAGAC|TTGAGTCCAGGAGCC|TTGAGTCCAGGAGGC|TTGAGTCCAGGAGTC)
</code></pre>
<p>But in the latter regex (the one that works), we have this:</p>
<pre><code>DEBUG|grep_regex::literal|grep-regex/src/literal.rs:59: literal prefixes detected: Literals { lits: [Complete(TGAGTCCAGGAGAAC), Complete(TGAGTCCAGGAGCAC), Complete(TGAGTCCAGGAGGAC), Complete(TGAGTCC
AGGAGTAC), Complete(TGAGTCCAGGAGACC), Complete(TGAGTCCAGGAGCCC), Complete(TGAGTCCAGGAGGCC), Complete(TGAGTCCAGGAGTCC), Complete(TGAGTCCAGGAGAGC), Complete(TGAGTCCAGGAGCGC), Complete(TGAGTCCAGGAGGGC)
, Complete(TGAGTCCAGGAGTGC), Complete(TGAGTCCAGGAGATC), Complete(TGAGTCCAGGAGCTC), Complete(TGAGTCCAGGAGGTC), Complete(TGAGTCCAGGAGTTC)], limit_size: 250, limit_class: 10 }
</code></pre>
<p>Therefore, this is almost certainly a bug in literal extraction. Moreover,
this Rust program correctly prints <code>true</code>:</p>
<pre><code class="language-rust">fn main() {
    let pattern = r&quot;CCAGCTACTCGGGAGGCTGAGGCTGGAGGATCGCTTGAGTCCAGGAG[ATCG]{2}C&quot;;
    let haystack = &quot;CCAGCTACTCGGGAGGCTGAGGCTGGAGGATCGCTTGAGTCCAGGAGTTC&quot;;

    let re = regex::Regex::new(pattern).unwrap();
    println!(&quot;{:?}&quot;, re.is_match(haystack));
}
</code></pre>
<p>Which points the finger at <code>grep-regex</code>'s inner literal extraction. Sigh.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @BurntSushi on 2019-07-05 17:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-07-06 14:58</div>
            <div class="timeline-body"><p>Oh, forgot to mention that this was originally reported in this StackOverflow question: https://stackoverflow.com/questions/56906725/ripgrep-missing-character-class-repetions</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jakubadamw">@jakubadamw</a> on 2019-09-05 21:30</div>
            <div class="timeline-body"><p>Replacing the line:</p>
<p>https://github.com/BurntSushi/ripgrep/blob/4858267f3b97fe2823d2ce104c1f90ec93eee8d7/grep-regex/src/literal.rs#L217</p>
<p>with</p>
<pre><code class="language-rust">if max.map_or(true, |max| min &lt;= max) {
</code></pre>
<p>or just dropping the whole <code>if</code> (as <code>min &gt; max</code> never holds) condition fixes the issue for me. That condition looked suspicious to me at a first glance but as I do not understand that code very well, I sadly cannot substantiate why this is the <em>right</em> fix and I'm not even convinced it is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jakubadamw">@jakubadamw</a> on 2019-09-06 20:59</div>
            <div class="timeline-body"><p>I wrote <a href="https://github.com/jakubadamw/grep-searcher-fuzz-test/blob/ab50e73ac26c5f175b228a235ad16957bfc87321/src/main.rs">a fuzzer</a> that uses the <a href="https://crates.io/crates/regex_generate">regex_generate</a> crate to produce matching inputs for a given fuzz-generated regular expression and then checks if <code>grep_matcher::RegexMatcher</code> successfully matches that input against the regex. It has successfully found the class of errors represented by this issue and with the proposed change applied it has not found any more failing cases yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-09-06 21:09</div>
            <div class="timeline-body"><p>@jakubadamw That's awesome! Do you want to submit a PR? If not, I'll get to this eventually!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jakubadamw">@jakubadamw</a> on 2019-09-06 21:46</div>
            <div class="timeline-body"><p>@BurntSushi, sure! ðŸ™‚</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2020-02-17 22:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:42:57 UTC
    </footer>
</body>
</html>
