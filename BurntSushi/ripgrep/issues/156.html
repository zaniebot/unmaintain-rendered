<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rg not parsing regex correctly? - BurntSushi/ripgrep #156</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>rg not parsing regex correctly?</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/156">#156</a>
        opened by <a href="https://github.com/isker">@isker</a>
        on 2016-10-08 05:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/isker">@isker</a></div>
            <div class="timeline-body"><p>Hi.  Apologies if this question is nonsensical - I am not super experienced with rg or Rust.</p>
<p>I've got ripgrep 0.2.1 from homebrew.  I cannot get it to correctly handle a regex from the command line, while I can get ag to do so.  I've attached a simple example file.</p>
<p><a href="https://github.com/BurntSushi/ripgrep/files/517442/testcase.txt">testcase.txt</a></p>
<p>Running this regex yields expected results:</p>
<pre><code>$ rg '#(?:parse|include)' /tmp/testcase.txt
1:#parse('widgets/foo_bar_macros.vm')
2:#parse ( 'widgets/mobile/foo_bar_macros.vm' )
3:#parse (&quot;widgets/foobarhiddenformfields.vm&quot;)
4:#parse ( &quot;widgets/foo_bar_legal.vm&quot; )
5:#include( 'widgets/foo_bar_tips.vm' )
6:#include('widgets/mobile/foo_bar_macros.vm')
7:#include (&quot;widgets/mobile/foo_bar_resetpw.vm&quot;)
8:#parse('widgets/foo-bar-macros.vm')
9:#parse ( 'widgets/mobile/foo-bar-macros.vm' )
10:#parse (&quot;widgets/foo-bar-hiddenformfields.vm&quot;)
11:#parse ( &quot;widgets/foo-bar-legal.vm&quot; )
12:#include( 'widgets/foo-bar-tips.vm' )
13:#include('widgets/mobile/foo-bar-macros.vm')
14:#include (&quot;widgets/mobile/foo-bar-resetpw.vm&quot;)
</code></pre>
<p>But extending it further does not:</p>
<pre><code>$ rg $'#(?:parse|include)\s*\(\s*(?:&quot;|\')[./A-Za-z_-]+(?:&quot;|\')' /tmp/testcase.txt
$
</code></pre>
<p>The Silver Searcher gets the same thing:</p>
<pre><code>$ ag $'#(?:parse|include)\s*\(\s*(?:&quot;|\')[./A-Za-z_-]+(?:&quot;|\')' /tmp/testcase.txt
1:#parse('widgets/foo_bar_macros.vm')
2:#parse ( 'widgets/mobile/foo_bar_macros.vm' )
3:#parse (&quot;widgets/foobarhiddenformfields.vm&quot;)
4:#parse ( &quot;widgets/foo_bar_legal.vm&quot; )
5:#include( 'widgets/foo_bar_tips.vm' )
6:#include('widgets/mobile/foo_bar_macros.vm')
7:#include (&quot;widgets/mobile/foo_bar_resetpw.vm&quot;)
8:#parse('widgets/foo-bar-macros.vm')
9:#parse ( 'widgets/mobile/foo-bar-macros.vm' )
10:#parse (&quot;widgets/foo-bar-hiddenformfields.vm&quot;)
11:#parse ( &quot;widgets/foo-bar-legal.vm&quot; )
12:#include( 'widgets/foo-bar-tips.vm' )
13:#include('widgets/mobile/foo-bar-macros.vm')
14:#include (&quot;widgets/mobile/foo-bar-resetpw.vm&quot;)
</code></pre>
<p>The cause of the difference, as indicated by the output colors, is that ripgrep stops matching at the '.' in each line, even though '.' is included in the character class I am matching on.  --debug output indicates that this character should be matched:</p>
<pre><code>        Repeat {
            e: Class(
                CharClass {
                    ranges: [
                        ClassRange {
                            start: '-',   &lt;-- '.' is in this range...
                            end: '/'
                        },
                        ClassRange {
                            start: 'A',
                            end: 'Z'
                        },
                        ClassRange {
                            start: '_',
                            end: '_'
                        },
                        ClassRange {
                            start: 'a',
                            end: 'z'
                        }
                    ]
                }
            ),
            r: OneOrMore,
            greedy: true
        },
</code></pre>
<p>I tested the regex in a simple Rust program to ensure that the regex itself is fine in the eyes of Rust.</p>
<pre><code>extern crate regex;

use regex::Regex;

fn main() {
    let re = Regex::new(r##&quot;#(?:parse|include)\s*\(\s*(?:&quot;|')[./A-Za-z_-]+(?:&quot;|')&quot;##).unwrap();
    assert!(re.is_match(&quot;#parse('widgets/foo_bar_macros.vm')&quot;));
    assert!(re.is_match(&quot;#parse('widgets/mobile/foo-bar-resetpw.vm')&quot;));
}
</code></pre>
<p>I'm at a bit of a loss.  Not too sure if this is a bug with rg or with me.  Any idea?  Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2016-10-11 02:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-10-11 02:05</div>
            <div class="timeline-body"><p>This was a great find and should now be fixed.</p>
<p>The actual bug was deep inside the <a href="https://github.com/rust-lang-nursery/regex/commit/e5b40638151f2126ddf25b7ab71faa4192dc4efe"><code>regex-syntax</code></a> library. In short, there was a bug round tripping a regex string to and from a regex AST, and your specific regex tripped it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/isker">@isker</a> on 2016-10-11 12:38</div>
            <div class="timeline-body"><p>Neat.  Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @BurntSushi on 2016-10-11 12:51</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:41:47 UTC
    </footer>
</body>
</html>
