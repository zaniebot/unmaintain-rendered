<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ripgrep not obeying --one-file-system or .gitignore on OneDrive folder - BurntSushi/ripgrep #1218</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ripgrep not obeying --one-file-system or .gitignore on OneDrive folder</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/1218">#1218</a>
        opened by <a href="https://github.com/Trucido">@Trucido</a>
        on 2019-03-11 10:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Trucido">@Trucido</a></div>
            <div class="timeline-body">What version of ripgrep are you using?
<p>ripgrep 0.10.0 (rev 8a7db1a918)
-SIMD -AVX (compiled)
+SIMD +AVX (runtime)</p>
How did you install ripgrep?
<p>tested both versions from scoop and chocolatey:
scoop install ripgrep
choco install ripgrep</p>
What operating system are you using ripgrep on?
<p>Windows 10 Version 1809 (OS Build 17763.348)
(Same behavior on prior 1803 version)</p>
Describe your question, feature request, or bug.
<p>Running rg from home directory, or anywhere that encounters the OneDrive folder doesn&#x27;t respect the <code>--one-file-system</code> option or .gitignore globs for OneDrive. (tested option in both CLI and in .ripgreprc)
Also tested adding various combinations of <code>Onedrive\*</code> to <code>~\.gitignore</code> and globs in <code>~\OneDrive\.gitignore</code> but it doesn&#x27;t seem to recognize it.
The only thing that seems to work is adding this to .ripgreprc:</p>
<pre><code>--glob
!OneDrive/*
</code></pre>
<p>Possibly somewhat related to #705 and I would consider this a bug if ripgrep is trying to read files not locally available (RECALL_ON_DATA_ACCESS) which triggers OneDrive to download the files.</p>
<p>Repro: Create file in <code>~\OneDrive</code> with uniquely identifiable text;  Right Click -&gt; &quot;Free Up Space&quot;; run <code>rg --one-file-system</code> with that unique text and it triggers download of the file. (same with .gitignore stuff).</p>
<p>These files seem to have identifiable flags, but it&#x27;s not entirely clear. I pieced together what I could and wrote a powershell script to parse these attributes and flags here: <a href="https://gist.github.com/Trucido/02dc6b7f43df1eb6f0e5146f77282143">Get-FileAttributesEx.ps1</a></p>
<p>Parsing which files ARE locally available and which are NOT would probably be a pain, but I think ripgrep should check some of these flags in the --one-file-system code somehow since they&#x27;re sync-related flags (and likely used on more than just OneDrive). I&#x27;m unaware of an easier method of easily identifying such cloud and/or offline-online/sync related files,</p>
<p>Also, parsing attrib.exe output isn&#x27;t reliable either.
External links:</p>
<ul>
<li>https://searchenterprisedesktop.techtarget.com/blog/Windows-Enterprise-Desktop/OneDrive-File-Attributes-Uncovered</li>
<li>https://www.petri.com/managing-onedrive-files-demand-windows-10-fall-creators-update</li>
<li>https://social.technet.microsoft.com/Forums/windows/en-US/375f3933-fcab-450c-bb9c-da54155549e2/how-do-i-getset-onedrive-quotfiles-on-demandquot-status-from-powershell?forum=ITCG</li>
<li>https://superuser.com/questions/1214542/what-do-new-windows-8-10-attributes-mean-no-scrub-file-x-integrity-v-pinn/1287315</li>
<li>https://www.tenforums.com/general-support/102804-why-these-p-u-file-attributes-suddenly-appearing.html</li>
<li>https://docs.microsoft.com/en-us/windows/desktop/FileIO/file-attribute-constants</li>
<li>https://docs.microsoft.com/en-us/windows/desktop/api/fileapi/nf-fileapi-createfilea</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-03-11 11:20</div>
            <div class="timeline-body"><p>The way you&#x27;re using <code>.gitignore</code> seems strange. Just do <code>echo &#x27;*&#x27; &gt; ~\OneDrive\.ignore</code> (or whatever the Windows equivalent of that is).</p>
<p>The way <code>--one-file-system</code> is implemented on Windows is by getting the volume serial number containing the given file. I have no idea how that interacts with OneNote, and honestly, it&#x27;s hard for me to make sense of the information you&#x27;ve flooded me with. I&#x27;m not a Windows user nor am I experienced with Windows development, so I think someone else will need to perform the research task of figuring out more precisely what&#x27;s happening.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-03-11 11:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">icebox</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-03-11 11:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-03-11 11:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Trucido">@Trucido</a> on 2019-03-12 13:26</div>
            <div class="timeline-body"><p>Sorry for the walls of text/urls, I was hoping someone could make sense of this and hopefully help rg&#x27;s <code>--one-file-system</code> flag work like it does on other OS&#x27;s.
――――――――――――――――</p>
<blockquote>
<p><code>echo &#x27;*&#x27; &gt; ~\OneDrive\.ignore</code></p>
</blockquote>
<p>This worked! Thanks, but for now is just a band-aid fix. Probably will become an issue again in the future with other sync providers and newer pseudo-file types for containers and/or cross-linked interop stuff with windows and linux containers and VMs and other special files/directories.
――――――――――――――――</p>
<p>Q: I thought rg parsed gitignore files? These didn&#x27;t seem to work:</p>
<pre><code># ~\.gitignore
OneDrive/*`
</code></pre>
<pre><code># ~\OneDrive\.gitignore
*
## (or various combinations of wildcards)
</code></pre>
<p>If not, sorry for wrongly assuming. I suppose .gitignore files could be symlinked/hardlinked to a &#x27;.ignore&#x27; file.
――――――――――――――――</p>
<blockquote>
<p>The way <code>--one-file-system</code> is implemented on Windows is by getting the volume serial number containing the given file.</p>
</blockquote>
<p>That works in most cases, but there&#x27;s a lot more &quot;filesystem&quot; types than are exposed by parsing volumes. (and I won&#x27;t even get into PSDrives...)
In this OneDrive issue though, it&#x27;s technically a sync provider folder, which are implemented strangely. I&#x27;m not sure how other sync providers and sync services implement these things; though there must be a standardized API of some sort to determine this stuff; otherwise it would be insanity.
――――――――――――――――</p>
<blockquote>
<p>I&#x27;m not a Windows user nor am I experienced with Windows development, so I think someone else will need to perform the research task of figuring out more precisely what&#x27;s happening.</p>
</blockquote>
<p>Understandable - rg works great on *nix platforms, though feature-parity with other OS&#x27;s would be ideal. I&#x27;m not expecting you to do all the &quot;legwork&quot; on platforms you don&#x27;t even use - the existing work put into the windows port is much appreciated.</p>
<p>Q: How does rg handle *nix files like sockets, FIFOs, mounted shares, fuse/overlayfs and/or btrfs subvols? I suppose /proc exposes more easily accessible information; but on windows parsing volume serial numbers seems valid only for physical drive(s) and certain types of pseudo-block devices. (Though I think MSFT is rehauling the storage system for hopefully more sanity).
――――――――――――――――</p>
<p>Anyway, I too am not so experienced in windows development (or rust), but if I can help I&#x27;d be glad to; and hopefully someone else can provide some insight into the appropriate APIs (or rust libs) to expose the file/directory/filesystem information we seem to be lacking on windows platforms.
If I have some time, I&#x27;ll try and look at the code of similar tools and see how they implement <code>--one-file-system</code> flags. Also maybe there&#x27;s some python and nodejs modules with decent code examples of doing this properly.</p>
<p>Perhaps this issue title should be changed to an enhancement such as &quot;Improve windows --one-file-system detection&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-03-12 18:07</div>
            <div class="timeline-body"><p>ripgrep does handle .gitignore, but only in git repos.</p>
<blockquote>
<p>hopefully help rg&#x27;s --one-file-system flag work like it does on other OS&#x27;s.</p>
</blockquote>
<p>It does. Looking at the volume serial number (or the device number on Unix) is the correct way to implement this. It is how every other cli tool with a similar feature implements this. You are asking for something very different. You are asking for ripgrep to become aware of N different file synchronization services that each probably have their own way of working. This isn&#x27;t practical.</p>
<p>I&#x27;m not in principle against supporting this request, but it needs to have a simple contained solution with low maintenance burden.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Trucido">@Trucido</a> on 2019-05-17 16:01</div>
            <div class="timeline-body"><p>(Sorry late reply)</p>
<blockquote>
<p>You are asking for ripgrep to become aware of N different file synchronization services that each probably have their own way of working. This isn&#x27;t practical.</p>
</blockquote>
<p>Sorry only bringing up issue which may get larger in future (thus harder to change codebase).
Using .ignore files works but also much clutter.
RIPGREP_CONFIG_PATH with ignore globs works without clutter but has other sideeffects. (Is there global blacklist/ignore file support?)</p>
<p>Maybe you&#x27;re right and most unix/linux utils only check <code>/proc/mounts</code> which is equivalent to checking windows volumes but maybe this is larger issue on both platforms then... especially with containers and virtualization, snapshot type mounts, checksum/archive files and other such complex xattr stuff.</p>
<p>I know you&#x27;re not primarily a Windows user but feel this should still be kept open in case someone else with more rust experience has some insight and the time to implement xattr/attribute checking or knows of an easy rust lib since I lack the time and knowledge to do the legwork on this</p>
<p>Most windows utils I work on use the GetFileAttributes family of Cpp macros (or equivalent C and dotnet methods), there&#x27;s lots of FOSS ntfs libs for doing this too.
<code>rg GetFileAttribute &quot;%programfiles(x86)%\Windows Kits&quot;</code>  for some context on these things (if windows SDK(s) are installed</p>
<p>Not ripgrep&#x27;s fault MSFT botched this, the new NTFS attributes are sparsely documented and whats worse is older windows headers do not even return anything meaningful except the hex values.</p>
<p>A few projects I work on use these GetFileAttributes APIs to check for even simple stuff like directories or no write access or to try and catch with return codes. (i.e. file logging/creation/deleting). Maybe not relevant to rust, I don&#x27;t know rust much.</p>
<p>P.S. (I still heavily use rg on nix, win, and various virt platforms and appreciate the support for such OS&#x27;s. unlike some rust utils in &#x27;oreutils&#x27; like bat and exa which have some larger issues (exa doesn&#x27;t even compile), but rg works consistently well)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-05-17 16:47</div>
            <div class="timeline-body"><p>Thanks for the follow up. I&#x27;m going to close this for now. If someone wants to do the research to figure out the correct way to implement this, <em>and</em> it&#x27;s a well contained and easy to maintain solution, then we can re-open this issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-05-17 16:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:08 UTC
    </footer>
</body>
</html>
