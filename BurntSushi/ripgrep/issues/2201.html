<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Some characters placed just after capture groups break replaced output - BurntSushi/ripgrep #2201</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Some characters placed just after capture groups break replaced output</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/2201">#2201</a>
        opened by <a href="https://github.com/tamwile">@tamwile</a>
        on 2022-05-08 00:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tamwile">@tamwile</a></div>
            <div class="timeline-body">What version of ripgrep are you using?
<p>`rg --version</p>
<p>ripgrep 13.0.0
-SIMD -AVX (compiled)
+SIMD +AVX (runtime)`</p>
How did you install ripgrep?
<p>cargo install</p>
What operating system are you using ripgrep on?
<p>Archlinux 5.17.4-arch1-1</p>
Describe your bug.
<p>When we use the replace flag -r, some characters seem to break the replaced result
if they are placed just after a capture group like $1.
For example underscore (_).</p>
What are the steps to reproduce the behavior?
<p>Run
<code>ls file.mkv | rg &#x27;(.*).mkv&#x27; -r &#x27;$1_en.ass&#x27;</code>
Here, _ is just after the 1 in &#x27;$1&#x27;, and it will break the output.
This also happen if we have any alphabet letter after the 1.</p>
What is the actual behavior?
<p>Here are some commands i tried.</p>
<p><code> ls file.mkv | rg &#x27;(.*).mkv&#x27; -r &#x27;$1_en.ass&#x27;</code>
<code>.ass</code>
The $1 is ignored and _ has apparently eaten the &quot;en&quot; part of the pattern.</p>
<p><code>ls file.mkv | rg &#x27;(.*).mkv&#x27; -r &#x27;$1$_en.ass&#x27;</code>
<code>file.ass</code>
Since $$ is used to escape $, i tried to write $_,
and while it still eats the &quot;en&quot; part, the $1 is correctly replaced this time.</p>
<p><code>ls file.mkv | rg &#x27;(.*).mkv&#x27; -r &#x27;$1 en.ass&#x27;</code>
<code>file en.ass</code>
Here we can see that the output is correct if a space follow the 1, this is also the case for ., !, and probably others.</p>
What is the expected behavior?
<p>The expected behavior to the first command listed above is :
<code>file_en.ass</code></p>
<p>I think this is a bug, but if this is intentional, then please show me where in the doc i could have find this, because i have not.
Is there a way to escape the capture group and/or find a way for underscore to not break the output ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2022-05-08 00:53</div>
            <div class="timeline-body"><p>The behavior is correct. The docs sadly do not mention the <code>${1}</code> syntax. It&#x27;s <a href="https://docs.rs/regex/latest/regex/struct.Captures.html#method.expand">documented in the regex engine</a>, but you shouldn&#x27;t need to dig into that. Specifically, this bit:</p>
<blockquote>
<p>The longest possible name consisting of the characters <code>[_0-9A-Za-z]</code> is used. e.g., <code>$1a</code> looks up the capture group named 1a and not the capture group at index 1. To exert more precise control over the name, or to refer to a capture group name that uses characters outside of <code>[_0-9A-Za-z]</code>, use braces, e.g., <code>${1}a</code> or <code>${foo[bar].baz}</code>. When using braces, any sequence of characters is permitted. If the sequence does not refer to a capture group name in the corresponding regex, then it is replaced with an empty string.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">doc</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2022-05-08 00:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tamwile">@tamwile</a> on 2022-05-08 01:42</div>
            <div class="timeline-body"><p>Thanks, this totally answers my question.
I leave the issue open until the doc is updated.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/brunetton">@brunetton</a> on 2023-03-16 18:40</div>
            <div class="timeline-body"><p>Sorry for my duplicate in #2455</p>
<p>It came to my mind that this might be this kind of problem; and I&#x27;ve to admit: I didn&#x27;t go deep enough into the doc to find this section. <strong>But</strong>, IMHO (very humble), it doesn&#x27;t seem very logical to me that the priority is given to users that use named groups over users (97% I suppose) that don&#x27;t.</p>
<p>I expected that to match <code>$1_en.ass</code> one should use <code>${1_en.ass}</code>, and <code>$1_en.ass</code> to be equivalent to <code>${1}_en.ass</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-03-16 18:56</div>
            <div class="timeline-body"><p>Yes, if I could go back in time, I might tweak these rules. But I don&#x27;t feel comfortable making a breaking change of this sort at this point. The problem is that it would be a silent breaking change. It would silently change the semantics of replacement strings that previously worked.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rollup</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-11-24 20:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-11-25 20:04</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:12 UTC
    </footer>
</body>
</html>
