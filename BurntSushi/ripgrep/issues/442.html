<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rg --help | less assumes the terminal has 100 columns - BurntSushi/ripgrep #442</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>rg --help | less assumes the terminal has 100 columns</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/442">#442</a>
        opened by <a href="https://github.com/bluss">@bluss</a>
        on 2017-04-09 14:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bluss">@bluss</a></div>
            <div class="timeline-body"><p>If we pipe rg's output to something, it assumes the terminal has 100 columns.</p>
<p>For example rg --help, which has output that is long and begs for pagination.</p>
<p>To reproduce: Install rg. Adjust terminal to a width of for example 90 columns. Use <code>rg --help | less</code>  (with no shell aliases or anything in between).</p>
<p>(Sorry! rg --help is now fixed, so the bug report now had its schedule unblocked)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-04-09 15:11</div>
            <div class="timeline-body"><p>ripgrep doesn't do anything explicitly smart with terminal size, so I assume this is a clap thing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @BurntSushi on 2017-04-09 15:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-04-09 15:13</div>
            <div class="timeline-body"><p>I could have sworn clap had some setting or knob for this, but I can't find it after a quick skim.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-04-09 16:00</div>
            <div class="timeline-body"><p>There's <a href="https://docs.rs/clap/2.23.1/clap/struct.App.html#method.max_term_width"><code>App::max_term_width</code></a> and <a href="https://docs.rs/clap/2.23.1/clap/struct.App.html#method.set_term_width"><code>App::set_term_width</code></a></p>
<p><code>max_term_width</code> will allow ~~freeform~~ &quot;smart&quot; wrapping at whatever the user terminal width is, <em>up to</em> some maximum. This is what ripgrep uses currently (at 100).</p>
<p><code>set_term_width</code> sets the virtual width and always &quot;smart&quot; wraps at that column width.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-04-09 16:01</div>
            <div class="timeline-body"><p>[I hit comment too early]</p>
<p>Not using either will just &quot;smart&quot; wrap at whatever width the user terminal width happens to be.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-04-09 16:09</div>
            <div class="timeline-body"><p>@kbknapp Oh interesting. Welp. I was clearly wrong about ripgrep not doing anything.</p>
<p>With that said, I can't seem to cause clap to do the right thing here. Namely, if <code>max_term_width</code> is set to <code>100</code>, then shouldn't it wrap text at <code>N &lt; 100</code> after I shrink my terminal? (I also just tried <code>set_term_width</code>, which has the same behavior.)</p>
<p>If I remove the <code>max_term_width</code>/<code>set_term_width</code> setting completely, then the help text sprawls across my entire screen, which I suspect is why I set it in the first place.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-04-09 16:10</div>
            <div class="timeline-body"><p>I see. clap does do the right thing <em>unless</em> its output is piped to <code>less</code>. So presumably that interferes with <code>clap</code> figuring out the terminal width?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-04-09 16:14</div>
            <div class="timeline-body"><p>Interesting, my initial thinking is <code>less</code> is being detected a terminal without a width (or rather <code>stdout</code> not being a terminal) which is causing the fallback to 100.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-04-09 16:14</div>
            <div class="timeline-body"><p>I haven't looked at clap's source code, but my best guess is that clap only does autowrapping when it thinks its printing to a tty (which seems reasonable). So if its output is piped to a file or to another program, then it won't auto-wrap because it isn't a tty. It should be possible to discriminate between &quot;redirected to a file&quot; and &quot;piped to other process,&quot; but even then, it's not clear that respecting terminal size is the right choice (although it certainly seems like a pragmatic one).</p>
<p>Another choice is to just set the max width to <code>79</code> columns and hope that fits most use cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-04-09 16:15</div>
            <div class="timeline-body"><p>@kbknapp Ah right, beat me to it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-04-09 16:17</div>
            <div class="timeline-body"><p>Here's where the logic happens</p>
<p>https://github.com/kbknapp/term_size-rs/blob/0297b6af8a6072ef1bee30527b6cb39f55b44755/src/lib.rs#L58-L82</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-04-09 16:19</div>
            <div class="timeline-body"><p>@kbknapp Oh, I suppose that is actually a different issue than what I was saying above. That's suggesting that <code>ioctl</code> itself will fail to find the terminal size if the process is being piped to another process? Or rather, finding the dimensions works by examining the stdout file descriptor? Interesting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-04-09 16:52</div>
            <div class="timeline-body"><p>@BurntSushi <code>ioctl</code> will fail when <code>stdout</code> isn't a tty. The crux of the problem is that the dimensions are determined by <code>stdout</code>, and where <code>stdout</code> is piped or redirected there are no dimensions. I don't know of a way to detect what the terminal width <em>was</em> (i.e. before <code>stdout</code> is checked).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-04-09 17:46</div>
            <div class="timeline-body"><p>@BurntSushi I found a solution that seems to work! ðŸŽ‰</p>
<p><code>term_size</code> can read stdout, and if that fails try <em>stdin</em>...if <em>that</em> fails then try stderr...<em>then</em> give up. Works in my tests so far.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-04-09 17:59</div>
            <div class="timeline-body"><p>Nice hack. I love it.</p>
<p>On Apr 9, 2017 1:46 PM, &quot;Kevin K.&quot; <a href="mailto:notifications@github.com">notifications@github.com</a> wrote:</p>
<blockquote>
<p>@BurntSushi <a href="https://github.com/BurntSushi">https://github.com/BurntSushi</a> I found a solution that seems
to work! ðŸŽ‰</p>
<p>term_size can read stdout, and if that fails try <em>stdin</em>...if <em>that</em>
fails then try stderr...<em>then</em> give up. Works in my tests so far.</p>
<p>â€”
You are receiving this because you were mentioned.
Reply to this email directly, view it on GitHub
<a href="https://github.com/BurntSushi/ripgrep/issues/442#issuecomment-292800709">https://github.com/BurntSushi/ripgrep/issues/442#issuecomment-292800709</a>,
or mute the thread
<a href="https://github.com/notifications/unsubscribe-auth/AAb34oa1sa0OdFtgHVn28d9J-BOP-HB3ks5ruRl9gaJpZM4M4C3P">https://github.com/notifications/unsubscribe-auth/AAb34oa1sa0OdFtgHVn28d9J-BOP-HB3ks5ruRl9gaJpZM4M4C3P</a>
.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2017-04-10 01:02</div>
            <div class="timeline-body"><p>Just did a <code>cargo install ripgrep</code> (to update <code>term_size</code>) and this is working.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2017-05-08 23:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eproxus">@eproxus</a> on 2020-06-22 12:57</div>
            <div class="timeline-body"><p>I have this issue running <code>rg -h</code> and <code>rg --help</code> using 12.1.1 running on macOS. Was this really fixed?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mattiase">@mattiase</a> on 2021-12-08 12:06</div>
            <div class="timeline-body"><blockquote>
<p>I have this issue running <code>rg -h</code> and <code>rg --help</code> using 12.1.1 running on macOS. Was this really fixed?</p>
</blockquote>
<p>No, you are right â€“ it seems that <code>clap</code> isn't used with the <code>wrap_help</code> feature. Presumably it should be added to the list of features in <code>Cargo.toml</code>.</p>
<p>With that done, it works even when stdout is a pipe, as in <code>rg -h | less</code> since it seems to look at the tty config for stdin (which is standard practice for interactive tools). Nice!</p>
<p>However, the  <code>--help</code> output is less pleasing: <code>clap</code> doesn't reflow paragraphs but wraps each line separately instead and this leads to the infamous &quot;comb&quot; appearance of alternating long and short lines. To deal with this, we either need to remove newlines inside paragraphs (replacing each with a single space), or detect blank lines as paragraph delimiters. The latter means less boring legwork but some changes to <code>clap</code> it seems.</p>
<p>Oh, and it would be nice with a right margin of a few spaces (2, say) for readability. I suppose that would go into <code>clap</code> too?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:42:08 UTC
    </footer>
</body>
</html>
