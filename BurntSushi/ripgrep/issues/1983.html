<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unexpected --json output with --multiline - BurntSushi/ripgrep #1983</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Unexpected --json output with --multiline</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/1983">#1983</a>
        opened by <a href="https://github.com/roblourens">@roblourens</a>
        on 2021-09-02 21:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/roblourens">@roblourens</a></div>
            <div class="timeline-body">What version of ripgrep are you using?
<pre><code>rg --version
ripgrep 13.0.0
-SIMD -AVX (compiled)
+SIMD +AVX (runtime)
</code></pre>
What operating system are you using ripgrep on?
<p>macOS</p>
Describe your bug.
<p>When doing a search with a certain regex and the <code>--json</code> and <code>--multiline</code> flags, I get a single <code>match</code> object with multiple lines, but in rg 12 I got one for each line.</p>
What are the steps to reproduce the behavior?
<p>Have this file</p>
<pre><code>.a1
.a2
</code></pre>
<p>Do this search</p>
<pre><code>$ rg &#x27;\Wa&#x27; --json --multiline
{&quot;type&quot;:&quot;begin&quot;,&quot;data&quot;:{&quot;path&quot;:{&quot;text&quot;:&quot;main.txt&quot;}}}
{&quot;type&quot;:&quot;match&quot;,&quot;data&quot;:{&quot;path&quot;:{&quot;text&quot;:&quot;main.txt&quot;},&quot;lines&quot;:{&quot;text&quot;:&quot;.a1\n.a2&quot;},&quot;line_number&quot;:1,&quot;absolute_offset&quot;:0,&quot;submatches&quot;:[{&quot;match&quot;:{&quot;text&quot;:&quot;.a&quot;},&quot;start&quot;:0,&quot;end&quot;:2},{&quot;match&quot;:{&quot;text&quot;:&quot;.a&quot;},&quot;start&quot;:4,&quot;end&quot;:6}]}}
{&quot;type&quot;:&quot;end&quot;,&quot;data&quot;:{&quot;path&quot;:{&quot;text&quot;:&quot;main.txt&quot;},&quot;binary_offset&quot;:null,&quot;stats&quot;:{&quot;elapsed&quot;:{&quot;secs&quot;:0,&quot;nanos&quot;:259022,&quot;human&quot;:&quot;0.000259s&quot;},&quot;searches&quot;:1,&quot;searches_with_match&quot;:1,&quot;bytes_searched&quot;:7,&quot;bytes_printed&quot;:269,&quot;matched_lines&quot;:2,&quot;matches&quot;:2}}}
{&quot;data&quot;:{&quot;elapsed_total&quot;:{&quot;human&quot;:&quot;0.005201s&quot;,&quot;nanos&quot;:5200971,&quot;secs&quot;:0},&quot;stats&quot;:{&quot;bytes_printed&quot;:269,&quot;bytes_searched&quot;:7,&quot;elapsed&quot;:{&quot;human&quot;:&quot;0.000259s&quot;,&quot;nanos&quot;:259022,&quot;secs&quot;:0},&quot;matched_lines&quot;:2,&quot;matches&quot;:2,&quot;searches&quot;:1,&quot;searches_with_match&quot;:1}},&quot;type&quot;:&quot;summary&quot;}
</code></pre>
<p>I get a single match with two submatches, and a newline between them. The parsing code in VS Code doesn&#x27;t handle this - it does handle newlines in a match if it is a multiline match, but not for individual matches with a newline in the middle.</p>
<p>If this is intended, I don&#x27;t think it&#x27;s necessarily an issue, but it&#x27;s not expected. For slightly different queries, I get multiple matches.</p>
<pre><code>$ rg &#x27;\.a&#x27; --json --multiline
{&quot;type&quot;:&quot;begin&quot;,&quot;data&quot;:{&quot;path&quot;:{&quot;text&quot;:&quot;main.txt&quot;}}}
{&quot;type&quot;:&quot;match&quot;,&quot;data&quot;:{&quot;path&quot;:{&quot;text&quot;:&quot;main.txt&quot;},&quot;lines&quot;:{&quot;text&quot;:&quot;.a1\n&quot;},&quot;line_number&quot;:1,&quot;absolute_offset&quot;:0,&quot;submatches&quot;:[{&quot;match&quot;:{&quot;text&quot;:&quot;.a&quot;},&quot;start&quot;:0,&quot;end&quot;:2}]}}
{&quot;type&quot;:&quot;match&quot;,&quot;data&quot;:{&quot;path&quot;:{&quot;text&quot;:&quot;main.txt&quot;},&quot;lines&quot;:{&quot;text&quot;:&quot;.a2&quot;},&quot;line_number&quot;:2,&quot;absolute_offset&quot;:4,&quot;submatches&quot;:[{&quot;match&quot;:{&quot;text&quot;:&quot;.a&quot;},&quot;start&quot;:0,&quot;end&quot;:2}]}}
{&quot;type&quot;:&quot;end&quot;,&quot;data&quot;:{&quot;path&quot;:{&quot;text&quot;:&quot;main.txt&quot;},&quot;binary_offset&quot;:null,&quot;stats&quot;:{&quot;elapsed&quot;:{&quot;secs&quot;:0,&quot;nanos&quot;:69208,&quot;human&quot;:&quot;0.000069s&quot;},&quot;searches&quot;:1,&quot;searches_with_match&quot;:1,&quot;bytes_searched&quot;:7,&quot;bytes_printed&quot;:393,&quot;matched_lines&quot;:2,&quot;matches&quot;:2}}}
{&quot;data&quot;:{&quot;elapsed_total&quot;:{&quot;human&quot;:&quot;0.009014s&quot;,&quot;nanos&quot;:9013863,&quot;secs&quot;:0},&quot;stats&quot;:{&quot;bytes_printed&quot;:393,&quot;bytes_searched&quot;:7,&quot;elapsed&quot;:{&quot;human&quot;:&quot;0.000069s&quot;,&quot;nanos&quot;:69208,&quot;secs&quot;:0},&quot;matched_lines&quot;:2,&quot;matches&quot;:2,&quot;searches&quot;:1,&quot;searches_with_match&quot;:1}},&quot;type&quot;:&quot;summary&quot;}
</code></pre>
<p>And in 12, I get two matches</p>
<pre><code>$ ./target/debug/rg --version                                                                                                                                                                                                                                    
ripgrep 12.0.0 (rev b9cd95faf1)
-SIMD -AVX (compiled)
+SIMD +AVX (runtime)
$ ./target/debug/rg &#x27;\Wa&#x27; --json --multiline /tmp/searchtest                                                                                                                                                                                                      
{&quot;type&quot;:&quot;begin&quot;,&quot;data&quot;:{&quot;path&quot;:{&quot;text&quot;:&quot;/tmp/searchtest/main.txt&quot;}}}
{&quot;type&quot;:&quot;match&quot;,&quot;data&quot;:{&quot;path&quot;:{&quot;text&quot;:&quot;/tmp/searchtest/main.txt&quot;},&quot;lines&quot;:{&quot;text&quot;:&quot;.a1\n&quot;},&quot;line_number&quot;:1,&quot;absolute_offset&quot;:0,&quot;submatches&quot;:[{&quot;match&quot;:{&quot;text&quot;:&quot;.a&quot;},&quot;start&quot;:0,&quot;end&quot;:2}]}}
{&quot;type&quot;:&quot;match&quot;,&quot;data&quot;:{&quot;path&quot;:{&quot;text&quot;:&quot;/tmp/searchtest/main.txt&quot;},&quot;lines&quot;:{&quot;text&quot;:&quot;.a2&quot;},&quot;line_number&quot;:2,&quot;absolute_offset&quot;:4,&quot;submatches&quot;:[{&quot;match&quot;:{&quot;text&quot;:&quot;.a&quot;},&quot;start&quot;:0,&quot;end&quot;:2}]}}
{&quot;type&quot;:&quot;end&quot;,&quot;data&quot;:{&quot;path&quot;:{&quot;text&quot;:&quot;/tmp/searchtest/main.txt&quot;},&quot;binary_offset&quot;:null,&quot;stats&quot;:{&quot;elapsed&quot;:{&quot;secs&quot;:0,&quot;nanos&quot;:5538755,&quot;human&quot;:&quot;0.005539s&quot;},&quot;searches&quot;:1,&quot;searches_with_match&quot;:1,&quot;bytes_searched&quot;:7,&quot;bytes_printed&quot;:441,&quot;matched_lines&quot;:2,&quot;matches&quot;:2}}}
{&quot;data&quot;:{&quot;elapsed_total&quot;:{&quot;human&quot;:&quot;0.027916s&quot;,&quot;nanos&quot;:27916431,&quot;secs&quot;:0},&quot;stats&quot;:{&quot;bytes_printed&quot;:441,&quot;bytes_searched&quot;:7,&quot;elapsed&quot;:{&quot;human&quot;:&quot;0.005539s&quot;,&quot;nanos&quot;:5538755,&quot;secs&quot;:0},&quot;matched_lines&quot;:2,&quot;matches&quot;:2,&quot;searches&quot;:1,&quot;searches_with_match&quot;:1}},&quot;type&quot;:&quot;summary&quot;}
</code></pre>
<p>Just let me know if you intend to keep this behavior and I can most likely adapt to it.</p>
<p>Downstream issue <a href="https://github.com/microsoft/vscode/issues/131507">microsoft/vscode#131507</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ashidaharo">@ashidaharo</a> on 2021-09-08 06:38</div>
            <div class="timeline-body"><p>I have found a smaller instance that reproduces this problem.
It&#x27;s &#x27;(? :\n|\.) a&#x27;. By the definition of \W, \W can be matched with \n.
I noticed that there is an explanation related to this problem in the help section for the --multiline option.</p>
<blockquote>
<p><strong>WARNING</strong>: Because of how the underlying regex engine works, multiline
searches may be slower than normal line-oriented searches, and they may also
use more memory. In particular, when multiline mode is enabled, ripgrep
requires that each file it searches is laid out contiguously in memory
(either by reading it onto the heap or by memory-mapping it). Things that
cannot be memory-mapped (such as stdin) will be consumed until EOF before
searching can begin. In general, ripgrep will only do these things when
necessary. Specifically, if the --multiline flag is provided but the regex
does not contain patterns that would match &#x27;\n&#x27; characters, then ripgrep
will automatically avoid reading each file into memory before searching it.
Nevertheless, if you only care about matches spanning at most one line, then it
is always better to disable multiline mode.</p>
<p>This flag can be disabled with --no-multiline.</p>
</blockquote>
<p>Uh... so, based on this warning, the output from the match with &#x27;\n&#x27; in the given expression is more likely to be correct for &quot;multiline mode&quot;output...?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:11 UTC
    </footer>
</body>
</html>
