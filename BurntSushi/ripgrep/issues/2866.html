<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Large memory consumption with `globset::GlobSet.is_match` - BurntSushi/ripgrep #2866</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Large memory consumption with <code>globset::GlobSet.is_match</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/2866">#2866</a>
        opened by <a href="https://github.com/iesahin">@iesahin</a>
        on 2024-08-06 09:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/iesahin">@iesahin</a></div>
            <div class="timeline-body"><h3>Please tick this box to confirm you have reviewed the above.</h3>
<ul>
<li>[X] I have a different issue.</li>
</ul>
<h3>What version of ripgrep are you using?</h3>
<p>globset = &quot;0.4&quot;</p>
<h3>How did you install ripgrep?</h3>
<p>cargo add globset</p>
<h3>What operating system are you using ripgrep on?</h3>
<p>macOS 14.5 (reproduced this with Linux as well)</p>
<h3>Describe your bug.</h3>
<p>This is about globset crate. Sorry if I'm reporting it at the wrong place.</p>
<p>I'm building <a href="https://github.com/iesahin/xvc/">a project</a> where you can track binary files on top of Git.</p>
<p>I'm using globset in <a href="https://github.com/iesahin/xvc">Xvc</a> for <code>check-ignore</code> functionality, mostly around: https://github.com/iesahin/xvc/blob/develop/walker/src/ignore_rules.rs</p>
<p>Xvc uses <code>.gitignore</code> to hide files it tracks from Git. I have a large repository with ~3000 lines in its <code>.gitignore</code>.</p>
<p>When I run a command which uses ignore files, I noticed memory consumption jumps to 10+GB from ~50MB. I traced the memory consumption line by line.</p>
<pre><code class="language-rust">    watch!(PEAK_ALLOC.current_usage_as_mb());
    let result = if ignore_rules.whitelist_set.read().unwrap().is_match(&amp;path) {
        MatchResult::Whitelist
    } else if ignore_rules.ignore_set.read().unwrap().is_match(&amp;path) {
        MatchResult::Ignore
    } else {
        MatchResult::NoMatch
    };
    watch!(PEAK_ALLOC.current_usage_as_mb());
</code></pre>
<p>In this code, <code>ignore_set</code> and <code>whitelist_set</code> are <code>Arc&lt;RwLock&lt;GlobSet&gt;&gt;</code>. The first <code>watch!</code> and second <code>watch!</code> results are:</p>
<pre><code>[TRACE][walker/src/lib.rs::798] PEAK_ALLOC.current_usage_as_mb(): 59.06844
[TRACE][walker/src/lib.rs::806] PEAK_ALLOC.current_usage_as_mb(): 10988.586
</code></pre>
<p>Two <code>GlobSet</code>s are built before these lines and only <code>is_match</code> is called.</p>
<p>This is likely something on my end, but I wanted to ask whether you have observed this or 3000 ignore rules are something unexpected. I'll continue to debug this and may go inside the crate as well, but I'd like to know if this is a known issue.</p>
<p>Thanks a lot.</p>
<h3>What are the steps to reproduce the behavior?</h3>
<p>I can submit the file I'm testing and other detailed instructions if you think this could be something with globset</p>
<h3>What is the actual behavior?</h3>
<p>The memory consumption from <code>is_match</code> method is +10GB.</p>
<h3>What is the expected behavior?</h3>
<p>The memory consumption shouldn't change much between those lines</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-08-06 10:50</div>
            <div class="timeline-body"><p>Please provide an MRE.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/iesahin">@iesahin</a> on 2024-08-27 17:42</div>
            <div class="timeline-body"><p>Replaced dependency with another lib. I'll provide an MRE if my time permits. Closing this for now. Thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @iesahin on 2024-08-27 17:42</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:43:50 UTC
    </footer>
</body>
</html>
