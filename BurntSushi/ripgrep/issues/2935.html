<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>surprising behavior of replacement using number capture groups when combined with multiple search patterns - BurntSushi/ripgrep #2935</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>surprising behavior of replacement using number capture groups when combined with multiple search patterns</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/2935">#2935</a>
        opened by <a href="https://github.com/hugues-aff">@hugues-aff</a>
        on 2024-11-16 23:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/hugues-aff">@hugues-aff</a></div>
            <div class="timeline-body">Please tick this box to confirm you have reviewed the above.
<ul>
<li>[X] I have a different issue.</li>
</ul>
What version of ripgrep are you using?
<pre><code>ripgrep 14.1.1 (rev 4649aa9700)

features:+pcre2
simd(compile):+NEON
simd(runtime):+NEON
</code></pre>
How did you install ripgrep?
<p>homebrew</p>
What operating system are you using ripgrep on?
<p>macOS 14.7</p>
Describe your bug.
<p>ripgrep behavior when combining multiple patterns and replacement strings using numbered capture groups is very surprising.</p>
What are the steps to reproduce the behavior?
<p>Run <code>rg -e &#x27;(foo)&#x27; -e &#x27;(bar)&#x27; -r &#x27;$1&#x27; -o</code> in a directory with files containing strings <code>foo</code> and <code>bar</code></p>
What is the actual behavior?
<p>Lines that contain <code>foo</code> get printed as <code>foo</code>, as expected
Lines that contain <code>bar</code> get printed as empty, which is rather surprising since neither of the patterns allow empty string</p>
<p>If I switch the replacement to <code>-r &#x27;$2&#x27;</code>, I see:</p>
<p>Lines that contain <code>foo</code> get printed as empty
Lines that contain <code>bar</code> get printed as <code>bar</code></p>
What is the expected behavior?
<p>I would expect the replacement index to reference whichever pattern actually matched, resulting in:</p>
<p>Lines that contain <code>foo</code> get printed as <code>foo</code>
Lines that contain <code>bar</code> get printed as <code>bar</code></p>
<p>As a workaround, I can achieve this behavior right now using <code>-r &#x27;$1$2&#x27;</code> which works but is rather unintuitive</p>
<p>My preferred solution would be to allow a 1:1 mapping for <code>-r</code> to <code>-e</code>, but failing that, it seems like the indexing into capture groups when given multiple patterns should either be changed to be more intuitive, or at least documented if we&#x27;re worried about breaking backwards compatibility</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-11-17 00:01</div>
            <div class="timeline-body"><p>Please provide an MRE.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hugues-aff">@hugues-aff</a> on 2024-11-17 07:37</div>
            <div class="timeline-body"><pre><code>hugues.bruant@HBruant-M-C600F bugs % cat - &gt;test &lt;&lt;EOF
heredoc&gt; foo
heredoc&gt; bar
heredoc&gt; baz
heredoc&gt; qux
heredoc&gt; EOF
hugues.bruant@HBruant-M-C600F bugs % cat test
foo
bar
baz
qux
hugues.bruant@HBruant-M-C600F bugs % rg -e &#x27;(foo)&#x27; -e &#x27;(bar)&#x27; -r &#x27;$1&#x27; -o
test
1:foo
2:
hugues.bruant@HBruant-M-C600F bugs % rg -e &#x27;(foo)&#x27; -e &#x27;(bar)&#x27; -r &#x27;$2&#x27; -o
test
1:
2:bar
hugues.bruant@HBruant-M-C600F bugs % rg -e &#x27;(foo)&#x27; -e &#x27;(bar)&#x27; -r &#x27;$1$2&#x27; -o
test
1:foo
2:bar
hugues.bruant@HBruant-M-C600F bugs %
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-11-17 12:32</div>
            <div class="timeline-body"><p>Yeah the issue here is that ripgrep doesn&#x27;t really provide multi pattern support everywhere. When you provide more than one pattern, it &quot;just&quot; stitches them all together into one regex.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-11-17 12:32</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:14 UTC
    </footer>
</body>
</html>
