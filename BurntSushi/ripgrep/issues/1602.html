<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>test misc::compressed_uncompress ... FAILED - BurntSushi/ripgrep #1602</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>test misc::compressed_uncompress ... FAILED</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/1602">#1602</a>
        opened by <a href="https://github.com/gyakovlev">@gyakovlev</a>
        on 2020-05-28 12:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gyakovlev">@gyakovlev</a></div>
            <div class="timeline-body"><p>Hi, got a test falure here. Does not look like a huge deal, but wanted to let you know.</p>
What version of ripgrep are you using?
<p>ripgrep 12.1.0
-SIMD -AVX (compiled)</p>
How did you install ripgrep?
<p>from gentoo repositories (I maintain ripgrep package/ebuild)</p>
What operating system are you using ripgrep on?
<p>Genroo rolling. tested on x86_64 and ppc64, same test failure.
distribution package of rustc 1.43.1 (which I also maintain)
also reproducable with official tarball of  rustc-1.43.1</p>
Describe your bug.
<p>.Z compress test fails with both uncompress provided by gzip and ncompress package.
gentoo bug and full buld log available here
https://bugs.gentoo.org/725778</p>
What are the steps to reproduce the behavior?
<p>cargo test</p>
What is the actual behavior?
<pre><code>test misc::compressed_uncompress ... FAILED

failures:

---- misc::compressed_uncompress stdout ----
thread &#x27;misc::compressed_uncompress&#x27; panicked at &#x27;

==========
command failed but expected success!

Did your search end up with no results?

command: &quot;/var/tmp/portage/sys-apps/ripgrep-12.1.0/work/ripgrep-12.1.0/target/release/deps/../rg&quot; &quot;--path-separator&quot; &quot;/&quot; &quot;-z&quot; &quot;Sherlock&quot; &quot;sherlock.Z&quot;

cwd: /var/tmp/portage/sys-apps/ripgrep-12.1.0/temp/ripgrep-tests/compressed_uncompress/108

dir list: [&quot;/var/tmp/portage/sys-apps/ripgrep-12.1.0/temp/ripgrep-tests/compressed_uncompress/108&quot;, &quot;/var/tmp/portage/sys-apps/ripgrep-12.1.0/temp/ripgrep-tests/compressed_uncompress/108/sherlock.Z&quot;]

status: exit code: 1

stdout:

stderr:

==========
==========
&#x27;, tests/util.rs:406:13
stack backtrace:
   0:        0x106826d94 - &lt;std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display&gt;::fmt::h1e21cbf03e4e5763
   1:        0x10685a364 - core::fmt::write::hb3ff83338e8b2d66
   2:        0x1067d3d58 - std::io::Write::write_fmt::h5fd38946bf8c7a11
   3:        0x10680f8dc - std::io::impls::&lt;impl std::io::Write for alloc::boxed::Box&lt;W&gt;&gt;::write_fmt::h0e0d8e73cfc9ac67
   4:        0x106810964 - std::panicking::default_hook::{{closure}}::ha159ab335d6d2780
   5:        0x1068104dc - std::panicking::default_hook::hc6f8b73d36ecf078
   6:        0x1068112ac - std::panicking::rust_panic_with_hook::h2b8f1d2ef0497000
   7:        0x106810d08 - rust_begin_unwind
   8:        0x106810c30 - std::panicking::begin_panic_fmt::h4ffe547a81dbf942
   9:        0x1067a621c - integration::util::TestCommand::expect_success::h742640728124be65
  10:        0x1067a4c74 - integration::util::TestCommand::stdout::h9c875b01ea94d149
  11:        0x106781210 - integration::misc::compressed_uncompress::h040d70216738de96
  12:        0x1067b7194 - test::__rust_begin_short_backtrace::h5d4bbc96f3e45b05
  13:        0x1067bdad8 - &lt;alloc::boxed::Box&lt;F&gt; as core::ops::function::FnOnce&lt;A&gt;&gt;::call_once::he06369dcdc359518
  14:        0x1068341d0 - __rust_try
  15:        0x10683404c - __rust_maybe_catch_panic
  16:        0x1067b7440 - test::run_test_in_process::hab58b4da0b1dab28
  17:        0x1067c3fa4 - std::sys_common::backtrace::__rust_begin_short_backtrace::h71a54a46a35eda28
  18:        0x1067c5378 - std::panicking::try::do_call::h3448860c56f573f7
  19:        0x1068341d0 - __rust_try
  20:        0x10683404c - __rust_maybe_catch_panic
  21:        0x1067bc87c - core::ops::function::FnOnce::call_once{{vtable.shim}}::h513d035f57eb50fe
  22:        0x10680f628 - &lt;alloc::boxed::Box&lt;F&gt; as core::ops::function::FnOnce&lt;A&gt;&gt;::call_once::hefcd91f4e78e44b5
  23:        0x106828074 - std::sys_common::thread::start_thread::hf3c0bc78acf4ce1e
  24:        0x10681c798 - std::sys::unix::thread::Thread::new::thread_start::he003e4e14f3e450a
  25:     0x7fff9de1850c - start_thread
                               at /var/tmp/portage/sys-libs/glibc-2.31-r3/work/glibc-2.31/nptl/pthread_create.c:477
  26:     0x7fff9dcf8b34 - __clone


failures:
    misc::compressed_uncompress

test result: FAILED. 254 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out
</code></pre>
What is the expected behavior?
<p>Test should succeed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-05-28 12:25</div>
            <div class="timeline-body"><p>I&#x27;m not sure this is a problem on ripgrep&#x27;s end. Here is the test in question:</p>
<pre><code>rgtest!(compressed_uncompress, |dir: Dir, mut cmd: TestCommand| {
    if !cmd_exists(&quot;uncompress&quot;) {
        return;
    }

    dir.create_bytes(&quot;sherlock.Z&quot;, include_bytes!(&quot;./data/sherlock.Z&quot;));
    cmd.arg(&quot;-z&quot;).arg(&quot;Sherlock&quot;).arg(&quot;sherlock.Z&quot;);

    let expected = &quot;\
    For the Doctor Watsons of this world, as opposed to the Sherlock
be, to a very large extent, the result of luck. Sherlock Holmes
&quot;;
    eqnice!(expected, cmd.stdout());
});
</code></pre>
<p>All this is doing is doing is copying the bytes from a pre-compressed <code>sherlock.Z</code> file in this repository, and then asking ripgrep to search it with its <code>-z</code> flag. The test failing implies, to me, that <code>uncompress</code> is installed but is for some reason not decompressing the <code>sherlock.Z</code> flag. So to debug this, I&#x27;d try this in your environment (from the root of a ripgrep checkout):</p>
<pre><code>$ uncompress -c tests/data/sherlock.Z &gt; /tmp/sherlock
$ rg &#x27;Sherlock&#x27; /tmp/sherlock
1:For the Doctor Watsons of this world, as opposed to the Sherlock
3:be, to a very large extent, the result of luck. Sherlock Holmes
</code></pre>
<p>Do you get the same output? If so, then I&#x27;d be perplexed. But if not, then I think you will have isolated the problem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-05-28 12:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gyakovlev">@gyakovlev</a> on 2020-05-28 18:36</div>
            <div class="timeline-body"><p>well looks like it&#x27;s not working for real.</p>
<pre><code>ya@hydra /tmp $ which uncompress
/usr/bin/uncompress

ya@hydra /tmp $ file /usr/bin/uncompress
/usr/bin/uncompress: symbolic link to /usr/bin/compress

file /usr/bin/compress
/usr/bin/compress: ELF 64-bit LSB pie executable, 64-bit PowerPC or cisco 7500, version 1 (SYSV), dynamically linked, interpreter /lib64/ld64.so.2, for GNU/Linux 3.10.0, stripped

ya@hydra /tmp $ file sherlock.Z
sherlock.Z: compress&#x27;d data 16 bits

ya@hydra /tmp $ uncompress -c sherlock.Z
For the Doctor Watsons of this world, as opposed to the Sherlock
Holmeses, success in the province of detective work must always
be, to a very large extent, the result of luck. Sherlock Holmes
can extract a clew from a wisp of straw or a flake of cigar ash;
but Doctor Watson has to have it taken out for him and dusted,
and exhibited clearly, with a label attached.

ya@hydra /tmp $ zgrep Sherlock sherlock.Z
For the Doctor Watsons of this world, as opposed to the Sherlock
be, to a very large extent, the result of luck. Sherlock Holmes
</code></pre>
<pre><code>rg --search-zip Sherlock sherlock.Z
rg  -z Sherlock  sherlock.Z
rg -z &#x27;Sherlock&#x27;  sherlock.Z
rg &#x27;Sherlock&#x27;  sherlock.Z
</code></pre>
<p>^ all return empty result.</p>
<p>what&#x27;s interesting,</p>
<pre><code>rg  S sherlock.Z
Binary file matches (found &quot;\u{0}&quot; byte around offset 285)
</code></pre>
<p>so it looks like it does not honor .Z as compressed file and treats it as binary?
https://github.com/BurntSushi/ripgrep/commit/df7a3bfc7fe30f3e9e89d8775748b1239c5b5fc4 seems to be adding it.</p>
<p>What else can I do to find the reason it&#x27;s not liking .Z ?</p>
<p><code>strace -fk</code> of <code>rg S sherlock.Z</code> here https://gist.github.com/gyakovlev/8039cb9d5ef6a08e5309ceb6c9ecdbe7</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-05-28 18:48</div>
            <div class="timeline-body"><blockquote>
<p>so it looks like it does not honor .Z as compressed file and treats it as binary?</p>
</blockquote>
<p>That&#x27;s normal. If you don&#x27;t provide the <code>-z/--search-zip</code> flag, then ripgrep doesn&#x27;t do any intelligent decompressing, just like <code>grep</code>. So the <code>strace</code> of that isn&#x27;t interesting. Could you post the output of <code>strace rg -z Sherlock sherlock.Z</code>?</p>
<p>The part I don&#x27;t understand here is why <code>uncompress -c sherlock.Z</code> is working as I&#x27;d expect, but ripgrep still isn&#x27;t finding any matches. That should be the exact command that ripgrep is running. So maybe the aforementioned <code>strace</code> will reveal something that defies my expectations. Otherwise, I&#x27;m not sure what&#x27;s going on. I&#x27;d need a reproduction to debug it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gyakovlev">@gyakovlev</a> on 2020-05-28 19:32</div>
            <div class="timeline-body"><p>thing is then I run it with <code>-z</code> flag it also thinks it&#x27;s a binary</p>
<pre><code>rg -z S sherlock.Z
Binary file matches (found &quot;\u{0}&quot; byte around offset 285)
</code></pre>
<ul>
<li><p>strace -fk -o rg_-z_S_sherlock.Z.txt rg -z S sherlock.Z  (matches binary)
https://gist.github.com/gyakovlev/90b2106c0cbf6e2c59b226aa0ffe7215</p>
</li>
<li><p>strace -fk -o rg_-z_Sherlock_sherlock.Z.txt rg -z Sherlock sherlock.Z (empty result)
https://gist.github.com/gyakovlev/ae37b86ac6ec3dd75d43a438b7c2efe9</p>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gyakovlev">@gyakovlev</a> on 2020-05-28 19:41</div>
            <div class="timeline-body"><p>gzipped file works btw.</p>
<pre><code>rg -z Sherlock sherlock.gz
1:For the Doctor Watsons of this world, as opposed to the Sherlock
3:be, to a very large extent, the result of luck. Sherlock Holmes
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-05-28 23:08</div>
            <div class="timeline-body"><p>@gyakovlev Wait, but in your prior comment, you said that <code>rg -z Sherlock sherlock.Z</code> returned an empty result? Now it&#x27;s giving you the <code>Binary file matches</code> message instead? Oh, I see, you&#x27;re saying that <code>rg -z S sherlock.Z</code> gives you the <code>Binary file matches</code> message where as <code>rg -z Sherlock sherlock.Z</code> gives you an empty result?</p>
<p>Unfortunately, the <code>strace</code> output doesn&#x27;t offer me any clues. One last thing you can try:</p>
<pre><code>$ rg -z --debug Sherlock sherlock.Z
</code></pre>
<p>and</p>
<pre><code>$ rg -z --debug S sherlock.Z
</code></pre>
<p>Hopefully that gives us the clue we need.</p>
<p>Thank you for your patience in helping me debug this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gyakovlev">@gyakovlev</a> on 2020-05-29 07:47</div>
            <div class="timeline-body"><p>correct, different pattern <code>S</code> just to show how the match looks like and now it prints that&#x27;s a binary match, instead of searching inside stdout decompressed stream.</p>
<p>I&#x27;ve tried experimenting more on it and it looks like that ripgrep built outside of package manager does .Z decompression properly.</p>
<p>after some digging I figured out the difference.
we enforce local builds and pre-fetch all crates and create a temporary cargo repo with locked dependencies for each build.</p>
<p>due to my overlook the build was using downloaded <code>.crate</code> versions of some dependencies, instead of using local workspace sources that are members of workspace of this repo (crates/*)</p>
<p>grep-cli-0.1.4 for instance was pulled in as a crate instead of crates/cli directory.
and published version of <code>grep-cli-0.1.4</code> does not yet have <code>uncompress</code> support =)</p>
<p>TLDR: the build was using external sources instead of local dir.</p>
<p>thanks for your time and work on ripgrep, sorry for the noise =)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-05-29 12:53</div>
            <div class="timeline-body"><p>@gyakovlev Ug. Nope, it is <em>not</em> your fault. It&#x27;s mine! The actual ripgrep release should be using tagged versions of crates in this repo, but it looks like I did not tag a new release of <code>grep-cli</code>. For example, <code>cargo install ripgrep</code> would compile <code>grep-cli 0.1.4</code> which, as you&#x27;ve pointed out, doesn&#x27;t have the added support for <code>uncompress</code>, which was definitely not intended. In general, <code>cargo install ripgrep</code> should correspond to the same functionality as installing one of the ripgrep binary releases.</p>
<p>A similarish but different thing happened a while back with the Debian packagers (see #1144 and <a href="https://github.com/BurntSushi/ripgrep/issues/1144#issuecomment-462079123">my comment for the realization of what happened</a>). I would love to figure out how to catch this in my release process, because it&#x27;s otherwise pretty tricky to do so. The Cargo tooling kind of makes everything seamless for crates in the same workspace/repo, so you don&#x27;t tend to realize when compilation is using a tagged release versus what&#x27;s on master. This is why I <a href="https://github.com/BurntSushi/ripgrep/blob/master/RELEASE-CHECKLIST.md">created a release checklist</a>, but I guess it&#x27;s still pretty easy to screw up, apparently.</p>
<p>I&#x27;ll tag a ripgrep 12.1.1 release.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-05-29 12:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-05-29 12:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-05-29 13:50</div>
            <div class="timeline-body"><p>This has been fixed with the <a href="https://github.com/BurntSushi/ripgrep/releases/tag/12.1.1">12.1.1 release</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-05-29 13:50</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:10 UTC
    </footer>
</body>
</html>
