<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cannot handle regexps with Japanese - BurntSushi/ripgrep #309</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Cannot handle regexps with Japanese</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/309">#309</a>
        opened by <a href="https://github.com/rubikitch">@rubikitch</a>
        on 2017-01-08 22:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/rubikitch">@rubikitch</a></div>
            <div class="timeline-body"><pre><code>$ cd /tmp
$ wget -q -O japanese.org http://rubikitch.com/f/japanese.org
$ cat japanese.org
* &lt;2017-01-09 Mon&gt;日本語タイトル
Hello!
$ ag --file-search-regex .\*.org --nocolor --line-number --smart-case --nogroup --column -- \^\(\\\*\)\+.\*\日\本\語 japanese.org
1:1:* &lt;2017-01-09 Mon&gt;日本語タイトル
$ rg  --no-heading --vimgrep \^\(\\\*\)\+.\*\日\本\語 japanese.org
$ rg  --no-heading --vimgrep \日\本\語 japanese.org
1:19:* &lt;2017-01-09 Mon&gt;日本語タイトル
$ rg --version
ripgrep 0.3.2</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-01-09 00:08</div>
            <div class="timeline-body"><p>I can't reproduce the issue. Namely, I see this:</p>
<pre><code>$ rg  --no-heading --vimgrep \^\(\\\*\)\+.\*\日\本\語 japanese.org
1:1:* &lt;2017-01-09 Mon&gt;日本語タイトル
</code></pre>
<p>With that said, I find your regex very puzzling and hard to read. Why are you mixing shell escaping with regex escaping? It's almost guaranteed to lead to sadness. For example, this is much clearer:</p>
<pre><code>$ rg '^(\*)+.*日本語' japanese.org
1:* &lt;2017-01-09 Mon&gt;日本語タイトル
</code></pre>
<p>To me, this suggests your problem is with escapes. Namely, if <code>^</code> is escaped inside the regex, then it will be treated as a literal <code>^</code>, which will cause your specific search to fail. But if <code>^</code> is escaped by the shell, then it will be interpreted as the special begin-line assertion. For example, this search fails:</p>
<pre><code>$ rg '\^(\*)+.*日本語' japanese.org
</code></pre>
<p>I see no reason why the Japanese characters have anything at all to do with this. ripgrep's Unicode support is strictly superior to ag's.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @BurntSushi on 2017-01-09 00:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rubikitch">@rubikitch</a> on 2017-01-09 03:28</div>
            <div class="timeline-body"><p>I cannot reproduce it. What's wrong?
The complex regex is generated by org-seek.el/ripgrep.el in Emacs (shell-quote-argument).</p>
<pre><code>$ cd /tmp
$ rg --no-heading --vimgrep '日本語' japanese.org
1:19:* &lt;2017-01-09 Mon&gt;日本語タイトル
$ rg --no-heading --vimgrep \^\(\\\*\)\+.\*\日\本\語 japanese.org
$ rg --no-heading --vimgrep '^(\*)+.*日本語' japanese.org</code></pre>
<p>It works well in non-Japanese chars.</p>
<pre><code>$ rg --no-heading --vimgrep \^\(\\\*\)\+.\*Mon japanese.org
1:1:* &lt;2017-01-09 Mon&gt;日本語タイトル
$ rg --no-heading --vimgrep '^(\*)+.*Mon' japanese.org
1:1:* &lt;2017-01-09 Mon&gt;日本語タイトル</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-01-10 01:15</div>
            <div class="timeline-body"><p>I'm stumped on this one. I've even specifically tried ripgrep <code>0.3.2</code> (as opposed to current master), and I still can't reproduce the bug you're seeing. It honestly doesn't make any sense to me. Is there anything else about your environment that might be impacting search? What shell are you running? (Although, I can't even think of something that would cause this bug.)</p>
<p>If you're still willing to debug this, can you try to widdle down the regex that fails? What is the <em>smallest</em> regex you can write with the <code>日本語</code> literal that still fails? For example, does <code>.*日本語</code> work? What about <code>^.*日本語</code>? Can you try others?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rubikitch">@rubikitch</a> on 2017-01-16 06:57</div>
            <div class="timeline-body"><p>This problem is fixed in 0.4.0. Thank you very much!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-01-16 11:45</div>
            <div class="timeline-body"><p>@rubikitch Strange. I still don't understand what was going on or what could have caused the bug. :-/</p>
<p>If anyone can reproduce it and do the <a href="https://github.com/BurntSushi/ripgrep/issues/309#issuecomment-271458479">minimization steps</a>, that would be much appreciated. Until then, I'll close this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2017-01-16 11:45</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:42:00 UTC
    </footer>
</body>
</html>
