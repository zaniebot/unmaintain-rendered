<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Only some ignores applied when searching a sub-directory - BurntSushi/ripgrep #1757</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Only some ignores applied when searching a sub-directory</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/1757">#1757</a>
        opened by <a href="https://github.com/SimonSapin">@SimonSapin</a>
        on 2020-12-08 14:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/SimonSapin">@SimonSapin</a></div>
            <div class="timeline-body"><h4>What version of ripgrep are you using?</h4>
<pre><code>ripgrep 12.1.1
-SIMD -AVX (compiled)
+SIMD +AVX (runtime)
</code></pre>
<h4>How did you install ripgrep?</h4>
<p>System package https://www.archlinux.org/packages/community/x86_64/ripgrep/</p>
<h4>What operating system are you using ripgrep on?</h4>
<p>Arch Linux</p>
<h4>Describe your bug.</h4>
<p>When giving a sub-directory of the current directory to search as a second command-line argument to ripgrep, only some patterns of <code>.ignore</code> in the current directory are applied.</p>
<h4>What are the steps to reproduce the behavior?</h4>
<pre><code class="language-sh">mkdir tmp
cd tmp
mkdir rust
mkdir rust/target
echo needle &gt; rust/source.rs
echo needle &gt; rust/target/rustdoc-output.html
echo rust/target &gt; .ignore
rg --files-with-matches needle
rg --files-with-matches needle rust
echo target &gt;&gt; .ignore
rg --files-with-matches needle rust
</code></pre>
<h4>What is the actual behavior?</h4>
<p>The first and third <code>rg</code> commands only print <code>rust/source.rs</code> as expected. However the second one prints both <code>rust/source.rs</code> and <code>rust/target/rustdoc-output.html</code>.</p>
<p>With <code>--debug</code> added, and <code>-j1</code> for more readable output:</p>
<pre><code>$ rg --files-with-matches needle --debug -j1
DEBUG|grep_regex::literal|crates/regex/src/literal.rs:58: literal prefixes detected: Literals { lits: [Complete(needle)], limit_size: 250, limit_class: 10 }
DEBUG|globset|crates/globset/src/lib.rs:431: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:431: built glob set; 1 literals, 0 basenames, 0 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|ignore::walk|crates/ignore/src/walk.rs:1730: ignoring ./.ignore: Ignore(IgnoreMatch(Hidden))
rust/source.rs
DEBUG|ignore::walk|crates/ignore/src/walk.rs:1730: ignoring ./rust/target: Ignore(IgnoreMatch(Gitignore(Glob { from: Some(&quot;./.ignore&quot;), original: &quot;rust/target&quot;, actual: &quot;rust/target&quot;, is_whitelist: false, is_only_dir: false })))

</code></pre>
<pre><code>$ rg --files-with-matches needle rust --debug -j1
DEBUG|grep_regex::literal|crates/regex/src/literal.rs:58: literal prefixes detected: Literals { lits: [Complete(needle)], limit_size: 250, limit_class: 10 }
DEBUG|globset|crates/globset/src/lib.rs:431: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:431: built glob set; 1 literals, 0 basenames, 0 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
rust/source.rs
rust/target/rustdoc-output.html
</code></pre>
<p>After <code>echo target &gt;&gt; .ignore</code>:</p>
<pre><code>$ rg --files-with-matches needle rust --debug -j1
DEBUG|grep_regex::literal|crates/regex/src/literal.rs:58: literal prefixes detected: Literals { lits: [Complete(needle)], limit_size: 250, limit_class: 10 }
DEBUG|globset|crates/globset/src/lib.rs:431: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:431: built glob set; 1 literals, 1 basenames, 0 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
rust/source.rs
DEBUG|ignore::walk|crates/ignore/src/walk.rs:1730: ignoring rust/target: Ignore(IgnoreMatch(Gitignore(Glob { from: Some(&quot;/tmp/tmp/.ignore&quot;), original: &quot;target&quot;, actual: &quot;**/target&quot;, is_whitelist: false, is_only_dir: false })))
</code></pre>
<h4>What is the expected behavior?</h4>
<p>Each command should only print <code>rust/source.rs</code>, as the HTML file should be ignored.</p>
<p>One might imagine that when searching a sub-directory only <code>.ignore</code> files under that sub-directory are considered, but the third command shows that is not the case. (The more general ignore pattern is not the desired one, it only serves to show that the <code>.ignore</code> file is indeed read.)</p>
<h4>Work-around</h4>
<p>I’ve managed to find a set up that does what I want by creating a <code>.ignore</code> file in the <code>rust</code> sub-directory of the project instead, with a <code>/target</code> pattern.</p>
<h4>Other suggestion</h4>
<p>After trying a few things and seeing unexpected results I wanted to find out details of the syntax of <code>.ignore</code> files. For example, is an initial slash meaningful?</p>
<p>I had to dig to find the answer in https://docs.rs/ignore/0.4.17/ignore/struct.WalkBuilder.html:</p>
<blockquote>
<p><code>.ignore</code> files have the same semantics as <code>gitignore</code> files</p>
</blockquote>
<p>and</p>
<blockquote>
<p><code>.gitignore</code> files have match semantics as described in the <code>gitignore</code> man page.</p>
</blockquote>
<p>It would be good to repeat these two facts in ripgrep’s own docs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @BurntSushi on 2020-12-09 17:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/goto-engineering">@goto-engineering</a> on 2020-12-10 21:29</div>
            <div class="timeline-body"><p>This works for me with <code>rg 12.1.1</code> on macOS:
<img width="344" alt="image" src="https://user-images.githubusercontent.com/16588780/101832128-c8788800-3aeb-11eb-9163-4d57732693c4.png"></p>
<p>edit: nevermind, I realized that you're fixing the problem as part of the recreate steps. If I only execute the first 2 <code>rg</code> commands, I'm getting the same thing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/SimonSapin">@SimonSapin</a> on 2020-12-10 21:54</div>
            <div class="timeline-body"><p>Ah yes, sorry, I should have separated that last step some more.</p>
<p>To me it’s not really a fix since it also ignore directories or files named <code>target</code> at any other location, which is not necessarily desirable. I only included it to show that <code>.ignore</code> in the current directory is read at all when searching a sub-directory. (It might make some sense if it weren’t even though that’s nat what I’d want in this case.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">gitignore</span> added by @BurntSushi on 2023-07-08 13:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2023-09-20 15:52</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:43:17 UTC
    </footer>
</body>
</html>
