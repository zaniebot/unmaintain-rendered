<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Small performance regression in ignore-0.4.x - BurntSushi/ripgrep #835</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Small performance regression in ignore-0.4.x</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/835">#835</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2018-02-25 13:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body">What operating system are you using ripgrep on?
<p>Arch Linux, x86_64</p>
Describe your question, feature request, or bug.
<p>I was running some benchmarks for <code>fd</code> and noticed that there was a small (~5%) performance regression when I updated from <code>ignore-0.2.2</code> to <code>ignore-0.4.x</code>. I investigated some more and ran the same benchmark (<code>fd -uu &#x27;[0-9]\.jpg$&#x27;</code> in my home folder) multiple times while changing the version of the ignore crate:</p>
<p><img src="https://user-images.githubusercontent.com/4209276/36641938-2a14fe2c-1a38-11e8-9870-f11e8f999707.png" alt="image"></p>
<p>There are two things to notice:</p>
<ol>
<li>The timing for <code>ignore-0.3.0</code> is not visisble because it&#x27;s so fast (137 ms). This is due to a bug where not all results are shown (I didn&#x27;t investigate further, but the git log seems to indicate that something was wrong with <code>ignore-0.3.0</code>).</li>
<li>There is a small (but statistically significant) performance regression that seems to have been introduced with commit 3cb4d13 (Custom ignore files). Interestingly, I&#x27;m running a search that doesn&#x27;t even use ignore files (<code>-uu</code> is the same as in ripgrep).</li>
</ol>
What are the steps to reproduce the behavior?
<p>I can reproduce this behavior with ripgrep itself:</p>
<pre><code>▶ git checkout 51864c1; cargo install -f

...

▶ hyperfine --warmup 10 &#x27;rg -uu --files --iglob &quot;*[0-9].jpg&quot; ~&#x27;
Benchmark #1: rg -uu --files --iglob &quot;*[0-9].jpg&quot; ~

  Time (mean ± σ):     700.4 ms ±   5.3 ms    [User: 3.157 s, System: 2.310 s]
 
  Range (min … max):   691.4 ms … 709.0 ms

▶ git checkout 3cb4d13; cargo install -f

...

▶ hyperfine --warmup 10 &#x27;rg -uu --files --iglob &quot;*[0-9].jpg&quot; ~&#x27;
Benchmark #1: rg -uu --files --iglob &quot;*[0-9].jpg&quot; ~

  Time (mean ± σ):     725.4 ms ±   7.9 ms    [User: 3.318 s, System: 2.338 s]
 
  Range (min … max):   715.5 ms … 743.9 ms
</code></pre>
<p>(benchmarks performed with <a href="https://github.com/sharkdp/hyperfine">hyperfine</a> on a warm disk cache)</p>
<p>Again, the difference is small (~4%) but significant.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2018-02-25 15:32</div>
            <div class="timeline-body"><p>This seems to be caused by the additional <code>Gitignore</code> instance <code>custom_ignore_matcher</code> that has to be constructed in <code>Ignore::add_child_path</code>.</p>
<p>(apparently, the gitignore matchers are fully constructed even though no ignore-matching is performed)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-03-13 02:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-03-13 02:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-04-23 23:17</div>
            <div class="timeline-body"><p>@sharkdp What corpus were your tests above on? I finally had a chance to look at this, and I can&#x27;t really reproduce your results.</p>
<p>I&#x27;m testing on the chromium repo:</p>
<pre><code>$ git remote -v
origin  git://github.com/nwjs/chromium.src (fetch)
origin  git://github.com/nwjs/chromium.src (push)
$ git rev-parse --short=10 HEAD
3682723171
</code></pre>
<p>Testing ripgrep on current master:</p>
<pre><code>$ rg-baseline --version
ripgrep 0.8.1 (rev 507801c1f2)
+SIMD +AVX
$ hyperfine -s basic --warmup 10 &#x27;rg-baseline -uu --files&#x27;
Benchmark #1: rg-baseline -uu --files
  Time (mean ± σ):     230.6 ms ±  10.2 ms    [User: 1.004 s, System: 0.349 s]
  Range (min … max):   211.7 ms … 243.1 ms
</code></pre>
<p>Testing ripgrep with this PR, rebased on current master:</p>
<pre><code>$ rg --version
ripgrep 0.8.1 (rev 2c2162f7bc)
+SIMD +AVX
$ hyperfine -s basic --warmup 10 &#x27;rg -uu --files&#x27;
Benchmark #1: rg -uu --files
  Time (mean ± σ):     230.2 ms ±   9.6 ms    [User: 927.0 ms, System: 383.5 ms]
  Range (min … max):   210.4 ms … 246.0 ms
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2018-04-24 06:38</div>
            <div class="timeline-body"><blockquote>
<p>@sharkdp What corpus were your tests above on? I finally had a chance to look at this, and I can&#x27;t really reproduce your results.</p>
</blockquote>
<p>I was running this on my home folder - not very helpful, I&#x27;m sorry. Two things seem to be different in your case:</p>
<ul>
<li><p>I believe the associated PR will show a more significant speedup in cases where there is a deep directory tree with lots of <code>.gitignore</code> files.</p>
</li>
<li><p>Could you please try to add the <code>--iglob</code> option (with some file pattern that occurs only rarely) to make sure that the execution time is not dominated by writing to standard out?</p>
</li>
</ul>
<p>I know it&#x27;s not a very scientific method, but could you try to run the following commands in your home folder (or some other large directory)? I was just re-running the benchmarks with the rebased branch (which is now included in #836), and I still see a 10% speedup:</p>
<pre><code>&gt; rg-baseline --version
ripgrep 0.8.1 (rev bf51058eb2)
-SIMD -AVX

&gt; rg-pr --version                                               
ripgrep 0.8.1 (rev 92dcb44d10)
-SIMD -AVX

&gt; hyperfine --warmup 10 &#x27;rg-baseline -uu --files --iglob &quot;README*&quot;&#x27; \
                        &#x27;rg-pr       -uu --files --iglob &quot;README*&quot;&#x27;
Benchmark #1: rg-baseline -uu --files --iglob &quot;README*&quot;

  Time (mean ± σ):     760.8 ms ±   3.5 ms    [User: 3.395 s, System: 2.511 s]
 
  Range (min … max):   756.1 ms … 766.5 ms
 
Benchmark #2: rg-pr -uu --files --iglob &quot;README*&quot;

  Time (mean ± σ):     692.0 ms ±  15.5 ms    [User: 2.844 s, System: 2.493 s]
 
  Range (min … max):   679.6 ms … 731.3 ms
 
Summary

&#x27;rg-pr -uu --files --iglob &quot;README*&quot;&#x27; ran
    1.10x faster than &#x27;rg-baseline -uu --files --iglob &quot;README*&quot;&#x27;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-04-24 15:19</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:06 UTC
    </footer>
</body>
</html>
