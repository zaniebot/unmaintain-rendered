<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Don't raise an error when a choose-one flag is specified repeatedly - BurntSushi/ripgrep #553</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Don&#x27;t raise an error when a choose-one flag is specified repeatedly</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/553">#553</a>
        opened by <a href="https://github.com/sarahgerweck">@sarahgerweck</a>
        on 2017-07-13 01:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sarahgerweck">@sarahgerweck</a></div>
            <div class="timeline-body"><p>There is currently no way to set custom defaults for Ripgrep. The recommended practice is to set an alias instead. However, this is somewhat thwarted by the fact that Ripgrep is too aggressive in validating that you never repeat yourself. This also has other consequences.</p>
<p>E.g., if you prefer smart case matching, you can make an alias like this:</p>
<pre><code>alias rg=&#x27;rg -S&#x27;
</code></pre>
<p>This <em>mostly</em> works, but it means that I now get an error if I ever execute any commands that include <code>-S</code> in them. Ripgrep give the error below:</p>
<pre><code>error: The argument &#x27;--smart-case&#x27; was provided more than once, but cannot be used multiple times
</code></pre>
<p>This is undesirable behavior both when writing scripts and when trying to use aliases as defaults. Both scripts and aliases face the same problem: building up a complex command line by nesting contexts. This rule means that this process needs to be globally aware of all the outer contexts.</p>
<p>I think it is much more common and more user friendly that commands like this use the last one specified for flags that are mutually exclusive, and don&#x27;t raise errors if you specify the same flag twice. Otherwise, trying to build nontrivial command lines from variables or aliases is somewhat a nightmare.</p>
<p>Fortunately, it at least allows <code>rg -S -i</code>. I think this is a good example of why raising an error for <code>rg -S -S</code> is undesired behavior. The <code>rg -S -i</code> case is <em>more</em> overspecified than the <code>rg -S -S</code> case. Ultimately, the current rule doesn&#x27;t actually protect you from any undesired behavior, but it does prevent useful use cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-07-13 01:34</div>
            <div class="timeline-body"><p>Right, agreed. My feeling is that this should get lumped into #196 (where I also left a <a href="https://github.com/BurntSushi/ripgrep/issues/196#issuecomment-314943495">comment explaining some things just now</a>), although I can appreciate that these are really two orthogonal issues. It just so happens that persistent config is blocked on it. But we can make your situation better without needing to finish persistent config, and this issue is thorny enough that I think giving it its own ticket is a good idea.</p>
<p>As a possible work-around until this is fixed properly, if you prefix your command with <code>\</code> (e.g., <code>\rg -S pattern</code>), then your shell should ignore any aliases you have set up and invoke the command directly.</p>
<blockquote>
<p>This is undesirable behavior both when writing scripts and when trying to use aliases as defaults. Both scripts and aliases face the same problem: building up a complex command line by nesting contexts. This rule means that this process needs to be globally aware of all the outer contexts.</p>
</blockquote>
<p>I think you might find that you have this problem regardless, although I can agree that the particular version of the problem you have might be the most annoying version of it. In particular, if you write a script that assumes your default config, then it might fail when the default config isn&#x27;t present (on a different machine) or if it changes over times as your preferences evolve. My &quot;answer&quot; to that is to avoid using custom defaults inside scripts.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-07-13 01:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-07-13 01:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sarahgerweck">@sarahgerweck</a> on 2017-07-13 01:38</div>
            <div class="timeline-body"><p>Yeah, I agree that custom settings can create problems with scripts &amp; shared commands in general. The point I was making was that if I wanted to send a coworker a command I use, I could just add the <code>-S</code> that is part of my alias‚Äîbut then I&#x27;ll get complaints if I run it. You&#x27;re right that I could work around this by temporarily unaliasing it or escaping it: it&#x27;s just a matter of convenience.</p>
<p>Neither this nor #196 is an earth-shattering issue. Ripgrep is a great tool and a nice performance and <code>.gitignore</code>-compliance improvement over Silver Searcher: this is just a quality-of-life issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/okdana">@okdana</a> on 2017-07-13 02:22</div>
            <div class="timeline-body"><p>btw, i believe <a href="https://github.com/kbknapp/clap-rs/issues/976">clap #976</a> is the specific ticket that covers this limitation it has. I don&#x27;t think i like the suggested solution (it should be the default behaviour, you shouldn&#x27;t have to write a bunch of code for every single option) but that&#x27;s where the immediate fix would come from i think.</p>
<p>tbh, these sorts of problems are common to almost every library that tries to provide a more &#x27;modern&#x27; approach to argument-handling than <code>getopt(3)</code>/<code>getopt_long(3)</code>. Python&#x27;s <code>argparse</code> (and <code>optparse</code> before it), Swift&#x27;s Commander, PHP&#x27;s Symfony Console and Zend Console, &amp;c. ‚Äî¬†they all have really frustrating limitations when it comes to dealing with options that appear multiple times or whose position in the argument list is supposed to be meaningful.</p>
<p><code>clap</code> is actually really functionally advanced compared to all of those, but you still run up against some fundamental issues that would be very simple to deal with if the library would just give you back the list of arguments so you could handle them yourself with a <code>for</code> loop.</p>
<p>Given all of what <code>clap</code> already does, though, this <em>particular</em> issue doesn&#x27;t seem like it&#x27;d be too difficult to solve. Probably just a matter of time and priorities.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-02-04 15:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2018-02-05 03:53</div>
            <div class="timeline-body"><p>kbknapp/clap-rs#976 has finally been fixed, implemented and released (v2.29.3). I know there is a work around for this, but just FYI.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-02-05 12:28</div>
            <div class="timeline-body"><p>@kbknapp Awesome! Thanks so much! I will switch over to that and get rid of my work-around. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-02-06 00:21</div>
            <div class="timeline-body"><p>@kbknapp Hmm it looks like I can&#x27;t just use <code>AllArgsOverrideSelf</code> because it causes flags that are supposed to be able to be specified multiple times to not work correctly. For example, if I enabled <code>AppSettings::AllArgsOverrideSelf</code>, and if I run</p>
<pre><code>$ rg &#x27;fn run&#x27; src/ --colors &#x27;match:fg:blue&#x27; --colors &#x27;path:fg:blue&#x27;
</code></pre>
<p>then only <code>--colors &#x27;path:fg:blue&#x27;</code> will be applied and <code>--colors &#x27;match:fg:blue&#x27;</code> will be ignored.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2018-02-06 00:27</div>
            <div class="timeline-body"><p>ü§¶‚Äç‚ôÇÔ∏è I fixed that for the switch case and forgot to fix it for the option case....standby</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2018-02-06 00:51</div>
            <div class="timeline-body"><p>Fixed in kbknapp/clap-rs#1166</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:04 UTC
    </footer>
</body>
</html>
