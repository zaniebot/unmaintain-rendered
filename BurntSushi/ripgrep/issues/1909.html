<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`ignore`: gitignore relative paths are not treated relatively - BurntSushi/ripgrep #1909</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>ignore</code>: gitignore relative paths are not treated relatively</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/1909">#1909</a>
        opened by <a href="https://github.com/SergioBenitez">@SergioBenitez</a>
        on 2021-06-23 19:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/SergioBenitez">@SergioBenitez</a></div>
            <div class="timeline-body"><p>In short, gitignore rules that should be relative to a specific gitgnore path are instead reinterpreted as <code>**/rule</code>. Here&#x27;s the failing test case:</p>
<pre><code>use std::path::PathBuf;
use ignore::gitignore::GitignoreBuilder;

fn main() {
    let mut builder = GitignoreBuilder::new(&quot;/root&quot;);
    builder.add_line(Some(PathBuf::from(&quot;/root/scratch/.gitignore&quot;)), &quot;!foo.html&quot;).unwrap();
    let matcher = dbg!(builder.build().unwrap());

    assert!(matcher.matched(&quot;/root/scratch/foo.html&quot;, false).is_whitelist());
    assert!(dbg!(matcher.matched(&quot;/root/unknown/foo.html&quot;, false)).is_none());
}
</code></pre>
<p>The relevant output:</p>
<pre><code>[src/main.rs:7] builder.build().unwrap() = Gitignore {
    root: &quot;/root&quot;,
    globs: [
        Glob {
            from: Some(
                &quot;/root/scratch/.gitignore&quot;,
            ),
            original: &quot;!foo.html&quot;,
            actual: &quot;**/foo.html&quot;,
            is_whitelist: true,
            is_only_dir: false,
        },
    ],
    num_ignores: 0,
    num_whitelists: 1,
}
[src/main.rs:10] matcher.matched(&quot;/root/unknown/foo.html&quot;, false) = Whitelist(
    Glob {
        from: Some(
            &quot;/root/scratch/.gitignore&quot;,
        ),
        original: &quot;!foo.html&quot;,
        actual: &quot;**/foo.html&quot;,
        is_whitelist: true,
        is_only_dir: false,
    },
)
thread &#x27;main&#x27; panicked at &#x27;assertion failed: dbg!(matcher.matched(\&quot;/root/unknown/foo.html\&quot;, false)).is_none()&#x27;, src/main.rs:10:5
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-06-23 22:34</div>
            <div class="timeline-body"><p>I believe these are the relevant gitignore docs:</p>
<blockquote>
<p>If there is a separator at the beginning or middle (or both) of the pattern, then the pattern is relative to the directory level of the particular .gitignore file itself. Otherwise the pattern may also match at any level below the .gitignore level.</p>
</blockquote>
<p>In particular, the &quot;Otherwise ...&quot; language applies here since there is no <code>/</code> in your pattern. The issue here is that it should <em>only</em> apply to any level <em>below</em> that <code>.gitignore</code> file, but here, it is also being applied (incorrectly) to a sibling directory. However, the pattern <code>foo.html</code> absolutely should match at any directory beneath the point in which it was defined. So the <code>**/foo.html</code> construction is correct... to a point.</p>
<p>This is very likely an API-level bug. In particular, when building the crate, I likely assumed that a gitignore matcher would only be used on paths at or below the directory in which it was created. And generally speaking, that&#x27;s how the <code>ignore</code> file traversal works. Fixing the gitignore matcher to handle this case correctly will likely incur an unavoidable additional cost (I think) to file traversal, and thus, some new API mechanism needs to exist.</p>
<p>I don&#x27;t see this bug getting fixed any time soon unfortunately. The <code>ignore</code> crate desperately needs a very very careful rewrite. (And has needed it for a long time.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/SergioBenitez">@SergioBenitez</a> on 2021-06-24 04:08</div>
            <div class="timeline-body"><blockquote>
<p>I believe these are the relevant gitignore docs:</p>
<blockquote>
<p>If there is a separator at the beginning or middle (or both) of the pattern, then the pattern is relative to the directory level of the particular .gitignore file itself. Otherwise the pattern may also match at any level below the .gitignore level.</p>
</blockquote>
<p>In particular, the &quot;Otherwise ...&quot; language applies here since there is no <code>/</code> in your pattern. The issue here is that it should <em>only</em> apply to any level <em>below</em> that <code>.gitignore</code> file, but here, it is also being applied (incorrectly) to a sibling directory. However, the pattern <code>foo.html</code> absolutely should match at any directory beneath the point in which it was defined. So the <code>**/foo.html</code> construction is correct... to a point.</p>
</blockquote>
<p>I suppose it could depend on what <code>**/foo.html</code> means to <code>ignore</code>. Unfortunately it doesn&#x27;t appear to mean anything with correct semantics as the following <em>also</em> doesn&#x27;t work:</p>
<pre><code>use std::path::PathBuf;
use ignore::gitignore::GitignoreBuilder;

fn main() {
    let mut builder = GitignoreBuilder::new(&quot;/root/scratch&quot;);
    builder.add_line(Some(PathBuf::from(&quot;/root/scratch/.gitignore&quot;)), &quot;!/**/*.html&quot;).unwrap();
    // builder.add_line(None, &quot;!/**/*.html&quot;).unwrap(); // Using `None` doesn&#x27;t help, unfortunately.

    let matcher = dbg!(builder.build().unwrap());

    assert!(matcher.matched(&quot;/root/scratch/foo.html&quot;, false).is_whitelist());
    assert!(dbg!(matcher.matched(&quot;/root/unknown/foo.html&quot;, false)).is_none());
}
</code></pre>
<p>Here, we see:</p>
<pre><code>[src/main.rs:7] builder.build().unwrap() = Gitignore {
    set: GlobSet {
    root: &quot;/root/scratch&quot;,
    globs: [
        Glob {
            from: Some(
                &quot;/root/scratch/.gitignore&quot;,
            ),
            original: &quot;!/**/*.html&quot;,
            actual: &quot;**/*.html&quot;,
            is_whitelist: true,
            is_only_dir: false,
        },
    ],
}
[src/main.rs:10] matcher.matched(&quot;/root/unknown/foo.html&quot;, false) = Whitelist(
    Glob {
        from: Some(
            &quot;/root/scratch/.gitignore&quot;,
        ),
        original: &quot;!/**/*.html&quot;,
        actual: &quot;**/*.html&quot;,
        is_whitelist: true,
        is_only_dir: false,
    },
)
thread &#x27;main&#x27; panicked at &#x27;assertion failed: dbg!(matcher.matched(\&quot;/root/unknown/foo.html\&quot;, false)).is_none()&#x27;, src/main.rs:10:5
</code></pre>
<blockquote>
<p>I don&#x27;t see this bug getting fixed any time soon unfortunately. The <code>ignore</code> crate desperately needs a very very careful rewrite. (And has needed it for a long time.)</p>
</blockquote>
<p>I understand. I&#x27;m working on a replacement for the core gitignore pattern matching part of <code>ignore</code> using <code>GlobSet</code> directly. Once it&#x27;s complete, I imagine it wouldn&#x27;t be too difficult to swap in this new library in <code>ignore</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-06-24 11:52</div>
            <div class="timeline-body"><p>@SergioBenitez Yeah, that looks like the same variant of the bug that is &quot;the gitignore matcher has an undocumented and in some cases inconvenient assumption that you only use it with paths at or below the directory in which the gitignore rules were defined.&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LeGEC">@LeGEC</a> on 2021-10-22 06:44</div>
            <div class="timeline-body"><p>@BurntSushi : is there some way to group the issues related to the <code>ignore</code> crate ? or perhaps an issue, which describes the various points that need to be clarified ?</p>
<p>I am aware of #278 for example, but searching the issue tracker for <code>&quot;ignore&quot;</code> brings along a whole lot of unrelated issues.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-10-22 12:19</div>
            <div class="timeline-body"><p>@LeGEC No, such a grouping doesn&#x27;t exist. You&#x27;re right that it should, but it will take work and effort to do.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/iesahin">@iesahin</a> on 2022-04-29 12:42</div>
            <div class="timeline-body"><p>I hit to this bug when I was developing something with the ignore crate.</p>
<p><code>mydir/.gitignore</code> has the entry <code>mydir/myfile.txt</code>. <code>matches</code> returns <code>Match::Ignore</code> on <code>mydir/myfile.txt</code>,  I believe the correct ignore should be <code>mydir/mydir/myfile.txt</code>, and <code>mydir/myfile.txt</code> should return a <code>None</code>.</p>
<p>I can submit a PR to add directory to the pattern. Currently lines in <code>mydir/.gitignore</code> are interpreted as if they are in <code>./.gitignore</code>, and if a <code>/</code> is in the pattern, <code>mydir/myfile.txt</code> becomes <code>**/mydir/myfile.txt</code> which matches all parent dirs. Instead, it should add <code>mydir/mydir/myfile.txt</code> when <code>ignore::add_file(&quot;mydir/.gitignore&quot;)</code> is used in <code>GitignoreBuilder</code>.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:11 UTC
    </footer>
</body>
</html>
