<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MS Windows 32bit binary does not work properly for files bigger than 4 gigabyte - BurntSushi/ripgrep #1911</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>MS Windows 32bit binary does not work properly for files bigger than 4 gigabyte</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/1911">#1911</a>
        opened by <a href="https://github.com/datatraveller1">@datatraveller1</a>
        on 2021-06-26 08:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/datatraveller1">@datatraveller1</a></div>
            <div class="timeline-body">What version of ripgrep are you using?
<p>ripgrep 13.0.0 (rev af6b6c543b)
-SIMD -AVX (compiled)</p>
How did you install ripgrep?
<p>I use the MS Windows binary rg.exe from ripgrep-13.0.0-i686-pc-windows-msvc.zip</p>
What operating system are you using ripgrep on?
<p>MS Windows 10 32bit</p>
Describe your bug.
<p>For files bigger than 4 gigabyte result lines are missing.
Only result lines from the upper part of the file or no lines are printed.</p>
What are the steps to reproduce the behavior?
<p>Search e.g. in a 5 gigabyte file for content of the last line.</p>
What is the actual behavior?
<p>rg &quot;string_in_last_line_of_big_file&quot; bigfile.txt</p>
<pre><code>no output
</code></pre>
What is the expected behavior?
<p>The last line of bigfile.txt containing &quot;string_in_last_line_of_big_file&quot; should be printed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-06-26 09:35</div>
            <div class="timeline-body"><p>Does <code>--no-mmap</code> resolve this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/datatraveller1">@datatraveller1</a> on 2021-06-26 14:09</div>
            <div class="timeline-body"><p>Yes, <code>rg --no-mmap &quot;string_in_last_line_of_big_file&quot; bigfile.txt</code> solves the issue with the 32bit version!
The missing result lines are printed with the <strong>--no-mmap</strong> option.</p>
<p>However, the previous 32bit version ripgrep-12.1.1-i686-pc-windows-msvc.zip works correctly <em>without</em> the --no-map option.
Some interesting hints about this observation:
<strong>ripgrep 12.1.1 (rev 7cb211378a)</strong>
<code>rg &quot;string_in_last_line_of_big_file&quot; bigfile.txt --debug</code>
=&gt;
DEBUG|grep_regex::literal|crates\regex\src\literal.rs:58: literal prefixes detected: Literals { lits: [Complete(string_in_last_line_of_big_file)], limit_size: 250, limit_class: 10 }
DEBUG|globset|crates\globset\src\lib.rs:431: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
<strong>DEBUG|grep_searcher::searcher::mmap|crates\searcher\src\searcher\mmap.rs:86: bigfile.txt: failed to open memory map: memory map length overflows usize</strong></p>
<p><strong>ripgrep 13.0.0 (rev af6b6c543b)</strong>
<code>rg &quot;string_in_last_line_of_big_file&quot; bigfile.txt --debug</code>
=&gt;
DEBUG|grep_regex::literal|crates\regex\src\literal.rs:58: literal prefixes detected: Literals { lits: [Complete(string_in_last_line_of_big_file)], limit_size: 250, limit_class: 10 }
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: gzip: could not find executable in PATH
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: gzip: could not find executable in PATH
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: bzip2: could not find executable in PATH
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: bzip2: could not find executable in PATH
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: xz: could not find executable in PATH
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: xz: could not find executable in PATH
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: lz4: could not find executable in PATH
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: xz: could not find executable in PATH
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: brotli: could not find executable in PATH
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: zstd: could not find executable in PATH
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: zstd: could not find executable in PATH
DEBUG|grep_cli::decompress|crates\cli\src\decompress.rs:482: uncompress: could not find executable in PATH</p>
<p>I somehow assume <code>--no-mmap</code> should be the default for the 32bit version to avoid wrong results.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-06-26 16:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-06-26 16:56</div>
            <div class="timeline-body"><p>Yup. The next release will have mmap disabled in all non-64-bit systems.</p>
<p>I don&#x27;t know why this used to work. The only semi-related change in ripgrep 13 that I can think of is that it is now statically linking vcruntime: <a href="https://github.com/BurntSushi/ripgrep/pull/1613">BurntSushi/ripgrep#1613</a></p>
<p>I&#x27;m not sure why or how that would change things here, but it&#x27;s simple enough to just disable mmap on 32-bit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/datatraveller1">@datatraveller1</a> on 2021-06-27 10:58</div>
            <div class="timeline-body"><p>Thank you very much! I&#x27;ll add a few more comments just to ensure there are no misunderstandings with the fix:
I plan to use the MS Windows 32bit binary release both for my PC (32bit) and my laptop (64bit) like it used to work with version 12.1.1.
Like on Windows 32bit, the current 13.0.0 32bit binary release does not work correctly on Windows 64bit unless the --no-mmap option is used. Only the current 13.0.0 64bit binary release works correctly on Windows 64bit for big files.
So, the patch (disable mmap) should impact the target rust 32bit binary release and not the Windows version currently used by the user (32bit or 64bit). I&#x27;m not a Rust programmer but it seems to me the fix takes care of that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-06-27 11:11</div>
            <div class="timeline-body"><p>Thank you for copying your comment from email. :-) I&#x27;ll copy my response as well:</p>
<p>The patch I pushed should impact the target used to build the binary.
A <code>cfg!</code> is conditional compilation.</p>
<p>I don&#x27;t use Windows, so it&#x27;s a bit annoying to test this patch myself. I have a Windows laptop somewhere in my house,
but it&#x27;s always a big production to pull it out because Windows
insists on spending hours running Windows Update.</p>
<p>If anyone has an easy way to build ripgrep&#x27;s master branch for 32-bit Windows and test it on a &gt;4GB file with a match at the end, that would be most appreciated!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ghost">@ghost</a> on 2021-09-22 07:20</div>
            <div class="timeline-body"><p>I think the underlying reason is https://github.com/RazrFalcon/memmap2-rs/commit/5e271224c8411c89b42060294f9393cfc7b12a2a introduced into <code>memmap2</code> version 0.3.0 used here as of https://github.com/BurntSushi/ripgrep/blob/9b01a8f9ae53ebcd05c27ec21843758c2c1e823f/Cargo.lock#L343 and fixed by https://github.com/RazrFalcon/memmap2-rs/commit/9aa838aed99a4879d8357ff295a0ca1c98ba1ae5 which is part of version 0.3.1 (but version 0.5.0 is current).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ghost">@ghost</a> on 2021-09-22 07:22</div>
            <div class="timeline-body"><blockquote>
<p>If anyone has an easy way to build ripgrep&#x27;s master branch for 32-bit Windows and test it on a &gt;4GB file with a match at the end, that would be most appreciated!</p>
</blockquote>
<p>I am not sure if that would have sufficed to catch this, but when working on the <code>memmap2</code> code, I have repeatedly resorted to cross building using MinGW and then testing the result under Wine. I am wary of the testing power of the <code>memmap2</code> to Win32 to POSIX API conversion though...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/adamreichold">@adamreichold</a> on 2021-09-23 07:56</div>
            <div class="timeline-body"><blockquote>
<p>I am not sure if that would have sufficed to catch this, but when working on the memmap2 code, I have repeatedly resorted to cross building using MinGW and then testing the result under Wine. I am wary of the testing power of the memmap2 to Win32 to POSIX API conversion though...</p>
</blockquote>
<p>I seems it would suffice, but there is a small wrinkle to this for cross building for 32-bit Windows: Due to LLVM/Rust assuming SEH-style unwinding but most Linux distributions 32-bit MinGW toolchains using SjLj-style unwinding, one will run into linker errors related to <code>_Unwind_Resume</code>, c.f. <a href="https://github.com/rust-lang/rust/issues/12859">rust-lang/rust#12859</a> Some distributions like Fedora since version 32 however ship cross toolchains using SEH-style unwinding and using such a distribution seems to work as expected, c.f. #2000</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:11 UTC
    </footer>
</body>
</html>
