<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>First entry of gitignore searched if it starts with BOM - BurntSushi/ripgrep #2177</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>First entry of gitignore searched if it starts with BOM</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/2177">#2177</a>
        opened by <a href="https://github.com/tvrg">@tvrg</a>
        on 2022-04-11 12:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tvrg">@tvrg</a></div>
            <div class="timeline-body">What version of ripgrep are you using?
<p>ripgrep 13.0.0
-SIMD -AVX (compiled)
+SIMD +AVX (runtime)</p>
How did you install ripgrep?
<p>pacman -S ripgrep</p>
What operating system are you using ripgrep on?
<p>Arch Linux</p>
Describe your bug.
<p>When a .gitignore starts with a BOM, ripgrep does not ignore the first entry of the .gitignore. git itself ignores the first entry.</p>
What are the steps to reproduce the behavior?
<pre><code>$ echo &quot;\xef\xbb\xbftest\nignoreme&quot; &gt; .gitignore &amp;&amp; echo &quot;test&quot; &gt; ignoreme
$ rg test
</code></pre>
What is the actual behavior?
<pre><code>$ rg --debug test
DEBUG|grep_regex::literal|crates/regex/src/literal.rs:58: literal prefixes detected: Literals { lits: [Complete(test)], limit_size: 250, limit_class: 10 }
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:416: glob converted to regex: Glob { glob: &quot;**/npm-debug.log*&quot;, re: &quot;(?-u)^(?:/?|.*/)npm\\-debug\\.log[^/]*$&quot;, opts: GlobOptions { case_insensitive: false, literal_separator: true, backslash_escape: true }, tokens: Tokens([RecursivePrefix, Literal(&#x27;n&#x27;), Literal(&#x27;p&#x27;), Literal(&#x27;m&#x27;), Literal(&#x27;-&#x27;), Literal(&#x27;d&#x27;), Literal(&#x27;e&#x27;), Literal(&#x27;b&#x27;), Literal(&#x27;u&#x27;), Literal(&#x27;g&#x27;), Literal(&#x27;.&#x27;), Literal(&#x27;l&#x27;), Literal(&#x27;o&#x27;), Literal(&#x27;g&#x27;), ZeroOrMore]) }
DEBUG|globset|crates/globset/src/lib.rs:416: glob converted to regex: Glob { glob: &quot;**/yarn-debug.log*&quot;, re: &quot;(?-u)^(?:/?|.*/)yarn\\-debug\\.log[^/]*$&quot;, opts: GlobOptions { case_insensitive: false, literal_separator: true, backslash_escape: true }, tokens: Tokens([RecursivePrefix, Literal(&#x27;y&#x27;), Literal(&#x27;a&#x27;), Literal(&#x27;r&#x27;), Literal(&#x27;n&#x27;), Literal(&#x27;-&#x27;), Literal(&#x27;d&#x27;), Literal(&#x27;e&#x27;), Literal(&#x27;b&#x27;), Literal(&#x27;u&#x27;), Literal(&#x27;g&#x27;), Literal(&#x27;.&#x27;), Literal(&#x27;l&#x27;), Literal(&#x27;o&#x27;), Literal(&#x27;g&#x27;), ZeroOrMore]) }
DEBUG|globset|crates/globset/src/lib.rs:416: glob converted to regex: Glob { glob: &quot;**/yarn-error.log*&quot;, re: &quot;(?-u)^(?:/?|.*/)yarn\\-error\\.log[^/]*$&quot;, opts: GlobOptions { case_insensitive: false, literal_separator: true, backslash_escape: true }, tokens: Tokens([RecursivePrefix, Literal(&#x27;y&#x27;), Literal(&#x27;a&#x27;), Literal(&#x27;r&#x27;), Literal(&#x27;n&#x27;), Literal(&#x27;-&#x27;), Literal(&#x27;e&#x27;), Literal(&#x27;r&#x27;), Literal(&#x27;r&#x27;), Literal(&#x27;o&#x27;), Literal(&#x27;r&#x27;), Literal(&#x27;.&#x27;), Literal(&#x27;l&#x27;), Literal(&#x27;o&#x27;), Literal(&#x27;g&#x27;), ZeroOrMore]) }
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 1 literals, 6 basenames, 3 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 3 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 1 basenames, 0 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|ignore::walk|crates/ignore/src/walk.rs:1741: ignoring ./.git: Ignore(IgnoreMatch(Hidden))
DEBUG|ignore::walk|crates/ignore/src/walk.rs:1741: ignoring ./.gitignore: Ignore(IgnoreMatch(Hidden))
ignoreme
1:test
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
DEBUG|globset|crates/globset/src/lib.rs:421: built glob set; 0 literals, 0 basenames, 12 extensions, 0 prefixes, 0 suffixes, 0 required extensions, 0 regexes
</code></pre>
What is the expected behavior?
<p>It should ignore <code>ignoreme</code> because git does so as well. See e.g. <code>git status</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2022-04-11 12:15</div>
            <div class="timeline-body"><p>I believe the description of your bug report is correct, but your reproduction isn&#x27;t. <code>rg</code> isn&#x27;t ignoring <code>ignoreme</code> in your particular example because of the BOM, it&#x27;s not ignoring it because it doesn&#x27;t respect <code>.gitignore</code> outside of a git repository. You either need to run <code>git init</code> or <code>mv .gitignore .ignore</code>. Here&#x27;s my repro:</p>
<pre><code>$ echo &quot;\xef\xbb\xbfignoreme1\nignoreme2&quot; &gt; .ignore &amp;&amp; echo &quot;test&quot; &gt; ignoreme1 &amp;&amp; echo &quot;test&quot; &gt; ignoreme2
$ rg test
ignoreme1
1:test
</code></pre>
<p>But <code>rg test</code> should return no results. Instead, it only ignores <code>ignoreme2</code> and not <code>ignoreme1</code>. If I drop the BOM from the <code>.ignore</code> file, then ripgrep correctly ignores both <code>.ignoreme1</code> and <code>.ignoreme2</code>.</p>
<p>I suspect the fix will be to tweak this code to handle the BOM:</p>
<p>https://github.com/BurntSushi/ripgrep/blob/ced5b92aa93eb47e892bd2fd26ab454008721730/crates/ignore/src/gitignore.rs#L386-L408</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2022-04-11 12:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tvrg">@tvrg</a> on 2022-04-11 12:33</div>
            <div class="timeline-body"><p>Oh, yes, sorry for the incomplete reproduction. I was actually running the commands in an initialized git repo.</p>
<p>I&#x27;ll try to fix this in the next days with the help of your pointer above if nobody else is faster.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/starthal">@starthal</a> on 2024-04-17 19:58</div>
            <div class="timeline-body"><p>Here is what Git does: https://github.com/git/git/blob/21306a098c3f174ad4c2a5cddb9069ee27a548b0/utf8.c#L794-L803</p>
<pre><code>const char utf8_bom[] = &quot;\357\273\277&quot;;

int skip_utf8_bom(char **text, size_t len)
{
	if (len &lt; strlen(utf8_bom) ||
	    memcmp(*text, utf8_bom, strlen(utf8_bom)))
		return 0;
	*text += strlen(utf8_bom);
	return 1;
}
</code></pre>
<p>If <code>ignore</code> intends to match its behavior then it should just skip this sequence in the first line.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rollup</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-11 20:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-09-20 01:08</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:12 UTC
    </footer>
</body>
</html>
