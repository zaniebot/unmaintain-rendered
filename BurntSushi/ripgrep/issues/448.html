<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>the integration test suite depends too much on the contents of the file system - BurntSushi/ripgrep #448</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>the integration test suite depends too much on the contents of the file system</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/448">#448</a>
        opened by <a href="https://github.com/misery">@misery</a>
        on 2017-04-13 16:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/misery">@misery</a></div>
            <div class="timeline-body"><p>Hi there,</p>
<p>I added a ripgrep package to AlpineLinux. It seems it works without a problem. But the unit test &quot;regression_25&quot; fails.</p>
<pre><code>failures:

---- regression_25 stdout ----
        thread &#x27;regression_25&#x27; panicked at &#x27;

==========
command failed but expected success!

command: &quot;/home/andre/aports/testing/ripgrep/src/ripgrep-0.5.1/target/debug/deps/../rg&quot; &quot;test&quot; &quot;.&quot;
cwd: /home/andre/aports/testing/ripgrep/src/ripgrep-0.5.1/target/debug/deps/ripgrep-tests/regression_25/90

status: exit code: 1

stdout: 

stderr: No files were searched, which means ripgrep probably applied a filter you didn&#x27;t expect. Try running again with --debug.


==========
&#x27;, tests/workdir.rs:227
stack backtrace:
   1:     0x563e982dbfcc - std::sys::imp::backtrace::tracing::imp::write::hcc40e709c47b6024
                        at /home/buildozer/aports/testing/rust/src/rustc-1.16.0-src/src/libstd/sys/unix/backtrace/tracing/gcc_s.rs:42
   2:     0x563e982e0e7e - std::panicking::default_hook::{{closure}}::ha5b032273abc9158
                        at /home/buildozer/aports/testing/rust/src/rustc-1.16.0-src/src/libstd/panicking.rs:351
   3:     0x563e982e0a13 - std::panicking::default_hook::h4aae1b7cae7d5632
                        at /home/buildozer/aports/testing/rust/src/rustc-1.16.0-src/src/libstd/panicking.rs:361
   4:     0x563e982e131b - std::panicking::rust_panic_with_hook::ha732da68a0d51d4b
                        at /home/buildozer/aports/testing/rust/src/rustc-1.16.0-src/src/libstd/panicking.rs:555
   5:     0x563e982e1164 - std::panicking::begin_panic::h0d7e1ef9bd5b6e18
                        at /home/buildozer/aports/testing/rust/src/rustc-1.16.0-src/src/libstd/panicking.rs:517
   6:     0x563e982e10d9 - std::panicking::begin_panic_fmt::h5592b8b8b8c0df74
                        at /home/buildozer/aports/testing/rust/src/rustc-1.16.0-src/src/libstd/panicking.rs:501
   7:     0x563e9827245a - integration::workdir::WorkDir::expect_success::he46ad897a51e9727
                        at /home/andre/aports/testing/ripgrep/src/ripgrep-0.5.1/tests/workdir.rs:227
   8:     0x563e982718f3 - integration::workdir::WorkDir::output::h1a775c52f50fcd3b
                        at /home/andre/aports/testing/ripgrep/src/ripgrep-0.5.1/tests/workdir.rs:185
   9:     0x563e9827148f - integration::workdir::WorkDir::stdout::hf2dcb74907becd28
                        at /home/andre/aports/testing/ripgrep/src/ripgrep-0.5.1/tests/workdir.rs:172
  10:     0x563e98288393 - integration::regression_25::{{closure}}::hdb2dfaeb1dc01182
                        at /home/andre/aports/testing/ripgrep/src/ripgrep-0.5.1/tests/tests.rs:720
  11:     0x563e982881a7 - integration::regression_25::h041438bf4d696525
                        at /home/andre/aports/testing/ripgrep/src/ripgrep-0.5.1/tests/tests.rs:720
  12:     0x563e982aadde - &lt;F as test::FnBox&lt;T&gt;&gt;::call_box::hf309100b6cb837e1
                        at /home/buildozer/aports/testing/rust/src/rustc-1.16.0-src/src/libtest/lib.rs:1366
                        at /home/buildozer/aports/testing/rust/src/rustc-1.16.0-src/src/libtest/lib.rs:140
  13:     0x563e982e7e7a - __rust_maybe_catch_panic
                        at /home/buildozer/aports/testing/rust/src/rustc-1.16.0-src/src/libpanic_unwind/lib.rs:98
  14:     0x563e9829f0aa - std::panicking::try::do_call::h9d29f4b654939df3
                        at /home/buildozer/aports/testing/rust/src/rustc-1.16.0-src/src/libstd/panicking.rs:436
                        at /home/buildozer/aports/testing/rust/src/rustc-1.16.0-src/src/libstd/panic.rs:361
                        at /home/buildozer/aports/testing/rust/src/rustc-1.16.0-src/src/libtest/lib.rs:1311
                        at /home/buildozer/aports/testing/rust/src/rustc-1.16.0-src/src/libstd/panic.rs:296
                        at /home/buildozer/aports/testing/rust/src/rustc-1.16.0-src/src/libstd/panicking.rs:460
  15:     0x563e982e7e7a - __rust_maybe_catch_panic
                        at /home/buildozer/aports/testing/rust/src/rustc-1.16.0-src/src/libpanic_unwind/lib.rs:98
  16:     0x563e982a5d96 - &lt;F as alloc::boxed::FnBox&lt;A&gt;&gt;::call_box::h0b04066a85c3412c
                        at /home/buildozer/aports/testing/rust/src/rustc-1.16.0-src/src/libstd/panicking.rs:436
                        at /home/buildozer/aports/testing/rust/src/rustc-1.16.0-src/src/libstd/panic.rs:361
                        at /home/buildozer/aports/testing/rust/src/rustc-1.16.0-src/src/libstd/thread/mod.rs:357
                        at /home/buildozer/aports/testing/rust/src/rustc-1.16.0-src/src/liballoc/boxed.rs:614
  17:     0x563e982e0454 - std::sys::imp::thread::Thread::new::thread_start::he98d7185c4a314b9
                        at /home/buildozer/aports/testing/rust/src/rustc-1.16.0-src/src/liballoc/boxed.rs:624
                        at /home/buildozer/aports/testing/rust/src/rustc-1.16.0-src/src/libstd/sys_common/thread.rs:21
                        at /home/buildozer/aports/testing/rust/src/rustc-1.16.0-src/src/libstd/sys/unix/thread.rs:84


failures:
    regression_25

test result: FAILED. 124 passed; 1 failed; 0 ignored; 0 measured
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-04-13 16:59</div>
            <div class="timeline-body"><p>ripgrep&#x27;s CI includes running tests with MUSL, I don&#x27;t think that&#x27;s an issue.</p>
<p>A problem with the current test suite is that it can be influenced by other <code>.ignore</code> or <code>.gitignore</code> files on your system. I&#x27;d recommend to try running the test suite in <code>/tmp</code> just to see if the error still occurs. If it doesn&#x27;t, then my guess is that there&#x27;s probably a <code>.gitignore</code> or <code>.ignore</code> somewhere along <code>/home/andre/aports/testing/</code> that&#x27;s messing with the tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/misery">@misery</a> on 2017-04-13 17:07</div>
            <div class="timeline-body"><p>Ah, thank you! I tried it in /tmp/ (.gitignore was the problem) and all unit tests passed.
The problem is that Travis-CI will checkout the Alpine portstree (git) and run the build / tests in that tree.</p>
<p>Is there something that I can add to the &quot;test&quot; target to have a &quot;clean test environment&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-04-13 17:28</div>
            <div class="timeline-body"><p>I don&#x27;t really have any work arounds for you. If they existed, I&#x27;d use them myself. I haven&#x27;t given much thought to the matter because it hasn&#x27;t really been an issue. Basically, the integration tests operate on the file system, and if the file system contains something already that will impact the tests, then there&#x27;s really no way to prevent that without some other means of isolation. e.g., a chroot or running the tests in a different directory.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/misery">@misery</a> on 2017-04-13 22:10</div>
            <div class="timeline-body"><p>Ok, I found a &quot;dirty&quot; work-around for the conflict.</p>
<pre><code>diff --git a/tests/tests.rs b/tests/tests.rs
index 578dbcb..d456fab 100644
--- a/tests/tests.rs
+++ b/tests/tests.rs
@@ -721,6 +721,7 @@ clean!(regression_25, &quot;test&quot;, &quot;.&quot;, |wd: WorkDir, mut cmd: Command| {
     wd.create(&quot;.gitignore&quot;, &quot;/llvm/&quot;);
     wd.create_dir(&quot;src/llvm&quot;);
     wd.create(&quot;src/llvm/foo&quot;, &quot;test&quot;);
+    wd.create(&quot;../.gitignore&quot;, &quot;!*&quot;);
 
     let lines: String = wd.stdout(&amp;mut cmd);
     let expected = path(&quot;src/llvm/foo:test\n&quot;);
</code></pre>
<p>By the way... thank you very much for ripgrep!!!! :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-04-13 22:40</div>
            <div class="timeline-body"><p>@misery LOL. That&#x27;s awesome. Nice hack. I probably can&#x27;t put that in the test suite proper, but thank you for filing this issue. This is a bug I&#x27;d like to fix more generally, but it needs more thought.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;test: regression_25 failed on Alpine (musl)&quot; to &quot;the integration test suite depends too much on the contents of the file system&quot; by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-04-13 22:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-04-13 22:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-04-13 22:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-07-29 14:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:04 UTC
    </footer>
</body>
</html>
