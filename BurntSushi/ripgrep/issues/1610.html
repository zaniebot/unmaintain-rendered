<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add preprocessor log to debug output - BurntSushi/ripgrep #1610</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add preprocessor log to debug output</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/BurntSushi/ripgrep/issues/1610">#1610</a>
        opened by <a href="https://github.com/phiresky">@phiresky</a>
        on 2020-06-09 09:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/phiresky">@phiresky</a></div>
            <div class="timeline-body"><p>When <code>rg --debug --pre ...</code> is used, it would be useful if the following information would be output:</p>
<ol>
<li>Which preprocessor command is run</li>
<li>What the preprocessor command stderr output was (not just if it fails).</li>
</ol>
<p>These would be very helpful to debug preprocessor issues, for example the a preprocessor that chooses between different other preprocessors can output which one it chose to stderr.</p>
<p>Here is a patch that implements this:</p>
<pre><code class="language-diff">diff --git a/crates/cli/src/process.rs b/crates/cli/src/process.rs
index 4ec5af7..3011abe 100644
--- a/crates/cli/src/process.rs
+++ b/crates/cli/src/process.rs
@@ -216,6 +216,7 @@ impl io::Read for CommandReader {
             if !self.child.wait()?.success() {
                 return Err(io::Error::from(self.stderr.read_to_end()));
             }
+            log::debug!(&quot;preprocesser command stderr: {}&quot;, self.stderr.read_to_end());
         }
         Ok(nread)
     }
diff --git a/crates/core/search.rs b/crates/core/search.rs
index 4da4057..8b1db00 100644
--- a/crates/core/search.rs
+++ b/crates/core/search.rs
@@ -392,6 +392,8 @@ impl&lt;W: WriteColor&gt; SearchWorker&lt;W&gt; {
         let bin = self.config.preprocessor.as_ref().unwrap();
         let mut cmd = Command::new(bin);
         cmd.arg(path).stdin(Stdio::from(File::open(path)?));
+        // log run command including file name
+        log::debug!(&quot;running preprocessor: {:?}&quot;, cmd);
 
         let rdr = self.command_builder.build(&amp;mut cmd).map_err(|err| {
             io::Error::new(

</code></pre>
<p>I can send a PR if needed, I'm not sure if this should be done in a different way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-06-09 11:42</div>
            <div class="timeline-body"><p>This seems OK to me, and a PR would be good, but I think this probably falls under a trace log level (enabled via <code>--trace</code>) rather than <code>--debug</code>. <code>--debug</code> mostly tries to avoid output for each individual file (other than making noise about which files are being ignored), where as <code>--trace</code> can be a bit more noisy on a per-file basis.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @BurntSushi on 2020-06-09 11:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/phiresky">@phiresky</a> on 2020-06-09 12:03</div>
            <div class="timeline-body"><blockquote>
<p>think this probably falls under a trace log level</p>
</blockquote>
<p>Hm.. for me, it's actually the other way around: the preprocessor debug information is more relevant to me than most of the other debug info, and not being able to see it's output without failing it completely makes debugging pretty hard. I think this is kinda true in general: If you use the <code>--pre</code> argument, then your preprocessor is probably the most fragile part of your pipeline, and thus a main reason to enable debug logging. Since preprocessors are also more expensive and probably slower than all else of ripgrep, they probably won't be run for tons of files so they should litter the logs less than other logs that happen per file - and if the preprocessor doesn't output anything to stderr, it will only add a single line per file.</p>
<p>So in general, it would be good if it would be possible to expose an interface similar to <a href="https://docs.rs/env_logger/0.7.1/env_logger/#enabling-logging">env_logger</a> to enable / disable logging for specific crate prefixes. For example <code>--log-config=trace,grep_searcher=debug,globset=info</code>. Let me know if I should open a different issue for that.</p>
<p>Testing it, it seems like --trace isn't used <em>that</em> much in rg as opposed to other programs though, so I guess it would still be like 4/5 of the convenience to add this there instead of --debug as opposed to not having it at all.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:43:11 UTC
    </footer>
</body>
</html>
