<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improve zsh completion function - BurntSushi/ripgrep #536</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Improve zsh completion function</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/BurntSushi/ripgrep/pull/536">#536</a>
        opened by <a href="https://github.com/okdana">@okdana</a>
        on 2017-07-01 23:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/okdana">@okdana</a></div>
            <div class="timeline-body"><p>This change is related to #532, though the actual problem there had already been fixed by the earlier addition of the hand-written completion function. In going over that function i found several issues/limitations which i&#x27;ve corrected:</p>
<ul>
<li><p>Added missing options (most notably <code>-o</code>)</p>
</li>
<li><p>Fixed the confusion between <code>--count</code> and <code>--max-count</code></p>
</li>
<li><p>Improved the consistency of the wording ‚Äî¬†The previous descriptions had mixed usage of capitalisation, punctuation, contractions, &amp;c., some of them were copied from the <code>--help</code> output verbatim, and so on</p>
</li>
<li><p>Added completion for encodings ‚Äî I didn&#x27;t want to include a gigantic list of every single individual encoding, so i compressed them all into a few lines by making use of brace expansion. As i noted in the code, it&#x27;s <em>super</em> hard to read this way, but i doubt that list will be changing any time soon, so i think the brevity is worth it (and you could expand them all by just passing them to <code>printf &#x27;%s\n&#x27;</code>, anyway)</p>
</li>
<li><p>Added completion for colour specs ‚Äî¬†Might need revisiting if/when #452 lands</p>
</li>
<li><p>Added partial completion for type specs ‚Äî I wanted to make it so that it would complete a list of types if you gave it an <code>include:</code> directive, but i ran up against the limits of my knowledge of zsh&#x27;s completion functions trying to figure out how to do that whilst making it clear that you can provide a glob <em>or</em> an <code>include</code> directive</p>
</li>
</ul>
<p>I think the structure of this file is kind of weird, honestly ‚Äî¬†how are future maintainers supposed to intuit which options are &#x27;common&#x27;? And is the break-down here even accurate? Is <code>--encoding</code> <em>really</em> more commonly used than <code>-m</code> or <code>-C</code>? I highly doubt it.</p>
<p>If i had written it i probably would have just put all of the options in alphabetical order. I was afraid it&#x27;d be bad etiquette for me to do that here, though, so i didn&#x27;t.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-07-03 11:15</div>
            <div class="timeline-body"><p>This is awesome work, thank you! If the bash completion were this good, I might actually use it, so color me green with envy. :-)</p>
<blockquote>
<p>If i had written it i probably would have just put all of the options in alphabetical order. I was afraid it&#x27;d be bad etiquette for me to do that here, though, so i didn&#x27;t.</p>
</blockquote>
<p>That would be fine. I&#x27;m not sure about why it&#x27;s split like that either. The <code>man</code> page is split that way, but <code>--encoding</code> is certainly not considered common, as you say. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-07-03 11:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-07-03 11:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lilianmoraru">@lilianmoraru</a> on 2017-07-05 20:37</div>
            <div class="timeline-body"><p>These completion files are generated by <code>clap-rs</code>.
Is it okay to modify these by hand?
I see 2 problems:</p>
<ul>
<li>either next time <code>clap-rs</code> generates the completion file, it overwrites everything</li>
<li>or this completion file is maintained by hand and then it could easily diverge from the flags that are set with <code>clap-rs</code>.</li>
</ul>
<p>If there are problems with the completion, it should probably be reported to <code>clap-rs</code>, the maintainer is very responsive.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lilianmoraru">@lilianmoraru</a> on 2017-07-05 20:40</div>
            <div class="timeline-body"><p>Ow, sorry, it was written by hand already.
Anyway should probably be reported to <code>clap-rs</code> what exactly the library should do better.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/okdana">@okdana</a> on 2017-07-05 21:37</div>
            <div class="timeline-body"><p>There are <a href="https://github.com/kbknapp/clap-rs/issues?utf8=%E2%9C%93&amp;q=is%3Aissue%20is%3Aopen%20zsh%20">several out-standing issues</a> related to zsh completion in the <code>clap</code> repo, many of which are relevant to <code>ripgrep</code>.</p>
<p>The two main issues with the auto-generated function were that it didn&#x27;t complete operands (<code>pattern</code> and <code>path</code>) correctly, and it didn&#x27;t account for options that take arguments (except for <code>--color</code>). I think both of those have been reported.</p>
<p>Another (less critical) issue is that it is currently no-where near advanced enough to generate code for complex option-argument completion like what i&#x27;ve added for <code>--colors</code> and <code>--type-add</code>. It looks like they&#x27;re discussing how they might eventually do that though.</p>
<p>In the mean time, it <em>is</em> bothersome that the completion function can get out-of-synch with the arguments that are actually in the app. Maybe it could be part of the test suite somehow?</p>
<p>I didn&#x27;t actually try this, but i think running a script like this would be an effective way of ensuring that the options in the <code>--help</code> output match the ones in the completion function:</p>
<pre><code>while read -r option; do
    ./target/release/rg -q -- &quot;${option}&quot; ./complete/_rg || {
        echo &quot;Completion function missing option: ${option}&quot; &gt;&amp;2
        exit 1
    }
done &lt; &lt;(
    ./target/release/rg --help |
    ./target/release/rg -io -- &#x27; (-[a-z0-9]|--[a-z0-9-]+)\b&#x27; |
    tr -d &#x27; &#x27; |
    sort -u
)
</code></pre>
<p>Not sure how worried anyone is about it, though, since it&#x27;s not critical functionality. ü§∑‚Äç‚ôÄÔ∏è</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-07-05 23:32</div>
            <div class="timeline-body"><p>I&#x27;m in favor of adding things to CI to help keep this stuff in sync. However, it must not ever have false negatives (or more precisely, any false negatives must be intermittent). False positives are not ideal obviously, but I could live with them (because it&#x27;s no worse than what we have now, which is nothing).</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:16 UTC
    </footer>
</body>
</html>
