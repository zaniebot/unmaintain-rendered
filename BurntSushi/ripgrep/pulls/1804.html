<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cargo.toml: try to make release binaries smaller - BurntSushi/ripgrep #1804</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Cargo.toml: try to make release binaries smaller</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/pull/1804">#1804</a>
        opened by <a href="https://github.com/vrmiguel">@vrmiguel</a>
        on 2021-02-14 01:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/vrmiguel">@vrmiguel</a></div>
            <div class="timeline-body"><p>Hello Andrew (and other contributors)! First off, congrats. on the great project ;)</p>
<p>This PR consists in</p>
<ul>
<li>Activating &quot;fat&quot; link-time optimization;</li>
<li>Compiling on a single code generation unit;</li>
<li>Setting <code>opt-level</code> to 3.</li>
</ul>
<p>The most obvious (and possibly the only) downside I can see are slightly longer compilation times.</p>
<p>Compiling the latest (at the time of writing) <code>ripgrep</code> (master):</p>
<pre><code>    Finished release [optimized + debuginfo] target(s) in 1m 23s
</code></pre>
<p>Compiling <code>ripgrep</code> with this PR's <code>Cargo.toml</code>:</p>
<pre><code>    Finished release [optimized + debuginfo] target(s) in 1m 29s
</code></pre>
<p>Both running on an AMD 4x 3.8GHz CPU, Linux 5.10.15 and a similarly undisturbed OS.</p>
<p>This is, of course, not the most scientific of tests but shows that the build time delta is not big.</p>
<p>The result in binary sizes are</p>
<pre><code class="language-bash">$ du -sh rg
27M     rg           # Current Cargo.toml 
</code></pre>
<pre><code class="language-bash">$ du -sh rg
18M     rg           # This PR's proposal
</code></pre>
<p>This is only anecdotal, but a 7.22% increase in build time gave us a 33.3% decrease in binary size, which seems (to me) a worthwhile investment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Cargo.toml: try to maker release binaries smaller" to "Cargo.toml: try to make release binaries smaller" by @vrmiguel on 2021-02-14 01:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-05-30 13:24</div>
            <div class="timeline-body"><p>OK, so people have tried to do this before. (There have been at least a few attempts.) I've rebuffed them every time, and unfortunately, this time is no different. I'm always willing to give it another shot to see if anything has changed, but it doesn't appear to be the case.</p>
<p>So on my laptop, without these options, it takes about 57s to compile ripgrep from scratch. With this change, it takes about 97s. That's a much bigger difference than what you measured.</p>
<p>But that actually isn't the biggest problem. The biggest problem is the increase in iteration time. My sniff test is, after a clean build, run <code>touch crates/core/main.rs</code> and then try a rebuild. Without these options, it takes a painful 13s. But with these options, it takes an excruciating 68s. This isn't something that I can really live with. 13s is already painful enough.</p>
<p>There are a couple higher level points here:</p>
<ul>
<li>Why do I care about release build times? Because I do most of my work with release builds, e.g., profiling.</li>
<li>In theory, what we probably should do is patch <code>Cargo.toml</code>'s release configuration when generating the <em>actual</em> release binaries in CI. But at that point, the size differences aren't as pronounced since CI already strips the binaries. So doing this is more about squeezing the binary as much as possible while perhaps enabling the best possible class of optimizations. But in some simple tests, I can't see a measurable difference.</li>
<li>Patching the release configuration in CI means <code>cargo install</code> users don't get the benefits. (But I wouldn't consider this a hard blocker.)</li>
<li>Finally, patching the release config in CI means that I'm not dog-fooding it.</li>
</ul>
<p>So with that, I'm going to close this for now, although I appreciate efforts to decrease binary size. I don't think I've ever done a <code>cargo bloat</code> on ripgrep before, so it's possible there are some lower hanging fruits there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2021-05-30 13:24</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 18:28:16 UTC
    </footer>
</body>
</html>
