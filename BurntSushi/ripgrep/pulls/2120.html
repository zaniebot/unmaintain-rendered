<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed CI with caching - BurntSushi/ripgrep #2120</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Speed CI with caching</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/pull/2120">#2120</a>
        opened by <a href="https://github.com/AustinWise">@AustinWise</a>
        on 2022-01-09 05:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AustinWise">@AustinWise</a></div>
            <div class="timeline-body"><p>Cache both Cargo dependencies and build output using the <a href="https://github.com/actions/cache/blob/main/examples.md#rust---cargo">example settings for actions/cache</a>.</p>
<p>This is similar to #719 which cached builds in Travis and Appveyor.</p>
Cache speedup
<p>This speeds up <em>most</em> builds:</p>
<p>|CI Leg|<a href="https://github.com/AustinWise/ripgrep/actions/runs/1673024260">Before</a>|<a href="https://github.com/AustinWise/ripgrep/actions/runs/1673043494">After</a>|
|--|--|--|
|pinned|3m 11s|1m 54s|
|stable|3m 24s|1m 15s|
|beta|2m 51s|1m 30s|
|nightly|2m 42s|1m 39s|
|nightly-musl|4m 56s|3m 9s|
|nightly-32|4m 29s|2m 35s|
|nightly-mips|8m 29s|<strong>9m 22s</strong>|
|macos|4m 23s|2m 3s|
|win-msvc|5m 32s|2m 17s|
|win-gnu|5m 52s|3m 1s|</p>
<p>The only build configuration that regressed between these two runs was the
slowest: <code>nightly-mips</code>. The &quot;run tests&quot; step was the slow part. I did another
<a href="https://github.com/AustinWise/ripgrep/runs/4751425936?check_suite_focus=true">uncached run</a>
that took the same amount of time on &quot;run tests&quot; as the slow cached one, so
maybe this is noise?</p>
Cache size
<p>There is a <a href="https://github.com/actions/cache#cache-limits">10GB limit</a> for the
cache:</p>
<blockquote>
<p>A repository can have up to 10GB of caches. Once the 10GB limit is reached, older caches will be evicted based on when the cache was last accessed. Caches that are not accessed within the last week will also be evicted.</p>
</blockquote>
<p>The size of the cached artifacts current vary from 256MB to 410MB. Assuming a
worst case of 500MB per leg, this would allow for caching of 20 different
builds. This is greater than the current 11 builds in the CI matrix.</p>
Cache invalidation
<p>The cache key will be invalidated whenever the Cargo.lock changes.</p>
Soundness
<p>Rust has suffered from
<a href="https://blog.rust-lang.org/2021/05/10/Rust-1.52.1.html">miscompilation during incremental builds</a>
in the past. So that is something to consider when deciding if the speedup is
worth the potential for spurious errors or lack of errors during CI runs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AustinWise">@AustinWise</a> on 2022-01-09 05:23</div>
            <div class="timeline-body"><p>Note the the nightly-arm build is failing. I assume it not because of my change, as it is failing even with an empty cache.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AustinWise">@AustinWise</a> on 2022-02-06 22:48</div>
            <div class="timeline-body"><p>I&#x27;m not sure now that this is best way to do the caching. Rustup uses a slightly different approach. See here:</p>
<p>https://github.com/rust-lang/rustup/blob/master/.github/workflows/linux-builds-on-pr.yaml</p>
<p>The main differences are:</p>
<ul>
<li>Separate caches for <code>.cargo</code> and <code>target</code> directories</li>
<li>Cleans the <code>.cargo</code> cache to be smaller</li>
</ul>
<p>I&#x27;m going to close this PR until I have more confidence about the right approach.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AustinWise">@AustinWise</a> on 2022-02-06 22:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:18 UTC
    </footer>
</body>
</html>
