<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>fix(globset/serde1): allow deserializing owned strings into `Glob` - BurntSushi/ripgrep #2388</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>fix(globset/serde1): allow deserializing owned strings into <code>Glob</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/pull/2388">#2388</a>
        opened by <a href="https://github.com/jeertmans">@jeertmans</a>
        on 2023-01-01 13:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jeertmans">@jeertmans</a></div>
            <div class="timeline-body"><p>This PR modifies how <code>Glob</code> is deserialized such that it now allows for owned strings (previously, only borrowed) to be deserialized into <code>Glob</code>. This takes inspiration from what is done in the <a href="https://github.com/tailhook/serde-regex/blob/336bb456ecd146ba9e3fcc2fef71870f603d72c5/src/lib.rs#L179-L191"><code>regex_serde</code> crate</a>.</p>
<p>For more details, see the discussion in #2386.</p>
<p>The first commit includes tests, which fail without the solution.
The second commit include the solution.</p>
<p>This fixes #2386.</p>
<p>I&#x27;d be happy to hear from your thoughts and I&#x27;m open to any review :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jeertmans">@jeertmans</a> on 2023-01-08 10:36</div>
            <div class="timeline-body"><p>Like so @LPGhatguy? I have updated the code according to your comment.</p>
<p>I have merged <code>StrVisitor</code> and <code>StringVisitor</code> implementation into <code>CowStrVisitor</code> (see <a href="https://rust-random.github.io/rand/src/serde/de/impls.rs.html#599">here</a>).</p>
<p>After checking, the first test uses a <code>Cow::Owned</code>, while the two others use a <code>Cow::Borrowed</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LPGhatguy">@LPGhatguy</a> on 2023-01-09 08:26</div>
            <div class="timeline-body"><p><code>Cow</code> doesn&#x27;t need to be involved here. You should make a <code>GlobVisitor</code> that constructs the glob directly from the value instead of pulling it into an intermediate <code>Cow</code>.</p>
<p>I don&#x27;t think that <code>visit_borrowed_bytes</code> or <code>visit_byte_buf</code> will be reached. Because we&#x27;re calling <code>deserialize_str</code>, we&#x27;re telling Sede that we&#x27;re going to deserialize a string, not an arbitrary sequence of bytes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jeertmans">@jeertmans</a> on 2023-01-09 10:38</div>
            <div class="timeline-body"><p>Thanks, @LPGhatguy! Indeed, after my commit, I realized that using <code>Cow</code> was no longer needed. I implemented a new version where I directly parse a string into a <code>Glob</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/LPGhatguy">@LPGhatguy</a> on <code>crates/globset/src/serde_impl.rs</code>:22 on 2023-01-14 03:51</div>
            <div class="timeline-body"><p>This should probably be &quot;a glob pattern&quot; or something more descriptive here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/LPGhatguy">@LPGhatguy</a> reviewed on 2023-01-14 03:52</div>
            <div class="timeline-body"><p>Last comment, then LGTM.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jeertmans">@jeertmans</a> reviewed on 2023-01-14 08:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jeertmans">@jeertmans</a> on <code>crates/globset/src/serde_impl.rs</code>:22 on 2023-01-14 08:15</div>
            <div class="timeline-body"><p>Thanks for noticing! There you go :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jonasbb">@jonasbb</a> approved on 2023-01-18 20:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/LPGhatguy">@LPGhatguy</a> approved on 2023-01-27 07:42</div>
            <div class="timeline-body"><p>lgtm</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jeertmans">@jeertmans</a> on 2023-02-11 10:53</div>
            <div class="timeline-body"><p>Hello @BurntSushi, any plan on merging this? Or is it waiting for something else?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/globset/src/serde_impl.rs</code>:3 on 2023-02-11 12:43</div>
            <div class="timeline-body"><p>Please group imports. std imports should come first, then an empty line, then third party imports (like <code>serde</code>) and then finally crate local imports.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/globset/src/serde_impl.rs</code>:3 on 2023-02-11 12:43</div>
            <div class="timeline-body"><p>Or just write <code>std::fmt::Formatter</code> and <code>std::fmt::Result</code> below.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/globset/src/serde_impl.rs</code>:44 on 2023-02-11 12:44</div>
            <div class="timeline-body"><p>Same nit here about import grouping.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> requested changes on 2023-02-11 12:45</div>
            <div class="timeline-body"><p>I think this LGTM and looks much better than what it was before. There are some style nits though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-02-11 12:45</div>
            <div class="timeline-body"><blockquote>
<p>Or is it waiting for something else?</p>
</blockquote>
<p>It&#x27;s waiting on me to review it. In general, my review latency is pretty high.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jeertmans">@jeertmans</a> on <code>crates/globset/src/serde_impl.rs</code>:3 on 2023-02-11 12:55</div>
            <div class="timeline-body"><p>Like so (see recent commit)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jeertmans">@jeertmans</a> reviewed on 2023-02-11 12:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jeertmans">@jeertmans</a> on 2023-02-11 12:56</div>
            <div class="timeline-body"><blockquote>
<p>It&#x27;s waiting on me to review it. In general, my review latency is pretty high.</p>
</blockquote>
<p>No problem, take your time :-)</p>
<p>I think I have updated the code accordingly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/BurntSushi">@BurntSushi</a> by <a href="https://github.com/jeertmans">@jeertmans</a> on 2023-02-11 12:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2023-07-07 18:40</div>
            <div class="timeline-body"><p>LGTM</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-07-07 18:43</div>
            <div class="timeline-body"><p>In the future, for changes this small, they should be one commit. If you need to make changes after opening the PR, then modify the commit via <code>git commit --amend</code> and force push.</p>
<p>Basically, treat commits like code. Optimize for the reader.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rollup</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-07-07 18:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-07-08 22:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-10 20:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:19 UTC
    </footer>
</body>
</html>
