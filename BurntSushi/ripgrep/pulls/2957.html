<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>feat(completion): support sourcing zsh completion dynamically - BurntSushi/ripgrep #2957</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>feat(completion): support sourcing zsh completion dynamically</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/BurntSushi/ripgrep/pull/2957">#2957</a>
        opened by <a href="https://github.com/vegerot">@vegerot</a>
        on 2024-12-30 23:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/vegerot">@vegerot</a></div>
            <div class="timeline-body"><p>Summary:
Previously, you needed to save the completion script to a file and then
source it.  Now, you can dynamically source completions in zsh by
running</p>
<pre><code class="language-zsh">$ source &lt;(rg --generate complete-zsh)
</code></pre>
<p>Test plan:</p>
<ol>
<li>Run <code>source &lt;(rg --generate complete-zsh)</code></li>
<li>Run <code>rg --generate=complete-zs&lt;TAB&gt;</code></li>
</ol>
<p>Before this commit, you would get an error after step 1.
After this commit, it should work as expected.</p>
<p>Closes #2956</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>FAQ.md</code>:129 on 2024-12-31 00:06</div>
            <div class="timeline-body"><p>Why are we suggesting this method? I'm okay with supporting it as long as it doesn't have any costs to doing so, but I don't see a good reason to specifically highlight it in the docs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-12-31 00:06</div>
            <div class="timeline-body"><p>r? @okdana</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/vegerot">@vegerot</a> reviewed on 2024-12-31 00:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/vegerot">@vegerot</a> on <code>FAQ.md</code>:129 on 2024-12-31 00:22</div>
            <div class="timeline-body"><p>Personal preference.  I personally like doing it this way because it makes installation easier.  Since the generation is fast, I don't need to think about installing <code>_rg</code> and can just put in my zshrc</p>
<pre><code class="language-zsh">  if type rg &gt; /dev/null; then
	  eval &quot;$(rg --generate=complete-zsh)&quot;
  fi
</code></pre>
<p>I assume other people prefer it this way too, which is why projects like <a href="https://github.com/junegunn/fzf?tab=readme-ov-file#setting-up-shell-integration">fzf</a> suggest it by default.  That is why I suggested it in the doc.</p>
<p>If you disagree, then I can remove this bit üôÇ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/vegerot">@vegerot</a> reviewed on 2024-12-31 00:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/vegerot">@vegerot</a> on <code>crates/core/flags/complete/rg.zsh</code>:438 on 2024-12-31 00:26</div>
            <div class="timeline-body"><p>I originally wrote this as</p>
<pre><code class="language-zsh">if [[ &quot;$funcstack[1]&quot; = &quot;_rg&quot; ]]; then
  _rg &quot;$@&quot;
elif type compdef &gt;/dev/null; then
    compdef _rg rg
fi
</code></pre>
<p>But <code>ci/test-complete</code> didn't like that.  ~~I feel like the test is wrong~~ (nvm I am wrong!), because realistically you will either have <code>compdef</code> or will run the completion as <code>_rg</code>.  I stared at the test for a few seconds and didn't want to spend more time digging into it.  Instead, I worked around it by making it</p>
<pre><code class="language-zsh">if [[ &quot;$funcstack[1]&quot; = &quot;_rg&quot; ]]; then
  _rg &quot;$@&quot;
elif type compdef &gt;/dev/null; then
    compdef _rg rg
else
  _rg &quot;$@&quot;
fi
</code></pre>
<p>To be clear, this code is fine, but feels redundant ü§∑üèº‚Äç‚ôÄÔ∏è</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/okdana">@okdana</a> reviewed on 2024-12-31 00:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/okdana">@okdana</a> on <code>crates/core/flags/complete/rg.zsh</code>:438 on 2024-12-31 00:42</div>
            <div class="timeline-body"><p>the test script isn't wrong. the function is designed to be sourced by it without requiring anything from the completion system. we could have the script load <code>compdef</code> but it would still do the wrong thing with that check. i would suggest this as more idiomatic (and faster) than the <code>type</code> method:</p>
<pre><code class="language-zsh">if [[ $funcstack[1] == _rg ]] || (( ! $+functions[compdef] )); then
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/okdana">@okdana</a> reviewed on 2024-12-31 00:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/okdana">@okdana</a> on <code>FAQ.md</code>:122 on 2024-12-31 00:45</div>
            <div class="timeline-body"><p>obv this is a pre-existing issue but these instructions don't really do anything as written. i would suggest we add something like 'then add <code>$dir</code> to your <code>fpath</code>'. if you'd rather not do this here i can make another pr</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/okdana">@okdana</a> reviewed on 2024-12-31 00:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/okdana">@okdana</a> on <code>FAQ.md</code>:129 on 2024-12-31 00:51</div>
            <div class="timeline-body"><p>i don't know for sure but i'd guess that other projects suggest this <code>source</code> method just because it's self-contained and it works regardless of whatever else might be in the user's zsh profile. creating a personal directory for completion functions and adding it to <code>fpath</code> is more idiomatic, more extensible, and (as the comment here mentions) faster at start-up, but harder to explain. i don't have a strong opinion on whether they should both be mentioned in the faq</p>
<p>eta: another benefit is that the function is self-updating. maybe that's a more compelling reason</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/vegerot">@vegerot</a> reviewed on 2024-12-31 00:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/vegerot">@vegerot</a> on <code>FAQ.md</code>:122 on 2024-12-31 00:57</div>
            <div class="timeline-body"><p>I can do that.</p>
<p>...orr, we could suggest the easier way I'm adding in this commit.</p>
<blockquote>
<p>If you installed ripgrep with a package manager, you should have shell completions automatically (Brew users see <a href="https://docs.brew.sh/Shell-Completion">here</a>)
However, if completions aren't working, then add to your <code>zshrc</code></p>
<pre><code class="language-zsh">source &lt;(rg --generate=complete-zsh)
</code></pre>
</blockquote>
<p>I like the idea of hoping their package manager does the right thing, but if doesn't then suggesting a simple one-liner instead of a multi-step process of creating directories, files, and adding things to your <code>fpath</code>.  On my machine (granted, it's over $1k) it only adds 4ms of overhead which is acceptable imo.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/vegerot">@vegerot</a> on <code>crates/core/flags/complete/rg.zsh</code>:438 on 2024-12-31 01:01</div>
            <div class="timeline-body"><p>Thanks! Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/vegerot">@vegerot</a> reviewed on 2024-12-31 01:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/vegerot">@vegerot</a> reviewed on 2024-12-31 01:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/vegerot">@vegerot</a> on <code>FAQ.md</code>:129 on 2024-12-31 01:57</div>
            <div class="timeline-body"><p>Based on how difficult it is to explain (see other thread), I think it makes more sense to show new users the easiest method by default, and if they want the more &quot;idiomatic&quot; / performant (slightly) option we can show it as an alternative.  The FAQ is going to be read by people who may not want to create directories, new files, and update their fpath.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/vegerot">@vegerot</a> on <code>FAQ.md</code>:129 on 2024-12-31 01:58</div>
            <div class="timeline-body"><p>@okdana @BurntSushi how about I remove the FAQ patch, and we can discuss how to improve the FAQ in a new issue? (continued from https://github.com/BurntSushi/ripgrep/pull/2957#discussion_r1899864739 )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/vegerot">@vegerot</a> reviewed on 2024-12-31 01:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-12-31 13:11</div>
            <div class="timeline-body"><p>I've left it in the FAQ and fixed up the wording by adding an appropriate caveat emptor. I guess since other projects have found it useful to suggest this method it's probably not too big of a deal for ripgrep to do it too. But the text now makes it clear that the &quot;generate and source&quot; approach is slower. 4ms might not seem like much, and indeed, I cannot perceive a 4ms lag, but if you accrue 10 of those kinds of things, it starts to pile up into something that is noticeable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2024-12-31 13:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2024-12-31 13:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vegerot">@vegerot</a> on 2025-01-03 04:01</div>
            <div class="timeline-body"><p>@BurntSushi I'm using a self-built version now, but jooc when will the next release be so others can use it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-01-03 04:29</div>
            <div class="timeline-body"><p>I don't know, sorry. See: https://github.com/BurntSushi/ripgrep/blob/master/FAQ.md#when-is-the-next-release</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:44:18 UTC
    </footer>
</body>
</html>
