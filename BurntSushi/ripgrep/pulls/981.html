<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Try to fullfill all the goals of the generic decoder program feature - BurntSushi/ripgrep #981</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Try to fullfill all the goals of the generic decoder program feature</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/pull/981">#981</a>
        opened by <a href="https://github.com/c-blake">@c-blake</a>
        on 2018-07-13 14:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/c-blake">@c-blake</a></div>
            <div class="timeline-body"><p>request: <a href="https://github.com/BurntSushi/ripgrep/issues/978">BurntSushi/ripgrep#978</a></p>
<p>There are a a bunch of choices maybe I should mention in this PR.
I called it &quot;-P,--preprocessor&quot; to suggest its primary function.
I basically just imitated the way decompression was handled with
a new file <code>src/preprocessor.rs</code> instead of <code>src/decompressor.rs</code>.</p>
<p>Currently, if both <code>--search-zip</code> and <code>--preprocessor PROGRAM</code> are
given,  the latter is used.  This seemed reasonable since preprocessing is more
general and probably involves more sophisticated users who can more easily
include whatever compression programs they want (or don&#x27;t want) using whatever
dispatching algorithm they want.</p>
<p>For me, it compiles and runs fine on rust-1.27.1 both with no <code>-P</code> at all,
with <code>-P program-using-only-stdin</code> and <code>-P program-using-argv1</code>.  The only
failing I see right now on Linux is that if you specify a bogus preprocessor
like <code>rg -P /junk foo</code> it does not error out at the very first file.</p>
<p>Oh, and while the shell script snippet formats fine in the --help output, the
auto-generated man page corrupts it into a 2- or 3-liner with some chars
dropped out.  Not sure what to do about that.  Could also just put that
material in GUIDE.md and drop it from the help.</p>
<p>Also, this is my very first significant stab at Rust work.  So, I may well
have done some things in an undesirable way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/okdana">@okdana</a> reviewed on 2018-07-13 15:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/okdana">@okdana</a> on <code>src/app.rs</code>:1467 on 2018-07-13 15:55</div>
            <div class="timeline-body"><p>Quoting <code>COMMAND FILE</code> doesn&#x27;t seem right; place-holders aren&#x27;t quoted anywhere else in the help text. Also you switch between <code>COMMAND FILE</code> and <code>COMMAND</code>; <code>COMMAND</code> seems simpler (or maybe <code>PROGRAM</code> if you&#x27;re worried that&#x27;s too vague). Also <code>deactivates</code> is misspelt</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/okdana">@okdana</a> on <code>src/app.rs</code>:1488 on 2018-07-13 16:00</div>
            <div class="timeline-body"><p>Usually when one option overrides another (as you said this does with <code>-z</code>), you put that in the help text and then specify it here. You can see examples of that elsewhere in the file</p>
<p>I actually would have suggested making them <em>conflict</em>, because it&#x27;s not intuitively obvious how they should behave together, but then i thought that a lot of people probably add <code>-z</code> to their aliases/configs, so that might be too inconvenient. Not sure</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/okdana">@okdana</a> reviewed on 2018-07-13 16:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/okdana">@okdana</a> reviewed on 2018-07-13 16:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/okdana">@okdana</a> on <code>complete/_rg</code>:176 on 2018-07-13 16:09</div>
            <div class="timeline-body"><p>If you&#x27;re going to put these together, i would suggest renaming the group and changing the comment, since it&#x27;s no longer accurate. Maybe <code>(preprocessor-zip) # File-preprocessing options</code> or something, to match the way <code>pretty-vimgrep</code> is done</p>
<p>Also, the spec isn&#x27;t right. It should be something like:</p>
<pre><code>{-P+,--preprocessor=}&#x27;[specify preprocessor utility]:preprocessor utility:_command_names -e&#x27;
</code></pre>
<p>(<code>_command_names -e</code> will prefer <code>PATH</code> executables, but also do the right thing if you try to complete an actual file path)</p>
<p>Also, it probably should be placed <em>before</em> the other two options, since they were meant to be... semi-alphabetically ordered :/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/c-blake">@c-blake</a> reviewed on 2018-07-13 16:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/c-blake">@c-blake</a> on <code>src/app.rs</code>:1467 on 2018-07-13 16:41</div>
            <div class="timeline-body"><p>Ok.  Dequoted &amp; fixed spelling.  I use COMMAND FILE when there is also a FILE in the sentence context and COMMAND when it&#x27;s just about the program.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/okdana">@okdana</a> reviewed on 2018-07-13 16:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/okdana">@okdana</a> on <code>src/app.rs</code>:1467 on 2018-07-13 16:42</div>
            <div class="timeline-body"><p>Ah, i think i see what you mean</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/phiresky">@phiresky</a> on 2018-07-13 16:50</div>
            <div class="timeline-body"><p>Just as an example of why this would be awesome: Together with <a href="https://gist.github.com/phiresky/5025490526ba70663ab3b8af6c40a8db">this caching pdftotext wrapper</a> as a preprocessor this is able improve on pdfgrep by orders of magnitude:</p>
<p>On a semi-large directory of pdfs:</p>
<p><code>time pdfgrep -r IP &gt;/dev/null</code></p>
<p><code>3,20s user 0,08s system 99% cpu </code><strong>3,284 total</strong></p>
<p><code>time rg --preprocessor pdftotext-cached.sh IP &gt;/dev/null</code></p>
<p><code>0,12s user 0,04s system 374% cpu </code><strong>0,035 total</strong></p>
<p>That&#x27;s almost a 9000% performance improvement.</p>
<p>(Even without caching it only takes 0.5s, not sure what the pdfgrep people are doing)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/c-blake">@c-blake</a> on 2018-07-13 17:23</div>
            <div class="timeline-body"><p>Yeah...Besides lecture slides I have a slew of papers I&#x27;ve collected over the years, as I expect many others have.  I use this all the time with a custom GNU grep patch I did that does basically the same thing.  Line numbers might be nice and all, but honestly I mostly use this with a specific enough pattern and <code>--files-with-matches</code>, myself.  My use case is usually...&quot;What was that paper or two that did xyz again?&quot;.</p>
<p>As mentioned in the feature request, applications are really bounded only by your imagination.  The searching through only the parts of context diffs with actual changes, conceivably even (trustworthy) foreign language translations if there was a good library/CLI tool for that, <code>rg -P enFrancais</code> or whatever.</p>
<p>Caching transformers surely can speed things up at the expense of disk space to maintain the cache.  Personally, my archives are small enough that I just re-decode on the fly.  The parallel operation of <code>rg</code> really helps with transformation time, actually.  Indeed, if one is willing to spend the space for a full cache, maintaining it with <code>make</code> or whatever, it will always be faster to run <code>rg</code> on that shadow file hierarchy and transform the filenames in the output (if you even need to).</p>
<p>To get even as low as 70 us/file + 0.34 sec/GB on my box at home, I have to have a statically linked classifier that does its own pass-through for &quot;uncoded data&quot; <em>and</em> trim my environment to just $PATH.  That may not sound like much overhead, but the microseconds and milliseconds of overhead pile up when you have 10s of thousands of files on fast NVMe storage or buffered in RAM and <em>most but not all</em> of that is uncoded data.  The per-byte costs come from copies over the pipe buffer.  My email history is sort of like that.  Anyway, the real user time of those overheads is usually smaller/around the same as my time to enter a pattern and interpret the results.  A less careful management of the overheads can easily blow that up by 10X or more (some fancy dynlinked bash script dispatcher type stuff to dynlinked cat with a big environment, etc.) which pushes it into annoying territory (at least for me).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/okdana">@okdana</a> on <code>complete/_rg</code>:173 on 2018-07-13 17:32</div>
            <div class="timeline-body"><p>Missed the comment here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/okdana">@okdana</a> reviewed on 2018-07-13 17:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/c-blake">@c-blake</a> reviewed on 2018-07-13 17:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/c-blake">@c-blake</a> on <code>complete/_rg</code>:173 on 2018-07-13 17:35</div>
            <div class="timeline-body"><p>Oops.  Did you want that <code>-E,--encoding</code> option down in that input-decoding group, too?  Instead of &quot;misc/other&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/okdana">@okdana</a> on <code>complete/_rg</code>:173 on 2018-07-13 17:41</div>
            <div class="timeline-body"><p>No, these options were grouped together because they&#x27;re completed exclusively of each other (that&#x27;s what the <code>(...)</code> in the group name means). <code>-E</code> is independent and doesn&#x27;t have any particular relationship with other options, so it can be dumped in with the miscellaneous stuff. I can see how the group name <code>input-decoding</code> might kind of imply that relationship, which is why i&#x27;d suggested <code>preprocessor-zip</code> or something more specific like that; doesn&#x27;t matter too much tho</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/okdana">@okdana</a> reviewed on 2018-07-13 17:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/c-blake">@c-blake</a> reviewed on 2018-07-13 17:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/c-blake">@c-blake</a> on <code>complete/_rg</code>:173 on 2018-07-13 17:46</div>
            <div class="timeline-body"><p>Ah.  Ok.  I see.  Well, if someone optimizes some other common case and adds another option like --search-pdf (just as an example) we have a general group name.  Doesn&#x27;t matter to me unless someone complains.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2018-07-21 18:56</div>
            <div class="timeline-body"><p>This looks great! For your first Rust code, this ain&#x27;t bad at all! :-)</p>
<p>I am going to clean this up with a variety of minor nits, but overall, your approach looks solid!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-07-21 19:08</div>
            <div class="timeline-body"><p>@c-blake Do you want to think of a different short option for this other than <code>-P</code>? I have something else in mind for use with <code>-P</code> so I&#x27;d rather not use it for this. I might even prefer not to allocate a short option for this at all, since it seems like a less common feature and short flag real estate is precious. Perhaps we could shorten the flag down to just <code>--pre</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-07-21 20:19</div>
            <div class="timeline-body"><p>Some notes from working through the code and cleaning it up:</p>
<ul>
<li><code>PreprocessorReader</code> does not attach the given file to stdin, which meant that preprocessor scripts couldn&#x27;t actually read from stdin.</li>
<li>The preprocessor isn&#x27;t active when ripgrep is searching stdin. This seems OKish to me, but I&#x27;ve added it to the documentation.</li>
<li>The preprocessor itself probably shouldn&#x27;t be emitting log messages. Instead, it should return an error and the caller should decide how and when to print it. (In this case, that&#x27;s the worker.) I see that this style was probably emulated from the decompressor implementation, but the decompressor should probably be updated in this vein as well. (Although, IIRC, the decompression stuff has slightly different constraints for when to emit error messages.)</li>
<li>I&#x27;ve fixed up the ill-formatted script example for the man page.</li>
<li>I&#x27;ve removed the <code>-P</code> short option and changed the long option to <code>--pre</code>.</li>
<li>I&#x27;ve changed the representation of the preprocessor from <code>PathBuf</code> to <code>Option&lt;PathBuf&gt;</code> to better communicate that it is optional.</li>
<li>I briefly investigated producing a better failure mode when the preprocessor command simply doesn&#x27;t exist, but it looks like Rust&#x27;s standard library doesn&#x27;t expose its path resolution logic for commands, and I didn&#x27;t want to try and re-litigate that. We could actually attempt to start the process, but then that would need to get added to the command interface, which is too deliciously simple to disturb IMO.</li>
</ul>
<p>I&#x27;ve opened #989 with these changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-07-21 21:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:17 UTC
    </footer>
</body>
</html>
