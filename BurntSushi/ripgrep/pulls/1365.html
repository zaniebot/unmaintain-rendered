<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Make the parallel walker visit untraversable directories before failing - BurntSushi/ripgrep #1365</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Make the parallel walker visit untraversable directories before failing</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/pull/1365">#1365</a>
        opened by <a href="https://github.com/jakubadamw">@jakubadamw</a>
        on 2019-09-03 22:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jakubadamw">@jakubadamw</a></div>
            <div class="timeline-body"><p>This PR fixes an inconsistency between the serial and the parallel
directory walkers around visiting a directory for which the user holds
insufficient permissions to descend into.</p>
<p>The serial walker does produce a successful entry for a directory that
it cannot descend into due to insufficient permissions. However, before
this change that has not been the case for the parallel walker, which
would produce an <code>Err</code> item not only when descending into a directory
that it cannot read from but also for the directory entry itself.</p>
<p>This change brings the behaviour of the parallel variant in line with
that of the serial one.</p>
<p>Fixes #1346.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jakubadamw">@jakubadamw</a> on 2019-09-04 12:09</div>
            <div class="timeline-body"><p>I should probably note that the new test will always fail when running it as a root. Is that a problem?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>ignore/src/walk.rs</code>:1365 on 2019-09-04 12:19</div>
            <div class="timeline-body"><p>Could you maybe add a short comment about the ordering here? e.g., Why <code>readdir</code> is being handled here instead of above when <code>work.read_dir()</code> is called?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>ignore/src/walk.rs</code>:2102 on 2019-09-04 12:22</div>
            <div class="timeline-body"><p>Hmm, yeah, tests should not fail depending on what user ran them. Maybe it would be good to check if the file is readable after chmodding it. If it is, then skip the test.</p>
<p>With that said, it would be nice if we could avoid bringing in <code>libc</code> and <code>unsafe</code> for this test. Is there some other way to test this? Nothing is coming to mind... Maybe using a pre-existing file that a normal user traditionally doesn't have access to? (And skipping the test if the file doesn't exist or is readable.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>ignore/src/walk.rs</code>:2102 on 2019-09-04 12:22</div>
            <div class="timeline-body"><p>Please also make sure that lines are wrapped to 79 columns, inclusive.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> requested changes on 2019-09-04 12:22</div>
            <div class="timeline-body"><p>Thanks for looking into this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jakubadamw">@jakubadamw</a> reviewed on 2019-09-04 16:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jakubadamw">@jakubadamw</a> on <code>ignore/src/walk.rs</code>:2102 on 2019-09-04 16:36</div>
            <div class="timeline-body"><p>@BurntSushi, I added the proposed check, though, of course, it'd be better if the harness allowed marking a test as skipped at runtime.</p>
<p>With regard to avoiding adding a dev-dependency on <code>libc</code> I don't have a good idea either. But now I made it a Linux-only dependency. Perhaps that's good enough?</p>
<p>If using <code>libc</code> is really an issue (even though it already is a regular dependency for some other ripgrep crates, though, in truth, not <code>ignore</code> itself), then I'll be happy to change this to try to walk /root and check if it is observing at least one valid entry (i.e. the one for the directory itself).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2019-09-04 17:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>ignore/src/walk.rs</code>:2102 on 2019-09-04 17:19</div>
            <div class="timeline-body"><p>I probably care more about the extra <code>unsafe</code> to be honest. I'm mostly just trying to make sure things are as a tight as possible. This isn't a <em>huge</em> deal, but I want to try for an alternative if it's feasible.</p>
<p>Just looking at my file system, maybe just trying look for <code>/etc/sudoers.d</code>? It's readable by <code>root</code>, but not by anyone else. So I think the logic might be something like this:</p>
<ul>
<li>Stat <code>/etc/sudoers.d</code> via <code>std::fs::metadata()</code>.</li>
<li>If it errors, skip test.</li>
<li>Read <code>/etc/sudoers.d</code>.</li>
<li>If it succeeds, skip test.</li>
<li>Try to traverse <code>/etc/sudoers.d</code> and run the test normally.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jakubadamw">@jakubadamw</a> on <code>ignore/src/walk.rs</code>:2102 on 2019-09-04 17:39</div>
            <div class="timeline-body"><p>@BurntSushi, alright, sounds like a plan! I pushed the proposed change. Without a doubt that made the test much shorter and simpler. Thanks for the review!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jakubadamw">@jakubadamw</a> reviewed on 2019-09-04 17:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2019-09-04 17:41</div>
            <div class="timeline-body"><p>Okay, I think this LGTM. I'll merge this once I get CI back online. (I tried setting up GitHub Actions over the weekend, but <a href="https://github.com/BurntSushi/ripgrep/actions">it's completely stuck</a>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jakubadamw">@jakubadamw</a> on 2019-09-04 17:48</div>
            <div class="timeline-body"><p>@BurntSushi, there's a button there for cancelling a workflow. Have you tried that? (You probably have and I'm asking a stupid question. ðŸ™‚)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2019-09-04 17:52</div>
            <div class="timeline-body"><blockquote>
<p>there's a button there for cancelling a workflow. Have you tried that? (You probably have and I'm asking a stupid question. slightly_smiling_face)</p>
</blockquote>
<p>Hah, I wish. But yeah, that button does normally show up. In my case though, Actions seems to be stuck in some sort of initialization state where by that button doesn't show up. The jobs have been running for over 4 days too, which suggests timeout functionality doesn't work either.</p>
<p>I've sent mail to GitHub support but haven't heard back from them.</p>
<p>I've turned Travis and AppVeyor back on. Going to see if I can trigger it on this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2019-09-04 17:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @BurntSushi on 2019-09-04 17:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/treere">@treere</a> on 2019-09-21 20:55</div>
            <div class="timeline-body"><p>there is a subtle bug and a performance issue. give me some minutes and I will explain.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/treere">@treere</a> on <code>ignore/src/walk.rs</code>:1351 on 2019-09-21 20:58</div>
            <div class="timeline-body"><p>here there is an unnecessary syscall. I think that a clone is 99% better in performance</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/treere">@treere</a> on <code>ignore/src/walk.rs</code>:1365 on 2019-09-21 21:24</div>
            <div class="timeline-body"><p>I think that readdir shuold be handled after the next if (line 1376). just before the iteration on the folder content.</p>
<p>If the the maximum depth has been reached you should I risk to <code>self.quit_now()</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/treere">@treere</a> reviewed on 2019-09-21 21:25</div>
            <div class="timeline-body"><p>I think that there is a small bug and a little persormance issue. (one is inside a piece marked as resolved)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/tavianator">@tavianator</a> on <code>ignore/src/walk.rs</code>:2102 on 2019-09-23 16:27</div>
            <div class="timeline-body"><p>Maybe <code>/root</code> (or more generally <code>~root</code>) is more ubiquitous than <code>/etc/sudoers.d</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tavianator">@tavianator</a> reviewed on 2019-09-23 16:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2020-02-17 18:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>ignore/src/walk.rs</code>:1351 on 2020-02-17 18:21</div>
            <div class="timeline-body"><p>I'm not sure I follow your comment here. There is exactly one call to <code>read_dir</code> both before and after this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rollup</span> added by @BurntSushi on 2020-02-17 18:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2020-02-17 22:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 18:28:09 UTC
    </footer>
</body>
</html>
