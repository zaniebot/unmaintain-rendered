<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fine-tune the Ordering for the atomic usages - BurntSushi/ripgrep #2706</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fine-tune the Ordering for the atomic usages</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/pull/2706">#2706</a>
        opened by <a href="https://github.com/wang384670111">@wang384670111</a>
        on 2024-01-08 08:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/wang384670111">@wang384670111</a></div>
            <div class="timeline-body"><p><code>SeqCst</code> is overly restrictive. I believe that the ordering can be appropriately modified.</p>
<p>In <code>messages</code> model, I believe that <code>MESSAGES</code>, <code>IGNORE_MESSAGES</code>, and <code>ERRORED</code> are merely signals for multithreading purposes and do not synchronize with other locals. Therefore, using <code>Relaxed</code> ordering should suffice.</p>
<p>In <code>lib</code> and <code>utils</code> models, <code>COUNTER</code> and <code>NEXT_ID</code> are used for multithreading counting purposes, so using <code>Relaxed</code> ordering is sufficient.</p>
<p>In <code>walk</code> model, the <code>load</code> and <code>store</code> of <code>quit_now</code> should use <code>Acquire</code>/<code>Release</code> to ensure that the <code>stack</code> is up-to-date.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ignore/src/walk.rs</code>:1720 on 2024-01-08 16:06</div>
            <div class="timeline-body"><p>I think this and the <code>Release</code> above need comments justifying why this is correct.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> requested changes on 2024-01-08 16:08</div>
            <div class="timeline-body"><p>I used <code>SeqCst</code> in part because I didn't want to do the analysis necessary to demonstrate that a less restrictive ordering was correct, and also because I didn't perceive using <code>SeqCst</code> to be a particular issue in most of these cases.</p>
<p>With that said, I buy all of the changes to <code>Relaxed</code> here I think.</p>
<p>However, I'm unsure of the <code>Require</code>/<code>Release</code> changes in the <code>ignore</code> crate. I think those warrant comments explaining their correctness.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wang384670111">@wang384670111</a> on 2024-01-09 09:58</div>
            <div class="timeline-body"><blockquote>
<p>I used <code>SeqCst</code> in part because I didn't want to do the analysis necessary to demonstrate that a less restrictive ordering was correct, and also because I didn't perceive using <code>SeqCst</code> to be a particular issue in most of these cases.</p>
<p>With that said, I buy all of the changes to <code>Relaxed</code> here I think.</p>
<p>However, I'm unsure of the <code>Require</code>/<code>Release</code> changes in the <code>ignore</code> crate. I think those warrant comments explaining their correctness.</p>
</blockquote>
<p>My reasoning is based on the following observations:</p>
<p>Line 1501 calls <code>quit_now</code> after calling <code>run_one</code> at line 1562, where <code>run_one</code> invokes <code>generate_work</code>. Inside <code>generate_work</code>, specifically at line 1655, the <code>send</code> performs a <code>push</code> on the <code>stack</code>.
https://github.com/BurntSushi/ripgrep/blob/648a65f1976cc3b7eb66425024649d71d5befe1e/crates/ignore/src/walk.rs#L1498-L1504
https://github.com/BurntSushi/ripgrep/blob/648a65f1976cc3b7eb66425024649d71d5befe1e/crates/ignore/src/walk.rs#L1654-L1656
Then, after executing <code>is_quit_now</code> at line 1669, <code>send_quit</code> is called at line 1680 to access the <code>stack</code> and perform another <code>push</code>.
https://github.com/BurntSushi/ripgrep/blob/648a65f1976cc3b7eb66425024649d71d5befe1e/crates/ignore/src/walk.rs#L1669-L1682</p>
<p>Based on this sequence of operations, in the absence of a definitive <code>happen-before</code> relationship within a concurrent environment, I believe it is necessary to use <code>Acquire</code>/<code>Release</code> to establish synchronization, in order to properly observe these modifications to <code>stack</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wang384670111">@wang384670111</a> on 2024-01-10 16:00</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>I used <code>SeqCst</code> in part because I didn't want to do the analysis necessary to demonstrate that a less restrictive ordering was correct, and also because I didn't perceive using <code>SeqCst</code> to be a particular issue in most of these cases.
With that said, I buy all of the changes to <code>Relaxed</code> here I think.
However, I'm unsure of the <code>Require</code>/<code>Release</code> changes in the <code>ignore</code> crate. I think those warrant comments explaining their correctness.</p>
</blockquote>
<p>My reasoning is based on the following observations:</p>
<p>Line 1501 calls <code>quit_now</code> after calling <code>run_one</code> at line 1562, where <code>run_one</code> invokes <code>generate_work</code>. Inside <code>generate_work</code>, specifically at line 1655, the <code>send</code> performs a <code>push</code> on the <code>stack</code>.</p>
<p>https://github.com/BurntSushi/ripgrep/blob/648a65f1976cc3b7eb66425024649d71d5befe1e/crates/ignore/src/walk.rs#L1498-L1504</p>
<p>https://github.com/BurntSushi/ripgrep/blob/648a65f1976cc3b7eb66425024649d71d5befe1e/crates/ignore/src/walk.rs#L1654-L1656</p>
<p>Then, after executing <code>is_quit_now</code> at line 1669, <code>send_quit</code> is called at line 1680 to access the <code>stack</code> and perform another <code>push</code>.
https://github.com/BurntSushi/ripgrep/blob/648a65f1976cc3b7eb66425024649d71d5befe1e/crates/ignore/src/walk.rs#L1669-L1682</p>
<p>Based on this sequence of operations, in the absence of a definitive <code>happen-before</code> relationship within a concurrent environment, I believe it is necessary to use <code>Acquire</code>/<code>Release</code> to establish synchronization, in order to properly observe these modifications to <code>stack</code>.</p>
</blockquote>
<blockquote>
<blockquote>
<p>I used <code>SeqCst</code> in part because I didn't want to do the analysis necessary to demonstrate that a less restrictive ordering was correct, and also because I didn't perceive using <code>SeqCst</code> to be a particular issue in most of these cases.
With that said, I buy all of the changes to <code>Relaxed</code> here I think.
However, I'm unsure of the <code>Require</code>/<code>Release</code> changes in the <code>ignore</code> crate. I think those warrant comments explaining their correctness.</p>
</blockquote>
<p>My reasoning is based on the following observations:</p>
<p>Line 1501 calls <code>quit_now</code> after calling <code>run_one</code> at line 1562, where <code>run_one</code> invokes <code>generate_work</code>. Inside <code>generate_work</code>, specifically at line 1655, the <code>send</code> performs a <code>push</code> on the <code>stack</code>.</p>
<p>https://github.com/BurntSushi/ripgrep/blob/648a65f1976cc3b7eb66425024649d71d5befe1e/crates/ignore/src/walk.rs#L1498-L1504</p>
<p>https://github.com/BurntSushi/ripgrep/blob/648a65f1976cc3b7eb66425024649d71d5befe1e/crates/ignore/src/walk.rs#L1654-L1656</p>
<p>Then, after executing <code>is_quit_now</code> at line 1669, <code>send_quit</code> is called at line 1680 to access the <code>stack</code> and perform another <code>push</code>.
https://github.com/BurntSushi/ripgrep/blob/648a65f1976cc3b7eb66425024649d71d5befe1e/crates/ignore/src/walk.rs#L1669-L1682</p>
<p>Based on this sequence of operations, in the absence of a definitive <code>happen-before</code> relationship within a concurrent environment, I believe it is necessary to use <code>Acquire</code>/<code>Release</code> to establish synchronization, in order to properly observe these modifications to <code>stack</code>.</p>
</blockquote>
<p>I've reconsidered my earlier deduction and realized I overlooked a crucial detail.</p>
<p>Before calling <code>quit_now</code> at 1501, we have a successful return of <code>WalkState::Quit</code> at 1500. This indicates that the <code>stack</code> push operation, occurring at line 1655, has completed. This establishes a happen-before relationship, making it unnecessary to use <code>Release</code> in <code>quit_now</code> to ensure the completion of the <code>stack</code> push operation. Therefore, using <code>Relaxed</code> for both the store in <code>quit_now</code> and the subsequent load should suffice.</p>
<p>I would greatly appreciate your feedback on this observation. I'm eager for the potential merge and am ready to provide any further clarifications as needed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-01-10 16:03</div>
            <div class="timeline-body"><p>It might take me some time to look into this. I basically need to convince myself of your argument.</p>
<p>If you want to get something merged more quickly, you could open a new PR with the less &quot;interesting&quot; changes and keep this PR focused on the changes to <code>ignore</code>'s parallel traversal.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rollup</span> added by @BurntSushi on 2025-07-04 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2025-09-20 01:08</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:44:13 UTC
    </footer>
</body>
</html>
