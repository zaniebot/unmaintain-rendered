<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ignore: speed up Gitignore::empty - BurntSushi/ripgrep #895</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ignore: speed up Gitignore::empty</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/BurntSushi/ripgrep/pull/895">#895</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2018-04-24 14:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>This commit makes Gitignore::empty a bit faster by avoiding allocation
and manually specializing the implementation instead of routing it through
the GitignoreBuilder.</p>
<p>This helps improve uses of ripgrep that traverse <em>many</em> directories, and
in particular, when the use of ignores is disabled via command line
switches.</p>
<p>Fixes #835, Closes #836</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-04-24 14:50</div>
            <div class="timeline-body"><p>@sharkdp I think this should resolve the performance regression. I think my <a href="https://github.com/BurntSushi/ripgrep/pull/836#issuecomment-372030260">initial analysis here</a> wasn&#x27;t quite the whole story. In addition to the overhead of <code>create_gitignore</code>, it turns out that <code>Gitignore::empty()</code> had a fair bit of cost associated with it as well.</p>
<p>Here are the benchmarks (first is current master, second is your PR on top of current master and third is this PR):</p>
<pre><code>$ hyperfine -s basic --warmup 10 &#x27;rg-baseline -uu --files -g &quot;README.rst&quot;&#x27;
Benchmark #1: rg-baseline -uu --files -g &quot;README.rst&quot;
  Time (mean ± σ):     596.9 ms ±   4.7 ms    [User: 3.815 s, System: 3.200 s]
  Range (min … max):   589.8 ms … 604.1 ms

$ hyperfine -s basic --warmup 10 &#x27;rg-sharkdp -uu --files -g &quot;README.rst&quot;&#x27;
Benchmark #1: rg-sharkdp -uu --files -g &quot;README.rst&quot;
  Time (mean ± σ):     544.0 ms ±   2.8 ms    [User: 3.287 s, System: 3.112 s]
  Range (min … max):   540.3 ms … 548.5 ms

$ hyperfine -s basic --warmup 10 &#x27;rg -uu --files -g &quot;README.rst&quot;&#x27;
Benchmark #1: rg -uu --files -g &quot;README.rst&quot;
  Time (mean ± σ):     554.9 ms ±   6.8 ms    [User: 3.365 s, System: 3.160 s]
  Range (min … max):   547.7 ms … 566.3 ms
</code></pre>
<p>One important observation here is that because <code>-u</code> is used, the calls to <code>matched</code> on the <code>Gitignore</code> matchers never actually take place since <code>has_any_ignore_rules</code> returns <code>false</code>.</p>
<p>Your PR is still a hair faster, but I&#x27;m not inclined to it since it spreads case analysis out too much. The likely cause of the performance difference is the additional function calls/copying when calling <code>Gitignore::empty</code> as opposed to just using <code>None</code>. One possible middle ground is to change <code>Gitignore</code> to be <code>pub struct Gitignore(Option&lt;GitignoreInner&gt;)</code> which would make the implementation of <code>Gitignore::empty()</code> equivalent to your PR without spreading out the case analysis. I&#x27;m not inclined to think it is worth it though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-04-24 15:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-04-24 15:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2018-04-24 15:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2018-04-24 17:52</div>
            <div class="timeline-body"><p>Very cool - thank you very much for looking into this!</p>
<p>I&#x27;ve run the benchmark again and see no significant difference between my PR and yours.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:17 UTC
    </footer>
</body>
</html>
