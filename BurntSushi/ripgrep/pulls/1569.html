<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ci: puts jemalloc allocator behind a cargo feature flag - BurntSushi/ripgrep #1569</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ci: puts jemalloc allocator behind a cargo feature flag</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/pull/1569">#1569</a>
        opened by <a href="https://github.com/jonstites">@jonstites</a>
        on 2020-05-06 13:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jonstites">@jonstites</a></div>
            <div class="timeline-body"><p>I have to say, thank you for making such incredibly nice, well-designed tools. I went through <code>ripgrep</code> and <code>xsv</code> a lot when I was first wrapping my head around Rust.</p>
<p>I saw an issue that I thought I could handle, so in an effort to be helpful, here it is.</p>
<p>This puts the jemalloc allocator behind a cargo feature as suggested here:
<a href="https://github.com/BurntSushi/ripgrep/issues/1542">BurntSushi/ripgrep#1542</a></p>
<p>The GitHub action for building releases appears to work:
https://github.com/jonstites/ripgrep/actions/runs/97156617</p>
<p>I did my best to make sensible choices, but I could be off the mark. Some thoughts:</p>
<ul>
<li>It might be confusing that there is a feature called &quot;jemalloc&quot; that doesn&#x27;t actually use jemalloc unless on x86 musl. Cargo does not yet fully support platform-specific features. The feature could be called &quot;jemalloc-musl-x86&quot; or it could actually try to use &quot;jemalloc&quot; for any target. But jemallocator doesn&#x27;t fully support all that many targets...</li>
<li>This changes the default allocator for x86_64-unknown-linux-musl. This might lead to a big performance hit for someone. The feature could instead be for disabling jemalloc.</li>
<li>I didn&#x27;t touch the build-deb file, partly because I don&#x27;t fully understand how .deb packaging works and partly because as best I can tell, jemalloc is disabled: https://salsa.debian.org/rust-team/debcargo-conf/-/blob/85f65b218cf86dbded7b66705617d3a5eb0b6a25/src/ripgrep/debian/patches/disable-jemallocator.diff</li>
</ul>
<p>PS I am not someone who would take it personally if you requested big changes or decided that this issue isn&#x27;t important enough for the added complexity. It&#x27;s your project and your call on the code!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-05-09 02:32</div>
            <div class="timeline-body"><p>Hmmm... Thanks so much for putting in the work for this! Actually seeing it done kind of makes me think it&#x27;s not worth doing. At minimum, I would probably either want to rename the <code>jemalloc</code> feature to <code>jemalloc-x86_64-musl</code> <em>or</em> cause the <code>jemalloc</code> feature to enable jemalloc regardless of the platform (even if it isn&#x27;t supported), like you suggested. But this does indeed lead to a case where building musl by default will now result in a slower ripgrep. I&#x27;m not quite sure how to mitigate that unfortunately. I think I would rather not have jemalloc configurable as a feature. :-( If disabling it ends up really being required, then I think just patching ripgrep is probably the best bet and is easy to do.</p>
<p>So thanks again for this, but I&#x27;m going to close this out for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2020-05-09 02:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hboetes">@hboetes</a> on 2020-09-23 15:09</div>
            <div class="timeline-body"><p>I just applied this patch to my git repo and it works like a charm. Finally can build static binaries. Please apply to master.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jameshilliard">@jameshilliard</a> on 2021-09-07 00:05</div>
            <div class="timeline-body"><blockquote>
<p>But this does indeed lead to a case where building musl by default will now result in a slower ripgrep.</p>
</blockquote>
<p>I think you can just set it as optional but enabled by default like <a href="https://doc.rust-lang.org/cargo/reference/features.html#the-default-feature">this</a> to fix that.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:18 UTC
    </footer>
</body>
</html>
