<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support .jj as well as .git - BurntSushi/ripgrep #2842</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Support .jj as well as .git</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/pull/2842">#2842</a>
        opened by <a href="https://github.com/fowles">@fowles</a>
        on 2024-06-22 10:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/fowles">@fowles</a></div>
            <div class="timeline-body"><ul>
<li>Allow <code>.jj</code> dirs to count as vcs directories.</li>
<li>Simplify the control flow around resolving info/exclude</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fowles">@fowles</a> on 2024-06-22 10:39</div>
            <div class="timeline-body"><p>I totally understand if you don&#x27;t want to expand things to support every oddball VCS, but so many tools I like (cargo watch, rg, fzf, fd) are all built on this common library that adding a bit of support at the core gets a lot of things to just work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fowles">@fowles</a> on 2024-07-02 21:03</div>
            <div class="timeline-body"><p>any chance I can get this considered?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-07-02 21:15</div>
            <div class="timeline-body"><p>I think my main concerns here are:</p>
<ol>
<li>I don&#x27;t even know what <code>.jj</code> is referring to. You didn&#x27;t give a link or explain anything.</li>
<li>This patch seems to assume that <code>.jj</code> and <code>.git</code> have identical semantics. Do they? There are literally no differences?</li>
<li>This doubles the number of stat calls for every directory ripgrep searches. This is a rather annoying hurdle because I don&#x27;t want this to be used as a bludgeon to forever fix ourselves to <code>git</code>. But at the same time, there is a cost here that needs to be weighed with the benefit.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fowles">@fowles</a> on 2024-07-02 21:19</div>
            <div class="timeline-body"><p>Sorry about the lack of link, that is my bad.  https://martinvonz.github.io/jj/latest/ is the best spot to read.  It is a version control system like git, so <code>.jj</code> is a directory that contains metadata for it (just like <code>.git</code>).</p>
<p>As an alternate suggestion, I would recommend respecting <code>.gitignore</code> files even when there is no <code>.git</code> directory.  Then you can cut the stat calls down from 1 to zero.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-07-02 21:52</div>
            <div class="timeline-body"><blockquote>
<p>As an alternate suggestion, I would recommend respecting <code>.gitignore</code> files even when there is no <code>.git</code> directory. Then you can cut the stat calls down from 1 to zero.</p>
</blockquote>
<p>That already exists today with <code>--no-require-git</code>. But vcs directory detection is in general required for correctness so that you don&#x27;t let gitignore files cross repository boundaries.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fowles">@fowles</a> on 2024-07-02 21:54</div>
            <div class="timeline-body"><p>The problem that I run into with <code>--no-require-git</code> is that every tool built on the library exposes it differently (and some don&#x27;t).  Is there a way to make that controlled via env variable or something?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-07-02 22:07</div>
            <div class="timeline-body"><p>No. I personally think that would be wildly inappropriate. <code>ignore</code> isn&#x27;t a &quot;standard,&quot; and trying to reach out into the environment in a library to do an end-runaround on the CLI interface just seems really bad to me. Like, there would, by construction, be no coupling between the environment variable and the CLI, which means there would be no way for <code>ignore</code> to know when to respect the environment variable versus some other option (which might override the environment variable). The only way to solve that would be to introduce more API machinery to deal with it. Sounds awful.</p>
<p>I&#x27;m not saying No to this PR, but it&#x27;s going to require that I or someone goes and understands <code>jj</code> to ensure this is implemented correctly. At minimum. And I&#x27;ll also need to make a judgment of whether the cost is worth it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fowles">@fowles</a> on 2024-07-03 16:54</div>
            <div class="timeline-body"><p>I checked with folks on the <code>jj</code> discord to make sure that I was getting all the corners.  I have updated the PR with that and also moved things around a tiny bit to minimize the number of stat calls as well as the number of allocations.</p>
<p>I absolutely understand that this is a judgement call on your end about complexity versus general utility.  If there is any data I can provide to make that case, I would be happy to try, but I recognize that <code>jj</code> is a niche VCS.  (I have hopes it will grow, but realistically I am not sure it will.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fowles">@fowles</a> on 2024-07-16 17:11</div>
            <div class="timeline-body"><p>Did you have a chance to come to a conclusion here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fowles">@fowles</a> on 2024-09-04 18:26</div>
            <div class="timeline-body"><p>Following up, I have verified this PR with <code>jj</code>&#x27;s owner (and I am also a committer on it).  So I think this is ready for review (pending your actual acceptance of the direction).</p>
<p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jaybosamiya">@jaybosamiya</a> on 2025-03-07 03:02</div>
            <div class="timeline-body"><p>Some musings:</p>
<p>Jujutsu is a neat VCS, and is <a href="https://jj-vcs.github.io/jj/latest/git-compatibility/">quite <code>git</code> compatible</a>. It has a lot of positives for it, and the biggest negative for it I&#x27;ve found in the past ~2 months I&#x27;ve been using it come from the (understandable, given it being relatively newer and more niche) lack of recognition of it by some tools, so I was considering making a PR to ripgrep to add support, and lo and behold, this PR already exists ❤️</p>
<p>As a quick note: <code>jj</code>&#x27;s only way (currently?) to ignore files is to use a <code>.gitignore</code> (<a href="https://jj-vcs.github.io/jj/latest/working-copy/#ignored-files">it even looks at <code>$GIT_DIR/info/exclude</code> as git would</a>), and while the <code>ignore</code> format is <em>itself</em> not a standard, I would be hard-pressed to accept that any tool that uses <code>.gitignore</code> (i.e., <em>with</em> the <code>git</code> in the file name) with a departure in semantics from what <code>git</code> already uses to not be considered a bug in the tool. Thus, I would expect <code>jj</code> to maintain the same semantics as <code>git</code> for their usage of <code>.gitignore</code>.</p>
<p>Personally, I was using ripgrep suboptimally for some time, because I wasn&#x27;t aware of <code>--no-require-git</code>, since at least as of ripgrep 14.1.1, it is not easy to realize that <code>.gitignore</code>s are ignored <em>unless</em> a <code>.git</code> exists. Obviously, once I found <code>--no-require-git</code> (via this PR, funnily), I took a gander through <code>rg --help</code>, and the only mention of the <code>.git</code> directory being necessary is in the <code>--no-require-git</code> option&#x27;s docs (which does mention the defaults). However, I wonder if people might be happier with the opposite default (I am somewhat biased here, so maybe I am not accounting for some other common use case where a <code>.gitignore</code> file should be ignored). I will note that literally the second line of <code>--help</code> states:</p>
<blockquote>
<p>By default, ripgrep will respect gitignore rules and automatically skip hidden files/directories and binary files.</p>
</blockquote>
<p>So I don&#x27;t think people would be annoyed by a default that respects gitignore rules (even if <code>.git</code> is absent).</p>
<p>If the flipped version becomes the default, then we would not need to double the number of <code>stat</code> calls (indeed, number of stat calls would <em>drop</em> for most people), at which point, we might actually be able to afford having some <code>--require-vcs git,jj,...</code>-style flag (again, this is just me musing) where the user is opting in for which VCSs they want the requirements checked, allowing for more stat calls (obviously, <code>--require-git</code> is already a flag right now, so more thought would be needed into such a future flag), but nonetheless, a flipped default would probably fix the issue, and not even need a <code>.jj/</code> check.</p>
<p>Sidenote: I now have <code>--no-require-git</code> as part of my CLI default for <code>rg</code> now; happy to report back if it&#x27;d help with (one person) anecdotal data if you find it useful.</p>
<p>Another alternative to consider: if a <code>.gitignore</code> file is found, but a <code>.git</code> is not, telling the user that <code>--no-require-git</code> exists could be nice. Clearly I am not the only one who missed that this option exists :)</p>
<hr>
<p>With all the above, I also want to add: I don&#x27;t want to increase maintainer burden, and I understand things like defaults are a hard decision. The existence of <code>--no-require-git</code> is great, and I am very glad that @BurntSushi you place such a laser focus on having a fast and awesome tool! :heart:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/devnoname120">@devnoname120</a> on 2025-03-17 23:57</div>
            <div class="timeline-body"><blockquote>
<p>So I don&#x27;t think people would be annoyed by a default that respects gitignore rules (even if .git is absent).</p>
</blockquote>
<p>That&#x27;s a problem for globally-defined <code>.gitignore</code>s that people tend to place in <code>~</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/strega-nil">@strega-nil</a> on 2025-03-29 13:11</div>
            <div class="timeline-body"><p>Ping on this, it would be awesome to get this in, although for now <code>--no-require-git</code> is a fine temporary solution :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ignore/src/dir.rs</code>:285 on 2025-03-29 13:29</div>
            <div class="timeline-body"><p>This is introducing an allocation in the common case where previously none existed. Maybe a <code>Cow&lt;Path&gt;</code> would help here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ignore/src/dir.rs</code>:290 on 2025-03-29 13:36</div>
            <div class="timeline-body"><p>I think this is my biggest concern by far here. I know that y&#x27;all are just looking for tooling to work, but from my perspective, I need to worry about the more expansive view. My understanding is that <code>jj</code> is still evolving, which makes me worry about whether this particular path is stable or not. If it gets changed, then all of a sudden every ripgrep version shipped out to users with this baked in is going to no longer work. Thankfully this would, I think, just impact <code>jj</code> users. But still, it&#x27;s non-ideal.</p>
<p>ripgrep does bake in similar sorts of assumptions about <code>git</code>, but that&#x27;s because <code>git</code> is &quot;stable&quot; software. If ripgrep would break because <code>git</code> changed something, then the <em>world</em> breaks. But that same sort of pressure isn&#x27;t there for <code>jj</code> yet.</p>
<p>I&#x27;m not really sure what to do here. Does the <code>jj</code> project have a commitment to stability for these kinds of things yet?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> requested changes on 2025-03-29 13:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-03-29 13:38</div>
            <div class="timeline-body"><p>And yes, there&#x27;s no way that <code>--no-require-git</code> is going to become a ripgrep default. That would allow gitignore files to cross pollinate into other repos. And nesting git repos inside other git repos is a very common pattern.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/fowles">@fowles</a> on <code>crates/ignore/src/dir.rs</code>:290 on 2025-03-29 19:37</div>
            <div class="timeline-body"><p>Speaking as a jj developer, this path has been stable for many years and I don&#x27;t think there is any reason we would change it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/fowles">@fowles</a> on <code>crates/ignore/src/dir.rs</code>:285 on 2025-03-29 20:11</div>
            <div class="timeline-body"><p>reworked to avoid the allocation (and also to cache it if it happens so the net result of this change reduces allocations).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/fowles">@fowles</a> reviewed on 2025-03-29 20:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/BurntSushi">@BurntSushi</a> by <a href="https://github.com/fowles">@fowles</a> on 2025-03-29 20:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/martinvonz">@martinvonz</a> reviewed on 2025-03-30 06:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/martinvonz">@martinvonz</a> on <code>crates/ignore/src/dir.rs</code>:290 on 2025-03-30 06:26</div>
            <div class="timeline-body"><p>I&#x27;m not aware of any plans to change the that path, but I&#x27;m still a bit reluctant to promise that that path won&#x27;t change. I wonder if just looking for <code>.jj/</code> is sufficient. Note that <code>.gitignore</code> is respected even if the jj repo is not using the Git backend. I think we would cover most cases by looking only for <code>.jj/</code>. The possible cases are:</p>
<ol>
<li>Colocated repos. This is when <code>.jj/</code> and <code>.git/</code> are siblings and <code>.jj/repo/store/git_target</code> points to that <code>.git/</code> directory.</li>
<li>Internal Git repo. This is when the Git repo lives in side <code>.jj/</code>, specifically at <code>.jj/repo/store/git</code>.</li>
<li>External Git repo. This is when the Git repo lives lives outside <code>.jj/</code> but not as its sibling. For example, you can have the ripgrep repo at <code>~/ripgrep</code> and a jj repo pointing to it from <code>~/ripgrep-jj</code>, so <code>~/ripgrep-jj/.jj/repo/store/git_target</code> points to <code>~/ripgrep/.git</code>.</li>
<li>Non-Git repo. This is when the there is no Git repo involved at all. Currently that only really happens at Google (Google has its own custom backends).</li>
</ol>
<p>Case 1 is covered by ripgrep&#x27;s current detection of the <code>.git/</code> directory. In all the other cases, there would normally still be a <code>.gitignore</code> in the working copy. The only thing we&#x27;d lose is that the <code>.git/info/exclude</code> would not be respected. I suspect it&#x27;s quite unusual that users add ignore patterns there, especially when they&#x27;re using a non-colocated setup. Note that jj respects your global gitignores too in all of the above cases, i.e. regardless of commit backend. (It depends on the <code>WorkingCopy</code> backend. We have an implementation at Google that doesn&#x27;t respect .gitignores at all. rigrep is largely impractical in that environment anyway.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/martinvonz">@martinvonz</a> reviewed on 2025-04-13 17:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/martinvonz">@martinvonz</a> on <code>crates/ignore/src/dir.rs</code>:290 on 2025-04-13 17:39</div>
            <div class="timeline-body"><p>So, to clarify, I would recommend just looking for <code>.jj/</code>. Let me know if you see a problem with that solution.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ignore/src/dir.rs</code>:290 on 2025-04-13 17:51</div>
            <div class="timeline-body"><p>I think that SGTM.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-04-13 17:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-04-13 17:52</div>
            <div class="timeline-body"><p>The next step here is for me to try this out and do some ad hoc perf testing to ensure the extra stat call isn&#x27;t too big of a perf hit. If it is, we can brainstorm how to mitigate it (or just accept it). My guess is that it will be acceptable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/fowles">@fowles</a> reviewed on 2025-04-13 20:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/fowles">@fowles</a> on <code>crates/ignore/src/dir.rs</code>:290 on 2025-04-13 20:47</div>
            <div class="timeline-body"><p>Awesome, I have simplified things to reflect that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ignore/src/dir.rs</code>:848 on 2025-07-12 16:16</div>
            <div class="timeline-body"><p>Are these changes necessary?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ignore/src/dir.rs</code>:297 on 2025-07-12 16:16</div>
            <div class="timeline-body"><p>Why don&#x27;t we need to also do <code>dir.join(&quot;.jj&quot;)</code> here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-07-12 16:17</div>
            <div class="timeline-body"><p>I&#x27;m unsure of how this patch is supposed to work. And it looks like there are unrelated changes here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-07-12 16:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ignore/src/dir.rs</code>:297 on 2025-07-12 16:19</div>
            <div class="timeline-body"><p>Oh I see, as @martinvonz said above, it looks like we are punting on handling clone-specific excludes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2025-07-12 16:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rollup</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-07-12 16:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/fowles">@fowles</a> on <code>crates/ignore/src/dir.rs</code>:848 on 2025-07-12 17:21</div>
            <div class="timeline-body"><p>You had expressed concern about number of allocations and these changes eliminate some extra allocations.  Happy to separate them to a different PR if you prefer</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/fowles">@fowles</a> reviewed on 2025-07-12 17:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-09-20 01:08</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:20 UTC
    </footer>
</body>
</html>
