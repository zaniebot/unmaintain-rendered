<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>fix: sorting nested results by system time - BurntSushi/ripgrep #2361</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>fix: sorting nested results by system time</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/pull/2361">#2361</a>
        opened by <a href="https://github.com/nguyenvukhang">@nguyenvukhang</a>
        on 2022-11-28 04:44
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/nguyenvukhang">@nguyenvukhang</a></div>
            <div class="timeline-body"><p>Bug is aptly described in <a href="https://github.com/BurntSushi/ripgrep/issues/2243">BurntSushi/ripgrep#2243</a>.</p>
<p>This PR aims to address this by delaying result sorting to after every match has been found.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/nguyenvukhang">@nguyenvukhang</a> on 2022-11-28 07:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/nguyenvukhang">@nguyenvukhang</a> on 2022-11-28 07:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;fix: nested results sorted wrongly&quot; to &quot;fix: sorting nested results by system time&quot; by <a href="https://github.com/nguyenvukhang">@nguyenvukhang</a> on 2022-11-28 15:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/core/args.rs</code>:361 on 2022-11-29 19:17</div>
            <div class="timeline-body"><p>So this isn&#x27;t really <code>unzip</code>. <code>unzip</code> is <code>Vec&lt;(K, V)&gt; -&gt; (Vec&lt;K&gt;, Vec&lt;V&gt;)</code>. And functions like this shouldn&#x27;t be marked as <code>#[inline]</code>: they are polymorphic so it will get inlined anyway. And even if it weren&#x27;t, the perf overhead of a function call in this context is negligible.</p>
<p>In any case, I would get rid of this function entirely. Instead, do:</p>
<pre><code>let items = match sorted.kind { ... };
items.into_iter().map(|v| v.1).collect()
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/core/main.rs</code>:108 on 2022-11-29 19:19</div>
            <div class="timeline-body"><p>This is a big no-no from what I can tell. It looks like you&#x27;re <em>unconditionally</em> collecting all paths before iterating over them even if no <code>--sort</code> flag is passed. That means you&#x27;re incurring the perf/memory/latency---at least in part---of sorting even when you don&#x27;t need to.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/core/main.rs</code>:258 on 2022-11-29 19:20</div>
            <div class="timeline-body"><p>Same deal here as for <code>search</code> above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> requested changes on 2022-11-29 19:23</div>
            <div class="timeline-body"><p>Nice work but yeah, there is a fair bit of work left here. The two big items:</p>
<ol>
<li>It is a hard requirement that if <code>--sort</code> is not given, then there should be no additional overhead here. But in this PR, it looks like you always collect all of the paths before starting a search. Today, ripgrep will start searching well before it finishes directory traversal.</li>
<li>There are a number of places where errors are being swallowed. We can&#x27;t do that.</li>
</ol>
<p>I&#x27;m also not sure about moving sorting to the <code>main</code> functions. I think it&#x27;s probably fine, although I was trying to keep the <code>main</code> functions as simple as I could. But if we are going to deal with sorting in <code>main.rs</code>, then I think it would be nice to add a short comment in the parallel searcher stating why it doesn&#x27;t handle sorting. (Because if sorting is enabled, then parallel searching is disabled in <code>args.rs</code>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nguyenvukhang">@nguyenvukhang</a> on 2022-11-30 11:21</div>
            <div class="timeline-body"><blockquote>
<ol>
<li>It is a hard requirement that if <code>--sort</code> is not given, then there should be no additional overhead here. But in this PR, it looks like you always collect all of the paths before starting a search. Today, ripgrep will start searching well before it finishes directory traversal.</li>
</ol>
</blockquote>
<p>Yep. Fixed it. Top-level <code>search()</code> and <code>files()</code> functions will now specifically check if a sort that requires calls to <code>stat</code> is required.</p>
<p>The latest implementation using new functions <code>continue_search()</code> and <code>continue_files()</code> is a result of trying to coerce the types of the two possible states of preliminary search results:</p>
<ol>
<li>uncollected and unconsumed iterator. (no sort)</li>
<li>collected, sorted, and re-made into an iterator.</li>
</ol>
<p>I&#x27;d prefer to stick to having just one function for <code>search</code> and <code>files</code> each, though I&#x27;m not sure if that&#x27;s possible.</p>
<blockquote>
<ol>
<li>There are a number of places where errors are being swallowed. We can&#x27;t do that.</li>
</ol>
</blockquote>
<p>Agreed. I noticed that the previously reviewed code swallowed the <code>Result&lt;Walk&gt;</code> that <code>args.walker()?</code> emitted, and that has been fixed.</p>
<p>https://github.com/BurntSushi/ripgrep/pull/2361#discussion_r1035183685 has also been addressed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/nguyenvukhang">@nguyenvukhang</a> on <code>crates/core/args.rs</code>:361 on 2022-11-30 11:24</div>
            <div class="timeline-body"><p>Yep, changed it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/nguyenvukhang">@nguyenvukhang</a> reviewed on 2022-11-30 11:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/nguyenvukhang">@nguyenvukhang</a> reviewed on 2022-11-30 11:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/nguyenvukhang">@nguyenvukhang</a> on <code>crates/core/main.rs</code>:108 on 2022-11-30 11:24</div>
            <div class="timeline-body"><p>resolved by <a href="https://github.com/BurntSushi/ripgrep/pull/2361">BurntSushi/ripgrep#2361</a>/commits/d4706913adf88cb3c6b395d0afcf493f39208169</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/nguyenvukhang">@nguyenvukhang</a> reviewed on 2022-11-30 11:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/nguyenvukhang">@nguyenvukhang</a> on <code>crates/core/main.rs</code>:258 on 2022-11-30 11:24</div>
            <div class="timeline-body"><p>also resolved by <a href="https://github.com/BurntSushi/ripgrep/pull/2361">BurntSushi/ripgrep#2361</a>/commits/d4706913adf88cb3c6b395d0afcf493f39208169</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/BurntSushi">@BurntSushi</a> by <a href="https://github.com/nguyenvukhang">@nguyenvukhang</a> on 2022-11-30 11:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-07-09 12:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ignore/src/walk.rs</code>:829 on 2023-07-09 12:13</div>
            <div class="timeline-body"><p>Why did you do this? It&#x27;s a breaking API change for the <code>ignore</code> crate. Same for <code>sort_by_file_name</code> below.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rollup</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-07-09 12:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/nguyenvukhang">@nguyenvukhang</a> reviewed on 2023-07-09 13:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/nguyenvukhang">@nguyenvukhang</a> on <code>crates/ignore/src/walk.rs</code>:829 on 2023-07-09 13:10</div>
            <div class="timeline-body"><p>Sorry about that, this change was not necessary. It&#x27;s been reverted by a8c3e89.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-07-09 13:29</div>
            <div class="timeline-body"><p>You&#x27;re all set. I already did the fixups needed to get this PR into shape. You can see it in #2555.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nguyenvukhang">@nguyenvukhang</a> on 2023-07-09 14:09</div>
            <div class="timeline-body"><p>I see. Thanks for patching up my tests and adding delays so the <code>stat</code> calls are correct.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-07-09 14:14</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:19 UTC
    </footer>
</body>
</html>
