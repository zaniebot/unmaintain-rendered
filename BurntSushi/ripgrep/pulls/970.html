<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improve zsh completion - BurntSushi/ripgrep #970</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Improve zsh completion</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/BurntSushi/ripgrep/pull/970">#970</a>
        opened by <a href="https://github.com/okdana">@okdana</a>
        on 2018-07-03 08:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/okdana">@okdana</a></div>
            <div class="timeline-body"><p>I'd been meaning to update this, and i think it's in a state now where it's much better than it was.</p>
<p>I propose that we give this a few days to sit before merging, just to make sure i haven't messed anything up (it is a decent number of lines changed). It's been working for me so far in zsh 5.3 and 5.5, though. If any zsh users watching the repo care to test, that would be pretty cool.</p>
<p>Full details:</p>
<ul>
<li><p>I've updated the function to use spec grouping with <code>_arguments</code>. This makes it so much easier (IMO) to read and maintain option exclusions. The down side is that grouping is only available in zsh 5.4+ (released in 2017); on older versions of zsh i simply strip the groups out. This makes option exclusivity pretty inaccurate on those older versions, but i think it's worth it — it's not like it breaks anything, it just continues to show options that might not be useful with options you've already supplied</p>
</li>
<li><p>I mentioned previously that i wasn't sure whether to complete rarely used 'negation' options like <code>--messages</code> and <code>--no-fixed-strings</code>. I decided i would complete them, but only if it seems like the user is specifically requesting them, or if they've enabled a style requesting that they always be completed. So if you do <code>rg --</code><kbd>Tab</kbd> you won't get the million <code>--no-whatever</code> options, but you will if you do <code>rg --n</code><kbd>Tab</kbd>. To be clear, this only affects the (mostly newer) options that were added solely to negate the effects of other options; stuff that's more generally useful like <code>--no-heading</code> and <code>--no-mmap</code> is still completed unconditionally</p>
</li>
<li><p>I've improved the accuracy of option exclusivity (for zsh 5.4+)</p>
</li>
<li><p>I've improved several option/optarg descriptions</p>
</li>
<li><p>I've improved completion of colour 'whens' (<code>always</code>, <code>never</code>, &amp;c.) — they now have descriptions</p>
</li>
<li><p>I've improved completion of colour specs, in particular the handling of the colons. This was the biggest irritation for me with previous iterations of the function tbh</p>
</li>
<li><p>I've removed some unnecessary work-arounds</p>
</li>
<li><p>I've generally replaced some uncommon/undesirable constructs by more idiomatic ones (<code>print</code>, quoting stuff, tag names, <code>ret</code> to support users with <code>prefix-needed</code> off, &amp;c.)</p>
</li>
</ul>
<p>ETA: The CI script failed on some of the AppVeyor platforms because they had an older version of zsh than i expected. Hopefully fixed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2018-07-03 10:45</div>
            <div class="timeline-body"><p>Lovely! This all looks good to me. Thank you for improving auto complete support in zsh!</p>
<p>I'll let this bake for a bit as requested. Ping me if I forget about it. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/okdana">@okdana</a> on 2018-07-06 04:23</div>
            <div class="timeline-body"><p>I found two or three trivial wording choices that i didn't like, but otherwise i guess this is as OK as it'll get for now. Rebased my subsequent fixes, ready to merge whenever you like.</p>
<p>As i was messing with it, though, i noticed that the interaction amongst <code>--heading</code>, <code>--passthru</code>, <code>--pretty</code>, and <code>--vimgrep</code> is a little weird. In the completion function i've made <code>--vimgrep</code> exclusive with each of the other options i mentioned, but <code>rg</code> itself doesn't treat them that way. Instead:</p>
<ul>
<li><p><code>--heading</code> and <code>--pretty</code> are just ignored. Probably these should override the colour/heading settings as appropriate, depending on the order they're given in, yeah?</p>
</li>
<li><p><code>--passthru</code> <em>kind of</em> works, but for some reason it produces a match for the last column of every line in addition to the (expected) first column. Even though it doesn't seem very useful, i think allowing <code>--passthru</code> + <code>--vimgrep</code> should be OK if not for that last-column weirdness. I didn't actually look to see what causes that. But we could just make them conflict, too, if you don't think it's a valid use case.</p>
</li>
</ul>
<p>Let me know how you feel and i'll do another PR for those.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-07-06 14:22</div>
            <div class="timeline-body"><p>@okdana Thanks for doing this! As to your questions... They are good ones. My feeling is that the interaction between <code>--vimgrep</code> and <code>--passthru</code> will <em>probably</em> be fixed in libripgrep (I haven't investigated, but it could be related to #441 and/or #690).</p>
<p>As for <code>--heading</code> and <code>--pretty</code>... They seem like conflicting options to me. I guess in my mind <code>--vimgrep</code> always intended to match a specific format to be read by vim itself, and options like <code>--heading</code> and <code>--pretty</code> kind of negate that. But yeah, maybe they should just work since it seems like there exists sensible behavior there.</p>
<p>In the course of working on libripgrep, I'm going to try and revisit the interactions between flags because it's going to get worse with the rise of support for additional output formats (thinking Ackmate and JSON lines). So I guess I'd say sit tight for now and we can try to knock out all that weirdness in one swoop.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2018-07-06 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2018-07-06 14:23</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 18:28:03 UTC
    </footer>
</body>
</html>
