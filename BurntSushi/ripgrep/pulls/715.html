<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add armhf build to Travis CI - BurntSushi/ripgrep #715</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add armhf build to Travis CI</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/BurntSushi/ripgrep/pull/715">#715</a>
        opened by <a href="https://github.com/lilianmoraru">@lilianmoraru</a>
        on 2017-12-17 14:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/lilianmoraru">@lilianmoraru</a></div>
            <div class="timeline-body"><p>The purpose of this is so that <code>ripgrep</code> will create the &quot;release&quot; binary for the most popular ARM target - but I did not manage to test if the binary is correctly pushed to the &quot;releases&quot; page...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lilianmoraru">@lilianmoraru</a> on 2017-12-17 16:07</div>
            <div class="timeline-body"><p>While trying to make sure that ARM tests are not run in the CI, I observed that <code>cargo clean</code> was being run only on <code>ripgrep</code> and not on all the subprojects(in <code>run_test_suite()</code>) - while analyzing if this is ok, I observed that every subproject gets its own <code>target</code> directory which means that these don't share dependencies.</p>
<p>Using cargo workspaces here should improve the build speed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/okdana">@okdana</a> reviewed on 2017-12-17 19:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/okdana">@okdana</a> on <code>ci/utils.sh</code>:58 on 2017-12-17 19:36</div>
            <div class="timeline-body"><p>Having a shell function return <code>1</code> on success/true and <code>0</code> on failure/false is pretty unorthodox. Also there's a lot of unnecessary forking here. It doesn't really matter, it's not like it's performance-critical or anything, but (in the spirit of some of your other changes) it would probably be more idiomatic to do something like this:</p>
<pre><code class="language-sh">case &quot;${TARGET}&quot; in
  i686-unknown-netbsd) return 1 ;;
  i686*|x86_64*)       return 0 ;;
esac
return 1
</code></pre>
<p>Then you can use it like:</p>
<pre><code class="language-sh">if is_ssse3_target; then
  # do SSSE3 stuff
else
  # do not-SSSE3 stuff
fi
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/okdana">@okdana</a> reviewed on 2017-12-17 19:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/okdana">@okdana</a> on <code>ci/before_deploy.sh</code>:10 on 2017-12-17 19:38</div>
            <div class="timeline-body"><p>Related to my other comment: I don't believe this construction will work reliably anyway â€” if <code>is_ssse3_target</code> returns <code>1</code> here, it will cause the script to bail because of <code>set -e</code>. The effect of <code>set -e</code> needs to be suppressed by putting it in the <code>if</code> condition (or using <code>||</code> or <code>&amp;&amp;</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/lilianmoraru">@lilianmoraru</a> reviewed on 2017-12-17 21:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/lilianmoraru">@lilianmoraru</a> on <code>ci/utils.sh</code>:58 on 2017-12-17 21:53</div>
            <div class="timeline-body"><blockquote>
<p>Having a shell function return 1 on success/true and 0 on failure/false is pretty unorthodox.</p>
</blockquote>
<p>That's what I thought too but then decided to make it more traditional programming languages-like... :)
Good point though and I will change it.</p>
<p>Btw, I used <code>$?</code> because I tried to do:</p>
<pre><code class="language-sh">is_ssse3_target() { return 0; }
test is_ssse3_target &amp;&amp; echo &quot;TRUE&quot; || echo &quot;FALSE&quot;
</code></pre>
<p>And this would not work, but I see that this works:</p>
<pre><code class="language-sh">if is_ssse3_target; then echo &quot;TRUE&quot;; else echo &quot;FALSE&quot;; fi
</code></pre>
<p>The alternative was to not use early-return and just <code>echo true/false</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>ci/script.sh</code>:31 on 2017-12-18 13:21</div>
            <div class="timeline-body"><p>Does this mean we aren't running tests on arm? Why?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>ci/utils.sh</code>:59 on 2017-12-18 13:22</div>
            <div class="timeline-body"><p>I think you can just remove this comment. As @okdana said, <code>1</code> for <code>false</code> is standard in shell scripts.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2017-12-18 13:23</div>
            <div class="timeline-body"><p>Thanks for doing this! I'm willing to give this a go, but as I mentioned in #676, my ability to maintain this is not set in stone. If it causes headaches, then I'll like just remove it.</p>
<p>Also, could you add <code>Fixes #676</code> to the bottom of your commit message on its own line? Thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-12-18 13:24</div>
            <div class="timeline-body"><p>Also, thanks for the tip about workspaces. I will do it soon.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/lilianmoraru">@lilianmoraru</a> reviewed on 2017-12-18 19:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/lilianmoraru">@lilianmoraru</a> on <code>ci/script.sh</code>:31 on 2017-12-18 19:37</div>
            <div class="timeline-body"><p>In order to run the tests on ARM, you would need to setup <code>qemu</code> inside the Travis CI.
This is doable(I've seen it done somewhere) but I don't currently have the knowledge(nor would I like to hold this PR for that) to easily add this feature.</p>
<p>It would definitely add overhead - you would probably need to limit it to run only when preparing a release or something like this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lilianmoraru">@lilianmoraru</a> on 2017-12-18 19:52</div>
            <div class="timeline-body"><blockquote>
<p>Also, thanks for the tip about workspaces. I will do it soon.</p>
</blockquote>
<p>The thing is almost a one-liner(works on <code>1.17</code>):</p>
<pre><code>[workspace]
members = [ &quot;grep&quot;, &quot;globset&quot;, &quot;ignore&quot;, &quot;termcolor&quot;, &quot;wincolor&quot; ]
</code></pre>
<p>But you need to remove <code>[profile.release]</code> from <code>ignore</code>.</p>
<p>For the full &quot;Win&quot;, if all the packages would have the same versions of the dependencies than you would have full re-use.</p>
<p>At some point the CI should also be switched to use <code>cargo build --all</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lilianmoraru">@lilianmoraru</a> on 2017-12-18 20:02</div>
            <div class="timeline-body"><p>Does not seem complicated: https://github.com/PJK/libcbor/blob/master/.travis-qemu.sh
Edit, or this: http://blog.kragniz.eu/raspbian-on-travis-ci/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lilianmoraru">@lilianmoraru</a> on 2017-12-18 20:39</div>
            <div class="timeline-body"><p>I pushed another change:
Installing specifically <code>gcc-4.8-arm-linux-gnueabihf</code> because if Travis moves to <code>Ubuntu 16.04</code> at some point, <code>gcc-arm-linux-gnueabihf</code> would become <code>GCC 5.3</code>, which would be incompatible with RPI's <code>GCC 4.9</code>(glibc API/ABI).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2017-12-18 21:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>ci/script.sh</code>:31 on 2017-12-18 21:25</div>
            <div class="timeline-body"><p>Oh I see, I understand. Thanks for explaining that to me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2017-12-18 21:26</div>
            <div class="timeline-body"><p>All right, let's do this. I'll try to keep a close eye on this during the next release.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2017-12-18 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2017-12-18 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lilianmoraru">@lilianmoraru</a> on 2017-12-18 21:45</div>
            <div class="timeline-body"><p>@BurntSushi Speaking of overhead. What's your opinion on removing the <code>cargo clean</code> step?
I have not yet encountered problems with incremental compilation unless you are building a C/C++ application through <code>build.rs</code>(which <code>ripgrep</code> doesn't).
That would allow to ask Travis to cache the <code>target</code> directory and have considerably better build speeds.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-12-18 21:56</div>
            <div class="timeline-body"><p>@lilianmoraru It sounds fine to me. I doubt there is any strong reason for it to be there now. It's probably there because I copied it from somewhere else, and it was probably there because I was debugging something and just didn't remove it. :)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 18:27:56 UTC
    </footer>
</body>
</html>
