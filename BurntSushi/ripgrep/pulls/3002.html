<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add tests for binary file detection when using memory maps - BurntSushi/ripgrep #3002</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add tests for binary file detection when using memory maps</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/pull/3002">#3002</a>
        opened by <a href="https://github.com/Erio-Harrison">@Erio-Harrison</a>
        on 2025-02-27 11:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Erio-Harrison">@Erio-Harrison</a></div>
            <div class="timeline-body"><p>The original code contained a TODO comment to add tests for binary file detection
when using memory maps. This PR implements those tests, noting the differences
between mmap and no-mmap behavior regarding binary detection.</p>
<p>The tests show that with memory maps:</p>
<ul>
<li>NUL bytes are only searched for in the first few KB and in matches</li>
<li>Explicit file paths behave differently than glob patterns</li>
<li>Matches can appear both before and after NUL bytes</li>
<li>Binary detection is more permissive with memory maps</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>tests/binary.rs</code>:44 on 2025-08-17 20:17</div>
            <div class="timeline-body"><p>This wasn&#x27;t quite right. This test doesn&#x27;t use memory maps. When you use the <code>-g</code> flag without an explicit file path, that puts ripgrep in recursive search mode. In that mode, ripgrep generally never uses memory maps.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>tests/binary.rs</code>:79 on 2025-08-17 20:19</div>
            <div class="timeline-body"><p>I think this test would be more effective if it also included a pattern that matched after the NUL byte.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>tests/binary.rs</code>:104 on 2025-08-17 20:23</div>
            <div class="timeline-body"><p>This test doesn&#x27;t check what is written in the comments. Memory maps aren&#x27;t used here. You can force it by adding the <code>--mmap</code> flag. Indeed, when memory maps are used here, the result changes!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>tests/binary.rs</code>:118 on 2025-08-17 20:23</div>
            <div class="timeline-body"><p>This test includes matches after <strong>and before</strong> the NUL byte.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-08-17 20:24</div>
            <div class="timeline-body"><p>Thanks! I&#x27;ve left feedback, but please don&#x27;t work on it. I&#x27;ve already resolved the feedback in my rollup branch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rollup</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-08-17 20:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Erio-Harrison">@Erio-Harrison</a> on 2025-08-18 01:06</div>
            <div class="timeline-body"><blockquote>
<p>Thanks! I&#x27;ve left feedback, but please don&#x27;t work on it. I&#x27;ve already resolved the feedback in my rollup branch.</p>
</blockquote>
<p>That&#x27;s cool! Thank you for your work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/Erio-Harrison">@Erio-Harrison</a> on 2025-08-18 01:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:20 UTC
    </footer>
</body>
</html>
