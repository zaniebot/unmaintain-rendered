<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Files with matches - BurntSushi/ripgrep #42</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Files with matches</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/BurntSushi/ripgrep/pull/42">#42</a>
        opened by <a href="https://github.com/andyleejordan">@andyleejordan</a>
        on 2016-09-24 03:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/andyleejordan">@andyleejordan</a></div>
            <div class="timeline-body"><p>Resolves #26 (or at least starts to).</p>
<ul>
<li>[x] Needs tests</li>
<li>[x] Needs docs</li>
<li>[x] Needs to terminate the search at the first match</li>
<li>[ ] Needs to be refactored after a review</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andyleejordan">@andyleejordan</a> on 2016-09-24 03:26</div>
            <div class="timeline-body"><p>@BurntSushi So I <em>think</em>, if I&#x27;m understanding this code correctly, to terminate early for mmap searching I could just break out of</p>
<pre><code>        for m in self.grep.iter(self.buf) {
            if self.opts.invert_match {
                self.print_inverted_matches(last_end, m.start());
            } else {
                self.print_match(m.start(), m.end());
            }
            last_end = m.end();
        }
</code></pre>
<p>t the first match. Is this loop &quot;for matches in lazy iter&quot;? I could use some pointers for sure ðŸ˜‰ (pun totally intended).</p>
<p>For now I&#x27;m going to eat some dinner and get to those video games, but this was fun!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-24 03:50</div>
            <div class="timeline-body"><blockquote>
<p>Is this loop &quot;for matches in lazy iter&quot;? I could use some pointers for sure :wink: (pun totally intended).</p>
</blockquote>
<p>You got it, that&#x27;s right. Breaking out of that loop is perfect.</p>
<p>Note that you&#x27;ll also need to do this in <code>search_stream.rs</code>, which is a little less nice.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-24 03:50</div>
            <div class="timeline-body"><p>@andschwa Thanks for working on this by the way! Enjoy the video games. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/andyleejordan">@andyleejordan</a> on <code>src/search_stream.rs</code> on 2016-09-25 00:29</div>
            <div class="timeline-body"><p>@BurntSushi in my experimentation, this seemed to work correctly to terminate after one match. However, I expected to be able to just break at the first match further down in the loop... but when I tried that I found that the match_count was &gt; 1 at the top of the loop, which was unexpected. I&#x27;m missing something.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/andyleejordan">@andyleejordan</a> reviewed on 2016-09-25 00:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/andyleejordan">@andyleejordan</a> on <code>src/search_stream.rs</code> on 2016-09-25 00:31</div>
            <div class="timeline-body"><p>@BurntSushi I think it might not be a bad refactor to add an <code>opts.just_file = self.opts.count || self.opts.files_with_matches</code>, which can replace four instances of this or statement; eh?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/andyleejordan">@andyleejordan</a> reviewed on 2016-09-25 00:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2016-09-25 00:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>src/search_stream.rs</code> on 2016-09-25 00:35</div>
            <div class="timeline-body"><p><code>match_count</code> could increase by more than than you might expect if you&#x27;re doing <code>inverted</code> matching. For regular searching, <code>match_count</code> should only be incremented by <code>1</code> at most on each iteration.</p>
<p>I would probably move this check to right after the call to <code>read_match</code>. i.e., <code>if self.opts.files_with_matches &amp;&amp; matched { break; }</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2016-09-25 00:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>src/search_stream.rs</code> on 2016-09-25 00:37</div>
            <div class="timeline-body"><p>That&#x27;s fine, but I wouldn&#x27;t add a new field. I&#x27;d just add a method on the <code>Options</code> struct. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/andyleejordan">@andyleejordan</a> reviewed on 2016-09-25 00:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/andyleejordan">@andyleejordan</a> on <code>src/search_stream.rs</code> on 2016-09-25 00:46</div>
            <div class="timeline-body"><p>It can&#x27;t be <em>right</em> after it because the first match needs to be handled. But what&#x27;s odd is that if I put it at the end of the while loop, I get this:</p>
<pre><code>loop {
            println!(&quot;{:?} {}&quot;, self.path, self.match_count);
...
while ... {
...
        if self.opts.files_with_matches &amp;&amp; matched {
            break;
        }
    }
}
</code></pre>
<pre><code>&quot;src/args.rs&quot; 1
&quot;src/args.rs&quot; 2
&quot;src/args.rs&quot; 3
&quot;src/args.rs&quot; 3
</code></pre>
<p>I think I have to break out of both loops maybe.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2016-09-25 01:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>src/search_stream.rs</code> on 2016-09-25 01:02</div>
            <div class="timeline-body"><p>Oh, yes, indeed you do. The outer loop corresponds to refilling the buffer with data from the file and the inner loop corresponds to iterating over all matches within that buffer. Breaking out of the inner loop won&#x27;t cause the outer loop to stop.</p>
<p>You might consider changing <code>loop</code> to <code>while !self.opts.files_with_matches || self.match_count == 0</code> or something similar. (With the case unfortunately repeated inside the <code>while</code> loop as well.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/andyleejordan">@andyleejordan</a> reviewed on 2016-09-25 01:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/andyleejordan">@andyleejordan</a> on <code>src/search_stream.rs</code> on 2016-09-25 01:20</div>
            <div class="timeline-body"><p>Added a small <code>terminate()</code> function; it&#x27;s working just grand.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/andyleejordan">@andyleejordan</a> reviewed on 2016-09-25 01:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/andyleejordan">@andyleejordan</a> on <code>src/search_stream.rs</code> on 2016-09-25 01:20</div>
            <div class="timeline-body"><p>Added <code>opts.skip_matches()</code>, definitely feels better.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andyleejordan">@andyleejordan</a> on 2016-09-25 01:21</div>
            <div class="timeline-body"><p>Just FYI I&#x27;m already using this; I wanted to rename a function I&#x27;d plumbed through:</p>
<pre><code>./target/debug/rg -l just_file | xargs gsed -i &#x27;s/just_file/skip_matches/g&#x27;
</code></pre>
<p>ðŸŽ‰</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andyleejordan">@andyleejordan</a> on 2016-09-25 02:27</div>
            <div class="timeline-body"><p>So either <code>--invert-match</code> or there&#x27;s a bug: when I combine it with <code>--count</code> (i.e. without these changes), I still get files that have matches listed (is this expected?). So I&#x27;ve removed <code>--files-without-match</code> as I was using the same logic and so had the same bug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andyleejordan">@andyleejordan</a> on 2016-09-25 02:49</div>
            <div class="timeline-body"><p>@BurntSushi okay this is ready for review!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andyleejordan">@andyleejordan</a> on 2016-09-25 03:03</div>
            <div class="timeline-body"><p>Hm my test failures are due to a few runners swapping the order in which the output was written.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-25 03:04</div>
            <div class="timeline-body"><p>Run with -j1.</p>
<p>On Sep 24, 2016 11:03 PM, &quot;Andrew Schwartzmeyer&quot; notifications@github.com
wrote:</p>
<blockquote>
<p>Hm my test failures are due to a few runners swapping the order in which
the output was written.</p>
<p>â€”
You are receiving this because you were mentioned.
Reply to this email directly, view it on GitHub
<a href="https://github.com/BurntSushi/ripgrep/pull/42">BurntSushi/ripgrep#42</a>#issuecomment-249399707,
or mute the thread
https://github.com/notifications/unsubscribe-auth/AAb34gPWaSfGYAvmqG4HeVpcGLS2ZWeCks5qteSbgaJpZM4KFiaJ
.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andyleejordan">@andyleejordan</a> on 2016-09-25 03:23</div>
            <div class="timeline-body"><p>Sadly, while <code>-j1</code> does make it deterministic, it does not account for ordering being different across platforms, which caused most of the failures in <a href="https://travis-ci.org/BurntSushi/ripgrep/builds/162517709">build #168</a> (although a couple failed with very odd panics on tests these changes didn&#x27;t touch).</p>
<p>Since I don&#x27;t actually need to test with multiple files... I&#x27;m going the simpler route and just testing with <code>sherlock</code>. Slightly less robust; much less prone to pointless failure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-25 03:25</div>
            <div class="timeline-body"><p>Sounds good to me!</p>
<p>On Sep 24, 2016 11:23 PM, &quot;Andrew Schwartzmeyer&quot; notifications@github.com
wrote:</p>
<blockquote>
<p>Sadly, while -j1 does make it deterministic, it does not account for
ordering being different across platforms, which caused most of the
failures in build #168
https://travis-ci.org/BurntSushi/ripgrep/builds/162517709 (although a
couple failed with very odd panics on tests these changes didn&#x27;t touch).</p>
<p>Since I don&#x27;t actually need to test with multiple files... I&#x27;m going the
simpler route and just testing with sherlock. Slightly less robust; much
less prone to pointless failure.</p>
<p>â€”
You are receiving this because you were mentioned.
Reply to this email directly, view it on GitHub
<a href="https://github.com/BurntSushi/ripgrep/pull/42">BurntSushi/ripgrep#42</a>#issuecomment-249400293,
or mute the thread
https://github.com/notifications/unsubscribe-auth/AAb34jSjzwepbCSJGJynrRbxvbC6diNOks5qtelCgaJpZM4KFiaJ
.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andyleejordan">@andyleejordan</a> on 2016-09-25 03:48</div>
            <div class="timeline-body"><p>So, this is admittedly strange, but Travis CI appears to be caching the built targets (and so left around my created test file <code>file</code> from <a href="https://travis-ci.org/BurntSushi/ripgrep/builds/162517709">build #168</a> on the next run <a href="https://travis-ci.org/BurntSushi/ripgrep/builds/162518787">build #169</a>, which didn&#x27;t expect it), causing failures. This appears to be what&#x27;s happening though because when I added a <code>cargo clean</code> to the CI scripts, they&#x27;re all now passing <a href="https://travis-ci.org/BurntSushi/ripgrep/builds/162519607">build #170</a>. I can squash that into this commit if you agree.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-25 04:21</div>
            <div class="timeline-body"><p>That&#x27;s fine sure, although I haven&#x27;t seen that happen before!</p>
<p>On Sep 24, 2016 11:48 PM, &quot;Andrew Schwartzmeyer&quot; notifications@github.com
wrote:</p>
<blockquote>
<p>So, this is admittedly strange, but Travis CI appears to be caching the
built targets (and so left around my created test file file from build
#168 https://travis-ci.org/BurntSushi/ripgrep/builds/162517709 on the
next run build #169
https://travis-ci.org/BurntSushi/ripgrep/builds/162518787, which didn&#x27;t
expect it), causing failures. This appears to be what&#x27;s happening though
because when I added a cargo clean to the CI scripts, they&#x27;re all now
passing build #170
https://travis-ci.org/BurntSushi/ripgrep/builds/162519607. I can squash
that into this commit if you agree.</p>
<p>â€”
You are receiving this because you were mentioned.
Reply to this email directly, view it on GitHub
<a href="https://github.com/BurntSushi/ripgrep/pull/42">BurntSushi/ripgrep#42</a>#issuecomment-249401017,
or mute the thread
https://github.com/notifications/unsubscribe-auth/AAb34ncj9yfag16hKbsOupFKj9EEQO0Qks5qte8dgaJpZM4KFiaJ
.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-25 18:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-25 18:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-09-25 18:53</div>
            <div class="timeline-body"><p>I just reviewed it and this is high quality work. Thank you so much. :-)</p>
<p>Your code refactoring is also going to help fix #77. Yay!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2016-09-25 19:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andyleejordan">@andyleejordan</a> on 2016-09-25 19:31</div>
            <div class="timeline-body"><p>Thank you! I really wanted this feature, and missed programming in Rust a lot. Cheers!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:15 UTC
    </footer>
</body>
</html>
