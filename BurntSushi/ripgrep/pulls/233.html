<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Switch from Docopt to Clap. - BurntSushi/ripgrep #233</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Switch from Docopt to Clap.</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/BurntSushi/ripgrep/pull/233">#233</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2016-11-13 02:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>There were two important reasons for the switch:</p>
<ol>
<li>Performance. Docopt does poorly when the argv becomes large, which is
a reasonable common use case for search tools. (e.g., use with xargs)</li>
<li>Better failure modes. Clap knows a lot more about how a particular
argv might be invalid, and can therefore provide much clearer error
messages.</li>
</ol>
<p>While both were important, (1) made it urgent.</p>
<p>Note that since Clap requires at least Rust 1.11, this will in turn
increase the minimum Rust version supported by ripgrep from Rust 1.9 to
Rust 1.11. It is therefore a breaking change, so the soonest release of
ripgrep with Clap will have to be 0.3.</p>
<p>There is also at least one subtle breaking change in real usage.
Previous to this commit, this used to work:</p>
<pre><code>rg -e -foo</code></pre>
<p>Where this would cause ripgrep to search for the string <code>-foo</code>. Clap
currently has problems supporting this use case
(see: <a href="https://github.com/kbknapp/clap-rs/issues/742">kbknapp/clap-rs#742</a>),
but it can be worked around by using this instead:</p>
<pre><code>rg -e [-]foo</code></pre>
<p>or even</p>
<pre><code>rg [-]foo</code></pre>
<p>and this still works:</p>
<pre><code>rg -- -foo</code></pre>
<p>This commit also adds Bash, Fish and PowerShell completion files to the
release, fixes a bug that prevented ripgrep from working on file
paths containing invalid UTF-8 and shows short descriptions in the
output of <code>-h</code> but longer descriptions in the output of <code>--help</code>.</p>
<p>Fixes #136, #189, #210, #230</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-11-13 02:46</div>
            <div class="timeline-body"><p>cc @kbknapp</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-11-14 23:47</div>
            <div class="timeline-body"><p>I&#x27;m on mobile right now so I still want to read through this in more detail but it looks good so far! And I really, really like some of the things you did that I haven&#x27;t thought of doing!</p>
<p>I&#x27;ll update here once kbknapp/clap-rs#742 has been implemented.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-11-14 23:47</div>
            <div class="timeline-body"><p>@kbknapp Thanks! I was hoping you&#x27;d take a peek. ^_^</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-11-18 01:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-11-18 01:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2016-11-18 01:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-11-18 01:22</div>
            <div class="timeline-body"><p>Woohoo! @kbknapp Thanks for clap! ^_^</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kbknapp">@kbknapp</a> on 2016-11-21 04:09</div>
            <div class="timeline-body"><p>@BurntSushi I saw you already noticed kbknapp/clap-rs#755 but this should address a few of the items you mentioned. For the use of a hyphen in specific option and not command wide there are plenty of edge cases that don&#x27;t have 100% solutions (i.e. many people may want many different things). So I&#x27;ve implemented what I think to be the 95% solution.</p>
<p>Namely, edge cases arise when one of two things happen,</p>
<ul>
<li>The option in question accepts multiple values</li>
<li>The value the user wishes to supply partially or fully matches a valid flag</li>
</ul>
<p>For the primary edge case example, assume <code>-e PAT...</code> where <code>PAT</code> can start with a hyphen. Also assume <code>-v</code>, <code>-a</code>, and <code>-l</code> are all valid short flags. Using <code>-e valid_pattern -val</code> can cause ambiguities. This can be solved by forcing <code>-e</code> to accept only value at a time <code>Arg::number_of_values(1)</code> and <code>Arg::multiple(true)</code>. This allows <code>-e PAT -e PAT</code> but disallows <code>-e PAT PAT</code>.</p>
<p>So there are workarounds, I just wanted to ensure you&#x27;re aware some testing may be required :wink:</p>
<p>Also the ZSH completions should be fixed for you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2016-11-21 11:50</div>
            <div class="timeline-body"><p>@kbknapp Ah that sounds perfect! I think I&#x27;ve banned all uses of <code>--flag val1 val2</code> anyway since it feels incredibly non-standard to me. :-) Thanks so much for the quick turnaround!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:15 UTC
    </footer>
</body>
</html>
