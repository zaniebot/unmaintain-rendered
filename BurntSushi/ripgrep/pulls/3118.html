<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>fix: exit code for -q --files-without-match combination - BurntSushi/ripgrep #3118</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>fix: exit code for -q --files-without-match combination</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/pull/3118">#3118</a>
        opened by <a href="https://github.com/wislertt">@wislertt</a>
        on 2025-08-02 14:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/wislertt">@wislertt</a></div>
            <div class="timeline-body"><p>This is to resolve issue #3108</p>
<p>Exit codes were inverted when using -q with --files-without-match. Quiet mode was overriding the search mode logic.</p>
<p>Before:</p>
<pre><code>echo &quot;haystack ......&quot; | rg -q --files-without-match needle # returned 1 ❌
echo &quot;haystack needle&quot; | rg -q --files-without-match needle # returned 0 ❌
</code></pre>
<p>After:</p>
<pre><code>echo &quot;haystack ......&quot; | rg -q --files-without-match needle # returns 0 ✅
echo &quot;haystack needle&quot; | rg -q --files-without-match needle # returns 1 ✅
</code></pre>
<p>Fix: Don&#x27;t let quiet mode override FilesWithoutMatch summary kind.</p>
<p>One line change in hiargs.rs printer logic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-08-20 00:56</div>
            <div class="timeline-body"><p>This change is bunk unfortunately. ripgrep&#x27;s test suite doesn&#x27;t check that <code>-q --files-without-match</code> emits nothing on stdout, but this patch makes it... not be quiet any more.</p>
<p>The problem is that the summary printer doesn&#x27;t distinguish &quot;quiet&quot; mode with &quot;quiet inverted match&quot; mode. This is an API design bug in ripgrep&#x27;s internal libraries. Sigh.</p>
<p>Nice find though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-08-20 00:56</div>
            <div class="timeline-body"><p>Specifically, with this PR, this test fails:</p>
<pre><code>// See: <a href="https://github.com/BurntSushi/ripgrep/issues/3108">BurntSushi/ripgrep#3108</a>
rgtest!(r3108_files_without_match_quiet_exit, |dir: Dir, _: TestCommand| {
    dir.create(&quot;yes-match&quot;, &quot;abc&quot;);
    dir.create(&quot;non-match&quot;, &quot;xyz&quot;);

    dir.command().args(&amp;[&quot;-q&quot;, &quot;abc&quot;, &quot;non-match&quot;]).assert_exit_code(1);
    dir.command().args(&amp;[&quot;-q&quot;, &quot;abc&quot;, &quot;yes-match&quot;]).assert_exit_code(0);
    dir.command()
        .args(&amp;[&quot;--files-with-matches&quot;, &quot;-q&quot;, &quot;abc&quot;, &quot;non-match&quot;])
        .assert_exit_code(1);
    dir.command()
        .args(&amp;[&quot;--files-with-matches&quot;, &quot;-q&quot;, &quot;abc&quot;, &quot;yes-match&quot;])
        .assert_exit_code(0);

    dir.command()
        .args(&amp;[&quot;--files-without-match&quot;, &quot;abc&quot;, &quot;non-match&quot;])
        .assert_exit_code(0);
    dir.command()
        .args(&amp;[&quot;--files-without-match&quot;, &quot;abc&quot;, &quot;yes-match&quot;])
        .assert_exit_code(1);

    let got = dir
        .command()
        .args(&amp;[&quot;--files-without-match&quot;, &quot;abc&quot;, &quot;non-match&quot;])
        .stdout();
    eqnice!(&quot;non-match\n&quot;, got);

    dir.command()
        .args(&amp;[&quot;--files-without-match&quot;, &quot;-q&quot;, &quot;abc&quot;, &quot;non-match&quot;])
        .assert_exit_code(0);
    dir.command()
        .args(&amp;[&quot;--files-without-match&quot;, &quot;-q&quot;, &quot;abc&quot;, &quot;yes-match&quot;])
        .assert_exit_code(1);

    let got = dir
        .command()
        .args(&amp;[&quot;--files-without-match&quot;, &quot;-q&quot;, &quot;abc&quot;, &quot;non-match&quot;])
        .stdout();
    eqnice!(&quot;\n&quot;, got);
});
</code></pre>
<p>with:</p>
<pre><code>running 1 test
test regression::r3108_files_without_match_quiet_exit ... FAILED

failures:

---- regression::r3108_files_without_match_quiet_exit stdout ----

thread &#x27;regression::r3108_files_without_match_quiet_exit&#x27; (1875804) panicked at tests/regression.rs:1530:5:

printed outputs differ!

expected:
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

got:
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
non-match

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-08-20 00:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-08-20 01:00</div>
            <div class="timeline-body"><p>This part in the code is the problem:</p>
<p>https://github.com/BurntSushi/ripgrep.git/blob/119a58a400ea948c2d2b0cd4ec58361e74478641/crates/printer/src/summary.rs#L506-L511</p>
<p>For <code>SummaryKind::PathWithoutMatch</code>, the case of whether a match has occurred or not is correctly inverted. But for <code>SummaryKind::Quiet</code>, the printer doesn&#x27;t know we want to invert the match.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:20 UTC
    </footer>
</body>
</html>
