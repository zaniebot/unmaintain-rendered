<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Max Filesize Option - BurntSushi/ripgrep #385</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add Max Filesize Option</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/BurntSushi/ripgrep/pull/385">#385</a>
        opened by <a href="https://github.com/tiehuis">@tiehuis</a>
        on 2017-02-28 05:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tiehuis">@tiehuis</a></div>
            <div class="timeline-body"><p>See #369.</p>
<p>There is now a build dependency on <code>regex</code>/ This is due to using it to validate the expect input format for the new option. I did seriously consider just doing this manually since it isn't very complicated but since there is a very similar function when actual parsing the arguments, I've opted for minimality.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Max Filesize Option" to "Add Max Filesize Option" by @tiehuis on 2017-02-28 05:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>ignore/src/walk.rs</code> on 2017-02-28 12:02</div>
            <div class="timeline-body"><p>This function cannot accept a <code>Metadata</code> because that implies <em>every</em> file is stat'd regardless of whether a max filesize option is set or not. You need to move the metadata access to occur only after you know there is a file size filter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>src/app.rs</code> on 2017-02-28 12:04</div>
            <div class="timeline-body"><p><code>\d</code> is Unicode aware, which includes a lot more than <code>[0-9]</code>, so I think you want to change this to <code>[0-9]</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>src/app.rs</code> on 2017-02-28 12:05</div>
            <div class="timeline-body"><p>I don't think you need the heredoc syntax either, since you aren't using any <code>&quot;</code> inside the regex. <code>r&quot;^([0-9]+)([KMG])?$&quot;</code> will suffice.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>src/app.rs</code> on 2017-02-28 12:06</div>
            <div class="timeline-body"><p>You don't need this match. You can unwrap the <code>value</code> since it is guaranteed to match if the entire regex matched. e.g., <code>try!(caps[1].parse::&lt;u64&gt;().map_err(|err| err.to_string()))</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>src/args.rs</code>:786 on 2017-02-28 12:07</div>
            <div class="timeline-body"><p>This duplication isn't acceptable, sorry.</p>
<p>Please just get rid of the clap validator. The error can be reported from here. That will also get rid of the build dep on regex.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>src/args.rs</code> on 2017-02-28 12:08</div>
            <div class="timeline-body"><p>See comments above about the regex itself and handling the captures after-the-fact.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>tests/tests.rs</code>:446 on 2017-02-28 12:09</div>
            <div class="timeline-body"><p>Can you add a test that checks the functionality of <code>--max-filesize</code> itself? I realize you have some unit tests, but checking that it works in an integration test will cover some important pieces of code, like the filesize parser and whether the limit is actually passed to the directory iterator.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> requested changes on 2017-02-28 12:12</div>
            <div class="timeline-body"><p>@tiehuis Thanks! Overall this looks pretty good, but the duplication of the parsing routine ain't gunna fly. We really don't need the clap validator if we're also going to report an error when extracting the arguments in <code>args.rs</code>. I left a few other nits as well, but the other important change is that we cannot call <code>metadata</code> unconditionally on every single file. It would slow down iteration way too much even when you don't use the <code>--max-filesize</code> flag.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tiehuis">@tiehuis</a> on 2017-03-01 05:50</div>
            <div class="timeline-body"><p>Thanks for the quick response. Here is an updated version.</p>
<p>A note about the <code>skip_filesize</code> function. I've currently just added appropriate checks prior to calling to ensure that it is necessary to even call. The two places it is called have slightly differing types <code>walkdir::DirEntry</code> and <code>walk::DirEntry</code> with no common impl for the metadata function. For the moment this seems the cleanest way to me and I've added a note to the function regarding the performance concern in actually calling it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2017-03-08 15:17</div>
            <div class="timeline-body"><p>Fantastic. Thanks so much! Great work. :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2017-03-08 15:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2017-03-08 15:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-03-08 15:17</div>
            <div class="timeline-body"><p>@tiehuis I will see if I can sort out the <code>skip_filesize</code> issue you mention next time I'm in that code. For now it looks OK. Thanks. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-03-08 15:21</div>
            <div class="timeline-body"><p>Urk. I missed that this hadn't been squashed. In the future, I will try to do better to notice and remind folks.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 18:27:48 UTC
    </footer>
</body>
</html>
