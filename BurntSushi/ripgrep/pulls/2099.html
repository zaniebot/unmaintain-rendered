<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add aarch64-apple-darwin target - BurntSushi/ripgrep #2099</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add aarch64-apple-darwin target</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/pull/2099">#2099</a>
        opened by <a href="https://github.com/arbourd">@arbourd</a>
        on 2021-12-12 01:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/arbourd">@arbourd</a></div>
            <div class="timeline-body"><p>Adds a build target <code>aarch64-apple-darwin</code> to the release steps.</p>
<p>Closes #1737</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Add macOS-arm64 build" to "Add aarch64-apple-darwin target" by @arbourd on 2021-12-12 01:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> requested changes on 2021-12-13 12:42</div>
            <div class="timeline-body"><p>I think this also needs to be added to the <code>ci</code> workflow, otherwise macos-arm won't be tested on PRs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @arbourd on 2021-12-15 18:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/arbourd">@arbourd</a> on 2021-12-15 19:25</div>
            <div class="timeline-body"><p>Not 100% sure why this is failing (not a Rust dev):</p>
<pre><code>     Running `/Users/runner/work/ripgrep/ripgrep/target/aarch64-apple-darwin/debug/deps/globset-5ccc9bf3313e73b3`
error: test failed, to rerun pass '-p globset --lib'

Caused by:
  could not execute process `/Users/runner/work/ripgrep/ripgrep/target/aarch64-apple-darwin/debug/deps/globset-5ccc9bf3313e73b3` (never executed)
</code></pre>
<p>Guessing we're building globset for aarch64 and trying to execute it? The macOS runners should be able to build arm64 binaries but don't think they'd be able to execute anything.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-12-15 19:35</div>
            <div class="timeline-body"><blockquote>
<p>The macOS runners should be able to build arm64 binaries but don't think they'd be able to execute anything.</p>
</blockquote>
<p>How come? If that's truly the case, then I think adding macOS/arm to CI is premature.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/arbourd">@arbourd</a> on 2021-12-15 19:48</div>
            <div class="timeline-body"><p>The Actions runners are amd64. I can easily build a Go or Swift arm64 binary on my intel amd64 machine, but if I try to execute that binary it will fail (unless it's universal, which is basically both the binaries squeezed into the same bin at double the size).</p>
<p>Homebrew uses its own arm64 runner VMs to build ripgrep binaries (it runs tests after that would require the runtime).</p>
<blockquote>
<p>If that's truly the case, then I think adding macOS/arm to CI is premature.</p>
</blockquote>
<p>True, but I'd still love to see an official binary packaged here, rather than having to rely on just Homebrew/source. I'd have to check that the bin in <code>release.yml</code> actually work though, haha.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2021-12-15 19:56</div>
            <div class="timeline-body"><p>Basically, managing the release is already really time consuming work. Adding more release targets that are difficult to verify isn't great IMO. I'd be open to it, but I'm really not the right point-of-contact to help debug unfortunately. I'm neither a macOS nor an arm user. So if others want to chip in here and do the leg work to make sure this is all working properly, I'd be willing to bring it in. But that also means testing that the release workflow works (probably in another repo).</p>
<p>For other linux/arm builds, I believe we use Cross to both build binaries <em>and</em> run tests. Ideally we could do that here, although I doubt the infrastructure on macOS exists for such a thing.</p>
<p>Given the popularity of macOS/arm, like I said, I'd be willing to bring this in, but I think others will need to put in the work here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/arbourd">@arbourd</a> on 2021-12-15 20:20</div>
            <div class="timeline-body"><blockquote>
<p>I'm neither a macOS nor an arm user. So if others want to chip in here and do the leg work to make sure this is all working properly, I'd be willing to bring it in. But that also means testing that the release workflow works (probably in another repo).</p>
</blockquote>
<p>Totally understand. I can get  the release working on my fork and verify if the binary functions. When you say &quot;testing that the release workflow works&quot; do you mean constantly or just the first time üòÖ</p>
<blockquote>
<p>Ideally we could do that here, although I doubt the infrastructure on macOS exists for such a thing.</p>
</blockquote>
<p>I think to get the full workflow in here we'd need https://github.com/actions/virtual-environments/issues/2187#issuecomment-737339211</p>
<blockquote>
<p>Given the popularity of macOS/arm, like I said, I'd be willing to bring this in, but I think others will need to put in the work here.</p>
</blockquote>
<p>Happy to help here. I don't even have an arm64 Mac yet but I will eventually and when I do I wanna be able to <code>curl</code> here.</p>
<p>Thank you for all your work on ripgrep. It's awesome and I use it everywhere ‚ù§Ô∏è</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/arbourd">@arbourd</a> on 2021-12-15 20:27</div>
            <div class="timeline-body"><p>Updated the macos runner to macos-11 (latest is still 10.15). I don't think that'll fix it but arm64 cross compilation support should be better.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/arcsi42">@arcsi42</a> on <code>.github/workflows/ci.yml</code>:84 on 2022-01-20 19:38</div>
            <div class="timeline-body"><p>I've tried running the <code>ci</code> workflow without this <code>target</code> specified, so <code>cross</code> isn't used for building, and all the runs have passed so far. Not sure if that's helpful.</p>
<pre><code class="language-suggestion"></code></pre>
<p>https://github.com/arcsi42/ripgrep/actions/runs/1725214380</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/arcsi42">@arcsi42</a> reviewed on 2022-01-20 19:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/arcsi42">@arcsi42</a> on 2022-01-20 20:48</div>
            <div class="timeline-body"><p>I have also tried modifying the <code>release.yml</code> workflow and seems to be working with the <a href="https://github.com/actions/virtual-environments/blob/main/images/macos/macos-11-Readme.md"><code>macos-11</code> runner</a>. Here is the passing workflow run: https://github.com/arcsi42/ripgrep/actions/runs/1725448592.</p>
<p>And the built artifacts could be tested by someone with an Arm Mac machine: https://github.com/arcsi42/ripgrep/releases/tag/TEST-0.0.2.</p>
<p>At least the file format looks okay:</p>
<pre><code class="language-console">$ file ./ripgrep-TEST-0.0.2-aarch64-apple-darwin/rg 
./ripgrep-TEST-0.0.2-aarch64-apple-darwin/rg: Mach-O 64-bit arm64 executable, flags:&lt;NOUNDEFS|DYLDLINK|TWOLEVEL|PIE|HAS_TLV_DESCRIPTORS&gt;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/arbourd">@arbourd</a> reviewed on 2022-01-20 23:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/arbourd">@arbourd</a> on <code>.github/workflows/ci.yml</code>:84 on 2022-01-20 23:19</div>
            <div class="timeline-body"><p>Without the target is it building a universal binary?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ellioseven">@ellioseven</a> on 2022-01-21 02:32</div>
            <div class="timeline-body"><p>@arcsi42 Can confirm I was able to get the version from the binary on my M1 Mac:</p>
<p><img src="https://user-images.githubusercontent.com/4191120/150455310-3aa85f2a-c54f-41b7-a1a8-143f53ecc3d9.png" alt="image" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/arcsi42">@arcsi42</a> reviewed on 2022-01-21 17:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/arcsi42">@arcsi42</a> on <code>.github/workflows/ci.yml</code>:84 on 2022-01-21 17:09</div>
            <div class="timeline-body"><p>Does cargo build universal binaries on Apple silicon? I'm not sure if it does yet, https://github.com/rust-lang/cargo/issues/8875.
But we could use <code>lipo</code> in a <code>macos-11</code> runner to merge both the <code>x86_64</code> and <code>arm64/aarch64</code> builds.
I have successful runs using <code>lipo</code>: https://github.com/arcsi42/ripgrep/actions/runs/1729830482, https://github.com/arcsi42/ripgrep/releases/tag/TEST-0.0.3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/arcsi42">@arcsi42</a> on 2022-01-21 17:13</div>
            <div class="timeline-body"><p>I have also built a universal binary using <code>lipo</code> on a <code>macos-11</code> runner: https://github.com/arcsi42/ripgrep/actions/runs/1729830482, can be downloaded from https://github.com/arcsi42/ripgrep/releases/tag/TEST-0.0.3.</p>
<p>Not sure what is the best way to integrate it into the <code>release</code> workflow or if a universal binary is needed at all, I just download previously built <code>macos</code> binaries and use <code>lipo</code> to merge them with github actions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/arbourd">@arbourd</a> on 2022-01-21 18:23</div>
            <div class="timeline-body"><p>@BurntSushi on the universal binary: https://github.com/BurntSushi/ripgrep/issues/1737#issuecomment-732270480</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/arbourd">@arbourd</a> on 2022-10-29 22:27</div>
            <div class="timeline-body"><p>I was able to build both amd64/arm64 binaries and run the tests with cargo/cross on macOS 13 with an arm64 machine @BurntSushi</p>
<p>We might be good to go here if the tests pass ü§ûüèª</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/arbourd">@arbourd</a> on 2022-11-07 19:28</div>
            <div class="timeline-body"><p>Hey @BurntSushi, I don't mean to bother you, but could you please <strong>approve the workflow</strong> so I can continue on this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/arbourd">@arbourd</a> on 2022-11-07 19:56</div>
            <div class="timeline-body"><p>Thank you! So it's failing because it looks like the target <code>aarch64-apple-darwin</code>isn't present. I had this problem locally as well but I was able to solve it by resolving the rustup target. I'll look into this a bit more üëÄ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/arbourd">@arbourd</a> on 2022-11-07 21:39</div>
            <div class="timeline-body"><p>Seems like this is still blocked by Cross because of https://github.com/cross-rs/cross/issues/558. We could also use M1 runners if GitHub ever releases them.</p>
<p>I'll finish this PR up if either of these things ever come to fruition.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/unixsurfer">@unixsurfer</a> on 2023-07-08 13:56</div>
            <div class="timeline-body"><p>Does anyone when this will be merged? I would like to use the pre-build package .</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-07-08 14:11</div>
            <div class="timeline-body"><p>@unixsurfer Use brew?</p>
<p>Otherwise I don't schedule my free time. It  happens when it happens and if it happens. See: https://github.com/BurntSushi/ripgrep/blob/master/FAQ.md#release</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/unixsurfer">@unixsurfer</a> on 2023-07-08 22:20</div>
            <div class="timeline-body"><blockquote>
<p>@unixsurfer Use brew?</p>
<p>Otherwise I don't schedule my free time. It happens when it happens and if it happens. See: https://github.com/BurntSushi/ripgrep/blob/master/FAQ.md#release</p>
</blockquote>
<p>On my working laptop I can't use brew. I need to package it, using autopkg, and the easiest way is to use a pre-built dmg.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-07-09 13:45</div>
            <div class="timeline-body"><p>I looked into this, and the fundamental problem here is that I do not know how to run tests for the <code>aarch64-apple-darwin</code> target in CI. It is possible to produce a binary, but I'm not comfortable doing that without also being able to run tests. (This PR also doesn't work at all as-is because you can't use Cross to build macOS targets. You never could do that and I don't see how that would ever work. You'd need a macOS Docker image, which I'm not sure even exists. And Cross doesn't support it.)</p>
<p>So this looks blocked on GitHub providing macOS arm CI runners. I'm therefore going to close this out for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2023-07-09 13:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-07-11 14:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bc-geoffl">@bc-geoffl</a> on 2023-10-06 19:26</div>
            <div class="timeline-body"><p>what's the latest and greatest way to install ripgrep on apple silicon without homebrew?</p>
<p>Is <code>ripgrep-13.0.0-arm-unknown-linux-gnueabihf.tar.gz</code> the correct binary from <a href="https://github.com/BurntSushi/ripgrep/releases">releases?</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-10-06 19:35</div>
            <div class="timeline-body"><p>@bc-geoffl No, that isn't correct. Look at its name... It has &quot;linux&quot; in it, so it can't be for macOS.</p>
<p>I'm not a macOS user, but if you want to do it without Homebrew, you can install Rust and then build ripgrep from source.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tekumara">@tekumara</a> on 2023-10-06 22:25</div>
            <div class="timeline-body"><p>FYI m1 arm runners are now available https://github.blog/2023-10-02-introducing-the-new-apple-silicon-powered-m1-macos-larger-runner-for-github-actions/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-10-06 22:35</div>
            <div class="timeline-body"><p>@tekumara Wow, about time! I had not seen that. I'll try it out and if it works, I'll get binaries available for the ripgrep 14 release.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tekumara">@tekumara</a> on 2023-10-06 23:49</div>
            <div class="timeline-body"><p>One gotcha I've just discovered is that the m1 runners are <code>large</code> and not standard sized runners, and so aren't free for open-source projects, and require <a href="https://docs.github.com/en/billing/managing-billing-for-github-actions/about-billing-for-github-actions#per-minute-rates">a billing plan</a>:</p>
<blockquote>
<p>Larger runners are only available for organizations and enterprises using the GitHub Team or GitHub Enterprise Cloud plans.
Larger runners are only billed at the per-minute rate for the amount of time workflows are executed on them. There is no cost associated with creating a larger runner that is not being used by a workflow.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-10-06 23:55</div>
            <div class="timeline-body"><p>Sigh.</p>
<p>I do personally have an M2 mac mini now, so I can worst case scenario upload a binary like I do for the Debian package.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:44:04 UTC
    </footer>
</body>
</html>
