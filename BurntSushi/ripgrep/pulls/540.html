<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add test script to compare `rg --help` output to zsh completion function - BurntSushi/ripgrep #540</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add test script to compare <code>rg --help</code> output to zsh completion function</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/BurntSushi/ripgrep/pull/540">#540</a>
        opened by <a href="https://github.com/okdana">@okdana</a>
        on 2017-07-06 02:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/okdana">@okdana</a></div>
            <div class="timeline-body"><p>Per our discussion in #536: Here&#x27;s something to hopefully prevent the zsh completion function from getting out-of-synch with the actual app.</p>
<p>I used a slightly different strategy from the one i mentioned before, but it&#x27;s the same basic idea — pull all of the options out of the <code>--help</code> output, pull all of the options out of the completion function, compare the two. I tried to address your concerns about false positives/negatives as best i could; i&#x27;ve documented the assumptions i make in the script, and i think it should be OK as long as nobody does anything bizarre.</p>
<p>I&#x27;ve tested this in <code>dash</code>, <code>bash</code>, and <code>zsh</code>. It also works in <code>ksh93</code> if you make <code>local</code> an alias for <code>typeset</code>... but you use <code>local</code> in your other scripts so i assume <code>ksh</code> compatibility isn&#x27;t a big concern.</p>
<p>Anyway, it turns out actually that the <code>-f</code> option is missing from the completion function, which is fortuitous i guess because it seems to demonstrate that the script behaves as expected! Here&#x27;s the output:</p>
<pre><code>heartswap:ripgrep % ci/test_complete.sh
zsh completion options differ from `--help` options:
--- `rg --help`
+++ complete/_rg
@@ -77,5 +77,4 @@
 -c
 -e
--f
 -g
 -h
</code></pre>
<p>Unless you have concerns with it i think i&#x27;m happy with the script itself. I&#x27;m not sure how to go about integrating it with your other tests though. Should i just add it to <code>appveyor.yml</code> or does it belong somewhere else?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>ci/test_complete.sh</code>:8 on 2017-07-06 10:51</div>
            <div class="timeline-body"><p>We probably can&#x27;t do this exact thing. This would at, the very least, depend on ripgrep being built before these tests are run. I think we could probably do it by using a debug build, but right now, a release build is not built in CI. It might be easier to just use <code>grep</code>. :P (I think you could set <code>rg=grep</code> and it will just work.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>ci/test_complete.sh</code>:8 on 2017-07-06 10:51</div>
            <div class="timeline-body"><p>Oh hmm I see you&#x27;re using the <code>--replace</code> flag. If you just change <code>rg</code> to <code>target/${TARGET}/debug/rg</code>, then I think that should be OK.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> requested changes on 2017-07-06 10:55</div>
            <div class="timeline-body"><p>This looks pretty good! And yeah, I don&#x27;t think I care too much about korn shell compatibility. :-) (Note that I am not the originator of these shell scripts.) If you wanted to make this <code>#!/bin/bash</code> to be more precise, then that&#x27;s fine!</p>
<p>To add this to CI, I think it needs to go in <code>ci/script.sh</code>, which is run by Travis. Once you do that, it should be testable by pushing to this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/okdana">@okdana</a> reviewed on 2017-07-06 16:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/okdana">@okdana</a> on <code>ci/test_complete.sh</code>:8 on 2017-07-06 16:10</div>
            <div class="timeline-body"><p>Yeah, i could easily have replicated most of the find/replace stuff with <code>grep</code> and/or <code>sed</code>, but i figured that since i needed <code>rg</code> for the <code>--help</code> output anyway i might as well just use it for everything</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/okdana">@okdana</a> on 2017-07-06 16:15</div>
            <div class="timeline-body"><p>Updated the <code>rg</code> path and added the script to <code>script.sh</code> — seems to have worked!</p>
<p>Would you like me to add completion for <code>-f</code> as part of this PR, or should i make another one?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-07-06 16:40</div>
            <div class="timeline-body"><blockquote>
<p>Would you like me to add completion for -f as part of this PR, or should i make another one?</p>
</blockquote>
<p>Whichever is most convenient for you! I&#x27;m find smushing it into this one via a separate commit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/okdana">@okdana</a> on 2017-07-06 19:09</div>
            <div class="timeline-body"><p>Done, seems like everything&#x27;s passing now!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[WIP] Add test script to compare `rg --help` output to zsh completion function&quot; to &quot;Add test script to compare `rg --help` output to zsh completion function&quot; by <a href="https://github.com/okdana">@okdana</a> on 2017-07-06 22:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2017-07-06 23:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-07-06 23:00</div>
            <div class="timeline-body"><p>@okdana You&#x27;re awesome. :-) Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-07-06 23:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2017-07-06 23:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:48:16 UTC
    </footer>
</body>
</html>
