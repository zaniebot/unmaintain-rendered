<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[WIP] Add support for compressed file formats (closes #539) - BurntSushi/ripgrep #751</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[WIP] Add support for compressed file formats (closes #539)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/pull/751">#751</a>
        opened by <a href="https://github.com/balajisivaraman">@balajisivaraman</a>
        on 2018-01-14 12:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/balajisivaraman">@balajisivaraman</a></div>
            <div class="timeline-body"><p>Creating this PR for review purposes. I still haven't added any tests for the newer code, which is one of the main things still pending here.</p>
<p>Notes:</p>
<ul>
<li>Had to add <code>globset</code> as dependency for <code>ripgrep</code> module to easily check for supported file formats. The in-built <code>path.extension()</code> method did not allow me to verify for <code>*.tar.gz</code> files. üòû</li>
<li>We could've used <a href="https://doc.rust-lang.org/std/process/struct.Command.html#method.output"><code>output</code></a> from Command instead of <a href="https://doc.rust-lang.org/std/process/struct.Command.html#method.spawn"><code>spawn</code></a>, which pipes stdout and stderr by default and gives us access to the process' exit status. However, it would've meant loading the entire file into memory in the form of a <code>Vec&lt;u8&gt;</code>. I've therefore gone with the <code>spawn</code> approach here, coupled with peeking at the <code>stderr</code> to verify whether the command succeeded or failed. It works nicely enough in practice in my testing.</li>
<li>Also, I noticed that the <code>spawn</code> method ends up returning an <code>Err</code> immediately if the command is not found. All other errors are obtained from the process' stderr. That's why I've handled it such that if <code>spawn</code> returns an <code>Error</code>, then <code>rg</code> will output the appropriate debug message.</li>
<li>I couldn't think of any other CLI flag that conflicts with <code>-z/--search-zip</code>. One thing to think of is how should <code>rg</code> handle when the <code>-a</code> argument is provided? Right now, if <code>-a</code> and <code>-z</code> are both provided, <code>rg</code> will search zip files as per the new code, but will also end up treating it as a binary file and try searching it. Are we OK with this?</li>
<li>Not really fond of passing the <code>no-messages</code> flag to the <code>decompressor</code>, but there's no better option if we want all error handling to remain within the module itself. In this way, the <code>worker</code> module remains largely unaffected if we choose to change how we do decompression at a later point in time.</li>
</ul>
<p>Any other thoughts and suggestions are welcome.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[WIP] Add support for compressed file formats" to "[WIP] Add support for compressed file formats (closes #539)" by @balajisivaraman on 2018-01-14 12:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/okdana">@okdana</a> reviewed on 2018-01-14 12:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/okdana">@okdana</a> on <code>complete/_rg</code>:90 on 2018-01-14 12:39</div>
            <div class="timeline-body"><p>The exclusions and the syntax itself are wrong here. At a minimum it should be something like this:</p>
<pre><code>'(-z --search-zip)'{-z,--search-zip}'[search through zip files]'
</code></pre>
<p>We might also want to add other exclusions, but i'd like to do another pass on this file within the next few weeks, so it can wait until then to get fancier.</p>
<p>I would also suggest changing the description wording to something like <em>search contents of compressed files</em> ‚Äî¬†'through' is a bit ambiguous, and we don't actually search <em>zip</em> files at all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/okdana">@okdana</a> reviewed on 2018-01-14 12:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/okdana">@okdana</a> on <code>doc/rg.1</code>:194 on 2018-01-14 12:41</div>
            <div class="timeline-body"><p>'On your <code>PATH</code>' feels strange to me ‚Äî '<em>in</em> your <code>PATH</code>'?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/okdana">@okdana</a> reviewed on 2018-01-14 12:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/okdana">@okdana</a> on <code>src/app.rs</code>:590 on 2018-01-14 12:42</div>
            <div class="timeline-body"><p>Same comment about 'on your <code>PATH</code>', but also i think 'uncompression' should be 'decompression' here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/okdana">@okdana</a> on 2018-01-14 12:48</div>
            <div class="timeline-body"><p>There is a problem with the completion function, and i added a few bike-shed wording remarks. I won't comment on the Rust stuff except to say that it does at least make sense to me.</p>
<p>I tested the patch on macOS (just briefly) and it works! This is neat as hell, ty!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/balajisivaraman">@balajisivaraman</a> reviewed on 2018-01-14 12:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/balajisivaraman">@balajisivaraman</a> on <code>complete/_rg</code>:90 on 2018-01-14 12:50</div>
            <div class="timeline-body"><p>I'll fix the syntax as per your suggestion. This file is always throwing me off. Sorry about that.</p>
<p>I thought of using <code>-C/--search-compressed</code> instead of <code>-z/--search-zip</code>. The only reason I went with the latter is that it would be familiar to folks coming from using <code>ag</code>. Like you said, <code>search-zip</code> doesn't really make a lot of sense here. Should we just go with the former option?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/okdana">@okdana</a> reviewed on 2018-01-14 13:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/okdana">@okdana</a> on <code>complete/_rg</code>:90 on 2018-01-14 13:01</div>
            <div class="timeline-body"><p>The completion-function syntax takes a while to get used to, yeah. Every few weeks i learn that something i used to do in these files is wrong, lol.</p>
<p>I like <code>-z</code> for the short option. It's what <code>ag</code> and <code>sift</code> both use, and the connection with 'Ziv' is immediately intuitive. As far as the long option, idk. <code>--search-zip</code> feels slightly inaccurate, but you're right about <code>ag</code> ‚Äî it's one of the most common recursive file searchers, and definitely the most well known one that supports searching compressed files, so it's not unreasonable to borrow the terminology. <code>--search-compressed</code> makes sense too tho, w/e ü§∑‚Äç‚ôÄÔ∏è</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tamird">@tamird</a> reviewed on 2018-01-17 19:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/tamird">@tamird</a> on <code>src/decompressor.rs</code>:27 on 2018-01-17 19:02</div>
            <div class="timeline-body"><p>why isn't this an enum?</p>
<p>better yet, can't this stuff be done without spawning subprocesses? i imagine there are rust libraries for most of these.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/okdana">@okdana</a> reviewed on 2018-01-17 19:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/okdana">@okdana</a> on <code>src/decompressor.rs</code>:27 on 2018-01-17 19:20</div>
            <div class="timeline-body"><p>The rationale for this implementation is explained in #225 and #539</p>
<p>There are still very few pure-Rust (de)compression libraries AFAIK</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>src/decompressor.rs</code>:8 on 2018-01-30 02:29</div>
            <div class="timeline-body"><p>Imports should be consistent with the rest of the code. They should be grouped in three blocks, where each block is separated by whitespace. The first block are <code>std</code> imports. The second block are external crate imports. The third block are internal crate imports. Each block should be sorted lexicographically.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>src/decompressor.rs</code>:14 on 2018-01-30 02:30</div>
            <div class="timeline-body"><p>Since we are building these values in a <code>lazy_static!</code>, we don't actually need the <code>Vec</code>. We can use an <code>&amp;'static [&amp;'static str]</code> instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>src/decompressor.rs</code>:63 on 2018-01-30 02:31</div>
            <div class="timeline-body"><p>In general, I like to keep control flow straight-forward and avoid gratuitous nesting. Early returns are very useful for this. For example, this code could be written as:</p>
<pre><code class="language-rust">if is_tar_archive(path) {
    debug!(...);
    return None;
}

let extension = ...;
</code></pre>
<p>That way, you don't need to indent the entire rest of the function.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>src/decompressor.rs</code>:90 on 2018-01-30 02:38</div>
            <div class="timeline-body"><p>OK, so the issue here is that this will deadlock in non-trivial cases. You might not have hit it if you only tested on small files. Basically the issue here is that if you don't read from stdout, then the process you spawned (if it's implemented sanely) will at some point block on writing to stdout because it is connected to a pipe. If the calling process never reads from stdout, then the spawned process will eventually block. If the calling process is in turn blocked on something else from the spawned process---which in this case, we are, because we're trying to read from <code>stderr</code> until the spawned process stops writing to it---then you wind up with a deadlock.</p>
<p>If you only test this on small files then you won't notice this because the spawned process will likely be using buffered output. And since it's connected to a pipe, the buffer is usually biggish (~4K?) as opposed to being line buffered on a tty. As a result, the spawned process will finish doing its thing before ever flushing its buffer, which gives the appearance of code that works. :-)</p>
<p>The &quot;fix&quot; to this is to couple the <code>child</code> with reading stdout and wait to read stderr until the process terminates. This basically means that you can't return <code>ChildStdout</code> directly. You need to return something else that wraps up this logic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>src/decompressor.rs</code>:90 on 2018-01-30 02:39</div>
            <div class="timeline-body"><p>As an additional upside, the reader that you return can return normal error values, which are handled by the worker. This means you don't need to thread <code>no_messages</code> through the code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>tests/tests.rs</code>:1699 on 2018-01-30 02:39</div>
            <div class="timeline-body"><p>Fantastic tests, thank you. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2018-01-30 02:41</div>
            <div class="timeline-body"><p>@balajisivaraman Thanks so much for working on this! I really wanted to get this merged and there were some fiddly details to get right here, so I went ahead and based a new PR on your work here: #767. I hope that's OK. Most of your code made it through :-) but I did need to refactor the <code>get_reader</code> method (which is now <code>DecompressionReader::from_path</code>).</p>
<p>I left some comments on this PR that roughly correspond to the changes I made.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-01-30 14:14</div>
            <div class="timeline-body"><p>I merged this PR in #767. Thanks again @balajisivaraman!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2018-01-30 14:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/balajisivaraman">@balajisivaraman</a> reviewed on 2018-01-30 15:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/balajisivaraman">@balajisivaraman</a> on <code>src/decompressor.rs</code>:90 on 2018-01-30 15:27</div>
            <div class="timeline-body"><p>Ah, I knew it. üòû  When I made this change and looked at the code, I knew there had to be something I was missing.</p>
<p>Thank you for the detailed write up on the issues with my code. It makes a lot of sense to me and helps me understand it better. It also gives me incentive to do some more reading up on pipes and child processes, which I will. üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/balajisivaraman">@balajisivaraman</a> reviewed on 2018-01-30 15:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/balajisivaraman">@balajisivaraman</a> on <code>src/decompressor.rs</code>:63 on 2018-01-30 15:27</div>
            <div class="timeline-body"><p>Ah, that makes a lot of sense. I did do this in the <code>worker.rs</code> file but missed it here. üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/balajisivaraman">@balajisivaraman</a> on 2018-01-30 15:28</div>
            <div class="timeline-body"><p>@BurntSushi, Thank you for merging this. It is one of my first significant contributions of any kind to a OSS project. I learned a lot from working on it as well as going through the changes you made on top of it. Cheers. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2018-01-30 15:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-01-30 15:35</div>
            <div class="timeline-body"><p>@balajisivaraman It's a helluva first contribution! It will be a highlight feature in the next release. :)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 18:27:58 UTC
    </footer>
</body>
</html>
