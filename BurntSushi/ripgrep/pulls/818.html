<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>printer: add support for printing 0-based byte offset before matches - BurntSushi/ripgrep #818</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>printer: add support for printing 0-based byte offset before matches</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/BurntSushi/ripgrep/pull/818">#818</a>
        opened by <a href="https://github.com/balajisivaraman">@balajisivaraman</a>
        on 2018-02-19 05:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/balajisivaraman">@balajisivaraman</a></div>
            <div class="timeline-body"><p>Closes #812</p>
<p>As discussed in the issue thread, the only question is the order of line number, column and offset when all three are displayed. I've gone with <code>line number:column:offset</code> as the default for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>tests/tests.rs</code>:407 on 2018-02-20 12:38</div>
            <div class="timeline-body"><p>For completeness, could you pass the <code>--no-mmap</code> flags to each of the above tests, and then copy the tests and change <code>--no-mmap</code> to <code>--mmap</code>? I am thinking that your implementation might actually be correct for <code>--mmap</code> but not for <code>--no-mmap</code>. I'm not sure a global byte offset is even tracked in the <code>--no-mmap</code> searcher, so this task might require a bit more work. :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> requested changes on 2018-02-20 12:39</div>
            <div class="timeline-body"><p>Thanks for working on this! We need a little bit more test coverage here, and I suspect it may expose a bug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/balajisivaraman">@balajisivaraman</a> reviewed on 2018-02-20 15:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/balajisivaraman">@balajisivaraman</a> on <code>tests/tests.rs</code>:407 on 2018-02-20 15:09</div>
            <div class="timeline-body"><p>I'm really sorry about overlooking this. When I went into <code>search_stream</code>, I noticed that the change was pretty trivial and it made so much sense to me that I missed <code>search_buffer</code>. It's on me. I'll have a look at the <code>mmap</code> searcher to see what can be done. :+1:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/balajisivaraman">@balajisivaraman</a> reviewed on 2018-02-20 16:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/balajisivaraman">@balajisivaraman</a> on <code>tests/tests.rs</code>:407 on 2018-02-20 16:16</div>
            <div class="timeline-body"><p>Ah, I think I lucked out here. The iterator returned by <code>self.grep.iter(self.buf)</code> in <code>search_buffer.rs</code> provides us with the starting position of the matching line itself. From then on, we call <code>printer.matched</code> with the <code>start</code> and <code>end</code>, which thankfully works the same way it does for <code>search_stream</code>. Both the <code>--no-mmap</code> and <code>--mmap</code> tests that you asked to write also pass. :+1:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2018-02-20 16:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>tests/tests.rs</code>:407 on 2018-02-20 16:18</div>
            <div class="timeline-body"><p>Hmm, awesome! You might actually want to test this also in non-mmap searcher using a smaller capacity, such that the matches reported span multiple buffers. If that test passes, then I'll believe the implementation is correct. :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2018-02-20 16:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>tests/tests.rs</code>:407 on 2018-02-20 16:18</div>
            <div class="timeline-body"><p>I believe there's a <code>smallcap</code> helper function in the tests somewhere, since there are other tests that proceed in a similar vein. But I can't remember. It's been a while since I looked at that code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/balajisivaraman">@balajisivaraman</a> on <code>tests/tests.rs</code>:407 on 2018-02-20 16:54</div>
            <div class="timeline-body"><p>Hmm... No, you're right. I tried it with the <code>smallcaps</code> test available in <code>search_stream.rs</code> and it completely blew apart. (I got 0 as the offset for the next match instead of the offset from the beginning of the file.) The good news is that I can see why this is happening very clearly.</p>
<p>I now understand why you originally thought it will require additional work for the <code>--no-mmap</code> case. I'll have a look at it. Sorry. :+1:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/balajisivaraman">@balajisivaraman</a> reviewed on 2018-02-20 16:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/balajisivaraman">@balajisivaraman</a> on 2018-02-21 16:55</div>
            <div class="timeline-body"><p>@BurntSushi, Thanks for the patient explanation and walkthrough yesterday. I've identified the bug and, hopefully, fixed it as well. :-)</p>
<p>One point to note is that within the searchers, I've named the variable that keeps track of the offset as <code>buffer_offset</code>. This made sense to me as it tracks the offset of the current buffer from the beginning of the file; and I can't come up with a better name for it.</p>
<p>Also, as I've moved the tests to within the searchers itself, I didn't feel a necessity to have <code>--mmap</code> and <code>--no-mmap</code> tests on the outside as well. The integration tests now only test for the behaviour of <code>-b</code> along with <code>-o</code> and <code>-v</code>.</p>
<p>EDIT: Moved the <code>--invert-match</code> test to the searchers itself. Added a <code>--before-context</code> test in <code>search_stream.rs</code> to ensure the offset tracking happens properly when bytes from the previous buffer are rolled over.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2018-03-10 15:16</div>
            <div class="timeline-body"><p>@balajisivaraman OK, I finally had a chance to look into merging this. Overall, this looks really great. I merged this PR in b006943c01561a4ae5b928081d1bb4087b599e19 with a few minor tweaks and a bug fix:</p>
<ol>
<li>I renamed <code>buffer_offset</code> to <code>byte_offset</code>, since the former isn't actually true for the stream searcher. (It is a byte offset for the entire file, not to a buffer.)</li>
<li>I changed the type of <code>byte_offset</code> to <code>u64</code> from <code>usize</code>. This is because <code>usize</code> is a platform specific type whose size is tied to the size of addressable memory. So on a 32 bit system, <code>usize</code>'s max value is <code>2^32-1</code>, which means the byte offset would overflow when searching files bigger than 4GB. Note that this is tricky to get right, since there are places in the searcher where <code>usize</code> is correct since they correspond to offsets into memory.</li>
<li>GNU grep's behavior when one of the <code>--context</code> flags is given is to emit a byte offset before each context line. I updated your patch to do that and fixed the test, which was easy to do thanks to your prior work. :-)</li>
</ol>
<p>Thanks so much for working on this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2018-03-10 15:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2018-03-10 16:07</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 18:28:00 UTC
    </footer>
</body>
</html>
