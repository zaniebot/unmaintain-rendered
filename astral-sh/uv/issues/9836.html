<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UV uses wrong wheel platform for package when rosetta is involved on MacOS - astral-sh/uv #9836</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>UV uses wrong wheel platform for package when rosetta is involved on MacOS</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/9836">#9836</a>
        opened by <a href="https://github.com/ghost">@ghost</a>
        on 2024-12-12 12:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ghost">@ghost</a> on 2024-12-12 12:28</div>
            <div class="timeline-body"><p>OS: Macos 15.1.1
UV: 0.5.5
python: 3.12</p>
<p>We currently have a situation where we occasionally need to run a python script with rosetta, which causes uv to pick the wrong packages, depending on which platform was first used.  In our case the issue happens with numpy.</p>
<p>Steps to reproduce:</p>
<ul>
<li>create venv with numpy natively ( uv_arm sync )<ul>
<li>importing numpy in the first venv works</li>
<li>arm wheel is in cache</li>
</ul>
</li>
<li>create venv with numpy with rosetta (uv_x86 sync )<ul>
<li>importing numpy causes an error due to a platform mismatch</li>
<li>no x86 wheel is in cache</li>
</ul>
</li>
</ul>
<p>Interestingly, a refresh causes the issue to happen on the arm side, so its picking up whichever wheel was downloaded first:</p>
<ul>
<li>run uv_x86 sync --refresh<ul>
<li>import numpy works</li>
<li>x86 wheel is in cache</li>
<li>arm wheel is now gone</li>
</ul>
</li>
<li>run uv_arm sync<ul>
<li>import numpy now breaks due to platform mismatch</li>
</ul>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "UV pulls in wrong wheel for package when rosetta is involved on MacOS" to "UV uses wrong wheel platform for package when rosetta is involved on MacOS" by @ghost on 2024-12-12 12:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-12-12 12:30</div>
            <div class="timeline-body"><p>Can you share logs for the numpy example (<code>uv sync -v</code>)?</p>
<p>When running through rosetta, is the path to the python interpreter the same?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ghost">@ghost</a> on 2024-12-12 13:12</div>
            <div class="timeline-body"><p>Yes, python interpreter is a universal binary so the path used to create the venv is the same.</p>
<p>Here are the logs for the sync that installs the x86 package with arm uv and universal binary python (package is found in cache but with wrong platform):</p>
<pre><code>DEBUG uv 0.5.4 (Homebrew 2024-11-20)
DEBUG Found project root: `/Users/.../workspace/numpy_test`
DEBUG No workspace root found, using project root
DEBUG Using Python request `&gt;=3.11` from `requires-python` metadata
DEBUG The virtual environment's Python version satisfies `&gt;=3.11`
DEBUG Using request timeout of 30s
DEBUG Found static `pyproject.toml` for: test @ file:///Users/.../workspace/numpy_test
DEBUG No workspace root found, using project root
DEBUG Existing `uv.lock` satisfies workspace requirements
Resolved 2 packages in 1ms
DEBUG Using request timeout of 30s
DEBUG Requirement already cached: numpy==2.2.0
Installed 1 package in 14ms
 + numpy==2.2.0
</code></pre>
<p>pyproject.toml</p>
<pre><code>[project]
name = &quot;test&quot;
version = &quot;0.0.0&quot;
requires-python = &quot;&gt;=3.11&quot;

dependencies = [&quot;numpy&quot;]
</code></pre>
<p>Exact commands:</p>
<pre><code class="language-bash">uv cache clean

uv_x86 venv --python ./universal_python3
uv_x86 sync 
arch -x86_64 ./.venv/bin/python -c &quot;import numpy; print(numpy.random.randint(2, size=10))&quot;
# x86 works

rm -rf .venv
uv_arm venv --python ./universal_python3
uv_arm sync
./.venv/bin/python -c  &quot;import numpy; print(numpy.random.randint(2, size=10))&quot;
# arm fails

# refresh cache with arm
rm -rf .venv
uv_arm venv --python ./universal_python3
uv_arm sync --refresh
./.venv/bin/python -c  &quot;import numpy; print(numpy.random.randint(2, size=10))&quot;
# arm works


uv_x86 venv --python ./universal_python3
uv_x86 sync 
arch -x86_64 ./.venv/bin/python -c &quot;import numpy; print(numpy.random.randint(2, size=10))&quot;
# x86 fails
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @konstin on 2024-12-12 13:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-12-12 13:27</div>
            <div class="timeline-body"><p>We cache the python interpreter platform by path, which I assume is wrong in this case because rosetta changes the interpreter platform while keeping the path intact.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-12 14:24</div>
            <div class="timeline-body"><p>Maybe there's something we can include in the cache here...? I'll look.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-12-12 14:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/9846.html">astral-sh/uv#9846</a> on 2024-12-12 17:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-12-12 18:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:31:48 UTC
    </footer>
</body>
</html>
