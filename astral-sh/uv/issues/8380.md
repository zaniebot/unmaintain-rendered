```yaml
number: 8380
title: Docker build fails with cached dependencies for a workspace
type: issue
state: closed
author: suhaskarnik
labels:
  - needs-mre
assignees: []
created_at: 2024-10-20T12:07:21Z
updated_at: 2025-04-29T15:46:21Z
url: https://github.com/astral-sh/uv/issues/8380
synced_at: 2026-01-10T01:57:19Z
```

# Docker build fails with cached dependencies for a workspace

---

_Issue opened by @suhaskarnik on 2024-10-20 12:07_

I've a project with the following structure:

```
app
├── pkgs
│   └── backend
│       ├── pyproject.toml
│       └── src
│           └── backend
│               ├── __init__.py
├── pyproject.toml
├── src
│   └── ui
│       ├── hello.py
```

In `pyproject.toml` I have the following:
```toml
[project]
name = "app"
version = "0.1.0"
requires-python = ">=3.12"
dependencies = [
"backend ==0.1.0"
]

[tool.uv.workspace]
members = ["pkgs/backend"]

[tool.uv.sources]
backend = { workspace = true }

[tool.hatch.build.targets.wheel]
packages = ["src/ui"]

[project.scripts]
hello = "ui.hello:main"

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"
```

In `backend/pyproject.toml` I have:
```toml
[project]
name = "backend"
version = "0.1.0"

requires-python = ">=3.12"
dependencies = ["..."]

[tool.hatch.build.targets.wheel]
packages = ["src/backend"]

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"
```

Finally, the `hello.py` is rather simple:
```python
from backend import hello

def main():
    print("Hello from uv-workspaces!")
    print(hello())    # backend.__init__.py has a hello() method that just returns "hello from backend"

if __name__ == "__main__":
    main()
```

As you can see, this is a minimal solution to understand how workspaces can be used to deploy an (eventually) more complex project with dependencies into a Docker container. 

Now `uv sync` and `uv run hello` work fine on my machine - it prints two hello messages.  But if I follow the Dockerfile [here](https://github.com/astral-sh/uv-docker-example/blob/main/Dockerfile), it fails with the error:

```
0.125   Caused by: Failed to parse entry for: `backend`
0.125   Caused by: Package is not included as workspace package in `tool.uv.workspace`
```

The problems seems to occur because the Dockerfile does _not_ copy the project source code before doing the sync. When I added a `--mount=type=bind,source=pkgs,target=pkgs` before the `uv-sync` command in the Dockerfile, it solved the problem, but this is obviously not a good idea because then I cannot cache the dependencies. 

---

_Comment by @zanieb on 2024-10-20 14:36_

You'll want to use `--no-install-workspace` instead of `--no-install-project`, I think. 

---

_Label `question` added by @zanieb on 2024-10-20 14:36_

---

_Comment by @suhaskarnik on 2024-10-21 09:56_

Thanks, I tried that too, but it gave me the same error. So all of the following give the same error:
```bash
--no-install-project
--no-install-workspace
--no-install-project --no-install-workspace
--no-install-project --no-install-workspace --no-install-package backend
```

In addition, I now added the -v flag to get verbose output. Most of it seemed innocuous, but these lines show up. Is this a problem?
```
0.128 DEBUG Ignoring existing lockfile due to mismatched members:
0.128   Expected: {}
0.128   Actual: {PackageName("app"), PackageName("backend")}
```

Running `uv lock` didn't fix the above, and doesn't seem to update the `uv.lock` file either, going by the file timestamp

---

_Comment by @zanieb on 2024-10-21 13:43_

Seems like a bug, @charliermarsh would know better though.

---

_Assigned to @charliermarsh by @zanieb on 2024-10-21 13:43_

---

_Label `question` removed by @zanieb on 2024-10-21 13:43_

---

_Label `bug` added by @zanieb on 2024-10-21 13:43_

---

_Comment by @charliermarsh on 2024-10-21 14:48_

Are you not running with `--frozen`? That debug message should be "impossible" with `--frozen`.

---

_Comment by @charliermarsh on 2024-10-21 14:53_

Either way, can you post the exact Dockerfile you're using with the above projects please?

---

_Comment by @charliermarsh on 2024-10-21 17:30_

I copied over the code and Dockerfile but the build succeeds without error.

---

_Label `bug` removed by @charliermarsh on 2024-10-21 17:30_

---

_Label `needs-mre` added by @charliermarsh on 2024-10-21 17:30_

---

_Comment by @charliermarsh on 2024-10-21 17:32_

E.g., this builds without error:

```docker
# Use a Python image with uv pre-installed
FROM ghcr.io/astral-sh/uv:python3.12-bookworm-slim

# Install the project into `/app`
WORKDIR /app

# Enable bytecode compilation
ENV UV_COMPILE_BYTECODE=1

# Copy from the cache instead of linking since it's a mounted volume
ENV UV_LINK_MODE=copy

# Install the project's dependencies using the lockfile and settings
RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,source=uv.lock,target=uv.lock \
    --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
    uv sync --frozen --no-install-workspace --no-dev

# Then, add the rest of the project source code and install it
# Installing separately from its dependencies allows optimal layer caching
ADD . /app
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --frozen --no-dev

# Place executables in the environment at the front of the path
ENV PATH="/app/.venv/bin:$PATH"

# Reset the entrypoint, don't invoke `uv`
ENTRYPOINT []

# Run the FastAPI application by default
# Uses `fastapi dev` to enable hot-reloading when the `watch` sync occurs
# Uses `--host 0.0.0.0` to allow access from outside the container
CMD ["fastapi", "dev", "--host", "0.0.0.0", "src/uv_docker_example"]
```

---

_Comment by @suhaskarnik on 2024-10-22 04:24_

Thanks, adding `--frozen` fixed the issue. 

Working backwards, I think I now get how this happened. Originally I had `--frozen --no-install-project`. Which threw the original error that I pasted. Later when I replaced that with `--no-install-workspace`, looks like I accidentally removed `--frozen`. 

So the solution is `--frozen --no-install-workspace`

---

_Closed by @suhaskarnik on 2024-10-22 04:24_

---

_Comment by @MarkusPorti on 2025-04-29 15:46_

@charliermarsh 
I just stumbled across the same error which could be fixed by replacing "--locked" with "--frozen" as suggested earlier.
You may want to change your documentation here: https://docs.astral.sh/uv/guides/integration/docker/#intermediate-layers


---
