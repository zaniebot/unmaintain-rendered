<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv sync` fails in xarray, while `pip install` succeeds - astral-sh/uv #7881</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>`uv sync` fails in xarray, while `pip install` succeeds</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/7881">#7881</a>
        opened by <a href="https://github.com/max-sixty">@max-sixty</a>
        on 2024-10-02 22:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/max-sixty">@max-sixty</a> on 2024-10-02 22:46</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

<p>Thanks for making <code>uv</code>! I'm trying it out for <a href="https://github.com/pydata/xarray">xarray</a>. We've had great success with <code>ruff</code>.</p>
<p>Currently this doesn't succeed:</p>
<pre><code> uv sync --extra=complete
Resolved 109 packages in 6ms
error: Failed to prepare distributions
  Caused by: Failed to fetch wheel: llvmlite==0.36.0
  Caused by: Build backend failed to determine requirements with `build_wheel()` (exit status: 1)
--- stdout:

--- stderr:
Traceback (most recent call last):
  File &quot;&lt;string&gt;&quot;, line 14, in &lt;module&gt;
  File &quot;/Users/maximilian/.cache/uv/builds-v0/.tmpXiRhdh/lib/python3.11/site-packages/setuptools/build_meta.py&quot;, line 332, in get_requires_for_build_wheel
    return self._get_build_requires(config_settings, requirements=[])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/Users/maximilian/.cache/uv/builds-v0/.tmpXiRhdh/lib/python3.11/site-packages/setuptools/build_meta.py&quot;, line 302, in _get_build_requires
    self.run_setup()
  File &quot;/Users/maximilian/.cache/uv/builds-v0/.tmpXiRhdh/lib/python3.11/site-packages/setuptools/build_meta.py&quot;, line 503, in run_setup
    super().run_setup(setup_script=setup_script)
  File &quot;/Users/maximilian/.cache/uv/builds-v0/.tmpXiRhdh/lib/python3.11/site-packages/setuptools/build_meta.py&quot;, line 318, in run_setup
    exec(code, locals())
  File &quot;&lt;string&gt;&quot;, line 55, in &lt;module&gt;
  File &quot;&lt;string&gt;&quot;, line 52, in _guard_py_ver
RuntimeError: Cannot install on Python version 3.11.10; only versions &gt;=3.6,&lt;3.10 are supported.
</code></pre>
<p>It's surprising that it's attempting to select an old version of <code>llvmlite</code>. When I run <code>pip install .[complete]</code> in the venv, I get a successful install, with version <code>0.43.0</code> of <code>llvmlite</code>.</p>
<p>Happy to debug a bit. I had a browse through https://docs.astral.sh/uv/pip/compatibility/. Is there anything I should look at / any way of understanding why <code>uv</code> doesn't succeed there? Is a dependency giving bad information that <code>pip</code> is ignoring?</p>
<p>Rather than me bugging you, one great model would be to print why it's choosing that package, and someone like me could open an issue on the offending dependency (but maybe not easy...)</p>
<p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-02 22:50</div>
            <div class="timeline-body"><p>Without looking, my guess is that it's something like <a href="https://github.com/astral-sh/uv/issues/6281#issuecomment-2316240724">this</a>, where we end up solving in a different order than pip and thus end up picking a newer version of something that leads to us using an old llvmlite.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-02 22:51</div>
            <div class="timeline-body"><p><code>uv sync</code> performs <a href="https://docs.astral.sh/uv/concepts/resolution/#universal-resolution">universal resolution</a> while pip does not. pip also has some different heuristics for selecting versions during resolution. Did you try <code>uv pip install</code>? That could help narrow it down.</p>
<p>If you <code>uv add 'llvmlite&gt;0.36.0'</code> you'll either get an error from the resolver explaining why we had to backtrack to the older version or it'll succeed indicating it's a difference in resolver heuristics.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-02 22:52</div>
            <div class="timeline-body"><p>If you run <code>uv tree --invert</code>, you can see the following which may help:</p>
<pre><code>llvmlite v0.36.0
└── numba v0.53.1
    ├── numbagg v0.8.2
    │   ├── xarray v0.1.0 (extra: accel)
    │   ├── xarray v0.1.0 (extra: dev)
    │   └── xarray v0.1.0 (extra: complete)
    └── sparse v0.15.4
        ├── xarray v0.1.0 (extra: dev)
        ├── xarray v0.1.0 (extra: complete)
        └── xarray v0.1.0 (extra: etc)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2024-10-02 22:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-02 22:55</div>
            <div class="timeline-body"><p>Thanks for such a kindly written issue btw.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">great writeup</span> added by @zanieb on 2024-10-02 22:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-02 22:58</div>
            <div class="timeline-body"><p>I would need to look at the <code>--verbose</code> logs to <em>understand</em> exactly what's going on, but it's something like: we're prioritizing the most recent version of NumPy, which is then causing us to require older versions of Numba, which is then requiring us to require older versions of llvmlite. If you constrain <code>numpy==2.0.2</code>, you get the most recent Numba and llvmlite versions. (I figured this out by running <code>uv tree</code> and applying various constraints, then re-running.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/max-sixty">@max-sixty</a> on 2024-10-02 23:15</div>
            <div class="timeline-body"><p>Thank you very much for the fast response! You're going to put LLMs out of a job already.</p>
<p>Forcing the latest version of <code>numba</code> makes it work:</p>
<pre><code class="language-diff">diff --git a/pyproject.toml b/pyproject.toml
index 4f33eff8..7d18a7d3 100644
--- a/pyproject.toml
+++ b/pyproject.toml
@@ -23,6 +23,7 @@ requires-python = &quot;&gt;=3.10&quot;
 
 dependencies = [
   &quot;numpy&gt;=1.24&quot;,
+  &quot;numba==0.60.0&quot;,
   &quot;packaging&gt;=23.1&quot;,
   &quot;pandas&gt;=2.1&quot;,
 ]
</code></pre>
<p>(Forcing the latest version of <code>llvmlite</code> doesn't)</p>
<p>Any idea <em>why</em> it's selecting numba 0.53.1? That version's <a href="https://github.com/numba/numba/blob/0.53.1/setup.py#L370">setup.py file</a> seems to specify a much earlier numpy version as a constraint, though possibly in a format that can't be read? (Could look more unless this is obvious to you)</p>
<p>The case of &quot;no version of A supports the latest version of B, so install the version of B which a version of A supports&quot; seems like it should be a common path; I'd have expected to find that some dependency has misspecified a constraint...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-02 23:17</div>
            <div class="timeline-body"><p>I think it's because newer versions of Numba include:</p>
<pre><code>Requires-Dist: numpy &lt;2.1,&gt;=1.22
</code></pre>
<p>So if we choose the latest NumPy, we end up having to backtrack to versions of Numba that <em>don't</em> include that upper-bound.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/max-sixty">@max-sixty</a> on 2024-10-02 23:20</div>
            <div class="timeline-body"><p>Ah yes, OK:</p>
<pre><code>$  rip uv.lock; uv sync --extra=complete --verbose &amp;&gt; uv.log

DEBUG Adding transitive dependency for numba==0.60.0: llvmlite&gt;=0.43.0.dev0, &lt;0.44
DEBUG Adding transitive dependency for numba==0.60.0: numpy&gt;=1.22, &lt;2.1
DEBUG Searching for a compatible version of numba (&gt;=0.49, &lt;0.60.0 | &gt;0.60.0)
DEBUG Selecting: numba==0.59.1 [compatible] (numba-0.59.1-cp310-cp310-macosx_10_9_x86_64.whl)
</code></pre>
<p>and then no upper bound at:</p>
<pre><code>DEBUG Adding transitive dependency for numba==0.53.1: llvmlite&gt;=0.36.0rc1, &lt;0.37
DEBUG Adding transitive dependency for numba==0.53.1: numpy&gt;=1.15
DEBUG Adding transitive dependency for numba==0.53.1: setuptools*
</code></pre>
<p>Let me try and fix by giving constraints in xarray for <code>numba</code>, so we get it backtracking in <code>numpy</code> instead...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/max-sixty">@max-sixty</a> on 2024-10-02 23:30</div>
            <div class="timeline-body"><p>OK great, this works!</p>
<pre><code class="language-diff">diff --git a/pyproject.toml b/pyproject.toml
index 4f33eff8..c6dd762d 100644
--- a/pyproject.toml
+++ b/pyproject.toml
@@ -28,7 +28,7 @@ dependencies = [
 ]
 
 [project.optional-dependencies]
-accel = [&quot;scipy&quot;, &quot;bottleneck&quot;, &quot;numbagg&quot;, &quot;flox&quot;, &quot;opt_einsum&quot;]
+accel = [&quot;scipy&quot;, &quot;bottleneck&quot;, &quot;numbagg&quot;, &quot;numba&gt;=0.54&quot;, &quot;flox&quot;, &quot;opt_einsum&quot;]
 complete = [&quot;xarray[accel,etc,io,parallel,viz]&quot;]
 dev = [
   &quot;hypothesis&quot;,
</code></pre>
<p>Thank you very much! Will push this change.</p>
<p><code>uv</code> behavior totally makes sense on reflection. To get the correct-by-what-we-really-want outcome, I think it would need do something quite complex, such as discount the requirements of older packages — i.e. with context, it's quite unlikely only versions of <code>numba</code> from before 2021 are good with <code>numpy</code> from 2024...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @max-sixty on 2024-10-02 23:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../pydata/xarray/pulls/9572.html">pydata/xarray#9572</a> on 2024-10-02 23:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-03 00:16</div>
            <div class="timeline-body"><p>Yeah we plan to improve these heuristics in the long-term but it's going to be quite the challenge</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../argilla-io/distilabel/pulls/1018.html">argilla-io/distilabel#1018</a> on 2024-10-07 09:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/7965.html">astral-sh/uv#7965</a> on 2024-10-08 22:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/8157.html">astral-sh/uv#8157</a> on 2024-10-13 13:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../deepset-ai/haystack/issues/8766.html">deepset-ai/haystack#8766</a> on 2025-01-24 08:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:22 UTC
    </footer>
</body>
</html>
