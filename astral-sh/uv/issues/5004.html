<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv building of casadi fails - astral-sh/uv #5004</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv building of casadi fails</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/5004">#5004</a>
        opened by <a href="https://github.com/andiradulescu">@andiradulescu</a>
        on 2024-07-12 08:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/andiradulescu">@andiradulescu</a> on 2024-07-12 08:12</div>
            <div class="timeline-body"><p>When trying to build <a href="https://github.com/casadi/casadi">casadi</a> with <code>uv</code> the build fails with:</p>
<pre><code>CMake Error at swig/python/CMakeLists.txt:32 (file):
  file STRINGS file
  &quot;/home/andiradulescu/.cache/uv/builds-v0/.tmpJ6W54S/include/patchlevel.h&quot;
  cannot be read.
Call Stack (most recent call first):
  swig/python/CMakeLists.txt:62 (CasadiGetPythonVersionMajor)
</code></pre>
<p>This is because <code>/home/andiradulescu/.cache/uv/builds-v0/.tmpJ6W54S/</code> folder doesn't seem to exist:</p>
<pre><code>ls: cannot access '/home/andiradulescu/.cache/uv/builds-v0/.tmpJ6W54S/': No such file or directory
</code></pre>
<p>CasADi uses this in it's <a href="https://github.com/casadi/casadi/blob/72764dc73eab7b935db7e302278508855815883b/swig/python/setup.py.in#L50C13-L50C60">setup.py</a>:</p>
<pre><code>'-DPYTHON_INCLUDE_DIR=' + self.include_dirs[0],
</code></pre>
<p>Debugging this further, self.include_dirs has (for <code>uv pip install</code>):</p>
<pre><code>[
'/home/andiradulescu/.cache/uv/builds-v0/.tmpaqg9V9/include',
'/home/andiradulescu/.pyenv/versions/3.12.4/include/python3.12'
]
</code></pre>
<p>Where <code>pip install</code> - that builds successfully has:</p>
<pre><code>[
'/home/andiradulescu/.pyenv/versions/3.12.4/include/python3.12'
]
</code></pre>
<p>I tested all of this by:</p>
<ul>
<li>downloading the latest casadi <a href="https://github.com/casadi/casadi/releases/download/3.6.5/casadi-source-v3.6.5.zip">source</a> files, so that I can also be able to add logs</li>
<li>creating a venv - <code>uv venv</code></li>
<li>running either <code>uv pip install --verbose .</code> or <code>pip install --verbose .</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-12 13:23</div>
            <div class="timeline-body"><blockquote>
<p>This is because <code>/home/andiradulescu/.cache/uv/builds-v0/.tmpJ6W54S/</code> folder doesn't seem to exist:</p>
</blockquote>
<p>This may be a red herring. That directory is cleaned up and deleted when the program exits, so it won't exist after the failure.</p>
<p>Does the package install successfully with <code>pip install --use-pep517</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2024-07-12 13:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andiradulescu">@andiradulescu</a> on 2024-07-12 15:26</div>
            <div class="timeline-body"><blockquote>
<p>Does the package install successfully with <code>pip install --use-pep517</code>?</p>
</blockquote>
<p>Yes, builds fine. Doesn't seem to be a difference.</p>
<pre><code>Successfully built casadi
Installing collected packages: numpy, casadi
Successfully installed casadi-3.6.5 numpy-2.0.0
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andiradulescu">@andiradulescu</a> on 2024-07-12 15:34</div>
            <div class="timeline-body"><p>Also, trying to list the contents of <code>self.include_dirs[0]</code> in casadi setup.py <code>build_extension</code>, while using <code>uv pip install</code> still complains it doesn't exist:</p>
<pre><code>error: [Errno 2] No such file or directory: '/Users/andiradulescu/Library/Caches/uv/builds-v0/.tmpYVB1tp/include'
</code></pre>
<p>But listing the parent dir ('/Users/andiradulescu/Library/Caches/uv/builds-v0/.tmpYVB1tp'), the tmp folder exits, but no <code>include</code> dir:</p>
<pre><code>bin
get_requires_for_build_wheel.txt
pyvenv.cfg
CACHEDIR.TAG
.gitignore
lib
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-12 18:00</div>
            <div class="timeline-body"><p>The temporary directory changes every time though -- how would you be checking if it exists?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-12 18:02</div>
            <div class="timeline-body"><p>For what it's worth, <code>python -m build</code> also fails with the same error. That suggests to me that it's a bug in the package, though not sure what. \cc @henryiii</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2024-07-12 18:09</div>
            <div class="timeline-body"><p>CMake-based packages should use scikit-build-core, not setuptools. :) I'd say <code>'-DPYTHON_INCLUDE_DIR=' + self.include_dirs[0],</code> is invalid, there's no guarantee in setuptools that the first include dir will be the Python include dir. <code>sysconfig.get_path(&quot;include&quot;)</code> is the correct way to get the Python include dir.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-12 18:12</div>
            <div class="timeline-body"><p>ðŸ™‡  Thank you. Any idea why the build directory is present in <code>uv</code> and <code>build</code> but not <code>pip</code>? That part is a mystery to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2024-07-12 18:14</div>
            <div class="timeline-body"><p>I would have thought it would be present if any packages used the wheel &quot;includes&quot; folder. Maybe it's created no matter what in build/uv and only created if needed in pip? Adding <code>pybind11-global</code> is a way to get a package that using the includes wheel folder for testing. Is the folder empty?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andiradulescu">@andiradulescu</a> on 2024-07-12 18:33</div>
            <div class="timeline-body"><blockquote>
<p>The temporary directory changes every time though -- how would you be checking if it exists?</p>
</blockquote>
<p>In setup.py, in <code>def build_extension(self, ext):</code> I do a <code>os.listdir()</code> e.g.</p>
<pre><code>cmake_args = [
    ...
    '-DPYTHON_INCLUDE_DIR=' + self.include_dirs[0],
    ...
]
logger.info(os.listdir(self.include_dirs[0]))
logger.info(os.listdir(os.path.dirname(self.include_dirs[0])))
</code></pre>
<blockquote>
<p>CMake-based packages should use scikit-build-core, not setuptools. :) I'd say <code>'-DPYTHON_INCLUDE_DIR=' + self.include_dirs[0],</code> is invalid, there's no guarantee in setuptools that the first include dir will be the Python include dir. <code>sysconfig.get_path(&quot;include&quot;)</code> is the correct way to get the Python include dir.</p>
</blockquote>
<p>This sounds much better than <code>self.include_dirs[0]</code>. Thanks @henryiii! Will try this out.</p>
<blockquote>
<p>I would have thought it would be present if any packages used the wheel &quot;includes&quot; folder. Maybe it's created no matter what in build/uv and only created if needed in pip? Adding <code>pybind11-global</code> is a way to get a package that using the includes wheel folder for testing. Is the folder empty?</p>
</blockquote>
<p>The <code>include</code> dir in the tmp folder does not exit. These are the folders in the tmp dir, at running time:</p>
<pre><code>bin
get_requires_for_build_wheel.txt
pyvenv.cfg
CACHEDIR.TAG
.gitignore
lib
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-12 21:17</div>
            <div class="timeline-body"><p>I think uv's behavior is correct, so gonna close.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-07-12 21:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andiradulescu">@andiradulescu</a> on 2024-07-13 06:39</div>
            <div class="timeline-body"><p>Thanks for the help!</p>
<p>For me it still doesnâ€™t make sense why there is a non-existent <code>include</code> dir there, but in <code>pip</code> isnâ€™t, as you also said.</p>
<p>I would like to investigate this whole issue myself. Any pointers where this dir is injected?</p>
<p>As for casadi I will try to implement the correct approach suggested earlier.</p>
<p>Again, thanks!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 05:34:21 UTC
    </footer>
</body>
</html>
