<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Some packages can not be installed with uv contrary to pip, like `ziglang` - astral-sh/uv #6615</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Some packages can not be installed with uv contrary to pip, like `ziglang`</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/6615">#6615</a>
        opened by <a href="https://github.com/Coruscant11">@Coruscant11</a>
        on 2024-08-25 19:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Coruscant11">@Coruscant11</a> on 2024-08-25 19:46</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

<p>Hello üôÇ First let me thank you for this awesome project !! ‚ù§Ô∏è</p>
<h2>The issue</h2>
<p>By using <code>uv</code>, I somehow managed to find a strange behaviour in wheel installations.
Indeed, on Linux, I was not able to install the <code>ziglang</code> package with <code>uv</code>.
Here is the error message:</p>
<pre><code class="language-console">(fixeduv) root@871e96b7ad46:/uv# uv pip install ziglang
Resolved 1 package in 225ms
error: Failed to install: ziglang-0.13.0-py3-none-manylinux_2_17_aarch64.many
linux2014_aarch64.musllinux_1_1_aarch64.http.whl (ziglang==0.13.0)
  Caused by: The wheel is invalid: Line 5 of the WHEEL file is invalid
</code></pre>
<h2>The cause</h2>
<p>So I looked at the <code>WHEEL</code> file content:</p>
<pre><code class="language-email">Wheel-Version: 1.0
Generator: ziglang make_wheels.py
Root-Is-Purelib: false
Tag:
  py3-none-manylinux_2_17_aarch64.manylinux2014_aarch64.musllinux_1_1_aarch64
</code></pre>
<blockquote>
<p>Hint: the markdown syntax is <code>email</code>
You can reproduce the parsing error with <a href="https://github.com/astral-sh/uv/blob/d8c41481ec884cc5166bcfadd95674ff7b2e918d/crates/install-wheel-rs/src/wheel.rs#L843">a unit test testing this wheel content here</a></p>
</blockquote>
<p>Meanwhile, pip can totally install it.
We can directly see that the tag value is containing a linesep and two spaces. So we could say that the wheel is indeed invalid, and <code>uv</code> is not to blame here. But the fact is that pip is installing the wheel without any issue...</p>
<p>So i looked at the source code of <code>uv</code> and <code>pip</code>. And I discovered that the parsing method was not the same.
While <a href="https://github.com/astral-sh/uv/blob/d8c41481ec884cc5166bcfadd95674ff7b2e918d/crates/install-wheel-rs/src/wheel.rs#L801">uv is using a simple key value text file parsing method</a>, <code>pip</code> is using <code>email.message_from_file</code> function from the python standard library, <a href="https://github.com/pypa/pip/blob/81041f7f573e89361e6ed934436adb6bf40ea3bc/src/pip/_vendor/distlib/wheel.py#L542">as you can see here</a>.</p>
<p>But not only uv, <a href="https://github.com/pypa/wheel/blob/main/src/wheel/_bdist_wheel.py#L462">bdist_wheel too</a></p>
<p>So I deduced that the <code>WHEEL</code> and <code>METADATA</code> files should be generated with email headers syntax.
Furthermore, by looking at the source code of <code>uv</code> and <code>pip</code>, we can also see that the <code>Tag</code> field is totally useless and not read, because both are fetching the tag from the wheel filename. So this issue is only a parsing file method issue.</p>
<p>But then I was then wondering, what could be the reason making uv maintainers not using the same parsing method ? For sure the PEP specification fo the wheels should tell that we need to use email messages formats right ?
But the PEP is in fact only talking about <a href="https://peps.python.org/pep-0491/#file-contents">basic key value format</a>
<img width="500" alt="image" src="https://github.com/user-attachments/assets/c25cfe37-f641-4808-8167-f6e5f91cb35b">
I should probably contact them in order to have their opinion! üòÑ</p>
<h2>Solution</h2>
<p>I think the solution here is pretty simple : let's use the same parsing method as <code>pip</code>, which is parsing these file as email messages! üöÄ
<code>uv</code> needs to be as fast as possible, so I found the <a href="https://docs.rs/mail-parser/latest/mail_parser/">mail_parser crate</a>
And the test runs as fast as the previous parsing method, sometimes even faster.
I will linked the pull-request #6616: waiting for your opinion! üòä
I also added a unit test for this specific use case.</p>
<p>Here is the result:</p>
<pre><code class="language-console">(fixeduv) root@871e96b7ad46:/uv# uv pip install ziglang
Resolved 1 package in 225ms
error: Failed to install: ziglang-0.13.0-py3-none-manylinux_2_17_aarch64.many
linux2014_aarch64.musllinux_1_1_aarch64.http.whl (ziglang==0.13.0)
  Caused by: The wheel is invalid: Line 5 of the WHEEL file is invalid
(fixeduv) root@871e96b7ad46:/uv# ./target/release/uv pip install ziglang
Resolved 1 package in 3ms
Installed 1 package in 177ms
 + ziglang==0.13.0
(fixeduv) root@871e96b7ad46:/uv# uname -a
Linux 871e96b7ad46 6.8.11-300.fc40.aarch64 #1 SMP PREEMPT_DYNAMIC Mon May 27
15:22:03 UTC 2024 aarch64 GNU/Linux
</code></pre>
<p>Thanks !!! I am open to anything if needed, first contribution on this awesome project here üòÑ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Some wheel can not be installed with uv contrary to pip, like `ziglang`" to "Some packages can not be installed with uv contrary to pip, like `ziglang`" by @Coruscant11 on 2024-08-25 19:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/6616.html">astral-sh/uv#6616</a> on 2024-08-25 19:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-08-25 20:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">compatibility</span> added by @charliermarsh on 2024-08-25 20:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-08-25 22:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:34 UTC
    </footer>
</body>
</html>
