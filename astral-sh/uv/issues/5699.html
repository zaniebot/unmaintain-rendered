<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>--no-binary in conjunction with a custom uv index url results in a failure to build. - astral-sh/uv #5699</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>--no-binary in conjunction with a custom uv index url results in a failure to build.</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/5699">#5699</a>
        opened by <a href="https://github.com/harmstyler">@harmstyler</a>
        on 2024-08-01 18:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harmstyler">@harmstyler</a></div>
            <div class="timeline-body"><p>When I attempt to use <code>--no-binary</code> in conjunction  with a custom uv index url via the <code>UV_INDEX_URL</code> environment variable, then uv still tries to grab the whl files but then errors because it can't use them. The .tar.gz build files are available, as that was my first suspission. The normal <code>pip install --no-binary</code> works with this setup, also.</p>
<p>I'm using <code>uv</code> on a docker container - Ubuntu 20.04
We're using the system python - Python 3.8.10</p>
<p>uv version:  0.2.32</p>
<p>The command I ran:</p>
<pre><code>uv pip -vvv install --no-cache --no-binary :all: -r requirements.txt
</code></pre>
<p>The output:</p>
<pre><code> uv_requirements::specification::from_source source=requirements.txt
    0.008109s DEBUG uv_python::discovery Searching for Python interpreter in system path
    0.056792s DEBUG uv_python::discovery Found `cpython-3.8.10-linux-x86_64-gnu` at `/tmp/.venv/bin/python3` (virtual environment)
    0.056859s DEBUG uv::commands::pip::install Using Python 3.8.10 environment at .venv/bin/python3
    0.056901s DEBUG uv_fs Acquired lock for `.venv`
    0.056958s DEBUG uv::commands::pip::install At least one requirement is not satisfied: paho-mqtt==1.3.1
 uv_client::linehaul::linehaul
    0.057713s DEBUG uv_client::base_client Using request timeout of 30s
 uv_resolver::flat_index::from_entries
 uv_resolver::resolver::solve
    0.060195s   0ms DEBUG uv_resolver::resolver Solving with installed Python version: 3.8.10
   uv_resolver::resolver::choose_version package=root
   uv_resolver::resolver::get_dependencies_forking package=root, version=0a0.dev0
     uv_resolver::resolver::get_dependencies package=root, version=0a0.dev0
    0.060320s   0ms DEBUG uv_resolver::resolver Adding direct dependency: oic==1.7.0
    0.060357s   0ms DEBUG uv_resolver::resolver Adding direct dependency: paho-mqtt==1.3.1
   uv_resolver::resolver::choose_version package=oic
 uv_resolver::resolver::process_request request=Versions oic
   uv_client::registry_client::simple_api package=oic
     uv_client::cached_client::get_cacheable
       uv_client::cached_client::read_and_parse_cache file=/tmp/.tmpKji4il/simple-v10/index/ab2a7f31a81931c8/oic.rkyv
 uv_resolver::resolver::process_request request=Versions paho-mqtt
   uv_client::registry_client::simple_api package=paho-mqtt
     uv_client::cached_client::get_cacheable
       uv_client::cached_client::read_and_parse_cache file=/tmp/.tmpKji4il/simple-v10/index/ab2a7f31a81931c8/paho-mqtt.rkyv
 uv_client::cached_client::from_path_sync path=&quot;/tmp/.tmpKji4il/simple-v10/index/ab2a7f31a81931c8/oic.rkyv&quot;
 uv_client::cached_client::from_path_sync path=&quot;/tmp/.tmpKji4il/simple-v10/index/ab2a7f31a81931c8/paho-mqtt.rkyv&quot;
 uv_resolver::resolver::process_request request=Prefetch paho-mqtt ==1.3.1
 uv_resolver::resolver::process_request request=Prefetch oic ==1.7.0
        0.061368s   0ms DEBUG uv_client::cached_client No cache entry for: https://pkgs.dev.azure.com/acme/project/_packaging/acme_feed/pypi/simple/oic/
       uv_client::cached_client::fresh_request url=&quot;https://pkgs.dev.azure.com/acme/project/_packaging/acme_feed/pypi/simple/oic/&quot;
        0.061507s   0ms DEBUG uv_client::cached_client No cache entry for: https://pkgs.dev.azure.com/acme/project/_packaging/acme_feed/pypi/simple/paho-mqtt/
       uv_client::cached_client::fresh_request url=&quot;https://pkgs.dev.azure.com/acme/project/_packaging/acme_feed/pypi/simple/paho-mqtt/&quot;
       uv_client::cached_client::new_cache file=/tmp/.tmpKji4il/simple-v10/index/ab2a7f31a81931c8/oic.rkyv
       uv_client::registry_client::parse_simple_api package=oic
         uv_client::html::parse url=https://pkgs.dev.azure.com/acme/project/_packaging/acme_feed/pypi/simple/oic/
   uv_resolver::version_map::from_metadata
   uv_distribution::distribution_database::get_or_build_wheel_metadata dist=oic==1.7.0
     uv_client::registry_client::wheel_metadata built_dist=oic==1.7.0
      0.381445s 321ms DEBUG uv_resolver::resolver Searching for a compatible version of oic (==1.7.0)
       uv_client::cached_client::get_serde
      0.381527s 321ms DEBUG uv_resolver::resolver Selecting: oic==1.7.0 [compatible] (oic-1.7.0.tar.gz)
         uv_client::cached_client::get_cacheable
           uv_client::cached_client::read_and_parse_cache file=/tmp/.tmpKji4il/wheels-v1/index/ab2a7f31a81931c8/oic/oic-1.7.0-py3-none-any.msgpack
 uv_client::cached_client::from_path_sync path=&quot;/tmp/.tmpKji4il/wheels-v1/index/ab2a7f31a81931c8/oic/oic-1.7.0-py3-none-any.msgpack&quot;
   uv_resolver::resolver::get_dependencies_forking package=oic, version=1.7.0
     uv_resolver::resolver::get_dependencies package=oic, version=1.7.0
            0.381986s   0ms DEBUG uv_client::cached_client No cache entry for: https://pkgs.dev.azure.com/acme/&lt;key&gt;/_packaging/&lt;pkg_key&gt;/pypi/download/oic/1.7/oic-1.7.0-py3-none-any.whl#sha256=b74bd06c7de1ab4f8e798f714062e6a68f68ad9cdbed1f1c30a7fb887602f321
           uv_client::cached_client::fresh_request url=&quot;https://pkgs.dev.azure.com/acme/&lt;key&gt;/_packaging/&lt;pkg_key&gt;/pypi/download/oic/1.7/oic-1.7.0-py3-none-any.whl#sha256=b74bd06c7de1ab4f8e798f714062e6a68f68ad9cdbed1f1c30a7fb887602f321&quot;
      0.445964s  64ms WARN uv_distribution::distribution_database Range requests unsupported when fetching metadata for oic==1.7.0; downloading wheel directly (HTTP status client error (405 Method Not Allowed) for url (https://pkgs.dev.azure.com/acme/&lt;key&gt;/_packaging/&lt;pkg_key&gt;/pypi/download/oic/1.7/oic-1.7.0-py3-none-any.whl#sha256=b74bd06c7de1ab4f8e798f714062e6a68f68ad9cdbed1f1c30a7fb887602f321))
error: Failed to download `oic==1.7.0`
  Caused by: Using pre-built wheels is disabled
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-01 18:05</div>
            <div class="timeline-body"><p>Thanks for the report. This is weird... I suspect this is a regression? I'm not sure why we select the source distribution then try to download the wheel.</p>
<p>This error is thrown at</p>
<p>https://github.com/astral-sh/uv/blob/41c1fc0c4dd268fcd5caf5551b2e7be334865716/crates/uv-distribution/src/distribution_database.rs#L153</p>
<p>which we are calling from:</p>
<p>https://github.com/astral-sh/uv/blob/41c1fc0c4dd268fcd5caf5551b2e7be334865716/crates/uv-distribution/src/distribution_database.rs#L130-L136</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-01 18:10</div>
            <div class="timeline-body"><p>Does this error occur if you do <code>uv cache clean oic</code> first? We <em>do</em> allow reading metadata from cached wheels with <code>--no-binary</code> â€” maybe we're trying to refresh the cache?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-01 18:22</div>
            <div class="timeline-body"><p>I can take a look.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-08-01 18:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-01 18:50</div>
            <div class="timeline-body"><p>It's possible that in <code>--no-binary</code> mode, we still use wheels to fetch <em>metadata</em> (even though we don't download and install them). My guess is that's what's happening here, and we're then hitting the fallback (downloading the wheel) since your registry doesn't support range requests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-08-01 18:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-01 18:54</div>
            <div class="timeline-body"><p>@harmstyler -- Just curious, what's the motivation for using <code>--no-binary</code>? Trying to make a decision on how to approach this change, just trying to learn more about the use-cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harmstyler">@harmstyler</a> on 2024-08-01 19:12</div>
            <div class="timeline-body"><blockquote>
<p>@harmstyler -- Just curious, what's the motivation for using <code>--no-binary</code>? Trying to make a decision on how to approach this change, just trying to learn more about the use-cases.</p>
</blockquote>
<p>Our company wants to build the whl files for security reasons. We used to use the <code>no-manylinux</code> package in the past. That package outlines the <em>why</em> pretty well https://pypi.org/project/no-manylinux/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-08-06 18:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-08-06 18:14</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:25:53 UTC
    </footer>
</body>
</html>
