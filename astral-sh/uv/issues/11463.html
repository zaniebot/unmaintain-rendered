<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>universal {lock, pip compile}: ability to ignore wheels for certain platforms during resolution - astral-sh/uv #11463</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>universal {lock, pip compile}: ability to ignore wheels for certain platforms during resolution</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/11463">#11463</a>
        opened by <a href="https://github.com/paveldikov">@paveldikov</a>
        on 2025-02-12 22:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/paveldikov">@paveldikov</a> on 2025-02-12 22:59</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Example use case: I want universal resolution, except I really do not care about Mac (and in fact, Mac wheels are actively sabotaging the resolution)</p>
<p>Something like <code>--exclude-python-platform 'macos_*'</code> (wildcards would be nice too üòÅ)</p>
<h3>Example</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @paveldikov on 2025-02-12 22:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-12 22:59</div>
            <div class="timeline-body"><p>I think you can accomplish this with <code>environments</code>, which lets you narrow the set of supported environments:</p>
<pre><code class="language-toml">[tool.uv]
environments = [&quot;sys_platform != 'darwin'&quot;]
</code></pre>
<p>See: https://docs.astral.sh/uv/reference/settings/#environments</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2025-02-12 23:00</div>
            <div class="timeline-body"><p>That would be amazing. Testing...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2025-02-12 23:08</div>
            <div class="timeline-body"><p>No dice. <code>uv pip compile --universal pyproject.toml</code> did not seem to pick it up.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-12 23:11</div>
            <div class="timeline-body"><p>Is the <code>pyproject.toml</code> actually in CWD? Like is uv picking up settings from it? I don't think it would work by pointing to an arbitrary <code>pyproject.toml</code>, it has to be the file that using is using for configuration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2025-02-12 23:13</div>
            <div class="timeline-body"><p>Yes it is and I deliberately broke the syntax to find out and <code>uv</code> got annoyed.</p>
<p>Note, the problem here is that the macos wheels have a tendency to give 403 errors on fetch. I wonder if <code>environments</code> is implemented after the initial computation i.e. it's a prune rather than an input filter?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-12 23:14</div>
            <div class="timeline-body"><p>Ah yeah, I don't think this would fix that. <code>environments</code> is a filter at the end <em>and</em> we avoid solving branches in the resolution tree that are disjoint with the specified environments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2025-02-12 23:22</div>
            <div class="timeline-body"><p>Yeah... this issue is also a cousin of #5260 I'd raised last year.</p>
<p>Basically false-positive 403s are a fact of life for us (and basically anyone who uses caching proxy indexes with bolted-on security scanning on top). And I am desperately trying to minimise the impact to developer productivity...</p>
<p>(Right now I find myself having to deliver lectures on universal locking every time a user insists that 'this is clearly broken since I do not use Mac!')</p>
<p>Could <code>environments</code> be made to act as a filter at the beginning, at least in the <code>sys_platform</code> case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "universal {lock, pip compile}: ability to exclude certain platforms" to "universal {lock, pip compile}: ability to ignore wheels for certain platforms" by @charliermarsh on 2025-02-13 15:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "universal {lock, pip compile}: ability to ignore wheels for certain platforms" to "universal {lock, pip compile}: ability to ignore wheels for certain platforms during resolution" by @charliermarsh on 2025-02-13 15:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-13 15:18</div>
            <div class="timeline-body"><p>Possibly... Is it <em>just</em> macOS wheels where you experience this is your setup?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2025-02-14 09:58</div>
            <div class="timeline-body"><p>It's not strictly limited to MacOS wheels, but the prevalence there is (for some inscrutable reason) much higher. And since MacOS is not a very common platform for us, it really draws attention to itself.</p>
<p>Often times users would end up just disabling universal resolution (which is unfortunate), but at the moment we have users who are actively relying on the universal resolution so that they can have repeatable tests across multiple Python versions. (a non-universal constraints file generated for the lower bound will actively fail to install on the higher versions. And the universal file fails to generate due to the 403)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/11294.html">astral-sh/uv#11294</a> on 2025-02-28 19:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/9277.html">astral-sh/uv#9277</a> on 2025-04-08 18:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2025-08-27 09:30</div>
            <div class="timeline-body"><p>This is still an issue btw. I am aware my use case is pretty niche in the scheme of things, but I'd like to give my users a robust way of not hitting this very annoying and conspicuous roadblock.</p>
<p>I'd be happy to contribute a change if that makes things any easier, but I have very little familiarity with the resolver part of the codebase, so I'd need lots of pointers.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-08-27 10:44</div>
            <div class="timeline-body"><p>Can you use <code>tool.uv.environments</code> with <code>uv lock</code> and <code>uv export</code>? This should do a universal resolution ignoring all mac packages (including the dependency edges) and the export gives you a <code>requirements.txt</code> (or <code>pylock.toml</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2025-08-27 12:28</div>
            <div class="timeline-body"><p>Nope, it still tries to fetch the Mac wheels, and in turn hits the 403 error which I am wanting to sidestep. The filtering applies too late in the algorithm.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-08-28 10:37</div>
            <div class="timeline-body"><p>Currently, we're always selecting the macos wheel for metadata fetching. To work around the proxy constraint, we would need to consider <code>tool.uv.environments</code> in <code>PrioritizedDist</code> construction, potentially having to generate implied markers for each wheel. Another approach would be returning PEP 658 metadata in the index, this allows fetching the information that uv needs without actually downloading any zips that could get caught in a security filter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-08-28 12:05</div>
            <div class="timeline-body"><p>(This is assuming that the security filter specifically blocks zip files and other archives, while allowing plain text API responses such as a PEP 658 <code>.metadata</code> file)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:25 UTC
    </footer>
</body>
</html>
