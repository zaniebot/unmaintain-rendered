```yaml
number: 12117
title: uv build packages for torch cpu and gpu
type: issue
state: open
author: anmolnagi-fugro
labels:
  - needs-mre
assignees: []
created_at: 2025-03-11T16:34:51Z
updated_at: 2025-04-25T00:19:46Z
url: https://github.com/astral-sh/uv/issues/12117
synced_at: 2026-01-10T01:57:27Z
```

# uv build packages for torch cpu and gpu

---

_Issue opened by @anmolnagi-fugro on 2025-03-11 16:34_

### Question

I would like to build three packages such that

custom-package has only the 3 listed `dependencies`
custom-package-cpu has `dependencies + cpu optional dependencies`
custom-package-cu117 has `dependencies + cu117 optional dependencies`

I was wondering if there is a way to create 3 different build?

for reference, I can install the different dependencies as
`uv sync --extra cpu`
`uv sync --extra cu117`

Another question is why `torch==2.0.0+cpu` and `torchvision==0.19.1` are installed when I do `uv sync`

```
[project]
name = "custom-package"

dependencies = [
  "pandas==2.2.3",
  "numpy==1.23.2",
  "natsort==8.4.0",
]

[tool.setuptools.packages.find]
where = ["."]
include = ["custome-package*"]

[project.optional-dependencies]
cpu = [
  "torch==2.0.0",
  "torchvision==0.15.1",
]
cu117 = [
  "torch==2.0.0+cu117",
  "torchvision==0.15.1+cu117",
]

[dependency-groups]
dev = [
  "ipykernel"
]

[[tool.uv.index]]
name = "pytorch-cpu"
url = "https://download.pytorch.org/whl/cpu"
explicit = true

[[tool.uv.index]]
name = "pytorch-cu117"
url = "https://download.pytorch.org/whl/cu117"
explicit = true

[tool.uv]
conflicts = [
  [
    { extra = "cpu" },
    { extra = "cu117" },
  ],
]

[tool.uv.sources]
torch = [
  { index = "pytorch-cpu", extra = "cpu" },
  { index = "pytorch-cu117", extra = "cu117" },
]
torchvision = [
  { index = "pytorch-cpu", extra = "cpu" },
  { index = "pytorch-cu117", extra = "cu117" },
]
```

### Platform

_No response_

### Version

uv 0.6.5 (bcbcd0a1e 2025-03-06)

---

_Label `question` added by @anmolnagi-fugro on 2025-03-11 16:34_

---

_Comment by @charliermarsh on 2025-03-14 01:11_

Unfortunately I can't get this to resolve:

```
  × No solution found when resolving dependencies:
  ╰─▶ Because only the following versions of numpy are available:
          numpy<=1.26.0
          numpy==1.26.1
          numpy==1.26.2
          numpy==1.26.3
          numpy==1.26.4
          numpy==2.0.0
          numpy==2.0.1
          numpy==2.0.2
          numpy==2.1.0
          numpy==2.1.1
          numpy==2.1.2
          numpy==2.1.3
          numpy==2.2.0
          numpy==2.2.1
          numpy==2.2.2
          numpy==2.2.3
      and pandas==2.2.3 depends on numpy>=1.26.0, we can conclude that pandas==2.2.3 depends on numpy>=1.26.0.
      And because your project depends on numpy==1.23.2 and pandas==2.2.3, we can conclude that your project's requirements are unsatisfiable.
```

I'm happy to help if you can put together a clear reproducible example with the exact commands you ran, the `pyproject.toml`, etc.

---

_Label `question` removed by @charliermarsh on 2025-03-14 01:11_

---

_Label `needs-mre` added by @charliermarsh on 2025-03-14 01:11_

---

_Comment by @Sunhill666 on 2025-04-24 07:14_

@charliermarsh Hello, i also have the same problem, here's my `project.toml`:

```toml
[project]
name = "some-package"
version = "0.1.0"
readme = "README.md"
requires-python = ">=3.11"
dependencies = [
  "ultralytics>=8.3.112",
]

[project.optional-dependencies]
cpu = [
  "torch>=2.6.0",
  "torchvision>=0.21.0",
  "torchaudio>=2.6.0",
]

cu118 = [
  "torch>=2.6.0",
  "torchvision>=0.21.0",
  "torchaudio>=2.6.0",
]

cu124 = [
  "torch>=2.6.0",
  "torchvision>=0.21.0",
  "torchaudio>=2.6.0",
]

cu126 = [
  "torch>=2.6.0",
  "torchvision>=0.21.0",
  "torchaudio>=2.6.0",
]

[tool.uv]
conflicts = [
  [
    { extra = "cpu" },
    { extra = "cu118" },
    { extra = "cu124" },
    { extra = "cu126" },
  ],
]

[tool.uv.sources]
torch = [
  { index = "pytorch-cpu", extra = "cpu" },
  { index = "pytorch-cu118", extra = "cu118", marker = "sys_platform == 'linux' or sys_platform == 'win32'" },
  { index = "pytorch-cu124", extra = "cu124", marker = "sys_platform == 'linux' or sys_platform == 'win32'" },
  { index = "pytorch-cu126", extra = "cu126", marker = "sys_platform == 'linux' or sys_platform == 'win32'" }
]
torchvision = [
  { index = "pytorch-cpu", extra = "cpu" },
  { index = "pytorch-cu118", extra = "cu118", marker = "sys_platform == 'linux' or sys_platform == 'win32'" },
  { index = "pytorch-cu124", extra = "cu124", marker = "sys_platform == 'linux' or sys_platform == 'win32'" },
  { index = "pytorch-cu126", extra = "cu126", marker = "sys_platform == 'linux' or sys_platform == 'win32'" }
]
torchaudio = [
  { index = "pytorch-cpu", extra = "cpu" },
  { index = "pytorch-cu118", extra = "cu118", marker = "sys_platform == 'linux' or sys_platform == 'win32'" },
  { index = "pytorch-cu124", extra = "cu124", marker = "sys_platform == 'linux' or sys_platform == 'win32'" },
  { index = "pytorch-cu126", extra = "cu126", marker = "sys_platform == 'linux' or sys_platform == 'win32'" }
]

[[tool.uv.index]]
name = "pytorch-cpu"
url = "https://download.pytorch.org/whl/cpu"
explicit = true

[[tool.uv.index]]
name = "pytorch-cu118"
url = "https://download.pytorch.org/whl/cu118"
explicit = true

[[tool.uv.index]]
name = "pytorch-cu124"
url = "https://download.pytorch.org/whl/cu124"
explicit = true

[[tool.uv.index]]
name = "pytorch-cu126"
url = "https://download.pytorch.org/whl/cu126"
explicit = true

[[tool.uv.index]]
url = "https://mirrors.ustc.edu.cn/pypi/simple"
default = true
```
Why is the pytorch of cpu installed when executing `uv run` without `--extra`, and the pytorch of cuda will only be installed if `--extra` parameters are used to specify, such as `cu124`, etc. How can I use `cu124` or `cu118` by default when executing `uv run` or `uv sync`?
Thank you and look forward to your reply.

---

_Comment by @charliermarsh on 2025-04-24 12:10_

It’s because Ultralytics itself depends on PyTorch. So if you don’t specify an extra, we still need to choose some version of PyTorch. You could move Ultralytics into each of the optional groups to make the relationship / behavior more explicit.

We don’t support enabling an extra by default, but you could use dependency groups instead. We do support default dependency groups, if you look for default-groups in the docs.

---

_Comment by @Sunhill666 on 2025-04-25 00:19_

@charliermarsh Thank you for your reply.

---
