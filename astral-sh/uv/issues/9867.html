<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update AWS CodeArtifact documentation to cover `[[tool.uv.index]]` API - astral-sh/uv #9867</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Update AWS CodeArtifact documentation to cover `[[tool.uv.index]]` API</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/9867">#9867</a>
        opened by <a href="https://github.com/AdrianB-sovo">@AdrianB-sovo</a>
        on 2024-12-13 14:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/AdrianB-sovo">@AdrianB-sovo</a> on 2024-12-13 14:06</div>
            <div class="timeline-body"><p>Currently, when using <code>UV_INDEX</code> and AWS CodeArtifact, a <code>[[tool.uv.index]]</code> section is automatically added in <code>pyproject.toml</code> (e.g. when calling <code>uv add pandas</code>) with the URL that includes the token, which mean I manually have to remove it before doing a <code>git commit</code>.</p>
<p>Here an example of lines generated in <code>pyproject.toml</code> when using AWS CodeArtifact:</p>
<pre><code class="language-toml">[[tool.uv.index]]
url = &quot;https://aws:&lt;token&gt;@somecompany-123456789012.d.codeartifact.eu-central-1.amazonaws.com/pypi/development/simple/&quot;
</code></pre>
<p>Could there be a way to avoid that?</p>
<p>BTW: the doc https://docs.astral.sh/uv/guides/integration/alternative-indexes/#aws-codeartifact still uses the deprecated <code>UV_EXTRA_INDEX_URL</code> instead of <code>UV_INDEX</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/FishAlchemist">@FishAlchemist</a> on 2024-12-13 14:40</div>
            <div class="timeline-body"><p>UV can be configured to set secrets in environment variables, but I'm unsure if this approach is suitable for AWS.
https://docs.astral.sh/uv/configuration/indexes/#providing-credentials</p>
<p>e.g.</p>
<pre><code class="language-toml">[[tool.uv.index]]
name = &quot;aws-code&quot;
url = &quot;https://somecompany-123456789012.d.codeartifact.eu-central-1.amazonaws.com/pypi/development/simple/&quot;
</code></pre>
<pre><code class="language-bash">export UV_INDEX_AWS_CODE_USERNAME=aws
export UV_INDEX_AWS_CODE_PASSWORD=&lt;token&gt;
</code></pre>
<hr />
<p>I see that I've modified the twine section in this way. Perhaps I haven't made a mistake?
https://docs.aws.amazon.com/codeartifact/latest/ug/python-configure-twine.html#python-configure-twine-without-login</p>
<pre><code class="language-pypirc">[distutils]
index-servers =
 codeartifact
[codeartifact]
repository = https://my_domain-111122223333.d.codeartifact.us-west-2.amazonaws.com/pypi/my_repo/
password = auth-token
username = aws
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AdrianB-sovo">@AdrianB-sovo</a> on 2024-12-13 15:05</div>
            <div class="timeline-body"><p>Thanks, it does work! :smiley:
Maybe it should be the recommended method described in the documentation?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-12-13 15:10</div>
            <div class="timeline-body"><p>Yeah the index integration docs were community contributed before we supported <code>UV_INDEX</code> â€” we should update those to cover both modes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> added by @zanieb on 2024-12-13 15:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Section `[[tool.uv.index]]` added when using `UV_INDEX` and AWS CodeArtifact" to "Update AWS CodeArtifact documentation to cover `[[tool.uv.index]]` API" by @zanieb on 2024-12-13 15:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/FishAlchemist">@FishAlchemist</a> on 2024-12-13 15:15</div>
            <div class="timeline-body"><p>@zanieb Should we update the password authentication part of <a href="https://docs.astral.sh/uv/guides/integration/alternative-indexes/#google-artifact-registry">Google Artifact Registry</a>  at the same time?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-12-13 15:53</div>
            <div class="timeline-body"><p>Yeah it makes sense to update it all â€” I don't feel strongly about separate pull requests vs one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lmanc">@lmanc</a> on 2024-12-23 17:57</div>
            <div class="timeline-body"><p>I was about to open an identical issue, but it seems that writing the index in <code>[[tool.uv.index]]</code> is intentional.</p>
<p>The workaround I'm currently using is to set it to <code>UV_EXTRA_INDEX_URL</code>:</p>
<pre><code class="language-bash">export UV_EXTRA_INDEX_URL=&quot;https://aws:${AWS_CODEARTIFACT_TOKEN}@${AWS_DOMAIN}-${AWS_ACCOUNT_ID}.d.codeartifact.${AWS_REGION}.amazonaws.com/pypi/${AWS_CODEARTIFACT_REPOSITORY}/simple/&quot;
</code></pre>
<p>When I run <code>uv add &lt;package&gt;</code>, it says:</p>
<pre><code>$ uv add --dev &quot;pytest&gt;=8.3.4&quot;
warning: Indexes specified via `--extra-index-url` will not be persisted to the `pyproject.toml` file; use `--index` instead.
</code></pre>
<p>which is exactly what I want, as <code>UV_EXTRA_INDEX_URL</code> contains a secret.</p>
<p>@FishAlchemist suggested a way to keep the index URL secret while using the new <code>UV_INDEX</code> configuration: https://docs.astral.sh/uv/configuration/indexes/#providing-credentials.</p>
<p>However, after reading the page, I'm unsure how to set it up with this method.</p>
<p>According to https://docs.astral.sh/uv/guides/integration/alternative-indexes/#aws-codeartifact I have:</p>
<ul>
<li><code>AWS_DOMAIN</code></li>
<li><code>AWS_ACCOUNT_ID</code></li>
<li><code>AWS_ACCOUNT_ID</code></li>
<li><code>AWS_CODEARTIFACT_REPOSITORY</code></li>
<li><code>AWS_CODEARTIFACT_TOKEN</code></li>
</ul>
<p>Where should I put each one of these, using the other method? It feels like I'm missing something trivial.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lmanc">@lmanc</a> on 2024-12-23 18:35</div>
            <div class="timeline-body"><p>I think I figured it out, maybe...?</p>
<pre><code class="language-toml">[[tool.uv.index]]
name = &quot;custom-name&quot;
url = &quot;https://&lt;AWS_DOMAIN&gt;-&lt;AWS_ACCOUNT_ID&gt;.d.codeartifact.&lt;AWS_REGION&gt;.amazonaws.com/pypi/&lt;AWS_CODEARTIFACT_REPOSITORY&gt;/simple/&quot;
</code></pre>
<p>Where <code>&lt;&gt;</code> are placeholders, not environment variables.</p>
<p>Then, in <code>.bashrc</code> or wherever environment variables are defined:</p>
<pre><code class="language-bash">export AWS_DOMAIN=
export AWS_ACCOUNT_ID=
export AWS_REGION=
export AWS_CODEARTIFACT_REPOSITORY=

export AWS_CODEARTIFACT_TOKEN=&quot;$(
    aws codeartifact get-authorization-token \
    --domain $AWS_DOMAIN \
    --domain-owner $AWS_ACCOUNT_ID \
    --region $AWS_REGION \
    --query authorizationToken \
    --output text
)&quot;

export UV_INDEX_CUSTOM_NAME_USERNAME=&quot;aws&quot;
export UV_INDEX_CUSTOM_NAME_PASSWORD=&quot;$AWS_CODEARTIFACT_TOKEN&quot;
</code></pre>
<p>Where:</p>
<ul>
<li><code>name = &lt;custom-name&gt;</code> must match <code>UV_INDEX_&lt;CUSTOM_NAME&gt;_USERNAME</code>, written in all caps with <code>_</code> replacing <code>-</code></li>
<li><code>aws</code> is just a placeholder for logging into CodeArtifact via a token.</li>
<li><code>UV_INDEX_&lt;NAME&gt;_PASSWORD</code> could also be a token.</li>
</ul>
<p>Am I right?</p>
<p>This is slightly counterintuitive, and I agree that it should be added to the documentation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Haknt">@Haknt</a> on 2025-01-06 13:44</div>
            <div class="timeline-body"><p>@lmanc You seem to be on the right track, and this approach looks reasonable to me.</p>
<hr />
<p>Hereâ€™s how I understand it could work:</p>
<h3>Adding a Package with a Specific Index:</h3>
<ol>
<li><p><strong>Set Environment Variables:</strong></p>
<pre><code class="language-bash">export AWS_DOMAIN=
export AWS_ACCOUNT_ID=
export AWS_REGION=
export AWS_CODEARTIFACT_REPOSITORY=

export AWS_CODEARTIFACT_TOKEN=&quot;$(
    aws codeartifact get-authorization-token \
    --domain $AWS_DOMAIN \
    --domain-owner $AWS_ACCOUNT_ID \
    --region $AWS_REGION \
    --query authorizationToken \
    --output text
)&quot;

export UV_INDEX_CUSTOM_NAME_USERNAME=&quot;aws&quot;
export UV_INDEX_CUSTOM_NAME_PASSWORD=&quot;$AWS_CODEARTIFACT_TOKEN&quot;
</code></pre>
</li>
<li><p><strong>Add a Package Using UV:</strong></p>
<pre><code class="language-bash">uv add &lt;PACKAGE_NAME&gt; --index custom_name=&lt;INDEX_URL&gt;
</code></pre>
</li>
</ol>
<h3>Alternatively:</h3>
<p>If youâ€™d rather include the index URL directly, you might use a command like this:</p>
<pre><code class="language-bash">uv add &lt;PACKAGE_NAME&gt; --index custom_name=https://${AWS_DOMAIN}-${AWS_ACCOUNT_ID}.d.codeartifact.${AWS_REGION}.amazonaws.com/pypi/${AWS_CODEARTIFACT_REPOSITORY}/simple/
</code></pre>
<p>This should add the following lines to your <code>pyproject.toml</code> file:</p>
<pre><code class="language-yaml">[tool.uv.sources]
&lt;PACKAGE_NAME&gt; = { index = &quot;custom-name&quot; }

[[tool.uv.index]]
name = &quot;custom-name&quot;
url = &quot;&lt;INDEX_URL&gt;&quot;
</code></pre>
<h3>Using the Index Exclusively for a Single Library:</h3>
<p>If you want the index to apply only to the specific library, you could try adding <code>explicit = true</code> like this:</p>
<pre><code class="language-yaml">[tool.uv.sources]
&lt;PACKAGE_NAME&gt; = { index = &quot;custom-name&quot; }

[[tool.uv.index]]
name = &quot;custom-name&quot;
url = &quot;&lt;INDEX_URL&gt;&quot;
explicit = true
</code></pre>
<hr />
<p>If thereâ€™s anything Iâ€™ve misunderstood or missed, feel free to correct me. Also, I agree that adding this to the documentation would make things clearer for others encountering similar challenges. ðŸ˜Š</p>
<blockquote>
<p>Note: <code>&lt;PACKAGE_NAME&gt;</code> and <code>&lt;INDEX_URL&gt;</code> are placeholders. Replace them with the actual package name and index URL.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @zanieb on 2025-01-06 17:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AdrianB-sovo">@AdrianB-sovo</a> on 2025-01-06 22:23</div>
            <div class="timeline-body"><p>I still see an issue with that in my case, where we have <code>dev</code> and <code>production</code> indexes in CodeArtifact.
Currently, we have:</p>
<p><strong>pyproject.toml</strong></p>
<pre><code class="language-TOML"># ...

dependencies = [
    &quot;my-package[aws,utils]==3.0.123&quot;,
]

[[tool.uv.index]]
name = &quot;aws-codeartifact&quot;
url = &quot;https://company-123456789.d.codeartifact.eu-central-1.amazonaws.com/pypi/development/simple/&quot;
</code></pre>
<p>When we develop, we export the two following env variables:</p>
<pre><code class="language-bash">export UV_INDEX_AWS_CODEARTIFACT_USERNAME=aws
export UV_INDEX_AWS_CODEARTIFACT_PASSWORD=&quot;${CODEARTIFACT_TOKEN}&quot;
</code></pre>
<p>This will create a <code>uv.lock</code> with something like:</p>
<pre><code class="language-TOML">[[package]]
name = &quot;my-package&quot;
version = &quot;3.0.123&quot;
source = { registry = &quot;https://company-123456789.d.codeartifact.eu-central-1.amazonaws.com/pypi/development/simple/&quot; }
sdist = { url = &quot;https://company-123456789.d.codeartifact.eu-central-1.amazonaws.com/pypi/development/simple/my-package/3.0.123/my-package-3.0.123.tar.gz&quot;, hash = &quot;sha256:12345...&quot; }
wheels = [
    { url = &quot;https://company-123456789.d.codeartifact.eu-central-1.amazonaws.com/pypi/development/simple/my-package/3.0.123/my-package-3.0.123-py3-none-any.whl&quot;, hash = &quot;sha256:12345...&quot; },
]
</code></pre>
<p>Now, I'm searching how I could instead use the <code>production</code> index instead when deploying into production with the CI (i.e. <code>https://company-123456789.d.codeartifact.eu-central-1.amazonaws.com/pypi/production/simple/</code>).</p>
<p>One way would be to do <code>uv export --frozen --no-dev --no-hashes &gt; requirements.txt</code>, then install using <code>pip</code> like I would usually do before using <code>uv</code>, but it's not a great solution...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/9544.html">astral-sh/uv#9544</a> on 2025-01-07 19:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/5605.html">astral-sh/uv#5605</a> on 2025-01-10 15:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/10826.html">astral-sh/uv#10826</a> on 2025-01-21 21:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mkniewallner">@mkniewallner</a> on 2025-01-21 21:25</div>
            <div class="timeline-body"><p>Started a draft to rework the documentation in https://github.com/astral-sh/uv/pull/10826.</p>
<p>The main reason it's in draft is because I won't be able to test AWS CodeArtifact nor Google Artifact Registry until next week, and won't be able to test Azure Artifacts at all. But if someone is able to test the changes before that, especially for Azure Artifacts as I can't, feel free to report what works and what doesn't in the PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-02-26 15:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-02-26 15:52</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:01 UTC
    </footer>
</body>
</html>
