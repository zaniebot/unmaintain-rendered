<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv add` and `uv lock` fail on corporate network - astral-sh/uv #6563</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`uv add` and `uv lock` fail on corporate network</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/6563">#6563</a>
        opened by <a href="https://github.com/maxfirman">@maxfirman</a>
        on 2024-08-23 23:44
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/maxfirman">@maxfirman</a> on 2024-08-23 23:44</div>
            <div class="timeline-body"><p>I'm running into some problems trying to use <code>uv add</code> and <code>uv lock</code> commands on a machine running behind a corporate proxy.</p>
<p>I have configured internal pypi mirrors in my <code>~/.config/uv/uv.toml</code> file:</p>
<pre><code class="language-toml">[pip]
index-url = &quot;&lt;pypi_mirrror_url&gt;&quot;
</code></pre>
<p>I then run through the following &quot;hello world&quot; example and get some errors along the way:</p>
<pre><code>➜  uv init hello-uv             
Initialized project `hello-uv` at `/home/develop/hello-uv`

➜  cd hello-uv
 
➜  uv add requests 
Using Python 3.12.3 interpreter at: /home/linuxbrew/.linuxbrew/opt/python@3.12/bin/python3.12
Creating virtualenv at: .venv
⠼ requests==1.2.3                                                                                                                                   error: Failed to download and build `requests==1.2.3`
  Caused by: Failed to extract archive
  Caused by: Invalid gzip header

➜  cat pyproject.toml
[project]
name = &quot;hello-uv&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = [
    &quot;requests&quot;,
]

[build-system]
requires = [&quot;hatchling&quot;]
build-backend = &quot;hatchling.build&quot;

➜  uv lock           
⠼ requests==1.2.3                                                                                                                                   error: Failed to download and build `requests==1.2.3`
  Caused by: Failed to extract archive
  Caused by: Invalid gzip header

➜  uv pip compile pyproject.toml
Resolved 5 packages in 1.66s
# This file was autogenerated by uv via the following command:
#    uv pip compile pyproject.toml
certifi==2024.7.4
    # via requests
charset-normalizer==3.3.2
    # via requests
idna==3.8
    # via requests
requests==2.32.3
    # via hello-uv (pyproject.toml)
urllib3==2.2.2
    # via requests
</code></pre>
<p>The interesting thing is that the <code>uv pip compile pyproject.toml</code> command succeeds, whereas the <code>uv add</code> and <code>uv lock</code> commands fail.</p>
<p>If I subsequently delete the <code>~/.config/uv/uv.toml</code> file, then the <code>uv pip compile pyproject.toml</code> command fails with the same error:</p>
<pre><code>➜  uv pip compile pyproject.toml
⠸ requests==1.2.3                                                                                                                                   error: Failed to download and build `requests==1.2.3`
  Caused by: Failed to extract archive
  Caused by: Invalid gzip header
</code></pre>
<p>This would seem to imply that the <code>uv add</code> and <code>uv lock</code> commands are not respecting the <code>index-url</code> configuration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-23 23:46</div>
            <div class="timeline-body"><p>Can you try removing the <code>[pip]</code> header from your <code>uv.toml</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-23 23:46</div>
            <div class="timeline-body"><p>Settings under <code>[pip]</code> <em>only</em> apply to <code>uv pip</code>; settings at the top-level apply to <em>everything</em> (<code>uv sync</code>, <code>uv lock</code>, and <code>uv pip</code> et al).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2024-08-23 23:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxfirman">@maxfirman</a> on 2024-08-23 23:52</div>
            <div class="timeline-body"><p>Brilliant, that worked! Thanks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @maxfirman on 2024-08-23 23:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-23 23:57</div>
            <div class="timeline-body"><p>@charliermarsh why do we fail with this weird error? because the proxy returns a weird response?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-23 23:58</div>
            <div class="timeline-body"><p>(@maxfirman if you can get more details about what the response from the proxy is that'd be helpful for improving the error message for other users, uv will say more about the requests with <code>RUST_LOG=trace uv add --verbose ...</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxfirman">@maxfirman</a> on 2024-08-24 00:47</div>
            <div class="timeline-body"><p><a href="https://github.com/user-attachments/files/16734717/uv_add_failure.log">uv_add_failure.log</a>
@zanieb log file attached</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @maxfirman on 2024-08-24 00:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-24 01:43</div>
            <div class="timeline-body"><p>What kind of response is returned when you <code>GET https://files.pythonhosted.org/packages/61/79/efc316760a906763de872d7328c9bf8c5af28708a35fdae57fbb4ee005f7/requests-1.2.3.tar.gz</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxfirman">@maxfirman</a> on 2024-08-24 19:42</div>
            <div class="timeline-body"><p><a href="https://github.com/user-attachments/files/16737785/curl_pythonhosted.log">curl_pythonhosted.log</a>
@zanieb see attached log. The request goes via our proxy and gets redirected to a our Artifactory which ultimately returns a 404. This looks likely to be a proxy misconfiguration on our end. It would definitely be better to have uv fail immediately and surface the 404 error.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @charliermarsh on 2024-08-26 14:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">error messages</span> added by @charliermarsh on 2024-08-26 14:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/brendan-morin">@brendan-morin</a> on 2024-12-11 06:24</div>
            <div class="timeline-body"><p>Running into (I think) similar:</p>
<pre><code>RUST_LOG=trace uv pip install --verbose --native-tls https://my.host.com/mylib/archive/refs/tags/v5.1.15.tar.gz
</code></pre>
<p>Logs (edited to provide corrected logs)</p>
<pre><code>DEBUG Using Python 3.11.9 environment at .venv
TRACE Checking lock for `.venv` at `.venv/.lock`
DEBUG Acquired lock for `.venv`
DEBUG At least one requirement is not satisfied: https://my.host.com/mylib/archive/refs/tags/v5.1.15.tar.gz
DEBUG Using request timeout of 30s
TRACE Checking lock for `/.../Caches/uv/sdists-v6/url/7581192789a2c104` at `/.../Caches/uv/sdists-v6/url/7581192789a2c104/.lock`
DEBUG Acquired lock for `/.../Caches/uv/sdists-v6/url/7581192789a2c104`
TRACE No cache entry exists for /.../Caches/uv/sdists-v6/url/7581192789a2c104/revision.http
DEBUG No cache entry for: https://my.host.com/mylibx/archive/refs/tags/v5.1.15.tar.gz
TRACE Sending fresh GET request for https://my.host.com/mylib/archive/refs/tags/v5.1.15.tar.gz
TRACE Handling request for https://my.host.com/mylib/archive/refs/tags/v5.1.15.tar.gz
TRACE Request for https://my.host.com/mylib/archive/refs/tags/v5.1.15.tar.gz is unauthenticated, checking cache
TRACE No credentials in cache for URL https://my.host.com/mylib/archive/refs/tags/v5.1.15.tar.gz
TRACE Attempting unauthenticated request for https://my.host.com/mylib/archive/refs/tags/v5.1.15.tar.gz
TRACE checkout waiting for idle connection: (&quot;https&quot;, my.host.com)
DEBUG starting new connection: https://my.host.com/    
TRACE Http::connect; scheme=Some(&quot;https&quot;), host=Some(&quot;my.host.com&quot;), port=None
DEBUG connecting to 10.52.226.221:443
DEBUG connected to 10.52.226.221:443
TRACE http1 handshake complete, spawning background dispatcher task
TRACE checkout dropped for (&quot;https&quot;, my.host.com)
TRACE put; add idle connection for (&quot;https&quot;, my.host.com)
DEBUG pooling idle connection for (&quot;https&quot;, my.host.com)
DEBUG redirecting 'https://my.host.com/mylib/archive/refs/tags/v5.1.15.tar.gz' to 'https://...%2Farchive%2Frefs%2Ftags%2Fv5.1.15.tar.gz'    
TRACE take? (&quot;https&quot;, my.host.com): expiration = Some(90s)
DEBUG reuse idle connection for (&quot;https&quot;, my.host.com)
TRACE idle interval checking for expired
TRACE cached request https://my.host.com/mylib/archive/refs/tags/v5.1.15.tar.gz is not storable because its response has a 'no-store' cache-control directive
DEBUG Downloading source distribution: https://my.host.com/mylib/archive/refs/tags/v5.1.15.tar.gz
DEBUG Released lock at `/.../Caches/uv/sdists-v6/url/7581192789a2c104/.lock`
DEBUG Released lock at `/.../.venv/.lock`
error: Failed to extract archive
  Caused by: Invalid gzip header
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/brendan-morin">@brendan-morin</a> on 2024-12-11 17:39</div>
            <div class="timeline-body"><p>Ok in my case it appears credential oriented, and the credentials are not being read from netrc properly (though they seem to work fine for other commands). I confirmed this with some gzip commands:</p>
<pre><code>&gt; curl -L https://my.host.com/mylib/archive/refs/tags/v5.1.15.tar.gz -o package.tar.gz
&gt; gzip -t package.tar.gz                                                                                                                                        

gzip: package.tar.gz: not in gzip format

&gt; cat package.tar.gz

&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
...
</code></pre>
<p>Basically, it just ends up grabbing the html for our internal &quot;please sign in to access GitHub&quot; page (the redirect log above should have cued me in). Looking at my .netrc, it seems my credentials should be passed through, but aren't for some reason:</p>
<pre><code>machine my.host.com
login username
password ghp_token
</code></pre>
<p>I can confirm if I sub into the url that it does work.</p>
<pre><code>uv pip install --native-tls https://username:ghp_token@my.host.com/mylib/archive/refs/tags/v5.1.15.tar.gz
</code></pre>
<p>Do we know why it wouldn't be picking up netrc in this case? Is this expected behavior?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:59 UTC
    </footer>
</body>
</html>
