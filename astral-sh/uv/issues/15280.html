<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docker - When adding a dependency eveything is installed - astral-sh/uv #15280</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Docker - When adding a dependency eveything is installed</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/15280">#15280</a>
        opened by <a href="https://github.com/errajibadr">@errajibadr</a>
        on 2025-08-14 13:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/errajibadr">@errajibadr</a> on 2025-08-14 13:33</div>
            <div class="timeline-body"><h3>Question</h3>
<p>Description
When I add a new dependency to my project using ⁠uv add package, the Docker build step that runs ⁠uv sync --no-install-project reinstalls all dependencies instead of just the new one.
I've structured my Dockerfile in two stages to prevent source code changes from triggering a full dependency reinstall, but this doesn't seem to work when adding new dependencies.</p>
<p>Expected behavior</p>
<p>When adding a new dependency with ⁠uv add package, only the new package should be installed during the Docker build, leveraging the cache for existing dependencies.</p>
<p>Actual behavior
All dependencies in docker Build are reinstalled from scratch when ⁠pyproject.toml or ⁠uv.lock changes.
Questions</p>
<ol>
<li>Is there a way to avoid full dependency reinstallation when adding a new package? </li>
<li>Am I structuring my Dockerfile incorrectly for this use case? </li>
<li>Are there any best practices for optimizing Docker builds with ⁠uv when dependencies change frequently?</li>
</ol>
<pre><code>FROM python:3.12.8-slim-bookworm

ENV UV_COMPILE_BYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV UV_LINK_MODE=copy
ENV UV_PROJECT_ENVIRONMENT=/usr/local 

WORKDIR /app

# Install the project's dependencies using the lockfile and settings
RUN --mount=from=ghcr.io/astral-sh/uv,source=/uv,target=/bin/uv \
    --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,source=uv.lock,target=uv.lock \
    --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
    uv sync --locked --no-install-project --no-dev


COPY pyproject.toml uv.lock ./
COPY src/ ./src
RUN --mount=from=ghcr.io/astral-sh/uv,source=/uv,target=/bin/uv \
    uv sync --no-dev

COPY scripts/ ./scripts
COPY migrations/ ./migrations

# ENV PYTHONPATH=/app/src
# ENV PATH=&quot;/app/.venv/bin:$PATH&quot;
RUN chmod +x ./scripts/start.sh

EXPOSE 8080

CMD [&quot;./scripts/start.sh&quot;]

</code></pre>
<h3>Platform</h3>
<p>MacOS - Darwin</p>
<h3>Version</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @errajibadr on 2025-08-14 13:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-14 13:38</div>
            <div class="timeline-body"><blockquote>
<p>When adding a new dependency with ⁠uv add package, only the new package should be installed during the Docker build, leveraging the cache for existing dependencies.</p>
</blockquote>
<p>The environment is not cached, so we need to install all of the packages still. We will leverage the cache, e.g., avoiding downloads? but the install still needs to happen.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/errajibadr">@errajibadr</a> on 2025-08-14 13:49</div>
            <div class="timeline-body"><p>Fair enough.
Thanks for fast reply.
However speed of install is not the same as local system.</p>
<p>Is this a known issue/normal behavior ?</p>
<h2>Docker</h2>
<p>[stage-0 3/9] RUN --mount=from=ghcr.io/astral-sh/uv,source=/uv,target=/bin/uv     --mount=type=cache,target=/root/.cache/uv     --mount=type=bind,source=uv.lock,target=uv.lock     --mount=type=bind,source=pyproject.toml,target=pyproject.toml     uv sync --locked --no-install-project --no-dev
#9 0.263 Resolved 177 packages in 6ms
#9 0.500 Downloading zstandard (4.7MiB)
#9 0.899  Downloading zstandard
#9 0.954 Prepared 9 packages in 644ms
#9 5.998 Installed 144 packages in 5.04s
#9 8.249 Bytecode compiled 8186 files in 2.25s</p>
<h2>Local</h2>
<p>(genai-template) ➜  genai-launchpad git:(working_realtime_chat) ✗ uv sync --reinstall --no-dev<br />
Resolved 177 packages in 0.89ms
Built dataunboxed-launchpad @ file:///Users/badrou/repository/genai-launchpad
Prepared 144 packages in 787ms
Uninstalled 173 packages in 1.63s
Installed 144 packages in 369ms</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-14 13:56</div>
            <div class="timeline-body"><p>Usually the cache in Docker is on a different file system so we need to copy the files instead of hard linking like we do on your local machine</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @errajibadr on 2025-08-14 13:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:29 UTC
    </footer>
</body>
</html>
