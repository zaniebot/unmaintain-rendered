<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bug: Installation destination inference for `uv pip` commands has inconsistent behavior (`UV_PYTHON` a.k.a `--python`) - astral-sh/uv #15709</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>bug: Installation destination inference for `uv pip` commands has inconsistent behavior (`UV_PYTHON` a.k.a `--python`)</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/15709">#15709</a>
        opened by <a href="https://github.com/gabyx">@gabyx</a>
        on 2025-09-06 19:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/gabyx">@gabyx</a> on 2025-09-06 19:21</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Please reproduce this:</p>
<ol start="0">
<li><p>Ensure <code>UV_PYTHON</code> is no set.</p>
</li>
<li><p>Start creating a virtual environment
<code>uv venv -p /nix/store/hwih8a4f4ms88dr3ynh1wcqcpc78pld3-python3-3.13.6-env/bin/python3.13</code> (choose any system python here)</p>
</li>
</ol>
<pre><code class="language-shell">Using CPython 3.13.6 interpreter at: /nix/store/hwih8a4f4ms88dr3ynh1wcqcpc78pld3-python3-3.13.6-env/bin/python3.13
Creating virtual environment at: .venv
Activate with: source .venv/bin/activate.fish
</code></pre>
<p>Now do one of the following scenrios:</p>
<h3>Scenario A</h3>
<ul>
<li><p>Installing numpy <code>uv pip install numpy -v</code>
results in success, and numpy is installed in the <strong>inferred</strong> virtual environment:</p>
<pre><code class="language-shell">DEBUG uv 0.8.6
DEBUG Searching for default Python interpreter in virtual environments
DEBUG Found `cpython-3.13.6-linux-x86_64-gnu` at `/home/gaetan/temp/test_project/.venv/bin/python3` (virtual environment)
DEBUG Using Python 3.13.6 environment at: .venv
DEBUG Acquired lock for `.venv`
DEBUG Requirement satisfied: numpy
Audited 1 package in 0.73ms
DEBUG Released lock at `/home/gaetan/temp/test_project/.venv/.lock`
</code></pre>
</li>
</ul>
<h3>Scenario B</h3>
<ul>
<li><p>Now explicitly set the Python interpreter (use the same one as in <code>uv venv</code>)</p>
<ul>
<li><code>export UV_PYTHON=/nix/store/hwih8a4f4ms88dr3ynh1wcqcpc78pld3-python3-3.13.6-env/bin/python3</code> before and then install</li>
<li><code>uv pip install numpy -v</code> fails</li>
</ul>
<pre><code class="language-shell">DEBUG uv 0.8.6
DEBUG Checking for Python interpreter at path `/nix/store/hwih8a4f4ms88dr3ynh1wcqcpc78pld3-python3-3.13.6-env/bin/python3`
Using Python 3.13.6 environment at: /nix/store/hwih8a4f4ms88dr3ynh1wcqcpc78pld3-python3-3.13.6-env
WARN Failed to acquire environment lock: Read-only file system (os error 30) at path &quot;/nix/store/hwih8a4f4ms88dr3ynh1wcqcpc78pld3-python3-3.13.6-env/.tmpx7wOq1&quot;
DEBUG At least one requirement is not satisfied: numpy
DEBUG Using request timeout of 30s
DEBUG Solving with installed Python version: 3.13.6
DEBUG Solving with target Python version: &gt;=3.13.6
DEBUG Adding direct dependency: numpy*
DEBUG Found fresh response for: https://pypi.org/simple/numpy/
DEBUG Searching for a compatible version of numpy (*)
DEBUG Selecting: numpy==2.3.2 [compatible] (numpy-2.3.2-cp313-cp313-manylinux_2_27_x86_64.manylinux_2_28_x86_64.whl)
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/1d/0f/571b2c7a3833ae419fe69ff7b479a78d313581785203cc70a8db90121b9a/numpy-2.3.2-cp313-cp313-manylinux_2_27_x86_64.manylinux_2_28_x86_64.whl.metadata
DEBUG Tried 1 versions: numpy 1
DEBUG marker environment resolution took 0.005s
Resolved 1 package in 5ms
DEBUG Registry requirement already cached: numpy==2.3.2
DEBUG File already exists (initial attempt), overwriting: /nix/store/hwih8a4f4ms88dr3ynh1wcqcpc78pld3-python3-3.13.6-env/lib/python3.13/site-packages/numpy/linalg/linalg.pyi
error: Failed to install: numpy-2.3.2-cp313-cp313-manylinux_2_27_x86_64.manylinux_2_28_x86_64.whl (numpy==2.3.2)
Caused by: Read-only file system (os error 30) at path &quot;/nix/store/hwih8a4f4ms88dr3ynh1wcqcpc78pld3-python3-3.13.6-env/lib/python3.13/site-packages/.tmpkD6UTw&quot;
3m
</code></pre>
</li>
</ul>
<blockquote>
<p>[!NOTE]
<code>UV_PYTHON=/nix/store/hwih8a4f4ms88dr3ynh1wcqcpc78pld3-python3-3.13.6-env/bin/python3 uv sync</code>
is not impacted by this, and always infers first the virtual environment.</p>
</blockquote>
<p>This behavior seems really unintuitive.
It seems that <code>uv</code> uses the <code>UV_PYTHON</code> env variable also to detect the environment which is slightly confusing.</p>
<p>This is related to the more confusion issue report: #14748 (I closed it)</p>
<p>@GaetanLepage: FYI</p>
<h3>Platform</h3>
<p>NixOS</p>
<h3>Version</h3>
<p>0.8.6</p>
<h3>Python version</h3>
<p>3.13</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @gabyx on 2025-09-06 19:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "bug: Installation destination inference for `uv pip` commands has inconsistent behavior" to "bug: Installation destination inference for `uv pip` commands has inconsistent behavior (`UV_PYTHON` a.k.a `--python`)" by @gabyx on 2025-09-06 19:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../cachix/devenv/pulls/1959.html">cachix/devenv#1959</a> on 2025-09-06 19:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-09-06 19:29</div>
            <div class="timeline-body"><p>Hmm, this seems right to me? If you tell us a <code>--python</code>, then <code>uv pip install</code> attempts to install into that <code>--python</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gabyx">@gabyx</a> on 2025-09-07 14:46</div>
            <div class="timeline-body"><p>Its just weird behavior in the non failing case where you dont set anything then it does discovery, and in the other case it doesnt.</p>
<p>If uv pip truely implements the exact behavior of pip (not sure) then is this wanted? In the success case there is no venv activated!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gabyx">@gabyx</a> on 2025-09-07 14:47</div>
            <div class="timeline-body"><p>Is the design of uv going towards &quot;forbid uv pip&quot; -&gt; always enforce an environment , that would be nice.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-09-07 17:11</div>
            <div class="timeline-body"><blockquote>
<p>If uv pip truely implements the exact behavior of pip (not sure) then is this wanted?</p>
</blockquote>
<p>I don't think pip has to consider any of these semantics, as it almost always targets the same environment that pip is installed in.</p>
<p>In general, uv won't install into a non-virtual environment without opt-in. However, using <code>--python</code> with an explicit path to an interpreter is considered opt-in.</p>
<blockquote>
<p>Its just weird behavior in the non failing case where you dont set anything then it does discovery, and in the other case it doesnt.</p>
</blockquote>
<p>I'm not sure what's weird about this. In the first case, we do discovery because you haven't asked for a specific Python interpreter. In the second case, we don't because you've given us a specific path.</p>
<p>I don't think you should set <code>UV_PYTHON</code> in this context. It sounds like you want something more like https://github.com/astral-sh/uv/issues/14748? Or you should just use <code>--python</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gabyx">@gabyx</a> on 2025-09-08 10:00</div>
            <div class="timeline-body"><p>Thanks @zanieb : the whole issue comes from #14748 and the fact that <code>UV_PYTHON</code> is conceptual the flag <code>--python</code> and
that we as Nix package/devenv maintainer want a way to <strong>really lock</strong> the python <strong>interpreter</strong> which <code>uv</code>  uses for <strong>all</strong> commands (no escape hatch).</p>
<p>I think <code>uv</code> needs a solution for that cause <code>UV_PYTHON</code> has the wrong semantics <strong>for our scenario</strong> at least for <code>uv pip</code> and <code>uv venv</code> etc.</p>
<p>Whats about <code>UV_PYTHON_INTERPRETER</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-09-08 12:50</div>
            <div class="timeline-body"><p>Like you want to assert that the interpreter in a discovered virtual environment matches the value set in a variable?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gabyx">@gabyx</a> on 2025-09-08 13:52</div>
            <div class="timeline-body"><p>Kind of, and make all uv commands respect that interpreter, when creating a new one with <code>uv venv</code> and other command which start fresh or do discovery etc...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gabyx">@gabyx</a> on 2025-09-08 13:56</div>
            <div class="timeline-body"><p>We can also say we set UV_PYTHON globally to an interpreter not in an environment (/nix/store/...) and forbid the use of <code>uv pip install</code> cause it want work. Or UV_PYTHON should not be read on <code>uv pip</code> commands. Only <code>--python</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @zanieb on 2025-09-08 14:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2025-09-08 14:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-09-08 14:18</div>
            <div class="timeline-body"><p>I think we should be looking more closely at the motivating problem in Nix here. I don't think we should just be hacking more complexity into the <code>UV_PYTHON</code> option for this purpose.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/16106.html">astral-sh/uv#16106</a> on 2025-10-02 19:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:05 UTC
    </footer>
</body>
</html>
