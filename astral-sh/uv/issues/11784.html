<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weird interaction of --resolution highest with uv.lock - astral-sh/uv #11784</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Weird interaction of --resolution highest with uv.lock</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/11784">#11784</a>
        opened by <a href="https://github.com/dimaqq">@dimaqq</a>
        on 2025-02-26 00:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dimaqq">@dimaqq</a> on 2025-02-26 00:13</div>
            <div class="timeline-body"><h3>Question</h3>
<p><code>otlp-test-data==0.9.4</code> was the latest when I locked my app.</p>
<p>My pyproject.toml specified <code>&gt;= 0.9.4</code>.</p>
<p>Since then, <code>otlp-test-data==0.10.0</code> was released.</p>
<p>Somehow, <code>uv sync --all-groups --resolution highest</code> and <code>uv sync --all-groups --resolution highest --no-cache</code> would not upgrade the virtualenv to 0.10.0.</p>
<p>In the end, <code>rm uv.lock; uv sync ...</code> did the trick.</p>
<p>I'm curious why. Do I misunderstand locking or the resolution strategy?</p>
<p>pyproject snippet for reference:</p>
<pre><code class="language-toml">[dependency-groups]
dev = [
    &quot;maturin ~= 1.8&quot;,
    &quot;opentelemetry-api ~= 1.30&quot;,  # 1.30 fixed type hints for Python 3.8
    &quot;pyright ~= 1.1&quot;,
    &quot;ruff ~= 0.9&quot;,
]
testing = [
    &quot;pytest ~= 8.3.4&quot;,
    &quot;otlp-test-data &gt;= 0.9.4&quot;,
]
</code></pre>
<h3>Platform</h3>
<p>macos</p>
<h3>Version</h3>
<p>uv 0.6.3 (Homebrew 2025-02-24)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @dimaqq on 2025-02-26 00:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-26 00:26</div>
            <div class="timeline-body"><p>That's surprising ‚Äî it sounds like a bug. Did any package versions change with <code>--resolution highest</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @zanieb on 2025-02-26 00:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2025-02-26 00:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-26 00:27</div>
            <div class="timeline-body"><p>Would you mind writing a minimal example using something a single small package like <code>anyio</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dimaqq">@dimaqq</a> on 2025-02-26 00:29</div>
            <div class="timeline-body"><p>Other packages too seemed to have required removing the lock file:</p>
<p>I've tried &quot;highest before&quot; and uv seemed to keep versions as locked... or perhaps &quot;as any version allowed in the lock file&quot;?</p>
<p>Then when I whacked the lock file, my dep and one more dep were updated:</p>
<pre><code class="language-command">(otlp-proto) ü¶ê/c/otlp-proto (main)&gt; rm uv.lock
(otlp-proto) ü¶ê/c/otlp-proto (main)&gt; uv sync --all-groups --resolution highest --no-cache
Resolved 39 packages in 509ms
Prepared 2 packages in 65ms
Uninstalled 2 packages in 8ms
‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë [0/2] Installing wheels...                                                                                                                                                                                                                                                                                                                                                                           warning: Failed to clone files; falling back to full copy. This may lead to degraded performance.
         If the cache and target directories are on different filesystems, reflinking may not be supported.
         If this is intentional, set `export UV_LINK_MODE=copy` or use `--link-mode=copy` to suppress this warning.
Installed 2 packages in 33ms
 - googleapis-common-protos==1.67.0
 + googleapis-common-protos==1.68.0
 - otlp-test-data==0.9.4
 + otlp-test-data==0.10.0
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dimaqq">@dimaqq</a> on 2025-02-26 00:33</div>
            <div class="timeline-body"><p>Re: making a MRE, I feel that would require me to cook up a lock file by hand, wouldn't it?</p>
<p>Instead, I could perhaps pull a lock from from some small project history... wdyt?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-26 00:44</div>
            <div class="timeline-body"><pre><code>‚ùØ uv init example
Initialized project `example` at `/Users/zb/workspace/uv/example`
‚ùØ cd example
‚ùØ uv add anyio==4.7.0
Using CPython 3.13.0
Creating virtual environment at: .venv
Resolved 4 packages in 181ms
Prepared 1 package in 118ms
Installed 3 packages in 5ms
 + anyio==4.7.0
 + idna==3.10
 + sniffio==1.3.1
‚ùØ uv add 'anyio&gt;=4.7.0' --frozen
‚ùØ uv lock
Resolved 4 packages in 3ms
‚ùØ uv sync
Resolved 4 packages in 0.83ms
Audited 3 packages in 0.02ms
‚ùØ uv sync --resolution highest
Resolved 4 packages in 1ms
Audited 3 packages in 0.03ms
‚ùØ uv sync --resolution highest --upgrade-package anyio
Resolved 4 packages in 60ms
Prepared 1 package in 0.72ms
Uninstalled 1 package in 1ms
Installed 1 package in 2ms
 - anyio==4.7.0
 + anyio==4.8.0
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-26 00:44</div>
            <div class="timeline-body"><p>cc @charliermarsh can you confirm if this is expected?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dimaqq">@dimaqq</a> on 2025-02-26 00:47</div>
            <div class="timeline-body"><p>Thank you @zanieb</p>
<p>P.S. if someone needs a MRE, I've tagged the &quot;problem state&quot; in a smaller repo here:
https://github.com/dimaqq/otlp-json/tree/mre-uv-11784</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-26 00:58</div>
            <div class="timeline-body"><p>That we prefer existing versions? I don‚Äôt know if it‚Äôs intentional.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-26 01:07</div>
            <div class="timeline-body"><p>Oh sorry, I've forgotten that &quot;highest&quot; is the default mode (https://docs.astral.sh/uv/reference/settings/#resolution)</p>
<p>We <em>will</em> invalidate the lockfile if you change the resolution mode</p>
<pre><code>‚ùØ uv sync --resolution lowest
Ignoring existing lockfile due to change in resolution mode: `highest` vs. `lowest`
Resolved 4 packages in 175ms
Prepared 2 packages in 90ms
Uninstalled 3 packages in 18ms
Installed 3 packages in 4ms
 - anyio==4.8.0
 + anyio==4.7.0
 - idna==3.10
 + idna==2.8
 - sniffio==1.3.1
 + sniffio==1.1.0
</code></pre>
<p>I think this actually is working as intended. The most we could do is warn? but it seems hard to get that right.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @zanieb on 2025-02-26 01:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2025-02-26 01:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-26 01:08</div>
            <div class="timeline-body"><p>I think it's correct for us to prefer the lockfile versions, as that's the intent of the lockfile ‚Äî an explicit upgrade request makes sense if that's what you're looking for.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dimaqq">@dimaqq</a> on 2025-03-03 05:49</div>
            <div class="timeline-body"><p>Indeed, I dunno what would be most expected.</p>
<p>It is a bit weird if the lock file is ‚Äúsometimes‚Äù invalidated and sometimes not.</p>
<p>Maybe the default should be ‚Äúfrozen‚Äù?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dimaqq">@dimaqq</a> on 2025-03-05 05:43</div>
            <div class="timeline-body"><p>Maybe this would be best solved by a separate command like <code>yarn outdated</code>? ü§î</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-05 19:02</div>
            <div class="timeline-body"><blockquote>
<p>Maybe this would be best solved by a separate command like yarn outdated? ü§î</p>
</blockquote>
<p>That exists as <code>uv tree --outdated</code></p>
<blockquote>
<p>It is a bit weird if the lock file is ‚Äúsometimes‚Äù invalidated and sometimes not.</p>
</blockquote>
<p>It's invalidated if it would change based on your settings. I don't think that should be surprising.</p>
<p>I don't think we'll change the default behavior to frozen and this specific feature is working as intended ‚Äî going to close this as I don't think there's something actionable here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-03-05 19:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:33:01 UTC
    </footer>
</body>
</html>
