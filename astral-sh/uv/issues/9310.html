<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv torch installation breaking in cpu-gpu multiplatform scenario. - astral-sh/uv #9310</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv torch installation breaking in cpu-gpu multiplatform scenario.</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/9310">#9310</a>
        opened by <a href="https://github.com/EgonFerri">@EgonFerri</a>
        on 2024-11-21 11:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EgonFerri">@EgonFerri</a></div>
            <div class="timeline-body"><p>First of all thanks for the tool, UV is simplifying immensely the package management.</p>
<p>I was following the new document you provided for <a href="https://docs.astral.sh/uv/guides/integration/pytorch/#using-uv-with-pytorch">using UV with PyTorch</a>, and I think I could have found an edge case that breaks the package resolution. Some of the last issues (#9306 and #9307) are possibly related, but I will report my specific case since it is a &quot;cleaner&quot; situation and could provide you with a new data point.
I&#x27;m using the last version (0.5.4).</p>
<p>I have this scenario:
I need a project that installs torch and torchvision (<code>&quot;torch==2.5.1&quot;, &quot;torchvision==0.20.1&quot;</code>), and I need to account for three different scenarios: Darwin os (obv always without GPU), and Linux os (both with and without GPU).</p>
<p>From my understanding following the guide, I should be able to use <code>uv sync --extra cpu</code> and <code>uv sync --extra gpu</code>, installing the proper torch version with this pyproject.toml:</p>
<pre><code>[project]
name = &quot;test&quot;
version = &quot;0.1.0&quot;
description = &quot;Test pytorch dependencies&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.11&quot;
dependencies = []

[project.optional-dependencies]
cpu = [
  &quot;torch==2.5.1&quot;,
  &quot;torchvision==0.20.1&quot;,
]
gpu = [
  &quot;torch==2.5.1&quot;,
  &quot;torchvision==0.20.1&quot;,
]

[tool]
[tool.uv]
conflicts = [
  [
    { extra = &quot;cpu&quot; },
    { extra = &quot;gpu&quot; },
  ],
]

[tool.uv.sources]
[[tool.uv.sources.torch]]
index = &quot;pytorch-cpu&quot;
marker = &quot;platform_system != &#x27;Darwin&#x27;&quot;
extra = &quot;cpu&quot;

[[tool.uv.sources.torchvision]]
index = &quot;pytorch-cpu&quot;
marker = &quot;platform_system != &#x27;Darwin&#x27;&quot;
extra = &quot;cpu&quot;

[[tool.uv.index]]
name = &quot;pytorch-cpu&quot;
url = &quot;https://download.pytorch.org/whl/cpu&quot;
explicit = true
</code></pre>
<p>However, it works well locally on Darwin (both <code>--extra CPU</code> and <code>--extra GPU</code>), but when I try to install it on Linux with <code>--extra CPU</code> I get this error:</p>
<pre><code>$ uv sync --extra cpu
Using CPython 3.11.9 interpreter at: /usr/local/bin/python3
Creating virtual environment at: .venv
Resolved 29 packages in 2ms
error: Distribution `torch==2.5.1 @ registry+https://download.pytorch.org/whl/cpu` can&#x27;t be installed because it doesn&#x27;t have a source distribution or wheel for the current platform
</code></pre>
<p>Notice that if I use --extra GPU, instead, not having an explicit extra index and falling back to pypi works correctly, and the installation of GPU torch with Nvidia packages is solved correctly:</p>
<pre><code>$ uv sync --extra gpu
Using CPython 3.11.9 interpreter at: /usr/local/bin/python3
Creating virtual environment at: .venv
Resolved 29 packages in 2ms
Prepared 25 packages in 58.28s
warning: Failed to hardlink files; falling back to full copy. This may lead to degraded performance.
         If the cache and target directories are on different filesystems, hardlinking may not be supported.
         If this is intentional, set `export UV_LINK_MODE=copy` or use `--link-mode=copy` to suppress this warning.
Installed 25 packages in 15.22s
 + filelock==3.16.1
 + fsspec==2024.10.0
 + jinja2==3.1.4
 + markupsafe==3.0.2
 + mpmath==1.3.0
 + networkx==3.4.2
 + numpy==2.1.3
 + nvidia-cublas-cu12==12.4.5.8
 + nvidia-cuda-cupti-cu12==12.4.127
 + nvidia-cuda-nvrtc-cu12==12.4.127
 + nvidia-cuda-runtime-cu12==12.4.127
 + nvidia-cudnn-cu12==9.1.0.70
 + nvidia-cufft-cu12==11.2.1.3
 + nvidia-curand-cu12==10.3.5.1[47](https://gitlab.pepita.io/core-aide/watergate/temp/-/jobs/3465971#L47)
 + nvidia-cusolver-cu12==11.6.1.9
 + nvidia-cusparse-cu12==12.3.1.170
 + nvidia-nccl-cu12==2.21.5
 + nvidia-nvjitlink-cu12==12.4.127
 + nvidia-nvtx-cu12==12.4.127
 + pillow==11.0.0
 + sympy==1.13.1
 + torch==2.5.1
 + torchvision==0.20.1
 + triton==3.1.0
 + typing-extensions==4.12.2
</code></pre>
<p>The problem is not with the extra index, since if I accept the situation where I only install cpu on Linux (like on Darwin), the extra index works correctly with this .toml:</p>
<pre><code>[project]
name = &quot;test&quot;
version = &quot;0.1.0&quot;
description = &quot;Test pytorch dependencies&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.11&quot;
dependencies = [&quot;torch==2.5.1&quot;, &quot;torchvision==0.20.1&quot;]

[tool]
[tool.uv]
[tool.uv.sources]
[[tool.uv.sources.torch]]
index = &quot;pytorch-cpu&quot;
marker = &quot;platform_system != &#x27;Darwin&#x27;&quot;

[[tool.uv.sources.torchvision]]
index = &quot;pytorch-cpu&quot;
marker = &quot;platform_system != &#x27;Darwin&#x27;&quot;

[[tool.uv.index]]
name = &quot;pytorch-cpu&quot;
url = &quot;https://download.pytorch.org/whl/cpu&quot;
explicit = true
</code></pre>
<p>Notice, however, that this toml only works after I delete and re-generate (with uv sync) the uv.lock, otherwise I have the same error.
I think that the diff of the two locks could show the problem, since the freshly generated lock has the correct x.y.z+cpu version for torch and torch vision, while the old one did not.</p>
<img alt="image" src="https://github.com/user-attachments/assets/95eafa6d-7a68-4cf8-85eb-006731a1d5f0">

<p>Thanks in advance for the help (:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eginhard">@eginhard</a> on 2024-11-21 11:35</div>
            <div class="timeline-body"><p>This is a duplicate of #9295 and should be fixed in the next release</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EgonFerri">@EgonFerri</a> on 2024-11-21 11:43</div>
            <div class="timeline-body"><p>sorry, missed that.
Thanks again for all the good work</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/EgonFerri">@EgonFerri</a> on 2024-11-21 11:43</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:35:39 UTC
    </footer>
</body>
</html>
