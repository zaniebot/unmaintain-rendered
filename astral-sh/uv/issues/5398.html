<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invalid non-resolution with `uv lock` - astral-sh/uv #5398</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Invalid non-resolution with <code>uv lock</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/5398">#5398</a>
        opened by <a href="https://github.com/JP-Ellis">@JP-Ellis</a>
        on 2024-07-24 06:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/JP-Ellis">@JP-Ellis</a> on 2024-07-24 06:03</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>With the most recent <code>0.2.28</code> release of uv, I am no longer able to lock the root package in my workspace, resulting in the error:</p>
<pre><code class="language-text">  √ó No solution found when resolving dependencies:
  ‚ï∞‚îÄ‚ñ∂ Because only mypkg[openai]==0.1.1.dev209+g1c110b4.d20240724 is available and the requested Python version (&gt;=3.8) does not satisfy Python&gt;=3.12.0,&lt;3.13, we can conclude that all versions
      of mypkg[openai] are incompatible.
      And because you require mypkg[openai], we can conclude that the requirements are unsatisfiable.
</code></pre>
<p>It seems to suggest that <code>Python &gt;= 3.8</code> is not compatible with <code>Python ~3.12.0</code>, which I believe is wrong as stated (though the converse would be correct).</p>
<h2>Logs</h2>
<p>The error appears with various commands that require dependency resolution.
trying <code>uv -v lock</code> results in:</p>
<pre><code class="language-text">DEBUG uv 0.2.28
warning: `uv lock` is experimental and may change without warning
DEBUG Found workspace root: `/Users/joshua.ellis/src/myproduct/mypkg`
DEBUG Adding current workspace member: /Users/joshua.ellis/src/myproduct/mypkg
DEBUG Adding discovered workspace member: /Users/joshua.ellis/src/myproduct/mypkg/mypkg-api
DEBUG Adding discovered workspace member: /Users/joshua.ellis/src/myproduct/mypkg/mypkg-cli
DEBUG Interpreter meets the requested Python: `Python &gt;=3.8`
DEBUG Using request timeout of 30s
DEBUG Starting clean resolution
DEBUG Acquired lock for `/Users/joshua.ellis/Library/Caches/uv/built-wheels-v3/editable/4b5f6ac25df4b874`
DEBUG Acquired lock for `/Users/joshua.ellis/Library/Caches/uv/built-wheels-v3/editable/0d4c51059253629e`
DEBUG Acquired lock for `/Users/joshua.ellis/Library/Caches/uv/built-wheels-v3/editable/8533a92294f62217`
DEBUG Preparing metadata for: mypkg @ file:///Users/joshua.ellis/src/myproduct/mypkg
DEBUG Preparing metadata for: mypkg-api @ file:///Users/joshua.ellis/src/myproduct/mypkg/mypkg-api
DEBUG Preparing metadata for: mypkg-cli @ file:///Users/joshua.ellis/src/myproduct/mypkg/mypkg-cli
## installing a bunch of stuff to prepare metadata
## redacted as I don't think it is that relevant
## but happy to update in case it is useful
DEBUG Prepared metadata for: mypkg @ file:///Users/joshua.ellis/src/myproduct/mypkg
DEBUG Prepared metadata for: mypkg-cli @ file:///Users/joshua.ellis/src/myproduct/mypkg/mypkg-cli
DEBUG Prepared metadata for: mypkg-api @ file:///Users/joshua.ellis/src/myproduct/mypkg/mypkg-api
DEBUG Found workspace root: `/Users/joshua.ellis/src/myproduct/mypkg`
DEBUG Adding current workspace member: /Users/joshua.ellis/src/myproduct/mypkg
DEBUG Adding discovered workspace member: /Users/joshua.ellis/src/myproduct/mypkg/mypkg-api
DEBUG Found workspace root: `/Users/joshua.ellis/src/myproduct/mypkg`
DEBUG Adding root workspace member: /Users/joshua.ellis/src/myproduct/mypkg
DEBUG Adding current workspace member: /Users/joshua.ellis/src/myproduct/mypkg/mypkg-cli
DEBUG Found workspace root: `/Users/joshua.ellis/src/myproduct/mypkg`
DEBUG Adding root workspace member: /Users/joshua.ellis/src/myproduct/mypkg
DEBUG Adding current workspace member: /Users/joshua.ellis/src/myproduct/mypkg/mypkg-api
DEBUG Adding discovered workspace member: /Users/joshua.ellis/src/myproduct/mypkg/mypkg-cli
warning: `uv.sources` is experimental and may change without warning
warning: Missing version constraint (e.g., a lower bound) for `boto3`
warning: Missing version constraint (e.g., a lower bound) for `boto3-stubs`
warning: Missing version constraint (e.g., a lower bound) for `coverage`
warning: Missing version constraint (e.g., a lower bound) for `ipykernel`
warning: Missing version constraint (e.g., a lower bound) for `jupyter`
warning: Missing version constraint (e.g., a lower bound) for `mkdocs`
warning: Missing version constraint (e.g., a lower bound) for `mkdocs-gen-files`
warning: Missing version constraint (e.g., a lower bound) for `mkdocs-literate-nav`
warning: Missing version constraint (e.g., a lower bound) for `mkdocs-material`
warning: Missing version constraint (e.g., a lower bound) for `mkdocs-section-index`
warning: Missing version constraint (e.g., a lower bound) for `mkdocstrings`
warning: Missing version constraint (e.g., a lower bound) for `pandas`
warning: Missing version constraint (e.g., a lower bound) for `pathspec`
warning: Missing version constraint (e.g., a lower bound) for `pygments`
warning: Missing version constraint (e.g., a lower bound) for `pytest`
warning: Missing version constraint (e.g., a lower bound) for `pytest-cov`
warning: Missing version constraint (e.g., a lower bound) for `rich`
warning: Missing version constraint (e.g., a lower bound) for `types-pygments`
warning: Missing version constraint (e.g., a lower bound) for `types-pyyaml`
DEBUG Adding discovered workspace member: /Users/joshua.ellis/src/myproduct/mypkg/mypkg-api
warning: Missing version constraint (e.g., a lower bound) for `packaging`
warning: Missing version constraint (e.g., a lower bound) for `types-toml`
DEBUG Adding discovered workspace member: /Users/joshua.ellis/src/myproduct/mypkg/mypkg-cli
warning: Missing version constraint (e.g., a lower bound) for `aws-lambda-typing`
warning: Missing version constraint (e.g., a lower bound) for `botocore-stubs`
warning: Missing version constraint (e.g., a lower bound) for `requests`
warning: Missing version constraint (e.g., a lower bound) for `types-cryptography`
warning: Missing version constraint (e.g., a lower bound) for `types-requests`
warning: Missing version constraint (e.g., a lower bound) for `uvicorn`
DEBUG Solving with installed Python version: 3.12.4
DEBUG Solving with target Python version: &gt;=3.8
DEBUG Adding direct dependency: mypkg*
DEBUG Adding direct dependency: mypkg[anthropic]*
DEBUG Adding direct dependency: mypkg[devel]*
DEBUG Adding direct dependency: mypkg[devel-docs]*
DEBUG Adding direct dependency: mypkg[devel-notebook]*
DEBUG Adding direct dependency: mypkg[devel-test]*
DEBUG Adding direct dependency: mypkg[devel-types]*
DEBUG Adding direct dependency: mypkg[openai]*
DEBUG Adding direct dependency: mypkg-api*
DEBUG Adding direct dependency: mypkg-api[devel]*
DEBUG Adding direct dependency: mypkg-api[devel-test]*
DEBUG Adding direct dependency: mypkg-api[devel-types]*
DEBUG Adding direct dependency: mypkg-cli*
DEBUG Adding direct dependency: mypkg-cli[devel]*
DEBUG Adding direct dependency: mypkg-cli[devel-test]*
DEBUG Adding direct dependency: mypkg-cli[devel-types]*
DEBUG Searching for a compatible version of mypkg @ file:///Users/joshua.ellis/src/myproduct/mypkg (*)
DEBUG No compatible version found for: Python
DEBUG Searching for a compatible version of mypkg @ file:///Users/joshua.ellis/src/myproduct/mypkg (&lt;0.1.1.dev209+g1c110b4.d20240724 | &gt;0.1.1.dev209+g1c110b4.d20240724)
DEBUG No compatible version found for: mypkg[openai]
  √ó No solution found when resolving dependencies:
  ‚ï∞‚îÄ‚ñ∂ Because only mypkg[openai]==0.1.1.dev209+g1c110b4.d20240724 is available and the requested Python version (&gt;=3.8) does not satisfy Python&gt;=3.12.0,&lt;3.13, we can conclude that all versions
      of mypkg[openai] are incompatible.
      And because you require mypkg[openai], we can conclude that the requirements are unsatisfiable.
</code></pre>
<p>The <code>mypkg-cli</code> component has the broadest Python compatibility, while the <code>mypkg</code> and <code>mypkg-api</code> components are pinned to use <code>3.12.X</code>.</p>
<p>It would appear that in the resolution, instead of narrow down the Python compatibility range, it is throwing an error for <code>mypkg</code> due to its narrow Python version requirements.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-24 13:30</div>
            <div class="timeline-body"><p>If your project declares a Python compatibility range of <code>Python &gt;= 3.8</code>, then all of your dependencies need to be at least as compatible as that range. If you have a package that only supports Python 3.12 or later, then there are some Python versions for which we wouldn't be able to construct a successful resolution. Does that make sense?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2024-07-24 19:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JP-Ellis">@JP-Ellis</a> on 2024-07-24 21:27</div>
            <div class="timeline-body"><p>That makes sense, but my situation is in fact the other way around; my project restricts Python &gt;=3.12, but depends on a project requiring Python &gt;= 3.8.</p>
<p>I also suspect it is an issue with <code>uv lock</code> as I am able to <code>uv pip install .</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-24 21:28</div>
            <div class="timeline-body"><p>The logs suggest you have a project in your workspace with <code>Python &gt;= 3.8</code> though -- is that wrong?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JP-Ellis">@JP-Ellis</a> on 2024-07-24 21:39</div>
            <div class="timeline-body"><p>Indeed there is, but the dependency is the wrong way around.</p>
<p><code>mypkg</code> is the root package and is in the workspace root, and requires Python 3.12. It has a development dependency of <code>mypkg-cli</code> (kept under the <code>devel</code> feature group) which requires a Python &gt;= 3.8. The <code>mypkg-cli</code> dependency is a standalone package with no dependence on anything else within the workspace.</p>
<p>Hope that makes sense? If it helps, I can also try and create a MWE.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-24 21:40</div>
            <div class="timeline-body"><p>The thing is, we're trying to lock the entire workspace, not just the root package. You could make <code>mypkg-cli</code> just a path dependency rather than part of the workspace (so it'd have its own lockfile if you wanted to run it), but for the workspace, we have to come up with a single lockfile that works for everything in the environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JP-Ellis">@JP-Ellis</a> on 2024-07-24 21:44</div>
            <div class="timeline-body"><p>That makes sense!</p>
<p>My follow up question then: does running <code>uv lock</code> within one of the subprojects lock the whole workspace again? Or only the subproject? This behaviour should probably be made clear, as it wasn't to me. (I understand <code>uv lock</code> is still in preview, so hopefully that's useful feedback!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-24 22:05</div>
            <div class="timeline-body"><p>(This would be good to clarify at https://github.com/astral-sh/uv/blob/main/docs/projects.md#lock-file if not present)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @konstin by @konstin on 2024-07-29 09:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @konstin by @konstin on 2024-08-07 12:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-08-07 12:28</div>
            <div class="timeline-body"><p>We improved the resolver docs including the way more details:</p>
<ul>
<li>https://github.com/astral-sh/uv/blob/main/docs/concepts/resolution.md</li>
<li>https://github.com/astral-sh/uv/blob/main/docs/reference/resolver-internals.md</li>
</ul>
<p>Do those sufficiently explain the behavior you're seeing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JP-Ellis">@JP-Ellis</a> on 2024-08-07 23:50</div>
            <div class="timeline-body"><p>Thanks for the heads up! I have gone of the two docs, I think the only thing that might be missing (which is what caught me off guard) is that <code>uv lock</code> works at the workspace level, unlike for example <code>uv pip compile</code>.</p>
<p>If we suppose a workspace as follows:</p>
<pre><code class="language-text">mypkg
‚îú‚îÄ‚îÄ mypkg-api          &lt;== API wrapper for core, pinned to specific Py version
‚îÇ  ‚îú‚îÄ‚îÄ pyproject.toml
‚îÇ  ‚îî‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ mypkg-cli          &lt;== Targets all OS+Python combinations
‚îÇ  ‚îú‚îÄ‚îÄ pyproject.toml
‚îÇ  ‚îî‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ src
‚îÇ  ‚îî‚îÄ‚îÄ mypkg           &lt;== Core code, library
‚îú‚îÄ‚îÄ pyproject.toml
‚îî‚îÄ‚îÄ README.md
</code></pre>
<p>I ran into the issue with <code>uv lock</code> with the intent of pinning all dependencies of <code>mypkg-api</code> to ensure reproducible builds. However, the command failed due to incompatible Python requirements between <code>mypkg-api</code> and <code>mypkg-cli</code>, even though these two packages have orthogonal purposes which would only come together on the dev's machine when (for example) testing the API locally.</p>
<p>I'm not sure whether it belongs in these docs or elsewhere, but I think there should be clarity as to how workspaces affects the various uv subcommands.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-08-08 08:30</div>
            <div class="timeline-body"><p>Good note, we have workspace docs too, even though the answer currently is that we don't really support workspaces with different <code>requires-python</code> per packages: https://github.com/astral-sh/uv/blob/main/docs/concepts/workspaces.md</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JP-Ellis">@JP-Ellis</a> on 2024-08-08 11:30</div>
            <div class="timeline-body"><p>The workspace docs do make it this behaviour much clearer! And even explain how <code>uv lock</code> can be narrowed down to a single package within a workspace.</p>
<p>Thanks üëç</p>
<p>I think this issue can be closed, though I'll let you all make the final determination.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-08-09 08:04</div>
            <div class="timeline-body"><p>We have workspaces tracked at https://github.com/astral-sh/uv/issues/5594, will close.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2024-08-09 08:04</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:30:36 UTC
    </footer>
</body>
</html>
