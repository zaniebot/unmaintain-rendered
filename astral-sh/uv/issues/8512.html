<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv installs incorrect versions of dependencies when using Nexus - astral-sh/uv #8512</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>uv installs incorrect versions of dependencies when using Nexus</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/8512">#8512</a>
        opened by <a href="https://github.com/nwp90">@nwp90</a>
        on 2024-10-24 04:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/nwp90">@nwp90</a> on 2024-10-24 04:10</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

<p>With uv 0.4.26 on Linux and python 3.8 found first in PATH:</p>
<ul>
<li>init a new project with &quot;uv init&quot;</li>
<li>uv will init the project and set .python-version to 3.8, and requires-python to &gt;= 3.8 in pyproject.toml.</li>
<li>&quot;uv add sphinx&quot;</li>
<li>uv will add the correct sphinx version, 7.1.2</li>
<li>add a [tool.uv] section specifying an index-url that points to a Nexus repo that mirrors pypi (and perhaps adds local packages too)</li>
<li>remove the existing dependency specs from pyproject.toml and blow away uv.lock</li>
<li>&quot;uv add sphinx&quot;</li>
<li>uv will add an incorrect sphinx version (7.2.2) which specifies a requires-python &gt;= 3.9</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-24 23:50</div>
            <div class="timeline-body"><p>Have you confirmed that the Nexus index is serving that Python requirement properly? And can you share the resulting <code>pyproject.toml</code> and <code>uv.lock</code> file?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @charliermarsh on 2024-10-24 23:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nwp90">@nwp90</a> on 2024-10-29 02:34</div>
            <div class="timeline-body"><p>When we fix the requirements to what it &quot;should&quot; serve, it gets it from Nexus with no problems, so I'd think Nexus is working as designed.</p>
<p>Interestingly, returning to this today, I can no longer get uv to install the wrong version of sphinx, but it does still install an incorrect version of alabaster (dependency of sphinx, should use 0.7.13 but uses 0.7.16 from Nexus) and sphinxcontrib-devhelp (should use 1.0.2, uses 1.0.6).</p>
<p>Pyproject.toml after init:</p>
<blockquote>
<p>[project]
name = &quot;test-uv-bad&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.8&quot;
dependencies = []</p>
</blockquote>
<p><code>uv add sphinx</code>, then pyproject.toml:</p>
<blockquote>
<p>[project]
name = &quot;test-uv-bad&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.8&quot;
dependencies = [
&quot;sphinx&gt;=7.1.2&quot;,
]</p>
</blockquote>
<p>uv.lock at this point:
<a href="https://github.com/user-attachments/files/17550735/uv.lock.txt">uv.lock.txt</a></p>
<p>Remove uv.lock, remove sphinx dep, add index-url, pyproject.toml now:</p>
<blockquote>
<p>[project]
name = &quot;test-uv-bad&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.8&quot;
dependencies = [
]</p>
<p>[tool.uv]
index-url = &quot;https://nexus.otago.ac.nz/repository/dst-python-localshop/simple/&quot;</p>
</blockquote>
<p><code>uv add sphinx</code>, output:</p>
<blockquote>
<p>Resolved 26 packages in 296ms
Uninstalled 2 packages in 4ms
Installed 2 packages in 4ms</p>
<ul>
<li>alabaster==0.7.13</li>
</ul>
<ul>
<li>alabaster==0.7.16</li>
</ul>
<ul>
<li>sphinxcontrib-devhelp==1.0.2</li>
</ul>
<ul>
<li>sphinxcontrib-devhelp==1.0.6</li>
</ul>
</blockquote>
<p>pyproject.toml now:</p>
<blockquote>
<p>[project]
name = &quot;test-uv-bad&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.8&quot;
dependencies = [
&quot;sphinx&gt;=7.1.2&quot;,
]</p>
<p>[tool.uv]
index-url = &quot;https://nexus.otago.ac.nz/repository/dst-python-localshop/simple/&quot;</p>
</blockquote>
<p>uv.lock now:
<a href="https://github.com/user-attachments/files/17550784/uv.lock.txt">uv.lock.txt</a></p>
<p>Comment out index-url, remove uv.lock, and <code>uv sync</code>, output:</p>
<blockquote>
<p>Resolved 26 packages in 20ms
Uninstalled 2 packages in 3ms
Installed 2 packages in 4ms</p>
<ul>
<li>alabaster==0.7.16</li>
</ul>
<ul>
<li>alabaster==0.7.13</li>
</ul>
<ul>
<li>sphinxcontrib-devhelp==1.0.6</li>
</ul>
<ul>
<li>sphinxcontrib-devhelp==1.0.2</li>
</ul>
</blockquote>
<p>When I was doing this at the time of creating this issue, sphinx was getting up/downgraded along with alabaster and sphinxcontrib-devhelp (and perhaps sphinxcontrib-serializinghtml as well, not 100% sure).</p>
<p>Running <code>uv sync</code> with -vvv at the time gave lots of &quot;Abandoning prefetch for <xxx> due to missing registry capabilities&quot; which I assume is due to something Nexus does/doesn't do, and might be related? There seem to be fewer of these messages now, unless I delete uv's cache - but even then the correct version of sphinx is still loading.</p>
<p>alabaster 0.7.16 and sphinxcontrib-devhelp 1.0.6 both have the requires-python &gt;= 3.9 in the METADATA file that's been installed into .venv/lib/python3.8/site-packages/alabaster-0.7.16.dist-info/METADATA or equivalent, so still broken, just slightly more subtly than the other day.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:23 UTC
    </footer>
</body>
</html>
