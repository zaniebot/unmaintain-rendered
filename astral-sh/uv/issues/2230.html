<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python tests pass when packages installed with `pip` outside venv , but not with `uv pip install --system` - astral-sh/uv #2230</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Python tests pass when packages installed with `pip` outside venv , but not with `uv pip install --system`</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/2230">#2230</a>
        opened by <a href="https://github.com/strickvl">@strickvl</a>
        on 2024-03-06 06:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/strickvl">@strickvl</a> on 2024-03-06 06:46</div>
            <div class="timeline-body"><p>[This is maybe a weird one, and not quite sure to what extent it's driven by <code>uv</code> vs other things, but the change made was adding <code>uv</code> so I'm going to ask here.]</p>
<p>We have a series of unit tests that run on 4 versions of Python in Windows, Ubuntu and MacOS runners in github actions. I'm switching our CI to use <code>uv pip install</code> since it offers a big speedup for installation times. For each runner, we set up Python with <code>actions/setup-python@v5.0.0</code> as is standard and then we install all our packages using <a href="https://github.com/zenml-io/zenml/blob/feature/use-uv-ci/scripts/install-zenml-dev.sh">this script</a>. Take note that we're using <code>uv pip install --system</code> to install the packages.</p>
<p>Later on we run our unit tests etc. Previously, before the changes <a href="https://github.com/zenml-io/zenml/pull/2442">in the PR / branch</a> all unit tests passed without issue. Since using <code>uv</code>, two tests fail on <a href="https://github.com/zenml-io/zenml/blob/4cdbe487d8792327eb3e8942c42929eab59ef2ca/tests/unit/utils/test_source_utils.py#L110-L114">essentially the same issue</a> across all our Windows runners:</p>
<pre><code class="language-python">    assert source_utils.resolve(defaultdict) == Source(
        module=defaultdict.__module__,
        attribute=defaultdict.__name__,
        type=SourceType.BUILTIN,
    )
</code></pre>
<p>(Code for the <code>resolve</code> function is <a href="https://github.com/zenml-io/zenml/blob/28eb2f5f60264c18bf788faf6a0380e961a68658/src/zenml/utils/source_utils.py">here</a> + <a href="https://github.com/zenml-io/zenml/blob/a24ccb12d4cfd5652388b031ca828600981a1925/tests/unit/utils/test_source_utils.py#L110-L113">for the test here</a>.)</p>
<p><a href="https://github.com/zenml-io/zenml/actions/runs/8100734877/job/22171677679">Here</a> you can see the two failures. Our source resolution util is behaving differently now that we're using <code>uv</code> to install our packages. I know there were <a href="https://github.com/astral-sh/uv/issues?q=is%3Aissue+windows+">some issues and discussions</a> around Windows installations so I thought I'd ask if there's a known issue here where for some reason when using <code>uv</code>'s <code>collections</code> version of the <code>defaultdict</code> our code resolves it as an unknown sourcetype with <code>uv</code> but as builtin without <code>uv</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-06 20:20</div>
            <div class="timeline-body"><p>That is... interesting. I'm not immediately sure what could be going wrong there. I'm obliged to confirm that <code>uv</code> is the only change in that branch, and that there isn't something else that could be at fault? :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-03-06 20:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/strickvl">@strickvl</a> on 2024-03-07 13:19</div>
            <div class="timeline-body"><p>Correct. https://github.com/zenml-io/zenml/pull/2442/files you can see the only changes that have been made in this branch relate to using <code>uv</code> instead of <code>pip</code>. The actual runs for the runners (I reran them fresh to confirm just now) can be viewed <a href="https://github.com/zenml-io/zenml/actions/runs/8187349253?pr=2442">here</a>. (It's the <code>ci-slow.yaml</code> that triggers the Windows runners to run the unit tests, and all those Windows runners fail for the reason explained above.)</p>
<p>A pity you didn't already have something that springs to mind. Suggests that maybe it's actually nothing to do with <code>uv</code>, though don't have too many bright ideas on how to pin that down, esp given the only thing changed in this PR is switching out <code>pip</code> for <code>uv</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-07 14:19</div>
            <div class="timeline-body"><p>How would you describe the failure informally? Like, &quot;It now thinks that <code>collections</code> is a third-party module instead of a standard-library module, so there must be some <code>collections</code> somewhere in path&quot; or similar.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/strickvl">@strickvl</a> on 2024-03-07 14:26</div>
            <div class="timeline-body"><p>https://github.com/zenml-io/zenml/actions/runs/8190492597 is my attempt to isolate what's going on, logging the state of the following:</p>
<pre><code class="language-bash">python -c &quot;import sys; print(f'Python version: {sys.version}')&quot;
python -c &quot;import collections; print(f'collections module file path: {collections.__file__}')&quot;
python -c &quot;import collections; print(f'collections module name: {collections.__name__}')&quot;
python -c &quot;from collections import defaultdict; print(f'defaultdict type: {type(defaultdict)}')&quot;
python -c &quot;import sys; from collections import defaultdict; from zenml.config.source import Source, SourceType; from zenml.utils import source_utils; print(f'source_utils.resolve(defaultdict): {source_utils.resolve(defaultdict)}'); print(f'Source object: {Source(module=defaultdict.__module__, attribute=defaultdict.__name__, type=SourceType.BUILTIN)}')&quot;
python -c &quot;import sys; print(f'Python executable: {sys.executable}')&quot;
python -c &quot;import sys; print(f'Module search paths: {sys.path}')&quot;
echo &quot;PYTHONPATH: $PYTHONPATH&quot;
echo &quot;PATH: $PATH&quot;
uv --version
pip list
</code></pre>
<p>I hope that will shed some light on what's going on. (Full workflow <a href="https://github.com/zenml-io/zenml/actions/runs/8190492597/workflow">here</a>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @konstin by @konstin on 2024-03-07 15:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/strickvl">@strickvl</a> on 2024-03-07 17:23</div>
            <div class="timeline-body"><p><img src="https://github.com/astral-sh/uv/assets/3348134/02d68a45-f0a5-4a59-ad45-bfe23b380d57" alt="CleanShot 2024-03-07 at 18 14 02@2x" /></p>
<p>They both output the same thing when run this way, interestingly. So outside the test suite, both <code>pip</code> and <code>uv</code> installations resolve the 'wrong' way on Windows.</p>
<p>So for some reason it's resolving <code>collections</code> as a non-standard-lib module, as you said, for Windows whereas it's find it just fine within Ubuntu / MacOS.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/strickvl">@strickvl</a> on 2024-03-07 20:22</div>
            <div class="timeline-body"><p>Having dug into it a bit further, I've noticed that some caching settings on our CI seem to have been the thing that have changed. I reran the tests with the old behaviour restored and the tests pass. We'll have to dig into this on our side to better understand why the caching changes the behaviour of the tests, but I'm now sure that it has nothing to do with <code>uv</code>. Thanks for the prompt to dig further and apologies for any wasted time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @strickvl on 2024-03-07 20:22</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:18 UTC
    </footer>
</body>
</html>
