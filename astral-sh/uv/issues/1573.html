<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>entry points/scripts  with additional &quot;attributes&quot; are not generated correctly (e.g. for Pyinvoke) - astral-sh/uv #1573</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>entry points/scripts  with additional &quot;attributes&quot; are not generated correctly (e.g. for Pyinvoke)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/1573">#1573</a>
        opened by <a href="https://github.com/markmmm">@markmmm</a>
        on 2024-02-17 04:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/markmmm">@markmmm</a> on 2024-02-17 04:34</div>
            <div class="timeline-body"><p><code>uv</code> generates console scripts incorrectly for entry_points that have dotted function paths.
For example <a href="https://github.com/pyinvoke/invoke/blob/main/setup.py#L46C1-L51C7">Invoke's setup.py</a>:</p>
<pre><code class="language-python">    entry_points={
        &quot;console_scripts&quot;: [
            &quot;invoke = invoke.main:program.run&quot;,
            &quot;inv = invoke.main:program.run&quot;,
        ]
    },
</code></pre>
<p>The generated script will look like:</p>
<pre><code class="language-python">#!/path/to/uv-venv/bin/python
# -*- coding: utf-8 -*-
import re
import sys
from invoke.main import program.run
if __name__ == &quot;__main__&quot;:
    sys.argv[0] = re.sub(r&quot;(-script\.pyw|\.exe)?$&quot;, &quot;&quot;, sys.argv[0])
    sys.exit(program.run())
</code></pre>
<p>And trying to run this (Python 3.12.0) generates:</p>
<pre><code>uv-venv/bin/inv
  File &quot;/Users/markm/clmv2/ServiceTest/uv-venv/bin/inv&quot;, line 5
    from invoke.main import program.run
                                   ^
SyntaxError: invalid syntax
</code></pre>
<p>The pip generated console script separates the import_name from the function_name</p>
<pre><code class="language-python">#!/path/to/py-venv/bin/python3.12
# -*- coding: utf-8 -*-
import re
import sys
from invoke.main import program
if __name__ == '__main__':
    sys.argv[0] = re.sub(r'(-script\.pyw|\.exe)?$', '', sys.argv[0])
    sys.exit(program.run())
</code></pre>
<ul>
<li>Steps to Reproduce:<ul>
<li><code>uv pip install pyinvoke</code></li>
<li><code>inv</code> (or <code>invoke</code>)</li>
</ul>
</li>
<li>Platform: macOS 14.3 (23D56) (M1)</li>
<li><code>uv-version</code>:  <code>uv 0.1.3</code></li>
</ul>
<p>I see there is a comment in the UV code asking what is the format - I think we can probably follow the rules here: https://github.com/pypa/setuptools/blob/main/docs/userguide/entry_point.rst#entry-points-syntax i.e.</p>
<blockquote>
<p><strong>Nested object</strong></p>
<p>If you supply:</p>
<pre><code class="language-python">&lt;name&gt; = &lt;package_or_module&gt;:&lt;object&gt;.&lt;attr&gt;.&lt;nested_attr&gt;
</code></pre>
<p>this will be roughly interpreted as:</p>
<pre><code class="language-python">from &lt;package_or_module&gt; import &lt;object&gt;
parsed_value = &lt;object&gt;.&lt;attr&gt;.&lt;nested_attr&gt;
</code></pre>
</blockquote>
<p>Also maybe not relevant - but the script parsing regex looks different between Pip and uv:</p>
<ul>
<li>Pip: https://github.com/pypa/pip/blob/7f8a6844037fb7255cfd0d34ff8e8cf44f2598d4/src/pip/_vendor/distlib/util.py#L710</li>
<li>uv: https://github.com/astral-sh/uv/blob/main/crates/install-wheel-rs/src/script.rs#L46C9-L46C155</li>
</ul>
<p>I don't mind trying to fix this - but unsure whether I should add an &quot;import_name&quot; field to <code>script::Script</code> - or provide a function to return these from the string (i.e. instead of using <code>entrypoint.import_name</code></p>
<p>Would the preference be to extract this in the regex - or via string parsing/splitting?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-17 04:42</div>
            <div class="timeline-body"><p>Awesome, thank you! Would love help. I think it'd be reasonable to add a field to <code>script::Script</code>, but I don't have a strong preference at this point.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-02-17 04:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-17 04:42</div>
            <div class="timeline-body"><p>Thanks for writing up such a clear issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/WAKayser">@WAKayser</a> on 2024-02-17 20:53</div>
            <div class="timeline-body"><p>I also ran into this when installing granian.  Which also has a dot in the script but not in the module name.</p>
<p>Below I attached the differences between pip and uv I found, which match the problem.</p>
<pre><code>[project.scripts]
granian = 'granian:cli.cli'
</code></pre>
<p>The script generated by pip is:</p>
<pre><code>#!/usr/local/bin/python
# -*- coding: utf-8 -*-
import re
import sys
from granian import cli
if __name__ == '__main__':
    sys.argv[0] = re.sub(r'(-script\.pyw|\.exe)?$', '', sys.argv[0])
    sys.exit(cli.cli())

</code></pre>
<p>While uv creates</p>
<pre><code>#!/usr/local/bin/python
# -*- coding: utf-8 -*-
import re
import sys
from granian import cli.cli
if __name__ == &quot;__main__&quot;:
    sys.argv[0] = re.sub(r&quot;(-script\.pyw|\.exe)?$&quot;, &quot;&quot;, sys.argv[0])
    sys.exit(cli.cli())
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">great writeup</span> added by @zanieb on 2024-02-17 20:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-17 22:02</div>
            <div class="timeline-body"><p>I can look into this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @MichaReiser by @MichaReiser on 2024-02-17 22:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-02-19 10:09</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 05:42:58 UTC
    </footer>
</body>
</html>
