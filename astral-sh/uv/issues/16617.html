<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caching wheel files - does not refresh? - astral-sh/uv #16617</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Caching wheel files - does not refresh?</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/16617">#16617</a>
        opened by <a href="https://github.com/behrenhoff">@behrenhoff</a>
        on 2025-11-06 17:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/behrenhoff">@behrenhoff</a> on 2025-11-06 17:49</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I am creating a wheel file out of my lib.
When testing the wheel, I use it outside of my repository - and to do that, I use <code>uv run --isolated --refresh --with  path/to/MYWHEEL.whl ...</code></p>
<p>That works <strong>once</strong> - but when I discover a bug and change the code + rebuild the wheel, uv keeps using the old wheel until I run <code>uv cache prune</code>.</p>
<p>According to the documentation, wheel files are cached via their modification time (source: https://docs.astral.sh/uv/concepts/cache/):</p>
<blockquote>
<p>For local dependencies, uv caches based on the last-modified time of the source archive (i.e., the local .whl or .tar.gz file).</p>
</blockquote>
<p>As my new wheel has a newer mtime, my expectation was that it would be picked up.</p>
<p>Is there any way uv could detect this by itself? Can I exclude certain packages from caching? This is in particular the case for local wheels which are being tested. Of course I usually want the dependencies of my wheel to come from cache (it might depend on huge packages like tensorflow, therefore disabling cache completely is not an option).</p>
<p>A simple reproducer is this script (run it in a temporary directory):</p>
<pre><code class="language-bash">#!/bin/bash

set -e

uv --version

rm -rf bug
uv cache prune

uv init --lib bug

cd bug

uv build --wheel
stat dist/bug-0.1.0-py3-none-any.whl
cd ..

echo
echo &quot;First call&quot;
echo &quot;-----------------------------------------------&quot;
uv run --isolated --refresh --with bug/dist/bug-0.1.0-py3-none-any.whl python -c 'import bug; print(bug.hello())'
echo &quot;-----------------------------------------------&quot;
echo

cd bug
cat &lt;&lt; EOF &gt; src/bug/__init__.py
def hello() -&gt; str:
    return &quot;Updated code!&quot;
EOF
rm -f dist/bug-0.1.0-py3-none-any.whl  # does not matter, but this ensures all times are different
uv build --wheel
stat dist/bug-0.1.0-py3-none-any.whl
cd ..

echo
echo &quot;Trying to run modified wheel (no output from uv&quot;
echo &quot;about reinstallation, the printout is still the&quot;
echo &quot;old one.&quot;
echo &quot;-----------------------------------------------&quot;
uv run --isolated --refresh --with bug/dist/bug-0.1.0-py3-none-any.whl python -c 'import bug; print(bug.hello())'
echo &quot;-----------------------------------------------&quot;
echo

uv cache prune
echo
echo &quot;Running modified wheel after cache pruning&quot;
echo &quot;Now the output is correct&quot;
echo &quot;-----------------------------------------------&quot;
uv run --isolated --refresh --with bug/dist/bug-0.1.0-py3-none-any.whl python -c 'import bug; print(bug.hello())'
echo &quot;-----------------------------------------------&quot;
</code></pre>
<p>The output is:</p>
<pre><code>$ ./uv-chache-reproducer.sh
uv 0.9.7
Pruning cache at: /home/username/.cache/uv
Removed 35 files (31.9KiB)
Initialized project `bug` at `/tmp/bug`
Building wheel (uv build backend)...
Successfully built dist/bug-0.1.0-py3-none-any.whl
  File: dist/bug-0.1.0-py3-none-any.whl
  Size: 1364            Blocks: 8          IO Block: 4096   regular file
Device: 0,37    Inode: 6099        Links: 1
Access: (0664/-rw-rw-r--)  Uid: ( 1000/username)   Gid: ( 1000/username)
Access: 2025-11-06 18:41:21.143532545 +0100
Modify: 2025-11-06 18:41:21.144532555 +0100
Change: 2025-11-06 18:41:21.144532555 +0100
 Birth: 2025-11-06 18:41:21.143532545 +0100

First call
-----------------------------------------------
Installed 1 package in 0.31ms
Hello from bug!
-----------------------------------------------

Building wheel (uv build backend)...
Successfully built dist/bug-0.1.0-py3-none-any.whl
  File: dist/bug-0.1.0-py3-none-any.whl
  Size: 1363            Blocks: 8          IO Block: 4096   regular file
Device: 0,37    Inode: 6100        Links: 1
Access: (0664/-rw-rw-r--)  Uid: ( 1000/username)   Gid: ( 1000/username)
Access: 2025-11-06 18:41:21.308534251 +0100
Modify: 2025-11-06 18:41:21.309534261 +0100
Change: 2025-11-06 18:41:21.309534261 +0100
 Birth: 2025-11-06 18:41:21.308534251 +0100

Trying to run modified wheel (no output from uv
about reinstallation, the printout is still the
old one.
-----------------------------------------------
Hello from bug!
-----------------------------------------------

Pruning cache at: /home/username/.cache/uv
Removed 35 files (31.9KiB)

Running modified wheel after cache pruning
Now the output is correct
-----------------------------------------------
Installed 1 package in 0.30ms
Updated code!
-----------------------------------------------
</code></pre>
<p>As you can see, I get &quot;Hello from bug!&quot; twice, even after rebuilding the wheel. Only after pruning, the new wheel is used.</p>
<h3>Platform</h3>
<p>Linux 6.14.0-35-generic x86_64 GNU/Linux</p>
<h3>Version</h3>
<p>uv 0.9.7</p>
<h3>Python version</h3>
<p>Python 3.12.3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @behrenhoff on 2025-11-06 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-11-06 17:50</div>
            <div class="timeline-body"><p>cc @konstin</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-11-06 17:55</div>
            <div class="timeline-body"><p>My guess is that this is specific to <code>--with</code> where we use the cached environment concept.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/caschb">@caschb</a> on 2025-11-08 19:49</div>
            <div class="timeline-body"><p>As @charliermarsh said, the origin of this problem is in the <code>CachedEnvironment</code>.</p>
<p>https://github.com/astral-sh/uv/blob/1b7faafd7a64f5eb91743213ce14cbb8e3cd248f/crates/uv/src/commands/project/environment.rs#L151-L181</p>
<p>The cache only uses the resolution and the interpreter path to create the content-addressed location, so if neither the resolution or the interpreter change, a collision happens.</p>
<p>A way to solve this could be to include more information in the hash that is tied to the state of the project, but I'm not sure how to implement this, or if this is indeed the best way to solve this problem.</p>
<blockquote>
<p>There are only two hard things in Computer Science: cache invalidation, naming things, and off by one errors</p>
<ul>
<li>Phil Karlton</li>
</ul>
</blockquote>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:05 UTC
    </footer>
</body>
</html>
