<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ability to cache Python downloads in Docker build - astral-sh/uv #16289</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Ability to cache Python downloads in Docker build</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/16289">#16289</a>
        opened by <a href="https://github.com/merlinz01">@merlinz01</a>
        on 2025-10-13 23:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/merlinz01">@merlinz01</a> on 2025-10-13 23:07</div>
            <div class="timeline-body"><h3>Question</h3>
<p>Is there a way to cache what is downloaded for managed Python installations? As far as I can tell, uv either downloads and extracts in-memory to <code>UV_PYTHON_INSTALL_DIR</code>, or downloads to a temp file, extracts, and then deletes it. Neither would make it possible to cache the Python download in Docker with <code>RUN --mount=type=cache</code>. So with <code>UV_CACHE_DIR</code> cached, even though the package installation is very fast, it has to download Python every time the packages are installed, slowing down the build.</p>
<p>It doesn't work to cache-mount <code>UV_PYTHON_INSTALL_DIR</code> because then the Python binary isn't included in the final image.</p>
<p>This is the relevant part of the Dockerfile I'm using:</p>
<pre><code class="language-dockerfile"># syntax=docker/dockerfile:1-labs
FROM debian:trixie-slim
RUN apt-get update &amp;&amp; \
    apt-get install -y ca-certificates git &amp;&amp; \
    update-ca-certificates &amp;&amp; \
    apt-get clean &amp;&amp; \
    rm -rf /var/lib/apt/lists/*
COPY --from=ghcr.io/astral-sh/uv:0.7 /uv /usr/bin/uv
RUN useradd myuser -d /app -M -U -u 1000
USER myuser
WORKDIR /app
COPY pyproject.toml uv.lock ./
RUN mkdir -p .cache/uv
RUN --mount=type=cache,uid=1000,gid=1000,target=/app/.cache/uv \
    uv sync --compile-bytecode --frozen --no-dev --link-mode=copy
</code></pre>
<p>As you can see it takes 2.8 seconds downloading Python:</p>
<pre><code> &gt; [stage-0  9/12] RUN --mount=type=cache,uid=1000,gid=1000,target=/app/.cache/uv     uv sync --compile-bytecode --frozen --no-dev --link-mode=copy:
0.390 Downloading cpython-3.13.5-linux-x86_64-gnu (download) (33.8MiB)
3.173  Downloading cpython-3.13.5-linux-x86_64-gnu (download)
3.305 Using CPython 3.13.5
3.305 Creating virtual environment at: .venv
3.529 Installed 102 packages in 208ms
4.443 Bytecode compiled 3072 files in 912ms
4.443  + aerich==0.9.2
4.443  + aiofiles==24.1.0
4.443  + aiohappyeyeballs==2.6.1
4.443  + aiohttp==3.12.3
4.443  + aiosignal==1.3.2
...
</code></pre>
<p>What I would like is if there was something like <code>$UV_PYTHON_DOWNLOAD_CACHE_DIR</code> (default to <code>$UV_CACHE_DIR/python-download-archives</code>) that is where all the Python distributions (<code>cpython-3.13.5-linux-x86_64-gnu.tar.gz</code> etc) are downloaded to and left intact, then used for subsequent Python installs.</p>
<p>Possibly related:
#13304
#7865
#8025
#14265
#6212
https://github.com/astral-sh/setup-uv/pull/621</p>
<h3>Platform</h3>
<p>Linux 6.1.0-39-amd64 x86_64 GNU/Linux</p>
<h3>Version</h3>
<p>uv 0.7.22</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @merlinz01 on 2025-10-13 23:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-10-14 10:27</div>
            <div class="timeline-body"><p>There's <code>UV_PYTHON_CACHE_DIR</code>, but for docker builds, you can run <code>uv python install 3.13</code> in a separate step before <code>COPY pyproject.toml uv.lock ./</code> (potentially after copying the <code>.python_version</code> file), so the step gets cached in docker.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/merlinz01">@merlinz01</a> on 2025-10-14 12:32</div>
            <div class="timeline-body"><blockquote>
<p>There's <code>UV_PYTHON_CACHE_DIR</code></p>
</blockquote>
<p>Hey, that seems to do the trick. I only wish it were better documented, as it's only listed in the docs for environment variables. What is the default location for <code>UV_PYTHON_CACHE_DIR</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-10-14 12:33</div>
            <div class="timeline-body"><p>There is no default location right now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/merlinz01">@merlinz01</a> on 2025-10-14 12:34</div>
            <div class="timeline-body"><p>Does that mean that if <code>UV_PYTHON_CACHE_DIR</code> is unset, uv extracts on-the-fly to the target directory without saving the archive to a file?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/merlinz01">@merlinz01</a> on 2025-10-14 15:59</div>
            <div class="timeline-body"><p>I think that is the case, in this code:</p>
<p>https://github.com/astral-sh/uv/blob/8eada1685ccb4bcd63d78bcc808ab23a4585aa7f/crates/uv-python/src/downloads.rs#L1041-L1127</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-10-14 16:10</div>
            <div class="timeline-body"><p>While you can use <code>UV_PYTHON_CACHE_DIR</code>, I do recommend using <code>uv python install ...</code> in an early cached layer, it's much better suited to the task.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-10-14 17:17</div>
            <div class="timeline-body"><blockquote>
<p>Does that mean that if UV_PYTHON_CACHE_DIR is unset, uv extracts on-the-fly to the target directory without saving the archive to a file?</p>
</blockquote>
<p>Yeah, that is the case.</p>
<p>I'll probably turn on the cache directory by default at some point? We just haven't yet. It's unclear if it's beneficial enough.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/merlinz01">@merlinz01</a> on 2025-10-14 17:34</div>
            <div class="timeline-body"><blockquote>
<p>While you can use <code>UV_PYTHON_CACHE_DIR</code>, I do recommend using <code>uv python install ...</code> in an early cached layer, it's much better suited to the task.</p>
</blockquote>
<p>Good point, yet being able to cache Python downloads adds efficiency to the build for whenever a earlier yet layer is invalidated.</p>
<blockquote>
<p>I'll probably turn on the cache directory by default at some point? We just haven't yet. It's unclear if it's beneficial enough.</p>
</blockquote>
<p>For this use case, I'm happy to set an environment variable since it's all specified in the Dockerfile and not something I have to type out often.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:33:13 UTC
    </footer>
</body>
</html>
