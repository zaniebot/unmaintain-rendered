<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv pip compile --resolution lowest-direct` treats transitive dependencies of file dependencies as direct. - astral-sh/uv #4238</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`uv pip compile --resolution lowest-direct` treats transitive dependencies of file dependencies as direct.</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/4238">#4238</a>
        opened by <a href="https://github.com/patrick-kidger">@patrick-kidger</a>
        on 2024-06-11 16:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/patrick-kidger">@patrick-kidger</a> on 2024-06-11 16:27</div>
            <div class="timeline-body"><p><strong>MWE</strong>:</p>
<p>Lead with the bit that's interesting! After a bit of head-scratching it turned out to be quite simple:</p>
<pre><code># one/pyproject.toml
[project]
name = &quot;one&quot;
version = &quot;0.0.1&quot;
dependencies = [&quot;two @ file://${PROJECT_ROOT}/../two&quot;]

# two/pyproject.toml
[project]
name = &quot;two&quot;
version = &quot;0.0.1&quot;
dependencies = [&quot;typing_extensions&gt;=4.5.0&quot;]
</code></pre>
<p>then</p>
<pre><code>one❯ uv pip compile pyproject.toml --resolution lowest-direct                
Resolved 2 packages in 86ms
# This file was autogenerated by uv via the following command:
#    uv pip compile pyproject.toml --resolution lowest-direct
two @ file://${PROJECT_ROOT}/../two
    # via one (pyproject.toml)
typing-extensions==4.5.0
    # via two
</code></pre>
<p><strong>Expected behaviour</strong>: to get <code>typing-extensions==4.12.2</code> (at time of writing).</p>
<p><strong>Versions</strong>: I've reproduced this with <code>uv</code> at <code>HEAD</code>, <code>0.2.10</code>, <code>0.2.4</code>, <code>0.1.34</code>.</p>
<p><strong>Other variations</strong>:
The same bug also occurs in all of the following scenarios:</p>
<ol>
<li>When expressed on the command line:</li>
</ol>
<pre><code>one❯ printf 'two @ file://${PROJECT_ROOT}/../two' | uv pip compile - --resolution lowest-direct
</code></pre>
<ol start="2">
<li>When expressed editably (side note, this one is our actual use-case).</li>
</ol>
<pre><code>one❯ printf '-e file://${PROJECT_ROOT}/../two' | uv pip compile - --resolution lowest-direct
</code></pre>
<ol start="3">
<li>When not using <code>PROJECT_ROOT</code>:</li>
</ol>
<pre><code>one❯ printf '-e file:///absolute/path/to/two' | uv pip compile - --resolution lowest-direct
</code></pre>
<p>(FWIW we found this problem as the resulting <code>requirements.txt</code> files go on to be used as <code>constraints</code> in one of our later build steps.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw-gts">@notatallshaw-gts</a> on 2024-06-11 16:49</div>
            <div class="timeline-body"><p>I also encountered this same behavior yesterday, specifically in the context of &quot;3.&quot;, and while surprised I personally found it useful, so wasn't sure if it was intentional or not.</p>
<p>If I have a local package I am passing into the requirement, uv can only see one version of it, so it made sense to me it would look for the lowest direct dependencies of that package, and was a better test for my environment.</p>
<p>But it is surprising, and not the behavior I would expect from the description.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-11 16:58</div>
            <div class="timeline-body"><p>Yeah this is intentional -- we consider anything local to be first-party, i.e., conceptually part of your local workspace.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-11 16:59</div>
            <div class="timeline-body"><p>Is this a real problem or undesirable behavior in your use-case, or just something that needs to be better-documented? (I'm not fully convinced that we should change it but open-minded of course.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/patrick-kidger">@patrick-kidger</a> on 2024-06-11 18:28</div>
            <div class="timeline-body"><p>At least for us it's undesirable behaviour! What's going on is that we have several libraries that depend on each other. Most of the time we express this as a git/PyPI dependency. But during local development, if making a cross-cutting change, then we switch that into an editable dependency.</p>
<p>So
(a) ideally such dependencies would behave the same as normal git/PyPI dependencies, as they're still conceptually separate libraries;
(b) if I've grokked this correctly then I think the nature of our dependency resolution actually changes, if we happen to run <code>uv compile</code> whilst the editable dependency is in place?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-11 18:39</div>
            <div class="timeline-body"><p>Yeah, if you run with <code>--resolution lowest-direct</code>, then what's considered &quot;direct&quot; will change if you switch from using a Git dependency to a local dependency, because one is considered direct and the other is not.</p>
<p>I mean, the weird thing is, given:</p>
<pre><code># one/pyproject.toml
[project]
name = &quot;one&quot;
version = &quot;0.0.1&quot;
dependencies = [&quot;typing-extensions&quot;]
</code></pre>
<p>And then <code>uv pip install ./one</code>, <code>typing-extensions</code> isn't technically a direct dependency either -- it's a transitive dependency, the direct dependency is <code>one @ file:///path/to/tone</code>. But intuitively it should be treated as a direct dependency, right?  Similarly, given <code>uv pip install ./one</code> vs. <code>uv pip install &quot;one @ git+https://...</code>, we treat <code>typing-extensions</code> as direct in the first case but not in the second case, so switching the source does again change what's considered direct. Separate from whether this should be applied transitively as it is now, do you think both of those decisions are correct?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/patrick-kidger">@patrick-kidger</a> on 2024-06-11 19:00</div>
            <div class="timeline-body"><blockquote>
<p>But intuitively it should be treated as a direct dependency, right?</p>
</blockquote>
<p>I don't think so -- at least subjectively by own intuition! :D</p>
<p>Like you say, these are transitive dependencies, I don't have a mental model that differs from that.</p>
<blockquote>
<p>Similarly, given <code>uv pip install ./one</code> vs. <code>uv pip install &quot;one @ git+https://...</code>, we treat typing-extensions as direct in the first case but not in the second case, so switching the source does again change what's considered direct.</p>
</blockquote>
<p>Likewise, this doesn't fit my intution either. I don't expect where a dependency is located to affect anything whatsoever. (Beyond the possible need to make a network request.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw-gts">@notatallshaw-gts</a> on 2024-06-11 19:22</div>
            <div class="timeline-body"><p>I would say that yesterday I arrived at the same mental model as @charliermarsh.</p>
<p>The local projects are projects that I own, so while these local project direct dependencies are transitive of the requirements I feed to uv, they are still the direct dependencies of <em>my</em> projects, which is more useful to my use case at least.</p>
<p>CC @potiuk, is airflow's CI use of lowest-direct referring to local files? A change in behavior here could break your setup.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:28 UTC
    </footer>
</body>
</html>
