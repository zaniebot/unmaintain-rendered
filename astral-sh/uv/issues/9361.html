<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UV on gitlab CICD has some issue - astral-sh/uv #9361</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>UV on gitlab CICD has some issue</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/9361">#9361</a>
        opened by <a href="https://github.com/MaKaNu">@MaKaNu</a>
        on 2024-11-22 18:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MaKaNu">@MaKaNu</a></div>
            <div class="timeline-body"><p>I am not sure at the moment, if this is an issue with the uv image or a <a href="https://gitlab.com/gitlab-org/charts/gitlab-runner/-/issues/477">bug on gitlab</a>, but I stumbled over a different issue when testing my pipelines:</p>
<p>I have tested the following scenarios with different small changes based on the presented errors:</p>
<p><strong>Gitlab runner on Kubernetes executor:</strong></p>
<p>.gitlab-ci.yml:</p>
<pre><code>variables:
  UV_VERSION: 0.5
  PYTHON_VERSION: 3.12
  BASE_LAYER: bookworm-slim

test_ndp_cli:
  stage: test
  image: ghcr.io/astral-sh/uv:latest
  variables:
    UV_CACHE_DIR: .uv-cache
  cache:
    - key:
        files:
          - uv.lock
      paths:
        - $UV_CACHE_DIR
  script:
    - uv python install
    - uv sync --all-extras --dev
    - uv run pytest
    - uv cache prune --ci
</code></pre>
<p>result:</p>
<pre><code>ERROR: Job failed (system failure): prepare environment: setting up trapping scripts on emptyDir: unable to upgrade connection: container not found (&quot;build&quot;). Check https://docs.gitlab.com/runner/shells/index.html#shell-profile-loading for more information
</code></pre>
<p>I have diagnosed a few issues with our kubernetes system, so I have run it multiple times and got a different result:</p>
<pre><code>WARNING: Event retrieved from the cluster: Error: failed to create containerd task: failed to create shim task: OCI runtime create failed: runc create failed: unable to start container process: exec: &quot;sh&quot;: executable file not found in $PATH: unknown
ERROR: Job failed (system failure): prepare environment: waiting for pod running: timed out waiting for pod to start. Check https://docs.gitlab.com/runner/shells/index.html#shell-profile-loading for more information
</code></pre>
<p>So I thought maybe still something wrong on Kubernetes, let me test on a standalone-docker executor:</p>
<p>result:</p>
<pre><code>Using docker image sha256:b4f508bf6cb1eda0e534b608a2a4dec80a8d01cfa2c4f3f8953537b60734d729 for ghcr.io/astral-sh/uv:latest with digest ghcr.io/astral-sh/uv@sha256:5436c72d52c9c0d011010ce68f4c399702b3b0764adcf282fe0e546f20ebaef6 ...
error: unrecognized subcommand &#x27;sh&#x27;
Usage: uv [OPTIONS] &lt;COMMAND&gt;
For more information, try &#x27;--help&#x27;.
Cleaning up project directory and file based variables 00:01
ERROR: Job failed: exit code 2
</code></pre>
<p>Something again with &#x27;sh&#x27; so I thought lets test with empty entrypoint:</p>
<pre><code>diff --git a/.gitlab-ci.yml b/.gitlab-ci.yml
index 909efe2..f30df03 100644
--- a/.gitlab-ci.yml
+++ b/.gitlab-ci.yml
@@ -16,8 +16,12 @@ variables:
   BASE_LAYER: bookworm-slim

 test_ndp_cli:
+  tags: [docker-standalone]
+
   stage: test
-  image: ghcr.io/astral-sh/uv:latest
+  image:
+    name: ghcr.io/astral-sh/uv:latest
+    entrypoint: [&quot;&quot;]
   variables:
     UV_CACHE_DIR: .uv-cache
   cache:
@@ -33,8 +37,11 @@ test_ndp_cli:
     - uv cache prune --ci

 build_linux:
+  tags: [docker-standalone]
   stage: build
-  image: ghcr.io/astral-sh/uv:latest
+  image:
+    name: ghcr.io/astral-sh/uv:latest
+    entrypoint: [&quot;&quot;]
   variables:
     UV_CACHE_DIR: .uv-cache
   cache:
</code></pre>
<p>result:</p>
<pre><code>ERROR: Job failed (system failure): Error response from daemon: failed to create task for container: failed to create shim task: OCI runtime create failed: runc create failed: unable to start container process: exec: &quot;sh&quot;: executable file not found in $PATH: unknown (exec.go:77:0s)
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-22 18:31</div>
            <div class="timeline-body"><p>Have you tried using an image as described in our GitLab integration guide? https://docs.astral.sh/uv/guides/integration/gitlab/</p>
<p>For GitLab, you&#x27;ll want an image that isn&#x27;t distroless: https://docs.astral.sh/uv/guides/integration/docker/#available-images</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-22 18:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MaKaNu">@MaKaNu</a> on 2024-11-22 22:18</div>
            <div class="timeline-body"><p>I was blind and deaf the hole time. As you can see I already had the variables ready but for what ever reason I missed entering the image correctly.</p>
<p>I always tinker at the wrong position... Thanks for pointing out. Kube now works as expected...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MaKaNu">@MaKaNu</a> on 2024-11-22 22:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:35:42 UTC
    </footer>
</body>
</html>
