<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reflink obscures errors when copying directories - astral-sh/uv #515</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Reflink obscures errors when copying directories</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/515">#515</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2023-11-29 18:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/zanieb">@zanieb</a> on 2023-11-29 18:30</div>
            <div class="timeline-body"><pre><code>error: Failed to install: example-pkg-b @ git+https://github.com/pypa/sample-namespace-packages.git@df7530eeb8fa0cb7dbb8ecb28363e8e36bfa2f45#subdirectory=pkg_resources/pkg_b
  Caused by: Failed to reflink /Users/mz/eng/src/astral-sh/puffin/cache/wheels-v0/url/e893521e97fa8b9e/example_pkg_b-1-py3-none-any.whl/example_pkg to /Users/mz/eng/src/astral-sh/puffin/.direnv/python-3.11/lib/python3.11/site-packages/example_pkg
  Caused by: the source path is not an existing regular file
</code></pre>
<p>They rewrite the error message at</p>
<ul>
<li>https://github.com/cargo-bins/reflink-copy/blob/main/src/lib.rs#L61</li>
<li>https://github.com/cargo-bins/reflink-copy/blob/main/src/lib.rs#L103-L112</li>
</ul>
<p>meaning when we copy a directory and it fails, we get a meaningless error about the source not being a file.</p>
<p>With that code removed, we get a better error</p>
<pre><code>error: Failed to install: example-pkg-b @ git+https://github.com/pypa/sample-namespace-packages.git@df7530eeb8fa0cb7dbb8ecb28363e8e36bfa2f45#subdirectory=pkg_resources/pkg_b
  Caused by: Failed to reflink /Users/mz/eng/src/astral-sh/puffin/cache/wheels-v0/url/e893521e97fa8b9e/example_pkg_b-1-py3-none-any.whl/example_pkg to /Users/mz/eng/src/astral-sh/puffin/.direnv/python-3.11/lib/python3.11/site-packages/example_pkg
  Caused by: File exists (os error 17)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-11-29 18:33</div>
            <div class="timeline-body"><p>Since macOS supports <code>clonefile</code> with directories, I'm unsure of the intent of this error transposition.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/516.html">astral-sh/uv#516</a> on 2023-11-29 19:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-11-29 19:30</div>
            <div class="timeline-body"><p>Upstream PR: https://github.com/cargo-bins/reflink-copy/pull/51</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2023-11-30 01:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Initial release" by @charliermarsh on 2023-11-30 01:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-01 18:53</div>
            <div class="timeline-body"><p>I <em>think</em> this is fixed now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-12-01 18:53</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:56 UTC
    </footer>
</body>
</html>
