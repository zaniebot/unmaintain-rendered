<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cannot compile `uv-client` as cargo dependency - astral-sh/uv #15471</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Cannot compile `uv-client` as cargo dependency</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/15471">#15471</a>
        opened by <a href="https://github.com/felixmulder">@felixmulder</a>
        on 2025-08-23 16:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/felixmulder">@felixmulder</a> on 2025-08-23 16:07</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>We're running a project that needs to invoke <code>uv</code> programmatically (we don't expect any API stability, don't worry). However, I'm a bit confused as to why I can't build the project at all as a dependency.</p>
<p>Minimal repro, <code>cargo init uv-repro &amp;&amp; cd uv-repro</code> with:</p>
<pre><code class="language-toml"># Cargo.toml
[package]
name = &quot;uv-repro&quot;
version = &quot;0.1.0&quot;
edition = &quot;2024&quot;

[dependencies]
uv-client = { git = &quot;https://github.com/astral-sh/uv&quot;, rev = &quot;088c908cda450d63db838ab41620d25c34a8d1fa&quot; }
</code></pre>
<pre><code class="language-shell">$ cargo build
</code></pre>
<p>Output:</p>
<pre><code>   Compiling uv-client v0.0.1 (https://github.com/astral-sh/uv#f1647838)
error[E0277]: the trait bound `reqwest_middleware::client::ClientWithMiddleware: From&lt;RedirectClientWithMiddleware&gt;` is not satisfied
   --&gt; /Users/x/.cargo/git/checkouts/uv-c9e40703e19509a8/f164783/crates/uv-client/src/registry_client.rs:937:25
    |
936 |                     let mut reader = AsyncHttpRangeReader::from_head_response(
    |                                      ---------------------------------------- required by a bound introduced by this call
937 |                         self.uncached_client(url).clone(),
    |                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ the trait `From&lt;RedirectClientWithMiddleware&gt;` is not implemented for `reqwest_middleware::client::ClientWithMiddleware`
    |
    = help: the trait `From&lt;RedirectClientWithMiddleware&gt;` is not implemented for `reqwest_middleware::client::ClientWithMiddleware`
            but trait `From&lt;reqwest::Client&gt;` is implemented for it
    = help: for that trait implementation, expected `reqwest::Client`, found `RedirectClientWithMiddleware`
    = note: required for `RedirectClientWithMiddleware` to implement `Into&lt;reqwest_middleware::client::ClientWithMiddleware&gt;`
note: required by a bound in `AsyncHttpRangeReader::from_head_response`
   --&gt; /Users/x/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/async_http_range_reader-0.9.1/src/lib.rs:304:22
    |
303 |     pub async fn from_head_response(
    |                  ------------------ required by a bound in this associated function
304 |         client: impl Into&lt;reqwest_middleware::ClientWithMiddleware&gt;,
    |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ required by this bound in `AsyncHttpRangeReader::from_head_response`

error[E0277]: the trait bound `reqwest_middleware::client::ClientWithMiddleware: From&lt;RedirectClientWithMiddleware&gt;` is not satisfied
   --&gt; /Users/x/.cargo/git/checkouts/uv-c9e40703e19509a8/f164783/crates/uv-client/src/registry_client.rs:936:38
    |
936 |                       let mut reader = AsyncHttpRangeReader::from_head_response(
    |  ______________________________________^
937 | |                         self.uncached_client(url).clone(),
938 | |                         response,
939 | |                         Url::from(url.clone()),
940 | |                         headers.clone(),
941 | |                     )
    | |_____________________^ the trait `From&lt;RedirectClientWithMiddleware&gt;` is not implemented for `reqwest_middleware::client::ClientWithMiddleware`
    |
    = help: the trait `From&lt;RedirectClientWithMiddleware&gt;` is not implemented for `reqwest_middleware::client::ClientWithMiddleware`
            but trait `From&lt;reqwest::Client&gt;` is implemented for it
    = help: for that trait implementation, expected `reqwest::Client`, found `RedirectClientWithMiddleware`
    = note: required for `RedirectClientWithMiddleware` to implement `Into&lt;reqwest_middleware::client::ClientWithMiddleware&gt;`
note: required by a bound in `AsyncHttpRangeReader::from_head_response`
   --&gt; /Users/x/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/async_http_range_reader-0.9.1/src/lib.rs:304:22
    |
303 |     pub async fn from_head_response(
    |                  ------------------ required by a bound in this associated function
304 |         client: impl Into&lt;reqwest_middleware::ClientWithMiddleware&gt;,
    |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ required by this bound in `AsyncHttpRangeReader::from_head_response`

error[E0277]: the trait bound `reqwest_middleware::client::ClientWithMiddleware: From&lt;RedirectClientWithMiddleware&gt;` is not satisfied
   --&gt; /Users/x/.cargo/git/checkouts/uv-c9e40703e19509a8/f164783/crates/uv-client/src/registry_client.rs:942:22
    |
942 |                     .await
    |                      ^^^^^ the trait `From&lt;RedirectClientWithMiddleware&gt;` is not implemented for `reqwest_middleware::client::ClientWithMiddleware`
    |
    = help: the trait `From&lt;RedirectClientWithMiddleware&gt;` is not implemented for `reqwest_middleware::client::ClientWithMiddleware`
            but trait `From&lt;reqwest::Client&gt;` is implemented for it
    = help: for that trait implementation, expected `reqwest::Client`, found `RedirectClientWithMiddleware`
    = note: required for `RedirectClientWithMiddleware` to implement `Into&lt;reqwest_middleware::client::ClientWithMiddleware&gt;`
note: required by a bound in `AsyncHttpRangeReader::from_head_response`
   --&gt; /Users/x/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/async_http_range_reader-0.9.1/src/lib.rs:304:22
    |
303 |     pub async fn from_head_response(
    |                  ------------------ required by a bound in this associated function
304 |         client: impl Into&lt;reqwest_middleware::ClientWithMiddleware&gt;,
    |                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ required by this bound in `AsyncHttpRangeReader::from_head_response`

For more information about this error, try `rustc --explain E0277`.
error: could not compile `uv-client` (lib) due to 3 previous errors
</code></pre>
<p>I'm not certain if there is anything specific to the Cargo build that makes it work within the uv repo itself -- in the uv repo at the same revision, I'm able to build the project. Both with <code>rustc</code> 1.87 and 1.89.</p>
<p>Cheers,
Felix</p>
<h3>Platform</h3>
<p>macOS 15.6.1</p>
<h3>Version</h3>
<p>088c908cda450d63db838ab41620d25c34a8d1fa</p>
<h3>Python version</h3>
<ul>
<li></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @felixmulder on 2025-08-23 16:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-23 18:50</div>
            <div class="timeline-body"><p>Hm the supposedly missing implementation is at https://github.com/astral-sh/uv/blob/4bc6c77f022a55cff3c8c0b3251ce419c372017c/crates/uv-client/src/base_client.rs#L659-L663</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rustlib</span> added by @zanieb on 2025-08-23 18:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/felixmulder">@felixmulder</a> on 2025-08-24 07:49</div>
            <div class="timeline-body"><p>It's pretty strange, the lockfile in the repro gets multiple versions of the <code>reqwest-middleware</code> library:</p>
<pre><code class="language-toml">[[package]]
name = &quot;reqwest-middleware&quot;
version = &quot;0.4.2&quot;
source = &quot;registry+https://github.com/rust-lang/crates.io-index&quot;
checksum = &quot;57f17d28a6e6acfe1733fe24bcd30774d13bffa4b8a22535b4c8c98423088d4e&quot;
dependencies = [
 &quot;anyhow&quot;,
 &quot;async-trait&quot;,
 &quot;http&quot;,
 &quot;reqwest&quot;,
 &quot;serde&quot;,
 &quot;thiserror 1.0.69&quot;,
 &quot;tower-service&quot;,
]

[[package]]
name = &quot;reqwest-middleware&quot;
version = &quot;0.4.2&quot;
source = &quot;git+https://github.com/astral-sh/reqwest-middleware?rev=ad8b9d332d1773fde8b4cd008486de5973e0a3f8#ad8b9d332d1773fde8b4cd008486de5973e0a3f8&quot;
dependencies = [
 &quot;anyhow&quot;,
 &quot;async-trait&quot;,
 &quot;http&quot;,
 &quot;reqwest&quot;,
 &quot;serde&quot;,
 &quot;thiserror 1.0.69&quot;,
 &quot;tower-service&quot;,
]
</code></pre>
<p>I guess the error message is somewhat confusing. I think it has two variants of the library on path when trying to compile ü§î</p>
<p>Hmm, yes adding:</p>
<pre><code class="language-toml">[patch.crates-io]
reqwest-middleware = { git = &quot;https://github.com/astral-sh/reqwest-middleware&quot;, rev = &quot;ad8b9d332d1773fde8b4cd008486de5973e0a3f8&quot; }
reqwest-retry = { git = &quot;https://github.com/astral-sh/reqwest-middleware&quot;, rev = &quot;ad8b9d332d1773fde8b4cd008486de5973e0a3f8&quot; }
</code></pre>
<p>to <code>Cargo.toml</code> in <code>uv-repro</code> fixes this. I guess all the forking confuses Cargo üòÖ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-24 12:14</div>
            <div class="timeline-body"><p>Ah yeah, that's a bummer. Hopefully we can get off those forks soon.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-08-24 12:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/felixmulder">@felixmulder</a> on 2025-08-24 18:31</div>
            <div class="timeline-body"><p>That would be pretty cool! I'll see if I can find some cycles to contribute it back at some point. Thanks for all the tools ‚ò∫Ô∏è</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-08-25 10:40</div>
            <div class="timeline-body"><p>For the reqweest-middleware dependency, the cause we're on a fork is https://github.com/TrueLayer/reqwest-middleware/pull/235, we need get that PR reviewed and merged to get of the fork.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:05 UTC
    </footer>
</body>
</html>
