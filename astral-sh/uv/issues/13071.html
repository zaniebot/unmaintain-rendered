<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>optional-dependency not synced with docker - astral-sh/uv #13071</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>optional-dependency not synced with docker</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/13071">#13071</a>
        opened by <a href="https://github.com/gabriel-vanzandycke">@gabriel-vanzandycke</a>
        on 2025-04-23 16:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gabriel-vanzandycke">@gabriel-vanzandycke</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I'm running <code>jupyterlab</code> within a docker container for my pytorch experiments. All was working well until I added an optional dependency <code>customlib</code> which depends on a private index:</p>
<p><strong>Note: Edited to take <a href="https://github.com/astral-sh/uv/issues/13071#issuecomment-2824998485">charliermarsh's comment</a> into account</strong></p>
<p>Here is my (simplified for sake of clarity) setup, I'm not sure whether it is a bug or a misconfiguration:</p>
<p><strong>Dockerfile</strong></p>
<pre><code class="language-Dockerfile">FROM pytorch/pytorch:2.2.0-cpu
COPY --from=ghcr.io/astral-sh/uv:0.6.16 /uv /bin/uv

# Setting working directory to the root user default home directory
WORKDIR /home/app

# Handle cache and target being on different filesystems
ENV UV_LINK_MODE=copy

# Install dependencies
RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,source=uv.lock,target=uv.lock \
    --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
    uv sync --frozen --no-install-project --no-install-workspace --extra jupyter --extra optional
</code></pre>
<p><strong>pyproject.toml</strong></p>
<pre><code class="language-pyproject.toml">[project]
name = &quot;experiment&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;==3.11.*&quot;
dependencies = [
    &quot;numpy&gt;=1.22&quot;,
    &quot;lightning&gt;=2.4.0&quot;,
    &quot;astconfig==0.2.0&quot;,
]

[project.optional-dependencies]
jupyterlab = ['jupyterlab&gt;=4.3.3']
optional = [&quot;customlib==1.0.0&quot;]

[tool.uv]
package = true # forces packaging this project

[tool.uv.sources]
customlib = { index = &quot;private&quot; }

[[tool.uv.index]]
name = &quot;private&quot;
url = &quot;https://gitlab.private.com/pypi/simple&quot;
</code></pre>
<p><strong>docker-compose.yaml</strong></p>
<pre><code class="language-yaml">services:
  jupyter:
    build: . # Builds the image from the Dockerfile in the current directory
    image: app:latest
    hostname: &quot;${HOSTNAME}&quot; # environment variable defined in your .profile for instance
    command: [&quot;uv&quot;, &quot;run&quot;, &quot;--with&quot;, &quot;jupyter&quot;, &quot;jupyter&quot;, &quot;lab&quot;, &quot;--port=${JUPYTERLAB_PORT}&quot;, &quot;--ip=${HOSTNAME}&quot;, &quot;--allow-root&quot;, &quot;--no-browser&quot;]
    ports:
        - ${JUPYTERLAB_PORT}:${JUPYTERLAB_PORT}
    environment:
      JUPYTERLAB_PORT: ${JUPYTERLAB_PORT}
    volumes:
      - .:/home/app
      - /home/app/.venv
    shm_size: '1g'
    env_file:
      - .env # Load environment variables from .env file which includes keys from the private index
</code></pre>
<p>After creating the container from scratch</p>
<pre><code class="language-bash">docker compose build --no-cache
</code></pre>
<p>The dependencies resolver of <code>uv</code> tries to search <code>wheel</code> into the private index, while it should be fetched from default Pypi.</p>
<pre><code>0.386   Ã— Failed to download `wheel==0.43.0`
0.386   â”œâ”€â–¶ Failed to fetch:
0.386   â”‚   `https://gitlab.private.com/api/pypi/files/&lt;random-key&gt;/wheel-0.43.0-py3-none-any.whl`
0.386   â•°â”€â–¶ HTTP status client error (401 Unauthorized) for url
0.386       (https://gitlab.private.com/api/pypi/files/&lt;random-key&gt;/wheel-0.43.0-py3-none-any.whl)
0.386   help: `wheel` (v0.43.0) was included because `experiment` (v0.1.0) depends
0.386         on `astconfig` (v0.2.0) which depends on `astunparse` (v1.6.3) which
0.386         depends on `wheel`
------
failed to solve: process &quot;/bin/sh -c uv sync --frozen --no-install-project --no-install-workspace --extra jupyterlab --extra das&quot; did not complete successfully: exit code: 1
</code></pre>
<p>The <code>.env</code> file, loaded with the <code>docker-compose.yaml</code> holds the credentials for the private index:</p>
<pre><code>UV_INDEX_PRIVATE_USERNAME=__token__
UV_INDEX_PRIVATE_PASSWORD=key
</code></pre>
<p>Anyone could help ?
Thanks in advance.</p>
<h3>Platform</h3>
<p>Ubuntu 22.04.4 LTS</p>
<h3>Version</h3>
<p>0.6.16</p>
<h3>Python version</h3>
<p>Python 3.11.9</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @gabriel-vanzandycke on 2025-04-23 16:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-04-23 17:17</div>
            <div class="timeline-body"><p>Thanks for filing. You def need to include <code>--extra optional</code> in your <code>uv sync</code> command -- otherwise we'll omit all of the extras. I think your <code>jupyterlab</code> command works because it's using <code>&quot;uv&quot;, &quot;run&quot;, &quot;--with&quot;, &quot;jupyter&quot;</code>, so you're &quot;manually&quot; injecting Jupyter into the environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @charliermarsh on 2025-04-23 17:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2025-04-23 17:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gabriel-vanzandycke">@gabriel-vanzandycke</a> on 2025-04-24 12:03</div>
            <div class="timeline-body"><p>Thanks!
I'm now facing another issue I was mentioning. I updated the OP, but in a nutshell, <code>docker compose build</code> searches for <code>wheel</code> in the private index from which <code>customlib</code> originates, rather than looking for it into PyPi ðŸ¤·</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-04-24 16:19</div>
            <div class="timeline-body"><p>Consider adding <code>explicit = true</code> under <code>[[tool.uv.index]]</code>. That way, only packages marked like <code>customlib = { index = &quot;private&quot; }</code> will come from that index.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gabriel-vanzandycke">@gabriel-vanzandycke</a> on 2025-04-24 18:49</div>
            <div class="timeline-body"><p>Thanks. I had tried this; however it leads to another problem, a dependency of <code>customlib</code> also on the private index cannot be found:</p>
<pre><code>  Ã— No solution found when resolving dependencies for split (python_full_version &gt;= '3.11' and sys_platform == 'darwin'):
  â•°â”€â–¶ Because cvcolors was not found in the package registry and customlib==1.0.0 depends on cvcolors&lt;1.0.0, we can conclude that customlib==1.0.0 cannot be used.
      And because experiment[optional] depends on customlib==1.0.0 and your workspace requires experiment[das], we can conclude that your workspace's requirements are unsatisfiable.
</code></pre>
<p>I tested adding <code>cvcolors</code> to the explicit list of dependencies (although I shouldn't have to), but it led to other problems...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-04-24 18:51</div>
            <div class="timeline-body"><p>Sorry, that's all consistent with the design. If you want a package to come from an explicit index, you need to mark it as such in <code>tool.uv.sources</code> and mark it as a dependency. Adding <code>cvcolors</code> to your list of dependencies shouldn't cause issues if that's a transitive dependency anyway? I also don't know why you're failing to fetch from <code>https://gitlab.private.com/api/pypi/files/&lt;random-key&gt;/wheel-0.43.0-py3-none-any.whl</code> in the first place. That just looks like a PyPI proxy?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-04-24 18:52</div>
            <div class="timeline-body"><p>You can also set <code>--index-strategy unsafe-best-match</code> if you want to trick uv into selecting <code>wheel==0.45.1</code> from PyPI. For whatever reason, your PyPI proxy suggests it has <code>wheel</code>, but only at version 0.43.0.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-04-24 18:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gabriel-vanzandycke">@gabriel-vanzandycke</a> on 2025-04-28 10:16</div>
            <div class="timeline-body"><p>I've investigated deeper and the issue was related to unavailable credentials at the moment of</p>
<pre><code>RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,source=uv.lock,target=uv.lock \
    --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
    uv sync --frozen --no-install-project --no-install-workspace
</code></pre>
<p>It was resolved by adding a secret to my <code>docker-compose.yaml</code></p>
<pre><code>secrets:
  gitlab:
    file: ./.env
</code></pre>
<p>And loading them in my <code>Dockerfile</code> before the call to <code>uv sync</code>:</p>
<pre><code>RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,source=uv.lock,target=uv.lock \
    --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
    --mount=type=secret,id=gitlab,required \
    set -a &amp;&amp; . /run/secrets/gitlab &amp;&amp; set +a &amp;&amp; \
    uv sync --frozen --no-install-project --no-install-workspace
</code></pre>
<p>Setting the extra index to <code>explicit=true</code> in <code>pyproject.toml</code> isn't necessary.</p>
<p>Hope that helps if anyone faces similar issues.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:31:04 UTC
    </footer>
</body>
</html>
