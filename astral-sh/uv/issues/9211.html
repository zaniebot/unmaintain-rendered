<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dependency resolution: unclear behaviour of `--only-group` - astral-sh/uv #9211</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Dependency resolution: unclear behaviour of <code>--only-group</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/9211">#9211</a>
        opened by <a href="https://github.com/ThomasHezard">@ThomasHezard</a>
        on 2024-11-18 19:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ThomasHezard">@ThomasHezard</a></div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

<p>Hello,</p>
<p>I have an issue with dependency resolution.<br />
My project is configured as follows (I am working on a custom <code>Pytoch Lightning</code> extension, <code>tomli</code> is used only in unit tests):</p>
<pre><code>requires-python = &quot;&gt;=3.8&quot;
dependencies = [
    &quot;google-auth~=2.0&quot;,
    &quot;google-cloud-storage~=2.0&quot;,
    &quot;lightning~=2.0&quot;,
    &quot;loguru~=0.1&quot;,
    &quot;mlflow~=2.0&quot;,
    &quot;typing-extensions~=4.0&quot;
]
[dependency-groups]
dev = [
    &quot;tomli~=2.0&quot;,
]
</code></pre>
<p>After locking the environment and building the wheel, the following line fails in my testing script (I want to run the unit tests on the built wheel, not on the source):</p>
<pre><code>uv run --link-mode=copy --python &quot;3.12&quot; --only-dev --with dist/*.whl python -m unittest discover tests &quot;*test*.py&quot;
</code></pre>
<p>with the error (confidential data replaced by <code>XXX</code>)</p>
<pre><code class="language-bash">Installed 1 package in 3ms
  √ó Failed to download and build `numpy==1.24.4`
  ‚îú‚îÄ‚ñ∂ Build backend failed to determine requirements with `build_wheel()` (exit status: 1)

  ‚îÇ   [stderr]
  ‚îÇ   Traceback (most recent call last):
  ‚îÇ     File &quot;&lt;string&gt;&quot;, line 8, in &lt;module&gt;
  ‚îÇ     File &quot;XXX/.cache/uv/builds-v0/.tmp1p0Hp0/lib/python3.12/site-packages/setuptools/__init__.py&quot;, line 10, in &lt;module&gt;
  ‚îÇ       import distutils.core
  ‚îÇ   ModuleNotFoundError: No module named 'distutils'

  ‚ï∞‚îÄ‚ñ∂ distutils was removed from the standard library in Python 3.12. Consider adding a constraint (like `numpy &gt;1.24.4`) to avoid building a version of numpy that depends on distutils.
  help: `numpy` was included because `XXX` depends on `mlflow==2.17.2` which depends on `numpy`

</code></pre>
<p>From what I understand from uv documentation</p>
<pre><code>--only-group only-group  
  Only include dependencies from the specified dependency group.
  May be provided multiple times.
  The project itself will also be omitted.
</code></pre>
<p>and given the fact that <code>tomli</code> has no dependency at all (which means <code>numpy</code> is NOT in the <code>dev</code> dependency group), the following command should behave exactly the same:</p>
<pre><code class="language-bash">uv run --link-mode=copy --python &quot;3.12&quot; --no-project --with &quot;tomli~=2.0&quot; --with dist/*.whl python -m unittest discover tests &quot;*test*.py&quot;
</code></pre>
<p>However, this command runs perfectly!</p>
<p>I tried the <code>--refresh</code> and <code>--reinstall</code> options in the first version, it does not work.</p>
<p>=&gt; <em><strong>Is this a bug or something I am missing?</strong></em></p>
<p>If that is unclear I can try to reproduce my issue in a toy project</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bluss">@bluss</a> on 2024-11-18 19:56</div>
            <div class="timeline-body"><p><code>uv run</code> only does an additive or <code>--inexact</code> sync of dependencies before it runs. It doesn't go out of its way to remove packages like <code>uv sync</code> would do. That could probably be the explanation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-18 19:59</div>
            <div class="timeline-body"><p>Do you have an up-to-date <code>uv.lock</code> file? We always lock the <em>entire</em> project, <code>--only-group</code> only affects the subset of the lockfile that we use.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2024-11-18 20:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ThomasHezard">@ThomasHezard</a> on 2024-11-18 20:17</div>
            <div class="timeline-body"><p>I'll send the up-to-date lock file as soon as I can (in the subway right now ^^).</p>
<p>I understand that locking locks the entire project.</p>
<p>However, even if the dev group contains strictly nothing else than <code>tomli</code>, <code>uv run --only-dev [...]</code> chooses the <code>numpy</code> version corresponding to the one in the lock file and not the <code>numpy</code> version deduced from my wheel dependencies, like <code>uv run --no-project --with tomli [...]</code> does.<br />
In other words: why does <code>uv run --only-dev [...]</code> look up the version in the lock file for packages that are not in the dev group?</p>
<p>If there is a reason behind this behaviour, documenting it clearly might be helpful üôè</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-18 20:40</div>
            <div class="timeline-body"><p>Oh I see you're using <code>--with dist/*.whl</code>. I can't reproduce this on a first try:</p>
<pre><code>‚ùØ uv build
Building source distribution...
...
Successfully built dist/example-0.1.0.tar.gz and dist/example-0.1.0-py3-none-any.whl
‚ùØ uv run --only-group dev --with dist/*.whl python -c &quot;print('hi')&quot;
Installed 92 packages in 587ms
hi
</code></pre>
<p>Nor if I try syncing first</p>
<pre><code>‚ùØ uv sync
Resolved 111 packages in 1ms
Audited 92 packages in 0.06ms
‚ùØ uv run --only-group dev --with dist/*.whl python -c &quot;print('hi')&quot;
Installed 92 packages in 510ms
hi
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-18 20:42</div>
            <div class="timeline-body"><p>I'm not quite sure what's going on, perhaps some verbose logs would be helpful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ThomasHezard">@ThomasHezard</a> on 2024-11-18 21:11</div>
            <div class="timeline-body"><p>I am only having the issues with <code>--python &quot;3.12&quot;</code>, because numpy 1.* fails to install with python 3.12 in my environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-18 21:36</div>
            <div class="timeline-body"><p><code>-p 3.12</code> doesn't change anything for me, it doesn't resolve to an older version of numpy</p>
<pre><code>‚ùØ uv run --only-group dev --with dist/*.whl -p 3.12 python -c &quot;import importlib.metadata; print(importlib.metadata.version('numpy'))&quot;
2.1.3
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ThomasHezard">@ThomasHezard</a> on 2024-11-18 21:47</div>
            <div class="timeline-body"><p>Do you have <code>requires-python = &quot;&gt;=3.8&quot;</code> in your project?<br />
I noticed that a minimum Python of 3.9 or above solves the issue as the <code>uv lock</code> chooses a more recent numpy version which installs correctly under Python 3.12.</p>
<p>I am finishing the toy project to reproduce, I'll send it to you in a few minutes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-18 21:55</div>
            <div class="timeline-body"><p>Ah okay I can reproduce with that (I thought I had it, but must have messed up when creating the reproduction).</p>
<p>And I can work around it by adding a constraint</p>
<pre><code>‚ùØ uv run --only-group dev -p 3.12 --with ./dist/*.whl --with 'numpy&gt;1.24.4' python -c &quot;&quot;
</code></pre>
<p>or by disabling builds</p>
<pre><code>‚ùØ uv run --only-group dev -p 3.12 --with ./dist/*.whl --frozen --no-build python -c &quot;&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ThomasHezard">@ThomasHezard</a> on 2024-11-18 21:55</div>
            <div class="timeline-body"><p>Here is a toy project that reproduces the issue:<br />
https://github.com/ThomasHezard/uv-issue-example</p>
<p>The code is dummy, but the dependencies are exactly the same as my project.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-18 21:57</div>
            <div class="timeline-body"><p>We include the numpy version as a preference</p>
<blockquote>
<p>DEBUG Selecting: numpy==1.24.4 [preference] (numpy-1.24.4.tar.gz)</p>
</blockquote>
<p>I believe we always use the lockfile versions as preferences during project resolution</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ThomasHezard">@ThomasHezard</a> on 2024-11-18 22:06</div>
            <div class="timeline-body"><blockquote>
<p>Ah okay I can reproduce with that (I thought I had it, but must have messed up when creating the reproduction).</p>
<p>And I can work around it by adding a constraint</p>
<pre><code>‚ùØ uv run --only-group dev -p 3.12 --with ./dist/*.whl --with 'numpy&gt;1.24.4' python -c &quot;&quot;
</code></pre>
<p>or by disabling builds</p>
<pre><code>‚ùØ uv run --only-group dev -p 3.12 --with ./dist/*.whl --frozen --no-build python -c &quot;&quot;
</code></pre>
</blockquote>
<p>I sent my message at the same time üôÇ</p>
<p>I did found some several workarounds indeed, including fixing the numpy version like you did üëç<br />
I'll have a closer look at the <code>--frozen</code> option.</p>
<p>However I would like to understand clearly why I end up with this behaviour in order to be able to setup my projects correctly. From my understanding of the documentation, my two commands should end up with the same environment but they do not at all.</p>
<p>Maybe some change in the documentation of the <code>--only-dev</code> may help. I don't think &quot;<em>Only include dependencies from the specified dependency group. The project itself will also be omitted.</em>&quot; describes clearly the behaviour I encountered.</p>
<p>I leave that to the <code>uv</code> team üôÇ<br />
And to be clear: this is not a critical issue, even though it bugged me for quite some time today üòâ</p>
<p>Hope this may help you or somebody in the future encountering the same issue as me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ThomasHezard">@ThomasHezard</a> on 2024-11-18 22:10</div>
            <div class="timeline-body"><p>And by the way, fixing <code>numpy</code> is not enough, as it ends up with incompatible <code>pandas</code> and <code>numpy</code> version, and importing <code>pandas</code> throws an error.</p>
<p>But <code>pandas</code> is struggling a bit with <code>numpy</code> 1.* and 2.*. I often have to fix my <code>numpy</code> version in my environments, especially with older <code>Python</code> version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-18 22:17</div>
            <div class="timeline-body"><blockquote>
<p>I'll have a closer look at the --frozen option.</p>
</blockquote>
<p><code>--no-build</code> is the key option there. <code>--frozen</code> is required to avoid trying to re-validate the lockfile in that case.</p>
<blockquote>
<p>I don't think &quot;Only include dependencies from the specified dependency group. The project itself will also be omitted.&quot; describes clearly the behaviour I encountered.</p>
</blockquote>
<p>Basically this is caveated with: in all uv project operations, we'll prefer versions in the lockfile during resolution for consistency. I don't think this is well documented, we can improve that.</p>
<p>Using <code>--no-project</code> is a bit more than omitting the project itself from the resolution, it's more like &quot;do not discover a project at all&quot; and this ignores the <code>uv.lock</code> entirely.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ThomasHezard">@ThomasHezard</a> on 2024-11-18 22:20</div>
            <div class="timeline-body"><blockquote>
<p>in all uv project operations, we'll prefer versions in the lockfile during resolution for consistency.</p>
</blockquote>
<p>Yes, this is what I'm starting to understand üëç</p>
<p>Thank you very much for the help and reactivity, this is much appreciated üôè</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-11-18 22:23</div>
            <div class="timeline-body"><p>I think the problem you're hitting is the following: uv tries to compute a uniersal lockfile for your <code>requires-python = &quot;&gt;=3.8&quot;</code>. Since newer numpy versions have a higher requires-python minimum, you're getting the old numpy 1.24.4. But that numpy only support up to Python 3.11, which uv doesn't realize, so you're getting build errors on Python 3.12 and up. You can find a long detailed explanation in https://github.com/astral-sh/uv/issues/8492#issuecomment-2431979599.</p>
<p>The proper solution is https://github.com/astral-sh/uv/pull/8686, as a workaround you can coerce uv to give you different numpy versions on different Python versions, something like the following, adjust the bounds to your liking:</p>
<pre><code>numpy&gt;=1.24.2; python_version &gt;= &quot;3.8&quot;
numpy&gt;=2.1.0; python_version &gt;= &quot;3.10&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ThomasHezard">@ThomasHezard</a> on 2024-11-18 22:28</div>
            <div class="timeline-body"><blockquote>
<p>The proper solution is #8686</p>
</blockquote>
<p>Yes, <code>--multi-version</code> seems exactly what I'm looking for indeed ü§©  üëç<br />
This will reproduce more closely the environment I get with <code>uv run --no-project --with dist/*.whl</code> (which is what I am looking in the end).</p>
<blockquote>
<p>as a workaround you can coerce uv to give you different numpy versions on different Python versions, something like the following, adjust the bounds to your liking:</p>
<pre><code>numpy&gt;=1.24.2; python_version &gt;= &quot;3.8&quot;
numpy&gt;=2.1.0; python_version &gt;= &quot;3.10&quot;
</code></pre>
</blockquote>
<p>This is basically the solution I ended up with (in my dev dependencies) üòâ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-11-20 20:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:28:24 UTC
    </footer>
</body>
</html>
