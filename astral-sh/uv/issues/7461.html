<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv add generating unstable environments when used with local version identifiers - astral-sh/uv #7461</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv add generating unstable environments when used with local version identifiers</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/7461">#7461</a>
        opened by <a href="https://github.com/itrase">@itrase</a>
        on 2024-09-17 14:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/itrase">@itrase</a> on 2024-09-17 14:08</div>
            <div class="timeline-body"><p>On uv version 0.4.10</p>
<p>To reproduce:
<code>mkdir project_a</code>
<code>cd project_a</code>
<code>uv init</code>
<code>uv add torch==2.4.1+cu124 --index-url https://download.pytorch.org/whl/cu124</code>
<code>uv add numpy</code></p>
<p>The resulting environment technically works (torch is available for import and uses the correct version of CUDA), but trying to add numpy (or any other package) will give the following error:</p>
<pre><code>  × No solution found when resolving dependencies:
  ╰─▶ Because there is no version of torch==2.4.1+cu124 and your project depends on torch==2.4.1+cu124, we can conclude that
      your project's requirements are unsatisfiable.
  help: If this is intentional, run `uv add --frozen` to skip the lock and sync steps.
</code></pre>
<p>My expectation with <code>uv add</code> is that it is intended to result in a reproducible environment, but it doesn't feel like it is the case here. I know that there is significant weirdness around local version identifiers, so perhaps this is intended behavior - but if so, having uv emit a warning would be good.</p>
<p>We can solve this by adding the following to the pyproject.toml:</p>
<pre><code>[tool.uv]
extra-index-url = [
    &quot;https://download.pytorch.org/whl/cu124&quot;,
]
</code></pre>
<p>This allows us to continue to <code>add</code> packages as normal. However, if I then initialize another project and try to <code>add</code> <code>project_a</code>, things break again:</p>
<p><code>mkdir project_b</code>
<code>cd project_b</code>
<code>uv init</code>
<code>uv add ../project_a --editable</code></p>
<p>We get the same error:</p>
<pre><code>  × No solution found when resolving dependencies:
  ╰─▶ Because there is no version of torch==2.4.1+cu124 and project-a==0.1.0 depends on torch==2.4.1+cu124, we can conclude
      that project-a==0.1.0 cannot be used.
      And because only project-a==0.1.0 is available and your project depends on project-a, we can conclude that your
      project's requirements are unsatisfiable.
  help: If this is intentional, run `uv add --frozen` to skip the lock and sync steps.
</code></pre>
<p>Once again, we can solve this by adding the extra-index-url to <code>project_b</code>'s <code>pyproject.toml</code>, but my expectation is that the extra index should be inherited automatically.</p>
<p>I believe a similar problem exists for things like torch-scatter, which want to use find-links to be installed:
<code>uv add torch_scatter  -f https://data.pyg.org/whl/torch-2.4.0+cu124.html</code>
adding a find-links section to the [tool.uv] allows it to proceed, but results in all downstream projects needing that line as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-17 14:30</div>
            <div class="timeline-body"><p>I think <code>uv add</code> should add the index, and we're going to do that as part of some larger changes to how indexes are handled. (I don't think that <code>project_b</code> should implicitly use the PyTorch index, but this will become easier to get right when we make the aforementioned changes.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JackismyShephard">@JackismyShephard</a> on 2024-11-07 17:39</div>
            <div class="timeline-body"><p>@charliermarsh I am experiencing what I believe may be a related issue. I have a distributable cli application that uses pytorch 2.5.1+cuda124 as a dependency and is built and published (to pypi) using uv. If I try to test the cli application using <code>uv tool install</code> (in another project) I get: <code>error: Because there is no version of torch==2.5.1+cu124 and ultimate-rvc==0.1.5 depends on torch==2.5.1+cu124, we can conclude that ultimate-rvc==0.1.5 cannot be used.</code> Is a fix on the horizon?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/itrase">@itrase</a> on 2024-11-07 18:45</div>
            <div class="timeline-body"><p>@JackismyShephard I'm installing torch in a normal package (not something intended as a tool), but with the updated version of uv (0.4.30), the syntax in the toml that I am using is:</p>
<pre><code>requires-python = &quot;&gt;=3.11,&lt;3.12&quot;
dependencies = [
    &quot;torch==2.5.1+cu124&quot;,
]

[tool.uv.sources]
torch = { index = &quot;pytorch&quot; }

[[tool.uv.index]]
name = &quot;pytorch&quot;
url = &quot;https://download.pytorch.org/whl/cu124&quot;
explicit = true
</code></pre>
<p>This has been working for me - does your cli application specify the index like this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JackismyShephard">@JackismyShephard</a> on 2024-11-07 20:14</div>
            <div class="timeline-body"><p>@itrase Yes I specify the index just like that. I don't think it should make a difference whether the application exposes a cli entry point or not. I have tried both using <code>uv tool install</code> as well as <code>pip install</code> (in a regular virtual environment with no uv installed) . Neither works. However, it should be noted that the package can be installed (from PyPI) as long as I first explicitly run <code>pip install torch==2.5.1+cu124 torchaudio==2.5.1+cu124 --index-url https://download.pytorch.org/whl/cu124</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-27 18:42</div>
            <div class="timeline-body"><p>@itrase -- Is this solved by using <code>uv add --default-index</code>? That writes the index to <code>pyproject.toml</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2024-12-27 18:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/itrase">@itrase</a> on 2024-12-28 18:54</div>
            <div class="timeline-body"><p>yes, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JackismyShephard">@JackismyShephard</a> on 2025-03-02 16:50</div>
            <div class="timeline-body"><p>@itrase @charliermarsh I am still having problems installing my package which is packaged with uv and depending on torch using pip. It only works if I explicitly install torch first using <code>pip install torch==2.4.1+cu124 torchaudio==2.4.1+cu124 --index-url https://download.pytorch.org/whl/cu124</code>. But I guess this might be a pip specific issue due to torch not being hosted on pypi?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-07-16 13:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:50 UTC
    </footer>
</body>
</html>
