```yaml
number: 883
title: "`--python-version` isn't respected in pip-compile for tf-models-nightly"
type: issue
state: closed
author: konstin
labels:
  - bug
assignees: []
created_at: 2024-01-11T12:11:58Z
updated_at: 2024-01-14T15:39:17Z
url: https://github.com/astral-sh/uv/issues/883
synced_at: 2026-01-10T01:57:01Z
```

# `--python-version` isn't respected in pip-compile for tf-models-nightly

---

_Issue opened by @konstin on 2024-01-11 12:11_

`tf-models-nightly>2.14` fails on python 3.12 but succeeds on python 3.10.  The `--python-version` seems to have no effect here.

```
$ virtualenv -p 3.12 --clear .venv
$ cargo run --bin puffin --profile profiling -q -- pip-compile --python-version 3.10 target/tf-models-nightly.txt > /dev/null 2> /dev/null && echo "success" || echo "failure"
failure
$ cargo run --bin puffin --profile profiling -q -- pip-compile --python-version 3.12 target/tf-models-nightly.txt > /dev/null 2> /dev/null && echo "success" || echo "failure"
failure
$ virtualenv -p 3.10 --clear .venv
$ cargo run --bin puffin --profile profiling -q -- pip-compile --python-version 3.10 target/tf-models-nightly.txt > /dev/null 2> /dev/null && echo "success" || echo "failure"
success
$ cargo run --bin puffin --profile profiling -q -- pip-compile --python-version 3.12  target/tf-models-nightly.txt > /dev/null 2> /dev/null && echo "success" || echo "failure"
success
```


---

_Label `bug` added by @konstin on 2024-01-11 12:11_

---

_Assigned to @charliermarsh by @charliermarsh on 2024-01-11 13:43_

---

_Comment by @charliermarsh on 2024-01-11 14:09_

Do you mind debugging this? I can't because `tensorflow-text-nightly` doesn't ship wheels that are compatible with my platform, and doesn't ship a source distribution, so it can't be resolved on my machine at all.

---

_Unassigned @charliermarsh by @charliermarsh on 2024-01-11 14:09_

---

_Assigned to @konstin by @konstin on 2024-01-11 14:10_

---

_Comment by @zanieb on 2024-01-11 14:42_

Weird. Once you figure out what's going on lmk and I can try to create a matching scenario.

---

_Comment by @konstin on 2024-01-11 16:38_

The problem is that:
* tensorflow-text-nightly has only wheels, and only wheel for cp310, not cp312
* We check wheels both
   * against the tags of the interpreter, which aren't the tags of the target and
   * expect that they match both installed and target versions 
* All wheels get listed as incompatible in the `VersionMap` -> `PrioritizedDistribution`
* `VersionMap::iter` -> `PrioritizedDistribution::get` returns only compatible wheels
* We see 0 compatible wheels and fail

Imho we need to consider wheels that only match the target python and only the (synthetic) target tags for this to succeed. We can test those scenarios as unit tests in `VersionMap`.

---

_Unassigned @konstin by @konstin on 2024-01-11 16:38_

---

_Comment by @charliermarsh on 2024-01-11 16:40_

To be clear, the intended behavior is that we _only_ check against the installed version for source distributions, since we would ultimately need to build them.


---

_Comment by @charliermarsh on 2024-01-11 16:40_

I can take a look.

---

_Assigned to @charliermarsh by @charliermarsh on 2024-01-11 16:40_

---

_Comment by @charliermarsh on 2024-01-11 21:23_

@konstin - Which one do you consider the bug - that it failed under `-p 3.12`, or that it succeeded under `-p 3.10` with `--python-version 3.12`?

---

_Comment by @charliermarsh on 2024-01-11 21:25_

It seems like it _should_ fail under `-p 3.10` with `--python-version 3.12`. That's what I see as the bug -- that it succeeds, but should fail.

---

_Comment by @zanieb on 2024-01-11 21:25_

@konstin I'm a bit confused by your description since you say "fail" as a conclusion but the bug is that it "succeeds"

---

_Comment by @konstin on 2024-01-11 22:16_

`pip3.12 install tf-models-nightly` fails, while `pip3.10 install tf-models-nightly` succeeds. I believe that `--python-version 3.12` should always fail and `--python-version 3.10` should always succeed, the `--python-version` should take precedence over the venv. The only case where the underlying venv should make a difference when using `--python-version` is when we need to build a venv. (I can see different solutions, mine is based on the idea that `--python-version` defines what we're doing and the underlying venv is incidental, a fallback to build source distributions).

| venv  | \-\-python\-version | current behaviour | expected behaviour |
|-------|---------------------|-------------------|--------------------|
| 3\.10 | n/a or 3\.10        | success           | success            |
| 3\.10 | 3\.12               | success           | failure            |
| 3\.12 | 3\.10               | failure           | success            |
| 3\.12 | n/a or 3\.12        | failure           | failure            |




---

_Comment by @charliermarsh on 2024-01-11 22:20_

Okay, I think I agree with your description. (The thing that was confusing is that your comment above ended with `We see 0 compatible wheels and fail`, but originally, the issue only included the 3.10 / 3.12 behavior where we currently succeed.)

---

_Referenced in [astral-sh/uv#890](../../astral-sh/uv/pulls/890.md) on 2024-01-12 02:19_

---

_Comment by @zanieb on 2024-01-12 14:30_

We should write a scenario for this? It seems within our capabilities. I still do not fully understand the situation. It'd be nice to have it described in that format.

---

_Comment by @charliermarsh on 2024-01-13 21:27_

Let's call Python 3.10 the "installed" environment and Python 3.12 the "target" environment. For each version, we have _both_ a Python version (to match against `Requires-Python`) and a set of tags (to match against wheels).

The rules for resolution are as follows...

- For each package, for each version, we try to find the "best candidate" for resolution and installation.
- We first look for a wheel that's compatible with the _target_ environment. (We won't have to build or run this code, so the _installed_ version is irrelevant.)
- If we can't find a compatible wheel, we accept any _incompatible_ wheel as long as there's a source distribution. The source distribution _must_ be compatible with the target environment. (We won't have to build or run this code, so the _installed_ version is irrelevant.)
- If there are no wheels, then the source distribution must be compatible with _both_ the installed and target environments, since we need to build it.

This is all true for the top-level resolution. When we perform a sub-resolution (when resolving the build dependencies of a source distribution), we should _only_ use the installed environment, and ignore the target environment, since we assume that the dependencies will be the same in both environments once built -- so our goal is "just" to build the distribution, without concern for which build dependencies it uses.


---

_Comment by @charliermarsh on 2024-01-13 21:27_

(This is kind of just documentation, I'll likely repeat it in a PR or in-code, I just had to write it out for myself before fixing this.)

---

_Comment by @zanieb on 2024-01-13 22:53_

I think we are capable of writing a scenario for this and I think we definitely should.

See https://github.com/zanieb/packse/blob/main/scenarios/requires-python.json and https://github.com/zanieb/packse/blob/main/scenarios/wheels.json for the relevant examples.

---

_Referenced in [astral-sh/uv#909](../../astral-sh/uv/pulls/909.md) on 2024-01-13 23:14_

---

_Comment by @charliermarsh on 2024-01-13 23:16_

How do we pass `--python-version` to packse scenarios?

---

_Comment by @charliermarsh on 2024-01-13 23:20_

(Agree we should have a test for this.)

---

_Comment by @zanieb on 2024-01-14 03:12_

So... we have a way to set the Python version for the environment but _not_ a separate resolution Python version. I'll add support for that.

---

_Closed by @charliermarsh on 2024-01-14 15:39_

---

_Referenced in [astral-sh/uv#1011](../../astral-sh/uv/pulls/1011.md) on 2024-01-19 22:31_

---
