<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv add foo` followed by a `uv remove foo` can sometimes produce a different lock file than what one started with - astral-sh/uv #6158</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`uv add foo` followed by a `uv remove foo` can sometimes produce a different lock file than what one started with</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/6158">#6158</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2024-08-16 17:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-08-16 17:35</div>
            <div class="timeline-body"><p>This is, assuming, of course, that the world remains fixed (which one can simulate with <code>--exclude-newer</code>). Here's a basic test case that is derived from #6063:</p>
<pre><code>$ rm -f *.lock

$ uv lock
warning: `uv lock` is experimental and may change without warning
Using Python 3.11.9
Resolved 8 packages in 51ms

$ cp uv.lock uv.first.lock

$ uv add --no-sync sniffio
warning: `uv add` is experimental and may change without warning
Using Python 3.11.9
Creating virtualenv at: .venv
Resolved 9 packages in 28ms

$ cp uv.lock uv.second.lock

$ uv remove --no-sync sniffio
warning: `uv remove` is experimental and may change without warning
Resolved 8 packages in 9ms

$ cp uv.lock uv.third.lock
</code></pre>
<p>Now, we expect <code>uv.first.lock</code> and <code>uv.second.lock</code> to be different, because we're adding a dependency:</p>
<pre><code>$ diff uv.first.lock uv.second.lock
15c15
&lt;     { name = &quot;zipp&quot; },
---
&gt;     { name = &quot;zipp&quot;, marker = &quot;python_full_version &lt; '3.10'&quot; },
164a165,173
&gt; name = &quot;sniffio&quot;
&gt; version = &quot;1.3.1&quot;
&gt; source = { registry = &quot;https://pypi.org/simple&quot; }
&gt; sdist = { url = &quot;https://files.pythonhosted.org/packages/a2/87/a6771e1546d97e7e041b6ae58d80074f81b7d5121207425c964ddf5cfdbd/sniffio-1.3.1.tar.gz&quot;, hash = &quot;sha256:f4324edc670a0f49750a81b895f35c3adb843cca46f0530f79fc1babb23789dc&quot;, size = 20372 }
&gt; wheels = [
&gt;     { url = &quot;https://files.pythonhosted.org/packages/e9/44/75a9c9421471a6c4805dbf2356f7c181a29c1879239abab1ea2cc8f38b40/sniffio-1.3.1-py3-none-any.whl&quot;, hash = &quot;sha256:2f6da418d1f1e0fddd844478f41680e794e6051915791a034ff65e5f100525a2&quot;, size = 10235 },
&gt; ]
&gt;
&gt; [[package]]
169a179
&gt;     { name = &quot;sniffio&quot; },
173c183,186
&lt; requires-dist = [{ name = &quot;jax&quot;, specifier = &quot;==0.4.17&quot; }]
---
&gt; requires-dist = [
&gt;     { name = &quot;jax&quot;, specifier = &quot;==0.4.17&quot; },
&gt;     { name = &quot;sniffio&quot; },
&gt; ]
</code></pre>
<p>But note that there is a change in the above lock file that is unrelated to the addition of <code>sniffio</code>. And we can see this by diffing <code>uv.first.lock</code> with <code>uv.third.lock</code>, which <em>should</em> be identical in this case:</p>
<pre><code>$ diff uv.first.lock uv.third.lock
15c15
&lt;     { name = &quot;zipp&quot; },
---
&gt;     { name = &quot;zipp&quot;, marker = &quot;python_full_version &lt; '3.10'&quot; },
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @BurntSushi on 2024-08-16 17:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">resolver</span> added by @BurntSushi on 2024-08-16 17:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-16 17:38</div>
            <div class="timeline-body"><p>I think this is basically the same problem as the Jax thing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-08-16 17:42</div>
            <div class="timeline-body"><p>Yeah it is. And this particular case is fixed by more aggressive forking. (But I believe I can come up with other cases of instability that aren't fixed by aggressive forking.)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 04:47:34 UTC
    </footer>
</body>
</html>
