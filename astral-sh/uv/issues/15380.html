<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Over-aggressive locking for editables cache - astral-sh/uv #15380</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Over-aggressive locking for editables cache</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/15380">#15380</a>
        opened by <a href="https://github.com/SquidDev">@SquidDev</a>
        on 2025-08-19 13:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/SquidDev">@SquidDev</a> on 2025-08-19 13:15</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>In an attempt to improve CI speeds, I've recently switched my workplaces self-hosted CI runners to use a persistent uv cache. This cache is <em>shared</em> across runners, to avoid wasting disk space — as <a href="https://docs.astral.sh/uv/concepts/cache/#cache-safety">noted in the documentation</a>, this should (and does!) work fine.</p>
<p>However, I've noticed some inefficiencies when building editable installs with native code (e.g. with maturin). <code>uv</code> acquires a lock on <code>$UV_CACHE_DIR/sdists-v9/editable/$CACHE_KEY</code> before starting a build. This means if two CI runners attempt to build the same package, one runner must wait for the other to finish building, before it builds itself.</p>
<p>This probably makes sense for pure-Python projects (where the build is cheap and reusable). However, because these packages use native code, we can't restore from the cache (see https://github.com/astral-sh/uv/issues/11390), so this feels doubly wasteful!</p>
<p>I wonder if it would be possible to reduce the scope of the lock, so that it's only acquired when the build finishes (and we write back the result to the cache), rather than the complete duration of the build?</p>
<h2>Reproduction steps</h2>
<p>Create a project with the following layout (<a href="https://github.com/user-attachments/files/21856281/uv_build.zip">premade one here</a>)</p>
<pre><code>├── build.py
├── pyproject.toml
├── src
│   └── uv_demo
│       └── __init__.py
</code></pre>
<p>Where <code>pyproject.toml</code> contains</p>
<pre><code class="language-toml">[project]
name = &quot;uv-demo&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.8&quot;
dependencies = []

[build-system]
requires = [&quot;hatchling&quot;]
build-backend = &quot;hatchling.build&quot;

[tool.hatch.build.targets.wheel.hooks.custom]
path = &quot;build.py&quot;
</code></pre>
<p>and <code>build.py</code> just ensures the build takes some time:</p>
<pre><code class="language-python">import time
from hatchling.builders.hooks.plugin.interface import BuildHookInterface

class CustomBuildHook(BuildHookInterface):
    def initialize(self, version: str, build_data: dict) -&gt; None:
        time.sleep(10)
</code></pre>
<p>Then, we can kick off two builds at the same time with <code>docker run --rm -it --mount type=bind,src=$PWD,dst=/src -w /src --env RUST_LOG=uv_build_frontend=debug,uv_fs=debug,maturin=debug --env UV_CACHE_DIR=/src/cache --tmpfs /src/.venv ghcr.io/astral-sh/uv:debian uv sync --reinstall</code>. Watching the logs, we can see we spend ~10 seconds waiting for the editable lock for the second build:</p>
<pre><code>DEBUG Acquired lock for `/src`
DEBUG Acquired lock for `/root/.local/share/uv/python`
Downloading cpython-3.8.20-linux-x86_64-gnu (download) (19.9MiB)
 Downloading cpython-3.8.20-linux-x86_64-gnu (download)
DEBUG Released lock at `/root/.local/share/uv/python/.lock`
Using CPython 3.8.20
Creating virtual environment at: .venv
DEBUG Released lock at `/tmp/uv-a307630218d6a300.lock`
DEBUG Acquired lock for `.venv`
Resolved 1 package in 0.96ms
INFO Waiting to acquire lock for `/src/cache/sdists-v9/editable/1de208056d3879b5` at `cache/sdists-v9/editable/1de208056d3879b5/.lock`
# ^^^^^^ Pauses here for 10s
DEBUG Acquired lock for `/src/cache/sdists-v9/editable/1de208056d3879b5`
DEBUG Released lock at `/src/cache/sdists-v9/editable/1de208056d3879b5/.lock`
Prepared 1 package in 8.46s
warning: Failed to hardlink files; falling back to full copy. This may lead to degraded performance.
         If the cache and target directories are on different filesystems, hardlinking may not be supported.
         If this is intentional, set `export UV_LINK_MODE=copy` or use `--link-mode=copy` to suppress this warning.
Installed 1 package in 0.92ms
 + uv-demo==0.1.0 (from file:///src)
DEBUG Released lock at `/src/.venv/.lock`
</code></pre>
<h3>Platform</h3>
<p>Linux 6.6.87.2-microsoft-standard-WSL2 x86_64 GNU/Linux, Ubuntu 24.04.3</p>
<h3>Version</h3>
<p>uv 0.8.12</p>
<h3>Python version</h3>
<p>Python 3.12.3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @SquidDev on 2025-08-19 13:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @zanieb on 2025-08-19 13:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-20 14:01</div>
            <div class="timeline-body"><p>I think part of the problem here is that it depends on the build backend. For example, IIRC <code>setuptools</code> is not safe to run concurrently.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/SquidDev">@SquidDev</a> on 2025-08-21 09:43</div>
            <div class="timeline-body"><p>Oh, to clarify, the reproduction steps in the original issue are not especially representative! In practice, we're just using normal GHA self-hosted runners. So each build gets its own checkout of the repository, it's just the checkout is mounted in its build container at the same path, and so shares a cache key. So I don't <em>think</em> the issues with setuptools (<a href="https://github.com/astral-sh/uv/blob/8d6ea3f2ea3255acdd91f7b618014aef95f7b393/crates/uv-build-frontend/src/lib.rs#L481-L485">assuming you're referring to this?</a>, which huh TIL — that's nasty!) matter here, as the source tree isn't shared.</p>
<p>That all said, I realise this setup is a bit niche, and honestly mostly exists to work around other limitations with caching (#11390 and #11455/#15224). I'd originally opened this in the hopes it might be a simple fix, but looking through <code>uv_distribution::source</code>, I'm less sure that's the case — happy if you want to close as wontfix!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:05 UTC
    </footer>
</body>
</html>
