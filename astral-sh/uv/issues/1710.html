<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`Failed to download distributions` with `unexpected BufError` errors - astral-sh/uv #1710</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>Failed to download distributions</code> with <code>unexpected BufError</code> errors</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/1710">#1710</a>
        opened by <a href="https://github.com/humanzz">@humanzz</a>
        on 2024-02-19 17:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/humanzz">@humanzz</a> on 2024-02-19 17:11</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

<p>Hello,</p>
<p>My team develops locally mostly using MacOS, but we use a CI/CD (Amazon Linux 2) system as part of our development process.</p>
<p>We have a python package, with <code>pyproject.toml</code> and we use https://github.com/pyinvoke/invoke to manage our build scripts.</p>
<p>The main task in question now in <code>tasks.py</code>, uses <code>uv pip install</code> and looks as follows</p>
<pre><code>UV_ENV = &quot;UV_CACHE_DIR=&lt;path&gt; UV_INDEX_URL=&lt;a non default index&gt; &quot;

@task
def develop(ctx):
    ctx.run(UV_ENV + &quot;uv pip install --verbose -e '.[dev,testing]'&quot;, echo=True)
</code></pre>
<p>We use <code>uv==0.1.5</code>.</p>
<p>We're trying to move to using <code>uv</code> for its speed gains.
On MacOS, everything works as expected.
On the CI/CD host, we sometimes - more often than not - run into an error that originates from the <code>uv pip install</code> call in the <code>develop</code> task.</p>
<p>The error consistently looks as follows. The error sometimes changes the dependency it's failing to fetch.</p>
<pre><code>error: Failed to download distributions
  Caused by: Failed to fetch wheel: numpy==1.26.4
  Caused by: Failed to extract source distribution
  Caused by: unexpected BufError
</code></pre>
<p>I'm attaching the <code>--verbose</code> output for a failed run and its successful retry. Note that I've slightly modified this to drop index urls, and package name, but the full list of dependencies should be there at the end of 2nd successful attempt.</p>
<p><a href="https://github.com/astral-sh/uv/files/14335151/uv_attempt1_fail.log">uv_attempt1_fail.log</a>
<a href="https://github.com/astral-sh/uv/files/14335152/uv_attempt2_success.log">uv_attempt2_success.log</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-02-19 17:19</div>
            <div class="timeline-body"><p>Interesting thanks for the thorough report!</p>
<p>Related:</p>
<ul>
<li>#1534</li>
</ul>
<p>This looks like an issue with our <code>uv-extract</code> crate. At the very least we should provide more information about what's gone wrong.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-02-19 17:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/humanzz">@humanzz</a> on 2024-02-19 18:23</div>
            <div class="timeline-body"><p>Yeah. It's very tough to know what's going wrong here with such short message.</p>
<p>Another point on <code>pip install</code> and its output: <code>verbose</code> is too chatty, but omitting <code>verbose</code> is also too silent. <code>pip</code> on the other hand does print out some useful things like what's being downloaded, what's already satisfied, what index was used, etc. which are useful bits of info, that are much shorter than the chatty verbose output. It'd be nice if <code>uv</code> does a similar thing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-02-19 18:25</div>
            <div class="timeline-body"><p>Yep agree see https://github.com/astral-sh/uv/issues/1569</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/humanzz">@humanzz</a> on 2024-02-19 18:32</div>
            <div class="timeline-body"><p>Awesome, I'll follow there for progress on that!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/humanzz">@humanzz</a> on 2024-02-26 23:31</div>
            <div class="timeline-body"><p>I've started seeing a similar error on Mac (Apple Silicon), this time when using <code>pip compile</code> and <code>uv==0.1.11</code> e.g.</p>
<pre><code>UV_CACHE_DIR=&lt;a cache dir&gt; UV_INDEX_URL=&lt;a custom index&gt; uv pip compile pyproject.toml --all-extras --upgrade -o requirements.lock

error: Failed to download: ipython==8.22.1
  Caused by: The wheel ipython-8.22.1-py3-none-any.whl is not a valid zip file
  Caused by: an upstream reader returned an error: unexpected BufError
  Caused by: unexpected BufError
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-02-27 04:54</div>
            <div class="timeline-body"><p>It looks like maybe this comes from <a href="https://docs.rs/flate2/latest/flate2/enum.Status.html#variant.BufError"><code>flate2</code></a> via <a href="https://github.com/Nullus157/async-compression/blob/bd46497b98117775d8921f9eb72ede84f179548f/src/codec/flate/decoder.rs#L54C21-L54C29"><code>async-compression</code></a> via <a href="https://github.com/Majored/rs-async-zip"><code>rs-async-zip</code></a> which I think we call at https://github.com/astral-sh/uv/blob/8d721830db8ad75b8b7ef38edc0e346696c52e3d/crates/uv-extract/src/stream.rs#L22</p>
<blockquote>
<p>For decompression this means that more input is needed to continue or the output buffer isn’t large enough to contain the result. The function can be called again after fixing both.</p>
</blockquote>
<p>It seems like either:</p>
<ul>
<li>Your custom index is returning truncated output</li>
<li>Our output buffer is overflowing somehow — I haven't looked into if this is even possible yet</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/humanzz">@humanzz</a> on 2024-02-28 19:38</div>
            <div class="timeline-body"><p>So, a bit more information - though likely a bit vague.
The setup I have, essentially runs a local proxy on my machine. I checked the logs of that proxy, to check entries when using <code>pip</code> and when using <code>uv pip</code>.</p>
<p>When using <code>pip</code>, logs look fine, no exceptions/errors.
When using <code>uv pip</code>, I did see some errors along the lines of</p>
<pre><code>ERROR org.glassfish.jersey.server.ServerRuntime$Responder - An I/O error has occurred while writing a response message entity to the container output stream. - org.glassfish.jersey.server.internal.process.MappableException: java.io.IOException: Buffer overflow
...
...
Caused by: java.io.IOException: Buffer overflow.
	at org.glassfish.jersey.netty.connector.internal.JerseyChunkedInput.write(JerseyChunkedInput.java:211) ~[jersey-netty-connector-2.31.jar:?]
	at org.glassfish.jersey.netty.connector.internal.JerseyChunkedInput.write(JerseyChunkedInput.java:191) ~[jersey-netty-connector-2.31.jar:?]
	at org.glassfish.jersey.netty.connector.internal.JerseyChunkedInput.write(JerseyChunkedInput.java:182) ~[jersey-netty-connector-2.31.jar:?]
	at org.glassfish.jersey.message.internal.CommittingOutputStream.write(CommittingOutputStream.java:185) ~[jersey-common-2.35.jar:?]
</code></pre>
<p>I feel like I've read somewhere, on some of the issues, that <code>uv</code>, as an optimization, can stream files to read specific parts it might need. I wonder if maybe there's some weird interaction here, <code>uv</code> is reading the part and closing the connection, and that proxy is not properly handling that.</p>
<p>I'm not sure, really, but trying to hypothesize what might be wrong, given I don't have access to that proxy code, and I'm Rust-ignorant :(</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-28 19:57</div>
            <div class="timeline-body"><p>It's reasonable that we should just fall back to non-range requests when we see a <code>BufError</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-01 15:52</div>
            <div class="timeline-body"><p>I would recommend reporting that buffer overflow as a bug to the proxy you're using (if you can), it seems like the proxy is failing to buffer the streamed data correctly sometimes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">network</span> added by @konstin on 2024-07-02 09:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chrisirhc">@chrisirhc</a> on 2024-08-12 08:44</div>
            <div class="timeline-body"><p>In case it'd help someone else, I got this <code>BufError</code> error when the wheel file itself was corrupted.
In our case, the cache was serving a corrupted file (2.5MB), whereas the same file on public pypi is 9.6 MB, and uv was correctly failing when trying to use it.</p>
<p>It was just a bit difficult to understand what was the nature of the failure based on the error <code>BufError</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">error messages</span> added by @zanieb on 2024-08-12 12:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:30:28 UTC
    </footer>
</body>
</html>
