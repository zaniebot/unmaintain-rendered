<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Struggling to install `axolotl[flash-attn,deepspeed]` via `pyproject.toml` with - astral-sh/uv #13321</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Struggling to install `axolotl[flash-attn,deepspeed]` via `pyproject.toml` with</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/13321">#13321</a>
        opened by <a href="https://github.com/sidmadala">@sidmadala</a>
        on 2025-05-06 22:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/sidmadala">@sidmadala</a> on 2025-05-06 22:13</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I am trying to install my research environment which requires the <code>axolotl</code> finetuning library alongside <code>flash-attn</code> and <code>deepspeed</code> extras. This requires using <code>no-build-isolation</code> which has been giving me significant trouble. I have pasted my <code>pyproject.toml</code> below along with the commands I am using the set up the environment. A similar issue is #1582 but does not solve my problem. I have also looked at some <a href="https://docs.astral.sh/uv/concepts/projects/config/#build-isolation">docs</a> which were not helpful on this issue. Any assistance would be much appreciated.</p>
<p>pyproject.toml</p>
<pre><code class="language-toml">[project]
name = &quot;test-uv&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.13&quot;
dependencies = [
    &quot;torch==2.6.0&quot;,
    &quot;torchvision&quot;,
    &quot;huggingface_hub[cli,torch]&gt;=0.30.0&quot;,
    &quot;transformers&gt;=4.51&quot;,
    &quot;evaluate&gt;=0.4.0&quot;,
    &quot;datasets&gt;=3.5.0&quot;,
    &quot;accelerate&gt;=1.6.0&quot;,
    &quot;peft&gt;=0.15.0&quot;,
    &quot;bitsandbytes&gt;=0.45.0&quot;,
    &quot;trl&gt;=0.17.0&quot;,
    &quot;unsloth&quot;,
    &quot;sentencepiece&quot;,
    &quot;openai&quot;,
    &quot;scikit-learn&quot;,
    &quot;scipy&quot;,
    &quot;jupyterlab&quot;, 
    &quot;matplotlib&quot;,
    &quot;seaborn&quot;,
    &quot;gradio&quot;,
    &quot;wandb&quot;,
    &quot;nltk==3.9.1&quot;,
    &quot;pandas&quot;,
    &quot;tenacity&quot;,
    &quot;requests&quot;,
    &quot;aiohttp&quot;,
    &quot;ratelimit&quot;,
    &quot;importlib_resources&quot;,
    &quot;mypy&quot;,
    &quot;python-dotenv&quot;,
    &quot;nvitop&quot;,
    &quot;gpustat&quot;,

    &quot;vllm==0.8.5&quot;, 
    # &quot;axolotl[flash-attn,deepspeed]==0.9.0&quot;,  # This causes errors when uncommented
]

[project.optional-dependencies]
build = [&quot;packaging&quot;, &quot;setuptools&quot;, &quot;wheel&quot;, &quot;ninja&quot;]  # might need torch
compile = [&quot;axolotl&quot;]

[tool.uv]
no-build-isolation-package = [&quot;axolotl&quot;]    

[[tool.uv.dependency-metadata]]
name = &quot;axolotl&quot;
provides-extras = [&quot;flash-attn&quot;, &quot;deepspeed&quot;]
version = &quot;0.9.0&quot;
</code></pre>
<p>Commands:</p>
<pre><code class="language-shell">sidmadala@icgpu01:~/hocklab/test-uv$ uv sync
Using CPython 3.13.3
Creating virtual environment at: .venv
Resolved 280 packages in 2.41s
  × Failed to build `outlines-core==0.1.26`
  ├─▶ The build backend returned an error
  ╰─▶ Call to `setuptools.build_meta.build_wheel` failed (exit status: 1)

      [stdout]
      running bdist_wheel
      running build
      running build_py
      copying python/outlines_core/__init__.py -&gt; build/lib.linux-x86_64-cpython-313/outlines_core
      copying python/outlines_core/_version.py -&gt; build/lib.linux-x86_64-cpython-313/outlines_core
      running egg_info
      writing python/outlines_core.egg-info/PKG-INFO
      writing dependency_links to python/outlines_core.egg-info/dependency_links.txt
      writing requirements to python/outlines_core.egg-info/requires.txt
      writing top-level names to python/outlines_core.egg-info/top_level.txt
      reading manifest file 'python/outlines_core.egg-info/SOURCES.txt'
      adding license file 'LICENSE'
      writing manifest file 'python/outlines_core.egg-info/SOURCES.txt'
      copying python/outlines_core/py.typed -&gt; build/lib.linux-x86_64-cpython-313/outlines_core
      copying python/outlines_core/fsm/__init__.py -&gt; build/lib.linux-x86_64-cpython-313/outlines_core/fsm
      copying python/outlines_core/fsm/guide.py -&gt; build/lib.linux-x86_64-cpython-313/outlines_core/fsm
      copying python/outlines_core/fsm/json_schema.py -&gt; build/lib.linux-x86_64-cpython-313/outlines_core/fsm
      copying python/outlines_core/fsm/outlines_core_rs.pyi -&gt; build/lib.linux-x86_64-cpython-313/outlines_core/fsm
      copying python/outlines_core/fsm/regex.py -&gt; build/lib.linux-x86_64-cpython-313/outlines_core/fsm
      running build_ext
      running build_rust

      [stderr]
      /home/sidmadala/.cache/uv/builds-v0/.tmp0f9q72/lib/python3.13/site-packages/setuptools/config/_apply_pyprojecttoml.py:82:
      SetuptoolsDeprecationWarning: `project.license` as a TOML table is deprecated
      !!

              ********************************************************************************
              Please use a simple string containing a SPDX expression for `project.license`. You can also use `project.license-files`. (Both options
      available on setuptools&gt;=77.0.0).

              By 2026-Feb-18, you need to update your project and remove deprecated calls
              or your builds will no longer be supported.

              See https://packaging.python.org/en/latest/guides/writing-pyproject-toml/#license for details.
              ********************************************************************************

      !!
        corresp(dist, value, root_dir)
      ERROR setuptools_scm._file_finders.git listing git files failed - pretending there aren't any
      /home/sidmadala/.cache/uv/builds-v0/.tmp0f9q72/lib/python3.13/site-packages/setuptools/command/build_py.py:212: _Warning: Package
      'outlines_core.fsm' is absent from the `packages` configuration.
      !!

              ********************************************************************************
              ############################
              # Package would be ignored #
              ############################
              Python recognizes 'outlines_core.fsm' as an importable package[^1],
              but it is absent from setuptools' `packages` configuration.

              This leads to an ambiguous overall configuration. If you want to distribute this
              package, please make sure that 'outlines_core.fsm' is explicitly added
              to the `packages` configuration field.

              Alternatively, you can also rely on setuptools' discovery methods
              (for example by using `find_namespace_packages(...)`/`find_namespace:`
              instead of `find_packages(...)`/`find:`).

              You can read more about &quot;package discovery&quot; on setuptools documentation page:

              - https://setuptools.pypa.io/en/latest/userguide/package_discovery.html

              If you don't want 'outlines_core.fsm' to be distributed and are
              already explicitly excluding 'outlines_core.fsm' via
              `find_namespace_packages(...)/find_namespace` or `find_packages(...)/find`,
              you can try to use `exclude_package_data`, or `include-package-data=False` in
              combination with a more fine grained `package-data` configuration.

              You can read more about &quot;package data files&quot; on setuptools documentation page:

              - https://setuptools.pypa.io/en/latest/userguide/datafiles.html


              [^1]: For Python, any directory (with suitable naming) can be imported,
                    even if it does not contain any `.py` files.
                    On the other hand, currently there is no concept of package data
                    directory, all directories are treated like packages.
              ********************************************************************************

      !!
        check.warn(importable)
      error: can't find Rust compiler

      If you are using an outdated pip version, it is possible a prebuilt wheel is available for this package but pip is not able to install from it.
      Installing from the wheel would avoid the need for a Rust compiler.

      To update pip, run:

          pip install --upgrade pip

      and then retry package installation.

      If you did intend to build this package from source, try installing a Rust compiler from your system package manager and ensure it is on
      the PATH during installation. Alternatively, rustup (available at https://rustup.rs) is the recommended way to download and update the Rust
      compiler toolchain.

      hint: This usually indicates a problem with the package or the build environment.
  help: `outlines-core` (v0.1.26) was included because `test-uv` (v0.1.0) depends on `vllm` (v0.8.5) which depends on `outlines` (v0.1.11) which
        depends on `outlines-core`
</code></pre>
<h3>Platform</h3>
<p>Linux 5.15.0-113-generic x86_64 GNU/Linux</p>
<h3>Version</h3>
<p>uv 0.7.2</p>
<h3>Python version</h3>
<p>Python 3.13</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @sidmadala on 2025-05-06 22:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-05-06 22:32</div>
            <div class="timeline-body"><p>You resolution has an old version of outlines-core that doesn't have binaries for 3.13. It needs to build the package from source, and then encounters this error:</p>
<blockquote>
<p>error: can't find Rust compiler</p>
</blockquote>
<p>If you install Rust, you should be able to build and install the package. Alternatively, use a lower Python version or check if you can use a newer outlines-core version, too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sidmadala">@sidmadala</a> on 2025-05-06 22:59</div>
            <div class="timeline-body"><p>Sorry, I downgraded to <code>python==3.12.*</code> This is the issue I'm getting now.</p>
<pre><code class="language-shell">sidmadala@icgpu01:~/hocklab/test-uv$ uv sync
Resolved 279 packages in 10ms
  × Failed to build `axolotl==0.9.0`
  ├─▶ The build backend returned an error
  ╰─▶ Call to `setuptools.build_meta.build_wheel` failed (exit status: 1)

      [stderr]
      Traceback (most recent call last):
        File &quot;&lt;string&gt;&quot;, line 8, in &lt;module&gt;
      ModuleNotFoundError: No module named 'setuptools'

      hint: This usually indicates a problem with the package or the build environment.
  help: `axolotl` (v0.9.0) was included because `test-uv` (v0.1.0) depends on `axolotl`
</code></pre>
<p>pyproject.toml</p>
<pre><code class="language-toml">[project]
name = &quot;test-uv&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;==3.12.*&quot;
dependencies = [
    &quot;torch==2.6.0&quot;,
    &quot;torchvision&quot;,
    &quot;huggingface_hub[cli,torch]&gt;=0.30.0&quot;,
    &quot;transformers&gt;=4.51&quot;,
    &quot;evaluate&gt;=0.4.0&quot;,
    &quot;datasets&gt;=3.5.0&quot;,
    &quot;accelerate&gt;=1.6.0&quot;,
    &quot;peft&gt;=0.15.0&quot;,
    &quot;bitsandbytes&gt;=0.45.0&quot;,
    &quot;trl&gt;=0.17.0&quot;,
    &quot;unsloth&quot;,
    &quot;sentencepiece&quot;,
    &quot;openai&quot;,
    &quot;scikit-learn&quot;,
    &quot;scipy&quot;,
    &quot;jupyterlab&quot;, 
    &quot;matplotlib&quot;,
    &quot;seaborn&quot;,
    &quot;gradio&quot;,
    &quot;wandb&quot;,
    &quot;nltk==3.9.1&quot;,
    &quot;pandas&quot;,
    &quot;tenacity&quot;,
    &quot;requests&quot;,
    &quot;aiohttp&quot;,
    &quot;ratelimit&quot;,
    &quot;importlib_resources&quot;,
    &quot;mypy&quot;,
    &quot;python-dotenv&quot;,
    &quot;nvitop&quot;,
    &quot;gpustat&quot;,

    &quot;vllm==0.8.5&quot;, 
    &quot;axolotl[flash-attn,deepspeed]==0.9.0&quot;,  # This causes errors when uncommented but doesn't install when commented
]

# [project.optional-dependencies]
# build = [&quot;packaging&quot;, &quot;setuptools&quot;, &quot;wheel&quot;, &quot;ninja&quot;]  # might need torch
# compile = [&quot;axolotl&quot;]

[tool.uv]
no-build-isolation-package = [&quot;axolotl&quot;]    

[[tool.uv.dependency-metadata]]
name = &quot;axolotl&quot;
provides-extras = [&quot;flash-attn&quot;, &quot;deepspeed&quot;]
version = &quot;0.9.0&quot;
requires-dist = [&quot;setuptools&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-07 12:57</div>
            <div class="timeline-body"><p>Happy to help, why does it require build isolation though? If you omit build isolation, what problem do you run into?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sidmadala">@sidmadala</a> on 2025-05-07 15:26</div>
            <div class="timeline-body"><p>I don't think <code>axolotl</code> itself requires build isolation, rather it's <code>flash-attn</code> which is causing the issue. I was referring to the <code>axolotl</code> <a href="https://docs.axolotl.ai/docs/installation.html">docs</a> though and they said to install the library with no build isolation enabled. I had a similar issue when using <code>pixi</code> as shown <a href="https://github.com/prefix-dev/pixi/issues/3730">here</a>, but found a workaround <a href="https://github.com/prefix-dev/pixi/issues/3735">here</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @konstin on 2025-06-06 11:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @konstin on 2025-06-06 11:42</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:03 UTC
    </footer>
</body>
</html>
