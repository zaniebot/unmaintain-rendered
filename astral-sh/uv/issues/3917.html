<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Different understanding of environment markers vs pip - astral-sh/uv #3917</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Different understanding of environment markers vs pip</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/3917">#3917</a>
        opened by <a href="https://github.com/wimglenn">@wimglenn</a>
        on 2024-05-29 22:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/wimglenn">@wimglenn</a> on 2024-05-29 22:05</div>
            <div class="timeline-body"><p>Minimal reproducer:</p>
<pre><code>$ cat pyproject.toml
[project]
name = &quot;example&quot;
version = &quot;0.1&quot;
dependencies = [
    &quot;dep1; platform_release &gt;= '1.0'&quot;,
    &quot;dep2; platform_release &lt; '1.0'&quot;,
]
</code></pre>
<p>uv pip wants to install dep1</p>
<pre><code>$ uv pip install .
  × No solution found when resolving dependencies:
  ╰─▶ Because dep1 was not found in the package registry and example==0.1 depends on dep1, we can conclude that example==0.1 cannot be used.
      And because only example==0.1 is available and you require example, we can conclude that the requirements are unsatisfiable.
</code></pre>
<p>python pip doesn't want to install either</p>
<pre><code>$ .venv/bin/pip install -q .
$ .venv/bin/pip list
Package Version
------- -------
example 0.1
pip     24.0
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-29 22:08</div>
            <div class="timeline-body"><p>Any idea which is correct?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wimglenn">@wimglenn</a> on 2024-05-29 23:21</div>
            <div class="timeline-body"><p>Hmm, I'm not 100% sure if this is well-defined even by the standards. ~I don't see anything explicitly describing the situation.~ <em>see note at bottom</em></p>
<p>To reproduce it, <code>platform.release()</code> should be returning a string which can not be parsed as a valid version number. An example container which does that:</p>
<pre><code>$ docker run --rm -it python:3.12.3-bookworm python -c 'import platform; print(platform.release())'
5.10.104-linuxkit
</code></pre>
<p>It is quite normal for this to be a string which is not parsable as a version number, PEP508 even offers such examples (<code>3.14.1-x86_64-linode39</code>, <code>14.5.0</code>, <code>1.8.0_51</code>). It means the marker can't be evaluated:</p>
<pre><code>$ docker run --rm -it python:3.12.3-bookworm bash
root@60f3aae789ef:/# pip install --root-user-action=ignore -q packaging
root@60f3aae789ef:/# python3
Python 3.12.3 (main, May 14 2024, 05:40:55) [GCC 12.2.0] on linux
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; from packaging.requirements import Requirement
&gt;&gt;&gt; req = Requirement(&quot;dep1; platform_release &gt;= '1.0'&quot;)
&gt;&gt;&gt; req.marker
&lt;Marker('platform_release &gt;= &quot;1.0&quot;')&gt;
&gt;&gt;&gt; req.marker.evaluate()
Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
  File &quot;/usr/local/lib/python3.12/site-packages/packaging/markers.py&quot;, line 252, in evaluate
    return _evaluate_markers(self._markers, current_environment)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/usr/local/lib/python3.12/site-packages/packaging/markers.py&quot;, line 158, in _evaluate_markers
    groups[-1].append(_eval_op(lhs_value, op, rhs_value))
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/usr/local/lib/python3.12/site-packages/packaging/markers.py&quot;, line 116, in _eval_op
    return spec.contains(lhs, prereleases=True)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/usr/local/lib/python3.12/site-packages/packaging/specifiers.py&quot;, line 558, in contains
    normalized_item = _coerce_version(item)
                      ^^^^^^^^^^^^^^^^^^^^^
  File &quot;/usr/local/lib/python3.12/site-packages/packaging/specifiers.py&quot;, line 26, in _coerce_version
    version = Version(version)
              ^^^^^^^^^^^^^^^^
  File &quot;/usr/local/lib/python3.12/site-packages/packaging/version.py&quot;, line 200, in __init__
    raise InvalidVersion(f&quot;Invalid version: '{version}'&quot;)
packaging.version.InvalidVersion: Invalid version: '5.10.104-linuxkit'
</code></pre>
<p>It would seem that pip considers such a case as evaluating False by default, by I don't know whether that is standardized or just UB. I'm not sure what uv is doing (string comparison lexicographically maybe?)</p>
<p><em>edit:</em> I just found this part in <a href="https://peps.python.org/pep-0508/">PEP508</a>:</p>
<blockquote>
<p>Comparisons in marker expressions are typed by the comparison operator. The &lt;marker_op&gt; operators that are not in &lt;version_cmp&gt; perform the same as they do for strings in Python. The &lt;version_cmp&gt; operators use the <a href="https://peps.python.org/pep-0440/">PEP 440</a> version comparison rules when those are defined (that is when both sides have a valid version specifier). If there is no defined <a href="https://peps.python.org/pep-0440/">PEP 440</a> behaviour and the operator exists in Python, then the operator falls back to the Python behaviour.</p>
</blockquote>
<p>So if I'm reading that right, it looks like uv is correct and pip is incorrect.</p>
<p>Feel free to close this issue, perhaps mentioning it in that list of known differences vs Python pip - https://github.com/astral-sh/uv/blob/main/PIP_COMPATIBILITY.md.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-05-31 10:47</div>
            <div class="timeline-body"><p>Using <code>platform_release</code> with greater/lower operators is unfortunately broken:</p>
<p>The paragraph you quoted from PEP 508 translates into a two-step procedure: Try to parse left hand side and right hand side as PEP 440 versions. If this succeeds, apply the operator as defined by PEP 440. If either side fails to parse, compare lexicographically. That means the behaviour of <code>platform_release &lt; '1.0'</code> depends on whether <code>platform_release</code> of the host happens to be PEP 440 compatible or not, something that may even change between releases (e.g. with a pre- or post-release scheme that incompatible to PEP 440, while the regular version is compatible. The behaviour then silently switches between PEP 440 semantic comparisons and lexicographic comparisons, which can have the inverse result (e.g. <code>3.9</code> &gt; <code>3.10</code> is false by PEP 440 but true by lexicographic order). We used to have warnings for this, but i think we turned them off because they were too noisy.</p>
<p>The pip behaviour you're observing is odd, i'd have to dig into the code again to see if that may have changed recently.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-04 01:54</div>
            <div class="timeline-body"><p>Going to close for now based on the above -- thank you both!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-06-04 01:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">compatibility</span> added by @charliermarsh on 2024-06-04 01:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../pypa/packaging/issues/774.html">pypa/packaging#774</a> on 2024-07-08 16:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../pyproject-nix/pyproject.nix/pulls/150.html">pyproject-nix/pyproject.nix#150</a> on 2024-09-10 01:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/h4l">@h4l</a> on 2025-07-30 10:53</div>
            <div class="timeline-body"><p>@konstin @charliermarsh In case either of you are have an opinion or are interested, we're trying to get the Python implementation of PEP 508 environment marker evaluation to match the spec's behaviour. As noted here, the spec's behaviour currently uses lexicographic order to compare version strings that don't match spec's version grammar, which can produce incorrect/unintuitive results for system-provided version strings that aren't valid  python package versions.</p>
<p>There's some discussion on whether the spec should be updated to solve this problem, or whether the <code>packaging</code> package should just be patched to match the spec as-is.</p>
<p>(Currently the <code>packaging</code> package (and tools that use it, like pip) are (unintentionally) failing with an error when evaluating expressions with version strings that don't match the spec's version grammar, instead of doing lexicographic comparison as the spec requires.)</p>
<p>See this comment from Brett Cannon on the <code>packaging</code> issue for this: https://github.com/pypa/packaging/issues/774#issuecomment-3120526922
And there's a thread about it on: https://discuss.python.org/t/reconciling-packaging-module-the-dependency-specifier-specs-non-version-to-version-comparison-rules/100287</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-07-30 11:26</div>
            <div class="timeline-body"><p>I did some research into cases for published package metadata where the fallback to lexicographic would apply, and found only unintended behavior that worked more or less accidentally before Python 3.10 (since lexicographically, &quot;3.10&quot; is lower than &quot;3.9&quot; for the first time).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/h4l">@h4l</a> on 2025-07-30 11:32</div>
            <div class="timeline-body"><p>So if I understand correctly, for you the current lexicographic fallback is good enough in practice?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-07-30 11:43</div>
            <div class="timeline-body"><p>I think the lexicographic fallback only causes confusion, a marker should have a only a single mode in which it gets evaluated. <code>platform_release</code> and <code>platform_version</code> are confusing markers by design, as it's not clear if their contents will fit any specific format, so I advise users against using them, but I don't have a good suggestion how to deal with exiting usage.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/h4l">@h4l</a> on 2025-07-30 11:48</div>
            <div class="timeline-body"><p>I see, thank you.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:28 UTC
    </footer>
</body>
</html>
