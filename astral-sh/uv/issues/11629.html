<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workspace incorectly resolves dependencies when they are conditionally excluded - astral-sh/uv #11629</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Workspace incorectly resolves dependencies when they are conditionally excluded</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/11629">#11629</a>
        opened by <a href="https://github.com/potiuk">@potiuk</a>
        on 2025-02-19 18:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/potiuk">@potiuk</a> on 2025-02-19 18:21</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I believe there is a bug in the way how workspace &quot;sub-package&quot; dependencies are resolved in workspace. Namely - when a dependency is conditionally excluded (for example because of python version), it is still considered as a &quot;workspace dependency&quot; and it might lead to</p>
<pre><code>workspace's requirements are unsatisfiable.
</code></pre>
<p>I made a first - draft attepmt to add Python 3.13 support to Apache Airflow. While I know it will not work out-of-the-box and we have still some fixes to make, the first step I had to do is to conditionally exclude some of dependencies for some of the providers in order to be able to <code>uv sync</code> the workspace and get consistent set of dependencies. This worked (eventually) but only after I used a hack and rather than conditionally, I had to exclude some of the dependencies entirely - not only for Python 3.13.</p>
<p>The PR https://github.com/apache/airflow/pull/46891 (awfully red now) shows the changes and allows to easilly replicate the bug.</p>
<p>If you look at the PR you will find in <code>providers/apache/beam/pyproject.toml</code> those commented lines:</p>
<pre><code class="language-toml">dependencies = [
    &quot;apache-airflow&gt;=2.9.0&quot;,
    # Apache Beam &gt; 2.53.0 and pyarrow &gt; 14.0.1 fix https://nvd.nist.gov/vuln/detail/CVE-2023-47248.
    # Apache Beam is for now disabled on Python 3.13 because of pyarrow compatibility issues.
    # For now commented out due to `uv` workspace issue https://github.com/astral-sh/uv/issues/11629
    #    'apache-beam&gt;=2.53.0; python_version &lt; &quot;3.12&quot;',
    #    'apache-beam&gt;=2.57.0; python_version &gt;= &quot;3.12&quot; and python_version &lt; &quot;3.13&quot;',
    'pyarrow&gt;=14.0.1; python_version &lt; &quot;3.13&quot;',
    &quot;numpy&gt;=1.26.0; python_version &lt; \&quot;3.13'\&quot;&quot;,
]
</code></pre>
<p>With those &quot;apache-beam&quot; lines commented out I can run:  <code>uv sync --all-extras --python 3.13 --reinstall</code> (--reinstall to take into account dynamic hatch_build.py in apache-airflow) and it installs airflow nicely:</p>
<pre><code class="language-text">Prepared 722 packages in 2.02s
Uninstalled 722 packages in 1.35s
Installed 722 packages in 431ms
</code></pre>
<p>So far so good - but this  is really &quot;unconditional&quot; remval of apache beam, which i do not want to do because I only want to remove apache-beam and it's dependencies in python 3.13.</p>
<p>So - what happens when you uncomment the lines?</p>
<pre><code class="language-toml">dependencies = [
    &quot;apache-airflow&gt;=2.9.0&quot;,
    # Apache Beam &gt; 2.53.0 and pyarrow &gt; 14.0.1 fix https://nvd.nist.gov/vuln/detail/CVE-2023-47248.
    # Apache Beam is for now disabled on Python 3.13 because of pyarrow compatibility issues.
    # For now commented out due to `uv` workspace issue https://github.com/astral-sh/uv/issues/11629
    'apache-beam&gt;=2.53.0; python_version &lt; &quot;3.12&quot;',
    'apache-beam&gt;=2.57.0; python_version &gt;= &quot;3.12&quot; and python_version &lt; &quot;3.13&quot;',
    'pyarrow&gt;=14.0.1; python_version &lt; &quot;3.13&quot;',
    &quot;numpy&gt;=1.26.0; python_version &lt; \&quot;3.13'\&quot;&quot;,
]
</code></pre>
<p>Not that the conditional there installs:</p>
<ul>
<li>apache-beam &gt; =2.53 when Python &lt; 3.12</li>
<li>apache-beam -&gt; 2.5.7 when Python &lt; 3.13</li>
</ul>
<p>So - for Python 3.13, apache-beam should not be installed.</p>
<p>Yet, the <code>uv</code> workspace resolution somehow thinks that apache-beam should be installed. When I run now <code>uv sync --all-extras --python 3.13 --reinstall</code> , I get this error:</p>
<pre><code class="language-python">  × No solution found when resolving dependencies for split (python_full_version == '3.12.*'):
  ╰─▶ Because only the following versions of grpcio-tools are available:
          grpcio-tools&lt;=1.66.0
          grpcio-tools==1.66.1
          grpcio-tools==1.66.2
          grpcio-tools==1.67.0
          grpcio-tools==1.67.1
          grpcio-tools==1.68.0
          grpcio-tools==1.68.1
          grpcio-tools==1.69.0
          grpcio-tools==1.70.0
      and grpcio-tools&gt;=1.66.0 depends on protobuf&gt;=5.26.1,&lt;6.0.dev0, we can conclude that grpcio-tools&gt;=1.66.0 depends on protobuf&gt;=5.26.1,&lt;6.0.dev0. (1)

      Because only the following versions of apache-beam{python_full_version == '3.12.*'} are available:
          apache-beam{python_full_version == '3.12.*'}&lt;=2.57.0
          apache-beam{python_full_version == '3.12.*'}==2.58.0
          apache-beam{python_full_version == '3.12.*'}==2.58.1
          apache-beam{python_full_version == '3.12.*'}==2.59.0
          apache-beam{python_full_version == '3.12.*'}==2.60.0
          apache-beam{python_full_version == '3.12.*'}==2.61.0
          apache-beam{python_full_version == '3.12.*'}==2.62.0
          apache-beam{python_full_version == '3.12.*'}==2.63.0
      and apache-beam&gt;=2.57.0,&lt;=2.60.0 depends on one of:
          protobuf&gt;=3.20.3,&lt;4.0.dev0
          protobuf&gt;=4.22.dev0,&lt;4.22.0
          protobuf&gt;4.22.0,&lt;4.23.dev0
          protobuf&gt;=4.25.dev0,&lt;4.26.0
      we can conclude that apache-beam{python_full_version == '3.12.*'}&gt;=2.57.0,&lt;2.58.0 depends on one of:
          protobuf&gt;=3.20.3,&lt;4.0.dev0
          protobuf&gt;=4.22.dev0,&lt;4.22.0
          protobuf&gt;4.22.0,&lt;4.23.dev0
          protobuf&gt;=4.25.dev0,&lt;4.26.0

      And because apache-beam&gt;=2.58.0,&lt;=2.60.0 depends on one of:
          protobuf&gt;=3.20.3,&lt;4.0.dev0
          protobuf&gt;=4.22.dev0,&lt;4.22.0
          protobuf&gt;4.22.0,&lt;4.23.dev0
          protobuf&gt;=4.25.dev0,&lt;4.26.0
      and one of:
          protobuf&gt;=3.20.3,&lt;4.0.dev0
          protobuf&gt;=4.22.dev0,&lt;4.22.0
          protobuf&gt;4.22.0,&lt;4.23.dev0
          protobuf&gt;=4.25.dev0,&lt;4.26.0
      we can conclude that apache-beam{python_full_version == '3.12.*'}&gt;=2.57.0,&lt;2.59.0 depends on one of:
          protobuf&gt;=3.20.3,&lt;4.0.dev0
          protobuf&gt;=4.22.dev0,&lt;4.22.0
          protobuf&gt;4.22.0,&lt;4.23.dev0
          protobuf&gt;=4.25.dev0,&lt;4.26.0

      And because apache-beam&gt;=2.59.0,&lt;=2.60.0 depends on one of:
          protobuf&gt;=3.20.3,&lt;4.0.dev0
          protobuf&gt;=4.22.dev0,&lt;4.22.0
          protobuf&gt;4.22.0,&lt;4.23.dev0
          protobuf&gt;=4.25.dev0,&lt;4.26.0
      and one of:
          protobuf&gt;=3.20.3,&lt;4.0.dev0
          protobuf&gt;=4.22.dev0,&lt;4.22.0
          protobuf&gt;4.22.0,&lt;4.23.dev0
          protobuf&gt;=4.25.dev0,&lt;4.26.0
      we can conclude that apache-beam{python_full_version == '3.12.*'}&gt;=2.57.0,&lt;2.61.0 depends on one of:
          protobuf&gt;=3.20.3,&lt;4.0.dev0
          protobuf&gt;=4.22.dev0,&lt;4.22.0
          protobuf&gt;4.22.0,&lt;4.23.dev0
          protobuf&gt;=4.25.dev0,&lt;4.26.0

      And because we know from (1) that grpcio-tools&gt;=1.66.0 depends on protobuf&gt;=5.26.1,&lt;6.0.dev0, we can conclude that grpcio-tools&gt;=1.66.0 and apache-beam{python_full_version == '3.12.*'}&gt;=2.57.0,&lt;2.61.0 are incompatible.
      And because apache-beam&gt;=2.60.0 depends xxxxxon one of:
          grpcio&gt;=1.33.1,&lt;1.48.0
          grpcio&gt;1.48.0,&lt;1.59.dev0
          grpcio&gt;=1.62.dev0,&lt;1.62.0
          grpcio&gt;1.62.1,&lt;1.66.0
      we can conclude that all of:
          grpcio&lt;1.33.1
          grpcio==1.48.0
          grpcio&gt;=1.59.dev0,&lt;1.62.dev0
          grpcio&gt;=1.62.0,&lt;=1.62.1
          grpcio&gt;=1.66.0
      , grpcio-tools&gt;=1.66.0, apache-beam{python_full_version == '3.12.*'}&gt;=2.57.0,&lt;2.62.0 are incompatible.
      And because apache-beam==2.63.0 depends on one of:
          grpcio&gt;=1.33.1,&lt;1.48.0
          grpcio&gt;1.48.0,&lt;1.59.dev0
          grpcio&gt;=1.62.dev0,&lt;1.62.0
          grpcio&gt;1.62.1,&lt;1.66.0
      and one of:
          grpcio&gt;=1.33.1,&lt;1.48.0
          grpcio&gt;1.48.0,&lt;1.59.dev0
          grpcio&gt;=1.62.dev0,&lt;1.62.0
          grpcio&gt;1.62.1,&lt;1.66.0
      we can conclude that all of:
          grpcio&lt;1.33.1
          grpcio==1.48.0
          grpcio&gt;=1.59.dev0,&lt;1.62.dev0
          grpcio&gt;=1.62.0,&lt;=1.62.1
          grpcio&gt;=1.66.0
      , grpcio-tools&gt;=1.66.0, apache-beam{python_full_version == '3.12.*'}&gt;=2.57.0 are incompatible. (2)

      Because only the following versions of grpcio-tools are available:
          grpcio-tools&lt;=1.66.0
          grpcio-tools==1.66.1
          grpcio-tools==1.66.2
          grpcio-tools==1.67.0
          grpcio-tools==1.67.1
          grpcio-tools==1.68.0
          grpcio-tools==1.68.1
          grpcio-tools==1.69.0
          grpcio-tools==1.70.0
      and grpcio-tools==1.66.0 depends on grpcio&gt;=1.66.0, we can conclude that grpcio-tools&gt;=1.66.0,&lt;1.66.1 depends on grpcio&gt;=1.66.0.
      And because grpcio-tools==1.66.1 depends on grpcio&gt;=1.66.1 and grpcio&gt;=1.66.2, we can conclude that grpcio-tools&gt;=1.66.0,&lt;1.67.0 depends on grpcio&gt;=1.66.0.
      And because grpcio-tools==1.67.0 depends on grpcio&gt;=1.67.0 and grpcio&gt;=1.67.1, we can conclude that grpcio-tools&gt;=1.66.0,&lt;1.68.0 depends on grpcio&gt;=1.66.0.
      And because grpcio-tools==1.68.0 depends on grpcio&gt;=1.68.0 and grpcio&gt;=1.68.1, we can conclude that grpcio-tools&gt;=1.66.0,&lt;1.69.0 depends on grpcio&gt;=1.66.0.
      And because grpcio-tools==1.69.0 depends on grpcio&gt;=1.69.0 and grpcio&gt;=1.70.0, we can conclude that grpcio-tools&gt;=1.66.0 depends on grpcio&gt;=1.66.0.
      And because we know from (2) that all of:
          grpcio&lt;1.33.1
          grpcio==1.48.0
          grpcio&gt;=1.59.dev0,&lt;1.62.dev0
          grpcio&gt;=1.62.0,&lt;=1.62.1
          grpcio&gt;=1.66.0
      , grpcio-tools&gt;=1.66.0, apache-beam{python_full_version == '3.12.*'}&gt;=2.57.0 are incompatible, we can conclude that grpcio-tools&gt;=1.66.0 and apache-beam{python_full_version == '3.12.*'}&gt;=2.57.0 are incompatible.
      And because apache-airflow[all] depends on grpcio-tools&gt;=1.66.0 and apache-airflow-providers-apache-beam depends on apache-beam{python_full_version == '3.12.*'}&gt;=2.57.0, we can conclude that apache-airflow-providers-apache-beam and apache-airflow[all] are incompatible.
      And because your workspace requires apache-airflow[all] and apache-airflow-providers-apache-beam[common-compat], we can conclude that your workspace's requirements are unsatisfiable.

      hint: Pre-releases are available for `grpcio-tools` in the requested range (e.g., 1.70.0rc1), but pre-releases weren't enabled (try: `--prerelease=allow`)

      hint: Pre-releases are available for `apache-beam` in the requested range (e.g., 2.63.0rc2), but pre-releases weren't enabled (try: `--prerelease=allow`)
</code></pre>
<p>Apparently, even if <code>pyproject.toml</code> says &quot;effectively I do not need apache-beam&quot;  - workspace resolution still believes it is needed.</p>
<h3>Platform</h3>
<p>Mint 21.3</p>
<h3>Version</h3>
<p>uv 0.6.1</p>
<h3>Python version</h3>
<p>Python 3.13.2</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @potiuk on 2025-02-19 18:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-02-20 09:44</div>
            <div class="timeline-body"><p>The error doesn't occur for installing on Python 3.13 but earlier in the <code>uv lock</code> that runs before <code>uv sync</code> if the requirements changed. During locking, it happens when trying to resolve the dependencies for Python 3.12.</p>
<p>In this case, apache-beam has a <code>grpcio&lt;1.66.0</code> bound, while the <code>grpcio-tools&gt;=1.66.0</code> in another provider have a <code>grpcio&gt;=1.66.0</code> bound, causing the conflict on Python 3.12.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/potiuk">@potiuk</a> on 2025-02-20 14:56</div>
            <div class="timeline-body"><p>Aaargh...  Thank you and sorry for the hassle.  I missed the 3.12 all over the output !!!</p>
<p>Let me try to fix it.</p>
<p>BTW. While it makes perfect sens of course, It' s kinda unexpected in this case - when I tried to sync python 3.13 was chosen to sync (especially that like in this case, I modified the dependencies to make Python 3.13 and purely accidentally I broke the 3.12 ones.</p>
<p>Might be a good idea to add more expicit messaging about it because I think that might be common patterns for others.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @konstin on 2025-02-20 14:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">error messages</span> added by @konstin on 2025-02-20 14:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-02-20 15:00</div>
            <div class="timeline-body"><p>In addition to indicating clearer that this error occurs in a python version disjoint from the install target (and doing the same thing when the platform mismatches), the error message for the conflict could also be a lot more concise, i had to remove a bunch of duplication before i was able to understand what it was trying to tell me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/potiuk">@potiuk</a> on 2025-02-20 15:04</div>
            <div class="timeline-body"><blockquote>
<p>In addition to indicating clearer that this error occurs in a python version disjoint from the install target (and doing the same thing when the platform mismatches), the error message for the conflict could also be a lot more concise, i had to remove a bunch of duplication before i was able to understand what it was trying to tell me.</p>
</blockquote>
<p>Indeed :D. After about 3 years of doing it for airflow, I can quickly decipher those &quot;riddles&quot; (though I missed 3.12 in the output - that caught me by surprise) - but I am pretty much the only one in airlfow who would not jump out of the window seeing the output ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/potiuk">@potiuk</a> on 2025-02-20 15:44</div>
            <div class="timeline-body"><blockquote>
<p>I can quickly decipher those &quot;riddles&quot;</p>
</blockquote>
<p>Indeed. It's working as expected now. https://github.com/apache/airflow/pull/46891</p>
<p>BTW. Despite the riddles, it's absolutely uncomparable experience to work out the set of dependnecies needed with <code>uv sync</code> - in 90+ projects of Airlfow, comparing to what I did before with <code>pip</code>. The sheer speed of iteratio is amazing. I think it would have taken me days before to figure the right set of deps for Python 3.13 and which packages I had to diable.</p>
<p>Fantastic job, as usual!</p>
<p>Shall I close this one or will you turn it into some doc improvement issue ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-02-20 15:48</div>
            <div class="timeline-body"><p>I'll keep this open to track the this as error message improvement, apache airflow at 21a34cbb1a564c795091a726b1993867c6ff3e8b (https://github.com/konstin/airflow/pull/new/gh11629) is a good reproducible example for an error message we should improve.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:33:00 UTC
    </footer>
</body>
</html>
