<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>build backend: optional dependencies don't make it to PKG-INFO - astral-sh/uv #10091</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>build backend: optional dependencies don&#x27;t make it to PKG-INFO</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/10091">#10091</a>
        opened by <a href="https://github.com/cthoyt">@cthoyt</a>
        on 2024-12-22 10:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cthoyt">@cthoyt</a></div>
            <div class="timeline-body"><p>I&#x27;m on uv 0.5.11 (c4d0caaee 2024-12-19).</p>
<p>The issue here is that optional dependencies aren&#x27;t being written properly to PKG-INFO, therefore making it impossible to pip install the package with options. This was originally identified in <a href="https://github.com/biopragmatics/curies/issues/147">biopragmatics/curies#147</a>. Here&#x27;s a minimal reproduction:</p>
<pre><code>$ uv --preview init xyz --build-backend uv
Initialized project `xyz` at `/Users/cthoyt/xyz`

$ cd xyz

$ uv --preview add defusedxml --optional xml
Using CPython 3.11.10
Creating virtual environment at: .venv
Resolved 2 packages in 59ms
   Built xyz @ file:///Users/cthoyt/xyz
Prepared 1 package in 5ms
Installed 2 packages in 3ms
 + defusedxml==0.7.1
 + xyz==0.1.0 (from file:///Users/cthoyt/xyz)

$ echo &quot;import defusedxml&quot; &gt; src/xyz/__init__.py
$ echo &quot;def main(): print(&#x27;hello from modified xyz&#x27;)&quot; &gt;&gt; src/xyz/__init__.py

$ uv run xyz
hello from modified xyz
</code></pre>
<p>If you start from scratch, you need to do <code>uv run --extra xml xyz</code>, since the option isn&#x27;t installed yet.</p>
<p>Now comes the problematic part, after building:</p>
<pre><code>$ uv --preview build
Building source distribution (uv build backend)...
Building wheel from source distribution (uv build backend)...
Successfully built dist/xyz-0.1.0.tar.gz
Successfully built dist/xyz-0.1.0-py3-none-any.whl

$ tar -xOzf dist/xyz-0.1.0.tar.gz xyz-0.1.0/PKG-INFO 
Metadata-Version: 2.3
Name: xyz
Version: 0.1.0
Summary: Add your description here
Author: Charles Tapley Hoyt
Author-email: Charles Tapley Hoyt &lt;cthoyt@gmail.com&gt;
Requires-Python: &gt;=3.11
Provides-Extra: xml
Description-Content-Type: text/markdown
</code></pre>
<p><strong>Here&#x27;s the bug:</strong> This PKG-INFO file should also include the line <code>Requires-Dist: defusedxml&gt;=0.7.1; extra == &#x27;xml&#x27;</code>.</p>
<p>I believe this also implies that the test scenario at https://github.com/astral-sh/uv/blob/ad92aaf186f59e7f9b3145b62308c8f8a7230bd5/crates/uv-build-backend/src/metadata.rs#L1029-L1036 is incomplete, since it&#x27;s also missing the appropriate <code>Requires-Dist:</code> lines for mysql and postgres</p>
What this means for <code>pip</code> users
<p>This affects users by the following scenario using pip to install the package. The minimal reproduction below should follow the code before, in which it creates a virtual environment, activates it (I&#x27;m using fish, but so activation will vary based on your console), installing pip in the virtual environment, then using pip to install the package locally</p>
<p>This can be reproduced with a pip installation scenario by creating a new virtual environment, installing pip in it, then using pip to install. Note that the same thing happens whether you&#x27;re using <code>-e</code> for an editable installation or not.</p>
<pre><code>$ uv venv
Creating virtual environment at: .venv
Activate with: source .venv/bin/activate.fish

$ source .venv/bin/activate.fish

$ uv pip install pip
Resolved 1 package in 196ms
Prepared 1 package in 182ms
Installed 1 package in 6ms
 + pip==24.3.1

$ UV_PREVIEW=1 python -m pip install .[xml]
Processing /Users/cthoyt/Desktop/xyz
  Installing build dependencies ... done
  Getting requirements to build wheel ... done
  Preparing metadata (pyproject.toml) ... done
Building wheels for collected packages: xyz
  Building wheel for xyz (pyproject.toml) ... done
  Created wheel for xyz: filename=xyz-0.1.0-py3-none-any.whl size=1503 sha256=23ddd26cc3e4c20321aec8053bf8ce5e80d9340977d96555e34ce06b7450c6f5
  Stored in directory: /private/var/folders/6k/r2gmmc213vl6h7bv20x624xw0000gn/T/pip-ephem-wheel-cache-hcnf61u2/wheels/92/98/ae/8e6e182b3e32485aed6bab20d53b27efc72ed7f772a8da227b
Successfully built xyz
Installing collected packages: xyz
Successfully installed xyz-0.1.0

$ pip list
Package Version Editable project location
------- ------- -------------------------
pip     24.3.1
xyz     0.1.0   /Users/cthoyt/Desktop/xyz
</code></pre>
<p>This listing should include <code>defusedxml</code>, but doesn&#x27;t</p>
How it should look, using <code>hatch</code> backend
<p>Here&#x27;s an alternate reproduction that gets the right thing, using hatchling as the backend:</p>
<pre><code>$ uv init xyz --build-backend hatch
Initialized project `xyz` at `/Users/cthoyt/Desktop/xyz`

$ cd xyz

$ uv add defusedxml --optional xml
Using CPython 3.11.10
Creating virtual environment at: .venv
Resolved 2 packages in 1ms
   Built xyz @ file:///Users/cthoyt/Desktop/xyz
Prepared 1 package in 218ms
Installed 2 packages in 1ms
 + defusedxml==0.7.1
 + xyz==0.1.0 (from file:///Users/cthoyt/Desktop/xyz)

$ uv build
Building source distribution...
Building wheel from source distribution...
Successfully built dist/xyz-0.1.0.tar.gz
Successfully built dist/xyz-0.1.0-py3-none-any.whl

$ tar -xOzf dist/xyz-0.1.0.tar.gz xyz-0.1.0/PKG-INFO 
Metadata-Version: 2.4
Name: xyz
Version: 0.1.0
Summary: Add your description here
Author-email: Charles Tapley Hoyt &lt;cthoyt@gmail.com&gt;
Requires-Python: &gt;=3.11
Provides-Extra: xml
Requires-Dist: defusedxml&gt;=0.7.1; extra == &#x27;xml&#x27;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-22 23:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-22 23:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-22 23:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-22 23:39</div>
            <div class="timeline-body"><p>(I&#x27;ll fix this, I&#x27;ve already implemented it before.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-23 13:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-23 13:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:36:22 UTC
    </footer>
</body>
</html>
