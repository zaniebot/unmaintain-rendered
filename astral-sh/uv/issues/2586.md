```yaml
number: 2586
title: "`unexpected end of file` during wheel download"
type: issue
state: closed
author: newne
labels:
  - network
assignees: []
created_at: 2024-03-21T10:25:57Z
updated_at: 2024-11-23T03:38:36Z
url: https://github.com/astral-sh/uv/issues/2586
synced_at: 2026-01-10T01:57:06Z
```

# `unexpected end of file` during wheel download

---

_Issue opened by @newne on 2024-03-21 10:25_

ubuntu 22.04 
uv  0.1.23
when exec " uv pip install ultralytics", it failed with :
```
Resolved 53 packages in 11ms
error: Failed to download distributions
  Caused by: Failed to fetch wheel: nvidia-cufft-cu12==11.0.2.54
  Caused by: Failed to extract archive
  Caused by: request or response body error: error reading a body from connection: unexpected end of file
  Caused by: error reading a body from connection: unexpected end of file
  Caused by: unexpected end of file
```

---

_Comment by @charliermarsh on 2024-03-21 13:12_

Are you seeing this for every package? Just for this one? Are you seeing it for this one package consistently? Are you using any non-PyPI indexes?

---

_Label `needs-mre` added by @zanieb on 2024-03-21 14:24_

---

_Comment by @newne on 2024-03-22 02:04_

> Are you seeing this for every package? Just for this one? Are you seeing it for this one package consistently? Are you using any non-PyPI indexes?

No, I try "uv pip install ultralytics" for three times but it comes out the same error. I install pandas with uv successfully:
```
 uv pip install pandas
Resolved 6 packages in 1.38s
Downloaded 2 packages in 12.07s
Installed 6 packages in 14ms
 + numpy==1.26.4
 + pandas==2.2.1
 + python-dateutil==2.9.0.post0
 + pytz==2024.1
 + six==1.16.0
 + tzdata==2024.1
```
This is a new conda env, all I do was :
```
conda create -n yolo python=3.10
uv pip install ultralytics
uv pip install ultralytics
uv pip install ultralytics
uv pip install pandas
```



---

_Comment by @zanieb on 2024-03-22 03:22_

I cannot reproduce this on Linux or macOS, although the download takes quite some time on Linux.

```
❯ uv venv -p 3.10
Using Python 3.10.13 interpreter at: /home/mz/workspace/uv/bin/python3.10
Creating virtualenv at: .venv
Activate with: source .venv/bin/activate
❯ uv pip install ultralytics
Resolved 51 packages in 606ms
Downloaded 45 packages in 2m 31s
Installed 51 packages in 28.35s
 + certifi==2024.2.2
 + charset-normalizer==3.3.2
 + contourpy==1.2.0
 + cycler==0.12.1
 + filelock==3.13.1
 + fonttools==4.50.0
 + fsspec==2024.3.1
 + idna==3.6
 + jinja2==3.1.3
 + kiwisolver==1.4.5
 + markupsafe==2.1.5
 + matplotlib==3.8.3
 + mpmath==1.3.0
 + networkx==3.2.1
 + numpy==1.26.4
 + nvidia-cublas-cu12==12.1.3.1
 + nvidia-cuda-cupti-cu12==12.1.105
 + nvidia-cuda-nvrtc-cu12==12.1.105
 + nvidia-cuda-runtime-cu12==12.1.105
 + nvidia-cudnn-cu12==8.9.2.26
 + nvidia-cufft-cu12==11.0.2.54
 + nvidia-curand-cu12==10.3.2.106
 + nvidia-cusolver-cu12==11.4.5.107
 + nvidia-cusparse-cu12==12.1.0.106
 + nvidia-nccl-cu12==2.19.3
 + nvidia-nvjitlink-cu12==12.4.99
 + nvidia-nvtx-cu12==12.1.105
 + opencv-python==4.9.0.80
 + packaging==24.0
 + pandas==2.2.1
 + pillow==10.2.0
 + psutil==5.9.8
 + py-cpuinfo==9.0.0
 + pyparsing==3.1.2
 + python-dateutil==2.9.0.post0
 + pytz==2024.1
 + pyyaml==6.0.1
 + requests==2.31.0
 + scipy==1.12.0
 + seaborn==0.13.2
 + six==1.16.0
 + sympy==1.12
 + thop==0.1.1.post2209072238
 + torch==2.2.1
 + torchvision==0.17.1
 + tqdm==4.66.2
 + triton==2.2.0
 + typing-extensions==4.10.0
 + tzdata==2024.1
 + ultralytics==8.1.30
 + urllib3==2.2.1
```

What happens if you just install the problematic package? e.g.

```
❯ uv pip install --no-cache nvidia-cufft-cu12==11.0.2.54
Resolved 1 package in 132ms
Downloaded 1 package in 4.81s
Installed 1 package in 169ms
 + nvidia-cufft-cu12==11.0.2.54
```

---

_Renamed from "Error when install package" to "`unexpected end of file` during wheel download" by @zanieb on 2024-03-22 03:23_

---

_Comment by @newne on 2024-03-22 06:22_

> uv pip install ultralytics

```
(ncg) (base) ncg@ncg-pc:~$ uv pip install ultralytics
Resolved 51 packages in 11ms
error: Failed to download distributions
  Caused by: Failed to fetch wheel: nvidia-cuda-cupti-cu12==12.1.105
  Caused by: Failed to extract archive
  Caused by: request or response body error: error reading a body from connection: unexpected end of file
  Caused by: error reading a body from connection: unexpected end of file
  Caused by: unexpected end of file
(ncg) (base) ncg@ncg-pc:~$ uv pip install nvidia-cuda-cupti-cu12==12.1.105
Resolved 1 package in 0.43ms
Downloaded 1 package in 13.61s
Installed 1 package in 1ms
 + nvidia-cuda-cupti-cu12==12.1.105
```
but I still can't install the ‘ultralytics’ package:
```
(ncg) (base) ncg@ncg-pc:~$ uv pip install ultralytics
Resolved 51 packages in 10ms
error: Failed to download distributions
  Caused by: Failed to fetch wheel: nvidia-cusparse-cu12==12.1.0.106
  Caused by: Failed to extract archive
  Caused by: request or response body error: error reading a body from connection: unexpected end of file
  Caused by: error reading a body from connection: unexpected end of file
  Caused by: unexpected end of file
(ncg) (base) ncg@ncg-pc:~$ uv pip install nvidia-cusparse-cu12==12.1.0.106
Resolved 2 packages in 0.50ms
error: Failed to download distributions
  Caused by: Failed to fetch wheel: nvidia-cusparse-cu12==12.1.0.106
  Caused by: Failed to extract archive
  Caused by: request or response body error: error reading a body from connection: unexpected end of file
  Caused by: error reading a body from connection: unexpected end of file
  Caused by: unexpected end of file
(ncg) (base) ncg@ncg-pc:~$ uv pip install nvidia-cusparse-cu12
Resolved 2 packages in 1.96s
error: Failed to download distributions
  Caused by: Failed to fetch wheel: nvidia-cusparse-cu12==12.3.0.142
  Caused by: Failed to extract archive
  Caused by: request or response body error: error reading a body from connection: unexpected end of file
  Caused by: error reading a body from connection: unexpected end of file
  Caused by: unexpected end of file
```


---

_Referenced in [materialsproject/pymatgen#3826](../../materialsproject/pymatgen/pulls/3826.md) on 2024-05-13 12:08_

---

_Comment by @DanielYang59 on 2024-05-13 12:12_

We are getting this same error for `uv pip install torch` in CI https://github.com/materialsproject/pymatgen/pull/3826:
```
error: Failed to download distributions
  Caused by: Failed to fetch wheel: torch==2.2.1
  Caused by: Failed to extract archive
  Caused by: error decoding response body
  Caused by: request or response body error
  Caused by: error reading a body from connection
  Caused by: end of file before message length reached
```

The failure seems quite intermittent.


---

_Comment by @njzjz on 2024-05-21 23:20_

I got this error randomly when fetching large wheels:

https://github.com/njzjz/deepmd-kit/actions/runs/9182537910/job/25251596562#step:5:35

You can see in 12 jobs, it only happens once.

---

_Referenced in [astral-sh/uv#4402](../../astral-sh/uv/issues/4402.md) on 2024-06-18 20:22_

---

_Referenced in [deepmodeling/deepmd-kit#3889](../../deepmodeling/deepmd-kit/pulls/3889.md) on 2024-06-19 23:41_

---

_Label `needs-mre` removed by @konstin on 2024-07-09 11:44_

---

_Label `network` added by @konstin on 2024-07-09 11:44_

---

_Comment by @b-phi on 2024-10-04 23:21_

Also seeing this downloading large packages (~180MB) over slow network connections (~5MB/s)

---

_Comment by @timonmerk on 2024-10-18 13:36_

+1 for the issue with installing PyTorch

---

_Comment by @DanielYang59 on 2024-10-21 03:47_

This issue might extend beyond `uv`, because I have seen [another error](https://github.com/materialsvirtuallab/monty/actions/runs/11432620447/job/31803375676?pr=713) regarding `torch` install but [use native `pip` instead of `uv`](https://github.com/materialsvirtuallab/monty/blob/189b6e6c23b5354ec13df00eaa2424a74599088f/.github/workflows/test.yml#L19-L27):

```
INFO: pip is looking at multiple versions of monty[dev,json,multiprocessing,serialization] to determine which version is compatible with other requirements. This could take a while.
ERROR: Ignored the following versions that require a different python version: 1.21.2 Requires-Python >=3.7,<3.11; 1.21.3 Requires-Python >=3.7,<3.11; 1.21.4 Requires-Python >=3.7,<3.11; 1.21.5 Requires-Python >=3.7,<3.11; 1.21.6 Requires-Python >=3.7,<3.11; 1.26.0 Requires-Python <3.13,>=3.9; 1.26.1 Requires-Python <3.13,>=3.9
ERROR: Could not find a version that satisfies the requirement torch; extra == "json" (from monty[dev,json,multiprocessing,serialization]) (from versions: none)
ERROR: No matching distribution found for torch; extra == "json"
```


---

_Comment by @Sytronik on 2024-10-30 05:50_

I also faced this error when downloading a large package (1.2GB) from my slow non-PyPI index server.

In my case, UV_CONCURRENT_DOWNLOADS=1 solved the issue.
I think we can confidently say the slow downloading causes this error.
In my case, I guess my index server is not fast enough to handle many concurrent connections.

---

_Comment by @charliermarsh on 2024-11-23 03:38_

We have more retries for these, including for these kind of "body" errors.

---

_Closed by @charliermarsh on 2024-11-23 03:38_

---
