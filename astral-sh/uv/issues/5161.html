<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>the output of `uv lock` can change merely by changing the order of requirements in `pyproject.toml` - astral-sh/uv #5161</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>the output of <code>uv lock</code> can change merely by changing the order of requirements in <code>pyproject.toml</code></h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/5161">#5161</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2024-07-17 18:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>The easiest way to reproduce this is with a packse index running, as I discovered this bug with one of our existing scenarios.</p>
<p>Note that this bug exists on <code>main</code>, but the output below might be different. The output below was generated with  PR #5163.</p>
<p>For context, this is the packse scenario we&#x27;re testing below, named <a href="https://github.com/astral-sh/packse/blob/99f85df71f9c8bfd647aa8b0088ccf66633bd8bb/scenarios/fork/marker-selection.toml"><code>fork-marker-selection</code></a> (the description is perhaps misleading now):</p>
<pre><code>name = &quot;fork-marker-selection&quot;
description = &#x27;&#x27;&#x27;
This tests a case where the resolver forks because of non-overlapping marker
expressions on `b`. In the original universal resolver implementation, this
resulted in multiple versions of `a` being unconditionally included in the lock
file. So this acts as a regression test to ensure that only one version of `a`
is selected.
&#x27;&#x27;&#x27;

[resolver_options]
universal = true

[expected]
satisfiable = true

[root]
requires = [
  &quot;a&quot;,
  &quot;b&gt;=2 ; sys_platform == &#x27;linux&#x27;&quot;,
  &quot;b&lt;2 ; sys_platform == &#x27;darwin&#x27;&quot;,
]

[packages.a.versions.&quot;1.0.0&quot;]
[packages.a.versions.&quot;2.0.0&quot;]
requires = [&quot;b&gt;=2.0.0&quot;]

[packages.b.versions.&quot;1.0.0&quot;]
[packages.b.versions.&quot;2.0.0&quot;]
</code></pre>
<p>First, spin up a packse index:</p>
<pre><code>$ uv run --all-extras packse serve scenarios/ --no-hash
</code></pre>
<p>In another shell, create this <code>pyproject.toml</code>:</p>
<pre><code>[project]
name = &#x27;project&#x27;
version = &#x27;0.1.0&#x27;
dependencies = [
  &quot;fork-marker-selection-a&quot;,
  &quot;fork-marker-selection-b&gt;=2 ; sys_platform == &#x27;linux&#x27;&quot;,
  &quot;fork-marker-selection-b&lt;2 ; sys_platform == &#x27;darwin&#x27;&quot;,
]
requires-python = &#x27;&gt;=3.8&#x27;
</code></pre>
<p>And now lock it, being careful to specify the index URL so that we use packse:</p>
<pre><code>$ rm -f uv.lock

$ uv cache clean
Clearing cache at: /home/andrew/.cache/uv
Removed 14 files (9.8KiB)

$ UV_INDEX_URL=http://localhost:3141 uv lock -p3.8
warning: `uv lock` is experimental and may change without warning.
Using Python 3.8.19 interpreter at: /home/andrew/.local/share/uv/python/cpython-3.8.19-linux-x86_64-gnu/bin/python3
Resolved 4 packages in 193ms
</code></pre>
<p>The relevant part of the lock file are the top-level dependencies for <code>project</code>:</p>
<pre><code>[[distribution]]
name = &quot;fork-marker-selection-a&quot;
version = &quot;0.1.0&quot;

[[distribution]]
name = &quot;project&quot;
version = &quot;0.1.0&quot;
source = { editable = &quot;.&quot; }
dependencies = [
    { name = &quot;fork-marker-selection-a&quot;, marker = &quot;sys_platform == &#x27;darwin&#x27; or sys_platform == &#x27;linux&#x27;&quot; },
    { name = &quot;fork-marker-selection-b&quot;, version = &quot;1.0.0&quot;, source = { registry = &quot;http://localhost:3141/&quot; }, marker = &quot;sys_platform == &#x27;darwin&#x27;&quot; },
    { name = &quot;fork-marker-selection-b&quot;, version = &quot;2.0.0&quot;, source = { registry = &quot;http://localhost:3141/&quot; }, marker = &quot;sys_platform == &#x27;linux&#x27;&quot; },
]
</code></pre>
<p>Now, flip the order of the <code>b</code> dependencies so that <code>pyproject.toml</code> looks like this:</p>
<pre><code>[project]
name = &#x27;project&#x27;
version = &#x27;0.1.0&#x27;
dependencies = [
  &quot;fork-marker-selection-a&quot;,
  &quot;fork-marker-selection-b&lt;2 ; sys_platform == &#x27;darwin&#x27;&quot;,
  &quot;fork-marker-selection-b&gt;=2 ; sys_platform == &#x27;linux&#x27;&quot;,
]
requires-python = &#x27;&gt;=3.8&#x27;
</code></pre>
<p>Repeat the exact same steps as before to lock it:</p>
<pre><code>$ rm -f uv.lock

$ uv cache clean
Clearing cache at: /home/andrew/.cache/uv
Removed 14 files (9.8KiB)

$ UV_INDEX_URL=http://localhost:3141 uv lock -p3.8
warning: `uv lock` is experimental and may change without warning.
Using Python 3.8.19 interpreter at: /home/andrew/.local/share/uv/python/cpython-3.8.19-linux-x86_64-gnu/bin/python3
Resolved 5 packages in 219ms
</code></pre>
<p>(The different number of resolved packages is indeed some ominous foreshadowing here.)</p>
<p>And the relevant part of the lock file now looks like this:</p>
<pre><code>[[distribution]]
name = &quot;project&quot;
version = &quot;0.1.0&quot;
source = { editable = &quot;.&quot; }
dependencies = [
    { name = &quot;fork-marker-selection-a&quot;, version = &quot;0.1.0&quot;, source = { registry = &quot;http://localhost:3141/&quot; }, marker = &quot;sys_platform == &#x27;darwin&#x27;&quot; },
    { name = &quot;fork-marker-selection-a&quot;, version = &quot;0.2.0&quot;, source = { registry = &quot;http://localhost:3141/&quot; }, marker = &quot;sys_platform == &#x27;linux&#x27;&quot; },
    { name = &quot;fork-marker-selection-b&quot;, version = &quot;1.0.0&quot;, source = { registry = &quot;http://localhost:3141/&quot; }, marker = &quot;sys_platform == &#x27;darwin&#x27;&quot; },
    { name = &quot;fork-marker-selection-b&quot;, version = &quot;2.0.0&quot;, source = { registry = &quot;http://localhost:3141/&quot; }, marker = &quot;sys_platform == &#x27;linux&#x27;&quot; },
]
</code></pre>
<p>In the former case, it is almost correct, except <code>a</code> is conditional on the platform being <code>linux</code> or <code>darwin</code>. I believe instead the marker shouldn&#x27;t even be there (or should evaluate to true for all marker environments). This is possibly a bug in my fix for incomplete markers and likely unrelated to this specific issue of the output changing based on the order of requirements. The main point of the former case is that we select one version that works across all platforms.</p>
<p>In the latter, we select two different versions of <code>a</code>, each depending on the platform. I believe this also suffers from a similar bug as the first case where <code>a 0.1.0</code>&#x27;s marker should actually be <code>sys_platform != &#x27;linux&#x27;</code>, or more likely, a <em>third</em> choice reflecting the part of the universe not covered by the existing marker expressions, which would be <code>sys_platform != &#x27;linux&#x27; and sys_platform != &#x27;darwin&#x27;</code>. And again, I think this problem occurs because of an issue in my fix for incomplete markers. That&#x27;s tracked by #5162.</p>
<p>But the output depending on the ordering of the requirements is, I believe, a different issue. I haven&#x27;t fully diagnosed why this is occurring yet. (I believe @konstin predicted the occurrence of this bug.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-17 18:26</div>
            <div class="timeline-body"><p>In theory, it seems ok if the resolution differs based on the order of requirements...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">great writeup</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-18 03:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">lock</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-18 03:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-07-18 08:30</div>
            <div class="timeline-body"><p>Our package prioritization is order dependent, so there are examples where this happens without forking too, e.g. given:</p>
<ul>
<li>a has 1, 2</li>
<li>b has 1, 2</li>
<li>a 2 -&gt; c==1</li>
<li>b 2 -&gt; c==2</li>
</ul>
<p><code>dependencies = [&quot;a&quot;, &quot;b&quot;]</code> will resolve a 2, b 1, while
<code>dependencies = [&quot;b&quot;, &quot;a&quot;]</code> will resolve b 2, a 1. Forks specifically we can improve the situation by prioritizing specific forks to increase the changes of getting a more minimal resolution (#4926).</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:32:04 UTC
    </footer>
</body>
</html>
