<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uvx`  invocation does not propagate `DYLD_FALLBACK_LIBRARY_PATH` to the invoked script on MacOS - astral-sh/uv #6971</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>uvx</code>  invocation does not propagate <code>DYLD_FALLBACK_LIBRARY_PATH</code> to the invoked script on MacOS</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/6971">#6971</a>
        opened by <a href="https://github.com/miccoli">@miccoli</a>
        on 2024-09-03 14:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/miccoli">@miccoli</a> on 2024-09-03 14:47</div>
            <div class="timeline-body"><p>I was not able to pass environment variables to utilities run with <code>uvx</code>.</p>
<p>I noticed this problem trying to run <code>uvx weasyprint</code> on MacOS, which fails because it is not able to locate a homebrew installed library.</p>
<pre><code class="language-bash">% export DYLD_FALLBACK_LIBRARY_PATH=/opt/homebrew/lib
% uvx weasyprint --version

... snip ...

OSError: cannot load library 'gobject-2.0-0': dlopen(gobject-2.0-0, 0x0002): tried: 'gobject-2.0-0' (no such file), '/System/Volumes/Preboot/Cryptexes/OSgobject-2.0-0' (no such file), '/usr/lib/gobject-2.0-0' (no such file, not in dyld cache), 'gobject-2.0-0' (no such file).  Additionally, ctypes.util.find_library() did not manage to locate a library called 'gobject-2.0-0'
</code></pre>
<p>But after installing in a venv</p>
<pre><code class="language-bash">% uv venv
Using Python 3.12.5
Creating virtualenv at: .venv
Activate with: source .venv/bin/activate

% uv pip install weasyprint
Resolved 14 packages in 9ms
Installed 14 packages in 19ms
 + brotli==1.1.0
 + cffi==1.17.0
 + cssselect2==0.7.0
 + fonttools==4.53.1
 + html5lib==1.1
 + pillow==10.4.0
 + pycparser==2.22
 + pydyf==0.11.0
 + pyphen==0.16.0
 + six==1.16.0
 + tinycss2==1.3.0
 + weasyprint==62.3
 + webencodings==0.5.1
 + zopfli==0.2.3
</code></pre>
<p>the command works as expected (and no <code>export</code> necessary)</p>
<pre><code class="language-bash">% DYLD_FALLBACK_LIBRARY_PATH=/opt/homebrew/lib .venv/bin/weasyprint --version
WeasyPrint version 62.3
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-03 15:18</div>
            <div class="timeline-body"><p>That's surprising. We can look into this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-09-03 15:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">uv tool</span> added by @zanieb on 2024-09-03 15:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-09-04 02:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-04 02:41</div>
            <div class="timeline-body"><p>I'm not yet sure what's happening here... It does seem like we're respecting environment variables (e.g., <code>RUFF_CACHE_DIR=foo uvx ruff check --show-settings</code> does show <code>cache_dir = &quot;foo&quot;</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @charliermarsh by @charliermarsh on 2024-09-04 02:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @zanieb on 2024-09-04 02:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-04 02:51</div>
            <div class="timeline-body"><p>I tried to reproduce this on macOS but failed — I think you'll need to do a bit more investigation on your end and try to get us an example we can reproduce e.g. maybe using a Docker container.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-04 02:52</div>
            <div class="timeline-body"><p>I have no trouble reproducing heh:</p>
<pre><code>❯ uvx weasyprint --verbose

-----

WeasyPrint could not import some external libraries. Please carefully follow the installation steps before reporting an issue:
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#installation
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#troubleshooting

-----

Traceback (most recent call last):
  File &quot;/Users/crmarsh/.cache/uv/archive-v0/iLLdmcx9aXJ9J2ThHhFPC/bin/weasyprint&quot;, line 7, in &lt;module&gt;
    from weasyprint.__main__ import main
  File &quot;/Users/crmarsh/.cache/uv/archive-v0/iLLdmcx9aXJ9J2ThHhFPC/lib/python3.12/site-packages/weasyprint/__init__.py&quot;, line 419, in &lt;module&gt;
    from .css import preprocess_stylesheet  # noqa: I001, E402
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/Users/crmarsh/.cache/uv/archive-v0/iLLdmcx9aXJ9J2ThHhFPC/lib/python3.12/site-packages/weasyprint/css/__init__.py&quot;, line 28, in &lt;module&gt;
    from .computed_values import COMPUTER_FUNCTIONS
  File &quot;/Users/crmarsh/.cache/uv/archive-v0/iLLdmcx9aXJ9J2ThHhFPC/lib/python3.12/site-packages/weasyprint/css/computed_values.py&quot;, line 9, in &lt;module&gt;
    from ..text.ffi import ffi, pango, units_to_double
  File &quot;/Users/crmarsh/.cache/uv/archive-v0/iLLdmcx9aXJ9J2ThHhFPC/lib/python3.12/site-packages/weasyprint/text/ffi.py&quot;, line 431, in &lt;module&gt;
    gobject = _dlopen(
              ^^^^^^^^
  File &quot;/Users/crmarsh/.cache/uv/archive-v0/iLLdmcx9aXJ9J2ThHhFPC/lib/python3.12/site-packages/weasyprint/text/ffi.py&quot;, line 420, in _dlopen
    return ffi.dlopen(names[0])  # pragma: no cover
           ^^^^^^^^^^^^^^^^^^^^
  File &quot;/Users/crmarsh/.cache/uv/archive-v0/iLLdmcx9aXJ9J2ThHhFPC/lib/python3.12/site-packages/cffi/api.py&quot;, line 150, in dlopen
    lib, function_cache = _make_ffi_library(self, name, flags)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/Users/crmarsh/.cache/uv/archive-v0/iLLdmcx9aXJ9J2ThHhFPC/lib/python3.12/site-packages/cffi/api.py&quot;, line 832, in _make_ffi_library
    backendlib = _load_backend_lib(backend, libname, flags)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/Users/crmarsh/.cache/uv/archive-v0/iLLdmcx9aXJ9J2ThHhFPC/lib/python3.12/site-packages/cffi/api.py&quot;, line 827, in _load_backend_lib
    raise OSError(msg)
OSError: cannot load library 'gobject-2.0-0': dlopen(gobject-2.0-0, 0x0002): tried: 'gobject-2.0-0' (no such file), '/System/Volumes/Preboot/Cryptexes/OSgobject-2.0-0' (no such file), '/usr/lib/gobject-2.0-0' (no such file, not in dyld cache), 'gobject-2.0-0' (no such file).  Additionally, ctypes.util.find_library() did not manage to locate a library called 'gobject-2.0-0'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-04 02:58</div>
            <div class="timeline-body"><p>Did you set the variable?</p>
<pre><code>❯ export DYLD_FALLBACK_LIBRARY_PATH=/opt/homebrew/lib
❯ uvx weasyprint --version

Installed 14 packages in 19ms
WeasyPrint version 62.3
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-04 03:02</div>
            <div class="timeline-body"><p>Yeah I did</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-04 03:03</div>
            <div class="timeline-body"><p>(Be sure to <code>uv tool uninstall weasyprint</code> if you didn't.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-04 03:05</div>
            <div class="timeline-body"><p>(Although looks like <code>uvx</code> did the install so nevermind.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-04 13:05</div>
            <div class="timeline-body"><p>I wonder if you just don't have the libs it needs installed with Brew? I'm confused that you could reproduce but I couldn't :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/miccoli">@miccoli</a> on 2024-09-04 14:51</div>
            <div class="timeline-body"><p>A little more investigation from my side...:</p>
<ul>
<li>The problem arises only with the <em>managed</em> python, not the <em>system</em> one:</li>
</ul>
<pre><code>% uvx --python-preference only-system weasyprint --version
WeasyPrint version 62.3
% uvx --python-preference only-managed weasyprint --version

... snip ...

OSError: cannot load library 'gobject-2.0-0': dlopen(gobject-2.0-0, 0x0002): tried: 'gobject-2.0-0' (no such file), '/System/Volumes/Preboot/Cryptexes/OSgobject-2.0-0' (no such file), '/usr/lib/gobject-2.0-0' (no such file, not in dyld cache), 'gobject-2.0-0' (no such file).  Additionally, ctypes.util.find_library() did not manage to locate a library called 'gobject-2.0-0'
</code></pre>
<ul>
<li><p>The managed version, in a <code>venv</code>, works as expected, i.e. throws an error without <code>DYLD_FALLBACK_LIBRARY_PATH=/opt/homebrew/lib</code> but is fine with this setting.</p>
</li>
<li><p>brew python works without setting <code>DYLD_FALLBACK_LIBRARY_PATH=/opt/homebrew/lib</code></p>
</li>
</ul>
<p>Could be the point here that the correct environment should be set when the python interpreter is invoked, not afterwards?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-04 14:56</div>
            <div class="timeline-body"><p>From what you've said there, I think this sounds like correct behavior?</p>
<p>I presume brew's Python links to <code>/opt/homebrew/lib</code> by default, so it's expected it works without a variable and then it sounds like the managed Python version requires you to explicitly provide the variable (which makes sense, how can it know about Brew?) and providing it works.</p>
<p>Am I missing something?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/miccoli">@miccoli</a> on 2024-09-04 16:16</div>
            <div class="timeline-body"><blockquote>
<p>From what you've said there, I think this sounds like correct behavior?</p>
<p>I presume brew's Python links to <code>/opt/homebrew/lib</code> by default, so it's expected it works without a variable and then it sounds like the managed Python version requires you to explicitly provide the variable (which makes sense, how can it know about Brew?) and providing it works.</p>
</blockquote>
<p>Main problem for me is the surprise factor.</p>
<p>Suppose I do not have system (homebrew) python installed:</p>
<ol>
<li>I run <code>uvx weasyprint</code> and it fails.</li>
<li>I lookup the docs, and since I have all relevant libraries installed in <code>/opt/homebrew/lib</code> I run <code>DYLD_FALLBACK_LIBRARY_PATH=/opt/homebrew/lib uvx weasyprint</code> and it fails again.</li>
<li>Now I'm lost... I have to install homebrew python, and run <code>uvx --python-preference only-system weasyprint</code></li>
<li>From now on <code>uvx weasyprint</code> works since the python pref. was cached...</li>
</ol>
<p>For sure we have an edge case, and sincerely I think that <code>weasyprint</code> could be a little more smart, but my point is that from a user perspective</p>
<pre><code>DYLD_FALLBACK_LIBRARY_PATH=/opt/homebrew/lib uvx --python-preference only-managed weasyprint
</code></pre>
<p>should work, because in a <code>only-managed</code> virtual env, <code>DYLD_FALLBACK_LIBRARY_PATH=/opt/homebrew/lib waesyprint</code> works as expected.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-04 16:29</div>
            <div class="timeline-body"><p><code>DYLD_FALLBACK_LIBRARY_PATH=/opt/homebrew/lib uvx weasyprint</code> should work and I thought you said it did above &quot;... but is fine with this setting.&quot;</p>
<blockquote>
<p>because in a only-managed virtual env, DYLD_FALLBACK_LIBRARY_PATH=/opt/homebrew/lib waesyprint works as expected.</p>
</blockquote>
<p>What does it mean to have a only-managed virtual env? It works with <code>uv add</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/miccoli">@miccoli</a> on 2024-09-04 16:57</div>
            <div class="timeline-body"><p>Sorry if my wording was not clear, <code>only-managed</code> and <code>only-system</code> refer  to the <code>--python-preference</code></p>
<p>Let me explain with some more examples, which I think you can reproduce:</p>
<p><code>only-managed</code>:</p>
<pre><code>% uv venv --python-preference only-managed
Using Python 3.12.5
Creating virtualenv at: .venv
Activate with: source .venv/bin/activate
% uv pip install weasyprint
Resolved 14 packages in 8ms
Installed 14 packages in 23ms
 + brotli==1.1.0
 + cffi==1.17.0
 + cssselect2==0.7.0
 + fonttools==4.53.1
 + html5lib==1.1
 + pillow==10.4.0
 + pycparser==2.22
 + pydyf==0.11.0
 + pyphen==0.16.0
 + six==1.16.0
 + tinycss2==1.3.0
 + weasyprint==62.3
 + webencodings==0.5.1
 + zopfli==0.2.3
% DYLD_FALLBACK_LIBRARY_PATH=/opt/homebrew/lib .venv/bin/weasyprint --version
WeasyPrint version 62.3
% .venv/bin/weasyprint --version

-----

WeasyPrint could not import some external libraries. Please carefully follow the installation steps before reporting an issue:
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#installation
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#troubleshooting

-----
</code></pre>
<p><code>only-system</code>:</p>
<pre><code>% uv venv --python-preference only-system
Using Python 3.12.5 interpreter at: /opt/homebrew/opt/python@3.12/bin/python3.12
Creating virtualenv at: .venv
Activate with: source .venv/bin/activate
% uv pip install weasyprint
Resolved 14 packages in 5ms
Installed 14 packages in 17ms
 + brotli==1.1.0
 + cffi==1.17.0
 + cssselect2==0.7.0
 + fonttools==4.53.1
 + html5lib==1.1
 + pillow==10.4.0
 + pycparser==2.22
 + pydyf==0.11.0
 + pyphen==0.16.0
 + six==1.16.0
 + tinycss2==1.3.0
 + weasyprint==62.3
 + webencodings==0.5.1
 + zopfli==0.2.3
% .venv/bin/weasyprint --version
WeasyPrint version 62.3
</code></pre>
<p>As expected, <code>weasyprint</code> script runs</p>
<ul>
<li>under homebrew managed python <em>without</em>  <code>DYLD_FALLBACK_LIBRARY_PATH</code></li>
<li>under uv managed python <strong>only with</strong> <code>DYLD_FALLBACK_LIBRARY_PATH</code></li>
</ul>
<p>So the problem is not within weasyprint, or the python interpreters... it is on how <code>uvx</code> loads the uv-managed python interpreter, which is somehow <em>unaware</em> of <code>DYLD_FALLBACK_LIBRARY_PATH</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-04 17:07</div>
            <div class="timeline-body"><p>The problem is that I cannot reproduce the <code>uvx</code> behavior you are seeing:</p>
<pre><code>❯ DYLD_FALLBACK_LIBRARY_PATH=/opt/homebrew/lib uvx --python-preference only-managed --no-cache weasyprint
Installed 14 packages in 17ms
usage: weasyprint [-h] [-e ENCODING] [-s STYLESHEETS] [-m MEDIA_TYPE] [-u BASE_URL] [-a ATTACHMENTS]
                  [--pdf-identifier PDF_IDENTIFIER]
                  [--pdf-variant {pdf/a-1b,pdf/a-2b,pdf/a-3b,pdf/a-4b,pdf/a-2u,pdf/a-3u,pdf/a-4u,pdf/ua-1}]
                  [--pdf-version PDF_VERSION] [--pdf-forms] [--uncompressed-pdf] [--custom-metadata] [-p] [--optimize-images]
                  [-j JPEG_QUALITY] [--full-fonts] [--hinting] [-c CACHE] [-D DPI] [-v] [-d] [-q] [--version] [-i] [-t TIMEOUT]
                  input output
weasyprint: error: the following arguments are required: input, output

❯ uvx --python-preference only-managed --no-cache weasyprint
Installed 14 packages in 17ms

....

WeasyPrint could not import some external libraries. Please carefully follow the installation steps before reporting an i
OSError: cannot load library 'gobject-2.0-0': dlopen(gobject-2.0-0, 0x0002): tried: 'gobject-2.0-0' (no such file), '/System/Volumes/Preboot/Cryptexes/OSgobject-2.0-0' (no such file), '/usr/lib/gobject-2.0-0' (no such file, not in dyld cache), 'gobject-2.0-0' (no such file).  Additionally, ctypes.util.find_library() did not manage to locate a library called 'gobject-2.0-0'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-04 17:08</div>
            <div class="timeline-body"><p>If it's helpful, I can (unless I'm doing something wrong):</p>
<pre><code>❯ DYLD_FALLBACK_LIBRARY_PATH=/opt/homebrew/lib uvx --python-preference only-managed --no-cache weasyprint
Installed 14 packages in 15ms

-----

WeasyPrint could not import some external libraries. Please carefully follow the installation steps before reporting an issue:
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#installation
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#troubleshooting

-----

Traceback (most recent call last):
  File &quot;/private/var/folders/nt/6gf2v7_s3k13zq_t3944rwz40000gn/T/.tmpG93U5p/archive-v0/mjF8lpR6k77GnkTmYc5m_/bin/weasyprint&quot;, line 7, in &lt;module&gt;
    from weasyprint.__main__ import main
  File &quot;/private/var/folders/nt/6gf2v7_s3k13zq_t3944rwz40000gn/T/.tmpG93U5p/archive-v0/mjF8lpR6k77GnkTmYc5m_/lib/python3.12/site-packages/weasyprint/__init__.py&quot;, line 419, in &lt;module&gt;
    from .css import preprocess_stylesheet  # noqa: I001, E402
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/private/var/folders/nt/6gf2v7_s3k13zq_t3944rwz40000gn/T/.tmpG93U5p/archive-v0/mjF8lpR6k77GnkTmYc5m_/lib/python3.12/site-packages/weasyprint/css/__init__.py&quot;, line 28, in &lt;module&gt;
    from .computed_values import COMPUTER_FUNCTIONS
  File &quot;/private/var/folders/nt/6gf2v7_s3k13zq_t3944rwz40000gn/T/.tmpG93U5p/archive-v0/mjF8lpR6k77GnkTmYc5m_/lib/python3.12/site-packages/weasyprint/css/computed_values.py&quot;, line 9, in &lt;module&gt;
    from ..text.ffi import ffi, pango, units_to_double
  File &quot;/private/var/folders/nt/6gf2v7_s3k13zq_t3944rwz40000gn/T/.tmpG93U5p/archive-v0/mjF8lpR6k77GnkTmYc5m_/lib/python3.12/site-packages/weasyprint/text/ffi.py&quot;, line 431, in &lt;module&gt;
    gobject = _dlopen(
              ^^^^^^^^
  File &quot;/private/var/folders/nt/6gf2v7_s3k13zq_t3944rwz40000gn/T/.tmpG93U5p/archive-v0/mjF8lpR6k77GnkTmYc5m_/lib/python3.12/site-packages/weasyprint/text/ffi.py&quot;, line 420, in _dlopen
    return ffi.dlopen(names[0])  # pragma: no cover
           ^^^^^^^^^^^^^^^^^^^^
  File &quot;/private/var/folders/nt/6gf2v7_s3k13zq_t3944rwz40000gn/T/.tmpG93U5p/archive-v0/mjF8lpR6k77GnkTmYc5m_/lib/python3.12/site-packages/cffi/api.py&quot;, line 150, in dlopen
    lib, function_cache = _make_ffi_library(self, name, flags)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/private/var/folders/nt/6gf2v7_s3k13zq_t3944rwz40000gn/T/.tmpG93U5p/archive-v0/mjF8lpR6k77GnkTmYc5m_/lib/python3.12/site-packages/cffi/api.py&quot;, line 832, in _make_ffi_library
    backendlib = _load_backend_lib(backend, libname, flags)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/private/var/folders/nt/6gf2v7_s3k13zq_t3944rwz40000gn/T/.tmpG93U5p/archive-v0/mjF8lpR6k77GnkTmYc5m_/lib/python3.12/site-packages/cffi/api.py&quot;, line 827, in _load_backend_lib
    raise OSError(msg)
OSError: cannot load library 'gobject-2.0-0': dlopen(gobject-2.0-0, 0x0002): tried: 'gobject-2.0-0' (no such file), '/System/Volumes/Preboot/Cryptexes/OSgobject-2.0-0' (no such file), '/usr/lib/gobject-2.0-0' (no such file, not in dyld cache), 'gobject-2.0-0' (no such file).  Additionally, ctypes.util.find_library() did not manage to locate a library called 'gobject-2.0-0'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-04 17:12</div>
            <div class="timeline-body"><p>@charliermarsh I am just presuming you don't have the relevant dependencies installed with Brew — does this work for you in a venv as they described? Also like... what do you see here?</p>
<pre><code>❯ DYLD_FALLBACK_LIBRARY_PATH=/opt/homebrew/lib uvx --python-preference only-managed --no-cache --from weasyprint bash -c 'echo &quot;$DYLD_FALLBACK_LIBRARY_PATH&quot;'
Installed 14 packages in 14ms
/opt/homebrew/lib
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-04 17:13</div>
            <div class="timeline-body"><p>Honestly surprised by this but it's empty:</p>
<pre><code>❯ DYLD_FALLBACK_LIBRARY_PATH=/opt/homebrew/lib uvx --python-preference only-managed --no-cache --from weasyprint bash -c 'echo &quot;$DYLD_FALLBACK_LIBRARY_PATH&quot;'
Installed 14 packages in 13ms

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-04 17:15</div>
            <div class="timeline-body"><p>Now that's very surprising haha umm... we're both on the same platform / os / arch. What the heck? Are you using zsh?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-04 17:16</div>
            <div class="timeline-body"><p>I'm using Zsh... Really confusing. I'm on macOS yes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-04 17:17</div>
            <div class="timeline-body"><p>I'm also confused because when I tested yesterday, <code>UV_CACHE_DIR=foo uvx ruff check --show-settings</code> did work (reflected <code>foo</code> in the output), but now it doesn't.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-04 17:18</div>
            <div class="timeline-body"><p>What's your version?</p>
<pre><code>❯ uvx --version
uv-tool-uvx 0.4.4 (3d75df6ab 2024-09-04)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-04 17:18</div>
            <div class="timeline-body"><p>Sorry, I was using the wrong env var above. <code>RUFF_CACHE_DIR=foo uvx ruff check --show-settings</code> <em>does</em> reflect <code>foo</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-04 17:19</div>
            <div class="timeline-body"><p>Ok, so <em>this</em> works:</p>
<pre><code>❯ FOO=1 uvx --python-preference only-managed --no-cache --from weasyprint bash -c 'echo &quot;$FOO&quot;'
Installed 14 packages in 14ms
1
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-04 17:23</div>
            <div class="timeline-body"><p>Ok, so <em>specifically</em> env vars that start with <code>DYLD_</code> are getting erased:</p>
<pre><code>❯ FALLBACK_LIBRARY_PATH=/opt/homebrew/lib uvx --python-preference only-managed --no-cache --from weasyprint zsh -c 'echo &quot;$FALLBACK_LIBRARY_PATH&quot;'
Installed 14 packages in 14ms
/opt/homebrew/lib

❯ DYLD_FOO=/opt/homebrew/lib uvx --python-preference only-managed --no-cache --from weasyprint zsh -c 'echo &quot;$DYLD_FOO&quot;'
Installed 14 packages in 15ms
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-04 17:24</div>
            <div class="timeline-body"><p>https://hynek.me/articles/macos-dyld-env/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-04 17:28</div>
            <div class="timeline-body"><p>Wow so tragic. I have SIP turned off — that's why it works for me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> removed by @zanieb on 2024-09-04 17:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-04 17:44</div>
            <div class="timeline-body"><p>@miccoli Sorry about all the back and forth! We'll look for a workaround here, but this is really an annoying macOS behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/miccoli">@miccoli</a> on 2024-09-04 20:08</div>
            <div class="timeline-body"><blockquote>
<p>@miccoli Sorry about all the back and forth! We'll look for a workaround here, but this is really an annoying macOS behavior.</p>
</blockquote>
<p>Thanks for nailing this down really really fast.</p>
<p>No problem on my side, once you know the problem you can live with it quite easily... I opened this issue mainly to avoid others the pain of understanding what was going on.</p>
<p>BTW this is really an edge case, so there is no urgency in solving it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-06 00:17</div>
            <div class="timeline-body"><p>@zanieb -- I'm tempted to close this, I don't know if we can actually fix it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-09-06 00:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/miccoli">@miccoli</a> on 2024-09-06 11:15</div>
            <div class="timeline-body"><blockquote>
<p>@zanieb -- I'm tempted to close this, I don't know if we can actually fix it.</p>
</blockquote>
<p>OK for closing since this is only an edge case, and it could be overly difficult to fix (and a BIG thanks for the wonderful uv project!)</p>
<p>Just for the records, and because this could surface in other places too, let me just point to the exact place where the <code>#!/bin/sh</code> shebang (responsible for the <code>DYLD_*</code> sanitisation) got added in the first place:</p>
<p>https://github.com/astral-sh/uv/blob/8bcae5f2f693a790cbb3f4bc3e509b931d8d7cea/crates/install-wheel-rs/src/wheel.rs#L126-L160</p>
<p>Interestingly it appears that the shebang length limit on MacOS is 512 and not 127, so this problem could be mitigated at the cost of a more complex check on the platform...</p>
<p>In <a href="https://www.in-ulm.de/~mascheck/various/shebang/">https://www.in-ulm.de/~mascheck/various/shebang/</a> there is a lot of info on the shebang.</p>
<p>I'm tempted to open a PR since it would be an excuse to finally learn rust (which is on my to do list), but this will not happen any time soon...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Allow setting env variables in `uvx`" to "`uvx`  invocation does not propagate `DYLD_FALLBACK_LIBRARY_PATH` to the invoked script on MacOS" by @miccoli on 2024-09-06 11:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/agustingomes-therapieland">@agustingomes-therapieland</a> on 2024-10-02 20:11</div>
            <div class="timeline-body"><p>@miccoli I would like to thank you because today I learned <code>DYLD_FALLBACK_LIBRARY_PATH</code> can solve some of my problems.</p>
<p>Edit: for context, I opened earlier <a href="https://github.com/astral-sh/uv/issues/7870">this issue</a> which I was having in my virtual env, and using that env variable helped me solve the issue, coincidentally also with WeasyPrint.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CHC383">@CHC383</a> on 2025-11-16 08:38</div>
            <div class="timeline-body"><p>Just want to share a way to set <code>DYLD_FALLBACK_LIBRARY_PATH</code> programmatically:</p>
<pre><code class="language-python">from ctypes.macholib import dyld
dyld.DEFAULT_LIBRARY_FALLBACK.append(&quot;/opt/homebrew/lib&quot;)
</code></pre>
<p>This is from https://github.com/Kozea/CairoSVG/issues/354#issuecomment-1072905204</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:30:41 UTC
    </footer>
</body>
</html>
