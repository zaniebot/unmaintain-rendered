<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python discovery prefers python3 over python3.12 when UV_PYTHON=python3.12 - astral-sh/uv #9046</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Python discovery prefers python3 over python3.12 when UV_PYTHON=python3.12</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/9046">#9046</a>
        opened by <a href="https://github.com/hynek">@hynek</a>
        on 2024-11-12 05:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/hynek">@hynek</a></div>
            <div class="timeline-body"><p>This is something that happens with uv 0.5.0 and 0.5.1 but not uv 0.4.30.</p>
<p>I've run into this in Ubuntu Noble containers where for some reason my fat build container carries a <code>/usr/bin/python3</code> but my slim prod container does not â€“ but it has <code>/usr/bin/python3.12</code>. Both are the same system Python 3.12.</p>
<p>Before 0.5.0, if <code>UV_PYTHON</code> is set to <code>python3.12</code>, uv sync and uv venv would already say <code>Using CPython 3.12.3 interpreter at: /usr/bin/python3</code> but the symlink from the venv would go to <code>/usr/bin/python3.12</code>. Now it goes to <code>/usr/bin/python3</code> and the venv is broken in prod.</p>
<p>The workaround is setting <code>UV_PYTHON=/usr/bin/python3.12</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Python discovery prefers python3 over python3.12" to "Python discovery prefers python3 over python3.12 when UV_PYTHON=python3.12" by @hynek on 2024-11-12 05:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-12 15:01</div>
            <div class="timeline-body"><p>Yeah this came up in Discord yesterday. I'm not sure what changed exactly. My guess is that we used to fully resolve those symlinks, but now we follow the Python standard library and only use <code>sys._base_executable</code> for the virtual environment Python.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-12 16:21</div>
            <div class="timeline-body"><p>Yeah I can't think of anything but #8481 that would have changed here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-12 16:37</div>
            <div class="timeline-body"><p>I guess the main question is why <code>sys._base_executable</code> is wrong here? This should be &quot;broken&quot; with <code>python -m venv</code> too right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-12 16:40</div>
            <div class="timeline-body"><p>I can fix this specific case by preferring a versioned executable over an unversioned one when a version is requested, but it's just more complexity in the discovery rules and won't help if there's a symlink in another directory.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-12 17:02</div>
            <div class="timeline-body"><p>@hynek -- Do you have any sort of minimal repro we can use to look at how the Python setup works?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @charliermarsh on 2024-11-12 17:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hynek">@hynek</a> on 2024-11-13 04:40</div>
            <div class="timeline-body"><p>Sure:</p>
<pre><code class="language-dockerfile"># syntax=docker/dockerfile:1.9
FROM ubuntu:noble AS build
SHELL [&quot;sh&quot;, &quot;-exc&quot;]

RUN &lt;&lt;EOT
apt-get update
apt-get install -qyy \
    -o APT::Install-Recommends=false \
    -o APT::Install-Suggests=false \
    python3-setuptools \
    python3.12
EOT

COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

ENV UV_LINK_MODE=copy \
    UV_PYTHON_DOWNLOADS=never \
    UV_PYTHON=python3.12

RUN &lt;&lt;EOT
uv venv /app
ls -l /app/bin/python
EOT

##########################################################################

FROM ubuntu:noble
SHELL [&quot;sh&quot;, &quot;-exc&quot;]

RUN &lt;&lt;EOT
apt-get update
apt-get install -qyy \
    -o APT::Install-Recommends=false \
    -o APT::Install-Suggests=false \
    python3.12
EOT

COPY --from=build /app /app

RUN &lt;&lt;EOT
ls -l /app/bin/python
/app/bin/python -V
EOT
</code></pre>
<p>FWIW it can also be triggered by installing <code>python3</code> instead of <code>python3-setuptools</code> but that's unlikely to happen in a Dockerfile. <em>This</em> is how <strong>I</strong> ran into the problem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-13 16:00</div>
            <div class="timeline-body"><p>Should be fixed by #9066</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> removed by @zanieb on 2024-11-13 16:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-13 16:01</div>
            <div class="timeline-body"><p>I would still like to understand why the base executable path is wrong.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bluss">@bluss</a> on 2024-11-13 16:08</div>
            <div class="timeline-body"><p>Isn't it the case here that there are two docker images. The first python environment has /usr/bin/python3. Then the venv is copied into a different image where /usr/bin/python3 doesn't exist. Uv doesn't do much wrong, the venv was transported between two &quot;incompatible&quot; python environments?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-13 16:37</div>
            <div class="timeline-body"><p>Yeah I don't know that the base executable path is &quot;wrong&quot;. It just depends on what Python itself reports.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-13 16:58</div>
            <div class="timeline-body"><p>It still seems weird that a different base executable would be reported depending on if <code>python</code> or <code>python3</code> is queried.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:28:18 UTC
    </footer>
</body>
</html>
