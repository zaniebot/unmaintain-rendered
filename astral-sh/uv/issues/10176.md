```yaml
number: 10176
title: "`uv lock --locked --offline` doesn’t work with projects that use dynamic versions"
type: issue
state: closed
author: vivodi
labels:
  - question
assignees: []
created_at: 2024-12-26T17:56:25Z
updated_at: 2025-01-22T21:07:30Z
url: https://github.com/astral-sh/uv/issues/10176
synced_at: 2026-01-10T01:57:23Z
```

# `uv lock --locked --offline` doesn’t work with projects that use dynamic versions

---

_Issue opened by @vivodi on 2024-12-26 17:56_

### Summary
> The requested feature, ideally, wouldn't involve actually resolving any dependencies and could be performed in a CICD pipeline that may not have the correct connections set up to update the uv.lock file
 _Originally posted by @butterlyn in [#7639](https://github.com/astral-sh/uv/issues/7639#issuecomment-2368401456)_

According to https://github.com/astral-sh/uv/issues/7639#issuecomment-2368419143, we can use `uv lock --locked --offline` to check if the `pyproject.toml` has been modified since the creation of the current `uv.lock` file. However, this approach does not offline work for projects with dynamic versions.

### Poetry works, but uv doesn’t
`poetry check --lock` can be used offline for projects with dynamic versions, while `uv lock --locked --offline` cannot. Here’s my speculation on the reasons:

1. Poetry does not write project information (such as version numbers and project names) into the `poetry.lock` file; it only writes dependency information, so `hatchling` is not needed when locking. This information is directly read from the `pyproject.toml` file when building the project.
   
2. Poetry writes a hash of the contents of `pyproject.toml` into the `poetry.lock` file to offline check the consistency between `pyproject.toml` and `poetry.lock`, whereas `uv.lock` does not include a hash.

### Possible solutions

1. `uv lock` could write only the dependency information into the `uv.lock` file, while the project's version information is directly read from the `pyproject.toml` during the build. This would avoid the need for the `hatchling` dependency to obtain the current project version when running `uv lock`.

2. Include a hash of the `pyproject.toml` content in the `uv.lock` file, so that the consistency between `uv.lock` and `pyproject.toml` can be verified based solely on the hash.

Related issues: https://github.com/astral-sh/uv/issues/7639#issuecomment-2368401456 #10167 #9653

### Log
[Log](https://results.pre-commit.ci/run/github/908488856/1735234912.h9kunT3vRaGetP3P1E4UBA):
```
uv-lock..................................................................Failed
- hook id: uv-lock
- exit code: 2

warning: `VIRTUAL_ENV=/pc/clone/JLKubma3TtiMMhmWEG5Gxg/py_env-python3` does not match the project environment path `.venv` and will be ignored
Using CPython 3.12.7 interpreter at: /usr/bin/python3.12
error: Failed to generate package metadata for `myproject==1.0.0 @ editable+.`
  Caused by: Failed to resolve requirements from `build-system.requires`
  Caused by: No solution found when resolving: `hatchling`
  Caused by: Because hatchling was not found in the cache and you require hatchling, we can conclude that your requirements are unsatisfiable.

hint: Packages were unavailable because the network was disabled. When the network is disabled, registry packages may only be read from the cache.
```

pyproject.toml:
```toml
[project]
name = "myproject"
requires-python = ">=3.12"
dynamic = ["version"]

[tool.hatch.version]
path = "myproject/version.py"

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"
```

.pre-commit-config.yaml
```yaml
repos:
- repo: https://github.com/astral-sh/uv-pre-commit
  rev: 0.5.11
  hooks:
    - id: uv-lock
      args: ["--locked", "--offline"]
```


---

_Referenced in [astral-sh/uv#10167](../../astral-sh/uv/issues/10167.md) on 2024-12-26 18:19_

---

_Renamed from "`uv lock --locked --offline` doesn't work for dynamic-versioned projects" to "`uv lock --locked --offline` doesn’t work with projects that use dynamic versions" by @vivodi on 2024-12-26 18:23_

---

_Comment by @charliermarsh on 2024-12-26 22:45_

Unfortunately both of those solutions have downsides and we intentionally choose not to pursue them. For example: the first solution means that lockfiles are not sufficient to perform an install -- they're inherently coupled to the `pyproject.toml`. The second solution causes problems with Git conflict resolution -- it's no longer possible to resolve a conflict without re-resolving the project.

---

_Comment by @vivodi on 2024-12-27 09:44_

There is a workaround for pre-commit CI: 

pre-commit CI only allows dependencies to be installed at `install time` and does not allow network access at `runtime`. So, can `uv` **search for hatchling in the venv** instead of only looking for dependencies in the cache `/tmp/cache/uv`?

This way, I can use `additional_dependencies: [hatchling]` to install it in the venv during `install time`, and then `uv` can use it.

---

_Comment by @vivodi on 2024-12-27 10:07_

> Unfortunately both of those solutions have downsides and we intentionally choose not to pursue them. For example: the first solution means that lockfiles are not sufficient to perform an install -- they're inherently coupled to the `pyproject.toml`. The second solution causes problems with Git conflict resolution -- it's no longer possible to resolve a conflict without re-resolving the project.

Regarding the first point, I believe that the coupling between `uv.lock` and `pyproject.toml` is not an issue, because locking dependencies is intended to ensure the project runs consistently across different environments, avoiding uncertainty and compatibility issues caused by dependency version changes. However, is it really necessary to lock the project's name and version number? I don't think so. Additionally, under normal circumstances, `pyproject.toml` should never be missing, and there should be no problem reading it directly during the build process.

Regarding the second point, I believe it's necessary to re-resolve the project after resolving conflicts, because we cannot guarantee that after manually modifying the `pyproject.toml` and `uv.lock`, `uv.lock` will still be fully consistent with `pyproject.toml`, nor can we guarantee that the dependency relationships remain valid.

---

_Label `question` added by @zanieb on 2025-01-06 20:36_

---

_Assigned to @charliermarsh by @zanieb on 2025-01-06 20:36_

---

_Comment by @charliermarsh on 2025-01-22 21:07_

I believe this now works, by the way.

---

_Closed by @charliermarsh on 2025-01-22 21:07_

---

_Referenced in [opentargets/gentropy#1024](../../opentargets/gentropy/pulls/1024.md) on 2025-03-20 09:24_

---
