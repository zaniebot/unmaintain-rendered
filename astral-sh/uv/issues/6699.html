<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stubs on Windows exit abnormally, includes succinct repro with busybox, related to some wider issue - astral-sh/uv #6699</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Stubs on Windows exit abnormally, includes succinct repro with busybox, related to some wider issue</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/6699">#6699</a>
        opened by <a href="https://github.com/doctorpangloss">@doctorpangloss</a>
        on 2024-08-27 16:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/doctorpangloss">@doctorpangloss</a> on 2024-08-27 16:27</div>
            <div class="timeline-body"><p>related: https://github.com/rmyorston/busybox-w32/issues/451
related: https://github.com/astral-sh/uv/issues/6464</p>
<p><img src="https://github.com/user-attachments/assets/fd8bcc34-930e-4664-9c32-704d039c9ab2" alt="WindowsTerminal_qBCDluBxeQ" /></p>
<pre><code>wget https://frippery.org/files/busybox/prerelease/busybox_pre64.exe
busybox_pre64.exe sh -X
mkdir uv-test
cd uv-test
uv venv --seed
source .venv/scripts/activate
# uses stub
pip install insightface
</code></pre>
<p>Observe <code>pip</code> exits abnormally under this shell. In Powershell it works fine.</p>
<p>uv 0.3.4 (39f3cd2a9 2024-08-26)
Windows 2022</p>
<p>All stubs, not just <code>pip</code>, are cursed this way. The stubs created by native <code>pip</code> do not have any issues.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Stubs on Windows exit abnormally when run under busybox, indicating wider issue" to "Stubs on Windows exit abnormally, includes succinct repro with busybox, related to some wider issue" by @doctorpangloss on 2024-08-27 16:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rmyorston">@rmyorston</a> on 2024-08-28 08:20</div>
            <div class="timeline-body"><p>I can see the problem, but don't have much idea why it occurs.</p>
<p>What I've done:</p>
<ul>
<li>Install Python on Windows using an installer from python.org.</li>
<li>From PowerShell run <code>pip install uv</code>.</li>
<li>From a busybox-w32 shell do the whole <code>mkdir uv-test; ... ; pip install insightface</code> thing. As promised, it doesn't work.</li>
</ul>
<p>The question is why not. I was suspicious of the changes the busybox-w32 shell makes to environment variables when it reads them in as shell variables. By default it converts the variable names to uppercase and replaces backslashes with forward slashes in the value. (There are a couple of exceptions to the latter, it seemed possible more might be needed.)</p>
<p>I made a custom shell so those changes could be avoided. It remains necessary to change <code>Path</code> to <code>PATH</code>, or the shell won't find any external commands. <code>pip install insightface</code> still fails with a segfault. I do note, though, that if the failing process is stopped with an error dialog the installation seems to carry on in the background until the dialog is closed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-28 12:45</div>
            <div class="timeline-body"><p>Thanks for the report. I presume this is a bug in our &quot;trampoline&quot; that's used for executables on Windows. I don't see an error message in the video, what's the failure mode exactly?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">windows</span> added by @zanieb on 2024-08-28 12:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2024-08-28 12:48</div>
            <div class="timeline-body"><blockquote>
<p>By default it converts the variable names to uppercase and replaces backslashes with forward slashes in the value.</p>
</blockquote>
<p>Does this behave as if it was a MinGW based environment? There's been a number of MinGW related issues, especially when it comes to paths. e.g. https://github.com/astral-sh/uv/issues/3573</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rmyorston">@rmyorston</a> on 2024-08-28 16:35</div>
            <div class="timeline-body"><p>@zanieb In my experience the failure mode is a 0xc0000005 error, which I (possibly wrongly) equate to a segfault.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rmyorston">@rmyorston</a> on 2024-08-28 17:08</div>
            <div class="timeline-body"><p>@samypr100 The issue you reference seems to be somewhat confused about what MinGW means. (And I'm not sure I can be lucid enough to clear up the confusion.)</p>
<p>MinGW (and these days that generally means <a href="https://www.mingw-w64.org">MinGW-w64</a>) is a set of headers and libraries which make it possible to build native Windows applications.</p>
<p>There are various ways that can be done:</p>
<ul>
<li>I cross-compile on Linux.</li>
<li>There's the Windows-native <a href="https://github.com/skeeto/w64devkit">w64devkit</a> toolchain.</li>
<li><a href="https://www.msys2.org">MSYS2</a> is an alternative toolchain for Windows.</li>
</ul>
<p>busybox-w32 is built using MinGW, so it's a native Windows binary which deals in native Windows paths.</p>
<p>This can be opposed to binaries built using the Cygwin DLL, such as those that come with  MSYS2: these see fake POSIX paths.</p>
<p>When the referenced issue talks of 'mingw python' it seems to mean the Python that's shipped with MSYS2. This is built using the Cygwin DLL and understands non-Windows paths. <em>I</em> wouldn't call that a 'MinGW Python'. Furthermore, I wouldn't be at all surprised to hear there have been issues with it's expectations regarding paths.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/6792.html">astral-sh/uv#6792</a> on 2024-08-29 04:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2024-08-29 04:46</div>
            <div class="timeline-body"><p>@rmyorston Thanks for the explanation. I've made an adjustment in #6792 that would fix this issue, or at least not fault. I haven't digged into the busybox impl, but <code>lpReserved2</code> reports multiple file descriptors which are invalid handles which led to the issue manifesting. For now, I've switched the implementation to ignore any handle that seems to be invalid.</p>
<p>https://github.com/astral-sh/uv/blob/3be4fe59d7fc0ed1f8906259c9723247460804ce/crates/uv-trampoline/src/bounce.rs#L347-L349</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rmyorston">@rmyorston</a> on 2024-08-29 06:26</div>
            <div class="timeline-body"><p>@samypr100 The fix sounds promising, thanks.</p>
<p>The shell in busybox-w32 uses <code>spawnve()</code> from the Microsoft C runtime to invoke external commands. What happens after that is up to Microsoft.</p>
<p>It'll be interesting to know if the fix also resolves #6464.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2024-08-30 08:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/doctorpangloss">@doctorpangloss</a> on 2024-08-30 22:47</div>
            <div class="timeline-body"><p>Is it expected to see</p>
<pre><code>Failed to close child file descriptors at 1
</code></pre>
<p>when invoking the stub from within sh onto stderr? otherwise things appear to be behaving normally</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/6866.html">astral-sh/uv#6866</a> on 2024-08-31 05:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/6955.html">astral-sh/uv#6955</a> on 2024-09-03 02:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2024-09-04 22:45</div>
            <div class="timeline-body"><p>@doctorpangloss Would you be able to confirm 0.4.5 fixes the fd issue for you?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/doctorpangloss">@doctorpangloss</a> on 2024-09-09 23:19</div>
            <div class="timeline-body"><pre><code>$ pip install -U uv
Collecting uv
  Obtaining dependency information for uv from https://files.pythonhosted.org/packages/06/f2/0278155d4b2726765bcad89e5bc6020a1afb52d2bfe8cf1602758e44a93f/uv-0.4.8-py3-none-win_amd64.whl.metadata
  Downloading uv-0.4.8-py3-none-win_amd64.whl.metadata (11 kB)
Downloading uv-0.4.8-py3-none-win_amd64.whl (12.7 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 12.7/12.7 MB 17.2 MB/s eta 0:00:00
Installing collected packages: uv
Successfully installed uv-0.4.8
WARNING: There was an error checking the latest version of pip.
(.venv) ~/Documents/appmana $ cd appmana-comfyui/src/
(.venv) ~/Documents/appmana/appmana-comfyui/src $ uv pip install --no-deps -e .
Resolved 1 package in 18ms
Installed 1 package in 14ms
 + comfyui==0.0.1 (from file:///C:/Users/bberman/Documents/appmana/appmana-comfyui/src)
(.venv) ~/Documents/appmana/appmana-comfyui/src $ comfyui -w ../../appmana-artworkspace/src/workdir/
Failed to close child file descriptors at 1
</code></pre>
<p>no, unfortunately the stubs still show the issue, they do work though</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2024-09-10 00:00</div>
            <div class="timeline-body"><p>Could you provide steps on how to reproduce this particular case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/doctorpangloss">@doctorpangloss</a> on 2024-09-10 00:25</div>
            <div class="timeline-body"><p>nervermind it's resolved! 0.4.8 has fixed it</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:34 UTC
    </footer>
</body>
</html>
