<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conflicting general dependency and extra transitive dependency - astral-sh/uv #9349</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Conflicting general dependency and extra transitive dependency</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/9349">#9349</a>
        opened by <a href="https://github.com/avicooper1">@avicooper1</a>
        on 2024-11-22 07:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/avicooper1">@avicooper1</a></div>
            <div class="timeline-body"><p>Linux, Python version 3.10, uv version 0.5.4</p>
<p>I am trying to set up the following set of requirements in my team&#x27;s project: I have dependency <code>A</code> for the project. I don&#x27;t care what the version <code>A</code> is, but would strongly prefer it be the latest version. I would also occasionally like to use dependency <code>B</code>. Dependency <code>B</code> has a transitive dependency which happens to be an old version of <code>A</code>.</p>
<p>Specifically, the project depends on <code>transformers</code>, and I&#x27;d like to have the latest version 4.46.3. I&#x27;d occasionally like to use <code>salesforce-lavis.</code> However the latest version of this library depends on <code>transformers&gt;=4.25.0,&lt;4.27</code>.</p>
<p>My goal is to be able to run my code with <code>transformers==4.46.3</code>, but if I set some flag, then it would be <code>transformers==4.26.1</code> (the version that gets resolved for <code>salesforce-lavis</code>.) For example,</p>
<pre><code>$ uv run python
&gt;&gt;&gt; import transformers
&gt;&gt;&gt; transformers.__version__
&#x27;4.46.3&#x27;
</code></pre>
<p>but if I run something else, it automatically changes the version:</p>
<pre><code>$ uv run --WITH_LAVIS python
&gt;&gt;&gt; import transformers
&gt;&gt;&gt; transformers.__version__
&#x27;4.26.1&#x27;
</code></pre>
<p>I have looked into using groups, optional dependancies, and extras. I&#x27;m not sure any of them solve what I am looking to do, and I&#x27;m wondering if there is any workaround.</p>
<hr>
<p>The farthest I&#x27;ve gotten is with the following <code>toml</code>:</p>
<pre><code>[project]
name = &quot;uv-test&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.10&quot;
dependencies = [
]

[dependency-groups]
lavis = [
    &quot;salesforce-lavis&gt;=1.0.2&quot;,
]
base = [
    &quot;transformers&gt;=4.46.3&quot;,
]

[tool.uv]
default-groups = [&quot;base&quot;]
conflicts = [
    [
      { group = &quot;base&quot; },
      { group = &quot;lavis&quot; },
    ],
]
</code></pre>
<p>now <code>uv run python</code> yields <code>transformers==4.46.3</code> and <code>uv run --only-group lavis python</code> yields <code>transformers==4.26.1</code>.</p>
<p>However there are some remaining problems with this approach:</p>
<ol>
<li>Ideally it would be easy to set up:</li>
</ol>
<pre><code>$ uv init
$ uv add transformers
$ uv add --group lavis salesforce-lavis
</code></pre>
<p>and the desired behavior would be achieved. However to get the above <code>toml</code> I needed to manually create the base group, set it to be the default, and to not conflict with the lavis group.</p>
<ol>
<li><p>Even with this approach, it doesn&#x27;t seem possible to upgrade <code>transformers</code> to the newest version. For example, starting with the same <code>toml</code>, but with an empty base dependency list, running <code>uv add --group base transformers</code> or <code>uv add --group base -U transformers</code> installs the same old version that&#x27;s already being used by <code>salesforce-lavis</code>.</p>
</li>
<li><p>It doesn&#x27;t seem like this approach would work if more dependencies were added outside of any group, (ie. inside <code>dependencies = []</code>.) I tried using <code>uv run --group lavis python</code> and it yields <code>transformers==4.46.3</code> (which itself seems like a bug to me.) If limited to using <code>--no-group</code> then if there is ever a new dependency that can be used by both base and lavis, <code>uv run --only-group lavis python</code> will not see it.</p>
</li>
</ol>
<hr>
<p>If there are any workarounds to achieve what I&#x27;m hoping to, I would greatly appreciate some direction! Thank you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-22 14:04</div>
            <div class="timeline-body"><p>Yeah for something like this you&#x27;ll need to edit the <code>pyproject.toml</code> manually -- it&#x27;s fairly complex and I don&#x27;t know that it would be easy to express in <code>uv add</code> even if we wanted to support it natively there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-22 14:05</div>
            <div class="timeline-body"><p>I think you should be able to <code>uv lock --upgrade-package transformers</code> to upgrade <code>transformers</code> from here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-22 14:05</div>
            <div class="timeline-body"><blockquote>
<p>I tried using uv run --group lavis python and it yields transformers==4.46.3 (which itself seems like a bug to me.)</p>
</blockquote>
<p>I think this should fail at runtime... Since it&#x27;s trying to install both conflicting groups. I consider that a bug.</p>
<p>(Filed: <a href="https://github.com/astral-sh/uv/issues/9355">astral-sh/uv#9355</a>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-22 14:06</div>
            <div class="timeline-body"><p>I would expect that you need to do <code>uv run --group lavis --no-group base python</code>. Or remove <code>base</code> from <code>default-groups</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-22 14:10</div>
            <div class="timeline-body"><p>I guess we could consider (1) removing default groups that conflict when you specify <code>--group lavis</code>, or (2) disabling default groups when you specify a group explicitly at all, but both of those seem slightly off to me. \cc @zanieb on CLI</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-22 14:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-22 15:42</div>
            <div class="timeline-body"><p>Yeah I don&#x27;t love the idea of automatically disabling default groups, though we could consider it if it&#x27;s super common. It seems like the first step is a more helpful error message.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fynnsu">@fynnsu</a> on 2024-11-22 17:41</div>
            <div class="timeline-body"><blockquote>
<p>I am trying to set up the following set of requirements in my team&#x27;s project: I have dependency A for the project. I don&#x27;t care what the version A is, but would strongly prefer it be the latest version. I would also occasionally like to use dependency B. Dependency B has a transitive dependency which happens to be an old version of A.</p>
</blockquote>
<p>I am also dealing with a similar issue. I have a package that depends on pytorch and I would like to always use that latest stable version when running things with <code>uv run</code>, etc. However, I have a github action that runs regularly and tests my package against the latest pytorch <strong>nightly</strong> version. So for that case only, I want to use a different pytorch version from a different index.</p>
<p>It would be great if there was a way to setup the dependencies with default versions but have the ability to override all defaults with a flag. It seems like the <code>--with</code> option does something similar (i.e. <code>--with torch&lt;2</code> will install <code>torch&lt;2</code> even if <code>torch&gt;2</code> is in my <code>pyproject.toml</code>) but only works with packages, not groups and doesn&#x27;t allow me to specify a different index (<code>uv run --with torch --index-url ...</code> doesn&#x27;t use the specified index for the <code>--with</code> install).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-22 19:27</div>
            <div class="timeline-body"><p>Wait, actually: <code>uv run --group lavis python</code> does error? Are you seeing something different @avicooper1?</p>
<pre><code>‚ùØ uv run --group lavis python
error: group `base`, group `lavis` are incompatible with the declared conflicts: {`uv-test:base`, `uv-test:lavis`}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-22 19:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-25 03:01</div>
            <div class="timeline-body"><p>Closing due to lack of follow-up.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-25 03:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/djsaunde">@djsaunde</a> on 2025-09-12 14:20</div>
            <div class="timeline-body"><p>I&#x27;m running into a similar issue with the following (simplified):</p>
<pre><code>[project]
dependencies = [&quot;torch&gt;=2.60&quot;]

[project.optional-dependencies]
vllm = [&quot;vllm&gt;=0.10.0&quot;]
</code></pre>
<p>When not installing vllm, I&#x27;d like to be able to resolve to <code>torch==2.8.0</code> by default, but latest vllm is pinned to <code>torch==2.7.1</code> for <a href="https://github.com/vllm-project/vllm/issues/9554#issuecomment-2426840976">reasons</a>.</p>
<p>Any solve for this?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:35:41 UTC
    </footer>
</body>
</html>
