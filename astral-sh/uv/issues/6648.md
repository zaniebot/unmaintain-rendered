```yaml
number: 6648
title: "shared env cache: copy fails on install"
type: issue
state: closed
author: stas00
labels: []
assignees: []
created_at: 2024-08-26T19:05:19Z
updated_at: 2024-08-27T06:27:33Z
url: https://github.com/astral-sh/uv/issues/6648
synced_at: 2026-01-10T01:57:14Z
```

# shared env cache: copy fails on install

---

_Issue opened by @stas00 on 2024-08-26 19:05_

This is a continuation of trying to use `uv` in a shared uv-cache https://github.com/astral-sh/uv/issues/5581

With `uv==0.3.3` we have a new issue:

The settings are:
```
export UV_LINK_MODE=copy
export UV_CACHE_DIR=/env/cache/uv
```

This is installing into a just-created fresh conda env:
```
$ conda create -y -n stas-test-123 python=3.10
$ pip install uv
$ uv pip install -e .
[...]
Prepared 1 package in 5.77s
Uninstalled 2 packages in 2.29s
error: Failed to install: setuptools-69.5.1-py3-none-any.http.whl (setuptools==69.5.1)
  Caused by: failed to copy file from /data/env/cache/uv/archive-v0/kYFrh3jfzM6r7gQ92HOcR/distutils-precedence.pth to /env/lib/conda/stas-test-123/lib/python3.10/site-packages/distutils-precedence.pth
  Caused by: Operation not permitted (os error 1)
```
The permissions are all correct so it shouldn't be failing.

```
ls -l /data/env/cache/uv/archive-v0/kYFrh3jfzM6r7gQ92HOcR/distutils-precedence.pth
-rw-rw-rw- 3 user1 user1 151 Aug 19 18:39 /data/env/cache/uv/archive-v0/kYFrh3jfzM6r7gQ92HOcR/distutils-precedence.pth

ls -l /env/lib/conda/stas-test-123/lib/python3.10/site-packages/distutils-precedence.pth
-rw-rw-rw- 8 user2 user2 0 Aug 26 18:48 /env/lib/conda/stas-test-123/lib/python3.10/site-packages/distutils-precedence.pth

ls -l /env/lib/conda/stas-test-123/lib/python3.10/ | grep site-pac
drwxrwxrwx  1 user3 user3    0 Aug 26 18:48 site-packages/
```

In fact I can copy the file just fine:
```
cp /data/env/cache/uv/archive-v0/kYFrh3jfzM6r7gQ92HOcR/distutils-precedence.pth /env/lib/conda/stas-test-123/lib/python3.10/site-packages/distutils-precedence.pth
```
no error and then if I rerun the command - uv pip install succeeds.

Please note 3 users are involved here. The source file is owned by user1, the destination file is owned by user2 and I'm user3 running `uv`.

Thank you.

@charliermarsh 


---

_Comment by @charliermarsh on 2024-08-26 19:06_

Interesting, thanks. Does this affect certain packages or files? E.g., is it always `.pth` files or something like that?

---

_Comment by @stas00 on 2024-08-26 19:09_

We have only run into this issue with `setuptools`, as you can see there are 3 versions of it each owned by one of the 3 users:

```
ls -l /data/env/cache/uv/archive-v0/*/distutils-precedence.pth
-rw-rw-rw- 1 user1 user2 151 Aug 21 01:23 /data/env/cache/uv/archive-v0/TwQKRNzosf4d3PUZv4Foa/distutils-precedence.pth
-rw-rw-rw- 1 user3 user3 151 Aug 15 19:07 /data/env/cache/uv/archive-v0/i-cXXyA_424PBsT1mucFi/distutils-precedence.pth
-rw-rw-rw- 3 user2 user2 151 Aug 19 18:39 /data/env/cache/uv/archive-v0/kYFrh3jfzM6r7gQ92HOcR/distutils-precedence.pth
```

---

_Comment by @stas00 on 2024-08-26 19:15_

Interesting, inspecting the logs from conda I run into this:

```
$ conda create -y -n stas-test-123 python=3.10
[...]
Downloading and Extracting Packages:

Preparing transaction: done
Verifying transaction: / 
SafetyError: The package for setuptools located at /env/cache/conda/pkgs/setuptools-72.2.0-pyhd8ed1ab_0
appears to be corrupted. The path 'site-packages/distutils-precedence.pth'
has an incorrect size.
  reported size: 151 bytes
  actual size: 0 bytes
```

so it looks like the first package came from conda.

Let me try and fix that by purging the bad conda cache package and retry

---

_Comment by @stas00 on 2024-08-26 19:19_

ok, that resolved the problem.

It's still odd why `uv` couldn't copy/overwrite the file, while a manual `cp` with the exact same args worked fine.

But unless you can think of something we can close this ticket.

---

_Comment by @stas00 on 2024-08-26 22:47_

I'm pretty convinced that it has to do with some IO failure on the shared network fs and nothing to do with `uv`, since we had other IO issues this morning. So I'm closing this.

---

_Closed by @stas00 on 2024-08-26 22:47_

---

_Comment by @charliermarsh on 2024-08-26 23:07_

Ok thanks for following up -- appreciate it. Please feel free to reopen in the future if you hit it again and think uv is involved.

---

_Comment by @stas00 on 2024-08-26 23:14_

Thank you for your amazing support, Charlie!

---
