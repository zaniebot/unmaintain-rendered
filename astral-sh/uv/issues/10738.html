<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dependency sorting issue in pyproject.toml - astral-sh/uv #10738</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Dependency sorting issue in pyproject.toml</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/10738">#10738</a>
        opened by <a href="https://github.com/Kavan72">@Kavan72</a>
        on 2025-01-18 19:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Kavan72">@Kavan72</a> on 2025-01-18 19:03</div>
            <div class="timeline-body"><p>Related issues</p>
<p>Relates to https://github.com/astral-sh/uv/issues/10076.</p>
<p>Setup</p>
<ul>
<li>uv 0.5.21</li>
<li>Python 3.10</li>
<li>macOS Sequoia 15.2</li>
</ul>
<p>pyproject.toml</p>
<pre><code class="language-toml">[project]
name = &quot;backend&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.10&quot;
dependencies = [
    &quot;aiohttp&gt;=3.11.11&quot;,
    &quot;alembic&gt;=1.14.0&quot;,
    &quot;asgi-correlation-id&gt;=4.3.4&quot;,
    &quot;asyncpg&gt;=0.30.0&quot;,
    &quot;celery&gt;=5.4.0&quot;,
    &quot;cryptography&gt;=44.0.0&quot;,
    &quot;email-validator&gt;=2.2.0&quot;,
    &quot;faker&gt;=33.3.0&quot;,
    &quot;fastapi-distributed-websocket&gt;=0.2.0&quot;,
    &quot;fastapi-pagination&gt;=0.12.34&quot;,
    &quot;fastapi[all]&gt;=0.115.6&quot;,
    &quot;gunicorn&gt;=23.0.0&quot;,
    &quot;loguru&gt;=0.7.3&quot;,
    &quot;pyjwt&gt;=2.10.1&quot;,
    &quot;pytest-order&gt;=1.3.0&quot;,
    &quot;pytest&gt;=8.3.4&quot;,
    &quot;sentry-sdk[fastapi]&gt;=2.19.2&quot;,
    &quot;sib-api-v3-sdk&gt;=7.6.0&quot;,
    &quot;sqlalchemy[asyncio]&gt;=2.0.36&quot;,
    &quot;sqlalchemy-utils&gt;=0.41.2&quot;,
    &quot;tomlkit&gt;=0.13.2&quot;,
    &quot;uvicorn&gt;=0.34.0&quot;,
    &quot;websockets&gt;=14.1&quot;,
    &quot;jsonschema&gt;=4.23.0&quot;,
]

[tool.pytest.ini_options]
minversion = &quot;6.0&quot;
addopts = &quot;-ra&quot;
testpaths = [
    &quot;tests&quot;,
]

[tool.uv]
dev-dependencies = [
    &quot;ruff&gt;=0.8.6&quot;,
]

[tool.ruff]
line-length = 100

[tool.ruff.lint]
select = [&quot;I&quot;, &quot;N&quot;, &quot;A&quot;, &quot;UP&quot;, &quot;F&quot;, &quot;E&quot;, &quot;T20&quot;]
</code></pre>
<p>When I try to remove and re-add jsonschema, which is already present, it gets added to the end of the dependencies.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-18 19:24</div>
            <div class="timeline-body"><p>You need to switch the order of <code>&quot;sqlalchemy[asyncio]&gt;=2.0.36&quot;</code> and <code>&quot;sqlalchemy-utils&gt;=0.41.2&quot;</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kavan72">@Kavan72</a> on 2025-01-18 19:38</div>
            <div class="timeline-body"><blockquote>
<p>You need to switch the order of <code>&quot;sqlalchemy[asyncio]&gt;=2.0.36&quot;</code> and <code>&quot;sqlalchemy-utils&gt;=0.41.2&quot;</code>.</p>
</blockquote>
<p>Sorry, I don't get you, you mean remove <code>&quot;sqlalchemy[asyncio]&gt;=2.0.36&quot;</code>, <code>&quot;sqlalchemy-utils&gt;=0.41.2&quot;</code>  and add <code>jsonschema</code> ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-18 19:41</div>
            <div class="timeline-body"><p>You need to swap the order, like:</p>
<pre><code class="language-toml">dependencies = [
    &quot;aiohttp&gt;=3.11.11&quot;,
    &quot;alembic&gt;=1.14.0&quot;,
    &quot;asgi-correlation-id&gt;=4.3.4&quot;,
    &quot;asyncpg&gt;=0.30.0&quot;,
    &quot;celery&gt;=5.4.0&quot;,
    &quot;cryptography&gt;=44.0.0&quot;,
    &quot;email-validator&gt;=2.2.0&quot;,
    &quot;faker&gt;=33.3.0&quot;,
    &quot;fastapi-distributed-websocket&gt;=0.2.0&quot;,
    &quot;fastapi-pagination&gt;=0.12.34&quot;,
    &quot;fastapi[all]&gt;=0.115.6&quot;,
    &quot;gunicorn&gt;=23.0.0&quot;,
    &quot;loguru&gt;=0.7.3&quot;,
    &quot;pyjwt&gt;=2.10.1&quot;,
    &quot;pytest-order&gt;=1.3.0&quot;,
    &quot;pytest&gt;=8.3.4&quot;,
    &quot;sentry-sdk[fastapi]&gt;=2.19.2&quot;,
    &quot;sib-api-v3-sdk&gt;=7.6.0&quot;,
    &quot;sqlalchemy-utils&gt;=0.41.2&quot;,
    &quot;sqlalchemy[asyncio]&gt;=2.0.36&quot;,
    &quot;tomlkit&gt;=0.13.2&quot;,
    &quot;uvicorn&gt;=0.34.0&quot;,
    &quot;websockets&gt;=14.1&quot;,
    &quot;jsonschema&gt;=4.23.0&quot;,
]
</code></pre>
<p>Notice how, earlier, you have <code>fastapi-distributed-websocket</code> before <code>fastapi</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-18 19:44</div>
            <div class="timeline-body"><p>We only retain sorting if dependencies are already sorted, and lexicographically, <code>sqlalchemy-utils</code> comes before <code>sqlalchemy</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-18 19:45</div>
            <div class="timeline-body"><p>I guess we could consider making the sort detection robust to these kinds of prefixes, but (e.g.) if you &quot;sort alphabetically&quot; in your editor, you should see the same result.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kavan72">@Kavan72</a> on 2025-01-19 05:25</div>
            <div class="timeline-body"><blockquote>
<p>We only retain sorting if dependencies are already sorted, and lexicographically, <code>sqlalchemy-utils</code> comes before <code>sqlalchemy</code>.</p>
</blockquote>
<p>The issue arose when I added some libraries with UV version 0.5.12 (which has a sorting issue: https://github.com/astral-sh/uv/issues/10076). This broke the sorting. After upgrading UV to the latest version, adding any extra library now results in it being appended to the end of the dependencies.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-19 14:19</div>
            <div class="timeline-body"><p>This is the order that uv considers sorted:</p>
<pre><code class="language-toml">dependencies = [
    &quot;aiohttp&gt;=3.11.11&quot;,
    &quot;alembic&gt;=1.14.0&quot;,
    &quot;asgi-correlation-id&gt;=4.3.4&quot;,
    &quot;asyncpg&gt;=0.30.0&quot;,
    &quot;celery&gt;=5.4.0&quot;,
    &quot;cryptography&gt;=44.0.0&quot;,
    &quot;email-validator&gt;=2.2.0&quot;,
    &quot;faker&gt;=33.3.0&quot;,
    &quot;fastapi-distributed-websocket&gt;=0.2.0&quot;,
    &quot;fastapi-pagination&gt;=0.12.34&quot;,
    &quot;fastapi[all]&gt;=0.115.6&quot;,
    &quot;gunicorn&gt;=23.0.0&quot;,
    &quot;loguru&gt;=0.7.3&quot;,
    &quot;pyjwt&gt;=2.10.1&quot;,
    &quot;pytest&gt;=8.3.4&quot;,
    &quot;pytest-order&gt;=1.3.0&quot;,
    &quot;sentry-sdk[fastapi]&gt;=2.19.2&quot;,
    &quot;sib-api-v3-sdk&gt;=7.6.0&quot;,
    &quot;sqlalchemy-utils&gt;=0.41.2&quot;,
    &quot;sqlalchemy[asyncio]&gt;=2.0.36&quot;,
    &quot;tomlkit&gt;=0.13.2&quot;,
    &quot;uvicorn&gt;=0.34.0&quot;,
    &quot;websockets&gt;=14.1&quot;,
]
</code></pre>
<p>I don't <em>think</em> any version of uv would consider the dependencies you posted sorted, even prior to 0.5.12, because <code>sqlalchemy-utils</code> needs to come after <code>sqlalchemy[asyncio]</code> lexicographically, and you have the order reversed.</p>
<p>Again, please try this version and run <code>uv add</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Kavan72 on 2025-01-25 17:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wu-clan">@wu-clan</a> on 2025-02-07 03:17</div>
            <div class="timeline-body"><p>Hi, @charliermarsh</p>
<p>This is my dependencies:</p>
<pre><code class="language-toml">dependencies = [
    &quot;alembic&gt;=1.14.1&quot;,
    &quot;asgiref&gt;=3.8.0&quot;,
    &quot;asyncmy&gt;=0.2.10&quot;,
    &quot;asyncpg&gt;=0.30.0&quot;,
    &quot;bcrypt&gt;=4.2.1&quot;,
    &quot;casbin&gt;=1.38.0&quot;,
    &quot;casbin_async_sqlalchemy_adapter&gt;=1.7.0&quot;,
    &quot;celery==5.3.6&quot;,
    &quot;cryptography&gt;=44.0.0&quot;,
    &quot;fast-captcha&gt;=0.3.2&quot;,
    &quot;fastapi[all]==0.111.0&quot;,
    &quot;fastapi-limiter&gt;=0.1.6&quot;,
    &quot;fastapi-pagination&gt;=0.12.34&quot;,
    &quot;itsdangerous&gt;=2.2.0&quot;,
    &quot;loguru&gt;=0.7.3&quot;,
    &quot;msgspec&gt;=0.19.0&quot;,
    &quot;pwdlib&gt;=0.2.1&quot;,
    &quot;path==17.0.0&quot;,
    &quot;phonenumbers&gt;=8.13.0&quot;,
    &quot;psutil&gt;=6.0.0&quot;,
    &quot;pydantic&gt;=2.10.6&quot;,
    &quot;python-jose&gt;=3.3.0&quot;,
    &quot;redis[hiredis]&gt;=5.2.0&quot;,
    &quot;sqlalchemy[asyncio]&gt;=2.0.30&quot;,
    &quot;user-agents==2.2.0&quot;,
    &quot;XdbSearchIP&gt;=1.0.2&quot;,
    &quot;fastapi_oauth20&gt;=0.0.1a2&quot;,
    &quot;flower&gt;=2.0.0&quot;,
    &quot;sqlalchemy-crud-plus==1.6.0&quot;,
    &quot;jinja2&gt;=3.1.4&quot;,
    &quot;aiofiles&gt;=24.1.0&quot;,
    # When celery version &lt; 6.0.0
    # https://github.com/celery/celery/issues/7874
    &quot;celery-aio-pool==0.1.0rc8&quot;,
    &quot;asgi-correlation-id&gt;=4.3.3&quot;,
    &quot;python-socketio&gt;=5.12.0&quot;,
]
</code></pre>
<p>It did not sort as expected, and whenever I add any dependencies, they are always added to the end</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-07 03:18</div>
            <div class="timeline-body"><p>We only retain sorting if the dependencies are already sorted. The list you gave above is out-of-order?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wu-clan">@wu-clan</a> on 2025-02-07 03:23</div>
            <div class="timeline-body"><p>The dependencies order after <code>&quot;XdbSearchIP&gt;=1.0.2&quot;,</code> does not seem to be sorted alphabetically, and my view on sorting is that they are always parsed and sorted alphabetically, but I did not find any related information in the documentation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-07 03:28</div>
            <div class="timeline-body"><p>If your dependencies are <em>already</em> sorted, then we add in sorted order. If they're not, we add to the end.</p>
<p>Here's the sorted version of the dependencies up to and including <code>XdbSearchIP</code>:</p>
<pre><code class="language-toml">dependencies = [
    &quot;alembic&gt;=1.14.1&quot;,
    &quot;asgiref&gt;=3.8.0&quot;,
    &quot;asyncmy&gt;=0.2.10&quot;,
    &quot;asyncpg&gt;=0.30.0&quot;,
    &quot;bcrypt&gt;=4.2.1&quot;,
    &quot;casbin&gt;=1.38.0&quot;,
    &quot;casbin_async_sqlalchemy_adapter&gt;=1.7.0&quot;,
    &quot;celery==5.3.6&quot;,
    &quot;cryptography&gt;=44.0.0&quot;,
    &quot;fast-captcha&gt;=0.3.2&quot;,
    &quot;fastapi-limiter&gt;=0.1.6&quot;,
    &quot;fastapi-pagination&gt;=0.12.34&quot;,
    &quot;fastapi[all]==0.111.0&quot;,
    &quot;itsdangerous&gt;=2.2.0&quot;,
    &quot;loguru&gt;=0.7.3&quot;,
    &quot;msgspec&gt;=0.19.0&quot;,
    &quot;path==17.0.0&quot;,
    &quot;phonenumbers&gt;=8.13.0&quot;,
    &quot;psutil&gt;=6.0.0&quot;,
    &quot;pwdlib&gt;=0.2.1&quot;,
    &quot;pydantic&gt;=2.10.6&quot;,
    &quot;python-jose&gt;=3.3.0&quot;,
    &quot;redis[hiredis]&gt;=5.2.0&quot;,
    &quot;sqlalchemy[asyncio]&gt;=2.0.30&quot;,
    &quot;user-agents==2.2.0&quot;,
    &quot;XdbSearchIP&gt;=1.0.2&quot;,
]
</code></pre>
<p>There were a few errors in your existing sort:</p>
<pre><code class="language-diff">--- a/pyproject.toml
+++ b/pyproject.toml
@@ -15,16 +15,16 @@ dependencies = [
     &quot;celery==5.3.6&quot;,
     &quot;cryptography&gt;=44.0.0&quot;,
     &quot;fast-captcha&gt;=0.3.2&quot;,
-    &quot;fastapi[all]==0.111.0&quot;,
     &quot;fastapi-limiter&gt;=0.1.6&quot;,
     &quot;fastapi-pagination&gt;=0.12.34&quot;,
+    &quot;fastapi[all]==0.111.0&quot;,
     &quot;itsdangerous&gt;=2.2.0&quot;,
     &quot;loguru&gt;=0.7.3&quot;,
     &quot;msgspec&gt;=0.19.0&quot;,
-    &quot;pwdlib&gt;=0.2.1&quot;,
     &quot;path==17.0.0&quot;,
     &quot;phonenumbers&gt;=8.13.0&quot;,
     &quot;psutil&gt;=6.0.0&quot;,
+    &quot;pwdlib&gt;=0.2.1&quot;,
     &quot;pydantic&gt;=2.10.6&quot;,
     &quot;python-jose&gt;=3.3.0&quot;,
     &quot;redis[hiredis]&gt;=5.2.0&quot;,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wu-clan">@wu-clan</a> on 2025-02-07 03:42</div>
            <div class="timeline-body"><p>Thank you very much.</p>
<p>I want to know whether should add some documentation/console output for dependency sorting explanation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhimmel">@dhimmel</a> on 2025-04-11 18:31</div>
            <div class="timeline-body"><blockquote>
<p>I guess we could consider making the sort detection robust to these kinds of prefixes, but (e.g.) if you &quot;sort alphabetically&quot; in your editor, you should see the same result.</p>
</blockquote>
<p>@charliermarsh that would be awesome.</p>
<p>Or at least a recommendation on this thread for a tool that sorts dependencies since IDE sorting differs.</p>
<p>Or perhaps a pyproject option to tell <code>uv</code> to always sort?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/13334.html">astral-sh/uv#13334</a> on 2025-05-07 17:58</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:25 UTC
    </footer>
</body>
</html>
