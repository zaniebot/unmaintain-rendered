<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv lock` resolves wrong version when using git source + dynamic version field in (optional) dependency - astral-sh/uv #16110</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>uv lock</code> resolves wrong version when using git source + dynamic version field in (optional) dependency</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/16110">#16110</a>
        opened by <a href="https://github.com/pausz">@pausz</a>
        on 2025-10-03 05:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/pausz">@pausz</a> on 2025-10-03 05:45</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I have two packages, <a href="https://github.com/pausz/package_a">package_a</a> and <a href="https://github.com/pausz/package_b">package_b</a>, where package_b depends on package_a.</p>
<ul>
<li><p><code>package_b</code> specifies <code>package_a&gt;2.0.0</code> in its optional dependencies. This is on purpose to highlight the issue.</p>
</li>
<li><p>In addition, <code>package_b</code> configures a uv (git) source pointing to a branch of <code>package_a</code> (uv-test/version-1) where the version is 1.0.0 (with a dynamic version field via hatchling) -- also done on purpose to illustrate the problem.</p>
</li>
</ul>
<p>I'm using <code>uv lock</code> to generate package_b's lock file for the first time.</p>
<h4>package_b's pyproject.toml</h4>
<pre><code class="language-toml">[project]
name = &quot;package-b&quot;
version = &quot;0.5.0&quot;
requires-python = &quot;&gt;=3.12&quot;

[project.optional-dependencies]
models = [
    &quot;package_a&gt;2.0.0&quot;,
]

[tool.uv.sources]
package-a = { git = &quot;ssh://git@github.com/pausz/package_a.git&quot;, branch = &quot;uv-test/version-1&quot; }
</code></pre>
<p><code>package_a/pyproject.toml</code> (excerpt):</p>
<pre><code class="language-toml">[tool.hatch.version]
path = &quot;src/package_a/version.py&quot;
</code></pre>
<h3>Observed unexpected behaviour</h3>
<p>From the verbose logs:</p>
<ul>
<li>uv attempts to fetch static metadata but fails because the version is dynamic.</li>
<li>It falls back to using the existing source.</li>
</ul>
<p>package_b's lockfile ends up including package_a==1.0.0, despite package_b requiring package_a&gt;2.0.0. This is the funny part, because, in practical terms, it means the version number of <code>package_a</code> can be extracted if it ends up in the lock file.</p>
<p>NOTE: This occurs whether package_a is defined as an optional dependency or base dependency of package_b.</p>
<p>Snippet from running <code>uv lock --verbose</code> in package_b (complete logs attached):</p>
<pre><code class="language-bash">DEBUG Attempting GitHub fast path for: package-a @ git+ssh://git@github.com/pausz/package_a.git@uv-test/version-1
DEBUG Querying GitHub for commit at: https://api.github.com/repos/pausz/package_a/commits/uv-test/version-1
DEBUG Attempting to fetch `pyproject.toml` from: https://raw.githubusercontent.com/pausz/package_a/400f4dec55e0685348c5ce7156e09c72da663c5d/pyproject.toml
DEBUG Failed to extract static metadata from GitHub API for: https://raw.githubusercontent.com/pausz/package_a/400f4dec55e0685348c5ce7156e09c72da663c5d/pyproject.toml
DEBUG Fetching source distribution from Git: ssh://git@github.com/pausz/package_a.git
DEBUG Acquired lock for `ssh://github.com/pausz/package_a`
DEBUG Using existing Git source `ssh://git@github.com/pausz/package_a.git`
DEBUG Released lock at `/home/psanz-leon/.cache/uv/git-v0/locks/c18cd15c7f661949`
DEBUG Acquired lock for `/home/psanz-leon/.cache/uv/sdists-v9/git/a44c012e829cfba8/400f4dec55e06853`
DEBUG No static `pyproject.toml` available for: package-a @ git+ssh://git@github.com/pausz/package_a.git@uv-test/version-1 (DynamicField(&quot;version&quot;))
DEBUG No static `PKG-INFO` available for: package-a @ git+ssh://git@github.com/pausz/package_a.git@uv-test/version-1 (MissingPkgInfo)
DEBUG Using cached metadata for: package-a @ git+ssh://git@github.com/pausz/package_a.git@uv-test/version-1

</code></pre>
<h3>Expected behaviour</h3>
<ul>
<li>If the uv source references to a version of the package that does not meet the declared requirement, I’d expect uv to:<ul>
<li>fail resolution with an error, or</li>
<li>correctly evaluate the dynamic version from the source, rather than silently falling back to a stale version.</li>
</ul>
</li>
</ul>
<h3>Questions</h3>
<p>... because it's entirely possible I may have misunderstood how uv + hatchling are supposed to work together. We are not using uv native's build backend yet, because we're still tracking our versioning with the <code>__version__</code> attribute either in  <code>__init__.py</code> or <code>version.py</code></p>
<ul>
<li>Should uv attempt to evaluate hatchling’s dynamic version in this case?</li>
<li>Or is it actually expected that a git source with dynamic versions can bypass constraint checks, and a workaround is needed?</li>
</ul>
<h3>Platform</h3>
<p>Ubuntu 24.04.3 LTS</p>
<h3>Version</h3>
<p>0.8.22</p>
<h3>Python version</h3>
<p>3.12.3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @pausz on 2025-10-03 05:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pausz">@pausz</a> on 2025-10-03 05:48</div>
            <div class="timeline-body"><p><a href="https://github.com/user-attachments/files/22674936/logs_uv_lock_package_b.txt">logs_uv_lock_package_b.txt</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pausz">@pausz</a> on 2025-10-03 05:49</div>
            <div class="timeline-body"><p>Resulting lock file:
<a href="https://github.com/user-attachments/files/22674949/uv.lock.txt">uv.lock.txt</a></p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:08 UTC
    </footer>
</body>
</html>
