<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv config file discovery avoiding filesystem traversal (because resolution blows up with unexpected directory called uv.toml) - astral-sh/uv #7351</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv config file discovery avoiding filesystem traversal (because resolution blows up with unexpected directory called uv.toml)</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/7351">#7351</a>
        opened by <a href="https://github.com/pelson">@pelson</a>
        on 2024-09-13 08:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/pelson">@pelson</a></div>
            <div class="timeline-body"><p>Firstly, the reproducer:</p>
<pre><code>$ mkdir uv.toml
$ uv pip install --python ./venv/bin/python setuptools
error: failed to read from file `./uv.toml`
  Caused by: Is a directory (os error 21)
</code></pre>
<p><code>uv</code> version <code>0.4.9</code></p>
<p>(I don't actually propose that this behaviour changes!)</p>
<hr />
<p>This sounds like a pathological case (and it probably is), but it hit me in real-life today... I was using <code>uv</code> to install into a location which mounted through NFS. On my system, my sys admins have a special mount point at <code>/nfs</code> which will mkdir when you stat in the <code>/nfs/</code> root, and hence uv triggered the creation of a directory at <code>/nfs/uv.toml</code> upon stat.</p>
<p>I'm reporting this here because I think it is worth highlighting. Honestly, I think probably <code>uv</code> is right to fail when there is a directory called <code>uv.toml</code>, just like it fails when <code>uv.toml</code> is a file with invalid TOML syntax. However, it is worth noting that such a filesystem does not trigger <code>git</code> to trip up when searching for a parent repo:</p>
<pre><code>$ cd /nfs/the-key-mountpoint/foo/bar; git status
fatal: not a git repository (or any parent up to mount point /nfs/the-key-mountpoint)
Stopping at filesystem boundary (GIT_DISCOVERY_ACROSS_FILESYSTEM not set).
</code></pre>
<p>And luckily, it even works when <code>cd /nfs</code> directly (I think because it finds a <code>.git</code> directory, but it then fails to find the <code>.git/HEAD</code> file (and there is no magic on the subdirectory level of my mount point).</p>
<p>Concretely, an option which could help here, and which would IMO be reasonable (and quicker), would be to refuse to traverse filesystems when walking the tree for possible config locations. In principle I think this is done by checking <code>stat::st_dev</code> / <code>MetadataExt.dev()</code> is unchanged when accessing the parent.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-09-13 13:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-14 03:36</div>
            <div class="timeline-body"><p>It seems reasonable to me to follow Git's lead here (stop at filesystem boundaries with an env var to override) \cc @zanieb</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:27:06 UTC
    </footer>
</body>
</html>
