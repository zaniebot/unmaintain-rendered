<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uv sources marker extra is not resolving a package correctly - astral-sh/uv #11860</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Uv sources marker extra is not resolving a package correctly</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/11860">#11860</a>
        opened by <a href="https://github.com/krystianMoras">@krystianMoras</a>
        on 2025-02-28 16:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/krystianMoras">@krystianMoras</a> on 2025-02-28 16:38</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>To reproduce, example pyproject.toml</p>
<pre><code>[project]
name = &quot;test-uv&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = [
    &quot;pytube&gt;=15.0.0&quot;,
]

[project.optional-dependencies]
dev = []

[[tool.uv.index]]
name = &quot;my_index&quot;
url = &quot;https://pypi.org/simple&quot;


[tool.uv.sources]
pytube = [
    { index = &quot;my_index&quot;, marker = &quot;extra!='dev'&quot;},
    { path = &quot;./pytube&quot;, editable = true, marker = &quot;extra=='dev'&quot;}
]
</code></pre>
<p>Running <code> uv sync --extra=dev</code> will correctly install pytube from my path as editable</p>
<pre><code>DEBUG uv 0.6.3 (a0b9f22a2 2025-02-24)
DEBUG Found project root: `/Users/krystianmoras/Documents/test-uv`
DEBUG No workspace root found, using project root
DEBUG Acquired lock for `/Users/krystianmoras/Documents/test-uv`
DEBUG Reading Python requests from version file at `/Users/krystianmoras/Documents/test-uv/.python-version`
DEBUG Using Python request `3.12` from version file at `.python-version`
DEBUG Checking for Python environment at `.venv`
DEBUG The virtual environment's Python version satisfies `3.12`
DEBUG Released lock at `/var/folders/1_/btj1k7sn3ls02qcwrbhlp5zc0000gp/T/uv-046f04b84c3c71d1.lock`
DEBUG Using request timeout of 30s
DEBUG Found static `pyproject.toml` for: test-uv @ file:///Users/krystianmoras/Documents/test-uv
DEBUG No workspace root found, using project root
DEBUG Found static `pyproject.toml` for: pytube @ file:///Users/krystianmoras/Documents/test-uv/pytube
DEBUG Project is contained in non-workspace project: `/Users/krystianmoras/Documents/test-uv`
DEBUG No workspace root found, using project root
DEBUG Existing `uv.lock` satisfies workspace requirements
Resolved 2 packages in 0.72ms
DEBUG Using request timeout of 30s
DEBUG Directory source requirement already cached: pytube==0.1.0 (from file:///Users/krystianmoras/Documents/test-uv/pytube)
Installed 1 package in 2ms
 + pytube==0.1.0 (from file:///Users/krystianmoras/Documents/test-uv/pytube)
</code></pre>
<p>However running just <code>uv sync</code> should resolve to use 'my_index', instead pytube package is uninstalled</p>
<pre><code>DEBUG uv 0.6.3 (a0b9f22a2 2025-02-24)
DEBUG Found project root: `/Users/krystianmoras/Documents/test-uv`
DEBUG No workspace root found, using project root
DEBUG Acquired lock for `/Users/krystianmoras/Documents/test-uv`
DEBUG Reading Python requests from version file at `/Users/krystianmoras/Documents/test-uv/.python-version`
DEBUG Using Python request `3.12` from version file at `.python-version`
DEBUG Checking for Python environment at `.venv`
DEBUG The virtual environment's Python version satisfies `3.12`
DEBUG Released lock at `/var/folders/1_/btj1k7sn3ls02qcwrbhlp5zc0000gp/T/uv-046f04b84c3c71d1.lock`
DEBUG Using request timeout of 30s
DEBUG Found static `pyproject.toml` for: test-uv @ file:///Users/krystianmoras/Documents/test-uv
DEBUG No workspace root found, using project root
DEBUG Found static `pyproject.toml` for: pytube @ file:///Users/krystianmoras/Documents/test-uv/pytube
DEBUG Project is contained in non-workspace project: `/Users/krystianmoras/Documents/test-uv`
DEBUG No workspace root found, using project root
DEBUG Existing `uv.lock` satisfies workspace requirements
Resolved 2 packages in 0.75ms
DEBUG Using request timeout of 30s
DEBUG Unnecessary package: pytube==0.1.0 (from file:///Users/krystianmoras/Documents/test-uv/pytube)
DEBUG Uninstalled pytube (10 files, 1 directory)
Uninstalled 1 package in 0.61ms
 - pytube==0.1.0 (from file:///Users/krystianmoras/Documents/test-uv/pytube)
</code></pre>
<p>I know of existence of workspaces, I'm just trying to illustrate the problem. This is a different problem where we want to be able to specify different package sources including our private indices.</p>
<p>This is an attempt to go around limitations of not being able to have multiple pyproject.toml and no flags that would enable selecting sources. Perhaps it could be solved if sources were allowed in uv.toml https://github.com/astral-sh/uv/issues/6772</p>
<p>We already have a workaround where we build a package and generate an index with <code>dumb-pypi</code> + <code>uv sync --index $LOCAL_INDEX_PATH --no-sources</code> however it would be much easier to omit that building step.</p>
<p>Nevertheless I think this is a bug and if <code>marker = &quot;extra!='dev'&quot;</code> it should install from <code>my_index</code></p>
<h3>Platform</h3>
<p>all</p>
<h3>Version</h3>
<p>uv 0.6.3 (a0b9f22a2 2025-02-24)</p>
<h3>Python version</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @krystianMoras on 2025-02-28 16:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-28 21:09</div>
            <div class="timeline-body"><p>Hmm, we don't support extras in that <code>marker</code> field. I think it would be dubious to allow extras to modify packages that aren't installed as part of that extra. In general, you can put <code>extra = &quot;dev&quot;</code> on sources to ensure that a source only applies when an dependecy is included as part of an optional group.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @charliermarsh on 2025-02-28 21:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2025-02-28 21:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-03-14 00:38</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:33:01 UTC
    </footer>
</body>
</html>
