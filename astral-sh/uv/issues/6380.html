<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Using uv to install coverage with toml extra as a dev dep gives error when generating lock file - astral-sh/uv #6380</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Using uv to install coverage with toml extra as a dev dep gives error when generating lock file</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/6380">#6380</a>
        opened by <a href="https://github.com/taranlu-houzz">@taranlu-houzz</a>
        on 2024-08-21 21:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/taranlu-houzz">@taranlu-houzz</a> on 2024-08-21 21:38</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

<p>If you install <code>coverage[toml]</code> as a dev dep, <code>uv</code> will complain about with the following error when running <code>uv lock</code>:</p>
<pre><code>‚ùØ uv lock
Failed to parse lockfile; ignoring locked requirements: for package `uv-coverage-with-toml-extra-bug==0.1.0 @ editable+.:dev`, found duplicate dependency `coverage==7.6.1 @ registry+https://pypi.org/simple`
Resolved 2 packages in 3ms
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-21 21:43</div>
            <div class="timeline-body"><p>Can you help me with a reproduction?</p>
<pre><code>‚ùØ uv add &quot;coverage&quot; --dev --extra toml
Resolved 3 packages in 226ms
   Built foo @ file:///Users/crmarsh/workspace/puffin/foo
Prepared 3 packages in 330ms
Installed 3 packages in 1ms
 + coverage==7.6.1
 + foo==0.1.0 (from file:///Users/crmarsh/workspace/puffin/foo)
 + tomli==2.0.1
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-21 21:44</div>
            <div class="timeline-body"><p>Could you share the <code>pyproject.toml</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/taranlu-houzz">@taranlu-houzz</a> on 2024-08-21 21:45</div>
            <div class="timeline-body"><pre><code class="language-toml">[project]
name = &quot;uv-coverage-with-toml-extra-bug&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = []

[build-system]
requires = [&quot;hatchling&quot;]
build-backend = &quot;hatchling.build&quot;

[tool.uv]
dev-dependencies = [
    &quot;coverage[toml]&gt;=7.6.1&quot;,
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/taranlu-houzz">@taranlu-houzz</a> on 2024-08-21 21:46</div>
            <div class="timeline-body"><p>Interestingly, it doesn't show up when I add the dep. It is only afterward when I run something that touches the lock file (e.g. <code>uv lock</code>).</p>
<pre><code>‚Üì2 ~/Documents/uv_coverage_with_toml_extra_bug is üì¶ v0.1.0 via üêç v3.12.1
‚ùå 2 ‚ùØ uv remove coverage --dev
Failed to parse lockfile; ignoring locked requirements: for package `uv-coverage-with-toml-extra-bug==0.1.0 @ editable+.:dev`, found duplicate dependency `coverage==7.6
.1 @ registry+https://pypi.org/simple`
Resolved 1 package in 20ms
   Built uv-coverage-with-toml-extra-bug @ file:///Users/taran/Documents/uv_coverage_with_toml_extra_bug
Prepared 1 package in 356ms
Uninstalled 2 packages in 17ms
Installed 1 package in 1ms
 - coverage==7.6.1
 ~ uv-coverage-with-toml-extra-bug==0.1.0 (from file:///Users/taran/Documents/uv_coverage_with_toml_extra_bug)

‚Üì2 ~/Documents/uv_coverage_with_toml_extra_bug is üì¶ v0.1.0 via üêç v3.12.1
‚ùØ uv add coverage --extra toml --dev
Resolved 2 packages in 10ms
   Built uv-coverage-with-toml-extra-bug @ file:///Users/taran/Documents/uv_coverage_with_toml_extra_bug
Prepared 2 packages in 220ms
Uninstalled 1 package in 1ms
Installed 2 packages in 3ms
 + coverage==7.6.1
 ~ uv-coverage-with-toml-extra-bug==0.1.0 (from file:///Users/taran/Documents/uv_coverage_with_toml_extra_bug)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-21 21:53</div>
            <div class="timeline-body"><p>I was able to replicate! Not sure how yet though. Fixing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-08-21 21:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-08-21 21:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-21 21:55</div>
            <div class="timeline-body"><p>Ok, I think it's because the <code>toml</code> extra <em>does</em> exist but doesn't actually activate any dependencies for Python &gt;= 3.12. If you change <code>requires-python = &quot;&gt;=3.10&quot;</code>, it works as expected.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/taranlu-houzz">@taranlu-houzz</a> on 2024-08-21 21:57</div>
            <div class="timeline-body"><p>Ah, I assume that is because the toml loading part of <code>tomli</code> got integrated into the Python stdlib? In that case, I suppose I don't need that extra.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-21 21:58</div>
            <div class="timeline-body"><p>Yeah that's right. We should still fix it though haha.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/6383.html">astral-sh/uv#6383</a> on 2024-08-21 22:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-21 22:24</div>
            <div class="timeline-body"><p>Fixed in https://github.com/astral-sh/uv/pull/6383, and used <code>coverage[toml]</code> as a test case, that's a good one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/taranlu-houzz">@taranlu-houzz</a> on 2024-08-21 22:33</div>
            <div class="timeline-body"><p>Awesome! Thanks for the speedy fix!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @taranlu-houzz on 2024-08-21 22:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-21 22:34</div>
            <div class="timeline-body"><p>Thanks for filing, that's a good bug!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:21 UTC
    </footer>
</body>
</html>
