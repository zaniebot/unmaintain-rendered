<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>On Windows, Running `uv run ruff server` locks all `ruff.exe` files in ALL virtual environments created by uv. - astral-sh/uv #13836</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>On Windows, Running <code>uv run ruff server</code> locks all <code>ruff.exe</code> files in ALL virtual environments created by uv.</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/13836">#13836</a>
        opened by <a href="https://github.com/momostein">@momostein</a>
        on 2025-06-04 13:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/momostein">@momostein</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<h2>Context</h2>
<p>I use PyCharm with the Ruff plugin on Windows. That plugin runs ruff server in the background. I am currently migrating my projects to uv. We currently use <a href="https://nox.thea.codes/en/stable/index.html">Nox</a> to test and lint our code against multiple Python versions. It creates a new isolated virtual environment for each session to run the tests or the linter</p>
<p>However, after switching over to uv, the linting Nox sessions would fail because they couldn't clean up their virtual  environments. After inspecting the virtual environment folder, only <code>Scripts/ruff.exe</code> was left. After closing PyCharm (and thus terminating the background <code>ruff server</code> process), it would work again.</p>
<h2>Steps to Reproduce</h2>
<p>You don't need nox to reproduce this bug. You just need uv and powershell.
To reproduce this bug:</p>
<ol>
<li>Create two folders, <code>foo</code> and <code>bar</code></li>
<li>Create a venv in each folder</li>
<li>Install <code>ruff</code> in both</li>
<li>Run <code>ruff server</code> in the <code>foo/.venv/</code> environment</li>
<li>Try to delete <code>bar/.venv/</code> while the ruff server is still running</li>
</ol>
<h3>Powershell Commands</h3>
<h4><code>foo</code></h4>
<pre><code class="language-ps1">mkdir foo
cd foo

uv venv
uv pip install ruff

uv run ruff server
</code></pre>
<h4><code>bar</code></h4>
<pre><code class="language-ps1">mkdir bar
cd bar

uv venv
uv pip install ruff

rm -r .venv
</code></pre>
<h3>Expected Outcome</h3>
<p>I expect <code>bar/.venv</code> to be deleted without error. I expect it to be independent of the <code>foo/.venv/</code> environment.</p>
<h3>Actual Outcome</h3>
<p>I get an error like this:</p>
<pre><code>rm : Cannot remove item foo\.venv\Scripts\ruff.exe: Access to the path 'ruff.exe' is denied.
</code></pre>
<p>And only <code>bar/.venv/Scripts/ruff.exe</code> remains.</p>
<h2>This only happens with uv Virtual Environments</h2>
<p>I've also tried it with the vanilla Python virtual environments and there was no issue.</p>
<h2>Current workaround</h2>
<p>Using a global ruff installation with <code>uv tool install ruff</code> to then just run <code>ruff server</code> does not lock the virtual environment <code>ruff.exe</code> files. I can edit my plugin settings to use the global ruff instead of the local ruff.</p>
<p>Another option could be using Windows Subsystem for Linux as this issue does not exist on Linux.</p>
<h3>Platform</h3>
<p>Windows 10 x86_64</p>
<h3>Version</h3>
<p>uv 0.7.10 (1e5120e15 2025-06-03)</p>
<h3>Python version</h3>
<p>Python 3.13.1</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @momostein on 2025-06-04 13:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "On Windows, Running `uv run ruff server` locks all `ruff.exe` files in *ALL* virtual environments created by uv." to "On Windows, Running `uv run ruff server` locks all `ruff.exe` files in ALL virtual environments created by uv." by @momostein on 2025-06-04 13:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-06-04 14:06</div>
            <div class="timeline-body"><p>Thank you for the detailed write-up, this is duplicate of https://github.com/astral-sh/uv/issues/11134. You can use <code>--link-mode copy</code> when installing ruff as a workaround.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/momostein">@momostein</a> on 2025-06-04 14:18</div>
            <div class="timeline-body"><p>The link-mode workaround fixes my issues.</p>
<p>I have added the following line to my global <code>%AppData%/uv/uv.toml</code> config file on my Windows environment:</p>
<pre><code class="language-toml">link-mode = &quot;copy&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-06-04 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/momostein">@momostein</a> on 2025-06-04 14:29</div>
            <div class="timeline-body"><p>On closer inspection of #11134, I concede that my Issue is very closely linked to it but it might not be a duplicate.</p>
<p>In my case, I'm trying to modify a different <code>ruff.exe</code> than the one being run as a server. Ok, behind the scenes of uv, they might hard link to the same <code>ruff.exe</code> file but I don't see how I shouldn't be able to delete the hard link that's not being run?</p>
<p>The main issue of #11134 is that trying to remove the <code>ruff.exe</code> that is actually running, leaves uv in an invalid state because <code>uv remove</code> is not <em>atomic</em>.</p>
<p>Can you please elaborate why you would still mark this as a duplicate?</p>
<p>Is it because that's just how hard links work on windows and we won't be able to fix this for uv?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/momostein">@momostein</a> on 2025-06-04 14:47</div>
            <div class="timeline-body"><p>Ok, after messing around myself with hard links and background processes, it seems that you can't delete a hard link to an executable that's running. Even through another hard link.</p>
<p>So yeah, my issue is not really a uv bug, but an issue with hard links themselves...</p>
<p>Therefore, I think that &quot;hardlink&quot; might not be the right default link-mode for Windows to begin with, but it's easily fixed through configuration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-06-04 14:53</div>
            <div class="timeline-body"><p>That's the problem we're tracking in #11134, we may want a different link mode for executables on Windows.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/momostein">@momostein</a> on 2025-06-04 15:01</div>
            <div class="timeline-body"><p>Thanks for the explanation. <code>link-mode = &quot;copy&quot;</code> would probably be the safest in most cases. I'm now trying out <code>link-mode = &quot;symlink&quot;</code> and it seems to work quite well. I can even delete the ruff.exe symlink that's actually running at the same time.</p>
<p>But I would not know what man-made horrors lie beyond my comprehension in terms of cache safety...</p>
<p>You're doing great work!</p>
<p>Thank you for bearing with me üëç</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:31:40 UTC
    </footer>
</body>
</html>
