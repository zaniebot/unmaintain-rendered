<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Failed to install a package from a public url on 0.1.33 - astral-sh/uv #3123</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Failed to install a package from a public url on 0.1.33</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/3123">#3123</a>
        opened by <a href="https://github.com/mgaitan">@mgaitan</a>
        on 2024-04-18 15:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/mgaitan">@mgaitan</a> on 2024-04-18 15:09</div>
            <div class="timeline-body"><p>since yesterday, we are experimented this issue</p>
<pre><code> &gt; [worker  7/13] RUN uv pip install --system --no-cache -r /tmp/shipping/reqs/requirements-dev.txt:
0.416 error: Failed to download: pyrovider @ https://github.com/Shiphero/pyrovider/releases/download/1.2.4/pyrovider-1.2.4-py3-none-any.whl
0.416   Caused by: HTTP status client error (401 Unauthorized) for url (https://objects.githubusercontent.com/github-production-release-asset-2e65be/144867083/d56d51b0-fe2d-4eda-a5f2-8f9d6503ce92?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=AKIAVCODYLSA53PQK4ZA%2F20240418%2Fus-east-1%2Fs3%2Faws4_request&amp;X-Amz-Date=20240418T144100Z&amp;X-Amz-Expires=300&amp;X-Amz-Signature=6b628fe5fc427071d8bc8bc84688ecda750075f74d01e4fc236ee4a1cc9eb9af&amp;X-Amz-SignedHeaders=host&amp;actor_id=0&amp;key_id=0&amp;repo_id=144867083&amp;response-content-disposition=attachment%3B%20filename%3Dpyrovider-1.2.4-py3-none-any.whl&amp;response-content-type=application%2Foctet-stream)
</code></pre>
<p>As you can see, the package is public
https://github.com/Shiphero/pyrovider/releases/download/1.2.4/pyrovider-1.2.4-py3-none-any.whl</p>
<p>Pinned uv to 0.1.32 worked for now, but is it related to the breaking changes introduced in the 0.1.33 releases? Do we need to upgrade something in our requirement file?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-18 15:16</div>
            <div class="timeline-body"><p>Hi! Sorry about that, this looks like a bug.</p>
<p>Can you provide logs with <code>RUST_LOG=trace uv pip install -v ...</code> and/or a minimal example I could run?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-04-18 15:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @zanieb by @zanieb on 2024-04-18 15:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ChannyClaus">@ChannyClaus</a> on 2024-04-18 15:20</div>
            <div class="timeline-body"><p>fwiw it seems to work okay on my machine</p>
<pre><code>$ uv --version
uv 0.1.33 (2cee7525c 2024-04-17)
chan.kang@Chans-MBP-4123 ~/test/uv - 
$ rm -rf .venv &amp;&amp; uv venv &amp;&amp; (echo 'pyrovider @ https://github.com/Shiphero/pyrovider/releases/download/1.2.4/pyrovider-1.2.4-py3-none-any.whl' | uv pip compile  - &gt; requirements.txt) &amp;&amp; uv pip install -r requirements.txt --no-cache
Using Python 3.12.1 interpreter at: /Users/chan.kang/.pyenv/versions/3.12.1/bin/python3
Creating virtualenv at: .venv
Activate with: source .venv/bin/activate
Resolved 3 packages in 52ms
Resolved 3 packages in 675ms
Downloaded 3 packages in 84ms
Installed 3 packages in 8ms
 + pyrovider==1.2.4 (from https://github.com/Shiphero/pyrovider/releases/download/1.2.4/pyrovider-1.2.4-py3-none-any.whl)
 + python-dotenv==1.0.1
 + pyyaml==6.0.1
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgaitan">@mgaitan</a> on 2024-04-18 16:02</div>
            <div class="timeline-body"><p>my teammate @romeroyonatan just discovered that it does not happen when installing the public package alone but in conjunction with another package from an url that requires authentication.  He will share an example in a moment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgaitan">@mgaitan</a> on 2024-04-18 16:09</div>
            <div class="timeline-body"><p>btw, I just realized that this misbehavior looks a lot like #3122 and is probably related to the same root cause.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/romeroyonatan">@romeroyonatan</a> on 2024-04-18 17:04</div>
            <div class="timeline-body"><p>Hi team, I found an easy way to reproduce the issue</p>
<pre><code class="language-sh">uv pip install 'uv-3123-bug @ https://romeroyonatan:a@github.com/romeroyonatan/uv-3123-bug/releases/download/v0.1.4/uv_3123_bug-0.0.1-py3-none-any.whl'
</code></pre>
<p>This is the output</p>
<pre><code class="language-sh">$ uv pip install 'uv-3123-bug @ https://romeroyonatan:a@github.com/romeroyonatan/uv-3123-bug/releases/download/v0.1.4/uv_3123_bug-0.0.1-py3-none-any.whl'
error: Failed to download: uv-3123-bug @ https://romeroyonatan:a@github.com/romeroyonatan/uv-3123-bug/releases/download/v0.1.4/uv_3123_bug-0.0.1-py3-none-any.whl
  Caused by: HTTP status client error (401 Unauthorized) for url (https://objects.githubusercontent.com/github-production-release-asset-2e65be/788539373/37fcd109-909c-4ed1-928c-2354c9a79a48?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=AKIAVCODYLSA53PQK4ZA%2F20240418%2Fus-east-1%2Fs3%2Faws4_request&amp;X-Amz-Date=20240418T165731Z&amp;X-Amz-Expires=300&amp;X-Amz-Signature=01a9bf253fb9083fd65e5b37c8b366e6349ca078644a32bac2e309e7a7ea69b2&amp;X-Amz-SignedHeaders=host&amp;actor_id=0&amp;key_id=0&amp;repo_id=788539373&amp;response-content-disposition=attachment%3B%20filename%3Duv_3123_bug-0.0.1-py3-none-any.whl&amp;response-content-type=application%2Foctet-stream)
</code></pre>
<p>This is the pip behavior</p>
<pre><code class="language-sh">$ pip install 'uv-3123-bug @ https://romeroyonatan:a@github.com/romeroyonatan/uv-3123-bug/releases/download/v0.1.4/uv_3123_bug-0.0.1-py3-none-any.whl'
Collecting uv-3123-bug@ https://romeroyonatan:a@github.com/romeroyonatan/uv-3123-bug/releases/download/v0.1.4/uv_3123_bug-0.0.1-py3-none-any.whl
  Downloading https://romeroyonatan:****@github.com/romeroyonatan/uv-3123-bug/releases/download/v0.1.4/uv_3123_bug-0.0.1-py3-none-any.whl (2.7 kB)

[notice] A new release of pip is available: 23.2.1 -&gt; 24.0
[notice] To update, run: pip install --upgrade pip
</code></pre>
<hr />
<p>I tried to reproduce the bug using a private repo, but I found that the issue happens even with public repositories with valid or invalid credentials.</p>
<p>I suspect the credentials are cached and we use the private credentials when we shouldn't (public repositories for example)</p>
<p>Edit: I found the auth cache https://github.com/astral-sh/uv/blob/0.1.33/crates/uv-auth/src/cache.rs#L98-L107
~Edit 2: This is the tracelog with the real instalation. I masked some sensitive data from the urls, sorry for that~ I did not reproduce the bug
Edit 3: New logs  <a href="https://github.com/astral-sh/uv/files/15028400/bug.log">bug.log</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-18 17:25</div>
            <div class="timeline-body"><p>Thanks a bunch ya'll! Will investigate.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/inoa-jboliveira">@inoa-jboliveira</a> on 2024-04-18 17:29</div>
            <div class="timeline-body"><p>There is a regression in 0.1.33 where user/pass combo on custom repos no longer work. It is also affecting us here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-18 17:30</div>
            <div class="timeline-body"><p>@inoa-jboliveira can you be more explicit? Providing a username and password doesn't work for a private repository anymore? This issue is for applying credentials from private repositories to public repositories.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/inoa-jboliveira">@inoa-jboliveira</a> on 2024-04-18 17:34</div>
            <div class="timeline-body"><p>@zanieb Yes, the credentials are being ignored. I tested 0.1.31 and 0.1.32 and they work.</p>
<p>This and UV_INDEX_URL no longer work with user/pass combo
<code>uv pip install --index-url https://myuser:mypass@example.com.br/repository/pypi-all/simple/</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/romeroyonatan">@romeroyonatan</a> on 2024-04-18 17:36</div>
            <div class="timeline-body"><p>I found in the logs that the cached credentials are used when it shouldn't (public repositories)</p>
<pre><code>TRACE Sending fresh HEAD request for https://github.com/Shiphero/pyrovider/releases/download/1.2.4/pyrovider-1.2.4-py3-none-any.whl
TRACE Handling request for https://github.com/Shiphero/pyrovider/releases/download/1.2.4/pyrovider-1.2.4-py3-none-any.whl
DEBUG resolving host=&quot;github.com&quot;
TRACE No credentials on request, checking cache...
TRACE Found cached credentials.
TRACE checkout waiting for idle connection: (&quot;https&quot;, github.com)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/inoa-jboliveira">@inoa-jboliveira</a> on 2024-04-18 17:37</div>
            <div class="timeline-body"><p>Maybe this is a slightly different issue I'm having, but they seem to be caused by the same regression on v0.1.33</p>
<pre><code>error: Failed to download: django==2.2.28
  Caused by: HTTP status client error (401 Unauthorized) for url  (https://example.com.br/repository/pypi-all/packages/django/2.2.28/Django-2.2.28-py3-none-any.whl#sha256=365429d07c1336eb42ba15aa79f45e1c13a0b04d5c21569e7d596696418a6a45)```
  
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-18 17:41</div>
            <div class="timeline-body"><p>I think there are two things going on here:</p>
<ol>
<li>We fixed our caching to actually apply per network location as intended in the original implementation, but this means we can apply credentials to requests that don't need it.</li>
<li>We stopped pre-seeding the cache with the URLs passed via the CLI, I think this is causing some sort of race condition where we don't apply credentials to <em>some</em> in flight requests because they're not cached yet.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/3124.html">astral-sh/uv#3124</a> on 2024-04-18 17:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/3130.html">astral-sh/uv#3130</a> on 2024-04-18 22:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-19 00:30</div>
            <div class="timeline-body"><p>If anyone is interested in trying out https://github.com/astral-sh/uv/pull/3130, it should resolve these issues but coming up with integration test cases is quite challenging and will take a bit longer.</p>
<p>We're also considering reverting the problematic change at #3131, though that will cause different regressions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/romeroyonatan">@romeroyonatan</a> on 2024-04-19 10:37</div>
            <div class="timeline-body"><p>Hi @zanieb, I tested the changes and it works. Great job!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/inoa-jboliveira">@inoa-jboliveira</a> on 2024-04-19 13:02</div>
            <div class="timeline-body"><p>Seems to be working on my issue as well, thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-19 14:06</div>
            <div class="timeline-body"><p>Thanks for giving it a try! I'll get that cleaned up and try to release today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-19 21:09</div>
            <div class="timeline-body"><p>This may go out on Monday instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-04-22 18:06</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:57 UTC
    </footer>
</body>
</html>
