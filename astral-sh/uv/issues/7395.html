<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`.lock` created in the wrong place on NixOS - astral-sh/uv #7395</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>.lock</code> created in the wrong place on NixOS</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/7395">#7395</a>
        opened by <a href="https://github.com/akaihola">@akaihola</a>
        on 2024-09-14 15:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/akaihola">@akaihola</a> on 2024-09-14 15:37</div>
            <div class="timeline-body"><p>On NixOS, installing packages in a virtualenv fails with <code>Read-only file system</code> if</p>
<ul>
<li><strong>either</strong> virtualenv was created using <code>uv venv</code>,</li>
<li><strong>or</strong> package install is attempted using <code>uv pip install</code>.</li>
</ul>
<p>See also #4450, probably related but on macOS. <a href="/astral-sh/uv/issues/4450#issuecomment-2211366244">This comment</a> is probably relevant:</p>
<blockquote>
<p>The fact that python from nix store isn't treated as a system interpreter isn't really an issue imo, as we can easily set the UV_PYTHON env dynamically in a derivation.</p>
<p>The real issue is the fact that uv wants to create a <code>.lock</code> file in there, but <code>/nix/store</code> is read-only, so that won't be possible.</p>
</blockquote>
<hr />
<h3>The four cases and their success/failure status:</h3>
<p>|                                   | <code>python -m venv .venv</code> | <code>uv venv</code>            |
| --------------------------- | ------------------------------ | ---------------------- |
| <code>pip install -U pip</code>      | :green_circle: success | :red_circle: FAIL |
| <code>uv pip install -U pip</code> | :red_circle: FAIL           | :red_circle: FAIL |</p>
<h3>Terminal output for the four cases:</h3>
<details>
<summary>:green_circle: python -m venv / pip:</summary>

<pre><code class="language-shell">$ python -m venv .venv
$ source .venv/bin/activate
$ pip install -U pip
Requirement already satisfied: pip in ./.venv/lib/python3.12/site-packages (24.0)
Collecting pip
  Using cached pip-24.2-py3-none-any.whl.metadata (3.6 kB)
Using cached pip-24.2-py3-none-any.whl (1.8 MB)
Installing collected packages: pip
  Attempting uninstall: pip
    Found existing installation: pip 24.0
    Uninstalling pip-24.0:
      Successfully uninstalled pip-24.0
Successfully installed pip-24.2
</code></pre>
</details>

<details>
<summary>:red_circle: uv venv / pip:</summary>

<pre><code class="language-shell">Using Python 3.12.4 interpreter at: /nix/store/pnavhjx4pdya95nx2apl2yxz6x46snh2-python3-3.12.4-env/bin/python3.12
Creating virtualenv at: .venv
Activate with: source .venv/bin/activate
$ source .venv/bin/activate
$ pip install -U pip
Requirement already satisfied: pip in /nix/store/pnavhjx4pdya95nx2apl2yxz6x46snh2-python3-3.12.4-env/lib/python3.12/site-packages (24.0)
Collecting pip
  Using cached pip-24.2-py3-none-any.whl.metadata (3.6 kB)
Using cached pip-24.2-py3-none-any.whl (1.8 MB)
Installing collected packages: pip
  Attempting uninstall: pip
    Found existing installation: pip 24.0
    WARNING: Could not access 'pyvenv.cfg' despite a virtual environment being active. Assuming global site-packages is not accessible in this environment.
    Uninstalling pip-24.0:
ERROR: Could not install packages due to an OSError: [Errno 30] Read-only file system: '/nix/store/pnavhjx4pdya95nx2apl2yxz6x46snh2-python3-3.12.4-env/bin/pip'
</code></pre>
</details>

<details>
<summary>:red_circle: python -m venv / uv pip:</summary>

<pre><code class="language-shell">$ python -m venv .venv
$ source .venv/bin/activate
$ uv pip install -U pip
error: failed to create file `/nix/store/pnavhjx4pdya95nx2apl2yxz6x46snh2-python3-3.12.4-env/.lock`
  Caused by: Read-only file system (os error 30)
</code></pre>
</details>

<details>
<summary>:red_circle: uv venv / uv pip:</summary>

<pre><code class="language-shell">$ uv venv
Using Python 3.12.4 interpreter at: /nix/store/pnavhjx4pdya95nx2apl2yxz6x46snh2-python3-3.12.4-env/bin/python3.12
Creating virtualenv at: .venv
Activate with: source .venv/bin/activate
$ source .venv/bin/activate
$ uv pip install -U pip
error: failed to create file `/nix/store/pnavhjx4pdya95nx2apl2yxz6x46snh2-python3-3.12.4-env/.lock`
  Caused by: Read-only file system (os error 30)
</code></pre>
</details>

<hr />
<h3>Work-around using <code>UV_PYTHON=$VIRTUAL_ENV/bin/python</code></h3>
<p>The work-around only fixes one of the cases:</p>
<p>|                                   | <code>python -m venv .venv</code>                              | <code>uv venv</code>            |
| --------------------------- | ------------------------------------------------------- | ---------------------- |
| <code>pip install -U pip</code>      | :green_circle: success                               | :red_circle: FAIL |
| <code>uv pip install -U pip</code> | :green_circle: success (with work-around) | :red_circle: FAIL |</p>
<details>
<summary>:green_circle: python -m venv / uv pip:</summary>

<pre><code class="language-shell">$ python -m venv .venv
$ source .venv/bin/activate
$ export UV_PYTHON=$VIRTUAL_ENV/bin/python
$ uv pip install -U pip
Resolved 1 package in 100ms
Prepared 1 package in 0.53ms
Uninstalled 1 package in 39ms
░░░░░░░░░░░░░░░░░░░░ [0/1] Installing wheels...                                                                                                                                Installed 1 package in 38ms
 - pip==24.0
 + pip==24.2
</code></pre>
<hr />
<!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-14 17:11</div>
            <div class="timeline-body"><p>In the third example, what &quot;is&quot; <code>/nix/store/pnavhjx4pdya95nx2apl2yxz6x46snh2-python3-3.12.4-env</code>? Is that the path to the system Python? Or the virtual environment?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akaihola">@akaihola</a> on 2024-09-14 18:26</div>
            <div class="timeline-body"><blockquote>
<p>what &quot;is&quot; <code>/nix/store/pnavhjx4pdya95nx2apl2yxz6x46snh2-python3-3.12.4-env</code></p>
</blockquote>
<p>It's what <code>pkgs.python3.withPackages</code> created.</p>
<p>Reading #4450 more carefully, that seems to be at the heart of the issue: running <code>uv</code> with a &quot;clean&quot; <code>pkgs.python3</code> seems to work ok, but the &quot;dirty&quot; <code>pkgs.python3.withPackages</code> derivation confuses <code>uv</code>. See <a href="/astral-sh/uv/issues/4450#issuecomment-2211766775">this comment from @Rubikoid</a>.</p>
<p>My use case for <code>withPackages</code> is to get binary dependencies for <a href="https://pypi.org/project/playwright/">Playwright</a> into the environment. I do install a specific Playwright version with Pip once those are in place.</p>
<p>It seems installing both <code>pkgs.python3</code> and <code>pkgs.python3.withPackages</code> and running <code>uv</code> with <code>pkgs.python3</code> may work just fine. I'll need to verify that Playwright actually works, too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MarSoft">@MarSoft</a> on 2025-03-17 14:25</div>
            <div class="timeline-body"><p>Here's a workaround I use in my <code>.bashrc</code>:</p>
<pre><code>export UV_PYTHON_PREFERENCE=only-system 
export PATH=&quot;$PATH:$(python -c 'import sys; print(sys.base_prefix)')/bin&quot;
</code></pre>
<p>Here is an explanation:</p>
<ol>
<li>I have a <code>python.withPackages {...}</code> in my <code>environment.systemPackages</code>. This is a &quot;wrapped&quot; Python, and <code>uv</code> fails to treat it as a &quot;system Python&quot;.</li>
<li>I want to tell <code>uv</code> which is the path to system-wide Python. If I use <code>UV_PYTHON</code> though then <code>uv</code> will always try to use this Python directly, even if the venv is active — so the venv won't work.</li>
<li>So I add the real Python to $PATH but put it after <code>/run/current-system/sw/bin</code> where there is a wrapped <code>python</code> binary.</li>
</ol>
<p>This seems to work for me, but I did not do thorough tests yet.</p>
<p>Just installing both <code>python.withPackages</code> and <code>python</code> to <code>environment.systemPackages</code> like @akaihola suggests won't work, because <code>systemPackages</code> are symlinks from <code>/run/current-system/sw/bin</code> and we cannot have two symlinks named <code>python</code> from the single directory. But adding the desired python to somewhere in <code>$PATH</code> but after the directory with &quot;main&quot; Python seems to work.</p>
<p>The correct fix for this bug would be to teach <code>uv</code> how to find the real system Python behind the &quot;wrapped&quot; one. Stock Python's <code>venv</code> module somehow manages to do this, unlike <code>uv</code> which complains about &quot;no interpreter found in system path&quot;. Looks like it uses <code>sys._base_executable</code>?..</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MarSoft">@MarSoft</a> on 2025-03-25 16:03</div>
            <div class="timeline-body"><p>Related issues: #10711 and #4450</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:30:43 UTC
    </footer>
</body>
</html>
