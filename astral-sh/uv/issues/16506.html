<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`source-include` is completely ignored when `source-exclude` contains overlapping patterns - astral-sh/uv #16506</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`source-include` is completely ignored when `source-exclude` contains overlapping patterns</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/16506">#16506</a>
        opened by <a href="https://github.com/byeblack">@byeblack</a>
        on 2025-10-30 01:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/byeblack">@byeblack</a> on 2025-10-30 01:40</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>When using <code>tool.uv.build-backend.source-exclude</code> with a broad pattern like <code>**/*.py</code>, the <code>source-include</code> setting is completely ignored, even when it specifies explicit files that should be included. This makes it impossible to exclude most files while keeping specific ones.</p>
<h3>Platform</h3>
<p>Windows 11 x86_64</p>
<h3>Version</h3>
<p>0.9.5 (d5f39331a 2025-10-21)</p>
<h3>Python version</h3>
<p>3.12.12</p>
<h3>Configuration</h3>
<pre><code class="language-toml">[tool.uv.build-backend]
source-exclude = [&quot;**/*.py&quot;]
source-include = [&quot;*.pyd&quot;, &quot;__init__.py&quot;, &quot;__main__.py&quot;]
</code></pre>
<h3>Expected Behavior</h3>
<p>The <code>source-include</code> patterns should take precedence over or create exceptions to <code>source-exclude</code> patterns. In this case, I expect:</p>
<ul>
<li>All <code>.py</code> files to be excluded (as per <code>source-exclude</code>)</li>
<li><strong>Except</strong> <code>__init__.py</code> and <code>__main__.py</code> files, which should be included (as per <code>source-include</code>)</li>
<li>Plus any <code>.pyd</code> files should be included</li>
</ul>
<p>This is a common use case where you want to:</p>
<ol>
<li>Compile most Python files to <code>.pyd</code> (or exclude them for other reasons)</li>
<li>Keep only essential files like <code>__init__.py</code> and <code>__main__.py</code> as source</li>
</ol>
<h2>Actual Behavior</h2>
<p>The <code>source-include</code> setting is completely ignored. <strong>No</strong> <code>.py</code> files are included in the wheel, not even <code>__init__.py</code> or <code>__main__.py</code>.</p>
<p>From the debug output:</p>
<pre><code>DEBUG Wheel excludes: [&quot;__pycache__&quot;, &quot;*.pyc&quot;, &quot;*.pyo&quot;, &quot;**/*.py&quot;]
DEBUG Adding content files to wheel
DEBUG Source root: src
DEBUG Module path: zzz
DEBUG Adding to wheel: zzz
DEBUG Adding to wheel: zzz/config
DEBUG Adding to wheel: zzz/config/1.json
DEBUG Adding to wheel: zzz/gui
DEBUG Adding to wheel: zzz/gui/components
DEBUG Adding to wheel: zzz/gui/page
DEBUG Adding to wheel: zzz/gui/vcruntime140.dll
DEBUG Adding to wheel: zzz/www.txt
DEBUG Visited 8 files for wheel build
</code></pre>
<p>Notice that no <code>.py</code> files are added at all, even though <code>__init__.py</code> and <code>__main__.py</code> exist in multiple directories.</p>
<h3>Project Structure</h3>
<pre><code>src/
  zzz/
    __init__.py          # Should be included but is excluded
    __main__.py          # Should be included but is excluded
    app.py               # Should be excluded ✓
    config/
      __init__.py        # Should be included but is excluded
      app.py             # Should be excluded ✓
      ...
    gui/
      app.py             # Should be excluded ✓
      ...
</code></pre>
<h3>Workarounds Attempted</h3>
<ol>
<li><p>❌ Using negation in exclude: <code>source-exclude = [&quot;**/*.py&quot;, &quot;!**/__init__.py&quot;]</code></p>
<ul>
<li>Result: Error <code>Invalid character '!' at position 3 in glob</code></li>
</ul>
</li>
<li><p>❌ Using character class negation: <code>source-exclude = [&quot;[!__]*.py&quot;]</code></p>
<ul>
<li>Result: Error <code>Invalid character '!' in range at position 4 in glob</code></li>
</ul>
</li>
<li><p>❌ Only using <code>source-include</code> without <code>source-exclude</code></p>
<ul>
<li>Result: Includes ALL Python files, not just the specified ones</li>
</ul>
</li>
</ol>
<h3>Proposed Solution</h3>
<p>Either:</p>
<ol>
<li>Make <code>source-include</code> take precedence over <code>source-exclude</code> (evaluated after exclude, to re-include specific files)</li>
<li>Support glob negation patterns like <code>!**/__init__.py</code> in <code>source-exclude</code></li>
<li>Document the current behavior clearly and provide guidance for this use case</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @byeblack on 2025-10-30 01:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">build-backend</span> added by @konstin on 2025-10-30 13:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-10-30 13:52</div>
            <div class="timeline-body"><p>For builds involving a compilation step, the uv build backend is currently not suited, as it doesn't (yet) have build script support. One of the core assumptions of the build backend is that we're adding a directory of Python files, so the includes and excludes aren't build for supporting excluding most Python files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @konstin on 2025-10-30 13:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @konstin on 2025-10-30 13:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/byeblack">@byeblack</a> on 2025-10-30 14:06</div>
            <div class="timeline-body"><p>Thank you for the response!</p>
<p>However, I think this is actually a bug in the glob implementation itself, unrelated to my specific use case.</p>
<p><strong>The issue</strong>: When I use <code>[!w]*.txt</code> or <code>[!__]*.py</code>, uv throws an error saying <code>Invalid character '!' in range</code>. But the error message itself documents that <code>[!...]</code> syntax should be supported:</p>
<pre><code>[!...] is the negation of [...], i.e. it matches any characters not in the brackets.
</code></pre>
<p>So uv's own documentation says <code>[!...]</code> should work, but it doesn't. This seems like a bug where the documented glob syntax isn't actually implemented.</p>
<p>Additionally, <code>source-include</code> patterns are completely ignored when they overlap with <code>source-exclude</code> patterns, which makes it impossible to create exceptions to exclusion rules.</p>
<p>Should these be fixed, or is the error message documentation incorrect?</p>
<p>https://docs.rs/glob/latest/glob/struct.Pattern.html</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-10-30 14:14</div>
            <div class="timeline-body"><blockquote>
<p><strong>The issue</strong>: When I use <code>[!w]*.txt</code> or <code>[!__]*.py</code>, uv throws an error saying <code>Invalid character '!' in range</code>. But the error message itself documents that <code>[!...]</code> syntax should be supported:</p>
<pre><code>[!...] is the negation of [...], i.e. it matches any characters not in the brackets.
</code></pre>
<p>So uv's own documentation says <code>[!...]</code> should work, but it doesn't. This seems like a bug where the documented glob syntax isn't actually implemented.</p>
</blockquote>
<p>That's not used by the uv build backend, which uses https://packaging.python.org/en/latest/specifications/glob-patterns/ (https://docs.astral.sh/uv/concepts/build-backend/#include-and-exclude-syntax). Did you get the cited message from the build backend error?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/byeblack">@byeblack</a> on 2025-10-30 14:20</div>
            <div class="timeline-body"><p>Thank you for the clarification and the link to the specification!</p>
<p>I understand now that the <code>[!...]</code> syntax is not part of the <a href="https://packaging.python.org/en/latest/specifications/glob-patterns/">PyPA glob spec</a>, so uv is correctly implementing the standard. The error message was just showing general glob concepts, not uv's actual supported syntax.</p>
<p>I appreciate you taking the time to explain this. I'll work with the current limitations.</p>
<p>Thanks again!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @byeblack on 2025-10-30 14:32</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:33:14 UTC
    </footer>
</body>
</html>
