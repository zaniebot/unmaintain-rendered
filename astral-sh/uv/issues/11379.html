<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slow resolution from Azure DevOps feed - astral-sh/uv #11379</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Slow resolution from Azure DevOps feed</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/11379">#11379</a>
        opened by <a href="https://github.com/thomasaarholt">@thomasaarholt</a>
        on 2025-02-10 08:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/thomasaarholt">@thomasaarholt</a> on 2025-02-10 08:50</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Hi!
I'm trying to find the best way to debug why installing from my work's package index is so slow. The dependency resolution is the slow part, at <strong>25 sec</strong> for our index vs <a href="https://gist.github.com/thomasaarholt/d8a39136769a864e34d4be1f64856b31">0.3 sec</a> for pypi.</p>
<p>I have followed the uv instructions for <a href="https://docs.astral.sh/uv/guides/integration/alternative-indexes/#using-a-pat">alternative package indexes</a>. We mostly mirror pypi, and for these packages I don't expect there to be any real difference, except that it should be a bit faster since we probably host fewer packages.</p>
<p>There is no authentication window that I need to click on, everything happens automatically. We've added keyring to uv tool with <code>uv tool install keyring --with artifacts-keyring</code>.</p>
<h1>Summary logs</h1>
<pre><code class="language-bash"># From pypi
‚ùØ uv pip install pandas numpy scikit-learn --no-cache
Resolved 10 packages in 379ms
Prepared 10 packages in 2.44s
Installed 10 packages in 617ms
# (package versions printed here)
</code></pre>
<pre><code class="language-bash"># From our index
uv pip install pandas numpy scikit-learn --no-cache --keyring-provider=subprocess --index-url=&lt;redacted&gt;
‚†¥ Resolving dependencies...                                                                                                                                                                                  [Information] [CredentialProvider]VstsCredentialProvider - Acquired bearer token using 'REDACTED'
[Information] [CredentialProvider]VstsCredentialProvider - Attempting to exchange the bearer token for an Azure DevOps session token.
Resolved 10 packages in 25.31s # &lt;-------------------- 25 sec vs 0.3 sec!
Prepared 10 packages in 3.70s
Installed 10 packages in 985ms
# (package versions printed here)
</code></pre>
<h1>Verbose logs</h1>
<p>I include full logs when appending --verbose to the calls for the <a href="https://gist.github.com/thomasaarholt/d8a39136769a864e34d4be1f64856b31">pypi </a>and other <a href="https://gist.github.com/thomasaarholt/9341f80c27de93ae3c6c9d0d3b016163">index-url case</a>.</p>
<h3>Platform</h3>
<p>Windows 11 x86_64</p>
<h3>Version</h3>
<p>uv 0.5.25 (9c07c3fc5 2025-01-28)</p>
<h3>Python version</h3>
<p>3.12.8</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @thomasaarholt on 2025-02-10 08:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-02-10 10:32</div>
            <div class="timeline-body"><p>When resolving, uv needs the metadata of every version used in the resolution. This information we get from a file called <code>METADATA</code> inside the <code>&lt;name&gt;-&lt;version&gt;.dist-info</code> directory of the wheel. PyPI exposes this file directly in the API (PEP 658). For most other server we can use HTTP Range requests to read only the METADATA file from the zip without downloading and unpacking the entire file. The index you're using does neither support PEP 658 nor HTTP Range requests, so we have to download each wheel file to extract its metadata.</p>
<p>The hint is in this log message:</p>
<blockquote>
<p>WARN Range requests not supported for numpy-2.2.2-cp311-cp311-win_amd64.whl; streaming wheel</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @konstin on 2025-02-10 10:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @konstin on 2025-02-10 10:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">upstream</span> added by @konstin on 2025-02-10 10:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thomasaarholt">@thomasaarholt</a> on 2025-02-10 16:35</div>
            <div class="timeline-body"><p>Thank you so much for this quick response, this makes perfect sense. I‚Äôm contacting those responsible for adding support for this.</p>
<p>I‚Äôm closing this, but any pointers or advice for adding support for this sort of thing to a tracker is very much appreciated! I‚Äôm very pro <em>not spending unnecessary energy boiling the oceans</em>, especially in a CI!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @thomasaarholt on 2025-02-10 16:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @thomasaarholt on 2025-02-12 12:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thomasaarholt">@thomasaarholt</a> on 2025-02-12 12:41</div>
            <div class="timeline-body"><p>Reopening this because I have some new information and am trying to find a minimum repro.</p>
<p>Full disclosure: I actually work at Microsoft, but as a Data Scientist and not affiliated with the Azure teams. My opinions are my own.</p>
<p>I raised this internally within Microsoft, and learnt that we do not support PEP 658 yet, but we <em>do</em> support HTTP range requests. However, we think that <code>uv</code> might not be handling the fact that we redirect from Azure Storage to <a href="https://learn.microsoft.com/en-us/azure/frontdoor/integrate-storage-account">Azure Front Door</a>, a caching service.</p>
<p>My intention is now to see if we can work out why uv doesn't handle the redirect for HTTP range requests.</p>
<p>I have created a <a href="https://dev.azure.com/thomasaarholt/thomasaarholt-python/_artifacts/feed/thomas-python-feed">public tracker</a> on Azure DevOps (ADO) where I can add specific python packages from PyPI to make them available to the public on that tracker. I have added PyPI as an &quot;upstream provider&quot;, which lets an authenticated user to the ADO project (me) add any PyPI package version to the feed for public consumption. I do that via <code>pip install &lt;package&gt;==&lt;version&gt;</code> while <a href="https://docs.astral.sh/uv/guides/integration/alternative-indexes/#using-keyring">authenticating via artifacts-keyring</a> (I install it directly in the venv, pip didn't pick up the <code>uv tool</code>). There's actually a (possibly redirect-related?) bug with uv here, as I can't get uv to authenticate correctly for packages that aren't already in the index. Will make a new issue on that, but that requires authentication to the server to debug.</p>
<pre><code>export INDEX='https://pkgs.dev.azure.com/thomasaarholt/thomasaarholt-python/_packaging/thomas-python-feed/pypi/simple/'
uv venv --seed --quiet
source .venv/bin/activate.fish # activate however you normally do
uv pip install numpy pandas scikit-learn --index-url=$INDEX --no-cache -v  &amp;| grep stream # I pipe stdout and stderr into grep
</code></pre>
<p>I've run the above a few times now, and always get at least one package warning, sometimes two or three:</p>
<pre><code class="language-fish">‚ùØ export INDEX='https://pkgs.dev.azure.com/thomasaarholt/thomasaarholt-python/_packaging/thomas-python-feed/pypi/simple/'
  uv venv --seed --quiet
  source .venv/bin/activate.fish
  uv pip install numpy pandas scikit-learn --index-url=$INDEX --no-cache -v  &amp;| grep stream # I pipe stdout and stderr into grep
# WARN Range requests not supported for scikit_learn-1.6.1-cp311-cp311-manylinux_2_17_x86_64.manylinux2014_x86_64.whl; streaming wheel

# rerun
‚ùØ export INDEX='https://pkgs.dev.azure.com/thomasaarholt/thomasaarholt-python/_packaging/thomas-python-feed/pypi/simple/'
  uv venv --seed --quiet
  source .venv/bin/activate.fish
  uv pip install numpy pandas scikit-learn --index-url=$INDEX --no-cache -v  &amp;| grep stream # I pipe stdout and stderr into grep
# WARN Range requests not supported for pandas-2.2.3-cp311-cp311-manylinux_2_17_x86_64.manylinux2014_x86_64.whl; streaming wheel
# WARN Range requests not supported for scikit_learn-1.6.1-cp311-cp311-manylinux_2_17_x86_64.manylinux2014_x86_64.whl; streaming wheel
# WARN Range requests not supported for numpy-2.2.2-cp311-cp311-manylinux_2_17_x86_64.manylinux2014_x86_64.whl; streaming wheel
</code></pre>
<p>Is there any chance I could get some help debugging this from the uv team?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-12 14:01</div>
            <div class="timeline-body"><blockquote>
<p>There's actually a (possibly redirect-related?) bug with uv here, as I can't get uv to authenticate correctly for packages that aren't already in the index. Will make a new issue on that, but that requires authentication to the server to debug.</p>
</blockquote>
<p>I'm not seeing the opt-in to using the keyring and a username in the index URL.</p>
<p>On the range requests...</p>
<p>Is it feasible to create a simple nginx container or something that replicates the setup?</p>
<p>Can you reproduce with <a href="https://github.com/prefix-dev/async_http_range_reader">async_http_range_reader</a> directly?</p>
<p>cc @konstin I think you have some familiarity with <code>async_http_range_reader</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thomasaarholt">@thomasaarholt</a> on 2025-02-12 16:33</div>
            <div class="timeline-body"><blockquote>
<p>I'm not seeing the opt-in to using the keyring and a username in the index URL.</p>
</blockquote>
<p>Yes, I'm showing the regular index url here since the user shouldn't need authentication when installing packages that are on the feed. When trying to get uv to authenticate to add packages from PyPI to my public feed, I was using:</p>
<pre><code>export UV_INDEX='https://VssSessionToken@pkgs.dev.azure.com/thomasaarholt/thomasaarholt-python/_packaging/thomas-python-feed/pypi/simple/'

uv venv --seed --quiet
source .venv/bin/activate.fish
uv pip install numpy==2.1.1 --index-url=$UV_INDEX --keyring-provider='subprocess' -v
</code></pre>
<p><a href="https://gist.github.com/thomasaarholt/78e141efd79188a362c8b1b09258adfe">Here's the log for that in a gist</a>.</p>
<p>To clear one possible point of confusion: One must be an authenticated user in order to install an upstream (PyPI) package through an ADO feed. <a href="https://learn.microsoft.com/en-us/azure/devops/artifacts/how-to/public-feeds-upstream-sources?view=azure-devops&amp;tabs=python#restore-packages">This is by design</a> (purple box).</p>
<blockquote>
<p>On the range requests...</p>
</blockquote>
<p>I might be able to. Never worked with nginx before, and only a bit with rust. I will try if I can find the time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-12 16:40</div>
            <div class="timeline-body"><p>So a range request does work with <code>curl</code> <em>if</em> you provide the <code>-L</code> flag to follow the redirects</p>
<pre><code>‚ùØ curl -H &quot;Range: bytes=0-1048575&quot; &quot;https://pkgs.dev.azure.com/thomasaarholt/5e230929-47ac-48ad-97db-15ab1d2aa0c5/_packaging/56fc1e3a-f592-420b-bd14-a8c967a65c28/pypi/download/pandas/2.2.3/pandas-2.2.3-cp311-cp311-manylinux_2_17_x86_64.manylinux2014_x86_64.whl#sha256=c124333816c3a9b03fbeef3a9f230ba9a737e9e5bb4060aa2107a86cc0a497fc&quot; -f -L &gt; chunk
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-12 16:45</div>
            <div class="timeline-body"><p>But...  if you make a HEAD request, the index returns a HTTP 405 method not allowed</p>
<pre><code>‚ùØ curl --head -L &quot;https://pkgs.dev.azure.com/thomasaarholt/5e230929-47ac-48ad-97db-15ab1d2aa0c5/_packaging/56fc1e3a-f592-420b-bd14-a8c967a65c28/pypi/download/pandas/2.2.3/pandas-2.2.3-cp311-cp311-manylinux_2_17_x86_64.manylinux2014_x86_64.whl&quot;
HTTP/2 405 
</code></pre>
<p>which is what we use to determine if range requests are supported</p>
<p>https://github.com/astral-sh/uv/blob/748582ee6f3ff1007692f131fa4b59d7c100ec66/crates/uv-client/src/registry_client.rs#L711-L753
https://github.com/prefix-dev/async_http_range_reader/blob/c2a1b5a63712a34bca661cc94389fb03fb0dcddd/src/lib.rs#L310-L318</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-12 16:48</div>
            <div class="timeline-body"><p>I would be curious to hear why they don't support HEAD requests ‚Äî as that seems to be the crux of the problem here.</p>
<p>You could set <code>RUST_LOG=trace</code> to get verbose logs from the network layer and confirm the HTTP 405 is occurring.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thomasaarholt">@thomasaarholt</a> on 2025-02-12 16:52</div>
            <div class="timeline-body"><p>That was quick! I've brought it up internally now. Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-02-12 16:53</div>
            <div class="timeline-body"><p>For additional context, we should be following redirects in the HEAD request, but we need the initial HEAD requests to determine whether the server supports range requests (https://github.com/prefix-dev/async_http_range_reader/blob/9c1e2d3082745f3a75d8065a3dd145cd51b2715a/src/lib.rs#L310-L318).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thomasaarholt">@thomasaarholt</a> on 2025-02-12 17:05</div>
            <div class="timeline-body"><blockquote>
<p>You could set <code>RUST_LOG=trace</code> to get verbose logs from the network layer and confirm the HTTP 405 is occurring.</p>
</blockquote>
<p>‚úÖ</p>
<pre><code>export INDEX='https://pkgs.dev.azure.com/thomasaarholt/thomasaarholt-python/_packaging/thomas-python-feed/pypi/simple/'
export RUST_LOG=trace
uv venv --seed --quiet
source .venv/bin/activate.fish # activate however you normally do
uv pip install numpy --index-url=$INDEX --no-cache -v  &amp;&gt; log.txt
</code></pre>
<pre><code># Ctrl+F 405
TRACE Attempting to retry error: Error { kind: WrappedReqwestError(Url { scheme: &quot;https&quot;, cannot_be_a_base: false, username: &quot;&quot;, password: None, host: Some(Domain(&quot;pkgs.dev.azure.com&quot;)), port: None, path: &quot;/thomasaarholt/5e230929-47ac-48ad-97db-15ab1d2aa0c5/_packaging/56fc1e3a-f592-420b-bd14-a8c967a65c28/pypi/download/numpy/2.2.2/numpy-2.2.2-cp311-cp311-manylinux_2_17_x86_64.manylinux2014_x86_64.whl&quot;, query: None, fragment: Some(&quot;sha256=02935e2c3c0c6cbe9c7955a8efa8908dd4221d7755644c59d1bba28b94fd334f&quot;) }, WrappedReqwestError(Reqwest(reqwest::Error { kind: Status(405), url: &quot;https://pkgs.dev.azure.com/thomasaarholt/5e230929-47ac-48ad-97db-15ab1d2aa0c5/_packaging/56fc1e3a-f592-420b-bd14-a8c967a65c28/pypi/download/numpy/2.2.2/numpy-2.2.2-cp311-cp311-manylinux_2_17_x86_64.manylinux2014_x86_64.whl#sha256=02935e2c3c0c6cbe9c7955a8efa8908dd4221d7755644c59d1bba28b94fd334f&quot; }))) }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Slow package resolution from authenticated package index" to "Slow resolution from Azure DevOps feed" by @thomasaarholt on 2025-02-12 17:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thomasaarholt">@thomasaarholt</a> on 2025-02-14 11:49</div>
            <div class="timeline-body"><p>We're taking a look internally at fixing this. No promises at timelines. üòÖ Thanks for your help!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../pypa/pip/pulls/12991.html">pypa/pip#12991</a> on 2025-03-09 22:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thomasaarholt">@thomasaarholt</a> on 2025-06-24 19:30</div>
            <div class="timeline-body"><p>Okay, so we have some progress from our side - we are testing support for HEAD requests, but still struggling with range requests.
I just wanted to ask if you have any perspective on these logs (<a href="https://gist.github.com/thomasaarholt/d6ac29cb811d8fa1dd1ecb402670d277">old</a> vs <a href="https://gist.github.com/thomasaarholt/f5172244b1ee07b87c4e66f4e0671404">new beta</a>) where I've extracted out the most relevant bits. I would really appreciate any help here. (Just a reminder that I'm 'just a (really keen) data scientist' acting as a messenger here, and not a representative of the ADO team)</p>
<p>Here's the most relevant bits:</p>
<pre><code class="language-log"># Old version
TRACE Considering retry of response HTTP 405 Method Not Allowed for https://o365exchange.pkgs.visualstudio.com/_packaging/4e1b791c-19a4-4f51-af8c-cfb5f7ab41ff/pypi/download/numpy/2.3.1/numpy-2.3.1-cp313-cp313-manylinux_2_28_x86_64.whl
TRACE Cannot retry error: not an IO error
WARN Range requests not supported for numpy-2.3.1-cp313-cp313-manylinux_2_28_x86_64.whl; streaming wheel
</code></pre>
<pre><code class="language-log"># New beta version
TRACE Considering retry of error: Error { kind: Zip(WheelFilename { name: PackageName(&quot;numpy&quot;), version: &quot;2.3.1&quot;, tags: Small { small: WheelTagSmall { python_tag: CPython { python_version: (3, 13) }, abi_tag: CPython { gil_disabled: false, python_version: (3, 13) }, platform_tag: Manylinux { major: 2, minor: 28, arch: X86_64 } } } }, UpstreamReadError(Custom { kind: Other, error: HttpRangeRequestUnsupported })) }
TRACE Cannot retry IO error: not one of `ConnectionReset` or `UnexpectedEof`
TRACE Cannot retry error: not an IO error
WARN Range requests not supported for numpy-2.3.1-cp313-cp313-manylinux_2_28_x86_64.whl; streaming wheel
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-06-24 19:42</div>
            <div class="timeline-body"><p>It seems we're a different error path now, with the second one being inside the async-http-range-reader crate.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thomasaarholt">@thomasaarholt</a> on 2025-06-24 19:43</div>
            <div class="timeline-body"><p>I also see this line a few lines above what I quoted in the previous comment:</p>
<pre><code>DEBUG redirect policy disallowed redirection to 'https://vsblobprodscussu0shard22.vsblob.vsassets.io/REDACTED?sv=2019-07-07&amp;sr=b&amp;sig=6nWQ8vjzgdYFB1CVD1DF1ifKJJIxBuBOH6hx%2F2nP648%3D&amp;skoid=b735c262-fb1c-41c9-b9ac-cdb426a80296&amp;sktid=33e01921-4d64-4f8c-a055-5bdaffd5e33d&amp;skt=2025-06-24T16%3A21%3A50Z&amp;ske=2025-06-26T17%3A21%3A50Z&amp;sks=b&amp;skv=2019-07-07&amp;se=2025-06-24T20%3A33%3A33Z&amp;sp=r&amp;rscl=x-e2eid-6b7350b3-9623492d-9d49d5c0-a360ba58-session-6b7350b3-9623492d-9d49d5c0-a360ba58&amp;rscd=attachment%3B%20filename%3D%22numpy-2.3.1-cp313-cp313-manylinux_2_28_x86_64.whl%22&amp;P1=1750808014&amp;P2=1&amp;P3=2&amp;P4=QwPC5E0pj0GF%2bw2ODhIpBy5bNfGHbpSh2pDGkaNwFI8%3d'    
</code></pre>
<p>When I curl that url, I get the following response:</p>
<pre><code>curl -I https://vsblobprodscussu0shard22.vsblob.vsassets.io/REDACTED=2019-07-07&amp;sr=b&amp;sig=6nWQ8vjzgdYFB1CVD1DF1ifKJJIxBuBOH6hx%2F2nP648%3D&amp;skoid=b735c262-fb1c-41c9-b9ac-cdb426a80296&amp;sktid=33e01921-4d64-4f8c-a055-5bdaffd5e33d&amp;skt=2025-06-24T16%3A21%3A50Z&amp;ske=2025-06-26T17%3A21%3A50Z&amp;sks=b&amp;skv=2019-07-07&amp;se=2025-06-24T20%3A33%3A33Z&amp;sp=r&amp;rscl=x-e2eid-6b7350b3-9623492d-9d49d5c0-a360ba58-session-6b7350b3-9623492d-9d49d5c0-a360ba58&amp;rscd=attachment%3B%20filename%3D%22numpy-2.3.1-cp313-cp313-manylinux_2_28_x86_64.whl%22&amp;P1=1750808014&amp;P2=1&amp;P3=2&amp;P4=QwPC5E0pj0GF%2bw2ODhIpBy5bNfGHbpSh2pDGkaNwFI8%3d
HTTP/2 200
content-length: 16627546
content-type: application/octet-stream
content-language: x-e2eid-0fef6d97-5ec04d58-b5f8a8db-c95cc161-session-0fef6d97-5ec04d58-b5f8a8db-c95cc161
last-modified: Tue, 24 Jun 2025 18:34:36 GMT
accept-ranges: bytes
etag: &quot;0x8DDB34DC5DB0604&quot;
x-cache: TCP_HIT
x-ms-request-id: 3cfeb847-f01e-0001-4e36-e5ed6f000000
x-ms-version: 2019-07-07
x-ms-creation-time: Tue, 24 Jun 2025 18:34:36 GMT
x-ms-lease-status: unlocked
x-ms-lease-state: available
x-ms-blob-type: BlockBlob
content-disposition: attachment; filename=&quot;numpy-2.3.1-cp313-cp313-manylinux_2_28_x86_64.whl&quot;
x-ms-server-encrypted: true
access-control-expose-headers: Content-Length
access-control-allow-origin: *
x-cid: 7
x-ccc: NO
x-msedge-ref: Ref A: 06E20667CA8B4B0E8D0F248E5976F541 Ref B: SVG20EDGE0108 Ref C: 2025-06-24T19:45:26Z
date: Tue, 24 Jun 2025 19:45:25 GMT
</code></pre>
<p>And that <strong>does</strong> contain <code>accept-ranges: bytes</code> indicating support of range requests!</p>
<p>Where does the redirect policy come from, and is there any way either you can adjust it, or we can support it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thomasaarholt">@thomasaarholt</a> on 2025-06-24 19:50</div>
            <div class="timeline-body"><p>@konstin agreed. I just edited the above comment with new info, didn't see that you responded.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thomasaarholt">@thomasaarholt</a> on 2025-06-24 20:59</div>
            <div class="timeline-body"><p>EDIT: This was not correct. Here I compared the latest release with the effect of me applying the patch in this post, when I should have compared master branch alone with me applying the patch. The following is already happening on latest master branch:</p>
<details><summary>Incorrect comment</summary>
<p>
@konstin I believe I am able to change the uv reqwest policy to allow the redirect. Here installing `numpy scipy scikit-learn`.

<p>When I compile uv with the following patch, I go from</p>
<pre><code>9726 TRACE Getting metadata for scikit_learn-1.7.0-cp313-cp313-manylinux_2_17_x86_64.manylinux2014_x86_64.whl by range request
...
10428 DEBUG redirect policy disallowed redirection to 'https://vsblobprodscussu0shard6.vsblob.vsassets.io/b-6cb12e9fc4334ae59c34553955d1a530/C264C1D7F05B28047E27011CBA39318F1C931C8D610E4695326FCF8217D8077300.blob?sv=2019-07-07&amp;sr=b&amp;sig=sKZzOIaeSAwNhCKNdc5UPl71VxEwMHb0cHlRlk4jZa0%3D&amp;skoid=b735c262-fb1c-41c9-b9ac-cdb426a80296&amp;sktid=33e01921-4d64-4f8c-a055-5bdaffd5e33d&amp;skt=2025-06-24T16%3A21%3A56Z&amp;ske=2025-06-26T17%3A21%3A56Z&amp;sks=b&amp;skv=2019-07-07&amp;se=2025-06-24T21%3A18%3A17Z&amp;sp=r&amp;rscl=x-e2eid-6b73e904-9623492d-9d49d5c0-a360ba58-session-6b73e904-9623492d-9d49d5c0-a360ba58&amp;rscd=attachment%3B%20filename%3D%22scikit_learn-1.7.0-cp313-cp313-manylinux_2_17_x86_64.manylinux2014_x86_64.whl%22&amp;P1=1750812358&amp;P2=1&amp;P3=2&amp;P4=yHZBtGsF5WEdz89dWI6sdjGIRBZ7ph5ntzgaFblphJY%3d'
...
10428 TRACE Considering retry of error: Error { kind: Zip(WheelFilename { name: PackageName(&quot;scikit-learn&quot;), version: &quot;1.7.0&quot;, tags: Large { large: WheelTagLarge { build_tag: None, python_tag: [CPython { python_version: (3, 13) }], abi_tag: [CPython { gil_disabled: false, python_version: (3, 13) }], platform_tag: [Manylinux { major: 2, minor: 17, arch: X86_64 }, Manylinux2014 { arch: X86_64 }], repr: &quot;cp313-cp313-manylinux_2_17_x86_64.manylinux2014_x86_64&quot; } } }, UpstreamReadError(Custom { kind: Other, error: HttpRangeRequestUnsupported })) }
10429 TRACE Cannot retry IO error: not one of `ConnectionReset` or `UnexpectedEof`
10430 TRACE Cannot retry error: not an IO error
10431 WARN Range requests not supported for scikit_learn-1.7.0-cp313-cp313-manylinux_2_17_x86_64.manylinux2014_x86_64.whl; streaming wheel
</code></pre>
<p>to</p>
<pre><code class="language-log">9705 TRACE Getting metadata for scikit_learn-1.7.0-cp313-cp313-manylinux_2_17_x86_64.manylinux2014_x86_64.whl by range request
# With no further error
</code></pre>
<p>Here is the patch. It isn't necessarily the correct change to make, but it shows that it is possible.</p>
<pre><code>git diff
diff --git a/crates/uv-client/src/base_client.rs b/crates/uv-client/src/base_client.rs
index 85c384b0d..9ce3b2797 100644
--- a/crates/uv-client/src/base_client.rs
+++ b/crates/uv-client/src/base_client.rs
@@ -96,7 +96,7 @@ impl RedirectPolicy {
     pub fn reqwest_policy(self) -&gt; reqwest::redirect::Policy {
         match self {
             RedirectPolicy::BypassMiddleware =&gt; reqwest::redirect::Policy::default(),
-            RedirectPolicy::RetriggerMiddleware =&gt; reqwest::redirect::Policy::none(),
+            RedirectPolicy::RetriggerMiddleware =&gt; reqwest::redirect::Policy::default(),
         }
     }
 }
</code></pre>
<p>Resolution is still slow - they both resolve in about 5 sec. I can send you the logs if you want, but its getting late here (CET) and I should go to bed now.</p>
</p>
</details> 

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thomasaarholt">@thomasaarholt</a> on 2025-06-30 07:21</div>
            <div class="timeline-body"><p>The latest ADO update will be live in a few weeks. I will update here then. It'll be much easier to debug using ADO feeds that don't require authentication. From what I can tell, we definitely support range requests, but there might be some tweaking on either our or uv's end to support faster package resolution.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/laenan8466">@laenan8466</a> on 2025-10-22 16:54</div>
            <div class="timeline-body"><p>Revisiting this, do you have an update for us @thomasaarholt ?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:25 UTC
    </footer>
</body>
</html>
