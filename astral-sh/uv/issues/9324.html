<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv sync produces a large (9.5GB) docker layer upon build - astral-sh/uv #9324</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>uv sync produces a large (9.5GB) docker layer upon build</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/9324">#9324</a>
        opened by <a href="https://github.com/fortminors">@fortminors</a>
        on 2024-11-21 15:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/fortminors">@fortminors</a> on 2024-11-21 15:08</div>
            <div class="timeline-body"><p>I have the following pyproject.toml:</p>
<pre><code class="language-toml">[project]
name = &quot;cv_tests&quot;
version = &quot;0.1.0&quot;
description = &quot;cv_tests&quot;
authors = [
    {name=&quot;me&quot;, email=&quot;me@me.com&quot;},
]
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.11&quot;
dependencies = [
    &quot;circle-fit&gt;=0.2.1&quot;,
    &quot;einops&gt;=0.8.0&quot;,
    &quot;fastapi&gt;=0.115.4&quot;,
    &quot;imutils&gt;=0.5.4&quot;,
    &quot;matplotlib&gt;=3.9.2&quot;,
    &quot;open-clip-torch&gt;=2.29.0&quot;,
    &quot;opencv-contrib-python&gt;=4.10.0.84&quot;,
    &quot;opencv-python&gt;=4.10.0.84&quot;,
    &quot;pyrealsense2&gt;=2.55.1.6486&quot;,
    &quot;safetensors&gt;=0.4.5&quot;,
    &quot;scikit-image&gt;=0.24.0&quot;,
    &quot;scikit-learn&gt;=1.5.2&quot;,
    &quot;scipy&gt;=1.14.1&quot;,
    &quot;shapely&gt;=2.0.6&quot;,
    &quot;transformers&gt;=4.46.1&quot;,
    &quot;ultralytics&gt;=8.3.27&quot;,
    &quot;uvicorn&gt;=0.32.0&quot;,
    &quot;xformers&gt;=0.0.28.post3&quot;,
    &quot;sam-2&quot;,
    &quot;setuptools&gt;=75.3.0&quot;,
    &quot;torch-tensorrt&gt;=2.5.0&quot;,
    &quot;pre-commit&gt;=4.0.1&quot;,
    &quot;lakefs&gt;=0.7.1&quot;,
]

[tool.uv.sources]
sam-2 = { git = &quot;https://github.com/facebookresearch/segment-anything-2.git&quot;, rev = &quot;c2ec8e14a185632b0a5d8b161928ceb50197eddc&quot; }
</code></pre>
<p>and the following Dockerfile:</p>
<pre><code class="language-Dockerfile">FROM nvcr.io/nvidia/cuda:12.6.2-cudnn-devel-ubuntu22.04

# https://docs.docker.com/reference/dockerfile/#shell-and-exec-form
# https://manpages.ubuntu.com/manpages/noble/en/man1/sh.1.html
SHELL [&quot;/bin/sh&quot;, &quot;-exc&quot;]

ARG DEBIAN_FRONTEND=noninteractive
ARG python_version=3.11

COPY --link --from=ghcr.io/astral-sh/uv:0.5.2 /uv /usr/local/bin/uv

RUN apt-get update --quiet &amp;&amp; \
    apt-get upgrade -y &amp;&amp; \
    apt-get install --quiet --no-install-recommends -y build-essential git ca-certificates \
    libgl1 libglib2.0-0 libusb-1.0-0-dev &amp;&amp; \
    # Forcing http 1.1 to fix https://stackoverflow.com/q/59282476
    git config --global http.version HTTP/1.1 &amp;&amp; \
    uv python install $python_version

ENV UV_PYTHON=&quot;python$python_version&quot; \
    UV_PYTHON_DOWNLOADS=never \
    UV_PROJECT_ENVIRONMENT=/app \
    UV_LINK_MODE=copy \
    PYTHONFAULTHANDLER=1 \
    PYTHONUNBUFFERED=1 \
    UV_COMPILE_BYTECODE=1 \
    PYTHONOPTIMIZE=1

WORKDIR /project
COPY pyproject.toml uv.lock README.md /project

# Building deps
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --no-dev --no-install-project --frozen

</code></pre>
<p>It builds successfully, however when the last RUN command is executed, it creates a huge layer of size 9.5 GB.
I inspected it with <a href="https://github.com/wagoodman/dive">dive</a>, to find that it is all taken by /app/lib/python3.11/site-packages
<img src="https://github.com/user-attachments/assets/7a93f3a7-3c8c-4888-92e7-13e3b5a16433" alt="image" />
<img src="https://github.com/user-attachments/assets/b399d76c-daab-468a-b287-61e9dc1fec23" alt="image" /></p>
<p>I thought that whenever I do <code>RUN --mount=type=cache,target=/root/.cache/uv</code>, the packages are cached internally in a local docker instance and it is not a part of the current image that I am building. Is there anything I can do about that? I thought of building a base (reusable) image with thick packages like pytorch and then inheriting from it and installing the other packages, so to split the installation in several layers, but then I would need several .toml project configurations and lock files. So I am curious what is the best way to do that? I am not sure if multi-stage build would help me here, but I might be mistaken.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-22 14:48</div>
            <div class="timeline-body"><p>I don't quite follow the issue. <code>uv sync</code> installs the packages. If the layer is big because of installed packages, I'm not sure what we could do differently.</p>
<p>Using a cache mount can speed up installation, but won't remove the installed packages from the image because then it'd be broken.</p>
<p>You could try <code>--no-install-package &lt;big-package&gt;</code> to separate that one out from the rest.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2024-11-22 14:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fortminors">@fortminors</a> on 2024-11-22 15:11</div>
            <div class="timeline-body"><p>Thank you for the suggestion. I thought that if I use <code>RUN --mount=type=cache,target=/root/.cache/uv</code>, it will mount the packages and cache to the image, but now that I think of it, <code>RUN --mount</code> invokes a temporary mount during build time only, so launching scripts won't work - there will be no packages any longer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @fortminors on 2024-11-22 15:11</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:24 UTC
    </footer>
</body>
</html>
