<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv pip compile` drops mention of extras, totally losing dependency annotations via constraints - astral-sh/uv #4256</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`uv pip compile` drops mention of extras, totally losing dependency annotations via constraints</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/4256">#4256</a>
        opened by <a href="https://github.com/funkybob">@funkybob</a>
        on 2024-06-11 23:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/funkybob">@funkybob</a> on 2024-06-11 23:47</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

<p>Using : uv-0.2.10-py3-none-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
Environment: <code>python:3.11-slim</code> docker container</p>
<p>I recently switched from <code>pip-compile</code> to <code>uv</code> and am generally pleased, however today I noticed (after discovering it doesn't write the output by default) that when a package requirement has extras, these aren't written out.</p>
<p>e.g. <code>django-storages[s3]</code> is written out as simply <code>django-storages</code></p>
<pre><code>django-storages==1.14.2
    # via -r requirements.in
</code></pre>
<p>At the first level, this has no direct impact; All the requirements are still commented as being required by this package:</p>
<pre><code>boto3==1.34.15
    # via
    #   -r requirements.in
    #   django-storages
</code></pre>
<p>Howerver, my <code>-dev.in</code> file which has a <code>-c</code> constraint on the main <code>requirements.txt</code> no longer carries over these comments, as it can no longer see the information -- the <code>requirements.txt</code> doesn't have <code>django-storages[s3]</code>, only <code>django-storages</code></p>
<pre><code>django-storages==1.14.2
    # via -r requirements.txt
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-11 23:51</div>
            <div class="timeline-body"><p>You can pass <code>--no-strip-extras</code> to retain these.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-11 23:53</div>
            <div class="timeline-body"><p>This shouldn't matter though -- extras just add additional dependencies, and they're all written out in the output requirements anyway. I believe pip-compile plans to make this the default too in the next release.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/funkybob">@funkybob</a> on 2024-06-11 23:55</div>
            <div class="timeline-body"><p>Firstly, thanks for the very quick response!</p>
<blockquote>
<p>You can pass --no-strip-extras to retain these.</p>
</blockquote>
<p>OK, so another unexpected difference from <code>pip-tools</code> behavior. Got it.</p>
<blockquote>
<p>This shouldn't matter though -- extras just add additional dependencies, and they're all written out in the output requirements anyway. I believe pip-compile plans to make this the default too in the next release.</p>
</blockquote>
<p>Whilst I recognise it makes no difference to the packages that eventually get installed, it matters because I, the developer, lose the information that helps me track dependencies.</p>
<p>Otherwise, why emit those comments in the first place?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-11 23:59</div>
            <div class="timeline-body"><p>Ah, I see, you want <code>django-storages[s3]</code> in the <em>comment</em>. I don't think we include the extra in the comment regardless.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-11 23:59</div>
            <div class="timeline-body"><p>(I thought you were referring to the emitted dependency.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-12 00:00</div>
            <div class="timeline-body"><p>Or am I again misinterpreting? Because <code>pip-compile</code> doesn't include the extras in the comments either.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/funkybob">@funkybob</a> on 2024-06-12 00:02</div>
            <div class="timeline-body"><p>No, to clarify I want my <code>requirements-dev.txt</code> to include in the comments that one of the reasons <code>boto3</code> was included was <code>django-storages</code>.</p>
<p>Adding <code>--no-strip-extras</code> has achieved this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-12 00:05</div>
            <div class="timeline-body"><p>Ahh, ok, I see. Glad it's working! And sorry for the confusion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/funkybob">@funkybob</a> on 2024-06-12 00:09</div>
            <div class="timeline-body"><p>If one doesn't exist already, I might contribute a docs update to include some tips on differences when moving from <code>pip-tools</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dperetti">@dperetti</a> on 2024-06-12 00:26</div>
            <div class="timeline-body"><p>Amazing, I was experimenting the same kind of confusion at the exact same time as @funkybob, as I was installing <code>django-anymail[mailgun]</code>. I came here for clarification and boom, this post!</p>
<p>That said, I noticed something that should probably be addressed:</p>
<p>If I install an extra that does not exist (&quot;blah&quot;, here), pip warns about it:</p>
<pre><code>pip install &quot;django-anymail[blah]&quot;

&gt;WARNING: django-anymail 8.2 does not provide the extra 'blah'
...
</code></pre>
<p>But uv says nothing about it:</p>
<pre><code>uv pip -v install &quot;django-anymail[blah]&quot;
Searching for Python interpreter in virtual environments
DEBUG Found CPython 3.11.8 at `/home/project/.venv/bin/python3` (virtual environment)
DEBUG Using Python 3.11.8 environment at .venv/bin/python3
DEBUG Acquired lock for `.venv`
DEBUG Requirement satisfied: asgiref&lt;4, &gt;=3.7.0
DEBUG Requirement satisfied: certifi&gt;=2017.4.17
DEBUG Requirement satisfied: charset-normalizer&lt;4, &gt;=2
DEBUG Requirement satisfied: django-anymail[mailgunqqsdqd]
DEBUG Requirement satisfied: django&gt;=2.0
DEBUG Requirement satisfied: idna&lt;4, &gt;=2.5
DEBUG Requirement satisfied: requests&gt;=2.4.3
DEBUG Requirement satisfied: sqlparse&gt;=0.3.1
DEBUG Requirement satisfied: urllib3&lt;3, &gt;=1.21.1
DEBUG Requirement satisfied: urllib3&gt;=1.25.0
Audited 1 package in 5ms
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/funkybob">@funkybob</a> on 2024-06-12 00:45</div>
            <div class="timeline-body"><p>Ah, should I open a separate ticket about how <code>uv</code> is not emitting the <code>--extra-index-url</code> line from the <code>requirements.in</code>?</p>
<p>I should have spotted this when I had to add it to the <code>requirements-dev.in</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-12 00:46</div>
            <div class="timeline-body"><p>You can add <code>--emit-index-url</code>. Check out <code>uv pip compile --help</code> for the full list!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-12 00:46</div>
            <div class="timeline-body"><p>@dperetti -- We do emit it on install:</p>
<pre><code>Downloaded 7 packages in 528ms
Installed 9 packages in 44ms
 + asgiref==3.8.1
 + certifi==2024.6.2
 + charset-normalizer==3.3.2
 + django==5.0.6
 + django-anymail==10.3
 + idna==3.7
 + requests==2.32.3
 + sqlparse==0.5.0
 + urllib3==2.2.1
warning: The package `django-anymail==10.3` does not have an extra named `blah`.
</code></pre>
<p>But not when the package is already installed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/funkybob">@funkybob</a> on 2024-06-12 00:51</div>
            <div class="timeline-body"><blockquote>
<p>You can add <code>--emit-index-url</code>. Check out <code>uv pip compile --help</code> for the full list!</p>
</blockquote>
<p>So many changes in behavior :/</p>
<p>Perhaps a &quot;--pip-tools-compat&quot; flag is warranted?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-06-12 00:56</div>
            <div class="timeline-body"><blockquote>
<p>I might contribute a docs update to include some tips on differences when moving from <code>pip-tools</code></p>
</blockquote>
<p>It seems like this won't be a difference for very long, if I don't specify <code>--strip-extras</code> or <code>--no-strip-extras</code> on the latest version of pip-tools I get this warning:</p>
<blockquote>
<p>$  pip-compile requirements.in
WARNING: --strip-extras is becoming the default in version 8.0.0. To silence this warning, either use --strip-extras to opt into the new default or use --no-strip-extras to retain the existing behavior.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/funkybob">@funkybob</a> on 2024-06-12 01:04</div>
            <div class="timeline-body"><p>Indeed, however it's a loud difference with a clear deprecation path and timeline.</p>
<p>I'm slowly discovering all the quiet differences between uv and pip-tools.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/funkybob">@funkybob</a> on 2024-06-12 01:05</div>
            <div class="timeline-body"><blockquote>
<p>You can add <code>--emit-index-url</code>. Check out <code>uv pip compile --help</code> for the full list!</p>
</blockquote>
<p>For those playing along at home, this does work, but it <em>also</em> emits <code>--index-url</code> -- another departure from<code>pip-tools</code> behavior, though granted &quot;explicit is better than implicit&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-12 01:06</div>
            <div class="timeline-body"><p>I appreciate where you're coming from but I consider these to be fairly minimal differences. We have different defaults for the <code>--strip</code> and <code>--emit</code> flags, and one of them is about to pip-tools default anyway. A contribution to the <code>PIP_COMPATIBILITY.md</code> to cover these would be welcome, if you're up for it, but I think all the choices we made here are very reasonable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/funkybob">@funkybob</a> on 2024-06-12 01:11</div>
            <div class="timeline-body"><p>Not arguing the validity of the choices.</p>
<p>It's more that since this is pitched as a <code>drop in replacement</code> ... it should default to behaving the same as the tools it's replacing.</p>
<p>Or have a flag to do that.</p>
<p>I will make time this afternoon to formulate a patch for the docs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-12 03:02</div>
            <div class="timeline-body"><p>Sorry to hear you've been having a hard time transitioning. We've tried to avoid implementing deprecated behavior in both <code>pip</code> and <code>pip tools</code> so there are definitely some differences â€” which is why we try to clearly outline the expectations in the compatibility guide.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2024-06-12 03:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-13 14:03</div>
            <div class="timeline-body"><p>Closed by https://github.com/astral-sh/uv/pull/4302. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-06-13 14:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:58 UTC
    </footer>
</body>
</html>
