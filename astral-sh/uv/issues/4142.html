<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv lock` should not treat non-compliant `pyproject.toml` fields as dynamic - astral-sh/uv #4142</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`uv lock` should not treat non-compliant `pyproject.toml` fields as dynamic</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/4142">#4142</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-06-07 19:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-07 19:16</div>
            <div class="timeline-body"><p>e.g. with an invalid dependency section</p>
<pre><code class="language-toml">[project.dependencies]
python = &quot;^3.12&quot;
msgspec = &quot;^0.18.4&quot;
twine = &quot;^4.0.2&quot;
hatchling = &quot;^1.20.0&quot;
chevron-blue = &quot;^0.2.1&quot;
setuptools = &quot;^69.1.1&quot;
pypiserver = { version =&quot;^2.0.1&quot;, optional = true}
watchfiles = { version = &quot;^0.21.0&quot;,  optional = true}
pyyaml = &quot;^6.0.1&quot;
</code></pre>
<p><code>uv lock</code> happily locked this project because I had retained the Poetry dependency section too</p>
<pre><code class="language-toml">[tool.poetry.dependencies]
python = &quot;^3.12&quot;
msgspec = &quot;^0.18.4&quot;
twine = &quot;^4.0.2&quot;
hatchling = &quot;^1.20.0&quot;
chevron-blue = &quot;^0.2.1&quot;
setuptools = &quot;^69.1.1&quot;
pypiserver = { version =&quot;^2.0.1&quot;, optional = true}
watchfiles = { version = &quot;^0.21.0&quot;,  optional = true}
pyyaml = &quot;^6.0.1&quot;
</code></pre>
<p>With verbose logs, I can see that the invalid data means that we treat the entire <code>pyproject.toml</code> as dynamic and presumably use the build backend (Poetry) to get the dependencies?</p>
<blockquote>
<p><code>DEBUG No static pyproject.toml available for: packse @ file:///Users/zb/workspace/packse (DynamicPyprojectToml(Toml(Error { inner: Error { inner: TomlError { message: &quot;invalid type: map, expected a sequence&quot;, raw: Some(&quot;[project]\nname = \&quot;packse\&quot;\nversion = \&quot;0.0.0\&quot;\ndescription = \&quot;\&quot;\nauthors = [\&quot;Zanie &lt;contact@zanie.dev&gt;\&quot;]\nreadme = \&quot;README.md\&quot;\nkeywords = [\n  \&quot;uv\&quot;, \&quot;packse\&quot;, \&quot;requirements\&quot;, \&quot;packaging\&quot;, \&quot;testing\&quot;\n]\nclassifiers = [\n  \&quot;Development Status :: 4 - Beta\&quot;,\n  \&quot;Environment :: Console\&quot;,\n  \&quot;Intended Audience :: Developers\&quot;,\n  \&quot;Operating System :: OS Independent\&quot;,\n  \&quot;License :: OSI Approved :: MIT License\&quot;,\n  \&quot;License :: OSI Approved :: Apache Software License\&quot;,\n  \&quot;Programming Language :: Python\&quot;,\n  \&quot;Programming Language :: Python :: 3.12\&quot;,\n  \&quot;Programming Language :: Python :: 3 :: Only\&quot;,\n  \&quot;Topic :: Software Development :: Quality Assurance\&quot;,\n  \&quot;Topic :: Software Development :: Testing\&quot;,\n  \&quot;Topic :: Software Development :: Libraries\&quot;,\n]\n\n\n[project.scripts]\npackse = \&quot;packse.cli:entrypoint\&quot;\n\n[project.dependencies]\npython = \&quot;^3.12\&quot;\nmsgspec = \&quot;^0.18.4\&quot;\ntwine = \&quot;^4.0.2\&quot;\nhatchling = \&quot;^1.20.0\&quot;\nchevron-blue = \&quot;^0.2.1\&quot;\nsetuptools = \&quot;^69.1.1\&quot;\npypiserver = { version =\&quot;^2.0.1\&quot;, optional = true}\nwatchfiles = { version = \&quot;^0.21.0\&quot;,  optional = true}\npyyaml = \&quot;^6.0.1\&quot;\n\n[project.optional-dependencies]\nindex = [\&quot;pypiserver\&quot;]\nserve = [\&quot;pypiserver\&quot;, \&quot;watchfiles\&quot;]\n\n[tool.uv]\ndev-dependencies = [\n  \&quot;syrupy&gt;=4.6.0\&quot;,\n  \&quot;pytest&gt;=7.4.3\&quot;,\n  \&quot;psutil&gt;=5.9.7\&quot;,\n]\n\n[tool.poetry]\nname = \&quot;packse\&quot;\nversion = \&quot;0.0.0\&quot;\ndescription = \&quot;\&quot;\nauthors = [\&quot;Zanie &lt;contact@zanie.dev&gt;\&quot;]\nreadme = \&quot;README.md\&quot;\nkeywords = [\n  \&quot;uv\&quot;, \&quot;packse\&quot;, \&quot;requirements\&quot;, \&quot;packaging\&quot;, \&quot;testing\&quot;\n]\nclassifiers = [\n  \&quot;Development Status :: 4 - Beta\&quot;,\n  \&quot;Environment :: Console\&quot;,\n  \&quot;Intended Audience :: Developers\&quot;,\n  \&quot;Operating System :: OS Independent\&quot;,\n  \&quot;License :: OSI Approved :: MIT License\&quot;,\n  \&quot;License :: OSI Approved :: Apache Software License\&quot;,\n  \&quot;Programming Language :: Python\&quot;,\n  \&quot;Programming Language :: Python :: 3.12\&quot;,\n  \&quot;Programming Language :: Python :: 3 :: Only\&quot;,\n  \&quot;Topic :: Software Development :: Quality Assurance\&quot;,\n  \&quot;Topic :: Software Development :: Testing\&quot;,\n  \&quot;Topic :: Software Development :: Libraries\&quot;,\n]\n\n\n[tool.poetry.scripts]\npackse = \&quot;packse.cli:entrypoint\&quot;\n\n[tool.poetry.dependencies]\npython = \&quot;^3.12\&quot;\nmsgspec = \&quot;^0.18.4\&quot;\ntwine = \&quot;^4.0.2\&quot;\nhatchling = \&quot;^1.20.0\&quot;\nchevron-blue = \&quot;^0.2.1\&quot;\nsetuptools = \&quot;^69.1.1\&quot;\npypiserver = { version =\&quot;^2.0.1\&quot;, optional = true}\nwatchfiles = { version = \&quot;^0.21.0\&quot;,  optional = true}\npyyaml = \&quot;^6.0.1\&quot;\n\n[tool.poetry.extras]\nindex = [\&quot;pypiserver\&quot;]\nserve = [\&quot;pypiserver\&quot;, \&quot;watchfiles\&quot;]\n\n[tool.poetry.group.dev.dependencies]\nsyrupy = \&quot;^4.6.0\&quot;\npytest = \&quot;^7.4.3\&quot;\nruff = \&quot;^0.1.12\&quot;\npsutil = \&quot;^5.9.7\&quot;\n\n[build-system]\nrequires = [\&quot;poetry-core\&quot;]\nbuild-backend = \&quot;poetry.core.masonry.api\&quot;\n\n[tool.ruff.lint]\nextend-select = [\&quot;I\&quot;, \&quot;W292\&quot;]\npreview = true\nexclude = [\&quot;src/packse/templates/**/*\&quot;, \&quot;build/**/*\&quot;, \&quot;dist/**/*\&quot;]\n&quot;), keys: [&quot;project&quot;, &quot;dependencies&quot;], span: Some(786..1054) } } })))</code></p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @zanieb on 2024-06-07 19:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "`uv lock` should not treat non-compliant fields as dynamic" to "`uv lock` should not treat non-compliant `pyproject.toml` fields as dynamic" by @zanieb on 2024-06-07 19:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-07 19:17</div>
            <div class="timeline-body"><p>Perhaps there's a feature here? Somehow? It would be cool to be able to use <code>uv lock</code> with my Poetry project definition.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-07 19:18</div>
            <div class="timeline-body"><p>However, if I remove the <code>[project.dependencies]</code> section <code>uv</code> only solves for 19 packages instead of 54. Basically no clue what's happening in there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-07 19:45</div>
            <div class="timeline-body"><p>Can you say more about the last comment? What's the final pyproject.toml in that case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-06-07 19:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-07 19:55</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/packse/commit/56f3c5998e01642277eb6d7bf2cbbf2b2611a8df</p>
<pre><code>[zb/uv-example-i 56f3c59] [project.dependencies] present but invalid
❯ uv lock
warning: `uv lock` is experimental and may change without warning.
Resolved 54 packages in 480ms
</code></pre>
<p>https://github.com/astral-sh/packse/commit/69b9417589d5feb20cf2595d80c481c5bd15421e</p>
<pre><code>[zb/uv-example-ii 69b9417] [project.dependencies] not present
❯ uv lock
warning: `uv lock` is experimental and may change without warning.
Resolved 19 packages in 7ms
</code></pre>
<p>I think what's happening in the latter case is that <code>dependencies</code> is just presumed to be <em>empty</em> so we don't treat it as invalid and don't fetch more from Poetry? Not sure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-07 19:56</div>
            <div class="timeline-body"><p>Hmm yeah. If <code>project.dependencies</code> is omitted but <code>project</code> is present, it's equivalent to <code>project.dependencies = []</code>, per the spec.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-07 20:14</div>
            <div class="timeline-body"><p>That makes sense. Why do we treat the parse error as a dynamic project though?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-07 20:27</div>
            <div class="timeline-body"><p>Yeah that part looks like a bug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-06-09 17:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-09 17:50</div>
            <div class="timeline-body"><p>I got this one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-09 18:49</div>
            <div class="timeline-body"><p>The options here are bad (sigh) because we have to support non-standard stuff like Hatch:</p>
<pre><code class="language-toml">dependencies = [
  &quot;black @ {root:uri}/../black_editable&quot;
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-09 19:01</div>
            <div class="timeline-body"><p>I don't really know what to do here. The above basically means that we have to treat invalid <code>[project]</code> tables as &quot;maybe just dynamic metadata&quot;. Like, we could make it more granular, such that if we fail to parse the <em>version specifiers</em>, we perform this fallback. But that still comes with a similar risk -- if you had <code>&quot;black @ {root:uri}/../black_editable&quot;</code> in your dependencies, then we'd assume it's dynamic, and then Poetry would give us a totally different set of dependencies.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-09 19:08</div>
            <div class="timeline-body"><p>I suppose for now we do a few things to make the common cases better:</p>
<ol>
<li>Make the error case more granular -- so, fail hard if we fail to parse the TOML schema (e.g., it's a map like above when it should be a list), and only use this soft fallback if we fail to parse a requirement. Maybe we make it even stricter, and only do it if they're using Hatch and using context formatting.</li>
<li>Warn if <code>project</code> is defined, but <code>project.dependencies</code> is not, and <code>tool.poetry.dependencies</code> <em>is</em>. In that case, they need to mark <code>project.dependencies</code> as dynamic.</li>
<li>Warn if <code>project</code> is defined, <code>project.dependencies</code> is defined, and <code>tool.poetry.dependencies</code> is <em>also</em> defined. In that case, we'll ignore the Poetry dependencies, so we should tell the user -- it's probably a mistake.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-09 19:13</div>
            <div class="timeline-body"><p>Actually, the last thing isn't right, because in future versions of Poetry they're going to encourage you to use both together (https://website-bj97773t2-python-poetry.vercel.app/docs/dependency-specification/).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4176.html">astral-sh/uv#4176</a> on 2024-06-09 23:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4182.html">astral-sh/uv#4182</a> on 2024-06-10 00:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-06-10 14:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:28 UTC
    </footer>
</body>
</html>
