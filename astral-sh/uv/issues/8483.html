<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv add` leaks credentials to `tool.uv.index` when `UV_DEFAULT_INDEX` is set - astral-sh/uv #8483</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>uv add</code> leaks credentials to <code>tool.uv.index</code> when <code>UV_DEFAULT_INDEX</code> is set</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/8483">#8483</a>
        opened by <a href="https://github.com/kwaegel">@kwaegel</a>
        on 2024-10-23 01:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kwaegel">@kwaegel</a></div>
            <div class="timeline-body"><p>I have a project that uses a private JFrog Artifactory repository to host internal packages, and as a proxy for PyPi. I just noticed that calling <code>uv add internal_package==specific_version</code> when overriding with <code>UV_DEFAULT_INDEX</code> will leak credentials into the <code>pyproject.toml</code> file, even if the lockfile isn't modified.</p>
<p>Original index entry (company name redacted):</p>
<pre><code># Set JFrog Artifactory as the default index.
[[tool.uv.index]]
name = &quot;internal&quot;
url = &quot;https://repos.internal.com/artifactory/api/pypi/internal-pypi/simple&quot;
default = true
</code></pre>
<p>Command (a no-op, since the package version already exists as a dependency):</p>
<pre><code>$uv add internal_package==version
Resolved M packages in 2ms
Audited N packages in 0.87ms
</code></pre>
<p>After running that command, the <code>tool.uv.index</code> section has removed the <code>name = internal</code> line, inserted the full repo URL, including authentication tokens, and removed the comments:</p>
<pre><code>[[tool.uv.index]]
url = &quot;https://USERNAME:REDACTED@repos.internal.com/artifactory/api/pypi/internal-pypi/simple&quot;
default = true
</code></pre>
<p>Summary:</p>
<ul>
<li>I was not expecting credentials to get saved to <code>pyproject.toml</code></li>
<li>I was not expecting that setting <code>UV_DEFAULT_INDEX</code> before running <code>uv add</code> would modify <code>pyproject.toml</code> at all (including removing comments).</li>
</ul>
<p>uv version 0.4.25</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "`uv add` leaks credentials to `tool.uv.index`" to "`uv add` leaks credentials to `tool.uv.index` when `UV_DEFAULT_INDEX` is set" by @kwaegel on 2024-10-23 01:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kwaegel">@kwaegel</a> on 2024-10-23 03:07</div>
            <div class="timeline-body"><p>I tried using <code>UV_INDEX_URL</code> (which is marked as deprecated) instead of <code>UV_DEFAULT_INDEX</code>, and it seems to work without leaking credentials, but it also emitted a warning suggesting that the behaviour I'm seeing might be intentional?</p>
<pre><code>warning: Indexes specified via `--index-url` will not be persisted to the `pyproject.toml` file; use `--default-index` instead.
</code></pre>
<p>Not sure what to do in this case, since I want to set <code>UV_INDEX_URL</code> (for <code>uv pip</code> commands to pick up), but also not overwrite/leak credentials when I already have <code>pyproject.toml</code> configured properly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-10-23 12:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-10-23 12:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-23 12:55</div>
            <div class="timeline-body"><p>It's just a bug. We shouldn't be overwriting with credentials like that IMO.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-23 13:39</div>
            <div class="timeline-body"><p>I'll fix it for today's release.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-10-23 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dan-jacobson">@dan-jacobson</a> on 2024-11-12 00:14</div>
            <div class="timeline-body"><p>Hey @charliermarsh, I'm still seeing a variant of this behavior with <code>uv 0.5.1</code>, IF the <code>UV_DEFAULT_INDEX</code> is set, but there's no existing <code>[[tool.uv.index]]</code> in the <code>pyproject.toml</code>.</p>
<p>Just to be clear, it's not overwriting the existing <code>[[tool.uv.index]]</code> anymore, it's only setting when it's blank. So I can go in and delete the token when I know to look for it.</p>
<p>But it does leak creds into <code>pyproject.toml</code> going through a standard new project workflow of <code>uv init</code> -&gt; <code>uv add</code> with my <code>UV_DEFAULT_INDEX</code> set. Feels like this has a decent potential to be a foot-gun.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-12 03:42</div>
            <div class="timeline-body"><p>You're right! Thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gaspardc-met">@gaspardc-met</a> on 2025-01-06 15:13</div>
            <div class="timeline-body"><p>Hey,</p>
<p>Sorry to chime in on a closed issue, but I did get owned by this issue recently, using <code>uv==0.5.11</code>.
Both <code>UV_DEFAULT_INDEX</code> and <code>UV_EXTRA_INDEX_URL</code> are defined as environment variables, but I did not set anything in <code>pyproject.toml</code>, so using <code>uv add library</code> leaked my private info.</p>
<p>I have read the docs on configuration and private indexes, but I don't get the point of defining a <code>[[tool.uv.index]]</code> entry in the <code>pyproject.toml</code> if you have environment variables or a proper global <code>uv.toml</code> file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-06 15:16</div>
            <div class="timeline-body"><p>That's ok. I thought I fixed it but I may be misremembering -- I'll look again today.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:27:53 UTC
    </footer>
</body>
</html>
