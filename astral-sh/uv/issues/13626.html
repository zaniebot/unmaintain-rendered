<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optionally disable file locking - astral-sh/uv #13626</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Optionally disable file locking</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/13626">#13626</a>
        opened by <a href="https://github.com/eaubin">@eaubin</a>
        on 2025-05-23 20:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/eaubin">@eaubin</a> on 2025-05-23 20:42</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I have the same problem and situation as https://github.com/astral-sh/uv/issues/9050, my cluster has a lustre file system with flock disabled and admins are unwilling to enable it. Trying to install something with uv errors with:</p>
<pre><code>In error: Could not acquire lock for `.local/share/uv/python` at `.local/share/uv/python/.lock`: Function not implemented (os error 38)
</code></pre>
<p>@zanieb rightfully points out that uv needs to take locks to prevent concurrent access to state.</p>
<p>I'd be happy to give up safety though to make uv usable on my cluster. Could uv take an <code>UV_UNSAFE_IGNORE_FLOCK</code> option and not attempt flock or ignore flock errors?</p>
<h3>Example</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @eaubin on 2025-05-23 20:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-23 21:04</div>
            <div class="timeline-body"><p>I'd be okay with something like that, personally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/philipp-fischer">@philipp-fischer</a> on 2025-05-28 15:50</div>
            <div class="timeline-body"><p>Hitting the same issue</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-05-28 15:51</div>
            <div class="timeline-body"><p>I'm fine with that too. Or, can we fallback to a more rudimentary form of locking?</p>
<p>cc @geofft</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by @zanieb on 2025-05-28 15:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-05-28 15:52</div>
            <div class="timeline-body"><p>(It seems fine to take the incremental step of just letting you turn it off first, regardless)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @zanieb on 2025-05-28 15:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CodeMan62">@CodeMan62</a> on 2025-05-28 16:35</div>
            <div class="timeline-body"><p>i will try to do this and propose a PR asap</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/geofft">@geofft</a> on 2025-05-28 17:18</div>
            <div class="timeline-body"><p>Yeah, an option to disable locking seems sensible to me (especially if there's &quot;unsafe&quot; in its name), regardless of what else we do.</p>
<p>The documentation should point out exactly what is unsafe and how to not get yourself into problems. My understanding is: for things like <code>uv python install</code> or <code>uv tool</code>, you can only have one running copy of <code>uv</code> at a time in the same home directory (same account), even on multiple computers. For things like <code>uv sync</code>, you can run it once <em>per environment</em>. But this gets a little dicey in that sometimes <code>uv</code> will automatically install a new Python version if needed, etc. Also, common things like <code>uv run</code> will want to at least consider <code>uv sync</code>, meaning it's a little dangerous to <code>uv run</code> on multiple computers if you disable locking, right? That seems like a surprising limitation, especially for people running in a clustered environment. Is <code>uv run --no-sync</code> / <code>export UV_NO_SYNC=1</code> sufficient to make this safe?</p>
<hr />
<p>@eaubin, I guess you've already gone down this road, but if your admins haven't already seen it, https://wiki.lustre.org/Mounting_a_Lustre_File_System_on_Client_Nodes says:</p>
<blockquote>
<p><code>flock</code>: enable support for cluster-wide, coherent POSIX file locks ('flock'). Must be applied to the <code>mount</code> commands for all clients that will be accessing common data requiring lock functionality. This has no measurable performance impact in modern (2.x) versions of Lustre (this page previously stated there was a performance impact; this is not correct for modern versions). This is the recommended mode, and is enabled by default in Lustre 2.13 and newer.&quot;</p>
</blockquote>
<p>Also, if you're not specifically trying to use uv across the cluster (on multiple nodes) and you just happen to be on a workstation with a Lustre home directory, you might be better served by putting the uv install directory onto local disk somewhere, which you can do with <a href="https://docs.astral.sh/uv/reference/cli/#uv-tool-dir"><code>UV_TOOL_DIR</code></a>. You may also need <a href="https://docs.astral.sh/uv/reference/settings/#cache-dir"><code>UV_CACHE_DIR</code></a>.</p>
<p>(Out of curiosity, what's your intended workflow, as in, on which machines are you running <code>uv</code> and on which machines do you intend to actually have it change anything? In particular, if your workflow is something like running <code>uv</code> on one machine to set up an environment and then access it read-only from a compute cluster, and so you really only need single-machine locking <em>but</em> you need the Python interpreter to be installed on Lustre, I think there are some potential designs in uv to make this use case easier.)</p>
<hr />
<p>Let me do some research on locks and add some comments on #9050 in a bit, it's a little complicated and I want to make sure I say something accurate :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/13760.html">astral-sh/uv#13760</a> on 2025-06-01 12:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-11 02:05</div>
            <div class="timeline-body"><p>These errors are now non-fatal, is that sufficient to close the issue?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eaubin">@eaubin</a> on 2025-07-11 14:16</div>
            <div class="timeline-body"><p>Thanks @charliermarsh! Tested with 0.7.20 and confirmed it warns and proceeds.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @eaubin on 2025-07-11 14:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/philipp-fischer">@philipp-fischer</a> on 2025-07-16 13:09</div>
            <div class="timeline-body"><p>Am I doing something wrong?</p>
<pre><code>$ uv tool install megatron-energon
error: Could not acquire lock for `/home/pfischer/.local/share/uv/tools` at `/home/pfischer/.local/share/uv/tools/.lock`: Function not implemented (os error 38)
$ uv self update
info: Checking for updates...
success: You're on the latest version of uv (v0.7.21)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-16 13:21</div>
            <div class="timeline-body"><p>We only made this non-fatal this in routes where it writes outside of uv-controlled directories; we didn't make it non-fatal everywhere, though we could.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/philipp-fischer">@philipp-fischer</a> on 2025-07-16 14:56</div>
            <div class="timeline-body"><p>I think it'd make sense. Right now it seems there is no way I can install anything with <code>uv tool install</code> if the FS is a network fs (which currently is true for almost any folder in my context)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:33:06 UTC
    </footer>
</body>
</html>
