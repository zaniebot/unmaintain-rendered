<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv pip compile ... -o` gives misleading errors on race conditions - astral-sh/uv #6239</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`uv pip compile ... -o` gives misleading errors on race conditions</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/6239">#6239</a>
        opened by <a href="https://github.com/binarybana">@binarybana</a>
        on 2024-08-20 00:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/binarybana">@binarybana</a> on 2024-08-20 00:53</div>
            <div class="timeline-body"><p>I completely understand if this is a <code>closedwontfix</code> scenario since I was obviously using it wrong, but figured I'd report it anyways in case you wanted to lock output files more defensively to protect against (perhaps more legitimate) failure modes.</p>
<p>But I recently triggered a situation where <code>uv compile requirements.in -o requirements.txt</code> was being triggered multiple times in parallel (by pre-commit hooks where I forgot to set <code>pass_filenames: false</code> if you're curious), and racing itself while reading the output file leading to misleading errors.</p>
<p>I built a minimal repro script to demonstrate the output:</p>
<pre><code>❯ cat run.sh
#!/bin/bash

for i in {1..200}; do
    uv pip compile -q requirements.in -o requirements.txt &amp;
done

wait

❯ cat requirements.in
torch&gt;2

❯ ./run.sh
error: Unexpected '', expected '-c', '-e', '-r' or the start of a requirement at requirements.txt:4:1
error: Unexpected '', expected '-c', '-e', '-r' or the start of a requirement at requirements.txt:2:1
error: error: Unexpected '', expected '-c', '-e', '-r' or the start of a requirement at requirements.txt:12:1
Unexpected '', expected '-c', '-e', '-r' or the start of a requirement at requirements.txt:13:1
error: Unexpected '', expected '-c', '-e', '-r' or the start of a requirement at requirements.txt:1:1
error: Couldn't parse requirement in `requirements.txt` at position 310
  Caused by: after parsing '1.13.2', found '', which is not part of a valid version
sympy==1.13.2
     ^^^^^^^^
error: Unexpected '', expected '-c', '-e', '-r' or the start of a requirement at requirements.txt:2:1
</code></pre>
<p>Anyways, thanks for the great project, we're using it now internally and it's been really nice so far.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-20 02:10</div>
            <div class="timeline-body"><p>Interesting. Thanks for the report. We probably could / should take a lock here? cc @charliermarsh</p>
<p>Glad to hear you like the project!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-08-20 02:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-08-20 20:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-08-20 20:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-08-20 20:36</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 04:47:35 UTC
    </footer>
</body>
</html>
