<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BUG: `uv tree --invert --package ...` sometimes also displays packages I didn't ask for - astral-sh/uv #11349</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>BUG: `uv tree --invert --package ...` sometimes also displays packages I didn't ask for</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/11349">#11349</a>
        opened by <a href="https://github.com/neutrinoceros">@neutrinoceros</a>
        on 2025-02-09 09:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/neutrinoceros">@neutrinoceros</a> on 2025-02-09 09:03</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>When I run <code>uv tree --invert --package ...</code> against astropy, I sometimes get more packages to show up in the displayed tree than I asked for, which seems like a bug.
This is obvious when requesting a single package as root and limiting the depth to 0.</p>
<pre><code>❯ git clone https://github.com/astropy/astropy
❯ cd astropy
❯ uv tree --invert --package setuptools -d 0 --no-config
Resolved 166 packages in 8ms
asdf-astropy v0.7.0
setuptools v75.8.0
❯ uv tree --invert --package six -d 0 --no-config
Resolved 166 packages in 8ms
asdf-astropy v0.7.0
six v1.17.0
</code></pre>
<p>In all cases I found that reproduce this problem, <code>asdf-astropy</code> seems to be the one package that show up uninvited. However, it may or may not show up depending on the package I ask for:</p>
<pre><code>❯ uv tree --invert --package numpy -d 0
Resolved 166 packages in 1ms
numpy v2.2.2
</code></pre>
<p>The output seems consistent (no randomness I can see) for any given command, however I don't have a clear idea why <code>--package numpy</code> works and <code>--package six</code> doesn't. My experiments suggest it has nothing to do with numpy being a direct and hard dependency to astropy, as I also hit the bug with <code>--package astropy-iers-data</code></p>
<pre><code>❯ uv tree --invert --package astropy-iers-data -d 0
Resolved 166 packages in 1ms
asdf-astropy v0.7.0
astropy-iers-data v0.2025.2.3.0.32.42
</code></pre>
<p>I wasn't able to reproduce this with a simpler package, though I admit I only tried a bottom-up approach; I did not attempt to simplify astropy's dependencies.</p>
<h3>Platform</h3>
<p>macOS 15.3 arm64</p>
<h3>Version</h3>
<p>uv 0.5.29 (ca73c4754 2025-02-05)</p>
<h3>Python version</h3>
<p>Python 3.12.9</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @neutrinoceros on 2025-02-09 09:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-09 18:11</div>
            <div class="timeline-body"><p>Thanks, we'll take a look.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-09 18:23</div>
            <div class="timeline-body"><p>I think this is because there's a circular dependency in the graph, whereby <code>asdf-astropy</code> depends on <code>astropy</code>, but <code>astropy</code> depends on <code>asdf-astropy</code> -- at least, as far as I can tell? So, like, it's <em>trying</em> to show you that <code>setuptools</code> is required by <code>astropy-sphinx-theme</code> which is required by <code>sphinx-astropy</code> which is required by <code>astropy</code>, but then <code>astropy</code> is both required by and requires <code>asdf-astropy</code>, which is hard to display.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/neutrinoceros">@neutrinoceros</a> on 2025-02-09 19:10</div>
            <div class="timeline-body"><blockquote>
<p>asdf-astropy depends on astropy, but astropy depends on asdf-astropy -- at least, as far as I can tell?</p>
</blockquote>
<p><a href="https://github.com/astropy/asdf-astropy/blob/462068492628f01901cb7f6f3b4f2fb46de3945f/pyproject.toml#L24">I can confirm it does</a>, and sorry for not thinking of this earlier !</p>
<blockquote>
<p>I think this is because there's a circular dependency in the graph (...) which is hard to display.</p>
</blockquote>
<p>Granted. Maybe the cycle could be indicated as <code>...</code>, inspired by the Python repr for self-referential objects, as in</p>
<pre><code class="language-py">&gt;&gt;&gt; L = []
&gt;&gt;&gt; L.append(L)
&gt;&gt;&gt; print(L)
[[...]]
</code></pre>
<p>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JadenMajid">@JadenMajid</a> on 2025-02-10 08:53</div>
            <div class="timeline-body"><p>Hi, can i work on this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/15907.html">astral-sh/uv#15907</a> on 2025-09-17 11:51</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:32:59 UTC
    </footer>
</body>
</html>
