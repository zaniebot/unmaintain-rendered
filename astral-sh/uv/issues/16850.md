```yaml
number: 16850
title: "Build cache pollution with `no-build-isolation-package` + `match-runtime = true`"
type: issue
state: open
author: ryan-clancy
labels:
  - bug
  - great writeup
  - external
assignees: []
created_at: 2025-11-25T19:44:10Z
updated_at: 2025-11-26T16:48:02Z
url: https://github.com/astral-sh/uv/issues/16850
synced_at: 2026-01-10T01:57:37Z
```

# Build cache pollution with `no-build-isolation-package` + `match-runtime = true`

---

_Issue opened by @ryan-clancy on 2025-11-25 19:44_

### Summary

# Build cache pollution with `no-build-isolation-package` + `match-runtime = true`

When using `no-build-isolation-package` with `extra-build-dependencies` and `match-runtime = true`, changing the runtime dependency version (e.g., torch) doesn't trigger a rebuild. Setuptools reuses stale build artifacts from `src/build/` inside the sdist cache.

Impacts any package requiring `no-build-isolation` with torch, e.g., `flash-attn`, `xformers`. Repro uses `fast_jl` for faster iteration.

## Repro

```toml
[project]
name = "repro"
version = "0.1.0"
requires-python = ">=3.10"
dependencies = ["torch==2.6.0", "fast_jl==0.1.3"]

[tool.uv]
no-build-isolation-package = ["fast-jl"]

[tool.uv.extra-build-dependencies]
fast-jl = [{ requirement = "torch", match-runtime = true }]

[[tool.uv.dependency-metadata]]
name = "fast-jl"
version = "0.1.3"
requires-dist = ["torch"]
```

```bash
uv sync  # builds fast_jl against torch 2.6.0
uv run python -c "import torch; import fast_jl; print('success')" # run, works fine
# change torch to 2.7.0 in pyproject.toml
uv sync  # reuses stale .so, import fails with undefined symbol
uv run python -c "import torch; import fast_jl; print('success')" # run, throws error
```

## Root cause

uv correctly creates separate cache slots per build config hash (e.g., `f3e277be7cca2a73` for torch 2.6, `951f323efb6ab57b` for torch 2.7). However, all builds share the same `src/` directory, and setuptools caches compiled artifacts in `src/build/`.

When torch version changes:

1. uv computes new cache hash, runs build in shared `src/`
2. setuptools sees source unchanged, skips recompilation
3. stale `.so` gets packaged into new cache slot

Both cached wheels end up with identical binaries (verified via md5sum).

## Workaround

Force setuptools to rebuild extensions:

```toml
config-settings-package = { fast-jl = { "--global-option" = ["build_ext", "--force"] } }
```

Ideally, we should not need to do this.

### Platform

Dedbian 11 (amd64)

### Version

uv 0.9.10

### Python version

3.13.0

---

_Label `bug` added by @ryan-clancy on 2025-11-25 19:44_

---

_Comment by @zanieb on 2025-11-25 19:48_

Hm, shouldn't setuptools be including the packages present in the build environment in its cache key? I'm not sure we can fix the problem on our end if setuptools is doing intermediate caching.

---

_Label `great writeup` added by @zanieb on 2025-11-25 19:48_

---

_Comment by @ryan-clancy on 2025-11-25 20:06_

@zanieb would deleting the `src/build` dir (e.g., in `~/.cache/uv/sdists-v9/pypi/fast-jl/0.1.3/<sdist-hash>/src/build/`) if a change in the dependencies are detected and `match-runtime = true` be possible? If I do this manually before the second `uv sync` in the repro it looks to run properly.

It seems like this is related to https://github.com/astral-sh/uv/issues/15218 and https://github.com/astral-sh/uv/pull/15289, but it needs to go one step further to cover cases like this.

---

_Comment by @zanieb on 2025-11-25 20:12_

I'm not sure if that's sound, since we'd be encoding behavior specific to `setuptools` and it could change at any time.

The other two issues were about encoding information we have control over in our cache key. It's plausible we can do something here, but (without going deep) it seems outside of our purview.

I think you should at least open an issue in setuptools about the use-case and see if they have recommendations. It's plausible that the solution you have (just forcing setuptools to disable caching) is appropriate? I think the alternative would be for them to provide an option to configure their cache directory, and we could place it within the respective wheel caches or something?

---

_Label `external` added by @konstin on 2025-11-26 16:45_

---

_Comment by @konstin on 2025-11-26 16:48_

This is IMHO a setuptools bug, we're only seeing this kind of problem with setuptools, but not with other build backends, other build backends either don't use a directory in the source tree or they use the cache invalidation of the underlying compiler which is sensitive to such version changes.

---
