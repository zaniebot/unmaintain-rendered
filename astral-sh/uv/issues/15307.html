<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UV_BUILD_CONCURRENCY not working - astral-sh/uv #15307</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>UV_BUILD_CONCURRENCY not working</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/15307">#15307</a>
        opened by <a href="https://github.com/mo22">@mo22</a>
        on 2025-08-15 13:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/mo22">@mo22</a> on 2025-08-15 13:23</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Hi, my goal is to have uv build only a single package at a time to prevent out of memory bugs.</p>
<pre><code>export UV_CONCURRENT_BUILDS=1
uv sync --locked
</code></pre>
<p>However uv spawns multiple build processes (bdist_wheel, setuptools)</p>
<pre><code>pstree $$
uv─┬─python───python───python───cmake───ninja───sh───x86_64-linux-gn───cc1plus
   ├─python───cmake───gmake───gmake───gmake───sh───c++───cc1plus
   └─22*[{uv}]
</code></pre>
<pre><code>uv self version
uv 0.8.8
uname -a
Linux ubuntu 6.8.0-71-generic #71-Ubuntu SMP PREEMPT_DYNAMIC Tue Jul 22 16:52:38 UTC 2025 x86_64 x86_64 x86_64 GNU/Linux
</code></pre>
<p>Am I misunderstanding the setting or might this be a bug?</p>
<h3>Platform</h3>
<p>Linux 6.8.0-71-generic x86_64 GNU/Linux</p>
<h3>Version</h3>
<p>uv 0.8.8</p>
<h3>Python version</h3>
<p>Python 3.12.3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @mo22 on 2025-08-15 13:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-15 13:25</div>
            <div class="timeline-body"><p>I don't see <code>UV_BUILD_CONCURRENCY</code> in our code base. Do you mean <a href="https://docs.astral.sh/uv/reference/environment/#uv_concurrent_builds">UV_CONCURRENT_BUILDS</a>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2025-08-15 13:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mo22">@mo22</a> on 2025-08-15 13:39</div>
            <div class="timeline-body"><blockquote>
<p>I don't see <code>UV_BUILD_CONCURRENCY</code> in our code base. Do you mean <a href="https://docs.astral.sh/uv/reference/environment/#uv_concurrent_builds">UV_CONCURRENT_BUILDS</a>?</p>
</blockquote>
<p>you are completely right - I am setting <code>UV_CONCURRENT_BUILDS</code>, still the same issue. Sorry for the confusion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-15 14:06</div>
            <div class="timeline-body"><p>Can you share a small MRE?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mo22">@mo22</a> on 2025-08-15 19:39</div>
            <div class="timeline-body"><p>Will try as soon as I find time.</p>
<p>For now, looking at <code>./crates/uv-build-frontend/src/lib.rs</code> in the current version, it looks as if every SourceBuild creates its own PythonRunner instance that takes the (correct) concurrency as an argument - but the number of SourceBuild instances itself is not limited.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mo22">@mo22</a> on 2025-08-17 10:50</div>
            <div class="timeline-body"><p>Hi @zanieb,</p>
<p>I've prepared a MRE at https://github.com/mo22/uv-concurrency-test</p>
<pre><code>uv sync --verbose
DEBUG running bdist_wheel
DEBUG running bdist_wheel
DEBUG running build
DEBUG pkg1 build start
DEBUG running build
DEBUG pkg2 build start
</code></pre>
<p>the <code>pkg2 build start</code> should print only after <code>pkg1 build end</code> is printed.</p>
<p>Cause seems to be that the PythonRunner instance with the concurrency semaphore is created for every SourceDist and not passed down globally.</p>
<p>Maybe BuildContext should provide the PythonRunner shared?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:29 UTC
    </footer>
</body>
</html>
