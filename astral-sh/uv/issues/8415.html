<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question about reducing code duplication in `[tool.uv.sources]` - astral-sh/uv #8415</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Question about reducing code duplication in `[tool.uv.sources]`</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/8415">#8415</a>
        opened by <a href="https://github.com/zmeir">@zmeir</a>
        on 2024-10-21 11:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/zmeir">@zmeir</a> on 2024-10-21 11:20</div>
            <div class="timeline-body"><p>I'll start by saying this is probably not a very common use-case, but I wanted to ask this in case there is some better way of doing what I'm doing that I couldn't find in the documentation.</p>
<p>I have a project with some internal packages as dependencies. These packages are published to a private index, which is then mirrored to 2 different locations. One of these locations is on the same network segment as our development environments, so for development purposes is it faster to download packages from this index. The second one is faster for our ci/automation/production environments. I can differentiate between the environments with the <code>sys_platform</code> marker (we develop on mac and windows, but deploy on linux).</p>
<p>I thought about setting up the <code>[tool.uv.sources]</code> table in <code>pyproject.toml</code> like this:</p>
<pre><code class="language-toml">[tool.uv.sources]
internal-package-1 = [
    { index = &quot;private-index-dev&quot;, marker = &quot;sys_platform == 'darwin' or sys_platform == 'win32'&quot; },
    { index = &quot;private-index-prd&quot;, marker = &quot;sys_platform != 'darwin' and sys_platform != 'win32'&quot; },
]
internal-package-2 = [
    { index = &quot;private-index-dev&quot;, marker = &quot;sys_platform == 'darwin' or sys_platform == 'win32'&quot; },
    { index = &quot;private-index-prd&quot;, marker = &quot;sys_platform != 'darwin' and sys_platform != 'win32'&quot; },
]
internal-package-3 = [
    { index = &quot;private-index-dev&quot;, marker = &quot;sys_platform == 'darwin' or sys_platform == 'win32'&quot; },
    { index = &quot;private-index-prd&quot;, marker = &quot;sys_platform != 'darwin' and sys_platform != 'win32'&quot; },
]
</code></pre>
<p>The same 2 lines for <code>private-index-dev</code> and <code>private-index-prd</code> are repeated for each internal package.</p>
<p>Is there any way to prevent this duplication?</p>
<p>As far as I know TOML doesn't support variable substitution, so I can't do something like this:</p>
<pre><code class="language-toml">[tool.uv.sources]
internal-package-settings = [
    { index = &quot;private-index-dev&quot;, marker = &quot;sys_platform == 'darwin' or sys_platform == 'win32'&quot; },
    { index = &quot;private-index-prd&quot;, marker = &quot;sys_platform != 'darwin' and sys_platform != 'win32'&quot; },
]
internal-package-1 = {internal-package-settings}
internal-package-2 = {internal-package-settings}
internal-package-3 = {internal-package-settings}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-21 13:54</div>
            <div class="timeline-body"><p>Interesting. Thanks for sharing. I guess we could add something like <code>[tool.uv.source-definitions]</code> then allow <code>tool.uv.sources.&lt;package&gt; = { definition = ... }</code></p>
<p>It certainly adds some complexity though, so I'm hesitant to pursue it without more requests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @zanieb on 2024-10-21 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wish</span> added by @zanieb on 2024-10-21 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sanmai-NL">@sanmai-NL</a> on 2025-02-24 10:57</div>
            <div class="timeline-body"><p>@zmeir Can you please evaluate <a href="https://www.kcl-lang.io/docs/user_docs/getting-started/intro">KCL</a> for this as a more generic and powerful solution? @zanieb the functional scope of such tools may serve as a good boundary for uv's vision on the scope wrt. templating functionality. After all, implementing such functionality is costly and prone to design issues that need to be revisited later (breaking changes). Then functionally, it's also bound to be complex for users which then results in documentation cost and support cost.</p>
<p>@zmeir you would write a template <code>pyproject.k</code> and do the transformations/DRY stuff in there.</p>
<pre><code class="language-sh">kcl run pyproject.k --format toml
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zmeir">@zmeir</a> on 2025-02-24 20:26</div>
            <div class="timeline-body"><p>@sanmai-NL Thanks for the suggestion. Right now, with a handful of packages, this isn't such a big deal for me. At least not enough to add another level of indirection to my projects. But if it gets too complex I'll be sure to take a crack at it.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 03:52:38 UTC
    </footer>
</body>
</html>
