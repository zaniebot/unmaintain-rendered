<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bug: Overriding self as workspace (to remove constraints on self from dependencies) prevents uv from installing dev-deps - astral-sh/uv #10121</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>bug: Overriding self as workspace (to remove constraints on self from dependencies) prevents uv from installing dev-deps</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/10121">#10121</a>
        opened by <a href="https://github.com/pawamoy">@pawamoy</a>
        on 2024-12-23 14:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/pawamoy">@pawamoy</a></div>
            <div class="timeline-body"><p>Follow-up of https://github.com/astral-sh/uv/issues/8148.</p>
<pre><code class="language-toml">[build-system]
requires = [&quot;pdm-backend&quot;]
build-backend = &quot;pdm.backend&quot;

[project]
name = &quot;repro-uv-8148-a&quot;
description = &quot;&quot;
authors = [{name = &quot;TimothÃ©e Mazzucotelli&quot;, email = &quot;dev@pawamoy.fr&quot;}]
license = {text = &quot;ISC&quot;}
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.9&quot;
keywords = []
dynamic = [&quot;version&quot;]
dependencies = []

[tool.pdm]
version = {source = &quot;scm&quot;}

[tool.pdm.build]
package-dir = &quot;src&quot;

[dependency-groups]
dev = [
    &quot;repro-uv-8148-b&gt;=0.1&quot;,
]

[tool.uv]
# Tell uv to ignore constraints on the main package.
# This is needed when the current project doesn't have Git tags (fork, CI).
override-dependencies = [&quot;repro-uv-8148-a&quot;]
sources = { repro-uv-8148-a = { workspace = true } }
</code></pre>
<p>When I tested the solution to #8148 by installing uv from sources, running <code>uv sync</code> in https://github.com/pawamoy-forks/repro-uv-8148-a was correctly installing the development dependencies, i.e. <code>repro-uv-8148-b</code>.</p>
<p>I just upgraded from my version installed from sources (0.5.4+) to uv 0.5.11, and dev-deps aren't installed anymore.</p>
<p>To reproduce:</p>
<pre><code class="language-bash">git clone git@github.com:pawamoy-forks/repro-uv-8148-a
cd repro-uv-8148-a
uv sync
</code></pre>
<p>Observe that the development dependency <code>repro-uv-8148-b</code> was not installed in <code>.venv</code>.</p>
<p>Logs:</p>
<pre><code class="language-console">% uv sync --verbose        
DEBUG uv 0.5.11
DEBUG Found project root: `/media/data/dev/repro-uv-8148-a`
DEBUG No workspace root found, using project root
DEBUG Using Python request `&gt;=3.9` from `requires-python` metadata
DEBUG Searching for Python &gt;=3.9 in managed installations or search path
DEBUG Searching for managed installations at `/home/pawamoy/.local/share/uv/python`
DEBUG Found managed installation `cpython-3.13.0rc3-linux-x86_64-gnu`
DEBUG Found `cpython-3.13.0rc3-linux-x86_64-gnu` at `/home/pawamoy/.local/share/uv/python/cpython-3.13.0rc3-linux-x86_64-gnu/bin/python3.13` (managed installations)
DEBUG Skipping pre-release cpython-3.13.0rc3-linux-x86_64-gnu
DEBUG Found managed installation `cpython-3.11.7-linux-x86_64-gnu`
DEBUG Found `cpython-3.11.7-linux-x86_64-gnu` at `/home/pawamoy/.local/share/uv/python/cpython-3.11.7-linux-x86_64-gnu/bin/python3.11` (managed installations)
Using CPython 3.11.7
Creating virtual environment at: .venv
DEBUG Assessing Python executable as base candidate: /home/pawamoy/.local/share/uv/python/cpython-3.11.7-linux-x86_64-gnu/bin/python3.11
DEBUG Using base executable for virtual environment: /home/pawamoy/.local/share/uv/python/cpython-3.11.7-linux-x86_64-gnu/bin/python3.11
DEBUG Using request timeout of 30s
DEBUG No static `pyproject.toml` available for: repro-uv-8148-a @ file:///media/data/dev/repro-uv-8148-a (PyprojectToml(DynamicField(&quot;version&quot;)))
DEBUG Acquired lock for `/media/data/.cache/uv/sdists-v6/editable/7fd03d4f10b5ac48`
DEBUG Using cached metadata for: repro-uv-8148-a @ file:///media/data/dev/repro-uv-8148-a
DEBUG No workspace root found, using project root
DEBUG Released lock at `/media/data/.cache/uv/sdists-v6/editable/7fd03d4f10b5ac48/.lock`
DEBUG Solving with installed Python version: 3.11.7
DEBUG Solving with target Python version: &gt;=3.9
DEBUG Adding direct dependency: repro-uv-8148-a*
DEBUG Adding direct dependency: repro-uv-8148-a*
DEBUG Searching for a compatible version of repro-uv-8148-a @ file:///media/data/dev/repro-uv-8148-a (*)
DEBUG Tried 1 versions: repro-uv-8148-a 1
DEBUG all marker environments resolution took 0.000s
Resolved 1 package in 1ms
DEBUG Using request timeout of 30s
DEBUG Directory source requirement already cached: repro-uv-8148-a==0.1.dev5+g9507e17.d20241223 (from file:///media/data/dev/repro-uv-8148-a)
Installed 1 package in 0.66ms
 + repro-uv-8148-a==0.1.dev5+g9507e17.d20241223 (from file:///media/data/dev/repro-uv-8148-a)
</code></pre>
<p><strong>This behavior started in 0.5.7.</strong></p>
<p>Related:</p>
<ul>
<li>https://github.com/astral-sh/uv/pull/9455</li>
</ul>
<p>Possibly related:</p>
<ul>
<li>https://github.com/astral-sh/uv/pull/9716</li>
<li>https://github.com/astral-sh/uv/pull/9717</li>
<li>https://github.com/astral-sh/uv/pull/9705</li>
<li>https://github.com/astral-sh/uv/pull/9714</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-23 15:10</div>
            <div class="timeline-body"><p>I honestly don't know if what you're doing here should work. I don't know if a package should be able to override itself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-23 15:15</div>
            <div class="timeline-body"><p>I think I have some idea of what's going wrong here though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pawamoy">@pawamoy</a> on 2024-12-23 15:22</div>
            <div class="timeline-body"><p>I don't know either! But I mean... why not? We have this escape hatch for dependencies, so when the project itself is a dependency of a dependency, we should be able to override it too ðŸ¤· I override self because that's the only thing I can do here, but this could be called differently, and done differently by uv, something like --if-the-only-conflict-is-on-my-project-install-it-anyway ðŸ˜‚</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-23 15:23</div>
            <div class="timeline-body"><p>I think there <em>is</em> a bug here, which we'll fix, I'm just not sure I want to call this officially supported :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pawamoy">@pawamoy</a> on 2024-12-23 15:23</div>
            <div class="timeline-body"><p>Understood ðŸ˜„ ðŸ¤ž</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pawamoy">@pawamoy</a> on 2024-12-23 15:26</div>
            <div class="timeline-body"><p>I'm actually surprised I'm the only one reporting this. Must be the combo self-cyclic-dep + dynamic-version + no-tags ðŸ˜…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-23 15:31</div>
            <div class="timeline-body"><p>I think it's specifically about overriding a workspace member that has dependency groups.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-23 15:32</div>
            <div class="timeline-body"><p>I think it's just super uncommon to use an override with a workspace member?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pawamoy">@pawamoy</a> on 2024-12-23 15:45</div>
            <div class="timeline-body"><p>Probably. That's just the only way I get to fix this issue ðŸ˜• The ideal solution would require of level of communication between the frontend and the backend that is not currently possible:</p>
<ul>
<li>frontend verifies constraints as usual</li>
<li>but if and only if the backend fails to compute the right version for the current project due to missing SCM data, then ignore the current project version (consider the constraints satisfied)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pawamoy">@pawamoy</a> on 2024-12-23 15:48</div>
            <div class="timeline-body"><p>I could definitely just document in my CONTRIBUTING files that contributors <em>must</em> pull tags, but that's equally weird IMO, I've never seen any such requirement ðŸ˜… Not hard per-se, just unusual for contributors.</p>
<pre><code class="language-bash">git clone ...; cd ...
git remote add upstream https://...
git pull upstream --tags
</code></pre>
<p>Heh, maybe I could put these into my <code>make setup</code> command (somehow detecting that <code>origin</code> isn't the main repo).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pawamoy">@pawamoy</a> on 2024-12-23 15:53</div>
            <div class="timeline-body"><p>Honestly, feel free to close and reconsider if more people chime in. I've bothered you enough with this ðŸ™‡</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pawamoy">@pawamoy</a> on 2024-12-23 22:54</div>
            <div class="timeline-body"><p>Hey Charlie, I found my brain and crafted a pdm-backend solution instead:</p>
<pre><code class="language-toml">[tool.pdm.version]
source = &quot;call&quot;
getter = &quot;scripts.get_version:get_version&quot;
</code></pre>
<pre><code class="language-python"># scripts/get_version.py
import re
from pathlib import Path

from pdm.backend.hooks.version import Version, SCMVersion, get_version_from_scm, default_version_formatter

_root = Path(__file__).parent.parent
_changelog = _root / &quot;CHANGELOG.md&quot;
_changelog_version_re = re.compile(r&quot;^## \[(\d+\.\d+\.\d+)\].*$&quot;)
_default_scm_version = SCMVersion(Version(&quot;0.0.0&quot;), None, False, None, None)


def get_version():
    scm_version = get_version_from_scm(_root) or _default_scm_version
    if scm_version.version &lt;= Version(&quot;0.1&quot;):  # Missing Git tags?
        if _changelog.exists():
            with _changelog.open() as file:
                for line in file:
                    if match := _changelog_version_re.match(line):
                        scm_version = scm_version._replace(version=Version(match.group(1)))
                        break
    return default_version_formatter(scm_version)
</code></pre>
<p>Basically, it's dynamic versioning based on SCM + falling back onto grepping the CHANGELOG.md file.</p>
<p>I will let you close this since you mentioned you found an issue, but consider this resolved on my end ðŸ™‚</p>
<p>Thank you so much for your patience, your kind responses, and your help ðŸ’Ÿ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-12-26 14:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:29:01 UTC
    </footer>
</body>
</html>
