<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pyproject.toml created with poetry is invalid on versions after 0.2.11 - astral-sh/uv #4521</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>pyproject.toml created with poetry is invalid on versions after 0.2.11</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/4521">#4521</a>
        opened by <a href="https://github.com/lskbr">@lskbr</a>
        on 2024-06-25 16:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/lskbr">@lskbr</a> on 2024-06-25 16:34</div>
            <div class="timeline-body"><p>I updated my uv to version 0.2.15 today, and I noticed some configurations in my pyproject.toml were not being applied, especially extra indexes. Running in debug mode, I noticed it complains that the pyproject.toml is malformed and misses a project section.
In version 0.2.15, the error is the same, but after it, the section [tool.uv.pip] is ignored. In version 0.2.11, the project section is not present and the error reported is the same, but [tool.uv.pip] is honored.</p>
<p>Up to version 0.2.11, the same toml works without any problem.
From version 0.2.12 up to 0.2.15, the pyproject.toml is declared invalid.</p>
<p>I'm using Azure ADO artifact repository, so I use pyproject.toml to setup the repo URL.</p>
<p>Example pyproject.toml with tainted extra-index-url, it must fail.</p>
<pre><code>[tool.poetry]
name = &quot;nilo&quot;
version = &quot;0.1.0&quot;
description = &quot;&quot;
authors = [&quot;Nilo Menezes &lt;x@mail.com&gt;&quot;]
readme = &quot;README.md&quot;

[tool.poetry.dependencies]
python = &quot;^3.10&quot;
rich = &quot;^13.7.1&quot;

[build-system]
requires = [&quot;poetry-core&quot;]
build-backend = &quot;poetry.core.masonry.api&quot;

[tool.uv.pip]
extra-index-url=[&quot;https://dummy.com&quot;]
</code></pre>
<p>Run with uv 0.2.15:</p>
<pre><code>$ uv pip compile pyproject.toml --verbose
DEBUG uv 0.2.15
DEBUG Starting toolchain discovery for any Python
DEBUG Looking for exact match for request any Python
DEBUG Searching for Python interpreter in system toolchains
DEBUG Found cpython 3.10.12 at `/home/nilo/.pyenv/shims/python3` (search path)
DEBUG Using Python 3.10.12 interpreter at /usr/bin/python3 for builds
DEBUG Using request timeout of 30s
DEBUG Acquired lock for `/home/nilo/.cache/uv/built-wheels-v3/path/0916cbb14bd2b497`
DEBUG Preparing metadata for: file:///home/nilo/tmp/
DEBUG No static `PKG-INFO` available for: file:///home/nilo/tmp/ (MissingPkgInfo)
DEBUG No static `pyproject.toml` available for: file:///home/nilo/tmp/ (PyprojectToml(FieldNotFound(&quot;project&quot;)))
INFO Ignoring empty directory
DEBUG Solving with installed Python version: 3.10.12
DEBUG Adding direct dependency: poetry-core*
DEBUG Found stale response for: https://pypi.org/simple/poetry-core/
DEBUG Sending revalidation request for: https://pypi.org/simple/poetry-core/
DEBUG Found not-modified response for: https://pypi.org/simple/poetry-core/
DEBUG Searching for a compatible version of poetry-core (*)
DEBUG Selecting: poetry-core==1.9.0 (poetry_core-1.9.0-py3-none-any.whl)
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/a1/8d/85fcf9bcbfefcc53a1402450f28e5acf39dcfde3aabb996a1d98481ac829/poetry_core-1.9.0-py3-none-any.whl.metadata
DEBUG Tried 1 versions: poetry-core 1
DEBUG Installing in poetry-core==1.9.0 in /home/nilo/.cache/uv/environments-v0/.tmpZXul8h
</code></pre>
<p>Run with uv 0.2.11:</p>
<pre><code>$ uv pip compile pyproject.toml --verbose
DEBUG Starting toolchain discovery for any Python
DEBUG Looking for exact match for request any Python
DEBUG Searching for Python interpreter in all sources
DEBUG Found CPython 3.10.12 at `/home/nilo/.pyenv/shims/python3` (search path)
DEBUG Using Python 3.10.12 interpreter at /usr/bin/python3 for builds
DEBUG Using request timeout of 30s
DEBUG Acquired lock for `/home/nilo/.cache/uv/built-wheels-v3/path/0916cbb14bd2b497`
DEBUG Preparing metadata for: file:///home/nilo/tmp/
DEBUG No static `PKG-INFO` available for: file:///home/nilo/tmp/ (MissingPkgInfo)
DEBUG No static `pyproject.toml` available for: file:///home/nilo/tmp/ (PyprojectToml(FieldNotFound(&quot;project&quot;)))
INFO Ignoring empty directory
DEBUG Solving with installed Python version: 3.10.12
DEBUG Adding direct dependency: poetry-core*
DEBUG No cache entry for: https://dummy.com/poetry-core/
DEBUG Searching for a compatible version of poetry-core (*)
DEBUG No compatible version found for: poetry-core
</code></pre>
<p>With uv 0.2.15 and pyproject using poetry sections, build fails, as tool.uv.pip section is ignored.
Same pyproject.toml with uv 0.2.11, no problem at all.</p>
<p>It looks like some sections of pyproject are being ignored when the error (PyprojectToml(FieldNotFound(&quot;project&quot;))) is reported.
Up to version 0.2.11, the tool.uv.pip section was used, even after (PyprojectToml(FieldNotFound(&quot;project&quot;))). Starting on 0.2.12, the tool.uv.pip is ignored. Changing the pyproject to include a [project] sections fix the issue, but require the migration of the pyproject.toml and stop using poetry.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-06-25 16:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-25 16:42</div>
            <div class="timeline-body"><p>I can take a look at it. I'm surprised by this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-06-25 16:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by @charliermarsh on 2024-06-25 16:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-25 17:59</div>
            <div class="timeline-body"><p>Oh, we stopped reading configuration from <code>pyproject.toml</code> files that aren't part of the workspace (and that file doesn't comprise a valid workspace because it's lacking a <code>project</code> table), instead requiring the use of <code>uv.toml</code>. We may want to reconsider though for this use-case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-06-25 18:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-06-25 18:53</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 05:34:17 UTC
    </footer>
</body>
</html>
