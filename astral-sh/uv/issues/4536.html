<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply Absorption Law when normalizing markers - astral-sh/uv #4536</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Apply Absorption Law when normalizing markers</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/4536">#4536</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-06-26 01:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><p>E.g., <code>python_version &lt; '3.11' or (python_version &lt; '3.11' and implementation_name == 'cpython')</code> should be reduced to <code>python_version &lt; '3.11'</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @charliermarsh on 2024-06-26 01:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-26 01:32</div>
            <div class="timeline-body"><p>I wonder if we should do something like this: https://docs.rs/boolean_expression/latest/boolean_expression/enum.Expr.html#method.simplify_via_bdd</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-26 01:36</div>
            <div class="timeline-body"><p>Alternatively, maybe we can just apply this in the <code>or</code> and <code>and</code> methods (make them smart constructors)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-06-26 02:02</div>
            <div class="timeline-body"><p>I think smart constructors are the way to go. To make smart constructors work, you have to make sure they are the only things capable of constructing the internal representation. You also need to make all normalization steps inductive. On top of this, I think the normalization logic (which would need to be ported to smart constructors in <code>pep508_rs</code>) currently lives in <code>uv-resolver</code> because it relies on a <code>pubgrub</code> type. So that dependency on <code>pubgrub</code> would probably need to be broken.</p>
<p>I would love to do this personally as I love smart constructors and they've worked out great when I used them in the past (like in <code>regex-syntax</code>). But it's a meaty task I think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-06-26 04:02</div>
            <div class="timeline-body"><p>I'm not sure the smart constructor helps with the simplification. For example, the expression <code>((x and y) or z)</code> is fully simplified, but combining that with <code>or y</code> we get <code>((x and y) or z) or y</code>, which simplifies to <code>y or z</code>. Importantly, the complete simplification cannot be performed inductively, so a SAT solver (<a href="https://docs.sympy.org/latest/modules/logic.html#sympy.logic.boolalg.to_dnf">such as this</a>) would need to be run after the entire marker tree has been constructed.</p>
<p>I think it would be helpful to know what kind of expressions the lockfile generates to see how far we need to take this. We can solve this issue using our current recursive approach and see whether more complex cases come up. It's totally possible that an inductive approach that only looks one layer deep is enough for us, but I would hesitate to add smart constructors and them end up not being useful because we need to do a recursive solve anyways.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw-gts">@notatallshaw-gts</a> on 2024-07-01 17:23</div>
            <div class="timeline-body"><p>FYI I came across this today with the following example:</p>
<pre><code>$ echo &quot;pylint&quot; | uv pip compile - --annotation-style line --python-version 3.10 --universal 2&gt;/dev/null | grep dill
dill==0.3.8 ; python_version &lt; '3.11' or python_version &gt;= '3.11'  # via pylint
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-01 17:34</div>
            <div class="timeline-body"><p>Confusingly there are Python versions that do not match either of those bounds. For example, <code>3.11.0a0</code> would not match either.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw-gts">@notatallshaw-gts</a> on 2024-07-01 19:46</div>
            <div class="timeline-body"><blockquote>
<p>Confusingly there are Python versions that do not match either of those bounds. For example, <code>3.11.0a0</code> would not match either.</p>
</blockquote>
<p>I don't feel like that's a correct interpretation of Python version numbers.</p>
<p>When you are installing into a Python installation there is only one specific version number available for that Python. So if you are installing into Python 3.11.0a0 then all versions of Python available (i.e. the one you are installing into) are pre-releases and therefore <code>python_version&gt;= 3.11</code> matches <code>3.11.0a0</code>.</p>
<p>But that's just me thinking out loud, when I get a moment I'll check what pip does and read through the spec.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-01 19:48</div>
            <div class="timeline-body"><p>I think per the spec it's correct. I actually agree that we should probably simplify that, but I think that's why it doesn't get simplified today.</p>
<p><code>python_version&gt;= 3.11</code> is implicitly <code>python_version&gt;= 3.11.0</code>, and <code>3.11.0a0</code> is not <code>&gt;= 3.11.0</code>, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw-gts">@notatallshaw-gts</a> on 2024-07-01 19:56</div>
            <div class="timeline-body"><blockquote>
<p>and <code>3.11.0a0</code> is not <code>&gt;= 3.11.0</code>, right</p>
</blockquote>
<p>My understanding is per PEP 440 <code>3.11.0a0</code> matches <code>&gt;= 3.11.0</code>, when <code>3.11.0a0</code> is the only version available because then pre-releases are implied. So my logic was that when you are installing into Python it's version is the only version available, and therefore you can always take pre-releases to be applied.</p>
<p>But, this was just all off the top of my head, I should of really waited to get home and test it out. I will do so later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-07-01 23:14</div>
            <div class="timeline-body"><p>Got home and ran some tests and read some specs and I still think uv isn't correct here, I created a seperate issue: https://github.com/astral-sh/uv/issues/4714</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-02 02:31</div>
            <div class="timeline-body"><p>I filed a separate issue for that normalization here: https://github.com/astral-sh/uv/issues/4719. (It's different than what's described in this issue.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ibraheemdev on 2024-07-08 18:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:25:22 UTC
    </footer>
</body>
</html>
