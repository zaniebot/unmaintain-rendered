```yaml
number: 12483
title: uv add --index updates source registry for all dependencies
type: issue
state: open
author: aranvir
labels:
  - question
assignees: []
created_at: 2025-03-26T11:10:23Z
updated_at: 2025-05-06T11:47:55Z
url: https://github.com/astral-sh/uv/issues/12483
synced_at: 2026-01-10T01:57:28Z
```

# uv add --index updates source registry for all dependencies

---

_Issue opened by @aranvir on 2025-03-26 11:10_

### Question

Hi, this question is related to https://github.com/astral-sh/uv/issues/8341 but I couldn't find more information on it (also not in the docs).

I have a bunch of gitlab package registries that I'd like to add to a project. I did it in the past with `uv add` (at least that's what pyproject.toml shows, lol) but now it's no longer working as expected. E.g., instead of adding just the package and the index reference it widely updates `uv.lock` and adds the index to many of the dependencies. On second glance, this happens because the added package depends on pydantic so now that and all of pydantics dependencies have this source index added although they don't need it.

The command I use is `uv add custom-package --index "http://some-token:super-secret-token@gitlab.private.lan/api/v4/projects/123/packages/pypi/simple"`

I assume in practice this will work fine as uv probably falls back to the default index. Yet what I would have expected is it to just add the registry information for this package only - not for all dependencies.

And lastly, when I compare it to the [docs example](https://docs.astral.sh/uv/concepts/projects/dependencies/#index)
* It does not add `custom-package = { index = "my-index"}`.
* It does not add the "name" field anymore to `[[tool.uv.index]]`. I'm not sure if that was always the case or is just happening now

So in summary:
* Should `uv` update individual dependency registries in the lock file like that?
* What could be a reason for it to not update pyproject.toml as described in the docs?

Thanks!

### Platform

Windows 10

### Version

uv 0.6.10 (f2a2d982b 2025-03-25)

---

_Label `question` added by @aranvir on 2025-03-26 11:10_

---

_Comment by @charliermarsh on 2025-03-26 16:21_

I think the difference with the docs example is that you need to provide a name for the index? Like `uv add custom-package --index my_custom_index=http://some-token:super-secret-token@gitlab.private.lan/api/v4/projects/123/packages/pypi/simple`. Or did you already have a named index defined in the file? If the index doesn't have a name, we can't "pin" it like that.

---

_Referenced in [astral-sh/uv#13064](../../astral-sh/uv/issues/13064.md) on 2025-04-23 08:58_

---

_Comment by @aranvir on 2025-05-06 11:47_

Hi - sorry that it took me so long to come back to this. I know spent some time trying to recreate what I did and what behavior I am expecting:

### Behavior
#### No pyproject.toml preparation
As mentioned before, if I use `uv add custom-package --index "http://some-token:super-secret-token@gitlab.private.lan/api/v4/projects/123/packages/pypi/simple"` it just adds a new index block but drops the token.

```toml
[[tool.uv.index]]
url = "http://gitlab.private.lan/api/v4/projects/123/packages/pypi/simple"
```

This means other users cannot use the same setup.

#### Adding the index manually
Instead, I can prepare the index manually
```toml
[[tool.uv.index]]
name = "some-name"
url = "http://__token__:some-token@gitlab.private.lan/api/v4/projects/123/packages/pypi/simple"
```

Then, `uv add custom-package` works fine, even without the `--index` argument.

Having multiple indexes also works fine, so that solves that.

### Expectation
The package resolution works correct and that is the important part.

However, since uv is so amazing at dependency management, it might be counter-intuitive that an index with tokens is stripped of those and the user has to set up the index manually. I think it's preferred that uv stores the index url as provided by the user. I'd argue that IF a user provides the tokens then it's their intent to store them in the `pyproject.toml` for others to use. If there are security concerns of accidentally storing private tokens, maybe a flag like `--save-tokens` could be used instead to make it explicit.

Regardless, I think it would be good to update the documentation to explain how to use uv with self-hosted package registries like gitlab :)

---
