<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv a uses private extra index URLs for all packages in the uv.lock instead of the main index URL - astral-sh/uv #13938</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv a uses private extra index URLs for all packages in the uv.lock instead of the main index URL</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/13938">#13938</a>
        opened by <a href="https://github.com/Ark-kun">@Ark-kun</a>
        on 2025-06-10 02:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Ark-kun">@Ark-kun</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Config:</p>
<pre><code>% cat ~/.config/uv/uv.toml 
index-url = &quot;https://pypi.python.org/simple&quot;
extra-index-url = [&quot;https://token:XXX@pkgs.shopify.io/basic/data/python/simple/&quot;]

index-strategy = &quot;unsafe-best-match&quot;
</code></pre>
<pre><code>% uv init    
Initialized project `test2`
(backend-test-python) ark@ test2 % uv add six -v
DEBUG uv 0.7.2 (481d05d8d 2025-04-30)
DEBUG Found project root: `/Users/ark/src/github.com/Shopify/test2`
DEBUG No workspace root found, using project root
DEBUG Acquired lock for `/Users/ark/src/github.com/Shopify/test2`
DEBUG Reading Python requests from version file at `/Users/ark/src/github.com/Shopify/test2/.python-version`
DEBUG Using Python request `3.12` from version file at `.python-version`
DEBUG Checking for Python environment at `.venv`
DEBUG Searching for Python 3.12 in managed installations or search path
DEBUG Searching for managed installations at `/Users/ark/.local/share/uv/python`
DEBUG Found managed installation `cpython-3.12.9-macos-aarch64-none`
DEBUG Found `cpython-3.12.9-macos-aarch64-none` at `/Users/ark/.local/share/uv/python/cpython-3.12.9-macos-aarch64-none/bin/python3.12` (managed installations)
Using CPython 3.12.9
Creating virtual environment at: .venv
DEBUG Assessing Python executable as base candidate: /Users/ark/.local/share/uv/python/cpython-3.12.9-macos-aarch64-none/bin/python3.12
DEBUG Using base executable for virtual environment: /Users/ark/.local/share/uv/python/cpython-3.12.9-macos-aarch64-none/bin/python3.12
DEBUG Released lock at `/var/folders/_9/dl_tfx9169q_wbnqf639bn6r0000gn/T/uv-7868c7ccaf7ba2e4.lock`
DEBUG Using request timeout of 30s
DEBUG Found static `pyproject.toml` for: test2 @ file:///Users/ark/src/github.com/Shopify/test2
DEBUG No workspace root found, using project root
DEBUG Solving with installed Python version: 3.12.9
DEBUG Solving with target Python version: &gt;=3.12
DEBUG Adding direct dependency: test2*
DEBUG Searching for a compatible version of test2 @ file:///Users/ark/src/github.com/Shopify/test2 (*)
DEBUG Adding direct dependency: six*
DEBUG Found fresh response for: https://pkgs.shopify.io/basic/data/python/simple/six/
DEBUG Found fresh response for: https://pypi.python.org/simple/six/
DEBUG Searching for a compatible version of six (*)
DEBUG Selecting: six==1.17.0 [compatible] (six-1.17.0-py2.py3-none-any.whl)
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/b7/ce/149a00dd41f10bc29e5921b496af8b574d8413afcd5e30dfa0ed46c2cc5e/six-1.17.0-py2.py3-none-any.whl.metadata
DEBUG Tried 2 versions: six 1, test2 1
DEBUG all marker environments resolution took 0.001s
Resolved 2 packages in 2ms
DEBUG Using request timeout of 30s
DEBUG Found static `pyproject.toml` for: test2 @ file:///Users/ark/src/github.com/Shopify/test2
DEBUG No workspace root found, using project root
DEBUG Ignoring existing lockfile due to mismatched requirements for: `test2==0.1.0`
  Requested: {Requirement { name: PackageName(&quot;six&quot;), extras: [], groups: [], marker: true, source: Registry { specifier: VersionSpecifiers([VersionSpecifier { operator: GreaterThanEqual, version: &quot;1.17.0&quot; }]), index: None, conflict: None }, origin: None }}
  Existing: {Requirement { name: PackageName(&quot;six&quot;), extras: [], groups: [], marker: true, source: Registry { specifier: VersionSpecifiers([]), index: None, conflict: None }, origin: None }}
DEBUG Solving with installed Python version: 3.12.9
DEBUG Solving with target Python version: &gt;=3.12
DEBUG Adding direct dependency: test2*
DEBUG Searching for a compatible version of test2 @ file:///Users/ark/src/github.com/Shopify/test2 (*)
DEBUG Adding direct dependency: six&gt;=1.17.0
DEBUG Searching for a compatible version of six (&gt;=1.17.0)
DEBUG Selecting: six==1.17.0 [preference] (six-1.17.0-py2.py3-none-any.whl)
DEBUG Tried 2 versions: six 1, test2 1
DEBUG all marker environments resolution took 0.000s
DEBUG Using request timeout of 30s
DEBUG Identified uncached distribution: six==1.17.0
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/b7/ce/149a00dd41f10bc29e5921b496af8b574d8413afcd5e30dfa0ed46c2cc5e/six-1.17.0-py2.py3-none-any.whl
Prepared 1 package in 1ms
Installed 1 package in 2ms
 + six==1.17.0
</code></pre>
<p>Resulting uv.lock</p>
<pre><code>version = 1
revision = 2
requires-python = &quot;&gt;=3.12&quot;

[[package]]
name = &quot;six&quot;
version = &quot;1.17.0&quot;
source = { registry = &quot;https://pkgs.shopify.io/basic/data/python/simple/&quot; }
sdist = { url = &quot;https://files.pythonhosted.org/packages/94/e7/b2c673351809dca68a0e064b6af791aa332cf192da575fd474ed7d6f16a2/six-1.17.0.tar.gz&quot;, hash = &quot;sha256:ff70335d468e7eb6ec65b95b99d3a2836546063f63acc5171de367e834932a81&quot;, size = 34031, upload-time = &quot;2024-12-04T17:35:28.174Z&quot; }
wheels = [
    { url = &quot;https://files.pythonhosted.org/packages/b7/ce/149a00dd41f10bc29e5921b496af8b574d8413afcd5e30dfa0ed46c2cc5e/six-1.17.0-py2.py3-none-any.whl&quot;, hash = &quot;sha256:4721f391ed90541fddacab5acf947aa0d3dc7d27b2e1e8eda2be8970586c3274&quot;, size = 11050, upload-time = &quot;2024-12-04T17:35:26.475Z&quot; },
]

[[package]]
name = &quot;test2&quot;
version = &quot;0.1.0&quot;
source = { virtual = &quot;.&quot; }
dependencies = [
    { name = &quot;six&quot; },
]

[package.metadata]
requires-dist = [{ name = &quot;six&quot;, specifier = &quot;&gt;=1.17.0&quot; }]
</code></pre>
<p>Expected:</p>
<pre><code>source = { registry = &quot;https://pypi.python.org/simple/&quot; }
</code></pre>
<p>Actual:</p>
<pre><code>source = { registry = &quot;https://pkgs.shopify.io/basic/data/python/simple/&quot; }
</code></pre>
<h3>Platform</h3>
<p>macOS 15 arm64</p>
<h3>Version</h3>
<p>uv 0.7.2 (481d05d8d 2025-04-30)</p>
<h3>Python version</h3>
<p>Python 3.12.9</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @Ark-kun on 2025-06-10 02:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @jtfmumm by @konstin on 2025-06-10 09:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on 2025-06-10 15:52</div>
            <div class="timeline-body"><p>I've been investigating this issue. Testing with a GitLab package registry (which will internally fall back to PyPI if a package is not found), uv does write the GitLab registry URL to the lockfile as the source just as in your case. Could it be that your registry endpoint through Shopify is either directly using PyPI or falling back to it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-06-10 16:18</div>
            <div class="timeline-body"><p>Could you look at the html of e.g. https://pkgs.shopify.io/basic/data/python/simple/ (with credentials), are the URLs there pointing to shopify or PyPI?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nichmor">@nichmor</a> on 2025-06-13 12:21</div>
            <div class="timeline-body"><blockquote>
<p>I've been investigating this issue. Testing with a GitLab package registry (which will internally fall back to PyPI if a package is not found), uv does write the GitLab registry URL to the lockfile as the source just as in your case. Could it be that your registry endpoint through Shopify is either directly using PyPI or falling back to it?</p>
</blockquote>
<p>For those curious minds that also had this cross-related problem, please verify that your private registry does not fall back by default to pypi. In my case, https://github.com/pypiserver/pypiserver was falling back to the pypi server indeed.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:31:43 UTC
    </footer>
</body>
</html>
