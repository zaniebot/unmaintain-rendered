<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incorrect source registry after using uv lock with custom indexes - astral-sh/uv #13590</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Incorrect source registry after using uv lock with custom indexes</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/13590">#13590</a>
        opened by <a href="https://github.com/praisethedeviI">@praisethedeviI</a>
        on 2025-05-22 08:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/praisethedeviI">@praisethedeviI</a> on 2025-05-22 08:01</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>When using a custom index configuration in pyproject.toml, the <code>uv lock</code> command incorrectly sets the source.registry for ALL packages to the custom index URL, even for packages that should come from PyPI</p>
<hr />
<h3>My toml configuration files</h3>
<ol>
<li>I have pyproject.toml</li>
</ol>
<pre><code class="language-toml">[project]
name = &quot;my-project&quot;
version = &quot;1.0.0&quot;
requires-python = &quot;==3.11.*&quot;
dependencies = [
    &quot;assistant-core&gt;=7.0.7,&lt;8&quot;,
]


[tool.uv]
package = false

[[tool.uv.index]]
name = &quot;assist-core&quot;
# It's actually different domain with gitlab on it
url = &quot;https://gitlab.com/api/v4/groups/949/-/packages/pypi/simple&quot;
explicit = true

[tool.uv.sources]
assistant-core = { index = &quot;assist-core&quot; }
</code></pre>
<ol start="2">
<li>I use uv.toml or UV_INDEX with authentication:</li>
</ol>
<pre><code class="language-toml">[[index]]
name = &quot;assist-core&quot;
# different domain
url = &quot;https://__token__:&lt;TOKEN&gt;@gitlab.com/api/v4/groups/949/-/packages/pypi/simple&quot;
</code></pre>
<hr />
<h3>Expected behavior</h3>
<ul>
<li>Only packages specified in <code>[tool.uv.sources]</code> should have the custom registry as their source</li>
<li>All other packages should maintain <code>source = { registry = &quot;https://pypi.org/simple&quot; }</code></li>
<li>Manually correcting the lockfile and re-running <code>uv lock</code> should not revert the changes</li>
</ul>
<hr />
<h3>Actual behavior</h3>
<ul>
<li>All packages in the lockfile get <code>source = { registry = &quot;https://gitlab.com/...&quot; }</code></li>
<li>Manually correcting the registry to PyPI and re-running <code>uv lock</code> doesn't update the lockfile (suggesting uv doesn't detect this as a change that needs resolution)</li>
</ul>
<hr />
<h3>Additional Context</h3>
<ul>
<li>The issue occurs regardless of whether authentication is provided via uv.toml or UV_INDEX environment variable</li>
<li>The workaround of manually editing the lockfile is not sustainable as it needs to be redone after every dependency update</li>
</ul>
<hr />
<h3>Also:</h3>
<p>After changing the index URL in uv.toml (but index URL in the pyproject.toml hasn't been changed) to <code>url = &quot;https://__token__:&lt;TOKEN&gt;@gitlab.com/api/v4/packages/pypi/simple&quot;</code>, the lockfile was fixed. However:</p>
<ul>
<li><code>uv sync --locked</code> and <code>uv lock --check</code> report that the lockfile needs updating</li>
<li>Meanwhile, <code>uv lock</code>, <code>uv lock --dry-run</code> and <code>uv sync --check</code> report no updates needed and don't modify the file</li>
</ul>
<h3>Platform</h3>
<p>Darwin 24.4.0 arm64</p>
<h3>Version</h3>
<p>uv 0.7.3 (3c413f74b 2025-05-07)</p>
<h3>Python version</h3>
<p>Python 3.11.11</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @praisethedeviI on 2025-05-22 08:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-22 11:37</div>
            <div class="timeline-body"><p>Why are you repeating the index definition across those two files? I don't think they'll get &quot;merged&quot; like that -- my guess is the above is as-if you <em>only</em> defined:</p>
<pre><code class="language-toml">[[index]]
name = &quot;assist-core&quot;
# different domain
url = &quot;https://__token__:&lt;TOKEN&gt;@gitlab.com/api/v4/groups/949/-/packages/pypi/simple&quot;
</code></pre>
<p>In which case, the index <em>isn't</em> explicit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @charliermarsh on 2025-05-22 11:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2025-05-22 11:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/praisethedeviI">@praisethedeviI</a> on 2025-05-22 14:41</div>
            <div class="timeline-body"><p>Writing <code>explicit = true</code> in <em>uv.toml</em> helped me</p>
<p>I repeated because I can't leave my credentials in <em>pyproject.toml</em>, so I also tried to create gitignored <em>uv.toml</em></p>
<p>Is there any way to get rid of the warning &quot;Found both a uv.toml file and a [tool.uv] section in an adjacent pyproject.toml. The [tool.uv] section will be ignored in favor of the uv.toml file&quot;?</p>
<p>If I leave the index only in uv.toml, I get an error:</p>
<pre><code>Caused by: Failed to parse entry: assistant-core
  Caused by: Package assistant-core references an undeclared index: `assist-core`
</code></pre>
<hr />
<p>Also, instead of using <em>uv.toml</em> with a repeated index defenition, I tried use the variable <code>UV_INDEX=https://__token__:&lt;TOKEN&gt;@gitlab.com/api/v4/groups/949/-/packages/pypi/simple</code>. But <code>uv lock</code> still writes the wrong registry</p>
<p>I guess that UV_INDEX works as an index in the <em>toml</em> files without explicit configuration</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-24 12:22</div>
            <div class="timeline-body"><p>I would strongly suggest putting the index definition in your <code>pyproject.toml</code>, then setting:</p>
<pre><code>export UV_INDEX_ASSIST_CORE_USERNAME= __token__
export UV_INDEX_ASSIST_CORE_PASSWORD=&lt;token&gt;
</code></pre>
<p>This is the recommended setup. (IIRC you're not allowed to reference explicit named indexes defined in a <code>uv.toml</code> file.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @praisethedeviI on 2025-05-24 13:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:33:06 UTC
    </footer>
</body>
</html>
