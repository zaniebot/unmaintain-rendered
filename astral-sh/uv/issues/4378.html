<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cache issue when installing from git urls with once missing refs - astral-sh/uv #4378</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Cache issue when installing from git urls with once missing refs</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/4378">#4378</a>
        opened by <a href="https://github.com/elupus">@elupus</a>
        on 2024-06-18 08:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/elupus">@elupus</a></div>
            <div class="timeline-body">

<p>I have an issue where the cache seem to get &quot;corrupt&quot;. I have a project with git references. If the install was attempted once when the target SHA had not landed in the upstream URL, the cache is broken for this sha and does not recover with a &quot;--refresh&quot; once the sha does exist in the upstream repo.</p>
<p>I don&#x27;t have a repro case just yet will see if i can figure out how to make one. But suspicion is that the git reset that fails below is performed before a new fetch has been performed from the upstream git repo.</p>
<p>Platform: Ubuntu 22.04.2 LTS
Uv: uv 0.2.12</p>
<pre><code>&lt;package&gt; @ git+ssh://&lt;url&gt;@&lt;sha&gt;#subdirectory=&lt;dir&gt;
</code></pre>
<pre><code>uv pip install --verbose --refresh -r tests/requirements.txt
DEBUG Searching for Python interpreter in virtual environments
DEBUG Found CPython 3.10.12 at `/home/rtljopl/tecu/application/.venv/bin/python3` (active virtual environment)
DEBUG Using Python 3.10.12 environment at .venv/bin/python3
DEBUG Acquired lock for `.venv`
DEBUG At least one requirement is not satisfied: &lt;package&gt; @ git+ssh://&lt;url&gt;@&lt;sha&gt;#subdirectory=&lt;dir&gt;

DEBUG Using request timeout of 30s
DEBUG Fetching source distribution from Git: ssh://&lt;url&gt;
DEBUG Acquired lock for `ssh://&lt;url&gt;`
DEBUG reset /home/rtljopl/.cache/uv/git-v0/checkouts/f5528ce19486c11e/&lt;sha&gt; to &lt;sha&gt;
error: Failed to download and build: `&lt;package&gt; @ git+ssh://&lt;url&gt;@&lt;sha&gt;#subdirectory=&lt;package&gt;`
  Caused by: Git operation failed
  Caused by: process didn&#x27;t exit successfully: `git reset --hard &lt;sha&gt;` (exit status: 128)
--- stderr
fatal: Could not parse object &#x27;&lt;sha&gt;&#x27;.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-06-18 17:07</div>
            <div class="timeline-body"><p>Interesting, if the local repository is corrupted we do a fresh clone and <a href="https://github.com/astral-sh/uv/blob/main/crates/uv-git/src/git.rs#L250">it looks like we assume the previous locked revision is correct</a>, even if we may not have fetched that refspec correctly. However, I&#x27;m not sure why we would have a locked revision in your case because the checkout would have failed. A reproduction would be helpful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-06-18 17:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-18 17:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eifinger">@eifinger</a> on 2024-06-26 14:33</div>
            <div class="timeline-body"><p>I just encountered the same problem in a project using rye with uv enabled.</p>
<ol>
<li>Have a project using a dependency in <code>pyproject.toml</code> in the form of <code>&lt;PACKAGE_NAME&gt; @ git+ssh://git@github.com/&lt;ORG&gt;/&lt;PACKAGE_NAME&gt;.git@&lt;GIT_HASH&gt;</code></li>
<li>run <code>rye sync</code> with uv enabled</li>
<li>Push a new commit to <code>&lt;ORG&gt;/&lt;PACKAGE_NAME&gt;</code></li>
<li>change &lt;GIT_HASH&gt; in <code>pyproject.toml</code></li>
<li>run <code>rye sync</code></li>
<li>Encounter the error above</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eifinger">@eifinger</a> on 2024-06-27 07:09</div>
            <div class="timeline-body"><p>Temporary workaround for me is <code>UV_NO_CACHE=true rye sync</code>. I have not yet used <code>uv</code> directly but for the initial problem @elupus reported this should work <code>UV_NO_CACHE=true uv pip install --verbose --refresh -r tests/requirements.txt</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-27 10:50</div>
            <div class="timeline-body"><p>Just as a minor note, using <code>--no-cache</code> with <code>--refresh</code> doesn&#x27;t make sense, I&#x27;d use one or the other. Generally <code>--refresh-package &lt;name&gt;</code> is the best option.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-07-01 17:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-07-01 17:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/elupus">@elupus</a> on 2024-07-01 17:03</div>
            <div class="timeline-body"><p>Beautiful! Thanks!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:31:39 UTC
    </footer>
</body>
</html>
