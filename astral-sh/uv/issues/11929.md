```yaml
number: 11929
title: "Upgrading tools adds an identical entry to the `index` list in uv-receipt.toml"
type: issue
state: open
author: nbaju1
labels:
  - bug
assignees: []
created_at: 2025-03-03T17:56:01Z
updated_at: 2025-03-05T18:48:09Z
url: https://github.com/astral-sh/uv/issues/11929
synced_at: 2026-01-10T01:57:27Z
```

# Upgrading tools adds an identical entry to the `index` list in uv-receipt.toml

---

_Issue opened by @nbaju1 on 2025-03-03 17:56_

### Summary

Upgrading libraries installed with `uv tool install <library>` keeps adding new and identical elements to the `index` list under `[tool.options]` in the corresponding uv-receipt.toml file. We use a private index, not PyPI.

Steps to reproduce:
1. Run `uv tool install ruff@0.9.1`.
2. Modify the created uv-receipt.toml file changing the specifier to `==0.9.2`
3. Run `uv tool upgrade ruff`
4. Repeat 2. and 3., incrementing the version.

Resulting uv-receipt.toml file (the urls are all identical):
```toml
...
[tool.options]
index = [
    { url = "https://<username>:<token>@<private index>", explicit = false, default = true },
    { url = "https://<username>:<token>@<private index>", explicit = false, default = true },
    { url = "https://<username>:<token>@<private index>", explicit = false, default = true },
]
```

Is this behavior intended? If so, why?

### Platform

Windows 11 x64

### Version

0.6.3

### Python version

3.12.7

---

_Label `bug` added by @nbaju1 on 2025-03-03 17:56_

---

_Comment by @charliermarsh on 2025-03-04 02:00_

Na, this looks like a bug.

---

_Comment by @charliermarsh on 2025-03-04 03:01_

The issue is that we combine the existing receipt configuration with any user-provided configuration. So if we read the index from the filesystem, we then combine that with the index that's already present in the receipt.

---

_Assigned to @charliermarsh by @charliermarsh on 2025-03-05 02:16_

---

_Comment by @charliermarsh on 2025-03-05 03:00_

Hmm. I do not know how to solve this. I mean, we can dedupe in this case, but not every setting is amenable to de-duping like this. We don't really have a way to combine the receipt with the "new" settings without causing some amount of deduplication. (Another example would be `--config-settings` where you can provide multiple values for a given key which get collected as lists... If we combine the existing receipt with the filesystem settings, we'll concatenate the lists, but we can't dedupe them -- it might be _meaningful_ that we have multiple repeated values.) 

Alternatives would be...

- Ignore all settings and just use the receipt when upgrading.
- Ignore the receipt and just rely on the user-provided setting.
- Just deduplicate and live with the cases in which we might write duplicate settings here (`--config-settings` might be the only case in practice).

\cc @zanieb 


---

_Comment by @zanieb on 2025-03-05 05:00_

I think passing settings on upgrade implies a replacement of the existing settings. I would ignore the existing receipt value of a particular setting if provided on upgrade. Does that make sense?

---

_Comment by @charliermarsh on 2025-03-05 13:43_

Yeah though it gets a little tricky with the index URL options, since `--index`, `--index-url`, and `--extra-index-url` are technically all distinct settings.

---

_Comment by @zanieb on 2025-03-05 18:48_

Yeah that's a bit awkward, but probably fine to just replace them all in this context?

---
