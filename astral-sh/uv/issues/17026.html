<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Django uv docker setup - astral-sh/uv #17026</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Django uv docker setup</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/17026">#17026</a>
        opened by <a href="https://github.com/blossomsg">@blossomsg</a>
        on 2025-12-08 09:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/blossomsg">@blossomsg</a> on 2025-12-08 09:54</div>
            <div class="timeline-body"><h3>Question</h3>
<p>Hello All,
I am exploring uv with docker, but facing some challenges setting up <strong>Dockerfile</strong></p>
<p>for the sake of upload i have added an extension .txt
<a href="https://github.com/user-attachments/files/24029033/Dockerfile.txt">Dockerfile.txt</a></p>
<p>I am referring django for professionals book
in which they are setting pipenv with docker, but i wanted to explore with uv
I keep getting the below error</p>
<pre><code> =&gt; ERROR [stage-0 8/8] RUN --mount=type=cache,target=/root/.cache/uv     uv sync --locked --no-dev                                                                                                                                                                         0.2s 
------
 &gt; [stage-0 8/8] RUN --mount=type=cache,target=/root/.cache/uv     uv sync --locked --no-dev:
0.220 error: failed to create directory `/nonexistent/.cache/uv`: Permission denied (os error 13)
------
Dockerfile:61
--------------------
  60 |     COPY . /app
  61 | &gt;&gt;&gt; RUN --mount=type=cache,target=/root/.cache/uv \
  62 | &gt;&gt;&gt;     uv sync --locked --no-dev
  63 |
--------------------
ERROR: failed to build: failed to solve: process &quot;/bin/sh -c uv sync --locked --no-dev&quot; did not complete successfully: exit code: 2

</code></pre>
<p>here is the docker file snippet from the book.
<img width="587" height="907" alt="Image" src="https://github.com/user-attachments/assets/97e2d7a5-072b-434a-a95b-2cc94f708512" /></p>
<p>I referred these links
https://docs.astral.sh/uv/guides/integration/docker/#using-uv-in-docker
https://github.com/astral-sh/uv-docker-example/blob/main/Dockerfile</p>
<p>Did the necessary tweaks, but still facing permissions issue.
Do let me know what needs to be refactored, it would be really helpful
Thank You.</p>
<h3>Platform</h3>
<p>Microsoft Windows 11 Pro x64</p>
<h3>Version</h3>
<p>uv 0.8.2 (21fadbcc1 2025-07-22)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @blossomsg on 2025-12-08 09:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Djanog uv docker setup" to "Django uv docker setup" by @AlexWaygood on 2025-12-08 09:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-08 13:08</div>
            <div class="timeline-body"><p>Copying this inline for readability</p>
<pre><code class="language-Dockerfile"># syntax=docker/dockerfile:1

# Comments are provided throughout this file to help you get started.
# If you need more help, visit the Dockerfile reference guide at
# https://docs.docker.com/go/dockerfile-reference/

# Want to help us make this template better? Share your feedback here: https://forms.gle/ybq9Krt8jtBL3iCk7

FROM python:3.12-slim-bookworm
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/


# Setup a non-root user
RUN groupadd --system --gid 999 nonroot \
 &amp;&amp; useradd --system --gid 999 --uid 999 --create-home nonroot

# Prevents Python from writing pyc files.
ENV PYTHONDONTWRITEBYTECODE=1

# Keeps Python from buffering stdout and stderr to avoid situations where
# the application crashes without emitting any logs due to buffering.
ENV PYTHONUNBUFFERED=1

WORKDIR /app

# Enable bytecode compilation
ENV UV_COMPILE_BYTECODE=1

# Copy from the cache instead of linking since it's a mounted volume
ENV UV_LINK_MODE=copy

# Ensure installed tools can be executed out of the box
ENV UV_TOOL_BIN_DIR=/usr/local/bin

# Create a non-privileged user that the app will run under.
# See https://docs.docker.com/go/dockerfile-user-best-practices/
ARG UID=10001
RUN adduser \
    --disabled-password \
    --gecos &quot;&quot; \
    --home &quot;/nonexistent&quot; \
    --shell &quot;/sbin/nologin&quot; \
    --no-create-home \
    --uid &quot;${UID}&quot; \
    appuser

# Download dependencies as a separate step to take advantage of Docker's caching.
# Leverage a cache mount to /root/.cache/pip to speed up subsequent builds.
# Leverage a bind mount to requirements.txt to avoid having to copy them into
# into this layer.
RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,source=uv.lock,target=uv.lock \
    --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
    uv sync --locked --no-install-project --no-dev

# Switch to the non-privileged user to run the application.
USER appuser

# Copy the source code into the container.
COPY . /app
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --locked --no-dev

# Place executables in the environment at the front of the path
ENV PATH=&quot;/app/.venv/bin:$PATH&quot;

# Reset the entrypoint, don't invoke `uv`
ENTRYPOINT []

# Use the non-root user to run our application
USER nonroot


# Expose the port that the application listens on.
EXPOSE 8000

# Run the application.
CMD [&quot;uv&quot;, &quot;run&quot;, &quot;python&quot;, &quot;manage.py&quot;, &quot;runserver&quot;, &quot;0.0.0.0:8000&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-08 13:09</div>
            <div class="timeline-body"><p>You change the home directory to <code>--home &quot;/nonexistent&quot;</code> so uv attempts to store the cache there. You have some mounts for the uv cache <code>--mount=type=cache,target=/root/.cache/uv</code> but note that uses <code>/root</code> instead of <code>/nonexistent</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blossomsg">@blossomsg</a> on 2025-12-08 14:38</div>
            <div class="timeline-body"><p>Hello @zanieb ,
thanks for the revert.</p>
<p>I tried both ways
<code>--home &quot;/nonexistent&quot;</code></p>
<pre><code>    --gecos &quot;&quot; \
    --home &quot;/nonexistent&quot; \
    --shell &quot;/sbin/nologin&quot; \
</code></pre>
<pre><code>RUN --mount=type=cache,target=/nonexistent/.cache/uv \
    uv sync --locked --no-dev
</code></pre>
<p>and same with <code>--home &quot;/root&quot;</code></p>
<pre><code>    --gecos &quot;&quot; \
    --home &quot;/root&quot; \
    --shell &quot;/sbin/nologin&quot; \
</code></pre>
<pre><code>RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --locked --no-dev
</code></pre>
<p>But unfortunately i am still getting same error, my last attempt was with <code>&quot;/root&quot;</code>, that is why the path of cache is with root.</p>
<pre><code> =&gt; ERROR [stage-0 8/8] RUN --mount=type=cache,target=/root/.cache/uv     uv sync --locked --no-dev                                                                                                                                                                         0.2s 
------
 &gt; [stage-0 8/8] RUN --mount=type=cache,target=/root/.cache/uv     uv sync --locked --no-dev:
0.178 error: failed to create directory `/root/.cache/uv`: Permission denied (os error 13)
------
Dockerfile:60
--------------------
  59 |     COPY . /app
  60 | &gt;&gt;&gt; RUN --mount=type=cache,target=/root/.cache/uv \
  61 | &gt;&gt;&gt;     uv sync --locked --no-dev
  62 |
--------------------
ERROR: failed to build: failed to solve: process &quot;/bin/sh -c uv sync --locked --no-dev&quot; did not complete successfully: exit code: 2

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-08 15:12</div>
            <div class="timeline-body"><p>You're switching to the unprivileged user early</p>
<pre><code>
# Switch to the non-privileged user to run the application.
USER appuser

# Copy the source code into the container.
COPY . /app
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --locked --no-dev
</code></pre>
<p>Do that later?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blossomsg">@blossomsg</a> on 2025-12-09 15:34</div>
            <div class="timeline-body"><p>Amazing @zanieb , thanks alot for the help.
Just worked in one goüòÅ.
attaching the new formatted dockerfile.</p>
<pre><code class="language-dockerfile"># syntax=docker/dockerfile:1

# Comments are provided throughout this file to help you get started.
# If you need more help, visit the Dockerfile reference guide at
# https://docs.docker.com/go/dockerfile-reference/

# Want to help us make this template better? Share your feedback here: https://forms.gle/ybq9Krt8jtBL3iCk7

FROM python:3.12-slim-bookworm
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/


# Setup a non-root user
RUN groupadd --system --gid 999 nonroot \
 &amp;&amp; useradd --system --gid 999 --uid 999 --create-home nonroot

# Prevents Python from writing pyc files.
ENV PYTHONDONTWRITEBYTECODE=1

# Keeps Python from buffering stdout and stderr to avoid situations where
# the application crashes without emitting any logs due to buffering.
ENV PYTHONUNBUFFERED=1

WORKDIR /app

# Enable bytecode compilation
ENV UV_COMPILE_BYTECODE=1

# Copy from the cache instead of linking since it's a mounted volume
ENV UV_LINK_MODE=copy

# Ensure installed tools can be executed out of the box
ENV UV_TOOL_BIN_DIR=/usr/local/bin

# Create a non-privileged user that the app will run under.
# See https://docs.docker.com/go/dockerfile-user-best-practices/
ARG UID=10001
RUN adduser \
    --disabled-password \
    --gecos &quot;&quot; \
    --home &quot;/root&quot; \
    --shell &quot;/sbin/nologin&quot; \
    --no-create-home \
    --uid &quot;${UID}&quot; \
    appuser

# Download dependencies as a separate step to take advantage of Docker's caching.
# Leverage a cache mount to /root/.cache/pip to speed up subsequent builds.
# Leverage a bind mount to requirements.txt to avoid having to copy them into
# into this layer.
RUN --mount=type=bind,source=uv.lock,target=uv.lock \
    --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
    uv sync --locked --no-install-project --no-dev


# Copy the source code into the container.
COPY . /app
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --locked --no-dev

# Switch to the non-privileged user to run the application.
USER appuser

# Place executables in the environment at the front of the path
ENV PATH=&quot;/app/.venv/bin:$PATH&quot;

# Reset the entrypoint, don't invoke `uv`
ENTRYPOINT []

# Use the non-root user to run our application
USER nonroot

# Expose the port that the application listens on.
EXPOSE 8000

# Run the application.
CMD [&quot;uv&quot;, &quot;run&quot;, &quot;python&quot;, &quot;manage.py&quot;, &quot;runserver&quot;, &quot;0.0.0.0:8000&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @blossomsg on 2025-12-09 15:35</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:06 UTC
    </footer>
</body>
</html>
