<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In-use Packages Removed by `uv cache prune` When Using Symlinks - astral-sh/uv #13270</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>In-use Packages Removed by <code>uv cache prune</code> When Using Symlinks</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/13270">#13270</a>
        opened by <a href="https://github.com/xyu">@xyu</a>
        on 2025-05-02 17:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/xyu">@xyu</a> on 2025-05-02 17:18</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>It appears the hash rather than package name change in #11738 introduced a bug in <code>find_archive_references()</code> and cache pruning now removes some libraries that are still in use. I created the following test file to demonstrate the issue:</p>
<pre><code class="language-bash">#!/bin/bash
set -eu

VER=&quot;$1&quot;

rm -rf &quot;$VER&quot;
uv venv &quot;$VER&quot;
cd &quot;$VER&quot;
source bin/activate

set -x

uv pip install &quot;uv==$VER&quot;
bin/uv --version

UV_LINK_MODE=symlink bin/uv pip install zstandard
symlinks lib/python3.*/site-packages/zstandard

bin/uv cache -v prune
symlinks lib/python3.*/site-packages/zstandard
</code></pre>
<p>When running this with <code>./uv-test.sh 0.6.4</code> I get the following output:</p>
<pre><code>Using CPython 3.11.12 interpreter at: /opt/Python/bin/python3
Creating virtual environment at: 0.6.4
+ uv pip install uv==0.6.4
Using Python 3.11.12 environment at:
Resolved 1 package in 1.00s
Prepared 1 package in 8.45s
Installed 1 package in 2ms
 + uv==0.6.4
+ bin/uv --version
uv 0.6.4
+ bin/uv pip install zstandard
Using Python 3.11.12 environment at:
Resolved 1 package in 604ms
Prepared 1 package in 2.25s
Installed 1 package in 3ms
 + zstandard==0.23.0
+ symlinks lib/python3.11/site-packages/zstandard
other_fs: /home/remote-user/0.6.4/lib/python3.11/site-packages/zstandard/backend_c.cpython-311-aarch64-linux-gnu.so -&gt; /home/remote-user/.cache/uv/archive-v0/3XkaxKI_hOb98TWKNRvUs/zstandard/backend_c.cpython-311-aarch64-linux-gnu.so
other_fs: /home/remote-user/0.6.4/lib/python3.11/site-packages/zstandard/__init__.py -&gt; /home/remote-user/.cache/uv/archive-v0/3XkaxKI_hOb98TWKNRvUs/zstandard/__init__.py
other_fs: /home/remote-user/0.6.4/lib/python3.11/site-packages/zstandard/_cffi.cpython-311-aarch64-linux-gnu.so -&gt; /home/remote-user/.cache/uv/archive-v0/3XkaxKI_hOb98TWKNRvUs/zstandard/_cffi.cpython-311-aarch64-linux-gnu.so
other_fs: /home/remote-user/0.6.4/lib/python3.11/site-packages/zstandard/backend_cffi.py -&gt; /home/remote-user/.cache/uv/archive-v0/3XkaxKI_hOb98TWKNRvUs/zstandard/backend_cffi.py
other_fs: /home/remote-user/0.6.4/lib/python3.11/site-packages/zstandard/py.typed -&gt; /home/remote-user/.cache/uv/archive-v0/3XkaxKI_hOb98TWKNRvUs/zstandard/py.typed
other_fs: /home/remote-user/0.6.4/lib/python3.11/site-packages/zstandard/__init__.pyi -&gt; /home/remote-user/.cache/uv/archive-v0/3XkaxKI_hOb98TWKNRvUs/zstandard/__init__.pyi
+ bin/uv cache -v prune
DEBUG uv 0.6.4
Pruning cache at: /home/remote-user/.cache/uv
DEBUG Removing dangling cache bucket: /home/remote-user/.cache/uv/wheels-v4
DEBUG Removing dangling cache archive: /app/data/wyeast/caches/.cache/uv/archive-v0/VIcOQ_j9JoOfTDcJ0PkGp
DEBUG Removing dangling cache archive: /app/data/wyeast/caches/.cache/uv/archive-v0/3XkaxKI_hOb98TWKNRvUs
Removed 26 files (52.5MiB)
+ symlinks lib/python3.11/site-packages/zstandard
dangling: /home/remote-user/0.6.4/lib/python3.11/site-packages/zstandard/backend_c.cpython-311-aarch64-linux-gnu.so -&gt; /home/remote-user/.cache/uv/archive-v0/3XkaxKI_hOb98TWKNRvUs/zstandard/backend_c.cpython-311-aarch64-linux-gnu.so
dangling: /home/remote-user/0.6.4/lib/python3.11/site-packages/zstandard/__init__.py -&gt; /home/remote-user/.cache/uv/archive-v0/3XkaxKI_hOb98TWKNRvUs/zstandard/__init__.py
dangling: /home/remote-user/0.6.4/lib/python3.11/site-packages/zstandard/_cffi.cpython-311-aarch64-linux-gnu.so -&gt; /home/remote-user/.cache/uv/archive-v0/3XkaxKI_hOb98TWKNRvUs/zstandard/_cffi.cpython-311-aarch64-linux-gnu.so
dangling: /home/remote-user/0.6.4/lib/python3.11/site-packages/zstandard/backend_cffi.py -&gt; /home/remote-user/.cache/uv/archive-v0/3XkaxKI_hOb98TWKNRvUs/zstandard/backend_cffi.py
dangling: /home/remote-user/0.6.4/lib/python3.11/site-packages/zstandard/py.typed -&gt; /home/remote-user/.cache/uv/archive-v0/3XkaxKI_hOb98TWKNRvUs/zstandard/py.typed
dangling: /home/remote-user/0.6.4/lib/python3.11/site-packages/zstandard/__init__.pyi -&gt; /home/remote-user/.cache/uv/archive-v0/3XkaxKI_hOb98TWKNRvUs/zstandard/__init__.pyi
</code></pre>
<p>So after installing <code>zstandard</code> then calling <code>uv cache prune</code> the archive dir <code>.cache/uv/archive-v0/3XkaxKI_hOb98TWKNRvUs</code> where that package gets installed gets removed thus leaving dangling symlinks in the package venv.</p>
<p>Compared to the previous version, <code>0.6.3</code> where the archive dir remains untouched after a cache prune:</p>
<pre><code>Using CPython 3.11.12 interpreter at: /opt/Python/bin/python3
Creating virtual environment at: 0.6.3
+ uv pip install uv==0.6.3
Using Python 3.11.12 environment at:
Resolved 1 package in 1.46s
Prepared 1 package in 9.16s
Installed 1 package in 3ms
 + uv==0.6.3
+ bin/uv --version
uv 0.6.3
+ bin/uv pip install zstandard
Using Python 3.11.12 environment at:
Resolved 1 package in 982ms
Prepared 1 package in 2.88s
Installed 1 package in 2ms
 + zstandard==0.23.0
+ symlinks lib/python3.11/site-packages/zstandard
other_fs: /home/remote-user/0.6.3/lib/python3.11/site-packages/zstandard/backend_c.cpython-311-aarch64-linux-gnu.so -&gt; /home/remote-user/.cache/uv/archive-v0/c8tiDgnJBm77dsv16VIVJ/zstandard/backend_c.cpython-311-aarch64-linux-gnu.so
other_fs: /home/remote-user/0.6.3/lib/python3.11/site-packages/zstandard/__init__.py -&gt; /home/remote-user/.cache/uv/archive-v0/c8tiDgnJBm77dsv16VIVJ/zstandard/__init__.py
other_fs: /home/remote-user/0.6.3/lib/python3.11/site-packages/zstandard/_cffi.cpython-311-aarch64-linux-gnu.so -&gt; /home/remote-user/.cache/uv/archive-v0/c8tiDgnJBm77dsv16VIVJ/zstandard/_cffi.cpython-311-aarch64-linux-gnu.so
other_fs: /home/remote-user/0.6.3/lib/python3.11/site-packages/zstandard/backend_cffi.py -&gt; /home/remote-user/.cache/uv/archive-v0/c8tiDgnJBm77dsv16VIVJ/zstandard/backend_cffi.py
other_fs: /home/remote-user/0.6.3/lib/python3.11/site-packages/zstandard/py.typed -&gt; /home/remote-user/.cache/uv/archive-v0/c8tiDgnJBm77dsv16VIVJ/zstandard/py.typed
other_fs: /home/remote-user/0.6.3/lib/python3.11/site-packages/zstandard/__init__.pyi -&gt; /home/remote-user/.cache/uv/archive-v0/c8tiDgnJBm77dsv16VIVJ/zstandard/__init__.pyi
+ bin/uv cache -v prune
DEBUG uv 0.6.3
Pruning cache at: /home/remote-user/.cache/uv
DEBUG Removing dangling cache bucket: /home/remote-user/.cache/uv/wheels-v5
Removed 3 files (1.4KiB)
+ symlinks lib/python3.11/site-packages/zstandard
other_fs: /home/remote-user/0.6.3/lib/python3.11/site-packages/zstandard/backend_c.cpython-311-aarch64-linux-gnu.so -&gt; /home/remote-user/.cache/uv/archive-v0/c8tiDgnJBm77dsv16VIVJ/zstandard/backend_c.cpython-311-aarch64-linux-gnu.so
other_fs: /home/remote-user/0.6.3/lib/python3.11/site-packages/zstandard/__init__.py -&gt; /home/remote-user/.cache/uv/archive-v0/c8tiDgnJBm77dsv16VIVJ/zstandard/__init__.py
other_fs: /home/remote-user/0.6.3/lib/python3.11/site-packages/zstandard/_cffi.cpython-311-aarch64-linux-gnu.so -&gt; /home/remote-user/.cache/uv/archive-v0/c8tiDgnJBm77dsv16VIVJ/zstandard/_cffi.cpython-311-aarch64-linux-gnu.so
other_fs: /home/remote-user/0.6.3/lib/python3.11/site-packages/zstandard/backend_cffi.py -&gt; /home/remote-user/.cache/uv/archive-v0/c8tiDgnJBm77dsv16VIVJ/zstandard/backend_cffi.py
other_fs: /home/remote-user/0.6.3/lib/python3.11/site-packages/zstandard/py.typed -&gt; /home/remote-user/.cache/uv/archive-v0/c8tiDgnJBm77dsv16VIVJ/zstandard/py.typed
other_fs: /home/remote-user/0.6.3/lib/python3.11/site-packages/zstandard/__init__.pyi -&gt; /home/remote-user/.cache/uv/archive-v0/c8tiDgnJBm77dsv16VIVJ/zstandard/__init__.pyi
</code></pre>
<h3>Platform</h3>
<p>Debian 12, aarch64 and x86_64</p>
<h3>Version</h3>
<p>0.6.4+</p>
<h3>Python version</h3>
<p>3.11.12, 3.12.10, 3.13.3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @xyu on 2025-05-02 17:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-04 14:41</div>
            <div class="timeline-body"><p>Unfortunately I haven't been able to reproduce this. When I run that script, none of the archives are removed. Could your cache be in a weird state? Do you see the same thing after running <code>uv cache clean</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @charliermarsh on 2025-05-04 17:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @charliermarsh on 2025-05-04 17:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/xyu">@xyu</a> on 2025-05-05 17:12</div>
            <div class="timeline-body"><blockquote>
<p>Unfortunately I haven't been able to reproduce this. When I run that script, none of the archives are removed.</p>
</blockquote>
<p>Ok I took another look and it looks like it's because I'm using symlinks instead of hardlinks. I amended the test script to add <code>UV_LINK_MODE=symlink</code> can you try again @charliermarsh? I have to use symlinks because we are running this in Dockerized environments and we want mount the cache dir into the container so that we can persist it across invocations for speed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "In-use Packages Removed by `uv cache prune`" to "In-use Packages Removed by `uv cache prune` When Using Symlinks" by @xyu on 2025-05-05 17:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-07 22:35</div>
            <div class="timeline-body"><p>Unfortunately I still see roughly the same thing:</p>
<pre><code>+ symlinks lib/python3.13/site-packages/zstandard
absolute: /Users/crmarsh/workspace/puffin/foo/0.7.0/lib/python3.13/site-packages/zstandard/_cffi.cpython-313-darwin.so -&gt; /Users/crmarsh/.cache/uv/archive-v0/rVEu_epLYxeo6MSInGqIh/zstandard/_cffi.cpython-313-darwin.so
absolute: /Users/crmarsh/workspace/puffin/foo/0.7.0/lib/python3.13/site-packages/zstandard/__init__.pyi -&gt; /Users/crmarsh/.cache/uv/archive-v0/rVEu_epLYxeo6MSInGqIh/zstandard/__init__.pyi
absolute: /Users/crmarsh/workspace/puffin/foo/0.7.0/lib/python3.13/site-packages/zstandard/__init__.py -&gt; /Users/crmarsh/.cache/uv/archive-v0/rVEu_epLYxeo6MSInGqIh/zstandard/__init__.py
absolute: /Users/crmarsh/workspace/puffin/foo/0.7.0/lib/python3.13/site-packages/zstandard/backend_cffi.py -&gt; /Users/crmarsh/.cache/uv/archive-v0/rVEu_epLYxeo6MSInGqIh/zstandard/backend_cffi.py
absolute: /Users/crmarsh/workspace/puffin/foo/0.7.0/lib/python3.13/site-packages/zstandard/py.typed -&gt; /Users/crmarsh/.cache/uv/archive-v0/rVEu_epLYxeo6MSInGqIh/zstandard/py.typed
absolute: /Users/crmarsh/workspace/puffin/foo/0.7.0/lib/python3.13/site-packages/zstandard/backend_c.cpython-313-darwin.so -&gt; /Users/crmarsh/.cache/uv/archive-v0/rVEu_epLYxeo6MSInGqIh/zstandard/backend_c.cpython-313-darwin.so
+ bin/uv cache -v prune
DEBUG uv 0.7.0 (62bca8c34 2025-04-29)
Pruning cache at: /Users/crmarsh/.cache/uv
No unused entries found
+ symlinks lib/python3.13/site-packages/zstandard
absolute: /Users/crmarsh/workspace/puffin/foo/0.7.0/lib/python3.13/site-packages/zstandard/_cffi.cpython-313-darwin.so -&gt; /Users/crmarsh/.cache/uv/archive-v0/rVEu_epLYxeo6MSInGqIh/zstandard/_cffi.cpython-313-darwin.so
absolute: /Users/crmarsh/workspace/puffin/foo/0.7.0/lib/python3.13/site-packages/zstandard/__init__.pyi -&gt; /Users/crmarsh/.cache/uv/archive-v0/rVEu_epLYxeo6MSInGqIh/zstandard/__init__.pyi
absolute: /Users/crmarsh/workspace/puffin/foo/0.7.0/lib/python3.13/site-packages/zstandard/__init__.py -&gt; /Users/crmarsh/.cache/uv/archive-v0/rVEu_epLYxeo6MSInGqIh/zstandard/__init__.py
absolute: /Users/crmarsh/workspace/puffin/foo/0.7.0/lib/python3.13/site-packages/zstandard/backend_cffi.py -&gt; /Users/crmarsh/.cache/uv/archive-v0/rVEu_epLYxeo6MSInGqIh/zstandard/backend_cffi.py
absolute: /Users/crmarsh/workspace/puffin/foo/0.7.0/lib/python3.13/site-packages/zstandard/py.typed -&gt; /Users/crmarsh/.cache/uv/archive-v0/rVEu_epLYxeo6MSInGqIh/zstandard/py.typed
absolute: /Users/crmarsh/workspace/puffin/foo/0.7.0/lib/python3.13/site-packages/zstandard/backend_c.cpython-313-darwin.so -&gt; /Users/crmarsh/.cache/uv/archive-v0/rVEu_epLYxeo6MSInGqIh/zstandard/backend_c.cpython-313-darwin.so
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-07 22:36</div>
            <div class="timeline-body"><p>Are you able to reproduce this in 0.7.0? Could it be an effect of switching uv versions, or do you still see this if you run <code>uv cache clean</code> first?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/xyu">@xyu</a> on 2025-05-08 18:27</div>
            <div class="timeline-body"><blockquote>
<p>Are you able to reproduce this in 0.7.0? Could it be an effect of switching uv versions, or do you still see this if you run uv cache clean first?</p>
</blockquote>
<p>I'm able to reproduce this in 0.7.0 and it does not matter if I run <code>uv cache clean</code> or not.</p>
<p>It looks like this issue is not reproducible on MacOS / Darwin but it is reproducible on Debian / Linux. To clarify the issue further I've pushed a Docker image, <code>hypertextranch/uv-13270</code>, to demonstrate the issue:</p>
<pre><code>$ docker run --rm hypertextranch/uv-13270:latest 0.7.0

Testing issue #13270 for uv 0.7.0 on Debian GNU/Linux 12 (bookworm)

...snip...
DEBUG Removing dangling cache archive: /root/.cache/uv/archive-v0/IVFKnhpbv3zp64XpoMjIK
Removed 11 files (20.6MiB)
+ symlinks lib/python3.13/site-packages/zstandard
dangling: /0.7.0/lib/python3.13/site-packages/zstandard/__init__.py -&gt; /root/.cache/uv/archive-v0/IVFKnhpbv3zp64XpoMjIK/zstandard/__init__.py
dangling: /0.7.0/lib/python3.13/site-packages/zstandard/backend_c.cpython-313-aarch64-linux-gnu.so -&gt; /root/.cache/uv/archive-v0/IVFKnhpbv3zp64XpoMjIK/zstandard/backend_c.cpython-313-aarch64-linux-gnu.so
dangling: /0.7.0/lib/python3.13/site-packages/zstandard/backend_cffi.py -&gt; /root/.cache/uv/archive-v0/IVFKnhpbv3zp64XpoMjIK/zstandard/backend_cffi.py
dangling: /0.7.0/lib/python3.13/site-packages/zstandard/py.typed -&gt; /root/.cache/uv/archive-v0/IVFKnhpbv3zp64XpoMjIK/zstandard/py.typed
dangling: /0.7.0/lib/python3.13/site-packages/zstandard/__init__.pyi -&gt; /root/.cache/uv/archive-v0/IVFKnhpbv3zp64XpoMjIK/zstandard/__init__.pyi
dangling: /0.7.0/lib/python3.13/site-packages/zstandard/_cffi.cpython-313-aarch64-linux-gnu.so -&gt; /root/.cache/uv/archive-v0/IVFKnhpbv3zp64XpoMjIK/zstandard/_cffi.cpython-313-aarch64-linux-gnu.so
</code></pre>
<pre><code>$ docker run --rm hypertextranch/uv-13270:latest 0.6.3

Testing issue #13270 for uv 0.6.3 on Debian GNU/Linux 12 (bookworm)

...snip...
No unused entries found
+ symlinks lib/python3.13/site-packages/zstandard
absolute: /0.6.3/lib/python3.13/site-packages/zstandard/__init__.py -&gt; /root/.cache/uv/archive-v0/odEgNMndS5fioMfLw05D7/zstandard/__init__.py
absolute: /0.6.3/lib/python3.13/site-packages/zstandard/backend_c.cpython-313-aarch64-linux-gnu.so -&gt; /root/.cache/uv/archive-v0/odEgNMndS5fioMfLw05D7/zstandard/backend_c.cpython-313-aarch64-linux-gnu.so
absolute: /0.6.3/lib/python3.13/site-packages/zstandard/backend_cffi.py -&gt; /root/.cache/uv/archive-v0/odEgNMndS5fioMfLw05D7/zstandard/backend_cffi.py
absolute: /0.6.3/lib/python3.13/site-packages/zstandard/py.typed -&gt; /root/.cache/uv/archive-v0/odEgNMndS5fioMfLw05D7/zstandard/py.typed
absolute: /0.6.3/lib/python3.13/site-packages/zstandard/__init__.pyi -&gt; /root/.cache/uv/archive-v0/odEgNMndS5fioMfLw05D7/zstandard/__init__.pyi
absolute: /0.6.3/lib/python3.13/site-packages/zstandard/_cffi.cpython-313-aarch64-linux-gnu.so -&gt; /root/.cache/uv/archive-v0/odEgNMndS5fioMfLw05D7/zstandard/_cffi.cpython-313-aarch64-linux-gnu.so
</code></pre>
<p>The <code>Dockerfile</code> and <code>uv-test.sh</code> used to build this image is here:
https://gist.github.com/xyu/a546a6e37c40069cede1a1973b8f806e</p>
<p>Note: I've only built this image for arm64 assuming you are using an M* series machine, please let me know if you are testing under x86_64, I can build a multiarch image for this as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-08 19:38</div>
            <div class="timeline-body"><p>Oh great, thanks! Yes, I've only been testing on macOS. I'll take another look.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2025-05-08 19:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-09 04:08</div>
            <div class="timeline-body"><p>Confirmed I also see it when running that Docker image.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-10 18:15</div>
            <div class="timeline-body"><p>Thanks, I've found the bug (we're messing up when the wheel tag contains a dot).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-05-10 18:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-05-10 18:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:00 UTC
    </footer>
</body>
</html>
