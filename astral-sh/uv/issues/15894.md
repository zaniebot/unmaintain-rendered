```yaml
number: 15894
title: "`override-dependencies` ignores optional-dependency extra"
type: issue
state: closed
author: habichta
labels:
  - question
assignees: []
created_at: 2025-09-16T15:41:28Z
updated_at: 2025-10-06T11:55:09Z
url: https://github.com/astral-sh/uv/issues/15894
synced_at: 2026-01-10T01:57:35Z
```

# `override-dependencies` ignores optional-dependency extra

---

_Issue opened by @habichta on 2025-09-16 15:41_

### Question

## Setup
We use a nested dependency structure where a project imports packages from PyPI but also our local packages from a `deps` folder (see minimal working example in this [GitHub Repo](https://github.com/habichta/uv-issue)).

Essentially there is a project (root) that implements some service, which requires the dependencies (`package-1`,  `package-2`) defined in `pyproject.toml` as path sources. 

Note: 
- that `package-2` itself requires `package-1` as a dependency (via its `deps` folder). 
- we use `optional-dependencies` to share  dev dependencies as well when using `--extra dev`
- package-1 and package-2 use the `uv_build` build-backend.
- In the actual Repo, the path sources are Git submodules (should not be relevant here)

This is the relevant dependency tree for our local path sources:
```
service project -> package-1,package-2
package-2 -> package-1
package-1
```
In order for this to work, I had to define the following in the `pyproject.toml` of the service

```
[tool.uv]
override-dependencies = ["package-1 @ ${PROJECT_ROOT}/deps/package_1"]
```
otherwise I get this error when executing `uv lock`, because it finds multiple "URLs" for the same package:

```
Failed to resolve dependencies for `package-2` (v0.1.0)
Requirements contain conflicting URLs for package `package-1` in all marker environments:
      - file:///..../uv-issues/deps/package_1 (editable)
      - file:///..../uv-issues/deps/package_2/deps/package_1 (editable)
  help: `package-2` (v0.1.0) was included because `uv-issues` (v0.1.0) depends on `package-2`
```

## Issue / Question
Adding an override mostly works, we can enforce the source from which `package-1` should be installed to resolve the above mentioned error. There is a subtle issue though. When i try to execute ` uv sync --extra dev` it installs all dev dependencies, apart from the ones defined in `package-1` (see verbose log below), which in this example would be `black` as defined in the `optional-dependecies` of `package-1`.

The problem seems to be, that `override-dependencies` ignores any extra dependencies. E.g., `project-2[dev]` works, but `project-1[dev]` is ignored because of the override.

I assume this is by design. However, is there a way to make this kind of structure work with uv? For us, it is important that we can keep this nested structure and  `editable` installs. One avenue I followed was using workspaces (TBH: I may have made mistakes there, so it might still be a viable option). 
I also noticed that the `override-dependencies` seems to be only necessary for the `uv_build` backend, not for `setuptools` which does not seem to perform the transitive resolution of path sources. Using `setuptools` has different issues related to editable installs. However, we are not bound to the `uv_build` backend.

I found some related issues. However, not with the exact same problem.

### Reproduce with the minimal example
- Clone the repo linked above
- `uv sync` to install non dev dependencies -> works as expected
- `uv sync --extra dev` -> additionally installs all dev dependencies apart from those defined in `package-1` (not expected)

---
Verbose log for `uv sync --verbose --extra dev` after executing `uv sync` (black is not installed, only `pytest` defined in `package-2`)

```
DEBUG uv 0.8.17
DEBUG Found project root: `/.../uv-issues`
DEBUG No workspace root found, using project root
DEBUG Acquired lock for `/.../uv-issues`
DEBUG Reading Python requests from version file at `/.../uv-issues/.python-version`
DEBUG Using Python request `3.11` from version file at `.python-version`
DEBUG Checking for Python environment at: `.venv`
DEBUG The project environment's Python version satisfies the request: `Python 3.11`
DEBUG Released lock at `/tmp/uv-53fa90ffc760f899.lock`
DEBUG Acquired lock for `.venv`
DEBUG Using request timeout of 30s
DEBUG Found static `pyproject.toml` for: uv-issues @ file:///.../uv-issues
DEBUG No workspace root found, using project root
DEBUG Found static `pyproject.toml` for: package-1 @ file:///.../uv-issues/deps/package_1
DEBUG Project is contained in non-workspace project: `/.../uv-issues`
DEBUG No workspace root found, using project root
DEBUG Found static `pyproject.toml` for: package-2 @ file:///.../uv-issues/deps/package_2
DEBUG Project is contained in non-workspace project: `/.../repos/personal/uv-issues`
DEBUG No workspace root found, using project root
DEBUG Existing `uv.lock` satisfies workspace requirements
Resolved 16 packages in 1ms
DEBUG Using request timeout of 30s
DEBUG Computed cache info: Some(Timestamp(SystemTime { tv_sec: 1758033246, tv_nsec: 669191892 })), None, None, {}, {"src": Some(Timestamp(Timestamp(SystemTime { tv_sec: 1758032363, tv_nsec: 682883741 })))}
DEBUG Requirement already installed: package-1==0.1.0 (from file:///.../uv-issues/deps/package_1)
DEBUG Computed cache info: Some(Timestamp(SystemTime { tv_sec: 1758032266, tv_nsec: 433159694 })), None, None, {}, {"src": Some(Timestamp(Timestamp(SystemTime { tv_sec: 1758032428, tv_nsec: 546251751 })))}
DEBUG Requirement already installed: package-2==0.1.0 (from file:///.../uv-issues/deps/package_2)
DEBUG Requirement already installed: responses==0.25.8
DEBUG Registry requirement already cached: pytest==8.4.2
DEBUG Requirement already installed: pyyaml==6.0.2
DEBUG Requirement already installed: requests==2.32.5
DEBUG Requirement already installed: urllib3==2.5.0
DEBUG Registry requirement already cached: iniconfig==2.1.0
DEBUG Registry requirement already cached: packaging==25.0
DEBUG Registry requirement already cached: pluggy==1.6.0
DEBUG Registry requirement already cached: pygments==2.19.2
DEBUG Requirement already installed: certifi==2025.8.3
DEBUG Requirement already installed: charset-normalizer==3.4.3
DEBUG Requirement already installed: idna==3.10
Installed 5 packages in 11ms
 + iniconfig==2.1.0
 + packaging==25.0
 + pluggy==1.6.0
 + pygments==2.19.2
 + pytest==8.4.2
DEBUG Released lock at `/.../uv-issues/.venv/.lock`
```



### Platform

Ubuntu 24.04.2 LTS

### Version

uv 0.8.17

---

_Label `question` added by @habichta on 2025-09-16 15:41_

---

_Renamed from "`override-dependencies` ignores dependency extra" to "`override-dependencies` ignores optional-dependency extra" by @habichta on 2025-09-16 15:41_

---

_Closed by @habichta on 2025-10-06 11:55_

---
