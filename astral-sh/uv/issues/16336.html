<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv rebuilds every time when using flat glob pattern `*.{h,c,hpp,cpp}` in `cache-keys` - astral-sh/uv #16336</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv rebuilds every time when using flat glob pattern <code>*.{h,c,hpp,cpp}</code> in <code>cache-keys</code></h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/16336">#16336</a>
        opened by <a href="https://github.com/jgauth">@jgauth</a>
        on 2025-10-17 05:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jgauth">@jgauth</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>When using the <code>cache-keys</code> field with a flat source layout, uv always triggers a rebuild, even when none of the relevant files have changed.</p>
<p>By default, (e.g. with <code>uv init --lib --build-backend=scikit .</code>), uv creates a <code>src/</code> dir, and includes in the <code>cache-keys</code>  <code>{ file = &quot;src/**/*.{h,c,hpp,cpp}&quot; }</code>. This works as you would expect.</p>
<p>If instead you have no nesting - source files flat in the top-level directory, and set <code>cache-keys</code> to <code>{ file = &quot;*.{h,c,hpp,cpp}&quot; }</code>, uv will trigger a rebuild every time, even if no files have changed.</p>
<h3>Minimal Reproducible Example</h3>
<p>See https://github.com/jgauth/uv-scikit-flat</p>
<p>Clone, run <code>uv run python</code> repeatedly. Observe that <code>uv</code> rebuilds the packages every time.</p>
<h3>Platform</h3>
<p>Ubuntu 22.04.5 LTS Linux 5.15.0-156-generic x86_64 GNU/Linux</p>
<h3>Version</h3>
<p>uv 0.9.3</p>
<h3>Python version</h3>
<p>Python 3.11.8</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @jgauth on 2025-10-17 05:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-10-17 09:02</div>
            <div class="timeline-body"><p>The bug is that we traverse into subdirectories with <code>*</code> (without <code>**</code>) and ignore <code>./</code>, so we a build file as modified: <code>build/cp311-cp311-linux_x86_64/CMakeFiles/3.28.3/CompilerIdCXX/CMakeCXXCompilerId.cpp</code>.</p>
<p>CC @BurntSushi for globs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jgauth">@jgauth</a> on 2025-10-17 22:24</div>
            <div class="timeline-body"><p>Thanks. In the meantime, I can work around this by using more specific patterns:
<code>file = &quot;myprefix_*.{h,cpp}&quot;</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-10-28 13:40</div>
            <div class="timeline-body"><p>@konstin Can you say more? Is there a specific bug with glob matching that you're referring to? (I'm not sure what the <code>+</code> is referring to.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-10-28 13:41</div>
            <div class="timeline-body"><p>Wrong sigil, sorry, I meant with <code>+</code>.</p>
<p>I'm curious about your thoughts on our current behavior that <code>&quot;*.{h,c,hpp,cpp}&quot;</code> includes all files and what we might want to change about this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-10-28 13:53</div>
            <div class="timeline-body"><p>Oh I see. Yeah, that is consistent with gitignore semantics. And I kind of think it makes intuitive sense. Users should be able to do <code>/*.{h,c,hpp,cpp}</code> to anchor it to the current working directory. @jgauth Does that work for you?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @charliermarsh on 2025-10-28 23:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2025-10-28 23:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-10-28 23:54</div>
            <div class="timeline-body"><p>(Marking as a question.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-10-29 11:44</div>
            <div class="timeline-body"><p><code>/*.{h,c,hpp,cpp}</code> doesn't seem to work, we start recursing through the filesystem root:</p>
<pre><code>WARN Failed to read glob entry: IO error for operation on /proc/259871/fd: Permission denied (os error 13)
WARN Failed to read glob entry: IO error for operation on /proc/259871/map_files: Permission denied (os error 13)
WARN Failed to read glob entry: IO error for operation on /proc/259871/fdinfo: Permission denied (os error 13)
WARN Failed to read glob entry: IO error for operation on /proc/259871/ns: Permission denied (os error 13)
WARN Failed to read glob entry: IO error for operation on /root: Permission denied (os error 13)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-10-29 12:30</div>
            <div class="timeline-body"><p>Oh interesting, I guess we are traversing based on the path in the glob itself. Then yeah, I think the way we currently have things setup, users can't write globs that only match the top level directory.</p>
<blockquote>
<p>I'm curious about your thoughts on our current behavior that <code>&quot;*.{h,c,hpp,cpp}&quot;</code> includes all files and what we might want to change about this.</p>
</blockquote>
<p>We could look at <a href="https://docs.rs/globset/latest/globset/struct.GlobBuilder.html#method.literal_separator">enabling <code>literal_separator</code></a>, so that the only thing that can match a <code>/</code> is <code>/</code> or <code>**</code>. I just don't know how much people are relying on, e.g., <code>*.c</code>, to match <em>anywhere</em> in the directory tree.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-10-29 14:12</div>
            <div class="timeline-body"><p>I think if someone provides a path starting with <code>/</code> we should root that in the CWD instead of going to actual <code>/</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-10-29 14:25</div>
            <div class="timeline-body"><p>I think that makes sense yeah.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @konstin on 2025-10-29 14:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-design</span> added by @konstin on 2025-10-29 14:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-design</span> removed by @konstin on 2025-10-29 14:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @konstin on 2025-10-29 14:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-10-29 14:31</div>
            <div class="timeline-body"><p>We have a <code>*</code>/<code>**</code> distinction in other globs, and also support absolute paths in most fields (or parse a leading <code>/</code> and say absolute paths are forbidden), so I'd prefer the <code>literal_separator</code> behavior. I'd be surprised if a lot of people depend on it, we always use <code>**/*.{ext}</code> in our example, at least I was unaware of our current behavior. Still, I think it's a breaking change with either change?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:33:12 UTC
    </footer>
</body>
</html>
