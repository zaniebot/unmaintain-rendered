<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Can `uv.lock` contain multiple source registries for a single package? - astral-sh/uv #7700</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Can <code>uv.lock</code> contain multiple source registries for a single package?</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/7700">#7700</a>
        opened by <a href="https://github.com/zmeir">@zmeir</a>
        on 2024-09-26 08:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zmeir">@zmeir</a></div>
            <div class="timeline-body"><p>I've been experimenting a bit with <code>uv lock</code> and came across a use-case that I can't seem to resolve.</p>
<p>My project is developed on python 3.10/3.11/3.12, and I have a dependency on a package that only has wheel distributions in pypi.org for 3.10 and 3.11, but not for 3.12. So when installing the package on 3.12 it has to be built from source distribution, which takes a very long time (~10 minutes).<br />
Eventually the build succeeds and my code works fine with this version, but I want to speed up my CI, so I looked up in <code>uv cache dir</code>, found the wheel, and then <code>uv publish</code>ed it to my private pypi index.</p>
<p>The problem is that now when I <code>uv lock</code> (with <code>--index-strategy=unsafe-best-match</code> and <code>--extra-index-url=&lt;my_private_index_url&gt;</code>), the generated <code>uv.lock</code> file only lists the wheels from my private index, without the rest of the wheels from pypi.org.</p>
<p>This is a an example for my <code>pyproject.toml</code> before adding my private index and wheel:</p>
<pre><code class="language-toml">[project]
name = &quot;test-uv-lock&quot;
version = &quot;0.0.dev0&quot;
requires-python = &quot;&gt;=3.10&quot;
dependencies = [
    &quot;pandas&gt;=1.3.4,&lt;2; python_version &lt;= '3.10'&quot;,
    &quot;pandas&gt;=1.5.2,&lt;2; python_version == '3.11'&quot;,
    &quot;pandas&gt;=1.5.3,&lt;2; python_version &gt;= '3.12'&quot;,
]
</code></pre>
<p>And this is the <code>[[package]]</code> section for <code>pandas</code> in <code>uv.lock</code> after running <code>uv lock</code>:</p>
<pre><code>[[package]]
name = &quot;pandas&quot;
version = &quot;1.5.3&quot;
source = { registry = &quot;https://pypi.org/simple&quot; }
dependencies = [
    { name = &quot;numpy&quot; },
    { name = &quot;python-dateutil&quot; },
    { name = &quot;pytz&quot; },
]
sdist = { url = &quot;https://files.pythonhosted.org/packages/74/ee/146cab1ff6d575b54ace8a6a5994048380dc94879b0125b25e62edcb9e52/pandas-1.5.3.tar.gz&quot;, hash = &quot;sha256:74a3fd7e5a7ec052f183273dc7b0acd3a863edf7520f5d3a1765c04ffdb3b0b1&quot;, size = 5203060 }
wheels = [
    { url = &quot;https://files.pythonhosted.org/packages/a9/cd/34f6b0780301be81be804d7aa71d571457369e6131e2b330af2b0fed1aad/pandas-1.5.3-cp310-cp310-macosx_10_9_universal2.whl&quot;, hash = &quot;sha256:3749077d86e3a2f0ed51367f30bf5b82e131cc0f14260c4d3e499186fccc4406&quot;, size = 18619230 },
    { url = &quot;https://files.pythonhosted.org/packages/5f/34/b7858bb7d6d6bf4d9df1dde777a11fcf3ff370e1d1b3956e3d0fcca8322c/pandas-1.5.3-cp310-cp310-macosx_10_9_x86_64.whl&quot;, hash = &quot;sha256:972d8a45395f2a2d26733eb8d0f629b2f90bebe8e8eddbb8829b180c09639572&quot;, size = 11982991 },
    { url = &quot;https://files.pythonhosted.org/packages/b8/6c/005bd604994f7cbede4d7bf030614ef49a2213f76bc3d738ecf5b0dcc810/pandas-1.5.3-cp310-cp310-macosx_11_0_arm64.whl&quot;, hash = &quot;sha256:50869a35cbb0f2e0cd5ec04b191e7b12ed688874bd05dd777c19b28cbea90996&quot;, size = 10927131 },
    { url = &quot;https://files.pythonhosted.org/packages/27/c7/35b81ce5f680f2dac55eac14d103245cd8cf656ae4a2ff3be2e69fd1d330/pandas-1.5.3-cp310-cp310-manylinux_2_17_aarch64.manylinux2014_aarch64.whl&quot;, hash = &quot;sha256:c3ac844a0fe00bfaeb2c9b51ab1424e5c8744f89860b138434a363b1f620f354&quot;, size = 11368188 },
    { url = &quot;https://files.pythonhosted.org/packages/49/e2/79e46612dc25ebc7603dc11c560baa7266c90f9e48537ecf1a02a0dd6bff/pandas-1.5.3-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl&quot;, hash = &quot;sha256:7a0a56cef15fd1586726dace5616db75ebcfec9179a3a55e78f72c5639fa2a23&quot;, size = 12062104 },
    { url = &quot;https://files.pythonhosted.org/packages/d9/cd/f27c2992cbe05a3e39937f73a4be635a9ec149ec3ca4467d8cf039718994/pandas-1.5.3-cp310-cp310-win_amd64.whl&quot;, hash = &quot;sha256:478ff646ca42b20376e4ed3fa2e8d7341e8a63105586efe54fa2508ee087f328&quot;, size = 10362473 },
    { url = &quot;https://files.pythonhosted.org/packages/e2/24/a26af514113fd5eca2d8fe41ba4f22f70dfe6afefde4a6beb6a203570935/pandas-1.5.3-cp311-cp311-macosx_10_9_universal2.whl&quot;, hash = &quot;sha256:6973549c01ca91ec96199e940495219c887ea815b2083722821f1d7abfa2b4dc&quot;, size = 18387750 },
    { url = &quot;https://files.pythonhosted.org/packages/53/c9/d2f910dace7ef849b626980d0fd033b9cded36568949c8d560c9630ad2e0/pandas-1.5.3-cp311-cp311-macosx_10_9_x86_64.whl&quot;, hash = &quot;sha256:c39a8da13cede5adcd3be1182883aea1c925476f4e84b2807a46e2775306305d&quot;, size = 11868668 },
    { url = &quot;https://files.pythonhosted.org/packages/b0/be/1843b9aff84b98899663e7cad9f45513dfdd11d69cb5bd85c648aaf6a8d4/pandas-1.5.3-cp311-cp311-macosx_11_0_arm64.whl&quot;, hash = &quot;sha256:f76d097d12c82a535fda9dfe5e8dd4127952b45fea9b0276cb30cca5ea313fbc&quot;, size = 10814036 },
    { url = &quot;https://files.pythonhosted.org/packages/63/8d/c2bd356b9d4baf1c5cf8d7e251fb4540e87083072c905430da48c2bb31eb/pandas-1.5.3-cp311-cp311-manylinux_2_17_aarch64.manylinux2014_aarch64.whl&quot;, hash = &quot;sha256:e474390e60ed609cec869b0da796ad94f420bb057d86784191eefc62b65819ae&quot;, size = 11374218 },
    { url = &quot;https://files.pythonhosted.org/packages/56/73/3351beeb807dca69fcc3c4966bcccc51552bd01549a9b13c04ab00a43f21/pandas-1.5.3-cp311-cp311-manylinux_2_17_x86_64.manylinux2014_x86_64.whl&quot;, hash = &quot;sha256:5f2b952406a1588ad4cad5b3f55f520e82e902388a6d5a4a91baa8d38d23c7f6&quot;, size = 12017319 },
    { url = &quot;https://files.pythonhosted.org/packages/da/6d/1235da14daddaa6e47f74ba0c255358f0ce7a6ee05da8bf8eb49161aa6b5/pandas-1.5.3-cp311-cp311-win_amd64.whl&quot;, hash = &quot;sha256:bc4c368f42b551bf72fac35c5128963a171b40dce866fb066540eeaf46faa003&quot;, size = 10303385 },
]
</code></pre>
<p>As you can see - there are no wheels listed for python 3.12.</p>
<p>Now this is my modified <code>pyproject.toml</code> after building a wheel for <code>pandas==1.5.3</code> on python 3.12 and publishing it to my private pypi index:</p>
<pre><code class="language-toml">[project]
name = &quot;test-uv-lock&quot;
version = &quot;0.0.dev0&quot;
requires-python = &quot;&gt;=3.10&quot;
dependencies = [
    &quot;pandas&gt;=1.3.4,&lt;2; python_version &lt;= '3.10'&quot;,
    &quot;pandas&gt;=1.5.2,&lt;2; python_version == '3.11'&quot;,
    &quot;pandas&gt;=1.5.3,&lt;2; python_version &gt;= '3.12'&quot;,
]

[tool.uv]
index-strategy = &quot;unsafe-best-match&quot;
extra-index-url = [
    &quot;https://my-private-pypi-repo.org/simple&quot;,
]
</code></pre>
<p>And this is the <code>[[package]]</code> section for <code>pandas</code> in <code>uv.lock</code> after running <code>uv lock</code>:</p>
<pre><code>[[package]]
name = &quot;pandas&quot;
version = &quot;1.5.3&quot;
source = { registry = &quot;https://my-private-pypi-repo.org/simple&quot; }
dependencies = [
    { name = &quot;numpy&quot; },
    { name = &quot;python-dateutil&quot; },
    { name = &quot;pytz&quot; },
]
wheels = [
    { url = &quot;https://my-private-pypi-repo.org/simple/pandas/1.5.3/pandas-1.5.3-cp312-cp312-linux_x86_64.whl&quot;, hash = &quot;sha256:6081e82b662d5109a7ba779063f947794e67be96a0ceac0aaf76121db56f096c&quot; },
]
</code></pre>
<p>As you can see:</p>
<ol>
<li>There is only one <code>source</code> registry which is my private index.</li>
<li>There is no <code>sdist</code> because I didn't publish the source distribution to my private index.</li>
<li>There is only one <code>wheel</code> listed - the one from my private index.</li>
</ol>
<p>Currently my workaround for this is to download all the other wheels and sdist from the original lock file and publish them to my private repo, but that seems like a very brittle solution:</p>
<ol>
<li>What do I do when I need to change dependency versions or face this issue with another package? Download and publish all the wheels again?</li>
<li>What if a wheel is published to pypi.org for some platform I didn't yet have the wheels for?</li>
</ol>
<p>TL;DR - Can the <code>source</code> entry in the <code>[[pacakge]]</code> part of the <code>uv.lock</code> file support more than one <code>registry</code>?</p>
<p>Ran all of these examples with <code>uv==0.4.16</code></p>
<pre><code>$ uv --version
uv 0.4.16 (e81ed8ec5 2024-09-24)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @zanieb on 2024-09-26 12:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @charliermarsh on 2024-09-28 19:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-28 19:09</div>
            <div class="timeline-body"><p>I think we can support this in the near future but you'll need to indicate (in the <code>pyproject.toml</code>) which platforms should pull from your index vs. which should not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zmeir">@zmeir</a> on 2024-09-29 07:59</div>
            <div class="timeline-body"><p>Thanks @charliermarsh !</p>
<p>How will that work with internal packages that are only available through my private index?</p>
<p>In my real example, my project doesn't depend on <code>pandas</code> directly, but rather on some internal package <code>foo</code>, which in turn depends on <code>pandas</code>.<br />
So when I generate the <code>uv.lock</code> file I want to get:</p>
<ol>
<li>All of <code>foo</code>'s ditributions from my private index</li>
<li>The custom wheels I built for <code>pandas</code> from my private index (specifically for a couple of platforms on python 3.12)</li>
<li>All the rest of of the distributions for <code>pandas</code> (and any other packages) from pypi.org</li>
</ol>
<p>Does that make sense?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zmeir">@zmeir</a> on 2024-10-17 18:23</div>
            <div class="timeline-body"><p>Hey @charliermarsh</p>
<p>Just saw #7769 was released in <code>0.4.23</code> and it seems like it could really help with my issue.</p>
<p>There's one thing I'm having trouble understanding:<br />
In my scenario, I only want to pull <code>pandas</code> from my private index for a specific version (1.5.3) and specific platforms (macos and linux).<br />
From the documentation on <code>[tool.uv.sources]</code> it looks like only the platform restriction part of my scenario is possible, but there is no way to specify that my private index should only be used for <code>pandas==1.5.3</code>, while for the rest of the versions the default index should be used. Am I missing something or is this true?</p>
<p>Regardless, thanks for all the hard work!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-17 21:26</div>
            <div class="timeline-body"><p>Yeah you can do something like this to pull Pandas from your custom index only on macOS (Darwin):</p>
<pre><code class="language-toml">[project]
name = &quot;test-uv-lock&quot;
version = &quot;0.0.dev0&quot;
requires-python = &quot;&gt;=3.10&quot;
dependencies = [
    &quot;pandas&quot;
]

[[tool.uv.index]]
name = &quot;private&quot;
url = &quot;https://my-private-pypi-repo.org/simple&quot;
explicit = true

[tool.uv.sources]
pandas = { index = &quot;private&quot;, markers = &quot;sys_platform == 'darwin'&quot; }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-17 21:28</div>
            <div class="timeline-body"><p>I think the thing I don't follow from your request is: the lockfile is going to lock to a single version for a given platform. It's either going to be 1.5.3 or not. So what would it mean to pull 1.5.3 from the index, but other versions from some other index (on the same platform)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zmeir">@zmeir</a> on 2024-10-18 07:35</div>
            <div class="timeline-body"><p>I generate 2 lockfiles- one with the default resolution (highest) and another with <code>--resolution lowest-direct</code>. With the lowest resolution I get <code>pandas==1.5.3</code>, for which I want to use my prebuilt wheel in my private index, but for the highest resolution I can potentially get a higher <code>pandas</code> version, for which I want to use pypi.org as the index. I'm guessing I can tweak the command I use for the lowest resolution to include the extra information I need to control the index, without affecting the highest resolution, but I was hoping to find a way to contain all the necessary information inside the <code>pyproject.toml</code> itself. This way I can have a generic CI process for all projects that uses the same lock commands, and the specific differences are contained within the <code>pyproject.toml</code> of each project.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zmeir">@zmeir</a> on 2024-10-20 13:05</div>
            <div class="timeline-body"><p>I'll try to elaborate on my use-case with another example.</p>
<p>Let's look at the following <code>pyproject.toml</code>:</p>
<pre><code class="language-toml">[project]
name = &quot;test-uv-lock&quot;
version = &quot;0.0.dev0&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = [
    &quot;pandas==1.5.3; python_version == '3.12.*'&quot;,
    &quot;pandas==2.2.3; python_version == '3.13.*'&quot;,
]


[[tool.uv.index]]
name = &quot;private&quot;
url = &quot;https://my-private-pypi-repo.org/simple&quot;
explicit = true

[tool.uv.sources]
pandas = { index = &quot;private&quot;, marker = &quot;sys_platform == 'darwin' and python_version == '3.12.*'&quot; }
</code></pre>
<p>As it currently stands, this <code>pyproject.toml</code> works exactly the way I need:</p>
<ol>
<li>For python version 3.12 on MacOS - I pull the wheel for <code>pandas==1.5.3</code> from my private index</li>
<li>For all other platforms or for python version 3.13 - I pull the wheel for <code>pandas</code> from pypi.org</li>
</ol>
<p>But I fear this setup will cause me much pain as I continue to develop and upgrade my pacakge:<br />
The strict <code>pandas==</code> version restrictions are too limiting since I am developing a library. Now if I change <code>pandas==1.5.3</code> to <code>pandas&gt;=1.5.3</code>, I have to make sure to build and publish a python 3.12 wheel for all future versions of <code>pandas</code> to my private index, otherwise if I add another dependency that will cause the resolver to select a version of pandas that is not <code>1.5.3</code>, it won't exist in my index and the resolution will likely fail.</p>
<p>I hope this helps to better illustrate the situation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @jtfmumm by @jtfmumm on 2025-02-21 09:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @jtfmumm by @jtfmumm on 2025-02-28 09:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:27:20 UTC
    </footer>
</body>
</html>
