<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual environments break on Homebrew upgrades due to using a `Cellar` link - astral-sh/uv #1640</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Virtual environments break on Homebrew upgrades due to using a <code>Cellar</code> link</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/1640">#1640</a>
        opened by <a href="https://github.com/cjolowicz">@cjolowicz</a>
        on 2024-02-18 11:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cjolowicz">@cjolowicz</a></div>
            <div class="timeline-body"><p>On Homebrew, virtual environments created by <code>uv venv</code> reference the Python installation under <code>Cellar</code> in their interpreter symlink and <code>pyvenv.cfg</code>, which has the full downstream version in its path. These virtual environments break when Homebrew upgrades the respective Python package to the next maintenance release. In recent versions of <code>venv</code> and <code>virtualenv</code>, this issue was resolved by using the stable link under <code>$(brew --prefix)/opt/python@3.x/</code> instead. For example, on Python 3.11 macOS aarch64 this would be the interpreter in <code>/opt/homebrew/opt/python@3.11/bin</code>.</p>
<p>This shell session demonstrates the problem:</p>
<pre><code class="language-sh">‚ùØ uv venv
‚ùØ readlink .venv/bin/python
/opt/homebrew/Cellar/python@3.11/3.11.7_1/Frameworks/Python.framework/Versions/3.11/bin/python3.11
‚ùØ grep ^home .venv/pyvenv.cfg
home = /opt/homebrew/Cellar/python@3.11/3.11.7_1/Frameworks/Python.framework/Versions/3.11/bin
</code></pre>
<p>When Homebrew upgrades its <code>python@3.11</code> package and cleans up the old installation under <code>Cellar</code>, those references in the virtual environment start to dangle.</p>
<p>For comparison, here's what I get with <code>venv</code> from Homebrew's <code>python@3.11</code> installation:</p>
<pre><code class="language-sh">‚ùØ python3.11 -m venv .venv
‚ùØ readlink .venv/bin/python
python3.11
‚ùØ readlink .venv/bin/python3.11
/opt/homebrew/opt/python@3.11/bin/python3.11
‚ùØ grep ^home .venv/pyvenv.cfg
home = /opt/homebrew/opt/python@3.11/bin
</code></pre>
<p>And with <code>virtualenv</code>:</p>
<pre><code class="language-sh">‚ùØ virtualenv --version
virtualenv 20.25.0 from ~/.local/pipx/venvs/virtualenv/lib/python3.12/site-packages/virtualenv/__init__.py
‚ùØ virtualenv .venv
‚ùØ readlink .venv/bin/python
/opt/homebrew/opt/python@3.12/bin/python3.12
‚ùØ grep ^home .venv/pyvenv.cfg
home = /opt/homebrew/opt/python@3.12/bin
</code></pre>
<p>Affected platforms: Linux and macOS with Homebrew Python</p>
<pre><code>‚ùØ uv --version
uv 0.1.4
‚ùØ gcc -dumpmachine
arm64-apple-darwin23.2.0
</code></pre>
<!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2024-02-18 12:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">macos</span> added by @MichaReiser on 2024-02-18 12:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">virtualenv</span> added by @zanieb on 2024-02-18 20:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">great writeup</span> added by @zanieb on 2024-02-18 21:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-01 19:45</div>
            <div class="timeline-body"><p>Do you by any chance have a link to the relevant PRs or issues in <code>venv</code> and/or <code>virtualenv</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cjolowicz">@cjolowicz</a> on 2024-03-02 00:44</div>
            <div class="timeline-body"><p>I don't, but FWIW <code>venv</code> derives the <code>home</code> key from <code>sys._base_executable</code>, which is the stable path.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-02 01:01</div>
            <div class="timeline-body"><p>Hmm yeah, we're using <code>sys._base_executable</code> as of an open PR, but even that gives me:</p>
<pre><code class="language-shell">‚ùØ python3.8
Python 3.8.18 (default, Aug 24 2023, 19:48:18)
[Clang 15.0.0 (clang-1500.1.0.2.5)] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import sys
&gt;&gt;&gt; sys._base_executable
'/opt/homebrew/bin/python3.8'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-02 02:06</div>
            <div class="timeline-body"><p>The problem is that we're calling <code>canonicalize</code> on the <code>sys.executable</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-02 02:16</div>
            <div class="timeline-body"><p>@konstin -- We may want to revisit this change (https://github.com/astral-sh/uv/issues/965). I think we should only do this (<code>canonicalize</code>) if we're in a virtual environment?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-03-02 02:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-02 02:23</div>
            <div class="timeline-body"><p>We may want something like...</p>
<ul>
<li>If we're not in a venv, use <code>sys.executable</code>.</li>
<li>If we are in a venv, resolve symlinks once (not recursively) on <code>sys.executable</code>.</li>
</ul>
<p>That's closer to virtualenv:</p>
<pre><code class="language-python"># if we're not in a virtual environment, this is already a system python, so return the original executable
# note we must choose the original and not the pure executable as shim scripts might throw us off
return self.original_executable
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2024-03-02 02:35</div>
            <div class="timeline-body"><p>I don't know if it's quite relevant but they just fixed a bug by storing the resolved absolute path in the metadata file that is generated for virtual environments: https://github.com/pypa/virtualenv/issues/2682</p>
<p>Also, I know all of you are basically Rust experts, but in case I am reading the source correctly please never ever use canonicalize directly as it is literally (I'm not joking) <a href="https://github.com/rust-lang/rust/issues/42869">broken on Windows</a> and will cause all of us bugs and unexpected behavior. Please don't use it. Instead, it's common to use the <a href="https://crates.io/crates/dunce">dunce</a> crate or the <a href="https://crates.io/crates/normpath">normpath</a> crate when you don't want to resolve symlinks. See even <a href="https://twitter.com/mitsuhiko/status/1699381180536086714">Armin talking about it</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-02 02:54</div>
            <div class="timeline-body"><p>Haha. We do use <code>fs::canonicalize</code> but we then strip UNC paths everywhere. (I guess we could use dunce's <code>canonicalize</code> to simplify that process.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-02 02:57</div>
            <div class="timeline-body"><p>I'd actually expect that virtualenv change to <em>break</em> this case, if I'm reading it correctly:</p>
<pre><code>‚ùØ realpath /opt/homebrew/opt/python@3.8/bin/python3.8
/opt/homebrew/Cellar/python@3.8/3.8.18_2/Frameworks/Python.framework/Versions/3.8/bin/python3.8
</code></pre>
<p>So now <code>virtualenv</code> would also use the Cellar path, IIUC?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2024-03-02 03:10</div>
            <div class="timeline-body"><p>I don't own a macOS to test that for you unfortunately but that sounds right.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-02 03:53</div>
            <div class="timeline-body"><p>On <code>main</code>, <code>virtualenv</code> uses <code>home = /opt/homebrew/Cellar/python@3.8/3.8.18_2/bin</code>. So, they might have the same problem @cjolowicz?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-02 11:34</div>
            <div class="timeline-body"><p>\cc @gaborbernat -- it seems like <code>virtualenv</code> on <code>main</code> will resolve symlinks for system Pythons, which seems desirable in some cases (hence the issue in <code>virtualenv</code>) but not in others (hence this issue). I can't tell which is &quot;correct&quot; though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on 2024-03-03 03:57</div>
            <div class="timeline-body"><p>I do not have a good answer here. üò±</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-03-03 17:58</div>
            <div class="timeline-body"><blockquote>
<p>We may want to revisit this change (https://github.com/astral-sh/uv/issues/965). I think we should only do this (canonicalize) if we're in a virtual environment?</p>
</blockquote>
<p>Agreed, i think this is better, i'm also thinking about the use case where somebody might have intentional redirects for their python setup.</p>
<p>For the Cellar issue, note that technically different patch versions aren't compatible from a packaging perspective, technically a project could require <code>python_full_version != &quot;3.12.2&quot;</code>. In practice projects i've only seen lower bounds for patch version (e.g. <code>&gt;3.8.1</code>), upper or exact bounds would be against how python patch versions are maintained and we're building a more reliable tool by intentionally ignoring this detail.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/minusf">@minusf</a> on 2024-09-13 18:28</div>
            <div class="timeline-body"><p>It would be really nice if this was solved somehow, all my uv venvs break after a minor python update...</p>
<p>Besides the difference in the picked executable symlink as described above, I find it interesting that both tools pick the absolute symlink completely differently:</p>
<pre><code>pip_venv/bin/python@ -&gt; python3.12
pip_venv/bin/python3@ -&gt; python3.12
pip_venv/bin/python3.12@ -&gt; /opt/homebrew/opt/python@3.12/bin/python3.12

uv_venv/bin/python@ -&gt; /opt/homebrew/Cellar/python@3.12/3.12.6/Frameworks/Python.framework/Versions/3.12/bin/python3.12
uv_venv/bin/python3@ -&gt; python
uv_venv/bin/python3.12@ -&gt; python
</code></pre>
<p>FWIW my OCD prefers the pip version, the most specific filename has the absolute symlink (<code>python3.12</code>) instead of uv's least specific (<code>python</code>) üòÖ</p>
<p>In case it helps anyone here is also the difference between the <code>pyvenv.conf</code>'s:</p>
<pre><code class="language-diff">--- pip_venv/pyvenv.cfg 2024-09-13 20:18:47.389618788 +0200
+++ uv_venv/pyvenv.cfg  2024-09-13 20:19:00.968279785 +0200
@@ -1,5 +1,6 @@
-home = /opt/homebrew/opt/python@3.12/bin
+home = /opt/homebrew/Cellar/python@3.12/3.12.6/Frameworks/Python.framework/Versions/3.12/bin
+implementation = CPython
+uv = 0.4.9
+version_info = 3.12.6
 include-system-site-packages = false
-version = 3.12.6
-executable = /opt/homebrew/Cellar/python@3.12/3.12.6/Frameworks/Python.framework/Versions/3.12/bin/python3.12
-command = /opt/homebrew/opt/python@3.12/bin/python3.12 -m venv /Volumes/sensitive/src/handmade/0/pip_venv
+relocatable = false
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-23 13:58</div>
            <div class="timeline-body"><p>I'm open to changing this since it's been reported multiple times. It might be considered breaking though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/frostming">@frostming</a> on 2024-09-24 08:36</div>
            <div class="timeline-body"><p>I suggest changing it to resolve symbolic links until a non-venv python is found.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lespea">@lespea</a> on 2024-09-24 15:23</div>
            <div class="timeline-body"><p>I think at the very least it would be nice to have a flag to force one behavior or the other, but maybe there's a concern of bloating commands with too many switches.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-24 15:24</div>
            <div class="timeline-body"><p>I'm fine to change this but it probably requires 0.5.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v0.5.0" by @charliermarsh on 2024-09-24 15:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-21 18:31</div>
            <div class="timeline-body"><p>I'll look into this as part of v0.5.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-21 19:44</div>
            <div class="timeline-body"><p>So just to summarize current behavior:</p>
<ul>
<li><code>python -m .venv</code>: Does not resolve symlinks (seemingly, even if you're creating a venv from within a venv -- at least sometimes).</li>
<li><code>virtualenv</code>: Does fully resolve symlinks (matches uv's behavior). Older versions of virtualenv do <em>not</em> resolve symlinks, but newer versions do, and so suffer from this same problem.</li>
<li><code>uv</code>: Fully resolves symlinks.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-21 19:49</div>
            <div class="timeline-body"><p>I don't fully understand the <code>python -m .venv</code> behavior. It may have changed ove rtime. For example, if I create a venv with the Homebrew Python, then create a venv from that venv, I get:</p>
<pre><code>‚ùØ cat .brew1/pyvenv.cfg
home = /opt/homebrew/opt/python@3.9/bin
include-system-site-packages = false
version = 3.9.19

‚ùØ cat .brew2/pyvenv.cfg
home = /Users/crmarsh/workspace/uv/.brew1/bin
include-system-site-packages = false
version = 3.9.19
</code></pre>
<p>But if I do the same with my non-Homebrew Python, I get:</p>
<pre><code>‚ùØ cat .venv1/pyvenv.cfg
home = /Users/crmarsh/.local/share/rtx/installs/python/3.12.3/bin
include-system-site-packages = false
version = 3.12.3
executable = /Users/crmarsh/.local/share/rtx/installs/python/3.12.3/bin/python3.12
command = /Users/crmarsh/.local/share/rtx/installs/python/3.12.3/bin/python -m venv /Users/crmarsh/workspace/uv/.venv1

‚ùØ cat .venv2/pyvenv.cfg
home = /Users/crmarsh/.local/share/rtx/installs/python/3.12.3/bin
include-system-site-packages = false
version = 3.12.3
executable = /Users/crmarsh/.local/share/rtx/installs/python/3.12.3/bin/python3.12
command = /Users/crmarsh/workspace/uv/.venv1/bin/python -m venv /Users/crmarsh/workspace/uv/.venv2
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-21 20:14</div>
            <div class="timeline-body"><p>Ok, if I use Homebrew's 3.12:</p>
<pre><code>‚ùØ cat .venv12-1/pyvenv.cfg
home = /opt/homebrew/opt/python@3.12/bin
include-system-site-packages = false
version = 3.12.7
executable = /opt/homebrew/Cellar/python@3.12/3.12.7_1/Frameworks/Python.framework/Versions/3.12/bin/python3.12
command = /opt/homebrew/opt/python@3.12/bin/python3.12 -m venv /Users/crmarsh/workspace/uv/.venv12-1

‚ùØ cat .venv12-2/pyvenv.cfg
home = /opt/homebrew/Cellar/python@3.12/3.12.7_1/Frameworks/Python.framework/Versions/3.12/bin
include-system-site-packages = false
version = 3.12.7
executable = /opt/homebrew/Cellar/python@3.12/3.12.7_1/Frameworks/Python.framework/Versions/3.12/bin/python3.12
command = /Users/crmarsh/workspace/uv/.venv12-1/bin/python -m venv /Users/crmarsh/workspace/uv/.venv12-2
</code></pre>
<p>So it <em>fully</em> resolves the symlink when inside a virtualenv, and doesn't resolve it when outside a virtualenv.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-21 20:14</div>
            <div class="timeline-body"><p>What we're suggesting is different than all of these: resolve until we see a non-virtualenv. But I think it makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-21 20:37</div>
            <div class="timeline-body"><p>Ok, I'm guessing that the Homebrew Pythons didn't used to set <code>sys._base_executable</code>? And now it's set to <code>/opt/homebrew/Cellar/python@3.12/3.12.7_1/Frameworks/Python.framework/Versions/3.12/bin/python3.12</code> so they always use that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-21 21:38</div>
            <div class="timeline-body"><p>(Gonna put together a table documenting all this.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-21 23:43</div>
            <div class="timeline-body"><p>Collated here: https://docs.google.com/spreadsheets/d/1Vw5ClYEjgrBJJhQiwa3cCenIA1GbcRyudYN9NwQaEcM/edit?usp=sharing (sorry, the formatting is terrible)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-21 23:44</div>
            <div class="timeline-body"><p>uv's current behavior is closest to the new <code>virtualenv</code> behavior (which also suffers from the problem described in this issue; prior versions did not). The <code>venv</code> behavior is closest to optimal but not quite optimal IMO because it uses <code>sys._base_executable</code> which leads to strange outcomes for the nested virtual environment with Brew.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-22 00:20</div>
            <div class="timeline-body"><p>PR here: https://github.com/astral-sh/uv/pull/8433</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/minusf">@minusf</a> on 2024-10-22 20:51</div>
            <div class="timeline-body"><p>Thank you for looking into this. Out of curiosity, what is the use case of</p>
<blockquote>
<p>then create a venv from that venv</p>
</blockquote>
<p>Admittedly I am a very vanilla venv user, always use a homebrew python (or now uv) to create single simple venv's per projects, or until <code>uv tool install</code> came along, some handmade <code>~/usr/venvs/...</code> for running python apps not installed with brew (esp after 3.12 python started enforcing not to abuse the system wide <code>site-packages</code>).  btw <code>uv tool install</code> is a real game changer for these and I even uninstalled some brew packages that were lagging a bit behind.</p>
<p>TBH while waiting for this feature to land I was even content just recreating and repopulating the venv's after a python upgrade, it's just so fast from the cache... Although I was a bit surprised that <code>uv venv</code> is a no-questions-asked destructive operation, and an existing <code>.venv</code> means nothing to it ü§£</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-11-07 20:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-10 20:42</div>
            <div class="timeline-body"><p>We refined the behavior a bit in https://github.com/astral-sh/uv/pull/9723.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:23:44 UTC
    </footer>
</body>
</html>
