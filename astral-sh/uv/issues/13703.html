<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>concurrent wheel builds fail oddly - astral-sh/uv #13703</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>concurrent wheel builds fail oddly</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/13703">#13703</a>
        opened by <a href="https://github.com/thatch">@thatch</a>
        on 2025-05-28 18:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/thatch">@thatch</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>with <code>t/setup.py</code> containing</p>
<pre><code class="language-py">import setuptools
setuptools.setup(name=&quot;t&quot;, version=&quot;4&quot;)
</code></pre>
<p><code>uv build --wheel &amp; sleep 0.1; uv build --wheel</code> fails because the invocations are stepping on each other.  I had hoped this would lock something related to the path (or the <code>build</code> subdir) and block the second until the first is done, but that does not appear to be the case.</p>
<p>This is a simplified repro that was originally something like</p>
<pre><code># x-reqs.txt
t @ t/
...
</code></pre>
<pre><code># y-reqs.txt
t @ t/
...
</code></pre>
<pre><code class="language-sh">(uv venv x; VIRTUAL_ENV=x uv pip install x-reqs.txt) &amp;
(uv venv y; VIRTUAL_ENV=y uv pip install y-reqs.txt)
wait
</code></pre>
<p>The user assumed that installs from the same local dir would work fine as long as they were to different venvs.  The bug seems to be a missing lock during wheel builds.</p>
<p>I can ask them to change settings, but I don't think that <code>-e</code> or a pep517 build would improve the situation here.</p>
<h3>Platform</h3>
<p>Ubuntu</p>
<h3>Version</h3>
<p>Jammy</p>
<h3>Python version</h3>
<p>3.12</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @thatch on 2025-05-28 18:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thatch">@thatch</a> on 2025-05-28 18:49</div>
            <div class="timeline-body"><p>Sample failure, showing a collision on PKG-INFO from concurrent builds:</p>
<pre><code>yCopying t.egg-info to build/bdist.macosx-11.0-arm64/wheel/./t-4-py3.13.egg-info
xwriting manifest file 't.egg-info/SOURCES.txt'
xremoving 'build/bdist.macosx-11.0-arm64/wheel/./t-4-py3.13.egg-info' (and everything under it)
yerror: [Errno 2] No such file or directory: 'build/bdist.macosx-11.0-arm64/wheel/./t-4-py3.13.egg-info/PKG-INFO'
xCopying t.egg-info to build/bdist.macosx-11.0-arm64/wheel/./t-4-py3.13.egg-info
</code></pre>
<details>
```
$ (uv build --wheel 2>&1 | sed -e 's/^/x/') & (uv build --wheel 2>&1 | sed -e 's/^/y/')
[1] 85628
xBuilding wheel...
yBuilding wheel...
^[[Cyrunning egg_info
xrunning egg_info
ywriting t.egg-info/PKG-INFO
xwriting t.egg-info/PKG-INFO
xwriting dependency_links to t.egg-info/dependency_links.txt
ywriting dependency_links to t.egg-info/dependency_links.txt
xwriting top-level names to t.egg-info/top_level.txt
ywriting top-level names to t.egg-info/top_level.txt
xreading manifest file 't.egg-info/SOURCES.txt'
yreading manifest file 't.egg-info/SOURCES.txt'
xwriting manifest file 't.egg-info/SOURCES.txt'
ywriting manifest file 't.egg-info/SOURCES.txt'
xrunning bdist_wheel
yrunning bdist_wheel
yrunning build
xrunning build
xinstalling to build/bdist.macosx-11.0-arm64/wheel
xrunning install
yinstalling to build/bdist.macosx-11.0-arm64/wheel
yrunning install
xrunning install_egg_info
yrunning install_egg_info
yrunning egg_info
xrunning egg_info
ywriting t.egg-info/PKG-INFO
xwriting t.egg-info/PKG-INFO
ywriting dependency_links to t.egg-info/dependency_links.txt
xwriting dependency_links to t.egg-info/dependency_links.txt
ywriting top-level names to t.egg-info/top_level.txt
xwriting top-level names to t.egg-info/top_level.txt
yreading manifest file 't.egg-info/SOURCES.txt'
xreading manifest file 't.egg-info/SOURCES.txt'
ywriting manifest file 't.egg-info/SOURCES.txt'
yCopying t.egg-info to build/bdist.macosx-11.0-arm64/wheel/./t-4-py3.13.egg-info
xwriting manifest file 't.egg-info/SOURCES.txt'
xremoving 'build/bdist.macosx-11.0-arm64/wheel/./t-4-py3.13.egg-info' (and everything under it)
yerror: [Errno 2] No such file or directory: 'build/bdist.macosx-11.0-arm64/wheel/./t-4-py3.13.egg-info/PKG-INFO'
xCopying t.egg-info to build/bdist.macosx-11.0-arm64/wheel/./t-4-py3.13.egg-info
xrunning install_scripts
xcreating build/bdist.macosx-11.0-arm64/wheel/t-4.dist-info/WHEEL
xcreating '/private/tmp/t/dist/.tmp-dnwckr5d/t-4-py3-none-any.whl' and adding 'build/bdist.macosx-11.0-arm64/wheel' to it
xadding 't-4.dist-info/METADATA'
xadding 't-4.dist-info/WHEEL'
xadding 't-4.dist-info/top_level.txt'
xadding 't-4.dist-info/RECORD'
xremoving build/bdist.macosx-11.0-arm64/wheel
xSuccessfully built dist/t-4-py3-none-any.whl
y  × Failed to build `/private/tmp/t`
y  ├─▶ The build backend returned an error
y  ╰─▶ Call to `setuptools.build_meta:__legacy__.build_wheel` failed (exit status: 1)
y      hint: This usually indicates a problem with the package or the build environment.
[1]  + done       ( uv build --wheel 2>&1 | sed -e 's/^/x/'; )
```
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-28 18:50</div>
            <div class="timeline-body"><p>I guess we should lock the build directory, kind of unfortunate though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thatch">@thatch</a> on 2025-05-28 18:55</div>
            <div class="timeline-body"><p>Yeah I don't see great options here -- calling the build directory anything but &quot;build&quot; people would need to change gitignores.  Is there anything we can enable that would make implicit builds use a tempdir instead?</p>
<p>I'm reluctant to add manual locks on my end because the obvious place to do that would be at the <code>x</code> / <code>y</code> level, and that's not where the conflict is happening, it's on the dep.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @oconnor663 by @zanieb on 2025-06-20 14:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-06-20 21:45</div>
            <div class="timeline-body"><p>I can't always reproduce the failure with the exact steps above, but this reliably repros it with 10 concurrent builds on my machine (current <code>main</code>):</p>
<pre><code>$ cat &gt;setup.py &lt;&lt;EOF
import setuptools
setuptools.setup(name=&quot;scratch&quot;, version=&quot;4&quot;)
EOF
$ for i in `seq 10` ; do
    uv build --wheel &amp;
done
[...]
$   × Failed to build `/tmp/tmp.wGbtw5vwhy`
  ├─▶ The build backend returned an error
  ╰─▶ Call to `setuptools.build_meta:__legacy__.build_wheel` failed (exit status: 1)
      hint: This usually indicates a problem with the package or the build environment.
[...]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @oconnor663 on 2025-06-26 19:28</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:31:35 UTC
    </footer>
</body>
</html>
