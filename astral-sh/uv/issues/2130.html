<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The &quot;standard&quot; installation use `pyproject.toml` in UV rather than dynamic dependencies via build hooks (comparing to PIP) - astral-sh/uv #2130</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>The &quot;standard&quot; installation use <code>pyproject.toml</code> in UV rather than dynamic dependencies via build hooks (comparing to PIP)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/2130">#2130</a>
        opened by <a href="https://github.com/potiuk">@potiuk</a>
        on 2024-03-02 14:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/potiuk">@potiuk</a></div>
            <div class="timeline-body"><p>When you install packages using remote url and specify extras, the <code>--editable</code> version of extras are used, rather than the dependencies used in wheel. While I don't think it's very well specified which dependencies should be used</p>
<pre><code>uv pip install 'apache-airflow[aiobotocore,amazon,async,celery,cncf-kubernetes,common-io, \
docker,elasticsearch,ftp,google,google-auth,graphviz,grpc,hashicorp,http,ldap,microsoft-azure, \
mysql,odbc,openlineage,pandas,postgres,redis,sendgrid,sftp,slack,snowflake, \
ssh,statsd,uv,virtualenv] @ https://github.com/apache/airflow/archive/main.tar.gz'
</code></pre>
<details>
  <summary>Here is the output of `uv pip install` output</summary>

<blockquote>
<p>Resolved 359 packages in 2.94s</p>
</blockquote>
<blockquote>
<p>Downloaded 154 packages in 2.44s
Installed 257 packages in 700ms</p>
<ul>
<li>adal==1.2.7</li>
<li>adlfs==2024.2.0</li>
<li>aiobotocore==2.12.0</li>
<li>aiofiles==23.2.1</li>
<li>aiohttp==3.9.3</li>
<li>aioitertools==0.11.0</li>
<li>aiosignal==1.3.1</li>
<li>amqp==5.2.0</li>
<li>annotated-types==0.6.0</li>
<li>apispec==6.5.0</li>
<li>asn1crypto==1.5.1</li>
<li>async-timeout==4.0.3</li>
<li>asyncssh==2.14.2</li>
<li>authlib==1.3.0</li>
<li>aws-sam-translator==1.85.0</li>
<li>aws-xray-sdk==2.12.1</li>
<li>azure-batch==14.1.0</li>
<li>azure-common==1.1.28</li>
<li>azure-core==1.30.1</li>
<li>azure-cosmos==4.5.1</li>
<li>azure-datalake-store==0.0.53</li>
<li>azure-identity==1.15.0</li>
<li>azure-keyvault-secrets==4.8.0</li>
<li>azure-kusto-data==4.3.1</li>
<li>azure-mgmt-containerinstance==10.1.0</li>
<li>azure-mgmt-containerregistry==10.3.0</li>
<li>azure-mgmt-core==1.4.0</li>
<li>azure-mgmt-cosmosdb==9.4.0</li>
<li>azure-mgmt-datafactory==5.0.0</li>
<li>azure-mgmt-datalake-nspkg==3.0.1</li>
<li>azure-mgmt-datalake-store==0.5.0</li>
<li>azure-mgmt-nspkg==3.0.2</li>
<li>azure-mgmt-resource==23.0.1</li>
<li>azure-mgmt-storage==21.1.0</li>
<li>azure-nspkg==3.0.2</li>
<li>azure-servicebus==7.11.4</li>
<li>azure-storage-blob==12.19.0</li>
<li>azure-storage-file-datalake==12.14.0</li>
<li>azure-storage-file-share==12.15.0</li>
<li>azure-synapse-artifacts==0.18.0</li>
<li>azure-synapse-spark==0.7.0</li>
<li>babel==2.14.0</li>
<li>bcrypt==4.1.2</li>
<li>beautifulsoup4==4.12.3</li>
<li>billiard==4.2.0</li>
<li>boto3==1.34.51</li>
<li>botocore==1.34.51</li>
<li>cachetools==5.3.3</li>
<li>cattrs==23.2.3</li>
<li>celery==5.3.6</li>
<li>cfn-lint==0.85.3</li>
<li>chardet==5.2.0</li>
<li>click-didyoumean==0.3.0</li>
<li>click-plugins==1.1.1</li>
<li>click-repl==0.3.0</li>
<li>colorama==0.4.6</li>
</ul>
<ul>
<li>cryptography==42.0.5</li>
</ul>
<ul>
<li>cryptography==41.0.7</li>
<li>db-dtypes==1.2.0</li>
<li>decorator==5.1.1</li>
<li>distlib==0.3.8</li>
<li>dnspython==2.6.1</li>
<li>docker==7.0.0</li>
<li>elastic-transport==8.12.0</li>
<li>elasticsearch==8.12.1</li>
<li>email-validator==1.3.1</li>
<li>eventlet==0.35.2</li>
<li>filelock==3.13.1</li>
<li>flask-appbuilder==4.3.11</li>
<li>flask-babel==2.0.0</li>
<li>flask-jwt-extended==4.6.0</li>
<li>flask-limiter==3.5.1</li>
<li>flask-login==0.6.3</li>
<li>flask-sqlalchemy==2.5.1</li>
<li>flower==2.0.1</li>
<li>frozenlist==1.4.1</li>
<li>gcloud-aio-auth==4.2.3</li>
<li>gcloud-aio-bigquery==7.1.0</li>
<li>gcloud-aio-storage==9.2.0</li>
<li>gcsfs==2024.2.0</li>
<li>gevent==24.2.1</li>
<li>google-ads==23.1.0</li>
<li>google-analytics-admin==0.22.6</li>
<li>google-api-core==2.17.1</li>
<li>google-api-python-client==2.120.0</li>
<li>google-auth==2.28.1</li>
<li>google-auth-httplib2==0.2.0</li>
<li>google-auth-oauthlib==1.2.0</li>
<li>google-cloud-aiplatform==1.43.0</li>
<li>google-cloud-appengine-logging==1.4.2</li>
<li>google-cloud-audit-log==0.2.5</li>
<li>google-cloud-automl==2.13.2</li>
<li>google-cloud-batch==0.17.12</li>
<li>google-cloud-bigquery==3.17.2</li>
<li>google-cloud-bigquery-datatransfer==3.15.0</li>
<li>google-cloud-bigquery-storage==2.24.0</li>
<li>google-cloud-bigtable==2.23.0</li>
<li>google-cloud-build==3.23.2</li>
<li>google-cloud-compute==1.17.0</li>
<li>google-cloud-container==2.41.0</li>
<li>google-cloud-core==2.4.1</li>
<li>google-cloud-datacatalog==3.18.2</li>
<li>google-cloud-dataflow-client==0.8.9</li>
<li>google-cloud-dataform==0.5.8</li>
<li>google-cloud-dataplex==1.12.2</li>
<li>google-cloud-dataproc==5.9.2</li>
<li>google-cloud-dataproc-metastore==1.15.2</li>
<li>google-cloud-dlp==3.15.2</li>
<li>google-cloud-kms==2.21.2</li>
<li>google-cloud-language==2.13.2</li>
<li>google-cloud-logging==3.9.0</li>
<li>google-cloud-memcache==1.9.2</li>
<li>google-cloud-monitoring==2.19.2</li>
<li>google-cloud-orchestration-airflow==1.12.0</li>
<li>google-cloud-os-login==2.14.2</li>
<li>google-cloud-pubsub==2.19.7</li>
<li>google-cloud-redis==2.15.2</li>
<li>google-cloud-resource-manager==1.12.2</li>
<li>google-cloud-run==0.10.4</li>
<li>google-cloud-secret-manager==2.18.2</li>
<li>google-cloud-spanner==3.42.0</li>
<li>google-cloud-speech==2.25.0</li>
<li>google-cloud-storage==2.14.0</li>
<li>google-cloud-storage-transfer==1.11.2</li>
<li>google-cloud-tasks==2.16.2</li>
<li>google-cloud-texttospeech==2.16.2</li>
<li>google-cloud-translate==3.15.2</li>
<li>google-cloud-videointelligence==2.13.2</li>
<li>google-cloud-vision==3.7.1</li>
<li>google-cloud-workflows==1.14.2</li>
<li>google-crc32c==1.5.0</li>
<li>google-resumable-media==2.7.0</li>
<li>graphql-core==3.2.3</li>
<li>graphviz==0.20.1</li>
<li>greenlet==3.0.3</li>
<li>grpc-google-iam-v1==0.13.0</li>
<li>grpc-interceptor==0.15.4</li>
<li>grpcio-gcp==0.2.2</li>
<li>grpcio-status==1.62.0</li>
<li>httplib2==0.22.0</li>
<li>humanize==4.9.0</li>
<li>hvac==2.1.0</li>
<li>ijson==3.2.3</li>
<li>isodate==0.6.1</li>
<li>jmespath==1.0.1</li>
<li>joserfc==0.9.0</li>
<li>jschema-to-python==1.2.3</li>
<li>json-merge-patch==0.2</li>
<li>jsondiff==2.0.0</li>
<li>jsonpatch==1.33</li>
<li>jsonpath-ng==1.6.1</li>
<li>jsonpickle==3.0.3</li>
<li>jsonpointer==2.4</li>
<li>jsonschema-path==0.3.2</li>
<li>junit-xml==1.9</li>
<li>kombu==5.3.5</li>
<li>kubernetes==29.0.0</li>
<li>kubernetes-asyncio==29.0.0</li>
<li>ldap3==2.9.1</li>
<li>limits==3.9.0</li>
<li>looker-sdk==24.2.0</li>
<li>lxml==5.1.0</li>
<li>marshmallow-sqlalchemy==0.26.1</li>
<li>more-itertools==10.2.0</li>
<li>moto==5.0.2</li>
<li>mpmath==1.3.0</li>
<li>msal==1.27.0</li>
<li>msal-extensions==1.1.0</li>
<li>msrest==0.7.1</li>
<li>msrestazure==0.6.4</li>
<li>multidict==6.0.5</li>
<li>mypy-boto3-appflow==1.34.0</li>
<li>mypy-boto3-rds==1.34.50</li>
<li>mypy-boto3-redshift-data==1.34.0</li>
<li>mypy-boto3-s3==1.34.14</li>
<li>mysql-connector-python==8.3.0</li>
<li>mysqlclient==2.2.4</li>
<li>networkx==3.1</li>
<li>numpy==1.24.4</li>
<li>oauthlib==3.2.2</li>
<li>openapi-schema-validator==0.6.2</li>
<li>openapi-spec-validator==0.7.1</li>
<li>openlineage-integration-common==1.9.1</li>
<li>openlineage-python==1.9.1</li>
<li>openlineage-sql==1.9.1</li>
<li>ordered-set==4.1.0</li>
<li>pandas==2.0.3</li>
<li>pandas-gbq==0.21.0</li>
<li>paramiko==3.4.0</li>
<li>pathable==0.4.3</li>
<li>pbr==6.0.0</li>
<li>platformdirs==3.11.0</li>
<li>ply==3.11</li>
<li>portalocker==2.8.2</li>
<li>prison==0.2.1</li>
<li>prometheus-client==0.20.0</li>
<li>prompt-toolkit==3.0.43</li>
<li>proto-plus==1.23.0</li>
<li>psycopg2-binary==2.9.9</li>
<li>py-partiql-parser==0.5.1</li>
<li>pyarrow==15.0.0</li>
<li>pyasn1==0.5.1</li>
<li>pyasn1-modules==0.3.0</li>
<li>pyathena==3.3.0</li>
<li>pydantic==2.6.3</li>
<li>pydantic-core==2.16.3</li>
<li>pydata-google-auth==1.8.2</li>
<li>pynacl==1.5.0</li>
<li>pyodbc==5.1.0</li>
<li>pyopenssl==24.0.0</li>
<li>pyparsing==3.1.1</li>
<li>pyspnego==0.10.2</li>
<li>python-dotenv==1.0.1</li>
<li>python-http-client==3.3.7</li>
<li>python-ldap==3.4.4</li>
<li>pywinrm==0.4.3</li>
<li>redis==4.6.0</li>
<li>redshift-connector==2.1.0</li>
</ul>
<ul>
<li>referencing==0.33.0</li>
</ul>
<ul>
<li>referencing==0.31.1</li>
<li>regex==2023.12.25</li>
<li>requests-ntlm==1.2.0</li>
<li>requests-oauthlib==1.3.1</li>
<li>requests-toolbelt==1.0.0</li>
<li>responses==0.25.0</li>
<li>rsa==4.9</li>
<li>s3fs==2024.2.0</li>
<li>s3transfer==0.10.0</li>
<li>sarif-om==1.0.4</li>
<li>scramp==1.4.4</li>
<li>sendgrid==6.11.0</li>
<li>shapely==2.0.3</li>
<li>slack-sdk==3.27.1</li>
<li>snowflake-connector-python==3.7.1</li>
<li>snowflake-sqlalchemy==1.5.1</li>
<li>sortedcontainers==2.4.0</li>
<li>soupsieve==2.5</li>
<li>sqlalchemy-bigquery==1.10.0</li>
<li>sqlalchemy-redshift==0.8.14</li>
<li>sqlalchemy-spanner==1.6.2</li>
<li>sqlalchemy-utils==0.41.1</li>
<li>sqlparse==0.4.4</li>
<li>sshtunnel==0.4.0</li>
<li>starkbank-ecdsa==2.2.0</li>
<li>statsd==4.0.1</li>
<li>sympy==1.12</li>
<li>tomlkit==0.12.4</li>
<li>tornado==6.4</li>
<li>uritemplate==4.1.1</li>
</ul>
<ul>
<li>urllib3==2.2.1</li>
</ul>
<ul>
<li>urllib3==1.26.18</li>
<li>vine==5.1.0</li>
<li>virtualenv==20.25.1</li>
<li>watchtower==3.0.1</li>
<li>wcwidth==0.2.13</li>
<li>websocket-client==1.7.0</li>
<li>xmltodict==0.13.0</li>
<li>yarl==1.9.4</li>
<li>zope-event==5.0</li>
<li>zope-interface==6.2</li>
</ul>
</blockquote>
</details>

<p>Compare it with the equivalent <code>pip</code> result:</p>
<pre><code>uv pip install 'apache-airflow[aiobotocore,amazon,async,celery,cncf-kubernetes,common-io, \
docker,elasticsearch,ftp,google,google-auth,graphviz,grpc,hashicorp,http,ldap,microsoft-azure, \
mysql,odbc,openlineage,pandas,postgres,redis,sendgrid,sftp,slack,snowflake, \
ssh,statsd,uv,virtualenv] @ https://github.com/apache/airflow/archive/main.tar.gz'
</code></pre>
<details>
   <summary>Result of `pip install`</summary>

<blockquote>
<p>Installing collected packages: wcwidth, unicodecsv, text-unidecode, statsd, starkbank-ecdsa, sortedcontainers, pytz, ply, lockfile, json-merge-patch, ijson, distlib, cron-descriptor, colorlog, azure-nspkg, azure-common, asn1crypto, zope.interface, zope.event, zipp, wrapt, websocket-client, vine, urllib3, uritemplate, uc-micro-py, tzdata, typing-extensions, tornado, tomlkit, termcolor, tenacity, tabulate, sqlparse, sqlalchemy, soupsieve, sniffio, slack_sdk, six, setproctitle, scramp, rpds-py, PyYAML, python-slugify, python-http-client, python-dotenv, pyparsing, pyodbc, pyjwt, pygments, pycparser, pyasn1, psycopg2-binary, psutil, protobuf, prompt-toolkit, prometheus-client, portalocker, pluggy, platformdirs, pkgutil-resolve-name, pathspec, packaging, ordered-set, opentelemetry-semantic-conventions, openlineage-sql, oauthlib, numpy, mysqlclient, mysql-connector-python, multidict, more-itertools, mdurl, markupsafe, lxml, lazy-object-proxy, jsonpath_ng, jmespath, itsdangerous, inflection, idna, humanize, h11, grpcio, greenlet, graphviz, google-re2, google-crc32c, fsspec, frozenlist, filelock, exceptiongroup, docutils, dnspython, dill, decorator, configupdater, colorama, click, charset-normalizer, chardet, certifi, cachetools, cachelib, blinker, billiard, bcrypt, backports.zoneinfo, backoff, Babel, azure-mgmt-nspkg, attrs, async-timeout, argcomplete, aiofiles, yarl, wtforms, werkzeug, virtualenv, universal-pathlib, sqlalchemy-utils, sqlalchemy_redshift, sqlalchemy-jsonfield, shapely, sendgrid, rsa, rfc3339-validator, requests, referencing, redis, python-dateutil, python-daemon, pyasn1-modules, pyarrow, proto-plus, prison, opentelemetry-proto, marshmallow, markdown-it-py, Mako, linkify-it-py, ldap3, jinja2, isodate, importlib-resources, importlib-metadata, httplib2, httpcore, gunicorn, grpcio-gcp, grpc-interceptor, googleapis-common-protos, google-resumable-media, gevent, eventlet, email-validator, elastic-transport, deprecated, clickclick, click-repl, click-plugins, click-didyoumean, cffi, cattrs, beautifulsoup4, azure-mgmt-datalake-nspkg, asgiref, apispec, anyio, amqp, aiosignal, aioitertools, time-machine, rich, requests_toolbelt, requests-oauthlib, python-nvd3, python-ldap, pynacl, pandas, opentelemetry-exporter-otlp-proto-common, opentelemetry-api, openlineage-python, mdit-py-plugins, marshmallow-sqlalchemy, marshmallow-oneofschema, looker-sdk, limits, kombu, jsonschema-specifications, hvac, httpx, grpcio-status, google-cloud-audit-log, google-auth, flask, elasticsearch, docker, cryptography, croniter, botocore, azure-core, alembic, aiohttp, s3transfer, rich-argparse, PyOpenSSL, pendulum, paramiko, opentelemetry-sdk, openlineage-integration-common, msrest, kubernetes_asyncio, kubernetes, jsonschema, grpc-google-iam-v1, google-auth-oauthlib, google-auth-httplib2, google-api-core, gcloud-aio-auth, flask-wtf, Flask-SQLAlchemy, flask-session, flask-login, Flask-Limiter, Flask-JWT-Extended, flask-caching, Flask-Babel, db-dtypes, celery, azure-storage-file-share, azure-storage-blob, azure-servicebus, azure-mgmt-core, azure-keyvault-secrets, azure-cosmos, authlib, asyncssh, aiobotocore, adal, sshtunnel, snowflake-connector-python, pydata-google-auth, opentelemetry-exporter-otlp-proto-http, opentelemetry-exporter-otlp-proto-grpc, msrestazure, msal, google-cloud-core, google-api-python-client, google-ads, gcloud-aio-storage, gcloud-aio-bigquery, flower, flask-appbuilder, connexion, boto3, azure-synapse-spark, azure-synapse-artifacts, azure-storage-file-datalake, azure-mgmt-storage, azure-mgmt-resource, azure-mgmt-datafactory, azure-mgmt-cosmosdb, azure-mgmt-containerregistry, azure-mgmt-containerinstance, watchtower, snowflake-sqlalchemy, redshift_connector, PyAthena, opentelemetry-exporter-otlp, msal-extensions, google-cloud-workflows, google-cloud-vision, google-cloud-videointelligence, google-cloud-translate, google-cloud-texttospeech, google-cloud-tasks, google-cloud-storage-transfer, google-cloud-storage, google-cloud-speech, google-cloud-spanner, google-cloud-secret-manager, google-cloud-run, google-cloud-resource-manager, google-cloud-redis, google-cloud-pubsub, google-cloud-os-login, google-cloud-orchestration-airflow, google-cloud-monitoring, google-cloud-memcache, google-cloud-language, google-cloud-kms, google-cloud-dlp, google-cloud-dataproc-metastore, google-cloud-dataproc, google-cloud-dataplex, google-cloud-dataform, google-cloud-dataflow-client, google-cloud-datacatalog, google-cloud-container, google-cloud-compute, google-cloud-build, google-cloud-bigtable, google-cloud-bigquery-storage, google-cloud-bigquery-datatransfer, google-cloud-bigquery, google-cloud-batch, google-cloud-automl, google-cloud-appengine-logging, google-analytics-admin, azure-mgmt-datalake-store, azure-datalake-store, azure-batch, sqlalchemy-spanner, sqlalchemy-bigquery, pandas-gbq, google-cloud-logging, google-cloud-aiplatform, gcsfs, azure-identity, azure-kusto-data, adlfs, apache-airflow-providers-smtp, apache-airflow-providers-imap, apache-airflow-providers-http, apache-airflow-providers-ftp, apache-airflow-providers-fab, apache-airflow-providers-common-sql, apache-airflow-providers-common-io, apache-airflow-providers-sqlite, apache-airflow-providers-ssh, apache-airflow-providers-snowflake, apache-airflow-providers-slack, apache-airflow-providers-sftp, apache-airflow-providers-sendgrid, apache-airflow-providers-redis, apache-airflow-providers-postgres, apache-airflow-providers-openlineage, apache-airflow-providers-odbc, apache-airflow-providers-mysql, apache-airflow-providers-microsoft-azure, apache-airflow-providers-hashicorp, apache-airflow-providers-grpc, apache-airflow-providers-google, apache-airflow-providers-elasticsearch, apache-airflow-providers-docker, apache-airflow-providers-cncf-kubernetes, apache-airflow-providers-celery, apache-airflow-providers-amazon</p>
</blockquote>
</details>

<p>Note - all the <code>apache-airflow-providers-*</code> packages missing in case of <code>uv pip install</code>.</p>
<p>The problem is likely that the installation uses directly <code>pyproject.toml</code> to install dependencies, however for such remote installation (and without <code>--editable</code> install at that - but even if it would be specified, <code>--editable</code> makes no sense for remote install) the dependencies should be the same as in packaged .whl file and it makes the installation of <code>uv</code> in this case non-compliant with PEP 517.</p>
<p>A bit more context: Airlfow uses hatchling build backend, and utilzes PEP 517 compliant build_hooks (https://peps.python.org/pep-0517/#build-wheel) to modify the <code>--editable</code>  extras into <code>wheel</code> extras on the flight. So for example <code>[celery]</code> requirement in pyproject.toml ( https://github.com/apache/airflow/blob/main/pyproject.toml#L641) is this:</p>
<pre><code>celery = [ # source: airflow/providers/celery/provider.yaml
  &quot;celery&gt;=5.3.0,&lt;6,!=5.3.3,!=5.3.2&quot;,
  &quot;flower&gt;=1.0.0&quot;,
  &quot;google-re2&gt;=1.0&quot;,
]
</code></pre>
<p>However the hatchling <a href="https://github.com/apache/airflow/blob/main/hatch_build.py">build hook of ours</a>, when preparing <code>wheel</code> package, replaces this extra with:</p>
<pre><code>&quot;apache-airflow-providers-celery&quot;
</code></pre>
<p>This is the way how we are dealing with our monorepo where <code>--editable</code> &quot;extra&quot; just installs dependencies of our providers, while the &quot;wheel&quot; extra install actual provider (and transitively dependencies of that provider).</p>
<p>I <strong>believe</strong> that PEP-517 compliant way of installing a package from remote URL should actually build the wheel file first using the build backend the project has defined in <code>pyproject.toml</code> and only then install such a wheel file (this is exactly what <code>pip</code> does under the hood when installing package from remote url - treating it the same way as installind an sdist package (which the remote URL is equivalent of).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-03-02 22:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">compatibility</span> added by @charliermarsh on 2024-03-02 22:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Installing from remote URL uses `--editable` version of dependencies in UV (comparing to PIP)" to "Installing from remote URL uses `pyproject.toml` version of dependencies in UV (comparing to PIP)" by @potiuk on 2024-03-24 22:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Installing from remote URL uses `pyproject.toml` version of dependencies in UV (comparing to PIP)" to "Installing from remote URL uses `pyproject.toml`  in UV rather than dynamic deypendencies via build hooks (comparing to PIP)" by @potiuk on 2024-03-24 22:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Installing from remote URL uses `pyproject.toml`  in UV rather than dynamic deypendencies via build hooks (comparing to PIP)" to "Installing from sources uses `pyproject.toml`  in UV rather than dynamic deypendencies via build hooks (comparing to PIP)" by @potiuk on 2024-03-24 22:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Installing from sources uses `pyproject.toml`  in UV rather than dynamic deypendencies via build hooks (comparing to PIP)" to "The "standard" installation use `pyproject.toml`  in UV rather than dynamic deypendencies via build hooks (comparing to PIP)" by @potiuk on 2024-03-24 22:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "The "standard" installation use `pyproject.toml`  in UV rather than dynamic deypendencies via build hooks (comparing to PIP)" to "The "standard" installation use `pyproject.toml` in UV rather than dynamic deypendencies via build hooks (comparing to PIP)" by @potiuk on 2024-03-24 22:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/potiuk">@potiuk</a> on 2024-03-24 22:50</div>
            <div class="timeline-body"><p>I have an update.</p>
<p>I realized that the problem could be, because we were not really PEP 621 compliant with Airflow becaused we mixed &quot;dynamic&quot; and &quot;static&quot; project properties in Airflow. The <code>pyproject.toml</code> contained  the &quot;dependencies&quot; and &quot;optional-dependencies&quot; but also build hooks modified them.</p>
<p>However as of today we fixed it in `apache-airflow'  in https://github.com/apache/airflow/pull/38439 and the problem remains.</p>
<p>Both &quot;dependencies&quot; and &quot;optional-dependencies&quot; are set as dynamic in <code>pyproject.toml</code>: https://github.com/apache/airflow/blob/main/pyproject.toml#L64 :</p>
<pre><code>dynamic = [&quot;version&quot;, &quot;optional-dependencies&quot;, &quot;dependencies&quot;]
</code></pre>
<p>It looks like <code>uv</code> - unlike <code>pip</code> does not use build hooks to determine <code>standard</code> dynamic properties as defined in <code>pyproject.toml</code> - only uses the hooks to determine <code>editable</code> dependencies</p>
<h2>PIP case</h2>
<p>With <code>pip</code> - they are both properly set dynamically by PEP 517 compliant build hooks (via hatchling) - https://github.com/apache/airflow/blob/main/hatch_build.py - you can check it by checking out the repo and running those commands (I separated out the relevant installed packages to show the difference)</p>
<ol>
<li><code>pip install &quot;apache-airflow[aws] @ file:///Users/jarek/code/airflow&quot;</code> -&gt; correctly installs &quot;wheel&quot; version of airflow with wheel <code>[aws]</code> variant of extra - including <code>apache-airflow-providers-amazon</code> - but not including devel deps like <code>moto</code>.</li>
</ol>
<details>
  <summary>Output</summary>

<blockquote>
<p>Successfully installed Babel-2.14.0 Flask-Babel-2.0.0 Flask-JWT-Extended-4.6.0 Flask-Limiter-3.5.1 Flask-SQLAlchemy-2.5.1 Mako-1.3.2 PyAthena-3.5.1 PyYAML-6.0.1 WTForms-3.1.2 aiohttp-3.9.3 aiosignal-1.3.1 alembic-1.13.1 anyio-4.3.0 apache-airflow-2.9.0.dev0</p>
</blockquote>
<blockquote>
<p><strong>apache-airflow-providers-amazon-8.19.0</strong></p>
</blockquote>
<blockquote>
<p>apache-airflow-providers-common-io-1.3.0 apache-airflow-providers-common-sql-1.11.1 apache-airflow-providers-fab-1.0.2.dev2 apache-airflow-providers-ftp-3.7.0 apache-airflow-providers-http-4.10.0 apache-airflow-providers-imap-3.5.0 apache-airflow-providers-smtp-1.6.1 apache-airflow-providers-sqlite-3.7.1 apispec-6.6.0 argcomplete-3.2.3 asgiref-3.8.1 asn1crypto-1.5.1 attrs-23.2.0 beautifulsoup4-4.12.3 blinker-1.7.0 boto3-1.34.69 botocore-1.34.69 cachelib-0.9.0 certifi-2024.2.2 cffi-1.16.0 charset-normalizer-3.3.2 click-8.1.7 clickclick-20.10.2 colorama-0.4.6 colorlog-4.8.0 configupdater-3.2 connexion-2.14.2 cron-descriptor-1.4.3 croniter-2.0.3 cryptography-42.0.5 deprecated-1.2.14 dill-0.3.8 dnspython-2.6.1 docutils-0.20.1 email-validator-2.1.1 flask-2.2.5 flask-appbuilder-4.4.1 flask-caching-2.1.0 flask-login-0.6.3 flask-session-0.5.0 flask-wtf-1.2.1 frozenlist-1.4.1 fsspec-2024.3.1 google-re2-1.1 googleapis-common-protos-1.63.0 grpcio-1.62.1 gunicorn-21.2.0 h11-0.14.0 httpcore-1.0.4 httpx-0.27.0 idna-3.6 importlib-metadata-6.11.0 importlib-resources-6.4.0 inflection-0.5.1 itsdangerous-2.1.2 jinja2-3.1.3 jmespath-1.0.1 jsonpath_ng-1.6.1 jsonschema-4.21.1 jsonschema-specifications-2023.12.1 lazy-object-proxy-1.10.0 limits-3.10.1 linkify-it-py-2.0.3 lockfile-0.12.2 lxml-5.1.0 markdown-it-py-3.0.0 markupsafe-2.1.5 marshmallow-3.21.1 marshmallow-oneofschema-3.1.1 marshmallow-sqlalchemy-0.28.2 mdit-py-plugins-0.4.0 mdurl-0.1.2 more-itertools-10.2.0 multidict-6.0.5 opentelemetry-api-1.23.0 opentelemetry-exporter-otlp-1.23.0 opentelemetry-exporter-otlp-proto-common-1.23.0 opentelemetry-exporter-otlp-proto-grpc-1.23.0 opentelemetry-exporter-otlp-proto-http-1.23.0 opentelemetry-proto-1.23.0 opentelemetry-sdk-1.23.0 opentelemetry-semantic-conventions-0.44b0 ordered-set-4.1.0 packaging-24.0 pathspec-0.12.1 pendulum-3.0.0 pluggy-1.4.0 ply-3.11 prison-0.2.1 protobuf-4.25.3 psutil-5.9.8 pycparser-2.21 pygments-2.17.2 pyjwt-2.8.0 python-daemon-3.0.1 python-dateutil-2.9.0.post0 python-nvd3-0.15.0 python-slugify-8.0.4 pytz-2024.1 redshift_connector-2.1.0 referencing-0.34.0 requests-2.31.0 requests_toolbelt-1.0.0 rfc3339-validator-0.1.4 rich-13.7.1 rich-argparse-1.4.0 rpds-py-0.18.0 s3transfer-0.10.1 scramp-1.4.4 setproctitle-1.3.3 six-1.16.0 sniffio-1.3.1 soupsieve-2.5 sqlalchemy-1.4.52 sqlalchemy-jsonfield-1.0.2 sqlalchemy-utils-0.41.2 sqlalchemy_redshift-0.8.14 sqlparse-0.4.4 tabulate-0.9.0 tenacity-8.2.3 termcolor-2.4.0 text-unidecode-1.3 time-machine-2.14.1 typing-extensions-4.10.0 tzdata-2024.1 uc-micro-py-1.0.3 unicodecsv-0.14.1 universal-pathlib-0.2.2 urllib3-2.2.1 watchtower-3.1.0 werkzeug-2.2.3 wrapt-1.16.0 yarl-1.9.4 zipp-3.18.1</p>
</blockquote>
</details>

<ol start="2">
<li><code>pip install -e &quot;/Users/jarek/code/airflow[aws]&quot;</code> -&gt; correctly install &quot;editable&quot; version of airflow with editable version of <code>[aws]</code> variant of extra - not includoing <code>apaxhe-airflow-providers-amazon</code></li>
</ol>
<details>
  <summary>Output</summary>

<blockquote>
<p>Successfully installed Mako-1.3.2 PyAthena-3.5.1 PyYAML-6.0.1 aiobotocore-2.12.1 aiohttp-3.9.3 aioitertools-0.11.0 aiosignal-1.3.1 alembic-1.13.1 annotated-types-0.6.0 anyio-4.3.0 apache-airflow-2.9.0.dev0 argcomplete-3.2.3 asgiref-3.8.1 asn1crypto-1.5.1 attrs-23.2.0 aws-sam-translator-1.86.0 aws_xray_sdk-2.13.0 beautifulsoup4-4.12.3 blinker-1.7.0 boto3-1.34.51 botocore-1.34.51 cachelib-0.9.0 certifi-2024.2.2 cffi-1.16.0 cfn-lint-0.86.1 charset-normalizer-3.3.2 click-8.1.7 clickclick-20.10.2 colorlog-4.8.0 configupdater-3.2 connexion-2.14.2 cron-descriptor-1.4.3 croniter-2.0.3 cryptography-42.0.5 deprecated-1.2.14 dill-0.3.8 docker-7.0.0 docutils-0.20.1 flask-2.2.5 flask-caching-2.1.0 flask-session-0.5.0 flask-wtf-1.2.1 frozenlist-1.4.1 fsspec-2024.3.1 google-re2-1.1 googleapis-common-protos-1.63.0 graphql-core-3.2.3 grpcio-1.62.1 gunicorn-21.2.0 h11-0.14.0 httpcore-1.0.4 httpx-0.27.0 idna-3.6 importlib-metadata-6.11.0 inflection-0.5.1 itsdangerous-2.1.2 jinja2-3.1.3 jmespath-1.0.1 joserfc-0.9.0 jschema-to-python-1.2.3 jsondiff-2.0.0 jsonpatch-1.33 jsonpath_ng-1.6.1 jsonpickle-3.0.3 jsonpointer-2.4 jsonschema-4.21.1 jsonschema-path-0.3.2 jsonschema-specifications-2023.12.1 junit-xml-1.9 lazy-object-proxy-1.10.0 linkify-it-py-2.0.3 lockfile-0.12.2 lxml-5.1.0 markdown-it-py-3.0.0 markupsafe-2.1.5 marshmallow-3.21.1 marshmallow-oneofschema-3.1.1 mdit-py-plugins-0.4.0 mdurl-0.1.2 more-itertools-10.2.0</p>
</blockquote>
<blockquote>
<p><strong>moto-5.0.3</strong></p>
</blockquote>
<blockquote>
<p>mpmath-1.3.0 multidict-6.0.5 mypy-boto3-appflow-1.34.0 mypy-boto3-rds-1.34.65 mypy-boto3-redshift-data-1.34.0 mypy-boto3-s3-1.34.65 networkx-3.2.1 openapi-schema-validator-0.6.2 openapi-spec-validator-0.7.1 opentelemetry-api-1.23.0 opentelemetry-exporter-otlp-1.23.0 opentelemetry-exporter-otlp-proto-common-1.23.0 opentelemetry-exporter-otlp-proto-grpc-1.23.0 opentelemetry-exporter-otlp-proto-http-1.23.0 opentelemetry-proto-1.23.0 opentelemetry-sdk-1.23.0 opentelemetry-semantic-conventions-0.44b0 packaging-24.0 pathable-0.4.3 pathspec-0.12.1 pbr-6.0.0 pendulum-3.0.0 pluggy-1.4.0 ply-3.11 protobuf-4.25.3 psutil-5.9.8 py-partiql-parser-0.5.1 pycparser-2.21 pydantic-2.6.4 pydantic-core-2.16.3 pygments-2.17.2 pyjwt-2.8.0 pyparsing-3.1.2 python-daemon-3.0.1 python-dateutil-2.9.0.post0 python-nvd3-0.15.0 python-slugify-8.0.4 pytz-2024.1 redshift_connector-2.1.0 referencing-0.31.1 regex-2023.12.25 requests-2.31.0 requests_toolbelt-1.0.0 responses-0.25.0 rfc3339-validator-0.1.4 rich-13.7.1 rich-argparse-1.4.0 rpds-py-0.18.0 s3fs-2024.3.1 s3transfer-0.10.1 sarif-om-1.0.4 scramp-1.4.4 setproctitle-1.3.3 six-1.16.0 sniffio-1.3.1 soupsieve-2.5 sqlalchemy-1.4.52 sqlalchemy-jsonfield-1.0.2 sqlalchemy_redshift-0.8.14 sqlparse-0.4.4 sympy-1.12 tabulate-0.9.0 tenacity-8.2.3 termcolor-2.4.0 text-unidecode-1.3 time-machine-2.14.1 typing-extensions-4.10.0 tzdata-2024.1 uc-micro-py-1.0.3 unicodecsv-0.14.1 universal-pathlib-0.2.2 urllib3-2.0.7 watchtower-3.1.0 werkzeug-2.2.3 wrapt-1.16.0 wtforms-3.1.2 xmltodict-0.13.0 yarl-1.9.4 zipp-3.18.1</p>
</details>

</blockquote>
<ol start="3">
<li>Similarly - remote installtion via URL uses &quot;wheel&quot; dependency versions: <code>pip install &quot;apache-airflow[aws] @ https://github.com/apache/airflow/archive/main.tar.gz&quot;</code>:</li>
</ol>
<details>
  <summary>Ouput</summary>

<blockquote>
<p>Successfully installed Babel-2.14.0 Flask-Babel-2.0.0 Flask-JWT-Extended-4.6.0 Flask-Limiter-3.5.1 Flask-SQLAlchemy-2.5.1 Mako-1.3.2 PyAthena-3.5.1 PyYAML-6.0.1 WTForms-3.1.2 aiohttp-3.9.3 aiosignal-1.3.1 alembic-1.13.1 anyio-4.3.0</p>
</blockquote>
<blockquote>
<p><strong>apache-airflow-providers-amazon-8.19.0</strong></p>
</blockquote>
<blockquote>
<p>apache-airflow-providers-common-io-1.3.0 apache-airflow-providers-common-sql-1.11.1 apache-airflow-providers-fab-1.0.2.dev2 apache-airflow-providers-ftp-3.7.0 apache-airflow-providers-http-4.10.0 apache-airflow-providers-imap-3.5.0 apache-airflow-providers-smtp-1.6.1 apache-airflow-providers-sqlite-3.7.1 apispec-6.6.0 argcomplete-3.2.3 asgiref-3.8.1 asn1crypto-1.5.1 attrs-23.2.0 beautifulsoup4-4.12.3 blinker-1.7.0 boto3-1.34.69 botocore-1.34.69 cachelib-0.9.0 certifi-2024.2.2 cffi-1.16.0 charset-normalizer-3.3.2 click-8.1.7 clickclick-20.10.2 colorama-0.4.6 colorlog-4.8.0 configupdater-3.2 connexion-2.14.2 cron-descriptor-1.4.3 croniter-2.0.3 cryptography-42.0.5 deprecated-1.2.14 dill-0.3.8 dnspython-2.6.1 docutils-0.20.1 email-validator-2.1.1 flask-2.2.5 flask-appbuilder-4.4.1 flask-caching-2.1.0 flask-login-0.6.3 flask-session-0.5.0 flask-wtf-1.2.1 frozenlist-1.4.1 fsspec-2024.3.1 google-re2-1.1 googleapis-common-protos-1.63.0 grpcio-1.62.1 gunicorn-21.2.0 h11-0.14.0 httpcore-1.0.4 httpx-0.27.0 idna-3.6 importlib-metadata-6.11.0 importlib-resources-6.4.0 inflection-0.5.1 itsdangerous-2.1.2 jinja2-3.1.3 jmespath-1.0.1 jsonpath_ng-1.6.1 jsonschema-4.21.1 jsonschema-specifications-2023.12.1 lazy-object-proxy-1.10.0 limits-3.10.1 linkify-it-py-2.0.3 lockfile-0.12.2 lxml-5.1.0 markdown-it-py-3.0.0 markupsafe-2.1.5 marshmallow-3.21.1 marshmallow-oneofschema-3.1.1 marshmallow-sqlalchemy-0.28.2 mdit-py-plugins-0.4.0 mdurl-0.1.2 more-itertools-10.2.0 multidict-6.0.5 opentelemetry-api-1.23.0 opentelemetry-exporter-otlp-1.23.0 opentelemetry-exporter-otlp-proto-common-1.23.0 opentelemetry-exporter-otlp-proto-grpc-1.23.0 opentelemetry-exporter-otlp-proto-http-1.23.0 opentelemetry-proto-1.23.0 opentelemetry-sdk-1.23.0 opentelemetry-semantic-conventions-0.44b0 ordered-set-4.1.0 packaging-24.0 pathspec-0.12.1 pendulum-3.0.0 pluggy-1.4.0 ply-3.11 prison-0.2.1 protobuf-4.25.3 psutil-5.9.8 pycparser-2.21 pygments-2.17.2 pyjwt-2.8.0 python-daemon-3.0.1 python-dateutil-2.9.0.post0 python-nvd3-0.15.0 python-slugify-8.0.4 pytz-2024.1 redshift_connector-2.1.0 referencing-0.34.0 requests-2.31.0 requests_toolbelt-1.0.0 rfc3339-validator-0.1.4 rich-13.7.1 rich-argparse-1.4.0 rpds-py-0.18.0 s3transfer-0.10.1 scramp-1.4.4 setproctitle-1.3.3 six-1.16.0 sniffio-1.3.1 soupsieve-2.5 sqlalchemy-1.4.52 sqlalchemy-jsonfield-1.0.2 sqlalchemy-utils-0.41.2 sqlalchemy_redshift-0.8.14 sqlparse-0.4.4 tabulate-0.9.0 tenacity-8.2.3 termcolor-2.4.0 text-unidecode-1.3 time-machine-2.14.1 typing-extensions-4.10.0 tzdata-2024.1 uc-micro-py-1.0.3 unicodecsv-0.14.1 universal-pathlib-0.2.2 urllib3-2.2.1 watchtower-3.1.0 werkzeug-2.2.3 wrapt-1.16.0 yarl-1.9.4 zipp-3.18.1</p>
</blockquote>
</details>

<h2>UV case</h2>
<p>The same exercise with <code>uv</code> produced very different (incorrect) results:</p>
<p>I run it with the latest as of today <code>uv</code> version:  0.1.24.</p>
<ol>
<li><code>uv pip install &quot;apache-airflow[aws] @ file:///Users/jarek/code/airflow&quot;</code></li>
</ol>
<p>This wrongly installs just airflow package and misses both - dynamic &quot;dependenciess&quot; and dynamic &quot;optional-dependencies&quot; that should be derived from running the build hook.</p>
<details>
  <summary>Output</summary>

<blockquote>
<p>Resolved 1 package in 0.42ms
Built apache-airflow @ file:///Users/jarek/code/airflow                                                                                                                                                                                                                                          &gt; Downloaded 1 package in 5.89s
Installed 1 package in 10ms</p>
<ul>
<li>apache-airflow==2.9.0.dev0 (from file:///Users/jarek/code/airflow)</li>
</ul>
</blockquote>
</details>

<ol start="2">
<li><code>uv pip install -e &quot;/Users/jarek/code/airflow[aws]&quot;</code></li>
</ol>
<p>This correctly installs dynamically derived both &quot;dependencies&quot; and &quot;optional-dependencies&quot;. See  (expected) lack of &quot;apache-airflow-providers-amazon&quot; and presence of &quot;moto&quot; - both indicate that <code>aws</code> extra was correctly calculated with the build hook.</p>
<details>
  <summary>Output</summary>

<blockquote>
<p>uv pip install -e &quot;/Users/jarek/code/airflow[aws]&quot;
Built file:///Users/jarek/code/airflow                                                                                                                                                                                                                                                           &gt; Built 1 editable in 4.90s
Resolved 161 packages in 6.94s
Built python-nvd3==0.15.0
Built lazy-object-proxy==1.10.0
Built unicodecsv==0.14.1                                                                                                                                                                                                                                                                         &gt; Downloaded 156 packages in 14.87s
Installed 160 packages in 219ms</p>
<ul>
<li>aiobotocore==2.12.1</li>
<li>aiohttp==3.9.3</li>
<li>aioitertools==0.11.0</li>
<li>aiosignal==1.3.1</li>
<li>alembic==1.13.1</li>
<li>annotated-types==0.6.0</li>
<li>anyio==4.3.0</li>
<li>apache-airflow==2.9.0.dev0 (from file:///Users/jarek/code/airflow)</li>
<li>argcomplete==3.2.3</li>
<li>asgiref==3.8.1</li>
<li>asn1crypto==1.5.1</li>
<li>attrs==23.2.0</li>
<li>aws-sam-translator==1.86.0</li>
<li>aws-xray-sdk==2.13.0</li>
<li>beautifulsoup4==4.12.3</li>
<li>blinker==1.7.0</li>
<li>boto3==1.34.51</li>
<li>botocore==1.34.51</li>
<li>cachelib==0.9.0</li>
<li>certifi==2024.2.2</li>
<li>cffi==1.16.0</li>
<li>cfn-lint==0.86.1</li>
<li>charset-normalizer==3.3.2</li>
<li>click==8.1.7</li>
<li>clickclick==20.10.2</li>
<li>colorlog==4.8.0</li>
<li>configupdater==3.2</li>
<li>connexion==2.14.2</li>
<li>cron-descriptor==1.4.3</li>
<li>croniter==2.0.3</li>
<li>cryptography==42.0.5</li>
<li>deprecated==1.2.14</li>
<li>dill==0.3.8</li>
<li>docker==7.0.0</li>
<li>docutils==0.20.1</li>
<li>flask==2.2.5</li>
<li>flask-caching==2.1.0</li>
<li>flask-session==0.5.0</li>
<li>flask-wtf==1.2.1</li>
<li>frozenlist==1.4.1</li>
<li>fsspec==2024.3.1</li>
<li>google-re2==1.1</li>
<li>googleapis-common-protos==1.63.0</li>
<li>graphql-core==3.2.3</li>
<li>grpcio==1.62.1</li>
<li>gunicorn==21.2.0</li>
<li>h11==0.14.0</li>
<li>httpcore==1.0.4</li>
<li>httpx==0.27.0</li>
<li>idna==3.6</li>
<li>importlib-metadata==6.11.0</li>
<li>inflection==0.5.1</li>
<li>itsdangerous==2.1.2</li>
<li>jinja2==3.1.3</li>
<li>jmespath==1.0.1</li>
<li>joserfc==0.9.0</li>
<li>jschema-to-python==1.2.3</li>
<li>jsondiff==2.0.0</li>
<li>jsonpatch==1.33</li>
<li>jsonpath-ng==1.6.1</li>
<li>jsonpickle==3.0.3</li>
<li>jsonpointer==2.4
v + jsonschema==4.21.1</li>
<li>jsonschema-path==0.3.2</li>
<li>jsonschema-specifications==2023.12.1</li>
<li>junit-xml==1.9</li>
<li>lazy-object-proxy==1.10.0</li>
<li>linkify-it-py==2.0.3</li>
<li>lockfile==0.12.2</li>
<li>lxml==5.1.0</li>
<li>mako==1.3.2</li>
<li>markdown-it-py==3.0.0</li>
<li>markupsafe==2.1.5</li>
<li>marshmallow==3.21.1</li>
<li>marshmallow-oneofschema==3.1.1</li>
<li>mdit-py-plugins==0.4.0</li>
<li>mdurl==0.1.2</li>
<li>more-itertools==10.2.0</li>
</ul>
</blockquote>
<blockquote>
<p><strong>+ moto==5.0.3</strong></p>
</blockquote>
<blockquote>
<ul>
<li>mpmath==1.3.0</li>
<li>multidict==6.0.5</li>
<li>mypy-boto3-appflow==1.34.0</li>
<li>mypy-boto3-rds==1.34.65</li>
<li>mypy-boto3-redshift-data==1.34.0</li>
<li>mypy-boto3-s3==1.34.65</li>
<li>networkx==3.2.1</li>
<li>openapi-schema-validator==0.6.2</li>
<li>openapi-spec-validator==0.7.1</li>
<li>opentelemetry-api==1.23.0</li>
<li>opentelemetry-exporter-otlp==1.23.0</li>
<li>opentelemetry-exporter-otlp-proto-common==1.23.0</li>
<li>opentelemetry-exporter-otlp-proto-grpc==1.23.0</li>
<li>opentelemetry-exporter-otlp-proto-http==1.23.0</li>
<li>opentelemetry-proto==1.23.0</li>
<li>opentelemetry-sdk==1.23.0</li>
<li>opentelemetry-semantic-conventions==0.44b0</li>
<li>packaging==24.0</li>
<li>pathable==0.4.3</li>
<li>pathspec==0.12.1</li>
<li>pbr==6.0.0</li>
<li>pendulum==3.0.0</li>
<li>pluggy==1.4.0</li>
<li>ply==3.11</li>
<li>protobuf==4.25.3</li>
<li>psutil==5.9.8</li>
<li>py-partiql-parser==0.5.1</li>
<li>pyathena==3.5.1</li>
<li>pycparser==2.21</li>
<li>pydantic==2.6.4</li>
<li>pydantic-core==2.16.3</li>
<li>pygments==2.17.2</li>
<li>pyjwt==2.8.0</li>
<li>pyparsing==3.1.2</li>
<li>python-daemon==3.0.1</li>
<li>python-dateutil==2.9.0.post0</li>
<li>python-nvd3==0.15.0</li>
<li>python-slugify==8.0.4</li>
<li>pytz==2024.1</li>
<li>pyyaml==6.0.1</li>
<li>redshift-connector==2.1.0</li>
<li>referencing==0.31.1</li>
<li>regex==2023.12.25</li>
<li>requests==2.31.0</li>
<li>requests-toolbelt==1.0.0</li>
<li>responses==0.25.0</li>
<li>rfc3339-validator==0.1.4</li>
<li>rich==13.7.1</li>
<li>rich-argparse==1.4.0</li>
<li>rpds-py==0.18.0</li>
<li>s3fs==2024.3.1</li>
<li>s3transfer==0.10.1</li>
<li>sarif-om==1.0.4</li>
<li>scramp==1.4.4</li>
<li>setproctitle==1.3.3</li>
<li>six==1.16.0</li>
<li>sniffio==1.3.1</li>
<li>soupsieve==2.5</li>
<li>sqlalchemy==1.4.52</li>
<li>sqlalchemy-jsonfield==1.0.2</li>
<li>sqlalchemy-redshift==0.8.14</li>
<li>sqlparse==0.4.4</li>
<li>sympy==1.12</li>
<li>tabulate==0.9.0</li>
<li>tenacity==8.2.3</li>
<li>termcolor==2.4.0</li>
<li>text-unidecode==1.3</li>
<li>time-machine==2.14.1</li>
<li>typing-extensions==4.10.0</li>
<li>tzdata==2024.1</li>
<li>uc-micro-py==1.0.3</li>
<li>unicodecsv==0.14.1</li>
<li>universal-pathlib==0.2.2</li>
<li>urllib3==2.0.7</li>
<li>watchtower==3.1.0</li>
<li>werkzeug==2.2.3</li>
<li>wrapt==1.16.0</li>
<li>wtforms==3.1.2</li>
<li>xmltodict==0.13.0</li>
<li>yarl==1.9.4</li>
<li>zipp==3.18.1</li>
</ul>
</blockquote>
</details>

<ol start="3">
<li>Finally installing from URL: <code>uv pip install &quot;apache-airflow[aws] @ https://github.com/apache/airflow/archive/main.tar.gz&quot;</code></li>
</ol>
<details>
  <summary>Output</summary>

<blockquote>
<p>Resolved 1 package in 589ms
Built apache-airflow @ https://github.com/apache/airflow/archive/main.tar.gz                                                                                                                                                                                                                     &gt; Downloaded 1 package in 1.06s
Installed 1 package in 9ms</p>
<ul>
<li>apache-airflow==2.9.0.dev0 (from file:///Users/jarek/code/airflow)</li>
</ul>
<ul>
<li>apache-airflow==2.9.0.dev0 (from https://github.com/apache/airflow/archive/main.tar.gz)</li>
</ul>
</blockquote>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-03-24 23:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-24 23:56</div>
            <div class="timeline-body"><p>There's something happening here but I don't quite understand what yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-25 00:00</div>
            <div class="timeline-body"><p>(We do run the PEP 517 build hooks in all cases here.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/potiuk">@potiuk</a> on 2024-03-25 00:05</div>
            <div class="timeline-body"><p>Just to add maybe a hypothesis/lead:</p>
<p>It could be that this is somehow interacting with the way how the &quot;hatch_build.py&quot; interacts with hatchling backeng build. I had a bit hard time to guess how to properly update both dependencies and optional-dependencies in the hook. And I settled with this way (which works as I described above + it nicely generates the .whl packages):</p>
<p>So what i settled with:</p>
<ul>
<li><p>Updating &quot;dependencies&quot; is as easy as setting &quot;dependencies&quot; tnery in the &quot;build_data&quot; dict passed to the initialize  https://github.com/apache/airflow/blob/20cb9f1770c819f31e48748fc9fb86527f739d6e/hatch_build.py#L748</p>
</li>
<li><p>modifying protected `_optional_dependencies&quot;  dictionary  in the hook, as I could not find a better way (documentation is a bit sparse and looking at the source code did not help me to understand how else I can do it).
https://github.com/apache/airflow/blob/20cb9f1770c819f31e48748fc9fb86527f739d6e/hatch_build.py#L754</p>
</li>
</ul>
<p>While the &quot;optional-dependencies&quot; might be somewhat hacky, the &quot;dependencies&quot; seem to be perfectly justified way. And they also nicely work for &quot;editable&quot; case.</p>
<p>Hypothesis - maybe the version is not set to &quot;standard&quot; when you run the hook ?  That could cause the behaviour observd.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-25 00:08</div>
            <div class="timeline-body"><p>So, this only installs airflow:</p>
<pre><code>rm -rf foo &amp;&amp; cargo run venv &amp;&amp; cargo run pip install &quot;apache-airflow[aws] @ https://github.com/apache/airflow/archive/main.tar.gz&quot; --pre --cache-dir foo
</code></pre>
<p>But if I run again without clearing the cache...</p>
<pre><code>cargo run venv &amp;&amp; cargo run pip install &quot;apache-airflow[aws] @ https://github.com/apache/airflow/archive/main.tar.gz&quot; --cache-dir foo --pre
</code></pre>
<p>Then I get all 150 dependencies.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/potiuk">@potiuk</a> on 2024-03-25 00:11</div>
            <div class="timeline-body"><p>Yes. the build hook is run properly. Just run it with a little exception just before existing <code>inistialization</code> to debug</p>
<p>in <code>hatch_build.py</code>:</p>
<pre><code class="language-python">        # with hatchling, we can modify dependencies dynamically by modifying the build_data
        build_data[&quot;dependencies&quot;] = self._dependencies
        raise Exception(build_data) &lt;-- added this
</code></pre>
<p>and it seems all good - at least for the  clean run of:</p>
<pre><code>uv pip install &quot;apache-airflow[aws] @ file:///Users/jarek/code/airflow&quot;
</code></pre>
<p>result:</p>
<pre><code>[jarek:~/code/airflow] [test-3.11] main(+1/-0)+ 2 Â± uv pip install &quot;apache-airflow[aws] @ file:///Users/jarek/code/airflow&quot;
Resolved 1 package in 0.48ms
error: Failed to download distributions
  Caused by: Failed to fetch wheel: apache-airflow @ file:///Users/jarek/code/airflow
  Caused by: Failed to build: apache-airflow @ file:///Users/jarek/code/airflow
  Caused by: Build backend failed to build wheel through `build_wheel()` with exit status: 1
--- stdout:

--- stderr:
Traceback (most recent call last):
  File &quot;&lt;string&gt;&quot;, line 11, in &lt;module&gt;
  File &quot;/Users/jarek/Library/Caches/uv/.tmpaYi2WU/.venv/lib/python3.11/site-packages/hatchling/build.py&quot;, line 58, in build_wheel
    return os.path.basename(next(builder.build(directory=wheel_directory, versions=['standard'])))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/Users/jarek/Library/Caches/uv/.tmpaYi2WU/.venv/lib/python3.11/site-packages/hatchling/builders/plugin/interface.py&quot;, line 147, in build
    build_hook.initialize(version, build_data)
  File &quot;/Users/jarek/IdeaProjects/airflow/hatch_build.py&quot;, line 750, in initialize
    raise Exception(build_data)
Exception: {'infer_tag': False, 'pure_python': True, 'dependencies': ['alembic&gt;=1.13.1, &lt;2.0', 'argcomplete&gt;=1.10', 'asgiref', 'attrs&gt;=22.1.0', 'blinker&gt;=1.6.2', 'colorlog&gt;=4.0.2, &lt;5.0', 'configupdater&gt;=3.1.1', 'connexion[flask]&gt;=2.10.0,&lt;3.0', 'cron-descriptor&gt;=1.2.24', 'croniter&gt;=2.0.2', 'cryptography&gt;=39.0.0', 'deprecated&gt;=1.2.13', 'dill&gt;=0.2.2', 'flask-caching&gt;=1.5.0', 'flask-session&gt;=0.4.0,&lt;0.6', 'flask-wtf&gt;=0.15', 'flask&gt;=2.2,&lt;2.3', 'fsspec&gt;=2023.10.0', 'google-re2&gt;=1.0', 'gunicorn&gt;=20.1.0', 'httpx', 'importlib_metadata&gt;=1.7;python_version&lt;&quot;3.9&quot;', 'importlib_resources&gt;=5.2,!=6.2.0,!=6.3.0,!=6.3.1;python_version&lt;&quot;3.9&quot;', 'itsdangerous&gt;=2.0', 'jinja2&gt;=3.0.0', 'jsonschema&gt;=4.18.0', 'lazy-object-proxy', 'linkify-it-py&gt;=2.0.0', 'lockfile&gt;=0.12.2', 'markdown-it-py&gt;=2.1.0', 'markupsafe&gt;=1.1.1', 'marshmallow-oneofschema&gt;=2.0.1', 'mdit-py-plugins&gt;=0.3.0', 'opentelemetry-api&gt;=1.15.0', 'opentelemetry-exporter-otlp', 'packaging&gt;=14.0', 'pathspec&gt;=0.9.0', 'pendulum&gt;=2.1.2,&lt;4.0', 'pluggy&gt;=1.0', 'psutil&gt;=4.2.0', 'pygments&gt;=2.0.1', 'pyjwt&gt;=2.0.0', 'python-daemon&gt;=3.0.0', 'python-dateutil&gt;=2.3', 'python-nvd3&gt;=0.15.0', 'python-slugify&gt;=5.0', 'requests&gt;=2.27.0,&lt;3', 'rfc3339-validator&gt;=0.1.4', 'rich-argparse&gt;=1.0.0', 'rich&gt;=12.4.4', 'setproctitle&gt;=1.1.8', 'sqlalchemy&gt;=1.4.36,&lt;2.0', 'sqlalchemy-jsonfield&gt;=1.0', 'tabulate&gt;=0.7.5', 'tenacity&gt;=6.2.0,!=8.2.0', 'termcolor&gt;=1.1.0', 'unicodecsv&gt;=0.14.1', 'universal-pathlib&gt;=0.2.2', 'werkzeug&gt;=2.0,&lt;3', 'apache-airflow-providers-common-io', 'apache-airflow-providers-common-sql', 'apache-airflow-providers-fab&gt;=1.0.2dev0', 'apache-airflow-providers-ftp', 'apache-airflow-providers-http', 'apache-airflow-providers-imap', 'apache-airflow-providers-smtp', 'apache-airflow-providers-sqlite'], 'force_include_editable': {}, 'extra_metadata': {}, 'artifacts': [], 'force_include': {}, 'build_hooks': ('custom',)}

</code></pre>
<p>Still, when I remove the exception:</p>
<pre><code>Resolved 1 package in 0.45ms
   Built apache-airflow @ file:///Users/jarek/code/airflow                                                                                                                                                                                                                                          Downloaded 1 package in 5.84s
Installed 1 package in 10ms
 + apache-airflow==2.9.0.dev0 (from file:///Users/jarek/code/airflow)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-25 00:13</div>
            <div class="timeline-body"><p>Hmm, it seems related to our use of <code>prepare_metadata_for_build_wheel</code>. The metadata returned by that hook isn't including any requirements.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/potiuk">@potiuk</a> on 2024-03-25 00:16</div>
            <div class="timeline-body"><p>Maybe I should set it differently in <code>hatchling</code>, but:</p>
<p>a) no idea how and at least &quot;dependencies&quot; seem to be the right way of doing it
b) <code>pip</code> works correctly with both <code>dependencies</code> and <code>optional-dependencies</code>
c) it seems to work fine with <code>--editable</code> build even in <code>uv</code></p>
<p>So it looks like something on the <code>uv</code> side :( ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/potiuk">@potiuk</a> on 2024-03-25 00:19</div>
            <div class="timeline-body"><p>Editable with exception:</p>
<pre><code>uv pip install -e &quot;/Users/jarek/code/airflow[aws]&quot;
error: Failed to build editables
  Caused by: Failed to build editable: file:///Users/jarek/code/airflow
  Caused by: Build backend failed to build wheel through `build_editable()` with exit status: 1
--- stdout:

--- stderr:
Traceback (most recent call last):
  File &quot;&lt;string&gt;&quot;, line 11, in &lt;module&gt;
  File &quot;/Users/jarek/Library/Caches/uv/.tmpFU2vBA/.venv/lib/python3.11/site-packages/hatchling/build.py&quot;, line 83, in build_editable
    return os.path.basename(next(builder.build(directory=wheel_directory, versions=['editable'])))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/Users/jarek/Library/Caches/uv/.tmpFU2vBA/.venv/lib/python3.11/site-packages/hatchling/builders/plugin/interface.py&quot;, line 147, in build
    build_hook.initialize(version, build_data)
  File &quot;/Users/jarek/IdeaProjects/airflow/hatch_build.py&quot;, line 750, in initialize
    raise Exception(build_data)
Exception: {'infer_tag': False, 'pure_python': True, 'dependencies': ['alembic&gt;=1.13.1, &lt;2.0', 'argcomplete&gt;=1.10', 'asgiref', 'attrs&gt;=22.1.0', 'blinker&gt;=1.6.2', 'colorlog&gt;=4.0.2, &lt;5.0', 'configupdater&gt;=3.1.1', 'connexion[flask]&gt;=2.10.0,&lt;3.0', 'cron-descriptor&gt;=1.2.24', 'croniter&gt;=2.0.2', 'cryptography&gt;=39.0.0', 'deprecated&gt;=1.2.13', 'dill&gt;=0.2.2', 'flask-caching&gt;=1.5.0', 'flask-session&gt;=0.4.0,&lt;0.6', 'flask-wtf&gt;=0.15', 'flask&gt;=2.2,&lt;2.3', 'fsspec&gt;=2023.10.0', 'google-re2&gt;=1.0', 'gunicorn&gt;=20.1.0', 'httpx', 'importlib_metadata&gt;=1.7;python_version&lt;&quot;3.9&quot;', 'importlib_resources&gt;=5.2,!=6.2.0,!=6.3.0,!=6.3.1;python_version&lt;&quot;3.9&quot;', 'itsdangerous&gt;=2.0', 'jinja2&gt;=3.0.0', 'jsonschema&gt;=4.18.0', 'lazy-object-proxy', 'linkify-it-py&gt;=2.0.0', 'lockfile&gt;=0.12.2', 'markdown-it-py&gt;=2.1.0', 'markupsafe&gt;=1.1.1', 'marshmallow-oneofschema&gt;=2.0.1', 'mdit-py-plugins&gt;=0.3.0', 'opentelemetry-api&gt;=1.15.0', 'opentelemetry-exporter-otlp', 'packaging&gt;=14.0', 'pathspec&gt;=0.9.0', 'pendulum&gt;=2.1.2,&lt;4.0', 'pluggy&gt;=1.0', 'psutil&gt;=4.2.0', 'pygments&gt;=2.0.1', 'pyjwt&gt;=2.0.0', 'python-daemon&gt;=3.0.0', 'python-dateutil&gt;=2.3', 'python-nvd3&gt;=0.15.0', 'python-slugify&gt;=5.0', 'requests&gt;=2.27.0,&lt;3', 'rfc3339-validator&gt;=0.1.4', 'rich-argparse&gt;=1.0.0', 'rich&gt;=12.4.4', 'setproctitle&gt;=1.1.8', 'sqlalchemy&gt;=1.4.36,&lt;2.0', 'sqlalchemy-jsonfield&gt;=1.0', 'tabulate&gt;=0.7.5', 'tenacity&gt;=6.2.0,!=8.2.0', 'termcolor&gt;=1.1.0', 'unicodecsv&gt;=0.14.1', 'universal-pathlib&gt;=0.2.2', 'werkzeug&gt;=2.0,&lt;3'], 'force_include_editable': {}, 'extra_metadata': {}, 'artifacts': [], 'force_include': {}, 'build_hooks': ('custom',)}
</code></pre>
<p>After removing the exception:</p>
<pre><code>[jarek:~/code/airflow] [test-3.11] main(+1/-1)+ 2 Â± uv pip install -e &quot;/Users/jarek/code/airflow[aws]&quot;
   Built file:///Users/jarek/code/airflow                                                                                                                                                                                                                                                           Built 1 editable in 4.63s
Resolved 161 packages in 5.82s
   Built python-nvd3==0.15.0
   Built lazy-object-proxy==1.10.0
   Built unicodecsv==0.14.1                                                                                                                                                                                                                                                                         Downloaded 151 packages in 1.82s
Installed 154 packages in 254ms
 + aiobotocore==2.12.1
 + aiohttp==3.9.3
 + aioitertools==0.11.0
 + aiosignal==1.3.1
 + alembic==1.13.1
 + annotated-types==0.6.0
 + anyio==4.3.0
 + apache-airflow==2.9.0.dev0 (from file:///Users/jarek/code/airflow)
 + argcomplete==3.2.3
 + asgiref==3.8.1
 + asn1crypto==1.5.1
 + attrs==23.2.0
 + aws-sam-translator==1.86.0
.....  and son ....
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-25 00:20</div>
            <div class="timeline-body"><p>Perhaps we can ask Ofek if he has any ideas why the generated metadata is different here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/potiuk">@potiuk</a> on 2024-03-25 00:21</div>
            <div class="timeline-body"><p>cc: @ofek ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "The "standard" installation use `pyproject.toml` in UV rather than dynamic deypendencies via build hooks (comparing to PIP)" to "The "standard" installation use `pyproject.toml` in UV rather than dynamic dependencies via build hooks (comparing to PIP)" by @potiuk on 2024-03-25 00:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-25 00:34</div>
            <div class="timeline-body"><p>(I <em>think</em> the reason it works the second invocation that the wheel is built, and we read the metadata from the wheel if it's available. But in the first invocation, during resolution, we do <code>prepare_metadata_for_build_wheel</code>, since the wheel isn't available yet.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/potiuk">@potiuk</a> on 2024-03-25 00:41</div>
            <div class="timeline-body"><blockquote>
<p>(I think the reason it works the second invocation that the wheel is built, and we read the metadata from the wheel if it's available. But in the first invocation, during resolution, we do prepare_metadata_for_build_wheel, since the wheel isn't available yet.)</p>
</blockquote>
<p>I believe this is what <code>pip</code> is always doing - preparing the  wheel first and only then installing it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/potiuk">@potiuk</a> on 2024-03-25 00:45</div>
            <div class="timeline-body"><p>And that might also explain why editable works - because you are doing it in PEP-660 compatible way (which also builds an &quot;editable&quot; wheel as an intermediary medium of metadaa)  ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-25 00:49</div>
            <div class="timeline-body"><p>I'm pretty sure that the metadata returned by <code>prepare_metadata_for_build_wheel</code> should be the same as that returned by building the wheel though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/potiuk">@potiuk</a> on 2024-03-25 01:02</div>
            <div class="timeline-body"><p>Hmmm. Then we need @ofek to chime-in :).</p>
<p>BTW. Just to add the sense of <code>priority</code> - it's not <strong>super</strong> important to handle quickly.</p>
<p>I workarounded it in our CI image building proces. so I donwload and unpack the <code>https://github.com/apache/airflow/archive/main.tar.gz</code> for our own caching, unpack it and instal it in <code>--editable</code> mode, which is actually even better for our process, because this way we could remove the <code>devel-ci</code> extra from wheel (so it is likely going to stay like that). but it would be nice to solve it for &quot;prime-time&quot; of <code>uv</code> for our users who might want to also install airflow via the GitHub URL in some cases.</p>
<p>It works for <code>pip</code> and <code>pip</code> is for now our recommended user-installation build frontent, so this does not impact us much</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2024-03-25 01:19</div>
            <div class="timeline-body"><p>Does it work if you explicitly gate by the value of this e.g. <code>wheel</code>? https://hatch.pypa.io/latest/plugins/build-hook/reference/#hatchling.builders.hooks.plugin.interface.BuildHookInterface.target_name</p>
<p>Both built-in targets <code>wheel</code> and <code>sdist</code> have a version named <code>standard</code> just like your custom build target:</p>
<ul>
<li>https://hatch.pypa.io/latest/plugins/builder/wheel/#versions</li>
<li>https://hatch.pypa.io/latest/plugins/builder/sdist/#versions</li>
</ul>
<p>I'm just getting up to speed on the issue and don't immediately see what's happening.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2024-03-25 01:32</div>
            <div class="timeline-body"><p>Oh, nevermind I see the issue I think: https://github.com/pypa/hatch/blob/hatchling-v1.22.4/backend/src/hatchling/build.py#L86-L99</p>
<p>Charlie, let me know how you would like me to fix. I think I have to account for your code base now as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/potiuk">@potiuk</a> on 2024-03-25 01:32</div>
            <div class="timeline-body"><blockquote>
<p>I'm just getting up to speed on the issue and don't immediately see what's happening.</p>
</blockquote>
<p>In short:</p>
<ul>
<li><p>airflow has rather complex build_hooks writen via hatchling's <code>hatch_build.py</code> https://github.com/apache/airflow/blob/main/hatch_build.py</p>
</li>
<li><p>I just merged PR yesterday (https://github.com/apache/airflow/pull/38437)  to fix it for a bit of abuse of <code>PEP 517</code> (partially based on your discussions in https://github.com/pypa/hatch/issues/1331 and comment from pfmoore about  non-standard compliant mixing of dynamic properties  with static data in <code>pyproject.toml</code>. I turned both <code>dependencies</code> and <code>optional-dependencies</code> into a truly dynamic property in this PR and in the hook I am updating them after calculating them (though I must admit <code>optional-dependencies</code> are updated in rather hacky way as I have not found a better way via the hatchling hook (see those few lines in https://github.com/apache/airflow/blob/main/hatch_build.py#L748)</p>
</li>
<li><p><strong>the problem</strong> - it seems all work perfectly fine in <code>pip</code> for both installing an &quot;editable&quot; install and also a <code>standard</code> install from airflow sources (either via &quot;file:///&quot; or  &quot;http:&quot; - with all the bells-and-whistles (i.e. extras are resolving as I wanted them to resolve). But the &quot;standard&quot; builds don't work with <code>uv</code>.</p>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/potiuk">@potiuk</a> on 2024-03-25 01:34</div>
            <div class="timeline-body"><blockquote>
<p>Oh, nevermind I see the issue I think: https://github.com/pypa/hatch/blob/hatchling-v1.22.4/backend/src/hatchling/build.py#L86-L99</p>
</blockquote>
<blockquote>
<p>Charlie, let me know how you would like me to fix. I think I have to account for your code base now as well.</p>
</blockquote>
<p>AAARGH...</p>
<p>If <code>pip</code> then.... ð¤¯</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/potiuk">@potiuk</a> on 2024-03-25 01:36</div>
            <div class="timeline-body"><p>BTW. @ofek -&gt; since I got your attention... Is there a better way to dynamically set <code>optional-dependencies</code> than what I (hackishly) figured out ?</p>
<pre><code class="language-python">        # unfortunately hatchling currently does not have a way to override optional_dependencies
        # via build_data (or so it seem) so we need to modify internal _optional_dependencies
        # field in core.metadata until this is possible
        self.metadata.core._optional_dependencies = self.optional_dependencies
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/potiuk">@potiuk</a> on 2024-03-25 01:38</div>
            <div class="timeline-body"><blockquote>
<p>I think I have to account for your code base now as well.</p>
</blockquote>
<p>BTW. Shouldn't it work for any PEP-compliant frontend (just sayin :D ) ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2024-03-25 01:39</div>
            <div class="timeline-body"><p>I know that seems hacky but I swear that was only the way to satisfy everyone ð I honestly thought a lot about that fix.</p>
<blockquote>
<p>Is there a better way to dynamically set optional-dependencies than what I (hackishly) figured out ?</p>
</blockquote>
<p>Yes there is a metadata hook https://hatch.pypa.io/latest/plugins/metadata-hook/custom/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-25 01:44</div>
            <div class="timeline-body"><p>Ah ok, so am I correct that Hatchling detects if pip is calling it, and disables the <code>prepare_metadata_for_build_wheel</code> hooks in that case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2024-03-25 01:50</div>
            <div class="timeline-body"><p>Yes, for precisely this issue!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/potiuk">@potiuk</a> on 2024-03-25 01:56</div>
            <div class="timeline-body"><blockquote>
<p>Yes there is a metadata hook https://hatch.pypa.io/latest/plugins/metadata-hook/custom/</p>
</blockquote>
<p>Thank you ðââï¸. I think after all the things I've done for Airlfow It's time to contribute back some docs to Hatchling from the &quot;user&quot; perspective :). Will likely do so soon.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2024-03-25 02:01</div>
            <div class="timeline-body"><p>That would be awesome, thanks ð Here is the meta-issue: https://github.com/pypa/hatch/issues/1245</p>
<p>In short, please prioritize how-to documents!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/potiuk">@potiuk</a> on 2024-03-25 02:05</div>
            <div class="timeline-body"><blockquote>
<p>Yes there is a metadata hook https://hatch.pypa.io/latest/plugins/metadata-hook/custom/</p>
</blockquote>
<p>Hmm. Just tried it but it does not seem to allow me to distinguish between editable/standard build. I want to <strong>really</strong> have quite a different set of those for editable standard build in a single <code>hatch_build.py</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2024-03-25 02:07</div>
            <div class="timeline-body"><p>Then please open a feature request to the build hook interface.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/potiuk">@potiuk</a> on 2024-03-25 02:08</div>
            <div class="timeline-body"><blockquote>
<p>Then please open a feature request to the build hook interface.</p>
</blockquote>
<p>Cool.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-25 02:12</div>
            <div class="timeline-body"><p>@ofek -- I assume there's no way for uv or for Hatch to detect when the hook can be trusted vs. not? E.g., could uv just avoid calling this when requirements are declared as &quot;dynamic&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2024-03-25 02:16</div>
            <div class="timeline-body"><p>That could work also I think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-25 02:32</div>
            <div class="timeline-body"><p>Is this unique to Hatch since it supports extensions? Would other build backends need similar gating?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2024-03-25 02:43</div>
            <div class="timeline-body"><p>setuptools would have the same issue in theory for very dynamic builds.</p>
<p>edit: really any such backend that allows for code execution during builds to modify metadata, maybe PDM also</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-25 02:45</div>
            <div class="timeline-body"><p>Ok, I'll add that gate in uv for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-25 03:31</div>
            <div class="timeline-body"><p>Do you have any advice for writing a test for this? This is what I have, but it's passing when I want it to fail based on the above: https://github.com/astral-sh/uv/compare/charlie/proj...charlie/dynamic</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2024-03-25 03:47</div>
            <div class="timeline-body"><p>Does this work?</p>
<p><code>scripts/packages/hatch_dynamic/pyproject.toml</code>:</p>
<pre><code class="language-toml">[build-system]
requires = [&quot;hatchling&quot;]
build-backend = &quot;hatchling.build&quot;

[project]
name = &quot;hatch-dynamic&quot;
version = &quot;1.0.0&quot;
dynamic = [&quot;dependencies&quot;]

[tool.hatch.build.targets.wheel.hooks.custom]
</code></pre>
<p><code>scripts/packages/hatch_dynamic/hatch_build.py</code>:</p>
<pre><code class="language-python">from hatchling.builders.hooks.plugin.interface import BuildHookInterface


class LiteraryBuildHook(BuildHookInterface):
    def initialize(self, version, build_data):
        build_data['dependencies'].append('foo')
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-25 03:48</div>
            <div class="timeline-body"><p>Trying, thank you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-25 03:56</div>
            <div class="timeline-body"><p>Yes, thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-25 04:02</div>
            <div class="timeline-body"><p>It looks like the example use-case from the Hatch issue (https://github.com/pypa/hatch/issues/532) doesn't use dynamic dependencies. I was hoping I could instead do something even more specific, like look for the presence of Hatch plugins (<code>[tool.hatch.build.targets.wheel.hooks]</code>, etc.), but that example <em>also</em> doesn't seem to use that, it registers a custom entrypoint.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-25 04:02</div>
            <div class="timeline-body"><p>So I'm not really sure how to detect it :/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2024-03-25 04:13</div>
            <div class="timeline-body"><p>Hmm, good point actually only metadata hooks have anything to do with <code>dynamic</code> I'm seeing. At the end of the day, build hooks can do anything to the metadata because even if they don't use the standard fields that the system might provide to change things they could also do a post hook to actually rewrite the contents of the wheel e.g. for example if there was a plugin that ran auditwheel/delocate/delvewheel to fix up extension modules.</p>
<p>If you want to check hooks then you would have to search for the following:</p>
<ul>
<li><code>[tool.hatch.build.hooks.*]</code></li>
<li><code>[tool.hatch.build.targets.*.hooks.*]</code></li>
</ul>
<p>Alternatively (or in addition to), maybe it would be nice to indicate your usage with an environment variable and then pip perhaps could start doing the same thing to standardize.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sbidoul">@sbidoul</a> on 2024-03-25 08:51</div>
            <div class="timeline-body"><p>I'd find it worrying if a trend develops for frontends to special case for specific backends, or backends to special case for specific frontends.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/potiuk">@potiuk</a> on 2024-03-25 08:57</div>
            <div class="timeline-body"><blockquote>
<p>I'd find it worrying if a trends develops for frontends to special case for specific backends, or backends to special case for specific frontends.</p>
</blockquote>
<p>Agree. I think we have to find a solution that is generic in both directions. Maybe something to discuss in Pittsburgh :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2024-03-25 13:06</div>
            <div class="timeline-body"><p>Just a sanity check, does everyone here understand why I do this? https://github.com/pypa/hatch/blob/hatchling-v1.22.4/backend/src/hatchling/build.py#L86-L99</p>
<p>I'm open to feedback but basically for extremely dynamic metadata you don't want frontends caching like that before dynamic stuff happens i.e. this issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-25 14:17</div>
            <div class="timeline-body"><p>I think I understand it, though I'm not familiar enough with Hatch to know why my first test case (using the <code>requirements.txt</code> plugin) worked without issue.</p>
<p>I do think it's non-standards compliant though, in two ways, at least based on what I saw in the linked issue:</p>
<ol>
<li>Projects that don't mark fields as &quot;dynamic&quot; can still produce dynamic metadata. In theory this could be considered a user configuration error?</li>
<li>The metadata returned by <code>prepare_metadata_for_build_wheel</code> is incorrect and Hatch doesn't adhere to the contract in the standards, so it's then sniffing for callers that would be impacted by the incorrectness.</li>
</ol>
<p>I'm honestly somewhat hesitant to add custom workarounds for Hatch here, though it also seems like a huge shame to skip <code>prepare_metadata_for_build_wheel</code> in all cases when it would be totally valid most of the time.</p>
<p>I know it's easier said than done, but I feel like the standards-compliant thing would be something like:</p>
<ul>
<li>Require &quot;dynamic&quot; for any field that is actually dynamic, and have Hatch enforce that after all the hooks run. (No idea if this is possible.)</li>
<li>Do the detection <em>within Hatch</em> to figure out whether <code>prepare_metadata_for_build_wheel</code> is safe (e.g., are there any build hooks?), and return <code>None</code> when it's not.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2024-03-25 15:59</div>
            <div class="timeline-body"><blockquote>
<p>I think I understand it, though I'm not familiar enough with Hatch to know why my first test case (using the requirements.txt plugin) worked without issue.</p>
</blockquote>
<p>Metadata resolution is the very first step and that component doesn't take into account what kind of builds are happening so it works perfectly in that case.</p>
<blockquote>
<p>Projects that don't mark fields as &quot;dynamic&quot; can still produce dynamic metadata. In theory this could be considered a user configuration error?</p>
</blockquote>
<p>That is unrelated to what's happening here but you're correct that I should produce an error for build hooks modifying static metadata just like I do for metadata hooks. I'll work on that soon.</p>
<blockquote>
<p>The metadata returned by prepare_metadata_for_build_wheel is incorrect and Hatch doesn't adhere to the contract in the standards, so it's then sniffing for callers that would be impacted by the incorrectness.</p>
</blockquote>
<p>I understand why you might think that but the issue is that backends that offer a dynamic functionality must make a trade-off. There are three options:</p>
<ol>
<li>Don't implement that method at all which would preclude certain performance optimizations for some tools.</li>
<li>Only provide an implementation conditionally, deliberately excluding situations where it is undesirable. (This is the current approach.)</li>
<li>Provide a constant implementation, which would break for workloads that require dynamic things happening during builds.</li>
</ol>
<blockquote>
<p>Do the detection within Hatch to figure out whether prepare_metadata_for_build_wheel is safe (e.g., are there any build hooks?), and return None when it's not.</p>
</blockquote>
<p>Is that part of the standard? It appears to me that you either implement it or you don't: https://peps.python.org/pep-0517/#prepare-metadata-for-build-wheel</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-25 17:04</div>
            <div class="timeline-body"><blockquote>
<p>That is unrelated to what's happening here but you're correct that I should produce an error for build hooks modifying static metadata just like I do for metadata hooks. I'll work on that soon.</p>
</blockquote>
<p>Yeah makes sense. This more spun out of my idea to detect <code>dynamic</code> fields and limit the call to non-<code>dynamic</code> cases.</p>
<blockquote>
<p>Is that part of the standard? It appears to me that you either implement it or you don't: https://peps.python.org/pep-0517/#prepare-metadata-for-build-wheel</p>
</blockquote>
<p>I think you're right. Our implementation allows the backend to return <code>None</code> but I think that's just an implementation detail on our side, I don't see that in the standard.</p>
<blockquote>
<p>Only provide an implementation conditionally, deliberately excluding situations where it is undesirable. (This is the current approach.)</p>
</blockquote>
<p>This seems like a reasonable outcome. The problem is that the &quot;conditionally&quot; is based on detecting the build front-end. Like, this wouldn't just be a problem for <code>uv</code>, it'd be a problem for any other installer too. Though I understand why it's hard to do anything differently here given the limitations of the spec.</p>
<blockquote>
<p>I understand why you might think that but the issue is that backends that offer a dynamic functionality must make a trade-off.</p>
</blockquote>
<p>Yeah, I understand. But it's still out of compliance with the standard, right? I'm not sure what to suggest other than that the standard needs to evolve in some way, but I'm not familiar enough with build backends to understand how.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2024-03-25 20:34</div>
            <div class="timeline-body"><p>I suppose I'll use your implementation's hack and return <code>None</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-25 20:40</div>
            <div class="timeline-body"><p>It's possible that breaks other frontends though, I'm not sure &gt;.&lt;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-25 20:53</div>
            <div class="timeline-body"><p>I have https://github.com/astral-sh/uv/pull/2645 open for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-25 21:00</div>
            <div class="timeline-body"><blockquote>
<p>I suppose I'll use your implementation's hack and return None.</p>
</blockquote>
<p>My read is that this won't work for <code>pip</code>:</p>
<pre><code class="language-python">def prepare_metadata_for_build_wheel(
        metadata_directory, config_settings, _allow_fallback):
    &quot;&quot;&quot;Invoke optional prepare_metadata_for_build_wheel

    Implements a fallback by building a wheel if the hook isn't defined,
    unless _allow_fallback is False in which case HookMissing is raised.
    &quot;&quot;&quot;
    backend = _build_backend()
    try:
        hook = backend.prepare_metadata_for_build_wheel
    except AttributeError:
        if not _allow_fallback:
            raise HookMissing()
    else:
        return hook(metadata_directory, config_settings)
    # fallback to build_wheel outside the try block to avoid exception chaining
    # which can be confusing to users and is not relevant
    whl_basename = backend.build_wheel(metadata_directory, config_settings)
    return _get_wheel_metadata_from_wheel(whl_basename, metadata_directory,
                                          config_settings)
</code></pre>
<p>(Though I know you omit pip anyway altogether.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-25 21:01</div>
            <div class="timeline-body"><p>I would say just leave it for now, there's no need to make any urgent changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-25 22:24</div>
            <div class="timeline-body"><p>I ended up special-casing <code>hatchling</code> in https://github.com/astral-sh/uv/pull/2645. We should figure out a better solution together.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-03-25 22:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:24:10 UTC
    </footer>
</body>
</html>
