<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv cache clean / uv pip install not concurrency safe? - astral-sh/uv #15704</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv cache clean / uv pip install not concurrency safe?</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/15704">#15704</a>
        opened by <a href="https://github.com/tiran">@tiran</a>
        on 2025-09-06 07:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tiran">@tiran</a></div>
            <div class="timeline-body">Summary
<p>Hi,</p>
<p>I&#x27;m running into a concurrency problem with uv that suggests that concurrent use of <code>uv cache clean</code> can interfere with <code>uv pip install</code>. I have not verified my hypothesis, yet. My Rust is a bit ... rusty. :)</p>
<p>I&#x27;m working on a project called <a href="https://github.com/python-wheel-build/fromager">Fromager</a>. Fromager is a tool to rebuild a package and all its build-time and run-time dependencies from sources. Simply speaking, Fromager operates in two phases. In the bootstrap phase it downloads sdists and figures out all build system requirements and install requirements recursively, and creates a graph file. In the second phase it builds wheels for all packages in the graph file. The second phase builds wheels in concurrent processes with a thread pool worker.</p>
<p>We recently switched to <code>uv</code> to benefit from its faster <code>uv pip install</code> and hardlink caching feature. We sometimes see build failures that suggest a problem with <code>uv cache clean &lt;pgk&gt;</code> and concurrent <code>uv pip install</code>. The core work loop looks like this:</p>
<ul>
<li>unpack sdist for PKG</li>
<li><code>uv venv</code></li>
<li><code>uv pip install</code> build system and build dependencies</li>
<li>PEP 571 build_wheel hook</li>
<li>copy wheel to local simple HTTP PyPI server (<code>http.server</code> on localhost)</li>
<li><code>uv cache clean PKG</code> to invalidate UV&#x27;s cache for the package</li>
</ul>
<p>In rare cases a package is built while another version of the same package is installed. In this particular case, Fromager had built <code>setuptools_scm-7.1.0</code> and was invalidating <code>uv cache clean setuptools_scm</code> while another task was <code>uv pip install setuptools-scm==8.2.0</code>. The error message from uv debug logs suggest that <code>uv cache clean</code> removed files that <code>uv pip install</code> was expecting:</p>
<pre><code>DEBUG Released lock at `/mnt/work-dir/compressed_tensors-0.10.2/build-3.12.9/.lock`
error: Failed to install: setuptools_scm-8.2.0-0-py3-none-any.whl (setuptools-scm==8.2.0)
  Caused by: failed to read directory `/mnt/work-dir/uv-cache/archive-v0/eajHM8DLem6g6TwjOkyU7`: No such file or directory (os error 2)
</code></pre>
Platform
<p>Linux (all arches)</p>
Version
<p>0.8.15</p>
Python version
<p>Python 3.12</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/tiran">@tiran</a> on 2025-09-06 07:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-09-06 12:16</div>
            <div class="timeline-body"><p>Yeah this is not safe, see https://docs.astral.sh/uv/concepts/cache/#cache-safety</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tiran">@tiran</a> on 2025-09-06 14:15</div>
            <div class="timeline-body"><p>Ah, now I feel dump for missing the caching section. I only looked at CLI docs https://docs.astral.sh/uv/reference/cli/#uv-cache .</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/SH2282000">@SH2282000</a> on 2025-09-06 19:33</div>
            <div class="timeline-body"><p>Why is it not possible to make it safe?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-09-08 16:45</div>
            <div class="timeline-body"><p>We would have to acquire an RW-lock on the cache for each uv operation that uses the cache (read), so we can get a write lock for cache cleaning operations. I don&#x27;t know how well RW-locks on files work cross platforms, or if it&#x27;s worth it here, given that <code>uv cache</code> operations shouldn&#x27;t run automatically or in the background.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-09-08 17:35</div>
            <div class="timeline-body"><blockquote>
<p>Why is it not possible to make it safe?</p>
</blockquote>
<p>Certainly it&#x27;s possible, it&#x27;s a matter of complexity and performance. I&#x27;m not sure how hard it&#x27;d be.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/konstin">@konstin</a> on 2025-09-19 08:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tiran">@tiran</a> on 2025-09-19 08:46</div>
            <div class="timeline-body"><p>Awesome! Thanks a lot, @konstin . I was not expecting a fix for this problem.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:40:17 UTC
    </footer>
</body>
</html>
