<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv pip compile --universal fails when dependency's python-requires is incompatible with -p, even with markers - astral-sh/uv #6730</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv pip compile --universal fails when dependency's python-requires is incompatible with -p, even with markers</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/6730">#6730</a>
        opened by <a href="https://github.com/alex">@alex</a>
        on 2024-08-27 23:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/alex">@alex</a> on 2024-08-27 23:16</div>
            <div class="timeline-body"><pre><code>~ ❯❯❯ uv version
uv 0.3.5 (Homebrew 2024-08-27)
</code></pre>
<p>When you use a marker to express a dependency, <code>uv pip compile --universal</code> &quot;forwards&quot; that to the output. For example:</p>
<pre><code>~ ❯❯❯ echo 'argcomplete; python_version &gt;= &quot;3.8&quot;' | uv pip compile --universal -p 3.7 -
warning: The requested Python version 3.7 is not available; 3.12.5 will be used to build dependencies instead.
Resolved 4 packages in 3ms
# This file was autogenerated by uv via the following command:
#    uv pip compile --universal -p 3.7 -
argcomplete==3.1.2 ; python_full_version &gt;= '3.8'
importlib-metadata==6.7.0 ; python_version &lt; '0'
    # via argcomplete
typing-extensions==4.7.1 ; python_version &lt; '0'
    # via importlib-metadata
zipp==3.15.0 ; python_version &lt; '0'
    # via importlib-metadata
</code></pre>
<p>When Python 3.7 is actually <em>used</em>, no dependencies will be installed.</p>
<p>However, when this same marker is used for a dependency whose python-requires mean there is no resolution for the lower version, this fails:</p>
<pre><code>~ ❯❯❯ echo 'check-sdist; python_version &gt;= &quot;3.8&quot;' | uv pip compile --universal -p 3.7 -
warning: The requested Python version 3.7 is not available; 3.12.5 will be used to build dependencies instead.
  × No solution found when resolving dependencies:
  ╰─▶ Because only check-sdist{python_full_version &gt;= '3.8'}&lt;=0.1.3 is available and the requested Python version (&gt;=3.7)
      does not satisfy Python&gt;=3.8, we can conclude that all versions of check-sdist{python_full_version &gt;= '3.8'} are
      incompatible.
      And because you require check-sdist{python_full_version &gt;= '3.8'}, we can conclude that your requirements are
      unsatisfiable.
</code></pre>
<p>The fact that <code>check-sdist</code> only supports Python 3.8+ should be ok, because the dependency has the <code>; python_version &gt;= &quot;3.8&quot;</code> marker. But instead <code>uv pip compile</code> rejects it because it's not compatible with <code>-p</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-27 23:20</div>
            <div class="timeline-body"><p>Ah yeah. You can solve this with the <code>environments</code> field, I think? By setting <code>environments = [&quot;python_version &gt;= '3.8'&quot;]</code>. I think it is similar to https://github.com/astral-sh/uv/issues/4668</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/alex">@alex</a> on 2024-08-27 23:23</div>
            <div class="timeline-body"><p>Hmm, this may in fact be a duplicate of that issue.</p>
<p>I'm not sure <code>environments</code> does what I want here -- I want to have a lockfile that installs correctly on Python 3.7, but does not include this dependency.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/alex">@alex</a> on 2024-08-27 23:24</div>
            <div class="timeline-body"><p>Ah, <code>environments = [&quot;python_version &lt; '3.8'&quot;, &quot;python_version &gt;= '3.8'&quot;]</code> causes it to work though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-27 23:25</div>
            <div class="timeline-body"><p>I think (or hope) that <code>environments = [&quot;python_version &lt; '3.8'&quot;, &quot;python_version &gt;= '3.8'&quot;]</code> would work though. That should work on any.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-27 23:26</div>
            <div class="timeline-body"><p>Yeah. The reason this happens is related to implementation details of the resolver (that we're considering changing). We only &quot;fork&quot; the resolver if we see multiple requirements for the same package. Once we fork, we (e.g.) do the right thing with respect to narrowing the supported Python range. But if we <em>only</em> see <code>argcomplete; python_version &gt;= &quot;3.8&quot;</code>, we don't fork (at least, not right now -- we have a PR open that <em>does</em> do this).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/alex">@alex</a> on 2024-08-27 23:29</div>
            <div class="timeline-body"><p>This may be a seperate issue, or not an issue at all, but it also seems that markers don't influence version resolution? Compare:</p>
<pre><code>~ ❯❯❯ echo 'argcomplete; python_version &gt;= &quot;3.8&quot;' | uv pip compile --universal -p 3.7 -
warning: The requested Python version 3.7 is not available; 3.12.5 will be used to build dependencies instead.
Resolved 4 packages in 3ms
# This file was autogenerated by uv via the following command:
#    uv pip compile --universal -p 3.7 -
argcomplete==3.1.2 ; python_full_version &gt;= '3.8'
importlib-metadata==6.7.0 ; python_version &lt; '0'
    # via argcomplete
typing-extensions==4.7.1 ; python_version &lt; '0'
    # via importlib-metadata
zipp==3.15.0 ; python_version &lt; '0'
    # via importlib-metadata
~ ❯❯❯ echo 'argcomplete; python_version &gt;= &quot;3.8&quot;' | uv pip compile --universal -p 3.8 -
warning: The requested Python version 3.8 is not available; 3.12.5 will be used to build dependencies instead.
Resolved 1 package in 1ms
# This file was autogenerated by uv via the following command:
#    uv pip compile --universal -p 3.8 -
argcomplete==3.5.0
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-27 23:49</div>
            <div class="timeline-body"><p>Can you explain that comment a bit more? Sorry, trying to follow. Do you mean the <code>-p 3.7</code> vs. <code>-p 3.8</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/alex">@alex</a> on 2024-08-27 23:50</div>
            <div class="timeline-body"><p>Sorry, I should have written more words.</p>
<p>In both of these invocations, <code>argcomplete</code> is only for Python 3.8. In one version this is done with <code>-p 3.8</code> and in the other it's done with <code>; python_version &gt;= &quot;3.8&quot;</code>. But these resolve to different <code>argcomplete</code> versions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-27 23:51</div>
            <div class="timeline-body"><p>Ohhh yes, I didn't notice that. I think that's because in the non-forking case (without <code>environments</code>), we're still trying to select a version that works on Python 3.7.</p>
<p><code>environments</code> is kind of a workaround for this right now; the resolver should actually do the right thing here, and select the maximum compatible version for Python 3.8 or later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/alex">@alex</a> on 2024-08-28 00:00</div>
            <div class="timeline-body"><p>Should this be a separate issue, or is this the right place?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/alex">@alex</a> on 2024-09-02 13:22</div>
            <div class="timeline-body"><p>I seem to have found another variant on this -- when you have additional environments:</p>
<pre><code>(tempenv-70b9155915899) ~/.v/tempenv-70b9155915899 ❯❯❯ cat uv.toml 
environments = [&quot;python_version &gt;= '3.10'&quot;, &quot;python_version &gt;= '3.8' and python_version &lt; '3.10'&quot;, &quot;python_version &lt; '3.8'&quot;]

(tempenv-70b9155915899) ~/.v/tempenv-70b9155915899 ❯❯❯ echo 'check-sdist; python_version &gt;= &quot;3.8&quot;' | uv pip compile --universal -p 3.7 -
warning: The requested Python version 3.7 is not available; 3.12.5 will be used to build dependencies instead.
  × No solution found when resolving dependencies for split (python_full_version &gt;= '3.8' and python_full_version &lt;
  │ '3.10'):
  ╰─▶ Because only check-sdist{python_full_version &gt;= '3.8'}&lt;=0.1.3 is available and the requested Python version (&gt;=3.7)
      does not satisfy Python&gt;=3.8, we can conclude that all versions of check-sdist{python_full_version &gt;= '3.8'} are
      incompatible.
      And because you require check-sdist{python_full_version &gt;= '3.8'}, we can conclude that your requirements are
      unsatisfiable.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../pyca/cryptography/issues/11548.html">pyca/cryptography#11548</a> on 2024-09-05 18:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/alex">@alex</a> on 2024-09-06 11:50</div>
            <div class="timeline-body"><p>The bug described ^ appears to be fixed now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-09-06 12:43</div>
            <div class="timeline-body"><p>It looks like <code>uv 0.4.5</code> fixed it:</p>
<pre><code>[andrew@duff i6730]$ cat uv.toml
environments = [&quot;python_version &gt;= '3.10'&quot;, &quot;python_version &gt;= '3.8' and python_version &lt; '3.10'&quot;, &quot;python_version &lt; '3.8'&quot;]
[andrew@duff i6730]$ echo 'check-sdist; python_version &gt;= &quot;3.8&quot;' | uv-0.4.4 pip compile --universal -p 3.7 -
warning: uv is only compatible with Python &gt;=3.8, found Python 3.7.9
  x No solution found when resolving dependencies for split (python_full_version &gt;= '3.8' and python_full_version &lt; '3.10'):
  `-&gt; Because only check-sdist{python_full_version &gt;= '3.8'}&lt;=0.1.3 is available and the requested Python version (&gt;=3.7) does not satisfy Python&gt;=3.8, we can conclude that all versions of check-sdist{python_full_version &gt;= '3.8'}
      are incompatible.
      And because you require check-sdist{python_full_version &gt;= '3.8'}, we can conclude that your requirements are unsatisfiable.
[andrew@duff i6730]$ echo 'check-sdist; python_version &gt;= &quot;3.8&quot;' | uv-0.4.5 pip compile --universal -p 3.7 -
warning: uv is only compatible with Python &gt;=3.8, found Python 3.7.9
Resolved 10 packages in 5ms
# This file was autogenerated by uv via the following command:
#    uv pip compile --universal -p 3.7 -
build==1.2.1 ; python_full_version &gt;= '3.8'
    # via check-sdist
check-sdist==0.1.3 ; python_full_version &gt;= '3.8'
colorama==0.4.6 ; python_full_version &gt;= '3.8' and os_name == 'nt'
    # via build
importlib-metadata==8.4.0 ; python_full_version &gt;= '3.8' and python_full_version &lt; '3.10.2'
    # via build
importlib-resources==6.4.4 ; python_full_version == '3.8.*'
    # via check-sdist
packaging==24.1 ; python_full_version &gt;= '3.8'
    # via build
pathspec==0.12.1 ; python_full_version &gt;= '3.8'
    # via check-sdist
pyproject-hooks==1.1.0 ; python_full_version &gt;= '3.8'
    # via build
tomli==2.0.1 ; python_full_version &gt;= '3.8' and python_full_version &lt; '3.11'
    # via
    #   build
    #   check-sdist
zipp==3.20.1 ; python_full_version &gt;= '3.8' and python_full_version &lt; '3.10.2'
    # via
    #   importlib-metadata
    #   importlib-resources
</code></pre>
<p>I'm actually not totally sure which commit fixed this. I haven't done a bisect. I see multiple possible candidates I think?</p>
<p>Also, the <code>python_version &lt; '0'</code> marker is weird. It can never be true, so I wonder what leads to us writing that out. That might be worth investigating too. (I know we can just filter such things out towards the end, but I'd like to better understand why they show up in the first place.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-06 12:48</div>
            <div class="timeline-body"><p>I believe Konsti dropped those in his unreachable PRs, maybe?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-09-06 12:54</div>
            <div class="timeline-body"><p>They are definitely still around (using the example in the OP):</p>
<pre><code>[andrew@duff i6730]$ echo 'argcomplete; python_version &gt;= &quot;3.8&quot;' | uv-main pip compile --universal -p 3.7 -
warning: uv is only compatible with Python &gt;=3.8, found Python 3.7.9
Resolved 4 packages in 32ms
# This file was autogenerated by uv via the following command:
#    uv pip compile --universal -p 3.7 -
argcomplete==3.1.2 ; python_full_version &gt;= '3.8'
importlib-metadata==6.7.0 ; python_full_version &lt; '0'
    # via argcomplete
typing-extensions==4.7.1 ; python_full_version &lt; '0'
    # via importlib-metadata
zipp==3.15.0 ; python_full_version &lt; '0'
    # via importlib-metadata
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-06 15:03</div>
            <div class="timeline-body"><p>But I don’t see them in your reproduced snippet, and those changes came after this issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-06 15:05</div>
            <div class="timeline-body"><p>Oh sorry, you re-ran there, I see. Do those packages appear if you use uv lock instead? We probably just need to apply whatever Konsti did in the lockfile to the universal output case \cc @konstin</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-09-06 15:37</div>
            <div class="timeline-body"><blockquote>
<p>I believe Konsti dropped those in his unreachable PRs, maybe?</p>
</blockquote>
<p>The pruning currently only happens in the transformation from graph to <code>uv.lock</code>, we should also prune <code>requirements.txt</code> entries with a false marker.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/7196.html">astral-sh/uv#7196</a> on 2024-09-08 18:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-08 18:32</div>
            <div class="timeline-body"><p>Gonna track that last part here: https://github.com/astral-sh/uv/issues/7196</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-09-08 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @BurntSushi by @charliermarsh on 2024-09-08 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-09-08 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-28 13:49</div>
            <div class="timeline-body"><p>Should be fixed in the next release (see: https://github.com/astral-sh/uv/pull/8628).</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:59 UTC
    </footer>
</body>
</html>
