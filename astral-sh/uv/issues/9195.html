<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publishing on Gitlab registry with `uv publish` needs extended access rights - astral-sh/uv #9195</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Publishing on Gitlab registry with <code>uv publish</code> needs extended access rights</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/9195">#9195</a>
        opened by <a href="https://github.com/ThomasHezard">@ThomasHezard</a>
        on 2024-11-18 13:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ThomasHezard">@ThomasHezard</a></div>
            <div class="timeline-body">

<p>Hello,</p>
<p>I am very new to <code>uv</code> but I find the project very interesting. Coming from the system-level programming world (C/C++ and Cmake on massive mono-repos with hundreds of targets and tons of automation tools), <code>uv</code> is the first tool, amongst those I encountered, which can do project management in the Python world the way I like it: clean, explicit and simple üëç</p>
<p>I have converted one simple Python project to <code>uv</code> and I have one issue regarding publishing.</p>
<p>My project is hosted on a private Gitlab instance, and this project contains a Python package which is published on the project&#x27;s package registry on Gitlab.
Before <code>uv</code>, I was building my wheel using <code>setuptools</code> and pushing it using <code>twine</code>.<br>
The build and publication was done by a CI job, and all <code>twine</code> needs to push on the project package registry on Gitlab is the <code>CI_JOB_TOKEN</code> provided by Gitlab.</p>
<p><code>uv publish</code> fails to do so using the same token. After some experiments, it seems that <code>uv publish</code> needs a token with <code>api</code> scope to work, which means I have to create one and put in my CI/CD variables, and which is not the best in terms of security.</p>
<p>In the end, I kept <code>twine</code> for the publishing at the end of my job for security reasons instead of using <code>uv publish</code>.</p>
<p>Two questions:</p>
<ul>
<li>Is there something I did wrong or did not understand?</li>
<li>If not, is there a reason for <code>uv publish</code> on Gitlab&#x27;s registry to need a token with a wider scope than <code>twine</code>?</li>
</ul>
<p>Thank you for your help, and thanks for this very good project üôè</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/FishAlchemist">@FishAlchemist</a> on 2024-11-18 14:34</div>
            <div class="timeline-body"><p>You are using CI_JOB_TOKEN as the access token, and twine can use CI_JOB_TOKEN, but <code>uv publish</code> doesn&#x27;t, right?
Could you please provide more specific details? Such as the version of uv you&#x27;re using, and what environment variables you&#x27;ve set for both twine and uv publish, including the values assigned to these variables. If any of the values are confidential, you can simply label them as &quot;confidential name.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/konstin">@konstin</a> on 2024-11-18 14:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/FishAlchemist">@FishAlchemist</a> on 2024-11-18 14:41</div>
            <div class="timeline-body"><p>But if it&#x27;s a UV issue, should we document how to publish packages to a GitLab private registry using GitLab CI/CD?
https://docs.astral.sh/uv/guides/integration/gitlab/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-11-18 14:43</div>
            <div class="timeline-body"><p>Can you share your uv invocation (with secrets redacted)?</p>
<p><code>uv publish</code> shouldn&#x27;t need more permissions than <code>twine</code> by default (they are using the same endpoint). If you&#x27;re using <code>--check-url</code>, in this case <code>uv publish</code> does more than <code>twine</code> and you may need a token that support the scope for the index page itself, too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ThomasHezard">@ThomasHezard</a> on 2024-11-18 18:30</div>
            <div class="timeline-body"><p>Here is my final script using <code>twine</code>, which is working, all ENV variables are provided by Gitlab itself:</p>
<pre><code>uv build
export TWINE_USERNAME=&quot;gitlab-ci-token&quot;
export TWINE_PASSWORD=$CI_JOB_TOKEN
uv run --link-mode=copy --no-project --with twine python -m twine upload --repository-url $CI_SERVER_URL/api/v4/projects/$CI_PROJECT_ID/packages/pypi dist/*.whl
</code></pre>
<p>My <code>uv publish</code> equivalent is the following:</p>
<pre><code>uv build
uv publish --publish-url $CI_SERVER_URL/api/v4/projects/$CI_PROJECT_ID/packages/pypi --token $CI_JOB_TOKEN dist/*.whl
</code></pre>
<p>which gets the following error (confidential data replaced by <code>XXX</code>):</p>
<pre><code>error: Failed to publish `dist/XXX.whl` to XXX/api/v4/projects/XXX/packages/pypi
  Caused by: Upload failed with status code 401 Unauthorized. Server says: {&quot;message&quot;:&quot;401 Unauthorized&quot;}
</code></pre>
<p>The only way I found to fix this is to replace <code>CI_JOB_TOKEN</code> with a custom CI variable containing a token with <code>api</code> scope, which is not an acceptable solution for me.</p>
<p>As for the environement:</p>
<ul>
<li>The scripts are running in the <code>ghcr.io/astral-sh/uv:debian</code> docker image (with up-to-date images, I verified all these error while writing this).</li>
<li>python is set to 3.10 using a <code>.python-version</code> file</li>
</ul>
<hr>
<p>[EDIT] I realise just now that my <code>twine</code> method uses a custom username which is not <code>__token__</code> for the authentification (as <a href="https://docs.gitlab.com/ee/user/packages/pypi_repository/#authenticate-with-a-ci-job-token">documented by Gitlab</a>). I&#x27;ll try the <code>uv publish</code> with <code>--password</code> and <code>--username</code> instead of <code>--token</code>, I&#x27;ll let you know.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ThomasHezard">@ThomasHezard</a> on 2024-11-18 18:43</div>
            <div class="timeline-body"><p>I found the issue.<br>
The <code>--token</code> option sets the username as <code>__token__</code>. However, in Gitlab, pushing to the pypi registry using <code>CI_JOB_TOKEN</code> requires to set the username to <code>gitlab-ci-token</code>, but you can also push to the pypi registry with the username <code>__token__</code> and a token with <code>api</code> scope as password, which led my to false interpretation of what was causing the error (a bit tricky though üòâ ).</p>
<p>This script works just fine üëå</p>
<pre><code>uv build
uv publish --publish-url $CI_SERVER_URL/api/v4/projects/$CI_PROJECT_ID/packages/pypi --username &quot;gitlab-ci-token&quot; --password $CI_JOB_TOKEN dist/*.whl
</code></pre>
<p>Some documentation about this in <code>uv</code> documentation may be interesting, but this would imply following any update on this on Gitlab documentation to update the <code>uv</code> documentation accordingly.<br>
Or we could ask for Gitlab to integrate a guide for publishing with <code>uv</code> in their documentation, but I doubt they will do that before <code>uv</code> gets to stable version <code>1.*</code>...</p>
<p>Sorry for the false alarm üôè</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/ThomasHezard">@ThomasHezard</a> on 2024-11-18 18:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/konstin">@konstin</a> on 2024-11-19 11:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-11-19 11:59</div>
            <div class="timeline-body"><p>That&#x27;s indeed confusing! We unfortunately haven&#x27;t fully figured out what to do with tokens yet (https://discuss.python.org/t/pep-694-upload-2-0-api-for-python-package-repositories/16879/64, <a href="https://github.com/astral-sh/uv/issues/9195">astral-sh/uv#9195</a>#issuecomment-2483840918)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ThomasA">@ThomasA</a> on 2025-01-22 09:28</div>
            <div class="timeline-body"><p>I was having the exact same problem and thanks to this thread, I now know how to solve it. Thanks @ThomasHezard üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/joukewitteveen">@joukewitteveen</a> on 2025-11-13 14:28</div>
            <div class="timeline-body"><p>Given that others may want to know as well and given that the documentation is easier to find than the current issue, can #16432 be merged/considered?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:35:33 UTC
    </footer>
</body>
</html>
