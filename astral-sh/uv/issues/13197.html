<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UV is unable to install rocm torch if I use a sys_platform marker - astral-sh/uv #13197</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>UV is unable to install rocm torch if I use a sys_platform marker</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/13197">#13197</a>
        opened by <a href="https://github.com/TheAyes">@TheAyes</a>
        on 2025-04-29 17:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/TheAyes">@TheAyes</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I'm currently trying to use uv for it's ease of use but I can't seem to get the platform markers to work correctly.</p>
<p>Here's my pyproject.toml:</p>
<pre><code class="language-toml">[project]
name = &quot;iona&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = [
    &quot;setuptools&quot;,
    &quot;wheel&quot;,
    &quot;transformers&quot;,
    &quot;torch&gt;=2.6.0&quot;,
    &quot;torchvision&gt;=0.21.0&quot;,
    &quot;torchaudio&gt;=2.6.0&quot;,
    &quot;accelerate&quot;
]

[tool.uv.sources]
torch = [
    { index = &quot;pytorch-cpu&quot;, marker = &quot;sys_platform != 'linux'&quot; },
    { index = &quot;pytorch-rocm&quot;, marker = &quot;sys_platform == 'linux'&quot; },
]
torchvision = [
    { index = &quot;pytorch-rocm&quot;, marker = &quot;sys_platform == 'linux'&quot; },
    { index = &quot;pytorch-cpu&quot;, marker = &quot;sys_platform != 'linux'&quot; },
]

[[tool.uv.index]]
name = &quot;pytorch-cpu&quot;
url = &quot;https://download.pytorch.org/whl/cpu&quot;
explicit = true

[[tool.uv.index]]
name = &quot;pytorch-rocm&quot;
url = &quot;https://download.pytorch.org/whl/rocm6.2&quot;
explicit = true
</code></pre>
<p>As you can see I'd like to use the rocm version of torch. However this always results in:</p>
<pre><code>  × No solution found when resolving dependencies for split (sys_platform == 'linux'):
  ╰─▶ Because only torch{sys_platform == 'linux'}&lt;=2.5.1+rocm6.2 is available and your project depends on torch{sys_platform == 'linux'}&gt;=2.6.0, we can conclude that your project's requirements are unsatisfiable.
</code></pre>
<p>Even If I decide to downgrade to 2.5.1 it suddenly becomes:</p>
<pre><code>× No solution found when resolving dependencies for split (sys_platform == 'linux'):
  ╰─▶ Because there is no version of pytorch-triton-rocm{python_full_version &lt; '3.13' and platform_machine == 'x86_64' and sys_platform == 'linux'}==3.1.0 and torch==2.5.1+rocm6.2 depends on
      pytorch-triton-rocm{python_full_version &lt; '3.13' and platform_machine == 'x86_64' and sys_platform == 'linux'}==3.1.0, we can conclude that torch==2.5.1+rocm6.2 cannot be used.
      And because only the following versions of torch{sys_platform == 'linux'} are available:
          torch{sys_platform == 'linux'}&lt;2.5.1
          torch{sys_platform == 'linux'}==2.5.1+rocm6.2
      and your project depends on torch{sys_platform == 'linux'}&gt;=2.5.1, we can conclude that your project's requirements are unsatisfiable.
</code></pre>
<p>So the only workaround I know of right now is removing the environment marker which resolves the issue but will install the wrong index unless I change it manually each time.</p>
<h3>Platform</h3>
<p>NixOS 25.05.20250423.8a2f738 (Warbler) x86_64</p>
<h3>Version</h3>
<p>uv 0.6.16</p>
<h3>Python version</h3>
<p>3.13 (can't check cause of  the dependency issue)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @TheAyes on 2025-04-29 17:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-04-29 17:24</div>
            <div class="timeline-body"><p>The first error looks correct: there is no <code>torch&gt;=2.6.0</code> on the ROCm6.2 index, so that's impossible to resolve.</p>
<p>The second issue looks correct too. You need to tell uv to look for <code>pytorch-triton-rocm</code> on the PyTorch index, probably something like this:</p>
<pre><code class="language-toml">[project]
name = &quot;iona&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = [
    &quot;setuptools&quot;,
    &quot;wheel&quot;,
    &quot;transformers&quot;,
    &quot;torch&gt;=2.5.1&quot;,
    &quot;torchvision&gt;=0.20.1&quot;,
    &quot;torchaudio&gt;=2.5.1&quot;,
    &quot;accelerate&quot;,
    &quot;pytorch-triton-rocm ; sys_platform == 'linux'&quot;,
]

[tool.uv.sources]
torch = [
    { index = &quot;pytorch-cpu&quot;, marker = &quot;sys_platform != 'linux'&quot; },
    { index = &quot;pytorch-rocm&quot;, marker = &quot;sys_platform == 'linux'&quot; },
]
torchvision = [
    { index = &quot;pytorch-rocm&quot;, marker = &quot;sys_platform == 'linux'&quot; },
    { index = &quot;pytorch-cpu&quot;, marker = &quot;sys_platform != 'linux'&quot; },
]
pytorch-triton-rocm = { index = &quot;pytorch-rocm&quot; }

[[tool.uv.index]]
name = &quot;pytorch-cpu&quot;
url = &quot;https://download.pytorch.org/whl/cpu&quot;
explicit = true

[[tool.uv.index]]
name = &quot;pytorch-rocm&quot;
url = &quot;https://download.pytorch.org/whl/rocm6.2&quot;
explicit = true
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TheAyes">@TheAyes</a> on 2025-04-29 17:26</div>
            <div class="timeline-body"><p>Wouldn't that mean the docs are incorrect?</p>
<p>https://docs.astral.sh/uv/guides/integration/pytorch/#configuring-accelerators-with-environment-markers</p>
<p>P.S.: I tried that. Bt the error remains the same:</p>
<pre><code>  × No solution found when resolving dependencies for split (sys_platform == 'linux'):
  ╰─▶ Because only torch{sys_platform == 'linux'}&lt;=2.5.1+rocm6.2 is available and your project depends on torch{sys_platform == 'linux'}&gt;=2.6.0, we can conclude that your project's requirements are unsatisfiable.
</code></pre>
<p>Will I need remove torch/torchvision from the dependencies for this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-04-29 17:34</div>
            <div class="timeline-body"><p>You also need to adjust the <code>torch</code> bound like I mentioned -- I've updated my comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TheAyes">@TheAyes</a> on 2025-04-29 17:41</div>
            <div class="timeline-body"><p>Alright this fixed it. Do you mind explaining what I will need to look for in order to resolve issues like this in the future? I'd take this as an opportunity to learn. :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-04-29 17:45</div>
            <div class="timeline-body"><p>Yeah sure. I should also add this example to the docs, similar to the Intel GPU example just below where you linked. Basically, once I saw:</p>
<pre><code>Because only torch{sys_platform == 'linux'}&lt;=2.5.1+rocm6.2 is available and your project depends on torch{sys_platform == 'linux'}&gt;=2.6.0, we can conclude that your project's requirements are unsatisfiable.
</code></pre>
<p>I opened up the ROCm index (https://download.pytorch.org/whl/rocm6.2/torch) and saw that the most recent supported version was <code>2.5.1</code> based on the filenames (e.g., <code>torch-2.5.1+rocm6.2-cp39-cp39-linux_x86_64.whl</code>). So I knew we needed to lower the version requirement (which the error message hints at).</p>
<p>Then when I saw:</p>
<pre><code>Because there is no version of pytorch-triton-rocm{python_full_version &lt; '3.13' and platform_machine == 'x86_64' and sys_platform == 'linux'}==3.1.0 and torch==2.5.1+rocm6.2 depends on
      pytorch-triton-rocm{python_full_version &lt; '3.13' an...
</code></pre>
<p>I had a suspicion that this package was only available on the ROCm index, since the error is saying it doesn't exist. So then I suspected that we had to mark it as &quot;coming from the ROCm index&quot; with <code>tool.uv.sources</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2025-04-29 17:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @charliermarsh on 2025-04-29 17:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> added by @charliermarsh on 2025-04-29 17:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @TheAyes on 2025-04-29 17:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-04-29 17:47</div>
            <div class="timeline-body"><p>Confusingly I'm gonna keep this open so that I remember to update the documentation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @charliermarsh on 2025-04-29 17:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-04-29 19:13</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:31:09 UTC
    </footer>
</body>
</html>
