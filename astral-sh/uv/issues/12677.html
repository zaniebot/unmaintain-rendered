<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UV fails installing a python library with CRC mismatch - astral-sh/uv #12677</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>UV fails installing a python library with CRC mismatch</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/12677">#12677</a>
        opened by <a href="https://github.com/unmultimedio">@unmultimedio</a>
        on 2025-04-04 18:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/unmultimedio">@unmultimedio</a> on 2025-04-04 18:03</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Attempting to install a uv package fails due to a CRC mismatch:</p>
<pre><code>$ uv add 'bufbuild-registry-grpc-python==1.71.0.1.20250116203702+1c024d64352b' --index https://buf.build/gen/python

  × No solution found when resolving dependencies:
  ╰─▶ Because
      bufbuild-registry-grpc-python==1.71.0.1.20250116203702+1c024d64352b
      has an invalid package format and your project depends on
      bufbuild-registry-grpc-python==1.71.0.1.20250116203702+1c024d64352b,
      we can conclude that your project's requirements are
      unsatisfiable.

      hint: The structure of `bufbuild-registry-grpc-python`
      (v1.71.0.1.20250116203702+1c024d64352b) was invalid:
        Bad CRC (got bb621658, expected 00000000) for file:
      bufbuild_registry_grpc_python-1.71.0.1.20250116203702+1c024d64352b.dist-info/METADATA

      hint: `bufbuild-registry-grpc-python` was found on
      https://buf.build/gen/python, but not at the requested version
      (bufbuild-registry-grpc-python==1.71.0.1.20250116203702+1c024d64352b).
      A compatible version may be available on a subsequent index
      (e.g., https://pypi.org/simple). By default, uv will only
      consider versions that are published on the first index that
      contains a given package, to avoid dependency confusion attacks.
      If all indexes are equally trusted, use `--index-strategy
      unsafe-best-match` to consider all versions from all indexes,
      regardless of the order in which they were defined.
  help: If you want to add the package regardless of the failed
        resolution, provide the `--frozen` flag to skip locking and
        syncing.
</code></pre>
<p>Trying to download the library zip file manually and run <code>zipinfo</code> on it, I get the correct expected CRC32 for the <code>METADATA</code> file entry:</p>
<pre><code>$ curl -O https://buf.build/gen/python/bufbuild-registry-grpc-python/bufbuild_registry_grpc_python-1.71.0.1.20250116203702+1c024d64352b-py3-none-any.whl --netrc
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 51133    0 51133    0     0   251k      0 --:--:-- --:--:-- --:--:--  252k

$ zipinfo -v bufbuild_registry_grpc_python-1.71.0.1.20250116203702+1c024d64352b-py3-none-any.whl
Archive:  bufbuild_registry_grpc_python-1.71.0.1.20250116203702+1c024d64352b-py3-none-any.whl
There is no zipfile comment.

... lots of entries ...

Central directory entry #61:
---------------------------

  There are an extra 16 bytes preceding this file.

  bufbuild_registry_grpc_python-1.71.0.1.20250116203702+1c024d64352b.dist-info/METADATA

  offset of local header from start of archive:   42466
                                                  (000000000000A5E2h) bytes
  file system or operating system of origin:      MS-DOS, OS/2 or NT FAT
  version of encoding software:                   2.0
  minimum file system compatibility required:     MS-DOS, OS/2 or NT FAT
  minimum software version required to extract:   2.0
  compression method:                             deflated
  compression sub-type (deflation):               normal
  file security status:                           not encrypted
  extended local header:                          yes
  file last modified on (DOS date/time):          1980 000 0 00:00:00
  32-bit CRC value (hex):                         bb621658
  compressed size:                                265 bytes
  uncompressed size:                              508 bytes
  length of filename:                             85 characters
  length of extra field:                          0 bytes
  length of file comment:                         0 characters
  disk number on which file begins:               disk 1
  apparent file type:                             binary
  non-MSDOS external file attributes:             000000 hex
  MS-DOS file attributes (00 hex):                none

  There is no file comment.

... more entries ...
</code></pre>
<p>Seems like CRC32 values should match?</p>
<pre><code>From error message:
bufbuild_registry_grpc_python-1.71.0.1.20250116203702+1c024d64352b.dist-info/METADATA
Bad CRC (got bb621658, expected 00000000)

From zipinfo:
bufbuild_registry_grpc_python-1.71.0.1.20250116203702+1c024d64352b.dist-info/METADATA
CRC: bb621658
</code></pre>
<p>This happens with the latest release https://github.com/astral-sh/uv/releases/tag/0.6.12, probably related to this PR? https://github.com/astral-sh/uv/pull/12623</p>
<p>Installing the same package using pip it works:</p>
<pre><code>python3 -m pip install bufbuild-registry-grpc-python==1.71.0.1.20250116203702+1c024d64352b --extra-index-url https://buf.build/gen/python
</code></pre>
<p>And pip seems to do a CRC check <a href="https://github.com/python/cpython/blob/main/Lib/zipfile/__init__.py#L1049">when the CRC is not zero in the header</a>.</p>
<h3>Platform</h3>
<p>Darwin 24.1.0 arm64</p>
<h3>Version</h3>
<p>uv 0.6.12 (e4e03833f 2025-04-02)</p>
<h3>Python version</h3>
<p>Python 3.13.2</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @unmultimedio on 2025-04-04 18:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pkwarren">@pkwarren</a> on 2025-04-04 18:30</div>
            <div class="timeline-body"><p>This looks to be related to https://github.com/Majored/rs-async-zip/issues/141#issuecomment-2195612262. It appears that reading the expected CRC32 from the data descriptor isn't supported.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-04-04 18:37</div>
            <div class="timeline-body"><p>cc @Gankra</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-04-06 21:03</div>
            <div class="timeline-body"><p>Ah interesting. Data descriptors are fairly rare in Python packages but I know the <code>buf</code> registry uses them (since that's the only place it's come up before).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/12694.html">astral-sh/uv#12694</a> on 2025-04-07 01:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-04-07 18:28</div>
            <div class="timeline-body"><p>Ideally fixed in #12722</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Gankra on 2025-04-07 18:28</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:27 UTC
    </footer>
</body>
</html>
