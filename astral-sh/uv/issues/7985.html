<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sys_platform seems to be ignored - astral-sh/uv #7985</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>sys_platform seems to be ignored</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/7985">#7985</a>
        opened by <a href="https://github.com/mikkelam">@mikkelam</a>
        on 2024-10-07 18:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/mikkelam">@mikkelam</a> on 2024-10-07 18:22</div>
            <div class="timeline-body"><p>sys_platform seems to be ignored. I am on a macos ARM64. This package is only available for linux</p>
<p>Reproduce</p>
<pre><code>~/projects/uvtest
‚ùØ uv init
Initialized project `uvtest`

~/projects/uvtest
‚ùØ uv add 'picamera2&gt;=0.3.18; sys_platform == &quot;linux&quot;'
Using CPython 3.12.4 interpreter at: /opt/homebrew/opt/python@3.12/bin/python3.12
Creating virtual environment at: .venv
‚†π av==13.1.0
error: Failed to download and build `python-prctl==1.8.1`
  Caused by: Build backend failed to determine extra requires with `build_wheel()` with exit status: 1
--- stdout:

--- stderr:
This module only works on linux
---

~/projects/uvtest
‚ùØ uv --version
uv 0.4.17 (Homebrew 2024-09-27)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-07 18:27</div>
            <div class="timeline-body"><p>We do support <code>sys_platform</code>, but to create a lockfile we need to read metadata from this package and if you look at the <a href="https://inspector.pypi.io/project/python-prctl/1.8.1/">package index</a> they only publish a source distribution and it does not statically define its dependencies so we need to build the project to know what its dependencies are.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2024-10-07 18:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mikkelam">@mikkelam</a> on 2024-10-07 18:36</div>
            <div class="timeline-body"><blockquote>
<p>We do support <code>sys_platform</code>, but to create a lockfile we need to read metadata from this package and if you look at the <a href="https://inspector.pypi.io/project/python-prctl/1.8.1/">package index</a> they only publish a source distribution and it does not statically define its dependencies so we need to build the project to know what its dependencies are.</p>
</blockquote>
<p>Fair enough, that makes sense. Should <code>uv</code> gracefully handle such examples? Or is this a rare occurrence?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-07 18:39</div>
            <div class="timeline-body"><p>It's fairly rare, especially with projects using modern metadata standards, but we've definitely seen other reports.  How would we handle it? We can't know it won't build on another platform unless we try, in which case the build could fail for arbitrary reasons.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mikkelam">@mikkelam</a> on 2024-10-07 18:49</div>
            <div class="timeline-body"><blockquote>
<p>It's fairly rare, especially with projects using modern metadata standards, but we've definitely seen other reports. How would we handle it? We can't know it won't build on another platform unless we try, in which case the build could fail for arbitrary reasons.</p>
</blockquote>
<p>I'm not sure it's worth your time, but a successful handling could be to simply inform the user what's happening here. i.e. <code>uv</code> is unable to create a lockfile on the host platform.</p>
<p>It would avoid bug reports from annoything users like meüòá</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">error messages</span> added by @zanieb on 2024-10-07 19:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-07 19:17</div>
            <div class="timeline-body"><p>cc @konstin / @charliermarsh if you have any ideas</p>
<p>It'd be great if we could have a hint, I'm just not sure we have enough information to explain the situation. Maybe we can hint about dynamic metadata and a lack of wheels to explain why we're building a package?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-10-08 13:22</div>
            <div class="timeline-body"><p>There are some categories of common build failures which are hard to detect algorithmically due to the intermediate state in which they occur.</p>
<p>Below is a draft i wrote compiling a number of user reports. After polishing it a bit, we can add it to the docs and link it for build failures.</p>
<hr />
<h1>Build failure FAQ</h1>
<p>This page lists common reasons why resolution and installation fails with a build error and how to fix them.</p>
<h3>Why does uv build a package?</h3>
<p>When generating the cross-platform lockfile, uv needs to determine the dependencies of all packages, even those only installed on other platforms. uv tries to avoid package builds during resolution. It uses any wheel if exist for that version, then tries to find static metadata in the source distribution (mainly pyproject.toml with static project.version, project.dependencies and project.optional-dependencies or METADATA of at least version 2.2). Only if all of that fails, it builds the package.</p>
<p>When installing, uv needs to have a wheel for the current platform for each package. If no matching wheel exists in the index, uv tries to build the source distribution.</p>
<p>You can check which wheels exist for a pypi project under ‚ÄúDownload Files‚Äù, e.g. https://pypi.org/project/numpy/2.1.1/#files. Wheels with <code>...-py3-none-any.whl</code> filenames work everywhere, others have the operating system and platform in the filename. For the linked numpy version, you can see that Python 3.10 to 3.13 on MacOS, Linux and Windows are supported.</p>
<h3>Fixes and Workarounds</h3>
<ul>
<li>If the build error mentions a missing header or library, there is often a matching package in your system package manager.</li>
<li>If the build error mentions a failing import, consider <a href="https://docs.astral.sh/uv/concepts/projects/#build-isolation">deactivating build isolation</a>.</li>
<li>If a package fails to build during resolution and the version that failed to build is older then the version you want to use, try adding a <a href="https://docs.astral.sh/uv/reference/settings/#constraint-dependencies">constraint</a> with a lower bound (e.g. <code>numpy&gt;=1.17</code>). Sometimes, due to algorithmic limitations, the uv resolver tries to find a fitting version using unreasonably old packages, which can be prevented by using lower bounds.</li>
<li>Consider using a different Python version for locking and/or installation (<code>-p</code>). If you are using an older Python version, you may need to use an older version of certain packages with native code too, especially for scientific code.</li>
<li>If locking fails due to building a package from a platform you do not support, consider <a href="https://docs.astral.sh/uv/reference/settings/#environments">declaring resolver environments</a> with your supported platforms.</li>
<li>If you support a large range of Python versions versions, consider using markers, e.g.:</li>
</ul>
<pre><code>numpy&gt;=1.23; python_version &gt;= &quot;3.10&quot;
numpy&lt;1.23; python_version &lt; &quot;3.10&quot;
</code></pre>
<ul>
<li>If locking fails due to building a package from a different platform, as an escape hatch you can <a href="https://docs.astral.sh/uv/reference/settings/#dependency-metadata">provide dependency metadata manually</a>. As uv can not verify this information, it is important to specify correct metadata in this override.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MicahLyle">@MicahLyle</a> on 2024-10-11 17:28</div>
            <div class="timeline-body"><p>Just documenting my use case</p>
<pre><code>    &quot;psycopg[binary]==3.2.3; (sys_platform == 'win32' or sys_platform == 'darwin')&quot;, # https://github.com/psycopg/psycopg
    &quot;psycopg[c]==3.2.3; (sys_platform != 'win32' and sys_platform != 'darwin')&quot;, # https://github.com/psycopg/psycopg
</code></pre>
<p>In this case I wouldn't want to try and compile the c version unless I'm on a production Linux system. But for developers running natively within Windows or Mac I just use the binary</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-10-21 21:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../beeware/toga/issues/2995.html">beeware/toga#2995</a> on 2024-11-25 05:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/16396.html">astral-sh/uv#16396</a> on 2025-11-06 02:28</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:22 UTC
    </footer>
</body>
</html>
