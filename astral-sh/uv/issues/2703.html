<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proactively build wheels for source distributions during `pip install` resolution - astral-sh/uv #2703</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Proactively build wheels for source distributions during <code>pip install</code> resolution</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/2703">#2703</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-03-28 02:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-28 02:07</div>
            <div class="timeline-body"><p>When we <code>pip install</code>, we first run the resolver, then use the resolution to install. If we encounter a source distribution while resolving, we'll attempt to get the metadata, which may involve running <code>prepare_metadata_for_build_wheel</code> as an optimization, to skip the wheel build. After the resolution, we need to install, so we go to build the wheel, which requires creating the build environment <em>again</em>.</p>
<p>This is somewhat wasteful, since we had to setup the build environment twice. If we <em>know</em> we'll need to include the distribution in the resolution, and we <em>know</em> that we're going to need to install (as in <code>pip install</code> or <code>pip sync</code>, but not <code>pip compile</code>), we should consider always building the distribution and avoiding <code>prepare_metadata_for_build_wheel</code>.</p>
<p>This could make sense for, e.g., direct URL distributions that we encounter during <code>pip install</code> and <code>pip sync</code> resolutions.</p>
<p>I don't know how much this matters, but it did occur to me today, since we're now doing more metadata resolutions during <code>pip install</code>. We should verify before changing anything, but in https://github.com/timothyjlaurent/uv-poetry-monorepo-mre, my estimate is that it cost us about 150ms.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @charliermarsh on 2024-03-28 02:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/potiuk">@potiuk</a> on 2024-03-28 09:22</div>
            <div class="timeline-body"><p>I think it's a good idea taking into acount all the dynamic complications - and also it follows the path that PEP 660 took for editable builds https://peps.python.org/pep-0660/. For dependencies that you indeed <code>know</code> that you have to install and you <code>know</code> that this is the version you are going to install for sure (URL. local paths)  as you noted this will make the resolution a bit longer, but overall impact on installation time will be net-negative. It will also allow to avoid the cases like we had with making some exceptions for specific cases like in #2130</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-29 15:54</div>
            <div class="timeline-body"><p>Just to clarify, I think this should be <em>faster</em> when we <em>know</em> we need to install the wheel eventually.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-31 17:52</div>
            <div class="timeline-body"><p>The downside here is that we may end up reducing the amount of parallelism if we're waiting on source distributions to build during resolution.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-31 18:05</div>
            <div class="timeline-body"><p>We could <em>safely</em> do this in <code>pip sync</code> and <code>pip install --no-deps</code> with no penalty though.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:30:31 UTC
    </footer>
</body>
</html>
