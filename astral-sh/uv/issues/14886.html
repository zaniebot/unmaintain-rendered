<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv installs pypy version into cpython venv - astral-sh/uv #14886</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv installs pypy version into cpython venv</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/14886">#14886</a>
        opened by <a href="https://github.com/tekumara">@tekumara</a>
        on 2025-07-25 10:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tekumara">@tekumara</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>The following results in <code>urllib3==1.26.20</code> being installed when I expect <code>urllib3==2.5.0</code>:</p>
<pre><code>❯ uv init
Initialized project `uvbug`
❯ uv add vcrpy
Using CPython 3.12.3
Creating virtual environment at: .venv
Resolved 10 packages in 468ms
Prepared 3 packages in 79ms
Installed 8 packages in 13ms
 + idna==3.10
 + multidict==6.6.3
 + propcache==0.3.2
 + pyyaml==6.0.2
 + urllib3==2.5.0
 + vcrpy==7.0.0
 + wrapt==1.17.2
 + yarl==1.20.1
❯ uv add google-cloud-dlp
Resolved 25 packages in 340ms
Prepared 2 packages in 1.67s
Installed 15 packages in 45ms
 + cachetools==5.5.2
 + certifi==2025.7.14
 + charset-normalizer==3.4.2
 + google-api-core==2.25.1
 + google-auth==2.40.3
 + google-cloud-dlp==3.31.0
 + googleapis-common-protos==1.70.0
 + grpcio==1.74.0
 + grpcio-status==1.74.0
 + proto-plus==1.26.1
 + protobuf==6.31.1
 + pyasn1==0.6.1
 + pyasn1-modules==0.4.2
 + requests==2.32.4
 + rsa==4.9.1
❯ rm uv.lock
❯ uv sync
Resolved 24 packages in 9ms
Uninstalled 1 package in 5ms
Installed 1 package in 5ms
 - urllib3==2.5.0
 + urllib3==1.26.20
</code></pre>
<p>vcrpy resolves to <a href="https://github.com/kevin1024/vcrpy/blob/19bd4e012c8fd6970fd7f2af3cc60aed1e5f1ab5/setup.py#L39-L41">urllib&lt;2 for pypy</a>  because of the following marker:</p>
<pre><code>&quot;urllib3 &lt;2; platform_python_implementation =='PyPy'&quot;
</code></pre>
<p>But I'm using a Cython implementation, so I was expecting urllib&gt;=2. There is some interaction between vcrpy and google-cloud-dlp because this doesn't happen with vcrpy alone.</p>
<p>Side note:</p>
<p>The lock file generated by subsequent <code>uv add</code>s differs from what I get if I remove the lock file and <code>uv sync</code> (see above) - is this to be expected?</p>
<h3>Platform</h3>
<p>macos</p>
<h3>Version</h3>
<p>uv 0.8.3 (Homebrew 2025-07-24)</p>
<h3>Python version</h3>
<p>python 3.12.3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @tekumara on 2025-07-25 10:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tekumara">@tekumara</a> on 2025-07-25 10:17</div>
            <div class="timeline-body"><p>As a workaround for now, I've asked uv not to resolve a pypy environment:</p>
<pre><code>[tool.uv]
environments = [
    &quot;platform_python_implementation != 'PyPy'&quot;
]
</code></pre>
<p>which gets me  <code>urllib3==2.5.0</code> when I <code>uv sync</code> from a clean slate (ie: without a uv.lock file or .venv).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-25 22:52</div>
            <div class="timeline-body"><p>uv's resolution is implementation agnostic by default, so this behavior is expected and your fix seems appropriate — the resolver is just preferring coherent versions across Python implementations. You could add a <code>urllib&gt;=2; platform_python_implementation != 'PyPy'&quot;</code> constraint the resolver would select separate versions for CPython and PyPy.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @zanieb on 2025-07-25 22:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2025-07-25 22:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tekumara">@tekumara</a> on 2025-07-26 12:42</div>
            <div class="timeline-body"><p>Thanks for the response! I think I'm missing something because given the following <a href="https://github.com/kevin1024/vcrpy/blob/19bd4e012c8fd6970fd7f2af3cc60aed1e5f1ab5/setup.py#L39-L44">taken from vcrpy</a>:</p>
<pre><code>[project]
name = &quot;foo&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = [
    &quot;urllib3 &lt;2; python_version &lt;'3.10'&quot;,
    # https://github.com/kevin1024/vcrpy/pull/775#issuecomment-1847849962
    &quot;urllib3 &lt;2; platform_python_implementation =='PyPy'&quot;,
    # Workaround for Poetry with CPython &gt;= 3.10, problem description at:
    # https://github.com/kevin1024/vcrpy/pull/826
    &quot;urllib3; platform_python_implementation !='PyPy' and python_version &gt;='3.10'&quot;,
]
</code></pre>
<p>When I run <code>uv sync</code> within CPython 3.12.3, then I end up with <code>urllib==2.5.0</code> (as I expect) and not a PyPy compatible version &lt; 2 as above. Why does the outcome differ here from the above case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-26 13:20</div>
            <div class="timeline-body"><p>I'm not sure off the top of my head, but we might be forking based on your first-party markers in a way we won't do for a third-party package?</p>
<p>The resolver is pretty complicated, it'd take a lot of investigation to explain why it takes a particular path in an edge case like this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tekumara">@tekumara</a> on 2025-07-27 03:50</div>
            <div class="timeline-body"><p>Ah, so I've compared the forking.</p>
<p>The <code>foo</code> pyproject.toml above generates these splits in the top-level of uv.lock:</p>
<pre><code>resolution-markers = [
    &quot;platform_python_implementation != 'PyPy'&quot;,
    &quot;platform_python_implementation == 'PyPy'&quot;,
]
</code></pre>
<p>Whereas in the original case (ie: <code>uv add vcrpy google-cloud-dlp</code>) I have top-level splits for:</p>
<pre><code>resolution-markers = [
    &quot;python_full_version &gt;= '3.13' and platform_python_implementation == 'PyPy'&quot;,
    &quot;python_full_version &gt;= '3.13' and platform_python_implementation != 'PyPy'&quot;,
    &quot;python_full_version &lt; '3.13' and platform_python_implementation != 'PyPy'&quot;,
    &quot;python_full_version &lt; '3.13' and platform_python_implementation == 'PyPy'&quot;,
]
</code></pre>
<p>I see the <a href="https://github.com/googleapis/python-api-core/blob/2c983853e930d1ad4a3ece6b6b55a6dc72206a17/pyproject.toml#L50">3.13 split is being introduced by google-api-core</a> (a dependency of google-cloud-dlp).</p>
<p>So I suspect the combination of splits is causing the instability in resolution, and difference in outcome, ie:</p>
<ol>
<li><code>uv add vcrpy &amp;&amp; uv add google-cloud-dlp</code> has urllib 2.5.0 and urllib 1.26.20 in the lock file with the relevant resolution makers</li>
<li><code>uv add vcrpy google-cloud-dlp</code> has only urllib 1.26.20 (with no resolution markers).</li>
</ol>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:32:21 UTC
    </footer>
</body>
</html>
