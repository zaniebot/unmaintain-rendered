```yaml
number: 17260
title: Hash mismatch for zstd-compressed wheels (regression in 0.9.20)
type: issue
state: closed
author: coltonevansid
labels:
  - bug
assignees: []
created_at: 2025-12-30T05:07:55Z
updated_at: 2025-12-30T16:23:25Z
url: https://github.com/astral-sh/uv/issues/17260
synced_at: 2026-01-10T03:11:36Z
```

# Hash mismatch for zstd-compressed wheels (regression in 0.9.20)

---

_Issue opened by @coltonevansid on 2025-12-30 05:07_

### Summary

After upgrading from uv 0.9.18 to 0.9.20, I'm experiencing hash mismatch errors when installing packages from a private pyx registry that serves zstd-compressed wheels. The same lock file that worked in 0.9.18 now fails in 0.9.20.

## Minimal Reproduction

### pyproject.toml
```toml
[project]
name = "test-project"
requires-python = ">=3.13"
dependencies = [
    "example-package",
]

[[tool.uv.index]]
name = "pyx"
url = "https://api.pyx.dev/simple/myorg/main"
explicit = true

[tool.uv.sources]
example-package = { index = "pyx" }
```

### Commands

```bash
# This works in 0.9.18, fails in 0.9.20
uv cache clean example-package --force
uv sync
```

### Error Output

```
× Failed to download `example-package==1.0.0`
  ╰─▶ Hash mismatch for `example-package==1.0.0`

      Expected:
        sha256:7227d1aa4a8266e4208e0955fc0c088cb118fdcfe05033320473ad4f832168c3

      Computed:
        sha256:479c179ce7bb022bd5f9d073778f1419709b2f384e44a5b62a7f86cd79c708ee
```

## Root Cause

The lock file contains both uncompressed and zstd-compressed hashes (this is the format generated by uv when locking against pyx registries):

```toml
[[package]]
name = "example-package"
version = "1.0.0"
source = { registry = "pyx" }
wheels = [
    {
        url = "https://files.astralhosted.com/.../example_package-1.0.0-py3-none-any.whl",
        hash = "sha256:7227d1aa4a8266e4208e0955fc0c088cb118fdcfe05033320473ad4f832168c3",
        size = 5688,
        upload-time = "2025-12-17T19:54:00Z",
        zstd = {
            hash = "sha256:479c179ce7bb022bd5f9d073778f1419709b2f384e44a5b62a7f86cd79c708ee",
            size = 3943
        }
    },
]
```

**The problem**:
- Primary hash `7227d1aa...` is for the **uncompressed wheel** (5688 bytes)
- Nested `zstd.hash` `479c179c...` is for the **zstd-compressed wheel** (3943 bytes)

**In uv 0.9.20**: Downloads the zstd-compressed wheel but verifies against the uncompressed hash → mismatch

**In uv 0.9.18**: Correctly verifies the zstd-compressed wheel against the nested zstd hash → works

## Pattern

This **only affects packages from pyx/astralhosted** that serve zstd-compressed wheels with the nested hash format. Packages from PyPI work fine because they don't have nested zstd hashes:

<details>
<summary>Lock file comparison</summary>

**PyPI package (works fine in both versions):**
```toml
wheels = [
    { url = "https://files.pythonhosted.org/.../package-1.0.0-py3-none-any.whl", hash = "sha256:...", size = 103094 },
]
```

**Pyx package (works in 0.9.18, fails in 0.9.20):**
```toml
wheels = [
    { url = "https://files.astralhosted.com/.../package-1.0.0-py3-none-any.whl", hash = "sha256:7227d1aa...", size = 5688, zstd = { hash = "sha256:479c179c...", size = 3943 } },
]
```

</details>

## Regression Analysis

This appears to be a regression from PR #17157 ("Avoid enforcing incorrect hash in mixed-hash settings"), included in 0.9.20.

That PR fixed mixed hash **algorithms** (SHA256 vs SHA512 for the same file), but broke the case of **same algorithm, different compression formats** (uncompressed vs zstd-compressed).

The test case in that PR (`lock_mixed_hashes`) only tests different hash algorithms, not zstd compression:

```rust
// Tests SHA256 → SHA512 switch for the same file
// Does NOT test uncompressed → zstd-compressed switch
```

## Workaround

Manually edit the lock file to use only the zstd hash:

```toml
# Change from:
wheels = [
    { url = "...", hash = "sha256:7227d1aa...", size = 5688, zstd = { hash = "sha256:479c179c...", size = 3943 } },
]

# To:
wheels = [
    { url = "...", hash = "sha256:479c179c...", size = 3943 },
]
```

### Platform

macOS (Darwin 25.1.0)

### Version

uv v0.9.20

### Python version

Python 3.13.9

---

_Label `bug` added by @coltonevansid on 2025-12-30 05:07_

---

_Comment by @woodruffw on 2025-12-30 05:50_

Hi @coltonevansid, thanks for opening this! Your RCA looks right to me on first blush. We'll triage a bit more and get back to you.

---

_Comment by @cgravill on 2025-12-30 14:08_

Thanks for workaround @coltonevansid we have the same with a private pyx package and that fixed it.

---

_Closed by @zanieb on 2025-12-30 15:24_

---

_Comment by @zanieb on 2025-12-30 16:23_

This should be fixed in 0.9.21

Thanks for the report!

---
