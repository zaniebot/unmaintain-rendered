<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv pip compile` possibly generating an unsatisfiable requirements file - astral-sh/uv #6038</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>uv pip compile</code> possibly generating an unsatisfiable requirements file</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/6038">#6038</a>
        opened by <a href="https://github.com/thecityofguanyu">@thecityofguanyu</a>
        on 2024-08-12 16:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/thecityofguanyu">@thecityofguanyu</a></div>
            <div class="timeline-body"><h2>Overview</h2>
<p>I'm not sure how this is possible?</p>
<p>See below for the relevant snippet from unsatisfiable lockfile that was emitted.</p>
<pre><code># This file was autogenerated by uv via the following command:
#    uv pip compile --no-emit-find-links --no-emit-index-url --no-emit-trusted-host --strip-extras --unsafe-package=pip --output-file=etc/pythondeps.linux.txt etc/pythondeps.linux.in
...
boto3==1.34.153
    # via
    #   -c etc/constraints.txt
    #   -r etc/pythondeps.lst
    #   redacted-lib-name
boto3-stubs==1.34.149
    # via -r etc/pythondeps.lst
botocore==1.34.149
    # via
    #   boto3
    #   s3transfer
botocore-stubs==1.34.153
    # via boto3-stubs
...
s3transfer==0.10.2
    # via boto3
</code></pre>
<p>We version the lockfile, so it is interesting to note that uv was actually <em>downgrading</em> those versions to <code>1.34.149</code> for some reason? (relative to what we already had checked in, which was <code>1.34.153</code> across the board)</p>
<p><img src="https://github.com/user-attachments/assets/d56c893f-372f-4695-a894-c5d83411327f" alt="image" /></p>
<hr />
<p>Relevant lines from the constraints.txt file referenced in the above:</p>
<pre><code>boto3 &gt;= 1.28.58
</code></pre>
<p>Relevant lines from the pythondeps.lst file referenced in the above:</p>
<pre><code>boto3
boto3-stubs[s3]
redacted-lib-name
</code></pre>
<hr />
<p>Error observed when trying to consume the generated lockfile:</p>
<pre><code>[2024-08-11T21:52:33.685Z] Successfully installed pip-24.2 uv-0.2.33
[2024-08-11T21:52:34.252Z] uv 0.2.33
[2024-08-11T21:52:40.824Z]   Ã— No solution found when resolving dependencies:
[2024-08-11T21:52:40.824Z]   â•°â”€â–¶ Because boto3==1.34.153 depends on botocore&gt;=1.34.153,&lt;1.35.0
[2024-08-11T21:52:40.824Z]       and you require boto3==1.34.153, we can conclude that you require
[2024-08-11T21:52:40.824Z]       botocore&gt;=1.34.153,&lt;1.35.0.
[2024-08-11T21:52:40.824Z]       And because you require botocore==1.34.149, we can conclude that the
[2024-08-11T21:52:40.824Z]       requirements are unsatisfiable.
</code></pre>
<h2>Other information</h2>
<ul>
<li>A minimal code snippet that reproduces the bug.<ul>
<li>We haven't reproduced this yet since it happened. Later runs resulted in those boto* versions matching. Still, the relevant information is in the above section, I believe.</li>
</ul>
</li>
<li>The command you invoked (e.g., <code>uv pip sync requirements.txt</code>), ideally including the <code>--verbose</code> flag.<ul>
<li>Also included in the above section, minus the verbose flag.</li>
</ul>
</li>
<li>The current uv platform.<ul>
<li>64bit RHEL7</li>
</ul>
</li>
<li>The current uv version (<code>uv --version</code>).<ul>
<li>Included in the above section <em>for the attempted install that later failed</em>. Unfortunately, there are no remaining logs / env from the environment that generated the lockfile.</li>
</ul>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-12 16:43</div>
            <div class="timeline-body"><p>Thanks for the thorough report. Does this occur on the latest version? There's been a lot of resolver work in the last few weeks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-08-12 16:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">resolver</span> added by @zanieb on 2024-08-12 16:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">great writeup</span> added by @zanieb on 2024-08-12 16:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thecityofguanyu">@thecityofguanyu</a> on 2024-08-12 17:02</div>
            <div class="timeline-body"><p>I can't say with for sure which <code>uv</code> version this occurred on due to lack of logs from this dev's local execution. We do usually live-at-head with uv, so if I compare to the CI run that failed from their commit, then I'd say it was likely to be <code>0.2.33</code>.</p>
<p>My understanding our org syncs our PyPI mirror weekly, so <code>0.2.33</code> happens to still be the latest available to us at this time.</p>
<p>We also haven't seen this happen apart from the one time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thecityofguanyu">@thecityofguanyu</a> on 2024-08-12 17:41</div>
            <div class="timeline-body"><p>Additional context not mentioned earlier: Python 3.8</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-12 19:22</div>
            <div class="timeline-body"><p>I'd love to figure this one out... Will be really hard without a repro though. I'm trying with <code>cargo run pip compile req.txt -c constraints.txt -o output.txt -n --exclude-newer 2024-08-11T21:52:33.685Z -p 3.8</code> using the example pinned versions above but not reproducing yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @charliermarsh on 2024-08-12 19:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @charliermarsh on 2024-08-12 19:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thecityofguanyu">@thecityofguanyu</a> on 2024-08-13 14:10</div>
            <div class="timeline-body"><p>Using the examples above, I gave it a shot with some repetitions yesterday and wasn't able to reproduce it.</p>
<p>By all accounts, we've only seen it happen this one time. I considered chalking this up to operator error and not opening an issue here, but I couldn't reason myself into an explanation that might explain the symptoms.</p>
<p>More context on the (non-minimal) execution that triggered this (one time):</p>
<ul>
<li>The <code>uv pip compile</code> execution was abstracted away into a Makefile<ul>
<li>I could share pieces of this, but I'm not sure it'll be enlightening because the autogenerated lockfile already shows the command ultimately used</li>
</ul>
</li>
<li>The constraints and input requirements files contain far more packages than listed above (although theoretically none that would interact with or influence the affected boto packages)</li>
<li>Packages are fetched from a custom UV_INDEX_URL (corporate environment) with mirrored packages from upstream PyPI and internal packages</li>
</ul>
<p>I'll see if I can try more repetitions again with the full requirements/constraints -- not trimmed down to the problematic packages.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-13 14:12</div>
            <div class="timeline-body"><p>Yeah I also can't come up with a great explanation for how it could happen. The only things I could imagine are...</p>
<ul>
<li>You have an <code>--override</code> defined somewhere, that's overriding the dependencies (seems unlikely, but it could lead to this kind of behavior).</li>
<li>There's some kind of caching error in the index such that the wrong requirements were reported.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thecityofguanyu">@thecityofguanyu</a> on 2024-08-13 15:32</div>
            <div class="timeline-body"><blockquote>
<p>You have an --override defined somewhere, that's overriding the dependencies (seems unlikely, but it could lead to this kind of behavior).</p>
</blockquote>
<p>Definitely no <code>--override</code> defined.</p>
<blockquote>
<p>There's some kind of caching error in the index such that the wrong requirements were reported</p>
</blockquote>
<p>Maybe, although I don't think I'll be able to corroborate that with logs.</p>
<hr />
<p>Still haven't reproduced it. The <code>uv pip compile</code> correctly fails when you explicitly constrain in a way to force the versions that were shown in the bad lockfile.</p>
<pre><code>DEBUG Prepared metadata for: redacted-lib-name ==0.1.24
  Ã— No solution found when resolving dependencies:
  â•°â”€â–¶ Because boto3==1.34.153 depends on botocore&gt;=1.34.153,&lt;1.35.0 and botocore&lt;=1.34.149, we can conclude that boto3==1.34.153 cannot be used.
      And because only the following versions of boto3 are available:
          boto3&lt;=1.34.153
          boto3==1.34.154
          boto3==1.34.155
      we can conclude that boto3&gt;=1.34.153,&lt;1.34.154 cannot be used. (1)

      Because boto3==1.34.154 depends on botocore&gt;=1.34.154,&lt;1.35.0 and botocore&lt;=1.34.149, we can conclude that boto3==1.34.154 cannot be used.
      And because we know from (1) that boto3&gt;=1.34.153,&lt;1.34.154 cannot be used, we can conclude that boto3&gt;=1.34.153,&lt;1.34.155 cannot be used. (2)

      Because boto3==1.34.155 depends on botocore&gt;=1.34.155,&lt;1.35.0 and botocore&lt;=1.34.149, we can conclude that boto3==1.34.155 cannot be used.
      And because we know from (2) that boto3&gt;=1.34.153,&lt;1.34.155 cannot be used, we can conclude that boto3&gt;=1.34.153 cannot be used.
      And because you require boto3&gt;=1.34.153, we can conclude that the requirements are unsatisfiable.
</code></pre>
<hr />
<p>There was a working theory that maybe the user had <code>git add -p</code> to commit only some of the lockfile changes. I thought that made sense at first.</p>
<p>If you notice from the diff where the bad lockfile is introduced, you'll see that there's also a metadata change of <code># via -r pythondeps.lst</code> to  <code># via -r etc/pythondeps.lst</code>. This is due to a working directory differences between our local Makefile and the CI process that also pushes new lockfiles.</p>
<p>That little comment change is there for every package in the lockfile, so a partial add theory would mean that somehow every change <em>except</em> those versions made it into the commit. This makes it seem less likely to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-13 15:38</div>
            <div class="timeline-body"><p>You could consider running in <code>--verbose</code> on CI, and then seeing if it pops up again so we can get more extensive logs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thecityofguanyu">@thecityofguanyu</a> on 2024-08-13 15:45</div>
            <div class="timeline-body"><p>Sure! We're grasping at straws now, so it can't hurt to log more verbosely just in case.</p>
<p>With that said, I wouldn't be hopeful from that approach. We pip-compile in CI once per week, and the one-off failure was from a local execution. ðŸ˜•</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:26:07 UTC
    </footer>
</body>
</html>
