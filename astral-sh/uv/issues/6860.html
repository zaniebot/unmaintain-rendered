<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dynamic version in editable install - astral-sh/uv #6860</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>dynamic version in editable install</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/6860">#6860</a>
        opened by <a href="https://github.com/pmeier">@pmeier</a>
        on 2024-08-30 12:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/pmeier">@pmeier</a> on 2024-08-30 12:06</div>
            <div class="timeline-body"><p><a href="https://peps.python.org/pep-0621/">PEP 621</a> allows for dynamic metadata in <code>pyproject.toml</code>. Tools like <a href="https://pypi.org/project/setuptools-scm/"><code>setuptools-scm</code></a> make use of this feature by computing the version of the package at build time.</p>
<p>Imagine I have a git repository with nothing but this <code>pyproject.toml</code> file that is committed.</p>
<pre><code class="language-toml">[build-system]
requires = [&quot;setuptools&gt;=64&quot;, &quot;setuptools_scm&gt;=8&quot;]
build-backend = &quot;setuptools.build_meta&quot;

[project]
name = &quot;foo&quot;
dynamic = [&quot;version&quot;]

[tool.uv]
dev-dependencies = [
    &quot;setuptools-scm&gt;=8.1.0&quot;,
]

[tool.setuptools_scm]
</code></pre>
<pre><code class="language-shell">$ ls -lA
total 8
drwxr-xr-x 8 pmeier pmeier 4096 Aug 30 11:40 .git
-rw-r--r-- 1 pmeier pmeier  238 Aug 30 11:34 pyproject.toml
$ git log --oneline
1105907 (HEAD -&gt; main) initial commit
</code></pre>
<p>Running <code>uv sync</code> gives me the following block in <code>uv.lock</code></p>
<pre><code>[[package]]
name = &quot;foo&quot;
version = &quot;0.1.dev1+g1105907&quot;
source = { editable = &quot;.&quot; }
</code></pre>
<p>We commit that and move on with development.</p>
<pre><code class="language-shell">$ git add uv.lock
$ git commit -m &quot;add lock&quot; &gt; /dev/null
$ git log --oneline
409a76d (HEAD -&gt; main) add lock
1105907 initial commit
</code></pre>
<p>Re-running, <code>uv sync</code> results in no changes in the lock file or venv, although we have</p>
<pre><code class="language-shell">$ uv run python -m setuptools_scm
0.1.dev2+g409a76d
</code></pre>
<p>Running <code>uv sync --reinstall-package foo</code> installs the correct version into the venv (checked with <code>uv pip show foo</code>), but again the <code>uv.lock</code> file stays untouched. Even why I manually change the version in the lock file to <code>0+dynamic</code> (<code>uv</code> complains if the string doesn't start with a number), <code>uv lock</code> does not change the <code>uv.lock</code> file at all.</p>
<p>IMO, in general this is good behavior given that it is impossible to lock the version of this editable package, since its version is computed dynamically. However, I'd prefer not have a quickly outdated version number &quot;hardcoded&quot; in the lock file.</p>
<p>Would it be possible to set the version to <code>&quot;dynamic&quot;</code> (or a different sentinel) if the package is an editable install and declares that the version is computed dynamically?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AbdealiLoKo">@AbdealiLoKo</a> on 2024-08-30 12:26</div>
            <div class="timeline-body"><p>I was using dynamic dependencies and version with setup.py/setuptools-scm and had the same issue.
So, this is kinda similar: https://github.com/astral-sh/uv/issues/6822</p>
<p>Currently uv aggressively caches packages, and dynamic metadata are not considered to break the cache. So, as per the current documentation what you are seeing is expected behavior.
https://docs.astral.sh/uv/concepts/cache/#dynamic-metadata</p>
<p>You can set <code>reinstall-package = [...]</code> to always reinstall specific packages where you know dynamic metadata is present</p>
<p>It did feel confusing to me when I saw it first too - and I feel like there will be many more such issues as users use uv more :)
Maybe worth enhancing !</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-design</span> added by @charliermarsh on 2024-08-30 12:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-30 12:51</div>
            <div class="timeline-body"><p>Agree that what you're seeing here (persisting the stale hash) is not quite right...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pmeier">@pmeier</a> on 2024-08-30 12:53</div>
            <div class="timeline-body"><p>Thanks a ton for the pointer. Same as you, I did not find this in the documentation.</p>
<p>In my case I don't need and more specifically don't want re-installation given that I already have an editable install for a pure Python package. I just don't want an outdated package version in my lock file. Setting it to something like <code>&quot;0+dynamic&quot;</code> seems to work, but I have no idea how brittle this is, i.e. does <code>uv</code> at some point simply override this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-09-09 20:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-09-09 20:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @charliermarsh on 2024-09-23 01:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-23 01:15</div>
            <div class="timeline-body"><p>This is still somewhat unsolved</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cpascual">@cpascual</a> on 2024-11-04 10:50</div>
            <div class="timeline-body"><p>Should this discussion be merged with #7533 ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pmeier">@pmeier</a> on 2024-11-11 20:44</div>
            <div class="timeline-body"><p>Updating this after trying the same workflow on <code>uv==0.5.1</code>:</p>
<ul>
<li>Putting in a sentinel like <code>0+dynamic</code> for the version into the <code>uv.lock</code> file no longer works. It gets replaced every time I run <code>uv sync</code></li>
<li>Running <code>uv sync</code> does not re-trigger a build. Meaning, if the version changes between two runs, e.g. by adding a <code>git tag</code> in between, the <code>uv.lock</code> file stays untouched</li>
<li><code>uv sync --reinstall-package foo</code> triggers a rebuild and updates the <code>uv.lock</code> file</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/my1e5">@my1e5</a> on 2024-11-11 23:26</div>
            <div class="timeline-body"><blockquote>
<p>Running uv sync does not re-trigger a build. Meaning, if the version changes between two runs, e.g. by adding a git tag in between, the uv.lock file stays untouched</p>
</blockquote>
<p>@pmeier - On this point, are you using the latest improvements to <code>cache-keys</code>? See https://docs.astral.sh/uv/concepts/cache/#dynamic-metadata</p>
<pre><code>[tool.uv]
cache-keys = [{ git = { commit = true, tags = true } }]
</code></pre>
<p>Git tag support recently got added. See</p>
<ul>
<li>https://github.com/astral-sh/uv/issues/7997</li>
<li>https://github.com/astral-sh/uv/pull/8259</li>
</ul>
<p>So I believe you should be able to trigger a re-build with just <code>uv sync</code> if a new Git tag is detected.</p>
<p>As for <code>uv.lock</code> file behaviour, that I'm less sure about. The topic is more fully discussed in</p>
<ul>
<li>https://github.com/astral-sh/uv/issues/7533</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pmeier">@pmeier</a> on 2024-11-18 09:37</div>
            <div class="timeline-body"><p>Thanks for the info @my1e5, but this is the opposite of what I want to do. Since the version of my app changes with every single commit and tag, but for most of the time no dependencies change, I'd like the <code>uv.lock</code> file just to stay constant. Whatever version that <code>uv</code> puts into the <code>uv.lock</code> file is going to be obsolete very soon.</p>
<p>Basically fresh development installs will always have to be done with <code>uv sync --frozen</code> to avoid adding &quot;arbitrary&quot; changes to the <code>uv.lock</code> file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-18 15:36</div>
            <div class="timeline-body"><p>Most of the discussion is happening in https://github.com/astral-sh/uv/issues/7533 â€” let's track there to avoid splitting the conversation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-11-18 15:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/7533.html">astral-sh/uv#7533</a> on 2024-12-16 03:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:35 UTC
    </footer>
</body>
</html>
