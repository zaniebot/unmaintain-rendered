<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incorrect sysconfig in uv-managed Python installation - astral-sh/uv #7369</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Incorrect sysconfig in uv-managed Python installation</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/7369">#7369</a>
        opened by <a href="https://github.com/akhilles">@akhilles</a>
        on 2024-09-13 17:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/akhilles">@akhilles</a> on 2024-09-13 17:33</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

<p>uv platform: macOS arm64
uv version: <code>0.4.9 (77d278f68 2024-09-10)</code></p>
<p>The <code>sysconfig</code> module is used by <code>pyo3</code> (and other tools) to discover information about the Python distribution. For example, https://pyo3.rs/v0.14.2/building_and_distribution.html?highlight=pyo3_python#configuring-the-python-version:</p>
<blockquote>
<p>Once the Python interpreter is located, pyo3-build-config executes it to query the information in the sysconfig module which is needed to configure the rest of the compilation.</p>
</blockquote>
<p>In a system-managed Python installation, <code>LIBDIR</code> in sysconfig correctly points to the installation's lib dir:</p>
<pre><code>$ uv venv --python-preference only-system
$ source .venv/bin/activate
$ python3 -m sysconfig | rg &quot;\sLIBDIR =&quot;
        LIBDIR = &quot;/opt/homebrew/opt/python@3.12/Frameworks/Python.framework/Versions/3.12/lib&quot;
</code></pre>
<p>In a uv-managed Python installation, <code>LIBDIR</code> is set to a non-existent directory:</p>
<pre><code>$ uv venv --python-preference managed
$ source .venv/bin/activate
$ python3 -m sysconfig | rg &quot;\sLIBDIR =&quot;
        LIBDIR = &quot;/install/lib&quot;
</code></pre>
<p>It should probably point to something like <code>$HOME/Library/Application Support/uv/python/cpython-3.12.3-macos-aarch64-none/install/lib</code>.</p>
<p>The incorrect <code>LIBDIR</code> causes some issues when using <code>pyo3</code> + <code>cargo test</code> in a uv virtual environment. I can work around it by messing around with <code>PYTHONPATH</code>, but it would be good to have consistent behavior across system-managed and uv-managed Python installations.</p>
<p>Related: https://github.com/bluss/sysconfigpatcher</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bluss">@bluss</a> on 2024-09-14 14:35</div>
            <div class="timeline-body"><p>Relatively simple patching go a long way and fixes many packages (as a start, patch CC and LIBDIR), but there is no obvious or perfect solution</p>
<p>Missing knowledge:</p>
<ul>
<li>Windows aspects of this issue?</li>
<li>In which cases does the sysconfigpatcher approach not work, it's not sufficient? It apparently helps in many simple cases, but what &quot;coverage&quot; does it give?</li>
<li>It depends on how the package works. Numpy doesn't need anything like this, it seems to build from source with uv's managed pythons anyway (it depends on Cython which does not build, but that's a different package)</li>
</ul>
<p>Because there is no perfect solution, it's probably good go an experimental path:</p>
<ol>
<li>The first step of the experimental approach is already done, sysconfigpatcher is that step - users can use that external tool - or other implementations of the same idea - and report their results</li>
<li>Could uv introduce opt-in patching of its managed python installs?</li>
<li>User feedback on the uv patching feature guides development - is different patching needed, is the method viable, should it be continued, should it be enabled by default</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bluss">@bluss</a> on 2024-10-06 22:59</div>
            <div class="timeline-body"><p>This proposed PEP is a little bit relevant for this issue</p>
<ul>
<li>https://peps.python.org/pep-0739/</li>
<li>https://discuss.python.org/t/pep-739-static-description-file-for-build-details-of-python-installations/44572</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-21 22:16</div>
            <div class="timeline-body"><p>Going to track improvements to this in https://github.com/astral-sh/uv/issues/8429</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-10-21 22:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 04:38:45 UTC
    </footer>
</body>
</html>
