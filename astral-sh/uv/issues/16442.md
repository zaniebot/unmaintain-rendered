```yaml
number: 16442
title: "Use don't care nodes to encode marker tree domains"
type: issue
state: open
author: ibraheemdev
labels: []
assignees: []
created_at: 2025-10-24T17:08:54Z
updated_at: 2025-10-24T17:39:14Z
url: https://github.com/astral-sh/uv/issues/16442
synced_at: 2026-01-10T01:57:36Z
```

# Use don't care nodes to encode marker tree domains

---

_Issue opened by @ibraheemdev on 2025-10-24 17:08_

A realization I came to when reading over the marker tree code (while reviewing https://github.com/astral-sh/ruff/pull/21050). We currently impose two domain constraints on a given marker tree:
- The `requires-python` range.
- Known mutually-incompatible marker pairs.

The first we handle using the "complexify" and "simplify" routines, where "complexify" maps ranges outside of the domain to false, while "simplify" removes these ranges entirely. The second we handle somewhat ad-hoc by simplifying away incompatible markers.

Looking at both of these cases as domain restrictions, we can instead represent inputs outside of the domain as "don't care" nodes, which are simplified away when checking satisfiability and when rendering the tree, which only consider inputs within the domain. This should also enable optimal simplification when considering mutually-incompatible pairs.

Ideally this means "complexify" maps ranges outside the domain to "don't care", and "simplify" goes away entirely, similar to the "restrict" operation we had before https://github.com/astral-sh/uv/pull/6268. However, it's possible that we need to keep "complexify" and have "simplify" instead perform the domain restriction via "don't care" nodes, depending on how we need to handle merging overlapping domains.

---

_Comment by @charliermarsh on 2025-10-24 17:39_

I knew you would come up with a better idea than whatever I did here :)

---
