<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issue with `uv pip` Handling Multiple Private Index URLs Leading to 403 Errors - astral-sh/uv #11244</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Issue with `uv pip` Handling Multiple Private Index URLs Leading to 403 Errors</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/11244">#11244</a>
        opened by <a href="https://github.com/Galdanwing">@Galdanwing</a>
        on 2025-02-05 14:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Galdanwing">@Galdanwing</a> on 2025-02-05 14:03</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Hello,</p>
<p>I am currently working on a project that requires pulling first-party libraries from multiple private artifact registries. To authenticate with these registries, I generate a JSON-based key in the format <code>https://_json_key_base64:{actual-key}/{location-of-registry}</code> and use it in the extra-index-url when installing packages via <code>uv pip</code>.</p>
<p>This approach works perfectly when installing from a single index. However, when I attempt to pull from multiple indexes, I encounter persistent 403 errors.</p>
<h4>Steps to Reproduce:</h4>
<ol>
<li><p>Use <code>uv pip</code> to install libraries from multiple private registries:</p>
<pre><code class="language-bash">uv pip install lib-from-private-registry-1 lib-from-private-registry-2 --index {json-base-64-key-of-private-registry-1-index-url} --index {json-base-64-key-of-private-registry-2-index-url}
</code></pre>
</li>
<li><p>This results in the following error:</p>
<pre><code>error: Failed to fetch: `https://europe-west4-python.pkg.dev/{location-of-registry-1}`
  Caused by: HTTP status client error (403 Forbidden) for url (https://europe-west4-python.pkg.dev/{location-of-registry-1}/l{lib-from-private-registry-1})
</code></pre>
</li>
<li><p>The issue does not occur when using <code>pip</code> with the <code>--extra-index-url</code> option.</p>
</li>
</ol>
<h4>Expected Behavior:</h4>
<p>When using <code>uv pip</code> with multiple <code>--index</code> options, libraries from all specified private registries should be installed without resulting in authorization errors.</p>
<h4>Observed Behavior:</h4>
<p>When specifying multiple private registries using <code>uv pip</code>, access to the libraries results in an HTTP 403 (Forbidden) error, indicating an issue with authorization.</p>
<h4>Additional Information:</h4>
<ul>
<li><strong>Tool Version:</strong> <code>uv</code> 0.5.28 (commit ee2bdc21f, 2025-02-04)</li>
<li><strong>Python Version:</strong> 3.13.1 (using virtual environment)</li>
</ul>
<h4>Anonymized verbose log</h4>
<pre><code>uv pip install {lib-1} {lib-2} --index ${registry-1} --index ${registry-2} --no-cache --verbose
DEBUG uv 0.5.28 (ee2bdc21f 2025-02-04)
DEBUG Searching for default Python interpreter in virtual environments
DEBUG Found `cpython-3.13.1-macos-aarch64-none` at `/Users/me/Repos/project/venv/bin/python3` (active virtual environment)
Using Python 3.13.1 environment at: venv
DEBUG Acquired lock for `venv`
DEBUG At least one requirement is not satisfied: {lib-2}
DEBUG Using request timeout of 30s
DEBUG Solving with installed Python version: 3.13.1
DEBUG Solving with target Python version: &gt;=3.13.1
DEBUG Adding direct dependency: {lib-1}*
DEBUG Adding direct dependency: {lib-2}*
DEBUG No cache entry for: https://europe-west4-python.pkg.dev/{registry-1}/{lib-1}
DEBUG No cache entry for: https://europe-west4-python.pkg.dev/{registry-1}/{lib-2}
DEBUG No cache entry for: https://europe-west4-python.pkg.dev/{registry-2}/{lib-2}
DEBUG Searching for a compatible version of {lib-1} (*)
DEBUG Selecting: {lib-1}==0.5.0 [compatible] ({lib-1}-0.5.0-py3-none-any.whl)
DEBUG No cache entry for: https://europe-west4-python.pkg.dev/{registry-1}/{lib-1}/{lib-1}
DEBUG No cache entry for: https://europe-west4-python.pkg.dev/{registry-2/{lib-2}/{lib-2}
WARN Range requests not supported for {lib-2}; streaming wheel
WARN Range requests not supported for {lib-1}; streaming wheel
DEBUG No cache entry for: https://europe-west4-python.pkg.dev/{registry-1}/{lib-1}
DEBUG No cache entry for: https://europe-west4-python.pkg.dev/{registry-2}/{lib-2}
DEBUG Released lock at `/Users/me/Repos/project/venv/.lock`
error: Failed to fetch: `https://europe-west4-python.pkg.dev/{registry-1}/{lib-1
  Caused by: HTTP status client error (403 Forbidden) for url ({registry-1)
</code></pre>
<h3>Platform</h3>
<p>Darwin 24.3.0 arm64</p>
<h3>Version</h3>
<p>uv 0.5.28 (ee2bdc21f 2025-02-04)</p>
<h3>Python version</h3>
<p>3.13.1</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @Galdanwing on 2025-02-05 14:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-05 15:15</div>
            <div class="timeline-body"><p>I'm guessing this is related to https://github.com/astral-sh/uv/pull/11074 e.g., as described at https://github.com/astral-sh/uv/issues/8565#issuecomment-2437949960</p>
<p>Is there a way you could share more details about the index URLs? Obfuscated is fine, but the structure is meaningful here.</p>
<p>You can also use <code>RUST_LOG=uv=trace</code> to get some more logs, which I presume will show us falling back to the &quot;realm cache&quot; for credentials.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-05 15:16</div>
            <div class="timeline-body"><p>Where do your registries serve files from relative to the index URL you provide?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Galdanwing">@Galdanwing</a> on 2025-02-06 08:10</div>
            <div class="timeline-body"><p>Hey @zanieb  , the registries are both 'Artifact Registry's in GCP.</p>
<p>Once I pulled the service-account json keys from GCP I convert it to a url I can use as extra index url like so:</p>
<pre><code>import base64
import json

ARTIFACT_REGISTRY_NAME = &quot;test-artifact-registry&quot;
GCP_PROJECT_ID=&quot;...&quot;

with open('/Users/me/file/google-service-account-json.json') as json_file:
    json_key = json.load(json_file)

json_b64 = base64.b64encode(json.dumps(json_key).encode()).decode()
url = f&quot;https://_json_key_base64:{json_b64}@europe-west4-python.pkg.dev/{GCP_PROJECT_ID}/{ARTIFACT_REGISTRY_NAME}/simple/&quot;
</code></pre>
<p>The second URL would then be generated the same way, except that the of course the ARTIFACT_REGISTRY_NAME but also the GCP_PROJECT_ID would be different. Does that answer your question? :)</p>
<p>In the rust trace it first matches the first package with the first registry, and then indeed it does show: <code>TRACE Found cached credentials for realm https://europe-west4-python.pkg.dev</code>which seems wrong, after this I see a request to the second registry with the key from the first one :)</p>
<p>As to your second comment:
<code>https://europe-west4-python.pkg.dev/{GCP_PROJECT_ID/{ARTIFACT_REGISTRY_NAME}/{library/{libary-version}.whl</code>, so this no longer contains the key, and therefore you fall back I guess, like you described in #8565</p>
<p>I will follow #11074 and if there's anything else you need, I'll try and answer!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-08 01:58</div>
            <div class="timeline-body"><p>Ah thanks for the details. #11074 was released in uv 0.5.26 â€” it looks like there's a bug with a trailing <code>/</code>.</p>
<p>https://github.com/astral-sh/uv/pull/11336</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/11336.html">astral-sh/uv#11336</a> on 2025-02-08 01:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-02-08 15:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-02-08 15:23</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:02 UTC
    </footer>
</body>
</html>
