<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Threadpool initialization fails during basic builds on HPC cluster unless low `concurrent-builds` limit set - astral-sh/uv #14462</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Threadpool initialization fails during basic builds on HPC cluster unless low <code>concurrent-builds</code> limit set</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/14462">#14462</a>
        opened by <a href="https://github.com/eah13">@eah13</a>
        on 2025-07-04 19:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/eah13">@eah13</a> on 2025-07-04 19:40</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I hope this might be an easy fix towards the broader HPC support issues mentioned in #7642</p>
<p>I'm testing out uv for use on the <a href="https://docs.tacc.utexas.edu/hpc/lonestar6/">Lonestar6</a> HPC cluster at TACC. I got through some basic hello world installs quick enough to want to abandon pyenv and poetry forever, but also ran into this early on:</p>
<pre><code class="language-bash">login1.ls6:~/smtest $ uvx ruff 
░░░░░░░░░░░░░░░░░░░░ [0/1] Installing wheels...                                                                                                                                                              memory allocation of 1520 bytes failed
memory allocation of 1520 bytes failed

thread 'main2' panicked at crates/uv-configuration/src/threading.rs:68:10:
failed to initialize global rayon pool: ThreadPoolBuildError { kind: IOError(Os { code: 11, kind: WouldBlock, message: &quot;Resource temporarily unavailable&quot; }) }
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
Aborted (core dumped)
</code></pre>
<p>This is a MWE drawn from the docs, but it happened tool that needed a build. (I picked <code>snakemake</code> as a workflow-relevant test install)</p>
<p>I was able to fix this by limiting the number of concurrent builds. I added these lines to my user's <code>uv.toml</code> (would also have worked in the relevant <code>pyproject.toml</code>, command line args, etc.) and was able to move on:</p>
<pre><code>#~/.config/uv.toml
concurrent-builds = 4
</code></pre>
<p><em>Edit: if you're coming here with the same issue it seems this is not a solid fix. The root cause seems to be resource scheduling, which is why setting this and other config variables _help</em> but don't guarantee a fix_</p>
<p>I can confirm that it fails again in the same way with <code>concurrent-builds =64</code> (half of the cores on the node). I want to be a good citizen on this system so even though I don't think this would get in anyone's way I didn't try anything higher than that, just in case.</p>
<p>I'm not exactly sure why simple builds like this would fail without that config line. This was on a login node intended for compilation. There's some throttling to prevent people from forgetting to submit a compute job to the clusters, but the throttling limits are massive compared to the load here. FWIW my user doesn't seem very throttled, or if so it's not at the OS level <code>ulimit</code> can see:</p>
<details><summary>Details</summary>

<pre><code class="language-bash">login1.ls6:~/smtest $ ulimit -a
core file size          (blocks, -c) 0
data seg size           (kbytes, -d) unlimited
scheduling priority             (-e) 0
file size               (blocks, -f) unlimited
pending signals                 (-i) 1028386
max locked memory       (kbytes, -l) unlimited
max memory size         (kbytes, -m) unlimited
open files                      (-n) 16384
pipe size            (512 bytes, -p) 8
POSIX message queues     (bytes, -q) 819200
real-time priority              (-r) 0
stack size              (kbytes, -s) unlimited
cpu time               (seconds, -t) unlimited
max user processes              (-u) 300
virtual memory          (kbytes, -v) 8388608
file locks                      (-x) unlimited
</code></pre>
</details> 

<p>Free speculation worth what you paid for it: Seems like <a href="https://github.com/astral-sh/uv/blob/eaf517efd85f3fcaafe290ffc36615f4be8e04f9/crates/uv-configuration/src/threading.rs#L63-L69">the relevant code</a> could catch that <code>ThreadPoolBuildError</code>, infer that resource throttling might be getting in the way (or whatever the correct diagnosis is), and perhaps try again with smaller resource limits?</p>
<p>tl;dr: uv threadpool initialization failed on multi tenant HPC systems with resource throttling. Seems easy to catch and retry with different limits or, at the very least, display an error message mentioning the configurations that addressed this issue.</p>
<h3>Platform</h3>
<p>Rocky 8.4, 2x AMD EPYC 7763 64-Core</p>
<h3>Version</h3>
<p>uv 0.7.19</p>
<h3>Python version</h3>
<p>Python 3.11.13</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @eah13 on 2025-07-04 19:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @konstin on 2025-07-07 12:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @konstin on 2025-07-07 12:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-07-07 12:42</div>
            <div class="timeline-body"><blockquote>
<p>memory allocation of 1520 bytes failed</p>
</blockquote>
<p>Are you memory constrained on the node?</p>
<p>We're using only standard rust tooling for parallelism (tokio, rayon, <code>std::thread</code>), so I'm surprised that the spawning the thread pool fails. I'm also surprised that <code>uvx ruff</code> is affected by concurrent builds, there are binary wheels for ruff so we shouldn't build at all, and the rayon thread pool is for installation, not for building.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eah13">@eah13</a> on 2025-07-07 14:14</div>
            <div class="timeline-body"><blockquote>
<p>Are you memory constrained on the node?</p>
</blockquote>
<p>No; check the <code>ulimit</code> output in the folded details above (fixed the formatting). And, let me tell you, when I've gotten it to run it's compiling super fast, in parallel. A thing of beauty.</p>
<p>Best I can tell, there's something about the 'one thread per CPU' heuristic that's baked into Rayon and common in Rust that's not playing well with these kinds of multi-tenant environments.</p>
<p>To me, a clue that there might be assumptions that don't hold baked into how the threadpool is built is this line:</p>
<pre><code>{ code: 11, kind: WouldBlock, message: &quot;Resource temporarily unavailable&quot; }
</code></pre>
<p>&quot;Temporarily&quot; suggests the system's saying &quot;wait a minute til I have those CPUs you asked for&quot; and Rayon is currently interpreting that as the resource being unavailable and dying. The fix might be as simple as waiting a tick to have full access to the CPUs that it's requesting.</p>
<p>I don't know what the specific resource scheduling setup is, but I have some evidence this is a broader problem.
I've done a bit of looking and have seen a bunch of HPC folks (using other systems with similar architectures) reporting <code>ThreadPoolBuildError</code>s on a variety of projects, including many that are using uv.
A few folks have reported similar errors on commercial hosting providers, so it's not just HPC.</p>
<p>Is support for the kind of  resource scheduling or whatever is happening on systems like this one in scope for this project?
If so, I'll reach out to our tech staff to get some more details on what kinds of behind-the-scenes resource scheduling type things might be fooling Rayon.</p>
<p>Even though there's a potential upstream fix on this, I think that project will be justifiably conservative. Some more intelligent error handling to check for currently unexpected resource scheduling schemes would make uv more robust overall and way more likely to work out of the box on multi-tenant systems.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-07-07 16:25</div>
            <div class="timeline-body"><blockquote>
<p>Is support for the kind of resource scheduling or whatever is happening on systems like this one in scope for this project?</p>
</blockquote>
<p>We would like to support an as large as possible set of environments, including HPC environments. The main hindrance is that we don't have access to those systems, so we can't reproduce those problems or validate any patches for them.</p>
<blockquote>
<p>I don't know what the specific resource scheduling setup is, but I have some evidence this is a broader problem.
I've done a bit of looking and have seen a bunch of HPC folks (using other systems with similar architectures) reporting <code>ThreadPoolBuildError</code>s on a variety of projects, including many that are using uv.
A few folks have reported similar errors on commercial hosting providers, so it's not just HPC.</p>
</blockquote>
<p>It would be great to fix this in rayon itself, the upstream error seems to be https://github.com/rayon-rs/rayon/issues/694.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:03 UTC
    </footer>
</body>
</html>
