<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>installing 'datrie' fails during compile (but pip succeeds) - astral-sh/uv #7525</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>installing 'datrie' fails during compile (but pip succeeds)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/7525">#7525</a>
        opened by <a href="https://github.com/samimia-swks">@samimia-swks</a>
        on 2024-09-18 23:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/samimia-swks">@samimia-swks</a> on 2024-09-18 23:55</div>
            <div class="timeline-body"><p>uv 0.4.11 on Ubuntu 22.04</p>
<p>I can install datrie (a dependency of snakemake) by using pip in a pyenv managed python 3.9.6 or 3.12.3 with no issues. pypi is missing wheels for python &gt;3.8 but the compile with gcc succeeds  creating datrie-0.8.2-cp39-cp39-linux_x86_64.whl. See attached pip logs.</p>
<p>if I try the same with <code>uv pip install datrie==0.8.2 --verbose</code> I get <code>error: command 'clang' failed: No such file or directory</code>
So somehow uv seems to want to compile this with clang even though I have gcc and pip can use that. See attached uv logs.</p>
<p>If I do <code>CC=$(which gcc) CXX=$(which g++)  uv pip install</code> it does use gcc but I get another error <code>command '/tools/llvm/bin/llvm-ar' failed: No such file or directory</code> further down the line.</p>
<p>The only thing that works is to install llvm and clang and then symlink llvm-ar from where it is installed to this seemingly hard-coded path '/tools/llvm/bin/llvm-ar'. This seems pretty hacky....</p>
<p>Now clearly this is mostly the fault of the datrie package, which is seemingly abandoned despite being a dependency of the very active and popular snakemake package,  but my question is why does pip succeed where uv fails?</p>
<p><a href="https://github.com/user-attachments/files/17051438/pip_datrie.log">pip_datrie.log</a>
<a href="https://github.com/user-attachments/files/17051439/uv_datrie.log">uv_datrie.log</a>
<a href="https://github.com/user-attachments/files/17051440/uv_datrie_gcc.log">uv_datrie_gcc.log</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "installing datrie fails during compile where pip succeeds" to "installing 'datrie' fails during compile (but pip succeeds)" by @samimia-swks on 2024-09-18 23:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-19 00:04</div>
            <div class="timeline-body"><p>Interestingly, when I use pip, it builds with clang not gcc. Are you using the same Python interpreter with <code>uv pip</code>? It looks like it's using 3.12 but the pip logs are using 3.9.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-19 00:09</div>
            <div class="timeline-body"><p>Can you reproduce this in CI or a container or something?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samimia-swks">@samimia-swks</a> on 2024-09-19 01:56</div>
            <div class="timeline-body"><p>pip was using a pyenv installed python 3.9.6, which I think compiles python from source.
uv was using uv installed python (which I think are pre-compiled). my original logs were with python 3.12 but here they are with 3.9.6. it's the same thing.
<a href="https://github.com/user-attachments/files/17052318/uv_datrie.log">uv_datrie.log</a></p>
<p>I have also attached logs for both pip and uv after installing clang and llvm (apt install clang llvm). it seems like pip still chooses to use gcc, but so does uv ?
<a href="https://github.com/user-attachments/files/17052371/pip_datrie_with_clang_installed.log">pip_datrie_with_clang_installed.log</a>
<a href="https://github.com/user-attachments/files/17052319/uv_datrie_with_clang_installed.log">uv_datrie_with_clang_installed.log</a></p>
<p>I don't have a CI or container setup unfortunately. But my colleague reproduced this issue on his own Ubuntu machine, if that counts for something. pip works for both of us.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-19 02:09</div>
            <div class="timeline-body"><p>Are you still using the uv-managed Python? We build the Python distribution itself with clang so maybe that's the difference? You can pass <code>--python &lt;path&gt;</code> to make sure you're using the same pyenv interpreter to see if that makes a difference.</p>
<blockquote>
<p>I don't have a CI or container setup unfortunately. But my colleague reproduced this issue on his own Ubuntu machine, if that counts for something.</p>
</blockquote>
<p>We'll need some sort of minimal reproduction to investigate for real.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2024-09-19 02:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @zanieb on 2024-09-19 02:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samimia-swks">@samimia-swks</a> on 2024-09-19 04:30</div>
            <div class="timeline-body"><p>Thanks for the quick response. See the logs below for an attempt at a minimal reproduction.
There are two python versions here:</p>
<ul>
<li><p>one is installed by 'pyenv install 3.9.6' which compiles from source with gcc (~/.pyenv/versions/3.9.6/bin/python)</p>
</li>
<li><p>and another with 'uv python install 3.9.6' which as you said is a pre-compiled clang install (~/.local/share/uv/python/cpython-3.9.6-linux-x86_64-gnu/bin/python3 )</p>
</li>
</ul>
<p>As you see in the log:</p>
<ul>
<li>'pip install' installs datrie successfully for the pyenv python with both CC=gcc and CC=clang.</li>
<li>'uv pip install' fails with both CC=gcc and CC=clang.</li>
<li>'uv pip install --python ~/.pyenv/versions/3.9.6/bin/python' succeeds with both CC=gcc and CC=clang.</li>
</ul>
<p>In short, the problem appears related to the python installed by uv.</p>
<p><a href="https://github.com/user-attachments/files/17053479/log.txt">log.txt</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samimia-swks">@samimia-swks</a> on 2024-09-20 20:42</div>
            <div class="timeline-body"><p>@zanieb, any luck with reproducing this?</p>
<p>Arman Samimi</p>
<p>Sent from my phone</p>
<p>On Sep 18, 2024, at 7:09 PM, Zanie Blue <em><strong>@</strong></em>.***&gt; wrote:</p>
<p>﻿
CAUTION: The email below is from an external source. Use caution before opening attachments or clicking links.</p>
<p>Are you still using the uv-managed Python? We build the Python distribution itself with clang so maybe that's the difference? You can pass --python <path> to make sure you're using the same pyenv interpreter to see if that makes a difference.</p>
<p>I don't have a CI or container setup unfortunately. But my colleague reproduced this issue on his own Ubuntu machine, if that counts for something.</p>
<p>We'll need some sort of minimal reproduction to investigate for real.</p>
<p>—
Reply to this email directly, view it on GitHub<a href="https://urldefense.com/v3/__https://github.com/astral-sh/uv/issues/7525*issuecomment-2359835189__;Iw!!MyQQGECaxY11k7S_!cVOVpZT4oCVUzE8kylbixoMEO26qzEmt9JrWRmOFAPbapWSkb2InXCXCgsxtyQDbJKc1aAOouE_1X1gM7L6oG2bDI6VrQXs$">https://urldefense.com/v3/__https://github.com/astral-sh/uv/issues/7525*issuecomment-2359835189__;Iw!!MyQQGECaxY11k7S_!cVOVpZT4oCVUzE8kylbixoMEO26qzEmt9JrWRmOFAPbapWSkb2InXCXCgsxtyQDbJKc1aAOouE_1X1gM7L6oG2bDI6VrQXs$</a>, or unsubscribe<a href="https://urldefense.com/v3/__https://github.com/notifications/unsubscribe-auth/A66EOSLEC2OFYYIKDLF6IUTZXIW5FAVCNFSM6AAAAABOOX23ZCVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDGNJZHAZTKMJYHE__;!!MyQQGECaxY11k7S_!cVOVpZT4oCVUzE8kylbixoMEO26qzEmt9JrWRmOFAPbapWSkb2InXCXCgsxtyQDbJKc1aAOouE_1X1gM7L6oG2bDEfy1uLo$">https://urldefense.com/v3/__https://github.com/notifications/unsubscribe-auth/A66EOSLEC2OFYYIKDLF6IUTZXIW5FAVCNFSM6AAAAABOOX23ZCVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDGNJZHAZTKMJYHE__;!!MyQQGECaxY11k7S_!cVOVpZT4oCVUzE8kylbixoMEO26qzEmt9JrWRmOFAPbapWSkb2InXCXCgsxtyQDbJKc1aAOouE_1X1gM7L6oG2bDEfy1uLo$</a>.
You are receiving this because you authored the thread.Message ID: <em><strong>@</strong></em>.***&gt;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-20 20:57</div>
            <div class="timeline-body"><p>Hm. I thought a wrote a reply but it's not here :/</p>
<p>In brief, I think you're running into a quirk of the Python distribution (which is built with clang): https://github.com/indygreg/python-build-standalone/blob/main/docs/quirks.rst#references-to-build-time-paths</p>
<p>I tried to dig into why this specific path (<code>/tools/llvm</code>) is in the distribution but couldn't figure that out. Maybe because I was looking at an aarch64 build though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bluss">@bluss</a> on 2024-09-20 21:05</div>
            <div class="timeline-body"><p>Sysconfig contains this for a typical indygreg build (typical that I've looked at / linux):</p>
<p><code>AR = &quot;/tools/llvm/bin/llvm-ar&quot;</code></p>
<p><code>AR</code> is one of the variables that sysconfigpatcher patches. It might be possible to try <a href="https://github.com/bluss/sysconfigpatcher">that tool</a> and see if it helps the build (but no guarantees, it's empirical only.)</p>
<p>If you want to inspect those variables, here's the way to do it:</p>
<pre><code>uv run python -m sysconfig
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-20 21:31</div>
            <div class="timeline-body"><p>Thanks! I wonder if we can/should reset some of these at build time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harryeslick">@harryeslick</a> on 2024-09-25 06:18</div>
            <div class="timeline-body"><p>I've run into the same problem installing <code>datrie</code> using rye.
I managed to get it working by adding the following env variable:</p>
<pre><code class="language-shell">export AR=/usr/bin/ar
</code></pre>
<p>Following the discussions here:
https://github.com/numpy/numpy/issues/17777#issuecomment-754583270</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samimia-swks">@samimia-swks</a> on 2024-09-25 16:59</div>
            <div class="timeline-body"><p>@zanieb @bluss your suggestion to use sysconfigpatcher did the trick! Maybe uv install should have a --patch-sysconfig option? it is an imperfect solution clearly, but doing nothing means that most packages with C extentions will fail to install if uv continues to use pre-compiled python builds.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bluss">@bluss</a> on 2024-09-25 17:13</div>
            <div class="timeline-body"><p>@samimia-swks sysconfigpatcher is experimental for sure, glad it helps, and I hope its experiments can be adopted if they are deemed safe, see my hopeful thoughts at https://github.com/bluss/sysconfigpatcher/issues/1 and #7369. I wonder if the uv team could say what kind of solution they would prefer and in that way open for the community to maybe offer help (pull requests).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> removed by @zanieb on 2024-10-06 14:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">uv python</span> added by @zanieb on 2024-10-06 14:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-06 14:39</div>
            <div class="timeline-body"><p>I'm not sure what the ideal solution is for us. We have the opportunity to make improvements at build time (i.e. stripping these from the distributions) as well as at install time (i.e. adding current platform relevant information). I think we have a fair bit of prototyping to do (and I'm happy to engage with community exploration) before we can choose a solution.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-21 22:11</div>
            <div class="timeline-body"><p>Let's track this in https://github.com/astral-sh/uv/issues/8429</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-10-21 22:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fivejjs">@fivejjs</a> on 2026-01-07 05:00</div>
            <div class="timeline-body"><p><code>export CC=clang</code> helped on my machine</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 03:17:11 UTC
    </footer>
</body>
</html>
