<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opt-into / opt-out of automatic re-sync with `uv run`? - astral-sh/uv #7165</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Opt-into / opt-out of automatic re-sync with `uv run`?</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/7165">#7165</a>
        opened by <a href="https://github.com/pawamoy">@pawamoy</a>
        on 2024-09-07 11:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/pawamoy">@pawamoy</a> on 2024-09-07 11:42</div>
            <div class="timeline-body"><p>uv 0.4.5.</p>
<p>Hi, thanks for uv, it's hot! :volcano:</p>
<p>I recently started using the higher-level commands of uv, like <code>uv sync</code> instead of <code>uv pip ...</code>. Working great :rocket: <code>uv sync</code> makes things much, much faster within my workflow :smile:</p>
<p>I also started using <code>uv run</code>. And there's something about it that I both love and dislike: the fact that it automatically re-syncs the env each time I use it.</p>
<ul>
<li>I love it because it means I can clone my repo, enter it, and immediately run my <code>format</code> task (which uses Ruff :yum:) to format the code, and uv will automatically create the venv, lock and install the dependencies, and run the specified command. That is <em>awesome</em>.</li>
<li>I dislike it because I often tinker with my venvs, installing different versions of dependencies to try things out. But now each time I use <code>uv run</code>, it resets these dependencies to the versions saved in the lock file.</li>
</ul>
<p>I am aware of the <code>--with</code> option (which is <em>awesome</em> too!), but I would really prefer &quot;persisting&quot; my changes in the venv, so that I don't have to use <code>--with x==y</code> in each subsequent commands. So, ideally I would like to have a way to opt-out of this automatic re-sync, which would result in the following behavior:</p>
<ol>
<li>if there's no venv, create one, lock, install deps</li>
<li>if there's a venv, don't touch it</li>
</ol>
<p>(venv path is determined with <code>UV_PROJECT_ENVIRONMENT</code> and usual fallback(s))</p>
<p>Do you think you can consider such a thing :thinking:?</p>
<p>Happy to elaborate on my use-case, as maybe there's a different/better workflow that uv suggests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pawamoy">@pawamoy</a> on 2024-09-07 11:52</div>
            <div class="timeline-body"><p>Ooooh it seems <code>--no-project</code> works for point 2 (if there's a venv, don't touch it), but not point 1 (if there's no venv, create it, lock, install). Could be good enough to me, as I don't mind continuing to tell my users to run <code>make setup</code> first to install deps.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-07 12:02</div>
            <div class="timeline-body"><p>I think it's gonna be hard for us to achieve both (1) and (2). We're trying to avoid reading state from disk like that. We <em>could</em>, it's just more of a departure from how things work today. I think <code>--no-project</code> will work if you've already activated the environment... Otherwise, I think you want something like <code>uv run --no-sync</code> (which doesn't exist IIRC).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @charliermarsh on 2024-09-07 12:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-07 12:02</div>
            <div class="timeline-body"><p>\cc @zanieb who may have opinions on point (1).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-07 16:04</div>
            <div class="timeline-body"><p>I think we're getting consistent feedback that <code>uv run --no-sync</code> should exist.</p>
<p>But... I don't think an operating mode that touches the virtual environment if it doesn't exist but not otherwise makes a ton of sense for general use — it seems hard to teach. I guess this would be a variant like <code>uv run --only-initial-sync</code>(?).</p>
<blockquote>
<p>I would really prefer &quot;persisting&quot; my changes in the venv, so that I don't have to use --with x==y in each subsequent commands.</p>
</blockquote>
<p>I think that we can do better here. We don't want you to have to persist the changes to your environment nor should you have to specify <code>--with</code> on every invocation. The options are probably</p>
<ol>
<li>Use <code>--with-requirements</code> and write them to a file</li>
<li>Add support for running commands with extra dependencies in #5903</li>
</ol>
<p>Would (2) address your use case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-07 17:29</div>
            <div class="timeline-body"><p>@zanieb -- Does <code>--no-sync</code> also not lock? (Should that just be the <code>--frozen</code> behavior perhaps?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-07 17:43</div>
            <div class="timeline-body"><p>I would be surprised if it locked. I was also surprised <code>--frozen</code> syncs —  but it makes sense that we allow for syncing without updating the lock.</p>
<p>Looking for consistency with other things... the <code>uv add</code> documention says:</p>
<blockquote>
<p>The lockfile and project environment will be updated to reflect the added dependencies. To skip updating the lockfile, use <code>--frozen</code>. To skip updating the environment, use <code>--no-sync</code>.</p>
</blockquote>
<p>Which seems reasonable. For <code>uv run</code> though I feel like <code>--no-sync</code> could imply <code>--frozen</code> since the intent of the command is not to modify the project's dependencies as opposed to, e.g., <code>uv add</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-09-08 16:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-09-10 21:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-09-10 21:29</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 04:47:48 UTC
    </footer>
</body>
</html>
