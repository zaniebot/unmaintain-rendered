```yaml
number: 11025
title: A group of tests is not robust to some external state
type: issue
state: closed
author: zanieb
labels:
  - testing
assignees: []
created_at: 2025-01-28T17:28:26Z
updated_at: 2025-01-28T19:28:55Z
url: https://github.com/astral-sh/uv/issues/11025
synced_at: 2026-01-12T16:00:26Z
```

# A group of tests is not robust to some external state

---

_@zanieb_

```
 FAIL [   1.413s] uv::it edit::add_index
──── STDOUT:             uv::it edit::add_index

running 1 test
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot: add_index-4
Source: crates/uv/tests/it/edit.rs:7020
────────────────────────────────────────────────────────────────────────────────
Expression: snapshot
────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬───────────────────────────────────────────────────────────────────
    4     4 │ ----- stderr -----
    5     5 │ Resolved 4 packages in [TIME]
    6     6 │ Prepared 2 packages in [TIME]
    7     7 │ Installed 2 packages in [TIME]
    8       │- + jinja2==3.1.3
          8 │+ + jinja2==3.1.4
    9     9 │  + markupsafe==2.1.5
────────────┴───────────────────────────────────────────────────────────────────
Stopped on the first failure. Run `cargo insta test` to run all snapshots.
test edit::add_index ... FAILED

failures:

failures:
    edit::add_index

test result: FAILED. 0 passed; 1 failed; 0 ignored; 0 measured; 1648 filtered out; finished in 1.40s

──── STDERR:             uv::it edit::add_index

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Unfiltered output ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
----- stdout -----

----- stderr -----
Resolved 2 packages in 111ms
Prepared 1 package in 18ms
Installed 1 package in 13ms
 + iniconfig==2.0.0

────────────────────────────────────────────────────────────────────────────────


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Unfiltered output ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
----- stdout -----

----- stderr -----
Resolved 4 packages in 223ms
──── STDOUT:             uv::it pip_compile::universal_platform_fork

running 1 test
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot: universal_platform_fork
Source: crates/uv/tests/it/pip_compile.rs:7474
────────────────────────────────────────────────────────────────────────────────
Expression: snapshot
────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬───────────────────────────────────────────────────────────────────
    5     5 │ filelock==3.13.1
    6     6 │     # via torch
    7     7 │ fsspec==2024.2.0
    8     8 │     # via torch
    9       │-jinja2==3.1.3
          9 │+jinja2==3.1.4
   10    10 │     # via torch
   11    11 │ markupsafe==3.0.2
   12    12 │     # via jinja2
   13    13 │ mpmath==1.3.0
┈┈┈┈┈┈┈┈┈┈┈┈┼┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
   21    21 │ torch==2.5.1 ; (platform_machine == 'aarch64' and sys_platform == 'linux') or sys_platform == 'darwin'
   22    22 │     # via -r requirements.in
   23    23 │ torch==2.5.1+cpu ; (platform_machine != 'aarch64' and sys_platform == 'linux') or (sys_platform != 'darwin' and sys_platform != 'linux')
   24    24 │     # via -r requirements.in
   25       │-typing-extensions==4.9.0
         25 │+typing-extensions==4.12.2
   26    26 │     # via torch
   27    27 │ 
   28    28 │ ----- stderr -----
   29    29 │ Resolved 11 packages in [TIME]
────────────┴───────────────────────────────────────────────────────────────────
Stopped on the first failure. Run `cargo insta test` to run all snapshots.
test pip_compile::universal_platform_fork ... FAILED

failures:

failures:
    pip_compile::universal_platform_fork

test result: FAILED. 0 passed; 1 failed; 0 ignored; 0 measured; 1648 filtered out; finished in 0.90s

──── STDERR:             uv::it pip_compile::universal_platform_fork

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Unfiltered output ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
----- stdout -----
# This file was autogenerated by uv via the following command:
#    uv pip compile --cache-dir /home/runner/.local/share/uv/tests/.tmpUm9dLS/cache requirements.in --universal
filelock==3.13.1
    # via torch
fsspec==2024.2.0
    # via torch
jinja2==3.1.4
    # via torch
markupsafe==3.0.2
    # via jinja2
mpmath==1.3.0
    # via sympy
networkx==3.2.1
    # via torch
setuptools==70.0.0
    # via torch
sympy==1.13.1
    # via torch
torch==2.5.1 ; (platform_machine == 'aarch64' and sys_platform == 'linux') or sys_platform == 'darwin'
    # via -r requirements.in
torch==2.5.1+cpu ; (platform_machine != 'aarch64' and sys_platform == 'linux') or (sys_platform != 'darwin' and sys_platform != 'linux')
    # via -r requirements.in
typing-extensions==4.12.2
    # via torch

----- stderr -----
Resolved 11 packages in 485ms

────────────────────────────────────────────────────────────────────────────────

thread 'pip_compile::universal_platform_fork' panicked at /home/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/insta-1.42.1/src/runtime.rs:679:13:
snapshot assertion for 'universal_platform_fork' failed in line 7474
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace

error: test run failed
```

---

_Label `testing` added by @zanieb on 2025-01-28 17:28_

---

_Comment by @BurntSushi on 2025-01-28 17:36_

Yeah I looked at jinja2's [release history](https://pypi.org/project/Jinja2/#history), and 3.1.5 was released about a month ago. And note that the snapshot diffs are going from `jinja2 3.1.3` to `jinja2 3.1.4`, which was released ~8 months ago. So I think there is something more sneaky happening here? Maybe?

---

_Renamed from "A group of tests is not robust to publish of new versions of `jinja2`" to "A group of tests is not robust to some external state" by @zanieb on 2025-01-28 17:39_

---

_Comment by @zanieb on 2025-01-28 17:39_

Interesting. More vague title now...

---

_Closed by @zanieb on 2025-01-28 19:28_

---
