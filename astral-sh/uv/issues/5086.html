<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`--universal` does not propagate markers to transitive dependencies - astral-sh/uv #5086</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`--universal` does not propagate markers to transitive dependencies</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/5086">#5086</a>
        opened by <a href="https://github.com/ibraheemdev">@ibraheemdev</a>
        on 2024-07-16 01:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-07-16 01:23</div>
            <div class="timeline-body"><p>For example, the following <code>requirements.in</code>:</p>
<pre><code>--find-links https://download.pytorch.org/whl/torch_stable.html

torch==2.0.0 ; platform_machine == 'x86_64'
torch==2.2.0 ; platform_machine != 'x86_64'
torchvision
</code></pre>
<p>Produces:</p>
<pre><code>certifi==2024.7.4
    # via requests
charset-normalizer==3.3.2
    # via requests
filelock==3.15.4
    # via torch
fsspec==2024.6.1
    # via torch
idna==3.7
    # via requests
jinja2==3.1.4
    # via torch
markupsafe==2.1.5
    # via jinja2
mpmath==1.3.0
    # via sympy
networkx==3.2.1
    # via torch
numpy==1.26.3
    # via torchvision
pillow==10.4.0
    # via torchvision
requests==2.32.3
    # via torchvision
sympy==1.13.0
    # via torch
torch==2.0.0
    # via
    #   -r requirements.in
    #   torchvision
torch==2.2.0
    # via
    #   -r requirements.in
    #   torchvision
torchvision==0.15.1+rocm5.4.2
    # via -r requirements.in
torchvision==0.17.0+rocm5.7
    # via -r requirements.in
typing-extensions==4.12.2
    # via torch
urllib3==2.2.2
    # via requests
</code></pre>
<p>Notably, none of the <code>torch</code> or <code>torchvision</code> pins have markers. I believe this happens because <code>torchvision</code> unconditionally depends on <code>torch</code> so the resolver forgets about the root markers.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ibraheemdev on 2024-07-16 01:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">lock</span> added by @ibraheemdev on 2024-07-16 01:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-16 01:28</div>
            <div class="timeline-body"><p>How does the lockfile look?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-16 01:29</div>
            <div class="timeline-body"><p>Hopefully it's correct, and this is just a bug in the <code>--universal</code> marker propagation piece.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-07-16 02:07</div>
            <div class="timeline-body"><p><code>uv lock</code> adds the markers to <code>torch</code>, but not <code>torchvision</code>:</p>
<pre><code>dependencies = [
    { name = &quot;torch&quot;, version = &quot;2.0.0&quot;, source = { registry = &quot;https://pypi.org/simple&quot; }, marker = &quot;platform_machine == 'x86_64'&quot; },
    { name = &quot;torch&quot;, version = &quot;2.2.0&quot;, source = { registry = &quot;https://pypi.org/simple&quot; }, marker = &quot;platform_machine != 'x86_64'&quot; },
    { name = &quot;torchvision&quot;, version = &quot;0.15.1&quot;, source = { registry = &quot;https://pypi.org/simple&quot; } },
    { name = &quot;torchvision&quot;, version = &quot;0.17.0&quot;, source = { registry = &quot;https://pypi.org/simple&quot; } },
]
</code></pre>
<p>I don't think we have a mechanism to transfer the markers to <code>torchvision</code>, that seems quite tricky.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-07-16 10:44</div>
            <div class="timeline-body"><p>We know which markers each version has by the <code>ForkState</code> it comes from, but it seems here we're somehow losing those markers in <code>into_resolution</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @BurntSushi by @BurntSushi on 2024-07-16 11:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-07-16 11:43</div>
            <div class="timeline-body"><p>I can look at this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "`--universal` does not propogate markers to transitive dependencies" to "`--universal` does not propagate markers to transitive dependencies" by @charliermarsh on 2024-07-17 01:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2024-07-26 14:28</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 04:55:51 UTC
    </footer>
</body>
</html>
