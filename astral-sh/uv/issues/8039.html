<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bug: uv pip compile does not respect `python-downloads` and `python-preference` - astral-sh/uv #8039</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>bug: uv pip compile does not respect `python-downloads` and `python-preference`</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/8039">#8039</a>
        opened by <a href="https://github.com/maartenbreddels">@maartenbreddels</a>
        on 2024-10-09 08:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/maartenbreddels">@maartenbreddels</a> on 2024-10-09 08:15</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

<h1>Reproducing the issue</h1>
<p>I have my system python version 3.9.16 (on osx)</p>
<pre><code>$ which python
/Users/maartenbreddels/miniconda3/envs/dev/bin/python
$ python --version
Python 3.9.16
</code></pre>
<p>uv is up to date (0.4.20).</p>
<p>I have the following uv.toml</p>
<pre><code class="language-toml">environments = [
    &quot;platform_system == 'Emscripten'&quot;
]

python-downloads = &quot;auto&quot;
python-preference = &quot;only-managed&quot;
</code></pre>
<p>My current requirement file is:</p>
<pre><code>https://py.cafe/gh/artifact/holoviz/panel/2021154790/panel-1.5.2-py3-none-any.whl
</code></pre>
<p><em>(PS: this url will fetch/extract a wheel on the fly from an upload artifact, i have excluded that endpoint being an issue by manually downloading the wheel from https://github.com/holoviz/panel/actions/runs/11204446095 an replacing the url with a local filename - i.e. <code>/Users/maartenbreddels/Downloads/pip/panel-1.5.2-py3-none-any.whl</code> in my case)</em></p>
<p>Running uv gives:</p>
<pre><code>$ UV_PYTHON_PREFERENCE=only-managed UV_PYTHON_DOWNLOADS=auto uv pip compile requirements.txt --python-version 3.12.1 --universal
warning: The requested Python version 3.12.1 is not available; 3.9.16 will be used to build dependencies instead.
  × No solution found when resolving dependencies:
  ╰─▶ Because the current Python version (3.9.16) does not satisfy Python&gt;=3.10 and panel==1.5.2 depends on Python&gt;=3.10, we can conclude that
      panel==1.5.2 cannot be used.
      And because only panel==1.5.2 is available and you require panel, we can conclude that your requirements are unsatisfiable.
</code></pre>
<p><em>(Note that I also set UV_PYTHON_PREFERENCE=only-managed UV_PYTHON_DOWNLOADS=auto just to be sure uv catches this setting, it shouldn't be needed)</em>.</p>
<h2>What I expect</h2>
<p>I expect <code>uv pip compile</code> to</p>
<ol>
<li>NOT use the system Python (3.9.16)</li>
<li>Install and use a 3.12.1 Python version</li>
</ol>
<h2>Current workaround</h2>
<p>First install the correct python version manually using `uv python install'</p>
<pre><code>$ uv python install 3.12.1
Searching for Python versions matching: Python 3.12.1
Installed Python 3.12.1 in 1.49s
 + cpython-3.12.1-macos-aarch64-none
$ uv pip compile requirements.txt --python-version 3.12.1 --universal
Resolved 34 packages in 19ms
# This file was autogenerated by uv via the following command:
#    uv pip compile requirements.txt --python-version 3.12.1 --universal
bleach==6.1.0
    # via panel
...
</code></pre>
<h2>Sidenote - extra inconsistency</h2>
<p>The behaviour is different when we do not install from a wheel link, but install from pypi.
I.e. change the requirement.txt file to.</p>
<pre><code>panel==1.5.2
</code></pre>
<pre><code>$ uv python uninstall --all
Searching for Python installations
Uninstalled Python 3.12.1 in 168ms
 - cpython-3.12.1-macos-aarch64-none
$ uv pip compile requirements.txt --python-version 3.12.1 --universal                                        ✘ 1 
warning: The requested Python version 3.12.1 is not available; 3.9.16 will be used to build dependencies instead.
Resolved 34 packages in 23ms
# This file was autogenerated by uv via the following command:
#    uv pip compile requirements.txt --python-version 3.12.1 --universal
bleach==6.1.0
    # via panel
bokeh==3.6.0
    # via panel
...
</code></pre>
<p>So although here it does still complain about the Python version being used, it will resolve.
Note that if we inspect https://pypi.org/pypi/panel/1.5.2/json we do find <code>&quot;requires_python&quot;: &quot;&gt;=3.10&quot;,</code>. To summarize:</p>
<ol>
<li><code>uv pip compile</code> with a wheel url will use the Python version of the system Python and fail to resolve if that Python versions does not match the constraints of the packages installed.</li>
<li><code>uv pip compile</code> with a pypi package will respect <code>--python-version</code>, despite using a system Python which does not match the constraints of the package installed.</li>
</ol>
<p>This makes <code>uv pip compile</code> a bit inconsistent. Note that this 'sidenote' might be a unrelated/new issue, although for me as a user they feel related. Let me know if I should open a new issue for this not to derail this issue.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:23 UTC
    </footer>
</body>
</html>
