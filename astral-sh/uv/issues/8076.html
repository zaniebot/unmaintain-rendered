<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explicitly setting `index-url` to its default is not equivalent to having it undefined when syncing lockfiles with unreachable URLs - astral-sh/uv #8076</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Explicitly setting `index-url` to its default is not equivalent to having it undefined when syncing lockfiles with unreachable URLs</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/8076">#8076</a>
        opened by <a href="https://github.com/mgab">@mgab</a>
        on 2024-10-10 08:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/mgab">@mgab</a> on 2024-10-10 08:56</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

<h2>Problem description</h2>
<p>When trying to sync from a lockfile that contains unreachable URLs, if there's any index url explicitly defined anywhere it correctly tries to get the packages from that index. Explicitly setting the default value <code>index-url = &quot;https://pypi.org/simple&quot;</code> works, too. However, if no index url is explicitly configured anywhere the sync command fails with an error reporting that the URLs in the lockfile are not reachable.</p>
<p>I would assume that explicitly setting the default value should be equivalent to not setting any value. If this is not the desired behavior I guess it should be mentioned in the documentation (e.g. <a href="https://docs.astral.sh/uv/reference/settings/#index-url">here</a>).</p>
<h2>Steps to reproduce</h2>
<p>You need to have no index URL configured anywhere (envvars, <code>~/.config/uv/uv.toml</code>...)</p>
<p>Then, on an empty folder</p>
<pre><code class="language-bash">uv init
uv add art
rm -r .venv
uv clean
sed -e 's/pypi.org/unresponding_url.org/' -e 's/files.pythonhosted.org/unresponding_url.org/g' -i '' uv.lock
uv sync --verbose
</code></pre>
<p>This command fails.</p>
<details>

<summary>`uv sync --verbose` output</summary>

<pre><code>DEBUG uv 0.4.19 (Homebrew 2024-10-07)
DEBUG Found project root: `/Users/m.gabalda/Code/uv_test/test_short`
DEBUG No workspace root found, using project root
DEBUG Reading requests from `/Users/m.gabalda/Code/uv_test/test_short/.python-version`
DEBUG Searching for Python 3.12 in managed installations or system path
DEBUG Searching for managed installations at `/Users/m.gabalda/.local/share/uv/python`
DEBUG Found `cpython-3.12.5-macos-aarch64-none` at `/Users/m.gabalda/.pyenv/shims/python` (search path)
Using CPython 3.12.5 interpreter at: /Users/m.gabalda/.pyenv/versions/3.12.5/bin/python
Creating virtual environment at: .venv
DEBUG Using request timeout of 30s
DEBUG Found static `pyproject.toml` for: test-short @ file:///Users/m.gabalda/Code/uv_test/test_short
DEBUG No workspace root found, using project root
DEBUG Existing `uv.lock` satisfies workspace requirements
Resolved 2 packages in 0.61ms
DEBUG Using request timeout of 30s
DEBUG Identified uncached distribution: art==6.3
DEBUG No cache entry for: https://unresponding_url.org/packages/b0/2e/2ad0cca2345e5bff23b979602917f39e844951dafe3b541935cc2850ee36/art-6.3-py3-none-any.whl
DEBUG Transient request failure for https://unresponding_url.org/packages/b0/2e/2ad0cca2345e5bff23b979602917f39e844951dafe3b541935cc2850ee36/art-6.3-py3-none-any.whl, retrying: error sending request for url (https://unresponding_url.org/packages/b0/2e/2ad0cca2345e5bff23b979602917f39e844951dafe3b541935cc2850ee36/art-6.3-py3-none-any.whl)
  Caused by: client error (Connect)
  Caused by: dns error: failed to lookup address information: nodename nor servname provided, or not known
  Caused by: failed to lookup address information: nodename nor servname provided, or not known
DEBUG Transient request failure for https://unresponding_url.org/packages/b0/2e/2ad0cca2345e5bff23b979602917f39e844951dafe3b541935cc2850ee36/art-6.3-py3-none-any.whl, retrying: error sending request for url (https://unresponding_url.org/packages/b0/2e/2ad0cca2345e5bff23b979602917f39e844951dafe3b541935cc2850ee36/art-6.3-py3-none-any.whl)
  Caused by: client error (Connect)
  Caused by: dns error: failed to lookup address information: nodename nor servname provided, or not known
  Caused by: failed to lookup address information: nodename nor servname provided, or not known
DEBUG Transient request failure for https://unresponding_url.org/packages/b0/2e/2ad0cca2345e5bff23b979602917f39e844951dafe3b541935cc2850ee36/art-6.3-py3-none-any.whl, retrying: error sending request for url (https://unresponding_url.org/packages/b0/2e/2ad0cca2345e5bff23b979602917f39e844951dafe3b541935cc2850ee36/art-6.3-py3-none-any.whl)
  Caused by: client error (Connect)
  Caused by: dns error: failed to lookup address information: nodename nor servname provided, or not known
  Caused by: failed to lookup address information: nodename nor servname provided, or not known
DEBUG Transient request failure for https://unresponding_url.org/packages/b0/2e/2ad0cca2345e5bff23b979602917f39e844951dafe3b541935cc2850ee36/art-6.3-py3-none-any.whl, retrying: error sending request for url (https://unresponding_url.org/packages/b0/2e/2ad0cca2345e5bff23b979602917f39e844951dafe3b541935cc2850ee36/art-6.3-py3-none-any.whl)
  Caused by: client error (Connect)
  Caused by: dns error: failed to lookup address information: nodename nor servname provided, or not known
  Caused by: failed to lookup address information: nodename nor servname provided, or not known
error: Failed to prepare distributions
  Caused by: Failed to fetch wheel: art==6.3
  Caused by: Could not connect, are you offline?
  Caused by: Request failed after 3 retries
  Caused by: error sending request for url (https://unresponding_url.org/packages/b0/2e/2ad0cca2345e5bff23b979602917f39e844951dafe3b541935cc2850ee36/art-6.3-py3-none-any.whl)
  Caused by: client error (Connect)
  Caused by: dns error: failed to lookup address information: nodename nor servname provided, or not known
  Caused by: failed to lookup address information: nodename nor servname provided, or not known
</code></pre>
</details>

<p>On the other hand, if before one defines explicitly the default value for <code>index-url</code> in <code>pyproject.toml</code> (or in <code>~/.config/uv/uv.toml</code>) it succeeds in searching for the dependencies in pypi:</p>
<pre><code>echo -e '\n[tool.uv]\nindex-url = &quot;https://pypi.org/simple&quot;' &gt;&gt; pyproject.toml
uv sync --verbose
</code></pre>
<details>

<summary>`uv sync --verbose` output</summary>

<pre><code>DEBUG uv 0.4.19 (Homebrew 2024-10-07)
DEBUG Found project root: `/Users/m.gabalda/Code/uv_test/test_short`
DEBUG No workspace root found, using project root
DEBUG Reading requests from `/Users/m.gabalda/Code/uv_test/test_short/.python-version`
DEBUG The virtual environment's Python version satisfies `Python 3.12`
DEBUG Using request timeout of 30s
DEBUG Found static `pyproject.toml` for: test-short @ file:///Users/m.gabalda/Code/uv_test/test_short
DEBUG No workspace root found, using project root
DEBUG Ignoring existing lockfile due to missing remote index: `art` `6.3` from `https://unresponding_url.org/simple`
DEBUG Starting clean resolution
DEBUG Found static `pyproject.toml` for: test-short @ file:///Users/m.gabalda/Code/uv_test/test_short
DEBUG No workspace root found, using project root
DEBUG Solving with installed Python version: 3.12.5
DEBUG Solving with target Python version: &gt;=3.12
DEBUG Adding direct dependency: test-short*
DEBUG Searching for a compatible version of test-short @ file:///Users/m.gabalda/Code/uv_test/test_short (*)
DEBUG Adding transitive dependency for test-short==0.1.0: art&gt;=6.3
DEBUG No cache entry for: https://pypi.org/simple/art/
WARN Skipping file for art: art-1.0-py3.4.egg
DEBUG Searching for a compatible version of art (&gt;=6.3)
DEBUG Selecting: art==6.3 [preference] (art-6.3-py3-none-any.whl)
DEBUG No cache entry for: https://files.pythonhosted.org/packages/b0/2e/2ad0cca2345e5bff23b979602917f39e844951dafe3b541935cc2850ee36/art-6.3-py3-none-any.whl.metadata
DEBUG Tried 2 versions: art 1, test-short 1
DEBUG Split universal resolution took 19.142s
Resolved 2 packages in 19.14s
DEBUG Using request timeout of 30s
DEBUG Identified uncached distribution: art==6.3
DEBUG No cache entry for: https://files.pythonhosted.org/packages/b0/2e/2ad0cca2345e5bff23b979602917f39e844951dafe3b541935cc2850ee36/art-6.3-py3-none-any.whl
Prepared 1 package in 212ms
DEBUG Extracting file name=PackageName(&quot;art&quot;)
DEBUG Cloning /Users/m.gabalda/.cache/uv/archive-v0/NOcfpTT4LlhTH0K29ewYy/art to /Users/m.gabalda/Code/uv_test/test_short/.venv/lib/python3.12/site-packages/art
DEBUG Cloning /Users/m.gabalda/.cache/uv/archive-v0/NOcfpTT4LlhTH0K29ewYy/art-6.3.dist-info to /Users/m.gabalda/Code/uv_test/test_short/.venv/lib/python3.12/site-packages/art-6.3.dist-info
DEBUG Extracted 2 files name=PackageName(&quot;art&quot;)
DEBUG Writing entrypoints name=PackageName(&quot;art&quot;)
DEBUG No data name=PackageName(&quot;art&quot;)
DEBUG Writing extra metadata name=PackageName(&quot;art&quot;)
DEBUG Writing record name=PackageName(&quot;art&quot;)
Installed 1 package in 5ms
 + art==6.3
</code></pre>
</details>

<h2>Versions</h2>
<p>Platform: macOS 14.6.1
uv version: uv 0.4.19 (Homebrew 2024-10-07)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-10 09:06</div>
            <div class="timeline-body"><p>Is there a reproduction here that doesn't involve manually modifying the <code>uv.lock</code>? (You're definitely on your own if you're modifying the <code>uv.lock</code> out-of-band; any guarantees go out the window.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @charliermarsh on 2024-10-10 09:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgab">@mgab</a> on 2024-10-10 12:11</div>
            <div class="timeline-body"><p>My use case is sharing a project, that doesn't have any explicit <code>index-url</code> or <code>extra-index-url</code> configured, between two setups:</p>
<ol>
<li>one that has some <code>index-url</code> configured at the user level (e.g. a proxy)</li>
<li>one that relies on the default <code>index-url</code> configuration without setting it explicitly (and for which the proxy the other setup uses is not reachable).</li>
</ol>
<p>AFAIU, if all the exact same packages are found in both index urls that setup should work. However, when (1) tries to sync using a lockfile generated by (2) it fails because it cannot reach the URLs listed in the lockfile instead of trying to get the files from the default index.</p>
<p>So, in short, the problem seems to be about dealing with unreachable URLs in the lockfile while not having an explicitly defined <code>index-url</code> value. Manually modifying the URLs in the lockfile to a non-responding hostname was a way to provide a minimal way to reproduce the issue, but I'm open to other ideas.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgab">@mgab</a> on 2024-10-11 07:50</div>
            <div class="timeline-body"><p>You can reproduce the issue using this <a href="https://github.com/user-attachments/files/17339212/uv.lock.txt">uv.lock.txt</a> and <a href="https://github.com/user-attachments/files/17339211/pyproject.toml.txt">pyproject.toml.txt</a> files (removing the <code>.txt</code> suffix that githubs requires to upload them)</p>
<p>The situation is essentially equivalent (URLs in the lockfile point at a domain that does not respond), but this time generated using a local mirror of pypi.</p>
<details>

<summary>Steps to generate those files</summary>

<hr />
<p>On one terminal, start a toy local pypi mirror. It can be populated with <code>python-pypi-mirror</code> and served with the standard library module <code>http.server</code>, just following the <a href="https://github.com/montag451/pypi-mirror">usage example</a> in <code>python-pypi-mirror</code>. I'll use <code>ast</code> as a dependency example:</p>
<pre><code class="language-bash">uvx --from python-pypi-mirror pypi-mirror download -d downloads ast
uvx --from python-pypi-mirror pypi-mirror create -d downloads -m simple
python3 -m http.server
</code></pre>
<p>Then on another terminal, create a new project and add <code>ast</code> as a project dependency using the local mirror as index url</p>
<pre><code>uv init
UV_EXTRA_INDEX_URL=http://127.0.0.1:8000/simple uv add art --no-cache
</code></pre>
<p>And then kill the http server on the first terminal.</p>
<hr />
</details>

<p>As in the other example, the issue is the same: trying to sync using that lockfile that has non-working URLs behaves differently depending on whether there's a index URL specifically defined or you rely on the default value.</p>
<p>Assuming there are no extra-index-url or index-url configured anywhere for the user, now this will fail</p>
<pre><code>uv sync --reinstall
</code></pre>
<p>while this, apparently equivalent according to the docs, will succeed</p>
<pre><code>UV_INDEX_URL=https://pypi.org/simple uv sync --reinstall
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-11 09:36</div>
            <div class="timeline-body"><p>Sorry yes -- this is intentional. If you don't provide <em>any</em> indexes explicitly, then we assume that we can accept the indexes that are already present in the lockfile. If you provide <em>at least</em> one index, then we reject the lockfile if it references any indexes that weren't provided by the user. By setting <code>UV_INDEX_URL</code> explicitly, that is semantically different than accepting the empty defaults.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> removed by @charliermarsh on 2024-10-11 09:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2024-10-11 09:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgab">@mgab</a> on 2024-10-11 11:20</div>
            <div class="timeline-body"><p>Oh, I see. Even if I see the desired behavior makes sense, it seems a behavior a bit confusing for a default value. In general I'd expect that defaults imply that not providing any value is equivalent to providing the default one.</p>
<p>Do you think it'd make sense to clarify it in the <a href="https://docs.astral.sh/uv/reference/settings/#index-url">documentation</a>? I couldn't find any reference to it.</p>
<p>In fact, probably then <code>https://pypi.org/simple</code> is not really a default value for the <code>index-url</code> setting, but rather a fallback package index used whenever there are no other relevant URL explicitly defined (either as index urls or in the lockfile)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgab">@mgab</a> on 2024-10-29 14:05</div>
            <div class="timeline-body"><p>Release <a href="https://github.com/astral-sh/uv/releases/tag/0.4.23">0.4.23</a> revamped the structure of the indexes and clarified the documentation! I'm closing the issue as I think it's all good now, thanks! üôè</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @mgab on 2024-10-29 14:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 04:38:49 UTC
    </footer>
</body>
</html>
