<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overly restrictive platform markers for jax/jaxlib when torch is included from torch index with CPU vs GPU &quot;--extra&quot; - astral-sh/uv #14805</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Overly restrictive platform markers for jax/jaxlib when torch is included from torch index with CPU vs GPU &quot;--extra&quot;</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/14805">#14805</a>
        opened by <a href="https://github.com/mscheltienne">@mscheltienne</a>
        on 2025-07-22 08:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mscheltienne">@mscheltienne</a></div>
            <div class="timeline-body">Summary
<p>The dependency resolution algorithm yields overly restrictive platform markers with the following <code>pyproject.toml</code>:</p>
<pre><code>[build-system]
build-backend = &#x27;setuptools.build_meta&#x27;
requires = [&#x27;setuptools &gt;= 64.0.0&#x27;]

[project]
dependencies = []
name = &#x27;test_jax_resolution&#x27;
requires-python = &#x27;&gt;=3.12&#x27;
version = &#x27;0.0.1&#x27;

[project.optional-dependencies]
cpu = [
  &#x27;jax&#x27;,
  &#x27;torch&gt;=2.7.0&#x27;,
  &#x27;torchvision&gt;=0.22.0&#x27;,
]
cu128 = [
  &#x27;jax[cuda12]&#x27;,
  &#x27;torch&gt;=2.7.0&#x27;,
  &#x27;torchvision&gt;=0.22.0&#x27;,
]

[tool.uv]
conflicts = [
  [
    {extra = &#x27;cpu&#x27;},
    {extra = &#x27;cu128&#x27;},
  ],
]
default-groups = &#x27;all&#x27;

[[tool.uv.index]]
explicit = true
name = &#x27;pytorch-cpu&#x27;
url = &#x27;https://download.pytorch.org/whl/cpu&#x27;

[[tool.uv.index]]
explicit = true
name = &#x27;pytorch-cu128&#x27;
url = &#x27;https://download.pytorch.org/whl/cu128&#x27;

[tool.uv.sources]
torch = [
  {extra = &#x27;cpu&#x27;, index = &#x27;pytorch-cpu&#x27;},
  {extra = &#x27;cu128&#x27;, index = &#x27;pytorch-cu128&#x27;},
]
torchvision = [
  {extra = &#x27;cpu&#x27;, index = &#x27;pytorch-cpu&#x27;},
  {extra = &#x27;cu128&#x27;, index = &#x27;pytorch-cu128&#x27;},
]
</code></pre>
<p>An <code>uv sync --extra cpu</code> with the above configuration yields markers for <code>jaxlib</code>: <code>marker = &quot;platform_machine == &#x27;aarch64&#x27; and sys_platform == &#x27;linux&quot;</code> which are thus excluding the current system, thus the <code>uv sync --extra cpu</code> command yields an environment where <code>jax</code> is installed.. but <code>jaxlib</code> is missing (despite being a dependency of <code>jax</code>).</p>
<p>Removing the <code>cu128</code> extra, associated index and <code>conflicts</code> resolution, thus yielding the following <code>pyproject.toml</code> is surprisingly fixing the problem:</p>
<pre><code>[build-system]
build-backend = &#x27;setuptools.build_meta&#x27;
requires = [&#x27;setuptools &gt;= 64.0.0&#x27;]

[project]
dependencies = []
name = &#x27;test_jax_resolution&#x27;
requires-python = &#x27;&gt;=3.12&#x27;
version = &#x27;0.0.1&#x27;

[project.optional-dependencies]
cpu = [
  &#x27;jax&#x27;,
  &#x27;torch&gt;=2.7.0&#x27;,
  &#x27;torchvision&gt;=0.22.0&#x27;,
]

[tool.uv]
default-groups = &#x27;all&#x27;

[[tool.uv.index]]
explicit = true
name = &#x27;pytorch-cpu&#x27;
url = &#x27;https://download.pytorch.org/whl/cpu&#x27;

[tool.uv.sources]
torch = [
  {extra = &#x27;cpu&#x27;, index = &#x27;pytorch-cpu&#x27;},
]
torchvision = [
  {extra = &#x27;cpu&#x27;, index = &#x27;pytorch-cpu&#x27;},
]
</code></pre>
<p>Now, the <code>uv sync --extra cpu</code> command correctly includes <code>jax</code> and <code>jaxlib</code>, although in version <code>0.5.3</code> instead of <code>0.6.2</code>.</p>
<p>The removal of the <code>cu128</code> extra should not have impacted the resolution of the <code>cpu</code> extra, thus this difference seems to be a bug in the dependency resolution algorithm.</p>
Platform
<p>Linux 6.14.0-24-generic x86_64 GNU/Linux</p>
Version
<p>0.8.0</p>
Python version
<p>Python 3.12.3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/mscheltienne">@mscheltienne</a> on 2025-07-22 08:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-24 13:09</div>
            <div class="timeline-body"><p>Agree that this looks like a bug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-24 13:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-24 13:20</div>
            <div class="timeline-body"><p>Replacing <code>jax[cuda12]</code> with <code>jax</code> also fixes it, so something to do with the extra.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/konstin">@konstin</a> on 2025-08-03 11:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-04 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-04 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-04 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/konstin">@konstin</a> on 2025-08-06 09:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:39:33 UTC
    </footer>
</body>
</html>
