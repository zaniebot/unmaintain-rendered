<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overly restrictive platform markers for jax/jaxlib when torch is included from torch index with CPU vs GPU &quot;--extra&quot; - astral-sh/uv #14805</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Overly restrictive platform markers for jax/jaxlib when torch is included from torch index with CPU vs GPU &quot;--extra&quot;</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/14805">#14805</a>
        opened by <a href="https://github.com/mscheltienne">@mscheltienne</a>
        on 2025-07-22 08:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/mscheltienne">@mscheltienne</a> on 2025-07-22 08:34</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>The dependency resolution algorithm yields overly restrictive platform markers with the following <code>pyproject.toml</code>:</p>
<pre><code>[build-system]
build-backend = 'setuptools.build_meta'
requires = ['setuptools &gt;= 64.0.0']

[project]
dependencies = []
name = 'test_jax_resolution'
requires-python = '&gt;=3.12'
version = '0.0.1'

[project.optional-dependencies]
cpu = [
  'jax',
  'torch&gt;=2.7.0',
  'torchvision&gt;=0.22.0',
]
cu128 = [
  'jax[cuda12]',
  'torch&gt;=2.7.0',
  'torchvision&gt;=0.22.0',
]

[tool.uv]
conflicts = [
  [
    {extra = 'cpu'},
    {extra = 'cu128'},
  ],
]
default-groups = 'all'

[[tool.uv.index]]
explicit = true
name = 'pytorch-cpu'
url = 'https://download.pytorch.org/whl/cpu'

[[tool.uv.index]]
explicit = true
name = 'pytorch-cu128'
url = 'https://download.pytorch.org/whl/cu128'

[tool.uv.sources]
torch = [
  {extra = 'cpu', index = 'pytorch-cpu'},
  {extra = 'cu128', index = 'pytorch-cu128'},
]
torchvision = [
  {extra = 'cpu', index = 'pytorch-cpu'},
  {extra = 'cu128', index = 'pytorch-cu128'},
]
</code></pre>
<p>An <code>uv sync --extra cpu</code> with the above configuration yields markers for <code>jaxlib</code>: <code>marker = &quot;platform_machine == 'aarch64' and sys_platform == 'linux&quot;</code> which are thus excluding the current system, thus the <code>uv sync --extra cpu</code> command yields an environment where <code>jax</code> is installed.. but <code>jaxlib</code> is missing (despite being a dependency of <code>jax</code>).</p>
<p>Removing the <code>cu128</code> extra, associated index and <code>conflicts</code> resolution, thus yielding the following <code>pyproject.toml</code> is surprisingly fixing the problem:</p>
<pre><code>[build-system]
build-backend = 'setuptools.build_meta'
requires = ['setuptools &gt;= 64.0.0']

[project]
dependencies = []
name = 'test_jax_resolution'
requires-python = '&gt;=3.12'
version = '0.0.1'

[project.optional-dependencies]
cpu = [
  'jax',
  'torch&gt;=2.7.0',
  'torchvision&gt;=0.22.0',
]

[tool.uv]
default-groups = 'all'

[[tool.uv.index]]
explicit = true
name = 'pytorch-cpu'
url = 'https://download.pytorch.org/whl/cpu'

[tool.uv.sources]
torch = [
  {extra = 'cpu', index = 'pytorch-cpu'},
]
torchvision = [
  {extra = 'cpu', index = 'pytorch-cpu'},
]
</code></pre>
<p>Now, the <code>uv sync --extra cpu</code> command correctly includes <code>jax</code> and <code>jaxlib</code>, although in version <code>0.5.3</code> instead of <code>0.6.2</code>.</p>
<p>The removal of the <code>cu128</code> extra should not have impacted the resolution of the <code>cpu</code> extra, thus this difference seems to be a bug in the dependency resolution algorithm.</p>
<h3>Platform</h3>
<p>Linux 6.14.0-24-generic x86_64 GNU/Linux</p>
<h3>Version</h3>
<p>0.8.0</p>
<h3>Python version</h3>
<p>Python 3.12.3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @mscheltienne on 2025-07-22 08:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-24 13:09</div>
            <div class="timeline-body"><p>Agree that this looks like a bug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2025-07-24 13:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-24 13:20</div>
            <div class="timeline-body"><p>Replacing <code>jax[cuda12]</code> with <code>jax</code> also fixes it, so something to do with the extra.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @charliermarsh by @konstin on 2025-08-03 11:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/15041.html">astral-sh/uv#15041</a> on 2025-08-03 11:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2025-08-04 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @konstin by @charliermarsh on 2025-08-04 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @charliermarsh by @charliermarsh on 2025-08-04 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-08-06 09:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:04 UTC
    </footer>
</body>
</html>
