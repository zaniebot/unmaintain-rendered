<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pip compile does not carry forward environment markers like sys_platform - astral-sh/uv #4231</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>pip compile does not carry forward environment markers like sys_platform</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/4231">#4231</a>
        opened by <a href="https://github.com/AbdealiLoKo">@AbdealiLoKo</a>
        on 2024-06-11 14:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/AbdealiLoKo">@AbdealiLoKo</a> on 2024-06-11 14:46</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

<p>If I have a item in my requirement file where I have explicitly provided env markers like <code>sys_platform</code>, it does not get carried forward in the <code>pip compile</code> output.</p>
<p>So, when I have a dependency like <code>pysqlite3-binary; sys_platform==&quot;linux&quot;</code> the pip compile removed the <code>sys_platform</code> part. WHen I use pip-tools, it was not removing that.</p>
<p>Try:</p>
<pre><code class="language-bash">$ echo &quot;pysqlite3-binary; sys_platform==\&quot;linux\&quot;&quot; | uv pip compile --verbose -
DEBUG Starting toolchain discovery for any Python
DEBUG Looking for exact match for request any Python
DEBUG Searching for Python interpreter in all sources
DEBUG Found CPython 3.8.19 at `/home/ali/.conda/envs/py38/bin/python3` (conda prefix)
DEBUG Using Python 3.8.19 interpreter at /home/ali/.conda/envs/py38/bin/python3 for builds
DEBUG Using request timeout of 30s
DEBUG Solving with installed Python version: 3.8.19
DEBUG Adding direct dependency: pysqlite3-binary{sys_platform == 'linux'}*
DEBUG Found stale response for: https://pypi.org/simple/pysqlite3-binary/
DEBUG Sending revalidation request for: https://pypi.org/simple/pysqlite3-binary/
DEBUG Found not-modified response for: https://pypi.org/simple/pysqlite3-binary/
DEBUG Searching for a compatible version of pysqlite3-binary{sys_platform == 'linux'} (*)
DEBUG Selecting: pysqlite3-binary{sys_platform == 'linux'}==0.5.3 (pysqlite3_binary-0.5.3-cp38-cp38-manylinux_2_17_x86_64.manylinux2014_x86_64.whl)
DEBUG Searching for a compatible version of pysqlite3-binary{sys_platform == 'linux'} (==0.5.3)
DEBUG Selecting: pysqlite3-binary{sys_platform == 'linux'}==0.5.3 (pysqlite3_binary-0.5.3-cp38-cp38-manylinux_2_17_x86_64.manylinux2014_x86_64.whl)
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/2a/ec/3007532ea336d705f3abc7961f1a1c89f2fa34733b625ac317eea5a935ea/pysqlite3_binary-0.5.3-cp38-cp38-manylinux_2_17_x86_64.manylinux2014_x86_64.whl.metadata
DEBUG Searching for a compatible version of pysqlite3-binary (==0.5.3)
DEBUG Selecting: pysqlite3-binary==0.5.3 (pysqlite3_binary-0.5.3-cp38-cp38-manylinux_2_17_x86_64.manylinux2014_x86_64.whl)
DEBUG Tried 1 versions: pysqlite3-binary 1
Resolved 1 package in 104ms
# This file was autogenerated by uv via the following command:
#    uv pip compile -
pysqlite3-binary==0.5.3
</code></pre>
<p>And my version:</p>
<pre><code>$ uv version
uv 0.2.10
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-11 14:47</div>
            <div class="timeline-body"><p>This is a duplicate of #1429.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-06-11 14:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-11 14:50</div>
            <div class="timeline-body"><p>As an aside: what <code>pip-compile</code> is doing there is not really safe (as in, you should not rely on those markers). Consider <code>flask ; python_version &gt; '3.8'</code> as your input. <code>pip-compile</code> will resolve to:</p>
<pre><code>blinker==1.8.2
    # via flask
click==8.1.7
    # via flask
flask==3.0.3 ; python_version &gt; &quot;3.8&quot;
    # via -r req.in
itsdangerous==2.2.0
    # via flask
jinja2==3.1.4
    # via flask
markupsafe==2.1.5
    # via
    #   jinja2
    #   werkzeug
werkzeug==3.0.3
    # via flask
</code></pre>
<p>So the marker is only applied to the direct dependency, not any of its downstream dependencies. Retaining the markers leads to a resolution that is still incorrect on all other platforms.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AbdealiLoKo">@AbdealiLoKo</a> on 2024-06-11 17:30</div>
            <div class="timeline-body"><ol>
<li>Thanks for the note on duplicate. For some reason I did not find it ! Probably searched for the wrong keywords</li>
<li>Hmm, you're right on pip-compile. Luckily I happen to use it only for this 1 dep which does not provide osx wheels and it doesn't have any other deps !</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">duplicate</span> added by @zanieb on 2024-06-11 17:36</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:58 UTC
    </footer>
</body>
</html>
