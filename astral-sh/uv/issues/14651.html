<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pinning a package to the default index (PyPI) - astral-sh/uv #14651</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Pinning a package to the default index (PyPI)</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/14651">#14651</a>
        opened by <a href="https://github.com/dmrauch">@dmrauch</a>
        on 2025-07-16 13:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dmrauch">@dmrauch</a> on 2025-07-16 13:32</div>
            <div class="timeline-body"><h3>Question</h3>
<p>Hi!</p>
<p>First of all, thanks so much for this amazing tool - managing Python projects has truly become a joy!</p>
<p>I couldn't find a closely related issue - hope that's not an oversight on my part.</p>
<p>I am using PyPI as the default index in combination with an additional private index. For one open source package (<code>package1</code>) that is provided via PyPI, we needed to create a one-off special version in our private index a few years ago. Of course, this version is far outdated, and we are now using a more up-to-date version from PyPI.</p>
<p>However, because there is one version of that package available on the private index - which when using the default <code>index-strategy = &quot;first-index&quot;</code> takes precedence over the default index - we are stuck with the outdated version.</p>
<p>I see two ways around this - but was wondering about a third strategy that I'd prefer over the other for reasons I'll state below:</p>
<ol>
<li>Use <code>index-strategy = &quot;unsafe-best-match&quot;</code>: This works and we pick a more up-to-date version from PyPI - but this would open the door for dependency confusion attacks</li>
<li>Set <code>explicit = true</code> on the private index definition in <code>[[tool.uv.index]]</code>: We have &gt;20 internal packages and tbh, I'd like to avoid having to pin all of them in every single <code>pyproject.toml</code></li>
</ol>
<p>So the possibility of pinning a package to a particular index via <code>[tool.uv.sources]</code> caught my attention and I tried</p>
<pre><code class="language-toml">[tool.uv.sources]
package1 = { index = &quot;default&quot; }
</code></pre>
<p>but unfortunately this doesn't seem to work. What does seem to work, however, is configuring PyPI as a custom default index and then pinning the package to it:</p>
<pre><code class="language-toml">[[tool.uv.index]]
name = &quot;pypi&quot;
url = &quot;https://pypi.org/simple&quot;
default = true

[tool.uv.sources]
package1 = { index = &quot;pypi&quot; }
</code></pre>
<p>My questions:</p>
<ul>
<li>Is this a correct and expected representation of the intended behaviour?</li>
<li>Am I missing anything why <code>package1 = { index = &quot;default&quot; }</code> wouldn't work?</li>
<li>How would you feel about allowing <code>package1 = { index = &quot;default&quot; }</code> to avoid having to re-configure PyPI as a custom default index?</li>
</ul>
<p>Many thanks!</p>
<h3>Platform</h3>
<p>macOS: Darwin 24.5.0 arm64</p>
<h3>Version</h3>
<p>uv 0.7.20 (251420396 2025-07-09)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @dmrauch on 2025-07-16 13:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-16 13:42</div>
            <div class="timeline-body"><p>Thanks for the kind words. I think everything you've written here is correct. You might already be doing it, but I'd probably put the <code>[[tool.uv.index]]</code> for the default PyPI index <em>after</em> your private index definition to make sure the private index is consulted first.</p>
<p>I'm a little hesitant to add <code>index = &quot;default&quot;</code> or similar as a special-case because there's some ambiguity to it. Does that always refer to PyPI? Or to whichever index is marked as <code>default = true</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2025-07-16 13:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dmrauch">@dmrauch</a> on 2025-07-16 14:00</div>
            <div class="timeline-body"><p>Thanks for the quick follow-up!</p>
<p>But just to be sure about the docs - <a href="https://docs.astral.sh/uv/concepts/indexes/#defining-an-index">Defining an index</a>:</p>
<blockquote>
<p>The default index is always treated as lowest priority, regardless of its position in the list of indexes.</p>
</blockquote>
<p>So the order in which I specify the indices in the <code>pyproject.toml</code> shouldn't matter, given that I configure PyPI with <code>default = true</code>?</p>
<pre><code class="language-toml">[[tool.uv.index]]
name = &quot;pypi&quot;
url = &quot;https://pypi.org/simple&quot;
default = true

[[tool.uv.index]]
name = &quot;private-index&quot;
url = &quot;https://some.where/simple&quot;
</code></pre>
<p>Regarding the aspect of ambiguity - yeah, I get that. Personally, I'd feel the natural thing to do would be to use whichever index effectively is the default index, keeping in mind that e.g. <code>uv sync</code> has a <code>--default-index</code> argument. This in fact is how why I kind of expected <code>index = &quot;default&quot;</code> to work - since I somehow had the impression that <em>default</em> was a kind of &quot;reserved word&quot; for this special status already. But that's perhaps just my intuition and not self-evident.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dmrauch">@dmrauch</a> on 2025-07-17 15:53</div>
            <div class="timeline-body"><p>Unfortunately, this doesn't seem to work reliably. Despite pinning <code>package1</code> to the custom default index <code>pypi</code>, I often get errors such as</p>
<pre><code>  √ó No solution found when resolving dependencies for split (python_full_version &gt;= '3.13'):
  ‚ï∞‚îÄ‚ñ∂ Because only package1==5.7.0 is available and private-package&gt;=1.11.1 depends on package1==5.9.4, we can conclude that private-package&gt;=1.11.1 cannot be used.
</code></pre>
<p>What makes me wonder is that <code>package1==5.7.0</code> is precisely the version of the one-off artifact that is available in our private package index. So uv seems to be finding <code>package1</code> in the private index - despite the fact that I configured</p>
<pre><code>[[tool.uv.index]]
name = &quot;pypi&quot;
url = &quot;https://pypi.org/simple&quot;
default = true

[[tool.uv.index]]
name = &quot;private-index&quot;
url = &quot;https://some.where/simple&quot;

[tool.uv.sources]
package1 = { index = &quot;pypi&quot; }
</code></pre>
<p>So in my understanding it should never look for that package in the private index at all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-17 16:41</div>
            <div class="timeline-body"><p>Apologies, the docs are right and I was wrong. The order shouldn't matter if one is marked as <code>default = true</code>.</p>
<p>Are you able to create a reproducible example? You can use <code>https://test.pypi.org/</code> in lieu of your private index if necessary.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @charliermarsh on 2025-07-21 01:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dmrauch">@dmrauch</a> on 2025-08-02 17:16</div>
            <div class="timeline-body"><p>Hi @charliermarsh - sorry this took a while! Thanks for your hint with <code>test.pypi.org</code> - I believe I have found a situation that reproduces what I describe above:</p>
<ul>
<li><code>dvc-pandas</code> has versions 0.0.1 - 0.3.3 on <code>pypi.org</code> and only versions 0.0.1 - 0.0.5 on <code>test.pypi.org</code>.<ul>
<li>Not pinning it to <code>pypi.org</code> (explicitly defined and configured as the default index) produces the expected and desired error message warning against dependency confusion attacks</li>
<li>Pinning it to <code>pypi.org</code> works fine with <code>dvc-pandas = { index = &quot;pypi&quot; }</code> - so all seems to be good for direct dependencies</li>
</ul>
</li>
<li><code>dvc-pandas</code> depends on <code>appdirs</code>, which has version 1.4.4 on <a href="https://test.pypi.org/simple/appdirs/"><code>test.pypi.org</code></a> (appears to be yanked, though) and versions 1.1.0 - 1.4.4 on <a href="https://pypi.org/simple/appdirs/"><code>pypi.org</code></a></li>
</ul>
<p>Now, when I run <code>uv sync</code> (uv version 0.8.4) with the following <code>pyproject.toml</code>:</p>
<pre><code>[build-system]
requires = [&quot;setuptools&quot;, &quot;setuptools-scm&quot;]
build-backend = &quot;setuptools.build_meta&quot;

[project]
name = &quot;additional-package-index&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.10&quot;
dependencies = [&quot;dvc-pandas ==0.3.3&quot;]

[[tool.uv.index]]
name = &quot;pypi&quot;
url = &quot;https://pypi.org/simple&quot;
default = true

[[tool.uv.index]]
name = &quot;pypi-test&quot;
url = &quot;https://test.pypi.org/simple&quot;
explicit = false

[tool.uv.sources]
appdirs = { index = &quot;pypi&quot; }
dvc-pandas = { index = &quot;pypi&quot; }
</code></pre>
<p>I get</p>
<pre><code>  √ó No solution found when resolving dependencies for split (python_full_version &gt;= '3.12'):
  ‚ï∞‚îÄ‚ñ∂ Because only appdirs==1.4.4 is available and appdirs==1.4.4 was yanked, we can conclude that appdirs==1.4.4 cannot be used.
      And because dvc-pandas==0.3.3 depends on appdirs==1.4.4 and your project depends on dvc-pandas==0.3.3, we can conclude that your project's requirements are unsatisfiable.

      hint: `appdirs` was found on https://test.pypi.org/simple, but not at the requested version (appdirs&gt;1.4.4). A compatible version may be available on a subsequent index (e.g., https://pypi.org/simple). By default, uv will only consider versions
      that are published on the first index that contains a given package, to avoid dependency confusion attacks. If all indexes are equally trusted, use `--index-strategy unsafe-best-match` to consider all versions from all indexes, regardless of the
      order in which they were defined.
</code></pre>
<p>So it appears that uv still tries to get <code>appdirs</code> from <code>test.pypi.org</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-02 20:13</div>
            <div class="timeline-body"><p>Ohh, we don't support index pinning for indirect dependencies. Maybe that's what you're running into? See https://github.com/astral-sh/uv/issues/8253.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dmrauch">@dmrauch</a> on 2025-08-03 17:42</div>
            <div class="timeline-body"><p>Yeah, it indeed seems like it. I had already found that adding version vetos for the packages that have one-off versions on the private index mitigated the situation in my case. Just mentioning the packages in a dedicated dependency group (without forbidding the affected versions) works just as fine. Thanks for the pointer to the other ticket, I'll leave a +1 there.</p>
<p>And many thanks for your support, greatly appreciated! üôè</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-04 12:40</div>
            <div class="timeline-body"><p>Thank you, merging into that other issue!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-08-04 12:40</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:04 UTC
    </footer>
</body>
</html>
