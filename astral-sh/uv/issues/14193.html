<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv sync fails on circular optional dependencies when installing from source - astral-sh/uv #14193</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>uv sync fails on circular optional dependencies when installing from source</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/14193">#14193</a>
        opened by <a href="https://github.com/sveinse">@sveinse</a>
        on 2025-06-21 22:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/sveinse">@sveinse</a> on 2025-06-21 22:12</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I have an issue running <code>uv sync</code> for a project that have circular dependencies in its optional extras, and where the dependencies refer to GitHub sources. It fails with &quot;Requirements contain conflicting URLs for package ... in all marker environments`.</p>
<p>What happens is that the local package <code>pkgb</code> has an optional dependency to <code>pkga</code> with GH URL. <code>pkga</code> depends on <code>pkgb</code> on GH URL.</p>
<p>Is there a simple way to circumvent this? Preferably in the sources and not by the installing user. Because <code>uv sync</code> is checking even on &quot;extra-less&quot; installs, every user installing this package from source will be hit with this issue.</p>
<h3>Setup</h3>
<p>I have setup a package <code>pkga</code> which depend on <code>pkgb @git+https://github.com/sveinse/pkgb.git</code>. See repo https://github.com/sveinse/pkga/blob/main/pyproject.toml</p>
<pre><code class="language-toml">[project]
name = &quot;pkga&quot;
dependencies = [
    &quot;pkgb @git+https://github.com/sveinse/pkgb.git&quot;
]
</code></pre>
<p>The <code>pkgb</code> repo depends <strong>optionally</strong> to <code>pkga @git+https://github.com/sveinse/pkga.git</code>. See https://github.com/sveinse/pkgb/blob/main/pyproject.toml</p>
<pre><code class="language-toml">[project]
name = &quot;pkgb&quot;
dependencies = []

[project.optional-dependencies]
dev = [
    &quot;pkga @git+https://github.com/sveinse/pkga.git&quot;
]
</code></pre>
<h3>Repro</h3>
<ol>
<li><code>git clone https://github.com/sveinse/pkgb.git</code></li>
<li><code>uv sync --verbose</code>. See response below</li>
</ol>
<pre><code>$ uv sync --verbose
DEBUG uv 0.7.13 (62ed17b23 2025-06-12)
DEBUG Found project root: `C:\sveinse\uv-issue\pkgb`
DEBUG No workspace root found, using project root
DEBUG Acquired lock for `C:\sveinse\uv-issue\pkgb`
DEBUG Reading Python requests from version file at `C:\sveinse\uv-issue\pkgb\.python-version`
DEBUG Using Python request `3.13` from version file at `.python-version`
DEBUG Checking for Python environment at `.venv`
DEBUG Searching for Python 3.13 in managed installations, search path, or registry
DEBUG Searching for managed installations at `C:\Users\sveinse\AppData\Roaming\uv\python`
DEBUG Python interpreter in the registry is not executable: `Software\Python\PythonCore\2.7
DEBUG Found `cpython-3.13.1-windows-x86_64-none` at `C:\Users\sveinse\AppData\Local\Programs\Python\Python313\python.exe` (registry)
Using CPython 3.13.1 interpreter at: C:\Users\sveinse\AppData\Local\Programs\Python\Python313\python.exe
Creating virtual environment at: .venv
DEBUG Using base executable for virtual environment: C:\Users\sveinse\AppData\Local\Programs\Python\Python313\python.exe
DEBUG Released lock at `C:\Users\sveinse\AppData\Local\Temp\uv-d1559711b0b131ba.lock`
DEBUG Acquired lock for `.venv`
DEBUG Using request timeout of 30s
DEBUG Found static `pyproject.toml` for: pkgb @ file:///C:/sveinse/uv-issue/pkgb
DEBUG No workspace root found, using project root
DEBUG Ignoring existing lockfile due to mismatched extras for: `pkgb==0.1.0`
  Requested: {ExtraName(&quot;dev&quot;)}
  Existing: {}
DEBUG Attempting GitHub fast path for: pkga @ git+https://github.com/sveinse/pkga.git
DEBUG Querying GitHub for commit at: https://api.github.com/repos/sveinse/pkga/commits/HEAD
DEBUG Attempting to fetch `pyproject.toml` from: https://raw.githubusercontent.com/sveinse/pkga/650c658383d0fce2c9653fae1df40ec6c5f00bea/pyproject.toml
DEBUG Found static metadata via GitHub fast path for: pkga @ git+https://github.com/sveinse/pkga.git
DEBUG Attempting GitHub fast path for: pkgb @ git+https://github.com/sveinse/pkgb.git
DEBUG Querying GitHub for commit at: https://api.github.com/repos/sveinse/pkgb/commits/HEAD
DEBUG Attempting to fetch `pyproject.toml` from: https://raw.githubusercontent.com/sveinse/pkgb/de73b8c9901f24d9646db7237b208f85ab4a5b2a/pyproject.toml
DEBUG Found static metadata via GitHub fast path for: pkgb @ git+https://github.com/sveinse/pkgb.git
DEBUG Solving with installed Python version: 3.13.1
DEBUG Solving with target Python version: &gt;=3.13
DEBUG Adding direct dependency: pkgb[dev]*
DEBUG Searching for a compatible version of pkgb @ file:///C:/sveinse/uv-issue/pkgb (*)
DEBUG Adding direct dependency: pkgb==0.1.0
DEBUG Adding direct dependency: pkgb[dev]==0.1.0
DEBUG Searching for a compatible version of pkgb @ file:///C:/sveinse/uv-issue/pkgb (==0.1.0)
DEBUG Searching for a compatible version of pkgb @ file:///C:/sveinse/uv-issue/pkgb (==0.1.0)
DEBUG Adding direct dependency: pkga*
DEBUG Searching for a compatible version of pkga @ git+https://github.com/sveinse/pkga.git (*)
DEBUG Released lock at `C:\sveinse\uv-issue\pkgb\.venv\.lock`
error: Requirements contain conflicting URLs for package `pkgb` in all marker environments:
- C:\sveinse\uv-issue\pkgb
- git+https://github.com/sveinse/pkgb.git
</code></pre>
<h3>Platform</h3>
<p>Win 11 x86</p>
<h3>Version</h3>
<p>uv 0.7.13 (62ed17b23 2025-06-12)</p>
<h3>Python version</h3>
<p>Python 3.13.1</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @sveinse on 2025-06-21 22:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-06-22 13:53</div>
            <div class="timeline-body"><p>Why do you have a circular dependency, should instead one of the packages be broken into two to remove the cycle?</p>
<p>One option would be to turn <code>dev</code> from an extra into a dependency group, which is not used in dependency resolution.</p>
<p>You can use a dependency override (https://docs.astral.sh/uv/reference/settings/#override-dependencies) to force a specific URL, such as a local file URL, but it requires an absolute path for the <code>file:///</code> URL so it's somewhat suboptimal.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sveinse">@sveinse</a> on 2025-06-22 19:16</div>
            <div class="timeline-body"><p>These are two packages that already exists and they used to work perfectly with pip. The optional dependency that creates the circular dependency is a little used extra option for validating the module during development.</p>
<p>It was a great hint to move the dependency into a dependency-group, because that's what it really is. However this do not work with uv. It still fails.</p>
<pre><code class="language-toml">[dependency-groups]
update = [
   &quot;pkga @git+https://github.com/sveinse/pkga.git&quot;
]

[tool.uv]
default-groups = []
</code></pre>
<p>That being said, pip has also stated to fail on this circular reference, both as extra and as group. So I'm inclined to think that this use case is moot. Need to find another way to specify this auxiliary dependency without breaking pip or uv.</p>
<p>PS! I wonder, would this construct work without the <code>@git</code> references?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @konstin on 2025-06-22 19:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @konstin on 2025-06-22 19:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-06-22 19:41</div>
            <div class="timeline-body"><blockquote>
<p>PS! I wonder, would this construct work without the <code>@git</code> references?</p>
</blockquote>
<p>uv accepts dependency cycles, but it requires that for each package (on each platform), there is only URL, be a file path, git or https. With the git reference, it can't tell that the project you're currently developing locally refers to the same project as the git URL and errors.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sveinse">@sveinse</a> on 2025-06-27 08:45</div>
            <div class="timeline-body"><p>I redid the packages by removing the <code>@git</code> dependencies, and it works fine now. So for that aspect of it, I think the issue can be closed. Not related to uv, it turns out that python packaging with the use direct URLs instead of package index is cumbersome.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-06-27 09:42</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:28 UTC
    </footer>
</body>
</html>
