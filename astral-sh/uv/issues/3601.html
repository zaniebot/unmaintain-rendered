<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv run can install two versions of the same package (and forces upgrades) - astral-sh/uv #3601</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv run can install two versions of the same package (and forces upgrades)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/3601">#3601</a>
        opened by <a href="https://github.com/henryiii">@henryiii</a>
        on 2024-05-15 04:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/henryiii">@henryiii</a></div>
            <div class="timeline-body"><p>I was trying out different versions of pytest with a pytest plugin to see when it was broken. I mentally was thinking of <code>uv run</code> as the Python launcher for UNIX, a way to avoid activating a venv (<code>py</code> instead of <code>.venv/bin/python</code>). It seems to do some installing automatically - including three strange things:</p>
<pre><code>$ uv venv
$ uv pip install -e .
$ uv pip install &#x27;pytest==7.0.*&#x27;
$ uv run pytest
warning: `uv run` is experimental and may change without warning.
Resolved 5 packages in 8ms
   Built pytest-github-actions-annotate-failures @ file:///Users/henryschreiner/git/software/pytest-github-actions-annotate-failures                                                                    Downloaded 1 package in 1.25s
Installed 2 packages in 33ms
 - pytest==7.0.1
 + pytest==8.2.0
 - pytest-github-actions-annotate-failures==0.2.0 (from file:///Users/henryschreiner/git/software/pytest-github-actions-annotate-failures)
 + pytest-github-actions-annotate-failures==0.2.0 (from file:///Users/henryschreiner/git/software/pytest-github-actions-annotate-failures)
... pytest output ...
</code></pre>
<p>At this point, I hadn&#x27;t noticed it had forcibly upgraded the pytest I was testing to the latest version, so I thought 7.0.x worked. (Some else in parallel found it was 7.4 that broke us).</p>
<p>Then the next line caught me by surprise, it uninstalls two pytests:</p>
<pre><code>$ uv pip install &#x27;pytest==6.*&#x27;
Resolved 7 packages in 145ms
Downloaded 2 packages in 68ms
Installed 2 packages in 6ms
 - pytest==7.0.1
 - pytest==8.2.0
 + pytest==6.2.5
 + toml==0.10.2
</code></pre>
<p>And finally, the final <code>uv run</code> actually works just fine, and doesn&#x27;t upgrade pytest:</p>
<pre><code>$ uv run pytest
... pytest output ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-15 04:16</div>
            <div class="timeline-body"><p>Thanks. To be clear, I wouldn&#x27;t recommend <code>uv run</code> for &quot;real&quot; use yet but I do appreciate bug reports. Are you able to reproduce the double-uninstall reliably?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2024-05-15 06:20</div>
            <div class="timeline-body"><p>Same sequence does do it again:</p>
<pre><code>$ uv venv
$ uv pip install &#x27;pytest==7.0.*&#x27;
$ uv run pytest
$ uv pip list
Package                                 Version
--------------------------------------- -------
attrs                                   23.2.0
iniconfig                               2.0.0
packaging                               24.0
pluggy                                  1.5.0
py                                      1.11.0
pytest                                  7.0.1
pytest                                  8.2.0
pytest-github-actions-annotate-failures 0.2.0
tomli                                   2.0.1
</code></pre>
<p>The editible install line can be skipped, same result. Using checkout of https://github.com/pytest-dev/pytest-github-actions-annotate-failures.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-15 12:56</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-15 12:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-05-15 13:13</div>
            <div class="timeline-body"><p>@charliermarsh this looks like it might be because we use <code>EmptyInstalledPackages</code> in <code>resolve</code> instead of passing the <code>SitePackages</code> we grabbed earlier.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-15 14:35</div>
            <div class="timeline-body"><p>Thanks @zanieb.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-15 14:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-15 14:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2024-05-15 14:48</div>
            <div class="timeline-body"><blockquote>
<p>To be clear, I wouldn&#x27;t recommend uv run for &quot;real&quot; use yet</p>
</blockquote>
<p>If it were finished, where would the fun be in me using it? ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-15 15:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:31:09 UTC
    </footer>
</body>
</html>
