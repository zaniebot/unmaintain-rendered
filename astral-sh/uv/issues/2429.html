<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv` should exclude `abi3` wheels in free-threaded Python 3.13+ - astral-sh/uv #2429</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>`uv` should exclude `abi3` wheels in free-threaded Python 3.13+</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/2429">#2429</a>
        opened by <a href="https://github.com/colesbury">@colesbury</a>
        on 2024-03-13 20:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/colesbury">@colesbury</a> on 2024-03-13 20:57</div>
            <div class="timeline-body"><p>Starting with the version 3.13 alpha releases, CPython can optionally be configured to run without the global interpreter lock. This build configuration (&quot;free-threaded&quot;) is not compatible with <code>abi3</code> wheels.</p>
<p>Additionally, the version specific wheels require the &quot;t&quot; suffix in the ABI tag. For example, <code>cp313-cp313t-manylinux_2_35_x86_64</code> (free-threaded build) instead of <code>cp313-cp313-manylinux_2_35_x86_64</code> (default 3.13 build).</p>
<h3>Steps to reproduce issue</h3>
<ol>
<li>Build python from <a href="https://github.com/python/cpython">source</a> with <code>--disable-gil</code></li>
<li><code>uv venv</code>, <code>source .venv/bin/activate</code></li>
<li><code>uv pip install psutil</code></li>
<li><code>python -c &quot;import psutil&quot;</code> Segmentation fault (core dumped)</li>
</ol>
<h3>Identifying <code>--disable-gil</code> CPython builds</h3>
<p>I think the best way is to check if <code>sysconfig.get_config_var(&quot;Py_GIL_DISABLED&quot;)</code> returns <code>True</code>.</p>
<p><a href="https://github.com/pypa/packaging/blob/e0dda88874e73cd484b9e8464c5921a903db3cf0/src/packaging/tags.py#L138"><code>packaging.tags</code></a> instead checks for a &quot;t&quot; in <code>sys.abiflags</code>, but this is because of constraints on the public API exposed by the package. I think using <code>sysconfig</code> is likely a better option for <code>uv</code>.</p>
<h3>See also:</h3>
<ul>
<li>https://github.com/pypa/packaging/blob/e0dda88874e73cd484b9e8464c5921a903db3cf0/src/packaging/tags.py#L229-L230</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-03-13 21:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-13 21:00</div>
            <div class="timeline-body"><p>Awesome, thank you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-13 23:12</div>
            <div class="timeline-body"><p>@konstin - Interested in this one?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @konstin by @konstin on 2024-03-14 09:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/2805.html">astral-sh/uv#2805</a> on 2024-04-03 13:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-04-03 13:29</div>
            <div class="timeline-body"><p>@colesbury What is the canonical name for this feature, &quot;no-gil python&quot;, &quot;gil disabled&quot; or &quot;free-threaded python&quot;?</p>
<p>As a more technical question, is psutil expected to still error when built from source with python 3.13.0a5? (I can built from main too if that's better)</p>
<p><strong>uv</strong></p>
<pre><code>$ uv venv -q -p python3.13 .venv3.13 --no-cache-dir &amp;&amp; uv pip install psutil --no-cache-dir &amp;&amp; .venv3.13/bin/python -c &quot;import psutil&quot;
Resolved 1 package in 206ms
Downloaded 1 package in 90ms
Installed 1 package in 1ms
 + psutil==5.9.8
Segmentation fault (core dumped)
</code></pre>
<p><strong>pip</strong></p>
<pre><code>$ cargo run -q -- venv -q -p python3.13 .venv3.13 --no-cache-dir &amp;&amp; cargo run -q -- pip install psutil --no-cache-dir &amp;&amp; .venv3.13/bin/python -c &quot;import psutil&quot;
Resolved 1 package in 225ms
   Built psutil==5.9.8                                                                                                                                                                                                                                                                                                                                                                                                           Downloaded 1 package in 1.51s
Installed 1 package in 0.78ms
 + psutil==5.9.8
Traceback (most recent call last):
  File &quot;&lt;string&gt;&quot;, line 1, in &lt;module&gt;
    import psutil
  File &quot;/home/konsti/projects/uv/.venv3.13/lib/python3.13/site-packages/psutil/__init__.py&quot;, line 102, in &lt;module&gt;
    from . import _pslinux as _psplatform
  File &quot;/home/konsti/projects/uv/.venv3.13/lib/python3.13/site-packages/psutil/_pslinux.py&quot;, line 25, in &lt;module&gt;
    from . import _psutil_linux as cext
ImportError: /home/konsti/projects/uv/.venv3.13/lib/python3.13/site-packages/psutil/_psutil_linux.abi3.so: undefined symbol: _Py_atomic_add_ssize
</code></pre>
<p>If yes, here's a PR implementing the <code>t</code> abiflag: https://github.com/astral-sh/uv/pull/2805</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-04-03 13:39</div>
            <div class="timeline-body"><blockquote>
<p>@colesbury What is the canonical name for this feature, &quot;no-gil python&quot;, &quot;gil disabled&quot; or &quot;free-threaded python&quot;?</p>
</blockquote>
<p>Not Sam, but as per the Steering Council decision, the canonical name is &quot;free-threaded Python&quot;: https://github.com/python/steering-council/issues/221#issuecomment-1841593283.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/colesbury">@colesbury</a> on 2024-04-03 20:21</div>
            <div class="timeline-body"><blockquote>
<p>As a more technical question, is psutil expected to still error when built from source with python 3.13.0a5...</p>
</blockquote>
<p>Oof... yeah I think that's something we need to fix either in CPython or in psutil</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2024-04-12 09:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:18 UTC
    </footer>
</body>
</html>
