<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Can't use uv docker image as a command-line tool - astral-sh/uv #8635</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Can't use uv docker image as a command-line tool</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/8635">#8635</a>
        opened by <a href="https://github.com/mjpieters">@mjpieters</a>
        on 2024-10-28 13:31
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/mjpieters">@mjpieters</a> on 2024-10-28 13:31</div>
            <div class="timeline-body"><p>Given that the documentation suggests that you <a href="https://docs.astral.sh/uv/guides/integration/docker/#running-uv-in-a-container"><em>can</em> use the docker container as a command-line tool</a> I found it very surprising that you can't, in fact, use <code>uv</code> in this manner:</p>
<pre><code class="language-sh">$ uv lock  # ensure there is an up-to-date lockfile
docker run --rm \
      --mount type=bind,source=&quot;$(pwd)&quot;,destination=/app --mount destination=/app/.venv \         
      ghcr.io/astral-sh/uv:latest \
           --directory /app -vv tree
    0.000473s DEBUG uv uv 0.4.27
    0.001380s DEBUG uv_workspace::workspace Found workspace root: `/app`
    0.001392s DEBUG uv_workspace::workspace Adding current workspace member: `/app`
    0.001800s DEBUG uv_python::discovery Searching for Python &gt;=3.12 in managed installations or system path
    0.001841s DEBUG uv_python::discovery Searching for managed installations at `/.local/share/uv/python`
error: Could not read ELF interpreter from any of the following paths: /bin/sh, /usr/bin/env, /bin/dash, /bin/ls
</code></pre>
<p>The <code>tree</code> command should not require a Python interpreter (see #8634), but the <code>ELF</code> error here is especially confusing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-28 13:36</div>
            <div class="timeline-body"><p>We are attempting to sniff the platform to determine which managed installations are relevant. We might be able to fix that, I'm not quite sure how though.</p>
<p>You probably want one of the images that isn't distroless.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-10-28 13:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-28 13:37</div>
            <div class="timeline-body"><p>cc @konstin should we set an environment variable in the distroless images for glibc? (or something else?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-10-28 16:14</div>
            <div class="timeline-body"><p>We can't reliably sniff the glibc version from inside the container, at least if we want to also provision Python. What about something like <code>-e UV_LIBC=&quot;$(/lib/ld-linux.so.2 --version)&quot;</code>/<code>-e UV_LIBC=&quot;$(/lib/ld-musl-x86_64.so.1 --version)&quot;</code> (is there a platform independent one?) for docker where you pass in the context and we parse our the right libc kind and version?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mjpieters">@mjpieters</a> on 2024-10-28 17:01</div>
            <div class="timeline-body"><p>Note that on MacOS, with Docker Desktop, docker itself runs inside a virtualised linux emulator, and so you can't trivially access <code>/lib/ld-linux.so.2</code> or <code>/lib/ld-musl-x86_64.so.1</code> from the host OS, at least not trivially.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-10-28 18:52</div>
            <div class="timeline-body"><p>Does that mean you want to use the docker uv with a host mac os python, not another linux Python?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-29 13:53</div>
            <div class="timeline-body"><blockquote>
<p>docker run --rm -it ghcr.io/astral-sh/uv:latest /bin/sh
If this command fails, it means that the image itself may have problems.</p>
</blockquote>
<p>That will always fail, and not because our image has problems — the image is distroless and only contains the uv binary.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2024-10-30 02:02</div>
            <div class="timeline-body"><blockquote>
<p>You probably want one of the images that isn't distroless.</p>
</blockquote>
<p>^this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mjpieters">@mjpieters</a> on 2024-11-06 10:57</div>
            <div class="timeline-body"><blockquote>
<p>Does that mean you want to use the docker uv with a host mac os python, not another linux Python?</p>
</blockquote>
<p>Exactly. But, we'll use <code>uv</code> locally, instead.</p>
<p>(To be exact: <code>uv</code> is used to manage venvs inside docker containers, but for certain operations having <code>uv</code> run locally is just much much nicer, given how fast the tool is).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/11052.html">astral-sh/uv#11052</a> on 2025-01-29 08:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codethief">@codethief</a> on 2025-03-27 22:27</div>
            <div class="timeline-body"><p>For other people (like me) who ended up here through their favorite search engine and need some context: The error message</p>
<pre><code>&gt; error: Could not read ELF interpreter from any of the following paths: /bin/sh, /usr/bin/env, /bin/dash, /bin/ls
</code></pre>
<p>is defined <a href="https://github.com/astral-sh/uv/blob/6a13e4ceddf983e55b12e0bf5d0c354301e9e809/crates/uv-python/src/libc.rs#L37">here</a> and <a href="https://github.com/astral-sh/uv/blob/6a13e4ceddf983e55b12e0bf5d0c354301e9e809/crates/uv-python/src/libc.rs#L205">is emitted when</a> the path to the linker / <code>ld</code> cannot be determined from looking at the binaries <code>&quot;/bin/sh&quot;, &quot;/usr/bin/env&quot;, &quot;/bin/dash&quot;, &quot;/bin/ls&quot;</code>. This might happen when the binaries are not present (e.g. when building a Docker image from scratch or using a distroless image, see above) or when they are statically linked, e.g.:</p>
<pre><code>$ file /bin/sh
&gt; /bin/sh: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, BuildID[sha1]=96ee037a361464bb7e73dd6bcf0e37e63dc85dd6, not stripped
</code></pre>
<p>(This is what I ran into – I'm on NixOS.)</p>
<p>One (likely temporary) workaround can be to not have uv install Python in the first place and install it through some other means, e.g.</p>
<pre><code>export UV_NO_MANAGED_PYTHON=true
export UV_SYSTEM_PYTHON=true
uv sync  # Won't try to find ld now
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">error messages</span> added by @zanieb on 2025-03-28 02:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @zanieb on 2025-03-28 02:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-28 02:56</div>
            <div class="timeline-body"><p>We should improve this error message, at least.</p>
<p>cc @geofft on what our behavior should be on NixOS</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/declension">@declension</a> on 2025-03-31 15:44</div>
            <div class="timeline-body"><p>I'm running into a similar problem within a small Nix derivation (itself in a Flake), one that calls <code>uv lock --locked</code>. The workaround from @codethief doesn't help (explanation is useful though, thanks!); still it wants to probe those files and I can't find a workaround currently.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codethief">@codethief</a> on 2025-04-02 10:02</div>
            <div class="timeline-body"><p>@declension Even with my workaround from above (i.e. using a system-installed Python instance) I ended up running into issues when using uv to install certain pip packages that include binaries. In the end, I just enabled <a href="https://github.com/nix-community/nix-ld">nix-ld</a> in my system config to provide both uv and the packages it installs with a somewhat standard environment to run in and so far that seems to be doing the trick. Maybe that could help you, too?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/declension">@declension</a> on 2025-04-04 08:17</div>
            <div class="timeline-body"><p>Thanks @codethief. I'm not on NixOS though so not sure if / how that'd help me.
Either way, I hacked a workaround [to run <code>uv lock --locked</code> as required] via <a href="https://ryantm.github.io/nixpkgs/builders/special/fhs-environments/"><code>buildFHSUserEnv</code></a> that seems to be a step forwards (has its own issues now though). I'm guess it could be improved too:</p>
<pre><code class="language-nix">let
  customUv = pkgs.buildFHSUserEnv {
    name = &quot;uv&quot;;
    targetPkgs = pkgs: [pkgs.uv pkgs.python3];
    runScript = &quot;uv&quot;;
  };
in
  pkgs.runCommandLocal &quot;uv-lock&quot; {
    inherit src;
    nativeBuildInputs = [customUv];
  } ''
    cd ${./.}
    ${customUv}/bin/uv --help  # or whatever
    exit 1  # to debug output
  '';
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/13549.html">astral-sh/uv#13549</a> on 2025-05-20 07:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-05-29 17:40</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/uv/commit/08f2fa48ff5af4dfd422cfa0ccc8b36499bbf149 doesn't change the behavior here, but it at least improves the error message:</p>
<pre><code>error: Failed to discover managed Python installations
  Caused by: Failed to determine the libc used on the current platform
  Caused by: Failed to find any common binaries to determine libc from: /bin/sh, /usr/bin/env, /bin/dash, /bin/ls
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> removed by @konstin on 2025-05-30 08:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">error messages</span> removed by @konstin on 2025-05-30 08:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jmesterh">@jmesterh</a> on 2025-10-18 17:59</div>
            <div class="timeline-body"><p>Just ran into this as we are being asked to use <a href="https://www.chainguard.dev/">chainguard</a> images as part of regulatory compliance.</p>
<p>As mentioned above, fix was to add this to the final stage of our Dockerfile:</p>
<pre><code>ENV UV_NO_MANAGED_PYTHON=true \
        UV_SYSTEM_PYTHON=true
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:31:19 UTC
    </footer>
</body>
</html>
