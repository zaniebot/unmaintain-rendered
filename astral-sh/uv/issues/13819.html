<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inconsistent default resolution behaviour between pip and uv: if-necessary-or-explicit vs if-necessary - astral-sh/uv #13819</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Inconsistent default resolution behaviour between pip and uv: if-necessary-or-explicit vs if-necessary</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/13819">#13819</a>
        opened by <a href="https://github.com/pelson">@pelson</a>
        on 2025-06-03 14:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/pelson">@pelson</a> on 2025-06-03 14:37</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I appreciate very much the caveat in https://docs.astral.sh/uv/pip/compatibility/#pre-release-compatibility related to pre-release compatibility. I wanted to highlight a specific difference, as I believe <code>uv</code> is being overly eager to install pre-releases.</p>
<p>With <code>pip</code>, if you do not enable pre-releases, it will only install them if no non-pre-release version is available:</p>
<pre><code>$ python -m pip install &quot;scipy&gt;=1.1,&lt;2a0&quot; --force-reinstall | grep &quot;Successfully installed&quot;
Successfully installed scipy-1.15.3
</code></pre>
<p>With <code>uv</code>, and its default <code>if-necessary-or-explicit</code> behaviour, this constraint results in a pre-release being installed:</p>
<pre><code>$ echo &quot;scipy&gt;=1.1,&lt;2a0&quot; | uv pip compile - | grep 'scipy=='
scipy==1.16.0rc1
</code></pre>
<p>If we change the pre-release flag to ``if-necessary`, then we see the expected behaviour:</p>
<pre><code>$ echo &quot;scipy&gt;=1.1,&lt;2a0&quot; | uv pip compile --prerelease &quot;if-necessary&quot; - | grep 'scipy=='
scipy==1.15.3
</code></pre>
<p>However, this now means that the pip behaviour of using pre-releases if there is no other option is not followed:</p>
<pre><code>$ python -m pip install &quot;scipy&gt;=1.16rc0&quot; --force-reinstall  | grep &quot;Successfully installed&quot;
Successfully installed scipy-1.16.0rc1
</code></pre>
<pre><code>$ echo &quot;scipy&gt;=1.16rc0&quot; | uv pip compile --prerelease &quot;if-necessary&quot; - | grep 'scipy=='
  × No solution found when resolving dependencies:
  ╰─▶ Because only scipy&lt;1.16rc0 is available and you require scipy&gt;=1.16rc0, we can conclude that your requirements are unsatisfiable.

      hint: `scipy` was requested with a pre-release marker (e.g., scipy&gt;=1.16rc0), but pre-releases weren't enabled (try: `--prerelease=allow`)
</code></pre>
<p>There is some history of issues here, in particular I point out https://github.com/astral-sh/uv/issues/9395#issuecomment-2576040442. I raise this to provide specific examples of the difference between pip and the <code>if-necessary</code> option, and to flag the desire to align with <code>pip</code> on the particular point of determining pre-releases.</p>
<p>I fully agree with the issue where it is claimed that <a href="https://github.com/astral-sh/uv/issues/12589#issuecomment-2770222517"><code>if-necessary</code> is unexpectedly named</a>, and would advocate for having an additional option which isn't &quot;Allow pre-release versions if all versions of a package are pre-release&quot;, but is rather &quot;Allow pre-release versions if the only versions available after applying the constraint are pre-releases&quot;. Doing this clearly requires an additional step that is possibly not being done today in <code>uv</code> (apply the constraint before deciding if pre-releases should be used), but this would be an essential step if one is to be consistent with <code>pip</code> in the way it resolves whether pre-releases are installed.</p>
<p><em>At the very least</em>, it would be good to have a flag to enable the same behaviour as pip in this regard.</p>
<h3>Platform</h3>
<p>Ubuntu</p>
<h3>Version</h3>
<p>uv 0.7.9</p>
<h3>Python version</h3>
<p>Python 3.11</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @pelson on 2025-06-03 14:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-06-04 14:04</div>
            <div class="timeline-body"><p>Instead of following pip's model, we chose to make the choice over prerelease or not explicit by requiring a prerelease specifier in a direct dependency, i.e. listing it in a file the user controls. This is an intentional choice to reduce the complexity in prerelease selection: As a user, you decide ahead of time whether you are interested in prereleases for a package or not.</p>
<p>When using uv, I'd recommend using <code>&lt;2</code> over <code>&lt;2a0</code>. If you know that you need a more recent version of e.g. scipy, you can use <code>&gt;=1.16.0rc1,&lt;2</code> to select that prerelease.</p>
<p>It is also due to how our incremental SAT solver works (PubGrub), which cannot re-enable prereleases if weren't selected once (which would break clause learning), this is something where pip's design limits their resolver choices.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @konstin on 2025-06-04 14:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @konstin on 2025-06-04 14:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pelson">@pelson</a> on 2025-06-10 08:05</div>
            <div class="timeline-body"><p>Thanks for the response. Having gone back to <code>pip</code> to demonstrate that <code>scipy&gt;=1.1,&lt;2a0</code> meant something different to <code>scipy&gt;=1.1,&lt;2</code>, it turns out that the behaviour changed in <code>pip</code> at some point.</p>
<p>Previously, <code>&lt;2</code> would trigger the installation of <code>2.0a0</code> if <code>pre</code> was enabled, but this is no longer the case, and your suggestion works out well at this point.</p>
<p>In terms of the naming of <code>if-necessary</code>, it is quite unfortunate IMO, but I think there are other issues where this is covered more in-depth (https://github.com/astral-sh/uv/issues/9395#issuecomment-2498355868). As a result, I will close this.</p>
<p>Thanks again @konstin.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @pelson on 2025-06-10 08:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2025-06-11 19:45</div>
            <div class="timeline-body"><p>This is an example of where pip (whose behavior is inherited from packaging) simply wasn't following the spec.</p>
<p>I detailed the behavior change in the 25.0 bug fix section: https://github.com/pypa/pip/blob/25.1.1/NEWS.rst#bug-fixes-3</p>
<blockquote>
<p>The inclusion of packaging 24.2 changes how pre-release specifiers with &lt; and &gt; behave. Including a pre-release version with these specifiers now implies accepting pre-releases (e.g., &lt;2.0dev can include 1.0rc1). To avoid implying pre-releases, avoid specifying them (e.g., use &lt;2.0). The exception is !=, which never implies pre-releases.</p>
</blockquote>
<p>uv and pip now both correctly this standard for user specified packages, uv fails to follow this standard for dependencies and transative dependencies for the reasons @konstin outlines.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2025-06-11 19:54</div>
            <div class="timeline-body"><blockquote>
<p>this is something where pip's design limits their resolver choices.</p>
</blockquote>
<p>Also FYI, pip can't use pubgrub-rs because it's the design choice is to stick to pure Python.</p>
<p>But what you mention here about pre-releaes isn't a design choice, it's a recommendation of the standard, and it's not incompatible with a pubgrub style algorithm.</p>
<p>Poetry, which uses mixology, a pubgrub style algorithm, successfully follows the standards recommendations here, where uv does not.</p>
<p>The major limiting factor for pip adopting a pubgrub style algorithm is maintainer time.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:28 UTC
    </footer>
</body>
</html>
