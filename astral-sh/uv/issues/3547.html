<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Installing wheel with link-mode=clone fails on windows - astral-sh/uv #3547</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Installing wheel with link-mode=clone fails on windows</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/3547">#3547</a>
        opened by <a href="https://github.com/bschoenmaeckers">@bschoenmaeckers</a>
        on 2024-05-13 14:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/bschoenmaeckers">@bschoenmaeckers</a> on 2024-05-13 14:43</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

<p>Installing a wheel with uv 0.1.42 fails when using <code>linkmode = clone</code> fails on a windows dev drive fails because windows does not support cloning directories as a whole. I suspect this fails on linux as well but haven't tested it myself just yet.</p>
<p>It currently shows the error message <code>the source path is not an existing regular file: Access is denied. (os error 5) </code> coming from the <a href="https://github.com/cargo-bins/reflink-copy/blob/0.1.17/src/lib.rs#L76-L79">reflink-copy</a> library. Uv should  fall back to cloning individual files on windows (at least) to support COW installations.</p>
<details>
  <summary>log trace</summary>

<pre><code class="language-console">&gt;uv pip install setuptools --link-mode=clone
INFO Found a virtualenv through VIRTUAL_ENV at: D:\repo\test-project\.venv
DEBUG Cached interpreter info for Python 3.12.1, skipping probing: .venv\Scripts\python.exe
DEBUG Using Python 3.12.1 environment at .venv\Scripts\python.exe
DEBUG Trying to lock if free: .venv\.lock
DEBUG At least one requirement is not satisfied: setuptools
DEBUG Using registry request timeout of 30s
⠋ Resolving dependencies...                                                                                                                                                                                                                                                                                         DEBUG Solving with target Python version 3.12.1
DEBUG Adding direct dependency: setuptools*
⠙ Resolving dependencies...                                                                                                                                                                                                                                                                                         INFO add_decision: root @ 0a0.dev0    
TRACE Fetching metadata for setuptools from https://pypi.org/simple/setuptools/
TRACE cached request https://pypi.org/simple/setuptools/ is storable because its response has a 'public' cache-control directive
DEBUG Found fresh response for: https://pypi.org/simple/setuptools/
TRACE Received package metadata for: setuptools
TRACE selecting candidate for package setuptools with range Range { segments: [(Unbounded, Unbounded)] } with 557 remote versions
TRACE found candidate for package PackageName(&quot;setuptools&quot;) with range Range { segments: [(Unbounded, Unbounded)] } after 1 steps: &quot;69.5.1&quot; version
DEBUG Searching for a compatible version of setuptools (*)
TRACE selecting candidate for package setuptools with range Range { segments: [(Unbounded, Unbounded)] } with 557 remote versions
TRACE found candidate for package PackageName(&quot;setuptools&quot;) with range Range { segments: [(Unbounded, Unbounded)] } after 1 steps: &quot;69.5.1&quot; version
DEBUG Selecting: setuptools==69.5.1 (setuptools-69.5.1-py3-none-any.whl)
⠙ setuptools==69.5.1                                                                                                                                                                                                                                                                                                TRACE cached request https://files.pythonhosted.org/packages/f7/29/13965af254e3373bceae8fb9a0e6ea0d0e571171b80d6646932131d6439b/setuptools-69.5.1-py3-none-any.whl.metadata is storable because its response has a 'public' cache-control directive
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/f7/29/13965af254e3373bceae8fb9a0e6ea0d0e571171b80d6646932131d6439b/setuptools-69.5.1-py3-none-any.whl.metadata
TRACE Received built distribution metadata for: setuptools==69.5.1
INFO add_decision: setuptools @ 69.5.1
DEBUG Tried 2 versions: root 1, setuptools 1
Resolved 1 package in 5ms
DEBUG Requirement already cached: setuptools==69.5.1
DEBUG Unnecessary package: pip==24.0
░░░░░░░░░░░░░░░░░░░░ [0/1] Installing wheels...                                                                                                                                                                                                                                                                     DEBUG Extracting file name=&quot;setuptools&quot;
DEBUG Cloning \\?\D:\packages\uv\archive-v0\SAaq2Tm4XZ_Ep1hD_lCQB\distutils-precedence.pth to D:\repo\test-project\.venv\Lib\site-packages\distutils-precedence.pth
DEBUG Cloning \\?\D:\packages\uv\archive-v0\SAaq2Tm4XZ_Ep1hD_lCQB\pkg_resources to D:\repo\test-project\.venv\Lib\site-packages\pkg_resources
error: Failed to install: setuptools-69.5.1-py3-none-any.http.whl (setuptools==69.5.1)
  Caused by: Failed to reflink D:\packages\uv\archive-v0\SAaq2Tm4XZ_Ep1hD_lCQB\pkg_resources to .venv\Lib\site-packages\pkg_resources
  Caused by: the source path is not an existing regular file: Access is denied. (os error 5)

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-13 14:45</div>
            <div class="timeline-body"><p>Sort of mixed on this. If you request <code>--link-mode=clone</code> and your system doesn't support cloning, it seems right (IMO) to fail with an error.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bschoenmaeckers">@bschoenmaeckers</a> on 2024-05-13 15:44</div>
            <div class="timeline-body"><p>I kind of understand where you are coming from. It a unfortunate limitation of microsoft implementation of Copy-On-Write on ReFS.  But I still think it is a &quot;nice to have&quot; to support cloning on windows.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-13 15:45</div>
            <div class="timeline-body"><p>Sorry, I misread. I do think we should support this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-13 15:45</div>
            <div class="timeline-body"><p>I thought you were saying that cloning wasn't supported at all in Windows, and so we should fall back to copying. But you're saying cloning <em>directories</em> isn't supported, so we should fall back to cloning the individual files. This is straightforward and we should do it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-05-13 15:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bschoenmaeckers">@bschoenmaeckers</a> on 2024-05-13 15:46</div>
            <div class="timeline-body"><p>I can open a MR if I'm free to do so.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-13 15:47</div>
            <div class="timeline-body"><p>Sure. We already have fallback code in <code>clone_recursive</code> that does exactly this (I think), but it only catches directory-already-exists errors.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">windows</span> added by @charliermarsh on 2024-05-13 15:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/3551.html">astral-sh/uv#3551</a> on 2024-05-13 15:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-05-13 16:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:27 UTC
    </footer>
</body>
</html>
