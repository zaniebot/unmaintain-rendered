<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv venv` and github actions scripts / workflows - astral-sh/uv #1386</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`uv venv` and github actions scripts / workflows</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/1386">#1386</a>
        opened by <a href="https://github.com/strickvl">@strickvl</a>
        on 2024-02-15 23:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/strickvl">@strickvl</a> on 2024-02-15 23:37</div>
            <div class="timeline-body"><p>Having trouble converting our pre-existing CI workflows / scripts to use <code>uv</code>, as you can see <a href="https://github.com/zenml-io/zenml/actions/runs/7923609857/job/21633667697?pr=2442">here</a>. Problem relates to the virtual environments which don't seem to be retained between workflow steps.</p>
<p><a href="https://github.com/zenml-io/zenml/blob/e25abb47e0988e5acc268e99d9b79931e6943e95/.github/workflows/ci-fast.yml#L31">This</a> is maybe the easiest illustration of that:</p>
<pre><code class="language-yaml">  steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
      - name: Set up Python
        uses: actions/setup-python@v5.0.0
        with:
          python-version: '3.10'
      - name: Install current package as editable
        run: |
          pip install uv
          uv venv
          uv pip install darglint
      - name: Check docstrings
        run: bash scripts/docstring.sh
</code></pre>
<p>One step installs it, and then the next step runs a script which in turn attempts to use the package, but it fails because the CI can't be found.</p>
<p>I don't see any docs yet, so wondering how best to handle this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-02-15 23:39</div>
            <div class="timeline-body"><p>Hi! You need to activate virtual environments so set <code>VIRTUAL_ENV=./.venv</code> after creating.</p>
<p>Related #1326</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2024-02-15 23:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/strickvl">@strickvl</a> on 2024-02-15 23:57</div>
            <div class="timeline-body"><p>Sorry maybe I'm being dumb here, but I've tried this and it still doesn't pick up the package.</p>
<pre><code class="language-yaml">steps:
      - name: Checkout code
        uses: actions/checkout@v4.1.1
      - name: Set up Python
        uses: actions/setup-python@v5.0.0
        with:
          python-version: '3.10'
      - name: Install current package as editable
        run: |
          pip install uv
          uv venv
          VIRTUAL_ENV=./.venv
          uv pip install darglint
      - name: Check docstrings
        run: bash scripts/docstring.sh
        env:
          VIRTUAL_ENV: ./.venv
</code></pre>
<p>I even threw in a <code>source .venv/bin/activate</code> after the <code>uv venv</code> and that also did nothing. Am I doing what you suggested, or am I doing it wrong?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ericbn">@ericbn</a> on 2024-02-16 04:23</div>
            <div class="timeline-body"><p>With GitHub Actions I think it makes more sense to install the dependencies globally in the virtual machine. uv does not support that yet. See #1374</p>
<p>In your ‚ÄúCheck docstrings‚Äù step shown above you‚Äôre missing also updating the PATH environment variable to include <code>‚Äú$VIRTUAL_ENV/bin‚Äù</code>. Or you can call <code>. .venv/bin/activate</code> at the beginning of the step, which will take care of the VIRTUAL_ENV and PATH environment variables for you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylanbstorey">@dylanbstorey</a> on 2024-02-16 05:54</div>
            <div class="timeline-body"><p>Had a similar issue, got this working for me with the following snippet :</p>
<pre><code> angreal-tests-linux:
    name: &quot;angreal run-tests linux&quot;
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: 1.67.0
          override: true
      - uses: Swatinem/rust-cache@v1
      - uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      - uses: actions/setup-python@v4
        with:
          python-version: &quot;3.12&quot;
      - run: echo &quot;VIRTUAL_ENV=${Python_ROOT_DIR}&quot; &gt;&gt; $GITHUB_ENV
      - run: pip install uv
      - run: uv pip install maturin pytest
      - run: uv pip install angreal@.
      - run: cargo test -v -- --nocapture --test-threads=1
      - run: python -m pytest -svv
</code></pre>
<p>Its a bit of a hack, but basically you create the environment variable and set it to the root python and append it to the special github_env variable.</p>
<p>This basically tells uv to just use the system python instead oa virtual env, should be good to go,</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/strickvl">@strickvl</a> on 2024-02-16 06:30</div>
            <div class="timeline-body"><p>@dylanbstorey that's a neat trick, and helpful it works across operating systems too. But would be good for <code>uv</code> to support installations globally too to make this unnecessary.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/strickvl">@strickvl</a> on 2024-02-16 06:37</div>
            <div class="timeline-body"><p>Ok and key here is that the <code>- run: echo &quot;VIRTUAL_ENV=${Python_ROOT_DIR}&quot; &gt;&gt; $GITHUB_ENV</code> step runs as a separate step. i.e. you can't just run that bash command from within a step that has some other <code>uv</code> commands as then it won't pick up the Env var.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/strickvl">@strickvl</a> on 2024-02-16 08:46</div>
            <div class="timeline-body"><p>Was running into race conditions here or at least issues with steps / jobs running in parallel attempting to access the same environment, it seems. I switched back to using <code>source ...</code> everywhere as it seemed more controlled.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/1526.html">astral-sh/uv#1526</a> on 2024-02-16 22:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../scikit-hep/pyhf/pulls/2444.html">scikit-hep/pyhf#2444</a> on 2024-02-16 22:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../open-webui/open-webui/pulls/758.html">open-webui/open-webui#758</a> on 2024-02-16 22:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/adamtheturtle">@adamtheturtle</a> on 2024-02-17 12:55</div>
            <div class="timeline-body"><p>Ideally for me there would be clear instructions on good practice for using <code>uv</code> in GitHub Actions, including on Windows, and including with a cache using <code>actions/cache</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/1604.html">astral-sh/uv#1604</a> on 2024-02-18 08:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/adamtheturtle">@adamtheturtle</a> on 2024-02-18 11:56</div>
            <div class="timeline-body"><p>Thank you @dylanbstorey .</p>
<p>In my use of your trick, I quote <code>&quot;$GITHUB_ENV&quot;</code> as per examples in https://docs.github.com/en/actions/using-workflows/workflow-commands-for-github-actions#setting-an-environment-variable and as advised by shellcheck.</p>
<pre><code>SC2086:info:1:42: Double quote to prevent globbing and word splitting [shellcheck]
</code></pre>
<p>Ideally for me any documented example will pass <a href="https://github.com/rhysd/actionlint"><code>actionlint</code></a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kdeldycke">@kdeldycke</a> on 2024-02-18 13:17</div>
            <div class="timeline-body"><p>Can confirm @dylanbstorey's hack</p>
<pre><code class="language-yaml">      - run: echo &quot;VIRTUAL_ENV=${Python_ROOT_DIR}&quot; &gt;&gt; $GITHUB_ENV
</code></pre>
<p>is working fine in my case:</p>
<p>https://github.com/kdeldycke/workflows/blob/9e840d7c00ccb5a62272d437d2fe23c2cfbf866d/.github/workflows/lint.yaml#L68-L71</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">virtualenv</span> added by @zanieb on 2024-02-18 20:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-02-19 13:10</div>
            <div class="timeline-body"><p>The previous solutions suggested in this thread aren't cross-platform:</p>
<ul>
<li><code>echo</code> is a Unix-only command; you need different syntax to set an environment variable on Windows</li>
<li>Even if you set the environment variable correctly on Windows, setting <code>VIRTUAL_ENV</code> to the Python root dir without creating a virtual environment doesn't work on Windows, due to the fact that <code>python.exe</code> isn't in a <code>Scripts/</code> directory on Windows if you don't have a virtual environment activated, and <code>uv</code> isn't (yet?) aware of that.</li>
</ul>
<p>All that means that the previous suggested solutions won't work in a workflow job that runs on multiple operating systems in CI. After much debugging with @MichaReiser, here's a workflow job that I'm now <a href="https://github.com/AlexWaygood/typeshed-stats/blob/main/.github/workflows/test.yml">successfully using</a> to run tests for my hobby project <code>typeshed-stats</code>. It runs on Linux, MacOS and Windows in CI:</p>
<pre><code class="language-yml">jobs:
  pytest-tests:
    name: Run tests with pytest
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [&quot;ubuntu-latest&quot;, &quot;windows-latest&quot;, &quot;macos-latest&quot;]
        python-version: [&quot;3.10&quot;, &quot;3.11&quot;, &quot;3.12&quot;]
      fail-fast: false

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python ${{ matrix.python-version }} on ${{ matrix.os }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true
      - name: Create and activate a virtual environment (Windows)
        if: ${{ runner.os == 'Windows' }}
        # uv doesn't (yet) allow us to install packages globally;
        # we have to create and activate a virtual environment
        run: |
          irm https://astral.sh/uv/install.ps1 | iex
          uv venv .venv
          &quot;VIRTUAL_ENV=.venv&quot; | Out-File -FilePath $env:GITHUB_ENV -Append
          &quot;$PWD/.venv/Scripts&quot; | Out-File -FilePath $env:GITHUB_PATH -Append
      - name: Create and activate a virtual environment (Unix)
        if: ${{ runner.os != 'Windows' }}
        # uv doesn't (yet) allow us to install packages globally;
        # we have to create and activate a virtual environment
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          uv venv .venv
          echo &quot;VIRTUAL_ENV=.venv&quot; &gt;&gt; $GITHUB_ENV
          echo &quot;$PWD/.venv/bin&quot; &gt;&gt; $GITHUB_PATH
      - name: Install dependencies
        run: uv pip install -e &quot;.[pytest]&quot;
      - run: uv pip freeze
      - name: Run tests under coverage
        run: |
          coverage run -m pytest
          coverage report
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/1639.html">astral-sh/uv#1639</a> on 2024-02-19 13:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> added by @AlexWaygood on 2024-02-19 13:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/adamtheturtle">@adamtheturtle</a> on 2024-02-20 09:01</div>
            <div class="timeline-body"><p>@AlexWaygood, @MichaReiser  Thank you for investigating this.</p>
<p>If you want to use <code>echo</code> on Windows in GitHub Actions, you can set <code>shell: bash</code> on a GitHub Action.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-02-20 09:05</div>
            <div class="timeline-body"><blockquote>
<p>If you want to use <code>echo</code> on Windows in GitHub Actions, you can set <code>shell: bash</code> on a GitHub Action.</p>
</blockquote>
<p>@adamtheturtle we tried that but it caused other things to break ;) take a look at the test failures on https://github.com/AlexWaygood/typeshed-stats/pull/191.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/strickvl">@strickvl</a> on 2024-02-20 10:19</div>
            <div class="timeline-body"><p>Had / having similar issues on our CI. Choosing to wait for a more stable way for this global install to happen which I believe will be worked on next week.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/1779.html">astral-sh/uv#1779</a> on 2024-02-20 21:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../mesa/mesa/pulls/2038.html">mesa/mesa#2038</a> on 2024-02-20 22:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgaitan">@mgaitan</a> on 2024-02-21 04:51</div>
            <div class="timeline-body"><p>The following worked <a href="https://github.com/Shiphero/shbin/actions/runs/7984095247/job/21800352598">here</a>.</p>
<pre><code class="language-yaml">jobs:
  build:

    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [&quot;3.8&quot;, &quot;3.9&quot;, &quot;3.10&quot;, &quot;3.11&quot;]

    steps:
      - uses: actions/checkout@v3
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install uv
          uv venv
          uv pip install -e .[dev]
      
      - name: Activate virtualenv
        run: |
          . .venv/bin/activate
          echo PATH=$PATH &gt;&gt; $GITHUB_ENV

      - name: Test with pytest
        run: pytest
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../actions/setup-python/issues/822.html">actions/setup-python#822</a> on 2024-02-21 19:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/2000.html">astral-sh/uv#2000</a> on 2024-02-27 16:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danielhollas">@danielhollas</a> on 2024-02-27 18:08</div>
            <div class="timeline-body"><blockquote>
<p>Ideally for me there would be clear instructions on good practice for using uv in GitHub Actions, including on Windows, and including with a cache using actions/cache.</p>
</blockquote>
<p>I'll just note that <code>setup-python</code> action also has a builtin cache. @alexwaygood have you done any testing to see if using this cache meaningfully speeds things up? Given how fast <code>uv</code> is, I wouldn't be surprised if there wasn't much difference. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-02-27 18:11</div>
            <div class="timeline-body"><blockquote>
<p>@AlexWaygood have you done any testing to see if using this cache meaningfully speeds things up?</p>
</blockquote>
<p>Nope! But it's a good point!</p>
<blockquote>
<p>Given how fast <code>uv</code> is, I wouldn't be surprised if there wasn't much difference. :-)</p>
</blockquote>
<p>I think that would likely depend quite a lot on how complex it is to resolve the requirements set. But for simple requirements sets, I'd wager you're likely right.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danielhollas">@danielhollas</a> on 2024-02-27 18:47</div>
            <div class="timeline-body"><blockquote>
<p>on how complex it is to resolve the requirements set.</p>
</blockquote>
<p>The way I understand it, the cache does not really speeds up resolution itself, no? Well, unless you do not run <code>uv pip install</code> at all upon cache hit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-02-27 21:31</div>
            <div class="timeline-body"><blockquote>
<p>The way I understand it, the cache does not really speeds up resolution itself, no? Well, unless you do not run <code>uv pip install</code> at all upon cache hit.</p>
</blockquote>
<p>oh I don't actually really know anything about how the caching works. Should probably not have implied that I did üòÜ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/strickvl">@strickvl</a> on 2024-03-03 09:53</div>
            <div class="timeline-body"><p>Closing this issue as the <code>--system</code> flag has basically solved this issue for me. Thanks <code>uv</code> team!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @strickvl on 2024-03-03 09:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-03 15:15</div>
            <div class="timeline-body"><p>The cache <em>does</em> improve resolution times because sometimes we need to build source distributions to determine their requirements during resolution which is generally slow ‚Äî the cache contains these builds.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/2231.html">astral-sh/uv#2231</a> on 2024-03-24 20:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../aiidateam/aiida-core/pulls/6363.html">aiidateam/aiida-core#6363</a> on 2024-04-22 12:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-05-22 20:56</div>
            <div class="timeline-body"><p>Hi! For those of you who are subscribed to this and are using <code>echo &quot;VIRTUAL_ENV=${Python_ROOT_DIR}&quot;</code> as a work-around ‚Äî as of 0.2.0 this is no longer supported and we'd recommend using the <code>--system</code> flag or <code>--python &lt;path&gt;</code> instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/elronbandel">@elronbandel</a> on 2024-06-27 16:53</div>
            <div class="timeline-body"><p>Can anyone share an example of how to set up uv in GitHub actions with --system/--python?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-27 16:58</div>
            <div class="timeline-body"><p>@elronbandel here's an example:</p>
<ul>
<li>https://github.com/inventree/InvenTree/pull/7317</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../shap/shap/pulls/3768.html">shap/shap#3768</a> on 2024-07-26 11:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../45spoons/seuranta/pulls/4.html">45spoons/seuranta#4</a> on 2024-08-24 17:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../shyndman/vantron-collectd-support/pulls/2.html">shyndman/vantron-collectd-support#2</a> on 2025-03-07 22:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/yx-altera">@yx-altera</a> on 2025-04-20 23:42</div>
            <div class="timeline-body"><p>Does <a href="https://github.com/astral-sh/setup-uv">astral-sh/setup-uv@v5</a> support caching venv across workflow runs (not just in 1 job, but across workflow runs) ?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:56 UTC
    </footer>
</body>
</html>
