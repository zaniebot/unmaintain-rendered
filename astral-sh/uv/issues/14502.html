<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Env markers in dependency specifiers ignored? - astral-sh/uv #14502</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Env markers in dependency specifiers ignored?</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/14502">#14502</a>
        opened by <a href="https://github.com/evertlammerts">@evertlammerts</a>
        on 2025-07-08 09:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/evertlammerts">@evertlammerts</a></div>
            <div class="timeline-body">Question
<p>Am I correct in assuming that environment markers I use in dependency specifiers for a dependency in a dependency group are not considered when syncing requirements? Or am I just doing this wrong[^1]?</p>
<p>For example:</p>
<pre><code>[dependency-groups]
test = [
    ...,
    &quot;tensorflow==2.14.0; ( sys_platform == &#x27;darwin&#x27; or platform_machine == &#x27;aarch64&#x27; ) and python_version &lt; &#x27;3.12&#x27;&quot;,
    &quot;tensorflow-cpu&gt;=2.14.0; sys_platform != &#x27;darwin&#x27; and platform_machine != &#x27;aarch64&#x27; and platform_machine != &#x27;amd64&#x27; and python_version &lt; &#x27;3.12&#x27;&quot;,
    &quot;tensorflow-intel==2.18.0; platform_machine == &#x27;amd64&#x27; and python_version &lt; &#x27;3.13&#x27;&quot;,
    &quot;numpy&lt;2&quot;,
    ...
]
</code></pre>
<p>and then:</p>
<pre><code>❯ uv sync
  × No solution found when resolving dependencies for split (python_full_version == &#x27;3.11.*&#x27; and sys_platform != &#x27;darwin&#x27;):
  ╰─▶ Because tensorflow==2.14.0 depends on keras&gt;=2.14.0,&lt;2.15 and tensorflow-intel==2.18.0 depends on keras&gt;=3.5.0, we can conclude that tensorflow-intel==2.18.0 and tensorflow{(python_full_version &lt;
      &#x27;3.12&#x27; and platform_machine == &#x27;aarch64&#x27;) or (python_full_version &lt; &#x27;3.12&#x27; and sys_platform == &#x27;darwin&#x27;)}==2.14.0 are incompatible.
      And because duckdb:dev depends on tensorflow{(python_full_version &lt; &#x27;3.12&#x27; and platform_machine == &#x27;aarch64&#x27;) or (python_full_version &lt; &#x27;3.12&#x27; and sys_platform == &#x27;darwin&#x27;)}==2.14.0, we can
      conclude that duckdb:dev and tensorflow-intel{python_full_version &lt; &#x27;3.13&#x27; and platform_machine == &#x27;amd64&#x27;}==2.18.0 are incompatible.
      And because duckdb:dev depends on tensorflow-intel{python_full_version &lt; &#x27;3.13&#x27; and platform_machine == &#x27;amd64&#x27;}==2.18.0 and your project requires duckdb:dev, we can conclude that your project&#x27;s
      requirements are unsatisfiable.

[^1]: NOTE: I&#x27;

      hint: While the active Python version is 3.10, the resolution failed for other Python versions supported by your project. Consider limiting your project&#x27;s supported Python versions using
      `requires-python`.
</code></pre>
<p><code>tensorflow==2.14.0</code> and <code>tensorflow-intel==2.18.0</code> are mutually exclusive, but the environment markers I used make sure they&#x27;re never installed on the same system:</p>
<ul>
<li>tensorflow: <code>sys_platform == &#x27;darwin&#x27; or platform_machine == &#x27;aarch64&#x27;</code> -&gt; OSX (x86_64 and arm64) and Linux aarch64</li>
<li>tensorflow-intel: <code>platform_machine == &#x27;amd64&#x27;</code> -&gt; Windows amd64</li>
</ul>
<p>[^1]: NOTE: These dependencies are just there for running tests, locally and in CI. I&#x27;m trying to get as much coverage as possible on as many platforms as possible.</p>
Platform
<p><em>No response</em></p>
Version
<p>uv 0.7.14 (Homebrew 2025-06-23)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/evertlammerts">@evertlammerts</a> on 2025-07-08 09:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-07-08 09:36</div>
            <div class="timeline-body"><p>In your case, where two packages with a different name are mutually exclusive, the resolver still tries to do perform a single resolution, as it does not recognize the disjointness in the conflict between the two tensorflows. You can manually get different resolution using <code>tool.uv.environments</code> (https://docs.astral.sh/uv/concepts/resolution/#limited-resolution-environments). Additionally, we have to add <code>sys_platform != &#x27;darwin&#x27;</code> for tensorflow-intel, to ensure that we don&#x27;t have overlap for Intel Macs. This is a full example that resolves for me, you may need to adapt the environments for your needs:</p>
<pre><code>[project]
name = &quot;debug&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.9&quot;

[tool.uv]
environments = [
  &quot;(sys_platform == &#x27;darwin&#x27; or platform_machine == &#x27;aarch64&#x27;) and python_version &lt; &#x27;3.12&#x27;&quot;,
  &quot;sys_platform != &#x27;darwin&#x27; and platform_machine != &#x27;aarch64&#x27; and platform_machine != &#x27;amd64&#x27; and python_version &lt; &#x27;3.12&#x27;&quot;,
  &quot;platform_machine == &#x27;amd64&#x27; and sys_platform != &#x27;darwin&#x27; and python_version &lt; &#x27;3.13&#x27;&quot;,
]

[dependency-groups]
test = [
  &quot;tensorflow==2.14.0; (sys_platform == &#x27;darwin&#x27; or platform_machine == &#x27;aarch64&#x27;) and python_version &lt; &#x27;3.12&#x27;&quot;,
  &quot;tensorflow-cpu&gt;=2.14.0; sys_platform != &#x27;darwin&#x27; and platform_machine != &#x27;aarch64&#x27; and platform_machine != &#x27;amd64&#x27; and python_version &lt; &#x27;3.12&#x27;&quot;,
  &quot;tensorflow-intel==2.18.0; platform_machine == &#x27;amd64&#x27; and sys_platform != &#x27;darwin&#x27; and python_version &lt; &#x27;3.13&#x27;&quot;,
  &quot;numpy&lt;2&quot;,
]

[build-system]
requires = [&quot;hatchling&quot;]
build-backend = &quot;hatchling.build&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evertlammerts">@evertlammerts</a> on 2025-07-08 14:59</div>
            <div class="timeline-body"><p>Thanks for the quick reply @konstin! I&#x27;ve learned a lot about dependency resolution with uv today. One thing that caught me was definitely the way universal resolution works with environments. Only after I defined my environments, resolution started to make (some) sense.</p>
<p>My environments are now as follows:</p>
<pre><code>[tool.uv]
environments = [ # no need to resolve packages beyond these platforms with uv...
    &quot;python_version &gt;= &#x27;3.9&#x27; and sys_platform == &#x27;darwin&#x27; and platform_machine == &#x27;arm64&#x27;&quot;,
    &quot;python_version &gt;= &#x27;3.9&#x27; and sys_platform == &#x27;darwin&#x27; and platform_machine == &#x27;x86_64&#x27;&quot;,
    &quot;python_version &gt;= &#x27;3.9&#x27; and sys_platform == &#x27;win32&#x27; and platform_machine == &#x27;AMD64&#x27;&quot;,
    &quot;python_version &gt;= &#x27;3.9&#x27; and sys_platform == &#x27;linux&#x27; and platform_machine == &#x27;x86_64&#x27;&quot;,
    &quot;python_version &gt;= &#x27;3.9&#x27; and sys_platform == &#x27;linux&#x27; and platform_machine == &#x27;aarch64&#x27;&quot;,
]
required-environments = [ # ... but do always resolve for all of them
    &quot;python_version &gt;= &#x27;3.9&#x27; and sys_platform == &#x27;darwin&#x27; and platform_machine == &#x27;arm64&#x27;&quot;,
    &quot;python_version &gt;= &#x27;3.9&#x27; and sys_platform == &#x27;darwin&#x27; and platform_machine == &#x27;x86_64&#x27;&quot;,
    &quot;python_version &gt;= &#x27;3.9&#x27; and sys_platform == &#x27;win32&#x27; and platform_machine == &#x27;AMD64&#x27;&quot;,
    &quot;python_version &gt;= &#x27;3.9&#x27; and sys_platform == &#x27;linux&#x27; and platform_machine == &#x27;x86_64&#x27;&quot;,
    &quot;python_version &gt;= &#x27;3.9&#x27; and sys_platform == &#x27;linux&#x27; and platform_machine == &#x27;aarch64&#x27;&quot;,
]
</code></pre>
<p>Omitting <code>python_version</code> from the markers changes the way resolution works in a way I don&#x27;t understand.</p>
<ul>
<li><p>First of all I was surprised that <code>requires-python = &quot;&gt;=3.9.0&quot;</code> seems to be ignored. That may have to do with semantics I&#x27;m not aware of, but it was certainly a surprise.</p>
</li>
<li><p>Second, omitting the <code>python_version &gt;= &#x27;3.9&#x27;</code> marker has surprising consequences. For example, it resolved pytorch as follows:</p>
<pre><code>  [[packages]]
  name = &quot;torch&quot;
  version = &quot;2.7.1+cpu&quot;
  marker = &quot;(platform_machine == &#x27;x86_64&#x27; and sys_platform == &#x27;darwin&#x27;) or (platform_machine == &#x27;aarch64&#x27; and sys_platform == &#x27;linux&#x27;) or (platform_machine == &#x27;x86_64&#x27; and sys_platform == &#x27;linux&#x27;) or (platform_machine == &#x27;AMD64&#x27; and sys_platform == &#x27;win32&#x27;)&quot;
  index = &quot;https://download.pytorch.org/whl/cpu&quot;
  wheels = [ ... bunch of wheels for linux and windows ... ]</code></pre>
<p>which is incorrect, because there is no available wheel for <code>(platform_machine == &#x27;x86_64&#x27; and sys_platform == &#x27;darwin&#x27;)</code>. The problem <em>might</em> be that the resolver just adds all my markers to the <code>marker</code> field of the dependency? I&#x27;m not quite sure.</p>
</li>
</ul>
<p>Whatever was happening there, my takeaway is this:</p>
<ol>
<li><code>tool.uv.environments</code> limits resolving to the listed envs</li>
<li><code>tool.uv.required-environments</code> forces all dependencies to resolve to the listed envs, while respecting the markers in the dependency specifiers</li>
<li>not specifying a dimension in an environment may result in undefined behavior - e.g. omitting <code>python_version</code> might result in resolving for a different set of python versions than you expect.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-07-08 15:15</div>
            <div class="timeline-body"><blockquote>
<p>Omitting <code>python_version</code> from the markers changes the way resolution works in a way I don&#x27;t understand.</p>
</blockquote>
<p>Can you share an MRE for that? I tried the following with and without <code>python_vestion &gt;= &quot;3.9&quot;</code> and got the same result:</p>
<pre><code>[project]
name = &quot;debug&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.9&quot;

[tool.uv]
environments = [ # no need to resolve packages beyond these platforms with uv...
  &quot;sys_platform == &#x27;darwin&#x27; and platform_machine == &#x27;arm64&#x27;&quot;,
  &quot;sys_platform == &#x27;darwin&#x27; and platform_machine == &#x27;x86_64&#x27;&quot;,
  &quot;sys_platform == &#x27;win32&#x27; and platform_machine == &#x27;AMD64&#x27;&quot;,
  &quot;sys_platform == &#x27;linux&#x27; and platform_machine == &#x27;x86_64&#x27;&quot;,
  &quot;sys_platform == &#x27;linux&#x27; and platform_machine == &#x27;aarch64&#x27;&quot;,
]
required-environments = [ # ... but do always resolve for all of them
  &quot;sys_platform == &#x27;darwin&#x27; and platform_machine == &#x27;arm64&#x27;&quot;,
  &quot;sys_platform == &#x27;darwin&#x27; and platform_machine == &#x27;x86_64&#x27;&quot;,
  &quot;sys_platform == &#x27;win32&#x27; and platform_machine == &#x27;AMD64&#x27;&quot;,
  &quot;sys_platform == &#x27;linux&#x27; and platform_machine == &#x27;x86_64&#x27;&quot;,
  &quot;sys_platform == &#x27;linux&#x27; and platform_machine == &#x27;aarch64&#x27;&quot;,
]

[dependency-groups]
test = [
  &quot;tensorflow==2.14.0; (sys_platform == &#x27;darwin&#x27; or platform_machine == &#x27;aarch64&#x27;) and python_version &lt; &#x27;3.12&#x27;&quot;,
  &quot;tensorflow-cpu&gt;=2.14.0; sys_platform != &#x27;darwin&#x27; and platform_machine != &#x27;aarch64&#x27; and platform_machine != &#x27;amd64&#x27; and python_version &lt; &#x27;3.12&#x27;&quot;,
  &quot;tensorflow-intel==2.18.0; platform_machine == &#x27;amd64&#x27; and sys_platform != &#x27;darwin&#x27; and python_version &lt; &#x27;3.13&#x27;&quot;,
  &quot;numpy&lt;2&quot;,
]
</code></pre>
<p>What indexes are you using, are those the same as in https://docs.astral.sh/uv/guides/integration/pytorch/?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/evertlammerts">@evertlammerts</a> on 2025-07-08 16:43</div>
            <div class="timeline-body"><p>Hm, I may have been wrong about the python version... but there are still some things I don&#x27;t get.</p>
<p>With the below config:</p>
<ol>
<li><code>uv export --only-group test --no-emit-project --format pylock.toml</code> on the below config <strong>without</strong> <code>required-environments</code> (<a href="https://gist.github.com/evertlammerts/821d8aba951efc8efc0f433ea35c61dc#file-pylock-toml-L130">gist with the resulting pylock.toml</a>) resolves <code>torch==2.7.1+cpu</code> for marker <code>(platform_machine == &#x27;x86_64&#x27; and sys_platform == &#x27;darwin&#x27;)</code>, but a wheel does not exist for that platform.</li>
<li><code>uv export --only-group test --no-emit-project --format pylock.toml</code> on the below config <strong>with</strong> <code>required-environments</code> (<a href="https://gist.github.com/evertlammerts/206715fde51d5fcfa4c913499c338660#file-pylock-toml-L130">gist with the resulting pylock.toml</a>) resolves <code>torch==2.2.2</code> for marker <code>platform_machine == &#x27;x86_64&#x27; and sys_platform == &#x27;darwin&#x27;</code>, which does exist for cp39-cp312, but not for cp313.</li>
</ol>
<p>Both aren&#x27;t what I expect. But that may be because I don&#x27;t understand the semantics of <code>environments</code> and <code>required-environments</code>.</p>
<pre><code>[project]
name = &quot;mre&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.9&quot;

[[tool.uv.index]]
name = &quot;pytorch-cpu&quot;
url = &quot;https://download.pytorch.org/whl/cpu&quot;
explicit = true

[tool.uv.sources]
torch = [ { index = &quot;pytorch-cpu&quot; } ]
torchvision = [ { index = &quot;pytorch-cpu&quot; } ]

[tool.uv]
environments = [ # no need to resolve packages beyond these platforms with uv...
    &quot;python_version &gt;= &#x27;3.9&#x27; and sys_platform == &#x27;darwin&#x27; and platform_machine == &#x27;arm64&#x27;&quot;,
    &quot;python_version &gt;= &#x27;3.9&#x27; and sys_platform == &#x27;darwin&#x27; and platform_machine == &#x27;x86_64&#x27;&quot;,
    &quot;python_version &gt;= &#x27;3.9&#x27; and sys_platform == &#x27;win32&#x27; and platform_machine == &#x27;AMD64&#x27;&quot;,
    &quot;python_version &gt;= &#x27;3.9&#x27; and sys_platform == &#x27;linux&#x27; and platform_machine == &#x27;x86_64&#x27;&quot;,
    &quot;python_version &gt;= &#x27;3.9&#x27; and sys_platform == &#x27;linux&#x27; and platform_machine == &#x27;aarch64&#x27;&quot;,
]
required-environments = [ # ... but do always resolve for all of them
    &quot;python_version &gt;= &#x27;3.9&#x27; and sys_platform == &#x27;darwin&#x27; and platform_machine == &#x27;arm64&#x27;&quot;,
    &quot;python_version &gt;= &#x27;3.9&#x27; and sys_platform == &#x27;darwin&#x27; and platform_machine == &#x27;x86_64&#x27;&quot;,
    &quot;python_version &gt;= &#x27;3.9&#x27; and sys_platform == &#x27;win32&#x27; and platform_machine == &#x27;AMD64&#x27;&quot;,
    &quot;python_version &gt;= &#x27;3.9&#x27; and sys_platform == &#x27;linux&#x27; and platform_machine == &#x27;x86_64&#x27;&quot;,
    &quot;python_version &gt;= &#x27;3.9&#x27; and sys_platform == &#x27;linux&#x27; and platform_machine == &#x27;aarch64&#x27;&quot;,
]

[dependency-groups]
test = [
  &quot;torch&gt;=2.2.2&quot;,
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-07-17 19:06</div>
            <div class="timeline-body"><p>Looking at https://download.pytorch.org/whl/torch/, there doesn&#x27;t seem to be any cp313 macos wheel. We should handle this better and actually complain when <code>python_version &gt;= &#x27;3.13&#x27; and sys_platform == &#x27;darwin&#x27; and platform_machine == &#x27;x86_64&#x27;</code> doesn&#x27;t have a wheel, but for the use case there seems to be no support from the torch side.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:39:19 UTC
    </footer>
</body>
</html>
