<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regression in 0.4.23: data did not match any variant of untagged enum CacheInfoWire - astral-sh/uv #8367</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Regression in 0.4.23: data did not match any variant of untagged enum CacheInfoWire</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/8367">#8367</a>
        opened by <a href="https://github.com/KapJI">@KapJI</a>
        on 2024-10-19 16:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/KapJI">@KapJI</a></div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

<p>My Github Actions CI started failing with this error:</p>
<pre><code>error: Failed to build: `homeassistant-stubs @ file:///home/runner/work/homeassistant-stubs/homeassistant-stubs`
  Caused by: Failed to deserialize cache entry
  Caused by: data did not match any variant of untagged enum CacheInfoWire
</code></pre>
<p>I bisected it to 0.4.23 here: https://github.com/KapJI/homeassistant-stubs/pull/496</p>
<p>This is an example workflow, <code>enable-cache: false</code>, other settings for <code>astral-sh/setup-uv</code> are default, it's using <code>ubuntu-latest</code> runner:
https://github.com/KapJI/homeassistant-stubs/actions/runs/11418948703/job/31772992617</p>
<p>All these tools in pre-commit hook are running via <code>uv run</code>. In this workflow no caches were materialized but <code>UV_CACHE_DIR</code> was set by <code>setup-uv</code>.</p>
<ul>
<li>I tried to remove all stored caches from the repo jsut in case with no result.</li>
<li>Also I tried using different <code>cache-local-path</code>, also with no result.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KapJI">@KapJI</a> on 2024-10-19 17:20</div>
            <div class="timeline-body"><p>Bisected to https://github.com/astral-sh/uv/pull/8259</p>
<ul>
<li>https://github.com/astral-sh/uv/commit/6a81d302bbc03bcb5bad4e6da44f4a0472f102b4 passes: https://github.com/KapJI/homeassistant-stubs/actions/runs/11419383821/job/31773917481</li>
<li>https://github.com/astral-sh/uv/commit/7730861bc5c6fb58ad402a396479f2cba6946110 fails: https://github.com/KapJI/homeassistant-stubs/actions/runs/11419315350/job/31773778565</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @zanieb on 2024-10-19 18:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-10-19 18:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cache</span> added by @zanieb on 2024-10-19 18:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-19 18:01</div>
            <div class="timeline-body"><p>Thanks for the bisect!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-19 19:25</div>
            <div class="timeline-body"><p>Are you somehow sharing a cache across multiple uv versions?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-19 19:25</div>
            <div class="timeline-body"><p>Like somehow writing to the cache from <code>0.4.23</code> and then reading from it on <code>0.4.22</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-19 19:31</div>
            <div class="timeline-body"><p>I think that's very likely what's happening. Your <code>uv.lock</code> has:</p>
<pre><code class="language-toml">[[package]]
name = &quot;uv&quot;
version = &quot;0.4.15&quot;
</code></pre>
<p>So the outer <code>uv run</code> for pre-commit is using 0.4.23 or whatever you've pinned, but the <code>uv run</code> within your pre-commit jobs is using the <code>uv</code> version locked in the project (0.4.15). It's not safe to write cache data with a later version and then read it with an earlier version unfortunately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @charliermarsh on 2024-10-19 19:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-19 19:33</div>
            <div class="timeline-body"><p>I think you need to either use 0.4.15 in your project (to match home-assistant), or use different cache directories between your top-level <code>uv run</code> (or even <code>--no-cache</code>?) and the jobs in your <code>pre-commit</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-19 19:34</div>
            <div class="timeline-body"><p>Alternatively we could decide to change our policy (written up <a href="https://docs.astral.sh/uv/concepts/cache/#cache-versioning">here</a>) so that versions like 0.4.15 are expected to be able to read cache data from 0.4.23.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-19 19:35</div>
            <div class="timeline-body"><p>(I'm not opposed to changing the policy, it just means more frequent cache version bumps.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KapJI">@KapJI</a> on 2024-10-19 19:43</div>
            <div class="timeline-body"><p>Wow, that's a good catch! I don't know how it got into <code>uv.lock</code> though. Is there any reasonable case when this should be allowed?</p>
<p>Edit: I found it's a dependency of <code>homeassistant</code> itself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KapJI">@KapJI</a> on 2024-10-19 20:15</div>
            <div class="timeline-body"><p>Basically the issue here is that some downstream dependency may add different version of <code>uv</code> to its dependencies, like <code>homeassistant</code> in this case. This means it's not safe to use <code>uv</code> within <code>uv run</code> as outer and inner versions may mismatch.</p>
<p>I wonder if <code>uv</code> can detect such case and show some warning as this scenario may probably lead to many other issues.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-19 23:32</div>
            <div class="timeline-body"><p>I actually just ran into this while working on typeshed.</p>
<p>Typeshed has <code>uv</code> listed as a test dependency in its <code>requirements-tests.txt</code> file (because we use it in our test scripts, but we don't want to mandate that users have to use <code>uv</code> for local development if they don't want to). But I also have <code>uv</code> installed globally for my local development, and the <code>uv</code> version I have installed globally is a much newer one than the <code>uv</code> pin in typeshed's <code>requirements-tests.txt</code> file that was installed into my typeshed-development virtual environment locally. Which led to <code>uv</code> crashing with this error message when one version of <code>uv</code> tried to read a cache entry written by another version of <code>uv</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-20 16:07</div>
            <div class="timeline-body"><p>We should probably just change our cache versioning policy to make this less likely.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-10-20 16:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-10-20 16:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mishamsk">@mishamsk</a> on 2024-10-23 20:12</div>
            <div class="timeline-body"><p>@charliermarsh I may be reading the policy wrong, but it kinda implies that if two version have incompatible cache formats, then they will use different subfolders within the root cache folder to avoid errors. Which is what I'd expect. I am not concerned about extra gigabytes of duplicate data sitting around as long as it helps uv &quot;just work&quot;.</p>
<p>But now it seems that either I am reading the text wrong, or. the reality is different. I have pretty much the same case as @AlexWaygood - the most recent version of uv installed and used globally (e.g. for quick scripts), but locked older versions in many a project. The latter randomly fail to uv sync.</p>
<p>I imagine adding forward compatibility may be really hard. Wonder if you could just treat the UV_CACHE as root folder, but really place cache under versioned subfolders, maybe versioned to a specific uv version to keep it really simple and stupid.</p>
<p>Whatever is the case, the amount of reduced testing/ci/frustration time that uv already brought definitely worth these minor inconveniences. So no complains really! Absolutely lovely stuff you are all making!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-23 20:15</div>
            <div class="timeline-body"><p>Thank you @mishamsk ❤️</p>
<p>The cache policy going forward is what you described in your first paragraph: if two versions have incompatible cache formats, they use different subfolders within the cache. So they shouldn't error, but they may duplicate data.</p>
<p>But I <em>just</em> changed the policy (see the linked PR here), so it's possible that you're seeing breakages when sharing the cache between older uv versions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mishamsk">@mishamsk</a> on 2024-10-23 20:35</div>
            <div class="timeline-body"><blockquote>
<p>Thank you @mishamsk ❤️</p>
<p>The cache policy going forward is what you described in your first paragraph: if two versions have incompatible cache formats, they use different subfolders within the cache. So they shouldn't error, but they may duplicate data.</p>
<p>But I <em>just</em> changed the policy (see the linked PR here), so it's possible that you're seeing breakages when sharing the cache between older uv versions.</p>
</blockquote>
<p>ah, ok, that makes sense. you are just moving so fast, this PR is 4 days old, I haven't realized that it did include the change you mentioned in a comment ;-)</p>
<p>I'll go ahead and update uv version on one of my projects then, was just debating if there is value to do that. Now I know there is. Thanks!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:27:49 UTC
    </footer>
</body>
</html>
