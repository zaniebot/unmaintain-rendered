<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Race condition when two libraries update the same __init__.py - astral-sh/uv #6568</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Race condition when two libraries update the same __init__.py</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/6568">#6568</a>
        opened by <a href="https://github.com/ramarnat">@ramarnat</a>
        on 2024-08-24 04:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ramarnat">@ramarnat</a> on 2024-08-24 04:38</div>
            <div class="timeline-body"><p>This has had me pulling my hair out.</p>
<p>If pydantic is enabled in the requirements.txt, pyjwt fails with</p>
<pre><code>#12 7.705 Traceback (most recent call last):
#12 7.705   File &quot;&lt;string&gt;&quot;, line 1, in &lt;module&gt;
#12 7.706 ImportError: cannot import name 'PyJWKClient' from 'jwt' (/opt/venv/lib/python3.12/site-packages/jwt/__init__.py)
</code></pre>
<p>Looks like the <strong>init</strong>.py doesnt get updated with PyJWKClient in the failed runs, but no indication as to why.</p>
<p>Cant make it fail deterministically but doing  <code>docker system prune</code>, it will fail every other (?) time.</p>
<p>Here is the Dockerfile:</p>
<pre><code>FROM python:3.12.3 AS build

ENV PATH=&quot;/opt/venv/bin:$PATH&quot;
ENV VIRTUAL_ENV=&quot;/opt/venv&quot;

# Python runtime dependencies
RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends \
    make \
    g++ \
    gfortran \
    cmake &amp;&amp; \
    python -m venv /opt/venv 


COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

WORKDIR /app
COPY requirements.txt  ./

RUN echo 1 &amp;&amp; \
    uv pip -v --no-cache sync requirements.txt &amp;&amp;\
    python -c &quot;from jwt import PyJWKClient&quot; 
</code></pre>
<p>Here is the requirements.txt:</p>
<pre><code># This file was autogenerated by uv via the following command:
#    uv pip compile requirements.in pyproject.toml
annotated-types==0.7.0
    # via pydantic
anyio==3.7.1
    # via
    #   fastapi
    #   starlette
certifi==2022.12.7
    # via requests
cffi==1.17.0
    # via cryptography
charset-normalizer==2.1.1
    # via requests
cryptography==43.0.0
    # via jwt
# fastapi==0.105.0
    # via -r requirements.in
google-search-results==2.4.2
    # via locus-ferb (pyproject.toml)
idna==3.4
    # via
    #   anyio
    #   requests
jwt==1.3.1
    # via locus-ferb (pyproject.toml)
pycparser==2.22
    # via cffi
pydantic==2.8.2
    # via fastapi
pydantic-core==2.20.1
    # via pydantic
pyjwt==2.9.0
    # via locus-ferb (pyproject.toml)
requests==2.28.1
    # via
    #   google-search-results
    #   serpapi
serpapi==0.1.5
    # via locus-ferb (pyproject.toml)
sniffio==1.3.1
    # via anyio
# starlette==0.27.0
    # via fastapi
typing-extensions==4.9.0
    # via
    #   fastapi
    #   pydantic
    #   pydantic-core
urllib3==1.26.13
    # via requests
</code></pre>
<p>Attached are the two logs, running the same command one after the other:
<code>docker system prune &amp;&amp; docker build --ssh default --progress plain -f Dockerfile-fail .</code>
<a href="https://github.com/user-attachments/files/16735252/build-working.log">build-working.log</a>
<a href="https://github.com/user-attachments/files/16735253/build-failing.log">build-failing.log</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-24 05:09</div>
            <div class="timeline-body"><p>Well, in the both examples there are things like:</p>
<pre><code>#12 7.601 DEBUG File already exists (subsequent attempt), overwriting: /opt/venv/lib/python3.12/site-packages/jwt/__init__.py
</code></pre>
<p>It looks like there's a conflict between two packages and you're seeing a race condition where it succeeds or fails depending on which one overwrites the file last.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2024-08-24 05:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ramarnat">@ramarnat</a> on 2024-08-24 05:47</div>
            <div class="timeline-body"><p>That makes sense, pyjwt adds functionality to jwt, so its update to the <strong>init</strong>.py should probably come after. Is there a way to force a dependency? If it were possible to do, would that fix the race condition?</p>
<p>I'll check to see if we can remove jwt, and only keep pyjwt. But I see the same issue for another library that seems to have the same issue, in that case I know I need both libraries.</p>
<p>Or maybe I have to do a sync, and then separately install the 2nd library with <code>uv pip install</code>?</p>
<p>The race condition doesn't happen in pip, because of its slowness.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-24 05:50</div>
            <div class="timeline-body"><p>I see. I don't know if it's feasible for us to unpack packages in a defined order like that, @charliermarsh would know better.</p>
<p>It seems like pretty bad behavior for a package to rely on patching an existing one by overwriting its files. I think in this case, you'd be best off running two separate install operations â€” one to prepare the environment, and the next to patch the package.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ramarnat">@ramarnat</a> on 2024-08-24 05:56</div>
            <div class="timeline-body"><p>Could the warning be surfaced, so it's clearer that one is clobbering the other?</p>
<p>Agreed on the package behavior, but such is life with dependence on third party libs...</p>
<p>And I take back that it may not happen for us in pip, but I see articles about the import not working.
https://github.com/jpadilla/pyjwt/issues/685</p>
<p>https://stackoverflow.com/questions/68912059/module-not-found-error-when-using-google-search-api-serpapi</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Strange, non-deterministic issue with library not importing or not importing when running multiple times, failing sometimes and other times not" to "Race condition when two libraries update the same __init__.py" by @ramarnat on 2024-08-24 06:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ramarnat">@ramarnat</a> on 2024-08-24 06:40</div>
            <div class="timeline-body"><p>Also, thank you @zanieb for  identifying the issue so quickly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ramarnat">@ramarnat</a> on 2024-08-24 14:46</div>
            <div class="timeline-body"><p>After looking at what my options around working around this while sticking with &quot;sync&quot; type workflow, and was hoping to use <code>uv lock</code> and then <code>uv sync --no-install-package pyjwt</code> instead of <code>uv pip sync</code> but....
<code>The project is marked as unmanaged</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-24 15:15</div>
            <div class="timeline-body"><p>Do you have unmanaged = true set anywhere?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ramarnat">@ramarnat</a> on 2024-08-24 15:22</div>
            <div class="timeline-body"><p>I do (I set managed=false in the pyproject.toml) - because our existing docker images use /opt/venv, and was trying to avoid changing that. But I think I will move stuff into /app/.venv so can use uv sync instead of uv pip.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ramarnat">@ramarnat</a> on 2024-08-24 15:27</div>
            <div class="timeline-body"><p>Ok I have it working with this Dockerfile and uv.lock</p>
<pre><code>ROM python:3.12.3 AS build

ENV PATH=&quot;/app/.venv/bin:$PATH&quot;
ENV VIRTUAL_ENV=&quot;/app/.venv&quot;

# Python runtime dependencies
RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends \
    make \
    g++ \
    gfortran \
    cmake 


COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

WORKDIR /app
COPY uv.lock pyproject.toml ./

RUN RUST_LOG=trace uv -v --no-cache sync --no-install-package pyjwt --no-install-package google-search-results &amp;&amp;\
    RUST_LOG=trace uv -v --no-cache sync &amp;&amp;\
    python -c &quot;from jwt import PyJWKClient&quot; 
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ramarnat">@ramarnat</a> on 2024-08-24 15:30</div>
            <div class="timeline-body"><p>I would like to request a feature for future uv noobs, that warns when a library clobbers another one, I spent a fair bit of time going thru a number of permutations thinking there was something going on in my environment/cache/docker setup.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-26 13:41</div>
            <div class="timeline-body"><p>@konstin is it feasible for us to use <code>warn_user_once</code> when installing a package clobbers files?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-26 13:50</div>
            <div class="timeline-body"><p>I'm honestly not sure if we <em>should</em>, because I think there are packages that do this somewhat intentionally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-08-26 13:55</div>
            <div class="timeline-body"><p>The cases i looked where <code>__init__.py</code> happened intentionally it was the <code>__init__.py</code> in both packages. We should show a warning when they are not the same, in which case we know there is a race condition. (We have to read the existing file for that, so we'll need to use <code>Locks</code> after <code>io::ErrorKind::AlreadyExists</code> to make sure the read is non-raced)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-26 17:37</div>
            <div class="timeline-body"><p>I think this one does do it intentionally but if it's installed in the same invocation as its target package that's a big problem since we don't do it in a deterministic order?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ramarnat">@ramarnat</a> on 2024-08-26 17:58</div>
            <div class="timeline-body"><p>could there be an option - <code>uv add &lt;package&gt; --depends_on &lt;main_package&gt; </code> which would update the uv.lock to install that package after the main_package?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-26 18:41</div>
            <div class="timeline-body"><p>There <em>could</em> be but it's a pretty niche use-case and controlling the install order manually seems weird. I feel like this is a problem with the design of these packages, not a common use-case we should add configuration options for.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @zanieb on 2024-10-21 21:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wish</span> added by @zanieb on 2024-10-21 21:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-design</span> added by @zanieb on 2024-10-21 21:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ramarnat">@ramarnat</a> on 2025-02-06 04:38</div>
            <div class="timeline-body"><p>Hi there. I am revisiting my Dockerfile build as we have added some more libraries, and have found a few more instances of this race condition happening. I was wondering if there has been any other improvements/configuration settings in newer versions that might mitigate this issue...</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:21 UTC
    </footer>
</body>
</html>
