<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weird interaction between pyenv and `uv pip install --python ...` - astral-sh/uv #2068</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Weird interaction between pyenv and `uv pip install --python ...`</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/2068">#2068</a>
        opened by <a href="https://github.com/edgarrmondragon">@edgarrmondragon</a>
        on 2024-02-29 00:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/edgarrmondragon">@edgarrmondragon</a> on 2024-02-29 00:46</div>
            <div class="timeline-body"><p>The <code>--python</code> flag seems to be following some form of symlink for the python interpreter, which is causing packages to be installed outside of the desired virtual environment. Here's a reproducible example:</p>
<pre><code class="language-console">$ uv --version
uv 0.1.12 (f68b2d1d5 2024-02-28)

$ uv venv venv --python python3.11
Using Python 3.11.8 interpreter at /Users/me/.pyenv/versions/3.11.8/bin/python3.11
Creating virtualenv at: venv
Activate with: source venv/bin/activate

$ uv pip install --no-cache --python venv/bin/python cowsay
Resolved 1 package in 771ms
Downloaded 1 package in 277ms
Installed 1 package in 9ms
 + cowsay==6.1

$ ./venv/bin/cowsay -t moo
zsh: no such file or directory: ./venv/bin/cowsay
</code></pre>
<p>So you can notice the package was not installed in the virtual environment, but in the source Python interpreter:</p>
<pre><code class="language-console">$ /Users/me/.pyenv/versions/3.11.8/bin/python3.11 -m cowsay -t moo
  ___
| moo |
  ===
   \
    \
      ^__^
      (oo)\_______
      (__)\       )\/\
          ||----w |
          ||     ||
</code></pre>
<p>If I repeat the same steps but instead of using the <code>--python</code> flag, I activate the virtual environment and then install cowsay, it works as expected:</p>
<pre><code class="language-console">$ (venv) uv pip install --no-cache cowsay
Resolved 1 package in 771ms
Downloaded 1 package in 277ms
Installed 1 package in 9ms
 + cowsay==6.1

$ ./venv/bin/cowsay -t moo
  ___
| moo |
  ===
   \
    \
      ^__^
      (oo)\_______
      (__)\       )\/\
          ||----w |
          ||     ||
</code></pre>
<p>Is this all expected and I'm just using the <code>--python</code> flag wrong, or is this a bug?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-29 00:49</div>
            <div class="timeline-body"><p>Can you re-run the <code>uv pip install --no-cache --python venv/bin/python cowsay</code> command with <code>--verbose</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/edgarrmondragon">@edgarrmondragon</a> on 2024-02-29 00:52</div>
            <div class="timeline-body"><p>Here you go!</p>
<pre><code class="language-console">$ uv --verbose pip install --no-cache --python venv/bin/python cowsay
 uv::requirements::from_source source=cowsay
 uv_interpreter::python_query::find_requested_python request=venv/bin/python
      0.002480s   0ms DEBUG uv_interpreter::python_query Starting interpreter discovery for Python venv/bin/python
      0.003579s   1ms DEBUG uv_interpreter::interpreter Probing interpreter info for: /Users/me/.pyenv/versions/3.11.8/bin/python3.11
      0.034149s  31ms DEBUG uv_interpreter::interpreter Found Python 3.11.8 for: /Users/me/.pyenv/versions/3.11.8/bin/python3.11
    0.034411s DEBUG uv::commands::pip_install Using Python 3.11.8 environment at /Users/me/.pyenv/versions/3.11.8/bin/python3.11
Audited 1 package in 35ms

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-29 00:56</div>
            <div class="timeline-body"><p>My guess is we shouldn't be canonicalizing paths (i.e., following symlinks) for pyenv shims, I'll play around with it...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-29 01:03</div>
            <div class="timeline-body"><p>We should def fix this but can I ask what the motivation is for using <code>--python</code> with a virtualenv? (Did you see this behavor with non-venv Python?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-02-29 01:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-02-29 01:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/edgarrmondragon">@edgarrmondragon</a> on 2024-02-29 01:16</div>
            <div class="timeline-body"><blockquote>
<p>We should def fix this but can I ask what the motivation is for using <code>--python</code> with a virtualenv? (Did you see this behavor with non-venv Python?)</p>
</blockquote>
<p>So, we create venvs and install packages in them on behalf of users. That involves calling the equivalent of <code>./venv/bin/python -m pip install ...</code> (<a href="https://github.com/meltano/meltano/blob/e61deee2d39667cc5065b1f178d8b4bdf2910b2c/src/meltano/core/venv_service.py#L447-L456">source code</a>).</p>
<p>We are able to do that because pip is seeded into every virtual environment, but that's not the case with uv, so I figured <code>--python</code> would allow us to get similar behavior.</p>
<p>I guess an alternative is to pass <code>VIRTUAL_ENV=./venv/bin/python</code> to the subprocess uv call ü§∑‚Äç‚ôÇÔ∏è.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-29 01:22</div>
            <div class="timeline-body"><p>Yeah, I think either should work (though the pyenv behavior is buggy, will fix).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-29 01:35</div>
            <div class="timeline-body"><p>(I see the issue, will fix for the next release.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-02-29 02:32</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 05:43:06 UTC
    </footer>
</body>
</html>
