<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv incorrectly excludes pre-release Python versions when `requires-python` is greater or equal to that version - astral-sh/uv #4714</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv incorrectly excludes pre-release Python versions when <code>requires-python</code> is greater or equal to that version</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/4714">#4714</a>
        opened by <a href="https://github.com/notatallshaw">@notatallshaw</a>
        on 2024-07-01 23:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/notatallshaw">@notatallshaw</a></div>
            <div class="timeline-body"><p>Tested on:</p>
<ul>
<li>uv 0.2.18</li>
<li>Python 3.13.0b3</li>
</ul>
<p>Create a pyproject.toml like so:</p>
<pre><code class="language-toml">[project]
name = &quot;foo&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.13&quot;

[build-system]
requires = [&quot;setuptools&quot;, &quot;wheel&quot;]
build-backend = &quot;setuptools.build_meta&quot;
</code></pre>
<p>Dry install with uv fails:</p>
<pre><code>$  uv pip install --dry-run .
  × No solution found when resolving dependencies:
  ╰─▶ Because the current Python version (3.13.0b3) does not satisfy Python&gt;=3.13 and foo==0.1.0 depends on Python&gt;=3.13, we can conclude that
  	foo==0.1.0 cannot be used.
  	And because only foo==0.1.0 is available and you require foo, we can conclude that the requirements are unsatisfiable.
</code></pre>
<p>Dry install with pip succeeds:</p>
<pre><code>$ pip install --dry-run .
Processing /home/damian/opensource/support/uv/4536
  Installing build dependencies ... done
  Getting requirements to build wheel ... done
  Preparing metadata (pyproject.toml) ... done
Would install foo-0.1.0
</code></pre>
<p><em>IMO</em> pip is following the spec here and uv is not. Specifically if we take <code>requires-python</code> to be a Version as defined by PEP 440, then according to: https://packaging.python.org/en/latest/specifications/version-specifiers/#handling-of-pre-releases then the installed version of Python should already be accepted based on:</p>
<blockquote>
<p>accept already installed pre-releases for all version specifiers</p>
</blockquote>
<p>Moreover, intuitively, if a developer splits up their package releases between <code>python &lt; 3.11</code> and <code>python &gt;= 3.11</code> they should not expect there to be a hole of Python versions.</p>
<p>But let me know if you know some more specific part of the spec that says my interpretation is wrong, I will file a bug against pip.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-01 23:21</div>
            <div class="timeline-body"><p>I don't feel strongly about this, I'm fine with effectively omitting pre-releases for Python version handling.</p>
<p>What does &quot;accept already installed pre-releases for all version specifiers&quot; mean? Is that like, if some does <code>pip install foo&gt;=3.0</code> and you already have <code>foo==3.0.0a0</code> installed, it should be satisfy the requirement?</p>
<p>I maintain that per the spec a pre-release version should not satisfy <code>python_version &lt; 3.11 or python_version &gt;= 3.11</code> -- for example, <code>uv pip compile --python-version 3.11.0a0</code> would be correct to exclude that dependency in formal terms (I don't think we even allow pre-releases there, just an example) -- but I agree that it's not really sensible.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-07-01 23:29</div>
            <div class="timeline-body"><blockquote>
<p>What does &quot;accept already installed pre-releases for all version specifiers&quot; mean? Is that like, if some does <code>pip install foo&gt;=3.0</code> and you already have <code>foo==3.0.0a0</code> installed, it should be satisfy the requirement?</p>
</blockquote>
<p>Yes, that has been my interpretation anyway.</p>
<blockquote>
<p>I maintain that per the spec a pre-release version should not satisfy python_version &lt; 3.11 or python_version &gt;= 3.11</p>
</blockquote>
<p>I don't follow your logic. If we were talking about remote packages versions instead of python_versions it would match though.</p>
<p>Let's say package &quot;foo&quot; there was only one remote package version, and it was &quot;foo 3.11.0a0&quot;, then it would match <code>foo &lt; 3.11 or foo &gt;= 3.11</code>. And in the context of Python versions, during installation, there is only ever one version, so to me at least it seems intuitive it matches.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-01 23:43</div>
            <div class="timeline-body"><p>You might be right on that last point. It's sort of hard for me to reason about in a world in which (1) we can install Python versions on-demand to meet <code>requires-python</code> and (2) we're trying to resolve for a range of Python versions at once. But I guess the thinking is: when you go to install, that's the only version available, so pre-releases should always be allowed?</p>
<p>Separately, if <code>requires-python = &quot;&gt;=3.13&quot;</code> is interpreted as allowing pre-releases, is there no way for package authors to indicate that their package does not support those pre-release versions?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-07-01 23:49</div>
            <div class="timeline-body"><p>Dug through the pip codebase, I think the line that ends up allowing Python prereleases is this one (at least in the &quot;new&quot; resolver): https://github.com/pypa/pip/blob/24.1.1/src/pip/_internal/resolution/resolvelib/requirements.py#L207</p>
<p>It looks like it was implemented by https://github.com/pypa/pip/pull/8079, and a side effect of the issue that releases with only prereleases should be installed https://github.com/pypa/pip/issues/8075.</p>
<p>But maybe there is a deeper history to this that I'm unware of.</p>
<blockquote>
<p>You might be right on that last point. It's sort of hard for me to reason about in a world in which (1) we can install Python versions on-demand to meet requires-python and (2) we're trying to resolve for a range of Python versions at once. But I guess the thinking is: when you go to install, that's the only version available, so pre-releases should always be allowed?</p>
</blockquote>
<p>That's my thinking anyway, I'm not sure anyone who wrote the spec had your scenario in mind. Is anyone else doing universal resolution other than Poetry? It might be worth sanity checking against what Poetry does.</p>
<blockquote>
<p>Separately, if requires-python = &quot;&gt;=3.13&quot; is interpreted as allowing pre-releases, is there no way for package authors to indicate that their package does not support those pre-release versions?</p>
</blockquote>
<p>Well, technically they could do something like:</p>
<pre><code>requires-python = &quot;&gt;=3.13, !=3.13.0a1, !=3.13.0a2, !=3.13.0a3, !=3.13.0a4, !=3.13.0a5, !=3.13.0a6, !=3.13.0b1, !=3.13.0b2, !=3.13.0b3&quot;</code></pre>
<p>Which I've seen similiar syntax for package versions due to the limited way you can express ranges with holes in them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-07-02 01:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-07-02 01:58</div>
            <div class="timeline-body"><p>I'd be happy to make a Python packaging discussion on this to seek clarification from the broader community if you'd prefer to see if there's consensus on this.</p>
<p>It's certainly not explicity spelled out in the spec, and I know sometimes the way I read the spec is not in line with the way the spec authors intended it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-02 02:04</div>
            <div class="timeline-body"><p>Na it's alright. We already have this semantics with <code>--universal</code> (but not when normalizing the markers -- only when determining package compatibility). I just need to find time to reason through the conversions and make it consistent everywhere.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-07-02 02:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-03 17:08</div>
            <div class="timeline-body"><p>Still trying to figure out how pip actually allows this given:</p>
<pre><code class="language-python">&gt;&gt;&gt; from packaging import specifiers
&gt;&gt;&gt; specifiers.SpecifierSet(&quot;&gt;=3.13&quot;).contains(&quot;3.13.0b0&quot;, prereleases=True)
False
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-07-03 17:31</div>
            <div class="timeline-body"><p>Ah you're right, the <code>prereleases=True</code> there is a red herring.</p>
<p>The reason pip includes prerelease versions of Python is when it extracts the version from Python it only takes the first 3 elements of the version object: https://github.com/pypa/pip/blob/24.1.1/src/pip/_internal/resolution/resolvelib/candidates.py#L540</p>
<pre><code class="language-python">&gt;&gt;&gt; sys.version_info
sys.version_info(major=3, minor=13, micro=0, releaselevel='beta', serial=3)
&gt;&gt;&gt; sys.version_info[:3]
(3, 13, 0)
&gt;&gt;&gt; &quot;.&quot;.join(str(c) for c in sys.version_info[:3])
'3.13.0'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-07-03 17:39</div>
            <div class="timeline-body"><p>I appreciate that seems to invalidate most of my reasoning, I will need to run some more checks and think on this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-03 17:40</div>
            <div class="timeline-body"><p>That actually makes life a lot easier for us though, if we just want to mimic that...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-07-03 18:00</div>
            <div class="timeline-body"><p>True, it does make me think though that you can't do any sort of prerelease exclusion, I will do some more careful testing and report an issue on pip side to see if maintainers have an opinion on that.</p>
<p>Going back to the spec I find the following: https://packaging.python.org/en/latest/specifications/pyproject-toml/#requires-python</p>
<p>Which links to: https://packaging.python.org/en/latest/specifications/core-metadata/#core-metadata-requires-python</p>
<p>It's all rather underspecified, and unfortunately uses the word <em>may</em>. Oh well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-07-04 20:06</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:25:27 UTC
    </footer>
</body>
</html>
