<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lock package destination directories on install - astral-sh/uv #520</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Lock package destination directories on install</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/520">#520</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2023-11-30 16:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/zanieb">@zanieb</a> on 2023-11-30 16:12</div>
            <div class="timeline-body"><p>As a follow-up to https://github.com/astral-sh/puffin/pull/516, we should have in-process locks which prevent concurrent writes to a package directory ensuring that we end up with at least one complete package e.g. when installing packages that write files to the same module. Additionally, we should ensure that linking always overrides existing files.</p>
<p>See https://github.com/astral-sh/puffin/pull/516#issuecomment-1834067560</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Initial release" by @zanieb on 2023-11-30 16:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/516.html">astral-sh/uv#516</a> on 2023-11-30 16:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wish</span> added by @charliermarsh on 2023-12-01 18:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-12-26 15:45</div>
            <div class="timeline-body"><p>Using the <code>install-many</code> dev command with the pypi 10k most dependents dataset, it's almost certain to trigger a non-deterministic error at some point on my machine.</p>
<pre><code>virtualenv --clear -p 3.10 .venv310 -q &amp;&amp; VIRTUAL_ENV=.venv310 RUST_LOG=puffin=info cargo run --bin puffin-dev --profile profiling -- install-many --no-build scripts/popular_packages/pypi_10k_most_dependents.txt
</code></pre>
<p>Both for files ...</p>
<pre><code>puffin-dev failed
  Caused by: Failed to install
  Caused by: Failed to install: pyppeteer-1.0.2-py3-none-any.whl
  Caused by: failed to hardlink file from /home/konsti/.cache/puffin/wheels-v0/pypi/pyppeteer/pyppeteer-1.0.2-py3-none-any/README.md to /home/konsti/projects/puffin/.venv310/lib/python3.10/site-packages/README.md
</code></pre>
<p>... and directories</p>
<pre><code>puffin-dev failed
  Caused by: Failed to install
  Caused by: Failed to install: jupyterlab-4.1.0b0-py3-none-any.whl (jupyterlab==4.1.0b0)
  Caused by: failed to create directory `/home/konsti/projects/puffin/.venv310/etc`
  Caused by: File exists (os error 17)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/732.html">astral-sh/uv#732</a> on 2023-12-26 16:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-02-02 20:06</div>
            <div class="timeline-body"><p>Fixed in #929</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2024-02-02 20:06</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:56 UTC
    </footer>
</body>
</html>
