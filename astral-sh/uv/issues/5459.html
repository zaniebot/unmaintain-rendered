<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python environment &quot;layering&quot; Rye vs Uv - astral-sh/uv #5459</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Python environment &quot;layering&quot; Rye vs Uv</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/5459">#5459</a>
        opened by <a href="https://github.com/bluss">@bluss</a>
        on 2024-07-25 18:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/bluss">@bluss</a> on 2024-07-25 18:33</div>
            <div class="timeline-body"><p>Here we are comparing <code>rye run</code> and <code>uv run</code>, how they behave w.r.t the python virtual environment they are started from.</p>
<p>Steps to reproduce: https://github.com/bluss/uv-issue-5459</p>
<p>We have a process tree like this</p>
<ul>
<li>rye run foo       <em>This starts some bigger application foo</em><ul>
<li>rye run bar       <em>Somewhere inside foo another application bar is started.</em></li>
</ul>
</li>
</ul>
<p>Foo and bar live in different projects or in different packages. And we can do the same thing using <code>uv run</code> instead of <code>rye run</code>:</p>
<ul>
<li>uv run foo<ul>
<li>uv run bar</li>
</ul>
</li>
</ul>
<p>.</p>
<ul>
<li><p>What happens in Rye is that it doesn't matter what virtualenv is active and so on, <code>foo</code> is executed in its project context with its own virtualenv. <code>bar</code> is executed the same way, with its own virtualenv.</p>
</li>
<li><p>What happens in Uv is that <code>bar</code> is executed in a python environment that &quot;layers&quot; on top of <code>foo</code>. So what the python program in bar sees is that it can use a mix of packages from both foo and bar.</p>
</li>
</ul>
<p>There's a different case for <code>uv run --with</code>, then we have:</p>
<ul>
<li>base project environment .venv<ul>
<li>uv run --with's ephemeral environment</li>
</ul>
</li>
</ul>
<p>In this case the two environments also layer each other. I thought that was kind of cool, in this case. But not in the original case.</p>
<p>I think this strict project focus and separation is an important selling point of rye. It makes more robust applications possible.</p>
<p>I don't know why this happens, but one difference I can notice when comparing rye run python and uv run python in the same project, is that only uv sets PYTHONPATH.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-25 18:35</div>
            <div class="timeline-body"><blockquote>
<p>What happens in Uv is that bar is executed in a python environment that &quot;layers&quot; on top of foo. So what the python program in bar sees is that it can use a mix of packages from both foo and bar.</p>
</blockquote>
<p>Hmm, I don't think it's intentional that <code>uv run bar</code> (is that being run from within <code>bar</code>?) is layered on top of <code>foo</code>. We should only be layering when <code>--with</code> is provided. Can you add an MRE?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bluss">@bluss</a> on 2024-07-25 19:02</div>
            <div class="timeline-body"><p>Sure, came up with this repository which I hope shows what happens https://github.com/bluss/uv-issue-5459</p>
<p>As one can guess, my real life use case for this is that foo=jupyterlab and bar=notebook kernel, which live in separate projects. But you could imagine that you would run an editor (spyder?) as the &quot;foo&quot; and any other developer tool as &quot;bar&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bluss">@bluss</a> on 2024-07-25 19:45</div>
            <div class="timeline-body"><p>I would consider dropping setting PYTHONPATH entirely in uv run - (if this should be fixed! Don't know that..)</p>
<p>Nesting can possibly be done right using a <a href="https://docs.python.org/3/library/site.html">path file</a> when using ephemeral environments? I don't have experience with that, but it sounds right - I don't know what's been attempted already(!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-25 20:58</div>
            <div class="timeline-body"><p>Thank you! What do you see as the issue with modifying <code>PYTHONPATH</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-25 21:03</div>
            <div class="timeline-body"><p>This is a very good example, I <em>think</em> I consider it a bug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bluss">@bluss</a> on 2024-07-25 21:06</div>
            <div class="timeline-body"><p>PYTHONPATH seems to be the factor that causes this.</p>
<p>PYTHONPATH shouldn't need to be set for using a virtual environment in the normal way. I can see why the environment layering (base project + ephemeral) would reach for using it, however, but maybe that can be avoided too. (I'm sure someone somewhere in history has lost a lot of time to virtual environment chaining and I haven't and don't know what works well..)</p>
<p>One can compare uv vs rye sys.path outcomes and notice that PYTHONPATH usage also moves the venv site-packages to be earlier than stdlib for uv, while it is not for rye. Does this mean that execution of a program - if it depends on shadowing one way or the other - could be subtly different for uv run thescript and .venv/bin/thescript?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-25 21:10</div>
            <div class="timeline-body"><p>Yeah, but we can fix the proximate issue by not &quot;propagating&quot; <code>PYTHONPATH</code> through nested calls:</p>
<pre><code class="language-diff">diff --git a/crates/uv/src/commands/project/run.rs b/crates/uv/src/commands/project/run.rs
index 34348a8f0..97f8153d1 100644
--- a/crates/uv/src/commands/project/run.rs
+++ b/crates/uv/src/commands/project/run.rs
@@ -452,15 +452,11 @@ pub(crate) async fn run(
                     .flatten(),
             )
             .map(PathBuf::from)
-            .chain(
-                std::env::var_os(&quot;PYTHONPATH&quot;)
-                    .as_ref()
-                    .iter()
-                    .flat_map(std::env::split_paths),
-            ),
     )?;
     process.env(&quot;PYTHONPATH&quot;, new_python_path);
</code></pre>
<p>There may be other issues with it though. Gonna ask some more knowledge people.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bluss">@bluss</a> on 2024-07-25 21:23</div>
            <div class="timeline-body"><p>It would be cool to try to drop PYTHONPATH entirely and try the path configuration file route. Do you know why pythonpath is used at all? Is it in case the user has existing settings for PYTHONPATH?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-25 21:26</div>
            <div class="timeline-body"><p>I think I learned about it from <a href="https://github.com/jaraco/pip-run">pip-run</a> and Jason knows a lot about this kind of manipulation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-25 21:27</div>
            <div class="timeline-body"><p>Maybe a <code>.pth</code> file would work, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-07-25 21:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-25 21:47</div>
            <div class="timeline-body"><p>I talked to @carljm and he walked me through how we might do it with <code>sitecustomize.py</code>, so I'll give that a shot.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @charliermarsh on 2024-07-25 21:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/5462.html">astral-sh/uv#5462</a> on 2024-07-25 23:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-07-25 23:30</div>
            <div class="timeline-body"><p>To be clear, the reason for <code>sitecustomize.py</code> over a pth file is to get processing of pth files in the added directory, so editable installs in the base environment are still importable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-07-25 23:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-07-25 23:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/7699.html">astral-sh/uv#7699</a> on 2024-09-26 16:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:58 UTC
    </footer>
</body>
</html>
