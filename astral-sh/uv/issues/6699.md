```yaml
number: 6699
title: Stubs on Windows exit abnormally, includes succinct repro with busybox, related to some wider issue
type: issue
state: closed
author: doctorpangloss
labels:
  - windows
assignees: []
created_at: 2024-08-27T16:27:31Z
updated_at: 2024-10-28T09:01:36Z
url: https://github.com/astral-sh/uv/issues/6699
synced_at: 2026-01-10T01:57:14Z
```

# Stubs on Windows exit abnormally, includes succinct repro with busybox, related to some wider issue

---

_Issue opened by @doctorpangloss on 2024-08-27 16:27_

related: https://github.com/rmyorston/busybox-w32/issues/451
related: https://github.com/astral-sh/uv/issues/6464

![WindowsTerminal_qBCDluBxeQ](https://github.com/user-attachments/assets/fd8bcc34-930e-4664-9c32-704d039c9ab2)

```
wget https://frippery.org/files/busybox/prerelease/busybox_pre64.exe
busybox_pre64.exe sh -X
mkdir uv-test
cd uv-test
uv venv --seed
source .venv/scripts/activate
# uses stub
pip install insightface
```

Observe `pip` exits abnormally under this shell. In Powershell it works fine.

uv 0.3.4 (39f3cd2a9 2024-08-26)
Windows 2022

All stubs, not just `pip`, are cursed this way. The stubs created by native `pip` do not have any issues.

---

_Renamed from "Stubs on Windows exit abnormally when run under busybox, indicating wider issue" to "Stubs on Windows exit abnormally, includes succinct repro with busybox, related to some wider issue" by @doctorpangloss on 2024-08-27 16:27_

---

_Comment by @rmyorston on 2024-08-28 08:20_

I can see the problem, but don't have much idea why it occurs.

What I've done:
- Install Python on Windows using an installer from python.org.
- From PowerShell run `pip install uv`.
- From a busybox-w32 shell do the whole `mkdir uv-test; ... ; pip install insightface` thing. As promised, it doesn't work.

The question is why not. I was suspicious of the changes the busybox-w32 shell makes to environment variables when it reads them in as shell variables. By default it converts the variable names to uppercase and replaces backslashes with forward slashes in the value. (There are a couple of exceptions to the latter, it seemed possible more might be needed.)

I made a custom shell so those changes could be avoided. It remains necessary to change `Path` to `PATH`, or the shell won't find any external commands. `pip install insightface` still fails with a segfault. I do note, though, that if the failing process is stopped with an error dialog the installation seems to carry on in the background until the dialog is closed.

---

_Comment by @zanieb on 2024-08-28 12:45_

Thanks for the report. I presume this is a bug in our "trampoline" that's used for executables on Windows. I don't see an error message in the video, what's the failure mode exactly?

---

_Label `windows` added by @zanieb on 2024-08-28 12:46_

---

_Comment by @samypr100 on 2024-08-28 12:48_

>By default it converts the variable names to uppercase and replaces backslashes with forward slashes in the value.

Does this behave as if it was a MinGW based environment? There's been a number of MinGW related issues, especially when it comes to paths. e.g. https://github.com/astral-sh/uv/issues/3573

---

_Comment by @rmyorston on 2024-08-28 16:35_

@zanieb In my experience the failure mode is a 0xc0000005 error, which I (possibly wrongly) equate to a segfault.

---

_Comment by @rmyorston on 2024-08-28 17:08_

@samypr100 The issue you reference seems to be somewhat confused about what MinGW means. (And I'm not sure I can be lucid enough to clear up the confusion.)

MinGW (and these days that generally means [MinGW-w64](https://www.mingw-w64.org)) is a set of headers and libraries which make it possible to build native Windows applications.

There are various ways that can be done:
- I cross-compile on Linux.
- There's the Windows-native [w64devkit](https://github.com/skeeto/w64devkit) toolchain.
- [MSYS2](https://www.msys2.org) is an alternative toolchain for Windows.

busybox-w32 is built using MinGW, so it's a native Windows binary which deals in native Windows paths.

This can be opposed to binaries built using the Cygwin DLL, such as those that come with  MSYS2: these see fake POSIX paths.

When the referenced issue talks of 'mingw python' it seems to mean the Python that's shipped with MSYS2. This is built using the Cygwin DLL and understands non-Windows paths. _I_ wouldn't call that a 'MinGW Python'. Furthermore, I wouldn't be at all surprised to hear there have been issues with it's expectations regarding paths.

---

_Referenced in [astral-sh/uv#6792](../../astral-sh/uv/pulls/6792.md) on 2024-08-29 04:38_

---

_Comment by @samypr100 on 2024-08-29 04:46_

@rmyorston Thanks for the explanation. I've made an adjustment in #6792 that would fix this issue, or at least not fault. I haven't digged into the busybox impl, but `lpReserved2` reports multiple file descriptors which are invalid handles which led to the issue manifesting. For now, I've switched the implementation to ignore any handle that seems to be invalid.

https://github.com/astral-sh/uv/blob/3be4fe59d7fc0ed1f8906259c9723247460804ce/crates/uv-trampoline/src/bounce.rs#L347-L349

---

_Comment by @rmyorston on 2024-08-29 06:26_

@samypr100 The fix sounds promising, thanks.

The shell in busybox-w32 uses `spawnve()` from the Microsoft C runtime to invoke external commands. What happens after that is up to Microsoft.

It'll be interesting to know if the fix also resolves #6464.

---

_Closed by @konstin on 2024-08-30 08:55_

---

_Comment by @doctorpangloss on 2024-08-30 22:47_

Is it expected to see

```
Failed to close child file descriptors at 1
```

when invoking the stub from within sh onto stderr? otherwise things appear to be behaving normally

---

_Referenced in [astral-sh/uv#6866](../../astral-sh/uv/issues/6866.md) on 2024-08-31 05:53_

---

_Referenced in [astral-sh/uv#6955](../../astral-sh/uv/pulls/6955.md) on 2024-09-03 02:31_

---

_Comment by @samypr100 on 2024-09-04 22:45_

@doctorpangloss Would you be able to confirm 0.4.5 fixes the fd issue for you?

---

_Comment by @doctorpangloss on 2024-09-09 23:19_

```
$ pip install -U uv
Collecting uv
  Obtaining dependency information for uv from https://files.pythonhosted.org/packages/06/f2/0278155d4b2726765bcad89e5bc6020a1afb52d2bfe8cf1602758e44a93f/uv-0.4.8-py3-none-win_amd64.whl.metadata
  Downloading uv-0.4.8-py3-none-win_amd64.whl.metadata (11 kB)
Downloading uv-0.4.8-py3-none-win_amd64.whl (12.7 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 12.7/12.7 MB 17.2 MB/s eta 0:00:00
Installing collected packages: uv
Successfully installed uv-0.4.8
WARNING: There was an error checking the latest version of pip.
(.venv) ~/Documents/appmana $ cd appmana-comfyui/src/
(.venv) ~/Documents/appmana/appmana-comfyui/src $ uv pip install --no-deps -e .
Resolved 1 package in 18ms
Installed 1 package in 14ms
 + comfyui==0.0.1 (from file:///C:/Users/bberman/Documents/appmana/appmana-comfyui/src)
(.venv) ~/Documents/appmana/appmana-comfyui/src $ comfyui -w ../../appmana-artworkspace/src/workdir/
Failed to close child file descriptors at 1
```

no, unfortunately the stubs still show the issue, they do work though

---

_Comment by @samypr100 on 2024-09-10 00:00_

Could you provide steps on how to reproduce this particular case?

---

_Comment by @doctorpangloss on 2024-09-10 00:25_

nervermind it's resolved! 0.4.8 has fixed it

---
