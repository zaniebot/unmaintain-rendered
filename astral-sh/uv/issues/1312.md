```yaml
number: 1312
title: Benchmarks cannot be run under PowerShell
type: issue
state: open
author: MichaReiser
labels:
  - internal
  - windows
assignees: []
created_at: 2024-02-15T09:14:23Z
updated_at: 2025-12-02T10:31:10Z
url: https://github.com/astral-sh/uv/issues/1312
synced_at: 2026-01-10T01:57:01Z
```

# Benchmarks cannot be run under PowerShell

---

_Issue opened by @MichaReiser on 2024-02-15 09:14_

Running the benchmarks on windows currently fails for several reasons:

* The script fails to find the `pdm`, `poetry`, `pip-compile`, ... binaries. I had to pass them manually and had to change the script to never run the benchmarks with the *default* binary if e.g. `--pdm-path` is specified
* There are multiple cases where we use `rm` in prepare scripts. We need to replace them with `rmdir` or `del`
* There's something else that I haven't been able to figure out quickly. 
  ```
  Benchmark 1: C:\Users\Micha\astral\puffin\.venv\Scripts\pip-compile.exe (resolve-warm)
  Could Not Find C:\Users\Micha\AppData\Local\Temp\tmp4ou6fhbn\tmpm4v1jonc\requirements.txt
  The filename, directory name, or volume label syntax is incorrect.
  ```

<details>
	<summary>My local patch</summary>

```diff
Index: scripts/bench/__main__.py
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/scripts/bench/__main__.py b/scripts/bench/__main__.py
--- a/scripts/bench/__main__.py	(revision e4fffc15f5c467e851267a85309496cb0907d45e)
+++ b/scripts/bench/__main__.py	(date 1707988190584)
@@ -197,7 +197,7 @@
 
         return Command(
             name=f"{self.name} ({Benchmark.RESOLVE_COLD.value})",
-            prepare=f"rm -rf {cwd} && rm -f {output_file}",
+            prepare=f"{rm_dir(cwd)} && {rm_file(output_file)}",
             command=[
                 self.path,
                 os.path.abspath(requirements_file),
@@ -215,7 +215,7 @@
 
         return Command(
             name=f"{self.name} ({Benchmark.RESOLVE_WARM.value})",
-            prepare=f"rm -f {output_file}",
+            prepare=f"{rm_file(output_file)}",
             command=[
                 self.path,
                 os.path.abspath(requirements_file),
@@ -260,7 +260,7 @@
 
         return Command(
             name=f"{self.name} ({Benchmark.RESOLVE_INCREMENTAL.value})",
-            prepare=f"rm -f {output_file} && cp {baseline} {output_file}",
+            prepare=f"{rm_file(output_file)} && cp {baseline} {output_file}",
             command=[
                 self.path,
                 input_file,
@@ -300,7 +300,7 @@
 
         return Command(
             name=f"{self.name} ({Benchmark.INSTALL_COLD.value})",
-            prepare=f"rm -rf {cache_dir} && virtualenv --clear -p 3.12 {venv_dir}",
+            prepare=f"{rm_dir(cache_dir)} && virtualenv --clear -p 3.12 {venv_dir}",
             command=[
                 self.path,
                 os.path.abspath(requirements_file),
@@ -340,6 +340,8 @@
         import tomli_w
         from packaging.requirements import Requirement
 
+        print(self.path)
+
         # Parse all dependencies from the requirements file.
         with open(requirements_file) as fp:
             requirements = [
@@ -360,8 +362,8 @@
                 "3.12",
             ],
             cwd=cwd,
-            stdout=subprocess.DEVNULL,
-            stderr=subprocess.DEVNULL,
+#             stdout=subprocess.DEVNULL,
+#             stderr=subprocess.DEVNULL,
         )
 
         # Parse the pyproject.toml.
@@ -392,10 +394,10 @@
         return Command(
             name=f"{self.name} ({Benchmark.RESOLVE_COLD.value})",
             prepare=(
-                f"rm -rf {config_dir} && "
-                f"rm -rf {cache_dir} && "
-                f"rm -rf {data_dir} &&"
-                f"rm -rf {poetry_lock}"
+                f"{rm_dir(config_dir)} && "
+                f"{rm_dir(cache_dir)} && "
+                f"{rm_dir(data_dir)} &&"
+                f"{rm_file(poetry_lock)}"
             ),
             command=[
                 f"POETRY_CONFIG_DIR={config_dir}",
@@ -418,7 +420,7 @@
 
         return Command(
             name=f"{self.name} ({Benchmark.RESOLVE_WARM.value})",
-            prepare=f"rm -f {poetry_lock}",
+            prepare=f"{rm_file(poetry_lock)}",
             command=[
                 f"POETRY_CONFIG_DIR={config_dir}",
                 f"POETRY_CACHE_DIR={cache_dir}",
@@ -478,7 +480,7 @@
 
         return Command(
             name=f"{self.name} ({Benchmark.RESOLVE_INCREMENTAL.value})",
-            prepare=f"rm -f {poetry_lock} && cp {baseline} {poetry_lock}",
+            prepare=f"{rm_file(poetry_lock)} && cp {baseline} {poetry_lock}",
             command=[
                 f"POETRY_CONFIG_DIR={config_dir}",
                 f"POETRY_CACHE_DIR={cache_dir}",
@@ -517,9 +519,9 @@
         return Command(
             name=f"{self.name} ({Benchmark.INSTALL_COLD.value})",
             prepare=(
-                f"rm -rf {config_dir} && "
-                f"rm -rf {cache_dir} && "
-                f"rm -rf {data_dir} &&"
+                f"{rm_dir(config_dir)} && "
+                f"{rm_dir(cache_dir)} && "
+                f"{rm_dir(data_dir)} &&"
                 f"virtualenv --clear -p 3.12 {venv_dir} --no-seed"
             ),
             command=[
@@ -623,7 +625,7 @@
 
         return Command(
             name=f"{self.name} ({Benchmark.RESOLVE_COLD.value})",
-            prepare=f"rm -rf {cache_dir} && rm -rf {pdm_lock} && {self.path} config cache_dir {cache_dir}",
+            prepare=f"{rm_dir(cache_dir)} && {rm_file(pdm_lock)} && {self.path} config cache_dir {cache_dir}",
             command=[
                 self.path,
                 "lock",
@@ -640,7 +642,7 @@
 
         return Command(
             name=f"{self.name} ({Benchmark.RESOLVE_WARM.value})",
-            prepare=f"rm -rf {pdm_lock} && {self.path} config cache_dir {cache_dir}",
+            prepare=f"{rm_dir(pdm_lock)} && {self.path} config cache_dir {cache_dir}",
             command=[
                 self.path,
                 "lock",
@@ -689,7 +691,7 @@
 
         return Command(
             name=f"{self.name} ({Benchmark.RESOLVE_INCREMENTAL.value})",
-            prepare=f"rm -f {pdm_lock} && cp {baseline} {pdm_lock} && {self.path} config cache_dir {cache_dir}",
+            prepare=f"{rm_file(pdm_lock)} && cp {baseline} {pdm_lock} && {self.path} config cache_dir {cache_dir}",
             command=[
                 self.path,
                 "lock",
@@ -721,7 +723,7 @@
         return Command(
             name=f"{self.name} ({Benchmark.INSTALL_COLD.value})",
             prepare=(
-                f"rm -rf {cache_dir} && "
+                f"{rm_dir(cache_dir)} && "
                 f"{self.path} config cache_dir {cache_dir} && "
                 f"virtualenv --clear -p 3.12 {venv_dir} --no-seed"
             ),
@@ -788,7 +790,7 @@
 
         return Command(
             name=f"{self.name} ({Benchmark.RESOLVE_COLD.value})",
-            prepare=f"rm -rf {cwd} && rm -f {output_file}",
+            prepare=f"{rm_dir(cwd)} && {rm_file(output_file)}",
             command=[
                 self.path,
                 "pip",
@@ -807,7 +809,7 @@
 
         return Command(
             name=f"{self.name} ({Benchmark.RESOLVE_WARM.value})",
-            prepare=f"rm -f {output_file}",
+            prepare=f"{rm_file(output_file)}",
             command=[
                 self.path,
                 "pip",
@@ -856,7 +858,7 @@
 
         return Command(
             name=f"{self.name} ({Benchmark.RESOLVE_INCREMENTAL.value})",
-            prepare=f"rm -f {output_file} && cp {baseline} {output_file}",
+            prepare=f"{rm_file(output_file)} && cp {baseline} {output_file}",
             command=[
                 self.path,
                 "pip",
@@ -875,7 +877,7 @@
 
         return Command(
             name=f"{self.name} ({Benchmark.INSTALL_COLD.value})",
-            prepare=f"rm -rf {cache_dir} && virtualenv --clear -p 3.12 {venv_dir}",
+            prepare=f"{rm_dir(cache_dir)} && virtualenv --clear -p 3.12 {venv_dir}",
             command=[
                 f"VIRTUAL_ENV={venv_dir}",
                 self.path,
@@ -1017,25 +1019,25 @@
 
     # Determine the tools to benchmark, based on the user-provided arguments.
     suites = []
-    if args.pip_sync:
-        suites.append(PipSync())
-    if args.pip_compile:
-        suites.append(PipCompile())
-    if args.poetry:
-        suites.append(Poetry())
-    if args.pdm:
-        suites.append(Pdm())
-    if args.puffin:
-        suites.append(Puffin())
-    for path in args.pip_sync_path or []:
+    # if args.pip_sync:
+    #     suites.append(PipSync())
+    # if args.pip_compile:
+    #     suites.append(PipCompile())
+    # if args.poetry:
+    #     suites.append(Poetry())
+    # if args.pdm:
+    #     suites.append(Pdm())
+    # if args.puffin:
+    #     suites.append(Puffin())
+    for path in args.pip_sync_path or [None]:
         suites.append(PipSync(path=path))
-    for path in args.pip_compile_path or []:
+    for path in args.pip_compile_path or [None]:
         suites.append(PipCompile(path=path))
-    for path in args.poetry_path or []:
+    for path in args.poetry_path or [None]:
         suites.append(Poetry(path=path))
-    for path in args.pdm_path or []:
+    for path in args.pdm_path or [None]:
         suites.append(Pdm(path=path))
-    for path in args.puffin_path or []:
+    for path in args.puffin_path or [None]:
         suites.append(Puffin(path=path))
 
     # If no tools were specified, benchmark all tools.
@@ -1091,5 +1093,18 @@
                 hyperfine.run()
 
 
+def rm_dir(directory: str) -> str:
+    if os.name == "nt":
+        return f"rmdir /s /q {directory}"
+
+    return "rm -rf {dir}"
+
+def rm_file(file: str) -> str:
+    if os.name == "nt":
+        return f"del /f {file}"
+
+    return f"rm -f {file}"
+
+
 if __name__ == "__main__":
     main()

```
</details>

---

_Label `windows` added by @MichaReiser on 2024-02-15 09:14_

---

_Renamed from "Windows: Can't run Benchmarks" to "PowerShel: Can't run Benchmarks" by @MichaReiser on 2024-02-15 09:14_

---

_Renamed from "PowerShel: Can't run Benchmarks" to "PowerShell: Can't run Benchmarks" by @MichaReiser on 2024-02-15 09:14_

---

_Label `internal` added by @zanieb on 2024-07-01 21:33_

---

_Renamed from "PowerShell: Can't run Benchmarks" to "Benchmarks cannot be run under PowerShell" by @zanieb on 2025-12-02 10:31_

---
