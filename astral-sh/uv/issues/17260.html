<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hash mismatch for zstd-compressed wheels (regression in 0.9.20) - astral-sh/uv #17260</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Hash mismatch for zstd-compressed wheels (regression in 0.9.20)</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/17260">#17260</a>
        opened by <a href="https://github.com/coltonevansid">@coltonevansid</a>
        on 2025-12-30 05:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/coltonevansid">@coltonevansid</a> on 2025-12-30 05:07</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>After upgrading from uv 0.9.18 to 0.9.20, I'm experiencing hash mismatch errors when installing packages from a private pyx registry that serves zstd-compressed wheels. The same lock file that worked in 0.9.18 now fails in 0.9.20.</p>
<h2>Minimal Reproduction</h2>
<h3>pyproject.toml</h3>
<pre><code class="language-toml">[project]
name = &quot;test-project&quot;
requires-python = &quot;&gt;=3.13&quot;
dependencies = [
    &quot;example-package&quot;,
]

[[tool.uv.index]]
name = &quot;pyx&quot;
url = &quot;https://api.pyx.dev/simple/myorg/main&quot;
explicit = true

[tool.uv.sources]
example-package = { index = &quot;pyx&quot; }
</code></pre>
<h3>Commands</h3>
<pre><code class="language-bash"># This works in 0.9.18, fails in 0.9.20
uv cache clean example-package --force
uv sync
</code></pre>
<h3>Error Output</h3>
<pre><code>× Failed to download `example-package==1.0.0`
  ╰─▶ Hash mismatch for `example-package==1.0.0`

      Expected:
        sha256:7227d1aa4a8266e4208e0955fc0c088cb118fdcfe05033320473ad4f832168c3

      Computed:
        sha256:479c179ce7bb022bd5f9d073778f1419709b2f384e44a5b62a7f86cd79c708ee
</code></pre>
<h2>Root Cause</h2>
<p>The lock file contains both uncompressed and zstd-compressed hashes (this is the format generated by uv when locking against pyx registries):</p>
<pre><code class="language-toml">[[package]]
name = &quot;example-package&quot;
version = &quot;1.0.0&quot;
source = { registry = &quot;pyx&quot; }
wheels = [
    {
        url = &quot;https://files.astralhosted.com/.../example_package-1.0.0-py3-none-any.whl&quot;,
        hash = &quot;sha256:7227d1aa4a8266e4208e0955fc0c088cb118fdcfe05033320473ad4f832168c3&quot;,
        size = 5688,
        upload-time = &quot;2025-12-17T19:54:00Z&quot;,
        zstd = {
            hash = &quot;sha256:479c179ce7bb022bd5f9d073778f1419709b2f384e44a5b62a7f86cd79c708ee&quot;,
            size = 3943
        }
    },
]
</code></pre>
<p><strong>The problem</strong>:</p>
<ul>
<li>Primary hash <code>7227d1aa...</code> is for the <strong>uncompressed wheel</strong> (5688 bytes)</li>
<li>Nested <code>zstd.hash</code> <code>479c179c...</code> is for the <strong>zstd-compressed wheel</strong> (3943 bytes)</li>
</ul>
<p><strong>In uv 0.9.20</strong>: Downloads the zstd-compressed wheel but verifies against the uncompressed hash → mismatch</p>
<p><strong>In uv 0.9.18</strong>: Correctly verifies the zstd-compressed wheel against the nested zstd hash → works</p>
<h2>Pattern</h2>
<p>This <strong>only affects packages from pyx/astralhosted</strong> that serve zstd-compressed wheels with the nested hash format. Packages from PyPI work fine because they don't have nested zstd hashes:</p>
<details>
<summary>Lock file comparison</summary>

<p><strong>PyPI package (works fine in both versions):</strong></p>
<pre><code class="language-toml">wheels = [
    { url = &quot;https://files.pythonhosted.org/.../package-1.0.0-py3-none-any.whl&quot;, hash = &quot;sha256:...&quot;, size = 103094 },
]
</code></pre>
<p><strong>Pyx package (works in 0.9.18, fails in 0.9.20):</strong></p>
<pre><code class="language-toml">wheels = [
    { url = &quot;https://files.astralhosted.com/.../package-1.0.0-py3-none-any.whl&quot;, hash = &quot;sha256:7227d1aa...&quot;, size = 5688, zstd = { hash = &quot;sha256:479c179c...&quot;, size = 3943 } },
]
</code></pre>
</details>

<h2>Regression Analysis</h2>
<p>This appears to be a regression from PR #17157 (&quot;Avoid enforcing incorrect hash in mixed-hash settings&quot;), included in 0.9.20.</p>
<p>That PR fixed mixed hash <strong>algorithms</strong> (SHA256 vs SHA512 for the same file), but broke the case of <strong>same algorithm, different compression formats</strong> (uncompressed vs zstd-compressed).</p>
<p>The test case in that PR (<code>lock_mixed_hashes</code>) only tests different hash algorithms, not zstd compression:</p>
<pre><code class="language-rust">// Tests SHA256 → SHA512 switch for the same file
// Does NOT test uncompressed → zstd-compressed switch
</code></pre>
<h2>Workaround</h2>
<p>Manually edit the lock file to use only the zstd hash:</p>
<pre><code class="language-toml"># Change from:
wheels = [
    { url = &quot;...&quot;, hash = &quot;sha256:7227d1aa...&quot;, size = 5688, zstd = { hash = &quot;sha256:479c179c...&quot;, size = 3943 } },
]

# To:
wheels = [
    { url = &quot;...&quot;, hash = &quot;sha256:479c179c...&quot;, size = 3943 },
]
</code></pre>
<h3>Platform</h3>
<p>macOS (Darwin 25.1.0)</p>
<h3>Version</h3>
<p>uv v0.9.20</p>
<h3>Python version</h3>
<p>Python 3.13.9</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @coltonevansid on 2025-12-30 05:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/woodruffw">@woodruffw</a> on 2025-12-30 05:50</div>
            <div class="timeline-body"><p>Hi @coltonevansid, thanks for opening this! Your RCA looks right to me on first blush. We'll triage a bit more and get back to you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/17263.html">astral-sh/uv#17263</a> on 2025-12-30 14:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cgravill">@cgravill</a> on 2025-12-30 14:08</div>
            <div class="timeline-body"><p>Thanks for workaround @coltonevansid we have the same with a private pyx package and that fixed it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/17265.html">astral-sh/uv#17265</a> on 2025-12-30 14:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-12-30 15:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-30 16:23</div>
            <div class="timeline-body"><p>This should be fixed in 0.9.21</p>
<p>Thanks for the report!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:30 UTC
    </footer>
</body>
</html>
