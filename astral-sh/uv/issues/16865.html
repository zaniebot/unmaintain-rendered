<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`tool update-shell` uses incorrect logic when `ZDOTDIR` is set by `~/.zshenv` - astral-sh/uv #16865</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>`tool update-shell` uses incorrect logic when `ZDOTDIR` is set by `~/.zshenv`</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/16865">#16865</a>
        opened by <a href="https://github.com/benberryallwood">@benberryallwood</a>
        on 2025-11-26 18:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/benberryallwood">@benberryallwood</a> on 2025-11-26 18:29</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>The logic in <code>uv_shell::Shell.configuration_files</code> is incorrect for Zsh in the case when <code>ZDOTDIR</code> is set, but there is an existing <code>~/.zshenv</code> file. <code>uv tool update-shell</code> will create a new file at <code>ZDOTDIR/.zshenv</code> whereas it should update the existing <code>~/.zshenv</code> file.</p>
<p>A comment links to <a href="https://github.com/rust-lang/rustup/blob/fede22fea7b160868cece632bd213e6d72f8912f/src/cli/self_update/shell.rs#L197">rustup's rc file detection</a> which handles this case correctly.</p>
<hr />
<p>Minimal reproducible example (assuming a system with no existing Zsh config):</p>
<pre><code class="language-zsh">echo &quot;export ZDOTDIR=~/.config/zsh&quot; &gt; ~/.zshenv
source ~/.zshenv
mkdir -p $ZDOTDIR
touch &quot;$ZDOTDIR/.zshrc&quot;
uv tool update-shell
</code></pre>
<p>This creates a file at <code>~/.config/zsh/.zshenv</code> which will never be sourced because <code>ZDOTDIR</code> is set while sourcing <code>.zshenv</code>, not before it.</p>
<h3>Platform</h3>
<p>Darwin 25.1.0 x86_64</p>
<h3>Version</h3>
<p>uv 0.9.13 (7ca92dcf6 2025-11-26)</p>
<h3>Python version</h3>
<p>Python 3.14.0</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @benberryallwood on 2025-11-26 18:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/benberryallwood">@benberryallwood</a> on 2025-11-26 18:30</div>
            <div class="timeline-body"><p>I'd like to raise a PR with the fix if people agree with the change</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LIghtJUNction">@LIghtJUNction</a> on 2025-11-26 19:15</div>
            <div class="timeline-body"><blockquote>
<p>I'd like to raise a PR with the fix if people agree with the change</p>
</blockquote>
<p>I think it's fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/16866.html">astral-sh/uv#16866</a> on 2025-11-26 19:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zsol on 2025-11-29 22:13</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:30 UTC
    </footer>
</body>
</html>
