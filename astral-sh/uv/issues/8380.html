<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docker build fails with cached dependencies for a workspace - astral-sh/uv #8380</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Docker build fails with cached dependencies for a workspace</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/8380">#8380</a>
        opened by <a href="https://github.com/suhaskarnik">@suhaskarnik</a>
        on 2024-10-20 12:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/suhaskarnik">@suhaskarnik</a> on 2024-10-20 12:07</div>
            <div class="timeline-body"><p>I've a project with the following structure:</p>
<pre><code>app
├── pkgs
│   └── backend
│       ├── pyproject.toml
│       └── src
│           └── backend
│               ├── __init__.py
├── pyproject.toml
├── src
│   └── ui
│       ├── hello.py
</code></pre>
<p>In <code>pyproject.toml</code> I have the following:</p>
<pre><code class="language-toml">[project]
name = &quot;app&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = [
&quot;backend ==0.1.0&quot;
]

[tool.uv.workspace]
members = [&quot;pkgs/backend&quot;]

[tool.uv.sources]
backend = { workspace = true }

[tool.hatch.build.targets.wheel]
packages = [&quot;src/ui&quot;]

[project.scripts]
hello = &quot;ui.hello:main&quot;

[build-system]
requires = [&quot;hatchling&quot;]
build-backend = &quot;hatchling.build&quot;
</code></pre>
<p>In <code>backend/pyproject.toml</code> I have:</p>
<pre><code class="language-toml">[project]
name = &quot;backend&quot;
version = &quot;0.1.0&quot;

requires-python = &quot;&gt;=3.12&quot;
dependencies = [&quot;...&quot;]

[tool.hatch.build.targets.wheel]
packages = [&quot;src/backend&quot;]

[build-system]
requires = [&quot;hatchling&quot;]
build-backend = &quot;hatchling.build&quot;
</code></pre>
<p>Finally, the <code>hello.py</code> is rather simple:</p>
<pre><code class="language-python">from backend import hello

def main():
    print(&quot;Hello from uv-workspaces!&quot;)
    print(hello())    # backend.__init__.py has a hello() method that just returns &quot;hello from backend&quot;

if __name__ == &quot;__main__&quot;:
    main()
</code></pre>
<p>As you can see, this is a minimal solution to understand how workspaces can be used to deploy an (eventually) more complex project with dependencies into a Docker container.</p>
<p>Now <code>uv sync</code> and <code>uv run hello</code> work fine on my machine - it prints two hello messages.  But if I follow the Dockerfile <a href="https://github.com/astral-sh/uv-docker-example/blob/main/Dockerfile">here</a>, it fails with the error:</p>
<pre><code>0.125   Caused by: Failed to parse entry for: `backend`
0.125   Caused by: Package is not included as workspace package in `tool.uv.workspace`
</code></pre>
<p>The problems seems to occur because the Dockerfile does <em>not</em> copy the project source code before doing the sync. When I added a <code>--mount=type=bind,source=pkgs,target=pkgs</code> before the <code>uv-sync</code> command in the Dockerfile, it solved the problem, but this is obviously not a good idea because then I cannot cache the dependencies.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-20 14:36</div>
            <div class="timeline-body"><p>You'll want to use <code>--no-install-workspace</code> instead of <code>--no-install-project</code>, I think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2024-10-20 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/suhaskarnik">@suhaskarnik</a> on 2024-10-21 09:56</div>
            <div class="timeline-body"><p>Thanks, I tried that too, but it gave me the same error. So all of the following give the same error:</p>
<pre><code class="language-bash">--no-install-project
--no-install-workspace
--no-install-project --no-install-workspace
--no-install-project --no-install-workspace --no-install-package backend
</code></pre>
<p>In addition, I now added the -v flag to get verbose output. Most of it seemed innocuous, but these lines show up. Is this a problem?</p>
<pre><code>0.128 DEBUG Ignoring existing lockfile due to mismatched members:
0.128   Expected: {}
0.128   Actual: {PackageName(&quot;app&quot;), PackageName(&quot;backend&quot;)}
</code></pre>
<p>Running <code>uv lock</code> didn't fix the above, and doesn't seem to update the <code>uv.lock</code> file either, going by the file timestamp</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-21 13:43</div>
            <div class="timeline-body"><p>Seems like a bug, @charliermarsh would know better though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @zanieb on 2024-10-21 13:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @zanieb on 2024-10-21 13:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-10-21 13:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-21 14:48</div>
            <div class="timeline-body"><p>Are you not running with <code>--frozen</code>? That debug message should be &quot;impossible&quot; with <code>--frozen</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-21 14:53</div>
            <div class="timeline-body"><p>Either way, can you post the exact Dockerfile you're using with the above projects please?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-21 17:30</div>
            <div class="timeline-body"><p>I copied over the code and Dockerfile but the build succeeds without error.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @charliermarsh on 2024-10-21 17:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @charliermarsh on 2024-10-21 17:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-21 17:32</div>
            <div class="timeline-body"><p>E.g., this builds without error:</p>
<pre><code class="language-docker"># Use a Python image with uv pre-installed
FROM ghcr.io/astral-sh/uv:python3.12-bookworm-slim

# Install the project into `/app`
WORKDIR /app

# Enable bytecode compilation
ENV UV_COMPILE_BYTECODE=1

# Copy from the cache instead of linking since it's a mounted volume
ENV UV_LINK_MODE=copy

# Install the project's dependencies using the lockfile and settings
RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,source=uv.lock,target=uv.lock \
    --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
    uv sync --frozen --no-install-workspace --no-dev

# Then, add the rest of the project source code and install it
# Installing separately from its dependencies allows optimal layer caching
ADD . /app
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --frozen --no-dev

# Place executables in the environment at the front of the path
ENV PATH=&quot;/app/.venv/bin:$PATH&quot;

# Reset the entrypoint, don't invoke `uv`
ENTRYPOINT []

# Run the FastAPI application by default
# Uses `fastapi dev` to enable hot-reloading when the `watch` sync occurs
# Uses `--host 0.0.0.0` to allow access from outside the container
CMD [&quot;fastapi&quot;, &quot;dev&quot;, &quot;--host&quot;, &quot;0.0.0.0&quot;, &quot;src/uv_docker_example&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/suhaskarnik">@suhaskarnik</a> on 2024-10-22 04:24</div>
            <div class="timeline-body"><p>Thanks, adding <code>--frozen</code> fixed the issue.</p>
<p>Working backwards, I think I now get how this happened. Originally I had <code>--frozen --no-install-project</code>. Which threw the original error that I pasted. Later when I replaced that with <code>--no-install-workspace</code>, looks like I accidentally removed <code>--frozen</code>.</p>
<p>So the solution is <code>--frozen --no-install-workspace</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @suhaskarnik on 2024-10-22 04:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MarkusPorti">@MarkusPorti</a> on 2025-04-29 15:46</div>
            <div class="timeline-body"><p>@charliermarsh
I just stumbled across the same error which could be fixed by replacing &quot;--locked&quot; with &quot;--frozen&quot; as suggested earlier.
You may want to change your documentation here: https://docs.astral.sh/uv/guides/integration/docker/#intermediate-layers</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:00 UTC
    </footer>
</body>
</html>
