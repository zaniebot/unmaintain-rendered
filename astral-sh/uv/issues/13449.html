<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv add` et al do not respect UV_BUILD_CONSTRAINT - astral-sh/uv #13449</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`uv add` et al do not respect UV_BUILD_CONSTRAINT</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/13449">#13449</a>
        opened by <a href="https://github.com/tmct">@tmct</a>
        on 2025-05-14 11:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/tmct">@tmct</a> on 2025-05-14 11:00</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Hi,</p>
<p>In the last week we encountered an issue with a not-actively-maintained package that we have a dependency on. <a href="https://github.com/escherba/python-metrohash/issues/29">Here</a> are the details if you're interested. We became unable to install the dependency, even on builds installing an identical version as before, because: no py312+ wheels have ever been published for the dep, its build from source was incompatible with the newly-released Cython 3.1.0, and the latter is automatically brought in for new isolated builds when one installs packages.</p>
<p>Fortunately, we were using uv pip install, so we could use UV_BUILD_CONSTRAINT to avoid the new Cython until we remove that package:</p>
<p>constraints.txt:</p>
<pre><code>Cython &lt; 3.1.0
</code></pre>
<pre><code>UV_BUILD_CONSTRAINT=constraints.txt uv pip install my-package-that-depends-on-metrohash
</code></pre>
<p>This worked successfully for uv pip install, including our usages of uv pip install through Hatch to build and test packages.</p>
<p>Now - a user has come to me with the same problem with <code>uv sync</code> - it seems like uv add, sync et all do not respect the UV_BUILD_CONSTRAINT parameter. IT picks latest Cython and you still see the build error.</p>
<p>I am fairly sure that these uv commands <em>should</em> respect UV_BUILD_CONSTRAINT: otherwise there is no realmechanism to exert control over the isolated builds that occur for one's dependencies that lack binary distributions.</p>
<p>(The user found an excellent workaround - uv pip install the troublesome package <em>in any other environment</em>, using UV_BUILD_CONSTRAINT. This pops the built package into uv's cache, and it starts working everywhere else! But clearly this is not a fully satisfying solution.)</p>
<p>Please could this behaviour be added to all relevant uv commands?</p>
<p>Thanks,
Tom</p>
<h3>Platform</h3>
<p>Ubuntu 24.04</p>
<h3>Version</h3>
<p>latest (0.7.x)</p>
<h3>Python version</h3>
<p>Python 3.12</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @tmct on 2025-05-14 11:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-14 18:39</div>
            <div class="timeline-body"><p>I believe those APIs expect to read build constraints from <code>[tool.uv.build-constraint-dependencies]</code> -- this is actually documented in the note here: https://docs.astral.sh/uv/reference/settings/#build-constraint-dependencies</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-06-28 13:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:03 UTC
    </footer>
</body>
</html>
