<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Using extra's as markers - astral-sh/uv #14090</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Using extra's as markers</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/14090">#14090</a>
        opened by <a href="https://github.com/scarere">@scarere</a>
        on 2025-06-16 19:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/scarere">@scarere</a> on 2025-06-16 19:46</div>
            <div class="timeline-body"><h3>Question</h3>
<p>I'm curious if it is possible to use extra's as markers when defining sources but still install the package from pypi when the requirement is not met.</p>
<p>For example, I'd like to include <code>nnunetv2</code> as a project dependency, but optionally install from a git source when told to do so by the user. Based on the documentation it seemed that this would be possible using the extra's flag using something like this:</p>
<pre><code class="language-toml">[project]
name = &quot;example&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.10&quot;
dependencies = [
     &quot;nnunetv2&gt;=2.6.2&quot;
]

[project.optional-dependencies]
usegit = [&quot;nnunetv2&gt;=2.6.2&quot;]

[tool.uv.sources]
nnunetv2 = { git = &quot;link/to/fork/of/nnunet&quot;, tag = &quot;custom tag&quot;, marker = &quot;extra == 'usegit'&quot;}
</code></pre>
<p>This however does not work. When I include <code>--extra usegit</code> in the <code>uv sync</code> command the package is installed from the git source, but when the extra is not included then <code>nnunetv2</code> is not installed at all and is removed from the repository. However based on the documentation I would expect it to always install nnunetv2, and to just switch the source when the marker condition is met. For some reason this is only an issue with the 'extra' marker. If I use the 'sys_platform` marker instead like in the example in the documentation, then the package is properly installed from pypi when then marker condition is not met, but installs from the alternate git source when the marker condition is met.</p>
<p>Lastly, I noticed that in the working example with the 'sys_platform' marker, if I run <code>uv sync</code> and the marker condition is true (i'm on linux and i set the marker to &quot;sys_platform == 'linux'&quot;) it installs from the git source, but then if I change the pyproject.toml file to make the marker condition false (marker = &quot;sys_platform == 'darwin'&quot;) then uv does not recognize that nnunetv2 is installed from the 'wrong' source. It only installs from the correct source if I use the <code>--reinstall</code> flag. Would it be a desirable feature for uv to automatically recognize when packages that have dependencyy specifications are installed incorrectly?</p>
<p>Overall I'm just wondering if there is any way to install dependencies from different sources using a user flag, but still install from pypi by default if that flag is not passed by the user.</p>
<h3>Platform</h3>
<p><em>No response</em></p>
<h3>Version</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @scarere on 2025-06-16 19:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-06-16 20:43</div>
            <div class="timeline-body"><p>Hm, something doesn't seem quite right here, e.g.</p>
<pre><code class="language-toml">[project]
name = &quot;example&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.13.2&quot;
dependencies = [
    &quot;httpx&quot;,
]

[project.optional-dependencies]
git = [&quot;httpx&quot;]

[tool.uv.sources]
httpx = { git = &quot;https://github.com/encode/httpx.git&quot;, extra = &quot;git&quot; }
</code></pre>
<p>Always uses the git source. We'll look into this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-06-16 20:58</div>
            <div class="timeline-body"><p>I think this is a bug</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @zanieb on 2025-06-16 20:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2025-06-16 20:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-06-18 08:46</div>
            <div class="timeline-body"><p>CC @oconnor663 for the sources behavior</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @konstin by @zanieb on 2025-06-20 14:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @konstin by @konstin on 2025-09-09 20:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-09-13 03:13</div>
            <div class="timeline-body"><p>@zanieb -- This works as expected if you use a package-level conflict... Like if you add:</p>
<pre><code class="language-toml">[tool.uv]
conflicts = [[{ package = &quot;example&quot; }, { package = &quot;example&quot;, extra = &quot;git&quot; }]]
</code></pre>
<p>Then you do indeed get the expected behavior. I guess that should work &quot;automatically&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/svetly-todorov">@svetly-todorov</a> on 2025-09-29 22:59</div>
            <div class="timeline-body"><p>@charliermarsh How did you verify that the package-level conflict produces the correct result? I'm trying to do something very similar (install pytorch from a different index when passing <code>--extra cpu</code>) and this is the error I'm seeing:</p>
<pre><code>$ uv sync --locked --extra cpu --preview-features package-conflicts
Resolved 106 packages in 10ms
error: Extra `cpu` and package `example` are incompatible with the declared conflicts: {`example[cpu]`, example}
</code></pre>
<p>From this snippet of pyproject.toml:</p>
<pre><code class="language-toml">[project.optional-dependencies]
cpu = [
    &quot;torch&quot;,
    &quot;sentence-transformers&gt;=5.1.0&quot;,
]
gpu = [
    &quot;sentence-transformers&gt;=5.1.0&quot;,
]

[tool.uv]
conflicts = [[{ package = &quot;example&quot; }, { package = &quot;example&quot;, extra = &quot;cpu&quot; }]]

[tool.uv.sources]
torch = [
  { index = &quot;pytorch-cpu-index&quot;, extra = &quot;cpu&quot;},
]

[[tool.uv.index]]
name = &quot;pytorch-cpu-index&quot;
url = &quot;https://download.pytorch.org/whl/cpu&quot;
explicit = true
</code></pre>
<p>Version:</p>
<pre><code>$ uv self version
uv 0.8.22
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ameicler">@ameicler</a> on 2025-10-21 09:02</div>
            <div class="timeline-body"><p>Encountering same issue, as described in duplicated #16379 ticket:</p>
<p>When using a source override with a marker like:</p>
<pre><code class="language-toml">[tool.uv.sources]
habitat-sim = { path = &quot;...&quot;, marker = &quot;extra == 'cuda'&quot; } # e.g, `path. = &quot;cuda/habitat_sim-0.3.3-cp310-cp310-linux_x86_64.whl&quot;`
</code></pre>
<p>Expected: When marker doesn't match, fall back to registry
Actual: uv lock only captures the path source, ignores marker, and fails to install when marker is false</p>
<p>This prevents environment-specific wheel usage (CUDA vs CPU builds).</p>
<p>Platform
Linux 5.10.242-239.961.amzn2.x86_64 x86_64 GNU/Linux</p>
<p>Version
uv 0.9.4</p>
<p>Python version
Python 3.10.19</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 03:26:41 UTC
    </footer>
</body>
</html>
