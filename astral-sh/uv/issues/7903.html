<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uv install script cannot detect glibc inside WolfiOS base image. - astral-sh/uv #7903</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Uv install script cannot detect glibc inside WolfiOS base image.</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/7903">#7903</a>
        opened by <a href="https://github.com/KhazAkar">@KhazAkar</a>
        on 2024-10-03 17:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/KhazAkar">@KhazAkar</a> on 2024-10-03 17:29</div>
            <div class="timeline-body"><p>When trying to install uv inside container with cURL'd script, when using wolfi-base from chainguard, cannot detect glibc version.</p>
<pre><code>#8 [stage-0 4/7] RUN curl -LsSf https://astral.sh/uv/install.sh &gt;install.sh &amp;&amp; sh install.sh
#8 9.598 head: /proc/self/exe: Bad file descriptor
#8 9.645 ERROR: unknown platform bitness
#8 9.647 sh: bad number
#8 9.653 install.sh: line 911: ldd: not found
#8 9.701 System glibc version (`') is too old; checking alternatives
#8 9.814 downloading uv 0.4.18 aarch64-unknown-linux-musl-static
#8 38.24 installing to /home/nonroot/.cargo/bin
#8 38.34   uv
#8 38.39   uvx
#8 38.39 everything's installed!
#8 38.79 
#8 38.80 To add $HOME/.cargo/bin to your PATH, either restart your shell or run:
#8 38.80 
#8 38.80     source $HOME/.cargo/env (sh, bash, zsh)
#8 38.80     source $HOME/.cargo/env.fish (fish)
#8 DONE 38.9s
</code></pre>
<p>(slow because I'm building aarch64 container on x86 host)
It installs musl python variant, when it's glibc here.
More info about Wolfi OS - https://github.com/wolfi-dev</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">upstream</span> added by @charliermarsh on 2024-10-03 17:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">releases</span> added by @zanieb on 2024-10-03 17:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mistydemeo">@mistydemeo</a> on 2024-10-03 17:56</div>
            <div class="timeline-body"><p>Looks like the inability to detect glibc comes from <code>ldd</code> being missing; I'll look into adding support for other methods to detect the glibc version. The &quot;unable to detect bitness&quot; one is interesting - I hadn't expected us not to have access to <code>/proc/self/exe</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KhazAkar">@KhazAkar</a> on 2024-10-03 18:08</div>
            <div class="timeline-body"><p>Probably because access to it was removed or restricted as part of WolfiOS security model, around which they revolve whole &quot;OS&quot; around. Like secured to the brim alpine with glibc instead of musl.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mistydemeo">@mistydemeo</a> on 2024-10-03 18:57</div>
            <div class="timeline-body"><p>I've been doing some local testing and wasn't able to reproduce the <code>/proc/self/exe</code> issue, though I can reproduce the <code>ldd</code> issue. Any chance you're able to share what the previous steps in your dockerfile look like?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KhazAkar">@KhazAkar</a> on 2024-10-03 19:04</div>
            <div class="timeline-body"><p>Sure, no problem, I can share even whole Dockerfile. Adding posix-libc-utils fixes missing ldd and now glibc is detected.</p>
<pre><code>FROM cgr.dev/chainguard/wolfi-base:latest
RUN apk add curl build-base posix-libc-utils
USER nonroot
WORKDIR /home/nonroot
ENV UV_COMPILE_BYTECODE=1 UV_LINK_MODE=copy
RUN mkdir -p .cache/uv
RUN curl -LsSf https://astral.sh/uv/install.sh &gt;install.sh &amp;&amp; sh install.sh
ENV PATH=&quot;/home/nonroot/.cargo/bin:/home/nonroot/app/.venv/bin:$PATH&quot;
RUN uv python install 3.11.9 &amp;&amp; uv venv
RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,source=uv.lock,target=uv.lock \
    --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
    CC=gcc uv sync --frozen --no-install-project --no-dev
COPY app .
EXPOSE 19110
ENTRYPOINT []
CMD [&quot;fastapi&quot;, &quot;--host&quot;, &quot;0.0.0.0&quot;, &quot;--port&quot;, &quot;19110&quot;, &quot;/home/nonroot/app&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KhazAkar">@KhazAkar</a> on 2024-10-03 19:07</div>
            <div class="timeline-body"><p>Interesting observation on the side - if I use <code>/root/.cache/uv</code> - step with mount works fine. If I want target cache to be in <code>/home/nonroot/.cache/uv</code> - it doesn't work with 'permission denied' error. Either I don't understand how something works, or is a bug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-10-04 08:58</div>
            <div class="timeline-body"><p>A few notes from my end: It would be great if we could correctly detect this (https://github.com/axodotdev/cargo-dist/issues/1439), the difficulty is that the curl installer is a shell script which limits our options a bit (uv itself uses a rust crate to do ELF parsing of common binaries).</p>
<p>Both the musl and the glibc build should generally work equally (we don't load any shared libraries), the fallback here should work without disadvantages.</p>
<p>In docker, we generally recommend for installation:</p>
<pre><code>COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv
</code></pre>
<p>The image is built from a <code>scratch</code> base and ships only the binaries:</p>
<pre><code>$ docker create --name=&quot;tmp_$$&quot; ghcr.io/astral-sh/uv:latest
3e25e2a9b7487d271792ac87aad50c2b4f09eb3b55cbc0ee317654a68a473e1b
$ docker export tmp_$$ | tar t
.dockerenv
dev/
dev/console
dev/pts/
dev/shm/
etc/
etc/hostname
etc/hosts
etc/mtab
etc/resolv.conf
io/
proc/
sys/
uv
uvx
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 04:47:55 UTC
    </footer>
</body>
</html>
