<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invalidate cache entries for same-version packages that have newer timestamps when also found externally (via --find-links) - astral-sh/uv #3518</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Invalidate cache entries for same-version packages that have newer timestamps when also found externally (via --find-links)</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/3518">#3518</a>
        opened by <a href="https://github.com/charlesnicholson">@charlesnicholson</a>
        on 2024-05-10 21:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/charlesnicholson">@charlesnicholson</a> on 2024-05-10 21:12</div>
            <div class="timeline-body"><p>Maybe this is too far afield for <code>uv</code>, but I have an interesting case-</p>
<p>During development, we don't change the version of our packages, so we'll create distribution packages that look like, say, <code>company.foo-0.0.1-py3-none-any.whl</code>. Our CI system sends these to a test runner computer, which uses <code>uv</code> to prepare a venv and install these wheels. These wheels go into a subdirectory called <code>wheels</code>, and then we run:</p>
<pre><code>uv pip install -q --upgrade -p venv/bin/python company.foo-0.0.1-py3-none-any.whl --find-links=wheels
</code></pre>
<p>The problem comes when package <code>foo</code> depends on <code>bar</code>- <code>company.bar-0.0.1-py3-none-any.whl</code> exists in <code>wheels</code>, but an &quot;older&quot; version (also at 0.0.1) already exists in the <code>uv</code> cache, and that one is chosen. But, the PR we're testing might also have important improvements to <code>bar</code>! In that case, our tests fail because <code>uv</code> found and installed the old <code>bar</code> package from its cache.</p>
<p>One solution would be to bump the version numbers any time we make any change to a package, but it would be simpler if we could say &quot;Hey, <code>uv</code>, please prefer whatever you find in the <code>--find-links</code> location to the cache, but if you want, feel free to update the cache with what you found afterwards.&quot;</p>
<p>That way big expensive third-party wheels would live in the cache for <code>uv</code>, but our first-party wheels would always be preferred.</p>
<p>Sorry if this is too esoteric of a use case to be interesting, or if there's another more elegant way to solve this; my current workaround is just to pass <code>-n</code> to <code>uv</code> but of course that slows everything down a ton. I'd happily just delete all of our first-party packages from the uv cache before running anything instead, if that's a better option, but then it would be really nice to have wildcard support: <code>uv cache clear &quot;company\.*&quot;</code> or something.</p>
<p>Anyway, thanks for reading!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-10 21:21</div>
            <div class="timeline-body"><p>This does make sense... I'm curious if @konstin has thoughts on how we could support it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-design</span> added by @charliermarsh on 2024-05-10 21:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-05-11 02:10</div>
            <div class="timeline-body"><p>From an interface perspective... adding a <code>--wheel-strategy &lt;kind&gt;</code> to specify this makes sense to me? It could subsume the <code>--no-binary</code> flag (although we wouldn't remove it for compatibility).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-11 02:13</div>
            <div class="timeline-body"><p>Personally I see this more about determining index priority (similar to our index strategy flag) rather than about wheels vs. source distributions. I assume that if this were set, youâ€™d also want source distributions in the find-links to take precedence over wheels in the index, since the intent is that any local distributions should be preferred.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-05-11 02:16</div>
            <div class="timeline-body"><p>Fair that makes sense to me. Why is this not just an index strategy like &quot;prefer-find-links&quot; then?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charlesnicholson">@charlesnicholson</a> on 2024-05-12 17:07</div>
            <div class="timeline-body"><p>Related: it would be nice if there was a way to tell <code>uv</code> never to cache specific packages; in my case it would be <code>company.*</code>; they just take up space, they're unstable development versions in flux, and it's always an error for <code>uv</code> to ever pick them for anything.</p>
<p>(This might be 3 issues: index preference, wildcard cache deletions, and &quot;don't ever cache&quot; this; LMK if there's enough interest to separate issues for the latter two)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-05-13 08:46</div>
            <div class="timeline-body"><p>I think it would make sense to check the timestamp of <code>company.bar-0.0.1-py3-none-any.whl</code> and invalidate the cache accordingly, i think this should handle the use case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charlesnicholson">@charlesnicholson</a> on 2024-05-13 13:19</div>
            <div class="timeline-body"><p>Also, I didn't investigate this deeply but this only started happening after moving to <code>uv</code> after ~1.5 years of this strategy working with vanilla pip, so it's possible that pip has something in place for this?</p>
<p>This is just an observation and not a claim; but I'm guessing we'd have seen this error at least a few times pre-uv.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charlesnicholson">@charlesnicholson</a> on 2024-06-18 00:22</div>
            <div class="timeline-body"><p>Hello! Just checking in on this issue and seeing if anyone has any appetite for looking at it :)</p>
<p>This issue is still flagged as &quot;needs-design&quot; but @konstin's suggestion sounded pretty reasonable from my POV as a user. Are there other blockers / prioritization issues that keep this one from getting attention? The divergence from pip makes it seem like it's possibly a regression from pip's behavior, in addition to just being a nice-to-have for me...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-18 00:37</div>
            <div class="timeline-body"><p>That seems pretty reasonable to me as well. It's just a matter of prioritization, I think. I'm happy to review a change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-design</span> removed by @zanieb on 2024-06-18 00:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-06-18 00:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cache</span> added by @zanieb on 2024-06-18 00:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kidrahahjo">@kidrahahjo</a> on 2024-06-18 02:14</div>
            <div class="timeline-body"><p>Hi from what I understood from this discussion, I tried to replicate this issue where my package relied on a specific version of <code>protobuf</code>. While trying to install my package from a wheel, I also placed the <code>protobuf</code> wheel in the same directory but uv ignored that. It either got installed from pypi, or from the cache. However we want to provide an API to prefer the links. Please feel free to correct me if I misunderstood.</p>
<p>Referring to what the maintainers suggested in terms of having a concrete API, would it make sense to have a flag called <code>--resolution-strategy</code> where it could take the following values:</p>
<ol>
<li><code>prefer-cache</code> (default) -&gt; Check in cache and install from there instead (for backwards compatibility), fall back to indexes</li>
<li><code>prefer-links</code> -&gt; Check for links, fall back to <code>prefer-cache</code>.</li>
<li><code>links-only</code> -&gt; Don't try to resolve from indexes or caches.</li>
</ol>
<p>We'd invalidate the cache in case of timestamp mismatch.</p>
<p>If it seems like a good first issue, I am happy to take this up.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charlesnicholson">@charlesnicholson</a> on 2024-06-18 23:11</div>
            <div class="timeline-body"><p>@kidrahahjo I'm just a user, but @konstin's approach seemed like it didn't need any new flags or anything; resolving would simply check for the existence of a distribution package file in the <code>--find-links</code> directory, and if it's there at the same version as the venv source, would simply fall back to a timestamp check. If the distribution package file is newer, it would be preferred. If it's &lt;= the venv timestamp, then the venv package is fine.</p>
<p>(I don't have a strong opinion, just here to observe that your writeup doesn't seem to incorporate what @konstin wrote)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Option for "Prefer wheels from "--find-links" directory to whatever's in the cache"?" to "uv should use timestamps as same-version tiebreakers between packages from the uv cache and from --find-links directories" by @charlesnicholson on 2024-09-27 20:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charlesnicholson">@charlesnicholson</a> on 2024-09-27 20:37</div>
            <div class="timeline-body"><p>(renamed bug issue to match @konstin's comment)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "uv should use timestamps as same-version tiebreakers between packages from the uv cache and from --find-links directories" to "Use timestamps as same-version tiebreakers between cache packages and  --find-links packages" by @charlesnicholson on 2024-12-16 03:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Use timestamps as same-version tiebreakers between cache packages and  --find-links packages" to "Invalidate cache entries for same-version packages that have newer timestamps when also found externally (via --find-links)" by @charlesnicholson on 2025-01-07 19:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/5731.html">astral-sh/uv#5731</a> on 2025-06-20 15:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:27 UTC
    </footer>
</body>
</html>
