```yaml
number: 6158
title: "`uv add foo` followed by a `uv remove foo` can sometimes produce a different lock file than what one started with"
type: issue
state: open
author: BurntSushi
labels:
  - bug
  - resolver
assignees: []
created_at: 2024-08-16T17:35:31Z
updated_at: 2024-08-16T17:42:08Z
url: https://github.com/astral-sh/uv/issues/6158
synced_at: 2026-01-10T01:57:13Z
```

# `uv add foo` followed by a `uv remove foo` can sometimes produce a different lock file than what one started with

---

_Issue opened by @BurntSushi on 2024-08-16 17:35_

This is, assuming, of course, that the world remains fixed (which one can simulate with `--exclude-newer`). Here's a basic test case that is derived from #6063:

```
$ rm -f *.lock

$ uv lock
warning: `uv lock` is experimental and may change without warning
Using Python 3.11.9
Resolved 8 packages in 51ms

$ cp uv.lock uv.first.lock

$ uv add --no-sync sniffio
warning: `uv add` is experimental and may change without warning
Using Python 3.11.9
Creating virtualenv at: .venv
Resolved 9 packages in 28ms

$ cp uv.lock uv.second.lock

$ uv remove --no-sync sniffio
warning: `uv remove` is experimental and may change without warning
Resolved 8 packages in 9ms

$ cp uv.lock uv.third.lock
```

Now, we expect `uv.first.lock` and `uv.second.lock` to be different, because we're adding a dependency:

```
$ diff uv.first.lock uv.second.lock
15c15
<     { name = "zipp" },
---
>     { name = "zipp", marker = "python_full_version < '3.10'" },
164a165,173
> name = "sniffio"
> version = "1.3.1"
> source = { registry = "https://pypi.org/simple" }
> sdist = { url = "https://files.pythonhosted.org/packages/a2/87/a6771e1546d97e7e041b6ae58d80074f81b7d5121207425c964ddf5cfdbd/sniffio-1.3.1.tar.gz", hash = "sha256:f4324edc670a0f49750a81b895f35c3adb843cca46f0530f79fc1babb23789dc", size = 20372 }
> wheels = [
>     { url = "https://files.pythonhosted.org/packages/e9/44/75a9c9421471a6c4805dbf2356f7c181a29c1879239abab1ea2cc8f38b40/sniffio-1.3.1-py3-none-any.whl", hash = "sha256:2f6da418d1f1e0fddd844478f41680e794e6051915791a034ff65e5f100525a2", size = 10235 },
> ]
>
> [[package]]
169a179
>     { name = "sniffio" },
173c183,186
< requires-dist = [{ name = "jax", specifier = "==0.4.17" }]
---
> requires-dist = [
>     { name = "jax", specifier = "==0.4.17" },
>     { name = "sniffio" },
> ]
```

But note that there is a change in the above lock file that is unrelated to the addition of `sniffio`. And we can see this by diffing `uv.first.lock` with `uv.third.lock`, which _should_ be identical in this case:

```
$ diff uv.first.lock uv.third.lock
15c15
<     { name = "zipp" },
---
>     { name = "zipp", marker = "python_full_version < '3.10'" },
```

---

_Label `bug` added by @BurntSushi on 2024-08-16 17:35_

---

_Label `resolver` added by @BurntSushi on 2024-08-16 17:35_

---

_Comment by @charliermarsh on 2024-08-16 17:38_

I think this is basically the same problem as the Jax thing.

---

_Comment by @BurntSushi on 2024-08-16 17:42_

Yeah it is. And this particular case is fixed by more aggressive forking. (But I believe I can come up with other cases of instability that aren't fixed by aggressive forking.)

---

_Referenced in [astral-sh/uv#6161](../../astral-sh/uv/pulls/6161.md) on 2024-08-16 18:21_

---

_Referenced in [astral-sh/uv#9990](../../astral-sh/uv/issues/9990.md) on 2024-12-18 17:22_

---

_Referenced in [mlrun/mlrun#7558](../../mlrun/mlrun/pulls/7558.md) on 2025-04-01 10:58_

---
