<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consider stripping `uv` release binaries - astral-sh/uv #5683</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Consider stripping <code>uv</code> release binaries</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/5683">#5683</a>
        opened by <a href="https://github.com/edmorley">@edmorley</a>
        on 2024-08-01 12:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/edmorley">@edmorley</a> on 2024-08-01 12:53</div>
            <div class="timeline-body"><p>Hi ðŸ‘‹</p>
<p>Thank you for a great project!</p>
<p>I noticed that the <code>uv</code> release binaries (as distributed via GitHub releases) are currently quite large.</p>
<p>For example:</p>
<pre><code>$ curl -sSfLO https://github.com/astral-sh/uv/releases/download/0.2.32/uv-aarch64-unknown-linux-gnu.tar.gz
$ tar -zx --strip-components=1 -f uv-aarch64-unknown-linux-gnu.tar.gz
$ du -ha uv uv-*
35M	uv
14M	uv-aarch64-unknown-linux-gnu.tar.gz
</code></pre>
<p>To put the size in perspective, 14 MB compressed and 35 MB uncompressed is very close to the size of our entire Python 3.12 install <a href="https://heroku-buildpack-python.s3.us-east-1.amazonaws.com/python-3.12.4-ubuntu-22.04-amd64.tar.zst">archive</a>, which has an archive size of 11MB and uncompressed install size of 41 MB (and this is even with that archive intentionally bundling <code>.pyc</code>s for the stdlib). For local installs the size doesn't really matter, however, in CI/CD/OCI image contexts cold caches can be prevalent and smaller OCI images are preferred (for end user UX it's not always desirable to exclude the package manager from the final run-image) etc, so large tool sizes are more noticeable.</p>
<p>uv's focus should absolutely be speed+compatibility+features over binary size, so I'm not suggesting there should be any user-facing compromises made to reduce binary size - but it seems there might be some low hanging fruit to reduce the size?</p>
<p>For example, stripping reduces the binary size in the example above by 25%:</p>
<pre><code>$ strip uv
$ du -ha uv
26M	uv
</code></pre>
<p>And Cargo now supports stripping natively in a cross-platform way:
https://doc.rust-lang.org/cargo/reference/profiles.html#strip</p>
<pre><code class="language-toml">[profile.release]
strip = true
</code></pre>
<p>I see this has been enabled already for the <code>uv-trampoline</code> crate:
https://github.com/astral-sh/uv/blob/9a1a2118e1b6daa0a8c370a21a0ebb788f20acb4/crates/uv-trampoline/Cargo.toml#L28-L29</p>
<p>...but not any of the others (in the release profile at least):
https://github.com/search?q=repo%3Aastral-sh%2Fuv+strip+language%3ATOML&amp;type=code&amp;l=TOML</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">release</span> added by @zanieb on 2024-08-01 12:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-01 13:00</div>
            <div class="timeline-body"><p>I thought we <em>were</em> stripping binaries via <code>strip = true</code> in <code>pyproject.toml</code> but the result above suggests we aren't, will take a look...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-08-01 13:08</div>
            <div class="timeline-body"><p>I've checked locally and</p>
<pre><code class="language-shell">RUST_LOG=debug uvx maturin build --release --locked --out dist --features self-update --target x86_64-unknown-linux-gnu
</code></pre>
<p>is correctly setting <code>-C link-arg=-s</code> and producing stripped binaries. @messense Any ideas what the maturin action is doing different that it could be ignoring the <code>tool.maturin.strip = true</code> that we set in <code>pyproject.toml</code>, while it works locally?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/messense">@messense</a> on 2024-08-02 03:35</div>
            <div class="timeline-body"><p>No idea, can you try run maturin build with <code>--debug</code> on CI?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-08-02 09:20</div>
            <div class="timeline-body"><p>CI also says https://github.com/astral-sh/uv/actions/runs/10213117825/job/28257883122:</p>
<pre><code>DEBUG build_wheels: maturin::compile: Running env -u CARGO &quot;cargo&quot; &quot;rustc&quot; &quot;--features&quot; &quot;self-update&quot; &quot;--target&quot; &quot;x86_64-unknown-linux-gnu&quot; &quot;--message-format&quot; &quot;json-render-diagnostics&quot; &quot;--locked&quot; &quot;--manifest-path&quot; &quot;/home/runner/work/uv/uv/crates/uv/Cargo.toml&quot; &quot;--release&quot; &quot;--bin&quot; &quot;uv&quot; &quot;--&quot; &quot;-C&quot; &quot;link-arg=-s&quot;
</code></pre>
<p>So the right arg is there. Could it be it's because we're not using mold in CI?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/messense">@messense</a> on 2024-08-02 09:37</div>
            <div class="timeline-body"><p>Have you tried comparing build artifact size with and without <code>strip = true</code>? I suspect that it's just that the Rust <code>strip = true</code> isn't as aggressive as the <code>strip</code> command.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-08-02 09:45</div>
            <div class="timeline-body"><p>It's indeed the difference between using the standard linker and mold. If i deactivate mold locally i get the same 37MB semi-stripped binary with <code>strip = true</code> that we see on CI. (Without <code>strip = true</code>, the binary is 40MB, properly stripped we are at 31MB/30MB).</p>
<p>So i think we have to configure mold for the linux build? <code>strip</code> doesn't seem to support stripping cross-compiled binaries, so we can't use it for the cross builds.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/messense">@messense</a> on 2024-08-02 09:56</div>
            <div class="timeline-body"><p><code>llvm-strip</code> might support stripping cross-compiled binaries.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/edmorley">@edmorley</a> on 2024-08-02 09:57</div>
            <div class="timeline-body"><p>I'm curious, why is Maturin passing manual linker args via <code>&quot;-C&quot; &quot;link-arg=-s&quot;</code> rather than the rustc option<code>-C strip={none,debuginfo,symbols}</code> mentioned here?
https://doc.rust-lang.org/rustc/codegen-options/index.html#strip</p>
<p>Did the Maturin strip feature just predate rust-lang/rust#72110?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-08-02 09:58</div>
            <div class="timeline-body"><p>Yeah, the maturin option is older, we could change maturin to use the new option.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/edmorley">@edmorley</a> on 2024-08-02 10:12</div>
            <div class="timeline-body"><blockquote>
<p>So i think we have to configure mold for the linux build? <code>strip</code> doesn't seem to support stripping cross-compiled binaries, so we can't use it for the cross builds.</p>
</blockquote>
<p>I just checked one of our Rust project's cross-compiled binaries (<code>aarch64-unknown-linux-musl-gcc</code> cross-compiled from <code>x86_64</code> Linux host using https://github.com/messense/homebrew-macos-cross-toolchains and Cargo's <code>strip = true</code>) and it's fully stripped, so it does seem like it is possible with <code>ld</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-08-03 10:35</div>
            <div class="timeline-body"><p>Reported upstream: https://github.com/rust-lang/cargo/issues/14346</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2024-08-03 11:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/edmorley">@edmorley</a> on 2024-08-03 12:18</div>
            <div class="timeline-body"><blockquote>
<p>Reported upstream: <a href="https://github.com/rust-lang/cargo/issues/14346">rust-lang/cargo#14346</a></p>
</blockquote>
<p>Thank you!</p>
<p>I took a quick look and this seems to be a regression from rust-lang/cargo#13257 in Rust 1.77.0.</p>
<p>As a workaround in the meantime (and to avoid individual projects having to adjust their own Cargo.toml files), Maturin could set <code>CARGO_PROFILE_RELEASE_STRIP=true</code> rather than passing <code>-C link-arg=-s</code> or <code>-C strip=symbols</code>.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:30:37 UTC
    </footer>
</body>
</html>
