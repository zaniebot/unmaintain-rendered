<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>How to handle custom `.venv` location in multi lib repos - astral-sh/uv #13089</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>How to handle custom `.venv` location in multi lib repos</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/13089">#13089</a>
        opened by <a href="https://github.com/andresliszt">@andresliszt</a>
        on 2025-04-24 13:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/andresliszt">@andresliszt</a> on 2025-04-24 13:28</div>
            <div class="timeline-body"><h3>Question</h3>
<p>Hello Thanks for this amazing project!.</p>
<pre><code>my-project/
‚îú‚îÄ‚îÄ Makefile
‚îú‚îÄ‚îÄ py_project/
‚îÇ   ‚îú‚îÄ‚îÄ uv.lock
‚îÇ   ‚îî‚îÄ‚îÄ Makefile
‚îî‚îÄ‚îÄ rs_project/
    ‚îî‚îÄ‚îÄ Makefile
</code></pre>
<p>Each <code>Makefile</code> has command to build the respective project, and the top level <code>Makefile</code> forwards the ref to the inners. I'm having problems in my CI/CD when:</p>
<ul>
<li>using the <a href="https://github.com/astral-sh/setup-uv">set-up uv action</a>, it creates a <code>.venv</code> in the root (<code>my-project</code>) and what I want is that the venv be at <code>py_project/.venv</code>, any <code>uv</code> command will create a new <code>.venv</code> at the right location (as desired) and I'm getting this warning:<pre><code class="language-warning:">`VIRTUAL_ENV=/home/runner/work/my-project/py_project/.venv` does not match the project environment path `.venv` and will be ignored; use `--active` to target the active environment instead
Using CPython 3.10.17
Creating virtual environment at: .venv
</code></pre>
</li>
</ul>
<pre><code>
In there a way to tell uv to work inside `py_project` always? I have tried several things reading the docs but I haven't been able to do it.

This warning can be handled with the --active, but I'm having several problem with other tools that manage their own venvs such as codspeed, when uv recreates a new venv it breaks everything


------------ Command snippets --------------

```Makefile
.DEFAULT_GOAL := help

#-------------------------------------------------
# Root Makefile for my-project
#-------------------------------------------------

.PHONY: help pymoors-% moors-%

# Proxy targets into subdirectories
pymoors-%:  ## Run target in pymoors/Makefile
	@$(MAKE) -C pymoors $*

moors-%:  ## Run target in moors/Makefile
	@$(MAKE) -C moors $*
</code></pre>
<p>and the py project reduced makefile</p>
<pre><code class="language-Makefile">.DEFAULT_GOAL := help
SOURCES      = python/pymoors tests

#-------------------------------------------------
# Environment checks &amp; pre‚Äëcommit helpers
#-------------------------------------------------
.PHONY: .uv .pre-commit pre-commit-install pre-commit-run
.uv:     ## Check for uv
	@uv -V \
	  || echo 'Please install uv: https://docs.astral.sh/uv/getting-started/installation/'
.pre-commit:   ## Check for pre-commit
	@uv run pre-commit --version \
	  || echo 'Please install pre-commit: https://pre-commit.com/'

pre-commit-install: .pre-commit   ## Install git hooks via pre-commit
	@echo &quot;Installing pre-commit hooks‚Ä¶&quot; \
	  &amp;&amp; uv run pre-commit install

pre-commit-run:                   ## Run all enabled hooks against all files
	@echo &quot;Running pre-commit on all files‚Ä¶&quot; \
	  &amp;&amp; uv run pre-commit run --all-files

#-------------------------------------------------
# Python/PyO3 (pymoors)
#-------------------------------------------------
.PHONY:  lock build-dev build-release \
        lint-python lint-rust pyright \
        test test-benchmarks test-all \
        coverage docs

lock:   ## Rebuild Python lockfile
	@echo &quot;[pymoors] rebuilding lockfile&quot; \
	  &amp;&amp; uv lock --upgrade

build-dev:  ## Build &amp; install in dev mode
	@echo &quot;[pymoors] dev build&quot; \
	  &amp;&amp; uv sync --group dev \
	  &amp;&amp; uv run maturin develop --uv
</code></pre>
<p>And using it in the action as</p>
<pre><code class="language-yaml">
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Build Pymoors (production)
        run: make pymoors-build-dev
</code></pre>
<p>This is the PR where I'm working on those changes : https://github.com/andresliszt/pymoors/pull/98</p>
<h3>Platform</h3>
<p><em>No response</em></p>
<h3>Version</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @andresliszt on 2025-04-24 13:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-04-24 13:42</div>
            <div class="timeline-body"><p>CC @eifinger this sounds like setup-uv more than uv.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eifinger">@eifinger</a> on 2025-04-24 13:46</div>
            <div class="timeline-body"><p>I literally merged https://github.com/astral-sh/setup-uv/pull/381 minutes ago üòÜ</p>
<p>I will release v6.0.0 of <code>setup-uv</code> shortly which adds the input <code>working-directory</code></p>
<p>EDIT: @andresliszt the current version of <code>setup-uv</code> automatically activates a venv when you use the <code>python-version</code> input. This won't be the case anymore in v6.0.0. Once it is released your problems should go away.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andresliszt">@andresliszt</a> on 2025-04-24 13:49</div>
            <div class="timeline-body"><p>Oh thank you @eifinger !!! Was doing everything, I was about to post that working directory wasn't workng. Thanks again</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../andresliszt/moo-rs/pulls/98.html">andresliszt/moo-rs#98</a> on 2025-04-24 13:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eifinger">@eifinger</a> on 2025-04-24 14:08</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/setup-uv/releases/tag/v6.0.0 is released. Let me know if this solves your errors üòÉ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andresliszt">@andresliszt</a> on 2025-04-25 02:41</div>
            <div class="timeline-body"><p>Thank you for the quick turnaround on the new release!</p>
<p>I‚Äôm running into a strange issue with <code>uv run pip install</code> in my Actions workflow. Here‚Äôs a simplified version of my <code>benchmarks</code> job:</p>
<pre><code class="language-yaml">jobs:
  benchmarks:
    name: Run benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v3
        with:
          python-version: ${{ env.DEFAULT_PYTHON }}

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          python-version: ${{ env.DEFAULT_PYTHON }}
          enable-cache: true
          working-directory: pymoors

      - name: Build optimized pymoors wheel
        id: build
        uses: PyO3/maturin-action@v1
        with:
          manylinux: auto
          args: --release --out dist --interpreter ${{ env.DEFAULT_PYTHON }}
          rust-toolchain: stable
          working-directory: pymoors

      - name: Capture wheel path
        id: find_wheel
        run: |
          # ‚Ä¶debug logic to set $WHEEL_FULL‚Ä¶
          echo &quot;wheel=$WHEEL_FULL&quot; &gt;&gt; $GITHUB_OUTPUT

      - name: Install built wheel &amp; inspect venv
        working-directory: pymoors
        run: |
          echo &quot;üîç Wheel path: ${{ steps.find_wheel.outputs.wheel }}&quot;
          echo &quot;üèóÔ∏è Creating virtual environment&quot;
          uv venv

          echo &quot;üì¶ Installing the wheel (no build isolation)&quot;
          uv run pip install &quot;${{ steps.find_wheel.outputs.wheel }}&quot; \
            --no-build-isolation \
            --force-reinstall

      - name: Run benchmarks
        uses: CodSpeedHQ/action@v3
        with:
          working-directory: pymoors
          run: make test-benchmarks
        env:
          CODSPEED_RUNNER_MODE: &quot;walltime&quot;
</code></pre>
<p><strong>What I‚Äôm seeing</strong><br />
Despite passing the absolute wheel path, pip falls back to:</p>
<pre><code>Building pymoors @ file:///home/runner/work/pymoors/pymoors/pymoors
‚Ä¶  
maturin pep517 build-wheel ‚Ä¶ --editable  
Permission denied: `/home/runner/work/pymoors/pymoors/pymoors/target/wheels` (os error 13)
</code></pre>
<p>In other words, pip never installs my wheel; it rebuilds the current directory as an editable package and hits the permission error. <strong>I can confirm that the wheel path is passed well</strong>.</p>
<p><strong>Temporary workaround</strong><br />
Switching to a plain Python install works, but the same permission error resurfaces later in the <code>Run benchmarks</code> step:</p>
<pre><code class="language-yaml">- name: Install wheel via python -m pip
  working-directory: pymoors
  run: |
    echo &quot;üîç Wheel path: ${{ steps.find_wheel.outputs.wheel }}&quot;
    echo &quot;üèóÔ∏è Creating virtual environment&quot;
    uv venv

    echo &quot;‚öôÔ∏è Bootstrapping pip&quot;
    python -m ensurepip --upgrade
    python -m pip install --upgrade pip

    echo &quot;üì¶ Installing wheel (no build isolation)&quot;
    python -m pip install -vvv --no-build-isolation --force-reinstall \
      &quot;file://${{ steps.find_wheel.outputs.wheel }}&quot;
</code></pre>
<p>This installs the wheel correctly, as I said, the next step</p>
<pre><code class="language-yaml">  - name: Run benchmarks
    uses: CodSpeedHQ/action@v3
    with:
      working-directory: pymoors
      run: make test-benchmarks
    env:
      CODSPEED_RUNNER_MODE: &quot;walltime&quot;
</code></pre>
<p>step still triggers the editable build and the same permission error, where</p>
<pre><code class="language-Makefile">test-benchmarks:  ## Run only benchmarks tests
	@echo &quot;[pymoors] benchmarks only&quot; \
	  &amp;&amp; uv sync --group testing \
	  &amp;&amp; uv run pytest tests/benchmarks --codspeed
</code></pre>
<hr />
<p><strong>Questions</strong></p>
<ol>
<li>Is there a way to make <code>uv run pip install</code> reliably pick up my pre-built wheel without falling back to a PEP-517 rebuild?</li>
<li>Can I configure <code>uv</code> so its pip shim respects <code>--no-build-isolation</code>?</li>
<li>Or is there a recommended pattern for installing wheels inside a <code>uv venv</code> that avoids this?</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eifinger">@eifinger</a> on 2025-04-25 11:31</div>
            <div class="timeline-body"><p>Can you try to leave out the <code>run</code> part?</p>
<pre><code class="language-yaml">uv pip install &quot;${{ steps.find_wheel.outputs.wheel }}&quot; \
            --no-build-isolation \
            --force-reinstall
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andresliszt">@andresliszt</a> on 2025-04-25 15:26</div>
            <div class="timeline-body"><p>@eifinger wow it does the trick <code>uv pip ...</code> works in the install wheel step, I'd like to know <em>why</em>, I think i'm going to read the docs carefully . The step where I run the benchmarks using the codspeed action is still failing. I think is not recognizing virtual env, because in the logs I can see that it attempts to install everything again.  i'll be digging into it and i'll let you know soon If can fix it.</p>
<pre><code class="language-yaml">  - name: Run benchmarks
    uses: CodSpeedHQ/action@v3
    with:
      working-directory: pymoors
      run: make test-benchmarks
    env:
      CODSPEED_RUNNER_MODE: &quot;walltime&quot;

</code></pre>
<p>fails with</p>
<pre><code>Preparing the environment
Running the benchmarks
  [pymoors] benchmarks only
  Resolved 121 packages in 0.59ms
     Building pymoors @ file:///home/runner/work/pymoors/pymoors/pymoors
  #################
  ### Omitted logs ###
  ################
  `/home/runner/work/pymoors/pymoors/pymoors/target/wheels`: Permission
denied (os error 13)

</code></pre>
<p>Probably synching first will do the work, but on main (without multiple libraries repo), I have the action working fine following the same steps.</p>
<ol>
<li>Install uv and create .venv</li>
<li>Build the wheel</li>
<li>Install the wheel</li>
<li>sync testing dependencies with uv</li>
<li>Run pytest</li>
</ol>
<p><strong>EDIT</strong>:</p>
<p>Steps listed above were wrong, I always did</p>
<ol>
<li>Install uv and create .venv</li>
<li>sync testing dependencies with uv</li>
<li>Build the wheel</li>
<li>Install the wheel <strong>forcing pymoors reinstall from step 2</strong></li>
<li>Run pytest</li>
</ol>
<p>Important to note that in step 2 all the dependencies are correctly installed in the created virtual env, note that pydantic's team do the same logic in their <a href="https://github.com/pydantic/pydantic-core/blob/main/.github/workflows/codspeed.yml">codspeed action
</a>.</p>
<p>Looks like when the wheel is created first and then sync, the last doesn't recognize that the project deps were installed (my hunch some stuff related with <code>uv.lock</code>).</p>
<p>I was wondering if there is a flag like <code>--no-deps</code> or something to install only group dependencies and no the project, i don't like to force reinstall because in the end we build the project twice</p>
<p>Thanks!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andresliszt">@andresliszt</a> on 2025-04-26 16:11</div>
            <div class="timeline-body"><p>@eifinger Thank you very much really for your help, I edited my comment above and could make all my actions to work. There are things with <code>uv run</code> that i still don't understand at 100% but will be reading and looking deeply in the code.</p>
<p>Thanks again!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-05-04 12:38</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:03 UTC
    </footer>
</body>
</html>
