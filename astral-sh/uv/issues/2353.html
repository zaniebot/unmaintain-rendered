<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regression from 0.1.15 to 0.1.16/17 when using --system on some RHEL based Docker images - astral-sh/uv #2353</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Regression from 0.1.15 to 0.1.16/17 when using --system on some RHEL based Docker images</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/2353">#2353</a>
        opened by <a href="https://github.com/alexprengere">@alexprengere</a>
        on 2024-03-11 09:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/alexprengere">@alexprengere</a></div>
            <div class="timeline-body"><p>I have a Docker image from a private registry which boils down to:</p>
<pre><code>FROM some_private_registry/rhel:latest

RUN dnf install --assumeyes python3 \
 &amp;&amp; dnf install --assumeyes python3-pip

RUN pip install --upgrade uv==0.1.15
RUN uv pip install httpx --system
</code></pre>
<p>This works great!
When replacing <code>uv==0.1.15</code> by <code>uv==0.1.16</code> or <code>uv==0.1.17</code>, I now have this error:</p>
<pre><code>STEP 4/4: RUN uv pip install httpx --system
error: Failed to list installed packages
  Caused by: failed to read directory `/usr/local/lib/python3.9/site-packages`
  Caused by: No such file or directory (os error 2)
Error: building at STEP &quot;RUN uv pip install httpx --system&quot;: while running runtime: exit status 2
</code></pre>
<p>Here are a few more details when inspecting the image:</p>
<pre><code>[root@0d3d619df19e app]# python3 -m site
sys.path = [
    &#x27;/app&#x27;,
    &#x27;/usr/lib64/python39.zip&#x27;,
    &#x27;/usr/lib64/python3.9&#x27;,
    &#x27;/usr/lib64/python3.9/lib-dynload&#x27;,
    &#x27;/usr/local/lib64/python3.9/site-packages&#x27;,
    &#x27;/usr/lib64/python3.9/site-packages&#x27;,
    &#x27;/usr/lib/python3.9/site-packages&#x27;,
]
USER_BASE: &#x27;/root/.local&#x27; (doesn&#x27;t exist)
USER_SITE: &#x27;/root/.local/lib/python3.9/site-packages&#x27; (doesn&#x27;t exist)
ENABLE_USER_SITE: True

[root@0d3d619df19e app]# python3 -c &#x27;import site; print(&quot;\n&quot;.join(site.getsitepackages()))&#x27;
/usr/local/lib64/python3.9/site-packages
/usr/local/lib/python3.9/site-packages
/usr/lib64/python3.9/site-packages
/usr/lib/python3.9/site-packages
</code></pre>
<p>It looks like <code>/usr/local/lib/python3.9/site-packages</code> does not exist.</p>
<pre><code>[root@0d3d619df19e app]# ls /usr/local/lib64/python3.9/site-packages
uv  uv-0.1.15.dist-info
[root@0d3d619df19e app]# ls /usr/local/lib/python3.9/site-packages
ls: cannot access &#x27;/usr/local/lib/python3.9/site-packages&#x27;: No such file or directory
</code></pre>
<p>I am not sure why <code>/usr/local/lib64/python3.9/site-packages</code> was not chosen here.
I checked on Fedora, it has a similar layout and the same issue is there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-11 13:02</div>
            <div class="timeline-body"><p>Iâ€™ll take a look, thanks! The main change between those versions is that we now follow the same logic as pip: for older Python versions or distros that override it, we use distutils instead of site-packages. Thatâ€™s likely whatâ€™s happening here, since youâ€™re pre-3.9, and my guess is distutils is patched in some way by the distro.</p>
<p>Can you check what directory pip installs into?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-11 13:51</div>
            <div class="timeline-body"><p>Actually, by far the most useful thing would be if you could share a minimal Dockerfile that reproduces this with Fedora or otherwise.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-11 13:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-11 13:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-11 13:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/alexprengere">@alexprengere</a> on 2024-03-11 14:47</div>
            <div class="timeline-body"><p>I could not reproduce on Fedora in Docker, so I will focus on RHEL, and open a separate issue for Fedora if I can ever build a MRE.</p>
<p>Here is the MRE for RHEL:</p>
<pre><code>FROM registry.access.redhat.com/rhel7/rhel
RUN python3 -m ensurepip
RUN python3 -m pip install --upgrade uv
RUN uv pip install httpx --system
</code></pre>
<p>Then I use podman to build (4.6.2). Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-11 14:50</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-11 14:53</div>
            <div class="timeline-body"><p>On that I get:</p>
<pre><code> &gt; [2/4] RUN python3 -m ensurepip:
#5 0.137 /bin/sh: python3: command not found
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-11 14:57</div>
            <div class="timeline-body"><p>I can try to resolve but I would like to make sure I&#x27;m using the same system Python install.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/alexprengere">@alexprengere</a> on 2024-03-11 15:29</div>
            <div class="timeline-body"><p>My bad, some caching hid this error. I will attempt another MRE (this is a bit non-trivial as my original issue used a private registry with private base images), and I am trying to replicate on publicly available images. Thank you for your patience.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-11 16:43</div>
            <div class="timeline-body"><p>@alexprengere - No rush, I just want to get it fixed as soon as I&#x27;m able to! :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-13 15:11</div>
            <div class="timeline-body"><p>I believe this is fixed by <a href="https://github.com/astral-sh/uv/pull/2413">astral-sh/uv#2413</a> (available in the next release).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-13 15:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-13 15:11</div>
            <div class="timeline-body"><p>If not, please re-open!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/alexprengere">@alexprengere</a> on 2024-03-14 07:53</div>
            <div class="timeline-body"><p>I can confirm the problem is no longer there on uv 0.1.20 ðŸ¥³ Thanks!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:30:23 UTC
    </footer>
</body>
</html>
