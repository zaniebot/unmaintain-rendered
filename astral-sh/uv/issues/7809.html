<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv publish` times out when uploading large packages (~85MiB) - astral-sh/uv #7809</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`uv publish` times out when uploading large packages (~85MiB)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/7809">#7809</a>
        opened by <a href="https://github.com/benniekiss">@benniekiss</a>
        on 2024-09-30 13:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/benniekiss">@benniekiss</a> on 2024-09-30 13:19</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

<p>When using <code>uv publish</code> to upload a package to a personal forgejo instance or at https://code.forgejo.org, I'm experiencing timeouts at the authentication stage. I'm seeing this when using either <code>--username</code> and <code>--password</code> or <code>--token</code>. Using <code>uvx twine upload</code> works.</p>
<p>EDIT:
I've also tested this against https://test.pypi.org/legacy/ and experience the same issue. See https://github.com/astral-sh/uv/issues/7809#issuecomment-2392235235</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-30 13:49</div>
            <div class="timeline-body"><p>Can you share verbose logs with <code>RUST_LOG=trace uv publish -v</code>? Make sure to redact any credentials.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-09-30 13:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @konstin by @konstin on 2024-09-30 14:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/benniekiss">@benniekiss</a> on 2024-09-30 14:03</div>
            <div class="timeline-body"><p>Here are logs when trying to upload to code.forgejo.org -</p>
<pre><code>(build) ðŸ“¦[bennie@micro-dev deps]$ RUST_LOG=trace uv publish -v --publish-url https://code.forgejo.org/api/packages/benniekiss/pypi --username benniekiss --password MYPASSWORD dist/exllamav2-0.2.3-cp312-cp312-linux_x86_64.whl 
DEBUG uv 0.4.17
warning: `uv publish` is experimental and may change without warning
Publishing 1 file to https://code.forgejo.org/api/packages/benniekiss/pypi
DEBUG Using request timeout of 30s
Uploading exllamav2-0.2.3-cp312-cp312-linux_x86_64.whl (130.9MiB)
DEBUG Using username/password basic auth
TRACE Handling request for https://benniekiss:****@code.forgejo.org/api/packages/benniekiss/pypi
TRACE Request for https://benniekiss:****@code.forgejo.org/api/packages/benniekiss/pypi is already fully authenticated
TRACE checkout waiting for idle connection: (&quot;https&quot;, code.forgejo.org)
DEBUG starting new connection: https://code.forgejo.org/    
TRACE Http::connect; scheme=Some(&quot;https&quot;), host=Some(&quot;code.forgejo.org&quot;), port=None
DEBUG resolving host=&quot;code.forgejo.org&quot;
DEBUG connecting to [2a01:4f9:3081:51ec::102]:443
DEBUG connected to [2a01:4f9:3081:51ec::102]:443
TRACE http1 handshake complete, spawning background dispatcher task
TRACE checkout dropped for (&quot;https&quot;, code.forgejo.org)
DEBUG Transient request failure for https://code.forgejo.org/api/packages/benniekiss/pypi, retrying: error sending request for url (https://code.forgejo.org/api/packages/benniekiss/pypi)
  Caused by: operation timed out
WARN Transient request failure for https://code.forgejo.org/api/packages/benniekiss/pypi, retrying
DEBUG Using username/password basic auth
TRACE Handling request for https://benniekiss:****@code.forgejo.org/api/packages/benniekiss/pypi
TRACE Request for https://benniekiss:****@code.forgejo.org/api/packages/benniekiss/pypi is already fully authenticated
TRACE checkout waiting for idle connection: (&quot;https&quot;, code.forgejo.org)
DEBUG starting new connection: https://code.forgejo.org/    
TRACE Http::connect; scheme=Some(&quot;https&quot;), host=Some(&quot;code.forgejo.org&quot;), port=None
DEBUG resolving host=&quot;code.forgejo.org&quot;
DEBUG connecting to [2a01:4f9:3081:51ec::102]:443
DEBUG connected to [2a01:4f9:3081:51ec::102]:443
TRACE http1 handshake complete, spawning background dispatcher task
TRACE checkout dropped for (&quot;https&quot;, code.forgejo.org)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-30 14:14</div>
            <div class="timeline-body"><p>Hm weird. It's not clear to me what's going on there.</p>
<p>cc @konstin</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/benniekiss">@benniekiss</a> on 2024-09-30 14:21</div>
            <div class="timeline-body"><p>I'm getting this in my forgejo instance logs when I upload, but I'm not getting anything more meaningful -</p>
<p><code>2024/09/30 10:20:13 ...eb/routing/logger.go:102:func1() [I] router: completed POST /api/packages/gts/pypi for 100.64.0.13:0, 400 Bad Request in 31283.3ms @ pypi/pypi.go:108(pypi.UploadPackageFile)</code></p>
<p>forgejo code - https://codeberg.org/forgejo/forgejo/src/commit/e3eaa284bb86a3767bff7c601f74e8350b66f6f4/routers/api/packages/pypi/pypi.go#L107-L190</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-10-01 12:50</div>
            <div class="timeline-body"><p>I unfortunately can't reproduce, uploading succeeds for me: https://code.forgejo.org/konstin/-/packages/pypi/black/0.1.0</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @konstin on 2024-10-01 12:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @konstin on 2024-10-01 12:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/benniekiss">@benniekiss</a> on 2024-10-01 13:42</div>
            <div class="timeline-body"><blockquote>
<p>I unfortunately can't reproduce, uploading succeeds for me: https://code.forgejo.org/konstin/-/packages/pypi/black/0.1.0</p>
</blockquote>
<p>Are you using a PAT as password or a regular password? I did not mention this earlier, but I was using a PAT</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-10-01 13:43</div>
            <div class="timeline-body"><p>I generated a token and used that for the upload</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/benniekiss">@benniekiss</a> on 2024-10-01 14:09</div>
            <div class="timeline-body"><p>I'll see if I can't get it working again on my end and give a better example</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/benniekiss">@benniekiss</a> on 2024-10-01 14:27</div>
            <div class="timeline-body"><p>So I am also able to publish the same <code>black</code> wheel you published (I just downloaded it from the link you posted); however, I still cannot publish the <code>exllama</code> wheel, and I think it may be related to the size of the file that's causing it to timeout. Here's what my console looks like when trying to publish the wheel:</p>
<img width="824" alt="Screenshot 2024-10-01 at 10 26 37" src="https://github.com/user-attachments/assets/318b11c4-c8a2-4c93-b735-016fc363c267">

<p>It typically restarts/timeouts after about 75mb have been uploaded, but sometimes it'll upload as much as 90% before timing out</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/benniekiss">@benniekiss</a> on 2024-10-03 16:03</div>
            <div class="timeline-body"><p>Here is a pre-built wheel that I cannot upload using <code>uv publish</code>, but that does upload using <code>uvx twine upload</code> - https://pypi.org/project/vllm/#files</p>
<p>code to run:</p>
<pre><code>uv publish --username $MY_USER --password $MY_PASSWORD --publish-url https://code.forgejo.org/api/packages/$MY_USER/pypi vllm-0.6.2-cp38-abi3-manylinux1_x86_64.whl
</code></pre>
<p>This fails for me in the same way as above. I can successfully upload the wheel using twine:</p>
<pre><code>uvx twine upload --username $MY_USER --password $MY_PASSWORD --repository-url https://code.forgejo.org/api/packages/$MY_USER/pypi vllm-0.6.2-cp38-abi3-manylinux1_x86_64.whl
</code></pre>
<p>I also tried testing by uploading to https://test.pypi.org/legacy to see if it was specific to forgejo, but I need to rebuild the wheel with a different name because of namespace issues. Ill update once I get to rebuilding and if I encounter the same timeout.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/benniekiss">@benniekiss</a> on 2024-10-03 20:05</div>
            <div class="timeline-body"><p>I was able to reproduce this problem when uploading a package to https://test.pypi.org/legacy/ . Since pypi has namespace and size limits, creating an MRE is a little involved -</p>
<pre><code class="language-shell">export MY_PYPI_TOKEN=

mkdir -p test_uv_publish_size/src/my_package
cd test_uv_publish_size

## make pyproject.toml
cat &lt;&lt;EOF &gt; pyproject.toml
[project]
name = &quot;test_uv_publish_size_$(openssl rand -hex 4)&quot;
version = &quot;0.0.1&quot;

[build-system]
requires = [&quot;hatchling&quot;]
build-backend = &quot;hatchling.build&quot;

[tool.hatch.build.targets.wheel]
packages = [&quot;src/my_package&quot;]
EOF

## make our program
cat &lt;&lt;EOF &gt; src/my_package/__init__.py
print(&quot;Hello World&quot;)
EOF

## fake our package size
dd if=/dev/urandom of=src/my_package/test_data bs=90MB count=1

## build with uv
uv build --wheel .

## upload with uv
uv publish --publish-url https://test.pypi.org/legacy/ --token $MY_PYPI_TOKEN dist/*
</code></pre>
<p>Here is what my console looks like during the failure:</p>
<img width="855" alt="Screenshot 2024-10-03 at 15 57 54" src="https://github.com/user-attachments/assets/33e08da5-aec4-4134-b307-21000cb19c83">

<img width="855" alt="Screenshot 2024-10-03 at 15 58 27" src="https://github.com/user-attachments/assets/33e628c7-5bd4-43e6-85bd-2cc2804750f0">

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "`uv publish` times out when uploading package to forgejo registry" to "`uv publish` times out when uploading large packages (~85MiB)" by @benniekiss on 2024-10-03 20:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-10-04 11:19</div>
            <div class="timeline-body"><p>Thank you for the great reproduction!</p>
<p>Our default timeouts are too low and we weren't showing the retry warnings, fixed in #7921 and we'll increase timeouts to 15min in #7923.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> removed by @konstin on 2024-10-04 11:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @konstin on 2024-10-04 11:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2024-10-04 13:52</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 04:47:55 UTC
    </footer>
</body>
</html>
