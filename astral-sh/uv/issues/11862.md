```yaml
number: 11862
title: "can't publish to private pypiserver"
type: issue
state: closed
author: jmrouet
labels:
  - bug
  - good first issue
assignees: []
created_at: 2025-02-28T18:04:06Z
updated_at: 2025-03-11T14:54:44Z
url: https://github.com/astral-sh/uv/issues/11862
synced_at: 2026-01-10T01:57:27Z
```

# can't publish to private pypiserver

---

_Issue opened by @jmrouet on 2025-02-28 18:04_

### Summary

When I try to upload a wheel to a private pypiserver (pypiserver v2.3.2), I get the following error:

uv  publish --no-progress --native-tls --publish-url %MYURL% --password ... --username ... .\dist\mypackage-1.2.3.4.dev0* -vvv
    0.000045s DEBUG uv uv 0.6.3 (a0b9f22a2 2025-02-24)
Publishing 2 files https://{removed MYURL}
    0.002920s DEBUG uv_client::base_client Using request timeout of 900s
Uploading mypackage-1.2.3.4.dev0-py3-none-any.whl (2.7MiB)
    0.014107s DEBUG uv_publish Hashing dist\mypackage-1.2.3.4.dev0-py3-none-any.whl
Downloading mypackage-1.2.3.4.dev0-py3-none-any.whl (2.7MiB)
    0.051056s DEBUG uv_publish Using username/password basic auth
    0.100613s DEBUG uv_publish Response code for https://{removed MYURL}: 411 Length Required
    0.100948s DEBUG uv_publish Upload error response: <!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
 <html><head>
 <title>411 Length Required</title>
 </head><body>
 <h1>Length Required</h1>
 <p>A request of the requested method POST requires a valid Content-length.<br />
 </p>
 <hr>
 <address>Apache/2.4.62 (Debian) SVN/1.14.1 OpenSSL/1.1.1w mod_wsgi/4.7.1 Python/3.9 mod_perl/2.0.11 Perl/v5.32.1 Server at {MYURL} Port 443</address>
 </body></html>
error: Failed to publish `dist\mypackage-1.2.3.4.dev0-py3-none-any.whl` to https://{removed MYURL}
  Caused by: Upload failed with status code 411 Length Required. Server says: <!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<html><head>
<title>411 Length Required</title>
</head><body>
<h1>Length Required</h1>
<p>A request of the requested method POST requires a valid Content-length.<br />
</p>
<hr>
<address>Apache/2.4.62 (Debian) SVN/1.14.1 OpenSSL/1.1.1w mod_wsgi/4.7.1 Python/3.9 mod_perl/2.0.11 Perl/v5.32.1 Server at {MYURL} Port 443</address>
</body></html>

Is there a way to avoid this by changing the way "uv publish" communicates with the pip server ?

Running on windows
uv 0.6.3 (a0b9f22a2 2025-02-24)



### Platform

Windows 11 x64

### Version

uv 0.6.3 (a0b9f22a2 2025-02-24)

### Python version

Python 3.12.9

---

_Label `bug` added by @jmrouet on 2025-02-28 18:04_

---

_Comment by @konstin on 2025-03-04 13:22_

Unfortunately i can't reproduce this with a local pypiserver:

Running in one terminal

```
pypi-server run -p 8080 packages -P htpasswd.txt
```

and in the other 

```
uv publish --publish-url http://localhost:8080 -u example -p example
```

successfully uploads for me.

Could this be a setting with the apache server as reverse proxy?

---

_Label `bug` removed by @konstin on 2025-03-04 13:22_

---

_Label `needs-mre` added by @konstin on 2025-03-04 13:22_

---

_Comment by @jmrouet on 2025-03-04 20:10_

That's right. Using standalone pypiserver instance works for me too.

It fails when set as a wsgi process in Apache (linux)

Using wsgi is convenient because processes are respawned automatically on crash or on server restart.

Also using twine to publish works in this configuration.

Is there something I can do to help reproduce or even debug the client side ?

---

_Comment by @jmrouet on 2025-03-05 08:49_

@konstin I have created a minimalistic reproducing environment in a docker file.
you can have a look to my repo here:

https://github.com/jmrouet/pypiserver-wsgi-docker

Let me know if you run into issues with testing it. This environemnt exhibits a 400 error code instead of 411. I haven't checked why.

It works with "twine upload"

---

_Label `needs-mre` removed by @konstin on 2025-03-06 08:23_

---

_Comment by @konstin on 2025-03-06 08:24_

The difference seems to be the `LimitRequestBody` that requires a `Content-Length`. twine sets that content length, while uv currently streams the upload without computing the content length ahead of time. There's an option in reqwest that we can use to set the filesize manually ahead of time.

---

_Label `bug` added by @konstin on 2025-03-06 08:25_

---

_Comment by @jmrouet on 2025-03-06 15:47_

Great to see you were able to reproduce ;) thanks.

I tried to remove/change the `LimitRequestBody` but it does not change much.
If I set the `WSGIChunkedRequest` to `Off`, it exhibits Error 411, and I think it's worse ?!

As you can see from https://modwsgi.readthedocs.io/en/latest/configuration-directives/WSGIChunkedRequest.html this is indeed a limitation of WSGI that requires `Content-Length` to be known in advance.

Will you check into reqwest how to enable enable the option you're talking about? I don't know enough Rust to try by myself.

---

_Label `good first issue` added by @konstin on 2025-03-07 14:29_

---

_Comment by @konstin on 2025-03-07 14:30_

It should be relatively straightforward to change our upload logic to use [sized](https://docs.rs/reqwest/latest/reqwest/blocking/struct.Body.html#method.sized) bodies and check that the request has a content-length before we send it.

---

_Comment by @jmrouet on 2025-03-11 10:43_

I found a minimalistic change that seem to work on my minimalistic reproducing example.

Basically, I just replaced `Part::stream` with `Part::stream_with_length`


```
diff --git a/crates/uv-publish/src/lib.rs b/crates/uv-publish/src/lib.rs
index 6cd51cbd8..59eb4367f 100644
--- a/crates/uv-publish/src/lib.rs
+++ b/crates/uv-publish/src/lib.rs
@@ -754,7 +754,8 @@ async fn build_request(
     }

     let file = File::open(file).await?;
-    let idx = reporter.on_upload_start(&filename.to_string(), Some(file.metadata().await?.len()));
+    let file_size = file.metadata().await?.len();
+    let idx = reporter.on_upload_start(&filename.to_string(), Some(file_size));
     let reader = ProgressReader::new(file, move |read| {
         reporter.on_upload_progress(idx, read as u64);
     });
@@ -762,7 +763,7 @@ async fn build_request(
     // a lifetime) -> callback needs to be static -> reporter reference needs to be Arc'd.
     let file_reader = Body::wrap_stream(ReaderStream::new(reader));
     // See [`files_for_publishing`] on `raw_filename`
-    let part = Part::stream(file_reader).file_name(raw_filename.to_string());
+    let part = Part::stream_with_length(file_reader, file_size).file_name(raw_filename.to_string());
     form = form.part("content", part);

     let url = if let Some(username) = username {
```

How do I create a pull request for that ? do I have permissions to create a pull request ? 

---

_Comment by @konstin on 2025-03-11 10:47_

You can create a fork on GitHub (in the UI), push the commit to the fork and then create the pull request from the fork, https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/working-with-forks/fork-a-repo and https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request-from-a-fork should have information about that.

---

_Referenced in [astral-sh/uv#12111](../../astral-sh/uv/pulls/12111.md) on 2025-03-11 10:48_

---

_Comment by @jmrouet on 2025-03-11 10:49_

Ok I've created pull request #12111 


---

_Comment by @konstin on 2025-03-11 11:03_

Thanks! Will review

---

_Comment by @jmrouet on 2025-03-11 12:32_

@konstin 
One of the tests is still failing (https://github.com/astral-sh/uv/actions/runs/13787765100/job/38559950147?pr=12111) but I think it is not related to my change. 
Is that ok ?

---

_Comment by @konstin on 2025-03-11 13:55_

The failure looks like it's part of the PyPI outage unrelated to the PR (https://status.python.org/incidents/2zf08fkp0nd1), we can retry the job and it should pass.

---

_Comment by @jmrouet on 2025-03-11 14:53_

Indeed tests are ok now.

---

_Comment by @konstin on 2025-03-11 14:54_

Fixed through #12111

---

_Closed by @konstin on 2025-03-11 14:54_

---
