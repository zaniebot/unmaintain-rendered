<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuring multiple indexes with `uv publish` - astral-sh/uv #7963</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Configuring multiple indexes with <code>uv publish</code></h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/7963">#7963</a>
        opened by <a href="https://github.com/cthoyt">@cthoyt</a>
        on 2024-10-07 09:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cthoyt">@cthoyt</a></div>
            <div class="timeline-body"><p>This issue is related to #7676.</p>
<p>I would like to switch from <code>twine</code> to <code>uv publish</code>, but in my workflow, I first upload to Test PyPI then later to vanilla PyPI. This means that I need to have configuration for the separate username and token for each index.</p>
<p>Currently, the only way that I saw to get the username and token into <code>uv publish</code> is by an environment variable or passing separately as flags <a href="https://docs.astral.sh/uv/guides/publish/#publishing-your-package">(ref Oct. 7th)</a>. This isn&#x27;t so convenient to set and unset to different values during a single workflow, or require me to shuttle text through flags in a potentially messy/insecure way. Further, there are probably people who have private indexes they also want to quickly switch between vanilla PyPI, test PyPI, and their private indexes.</p>
<p>One solution from the PyPA was to keep track of different <code>index-servers</code> in the <code>.pypirc</code> file <a href="https://packaging.python.org/en/latest/specifications/pypirc/">(ref)</a>. There have been reservations about relying on text-based configurations, but currently as it is, it&#x27;s not comfortable to switch to <code>uv publish</code> (even though I want to!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wish</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-08 22:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cthoyt">@cthoyt</a> on 2024-10-23 06:56</div>
            <div class="timeline-body"><p>The solution to <a href="https://github.com/astral-sh/uv/issues/8448">astral-sh/uv#8448</a> is awfully close to what’s needed here - it looks like there’s already a uv solution for specifying indexes now, so it would just require having some more dynamic env var names for the publish credentials in the same way as the index credentials</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-11-03 17:54</div>
            <div class="timeline-body"><p>Can you use:</p>
<pre><code>      - name: Publish to Test PyPI
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: |
          uv publish --publish-url https://test.pypi.org/legacy/
      - name: Publish to PyPI
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          uv publish --publish-url https://upload.pypi.org/legacy/
</code></pre>
<p>or could you use keyring authentication, where credentials are tagged by URL?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cthoyt">@cthoyt</a> on 2024-11-03 18:30</div>
            <div class="timeline-body"><p>hi @konstin, thanks for checking in on this. If I were using something like GitHub Actions for publishing, then this is a great solution, so thanks for writing that up. Typo note for the second publish-url (shouldn&#x27;t have <code>test.pypi</code>, should just be <code>pypi</code>)</p>
<p>Unfortunately, I am not publishing from the GitHub actions workflow, but rather from my local machine. I get that there&#x27;s a push against people doing it, but that&#x27;s my workflow. I&#x27;m using twine in a tox configuration like this (abbreviated):</p>
<pre><code>[testenv:release]
skip_install = true
deps =
    twine &gt;= 1.5.0
    uv
commands =
    uv build --sdist --wheel --no-build-isolation
    twine upload --skip-existing dist/*
</code></pre>
<p>And I have a second environment that&#x27;s basically the same but passes the <code>--repository testpypi</code> flag to twine:</p>
<pre><code>[testenv:testrelease]
skip_install = true
deps =
    twine &gt;= 1.5.0
    uv
commands =
    uv build --sdist --wheel --no-build-isolation
    twine upload --skip-existing --repository testpypi dist/*
</code></pre>
<p>If your perceptive is, uv shouldn&#x27;t support this local workflow then I also understand. I think it would be a bummer though if I had to do some hacky things to get the credentials out of my <code>.pypirc</code> file to get it into the right environment variables for uv, though</p>
<p>Please let me know if there&#x27;s more information you&#x27;d like from my side</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cthoyt">@cthoyt</a> on 2024-11-03 18:35</div>
            <div class="timeline-body"><p>This might be a wild idea to throw out there, but I was reading up on https://docs.astral.sh/uv/configuration/indexes/, which for now is for installing packages from certain indexes, but ultimately this is a way of defining a specific name and URL for an upload URL. Maybe this is a place there the publish URL could also be stored, then you could have in your pyproject.toml:</p>
<pre><code>[[tool.uv.index]]
# Optional name for the index.
name = &quot;testpypi&quot;
# Required URL for the index.
url = &quot;https://test.pypi.org/&quot;
# Optional URL for uploading to the index
publish_url = &quot;https://test.pypi.org/legacy/&quot;
</code></pre>
<p>then, uv could get tricky and say, let&#x27;s look for an environment variable like <code>UV_PUBLISH_&lt;index.name&gt;_TOKEN</code> which in this case would be <code>UV_PUBLISH_TESTPYPI_TOKEN</code>. This would follow the same idea like for providing credentials, which is written up lower on the same guide at https://docs.astral.sh/uv/configuration/indexes/#providing-credentials</p>
<p>It&#x27;s not clear to me right now if the index username/password should be the same as the publish token and if those could be shared in the same environment variable as written up in the existing docs</p>
<p>edit: looks like something like this was also proposed before <a href="https://github.com/astral-sh/uv/pull/8531">astral-sh/uv#8531</a>#issuecomment-2442698889</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-11-03 18:41</div>
            <div class="timeline-body"><p>While publishing from a local machine isn&#x27;t the recommended workflow (less reproducibility, no auditability compared to CI runs, no trusted publishing, etc.), it is a supported workflow: We understand that not every project and setup is worth doing the extra work for publishing from CI.</p>
<p>Can you use the keyring integration? This stores the credentials in the system keyring instead of a plain text file. When using <code>keyring</code>, it store the token with the publish URL, so when you call publish with testpypi or pypi, it picks the right credentials.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cthoyt">@cthoyt</a> on 2024-11-03 18:49</div>
            <div class="timeline-body"><p>I&#x27;m not familiar with keyring but if what you&#x27;re saying is that you can use the publish_url as a &quot;key&quot; and then it associate the token with it, I think this is an excellent alternative. In this case, I would only suggest that we should write up a tutorial to show how using this is a solution for this multiple-indexes use case. Additionally, having a part specifically on migrating away from <code>.pypirc</code> would be great! I am happy to contribute this once I figure out how keyring works myself :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-11-03 18:59</div>
            <div class="timeline-body"><p>Let me test run the <code>keyring</code> instructions here before I add them to the docs.</p>
<p><code>keyring</code> is a PyPI package that is used to interact with the system keyring. The system keyring stores your passwords securely, depending on operating system and platform they are encrypted or even in a hardware enclave. The <code>keyring</code> package allows plugins to interface with external services, some alternative indexes only provide their credentials only through keyring plugins (e.g. <code>keyrings.google-artifactregistry-auth</code> or <code>artifacts-keyring</code>). For local publishing to e.g. PyPI, we only need the plain keyring package.</p>
<p>To use the keyring, install it as tool first:</p>
<pre><code>uv tool install keyring
</code></pre>
<p>Enter the token you got on PyPI in the interactive prompt, while replacing <code>PACKAGE_NAME</code> with the name of your package. The package name is an unfortunate workaround because we&#x27;re using the same username but different tokens per package, but keyring stores one password per URL/username combination.</p>
<pre><code>keyring set https://test.pypi.org/legacy/?PACKAGE_NAME __token__
keyring set https://upload.pypi.org/legacy/?PACKAGE_NAME __token__
</code></pre>
<p>Then you can publish with:</p>
<pre><code>uv publish --username __token__ --keyring-provider subprocess --publish-url https://test.pypi.org/legacy/?PACKAGE_NAME
uv publish --username __token__ --keyring-provider subprocess --publish-url https://upload.pypi.org/legacy/?PACKAGE_NAME
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wish</span> removed by <a href="https://github.com/konstin">@konstin</a> on 2024-11-03 18:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cthoyt">@cthoyt</a> on 2024-11-03 19:56</div>
            <div class="timeline-body"><p>One bit of confusion here is why the package name has anything to do with authentication. Does this mean I have to configure keyring over and over for every package I want to publish?</p>
<p>I tried setting it for a package I wrote https://github.com/cthoyt/class-resolver with:</p>
<pre><code>$ keyring set &quot;https://test.pypi.org/legacy/?class-resolver&quot; __token__
</code></pre>
<p>and then running the following:</p>
<pre><code>$ uv publish --username __token__ --keyring-provider subprocess --publish-url https://test.pypi.org/legacy/
warning: `uv publish` is experimental and may change without warning
Publishing 10 files https://test.pypi.org/legacy/
Uploading class_resolver-0.5.2-py3-none-any.whl (28.1KiB)
error: Failed to publish `dist/class_resolver-0.5.2-py3-none-any.whl` to https://test.pypi.org/legacy/
  Caused by: Permission denied (status code 403 Forbidden): 403 Invalid or non-existent authentication information. See https://test.pypi.org/help/#invalid-auth for more information.
</code></pre>
<p>I tried both ways with keyring for <code>class_resolver</code> and <code>class-resolver</code>, that didn&#x27;t change it.</p>
<p>uv version:</p>
<pre><code>$ uv --version
uv 0.4.29 (85f9a0d0e 2024-10-30)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-11-03 20:07</div>
            <div class="timeline-body"><p>A limitation of the keyring is that it stores one password per URL/username key, so we have to modify the URL to allow different tokens for different packages. I&#x27;ve updated the example to include the correct URL.</p>
<p>We should also warn when using the keyring but not getting credentials from it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cthoyt">@cthoyt</a> on 2024-11-04 07:47</div>
            <div class="timeline-body"><p>Ahh, I see what&#x27;s going on. It&#x27;s also possible to use a URL that doesn&#x27;t have the parameter set for the package if you just have a token used for everything. The updated you made in your comment before where you added the <code>?PACKAGE</code> made this more clear - so for a potential tutorial, it makes sense to note that there&#x27;s a generic solution (which may be insecure/less desirable) and a package-by-package solution too.</p>
<p>Confirming that the following worked</p>
<pre><code>$ keyring set https://test.pypi.org/legacy/ __token__
Password for &#x27;__token__&#x27; in &#x27;https://test.pypi.org/legacy/&#x27;: 

$ uv publish --username __token__ --keyring-provider subprocess --publish-url https://test.pypi.org/legacy/
warning: `uv publish` is experimental and may change without warning
Publishing 10 files https://test.pypi.org/legacy/
Uploading class_resolver-0.5.2-py3-none-any.whl (28.1KiB)
Uploading class_resolver-0.5.2.dev0-py3-none-any.whl (27.8KiB)
Uploading class_resolver-0.5.2.dev0.tar.gz (41.3KiB)
Uploading class_resolver-0.5.2.tar.gz (41.8KiB)
Uploading class_resolver-0.5.3-py3-none-any.whl (28.5KiB)
Uploading class_resolver-0.5.3.tar.gz (42.3KiB)
Uploading class_resolver-0.5.4-py3-none-any.whl (28.6KiB)
Uploading class_resolver-0.5.4.tar.gz (42.4KiB)
Uploading class_resolver-0.5.5.dev0-py3-none-any.whl (28.7KiB)
Uploading class_resolver-0.5.5.dev0.tar.gz (42.5KiB)
</code></pre>
<p>See https://test.pypi.org/project/class_resolver/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> added by <a href="https://github.com/konstin">@konstin</a> on 2024-11-04 08:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:34:31 UTC
    </footer>
</body>
</html>
