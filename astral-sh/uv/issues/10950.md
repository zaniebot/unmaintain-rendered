```yaml
number: 10950
title: Inconsistent C/C++ Extension Build Behavior
type: issue
state: closed
author: austin2118ace
labels:
  - bug
assignees: []
created_at: 2025-01-25T00:11:07Z
updated_at: 2025-01-25T17:44:39Z
url: https://github.com/astral-sh/uv/issues/10950
synced_at: 2026-01-10T01:57:25Z
```

# Inconsistent C/C++ Extension Build Behavior

---

_Issue opened by @austin2118ace on 2025-01-25 00:11_

### Summary

I have come across some interesting behavior using uv to build C/C++ extension modules in a package our lab is trying to use. 

For reference, this package is available with only `setup.py` and I have moved the pertinent fields into a `pyproject.toml` file. Since the `pyproject.toml` format does not support building extensions in a non-experimental manner, I have chosen to keep the `setup.py` alongside it to continue using the legacy build configuration. 

You can find the original repository [here](https://github.com/j-friedrich/OASIS) and my slightly updated repository [here](https://github.com/austin2118ace/OASIS-deconv).

## The Issue
There are several ways one can initiate the build of an external C/C++ extension. Traditionally, there are two main ways:
1) Manually build the binary using `python setup.py build_ext -i` and then use `pip install .` 
2) Use `pip install -e .` which will automatically invoke the build of the binary

Both of these commands run as expected, and the module is importable and usable. In an attempt to learn more about uv and its features, I have been experimenting with installing and building this package with uv. When running `uv pip install .` the behavior is effectively identical to `pip install -e .` since uv installs package as editable by default. However, I have had some challenges successfully building the package using uv.

### Successful Commands
1) `uv sync`: Does not invoke the build of the c/c++ extension; however, I believe this is expected behavior as it imitates `pip install .` which does not invoke building the extension.
2) `uv pip install .` :builds and installs the package as expected
3) `uv build --sdist --wheel .`: This command behaves exactly as expected. It builds the extension and compiles everything into a wheel. The wheel can then successfully be installed using `pip install [path_to_wheel.whl]`

### Unsuccessful Command:
`uv build`: This is the strange one. After consulting the documentation, I would expect this command to automatically determine the build back-end, create the isolated build environment, install the build dependencies, build the extension, and compile the wheel. However, running this command outright fails. You can see the build output in [this](https://gist.github.com/austin2118ace/ba69589610dd2010332df4d3d08d10ff) gist within `uv_build.log`.
This output does indicate what the issue is on line 69: `ValueError: 'oasis/oasis_methods.pyx' doesn't match any files`

So, to me (although I could be wrong) it seems like uv is not properly linking/copying the source file(s) into the temp build environment it creates. I further believe there is some more weirdness if you examine lines `7:11 and 21:25` where it complains about absolute paths being used when relative paths should be utilized. 

Leading off of this, I attempted to provide an absolute path in `setup.py` to the `.pyx` file which also resulted in a failed build due to the absolute path. 

I am curious if there is some inconsistency between how `uv build .` and `uv build --sdist --wheel .` are operating. Based on the documentation, I am lead to believe that `uv build .` should effectively be an alias for `uv build --sdist --wheel .`

> By default, if passed a directory, uv build will build a source distribution ("sdist") from the source directory, and a binary distribution ("wheel") from the source distribution. [uv build](https://docs.astral.sh/uv/reference/cli/#uv-build)

I'm curious on your thoughts. I can definitely use some of the successful methods, but wanted to bring what appeared to be an error to your attention. You can find the `pyproject.toml` and `setup.py` below.

Thanks

``` TOML
[project]
name = "oasis-deconv"
version = "0.2.0"
description = "Fast algorithm for deconvolution of neural calcium imaging traces"
authors = [
    {name="Johannes Friedrich", email="johannes.friedrich@alleninstitute.org"},
]
readme = "README.md"
requires-python = ">=3.5, <=3.13"
dependencies = [
    'numpy',
    'scipy',
    'matplotlib',
]

[build-system]
requires = ['setuptools', 'wheel', 'Cython', 'numpy>2']
build-backend = "setuptools.build_meta"

```

``` python
# setup.py
# run with:         python setup.py build_ext -i
# clean up with:    python setup.py clean --all

import numpy as np
from setuptools.extension import Extension
from setuptools import find_packages, setup
from Cython.Build import cythonize

ext_modules = [Extension("oasis.oasis_methods",
                         sources=["oasis/oasis_methods.pyx"],
                         include_dirs=[np.get_include()],
                         language="c++")]

setup(name='oasis.oasis_methods',
      ext_modules=cythonize(ext_modules,compiler_directives={'cdivision': True}),
)


```

### Platform

Linux 5.15.167.4-microsoft-standard-WSL2 x86_64 GNU/Linux

### Version

uv 0.5.14

### Python version

Python 3.10.16

---

_Label `bug` added by @austin2118ace on 2025-01-25 00:11_

---

_Comment by @charliermarsh on 2025-01-25 00:16_

`uv build .` is slightly different than `uv build --sdist --wheel .`. The former builds an sdist, then builds the wheel from the sdist. The latter builds an sdist from source, and then a wheel from source.

I'd suggest trying the same commands with [`pypa/build`](https://github.com/pypa/build) to determine whether it's a problem with uv, or a problem with your package / backend, since that's basically the "canonical" spec. If you see the same behavior with `pypa/build`, then we can focus on figuring out what's wrong in your build setup. If you see different behavior, we can focus on what's wrong with uv.

---

_Comment by @austin2118ace on 2025-01-25 16:30_

> @charliermarsh ...

Hi Charlie, wow thank you for pointing that out; that is quite the subtle difference in wording. Could you give me a very brief tl;dr on the difference or point me out to some docs where the difference is explained? 

I can confirm the behavior of `pypa/build` is the same as I described above. So I need to spend some time trying to figure out why `python -m build | uv build ` fails whereas `python -m build --sdist --wheel | uv build --sdist --wheel` works. 

---

_Comment by @zanieb on 2025-01-25 17:04_

Building from a wheel from the source distribution (sdist) instead of from the source tree (the working directory) is best practice because it ensures your sdist can be properly built by consumers. The most notable practical difference is that if files needed for the build are not properly included in the sdist they'll be missing and cause a failure â€” from a skim of your issue, it seems like you're encountering this?

---

_Comment by @austin2118ace on 2025-01-25 17:44_

> @zanieb @charliermarsh  ...

Yup, that was the problem. I didn't realize the difference between building from the source tree and source distribution and explicitly including the non-python file.
 
The solution is to either:
1) Include a `MANIFEST.in` with the line `include oasis/*.pyx` in the root so `setuptools` knows to include it in the `sdist`
2) Include the following lines in the `pyproject.toml` to achieve the same end result

``` TOML

[tool.setuptools.package-data]
oasis = ["*.pyx"]

```

I have confirmed both work with `python -m build` and `uv build`
Thank you both for the help! Glad to know this wont entail extra work on your end lol.

---

_Closed by @austin2118ace on 2025-01-25 17:44_

---
