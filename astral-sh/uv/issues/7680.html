<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regression in prefetching unbounded-lower-bound packages - astral-sh/uv #7680</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Regression in prefetching unbounded-lower-bound packages</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/7680">#7680</a>
        opened by <a href="https://github.com/topherinternational">@topherinternational</a>
        on 2024-09-25 07:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/topherinternational">@topherinternational</a> on 2024-09-25 07:49</div>
            <div class="timeline-body"><p>#4136 (implemented by #4149) addressed an issue where the prefetcher was fetching the lowest-ever version of a dependency, which wasn't compatible with the Python version, and the wheel build for that version failed and killed the resolver process.</p>
<p>It looks like this has regressed in uv 0.4.8 with the same behavior seen in #4136. Failures were seen when Airflow tried to upgrade to 0.4.8+ in https://github.com/apache/airflow/pull/42274.</p>
<p>I have a more minimal repro that doesn't require checking out airflow (these are the key packages causing the conflict in the <code>-e &quot;.[google]&quot;</code> install from #4136):</p>
<ol>
<li>Create and activate a fresh Python 3.8 environment</li>
<li>Run <code>uv pip install --resolution lowest --upgrade pandas-gbq==0.7.0 &quot;pandas==1.5.3 ; python_version &lt; \&quot;3.9\&quot;&quot; --dry-run --verbose</code></li>
</ol>
<pre><code>(venv38) ~/code/airflow (main) % uv pip install --resolution lowest --upgrade pandas-gbq==0.7.0 &quot;pandas==1.5.3 ; python_version &lt; \&quot;3.9\&quot;&quot; --dry-run
error: Failed to download and build `pandas==0.1`
  Caused by: Build backend failed to determine extra requires with `build_wheel()` with exit status: 1
--- stdout:

--- stderr:
Traceback (most recent call last):
  File &quot;&lt;string&gt;&quot;, line 14, in &lt;module&gt;
  File &quot;/Users/cpanderson/Library/Caches/uv/builds-v0/.tmpWkAeOB/lib/python3.8/site-packages/setuptools/build_meta.py&quot;, line 332, in get_requires_for_build_wheel
    return self._get_build_requires(config_settings, requirements=[])
  File &quot;/Users/cpanderson/Library/Caches/uv/builds-v0/.tmpWkAeOB/lib/python3.8/site-packages/setuptools/build_meta.py&quot;, line 302, in _get_build_requires
    self.run_setup()
  File &quot;/Users/cpanderson/Library/Caches/uv/builds-v0/.tmpWkAeOB/lib/python3.8/site-packages/setuptools/build_meta.py&quot;, line 503, in run_setup
    super().run_setup(setup_script=setup_script)
  File &quot;/Users/cpanderson/Library/Caches/uv/builds-v0/.tmpWkAeOB/lib/python3.8/site-packages/setuptools/build_meta.py&quot;, line 318, in run_setup
    exec(code, locals())
  File &quot;&lt;string&gt;&quot;, line 5, in &lt;module&gt;
ModuleNotFoundError: No module named 'numpy'
---
</code></pre>
<p>I repro'd from source bisecting between 0.4.7 and 0.4.8 and found the exact change that causes the regression: #7226 (@charliermarsh).</p>
<p><code>pandas-gbq</code> 0.7.0 has an unbounded dependency on <code>pandas</code>, so with <code>--resolution lowest</code> the prefetcher tries to load the earliest pandas version of 0.1 which doesn't build properly. #4149 was written to prevent fetching if a dependency has an unbounded lower-bound, iow this exact scenario.</p>
<p>#7226 changes the line that detects an unbounded source dist:</p>
<pre><code class="language-diff">                 // Avoid prefetching source distributions with unbounded lower-bound ranges. This
                 // often leads to failed attempts to build legacy versions of packages that are
                 // incompatible with modern build tools.
-                if !dist.prefetchable() {
+                if dist.wheel().is_some() {
                     if !self.selector.use_highest_version(&amp;package_name) {
                         if let Some((lower, _)) = range.iter().next() {
                             if lower == &amp;Bound::Unbounded {
</code></pre>
<p>@charliermarsh is it possible this comparison is backwards? It seems like this block should be entered if the dist is NOT a wheel, this may have been inadvertently reversed when #7226 was written?</p>
<p>cc @potiuk @dirrao</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/7683.html">astral-sh/uv#7683</a> on 2024-09-25 10:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-09-25 12:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-25 12:35</div>
            <div class="timeline-body"><p>Thank you for the thorough analysis... Yes, I think you're right.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-09-25 12:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../apache/airflow/pulls/42574.html">apache/airflow#42574</a> on 2024-09-29 19:29</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:22 UTC
    </footer>
</body>
</html>
