```yaml
number: 14974
title: "`required-environments`: only require that some extras build in some environments"
type: issue
state: closed
author: tbrugere
labels:
  - question
assignees: []
created_at: 2025-07-30T14:24:03Z
updated_at: 2025-07-30T15:19:29Z
url: https://github.com/astral-sh/uv/issues/14974
synced_at: 2026-01-10T01:57:34Z
```

# `required-environments`: only require that some extras build in some environments

---

_Issue opened by @tbrugere on 2025-07-30 14:24_

### Question

As all dependency problems, this one originates from `torch`. 

I need to support cuda 12.4  on x86_64, and cuda 12.8 on arm64.  Importantly, pytorch does not provide builds for cuda 12.4 on arm64 platforms.

so I wrote my `pyproject.toml`  the following way, using, specifying the `extra` field in `required-environments` to limit which version of cuda uv would try to resolve for depending on which platform

```toml
[project]
name = "minimal_reproduction"
version = "0.1.0"
description = ""
readme = "README.md"
requires-python = ">=3.13"
dependencies = []

[tool.uv]
conflicts = [
    [{extra="cu128"}, {extra="cu124"}]
    ]
required-environments = [
    "sys_platform == 'linux' and platform_machine == 'x86_64'  and extra == 'cu124'",
    "sys_platform == 'linux' and platform_machine == 'aarch64' and extra == 'cu128'",
]
index-strategy = "unsafe-best-match"



[project.optional-dependencies]
cu124 = [
    "torch==2.6.0+cu124", 
]

cu128 = [
    "torch==2.7.0+cu128", 
]

[[tool.uv.index]]
name = "torch-cu128"
url = "https://download.pytorch.org/whl/cu128"

[[tool.uv.index]]
name = "torch-cu124"
url = "https://download.pytorch.org/whl/cu124"
```

But it seems `uv` ignores the `extra` field, and still complains that it cannot build `cu124` on `arm`

```
× No solution found when resolving dependencies for split (python_full_version ==
  │ '3.13.*' and platform_machine == 'aarch64' and sys_platform == 'linux' and extra ==
  │ 'cu128'):
  ╰─▶ Because torch==2.6.0+cu124 has no `python_full_version == '3.13.*' and
      platform_machine == 'aarch64' and sys_platform == 'linux' and extra ==
      'cu128'`-compatible wheels and test[cu124] depends on torch==2.6.0+cu124, we can
      conclude that test[cu124]'s requirements are unsatisfiable.
      And because your project requires test[cu124], we can conclude that your project's
      requirements are unsatisfiable.

      hint: The resolution failed for an environment that is not the current one, consider
      limiting the environments with `tool.uv.environments`.
```

Is there a way to limit which extras uv will try to build on certain environments?

### Platform

Ubuntu 22.04.5 LTS Linux 5.15.0-126-generic x86_64 GNU/Linux

### Version

uv 0.8.0

---

_Label `question` added by @tbrugere on 2025-07-30 14:24_

---

_Comment by @zanieb on 2025-07-30 14:33_

We need to solve the full dependency tree to produce a lockfile.

We're trying to build the package during resolution in order to determine its metadata. Otherwise, we cannot tell what its dependencies are.

You could probably define static metadata for the package to avoid that? https://docs.astral.sh/uv/concepts/resolution/#dependency-metadata

---

_Comment by @tbrugere on 2025-07-30 14:40_

Hi @zanieb , thanks for your answer

I'm not sure which package you are talking about that needs to be built? Is it torch? It is only available as pre-build distributions, there's nothing to build there. 

I can hardcode its dependencies in my pyproject, but I am not sure how that would solve the problem. 

It seems the difficulty lies with the fact that I need two different versions on two different platforms, and uv is trying to resolve for both versions on both platforms (which is impossible). How is adding static dependencies going to solve that?

---

_Comment by @zanieb on 2025-07-30 14:43_

Sorry, I was reading into your title. What did you mean by "require that some extras build"?

I'll look closer at the resolver error here...

---

_Comment by @zanieb on 2025-07-30 14:44_

I think the crux here is that we're not considering the extra we're solving for when assessing `required-environment` markers so `and extra == 'cu128'` is ignored?

---

_Comment by @zanieb on 2025-07-30 14:45_

This might resolve if you add the platform marker to your dependency? 

e.g.,

```
cu124 = [
    "torch==2.6.0+cu124; sys_platform == 'linux' and platform_machine == 'x86_64'", 
]
```

---

_Comment by @zanieb on 2025-07-30 14:50_

Separately...

> required-environments to limit which version of cuda uv would try to resolve for depending on which platform

I'm also not sure this is a correct use of `required-environments`. 

> The required-environments setting can be used to ensure that the resulting resolution contains wheels for specific platforms, or fails if no such wheels are available.

from https://docs.astral.sh/uv/concepts/resolution/#required-environments

Perhaps you're just looking for `environments`?

> If your project supports only a limited set of platforms or Python versions, you can constrain the set of solved platforms via the environments setting, [...]. In other words, you can use the environments setting to reduce the set of supported platforms.

from https://docs.astral.sh/uv/concepts/resolution/#limited-resolution-environments

---

_Comment by @tbrugere on 2025-07-30 15:19_

It does resolve now! thank you ! I wasn't aware you could add full platform markers in dependencies. 

Yes it probably should be environments, thanks for catching that too

---

_Closed by @tbrugere on 2025-07-30 15:19_

---
