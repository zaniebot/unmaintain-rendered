```yaml
number: 12493
title: "`uv sync --dry-run --reinstall` does not check access to indexes"
type: issue
state: open
author: LewisGaul
labels:
  - enhancement
  - needs-decision
assignees: []
created_at: 2025-03-26T17:36:14Z
updated_at: 2025-04-03T01:12:47Z
url: https://github.com/astral-sh/uv/issues/12493
synced_at: 2026-01-10T01:57:28Z
```

# `uv sync --dry-run --reinstall` does not check access to indexes

---

_Issue opened by @LewisGaul on 2025-03-26 17:36_

### Summary

I'm testing out using a custom index with the following config:
```toml
[project]
name = "test-pkg"
version = "0.1.0"
requires-python = ">=3.11"
dependencies = ["pyyaml"]

[[tool.uv.index]]
name = "foo-pypi"
url = "https://.../foo-pypi-local/simple"
explicit = true

[tool.uv.sources]
pyyaml = { index = "foo-pypi" }
```

I can then install `pyyaml` from the "foo" index with: `UV_INDEX_FOO_PYPI_PASSWORD=$TOKEN uv sync` as expected (and `--dry-run` works fine here too).

If I try to reinstall the package without the token being provided this errors, as expected:
```
   > uv sync --reinstall
Resolved 2 packages in 0.75ms
x Failed to download `pyyaml==0.0.1`
  |-> Failed to fetch: `https://.../foo-pypi-local/pyyaml/0.0.1/pyyaml-0.0.1-py3-none-any.whl`
  `-> HTTP status client error (403 Forbidden) for url
      (https://.../foo-pypi-local/pyyaml/0.0.1/pyyaml-0.0.1-py3-none-any.whl)
  help: `pyyaml` (v0.0.1) was included because `test-pkg` (v0.1.0) depends on `pyyaml`
```

However with `--dry-run` there is no indication of the error:
```
   > uv sync --reinstall --dry-run
Discovered existing environment at: .venv
Resolved 2 packages in 0.78ms
Found up-to-date lockfile at: uv.lock
Would download 1 package
Would uninstall 1 package
Would install 1 package
 - pyyaml==0.0.1
 + pyyaml==0.0.1
```

I appreciate this is a bit niche/low priority but thought the issue would be appreciated by a team that has such an impressive attention to detail!

### Platform

RHEL8 x86_64

### Version

uv 0.6.10

### Python version

Python 3.11.4

---

_Label `bug` added by @LewisGaul on 2025-03-26 17:36_

---

_Label `bug` removed by @zanieb on 2025-04-01 19:23_

---

_Label `enhancement` added by @zanieb on 2025-04-01 19:23_

---

_Comment by @zanieb on 2025-04-01 19:24_

I'm unsure if we _should_ hit the network during dry-run since it's sort of a "real" action? It could be nice to check and warn if it would fail though ðŸ¤” 

What's the use-case for this?

---

_Label `needs-decision` added by @zanieb on 2025-04-01 19:24_

---

_Comment by @LewisGaul on 2025-04-03 00:09_

Apologies for the miscategorisation, I did question whether it should be considered a bug.

I was assuming `--dry-run` already relies on network access get package metadata? A couple of use-cases shown below.

To resolve dependencies:
```
   > uv pip install --dry-run --reinstall --no-cache pydantic
Resolved 5 packages in 102ms
Would download 5 packages
Would install 5 packages
 + annotated-types==0.7.0
 + pydantic==2.11.1
 + pydantic-core==2.33.0
 + typing-extensions==4.13.0
 + typing-inspection==0.4.0
```

Or to check the actual project name from a URL:
```
   > uv pip install --dry-run 'git+https://github.com/jackrosenthal/legacy-cgi.git'
Resolved 1 package in 482ms
Would download 1 package
Would install 1 package
 + legacy-cgi @ git+https://github.com/jackrosenthal/legacy-cgi.git@968c02eaa3c13188a448bacc17d3e1a994eb4c4d
```

The use-case I showed in the description was wanting to check some config variations when installing from multiple indexes, using the version number that would be installed to determine which index was selected, but not actually caring about the install being completed.

---

_Comment by @zanieb on 2025-04-03 00:41_

> Apologies for the miscategorisation, I did question whether it should be considered a bug.

No worries!

> I was assuming --dry-run already relies on network access get package metadata? 

I think `uv sync` can get all that metadata from the `uv.lock` file. It's a bit different in `uv pip` where we don't have a local source. 

```
â¯ uv sync --no-cache --dry-run --offline
Discovered existing environment at: .venv
Resolved 5 packages in 7ms
Found up-to-date lockfile at: uv.lock
Audited 4 packages in 0.20ms
Would make no changes

â¯ uv pip install --no-cache --dry-run pydantic --offline
  Ã— No solution found when resolving dependencies:
  â•°â”€â–¶ Because pydantic was not found in the cache and you require pydantic, we can conclude that your
      requirements are unsatisfiable.

      hint: Packages were unavailable because the network was disabled. When the network is disabled,
      registry packages may only be read from the cache.
```

Though, it looks like I can get `uv sync` to hit the network if the lockfile is stale.

That's an interesting use-case.

---

_Comment by @LewisGaul on 2025-04-03 00:55_

Ah I see, that does expose another case where `--dry-run` indicates something would succeed when actually it would fail (which could be determined without accessing the network): combining `--no-cache` and `--offline`, since it's impossible to install in offline mode without the cache?

```
$uv sync --offline --no-cache --dry-run
Discovered existing environment at: .venv
Resolved 52 packages in 1ms
Found up-to-date lockfile at: uv.lock
Would download 1 package
Would install 1 package
 + pydantic-core==2.27.2

$uv sync --offline --no-cache
Resolved 52 packages in 1ms
  x Failed to download `pydantic-core==2.27.2`
  `-> Network connectivity is disabled, but the requested data wasn't found in the cache for:
      `https://files.pythonhosted.org/packages/a6/74/d12b2cd841d8724dc8ffb13fc5cef86566a53ed358103150209ecd5d1999/pydantic_core-2.27.2-cp313-cp313-manylinux_2_17_x86_64.manylinux2014_x86_64.whl`
  help: `pydantic-core` (v2.27.2) was included because `my-pypi` (v0.1.0) depends on `pypi-simple` (v1.6.1) which depends on `pydantic` (v2.10.6) which depends on
        `pydantic-core`
```

I'd personally be in favour of making dry-run more correct by accessing the network when needed, and actually just be a dry-run of *whether packages get installed or not* (and also not updating the lock file or anything else potentially destructive on the local system).

---

_Comment by @zanieb on 2025-04-03 01:12_

I think what you're proposing makes sense. It sounds hard though :) 

I'd be happy to take a look at some proposed changes, but we're unlikely to pursue it ourselves in the short-term.

---
