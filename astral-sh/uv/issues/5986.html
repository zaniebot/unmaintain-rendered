<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revisit LTO for ppc64le binaries - astral-sh/uv #5986</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Revisit LTO for ppc64le binaries</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/5986">#5986</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-08-09 23:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-09 23:58</div>
            <div class="timeline-body"><p>In #5904, LTO was added to our release profile. However, in #5984, this failed for just the ppc64le musl cross build (which uses the nightly toolchain):</p>
<pre><code>error: failed to get bitcode from object file for LTO (could not find requested section)

error: could not compile `uv` (bin &quot;uv&quot;) due to 1 previous error
ðŸ’¥ maturin failed
  Caused by: Failed to build a native library through cargo
  Caused by: Cargo build finished with &quot;exit status: 101&quot;: `env -u CARGO &quot;cargo&quot; &quot;rustc&quot; &quot;--features&quot; &quot;self-update&quot; &quot;--target&quot; &quot;powerpc64le-unknown-linux-musl&quot; &quot;--message-format&quot; &quot;json-render-diagnostics&quot; &quot;--locked&quot; &quot;--manifest-path&quot; &quot;/home/runner/work/uv/uv/crates/uv/Cargo.toml&quot; &quot;--release&quot; &quot;--bin&quot; &quot;uv&quot; &quot;--&quot; &quot;-C&quot; &quot;link-arg=-s&quot;`
</code></pre>
<p>I unsuccessfully tried using <code>-Cembed-bitcode=yes</code> (https://github.com/rust-osdev/cargo-xbuild/pull/73) to workaround this, before creating a separate release profile (<code>release-no-lto</code>) with LTO disabled and using it for just this build (https://github.com/astral-sh/uv/pull/5984/commits/f0ffda4039f80d49810dd37ac067c373bb26c7f8).</p>
<p>I'm not anywhere near an expert at Rust compilation options. Someone else should validate this approach and explore alternatives.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">release</span> added by @zanieb on 2024-08-09 23:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/5984.html">astral-sh/uv#5984</a> on 2024-08-10 00:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davfsa">@davfsa</a> on 2024-08-10 08:35</div>
            <div class="timeline-body"><p>Hey!</p>
<p>First of all, sorry for making this an issue right at the time of release. Wish I could have caught this earlier.</p>
<p>Now, to the issue at hand, it seems like your attempts to pass <code>-Cembed-bitcode=yes</code> using <code>RUSTFLAGS</code> didn't make it through. I dont think docker containers inherit the environment of the runner. Something that could be tried is adding</p>
<pre><code>maturin_docker_options: -e RUSTFLAGS=&quot;-Cembed-bitcode=yes&quot;
</code></pre>
<p>to the matrix task for <code>ppc64le</code>, which would pass the environment flag to the container.</p>
<p>I am unable to test it until late night today or potentially tomorrow (I'm CEST), so dropping it here in case someone can give it a shot. Otherwise, will attempt to look more into it myself by running the docker containers locally.</p>
<p>Again, sorry for the issues this has caused!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-10 13:45</div>
            <div class="timeline-body"><blockquote>
<p>First of all, sorry for making this an issue right at the time of release. Wish I could have caught this earlier.</p>
</blockquote>
<p>That's not your fault, we should have tested the release builds with your change :)</p>
<blockquote>
<p>I dont think docker containers inherit the environment of the runner.</p>
</blockquote>
<p>I think Maturin specifically uses <code>-e RUSTFLAGS</code> to pass the variable to the container, I can see this passed to <code>docker run</code> in the logs â€” that said, I'm not a Maturin expert and cannot confirm the flag was used.</p>
<p>Thanks for following up!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davfsa">@davfsa</a> on 2024-08-11 10:16</div>
            <div class="timeline-body"><p>You were right!</p>
<p>It seems like it does get passed correctly, but maturin does seem to ignore them, as the way to specify them is in the toml (which doesn't allow specifying per type flags)</p>
<p>I'll keep investigating. Getting the docker image to run locally is being quite the struggle</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-11 14:45</div>
            <div class="timeline-body"><p>Might be easiest to run the action in a fork and just comment out the rest of the jobs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../element-hq/synapse/issues/18240.html">element-hq/synapse#18240</a> on 2025-07-28 23:43</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:21 UTC
    </footer>
</body>
</html>
