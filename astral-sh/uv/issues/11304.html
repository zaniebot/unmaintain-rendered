<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv pip compile --universal` not picking up required transitive dependency for certain python versions - astral-sh/uv #11304</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>`uv pip compile --universal` not picking up required transitive dependency for certain python versions</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/11304">#11304</a>
        opened by <a href="https://github.com/brendan-morin">@brendan-morin</a>
        on 2025-02-07 01:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/brendan-morin">@brendan-morin</a> on 2025-02-07 01:14</div>
            <div class="timeline-body"><h3>Summary</h3>
<h2>Overview</h2>
<p>I'm seeing some weird behavior where <code>uv pip compile --universal</code> does not seem to properly resolve the <code>async-timeout</code> transitive dependency of <code>aiohttp</code>, which is only required for python &lt; 3.11. We can see this dep <a href="https://github.com/aio-libs/aiohttp/blob/8aaaba3ec798327ab5ab52c977fb7395b56c54a4/setup.cfg#L56C3-L56C16">listed here</a>.</p>
<p>It does seem to work if <code>--python-version</code> is specified to a lower version (despite warning it doesn't exist), though this doesn't seem to be the intended outcome reading the docs/help strings for <code>--universal</code> and <code>--python-version</code>.</p>
<h2>Repro</h2>
<p><code>uv.toml</code></p>
<pre><code>python-install-mirror = &quot;https://...&quot; # Internal mirror
python-preference = &quot;managed&quot;

[[index]]
url = internal index
default = true
native-tls = true
</code></pre>
<p><code>requirements.in</code></p>
<pre><code>aiohttp==3.11.11
</code></pre>
<p>Commands:</p>
<pre><code>uv pip compile --universal requirements.in
</code></pre>
<p>Output:</p>
<pre><code>Resolved 9 packages in 10ms
# This file was autogenerated by uv via the following command:
#    uv pip compile --universal requirements.in
aiohappyeyeballs==2.4.4
    # via aiohttp
aiohttp==3.11.11
    # via -r requirements/test.in
aiosignal==1.3.2
    # via aiohttp
attrs==25.1.0
    # via aiohttp
frozenlist==1.5.0
    # via
    #   aiohttp
    #   aiosignal
idna==3.10
    # via yarl
multidict==6.1.0
    # via
    #   aiohttp
    #   yarl
propcache==0.2.1
    # via
    #   aiohttp
    #   yarl
yarl==1.18.3
    # via aiohttp
</code></pre>
<p>versions:</p>
<pre><code>uv --version

&gt; uv 0.5.29 (ca73c4754 2025-02-05)

python --version

&gt; Python 3.11.8

</code></pre>
<p>Note that running using <code>--python 3.10</code> provides a warning that it does not exist, but provides the expected output below now: <code>async-timeout==5.0.1 ; python_full_version &lt; '3.11'</code></p>
<pre><code>uv pip compile --universal --python-version 3.10 requirements.in
warning: The requested Python version 3.10 is not available; 3.11.8 will be used to build dependencies instead.
Resolved 11 packages in 5ms
# This file was autogenerated by uv via the following command:
#    uv pip compile --universal --python-version 3.10  requirements.in
aiohappyeyeballs==2.4.4
    # via aiohttp
aiohttp==3.11.11
    # via -r requirements/test.in
aiosignal==1.3.2
    # via aiohttp
async-timeout==5.0.1 ; python_full_version &lt; '3.11'
    # via aiohttp
attrs==25.1.0
    # via aiohttp
frozenlist==1.5.0
    # via
    #   aiohttp
    #   aiosignal
idna==3.10
    # via yarl
multidict==6.1.0
    # via
    #   aiohttp
    #   yarl
propcache==0.2.1
    # via
    #   aiohttp
    #   yarl
typing-extensions==4.12.2 ; python_full_version &lt; '3.11'
    # via multidict
yarl==1.18.3
    # via aiohttp
</code></pre>
<h3>Cargo culting</h3>
<p>One more note, and take this with a grain of salt, but I am 80% sure it initially did not resolve the transitive dep when using<code>--python-version 3.10</code>, but then after removing <code>python-preference = &quot;managed&quot;</code> from my <code>uv.toml</code> and then rerunning, it seemed to now work (though I am unable to reproduce that behavior now). I am only including this in case it is somehow related to existing uv python versions on the system.</p>
<h3>Platform</h3>
<p>macOS</p>
<h3>Version</h3>
<p>uv 0.5.29 (ca73c4754 2025-02-05)</p>
<h3>Python version</h3>
<p>Python 3.11.8</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @brendan-morin on 2025-02-07 01:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-07 01:17</div>
            <div class="timeline-body"><p>If you don't specify a <code>--python-version</code>, I believe we'll use the <em>discovered</em> Python as the minimum supported version. So, in this case, it looks like we're resolving for Python 3.11.8 and later -- in which case, <code>async-timeout</code> can be omitted, since it's never relevant on those versions!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/brendan-morin">@brendan-morin</a> on 2025-02-07 01:22</div>
            <div class="timeline-body"><p>I think that’s sensible enough. Maybe more of a documentation fix then, the cli help doesn’t seem to imply this limitation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-07 01:38</div>
            <div class="timeline-body"><p>We do have this in the documentation</p>
<pre><code>❯ uv help pip compile | grep &quot;default minimum Python&quot; -B 8

Python options:
      --python &lt;PYTHON&gt;
          The Python interpreter to use during resolution.
          
          A Python interpreter is required for building source distributions to
          determine package metadata when there are not wheels.
          
          The interpreter is also used to determine the default minimum Python
</code></pre>
<p>and</p>
<pre><code>❯ uv help pip compile | grep &quot;\-\-universal&quot; -A 4
      --universal
          Perform a universal resolution, attempting to generate a single `requirements.txt` output file that is compatible
          with all operating systems, architectures, and Python implementations.
          
          In universal mode, the current Python version (or user-provided `--python-version`) will be treated as a lower
          bound. For example, `--universal --python-version 3.7` would produce a universal resolution for Python 3.7 and
          later.
          
          Implies `--no-strip-markers`.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @zanieb on 2025-02-07 01:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2025-02-07 01:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/11305.html">astral-sh/uv#11305</a> on 2025-02-07 01:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/brendan-morin">@brendan-morin</a> on 2025-02-07 05:23</div>
            <div class="timeline-body"><p>Interesting, it looks like maybe the <code>--help</code> docs are out of sync with the <code>uv help</code> docs? Or perhaps just an unfortunate caveat cut off from concise vs detailed docs.</p>
<pre><code>&gt; uv pip compile --help | grep &quot;default minimum Python&quot; -B 8 

</code></pre>
<pre><code>&gt; uv pip compile --help | grep &quot;\-\-universal&quot; -A 4
      --universal                                        Perform a universal resolution, attempting to generate a single `requirements.txt` output file that is
                                                         compatible with all operating systems, architectures, and Python implementations
      --no-emit-package &lt;NO_EMIT_PACKAGE&gt;                Specify a package to omit from the output resolution. Its dependencies will still be included in the
                                                         resolution. Equivalent to pip-compile's `--unsafe-package` option
      --emit-index-url                                   Include `--index-url` and `--extra-index-url` entries in the generated output file
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-05-13 02:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:25 UTC
    </footer>
</body>
</html>
