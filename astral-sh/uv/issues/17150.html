<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`as_io_error` and coalescing `io::Error` could lead to confusing behaviour/bugs - astral-sh/uv #17150</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>as_io_error</code> and coalescing <code>io::Error</code> could lead to confusing behaviour/bugs</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/17150">#17150</a>
        opened by <a href="https://github.com/EliteTK">@EliteTK</a>
        on 2025-12-16 15:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/EliteTK">@EliteTK</a> on 2025-12-16 15:48</div>
            <div class="timeline-body"><h3>Issue</h3>
<p><a href="https://github.com/astral-sh/uv/tree/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781">Currently</a> the function <code>as_io_error</code> is implemented for:</p>
<ul>
<li><a href="https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv-fs/src/locked_file.rs#L78-L88"><code>uv_fs::locked_file::LockedFileError</code></a></li>
<li><a href="https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv-auth/src/store.rs#L93-L103"><code>uv_auth::store::TomlCredentialError</code></a></li>
<li><a href="https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv-tool/src/lib.rs#L95-L112"><code>uv_tool::Error</code></a></li>
</ul>
<p>These functions return the <code>io::Error</code> for any error variant within the error which contains an <code>io::Error</code>. In the case of <code>TomlCredentialError</code> and <code>uv_tool::Error</code> these also delegate to <code>LockedFileError</code>.</p>
<p><code>LockedFileError::as_io_error</code> is used in one place (aside from the implementation of <code>as_io_error</code> of the other errors):</p>
<p><a href="https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv-cache/src/lib.rs#L454-L488">https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv-cache/src/lib.rs#L454-L488</a></p>
<p>This problem is that the code it is used in is checking if shared locking is unsupported, which specifically relates to <code>LockedFileError::Lock</code>:</p>
<p>https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv-fs/src/locked_file.rs#L176-L181</p>
<p>But various other errors in <code>LockedFileError</code> include <code>io::Error</code>. This means that if any other function fails with an error with <code>ErrorKind::Unsupported</code> then the error message will be misleading.</p>
<p><code>TomlCredentialError::as_io_error</code> is used in two places:</p>
<p><a href="https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv-auth/src/middleware.rs#L80-L109">https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv-auth/src/middleware.rs#L80-L109</a></p>
<p><a href="https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv-auth/src/store.rs#L31-L53">https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv-auth/src/store.rs#L31-L53</a></p>
<p>In both cases <code>as_io_error</code> is being used to check for <code>ErrorKind::NotFound</code>. This will assume that the credential store itself was not found. But any io operation performed while locking the lockfile or reading the credential store which triggers an error of that sort would lead down this path. While it might make sense to coalesce the errors in the case of errors coming from <code>TextCredentialStore::from_file</code>, errors from <code>LockedFile::acquire</code> probably aren't relevant here.</p>
<p>There are 5 uses for <code>uv_tool::Error::as_io_error</code>:</p>
<ul>
<li><a href="https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv/src/commands/tool/install.rs#L406">https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv/src/commands/tool/install.rs#L406</a></li>
<li><a href="https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv/src/commands/tool/list.rs#L32">https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv/src/commands/tool/list.rs#L32</a></li>
<li><a href="https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv/src/commands/tool/run.rs#L480">https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv/src/commands/tool/run.rs#L480</a></li>
<li><a href="https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv/src/commands/tool/uninstall.rs#L22">https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv/src/commands/tool/uninstall.rs#L22</a></li>
<li><a href="https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv/src/commands/tool/uninstall.rs#L119">https://github.com/astral-sh/uv/blob/66f7093ad2f1b0fd34b59d486c3c0ac57fc0e781/crates/uv/src/commands/tool/uninstall.rs#L119</a></li>
</ul>
<p>All are using it to check for <code>ErrorKind::NotFound</code> and all exhibit similar issues.</p>
<h3>Proposal</h3>
<ul>
<li>Consider removing implementations of <code>as_io_error</code></li>
<li>For cases where a number of different enum variants may contribute to &quot;this operation failed because of X underlying cause&quot; (like maybe for <code>uv_tool::Error</code>) an explicit predicate function (e.g. maybe <code>::Io</code> and <code>::VirtualEnvError</code>).</li>
<li>For other cases, the relevant case should be checked explicitly.</li>
<li><code>Io(#[from] io::Error)</code> variants should be checked to ensure that they aren't used in situations where errors unrelated to each other are merged and then checked against an <code>ErrorKind</code> which could cause confusing error messages.</li>
</ul>
<h3>Example</h3>
<p>This would avoid buggy error reporting behaviour and make it easier to reason about the code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @EliteTK on 2025-12-16 15:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @EliteTK on 2025-12-16 15:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">error messages</span> added by @EliteTK on 2025-12-16 15:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-12-16 15:59</div>
            <div class="timeline-body"><p>I'm very much in favor of replacing <code>as_io_error</code> with properly typed checks.</p>
<p>I'd implement it so that <code>TomlCredentialError</code> should have a dedicated <code>NotFound</code> variant, so what callee can decide what is a not found error at call time. We likely want to replace some <code>Io(#[from] io::Error)</code> with <code>Io(#[source] io::Error)</code> to get more explicit checking.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:11 UTC
    </footer>
</body>
</html>
