```yaml
number: 11324
title: uv run fails after installing packges with root and uv 0.5.29
type: issue
state: closed
author: jamescooke
labels:
  - bug
assignees: []
created_at: 2025-02-07T17:55:31Z
updated_at: 2025-02-07T21:36:11Z
url: https://github.com/astral-sh/uv/issues/11324
synced_at: 2026-01-10T01:57:25Z
```

# uv run fails after installing packges with root and uv 0.5.29

---

_Issue opened by @jamescooke on 2025-02-07 17:55_

### Summary

## Current behaviour

We have an app which installs packages with uv in root, but then uses a team user to run the app.

However, as of `0.5.29`, this has stopped working. The error received when the team user tries to `uv run` anything is:

```
error: failed to create file `/tmp/uv-f348faaccf85129c.lock`: Permission denied (os error 13)
```

The following dockerfile reproduces the error

```dockerfile
FROM python:3.13
COPY --from=ghcr.io/astral-sh/uv:0.5.29 /uv /bin/uv

WORKDIR /usr/src/app
RUN uv init
RUN uv add pytest

RUN useradd --user-group --create-home --uid 1000 team
USER team
RUN uv run pytest -h
```

This fails when built with `docker build .` with:

```
 => ERROR [stage-0 7/7] RUN uv run pytest -h                                                        0.3s
------
 > [stage-0 7/7] RUN uv run pytest -h:
0.266 error: failed to create file `/tmp/uv-f348faaccf85129c.lock`: Permission denied (os error 13)
------
Dockerfile:10
--------------------
   8 |     RUN useradd --user-group --create-home --uid 1000 team
   9 |     USER team
  10 | >>> RUN uv run pytest -h
  11 |
--------------------
ERROR: failed to solve: process "/bin/sh -c uv run pytest -h" did not complete successfully: exit code: 2
```

## Expected behaviour

Pinning to `0.5.28` allows the build of the file above to run:

```dockerfile
COPY --from=ghcr.io/astral-sh/uv:0.5.28 /uv /bin/uv
```

This is the expected behaviour (unless doing the above is deprecated - if so please could you help me understand if there's a path for root to install and "normal" users to use?)

My colleague noticed this recent change released in `0.5.29` and thought it might be related to this issue: https://github.com/astral-sh/uv/pull/11259/


### Platform

Linux 5.15.0-131-generic x86_64 GNU/Linux

### Version

uv 0.5.29

### Python version

3.13.2

---

_Label `bug` added by @jamescooke on 2025-02-07 17:55_

---

_Comment by @charliermarsh on 2025-02-07 18:14_

Interesting, thanks. I'll fix this in the next release. We shouldn't be failing here.

---

_Referenced in [astral-sh/uv#11328](../../astral-sh/uv/pulls/11328.md) on 2025-02-07 20:13_

---

_Comment by @jamescooke on 2025-02-07 20:21_

Thanks for checking and confirming @charliermarsh üëçüèª 

Clarification for future readers: The small failing case above uses `uv init` in the Dockerfile. However, uv fails just the same when building a container image for an existing project. I just used `uv init` to create the simplest failing case possible.

Alternatively, a project can be build "like normal" on the host:

```console
$ uv init
$ uv add pytest
```

Then the following Dockerfile will fail in the same way (with or without `--frozen`):

```dockerfile
FROM python:3.13
COPY --from=ghcr.io/astral-sh/uv:0.5.29 /uv /bin/uv

WORKDIR /usr/src/app
COPY pyproject.toml uv.lock .
RUN uv sync --frozen

RUN useradd --user-group --create-home --uid 1000 team
USER team
RUN uv run pytest -h
```

Apart from just running as root instead, one work around appears to be to clean the `/tmp` dir after doing the `uv sync`.

```dockerfile
RUN rm /tmp/*
```

---

_Comment by @charliermarsh on 2025-02-07 20:23_

Yeah, we're creating that file during `uv add` (because we sync the project environment), and the permissions are such that other users can't acquire it.

---

_Assigned to @charliermarsh by @charliermarsh on 2025-02-07 21:05_

---

_Closed by @charliermarsh on 2025-02-07 21:36_

---

_Closed by @charliermarsh on 2025-02-07 21:36_

---

_Referenced in [astral-sh/uv#12665](../../astral-sh/uv/issues/12665.md) on 2025-04-04 09:29_

---

_Referenced in [astral-sh/uv#16769](../../astral-sh/uv/issues/16769.md) on 2025-12-02 13:45_

---
