<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Install uses wrong package location when a secondary Python installation is declared as venv - astral-sh/uv #2387</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Install uses wrong package location when a secondary Python installation is declared as venv</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/2387">#2387</a>
        opened by <a href="https://github.com/adebrecht661">@adebrecht661</a>
        on 2024-03-12 17:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/adebrecht661">@adebrecht661</a> on 2024-03-12 17:40</div>
            <div class="timeline-body"><p>On Ubuntu 22.04, with Python installed to <code>~/.local/bin/python</code> through a symlink (-&gt; <code>/usr/bin/python</code> -&gt; <code>/usr/bin/python3.11</code>) and <code>VIRTUAL_ENV=~/.local/</code>:</p>
<p>With <code>uv==0.1.11</code>, <code>uv pip install</code> installs to <code>~/.local/lib/python3.11/site-packages</code>. This makes sense.</p>
<p>With <code>uv==0.1.12</code>, <code>uv pip install</code> attempts to install to <code>/usr/local/lib/python3.11/dist-packages</code> (and fails because of insufficient permissions). I would expect this to still attempt to install to <code>~/.local</code>, since that was declared as the virtual environment.</p>
<p>I believe #2353, #2059, #1584, #1526 are related (e.g. the <code>--user</code> flag would at least resolve this issue), but it seems like this may be a separate problem with the order of resolution of possible installation locations; that is, I'd expect <code>uv</code> to attempt to install to a virtual environment if one is declared, even if the virtual environment eventually resolves to a system(ish) Python installation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-12 19:53</div>
            <div class="timeline-body"><p>I'm not sure on this one... I think it'd be error-prone to treat <code>~/.local/bin/python</code> as a virtual environment just because it's set as <code>VIRTUAL_ENV</code>. There's just no guarantee at all (AFAICT?) that <code>~/.local/lib/python3.11/site-packages</code> would actually be on <code>sys.path</code> at runtime. So we'd end up installing packages that aren't available to the user.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-12 19:53</div>
            <div class="timeline-body"><p>A virtual environment has a more &quot;formal&quot; definition (AFAIK), which is, a Python interpreter in which <code>sys.prefix</code> and <code>sys.base_prefix</code> are not equivalent.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-12 19:54</div>
            <div class="timeline-body"><p>I think this is reasonably solved by creating a real virtual environment, or using <code>--user</code> once it's supported, but I don't think it's tenable to make assumptions about the paths based on <code>VIRTUAL_ENV</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/adebrecht661">@adebrecht661</a> on 2024-03-12 20:54</div>
            <div class="timeline-body"><blockquote>
<p>There's just no guarantee at all (AFAICT?) that <code>~/.local/lib/python3.11/site-packages</code> would actually be on sys.path at runtime.</p>
</blockquote>
<p>Digging through the docs, I believe this is guaranteed for &quot;UNIX and non-framework MacOS builds&quot; (under the condition that <code>ENABLE_USER_SITE</code> is true), but not because of anything that could be relied upon in the case of a more general <code>VIRTUAL_ENV</code> path. Specifically, this relies on the fact that the user <code>site-packages</code> will be added to <code>sys.path</code> if it exists. But if, for example, <code>VIRTUAL_ENV=~/.foo</code> instead, <code>~/.foo/lib/python3.11/site-packages</code> would not be on the path.</p>
<p>I agree this is solved by <code>--user</code>, so this can be closed in favor of that issue.</p>
<p>I will say that while I understand wanting to push users away from modifying the <em>system</em> Python, there are a lot of ways to install Python that are global but not the system Python, and passing both <code>--user</code> and <code>--system</code> in the command to get <code>pip</code>'s default behavior seems... counterintuitive. I'm not sure if there's a straightforward resolution to this, though there is already also <code>--break-system-packages</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-26 01:02</div>
            <div class="timeline-body"><p>I think this would work now with <code>--prefix ~/.local</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-06-26 01:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:25 UTC
    </footer>
</body>
</html>
