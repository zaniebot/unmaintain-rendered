```yaml
number: 12744
title: Wrong dependency built from correct git hash
type: issue
state: open
author: robtovey
labels:
  - bug
assignees: []
created_at: 2025-04-08T14:12:58Z
updated_at: 2025-04-08T14:34:35Z
url: https://github.com/astral-sh/uv/issues/12744
synced_at: 2026-01-10T01:57:29Z
```

# Wrong dependency built from correct git hash

---

_Issue opened by @robtovey on 2025-04-08 14:12_

### Summary

I have just tried to update a specific dependency from git and I'm getting really weird resolving behaviour.

The update was on a public repository, the change is [here](https://github.com/ElmerCSC/elmer_circuitbuilder/commit/a32eee95ccec3887b099bb718576ddecfb79ebed)
Importantly note that the docstring at the top has changed from `Rmat_str : numpy.chararray` to `Rmat_str : numpy.ndarray of 'bytes' strings`.

I now mainly get the old (wrong) version on my laptop:
```bash
uv run --with numpy --with https://github.com/ElmerCSC/elmer_circuitbuilder.git --no-project --isolated --upgrade --no-cache python -c "import elmer_circuitbuilder; print(elmer_circuitbuilder.get_incidence_matrix_str.__doc__)" | grep Amat
```
prints the `numpy.chararray` version.

```bash
uv run --with numpy==2.1.3 --with https://github.com/ElmerCSC/elmer_circuitbuilder.git --no-project --isolated --upgrade --no-cache python -c "import elmer_circuitbuilder; print(elmer_circuitbuilder.get_incidence_matrix_str.__doc__)" | grep Amat
```
prints the correct `ndarray of 'bytes'` message!


Some additional context to this:
- originally the dependency was bound to main (like above) in a pyproject.toml
- I later tried to pin it to `rev = "a32eee95ccec3887b099bb718576ddecfb79ebed"`, which is the current main, in my pyproject.toml, but calling `uv sync` has never updated to the new version of the package.
- if I look in the `.lock` file, then it points to the correct `a32eee` hash
- if I call `uv sync -P elmer-circuitbuilder -vv`, then every reference points at the same correct `a32eee` hash

I haven't managed to find anything which looks wrong to me, I'm happy to run some additional commands if that helps you identify the problem.

In fact, a colleague has just pointed out to me that the message is not deterministic! If I run the first command repeatedly then I get the correct version 1 out of 4 times!

I have attached the output of:
```bash 
uv run --with numpy --with https://github.com/ElmerCSC/elmer_circuitbuilder.git --no-project --isolated --upgrade --no-cache -vv python -c "import elmer_circuitbuilder; print(elmer_circuitbuilder.get_incidence_matrix_str.__doc__)" &> verbose.txt
```
when it has resolved wrongly
[verbose.txt](https://github.com/user-attachments/files/19650642/tmp.txt)

### Platform

Linux 5.15.167.4-microsoft-standard-WSL2 x86_64 GNU/Linux

### Version

uv 0.6.12

### Python version

Python 3.13.2

---

_Label `bug` added by @robtovey on 2025-04-08 14:12_

---

_Comment by @tpgillam on 2025-04-08 14:29_

> In fact, a colleague has just pointed out to me that the message is not deterministic! If I run the first command repeatedly then I get the correct version 1 out of 4 times!

A little bit more on this..

We've discovered some strangeness in the `elmer-circuitbuilder` repository. Specifically, in the latest commit, the main library file exists twice:

- Correctly: https://github.com/ElmerCSC/elmer_circuitbuilder/blob/a32eee95ccec3887b099bb718576ddecfb79ebed/elmer_circuitbuilder/elmer_circuitbuilder.py
- An old version that seems to be the by-product of an old build: https://github.com/ElmerCSC/elmer_circuitbuilder/blob/a32eee95ccec3887b099bb718576ddecfb79ebed/build/lib/elmer_circuitbuilder.py

Naturally the library needs fixing, but we are slightly surprised that uv (*) seems to switch between these two versions non-deterministically. 

It took about an hour of debugging for us to figure this out, so if there's any scope for uv to moan loudly in situations like this, that could be helpful for others in the future!


(*) although possibly this isn't uv, but rather what setuptools would do in the presence of a dirty build directory..?

---

_Comment by @robtovey on 2025-04-08 14:34_

It looks like I should have looked into the specific dependency a bit more first...
I am assuming that such an edge-case will not appear very often!
Feel free to close this issue whenever you consider it solved from the uv side

---

_Referenced in [ElmerCSC/elmer_circuitbuilder#12](../../ElmerCSC/elmer_circuitbuilder/issues/12.md) on 2025-04-08 15:40_

---
