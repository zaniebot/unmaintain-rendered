<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command to update metadata in PEP 723 script from project - astral-sh/uv #12529</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Command to update metadata in PEP 723 script from project</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/12529">#12529</a>
        opened by <a href="https://github.com/dbohdan">@dbohdan</a>
        on 2025-03-28 13:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dbohdan">@dbohdan</a> on 2025-03-28 13:10</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Python scripts with inline script metadata are incredibly convenient to use but not so convenient to develop because Python tooling expects a project. My preferred solution to this problem has been to develop PEP 723 scripts as regular Python projects that have <code>pyproject.toml</code>. This lets you use your normal tooling like Ruff, Pyright, and Poe like in any other project. You get a place to specify Ruff ignore rules and development dependencies like type stubs.</p>
<p>A drawback of this approach is <em>duplicated dependencies</em>: you must have the dependencies in both the PEP 723 script itself and <code>pyproject.toml</code>. It is better to have a single source of truth. uv could help by implementing a command to copy the list of dependencies and the required Python version from <code>pyproject.toml</code> to the script. What I mean is, when you ran <code>uv foo script.py</code>, <code>project.dependencies</code> and <code>project.requires-python</code> from <code>pyproject.toml</code> would be copied to the metadata comment block in <code>script.py</code>.</p>
<p>There are other potential solutions to create a workflow for PEP 723 scripts that enables tooling and development dependencies. One would be for uv to directly use the dependencies and Python version from a script's metadata with development dependencies from <code>pyproject.toml</code>. Such a solution seems more complex and more potentially surprising to the user.</p>
<h3>Example</h3>
<p>I migrated a project from <a href="https://github.com/linkedin/shiv">shiv</a> to PEP 723 recently and wrote some code to experiment with this. It creates a separate <code>bundle.py</code>, but with a little more effort it could replace the inline metadata in the source.</p>
<pre><code class="language-python">#! /usr/bin/env python3
# License: https://dbohdan.mit-license.org/@2025/license.txt

import re
import tomllib
from pathlib import Path
from string import Template

import tomli_w

DEPENDENCIES = &quot;dependencies&quot;
PROJECT = &quot;project&quot;
REQUIRES_PYTHON = &quot;requires-python&quot;

DST = Path(&quot;bundle.py&quot;)
PYPROJECT = Path(&quot;pyproject.toml&quot;)
SRC = Path(&quot;main.py&quot;)

BUNDLE = Template(
    &quot;&quot;&quot;
#! /usr/bin/env -S uv run --quiet --script
# /// script
$toml
# ///

$code
&quot;&quot;&quot;.strip()
)


def main() -&gt; None:
    with PYPROJECT.open(&quot;rb&quot;) as f:
        pyproject = tomllib.load(f)

    toml = tomli_w.dumps(
        {
            DEPENDENCIES: pyproject[PROJECT][DEPENDENCIES],
            REQUIRES_PYTHON: pyproject[PROJECT][REQUIRES_PYTHON],
        },
        indent=2,
    )

    code = SRC.read_text()
    code = re.sub(r&quot;^#![^\n]+\n&quot;, &quot;&quot;, code)

    bundle = BUNDLE.substitute(
        toml=&quot;\n&quot;.join(f&quot;# {line}&quot; for line in toml.splitlines()),
        code=code,
    )

    DST.write_text(bundle)


if __name__ == &quot;__main__&quot;:
    main()
</code></pre>
<h3>See also</h3>
<p>An <a href="https://news.ycombinator.com/item?id=43500124#43500814">HN discussion</a> today prompted me to open this issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @dbohdan on 2025-03-28 13:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-04-01 19:42</div>
            <div class="timeline-body"><p>I think the solution here is rather to add PEP 723 script support to editors, LSPs, and other tools.</p>
<p>It's a fun idea, but I don't think we'll invest in duplicating dependencies across <code>pyproject.toml</code> and scripts.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wish</span> added by @zanieb on 2025-04-01 19:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dbohdan">@dbohdan</a> on 2025-04-01 20:50</div>
            <div class="timeline-body"><p>Fair enough. There is a reasonable argument that this can only be a stopgap measure. If PEP 723 scripts are widely adopted, this feature will become unnecessary because tools will directly support PEP 723; if PEP 723 isn't widely adopted, maintaining this feature might not be worth the effort.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:26 UTC
    </footer>
</body>
</html>
