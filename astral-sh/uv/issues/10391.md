```yaml
number: 10391
title: Excluding a file from non-editable installs with uv sync --no-editable
type: issue
state: closed
author: mjpieters
labels:
  - external
assignees: []
created_at: 2025-01-08T12:56:18Z
updated_at: 2025-01-30T00:28:20Z
url: https://github.com/astral-sh/uv/issues/10391
synced_at: 2026-01-10T01:57:24Z
```

# Excluding a file from non-editable installs with uv sync --no-editable

---

_Issue opened by @mjpieters on 2025-01-08 12:56_

I have a packaged app project with a docker image, built with `uv`:

```Dockerfile
RUN --mount=from=ghcr.io/astral-sh/uv:0.5.14@sha256:f0786ad49e2e684c18d38697facb229f538a6f5e374c56f54125aabe7d14b3f7,source=/uv,target=/bin/uv \
    --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,source=uv.lock,target=uv.lock \
    --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
    --mount=type=bind,source=src/,target=src/ \
    uv sync --no-group dev --no-editable
```

The project uses hatch as the build backend, and excludes a single file that is only used during development (a third-party tool needs to be able to import it)

```toml
[build-system]
requires = ["hatchling==1.27.0"]
build-backend = "hatchling.build"

[tool.hatch.build.targets.sdist]
exclude = [
    "src/project_name/_dev_support_plugin.py",
]
```

When I run `uv build` and inspect the sdist and wheel, the plugin file is not packaged, as intended:

```sh
% rm -rf dist/
% uv build
# ...
% tar tzvf dist/*.tar.gz | grep plugin 
# no output
% zipinfo dist/*.whl | grep plugin
# no output
```

However, the docker image does include the file, the `.venv/lib/python3.13/site-packages/project_name/_dev_support_plugin.py` exists and is importable.

I expected that uv would have used the build backend to create the source distribution for such installs, but that's apparently not the case.

To simplify and debug, I next used `uv sync` locally to verify this isn't specific to docker:

```sh
% uv sync --no-group dev --no-editable
...
% ls .venv/lib/python3.13/site-packages/project_name/ | grep plugin
_dev_support_plugin.py
```

I then also tried to run the above with `--reinstall` and `--no-cache` with the same results. I also tried excluding the file by adding a `[tool.hatch.build.targets.wheel]` section with the same `exclude` configuration, but this makes no difference either.

Is there any way I can exclude files from being installed when using `--no-editable` or should I relocate the plugin to some other place and add that to the import path for the 3rd-party tool to import?

---

_Comment by @charliermarsh on 2025-01-08 14:36_

We do use the same build frontend to build the distribution for such installs, so I would expect the file to be excluded there too. Can you provide a full reproduction, like a Git repo that I can clone and run? It's a fairly bespoke setup so it's a lot of work for me to reproduce it myself.

---

_Label `needs-mre` added by @charliermarsh on 2025-01-08 14:36_

---

_Comment by @mjpieters on 2025-01-08 16:33_

> We do use the same build frontend to build the distribution for such installs, so I would expect the file to be excluded there too. Can you provide a full reproduction, like a Git repo that I can clone and run? It's a fairly bespoke setup so it's a lot of work for me to reproduce it myself.

It's an open source project but I haven't committed the work for this yet (I'm dithering on a GraphQL dev pipeline, the plugin is for a code generator): https://github.com/mjpieters/pyright-analysis-action. So, not yet?

But, I found it easy enough to create a stand-alone test for this; here is the reproducer, with bash functions to do test the issue:

```sh
mkdir /tmp/reproducer
cd /tmp/reproducer
uv init --vcs none --python 3.13 --package --name reproducer
>>pyproject.toml cat << EOF

[tool.hatch.build.targets.sdist]
exclude = [
    "src/reproducer/dontinclude.py",
]
EOF
touch src/reproducer/dontinclude.py
function test_dists {
    rm -rf dist/; uv build
    if tar tzvf dist/reproducer-0.1.0.tar.gz| grep -q dontinclude; then echo -e '\033[1;31mFAILED\033[0m'; return; fi
    if zipinfo dist/reproducer-0.1.0-py3-none-any.whl| grep -q dontinclude; then echo -e '\033[1;31mFAILED\033[0m'; return; fi
    echo -e '\033[1;32mSUCCESS\033[0m'
}
function test_uv_sync {
    rm -rf .venv
    uv sync --no-editable --no-cache
    if [ -f .venv/lib/python3.13/site-packages/reproducer/dontinclude.py ]; then echo -e '\033[1;31mFAILED\033[0m'; return; fi
    echo -e '\033[1;32mSUCCESS\033[0m'
}
```

You can then verify that `dontinclude.py` is not part of the sdist or wheel artefacts by invoking the `test_dists` function:

```sh
% test_dists
Building source distribution...
Building wheel from source distribution...
Successfully built dist/reproducer-0.1.0.tar.gz
Successfully built dist/reproducer-0.1.0-py3-none-any.whl
SUCCESS
```

and finally, verify that `uv sync --no-editable` _does_ include the file with the `test_uv_sync` function:

```sh
% test_uv_sync
Creating virtual environment at: .venv
Resolved 1 package in 4ms
   Built reproducer @ file:///private/tmp/reproducer
Prepared 1 package in 706ms
Installed 1 package in 2ms
 + reproducer==0.1.0 (from file:///private/tmp/reproducer)
FAILED
```

And, as this probably matters, here's my current uv version, OS version and platform architecture:

```
% uv --version
uv 0.5.15 (Homebrew 2025-01-07)
% sw_vers
ProductName:		macOS
ProductVersion:		14.7.2
BuildVersion:		23H311
% arch
arm64
```

---

_Comment by @mjpieters on 2025-01-08 16:57_

I note that the same issue also applies to `uv run --with .`, as shown by the following test command run in the same `/tmp/reproducer` directory:

```sh
% uv run --with . python -c 'import reproducer, os; print("\x1b[1;31mFAILED\x1b[0m" if "dontinclude.py" in os.listdir(os.path.dirname(reproducer.__file__)) else "\x1b[1;32mSUCCESS\x1b[0m")'
FAILED
```

---

_Comment by @mjpieters on 2025-01-12 21:31_

@charliermarsh is there anything else needed to move this forward?

---

_Comment by @charliermarsh on 2025-01-12 21:32_

No, sorry, I just need to find time to prioritize it. I will test it when I can!

---

_Assigned to @charliermarsh by @charliermarsh on 2025-01-13 03:01_

---

_Comment by @charliermarsh on 2025-01-13 17:20_

Great, thanks, I reproduced with the above.

---

_Comment by @charliermarsh on 2025-01-13 17:27_

I think this might be a hatchling issue? This also fails:

```
function test_dists {
    rm -rf dist/; uv build --wheel
    if zipinfo dist/reproducer-0.1.0-py3-none-any.whl| grep -q dontinclude; then echo -e '\033[1;31mFAILED\033[0m'; return; fi
    echo -e '\033[1;32mSUCCESS\033[0m'
}
```

So it's something about building the wheel directly (which we do in `uv sync`), as opposed to building an sdist, then building the wheel from the sdist (as in `uv build`).

---

_Comment by @charliermarsh on 2025-01-13 17:28_

It also fails with `python -m build` which is effectively the "canonical" implementation, so I think this is a problem for the build backend -- sorry!

```
function test_dists {
    rm -rf dist/; python -m build --wheel
    if zipinfo dist/reproducer-0.1.0-py3-none-any.whl| grep -q dontinclude; then echo -e '\033[1;31mFAILED\033[0m'; return; fi
    echo -e '\033[1;32mSUCCESS\033[0m'
}
```

---

_Label `needs-mre` removed by @charliermarsh on 2025-01-13 17:28_

---

_Label `upstream` added by @charliermarsh on 2025-01-13 17:28_

---

_Comment by @zanieb on 2025-01-13 18:25_

cc @ofek 

---

_Comment by @ofek on 2025-01-13 20:47_

> So it's something about building the wheel directly (which we do in `uv sync`), as opposed to building an sdist, then building the wheel from the sdist (as in `uv build`).

> [tool.hatch.build.targets.sdist]
> exclude = [
>     "src/project_name/_dev_support_plugin.py",
> ]

This seems like there is no bug. Configuration dictates that source distributions ignore that file and so if you build a wheel from that then it also will be excluded, however building the wheel directly would include the file.

---

_Comment by @mjpieters on 2025-01-14 08:26_

Right, so it was `uv build` that tripped me up here; since the result of `uv build`  was a wheel with that file omitted I made the assumption that hatchling was responsible for this behaviour.

That said, uv is then being inconsistent about how it builds the project. Either treat the sdist as the source for wheels everywhere *or* always build the wheel directly. The latter would be preferred, to be honest. If uv also has an option to sanity check builds (a la `twine check`) that then verifies that building a wheel from the sdist results in the same output as building a wheel directly then that’s great too.

For an example why the current `uv build` behaviour is unhelpful: I thought I had tried configuring excluding the file from the wheel build but if I *only* set wheel build exclusions then the file would have still been present in the wheel built from the sdist output and so I’d have assumed I misunderstood something about hatch. It certainly had not occurred to me that `uv build` is, in essence, ignoring the project configuration on how to build a wheel.

---

_Comment by @charliermarsh on 2025-01-14 15:51_

@mjpieters -- I think this is working as intended, and it matches `pypa/build`. `uv build` by default builds the source distribution from source, then the wheel from the source distribution. `uv build --wheel` builds the wheel directly from source. (And `uv build --sdist` builds _just_ the source distribution.) This is all documented. It's just a question of what the _default_ is, and I think our choice is correct (and, as I said, matches `pypa/build`).

---

_Comment by @mjpieters on 2025-01-29 16:15_

Okidoki, so it is surprising-behaviour-compatible with `pypa/build`!

> This is all documented

See, I _try_ to read all documentation, but.. you know.. :-)

Right, I'll close this issue then.

---

_Closed by @mjpieters on 2025-01-29 16:15_

---

_Comment by @charliermarsh on 2025-01-29 16:18_

It's okay, I know it's complicated and a lot to sift through.

---

_Comment by @micolous on 2025-01-30 00:26_

This issue can also manifest when *including* a file (from a parent directory) with `force-include`: it only gets collected correctly when building a `wheel` from `sdist`, not `uv sync`.

https://github.com/pypa/hatch/issues/1230#issuecomment-1922254244 seems to suggest that this is a product of Hatch's behaviour.

---

_Referenced in [astral-sh/uv#11557](../../astral-sh/uv/issues/11557.md) on 2025-02-16 16:52_

---
