<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Accelerator torch setup and unexpected uv run behaviour - astral-sh/uv #12290</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Multi-Accelerator torch setup and unexpected uv run behaviour</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/12290">#12290</a>
        opened by <a href="https://github.com/relativityhd">@relativityhd</a>
        on 2025-03-18 16:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/relativityhd">@relativityhd</a> on 2025-03-18 16:36</div>
            <div class="timeline-body"><h3>Question</h3>
<p>Hi all,</p>
<p>I am wondering whether my problem is expected behavior or not. I also already found a workaround.</p>
<h2>Problem</h2>
<p>In one of my larger projects, I stumbled upon this weird behavior. This project uses PyTorch and some other packages depending on PyTorch. I set up uv following the PyTorch Integration guide from the uv documentation (via extras). When I run <code>uv sync --extra cpu</code> followed by <code>uv run ...</code> uv starts installing some <code>nvidia-</code> packages which should only be installed for non-cpu pytorch versions. If I run however, <code>uv run --extra cpu ...</code> everything is fine. I was able to reproduce the problem on a new project:</p>
<p>The pyproject looks like this:</p>
<pre><code class="language-toml">[project]
name = &quot;reproduce-torch&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.13&quot;
dependencies = [&quot;numpy&gt;=2.2.4&quot;, &quot;efficientnet-pytorch&gt;=0.7.1&quot;]

[project.optional-dependencies]
cpu = [&quot;torch&gt;=2.2.0&quot;]
cuda = [&quot;torch&gt;=2.2.0&quot;]

[tool.uv]
conflicts = [[{ extra = &quot;cpu&quot; }, { extra = &quot;cuda&quot; }]]

[tool.uv.sources]
torch = [
    { index = &quot;pytorch-cpu&quot;, extra = &quot;cpu&quot; },
    { index = &quot;pytorch-cuda&quot;, extra = &quot;cuda&quot; },
]


[[tool.uv.index]]
name = &quot;pytorch-cpu&quot;
url = &quot;https://download.pytorch.org/whl/cpu&quot;
explicit = true

[[tool.uv.index]]
name = &quot;pytorch-cuda&quot;
url = &quot;https://download.pytorch.org/whl/cu126&quot;
explicit = true
</code></pre>
<p>Now locking and syncing with <code>uv sync --extras cpu</code> installs everything as expected (no <code>nvidia-...</code> packages):</p>
<pre><code class="language-sh">$ uv sync --extra cpu
Using CPython 3.13.2
Creating virtual environment at: .venv
Resolved 30 packages in 2ms
Installed 12 packages in 331ms
 + efficientnet-pytorch==0.7.1
 + filelock==3.18.0
 + fsspec==2025.3.0
 + jinja2==3.1.6
 + markupsafe==3.0.2
 + mpmath==1.3.0
 + networkx==3.4.2
 + numpy==2.2.4
 + setuptools==76.1.0
 + sympy==1.13.1
 + torch==2.6.0+cpu
 + typing-extensions==4.12.2
</code></pre>
<p>A look on <code>uv tree</code> shows that <code>efficientnet-pytorch</code> depends on <code>torch</code>:</p>
<pre><code class="language-sh">$ uv tree
reproduce-torch v0.1.0
â”œâ”€â”€ efficientnet-pytorch v0.7.1
â”‚   â””â”€â”€ torch v2.6.0
â”‚       â”œâ”€â”€ filelock v3.18.0
â”‚       â”œâ”€â”€ fsspec v2025.3.0
â”‚       â”œâ”€â”€ jinja2 v3.1.6
â”‚       â”‚   â””â”€â”€ markupsafe v3.0.2
â”‚       â”œâ”€â”€ networkx v3.4.2
â”‚       â”œâ”€â”€ nvidia-cublas-cu12 v12.4.5.8
â”‚       â”œâ”€â”€ nvidia-cuda-cupti-cu12 v12.4.127
â”‚       â”œâ”€â”€ nvidia-cuda-nvrtc-cu12 v12.4.127
â”‚       â”œâ”€â”€ nvidia-cuda-runtime-cu12 v12.4.127
â”‚       â”œâ”€â”€ nvidia-cudnn-cu12 v9.1.0.70
â”‚       â”‚   â””â”€â”€ nvidia-cublas-cu12 v12.4.5.8
â”‚       â”œâ”€â”€ nvidia-cufft-cu12 v11.2.1.3
â”‚       â”‚   â””â”€â”€ nvidia-nvjitlink-cu12 v12.4.127
â”‚       â”œâ”€â”€ nvidia-curand-cu12 v10.3.5.147
â”‚       â”œâ”€â”€ nvidia-cusolver-cu12 v11.6.1.9
â”‚       â”‚   â”œâ”€â”€ nvidia-cublas-cu12 v12.4.5.8
â”‚       â”‚   â”œâ”€â”€ nvidia-cusparse-cu12 v12.3.1.170
â”‚       â”‚   â”‚   â””â”€â”€ nvidia-nvjitlink-cu12 v12.4.127
â”‚       â”‚   â””â”€â”€ nvidia-nvjitlink-cu12 v12.4.127
â”‚       â”œâ”€â”€ nvidia-cusparse-cu12 v12.3.1.170 (*)
â”‚       â”œâ”€â”€ nvidia-cusparselt-cu12 v0.6.2
â”‚       â”œâ”€â”€ nvidia-nccl-cu12 v2.21.5
â”‚       â”œâ”€â”€ nvidia-nvjitlink-cu12 v12.4.127
â”‚       â”œâ”€â”€ nvidia-nvtx-cu12 v12.4.127
â”‚       â”œâ”€â”€ setuptools v76.1.0
â”‚       â”œâ”€â”€ sympy v1.13.1
â”‚       â”‚   â””â”€â”€ mpmath v1.3.0
â”‚       â”œâ”€â”€ triton v3.2.0
â”‚       â””â”€â”€ typing-extensions v4.12.2
â”œâ”€â”€ numpy v2.2.4
â””â”€â”€ torch v2.6.0+cu126 (extra: cuda)
(*) Package tree already displayed
</code></pre>
<p>Note that <code>torch v2.6.0+cpu (extra: cpu)</code> is missing, despite installed.</p>
<p>Now running <code>uv run python</code> starts downloading and installing the nvidia packages, this may take a few minutes since they are quite large:</p>
<pre><code class="language-sh"># Output while installing
$ uv run python
â § Preparing packages... (0/9)
nvidia-cuda-nvrtc-cu12 ------------------------------ 955.00 KiB/22.58 MiB
nvidia-nvjitlink-cu12 ------------------------------ 1.11 MiB/37.44 MiB
nvidia-curand-cu12 ------------------------------ 953.81 KiB/53.85 MiB
nvidia-cufft-cu12 ------------------------------ 996.71 KiB/116.00 MiB
nvidia-cusolver-cu12 ------------------------------ 952.56 KiB/118.41 MiB
nvidia-nccl-cu12 ------------------------------ 980.81 KiB/158.30 MiB
nvidia-cusparse-cu12 ------------------------------ 979.56 KiB/186.88 MiB
nvidia-cublas-cu12 ------------------------------ 1012.81 KiB/391.57 MiB
nvidia-cudnn-cu12 ------------------------------ 979.03 KiB/697.83 MiB    
</code></pre>
<pre><code class="language-sh"># Output after installing
$ uv run python
Installed 14 packages in 32ms
Python 3.13.2 (main, Feb  5 2025, 19:11:32) [Clang 19.1.6 ] on linux
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; 
</code></pre>
<p>Syncing again with <code>uv sync --extra cpu</code> will uninstall the unwanted packages:</p>
<pre><code class="language-sh">uv sync --extra cpu
Resolved 30 packages in 1ms
Uninstalled 14 packages in 26ms
 - nvidia-cublas-cu12==12.4.5.8
 - nvidia-cuda-cupti-cu12==12.4.127
 - nvidia-cuda-nvrtc-cu12==12.4.127
 - nvidia-cuda-runtime-cu12==12.4.127
 - nvidia-cudnn-cu12==9.1.0.70
 - nvidia-cufft-cu12==11.2.1.3
 - nvidia-curand-cu12==10.3.5.147
 - nvidia-cusolver-cu12==11.6.1.9
 - nvidia-cusparse-cu12==12.3.1.170
 - nvidia-cusparselt-cu12==0.6.2
 - nvidia-nccl-cu12==2.21.5
 - nvidia-nvjitlink-cu12==12.4.127
 - nvidia-nvtx-cu12==12.4.127
 - triton==3.2.0
</code></pre>
<p>Running <code>uv run</code> with the cpu extra would run without installing the unwanted packages:</p>
<pre><code class="language-sh">$ uv run --extra cpu python
Python 3.13.2 (main, Feb  5 2025, 19:11:32) [Clang 19.1.6 ] on linux
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; 
</code></pre>
<h2>Workaround</h2>
<p>Putting the pytorch-dependend package <code>efficientnet-pytorch</code> into the <code>[project.optional-dependencies]</code> section along <code>torch</code> solves the problem:</p>
<pre><code class="language-toml">...
dependencies = [&quot;numpy&gt;=2.2.4&quot;]

[project.optional-dependencies]
cpu = [&quot;torch&gt;=2.2.0&quot;, &quot;efficientnet-pytorch&gt;=0.7.1&quot;]
cuda = [&quot;torch&gt;=2.2.0&quot;, &quot;efficientnet-pytorch&gt;=0.7.1&quot;]
...
</code></pre>
<h2>Final thoughts</h2>
<p>I am not sure whether this behavior is intended by uv. The workaround works but can be tedious for larger projects which support more than two torch-versions (e.g. we try to support systems with <code>cuda 11.8</code>, <code>cuda 12.1</code>, <code>cuda 12.4</code>, <code>cuda 12.6</code> and <code>cpu</code>) and / or many torch-dependent packages.</p>
<p>Also, I find it a little unintuitive that <code>uv run</code> does not always automatically apply previous synced extras.</p>
<p>I am happy about all thoughts, pot. better approaches and other input. ðŸ˜„</p>
<p>P.S. if anyone has a better title for this issue which is easier for other to find I am happy for ideas.</p>
<h3>Platform</h3>
<p>Linux 5.15.167.4-microsoft-standard-WSL2 x86_64 GNU/Linux</p>
<h3>Version</h3>
<p>uv 0.6.7</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @relativityhd on 2025-03-18 16:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/johnpyp">@johnpyp</a> on 2025-03-24 02:47</div>
            <div class="timeline-body"><p>Also running into this. As far as I can tell, there's no way for a user to &quot;customize&quot; their UV environment external from the source-controlled <code>uv.toml</code> file at all.</p>
<p>Making it worse, the user can't &quot;incrementally override&quot; the <code>[tool.uv.sources]</code> configuration in a source-uncontrolled <code>uv.toml</code> (see https://github.com/astral-sh/uv/issues/6772#issue-2492799415), so they can't workaround it either.</p>
<p>Some kind of persisted, non source controlled preference for the <code>extras</code> setting would be very helpful (an environment variable combined with something like Mise's environments could also work</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/johnpyp">@johnpyp</a> on 2025-03-24 02:50</div>
            <div class="timeline-body"><p>What I'm doing for now as a (unsatisfying) workaround is using <a href="https://mise.jdx.dev/environments/#environments">mise environments</a> combined with the <code>UV_NO_SYNC=true</code> environment variable.</p>
<p>In reality, I <em>do</em> want uv to do the sync before each run command, just with my saved preferences... but this is a decent approximation for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-04-01 18:14</div>
            <div class="timeline-body"><p>@relativityhd regarding this part</p>
<blockquote>
<p>I find it a little unintuitive that uv run does not always automatically apply previous synced extras.</p>
</blockquote>
<p>You can do <code>uv run --no-sync</code> to avoid performing a sync (as noted by @johnpyp)</p>
<p>@johnpyp</p>
<blockquote>
<p>Some kind of persisted, non source controlled preference for the extras setting would be very helpful (an environment variable combined with something like Mise's environments could also work</p>
</blockquote>
<p>We're considering something like this. I think there's a fair amount of design work to be done though, as it introduces more abstractions and complexity.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/relativityhd">@relativityhd</a> on 2025-10-30 08:27</div>
            <div class="timeline-body"><p>I close this in hope that the <a href="https://astral.sh/blog/wheel-variants">push in development of WheelNext</a> will resolve this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @relativityhd on 2025-10-30 08:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:03 UTC
    </footer>
</body>
</html>
