<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal mode duplicates requirements lines - astral-sh/uv #4885</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Universal mode duplicates requirements lines</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/4885">#4885</a>
        opened by <a href="https://github.com/A5rocks">@A5rocks</a>
        on 2024-07-08 02:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/A5rocks">@A5rocks</a> on 2024-07-08 02:00</div>
            <div class="timeline-body"><p>I just noticed the <code>--universal</code> flag and it looks like just what we need with <code>trio</code>! However, <a href="https://github.com/python-trio/trio/pull/3032">when we try this out</a> (though it's not shown in that PR), we run into an issue where requirement lines are duplicated.</p>
<p>Here's a reproducer, I can't explain this well. <code>x.in</code>:</p>
<pre><code>pylint
sphinx
</code></pre>
<p>And here's what is spit out in my terminal when I run <code>uv pip compile --universal --python-version=3.8 x.in</code>:</p>
<pre><code>Resolved 42 packages in 40ms
# This file was autogenerated by uv via the following command:
#    uv pip compile --universal --python-version=3.8 x.in
alabaster==0.7.16
    # via sphinx
alabaster==0.7.13
    # via sphinx
astroid==3.2.2
    # via pylint
babel==2.15.0
    # via sphinx
certifi==2024.7.4
    # via requests
charset-normalizer==3.3.2
    # via requests
colorama==0.4.6 ; sys_platform == 'win32'
    # via
    #   pylint
    #   sphinx
dill==0.3.8
    # via pylint
docutils==0.20.1
    # via sphinx
docutils==0.21.2
    # via sphinx
idna==3.7
    # via requests
imagesize==1.4.1
    # via sphinx
importlib-metadata==8.0.0 ; python_version &lt; '3.10'
    # via sphinx
isort==5.13.2
    # via pylint
jinja2==3.1.4
    # via sphinx
markupsafe==2.1.5
    # via jinja2
mccabe==0.7.0
    # via pylint
packaging==24.1
    # via sphinx
platformdirs==4.2.2
    # via pylint
pygments==2.18.0
    # via sphinx
pylint==3.2.5
    # via -r x.in
pytz==2024.1 ; python_version &lt; '3.9'
    # via babel
requests==2.32.3
    # via sphinx
snowballstemmer==2.2.0
    # via sphinx
sphinx==7.3.7
    # via -r x.in
sphinx==7.1.2
    # via -r x.in
sphinxcontrib-applehelp==1.0.8
    # via sphinx
sphinxcontrib-applehelp==1.0.4
    # via sphinx
sphinxcontrib-devhelp==1.0.6
    # via sphinx
sphinxcontrib-devhelp==1.0.2
    # via sphinx
sphinxcontrib-htmlhelp==2.0.5
    # via sphinx
sphinxcontrib-htmlhelp==2.0.1
    # via sphinx
sphinxcontrib-jsmath==1.0.1
    # via sphinx
sphinxcontrib-qthelp==1.0.7
    # via sphinx
sphinxcontrib-qthelp==1.0.3
    # via sphinx
sphinxcontrib-serializinghtml==1.1.10
    # via sphinx
sphinxcontrib-serializinghtml==1.1.5
    # via sphinx
tomli==2.0.1 ; python_version &lt; '3.11'
    # via pylint
tomlkit==0.12.5
    # via pylint
typing-extensions==4.12.2 ; python_version &lt; '3.11'
    # via
    #   astroid
    #   pylint
urllib3==2.2.2
    # via requests
zipp==3.19.2 ; python_version &lt; '3.10'
    # via importlib-metadata
</code></pre>
<p>See how the <code>sphinx</code> lines are duplcated! Note that essentially everything above (<code>x.in</code>, command run) is minimized.</p>
<p>~~I'd love to poke at <code>uv</code>'s internals a bit and maybe fix this!~~ nevermind, I don't think I'm able to given some investigation, as I think this requires a larger change.</p>
<p>Platform information:</p>
<pre><code class="language-sh">$ uv --version
uv 0.2.22
$ python --version
Python 3.12.2
$ python -m platform
Linux-6.1.0-21-amd64-x86_64-with-glibc2.36
</code></pre>
<p>I'm running Debian Linux but I also reproduced on Windows.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-07-08 02:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">lock</span> added by @zanieb on 2024-07-08 02:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/A5rocks">@A5rocks</a> on 2024-07-08 02:36</div>
            <div class="timeline-body"><p>Ok this doesn't happen in <code>uv==0.2.18</code>. The bad change is bisected to https://github.com/astral-sh/uv/commit/d9f389a58d748f217dfb35d11b63706ce53a5be7 ... which isn't too surprising TBH.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-08 03:29</div>
            <div class="timeline-body"><p>Thank you for bisecting, that's really helpful. cc @charliermarsh</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/A5rocks">@A5rocks</a> on 2024-07-08 03:42</div>
            <div class="timeline-body"><p>Based on some investigation: when <code>uv</code> hits <code>pylint</code>, it forks into <code>&lt;3.11</code> and <code>&gt;=3.11</code> (or something like that). This means it then continues with <code>&gt;=3.8,&lt;3.11</code> and <code>&gt;=3.8,&gt;=3.11</code>: the second simplifies to <code>&gt;=3.11</code>. Then <code>uv</code> processes the <code>sphinx</code> dependency, with <code>&gt;=3.11</code> first it finds <code>sphinx==7.3.7</code> but with <code>&gt;=3.8&lt;3.11</code> it finds <code>sphinx==7.1.2</code> (because <code>sphinx&gt;=7.2.0</code> dropped Python 3.8).</p>
<p>I think what <code>uv</code> should be doing here is adding markers that apply to everything within the forked state. But ATM it's not clear to me how to do that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-08 13:04</div>
            <div class="timeline-body"><p>Yeah there should already be markers on the forked state that get propagated here. I'll take a look!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-07-08 13:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-08 13:25</div>
            <div class="timeline-body"><p>Will prioritize this of course, hopefully fixed today but I have to travel in the afternoon.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-08 14:10</div>
            <div class="timeline-body"><p>I'll probably revert if we don't figure it out today -- better to be strict than wrong.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/A5rocks">@A5rocks</a> on 2024-07-08 14:13</div>
            <div class="timeline-body"><p>Yeah based on my investigation a very trivial fix is to comment out narrowing the forked state's Python version. (Which is essentially reverting any improvements)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @BurntSushi by @BurntSushi on 2024-07-08 16:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2024-07-08 16:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2024-07-08 16:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw-gts">@notatallshaw-gts</a> on 2024-07-11 14:01</div>
            <div class="timeline-body"><p>Is this supposed to be fixed for uv 0.2.24?</p>
<p>I still see it, but in a very complex example, so I wanted to check before trying to create a more minimal reproducer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-11 14:22</div>
            <div class="timeline-body"><p>I believe so — feel free to file an issue. There are some known errors that we’re working on already, it may end up being a dupe but it’s totally fine.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 05:34:20 UTC
    </footer>
</body>
</html>
