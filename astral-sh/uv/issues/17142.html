<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv` couldn't find `ffmpeg` on macOS installed with `Homebrew` when running `demucs` - astral-sh/uv #17142</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>`uv` couldn't find `ffmpeg` on macOS installed with `Homebrew` when running `demucs`</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/17142">#17142</a>
        opened by <a href="https://github.com/setoelkahfi">@setoelkahfi</a>
        on 2025-12-16 12:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/setoelkahfi">@setoelkahfi</a> on 2025-12-16 12:16</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>The title is self-explanatory.</p>
<p>I'm trying to migrate my <code>Python</code> tooling to uv<code>,</code> and managed to do so for two of our background jobs so far. But this one job that needs <code>ffmpeg</code> is failing locally:</p>
<pre><code class="language-bash">➜  musik88-web git:(feature/backend-uv-splitfire-job) ✗ uv run demucs -n=htdemucs_ft -d cpu yt-dlp/output/test.mp3
Selected model is a bag of 4 models. You will see that many progress bars per track.
Separated tracks will be stored in /Users/setoelkahfi/Repositories/splitfire/backend/musik88-web/separated/htdemucs_ft
Separating track yt-dlp/output/test.mp3
100%|██████████████████████████████████████████████████████████████████████████| 23.4/23.4 [00:05&lt;00:00,  4.28seconds/s]
100%|██████████████████████████████████████████████████████████████████████████| 23.4/23.4 [00:04&lt;00:00,  4.75seconds/s]
100%|██████████████████████████████████████████████████████████████████████████| 23.4/23.4 [00:04&lt;00:00,  4.81seconds/s]
100%|██████████████████████████████████████████████████████████████████████████| 23.4/23.4 [00:04&lt;00:00,  4.78seconds/s]
Traceback (most recent call last):
  File &quot;/Users/setoelkahfi/Repositories/splitfire/backend/musik88-web/.venv/bin/demucs&quot;, line 10, in &lt;module&gt;
    sys.exit(main())
             ^^^^^^
  File &quot;/Users/setoelkahfi/Repositories/splitfire/backend/musik88-web/.venv/lib/python3.12/site-packages/demucs/separate.py&quot;, line 199, in main
    save_audio(source, str(stem), **kwargs)
  File &quot;/Users/setoelkahfi/Repositories/splitfire/backend/musik88-web/.venv/lib/python3.12/site-packages/demucs/audio.py&quot;, line 260, in save_audio
    ta.save(str(path), wav, sample_rate=samplerate,
  File &quot;/Users/setoelkahfi/Repositories/splitfire/backend/musik88-web/.venv/lib/python3.12/site-packages/torchaudio/__init__.py&quot;, line 178, in save
    return save_with_torchcodec(
           ^^^^^^^^^^^^^^^^^^^^^
  File &quot;/Users/setoelkahfi/Repositories/splitfire/backend/musik88-web/.venv/lib/python3.12/site-packages/torchaudio/_torchcodec.py&quot;, line 246, in save_with_torchcodec
    from torchcodec.encoders import AudioEncoder
  File &quot;/Users/setoelkahfi/Repositories/splitfire/backend/musik88-web/.venv/lib/python3.12/site-packages/torchcodec/__init__.py&quot;, line 12, in &lt;module&gt;
    from . import decoders, encoders, samplers  # noqa
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/Users/setoelkahfi/Repositories/splitfire/backend/musik88-web/.venv/lib/python3.12/site-packages/torchcodec/decoders/__init__.py&quot;, line 7, in &lt;module&gt;
    from .._core import AudioStreamMetadata, VideoStreamMetadata
  File &quot;/Users/setoelkahfi/Repositories/splitfire/backend/musik88-web/.venv/lib/python3.12/site-packages/torchcodec/_core/__init__.py&quot;, line 8, in &lt;module&gt;
    from ._metadata import (
  File &quot;/Users/setoelkahfi/Repositories/splitfire/backend/musik88-web/.venv/lib/python3.12/site-packages/torchcodec/_core/_metadata.py&quot;, line 16, in &lt;module&gt;
    from torchcodec._core.ops import (
  File &quot;/Users/setoelkahfi/Repositories/splitfire/backend/musik88-web/.venv/lib/python3.12/site-packages/torchcodec/_core/ops.py&quot;, line 104, in &lt;module&gt;
    ffmpeg_major_version, core_library_path = load_torchcodec_shared_libraries()
                                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/Users/setoelkahfi/Repositories/splitfire/backend/musik88-web/.venv/lib/python3.12/site-packages/torchcodec/_core/ops.py&quot;, line 75, in load_torchcodec_shared_libraries
    raise RuntimeError(
RuntimeError: Could not load libtorchcodec. Likely causes:
          1. FFmpeg is not properly installed in your environment. We support
             versions 4, 5, 6, 7, and 8. On Windows, ensure you've installed
             the &quot;full-shared&quot; version which ships DLLs.
          2. The PyTorch version (2.9.1) is not compatible with
             this version of TorchCodec. Refer to the version compatibility
             table:
             https://github.com/pytorch/torchcodec?tab=readme-ov-file#installing-torchcodec.
          3. Another runtime dependency; see exceptions below.
        The following exceptions were raised as we tried to load libtorchcodec:

[start of libtorchcodec loading traceback]
FFmpeg version 8: Could not load this library: /Users/setoelkahfi/Repositories/splitfire/backend/musik88-web/.venv/lib/python3.12/site-packages/torchcodec/libtorchcodec_core8.dylib
FFmpeg version 7: Could not load this library: /Users/setoelkahfi/Repositories/splitfire/backend/musik88-web/.venv/lib/python3.12/site-packages/torchcodec/libtorchcodec_core7.dylib
FFmpeg version 6: Could not load this library: /Users/setoelkahfi/Repositories/splitfire/backend/musik88-web/.venv/lib/python3.12/site-packages/torchcodec/libtorchcodec_core6.dylib
FFmpeg version 5: Could not load this library: /Users/setoelkahfi/Repositories/splitfire/backend/musik88-web/.venv/lib/python3.12/site-packages/torchcodec/libtorchcodec_core5.dylib
FFmpeg version 4: Could not load this library: /Users/setoelkahfi/Repositories/splitfire/backend/musik88-web/.venv/lib/python3.12/site-packages/torchcodec/libtorchcodec_core4.dylib
[end of libtorchcodec loading traceback].
</code></pre>
<p>My pyproject.toml file:</p>
<pre><code class="language-toml">[project]
name = &quot;musik88-web&quot;
version = &quot;1.0.0&quot;
description = &quot;Cool stuff&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.12.12&quot;
dependencies = [
    &quot;demucs&gt;=4.0.1&quot;,
    &quot;ffmpeg&gt;=1.4&quot;,
    &quot;librosa&gt;=0.11.0&quot;,
    &quot;torchcodec&gt;=0.9.1&quot;,
    &quot;yt-dlp&gt;=2025.12.8&quot;,
]
</code></pre>
<p>I already installed ffmpeg through Homebrew:</p>
<pre><code class="language-bash">➜  musik88-web git:(feature/backend-uv-splitfire-job) ✗ brew install ffmpeg
==&gt; Auto-updating Homebrew...
Adjust how often this is run with `$HOMEBREW_AUTO_UPDATE_SECS` or disable with
`$HOMEBREW_NO_AUTO_UPDATE=1`. Hide these hints with `$HOMEBREW_NO_ENV_HINTS=1` (see `man brew`).
==&gt; Auto-updated Homebrew!
Updated 2 taps (homebrew/core and homebrew/cask).
==&gt; New Formulae
ctre: Compile-time PCRE-compatible regular expression matcher for C++

You have 18 outdated formulae installed.

Warning: ffmpeg 8.0.1 is already installed and up-to-date.
To reinstall 8.0.1, run:
  brew reinstall ffmpeg
</code></pre>
<p>Any pointers? Do I need the <code>ffmpeg</code> package on my deps file?</p>
<h3>Platform</h3>
<p>Darwin 25.1.0 arm64</p>
<h3>Version</h3>
<p>uv 0.9.16 (a63e5b62e 2025-12-06)</p>
<h3>Python version</h3>
<p>3.12.12</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @setoelkahfi on 2025-12-16 12:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/setoelkahfi">@setoelkahfi</a> on 2025-12-16 12:27</div>
            <div class="timeline-body"><p>I updated uv to the latest with <code>uv self update</code> <code>uv 0.9.17 (2b5d65e61 2025-12-09)</code> and tried <code>Python</code> 3.13, got the same errors. When trying Python 3.14 got error from <code>uv</code>:</p>
<pre><code>➜  musik88-web git:(feature/backend-uv-splitfire-job) ✗ uv sync
Using CPython 3.14.2
Removed virtual environment at: .venv
Creating virtual environment at: .venv
Resolved 74 packages in 0.63ms
error: Distribution `lameenc==1.8.1 @ registry+https://pypi.org/simple` can't be installed because it doesn't have a source distribution or wheel for the current platform

hint: You're using CPython 3.14 (`cp314`), but `lameenc` (v1.8.1) only has wheels with the following Python ABI tags: `cp312`, `cp313`, `cp313t`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-12-16 12:52</div>
            <div class="timeline-body"><p>It this a uv-specific problem, or a problem between <code>splitfire</code> and <code>[lib]torchcodec</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @konstin on 2025-12-16 12:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @konstin on 2025-12-16 12:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/setoelkahfi">@setoelkahfi</a> on 2025-12-17 09:22</div>
            <div class="timeline-body"><p>I was not sure because my current setup without uv is working ok but <code>uv run</code> fails with seemingly the same dependencies, hence the question. I think Claude pointed me the problem now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-12-17 10:27</div>
            <div class="timeline-body"><p>Does this mean this issue is solved?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/setoelkahfi">@setoelkahfi</a> on 2025-12-17 12:00</div>
            <div class="timeline-body"><p>Ok, this is happening on my production environment as well, running Linux Debian, ffmpeg 4. @konstin feel free to close this if you think it's unrelated to <code>uv</code>. I still don't know yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-12-17 12:10</div>
            <div class="timeline-body"><p>Yep, this looks like it needs to be solved by the packages, not by the package manager.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-12-17 12:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/setoelkahfi">@setoelkahfi</a> on 2025-12-23 12:49</div>
            <div class="timeline-body"><p>For my future reference and people who probably stumble upon this thread, we're running this in a Rails <code>ActiveJob</code>, and we need to append the envrionment variables in the command level in the <code>ActiveJob</code> class:</p>
<pre><code class="language-ruby">  # Always use absolute path in production until we figure out how to load the command
  # in the sidekiq.service
  def demucs
    if Rails.env.production?
      '/home/deploy/.local/bin/uv run demucs'
    else
      &quot;#{local_environments} uv run demucs&quot;
    end
  end

  def local_environments
    'DYLD_LIBRARY_PATH=/opt/homebrew/lib:$DYLD_LIBRARY_PATH DYLD_FALLBACK_LIBRARY_PATH=/opt/homebrew/lib'
  end
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:30 UTC
    </footer>
</body>
</html>
