<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[perf] differences in pip vs uv when installing package from src - astral-sh/uv #3802</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[perf] differences in pip vs uv when installing package from src</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/3802">#3802</a>
        opened by <a href="https://github.com/ryxli">@ryxli</a>
        on 2024-05-23 20:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ryxli">@ryxli</a> on 2024-05-23 20:49</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

<p>Would like some help or pointers with identifying the reason for the performance different between pip and uv pip install for a package (https://github.com/NVIDIA/TransformerEngine)</p>
<p>Reproduce steps:</p>
<pre><code>&gt;uv --version
uv 0.1.44

&gt;git clone https://github.com/NVIDIA/TransformerEngine.git
&gt;cd TransformerEngine
</code></pre>
<p>With regular pip:</p>
<pre><code>&gt; time NVTE_FRAMEWORK=pytorch NVTE_WITH_USERBUFFERS=1 MPI_HOME=/usr/local/mpi   pip install --no-build-isolation --no-deps -e .
Looking in indexes: https://pypi.org/simple, https://pypi.ngc.nvidia.com
Obtaining file:///workspace/TransformerEngine
  Preparing metadata (setup.py) ... done
Installing collected packages: transformer-engine
  Attempting uninstall: transformer-engine
    Found existing installation: transformer-engine 1.8.0.dev0+d705f7f
    Uninstalling transformer-engine-1.8.0.dev0+d705f7f:
      Successfully uninstalled transformer-engine-1.8.0.dev0+d705f7f
  Running setup.py develop for transformer-engine
Successfully installed transformer-engine-1.8.0.dev0+d705f7f
WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv

real    0m12.524s
user    0m10.516s
sys     0m12.773s
</code></pre>
<p>With uv pip:</p>
<pre><code>&gt; time NVTE_FRAMEWORK=pytorch NVTE_WITH_USERBUFFERS=1 MPI_HOME=/usr/local/mpi uv p
ip install --system --no-build-isolation --no-deps -e .
   Built file:///workspace/TransformerEngine                                                                                                                         Built 1 editable in 1m 09s
Resolved 1 package in 10ms
Installed 1 package in 1ms
 - transformer-engine==1.8.0.dev0+d705f7f
 + transformer-engine==1.8.0.dev0+d705f7f (from file:///workspace/TransformerEngine)

real    1m9.980s
user    16m6.687s
sys     2m12.868s
</code></pre>
<p>With --verbose enabled, the command seems to get stuck at <code>Calling setuptools.build_meta:__legacy__.build_editable</code> for a long while:</p>
<pre><code>DEBUG Starting interpreter discovery for default Python
DEBUG Cached interpreter info for Python 3.10.12, skipping probing: /usr/bin/python3
DEBUG Using Python 3.10.12 environment at /usr/bin/python3
DEBUG Trying to lock if free: /tmp/uv-08d95a7330542a29.lock
DEBUG At least one requirement is not satisfied: file:///workspace/TransformerEngine
DEBUG Using registry request timeout of 30s
DEBUG Building (editable) file:///workspace/TransformerEngine
DEBUG Calling `setuptools.build_meta:__legacy__.build_editable(&quot;/root/.cache/uv/.tmpKghDdN/.tmphfHmSb&quot;, {}, None)`
.....
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @ibraheemdev on 2024-05-23 21:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-24 00:06</div>
            <div class="timeline-body"><p>Hard for me to test this because it requires CUDA it seems?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-24 00:06</div>
            <div class="timeline-body"><p>But <code>setuptools.build_meta:__legacy__.build_editable</code> is just the build hook to build the editable -- it's not uv code, but Python code following the standards.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-05-24 00:26</div>
            <div class="timeline-body"><p>It seems like pip isn't performing a build? Do their verbose logs have more information?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-24 00:30</div>
            <div class="timeline-body"><p>I think pip actually doesn't use PEP 517 when doing editables, or something like that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ryxli">@ryxli</a> on 2024-05-24 02:02</div>
            <div class="timeline-body"><blockquote>
<p>Hard for me to test this because it requires CUDA it seems?</p>
</blockquote>
<p>Unfortunately this <a href="https://github.com/NVIDIA/TransformerEngine/blob/main/setup.py#L158">package requires cuda</a>, although the issue related to the install time does not seem related from what I can tell</p>
<blockquote>
<p>It seems like pip isn't performing a build? Do their verbose logs have more information?</p>
</blockquote>
<p>I did not include the whole logs as on first install most of the time is spent building cpp extensions via cmake. The cmake build is done incrementally, so it doesn't affect the tests above which is when I noticed this significant time difference just comparing uv and pip install.</p>
<p>The uv pip install just hangs on this line for a while, after which the install seems just as fast as regular pip.</p>
<pre><code>DEBUG Calling `setuptools.build_meta:__legacy__.build_editable(&quot;/root/.cache/uv/.tmpKghDdN/.tmphfHmSb&quot;, {}, None)`
</code></pre>
<p>It's possible there may be something else going on under the hood, as cmake logs are not exposed via uv pip install (https://github.com/astral-sh/uv/issues/1567). But for regular pip, I can get the logs and it seems relatively fast, so unsure what the issue is (10-15 seconds vs 1-2 minutes)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2024-05-26 13:21</div>
            <div class="timeline-body"><p>Is there a particular setup you have? Can you try on a fully clean environment, e.g. docker image?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ryxli">@ryxli</a> on 2024-05-26 16:37</div>
            <div class="timeline-body"><p>This is while trying to build a docker image</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2024-05-26 19:44</div>
            <div class="timeline-body"><p>Which docker image base were you using?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ryxli">@ryxli</a> on 2024-05-26 21:07</div>
            <div class="timeline-body"><p>Nvidia pytorch image</p>
<p>https://catalog.ngc.nvidia.com/orgs/nvidia/containers/pytorch</p>
<p>Using 24.04-py3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2024-05-26 23:44</div>
            <div class="timeline-body"><p>Thanks, I was attempting it earlier in a <code>nvidia/cuda:12.1.1-cudnn8-devel-ubuntu22.04</code> image and was getting relatively same build times across both. I will try using <code>nvcr.io/nvidia/pytorch:24.04-py3</code>, but from a quick glance it seems transformer-engine is already pre-built in it which could explain some of the speed differences.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ryxli">@ryxli</a> on 2024-05-27 00:15</div>
            <div class="timeline-body"><p>This is after uninstalling transformer_engine n in the base image, and then installing it from src</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:58 UTC
    </footer>
</body>
</html>
