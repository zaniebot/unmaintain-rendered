<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv add --branch` is broken solely on a particular repo - astral-sh/uv #7433</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>uv add --branch</code> is broken solely on a particular repo</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/7433">#7433</a>
        opened by <a href="https://github.com/Xmaster6y">@Xmaster6y</a>
        on 2024-09-16 17:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Xmaster6y">@Xmaster6y</a> on 2024-09-16 17:11</div>
            <div class="timeline-body"><h2>Problem</h2>
<p><code>uv</code> doesn't resolve the good commit when using <code>--branch &lt;branch&gt;</code> but <code>@&lt;branch&gt;</code> does (the repo: https://github.com/Xmaster6y/vec_noise)</p>
<p>When I use:</p>
<pre><code>uv add git+https://github.com/Xmaster6y/vec_noise@refacto 
</code></pre>
<p>I get (good rev):</p>
<pre><code>Updated https://github.com/Xmaster6y/vec_noise (1e281ec)
Updated https://github.com/Xmaster6y/vec_noise (1e281ec)
</code></pre>
<p>But when I use:</p>
<pre><code>uv add git+https://github.com/Xmaster6y/vec_noise --branch refacto
</code></pre>
<p>I get:</p>
<pre><code>Updated https://github.com/Xmaster6y/vec_noise (7c3865d)
...
</code></pre>
<h3>Same for <code>--rev</code></h3>
<p>Using</p>
<pre><code>uv add git+https://github.com/Xmaster6y/vec_noise --rev 1e281ec
</code></pre>
<p>gives :</p>
<pre><code>Updated https://github.com/Xmaster6y/vec_noise (7c3865d)
...
</code></pre>
<h3>Specificities</h3>
<ul>
<li>The repository is a second order fork</li>
<li>The original repository is fairly old -&gt; a fork belongs to the original repository network</li>
</ul>
<h2>What didn't work</h2>
<ul>
<li>I tried to add from a branch on a fork -&gt; worked as expected</li>
<li>I tried to add from a branch on a second order fork -&gt; worked as expected</li>
</ul>
<h2>Details</h2>
<ul>
<li>Plateform: MacOS (Darwin 23.5.0 arm64)</li>
<li><code>uv</code> version: uv 0.4.10 (690716484 2024-09-13)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-09-16 17:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">great writeup</span> added by @zanieb on 2024-09-16 17:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-16 17:13</div>
            <div class="timeline-body"><p>Thank you for the well-written report!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-16 17:17</div>
            <div class="timeline-body"><p>As a note, <code>7c3865d</code> is the head commit on <code>main</code> and the upstream fork (but not the original repository)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Xmaster6y">@Xmaster6y</a> on 2024-09-16 17:21</div>
            <div class="timeline-body"><p>Puzzling edit:</p>
<p>I previously add:</p>
<pre><code>uv add git+https://github.com/astral-sh/ruff --branch sys-version-info
</code></pre>
<p>giving:</p>
<pre><code> Updated https://github.com/astral-sh/ruff (bb12fe9d0)
 Updated https://github.com/astral-sh/ruff (61a5a86a7)
 ...
</code></pre>
<p>But now:</p>
<pre><code>uv add git+https://github.com/astral-sh/ruff --branch sys-version-info
</code></pre>
<p>giving:</p>
<pre><code> Updated https://github.com/astral-sh/ruff (bb12fe9d0)
 ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-16 17:28</div>
            <div class="timeline-body"><p>The difference in behavior appears to be because of https://github.com/astral-sh/uv/blob/cafc1f986a6efda0c2f384e63930333a812c9ea4/crates/uv/src/commands/project/add.rs#L241-L242</p>
<p>We only pass the <code>requirements</code> in here and when you use the <code>--branch</code> syntax the source is tracked separately from the package requirement.</p>
<pre><code>[crates/uv/src/commands/project/add.rs:240:5] &amp;requirements = [
    Package(
        &quot;git+https://github.com/Xmaster6y/vec_noise&quot;,
    ),
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Xmaster6y">@Xmaster6y</a> on 2024-09-16 17:32</div>
            <div class="timeline-body"><p>Is this wanted/expected?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Xmaster6y">@Xmaster6y</a> on 2024-09-16 17:33</div>
            <div class="timeline-body"><p>My later observation seems unrelated to my first issue</p>
<p>This happen when my <code>uv.lock</code> is not sync.</p>
<h3>To reproduce:</h3>
<p>Run (should break, otherwise interupt it mid-course):</p>
<pre><code>uv add git+https://github.com/astral-sh/ruff --branch sys-version-info 
</code></pre>
<p>Run the command again (not calling <code>uv sync/lock</code>):</p>
<pre><code>uv add git+https://github.com/astral-sh/ruff --branch sys-version-info 
</code></pre>
<p>Does it deserve another issue?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-16 17:33</div>
            <div class="timeline-body"><p>We later fail at</p>
<p>https://github.com/astral-sh/uv/blob/cafc1f986a6efda0c2f384e63930333a812c9ea4/crates/uv/src/commands/project/add.rs#L316-L324</p>
<p>If you name the dependency, the correct revision is resolved</p>
<pre><code>‚ùØ uv add vec_noise@git+https://github.com/Xmaster6y/vec_noise --branch refacto
 Updated https://github.com/Xmaster6y/vec_noise (1e281ec)
</code></pre>
<blockquote>
<p>Is this wanted/expected?</p>
</blockquote>
<p>No, I don't think the behavior we're seeing is wanted or expected. I'm just debugging and sharing some notes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-09-16 17:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-09-17 02:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-09-17 02:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:30:43 UTC
    </footer>
</body>
</html>
