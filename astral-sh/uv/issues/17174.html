<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv run pytest breaks history in pdb on windows - astral-sh/uv #17174</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv run pytest breaks history in pdb on windows</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/17174">#17174</a>
        opened by <a href="https://github.com/RmStorm">@RmStorm</a>
        on 2025-12-18 12:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/RmStorm">@RmStorm</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>When running <code>pytest</code> using <code>uv run</code> it breaks history in <code>pdb</code>.. so something like:</p>
<pre><code>➜ cat src/shell_pytest/test_thingy.py -p
def test_my_test():
    breakpoint()
</code></pre>
<p>drops you into a debugger when running <code>uv run pytest</code>.. Then you can do something like:</p>
<pre><code>➜ uv run pytest
========================================= test session starts ==========================================
platform linux -- Python 3.12.9, pytest-9.0.2, pluggy-1.6.0
rootdir: /home/rmstorm/Documents/python/shell_pytest
configfile: pyproject.toml
collected 1 item                                                                                       

src/shell_pytest/test_thingy.py 
&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; PDB set_trace (IO-capturing turned off) &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
--Return--
&gt; /home/rmstorm/Documents/python/shell_pytest/src/shell_pytest/test_thingy.py(2)test_my_test()-&gt;None
-&gt; breakpoint()
(Pdb) p 5
5
(Pdb) p 5
5
(Pdb) exit()


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! _pytest.outcomes.Exit: Quitting debugger !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
======================================== no tests ran in 7.12s =========================================
</code></pre>
<p>And on Linux this works.. you get arrow up functionality and a nice debugging experience.. On Windows arrow up will be broken. I've found two workarounds for the issue that might help in debugging.</p>
<p>The first is to directly invoke <code>pytest.exe</code> from the uv managed venv like so <code>.\.venv\Scripts\pytest.exe</code> everything works as expected! The second is to invoke the <code>pytest</code> module through python like so: <code>uv run python -m pytest</code> This also gives working history in pdb under pytest..</p>
<p>So I think the issue is a strange interaction between <code>pytest.exe</code> and uv.</p>
<h3>Platform</h3>
<p>Windows 11 X86_64</p>
<h3>Version</h3>
<p>uv 0.9.5</p>
<h3>Python version</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @RmStorm on 2025-12-18 12:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">windows</span> added by @konstin on 2025-12-18 12:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zelosleone">@zelosleone</a> on 2025-12-22 17:00</div>
            <div class="timeline-body"><p>This is most definitely not an uv bug. uv currently makes invalid handlers on windows due to <code>close_handles</code> closing DUPed handles that share the same underlying kernel object as STDIN/STDOUT as it was not checking the handler correctly, changing these things and making sure we get the standard handlers from OS will fix that and we won't have invalid handles on trampoline after <code>close_handles</code> function performs. However, this won't fix the issue of pytest. Python by itself works correctly by the way, it's a pytest issue.</p>
<p>Some logs after i added things to diagnostics (before the mentioned fixes first)</p>
<pre><code>--- TRAMPOLINE DIAGNOSTICS: STARTUP ---
  STDIN: Handle=520
    -&gt; Console Mode: 0x000001F7
  STDOUT: Handle=812
    -&gt; Console Mode: 0x00000007
  STDERR: Handle=1008
    -&gt; Console Mode: 0x00000007
-------------------------------------------
--- TRAMPOLINE DIAGNOSTICS: AFTER CLOSE_HANDLES ---
  STDIN: Handle=-1
    -&gt; INVALID
  STDOUT: Handle=-1
    -&gt; INVALID
  STDERR: Handle=1008
    -&gt; Console Mode: 0x00000007
</code></pre>
<p>after:</p>
<pre><code>--- TRAMPOLINE DIAGNOSTICS: STARTUP ---
  STDIN: Handle=532
    -&gt; Console Mode: 0x000001F7
  STDOUT: Handle=920
    -&gt; Console Mode: 0x00000007
  STDERR: Handle=936
    -&gt; Console Mode: 0x00000007
-------------------------------------------
--- TRAMPOLINE DIAGNOSTICS: AFTER CLOSE_HANDLES (DISABLED) ---
  STDIN: Handle=532
    -&gt; Console Mode: 0x000001F7
  STDOUT: Handle=920
    -&gt; Console Mode: 0x00000007
  STDERR: Handle=936
    -&gt; Console Mode: 0x00000007
</code></pre>
<p>which still won't make pytest see the history for some reason. And yes, directly calling it with a direct path works but that could be a path issue from pytest itself as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zelosleone">@zelosleone</a> on 2025-12-22 20:58</div>
            <div class="timeline-body"><p>I basically traced it back to pdb itself. https://github.com/python/cpython/pull/143083 this fixes it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2026-01-06 19:09</div>
            <div class="timeline-body"><p>Amazing, thanks for fixing this in CPython!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2026-01-06 19:09</div>
            <div class="timeline-body"><blockquote>
<p>uv currently makes invalid handlers on windows due to <code>close_handles</code> closing DUPed handles that share the same underlying kernel object as STDIN/STDOUT as it was not checking the handler correctly, changing these things and making sure we get the standard handlers from OS will fix that and we won't have invalid handles on trampoline after <code>close_handles</code> function performs. However, this won't fix the issue of pytest.</p>
</blockquote>
<p>Can you share that fix?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zelosleone">@zelosleone</a> on 2026-01-09 12:09</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>uv currently makes invalid handlers on windows due to <code>close_handles</code> closing DUPed handles that share the same underlying kernel object as STDIN/STDOUT as it was not checking the handler correctly, changing these things and making sure we get the standard handlers from OS will fix that and we won't have invalid handles on trampoline after <code>close_handles</code> function performs. However, this won't fix the issue of pytest.</p>
</blockquote>
<p>Can you share that fix?</p>
</blockquote>
<p>sure, here is it https://github.com/astral-sh/uv/pull/17374</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2026-01-09 12:10</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zelosleone">@zelosleone</a> on 2026-01-09 12:14</div>
            <div class="timeline-body"><p>Also if you guys can connect with pyreadline3 guys, their window build is gonna be completely broken in the future (its already broken in newer python versions) https://github.com/pyreadline3/pyreadline3/pull/44 (just to let you guys know since you guys might know one of them)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2026-01-10 18:11</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:33:43 UTC
    </footer>
</body>
</html>
