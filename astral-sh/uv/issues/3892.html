<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv run` should only resolve when lockfile is out-of-sync - astral-sh/uv #3892</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>`uv run` should only resolve when lockfile is out-of-sync</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/3892">#3892</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-05-28 23:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-28 23:07</div>
            <div class="timeline-body"><p>As long as the lockfile satisfies the requirements, we should accept it (even if dependencies are outdated). Updating the lockfile should be done via <code>uv update</code> or <code>uv lock</code> or comparable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @charliermarsh on 2024-05-28 23:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-05-28 23:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @charliermarsh by @charliermarsh on 2024-06-01 00:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-06-08 20:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-09 00:22</div>
            <div class="timeline-body"><p>I'm looking into this now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-10 02:58</div>
            <div class="timeline-body"><p>There are two parts to this:</p>
<ol>
<li>Statically extracting the requirements for the workspace.</li>
<li>Comparing the extracted requirements to the lockfile.</li>
</ol>
<p>I am working on (1). It's not totally trivial, we currently defer that extraction to the resolver.</p>
<p>There are several things that make (2) hard:</p>
<ol>
<li>The markers might've been normalized when writing to the lockfile, so they may not match the requirements as defined by the user. We could also have multiple requirements from (1) that map to a single requirement in (2), if it's (e.g.) a single requirement repeated with different markers (which would get OR'd when writing to the lockfile).</li>
<li>We have to check workspace dependencies recursively.</li>
<li>We need to ensure that there are no entries in the lockfile that no longer exist as requirements -- otherwise, we'll install too many packages. So it's not just checking that each requirement is present; we also need to check that nothing is present that isn't a requirement. We need to be able to map from requirement to lock entry, but also the other way around.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @charliermarsh by @charliermarsh on 2024-06-10 13:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-10 13:43</div>
            <div class="timeline-body"><p>@ibraheemdev and I discussed this in Discord. A summary:</p>
<ul>
<li>We think that the right way to solve this is to enable the resolver to read from the lockfile directly. Then, this could be reframed as: can we solve the graph with <em>just</em> the lockfile? (Overlaps heavily with https://github.com/astral-sh/uv/issues/3925.) If we can implement resolution atop the lockfile, all of the challenges that I described above go away.</li>
<li>Separately, we may want to read from the lockfile directly during &quot;normal&quot; resolution, but to implement this ticket, we could just do a first-pass where we try to solve from <em>only</em> the lockfile. So there could be additional follow-up work for #3925 later.</li>
<li>Another idea we discussed was: write a hash or checksum of the requirements somewhere in the cache, and avoid re-resolving if they line up with the lockfile. This would be conceptually similar to writing a hash to the lockfile to capture its inputs, but we would write it out-of-band (to the cache) to avoid causing merge conflicts, etc. (This would only work locally after performing at least one resolution.) But we weren't sure if this would be necessary once we do the &quot;resolve from the lockfile&quot; idea. Either way, we'd need to read the lockfile from disk; and either way, we'd need to then validate that the virtual environment satisfies the requirements (unless we used the hash / checksum to skip this too, which could work, but risks getting out-of-sync when the user modifies the environment manually). So we opted <em>not</em> do to that for now, and to instead focus on the harder thing.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-10 15:55</div>
            <div class="timeline-body"><p>There's something confusing in https://github.com/astral-sh/uv/issues/3925 though... In the lockfile, we don't actually store the version <em>constraints</em>, we just store the locked version. That might be fine? But if we translate that back to a requirement, we will have to translate to an <code>==</code> requirement. I haven't thought through the implications of that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @ibraheemdev on 2024-06-19 20:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4495.html">astral-sh/uv#4495</a> on 2024-06-24 22:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-07-07 18:16</div>
            <div class="timeline-body"><p>To add more motivation here: When running <code>uv lock</code> transformers with all extras with a fitting lock, we take 100ms on main, but 60ms with https://github.com/astral-sh/uv/pull/4495.</p>
<p>One thing we lose by doing this is the check for yanked releases, those versions that are part of the lock file but have yanked since.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @ibraheemdev by @ibraheemdev on 2024-07-09 18:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-07-12 22:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-07-12 22:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:19 UTC
    </footer>
</body>
</html>
