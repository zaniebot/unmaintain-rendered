<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caching does not consider URLs (or redirects) - astral-sh/uv #14534</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Caching does not consider URLs (or redirects)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/14534">#14534</a>
        opened by <a href="https://github.com/danielpanteleit">@danielpanteleit</a>
        on 2025-07-10 08:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danielpanteleit">@danielpanteleit</a></div>
            <div class="timeline-body">Summary
<p>I am using DevPI and noticed missing caching in uv when changing indices, even though the relevant file is served on the same URL and redirects to the same PyPI URL (using the undocumented <code>mirror_use_external_urls</code> configuration in DevPI).</p>
<p>You can see below that both indices refer to the same download URL <code>https://devpi.example.com/root/pypi/+f/436/4d3a37c449f1c/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl</code> (note: I changed the server domain) which redirects to <code>https://files.pythonhosted.org/packages/18/12/7ccbc678a130df0f751596b37eddb98b2e40930d0ebc9ee41965ffbf0b92/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl</code>.</p>
<pre><code>$ uv venv
Using CPython 3.13.5
Creating virtual environment at: .venv
Activate with: source .venv/bin/activate

$ uv pip install -v mysql-connector-python
DEBUG uv 0.7.20
DEBUG Searching for default Python interpreter in virtual environments
DEBUG Found `cpython-3.13.5-linux-x86_64-gnu` at `/tmp/.venv/bin/python3` (virtual environment)
DEBUG Using Python 3.13.5 environment at: .venv
DEBUG Acquired lock for `.venv`
DEBUG At least one requirement is not satisfied: mysql-connector-python
DEBUG Using request timeout of 30s
DEBUG Solving with installed Python version: 3.13.5
DEBUG Solving with target Python version: &gt;=3.13.5
DEBUG Adding direct dependency: mysql-connector-python*
DEBUG No cache entry for: https://devpi.example.com/user/master/+simple/mysql-connector-python/
DEBUG Searching for a compatible version of mysql-connector-python (*)
DEBUG Selecting: mysql-connector-python==9.3.0 [compatible] (mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl)
DEBUG No cache entry for: https://devpi.example.com/root/pypi/+f/436/4d3a37c449f1c/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl
DEBUG Received a cross-origin redirect. Removing sensitive headers.
DEBUG Received HTTP 302 Found. Redirecting to https://files.pythonhosted.org/packages/18/12/7ccbc678a130df0f751596b37eddb98b2e40930d0ebc9ee41965ffbf0b92/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl
WARN Range requests not supported for mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl; streaming wheel
DEBUG No cache entry for: https://devpi.example.com/root/pypi/+f/436/4d3a37c449f1c/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl
DEBUG Received a cross-origin redirect. Removing sensitive headers.
DEBUG Received HTTP 302 Found. Redirecting to https://files.pythonhosted.org/packages/18/12/7ccbc678a130df0f751596b37eddb98b2e40930d0ebc9ee41965ffbf0b92/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl
DEBUG Tried 1 versions: mysql-connector-python 1
DEBUG marker environment resolution took 6.468s
Resolved 1 package in 6.46s
DEBUG Identified uncached distribution: mysql-connector-python==9.3.0
DEBUG No cache entry for: https://devpi.example.com/root/pypi/+f/436/4d3a37c449f1c/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl
DEBUG Received a cross-origin redirect. Removing sensitive headers.
DEBUG Received HTTP 302 Found. Redirecting to https://files.pythonhosted.org/packages/18/12/7ccbc678a130df0f751596b37eddb98b2e40930d0ebc9ee41965ffbf0b92/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl
Downloading mysql-connector-python (32.3MiB)
 Downloading mysql-connector-python
Prepared 1 package in 5.92s
Installed 1 package in 153ms
 + mysql-connector-python==9.3.0
DEBUG Released lock at `/tmp/.venv/.lock`
</code></pre>
<p>Here I changed the index.</p>
<pre><code>$ rm -rf .venv/

$ uv venv
Using CPython 3.13.5
Creating virtual environment at: .venv
Activate with: source .venv/bin/activate

$ uv pip install -v mysql-connector-python
DEBUG uv 0.7.20
DEBUG Searching for default Python interpreter in virtual environments
DEBUG Found `cpython-3.13.5-linux-x86_64-gnu` at `/tmp/.venv/bin/python3` (virtual environment)
DEBUG Using Python 3.13.5 environment at: .venv
DEBUG Acquired lock for `.venv`
DEBUG At least one requirement is not satisfied: mysql-connector-python
DEBUG Using request timeout of 30s
DEBUG Solving with installed Python version: 3.13.5
DEBUG Solving with target Python version: &gt;=3.13.5
DEBUG Adding direct dependency: mysql-connector-python*
DEBUG No cache entry for: https://devpi.example.com/user/topic/+simple/mysql-connector-python/
DEBUG Searching for a compatible version of mysql-connector-python (*)
DEBUG Selecting: mysql-connector-python==9.3.0 [compatible] (mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl)
DEBUG No cache entry for: https://devpi.example.com/root/pypi/+f/436/4d3a37c449f1c/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl
DEBUG Received a cross-origin redirect. Removing sensitive headers.
DEBUG Received HTTP 302 Found. Redirecting to https://files.pythonhosted.org/packages/18/12/7ccbc678a130df0f751596b37eddb98b2e40930d0ebc9ee41965ffbf0b92/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl
WARN Range requests not supported for mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl; streaming wheel
DEBUG No cache entry for: https://devpi.example.com/root/pypi/+f/436/4d3a37c449f1c/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl
DEBUG Received a cross-origin redirect. Removing sensitive headers.
DEBUG Received HTTP 302 Found. Redirecting to https://files.pythonhosted.org/packages/18/12/7ccbc678a130df0f751596b37eddb98b2e40930d0ebc9ee41965ffbf0b92/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl
DEBUG Tried 1 versions: mysql-connector-python 1
DEBUG marker environment resolution took 6.379s
Resolved 1 package in 6.38s
DEBUG Identified uncached distribution: mysql-connector-python==9.3.0
DEBUG No cache entry for: https://devpi.example.com/root/pypi/+f/436/4d3a37c449f1c/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl
DEBUG Received a cross-origin redirect. Removing sensitive headers.
DEBUG Received HTTP 302 Found. Redirecting to https://files.pythonhosted.org/packages/18/12/7ccbc678a130df0f751596b37eddb98b2e40930d0ebc9ee41965ffbf0b92/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl
Downloading mysql-connector-python (32.3MiB)
 Downloading mysql-connector-python
Prepared 1 package in 5.86s
Installed 1 package in 210ms
 + mysql-connector-python==9.3.0
DEBUG Released lock at `/tmp/.venv/.lock`
</code></pre>
<p>After that the cache is twice as large as before (~180 MB instead of ~90 MB). So it was downloaded twice and cached twice. Since both indices refer to the same download URL I would expect the first cached version to be reused. In pip this works and it seems to cache the redirection too, but I&#x27;m not sure:</p>
<pre><code>$ pip download -v mysql-connector-python
Collecting mysql-connector-python
  Created temporary directory: /tmp/pip-unpack-jr1kcmwg
  Found index url https://devpi.example.com/user/master/+simple/
  Found credentials in index url for devpi.example.com
  Looking up &quot;https://devpi.example.com/root/pypi/%2Bf/436/4d3a37c449f1c/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl&quot; in the cache
  No cache entry available
  No cache entry available
  https://devpi.example.com:443 &quot;GET /root/pypi/%2Bf/436/4d3a37c449f1c/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl HTTP/1.1&quot; 302 341
  Status code 302 not in (200, 203, 300, 301, 308)
  Looking up &quot;https://files.pythonhosted.org/packages/18/12/7ccbc678a130df0f751596b37eddb98b2e40930d0ebc9ee41965ffbf0b92/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl&quot; in the cache
  No cache entry available
  No cache entry available
  Starting new HTTPS connection (1): files.pythonhosted.org:443
  https://files.pythonhosted.org:443 &quot;GET /packages/18/12/7ccbc678a130df0f751596b37eddb98b2e40930d0ebc9ee41965ffbf0b92/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl HTTP/1.1&quot; 200 33853838
  Downloading https://devpi.example.com/root/pypi/%2Bf/436/4d3a37c449f1c/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl (33.9 MB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╺ 33.0/33.9 MB 5.9 MB/s eta 0:00:01  Ignoring unknown cache-control directive: immutable
  Updating cache with response from &quot;https://files.pythonhosted.org/packages/18/12/7ccbc678a130df0f751596b37eddb98b2e40930d0ebc9ee41965ffbf0b92/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl&quot;
  etag object cached for 1209600 seconds
  Caching due to etag
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 33.9/33.9 MB 5.8 MB/s eta 0:00:00
</code></pre>
<p>and with the other index:</p>
<pre><code>$ pip download -v mysql-connector-python
Collecting mysql-connector-python
  Created temporary directory: /tmp/pip-unpack-9sdlijv_
  Found index url https://devpi.example.com/user/topic/+simple/
  Found credentials in index url for devpi.example.com
  Looking up &quot;https://devpi.example.com/root/pypi/%2Bf/436/4d3a37c449f1c/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl&quot; in the cache
  No cache entry available
  No cache entry available
  https://devpi.example.com:443 &quot;GET /root/pypi/%2Bf/436/4d3a37c449f1c/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl HTTP/1.1&quot; 302 341
  Status code 302 not in (200, 203, 300, 301, 308)
  Looking up &quot;https://files.pythonhosted.org/packages/18/12/7ccbc678a130df0f751596b37eddb98b2e40930d0ebc9ee41965ffbf0b92/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl&quot; in the cache
  Current age based on date: 207
  Ignoring unknown cache-control directive: immutable
  Freshness lifetime from max-age: 365000000
  The response is &quot;fresh&quot;, returning cached response
  365000000 &gt; 207
  Using cached https://devpi.example.com/root/pypi/%2Bf/436/4d3a37c449f1c/mysql_connector_python-9.3.0-cp313-cp313-manylinux_2_28_x86_64.whl (33.9 MB)
</code></pre>
Platform
<p>Ubuntu 25.04</p>
Version
<p>uv 0.7.20</p>
Python version
<p>3.13.5</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/danielpanteleit">@danielpanteleit</a> on 2025-07-10 08:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cache</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-10 18:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-10 18:21</div>
            <div class="timeline-body"><p>From the logs, itt looks like we aren&#x27;t use the redirect target for the cache entry. I&#x27;m not sure if this is intentional, @charliermarsh may know.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-10 18:27</div>
            <div class="timeline-body"><p>We don&#x27;t cache registry wheels based on the URL at all. Instead, we cache based on (index URL), (package name), (version). Since these are served from different registries, they&#x27;re treated as separate cache entities. I think the right fix here is to use content-addressed caching for wheels, which we&#x27;re tracking elsewhere.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-14 01:17</div>
            <div class="timeline-body"><p>Going to merge into #13995.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-14 01:17</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:39:21 UTC
    </footer>
</body>
</html>
