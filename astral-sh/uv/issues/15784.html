<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Do not update cache ctime - astral-sh/uv #15784</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Do not update cache ctime</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/15784">#15784</a>
        opened by <a href="https://github.com/elazarl">@elazarl</a>
        on 2025-09-11 09:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/elazarl">@elazarl</a> on 2025-09-11 09:51</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>When building a docker image, we often rely on <code>uv</code>'s great caching features.</p>
<p>Doing something along the lines of</p>
<pre><code class="language-Dockerfile">FROM  ghcr.io/astral-sh/uv:debian

RUN &lt;&lt;EOT

uv venv
source .venv/bin/activate
uv pip install kubernetes
deactivate
rm -rf .venv

EOT

RUN &lt;&lt;EOT

uv venv
source .venv/bin/activate
uv pip install kubernetes requests
deactivate
rm -rf .venv

EOT
</code></pre>
<p>I expect that the last layer would only contain the <code>requests</code> package in cache, and the <code>kubernetes</code> package would be taken from the previous layer.</p>
<p>This is since when attempting to install <code>kubernetes</code> again, <code>uv</code> updates the <code>ctime</code> in cache.</p>
<p>Can I prevent it from changing existing cache items? So that docker would only grab new packages?</p>
<h3>Example</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @elazarl on 2025-09-11 09:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/elazarl">@elazarl</a> on 2025-09-11 10:02</div>
            <div class="timeline-body"><p>The current workaround I found:</p>
<pre><code>C=/tmp/uv-cache
cp -r `uv cache dir` $C
uv pip install --cache-dir $C kubernetes
rsync -avc $C/ `uv cache dir`/
</code></pre>
<p>Assuming COW filesystem the initial copy isn't aweful, and docker seems to only take the new files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-09-11 17:05</div>
            <div class="timeline-body"><p>Hm I guess the ctime changes because the number of hardlinks changes? Why's that a problem?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/elazarl">@elazarl</a> on 2025-09-11 18:22</div>
            <div class="timeline-body"><blockquote>
<p>Hm I guess the ctime changes because the number of hardlinks changes? Why's that a problem?</p>
</blockquote>
<p>TBH I'm not quite sure. I'll show you the steps I took to recreate the problem</p>
<pre><code>â¯ bat uv.Dockerfile
â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       â”‚ File: uv.Dockerfile
â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1   â”‚ FROM  ghcr.io/astral-sh/uv:debian
   2   â”‚
   3   â”‚ RUN apt-get update &amp;&amp; apt-get install -y rsync
   4   â”‚
   5   â”‚ RUN &lt;&lt;EOT
   6   â”‚
   7   â”‚ uv venv
   8   â”‚ . .venv/bin/activate
   9   â”‚ uv pip install kubernetes
  10   â”‚ deactivate
  11   â”‚ rm -rf .venv
  12   â”‚
  13   â”‚ EOT
  14   â”‚
  15   â”‚ RUN &lt;&lt;EOT
  16   â”‚
  17   â”‚ uv venv
  18   â”‚ . .venv/bin/activate
  19   â”‚ uv pip install kubernetes
  20   â”‚ deactivate
  21   â”‚ rm -rf .venv
  22   â”‚
  23   â”‚ EOT
â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ubuntu in ğŸŒ elazarl-bootstrap in ~ via C v13.3.0-gcc via ğŸ v3.12.3 (atero-um)
â¯ docker buildx build -f uv.Dockerfile -t tmp .
[+] Building 4.4s (8/8) FINISHED                                                                                                                                                                                                      docker:default
 =&gt; [internal] load build definition from uv.Dockerfile                                                                                                                                                                                         0.0s
 =&gt; =&gt; transferring dockerfile: 316B                                                                                                                                                                                                            0.0s
 =&gt; [internal] load metadata for ghcr.io/astral-sh/uv:debian                                                                                                                                                                                    0.0s
 =&gt; [internal] load .dockerignore                                                                                                                                                                                                               0.0s
 =&gt; =&gt; transferring context: 2B                                                                                                                                                                                                                 0.0s
 =&gt; [1/4] FROM ghcr.io/astral-sh/uv:debian                                                                                                                                                                                                      0.0s
 =&gt; CACHED [2/4] RUN apt-get update &amp;&amp; apt-get install -y rsync                                                                                                                                                                                 0.0s
 =&gt; CACHED [3/4] RUN &lt;&lt;EOT (uv venv...)                                                                                                                                                                                                         0.0s
 =&gt; [4/4] RUN &lt;&lt;EOT (uv venv...)                                                                                                                                                                                                                1.3s
 =&gt; exporting to image                                                                                                                                                                                                                          2.8s
 =&gt; =&gt; exporting layers                                                                                                                                                                                                                         2.7s
 =&gt; =&gt; writing image sha256:a1647151e840c84d5b13c434b178eedf14be6c537ec2775af5d26fd17c2a9c04                                                                                                                                                    0.0s
 =&gt; =&gt; naming to docker.io/library/tmp
</code></pre>
<p>Now I ran it</p>
<pre><code>â¯ docker run -ti tmp /bin/bash
root@0a2701e6aca1:/# du -sh `uv cache dir`
29M     /root/.cache/uv
root@0a2701e6aca1:/#
</code></pre>
<p>In another shell</p>
<pre><code>$ docker container inspect `docker container ps -l -q`|jq -r '.[]|.GraphDriver.Data.LowerDir'|tr : \\n|xargs -I@ sudo du -sh @
4.0K    /data/docker/overlay2/95af2a7d2bcd4fe15c77252e4e94b71d1e12bde924ffd15b5db19167dfe39b5b-init/diff
28M     /data/docker/overlay2/lfhobfke608dzz9fwdswayqym/diff
29M     /data/docker/overlay2/cb4v72ruwtpk98s422nfmmcas/diff
22M     /data/docker/overlay2/iw0iyehesu4g0xdaa1ffq3ida/diff
47M     /data/docker/overlay2/c8272fc40b25c1f15d10c37cd9d17a730143e258dcea509fdef5653683bcb771/diff
590M    /data/docker/overlay2/dae5f8dcc2a8537dc1a74849febfd9bb369fc7c1da2510cf71dd89dac41735f7/diff
183M    /data/docker/overlay2/c29c935136d9ddafc56d869c70e1a1bb10c26552356618e30371d4d987475e56/diff
51M     /data/docker/overlay2/86baab4e84626efe7eafbaecdec892d6b2e40b935858ad934c4a1583e58d6fc8/diff
127M    /data/docker/overlay2/010768ffc34fecf10413f67775c7ba87cb91c45361cf534e344a29246cc2d712/diff
</code></pre>
<p>I expect <code>lfhobfke608dzz9fwdswayqym</code> would not take 28MB</p>
<p>Also, the layers should not contain identical files, alas:</p>
<pre><code>$ sudo diff -rn --report-identical-files   /data/docker/overlay2/lfhobfke608dzz9fwdswayqym/diff   /data/docker/overlay2/cb4v72ruwtpk98s422nfmmcas/diff|grep identical|head -3
Files /data/docker/overlay2/lfhobfke608dzz9fwdswayqym/diff/root/.cache/uv/archive-v0/52Mg-r6jPNKsXKOiVUyQP/kubernetes/__init__.py and /data/docker/overlay2/cb4v72ruwtpk98s422nfmmcas/diff/root/.cache/uv/archive-v0/52Mg-r6jPNKsXKOiVUyQP/kubernetes/__init__.py are identical
Files /data/docker/overlay2/lfhobfke608dzz9fwdswayqym/diff/root/.cache/uv/archive-v0/52Mg-r6jPNKsXKOiVUyQP/kubernetes/client/__init__.py and /data/docker/overlay2/cb4v72ruwtpk98s422nfmmcas/diff/root/.cache/uv/archive-v0/52Mg-r6jPNKsXKOiVUyQP/kubernetes/client/__init__.py are identical
Files /data/docker/overlay2/lfhobfke608dzz9fwdswayqym/diff/root/.cache/uv/archive-v0/52Mg-r6jPNKsXKOiVUyQP/kubernetes/client/api/__init__.py and /data/docker/overlay2/cb4v72ruwtpk98s422nfmmcas/diff/root/.cache/uv/archive-v0/52Mg-r6jPNKsXKOiVUyQP/kubernetes/client/api/__init__.py are identical
</code></pre>
<p>But ctime is different</p>
<pre><code>(atero-um) ubuntu@elazarl-bootstrap:~$ sudo stat /data/docker/overlay2/lfhobfke608dzz9fwdswayqym/diff/root/.cache/uv/archive-v0/52Mg-r6jPNKsXKOiVUyQP/kubernetes/__init__.py
  File: /data/docker/overlay2/lfhobfke608dzz9fwdswayqym/diff/root/.cache/uv/archive-v0/52Mg-r6jPNKsXKOiVUyQP/kubernetes/__init__.py
  Size: 844             Blocks: 8          IO Block: 4096   regular file
Device: 0,49    Inode: 2425323     Links: 1
Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)
Access: 2025-09-11 09:46:47.870429496 +0000
Modify: 2025-09-11 09:46:47.870429496 +0000
Change: 2025-09-11 18:12:06.893881933 +0000
 Birth: 2025-09-11 18:12:06.433886506 +0000
(atero-um) ubuntu@elazarl-bootstrap:~$ sudo stat /data/docker/overlay2/cb4v72ruwtpk98s422nfmmcas/diff/root/.cache/uv/archive-v0/52Mg-r6jPNKsXKOiVUyQP/kubernetes/__init__.py
  File: /data/docker/overlay2/cb4v72ruwtpk98s422nfmmcas/diff/root/.cache/uv/archive-v0/52Mg-r6jPNKsXKOiVUyQP/kubernetes/__init__.py
  Size: 844             Blocks: 8          IO Block: 4096   regular file
Device: 0,49    Inode: 2270007     Links: 1
Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)
Access: 2025-09-11 09:46:47.870429496 +0000
Modify: 2025-09-11 09:46:47.870429496 +0000
Change: 2025-09-11 09:46:48.229429913 +0000
 Birth: 2025-09-11 09:46:47.870429496 +0000
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-09-12 10:47</div>
            <div class="timeline-body"><p>I see, thanks. Maybe you want to change to <code>UV_LINK_MODE=copy</code>? I'd also recommend using a cache mount for the uv cache? Did you see our section on this in the documentation?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/elazarl">@elazarl</a> on 2025-09-12 14:08</div>
            <div class="timeline-body"><blockquote>
<p>I see, thanks. Maybe you want to change to <code>UV_LINK_MODE=copy</code>? I'd also recommend using a cache mount for the uv cache? Did you see our section on this in the documentation?</p>
</blockquote>
<p>I tried the <code>UV_LINK_MODE=link</code> and it seems like a good workaround.</p>
<p>( <em>edit:</em> wrong conclusion)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/elazarl">@elazarl</a> on 2025-09-12 14:09</div>
            <div class="timeline-body"><p>(The <code>copy</code> mode defeats the purpose of the optimization, as I don't want docker images to contain two copies of the same packages.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eabase">@eabase</a> on 2025-09-14 13:27</div>
            <div class="timeline-body"><p>Because windows doesn't have a 1:1 mapping of <code>ctime</code>, <code>atime</code>, and <code>mtime</code>. They've been broken and confused for decades. So don't expect <em>any</em>time to match between docker/WSL distros and any normal nix ones.</p>
<p>Hee-ell, Windows still can't even sort file times correctly in their own File Explorer!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:33:12 UTC
    </footer>
</body>
</html>
