<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caching behavior with --ci for large libraries - astral-sh/uv #10403</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Caching behavior with --ci for large libraries</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/10403">#10403</a>
        opened by <a href="https://github.com/MattTheCuber">@MattTheCuber</a>
        on 2025-01-08 18:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MattTheCuber">@MattTheCuber</a></div>
            <div class="timeline-body"><p>According to <a href="https://docs.astral.sh/uv/concepts/cache/#caching-in-continuous-integration">the docs</a>, <code>uv cache prune --ci</code> &quot;removes all pre-built wheels and unzipped source distributions from the cache&quot;.</p>
<p>Our project uses a few large libraries which take a long time to download from PyPi. For example, torch and it&#x27;s dependencies (several nvidia packages) make up 2 GB of files that need to be downloaded (takes ~5 minutes to download and install with uv). Would it be possible to make the <code>--ci</code> flag not clear very large downloaded packages? Otherwise, an argument could be added to <code>uv cache prune</code> that doesn&#x27;t clear libraries over a given size?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MattTheCuber">@MattTheCuber</a> on 2025-01-08 18:30</div>
            <div class="timeline-body"><p>Example:</p>
<pre><code>$ uv venv
Using CPython 3.9.21 interpreter at: /usr/bin/python
Creating virtual environment at: .venv
Activate with: source .venv/bin/activate
$ source .venv/bin/activate
$ uv pip install torch --cache-dir .uv_cache
Resolved 22 packages in 528ms
Prepared 22 packages in 4m 58s
Installed 22 packages in 196ms
...
$ uv cache prune --ci --cache-dir .uv_cache
Pruning cache at: .uv_cache
Removed 13871 files (4.9GiB)
$ deactivate
$ rm -rf .venv
$ uv venv
Using CPython 3.9.21 interpreter at: /usr/bin/python
Creating virtual environment at: .venv
Activate with: source .venv/bin/activate
$ source .venv/bin/activate
$ uv pip install torch --cache-dir .uv_cache
Resolved 22 packages in 487ms
Prepared 22 packages in 5m 02s
Installed 22 packages in 202ms
...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by <a href="https://github.com/Gankra">@Gankra</a> on 2025-01-08 19:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cache</span> added by <a href="https://github.com/Gankra">@Gankra</a> on 2025-01-08 19:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-01-08 19:51</div>
            <div class="timeline-body"><p>If we do anything here, the CLI flag for a size limit is probably a good idea either way, as an override for any behaviour we pick.</p>
<p>Out of curiosity, did you measure how long it takes to upload+download everything from your cache (e.g. if you don&#x27;t use prune --ci)? That kind of information is the crux of whether this will actually improve performance to do this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MattTheCuber">@MattTheCuber</a> on 2025-01-08 20:07</div>
            <div class="timeline-body"><p>Yes, I am currently using that method. It cuts off several minutes although it didn&#x27;t measure the exact time difference.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MattTheCuber">@MattTheCuber</a> on 2025-01-09 14:34</div>
            <div class="timeline-body"><p>My current fastest solution is to build a custom image that simply pip installs torch that way uv doesn&#x27;t have to download or install it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fenuks">@fenuks</a> on 2025-04-11 14:00</div>
            <div class="timeline-body"><p>I have somewhat related issue. I don&#x27;t want <code>uv cache prune --ci</code> to remove
wheels at all, only stale/outdated ones.</p>
<p>Let&#x27;s say I have cached wheels for <code>django 5.1.7</code>, I update to <code>5.2</code>. I would
like to remove old cached data for <code>v5.1.7</code>. Currently <code>uv cache prune --ci</code>
removes almost everything, and <code>uv sync</code> re-downloads every dependency, so
there is little advantage to having it. I get very similar times with <code>uv sync</code>
when I have no cache, and when I have cache pruned with <code>--ci</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MattTheCuber">@MattTheCuber</a> on 2025-04-11 15:40</div>
            <div class="timeline-body"><p>@fenuks I think you are looking for just <code>uv cache prune</code> (without <code>--ci</code>) which only removes unused packages such as old versions (see the docs <a href="https://docs.astral.sh/uv/concepts/cache/#clearing-the-cache">here</a>). The <code>--ci</code> removes all packages that were not built locally and would redownload them on next sync. I find this behavior a little strange as well, but <a href="https://docs.astral.sh/uv/concepts/cache/#caching-in-continuous-integration">their docs</a> claims it is faster to redownload from PyPi than to save and load a larger cache file to the CI server.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fenuks">@fenuks</a> on 2025-04-11 15:58</div>
            <div class="timeline-body"><p>Thank you for an answer. I use <code>uv cache prune</code> (even if getting dependencies would be faster that doing
so from cache, I think it&#x27;s better to not expose unnecessary burden on public
infrastructure such as PyPI needlessly), but it doesn&#x27;t seem to remove unused
versions from cache at all. Documentation is a bit vague, it doesn&#x27;t state exactly what is
unused entry and how it is determined. It mentions only that <code>the cache directory may contain entries created in previous uv versions that are no longer necessary and can be safely removed</code>, so I would be grateful if somebody
could confirm that uv tries also to remove unused versions of packages.</p>
<p>I&#x27;m using the latest uv version at the moment (0.6.14) with <code>UV_LINK_MODE=copy</code>
and <code>UV_CACHE_DIR=.uv-cache</code>, after updating package, <code>uv cache prune</code> leaves
both versions of it in cache. Perhaps <code>uv</code> is reluctant to remove it, because
it cannot be assumed that this cache directory isn&#x27;t used by many projects?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-04-11 18:14</div>
            <div class="timeline-body"><p>There are several different parts of the cache / ways in which a package can &quot;be&quot; cached. Which subdirs of the cache are you concerned with?</p>
<p>The prune command isn&#x27;t really current-project-aware. If you don&#x27;t pass the <code>--ci</code> flag its job is mostly to GC &quot;dangling&quot; entries in the cache that nothing <em>in the cache itself</em> references anymore. Specifically stuff in the <code>sdist-*</code> and <code>archive-*</code> dirs.</p>
<p>If you pass the <code>--ci</code> flag then we will also delete everything in the <code>wheels-*</code> dir, and most things from the <code>sdist-*</code> dir.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fenuks">@fenuks</a> on 2025-04-12 10:24</div>
            <div class="timeline-body"><blockquote>
<p>Which subdirs of the cache are you concerned with?</p>
</blockquote>
<p>From what I see, most data is stored in <code>archive-*</code>, <code>sdists-*</code>, and <code>wheels-*</code> dirs.</p>
<blockquote>
<p>The prune command isn&#x27;t really current-project-aware.</p>
</blockquote>
<p>That&#x27;s what I observed, thank you for confirmation. Having fast cache service in local network, I would like uv to allow me to clean only data of unused dependencies in current project (or perhaps many projects, with option to provide paths to multiple <code>uv.lock</code> files, in case I have few separate projects in one repository).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/Gankra">@Gankra</a> on 2025-04-14 18:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LSerranoPEReN">@LSerranoPEReN</a> on 2025-10-01 15:21</div>
            <div class="timeline-body"><p>I have a similar problem, as I also use very large machine learning libraries that take a long time to download. However, I don&#x27;t think that not pruning the heaviest libraries completely solves the problem for CI.</p>
<p>I&#x27;m using Gitlab CI and building the CI cache requires zipping all the files to be saved which takes a lot of times when you have tens of thousands of files to save. My understanding of the uv cache is that most pre-built wheels are stored unzipped, so all the files in large libraries will need to be rezipped when building the CI cache.</p>
<p>One solution to both problems could be to have the possibility to configure a directory to keep all the downloaded wheels still zipped and save that particular directory for CI cache.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:36:34 UTC
    </footer>
</body>
</html>
