<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bug: Circular dependencies at build-time cause hang without error - astral-sh/uv #10255</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Bug: Circular dependencies at build-time cause hang without error</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/10255">#10255</a>
        opened by <a href="https://github.com/CarrotManMatt">@CarrotManMatt</a>
        on 2024-12-31 16:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/CarrotManMatt">@CarrotManMatt</a> on 2024-12-31 16:47</div>
            <div class="timeline-body"><p>When a project uses a package for building that has the original project as a runtime dependency, all build/lock/sync commands hang without any message or error.</p>
<h1>Steps to reproduce</h1>
<ol>
<li>Create project <code>foo</code> with the following <code>pyproject.toml</code></li>
</ol>
<pre><code class="language-toml">[build-system]
build-backend = &quot;hatchling.build&quot;
requires = [&quot;hatchling&quot;]

[project]
name = &quot;foo&quot;
version = &quot;1.0.0&quot;
description = &quot;My package foo&quot;

[tool.hatch.build]
only-packages = true

[tool.uv]
no-binary-package = [&quot;foo&quot;]
no-build = true
package = true
trusted-publishing = &quot;always&quot;
</code></pre>
<ol start="2">
<li>Create the package <code>foo</code> within the project</li>
</ol>
<pre><code class="language-bash">mkdir foo/ &amp;&amp; touch foo/__init__.py
</code></pre>
<ol start="3">
<li>Build the project as a wheel &amp; sdist</li>
</ol>
<pre><code class="language-bash">uv build --no-sources --build
</code></pre>
<ol start="4">
<li>Publish the project to testpypi (package names will need to be changed to avoid collisions)</li>
</ol>
<pre><code class="language-bash">uv publish --publish-url https://test.pypi.org/legacy/
</code></pre>
<ol start="5">
<li>Create a new project bar with the following pyproject.toml</li>
</ol>
<pre><code class="language-toml">[build-system]
build-backend = &quot;hatchling.build&quot;
requires = [&quot;hatchling&quot;]

[project]
dependencies = [&quot;foo&quot;]
name = &quot;bar&quot;
version = &quot;2.0.0&quot;
description = &quot;My package bar (Has a dependency!)&quot;

[tool.hatch.build]
only-packages = true

[tool.uv]
no-binary-package = [&quot;foo&quot;]
no-build = true
package = true
trusted-publishing = &quot;always&quot;
</code></pre>
<ol start="6">
<li>Create the package <code>bar</code> within the project</li>
</ol>
<pre><code class="language-bash">mkdir bar/ &amp;&amp; touch bar/__init__.py
</code></pre>
<ol start="7">
<li>Build the project as a wheel only</li>
</ol>
<pre><code class="language-bash">uv build --no-sources --build --wheel
</code></pre>
<ol start="8">
<li>Publish the built wheel to testpypi (package names will need to be changed to avoid collisions)</li>
</ol>
<pre><code class="language-bash">uv publish --publish-url https://test.pypi.org/legacy/
</code></pre>
<ol start="9">
<li>Edit the <code>pyproject.toml</code> of the <code>foo</code> project</li>
</ol>
<pre><code class="language-toml">[build-system]
build-backend = &quot;hatchling.build&quot;
requires = [&quot;hatchling&quot;, &quot;bar&quot;]
</code></pre>
<ol start="10">
<li>Run the following build command on project <code>foo</code>. Compared to step 3 this will now hang indefinetly</li>
</ol>
<pre><code class="language-bash">uv build --no-sources --build
</code></pre>
<p>I think this is a regression as the build of <code>foo</code> using <code>bar</code> as a build requirement worked successfully in uv version 0.5.11, but in 0.5.13 it fails (I have not verified this however). Is there something I am missing with this kind of circular dependency not being allowed? I would expect the build dependencies to be isolated and just use the existing published wheel, rather than installing the local project (which is what i think is happening)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/10252.html">astral-sh/uv#10252</a> on 2024-12-31 16:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-31 17:11</div>
            <div class="timeline-body"><p>Hmm. Why would this work, though? Even if we install <code>bar</code> from a wheel, we still have to install its requirements, which include <code>foo</code>. I think this should probably error due to a cycle (but not hang).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">error messages</span> added by @charliermarsh on 2024-12-31 17:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CarrotManMatt">@CarrotManMatt</a> on 2024-12-31 17:53</div>
            <div class="timeline-body"><p>Gotcha, many thanks for helping out. I think I didn't fully appreciate that there was a full dependency cycle during the build stage too, due to my setup possibly being outdated with the <code>foo</code> package version.</p>
<p>A more helpful error message rather than just hanging would be appreciated for people running into this issue in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-12-31 21:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-01 01:00</div>
            <div class="timeline-body"><p>So I took the time to publish these as https://test.pypi.org/project/circular-one/ and https://test.pypi.org/project/circular-two/, and this actually works for me?</p>
<p>Specifically, this works <code>uv build --no-sources --build --index https://test.pypi.org/simple --index-strategy unsafe-best-match --verbose</code> given:</p>
<pre><code class="language-toml">[project]
name = &quot;circular-one&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
authors = [
    { name = &quot;Charlie Marsh&quot;, email = &quot;charlie.r.marsh@gmail.com&quot; }
]
requires-python = &quot;&gt;=3.13.0&quot;
dependencies = []

[build-system]
requires = [&quot;hatchling&quot;, &quot;circular-two&quot;]
build-backend = &quot;hatchling.build&quot;

[tool.hatch.build]
only-packages = true

[tool.uv]
no-binary-package = [&quot;circular-one&quot;]
no-build = true
package = true
trusted-publishing = &quot;always&quot;
</code></pre>
<p>My guess is it might fail if I re-publish with:</p>
<pre><code class="language-toml">[build-system]
requires = [&quot;hatchling&quot;, &quot;circular-two&quot;]
build-backend = &quot;hatchling.build&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-01 01:01</div>
            <div class="timeline-body"><p>Okay yeah, once I re-publish to create the circular dependency, it deadlocks as expected.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-01 01:13</div>
            <div class="timeline-body"><p>Notably, <code>pypa/build</code> also fails here: <code>PIP_NO_BINARY=circular-one PIP_EXTRA_INDEX_URL=https://test.pypi.org/simple python3.13 -m build</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/10258.html">astral-sh/uv#10258</a> on 2025-01-01 02:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-01-01 03:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-01-01 03:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CarrotManMatt">@CarrotManMatt</a> on 2025-01-01 14:21</div>
            <div class="timeline-body"><p>Amazing, thank you so much! For improving the error messages!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:25 UTC
    </footer>
</body>
</html>
