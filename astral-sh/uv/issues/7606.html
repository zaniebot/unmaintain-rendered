<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> v0.4.14 seems to have resolver issues - astral-sh/uv #7606</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>v0.4.14 seems to have resolver issues</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/7606">#7606</a>
        opened by <a href="https://github.com/stas00">@stas00</a>
        on 2024-09-20 22:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/stas00">@stas00</a></div>
            <div class="timeline-body"><p>our <code>uv pip compile -v setup.py  --extra replug</code> has just started failing on CI once <code>uv</code> has been updated:</p>
<pre><code>  × No solution found when resolving dependencies:
  ╰─▶ Because nmslib==2.1.1 depends on numpy&gt;=1.10.0,&lt;1.17 and only nmslib&lt;=2.1.1 is available, we can conclude that nmslib&gt;=2.1.1
      depends on numpy&gt;=1.10.0,&lt;1.17.
      And because pyserini==0.23.0 depends on numpy&gt;=1.18.1, we can conclude that nmslib&gt;=2.1.1 and pyserini==0.23.0 are incompatible.
      And because pyserini==0.23.0 depends on nmslib&gt;=2.1.1 and dawn depends on pyserini==0.23.0, we can conclude that your requirements
      are unsatisfiable.
</code></pre>
<p>The parser seems to be getting the requirements wrong, because:</p>
<pre><code>$ git clone https://github.com/nmslib
$ cd nmslib
$ git checkout v2.1.1
$ grep -Ir &quot;&lt;1\.17&quot;
python_bindings/setup.py:dep_list.append(&quot;numpy&gt;=1.10.0,&lt;1.17 ; python_version==&#x27;2.7&#x27;&quot;)
</code></pre>
<p>but I&#x27;m running py3.10</p>
<p>an easier way to repro is to just run:</p>
<pre><code>$ uv pip install nmslib==2.1.1
Resolved 4 packages in 152ms
error: Failed to prepare distributions
  Caused by: Failed to fetch wheel: numpy==1.16.6
  Caused by: Build backend failed to build wheel through `build_wheel()` with exit status: 1
--- stdout:

--- stderr:
Running from numpy source directory.
/data/env/cache/uv/sdists-v4/pypi/numpy/1.16.6/YYsNUdkR_MaadjuXSLKgQ/numpy-1.16.6.zip/numpy/distutils/misc_util.py:476: SyntaxWarning: &quot;is&quot; with a literal. Did you mean &quot;==&quot;?
  return is_string(s) and (&#x27;*&#x27; in s or &#x27;?&#x27; is s)
Traceback (most recent call last):
  File &quot;&lt;string&gt;&quot;, line 11, in &lt;module&gt;
  File &quot;/env/cache/uv/builds-v0/.tmpEg6RuR/lib/python3.10/site-packages/setuptools/build_meta.py&quot;, line 421, in build_wheel
    return self._build_with_temp_dir(
  File &quot;/env/cache/uv/builds-v0/.tmpEg6RuR/lib/python3.10/site-packages/setuptools/build_meta.py&quot;, line 403, in _build_with_temp_dir
    self.run_setup()
  File &quot;/env/cache/uv/builds-v0/.tmpEg6RuR/lib/python3.10/site-packages/setuptools/build_meta.py&quot;, line 503, in run_setup
    super().run_setup(setup_script=setup_script)
  File &quot;/env/cache/uv/builds-v0/.tmpEg6RuR/lib/python3.10/site-packages/setuptools/build_meta.py&quot;, line 318, in run_setup
    exec(code, locals())
  File &quot;&lt;string&gt;&quot;, line 419, in &lt;module&gt;
  File &quot;&lt;string&gt;&quot;, line 398, in setup_package
  File &quot;/data/env/cache/uv/sdists-v4/pypi/numpy/1.16.6/YYsNUdkR_MaadjuXSLKgQ/numpy-1.16.6.zip/numpy/distutils/core.py&quot;, line 26, in &lt;module&gt;
    from numpy.distutils.command import config, config_compiler, \
  File &quot;/data/env/cache/uv/sdists-v4/pypi/numpy/1.16.6/YYsNUdkR_MaadjuXSLKgQ/numpy-1.16.6.zip/numpy/distutils/command/config.py&quot;, line 19, in &lt;module&gt;
    from numpy.distutils.mingw32ccompiler import generate_manifest
  File &quot;/data/env/cache/uv/sdists-v4/pypi/numpy/1.16.6/YYsNUdkR_MaadjuXSLKgQ/numpy-1.16.6.zip/numpy/distutils/mingw32ccompiler.py&quot;, line 34, in &lt;module&gt;
    from distutils.msvccompiler import get_build_version as get_build_msvc_version
ModuleNotFoundError: No module named &#x27;distutils.msvccompiler&#x27;
---
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stas00">@stas00</a> on 2024-09-20 22:55</div>
            <div class="timeline-body"><p><a href="https://github.com/astral-sh/uv/releases/tag/0.4.13">0.4.13</a> also has an issue</p>
<pre><code>uv pip install uv==0.4.13
uv pip install nmslib==2.1.1
</code></pre>
<p>same error as the end of the OP</p>
<p>I didn&#x27;t check them all but <code>uv==0.4.0</code> works fine.</p>
<p>The correct resolution should be <code>numpy&gt;=1.10.0</code> for py3.10 for <code>nmslib==2.1.1</code></p>
<pre><code>$ uv pip install uv==0.4.0
Resolved 1 package in 122ms
Prepared 1 package in 396ms
Uninstalled 1 package in 51ms
Installed 1 package in 125ms
 - uv==0.4.13
 + uv==0.4.0

$ uv pip install  nmslib==2.1.1
Resolved 4 packages in 322ms
Installed 1 package in 1.05s
 + nmslib==2.1.1
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stas00">@stas00</a> on 2024-09-20 23:01</div>
            <div class="timeline-body"><p>The actual dependency I need to satisfy is <code>pyserini==0.23.0</code>, which pulls in <code>nmslib</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-21 02:43</div>
            <div class="timeline-body"><p>Sorry struggling to reproduce this, am I doing something wrong?</p>
<pre><code>❯ echo &quot;nmslib==2.1.1&quot; | uvx uv@0.4.14 pip compile - --python-platform linux --python 3.10
Resolved 4 packages in 3ms
# This file was autogenerated by uv via the following command:
#    uv pip compile - --python-platform linux --python 3.10
nmslib==2.1.1
numpy==2.1.1
    # via nmslib
psutil==6.0.0
    # via nmslib
pybind11==2.6.1
    # via nmslib
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stas00">@stas00</a> on 2024-09-21 02:48</div>
            <div class="timeline-body"><p>indeed, seems to be fine alone:</p>
<pre><code>$ echo &quot;nmslib==2.1.1&quot; | uv pip compile - --python-platform linux --python 3.10
Resolved 4 packages in 245ms
# This file was autogenerated by uv via the following command:
#    uv pip compile - --python-platform linux --python 3.10
nmslib==2.1.1
numpy==1.16.6
    # via nmslib
psutil==6.0.0
    # via nmslib
pybind11==2.6.1
    # via nmslib
</code></pre>
<p>now let&#x27;s try with the actual package that I depend on:</p>
<pre><code>$ echo &quot;pyserini==0.23.0&quot; | uv pip compile - --python-platform linux --python 3.10
  × No solution found when resolving dependencies:
  ╰─▶ Because nmslib==2.1.1 depends on numpy&gt;=1.10.0,&lt;1.17 and only nmslib&lt;=2.1.1 is available, we can conclude that nmslib&gt;=2.1.1 depends
      on numpy&gt;=1.10.0,&lt;1.17.
      And because pyserini==0.23.0 depends on numpy&gt;=1.18.1, we can conclude that nmslib&gt;=2.1.1 and pyserini==0.23.0 are incompatible.
      And because pyserini==0.23.0 depends on nmslib&gt;=2.1.1 and you require pyserini==0.23.0, we can conclude that your requirements are
      unsatisfiable.
</code></pre>
<p>that <code>numpy&gt;=1.10.0,&lt;1.17</code> dependency is the trigger, and it should be <code>numpy&gt;=1.10.0</code> instead.</p>
<p>By looking at the source code of these repos - the only suspect to where <code>&lt;1.17</code> may have come from I think is:</p>
<pre><code>$ git clone https://github.com/nmslib
$ cd nmslib
$ git checkout v2.1.1
$ grep -Ir &quot;&lt;1\.17&quot;
python_bindings/setup.py:dep_list.append(&quot;numpy&gt;=1.10.0,&lt;1.17 ; python_version==&#x27;2.7&#x27;&quot;)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-21 03:24</div>
            <div class="timeline-body"><p>Looks like this regressed in 0.4.13</p>
<pre><code>❯ echo &quot;pyserini==0.23.0&quot; | uvx uv@0.4.13 pip compile - --python-platform linux --python 3.10
Installed 1 package in 6ms
  × No solution found when resolving dependencies:
  ╰─▶ Because nmslib==2.1.1 depends on numpy&gt;=1.10.0,&lt;1.17 and only nmslib&lt;=2.1.1 is available, we can conclude that nmslib&gt;=2.1.1 depends on
      numpy&gt;=1.10.0,&lt;1.17.
      And because pyserini==0.23.0 depends on numpy&gt;=1.18.1, we can conclude that nmslib&gt;=2.1.1 and pyserini==0.23.0 are incompatible.
      And because pyserini==0.23.0 depends on nmslib&gt;=2.1.1 and you require pyserini==0.23.0, we can conclude that your requirements are unsatisfiable.
      
❯ echo &quot;pyserini==0.23.0&quot; | uvx uv@0.4.12 pip compile - --python-platform linux --python 3.10
Resolved 83 packages in 27ms
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-21 03:29</div>
            <div class="timeline-body"><p>Unfortunately this was caused by 18c18b84066406fa6b6b9864d561eb5e64bbf476 (#7556) which we thought just affected error messages. Reverting the commit causes resolution to succeed.</p>
<p>cc @charliermarsh</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-21 12:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-21 12:35</div>
            <div class="timeline-body"><p>I&#x27;ll do a release real-quick to get this revert out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-21 12:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-21 17:39</div>
            <div class="timeline-body"><p>Okay, I think the root problem here is that <code>nmslib</code> has inconsistent metadata across wheels... So <a href="https://files.pythonhosted.org/packages/8e/95/d8c595464322fafe539cba88457159c70d9d66c6877602343e0c7651fcdb/nmslib-2.1.1-cp39-cp39-manylinux2014_aarch64.whl.metadata">some</a> of the wheels contain:</p>
<pre><code>Requires-Dist: numpy (&lt;1.17,&gt;=1.10.0) ; python_version == &quot;2.7&quot;
Requires-Dist: numpy (&gt;=1.10.0) ; python_version &gt;= &quot;3.5&quot;
</code></pre>
<p>And we succeed in that case.</p>
<p><a href="https://files.pythonhosted.org/packages/15/97/6f7f05cf605601426664ccf665d235a0d20875e606e32ca87496f66b71ce/nmslib-2.1.1-cp35-cp35m-macosx_10_14_x86_64.whl.metadata">Others</a> contain this definition, which looks like a mistake:</p>
<pre><code>Requires-Dist: numpy (&lt;1.17,&gt;=1.10.0)
Requires-Dist: numpy (&gt;=1.10.0)
</code></pre>
<p>If we can&#x27;t find a valid wheel for a dependency, we&#x27;ll still read metadata from an incompatible wheel. The change I made was actually fine, it that it started preferring different incompatible wheels than before (wheels that are closer to being compatible). But I guess we were just lucky before that we got the &quot;good&quot; metadata vs. the &quot;bad&quot; metadata here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-21 17:44</div>
            <div class="timeline-body"><p>I created an issue here: <a href="https://github.com/nmslib/nmslib/issues/558">nmslib/nmslib#558</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stas00">@stas00</a> on 2024-09-21 18:43</div>
            <div class="timeline-body"><p>Thank you for getting to the root of it, Charlie.</p>
<p>Yes, their last released package is many years old. I&#x27;m asking already to get a new source release made, but it appears to be far from trivial according to the owner. Not sure what to do. <a href="https://github.com/castorini/pyserini/issues/1985">castorini/pyserini#1985</a></p>
<p>Thank you for flagging this issue to the owner of that package, Charlie.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-21 18:50</div>
            <div class="timeline-body"><p>No problem. The other thing we could do is curate a list of &quot;rejected&quot; wheels in uv itself... That feels wrong and I&#x27;d prefer to avoid it, but we may be forced into it eventually.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stas00">@stas00</a> on 2024-09-21 19:05</div>
            <div class="timeline-body"><p>That would require a lot of unnecessary maintenance work on your part. I wonder if <code>uv</code> falling back to <code>pip</code> on failure would be a sufficient workaround. Like having a new flag, <code>--fallback-to-pip-on-failure</code>, which would require <code>pip</code> to be installed (assuming pip has a more relaxed/less precise resolver) e.g. often when using conda I had to fall back to pip because conda was super anal about some dependency situations and pip saved the day and everything worked just fine.)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:34:14 UTC
    </footer>
</body>
</html>
