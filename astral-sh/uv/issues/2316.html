<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UV finds PyPy when looking for Python - astral-sh/uv #2316</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>UV finds PyPy when looking for Python</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/2316">#2316</a>
        opened by <a href="https://github.com/henryiii">@henryiii</a>
        on 2024-03-09 05:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/henryiii">@henryiii</a> on 2024-03-09 05:37</div>
            <div class="timeline-body"><p>If you have both CPython and PyPy installed, it seems like <code>uv</code> can find the wrong one when you ask for <code>-p python3.7</code> (up to 3.10, since that's the highest version of PyPy):</p>
<pre><code>nox &gt; Command C:\Program Files (x86)\pipx\venvs\nox\Scripts\uv.exe venv -p python3.7 'D:\a\nox\nox\.nox\github_actions_all_tests-3-7' failed with exit code 1:
Using Python 3.7.13 interpreter at: C:\hostedtoolcache\windows\PyPy\3.7.13\x86\python3.7.exe
Creating virtualenv at: D:\a\nox\nox\.nox\github_actions_all_tests-3-7
uv::venv::creation

  � Failed to create virtualenv
  \u251c\u2500\u25b6 failed to copy file from
  \u2502   \\?\C:\hostedtoolcache\windows\PyPy\3.7.13\x86\venvwlauncher.exe to
  \u2502   \\?\D:\a\nox\nox\.nox\github_actions_all_tests-3-7\Scripts\python.exe
  \u2570\u2500\u25b6 The system cannot find the file specified. (os error 2)
</code></pre>
<p>Virutalenv finds the correct one. This happens on GitHub Actions in https://github.com/wntrblm/nox/actions/runs/8209739709/job/22455867659?pr=799, only tried Windows - https://github.com/wntrblm/nox/pull/799.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-09 12:47</div>
            <div class="timeline-body"><p>Is this &quot;wrong&quot;? We have two <code>python3.7.exe</code> binaries, but I guess the argument is that we should break ties in favor of CPython?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-09 13:05</div>
            <div class="timeline-body"><p>Does it work as expected if you install Python 3.7 in the <code>setup-python</code> step (but not PyPy)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-03-09 13:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">pypy</span> added by @charliermarsh on 2024-03-09 13:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2024-03-09 17:20</div>
            <div class="timeline-body"><p>python3.7 should not find pypy3.7. Some installs of PyPy (like GitHub Actions) include a &quot;compatibility&quot; python3.7 executable so that if it is &quot;activated&quot;, then &quot;python&quot; works, but it shouldn't be discovered if you ask for <code>python3.7</code>, only <code>pypy3.7</code>.</p>
<p>I believe we are making <code>3.7-3.12, pypy3.9, pypy3.10</code> (don't remember the exact syntax for multiple activations in one step, it's something like that) available by setup-python, and are ~~not explicitly listing pypy3.7~~, but it's still finding it. (Which is also wrong for 3.9 and 3.10, we are not looking for pypy if we ask for <code>python</code>!)</p>
<p>Maybe the rule could be if <code>python*</code> is accompanied by <code>pypy*</code>, then it's really pypy and the python shims should be ignored?</p>
<p>Might be worth checking how virtualenv does this, as it handles it correctly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2024-03-09 17:21</div>
            <div class="timeline-body"><p>Correction: Yes, we are activating everything: https://github.com/wntrblm/nox/blob/08813c3c6b0d2171c280bbfcf219d089a16d1ac2/.github/workflows/action.yml#L44</p>
<p>It's just the default that was pypy3.9 and pypy3.10, but we override it for our tests.</p>
<p>Note that that field gets transformed before it is fed to setup-python, since we supported activating multiple Pythons before the official action supported it, and our syntax was slightly different.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-09 17:34</div>
            <div class="timeline-body"><p>Ok, this makes sense. I wasn’t really familiar with how PyPy is typically used / executed. Shouldn’t be too hard to fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-09 17:36</div>
            <div class="timeline-body"><p>What about when a user does “—python 3.7”? In that case, we probably <em>do</em> need to allow PyPy?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2024-03-09 17:43</div>
            <div class="timeline-body"><p>Generally PyPy is a special case and you should be explicitly asking for it. It isn’t a drop in replacement for CPython due to the fact many libraries don’t support it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2024-03-09 17:45</div>
            <div class="timeline-body"><p>I think virtualenv, tox, nox all require PyPy in the search to include PyPy. Setup-Python too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-09 19:19</div>
            <div class="timeline-body"><p>Sounds good, this is helpful, thanks Henry. I’ll change it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/2092.html">astral-sh/uv#2092</a> on 2024-03-09 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-03-10 00:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-10 03:23</div>
            <div class="timeline-body"><p>I can think of two approaches:</p>
<ol>
<li>Always filter out <code>pypy</code> unless the search includes <code>pypy</code> (e.g., <code>--python pypy37</code>).</li>
<li>When given a query like <code>python37</code>, first search excluding <code>pypy</code>; if nothing is found, search including <code>pypy</code>.</li>
</ol>
<p>Neither of these would apply when in a PyPy virtual environment, since in that case, we <em>do</em> want to find the <code>python</code> shims.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-10 03:24</div>
            <div class="timeline-body"><p>The questions would be:</p>
<ul>
<li>Should <code>--python python37</code> <em>ever</em> return PyPy? Like, if it's the only Python installed, should it be returned?</li>
<li>Should <code>--python 3.7</code> <em>ever</em> return PyPy?</li>
</ul>
<p>I would probably start by only matching PyPy if the user is explicit, e.g., the <code>--python pypy37</code> case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2024-03-10 04:22</div>
            <div class="timeline-body"><p>I’d say no. PyPy should only match if you ask for PyPy. But @gaborbernat would have more experience and good advice here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on 2024-03-10 04:49</div>
            <div class="timeline-body"><blockquote>
<ul>
<li>Should <code>--python python37</code> <em>ever</em> return PyPy? Like, if it's the only Python installed, should it be returned?</li>
</ul>
</blockquote>
<p>Yes.</p>
<blockquote>
<ul>
<li>Should <code>--python 3.7</code> <em>ever</em> return PyPy?</li>
</ul>
<p>I would probably start by only matching PyPy if the user is explicit, e.g., the <code>--python pypy37</code> case.</p>
</blockquote>
<p>Yes, if no other python is present.</p>
<p>The way I interpret it, python or the lack of the implementation basically translates to any implementation. However for historical reasons if multiple implementations are available cpython wins.</p>
<p>This is what virtualenv does.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2024-03-10 05:23</div>
            <div class="timeline-body"><p>Is <code>--python cpython37</code> valid? I've never specified that. A lot of packages don't support pypy.</p>
<blockquote>
<p>if multiple implementations are available cpython wins. This is what virtualenv does.</p>
</blockquote>
<p>I've never had pypy without cpython I guess. Matching virtualenv is fine.</p>
<p>So <code>py38, pypy38</code> (tox) or <code>&quot;3.8&quot;, &quot;pypy3.8&quot;</code> (nox) may actually match pypy twice if CPython is missing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on 2024-03-10 05:27</div>
            <div class="timeline-body"><blockquote>
<p>Is <code>--python cpython37</code> valid? I've never specified that. A lot of packages don't support pypy.</p>
</blockquote>
<p>Yes.</p>
<blockquote>
<p>So <code>py38, pypy38</code> (tox) or <code>&quot;3.8&quot;, &quot;pypy3.8&quot;</code> (nox) may actually match pypy twice if CPython is missing?</p>
</blockquote>
<p>Yes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2024-03-10 05:52</div>
            <div class="timeline-body"><p>Wow, thanks! Okay, so I think just matching virtualenv's CPython preference would be fine here. And I might start using &quot;cpython&quot;. Need to check and see if that's supported everywhere in nox. :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../john-kurkowski/tldextract/pulls/324.html">john-kurkowski/tldextract#324</a> on 2024-03-11 02:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/2386.html">astral-sh/uv#2386</a> on 2024-03-12 17:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-05-22 14:54</div>
            <div class="timeline-body"><p>As of #3266 and #3706 we will discover all Python interpreters without regard for the implementation by default but allow opt-in to selecting only <code>cpython</code> or <code>pypy</code> implementations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-05-22 14:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2024-05-23 05:35</div>
            <div class="timeline-body"><p>I still believe cpython should be chosen over pypy if there's a tie. It is very, very unlikely that PyPy is expected unless a user asked for PyPy, or if there is no matching CPython version. PyPy is not a drop in replacement for Python when it comes to packages; packages that provide wheels for CPython often have to build on PyPy if they are supported at all. This is also true for other implementations, I assume you'd at least be adding support for GraalPy soon, and again I think it should be opt-in unless it's the only matching interpreter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-05-23 13:13</div>
            <div class="timeline-body"><p>@henryiii What does a tie mean? One has to come before the other in the PATH, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-05-23 13:15</div>
            <div class="timeline-body"><p>I'm pretty hesitant to do the approach where we search for <em>any</em> CPython interpreter then fall back to other implementations like PyPy in a second search.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2024-05-23 16:17</div>
            <div class="timeline-body"><p>My issue is that setting up multiple versions of Python:</p>
<pre><code class="language-yaml">- uses: actions/setup-python@v5
  with:
    python-version: |
      3.10
      3.11
      3.12
      pypy3.10
</code></pre>
<p>Then running nox, build, or whatever requesting &quot;3.10&quot; may run pypy twice, getting pypy when requesting <code>3.10</code>. Virtualenv does this, selecting CPython over PyPy if both are found.</p>
<pre><code class="language-python">@nox.session(
    python=[
        &quot;3.10&quot;,
        &quot;3.11&quot;,
        &quot;3.12&quot;,
        &quot;pypy3.10&quot;,
    ]
)
...
</code></pre>
<p>This also affects PEP 723, if you write:</p>
<pre><code class="language-python"># /// script
# requires-python = &quot;3.10.*&quot;
# requires = [&quot;numpy&quot;]
# ///
</code></pre>
<p>This will either take several minutes to build or more likely fail if PyPy is selected, since numpy doesn't provide PyPy 3.10 wheels. (I'm not sure if they ever plan to, they claim PyPy is going away in the coming months)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:18 UTC
    </footer>
</body>
</html>
