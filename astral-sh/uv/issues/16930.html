<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv-resolver stack overflow on ARM required-environments - astral-sh/uv #16930</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv-resolver stack overflow on ARM required-environments</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/16930">#16930</a>
        opened by <a href="https://github.com/Oblynx">@Oblynx</a>
        on 2025-12-02 13:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Oblynx">@Oblynx</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I have a uv workspace project. In my project, I declare:</p>
<pre><code>[tool.uv]
# Ensure resolution for supported environments
required-environments = [
    &quot;sys_platform == 'linux' and platform_machine == 'x86_64'&quot;,
]
</code></pre>
<p>and <code>uv lock</code> successfully compiles the dependencies.</p>
<p>However, if I switch to <strong>aarch64</strong>, there's a stack overflow:</p>
<ul>
<li><code>sys_platform == 'linux' and platform_machine == 'x86_64'</code> =&gt; 游릭</li>
<li><code>sys_platform == 'linux' and platform_machine == 'aarch64'</code>=&gt; 游댮</li>
<li><code>sys_platform == 'darwin' and platform_machine == 'arm64'</code> =&gt; 游릭</li>
<li><code>sys_platform == 'win32' and platform_machine == 'AMD64'</code>  =&gt; 游댮</li>
</ul>
<p>Values that AFAIK shouldn't mean anything actually work:</p>
<ul>
<li><code>sys_platform == 'linux' and platform_machine == 'HELLO'</code>  =&gt; 游릭</li>
<li><code>sys_platform == 'linux' and platform_machine == 'arm64'</code>  =&gt; 游릭</li>
</ul>
<p>Also note that the same values in <code>environments</code> (instead of <code>required-environments</code>) work as well.</p>
<h3>Logs</h3>
<p>Note that I set the env var <code>UV_EXTRA_INDEX_URL</code>.</p>
<pre><code>[tool.uv]
required-environments = [
    &quot;sys_platform == 'linux' and platform_machine == 'aarch64'&quot;,
]
</code></pre>
<p>Depending on the combination of environments and required-environments, the logs change.</p>
<pre><code>DEBUG Found fresh response for: https://gitlab.com/api/v4/groups/106570154/-/packages/pypi/simple/send2trash/
DEBUG Searching for a compatible version of cadquery{platform_machine == 'x86_64'} (&gt;=2.5.2, &lt;2.6.dev0)
DEBUG Selecting: cadquery==2.5.2 [preference] (cadquery-2.5.2-py3-none-any.whl)
DEBUG Found fresh response for: https://gitlab.com/api/v4/groups/106570154/-/packages/pypi/simple/sqlalchemy/
DEBUG Adding transitive dependency for cadquery==2.5.2: cadquery==2.5.2
DEBUG Adding transitive dependency for cadquery==2.5.2: cadquery{platform_machine == 'x86_64'}==2.5.2
DEBUG Searching for a compatible version of cadquery (==2.5.2)
DEBUG Selecting: cadquery==2.5.2 [preference] (cadquery-2.5.2-py3-none-any.whl)
DEBUG Adding transitive dependency for cadquery==2.5.2: cadquery-ocp&gt;=7.7.0, &lt;7.8
...
DEBUG Searching for a compatible version of cadquery-ocp{platform_machine == 'x86_64'} (&gt;=7.7.2.2b2, &lt;7.7.3.dev0)
DEBUG Found fresh response for: https://gitlab.com/api/v4/groups/106570154/-/packages/pypi/simple/werkzeug/
...
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/7c/50/11c9ee1ede64b45d687fd36eb8768dafc57afc78b4d83396920cfd69ed30/path-17.1.1-py3-none-any.whl.metadata

thread 'uv-resolver' (30456) has overflowed its stack
fatal runtime error: stack overflow, aborting
Aborted (core dumped)
</code></pre>
<h3>Platform</h3>
<p>ubuntu 24.04 x86_64</p>
<h3>Version</h3>
<p>uv 0.9.13</p>
<h3>Python version</h3>
<p>Python 3.11.14</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @Oblynx on 2025-12-02 13:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @konstin on 2025-12-02 13:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-12-02 13:41</div>
            <div class="timeline-body"><p>Can you provide a set of dependencies that reproduces this problem? We haven't seen this crash before, so otherwise I wouldn't know how to reproduce it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Oblynx">@Oblynx</a> on 2025-12-02 13:42</div>
            <div class="timeline-body"><p>You believe that it's dependency specific?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-12-02 13:44</div>
            <div class="timeline-body"><p>Yes, we know that <code>sys_platform == 'linux' and platform_machine == 'aarch64'</code> works in other configurations, we even have forms of this marker (normalized to <code>platform_machine == 'aarch64' and sys_platform == 'linux'</code>) in our test suite, there needs to be something specific about the dependency structure for it to fail this way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Oblynx">@Oblynx</a> on 2025-12-02 13:56</div>
            <div class="timeline-body"><p>Here's the set of package constraints I had to remove for the resolution to succeed (+ delete the existing uv.lock):</p>
<pre><code>-    &quot;vtk~=9.2.6&quot;,
-    &quot;pyacvd&quot;,
-    &quot;cadquery~=2.5.2 ; platform_machine == 'x86_64'&quot;,
-    &quot;cadquery-ocp~=7.7.2.2b2; platform_machine == 'x86_64'&quot;,
</code></pre>
<p>Each of these packages causes the crash.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Oblynx">@Oblynx</a> on 2025-12-02 14:00</div>
            <div class="timeline-body"><p>Interestingly, if I make a minimal project with just these dependencies, I don't see the crash.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:33:34 UTC
    </footer>
</body>
</html>
