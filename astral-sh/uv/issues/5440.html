<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consider using `dunce` for paths on Windows (not just for display) - astral-sh/uv #5440</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Consider using `dunce` for paths on Windows (not just for display)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/5440">#5440</a>
        opened by <a href="https://github.com/paveldikov">@paveldikov</a>
        on 2024-07-25 10:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/paveldikov">@paveldikov</a> on 2024-07-25 10:56</div>
            <div class="timeline-body"><p><em>As originally mentioned in https://github.com/astral-sh/uv/issues/1491#issuecomment-2247703908</em></p>
<p>Consider the scenario where the Python interpreter is distributed via a network share path. e.g. <code>\\some-host\some-share\...\python.exe</code>. Obviously this is not very common but the same sort of path notation can be used for local disk drives, e.g. <code>\\localhost\c$\</code> -- which is what I use for this reproducer:</p>
<pre><code>$ uv venv --python &quot;//localhost/c$/Program Files/Python310/python.exe&quot; test310
Using Python 3.10.11 interpreter at: \\localhost\c$\Program Files\Python310\python.exe
Creating virtualenv at: test310
Activate with: source test310\Scripts\activate
$ cat test310/pyvenv.cfg
home = \\?\UNC\localhost\c$\Program Files\Python310
implementation = CPython
uv = 0.2.29
version_info = 3.10.11
include-system-site-packages = false
$ test310/Scripts/python.exe
Python 3.10.11 (tags/v3.10.11:7d4cc5a, Apr  5 2023, 00:38:17) [MSC v.1929 64 bit (AMD64)] on win32
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import sqlite3
Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
  File &quot;\\?\UNC\localhost\c$\Program Files\Python310\lib\sqlite3\__init__.py&quot;, line 57, in &lt;module&gt;
    from sqlite3.dbapi2 import *
  File &quot;\\?\UNC\localhost\c$\Program Files\Python310\lib\sqlite3\dbapi2.py&quot;, line 27, in &lt;module&gt;
    from _sqlite3 import *
ImportError: DLL load failed while importing _sqlite3: The parameter is incorrect.
</code></pre>
<p><code>dunce</code>'ing the path by hand in <code>pyvenv.cfg</code> fixes it for me:</p>
<pre><code>$ cat test310/pyvenv.cfg
home = \\localhost\c$\Program Files\Python310
implementation = CPython
uv = 0.2.29
version_info = 3.10.11
include-system-site-packages = false
$ test310/Scripts/python.exe
Python 3.10.11 (tags/v3.10.11:7d4cc5a, Apr  5 2023, 00:38:17) [MSC v.1929 64 bit (AMD64)] on win32
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import sqlite3
&gt;&gt;&gt; sqlite3
&lt;module 'sqlite3' from '\\\\localhost\\c$\\Program Files\\Python310\\lib\\sqlite3\\__init__.py'&gt;
</code></pre>
<p>This issue is reproducible with 3.10.11, but not 3.11. (presumably this bad handling of UNC paths got fixed in CPython down the line?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-07-25 13:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-07-25 13:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-25 13:48</div>
            <div class="timeline-body"><p>Hmm, the values in <code>pyvenv</code> already go through dunce: https://github.com/astral-sh/uv/blob/375a4152fa0d9359ea1f338e8345a5281bf795b2/crates/uv-virtualenv/src/virtualenv.rs#L316</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-25 13:49</div>
            <div class="timeline-body"><p>Can you test a debug build if I push a branch?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-25 13:50</div>
            <div class="timeline-body"><p>My only guess is that we need to avoid calling the non-safe <code>canonicalize</code> on the excecutable in the first place (e.g., change <code>canonicalize_executable</code> to use <code>path.simple_canonicalize()</code> instead of <code>fs_err::canonicalize(path)</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2024-07-25 14:01</div>
            <div class="timeline-body"><blockquote>
<p>Can you test a debug build if I push a branch?</p>
</blockquote>
<p>Happy to test.</p>
<blockquote>
<p>My only guess is that we need to avoid calling the non-safe canonicalize on the excecutable in the first place (e.g., change canonicalize_executable to use path.simple_canonicalize() instead of fs_err::canonicalize(path).</p>
</blockquote>
<p>Yeah, and I wonder if this will actually make the code <em>simpler</em>? (assuming that this is going to be a near-total revert of #1086. If so, win-win!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-25 15:00</div>
            <div class="timeline-body"><p>Can we try https://github.com/astral-sh/uv/pull/5446 to start, see if the venv is any different?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2024-07-25 15:30</div>
            <div class="timeline-body"><p>No change.</p>
<pre><code>$ cargo run -- venv --python &quot;//localhost/c$/Program Files/Python310/python.exe&quot; test310
Using Python 3.10.11 interpreter at: \\localhost\c$\Program Files\Python310\python.exe
Creating virtualenv at: test310
Activate with: source test310\Scripts\activate
$ cat test310/pyvenv.cfg
home = \\?\UNC\localhost\c$\Program Files\Python310
implementation = CPython
uv = 0.2.29
version_info = 3.10.11
include-system-site-packages = false
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-25 15:47</div>
            <div class="timeline-body"><p>Can you try with the update I just pushed? Trying to understand where the prefix is coming from, confused.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2024-07-25 16:15</div>
            <div class="timeline-body"><pre><code>$ cargo run -- venv --python &quot;//localhost/c$/Program Files/Python310/python.exe&quot; test310
     Running `target\debug\uv.exe venv --python '//localhost/c$/Program Files/Python310/python.exe' test310`
Using Python 3.10.11 interpreter at: \\localhost\c$\Program Files\Python310\python.exe
Creating virtualenv at: test310
base_python: &quot;\\\\?\\UNC\\localhost\\c$\\Program Files\\Python310\\python.exe&quot;
sys_executable: &quot;\\\\localhost\\c$\\Program Files\\Python310\\python.exe&quot;
sys_base_executable: Some(&quot;\\\\localhost\\c$\\Program Files\\Python310\\python.exe&quot;)
Activate with: source test310\Scripts\activate
</code></pre>
<p>pyvenv.cfg unchanged</p>
<pre><code>$ cat test310/pyvenv.cfg
home = \\?\UNC\localhost\c$\Program Files\Python310
implementation = CPython
uv = 0.2.29
version_info = 3.10.11
include-system-site-packages = false
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-25 16:20</div>
            <div class="timeline-body"><p>My guess is that this path is actually <em>not</em> safe to strip though I'm not intimately familiar with the rules:</p>
<pre><code class="language-rust">fn is_safe_to_strip_unc(path: &amp;Path) -&gt; bool {
    let mut components = path.components();
    match components.next() {
        Some(Component::Prefix(p)) =&gt; match p.kind() {
            Prefix::VerbatimDisk(..) =&gt; {},
            _ =&gt; return false, // Other kinds of UNC paths
        },
        _ =&gt; return false, // relative or empty
    }

    for component in components {
        match component {
            Component::RootDir =&gt; {},
            Component::Normal(file_name) =&gt; {
                // it doesn't allocate in most cases,
                // and checks are interested only in the ASCII subset, so lossy is fine
                if !is_valid_filename(file_name) || is_reserved(file_name) {
                    return false;
                }
            }
            _ =&gt; return false, // UNC paths take things like &quot;..&quot; literally
        };
    }

    if windows_char_len(path.as_os_str()) &gt; 260 { // However, if the path is going to be used as a directory it's 248
        return false;
    }
    true
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-25 16:23</div>
            <div class="timeline-body"><p>Will look deeper when I can, but need to prioritize a few other things first today. Sorry!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2024-07-25 16:30</div>
            <div class="timeline-body"><p>No worries!</p>
<p>Judging from the log lines it must be safe to strip in at least some contexts:</p>
<pre><code>sys_executable: &quot;\\\\localhost\\c$\\Program Files\\Python310\\python.exe&quot;
sys_base_executable: Some(&quot;\\\\localhost\\c$\\Program Files\\Python310\\python.exe&quot;)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-25 16:33</div>
            <div class="timeline-body"><p>I think that's the original, unmodified path we get from <code>sys.executable</code> in Python. Then we pass it to <code>uv_fs::canonicalize_executable(interpreter.sys_executable())</code> to get <code>base_python</code>... which adds the prefix, which dunce then tries to strip if it can (but seemingly can't).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2024-07-25 17:35</div>
            <div class="timeline-body"><p>Naive question: do we really need to canonicalise on Windows? (we aren't following symlinks as we are on Linux)</p>
<p>Comment in code says:</p>
<blockquote>
<p>We canonicalize the path to ensure that it's real and consistent, though we don't expect any symlinks on Windows.</p>
</blockquote>
<p>We generally know that it's <em>real</em> beforehand -- though perhaps not 'real' in the POSIX sense. See the <code>Using Python .... interpreter at:</code> printout (although this happens in a very different place in the control flow)</p>
<p>Also perhaps it's something to do with the dollar sign? I am in the predicament of trying to replicate this issue in my home environment and I don't really happen to have network shares laying around :-/ so I thought I'd fake this by using this notation on my C: drive...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-25 17:41</div>
            <div class="timeline-body"><p>Hmm. We <em>probably</em> don't.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2024-07-25 17:50</div>
            <div class="timeline-body"><p>P.S. it's not the dollar sign. Turns out I can get an arbitrary <code>\\</code> path using a shared folder. No special characters involved, but still gets UNC'd.</p>
<pre><code>home = \\?\UNC\DESKTOP\Users\Pavel\share\Python310
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-25 17:52</div>
            <div class="timeline-body"><p>Yeah. I assume dunce is correct that it's not unequivocally safe to strip that (maybe leads to an ambiguity) but again mercifully I'm not an expert in Windows paths. We can experiment with not canonicalizing paths on Windows at all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-25 20:56</div>
            <div class="timeline-body"><p>I pushed a new version to that same branch / PR that avoids canonicalizing on Windows, if you want to try it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2024-07-25 23:25</div>
            <div class="timeline-body"><p>Third time's the charm! üëç</p>
<pre><code>home = \\localhost\c$\Program Files\Python310
</code></pre>
<p>Looking at the <code>dunce</code> code you quoted -- this all tracks. It seems to only consider as 'safe' paths starting with a drive letter e.g. <code>C:</code>, else gives up completely:</p>
<pre><code>    match components.next() {
        Some(Component::Prefix(p)) =&gt; match p.kind() {
            Prefix::VerbatimDisk(..) =&gt; {},
            _ =&gt; return false, // Other kinds of UNC paths
        },
        _ =&gt; return false, // relative or empty
    }
</code></pre>
<p>IMHO this is overly conservative, but I am likewise not a Windows expert -- just someone that has to live with its quirks! Also found this conversation @ <a href="https://gitlab.com/kornelski/dunce/-/issues/2">someone's <code>dunce</code> bug report</a>. I guess the problem here is that once (mis-)canonicalisation adds the prefix, it is impossible to safely to strip it back away.</p>
<p>So... a <code>dunce</code> issue that is effectively WONTFIX?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-07-26 12:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2024-07-26 14:39</div>
            <div class="timeline-body"><p>Thanks a million for the quick resolution üôå</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 04:55:54 UTC
    </footer>
</body>
</html>
