<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv wrongly detects PEP723 style magic comments in strings - astral-sh/uv #12303</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv wrongly detects PEP723 style magic comments in strings</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/12303">#12303</a>
        opened by <a href="https://github.com/samuelcolvin">@samuelcolvin</a>
        on 2025-03-18 23:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/samuelcolvin">@samuelcolvin</a> on 2025-03-18 23:49</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>code:</p>
<pre><code class="language-py">print(&quot;&quot;&quot;
# /// script
# dependencies = [&quot;pydantic&quot;, &quot;email-validator&quot;]
# ///
import pydantic

class Model(pydantic.BaseModel):
    email: pydantic.EmailStr

print(Model(email='hello@pydantic.dev'))
&quot;&quot;&quot;)
</code></pre>
<p>Running this prints:</p>
<pre><code>error: failed to create directory `/Users/samuel/Library/Caches/uv/environments-v2/check-da89a400ed637ca7`: Permission denied (os error 13)
</code></pre>
<h3>Platform</h3>
<p>MacOS 15 ARM</p>
<h3>Version</h3>
<p>uv 0.6.6 (c1a0bb85e 2025-03-12)</p>
<h3>Python version</h3>
<p>Python 3.12.3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @samuelcolvin on 2025-03-18 23:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-19 00:09</div>
            <div class="timeline-body"><p>Alas.</p>
<p>Fwiw, this matches the regex in the specification https://regex101.com/r/LNoSNF/1 — though I'm sure this isn't the intent.</p>
<p>I presume we can use a heuristic to avoid this? I don't want to bring in a parser.</p>
<p><code>pipx</code> has the same behavior</p>
<pre><code>❯ uvx pipx run -v example.py
pipx &gt;(setup:1110): pipx version is 1.7.1
pipx &gt;(setup:1111): Default python interpreter is '/Users/zb/.local/share/uv/python/cpython-3.13.0-macos-aarch64-none/bin/python3.13'
pipx &gt;(_remove_all_expired_venvs:315): Removing expired venv /Users/zb/.local/pipx/.cache/CACHEDIR.TAG
pipx &gt;(create_venv:164): Creating virtual environment
creating virtual environment...
pipx &gt;(run_subprocess:175): running /Users/zb/.local/share/uv/python/cpython-3.13.0-macos-aarch64-none/bin/python3.13 -m venv --without-pip /Users/zb/.local/pipx/.cache/ea304b8314d56fb
pipx &gt;(run_subprocess:175): running &lt;checking pip's availability&gt;
pipx &gt;(run_subprocess:175): running /Users/zb/.local/pipx/.cache/ea304b8314d56fb/bin/python -c import sysconfig; print(sysconfig.get_path('purelib'))
pipx &gt;(run_subprocess:175): running /Users/zb/.local/pipx/shared/bin/python -c import sysconfig; print(sysconfig.get_path('purelib'))
pipx &gt;(run_subprocess:175): running /Users/zb/.local/pipx/.cache/ea304b8314d56fb/bin/python --version
pipx &gt;(install_unmanaged_packages:292): Installing pydantic, email-validator
installing pydantic, email-validator...
pipx &gt;(run_subprocess:175): running /Users/zb/.local/pipx/.cache/ea304b8314d56fb/bin/python -m pip --no-input install pydantic email-validator
pipx &gt;(exec_app:375): exec_app: /Users/zb/.local/pipx/.cache/ea304b8314d56fb/bin/python example.py

# /// script
# dependencies = [&quot;pydantic&quot;, &quot;email-validator&quot;]
# ///
import pydantic

class Model(pydantic.BaseModel):
    email: pydantic.EmailStr

print(Model(email='hello@pydantic.dev'))
</code></pre>
<p>cc @ofek</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samuelcolvin">@samuelcolvin</a> on 2025-03-19 01:05</div>
            <div class="timeline-body"><p>Presumably the magic comment should appear at the start of the file, perhaps allowing for blank lines? If so, that should be pretty easy to detect.</p>
<p>I agree the original regex <a href="https://packaging.python.org/en/latest/specifications/inline-script-metadata/#inline-script-metadata">here</a> would match on this, and I'm pretty sure my code in <code>mcp-run-python</code> <a href="https://github.com/pydantic/pydantic-ai/blob/4c0f384a0626299382c22a8e3372638885e18286/mcp-run-python/src/prepare_env.py#L147-L156">here</a> would do the same (that's what I was testing when I found this).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-19 01:08</div>
            <div class="timeline-body"><p>I think it needs to be able to appear after a shebang, which could be fairly complicated (e.g., https://github.com/astral-sh/uv/issues/12193#issuecomment-2726977692 — which is not quite a perfect example but does capture the possible complexity)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-19 01:17</div>
            <div class="timeline-body"><p>I need to look back at the comments, but I seem to recall that this came up when the PEP was being discussed… I’ll look when I’m back at my computer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2025-03-19 01:39</div>
            <div class="timeline-body"><p>The magic comment is allowed anywhere in the file because an anticipated use case is modification of the comment such as storing the contents of a lock file/dependency resolution. I don't think anything can be done here. In order to get your example working start immediately after the triple quotes i.e. don't have a leading new line character.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../pex-tool/pex/pulls/2722.html">pex-tool/pex#2722</a> on 2025-03-19 03:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2025-03-19 04:03</div>
            <div class="timeline-body"><p>I very much dislike solutions like the one that was opened in response to this issue: https://github.com/pex-tool/pex/pull/2722</p>
<p>There's nothing preventing such liberties but I think we're in a bad situation if/when providers start getting requests to support parsing Python syntax.</p>
<p>@samuelcolvin What's your use case for running scripts that happen to embed magic comments in multiline literals?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/shauneccles">@shauneccles</a> on 2025-03-19 08:11</div>
            <div class="timeline-body"><p>This seems like a &quot;don't shoot yourself in the face&quot; problem.</p>
<p>I'd advocate that this is noted as an issue with the spec and if the spec changes to fix it then great.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samuelcolvin">@samuelcolvin</a> on 2025-03-19 10:24</div>
            <div class="timeline-body"><blockquote>
<p>@samuelcolvin What's your use case for running scripts that happen to embed magic comments in multiline literals?</p>
</blockquote>
<p>I don't have a specific use case, as mentioned above I discovered this while debugging our MCP server for writing python that uses PEP 723 style comments for dependencies, so I had some code in a string within a python script.</p>
<p>I was reporting it to be a good citizen, not particularly because I need a fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-20 15:16</div>
            <div class="timeline-body"><p>Personally, I think we should <em>probably</em> avoid changing anything here. The spec was designed with the intent of supporting non-Python consumers, and deviating from the spec puts pressure on <em>other</em> tools to support those deviations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2025-03-20 16:00</div>
            <div class="timeline-body"><p>Accepting the magic comment in any location in the file matches the spec and is obvious to the user what happened after the fact, if sometimes surprising to the user before the fact.</p>
<p>Therefore <em>if</em> a tool rejects a magic comment based on the Python syntax, or some other measure, I would prefer it do it non-silently, give a big warning that a magic comment was detected but rejected due to reasons.</p>
<p>As I recall, there was a <a href="https://discuss.python.org/t/pep-723-embedding-pyproject-toml-in-single-file-scripts/31151">long discussion</a> about not having to parse Python, and the construction of this comment was made such that it was unlikely to accidentally result in false positives, but obviously giving an example of the spec itself would be one of those cases impossible to avoid.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2025-03-20 16:38</div>
            <div class="timeline-body"><p>Germane to the discussion: is there a plan to embed the lock file within scripts rather than generating a file beside the script? It would be nice to have portable reproducibility (without relying on that resolution date limit option).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2025-03-20 16:46</div>
            <div class="timeline-body"><blockquote>
<p>is there a plan to embed the lock file within scripts</p>
</blockquote>
<p>I think that's https://github.com/astral-sh/uv/issues/11064</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-20 17:30</div>
            <div class="timeline-body"><p>Worth noting that I see some hiccups with the specification for this purpose too https://github.com/astral-sh/uv/issues/6318#issuecomment-2489572640</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-20 17:31</div>
            <div class="timeline-body"><p>If PEP 751 lands maybe we can have a <code># /// lock</code> block :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../pypa/packaging.python.org/issues/1835.html">pypa/packaging.python.org#1835</a> on 2025-03-21 16:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ncoghlan">@ncoghlan</a> on 2025-03-21 16:23</div>
            <div class="timeline-body"><p>I agree with the folks suggesting that nothing needs to change in <code>uv</code> here - the naive parsing in the spec is intentional, not accidental, and Python's string quoting is flexible enough that it isn't <em>necessary</em> to format strings in a way that triggers a misfire when generating code that happens to include PEP 723 comments.</p>
<p>I filed https://github.com/pypa/packaging.python.org/issues/1835 to cover adding a note about this to the &quot;Recommendations&quot; section on the PEP 723 page (I'm open to bikeshedding on what we think the nicest &quot;escaping&quot; mechanism to recommend would be)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">external</span> added by @zanieb on 2025-03-21 16:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-03-24 15:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/16239.html">astral-sh/uv#16239</a> on 2025-10-14 11:32</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:03 UTC
    </footer>
</body>
</html>
