```yaml
number: 2703
title: "Proactively build wheels for source distributions during `pip install` resolution"
type: issue
state: open
author: charliermarsh
labels:
  - performance
assignees: []
created_at: 2024-03-28T02:07:00Z
updated_at: 2024-03-31T18:05:09Z
url: https://github.com/astral-sh/uv/issues/2703
synced_at: 2026-01-10T01:57:06Z
```

# Proactively build wheels for source distributions during `pip install` resolution

---

_Issue opened by @charliermarsh on 2024-03-28 02:07_

When we `pip install`, we first run the resolver, then use the resolution to install. If we encounter a source distribution while resolving, we'll attempt to get the metadata, which may involve running `prepare_metadata_for_build_wheel` as an optimization, to skip the wheel build. After the resolution, we need to install, so we go to build the wheel, which requires creating the build environment _again_.

This is somewhat wasteful, since we had to setup the build environment twice. If we _know_ we'll need to include the distribution in the resolution, and we _know_ that we're going to need to install (as in `pip install` or `pip sync`, but not `pip compile`), we should consider always building the distribution and avoiding `prepare_metadata_for_build_wheel`.

This could make sense for, e.g., direct URL distributions that we encounter during `pip install` and `pip sync` resolutions.

I don't know how much this matters, but it did occur to me today, since we're now doing more metadata resolutions during `pip install`. We should verify before changing anything, but in https://github.com/timothyjlaurent/uv-poetry-monorepo-mre, my estimate is that it cost us about 150ms.


---

_Label `performance` added by @charliermarsh on 2024-03-28 02:07_

---

_Comment by @potiuk on 2024-03-28 09:22_

I think it's a good idea taking into acount all the dynamic complications - and also it follows the path that PEP 660 took for editable builds https://peps.python.org/pep-0660/. For dependencies that you indeed `know` that you have to install and you `know` that this is the version you are going to install for sure (URL. local paths)  as you noted this will make the resolution a bit longer, but overall impact on installation time will be net-negative. It will also allow to avoid the cases like we had with making some exceptions for specific cases like in #2130

---

_Comment by @charliermarsh on 2024-03-29 15:54_

Just to clarify, I think this should be _faster_ when we _know_ we need to install the wheel eventually.

---

_Comment by @charliermarsh on 2024-03-31 17:52_

The downside here is that we may end up reducing the amount of parallelism if we're waiting on source distributions to build during resolution.

---

_Comment by @charliermarsh on 2024-03-31 18:05_

We could _safely_ do this in `pip sync` and `pip install --no-deps` with no penalty though.

---
