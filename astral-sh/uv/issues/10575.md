```yaml
number: 10575
title: Caching and --config-settings
type: issue
state: open
author: suomela
labels:
  - bug
  - external
assignees: []
created_at: 2025-01-13T19:10:16Z
updated_at: 2025-01-13T21:02:02Z
url: https://github.com/astral-sh/uv/issues/10575
synced_at: 2026-01-10T01:57:24Z
```

# Caching and --config-settings

---

_Issue opened by @suomela on 2025-01-13 19:10_

I am here using `leanblueprint` as a random example of a tool I can run like `uvx leanblueprint`, which also depends on a package (`pygraphviz`) that requires magic command line switches to compile correctly.

On macOS, this typically fails with a compilation error in `pygraphviz`:
```
uv cache clean
uvx leanblueprint
```

I can fix it like this:
```
uvx --config-settings="--global-option=build_ext" --config-settings="--global-option=-I$(brew --prefix graphviz)/include/" --config-settings="--global-option=-L$(brew --prefix graphviz)/lib/" leanblueprint
```

After running the above command once, `pygraphviz` is compiled correctly and cached and I can simply use this:
```
uvx leanblueprint
```

However, if I ever clean the cache with e.g. `uv cache clean`, I can no longer run `uvx leanblueprint` until I do the magic thing with all the right `--config-settings` switches.

Somehow this does not feel right. The cache should be there just to speed things up, right? Cleaning the cache should only mean that next time things will take more time to download & build, but it shouldn't break anything? I would expect e.g. `uvx leanblueprint` behave in the same way before and after cleaning the cache (other than speed), but that is not the case.

Is this intentional? Or am I just doing something wrong by using `--config-settings` like this?

---

_Comment by @charliermarsh on 2025-01-13 19:16_

Let me take a look, I'll see if I can explain what's going on.

---

_Comment by @charliermarsh on 2025-01-13 19:19_

I believe this is because we cache the resolved environment. We might want the cached environment to take `--config-settings` into account, just like we do in the wheel cache itself.

---

_Assigned to @charliermarsh by @charliermarsh on 2025-01-13 19:19_

---

_Label `bug` added by @charliermarsh on 2025-01-13 19:19_

---

_Comment by @charliermarsh on 2025-01-13 19:20_

The thing is, I think that would mean that you need to pass the `--config-settings` every time you invoke `uvx`. Which is, I guess, correct to enforce? You could `uv tool install` instead if you want to avoid that ceremony. Then `uvx leanblueprint` would use the installed version.

---

_Comment by @suomela on 2025-01-13 19:26_

> The thing is, I think that would mean that you need to pass the `--config-settings` every time you invoke `uvx`. Which is, I guess, correct to enforce?

Yes, I would expect that if I have to pass `--config-settings` once, I'd have to pass it every time. That would at least be consistent and non-surprising.

The same thing apparently happens with `uv add`. This is how I originally noticed this: I was struggling with getting stuff working in one project, I created a brand new project for debugging, I managed to get it working there with `uv add --config-settings ...`, and to my surprise this also fixed the behavior in another unrelated project. Except that it broke when I cleared the cache.

---

_Comment by @charliermarsh on 2025-01-13 19:29_

That one I'm a bit more surprised by, but maybe there's a bug somewhere.

---

_Comment by @suomela on 2025-01-13 19:34_

Here are steps to reproduce (getting it working in `bar` influences what happens in `foo`):
```
uv cache clean
uv init foo
uv init bar
cd foo
uv add pygraphviz   # FAILS
cd ..
cd bar
uv add --config-settings="--global-option=build_ext" --config-settings="--global-option=-I$(brew --prefix graphviz)/include/" --config-settings="--global-option=-L$(brew --prefix graphviz)/lib/" pygraphviz
cd ..
cd foo
uv add pygraphviz   # NOW IT WORKS
```

---

_Comment by @charliermarsh on 2025-01-13 20:12_

Thanks!

---

_Comment by @charliermarsh on 2025-01-13 20:13_

I can reproduce that.

---

_Comment by @charliermarsh on 2025-01-13 20:55_

Hmm... I'm not sure what the best option is here... The problem is that setuptools seems to "reuse" the build. Like, this directory gets created, so then subsequent setuptools invocations skip a step in the build, I think. The only solution here would be to shard the cache based on `--config-setting`. Right now, we store separate built wheels based on `--config-setting`, but we use the same `src` directory.

![Image](https://github.com/user-attachments/assets/0dd1bc14-9816-4719-aa6c-5151cc7fcd9b)

---

_Comment by @charliermarsh on 2025-01-13 21:00_

I think it's related to this: https://github.com/pypa/setuptools/issues/1347

---

_Label `upstream` added by @konstin on 2025-01-13 21:02_

---

_Referenced in [astral-sh/uv#10577](../../astral-sh/uv/issues/10577.md) on 2025-01-13 21:07_

---

_Referenced in [astral-sh/uv#12463](../../astral-sh/uv/issues/12463.md) on 2025-03-25 13:20_

---
