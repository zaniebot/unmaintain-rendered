<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv cache prune removes files from a running process executed with `uvx` - astral-sh/uv #11694</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv cache prune removes files from a running process executed with <code>uvx</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/11694">#11694</a>
        opened by <a href="https://github.com/jezekra1">@jezekra1</a>
        on 2025-02-21 10:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jezekra1">@jezekra1</a></div>
            <div class="timeline-body">Summary
<p>When a tool is executing for a long period of time, for example <code>uvx mlflow server</code>,
running <code>uv cache prune</code> will remove its files while still running!</p>
<p>This is a screenshot from from htop:
<img src="https://github.com/user-attachments/assets/016bab73-46b9-4a7f-a616-5ad293e15e28" alt="Image"></p>
<p>However <code>uv cache prune</code> will remove it:</p>
<pre><code>❯ ls /Users/radek/.cache/uv/archive-v0/yl7-ET-Ix2_OI5icDQcWe
CACHEDIR.TAG bin          lib          pyvenv.cfg   share
❯ uv cache prune
Pruning cache at: /Users/radek/.cache/uv
Removed 12436 files (465.6MiB)
❯ ls /Users/radek/.cache/uv/archive-v0/yl7-ET-Ix2_OI5icDQcWe
ls: /Users/radek/.cache/uv/archive-v0/yl7-ET-Ix2_OI5icDQcWe: No such file or directory
</code></pre>
<p>But the <code>mflow</code> server process is still running! This will cause any runtime imports to fail. If this happens during the process startup, it fails inevitably.</p>
<p>This is also contrary to the statement in docs:</p>
<blockquote>
<p>uv cache prune removes all unused cache entries. For example, the cache directory may contain entries created in previous uv versions that are no longer necessary and can be safely removed. uv cache prune is safe to run periodically, to keep the cache directory clean.</p>
</blockquote>
<p>https://docs.astral.sh/uv/concepts/cache/#clearing-the-cache</p>
<hr>
<p><strong>Naive fix idea</strong></p>
<p>Add a new cache bucket which would use <code>pid</code> of the running process <code>~/.cache/uv/uvx-process-v1/{pid}/{symlink}</code>
When pruning cache uv could check whether the process with pid still exists and if not - remove the directory.</p>
<hr>
<p><strong>Related feature request</strong>:</p>
<p>Also it would be nice to have a way to prune old versions of the tool only and keep the latest one (the one that would be used by <code>uvx &lt;tool&gt;</code> as per docs, we could have <code>--keep-tools</code> flag to <code>uv cache prune</code> or something like that:</p>
<blockquote>
<p>uvx will use the latest available version of the requested tool on the first invocation. After that, uvx will use the cached version of the tool unless a different version is requested, the cache is pruned, or the cache is refreshed.</p>
</blockquote>
<hr>
<p><strong>Context</strong>:</p>
<p>We&#x27;re trying to create a platform which spawns processes using <code>uvx</code>:</p>
<p>https://github.com/i-am-bee/beeai/blob/85d970a5b7436f742bc85ed9ab6e324bf91bbeed/apps/beeai-server/src/beeai_server/domain/model.py#L203</p>
<p>However it leaves a lot of files on the filesystem potentially forever with no way to clean them because <code>uv cache prune</code> breaks the running processes.</p>
<p>Thanks for all the amazing work!</p>
Platform
<p>Darwin 24.3.0 arm64</p>
Version
<p>uv 0.6.2 (6d3614eec 2025-02-19)</p>
Python version
<p>Python 3.11.11</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/jezekra1">@jezekra1</a> on 2025-02-21 10:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-11-28 15:18</div>
            <div class="timeline-body"><p>I think this is likely no longer true given that we hold a lock on the cache itself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-11-28 15:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:37:26 UTC
    </footer>
</body>
</html>
