<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv` fails to connect to private index with mTLS enabled - astral-sh/uv #4612</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>uv</code> fails to connect to private index with mTLS enabled</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/4612">#4612</a>
        opened by <a href="https://github.com/CJSmith-0141">@CJSmith-0141</a>
        on 2024-06-28 12:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/CJSmith-0141">@CJSmith-0141</a></div>
            <div class="timeline-body"><p>Having set all the following environment variables, my expectation is that <code>uv</code> would behave the same way as <code>pip</code> when running <code>uv pip install .</code></p>
<pre><code class="language-console">export UV_INDEX_URL=&quot;https://${NEXUS_USERNAME}:${NEXUS_PASSWORD}@${NEXUS_URL}:443/repository/pypi-proxy/simple&quot;
export UV_EXTRA_INDEX_URL=&quot;https://${NEXUS_USERNAME}:${NEXUS_PASSWORD}@${NEXUS_URL}:443/repository/private-python-repo/simple&quot;
export SSL_CERT_FILE=/path/to/trusted/certs/certs.crt
export SSL_CLIENT_CERT=/path/to/private/cert_then_key.pem
</code></pre>
<p><code>uv</code> version is <code>0.2.17</code> and <code>pip</code> version is <code>24.1.1</code>.</p>
<p>The private repo in question is an instance of <a href="https://www.sonatype.com/products/sonatype-nexus-repository">Sonatype Nexus</a></p>
<p>Here is the <code>pip.conf</code> that is working using <code>pip</code></p>
<pre><code class="language-conf">[global]
index-url = {same as above UV_INDEX_URL}
extra-index-url = {{ same as above UV_EXTRA_INDEX_URL }}
client-cert = {{ same as above SSL_CERT_FILE }}
cert = {{ same as above SSL_CLIENT_CERT }}
</code></pre>
<p><a href="https://github.com/user-attachments/files/16029106/failure_with_full_trace.txt">Here is a full trace with private things redacted</a>, but the TL;DR seems to be:</p>
<pre><code class="language-console">DEBUG Transient request failure for https://*****************/repository/private-python-repo/simple/xmlschema/, retrying: Request error: error sending request for url (https://*****************/repository/private-python-repo/simple/xmlschema/)
  Caused by: error sending request for url (https://*****************/repository/private-python-repo/simple/xmlschema/)
  Caused by: client error (Connect)
  Caused by: Connection reset by peer (os error 104)
</code></pre>
<p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">network</span> added by @zanieb on 2024-06-29 23:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-06-29 23:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-04 15:55</div>
            <div class="timeline-body"><p>Unfortunately I don't have any ideas here. cc @samypr100</p>
<p>Do you have server side logs for the failed connections?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2024-07-04 17:10</div>
            <div class="timeline-body"><p>hmm, hard to say. <code>Connection reset by peer</code> tells me that the handshake is failing for some unknown reason and like @zanieb mentioned its worth correlating with server logs to figure out exactly what the issue is.  Alternatively, if there's other details you can share about the server's exact TLS configuration or how client certs are generated I can try to reproduce.</p>
<p>Normally you might see success in pip in situations like these if have something like <code>trusted-host</code> configured for pip anywhere on your system. Sidenote, the mTLS implementation uv is using is strict, not permissive but in such cases you'd likely get an error like <code>invalid peer certificate</code>.</p>
<p>It might be worth trying to debug using <code>openssl s_client</code> itself using <code>-connect</code> with <code>-verify_return_error</code>, maybe there is a hint somewhere there about the type of TLS error.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CJSmith-0141">@CJSmith-0141</a> on 2024-07-04 23:14</div>
            <div class="timeline-body"><p>I'll give a shot at making a project that reproduces the error I'm seeing, but first I'll try and track down the server logs too see if there is anything obvious. Thank you for the help and suggestions @samypr100 / @zanieb ðŸ˜„</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CJSmith-0141">@CJSmith-0141</a> on 2024-07-15 15:48</div>
            <div class="timeline-body"><p>Ok so this one was totally on me and possibly on <code>pip</code> being too permissive, and I could only see what was going wrong when getting into the logs for the Amazon ALB that was in front of nexus. What happened was that the load balancer had an incomplete certificate chain while the chain on the client side was complete. Some logging indicating this failure would be helpful but is out of scope for <code>uv</code> I think.</p>
<p>Thank you for the help!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @CJSmith-0141 on 2024-07-15 15:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-15 15:54</div>
            <div class="timeline-body"><p>Thank you for following up!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:25:24 UTC
    </footer>
</body>
</html>
