<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv sync failure when running concurrently - astral-sh/uv #12751</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv sync failure when running concurrently</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/12751">#12751</a>
        opened by <a href="https://github.com/noahrossi">@noahrossi</a>
        on 2025-04-08 16:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/noahrossi">@noahrossi</a> on 2025-04-08 16:54</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>First, thank you for creating such a great tool! My experience with uv has been overall fantastic. Unfortunately I'm running into some issues with concurrent <code>uv sync</code>ing. Since the MRE will look contrived (i.e. why am I even doing this?), I'll start with some background on what I am hoping to achieve. I am using uv in a parallel computing environment. As part of this, I am using <code>uv run</code> to run tasks inside a uv project. Sometimes these tasks need to be run in parallel, so a bunch of instances of <code>uv run</code> will start running at the same time. If the uv project needs to be synced, uv will then run a bunch of syncs in parallel. This is where I'm running into what I think is a race condition.</p>
<h4>My MRE</h4>
<pre><code class="language-bash">#!/bin/bash

uv init repro
cd repro

# You need a project with a lot of dependencies to reproduce this reliably
uv add boto3 fastapi numba pandas polars protobuf pyarrow pydantic requests urllib3 scikit-learn jupyter

rm -Rf .venv
parallel -n0 &quot;uv sync -q&quot; ::: {1..10}
# Uncomment the below (and comment the above) to verbose log to file
# parallel &quot;uv sync -v &amp;&gt;{}.log&quot; ::: {1..10}
</code></pre>
<h4>The error</h4>
<p>It's nondeterministic, but here's an example of an error from the above script:</p>
<details>

<pre><code>error: Failed to install: jupyterlab_widgets-3.0.13-py3-none-any.whl (jupyterlab-widgets==3.0.13)
  Caused by: failed to rename file from /home/nrossi/repro/.venv/lib/python3.13/site-packages/.tmp7EUD1t/plugin.json to /home/nrossi/repro/.venv/lib/python3.13/site-packages/jupyterlab_widgets-3.0.13.data/data/share/jupyter/labextensions/@jupyter-widgets/jupyterlab-manager/schemas/@jupyter-widgets/jupyterlab-manager/plugin.json: No such file or directory (os error 2)
error: Failed to install: notebook-7.3.3-py3-none-any.whl (notebook==7.3.3)
</code></pre>
</details>

<p>And here's some verbose logs from both a successful and unsuccessful uv sync that were run at the same time (see the commented part of the MRE script): https://gist.github.com/noahrossi/acbaafa55fef36af904970c0a968bcc4.</p>
<h4>Other details</h4>
<p>I believe that this is a bug based the intended behavior described on the <a href="https://docs.astral.sh/uv/concepts/cache/#cache-safety">Cache Safety section</a> of the docs, but please let me know if this is out of the scope of the guarantees that uv provides.</p>
<p>A few more notes:</p>
<ul>
<li>I've used GNU parallel here for simplicity. I can rewrite with bash loops and sending tasks to the bg if that would be easier for you.</li>
<li>Since it's a concurrency bug, the results of the MRE are nondeterministic. That said, on my system, I'm able to reproduce the bug ~80% of the time using that script. Hopefully it'll also reproduce on your system, but let me know if not.</li>
<li>I can avoid this error by ensuring that I <code>uv sync</code> before the parallel step or by using <code>--isolated</code>, but having <code>uv run</code> &quot;just work&quot; in a parallel environment would be most ideal.</li>
<li>I'm open to other ways of running uv projects in parallel, if you believe that there's a better way of accomplishing this without concurrently syncing.</li>
</ul>
<h3>Platform</h3>
<p>Red Hat Enterprise Linux 8.6</p>
<h3>Version</h3>
<p>uv 0.6.11</p>
<h3>Python version</h3>
<p>3.13.1</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @noahrossi on 2025-04-08 16:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-04-08 17:16</div>
            <div class="timeline-body"><p>Thanks for the report and reproduction! We <em>should</em> be locking the environment to prevent concurrent mutation and we <em>should</em> be doing atomic replacements, so this does look like a bug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @jtfmumm by @zanieb on 2025-04-11 14:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rafaelangelucci">@rafaelangelucci</a> on 2025-06-05 15:31</div>
            <div class="timeline-body"><p>I seem to be suffering from the same issue described in the ticket. Im wondering if there is an expected timeline for a fix?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-06-05 17:02</div>
            <div class="timeline-body"><blockquote>
<p>Im wondering if there is an expected timeline for a fix?</p>
</blockquote>
<p>There is not.</p>
<p>That said, I'd be interested in looking into this one unless you know for a fact @zanieb that it's going to be a can of worms?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-06-05 17:07</div>
            <div class="timeline-body"><p>We just lost track of this issue, hopefully we can address it soon.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @jtfmumm by @konstin on 2025-06-05 17:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/13869.html">astral-sh/uv#13869</a> on 2025-06-05 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/13883.html">astral-sh/uv#13883</a> on 2025-06-06 11:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-06-06 12:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-06-06 12:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/14153.html">astral-sh/uv#14153</a> on 2025-06-20 14:07</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:33:04 UTC
    </footer>
</body>
</html>
