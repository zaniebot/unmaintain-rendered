<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>cache_prune tests fail when run from unpacked sources - astral-sh/uv #4374</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>cache_prune tests fail when run from unpacked sources</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/4374">#4374</a>
        opened by <a href="https://github.com/mgorny">@mgorny</a>
        on 2024-06-18 04:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/mgorny">@mgorny</a> on 2024-06-18 04:25</div>
            <div class="timeline-body"><p>When building uv and running the test suite from unpacked sources (e.g. https://github.com/astral-sh/uv/archive/refs/tags/0.2.12.tar.gz), the following tests fail:</p>
<pre><code>     Running tests/cache_prune.rs (target/debug/deps/cache_prune-a20668bb0c4fb0dd)

running 3 tests
test prune_no_op ... FAILED
test prune_stale_directory ... FAILED
test prune_stale_symlink ... FAILED

failures:

---- prune_no_op stdout ----
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot: prune_no_op
Source: crates/uv/tests/cache_prune.rs:77
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
Expression: snapshot
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
    1     1 │ exit_code: 0
    2     2 │ ----- stdout -----
    3     3 │ 
    4     4 │ ----- stderr -----
    5       │-DEBUG uv [VERSION] ([COMMIT] DATE)
          5 │+DEBUG uv 0.2.12
    6     6 │ Pruning cache at: [CACHE_DIR]/
    7     7 │ No unused entries found
────────────┴──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
To update snapshots run `cargo insta review`
Stopped on the first failure. Run `cargo insta test` to run all snapshots.
thread 'prune_no_op' panicked at /home/mgorny/.cargo/registry/src/index.crates.io-6f17d22bba15001f/insta-1.39.0/src/runtime.rs:562:9:
snapshot assertion for 'prune_no_op' failed in line 77

---- prune_stale_directory stdout ----
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot: prune_stale_directory
Source: crates/uv/tests/cache_prune.rs:115
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
Expression: snapshot
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
    1     1 │ exit_code: 0
    2     2 │ ----- stdout -----
    3     3 │ 
    4     4 │ ----- stderr -----
    5       │-DEBUG uv [VERSION] ([COMMIT] DATE)
          5 │+DEBUG uv 0.2.12
    6     6 │ Pruning cache at: [CACHE_DIR]/
    7     7 │ DEBUG Removing dangling cache entry: [CACHE_DIR]/simple-v4
    8     8 │ Removed 1 directory
────────────┴──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
To update snapshots run `cargo insta review`
Stopped on the first failure. Run `cargo insta test` to run all snapshots.
thread 'prune_stale_directory' panicked at /home/mgorny/.cargo/registry/src/index.crates.io-6f17d22bba15001f/insta-1.39.0/src/runtime.rs:562:9:
snapshot assertion for 'prune_stale_directory' failed in line 115
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace

---- prune_stale_symlink stdout ----
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot: prune_stale_symlink
Source: crates/uv/tests/cache_prune.rs:161
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
Expression: snapshot
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
    1     1 │ exit_code: 0
    2     2 │ ----- stdout -----
    3     3 │ 
    4     4 │ ----- stderr -----
    5       │-DEBUG uv [VERSION] ([COMMIT] DATE)
          5 │+DEBUG uv 0.2.12
    6     6 │ Pruning cache at: [CACHE_DIR]/
    7     7 │ DEBUG Removing dangling cache entry: [CACHE_DIR]/archive-v0/[ENTRY]
    8     8 │ Removed 44 files ([SIZE])
────────────┴──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
To update snapshots run `cargo insta review`
Stopped on the first failure. Run `cargo insta test` to run all snapshots.
thread 'prune_stale_symlink' panicked at /home/mgorny/.cargo/registry/src/index.crates.io-6f17d22bba15001f/insta-1.39.0/src/runtime.rs:562:9:
snapshot assertion for 'prune_stale_symlink' failed in line 161


failures:
    prune_no_op
    prune_stale_directory
    prune_stale_symlink

test result: FAILED. 0 passed; 3 failed; 0 ignored; 0 measured; 0 filtered out; finished in 1.21s
</code></pre>
<p>I'm going to submit a pull request shortly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4375.html">astral-sh/uv#4375</a> on 2024-06-18 04:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-06-18 07:15</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:20 UTC
    </footer>
</body>
</html>
