```yaml
number: 12123
title: "unsafe-best-match: unexpected best-version selection with multiple indexes"
type: issue
state: open
author: UmerAhmad
labels:
  - needs-decision
assignees: []
created_at: 2025-03-11T23:11:13Z
updated_at: 2025-03-13T02:15:09Z
url: https://github.com/astral-sh/uv/issues/12123
synced_at: 2026-01-10T01:57:27Z
```

# unsafe-best-match: unexpected best-version selection with multiple indexes

---

_Issue opened by @UmerAhmad on 2025-03-11 23:11_

### Summary

hey folks, 

I found that when using unsafe-best-match with multiple indexes, there was a case where behavior for candidacy of "best-version" across the combined set of candidate versions was a bit unintuitive, and that ordering of the indexes mattered. 

For example with a package that has both a wheel and a sdist, if the repository with the sdist appeared first (in extra-index) and the wheel as a fallback (default), it would attempt to build the sdist and error. However, if the ordering of the indexes was swapped, it would work due to resolving to the wheel. This isn't an issue for us as our repositories are purposed so as long as the ordering is correct it'll behave correctly, but I assumed "best-version" candidacy would include default uv behavior of prioritizing a wheel where it can across the combined set of candidate versions (i.e similar for a single repository search with multiple versions of the same package), and make it index ordering agnostic.

### Platform

macOS 15 arm64

### Version

uv 0.6.1

### Python version

3.10.x

---

_Label `bug` added by @UmerAhmad on 2025-03-11 23:11_

---

_Comment by @charliermarsh on 2025-03-11 23:14_

Just to clarify, in this case, were the sdist and wheel for the same version of the package?

---

_Comment by @UmerAhmad on 2025-03-11 23:20_

yep! for a bit more context, specifically supplying a pinned.txt with all the versions pinned and using:

"uv pip sync pinned.txt --index-strategy unsafe-best-match"

I found that the ordering of the environment variables (of the indexes) was what the command was dependent on in differentiating to build vs finding the wheel

---

_Label `bug` removed by @charliermarsh on 2025-03-12 22:46_

---

_Label `needs-decision` added by @charliermarsh on 2025-03-12 22:46_

---

_Comment by @charliermarsh on 2025-03-12 23:04_

Yeah this is interesting... I'm undecided on whether we should change anything here, but we should at least consider it.

---

_Comment by @UmerAhmad on 2025-03-13 02:12_

thanks for taking a look! yeah I was unsure whether this was intentional or not, but definitely something to be aware of when using it.

also, wanted to say as a new user - onboarding with & using UV overall has been phenomenal. really appreciate the work being done here!!

---

_Comment by @charliermarsh on 2025-03-13 02:15_

Thank you so much! üôá‚Äç‚ôÇ 

---
