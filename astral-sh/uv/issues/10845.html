<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv run` changes uv.lock files - astral-sh/uv #10845</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>`uv run` changes uv.lock files</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/10845">#10845</a>
        opened by <a href="https://github.com/jaapz">@jaapz</a>
        on 2025-01-22 08:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/jaapz">@jaapz</a> on 2025-01-22 08:28</div>
            <div class="timeline-body"><p>When running a command through <code>uv run</code>, sometimes the <code>uv.lock</code> file gets changed. This is a bit annoying when the <code>uv.lock</code> file is in a git repository, as it introduces unrelated changes to the lock file to merge requests or commits (or you have to undo the change or explicitly not commit it...).</p>
<p>I know about the <code>--frozen</code>  argument, which helps (although it might do with a shortcut argument).</p>
<p>However doesn't it make more sense for <code>uv run</code> not to modify any files unless explicitly allowed, instead of the other way around? For example to instruct <code>uv</code> to change dependencies in the lockfile, you need to explicitly tell <code>uv</code> to do so. But <code>uv run</code> just changes files as a side-effect of whatever command you actually want to run.</p>
<p>The changes done by <code>uv run</code> also always seem quite insignificant, and do not seem to change how the lockfile seems to be interpreted.</p>
<p>As an example, when I run <code>uv run</code> in my ansible playbooks repository it now changes the <code>uv.lock</code> file with the following diff:</p>
<pre><code>diff --git a/playbooks/uv.lock b/playbooks/uv.lock
index c138ac2dd4..74438e6462 100644
--- a/playbooks/uv.lock
+++ b/playbooks/uv.lock
@@ -92,7 +92,6 @@ wheels = [

 [[package]]
 name = &quot;my-playbooks&quot;
-version = &quot;0.0.0&quot;
 source = { virtual = &quot;.&quot; }
 dependencies = [
     { name = &quot;ansible&quot; },
</code></pre>
<p>So now every time I run a playbook, the <code>uv.lock</code> changes and my repository is dirty.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-01-22 12:28</div>
            <div class="timeline-body"><p>Can you share a minimal reproducible example, following https://github.com/astral-sh/uv/issues/9452, as well as python version, your platform and your uv version?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @konstin on 2025-01-22 12:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-22 13:30</div>
            <div class="timeline-body"><p>Your problem in this case is that youâ€™re using an inconsistent uv version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jaapz">@jaapz</a> on 2025-01-23 09:41</div>
            <div class="timeline-body"><p>Yes, we use different <code>uv</code> versions across developers. For something as quickly developed as <code>uv</code> that is something you can't really avoid I guess?</p>
<p>I am currently on 0.5.20, which I updated to only a week ago and already there are 3 new versions. Don't get me wrong, that's great and I love the momentum you guys have, <code>uv</code> is an amazing tool.</p>
<p>But I'm just trying to raise the point that <code>uv run</code> by default having as side effect that it can change files. For me it makes more sense that file changes are only expected when explicitly asked for (for example when running <code>uv lock</code>, you expect the lockfile to change).</p>
<p>With <code>uv run</code>, I expect a command to be run in the right environment, but changing files was a surprise to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> removed by @konstin on 2025-01-23 10:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @konstin on 2025-01-23 10:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-01-23 10:12</div>
            <div class="timeline-body"><p>You can make <code>uv run</code> not touch the lockfile by using <code>uv run --frozen</code> or setting <code>UV_FROZEN=1</code>.</p>
<p>The idea behind <code>uv run</code> is that it runs your code with the declared dependencies (<code>pyproject.toml</code> or inline script dependencies). If you change pyproject.toml, we'll update the lockfile and venv for you in background. We try to preserve the versions in <code>uv.lock</code> to avoid churn and increase consistency, but in cases like this where we changed the lockfile format to better accommodate dynamically versioned projects it can give an odd diff. With the <code>--frozen</code> and <code>--locked</code> options you can toggle the behavior to avoid accidental lockfile modifications.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jaapz">@jaapz</a> on 2025-01-23 15:24</div>
            <div class="timeline-body"><p>I am aware of the <code>--frozen</code> argument (as I mentioned in the original report). In my mind however, it makes more sense for the behaviour of <code>--frozen</code> to be the default behavior of <code>uv run</code> - I expected <code>uv run</code> just to &quot;run&quot; my command, and not have any side effects changing files.</p>
<p>I understand this is a deliberate design decision, but it was something that slightly annoyed me, if it is something you are not likely to change then this issue can be closed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-01-23 15:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-23 15:56</div>
            <div class="timeline-body"><p>It's a big value proposition of <code>uv run</code> to ensure things are up to date. Once we add support for configuring options per-command, you could toggle the default behavior. Similarly, if you have a strong preference for this I'd recommend just setting up an alias that includes <code>--frozen</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../GridTools/gt4py/pulls/1841.html">GridTools/gt4py#1841</a> on 2025-01-31 08:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/silverwind">@silverwind</a> on 2025-07-16 11:08</div>
            <div class="timeline-body"><blockquote>
<p>Once we add support for configuring options per-command</p>
</blockquote>
<p>Maybe a option in <code>pyproject.toml</code> to always have <code>run</code> run with <code>--frozen</code>:</p>
<pre><code class="language-toml">[tool.uv]
commandOptions = {run = [&quot;--frozen&quot;]}
</code></pre>
<p>But imho, <code>run</code> should never touch the lockfile, its not an action that's supposed to change the dependencies.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../go-gitea/gitea/pulls/35097.html">go-gitea/gitea#35097</a> on 2025-07-16 12:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/UmaisZahid">@UmaisZahid</a> on 2025-07-23 09:43</div>
            <div class="timeline-body"><p>I agree with the comments above, this is a counter-intuitive aspect of the API. I think most people would assume <code>uv run</code> to be a stateless op for the underlying venv.</p>
<p>Something like the behaviour of <code>--locked</code> should probably be the default, so that an error is raised if your <code>uv.lock</code> is out of sync with your <code>pyproject.toml</code>, with the error message informing the user that they should update explicitly with <code>uv sync</code> or <code>uv run</code> with <code>--frozen</code> if they want to proceed anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../perrygeo/python-rasterstats/pulls/309.html">perrygeo/python-rasterstats#309</a> on 2025-09-02 18:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../ecolabdata/ecospheres-universe/pulls/18.html">ecolabdata/ecospheres-universe#18</a> on 2025-10-20 12:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:25 UTC
    </footer>
</body>
</html>
