<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benchmarks cannot be run under PowerShell - astral-sh/uv #1312</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Benchmarks cannot be run under PowerShell</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/1312">#1312</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-02-15 09:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-15 09:14</div>
            <div class="timeline-body"><p>Running the benchmarks on windows currently fails for several reasons:</p>
<ul>
<li>The script fails to find the <code>pdm</code>, <code>poetry</code>, <code>pip-compile</code>, ... binaries. I had to pass them manually and had to change the script to never run the benchmarks with the <em>default</em> binary if e.g. <code>--pdm-path</code> is specified</li>
<li>There are multiple cases where we use <code>rm</code> in prepare scripts. We need to replace them with <code>rmdir</code> or <code>del</code></li>
<li>There's something else that I haven't been able to figure out quickly.<pre><code>Benchmark 1: C:\Users\Micha\astral\puffin\.venv\Scripts\pip-compile.exe (resolve-warm)
Could Not Find C:\Users\Micha\AppData\Local\Temp\tmp4ou6fhbn\tmpm4v1jonc\requirements.txt
The filename, directory name, or volume label syntax is incorrect.
</code></pre>
</li>
</ul>
<details>
	<summary>My local patch</summary>

<pre><code class="language-diff">Index: scripts/bench/__main__.py
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&lt;+&gt;UTF-8
===================================================================
diff --git a/scripts/bench/__main__.py b/scripts/bench/__main__.py
--- a/scripts/bench/__main__.py	(revision e4fffc15f5c467e851267a85309496cb0907d45e)
+++ b/scripts/bench/__main__.py	(date 1707988190584)
@@ -197,7 +197,7 @@
 
         return Command(
             name=f&quot;{self.name} ({Benchmark.RESOLVE_COLD.value})&quot;,
-            prepare=f&quot;rm -rf {cwd} &amp;&amp; rm -f {output_file}&quot;,
+            prepare=f&quot;{rm_dir(cwd)} &amp;&amp; {rm_file(output_file)}&quot;,
             command=[
                 self.path,
                 os.path.abspath(requirements_file),
@@ -215,7 +215,7 @@
 
         return Command(
             name=f&quot;{self.name} ({Benchmark.RESOLVE_WARM.value})&quot;,
-            prepare=f&quot;rm -f {output_file}&quot;,
+            prepare=f&quot;{rm_file(output_file)}&quot;,
             command=[
                 self.path,
                 os.path.abspath(requirements_file),
@@ -260,7 +260,7 @@
 
         return Command(
             name=f&quot;{self.name} ({Benchmark.RESOLVE_INCREMENTAL.value})&quot;,
-            prepare=f&quot;rm -f {output_file} &amp;&amp; cp {baseline} {output_file}&quot;,
+            prepare=f&quot;{rm_file(output_file)} &amp;&amp; cp {baseline} {output_file}&quot;,
             command=[
                 self.path,
                 input_file,
@@ -300,7 +300,7 @@
 
         return Command(
             name=f&quot;{self.name} ({Benchmark.INSTALL_COLD.value})&quot;,
-            prepare=f&quot;rm -rf {cache_dir} &amp;&amp; virtualenv --clear -p 3.12 {venv_dir}&quot;,
+            prepare=f&quot;{rm_dir(cache_dir)} &amp;&amp; virtualenv --clear -p 3.12 {venv_dir}&quot;,
             command=[
                 self.path,
                 os.path.abspath(requirements_file),
@@ -340,6 +340,8 @@
         import tomli_w
         from packaging.requirements import Requirement
 
+        print(self.path)
+
         # Parse all dependencies from the requirements file.
         with open(requirements_file) as fp:
             requirements = [
@@ -360,8 +362,8 @@
                 &quot;3.12&quot;,
             ],
             cwd=cwd,
-            stdout=subprocess.DEVNULL,
-            stderr=subprocess.DEVNULL,
+#             stdout=subprocess.DEVNULL,
+#             stderr=subprocess.DEVNULL,
         )
 
         # Parse the pyproject.toml.
@@ -392,10 +394,10 @@
         return Command(
             name=f&quot;{self.name} ({Benchmark.RESOLVE_COLD.value})&quot;,
             prepare=(
-                f&quot;rm -rf {config_dir} &amp;&amp; &quot;
-                f&quot;rm -rf {cache_dir} &amp;&amp; &quot;
-                f&quot;rm -rf {data_dir} &amp;&amp;&quot;
-                f&quot;rm -rf {poetry_lock}&quot;
+                f&quot;{rm_dir(config_dir)} &amp;&amp; &quot;
+                f&quot;{rm_dir(cache_dir)} &amp;&amp; &quot;
+                f&quot;{rm_dir(data_dir)} &amp;&amp;&quot;
+                f&quot;{rm_file(poetry_lock)}&quot;
             ),
             command=[
                 f&quot;POETRY_CONFIG_DIR={config_dir}&quot;,
@@ -418,7 +420,7 @@
 
         return Command(
             name=f&quot;{self.name} ({Benchmark.RESOLVE_WARM.value})&quot;,
-            prepare=f&quot;rm -f {poetry_lock}&quot;,
+            prepare=f&quot;{rm_file(poetry_lock)}&quot;,
             command=[
                 f&quot;POETRY_CONFIG_DIR={config_dir}&quot;,
                 f&quot;POETRY_CACHE_DIR={cache_dir}&quot;,
@@ -478,7 +480,7 @@
 
         return Command(
             name=f&quot;{self.name} ({Benchmark.RESOLVE_INCREMENTAL.value})&quot;,
-            prepare=f&quot;rm -f {poetry_lock} &amp;&amp; cp {baseline} {poetry_lock}&quot;,
+            prepare=f&quot;{rm_file(poetry_lock)} &amp;&amp; cp {baseline} {poetry_lock}&quot;,
             command=[
                 f&quot;POETRY_CONFIG_DIR={config_dir}&quot;,
                 f&quot;POETRY_CACHE_DIR={cache_dir}&quot;,
@@ -517,9 +519,9 @@
         return Command(
             name=f&quot;{self.name} ({Benchmark.INSTALL_COLD.value})&quot;,
             prepare=(
-                f&quot;rm -rf {config_dir} &amp;&amp; &quot;
-                f&quot;rm -rf {cache_dir} &amp;&amp; &quot;
-                f&quot;rm -rf {data_dir} &amp;&amp;&quot;
+                f&quot;{rm_dir(config_dir)} &amp;&amp; &quot;
+                f&quot;{rm_dir(cache_dir)} &amp;&amp; &quot;
+                f&quot;{rm_dir(data_dir)} &amp;&amp;&quot;
                 f&quot;virtualenv --clear -p 3.12 {venv_dir} --no-seed&quot;
             ),
             command=[
@@ -623,7 +625,7 @@
 
         return Command(
             name=f&quot;{self.name} ({Benchmark.RESOLVE_COLD.value})&quot;,
-            prepare=f&quot;rm -rf {cache_dir} &amp;&amp; rm -rf {pdm_lock} &amp;&amp; {self.path} config cache_dir {cache_dir}&quot;,
+            prepare=f&quot;{rm_dir(cache_dir)} &amp;&amp; {rm_file(pdm_lock)} &amp;&amp; {self.path} config cache_dir {cache_dir}&quot;,
             command=[
                 self.path,
                 &quot;lock&quot;,
@@ -640,7 +642,7 @@
 
         return Command(
             name=f&quot;{self.name} ({Benchmark.RESOLVE_WARM.value})&quot;,
-            prepare=f&quot;rm -rf {pdm_lock} &amp;&amp; {self.path} config cache_dir {cache_dir}&quot;,
+            prepare=f&quot;{rm_dir(pdm_lock)} &amp;&amp; {self.path} config cache_dir {cache_dir}&quot;,
             command=[
                 self.path,
                 &quot;lock&quot;,
@@ -689,7 +691,7 @@
 
         return Command(
             name=f&quot;{self.name} ({Benchmark.RESOLVE_INCREMENTAL.value})&quot;,
-            prepare=f&quot;rm -f {pdm_lock} &amp;&amp; cp {baseline} {pdm_lock} &amp;&amp; {self.path} config cache_dir {cache_dir}&quot;,
+            prepare=f&quot;{rm_file(pdm_lock)} &amp;&amp; cp {baseline} {pdm_lock} &amp;&amp; {self.path} config cache_dir {cache_dir}&quot;,
             command=[
                 self.path,
                 &quot;lock&quot;,
@@ -721,7 +723,7 @@
         return Command(
             name=f&quot;{self.name} ({Benchmark.INSTALL_COLD.value})&quot;,
             prepare=(
-                f&quot;rm -rf {cache_dir} &amp;&amp; &quot;
+                f&quot;{rm_dir(cache_dir)} &amp;&amp; &quot;
                 f&quot;{self.path} config cache_dir {cache_dir} &amp;&amp; &quot;
                 f&quot;virtualenv --clear -p 3.12 {venv_dir} --no-seed&quot;
             ),
@@ -788,7 +790,7 @@
 
         return Command(
             name=f&quot;{self.name} ({Benchmark.RESOLVE_COLD.value})&quot;,
-            prepare=f&quot;rm -rf {cwd} &amp;&amp; rm -f {output_file}&quot;,
+            prepare=f&quot;{rm_dir(cwd)} &amp;&amp; {rm_file(output_file)}&quot;,
             command=[
                 self.path,
                 &quot;pip&quot;,
@@ -807,7 +809,7 @@
 
         return Command(
             name=f&quot;{self.name} ({Benchmark.RESOLVE_WARM.value})&quot;,
-            prepare=f&quot;rm -f {output_file}&quot;,
+            prepare=f&quot;{rm_file(output_file)}&quot;,
             command=[
                 self.path,
                 &quot;pip&quot;,
@@ -856,7 +858,7 @@
 
         return Command(
             name=f&quot;{self.name} ({Benchmark.RESOLVE_INCREMENTAL.value})&quot;,
-            prepare=f&quot;rm -f {output_file} &amp;&amp; cp {baseline} {output_file}&quot;,
+            prepare=f&quot;{rm_file(output_file)} &amp;&amp; cp {baseline} {output_file}&quot;,
             command=[
                 self.path,
                 &quot;pip&quot;,
@@ -875,7 +877,7 @@
 
         return Command(
             name=f&quot;{self.name} ({Benchmark.INSTALL_COLD.value})&quot;,
-            prepare=f&quot;rm -rf {cache_dir} &amp;&amp; virtualenv --clear -p 3.12 {venv_dir}&quot;,
+            prepare=f&quot;{rm_dir(cache_dir)} &amp;&amp; virtualenv --clear -p 3.12 {venv_dir}&quot;,
             command=[
                 f&quot;VIRTUAL_ENV={venv_dir}&quot;,
                 self.path,
@@ -1017,25 +1019,25 @@
 
     # Determine the tools to benchmark, based on the user-provided arguments.
     suites = []
-    if args.pip_sync:
-        suites.append(PipSync())
-    if args.pip_compile:
-        suites.append(PipCompile())
-    if args.poetry:
-        suites.append(Poetry())
-    if args.pdm:
-        suites.append(Pdm())
-    if args.puffin:
-        suites.append(Puffin())
-    for path in args.pip_sync_path or []:
+    # if args.pip_sync:
+    #     suites.append(PipSync())
+    # if args.pip_compile:
+    #     suites.append(PipCompile())
+    # if args.poetry:
+    #     suites.append(Poetry())
+    # if args.pdm:
+    #     suites.append(Pdm())
+    # if args.puffin:
+    #     suites.append(Puffin())
+    for path in args.pip_sync_path or [None]:
         suites.append(PipSync(path=path))
-    for path in args.pip_compile_path or []:
+    for path in args.pip_compile_path or [None]:
         suites.append(PipCompile(path=path))
-    for path in args.poetry_path or []:
+    for path in args.poetry_path or [None]:
         suites.append(Poetry(path=path))
-    for path in args.pdm_path or []:
+    for path in args.pdm_path or [None]:
         suites.append(Pdm(path=path))
-    for path in args.puffin_path or []:
+    for path in args.puffin_path or [None]:
         suites.append(Puffin(path=path))
 
     # If no tools were specified, benchmark all tools.
@@ -1091,5 +1093,18 @@
                 hyperfine.run()
 
 
+def rm_dir(directory: str) -&gt; str:
+    if os.name == &quot;nt&quot;:
+        return f&quot;rmdir /s /q {directory}&quot;
+
+    return &quot;rm -rf {dir}&quot;
+
+def rm_file(file: str) -&gt; str:
+    if os.name == &quot;nt&quot;:
+        return f&quot;del /f {file}&quot;
+
+    return f&quot;rm -f {file}&quot;
+
+
 if __name__ == &quot;__main__&quot;:
     main()

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">windows</span> added by @MichaReiser on 2024-02-15 09:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Windows: Can't run Benchmarks" to "PowerShel: Can't run Benchmarks" by @MichaReiser on 2024-02-15 09:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "PowerShel: Can't run Benchmarks" to "PowerShell: Can't run Benchmarks" by @MichaReiser on 2024-02-15 09:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @zanieb on 2024-07-01 21:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "PowerShell: Can't run Benchmarks" to "Benchmarks cannot be run under PowerShell" by @zanieb on 2025-12-02 10:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:20 UTC
    </footer>
</body>
</html>
