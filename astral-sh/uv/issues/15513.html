<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv format` fails to install ruff with access denied on Windows - astral-sh/uv #15513</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>`uv format` fails to install ruff with access denied on Windows</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/15513">#15513</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2025-08-25 12:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-25 12:48</div>
            <div class="timeline-body"><p>e.g.</p>
<blockquote>
<p>Caused by: failed to rename file from C:\Users\Administrator\AppData\Roaming\uv\cache\binaries-v0.tmp5Kx5O1\ruff.exe to C:\Users\Administrator\AppData\Roaming\uv\cache\binaries-v0\ruff\0.12.5\x86_64-pc-windows-msvc\ruff.exe: Access is denied. (os error 5)</p>
</blockquote>
<p>https://github.com/astral-sh/ruff/actions/runs/17208854039/job/48815489906?pr=19665</p>
<p>I'm not sure why this is failing yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2025-08-25 12:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @zanieb on 2025-08-25 12:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">windows</span> added by @zanieb on 2025-08-25 12:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @zanieb on 2025-08-25 12:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sunfkny">@sunfkny</a> on 2025-08-25 14:21</div>
            <div class="timeline-body"><p>I can reproduce the same issue on Windows when running ruff's tests with <code>cargo nextest run --package ruff_server --lib --features test-uv</code></p>
<p>This doesn’t happen with <code>cargo test</code>, only with <code>cargo nextest</code>.
My guess is that since nextest runs tests in parallel, multiple processes may try to install/write to the same uv cache path at the same time, which triggers a file lock conflict.</p>
<pre><code>&gt; rm -Recurse -Force C:\Users\root\AppData\Local\uv\cache\binaries-v0\ruff
ruff on git pull_19665 is pkg v0.12.7 via py v3.14.0rc2 via rs v1.88.0                                                  
&gt; cargo test --package ruff_server --lib --features test-uv               
    Finished `test` profile [unoptimized + debuginfo] target(s) in 0.57s
     Running unittests src\lib.rs (target\debug\deps\ruff_server-9398095e742bc83c.exe)

running 25 tests
test edit::replacement::tests::delete_first_line ... ok
test edit::replacement::tests::replace_lines ... ok
test edit::replacement::tests::delete_multiple_lines ... ok
test edit::replacement::tests::insert_multiple_lines ... ok
test edit::replacement::tests::delete_middle_line ... ok
test edit::notebook::tests::swap_cells ... ok
test session::index::ruff_settings::tests::inline_settings ... ok
test edit::replacement::tests::insert_first_line ... ok
test edit::replacement::tests::insert_middle_line ... ok
test session::index::ruff_settings::tests::inline_and_specific_settings_resolution_order ... ok
test session::options::tests::test_empty_init_options_deserialize ... ok
test edit::text_document::tests::redo_edit ... ok
test session::options::tests::test_preview_flag ... ok
test session::options::tests::test_global_only_resolves_correctly ... ok
test session::options::tests::inline_configuration ... ok
test session::options::tests::test_global_only_init_options_deserialize ... ok
test format::tests::format_per_file_version ... ok
test format::tests::format_per_file_version_range ... ok
test format::tests::uv_tests::test_uv_format_with_quote_style ... ok
test format::tests::uv_tests::test_uv_format_with_indent_style ... ok
test format::tests::uv_tests::test_uv_format_syntax_error ... ok
test format::tests::uv_tests::test_uv_format_range ... ok
test format::tests::uv_tests::test_uv_format_with_magic_trailing_comma ... ok
test format::tests::uv_tests::test_uv_format_document ... ok
test format::tests::uv_tests::test_uv_format_with_line_length ... ok

test result: ok. 25 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 4.33s

ruff on git pull_19665 is pkg v0.12.7 via py v3.14.0rc2 via rs v1.88.0 took 5s 
&gt; rm -Recurse -Force C:\Users\root\AppData\Local\uv\cache\binaries-v0\ruff
ruff on git pull_19665 is pkg v0.12.7 via py v3.14.0rc2 via rs v1.88.0                                                  
&gt; cargo nextest run --package ruff_server --lib --features test-uv
    Finished `test` profile [unoptimized + debuginfo] target(s) in 0.63s
────────────
 Nextest run ID 24ffebd2-59bb-4a63-b6fe-c2e2a8fec2fc with nextest profile: default
    Starting 25 tests across 1 binary
     Running [ 00:00:00] 0/25: 0 running, 0 passed, 0 skipped
        PASS [   0.036s] ruff_server edit::replacement::tests::delete_multiple_lines                                                       
        PASS [   0.054s] ruff_server edit::replacement::tests::delete_middle_line
        PASS [   0.071s] ruff_server edit::replacement::tests::delete_first_line
        PASS [   0.090s] ruff_server edit::replacement::tests::insert_middle_line
        PASS [   0.109s] ruff_server edit::replacement::tests::insert_first_line
        PASS [   0.128s] ruff_server edit::replacement::tests::replace_lines                                                               
        PASS [   0.148s] ruff_server edit::notebook::tests::swap_cells
        PASS [   0.183s] ruff_server edit::text_document::tests::redo_edit                                                                 
        PASS [   0.205s] ruff_server edit::replacement::tests::insert_multiple_lines
        PASS [   0.273s] ruff_server format::tests::format_per_file_version
        PASS [   0.379s] ruff_server session::index::ruff_settings::tests::inline_settings
        PASS [   0.387s] ruff_server format::tests::format_per_file_version_range
        PASS [   0.389s] ruff_server session::index::ruff_settings::tests::inline_and_specific_settings_resolution_order
        PASS [   0.434s] ruff_server session::options::tests::test_empty_init_options_deserialize                                          
        PASS [   0.449s] ruff_server session::options::tests::inline_configuration
        PASS [   0.470s] ruff_server session::options::tests::test_global_only_resolves_correctly
        PASS [   0.503s] ruff_server session::options::tests::test_preview_flag
        PASS [   0.586s] ruff_server session::options::tests::test_global_only_init_options_deserialize
        PASS [   2.369s] ruff_server format::tests::uv_tests::test_uv_format_document
        PASS [   2.642s] ruff_server format::tests::uv_tests::test_uv_format_range
        PASS [   2.655s] ruff_server format::tests::uv_tests::test_uv_format_syntax_error
        FAIL [   3.123s] ruff_server format::tests::uv_tests::test_uv_format_with_quote_style
  stdout ───

    running 1 test
    test format::tests::uv_tests::test_uv_format_with_quote_style ... FAILED

    failures:

    failures:
        format::tests::uv_tests::test_uv_format_with_quote_style

    test result: FAILED. 0 passed; 1 failed; 0 ignored; 0 measured; 24 filtered out; finished in 2.78s

  stderr ───

    thread 'format::tests::uv_tests::test_uv_format_with_quote_style' panicked at crates\ruff_server\src\format.rs:686:14:
    Expected no errors when formatting with uv: Failed to format document: warning: `uv format` is experimental and may change without warning. Pass `--preview-features format` to disable this warning.
    Downloading ruff v0.12.5 (11.9MiB)
     Downloading ruff v0.12.5
    error: Failed to install ruff {version}
      Caused by: failed to rename file from C:\Users\root\AppData\Local\uv\cache\binaries-v0\.tmpOCus9a\ruff.exe to C:\Users\root\AppData\Local\uv\cache\binaries-v0\ruff\0.12.5\x86_64-pc-windows-msvc\ruff.exe: 拒绝访问。 (os error 5)

    note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace

  Cancelling due to test failure: 3 tests still running
        PASS [   3.214s] ruff_server format::tests::uv_tests::test_uv_format_with_line_length
        PASS [   4.100s] ruff_server format::tests::uv_tests::test_uv_format_with_indent_style
        PASS [   4.885s] ruff_server format::tests::uv_tests::test_uv_format_with_magic_trailing_comma
────────────
     Summary [   4.898s] 25 tests run: 24 passed, 1 failed, 0 skipped
        FAIL [   3.123s] ruff_server format::tests::uv_tests::test_uv_format_with_quote_style
error: test run failed
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-25 14:34</div>
            <div class="timeline-body"><p>Oh that makes sense, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-25 14:35</div>
            <div class="timeline-body"><p>We should make this safe to concurrent operations, e.g, by taking a lock to the cache directory.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/15551.html">astral-sh/uv#15551</a> on 2025-08-27 14:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-08-27 16:42</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:29 UTC
    </footer>
</body>
</html>
