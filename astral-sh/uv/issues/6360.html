<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recursive execution when using `uv run` in shebang line of script without `.py` extension - astral-sh/uv #6360</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Recursive execution when using `uv run` in shebang line of script without `.py` extension</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/6360">#6360</a>
        opened by <a href="https://github.com/ngnpope">@ngnpope</a>
        on 2024-08-21 17:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ngnpope">@ngnpope</a> on 2024-08-21 17:37</div>
            <div class="timeline-body"><p>Related to https://github.com/astral-sh/uv/pull/6313 and https://github.com/astral-sh/ruff/issues/13021#issuecomment-2302585295.</p>
<p>Using the example from <a href="https://astral.sh/blog/uv-unified-python-packaging#single-file-scripts">here</a> with the shebang line added and saved to a file named <code>list-peps</code>:</p>
<pre><code class="language-python">#!/usr/bin/env -S uv run --verbose

# /// script
# requires-python = &quot;&gt;=3.12&quot;
# dependencies = [&quot;requests&lt;3&quot;, &quot;rich&quot;]
# ///

import requests
from rich.pretty import pprint

resp = requests.get(&quot;https://peps.python.org/api/peps.json&quot;)
data = resp.json()
pprint([(k, v[&quot;title&quot;]) for k, v in data.items()][:10])
</code></pre>
<p>On execution, it keeps attempting to execute itself:</p>
<pre><code class="language-console">$ ./list-peps
DEBUG uv 0.3.0
DEBUG No project found; searching for Python interpreter
DEBUG Searching for Python interpreter in managed installations or system path
DEBUG Searching for managed installations at `.local/share/uv/python`
DEBUG Found `cpython-3.12.4-linux-x86_64-gnu` at `/home/nick/.pyenv/shims/python3` (search path)
DEBUG Using Python 3.12.4 interpreter at: /usr/bin/python3
DEBUG Running `./list-peps`
DEBUG uv 0.3.0
DEBUG No project found; searching for Python interpreter
DEBUG Searching for Python interpreter in managed installations or system path
DEBUG Searching for managed installations at `.local/share/uv/python`
DEBUG Found `cpython-3.12.4-linux-x86_64-gnu` at `/usr/bin/python3` (search path)
DEBUG Using Python 3.12.4 interpreter at: /usr/bin/python3
DEBUG Running `./list-peps`
...
</code></pre>
<p>If executing without an extension using <code>uv run</code>:</p>
<pre><code class="language-console">$ uv run list-peps
error: Failed to spawn: `list-peps`
  Caused by: No such file or directory (os error 2)
</code></pre>
<p>For comparison, if the script has the extension:</p>
<pre><code class="language-console">$ ./list-peps.py 
DEBUG uv 0.3.0
Reading inline script metadata from: ./list-peps.py
DEBUG Searching for Python &gt;=3.12 in managed installations or system path
DEBUG Searching for managed installations at `.local/share/uv/python`
DEBUG Found `cpython-3.12.4-linux-x86_64-gnu` at `/home/nick/.pyenv/shims/python3` (search path)
DEBUG Caching via interpreter: `/usr/bin/python3`
DEBUG Using request timeout of 30s
DEBUG Solving with installed Python version: 3.12.4
DEBUG Adding direct dependency: requests&lt;3
DEBUG Adding direct dependency: rich*
DEBUG Found fresh response for: https://pypi.org/simple/requests/
DEBUG Searching for a compatible version of requests (&lt;3)
DEBUG Selecting: requests==2.32.3 [compatible] (requests-2.32.3-py3-none-any.whl)
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/f9/9b/335f9764261e915ed497fcdeb11df5dfd6f7bf257d4a6a2a686d80da4d54/requests-2.32.3-py3-none-any.whl.metadata
DEBUG Found fresh response for: https://pypi.org/simple/rich/
DEBUG Adding transitive dependency for requests==2.32.3: charset-normalizer&gt;=2, &lt;4
DEBUG Adding transitive dependency for requests==2.32.3: idna&gt;=2.5, &lt;4
DEBUG Adding transitive dependency for requests==2.32.3: urllib3&gt;=1.21.1, &lt;3
DEBUG Adding transitive dependency for requests==2.32.3: certifi&gt;=2017.4.17
DEBUG Searching for a compatible version of rich (*)
DEBUG Selecting: rich==13.7.1 [compatible] (rich-13.7.1-py3-none-any.whl)
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/87/67/a37f6214d0e9fe57f6ae54b2956d550ca8365857f42a1ce0392bb21d9410/rich-13.7.1-py3-none-any.whl.metadata
DEBUG Adding transitive dependency for rich==13.7.1: markdown-it-py&gt;=2.2.0
DEBUG Adding transitive dependency for rich==13.7.1: pygments&gt;=2.13.0, &lt;3.0.0
DEBUG Found fresh response for: https://pypi.org/simple/urllib3/
DEBUG Found fresh response for: https://pypi.org/simple/charset-normalizer/
DEBUG Found fresh response for: https://pypi.org/simple/certifi/
DEBUG Found fresh response for: https://pypi.org/simple/idna/
DEBUG Searching for a compatible version of charset-normalizer (&gt;=2, &lt;4)
DEBUG Found fresh response for: https://pypi.org/simple/markdown-it-py/
DEBUG Found fresh response for: https://pypi.org/simple/pygments/
DEBUG Selecting: charset-normalizer==3.3.2 [compatible] (charset_normalizer-3.3.2-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl)
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/ee/fb/14d30eb4956408ee3ae09ad34299131fb383c47df355ddb428a7331cfa1e/charset_normalizer-3.3.2-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl.metadata
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/ca/1c/89ffc63a9605b583d5df2be791a27bc1a42b7c32bab68d3c8f2f73a98cd4/urllib3-2.2.2-py3-none-any.whl.metadata
DEBUG Searching for a compatible version of idna (&gt;=2.5, &lt;4)
DEBUG Selecting: idna==3.7 [compatible] (idna-3.7-py3-none-any.whl)
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/e5/3e/741d8c82801c347547f8a2a06aa57dbb1992be9e948df2ea0eda2c8b79e8/idna-3.7-py3-none-any.whl.metadata
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/42/d7/1ec15b46af6af88f19b8e5ffea08fa375d433c998b8a7639e76935c14f1f/markdown_it_py-3.0.0-py3-none-any.whl.metadata
DEBUG Searching for a compatible version of urllib3 (&gt;=1.21.1, &lt;3)
DEBUG Selecting: urllib3==2.2.2 [compatible] (urllib3-2.2.2-py3-none-any.whl)
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/f7/3f/01c8b82017c199075f8f788d0d906b9ffbbc5a47dc9918a945e13d5a2bda/pygments-2.18.0-py3-none-any.whl.metadata
DEBUG Searching for a compatible version of certifi (&gt;=2017.4.17)
DEBUG Selecting: certifi==2024.7.4 [compatible] (certifi-2024.7.4-py3-none-any.whl)
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/1c/d5/c84e1a17bf61d4df64ca866a1c9a913874b4e9bdc131ec689a0ad013fb36/certifi-2024.7.4-py3-none-any.whl.metadata
DEBUG Searching for a compatible version of markdown-it-py (&gt;=2.2.0)
DEBUG Selecting: markdown-it-py==3.0.0 [compatible] (markdown_it_py-3.0.0-py3-none-any.whl)
DEBUG Adding transitive dependency for markdown-it-py==3.0.0: mdurl&gt;=0.1, &lt;1.dev0
DEBUG Searching for a compatible version of pygments (&gt;=2.13.0, &lt;3.0.0)
DEBUG Selecting: pygments==2.18.0 [compatible] (pygments-2.18.0-py3-none-any.whl)
DEBUG Found fresh response for: https://pypi.org/simple/mdurl/
DEBUG Searching for a compatible version of mdurl (&gt;=0.1, &lt;1.dev0)
DEBUG Selecting: mdurl==0.1.2 [compatible] (mdurl-0.1.2-py3-none-any.whl)
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/b3/38/89ba8ad64ae25be8de66a6d463314cf1eb366222074cfda9ee839c56a4b4/mdurl-0.1.2-py3-none-any.whl.metadata
DEBUG Tried 9 versions: certifi 1, charset-normalizer 1, idna 1, markdown-it-py 1, mdurl 1, pygments 1, requests 1, rich 1, urllib3 1
DEBUG Split specific environment resolution took 0.004s
Resolved 9 packages in 5ms
DEBUG Using Python 3.12.4 interpreter at: /home/nick/.cache/uv/archive-v0/YE732SMtA0aLqaQ-9zyiT/bin/python3
DEBUG Running `python ./list-peps.py`
[
│   ('1', 'PEP Purpose and Guidelines'),
│   ('2', 'Procedure for Adding New Modules'),
│   ('3', 'Guidelines for Handling Bug Reports'),
│   ('4', 'Deprecation of Standard Modules'),
│   ('5', 'Guidelines for Language Evolution'),
│   ('6', 'Bug Fix Releases'),
│   ('7', 'Style Guide for C Code'),
│   ('8', 'Style Guide for Python Code'),
│   ('9', 'Sample Plaintext PEP Template'),
│   ('10', 'Voting Guidelines')
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-08-21 17:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-21 17:54</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-21 18:58</div>
            <div class="timeline-body"><pre><code>$ uv run list-peps
error: Failed to spawn: `list-peps`
  Caused by: No such file or directory (os error 2)
</code></pre>
<p>You can avoid this with <code>uv run ./list-peps</code>. I'm not sure whether that's a bug or working as intended, given that running <code>list-peps</code> in the terminal is interpreted the same way:</p>
<pre><code>❯ list-peps
zsh: command not found: list-peps
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-21 18:58</div>
            <div class="timeline-body"><p>(But the recursion is definitely a bug.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/PaarthShah">@PaarthShah</a> on 2024-08-22 08:14</div>
            <div class="timeline-body"><p>Hah, I wondered what would happen if I tried this, didn't get around to it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ngnpope">@ngnpope</a> on 2024-08-22 09:02</div>
            <div class="timeline-body"><blockquote>
<p>You can avoid this with <code>uv run ./list-peps</code>. I'm not sure whether that's a bug or working as intended, given that running <code>list-peps</code> in the terminal is interpreted the same way</p>
</blockquote>
<p>Hmm. I'm not sure that &quot;command not found&quot; is really the same as the &quot;failed to spawn&quot; case. The former is basically because the current directory is not on <code>$PATH</code> (a good thing) so you have to specify a path where the executable is found, hence <code>./list-peps</code>.</p>
<p>On the other hand, we should probably expect <code>uv run list-peps</code> to work in a similar vein to <code>python list-peps</code> where we don't need to do <code>python ./list-peps</code>. I've not attempted to look at what <code>uv run</code> does, but it seems as though it's treating files ending in <code>.py</code> as something to be run with a Python interpreter and anything else as execute directly, irrespective of whether it has the executable bit or not. I realise that fixing this might require some sort of file type detection instead of only relying on the extension.</p>
<p>Some further things of interest that seem to confirm the above...</p>
<details>
<summary>Python not needing the <tt>./</tt> prefix</summary>

<pre><code class="language-console">$ python list-peps
Traceback (most recent call last):
  File &quot;/home/nick/list-peps&quot;, line 9, in &lt;module&gt;
    from rich.pretty import pprint
ModuleNotFoundError: No module named 'rich'
</code></pre>
</details>
<details>
<summary>Removing the executable bit and using <tt>uv run</tt></summary>

<pre><code class="language-console">$ uv run ./list-peps
error: Failed to spawn: `./list-peps`
  Caused by: Permission denied (os error 13)
</code></pre>
</details>
<details>
<summary>Attempting to execute a <tt>.pyc</tt> (which is something that Python can do)</summary>

<p><em>This is something that is unlikely to support the PEP 723 stuff, so of much less use.</em></p>
<pre><code class="language-console">$ python -m compileall list-peps.py
$ python __pycache__/list-peps.cpython-312.pyc 
Traceback (most recent call last):
  File &quot;list-peps.py&quot;, line 9, in &lt;module&gt;
    from rich.pretty import pprint
ModuleNotFoundError: No module named 'rich'
$ uv run __pycache__/list-peps.cpython-312.pyc 
error: Failed to spawn: `__pycache__/list-peps.cpython-312.pyc`
  Caused by: Permission denied (os error 13)
</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/6313.html">astral-sh/uv#6313</a> on 2024-08-22 14:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-25 20:56</div>
            <div class="timeline-body"><p>I'll try to fix this for tomorrow's release.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/6635.html">astral-sh/uv#6635</a> on 2024-08-26 00:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/6634.html">astral-sh/uv#6634</a> on 2024-08-26 00:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @konstin by @zanieb on 2024-08-26 17:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/6711.html">astral-sh/uv#6711</a> on 2024-08-27 18:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/teroshan">@teroshan</a> on 2024-08-28 14:53</div>
            <div class="timeline-body"><p>I didn't know that <code>uv run</code> could also run binaries, my expectation for its behaviour was actually in line with what I found on <a href="https://docs.astral.sh/uv/guides/scripts/#declaring-script-dependencies">this documentation page</a>:</p>
<p>As in I was lead to believe that <code>uv run example.py</code> or <code>uv run --python 3.12 example.py</code> would work like <code>python example.py</code> or <code>python3.12 example.py</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-28 14:58</div>
            <div class="timeline-body"><p>That is the case (we use <code>python</code> for <code>.py</code> files), but it can run any command in the environment context e.g. <code>uv add ruff &amp;&amp; uv run ruff</code> — this is really important.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-28 14:59</div>
            <div class="timeline-body"><p>As a minor note, Hatch and Poetry also recursive infinitely when used this way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/teroshan">@teroshan</a> on 2024-08-28 15:02</div>
            <div class="timeline-body"><blockquote>
<p>As a minor note, Hatch and Poetry also recursive infinitely when used this way.</p>
</blockquote>
<p><code>pipx run</code> doesn't for me</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/plobsing">@plobsing</a> on 2024-09-07 12:43</div>
            <div class="timeline-body"><p>A perhaps surprising consequence to the current behaviour is that symlinks to working scripts might themselves not work, depending on the symlink name. For example, if I start with the working version of <code>./list-peps.py</code> in the original report, and create <code>./list-peps</code> as a symlink to it, I also get the recursion bug but only when invoking through the symlink. I think if the script filename was canonicalized prior to choosing whether to invoke it as a Python source or a binary, this would be less of a problem and perhaps serve as a viable workaround.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @konstin by @konstin on 2024-09-09 15:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dracos">@dracos</a> on 2024-09-10 12:13</div>
            <div class="timeline-body"><p>Not sure if linked, sorry if not, couldn't find another issue and sorry again if I've got confused - the documentation says &quot;uv run file.py is equivalent to uv run python file.py&quot;, but it doesn't appear to be, and it gets confused with/without extension:</p>
<pre><code>~/test $ cat noextension
#!/usr/bin/env python3
# /// script
# requires-python = &quot;&gt;=3.12&quot;
# dependencies = [
#     &quot;click&quot;,
# ]
# ///
import click
~/test $ cat extension.py
#!/usr/bin/env python3
# /// script
# requires-python = &quot;&gt;=3.12&quot;
# dependencies = [
#     &quot;click&quot;,
# ]
# ///
import click
~/test $ uv run noextension  # This error is expected
error: Failed to spawn: `noextension`
  Caused by: No such file or directory (os error 2)
~/test $ uv run ./noextension
Traceback (most recent call last):
  File &quot;/Users/m/test/./noextension&quot;, line 8, in &lt;module&gt;
    import click
ModuleNotFoundError: No module named 'click'
~/test $ uv run python3 ./noextension
Traceback (most recent call last):
  File &quot;/Users/m/test/./noextension&quot;, line 8, in &lt;module&gt;
    import click
ModuleNotFoundError: No module named 'click'
~/test $ uv run extension.py
Reading inline script metadata from: extension.py
~/test $ uv run ./extension.py
Reading inline script metadata from: ./extension.py
~/test $ uv run python3 ./extension.py
Traceback (most recent call last):
  File &quot;/Users/m/test/./extension.py&quot;, line 8, in &lt;module&gt;
    import click
ModuleNotFoundError: No module named 'click'
</code></pre>
<p>Hope that's helpful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bo5o">@bo5o</a> on 2024-10-31 13:43</div>
            <div class="timeline-body"><p>The following fixed the recursion bug for me:</p>
<pre><code class="language-python">#!/usr/bin/env -S uv run -s
</code></pre>
<p>From <code>uv help run</code>:</p>
<pre><code class="language-help">-s, --script
        Run the given path as a Python script.

        Using `--script` will attempt to parse the path as a PEP 723 script, irrespective of its extension.
</code></pre>
<p>With this, I can call just <code>list-peps</code> (no <code>./</code> or <code>.py</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ngnpope">@ngnpope</a> on 2024-10-31 14:52</div>
            <div class="timeline-body"><p>Yes. The <code>--script</code> flag was added after I opened this and solves this issue. I forgot to come back and close this out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ngnpope on 2024-10-31 14:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/10003.html">astral-sh/uv#10003</a> on 2024-12-18 15:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/11220.html">astral-sh/uv#11220</a> on 2025-02-04 17:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:21 UTC
    </footer>
</body>
</html>
