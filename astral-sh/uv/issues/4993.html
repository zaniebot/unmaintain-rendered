<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv requires Content-Length Header on wheels, breaking compatibility with some package repositories - astral-sh/uv #4993</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv requires Content-Length Header on wheels, breaking compatibility with some package repositories</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/4993">#4993</a>
        opened by <a href="https://github.com/philieeas">@philieeas</a>
        on 2024-07-11 14:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/philieeas">@philieeas</a></div>
            <div class="timeline-body"><p>When using uv as a drop-in replacement for pip, I encountered an issue where uv fails to download packages from a custom package repository due to the absence of the Content-Length Header in the response. The registry is getting proxied by nginx and it seems that strips that header(I unfortunately can&#x27;t change that fact).</p>
Steps to reproduce:
<ul>
<li>Install uv and create a virtual environment.</li>
<li>Run the command <code>uv pip install --index-url &lt;custom_repository_url&gt; &lt;package_name&gt;</code>(You need a server that doesn&#x27;t send the <code>Content-Length</code> header)</li>
<li>Observe the error message indicating that the Content-Length Header is missing from the response.</li>
</ul>
<ul>
<li>Tested UV platform: Windows, Tried on Linux too</li>
<li>Used UV version: uv 0.2.24 (527b711bc 2024-07-10)</li>
</ul>
Error message:
<pre><code>error: Failed to download &lt;package_name&gt;
  Caused by: content-length header is missing from response
</code></pre>
Response headers:
<p>The response headers from the custom package repository do not include the Content-Length Header, as shown below:</p>
<pre><code>HTTP/1.1 200 OK
Server: nginx
Date: Thu, 11 Jul 2024 14:38:49 GMT
Content-Type: binary/octet-stream
Transfer-Encoding: chunked
Connection: keep-alive
Accept-Ranges: bytes
Cache-Control: max-age=0, private, must-revalidate
Etag: &quot;9b2d35955a25abe3acb5c94aa54ad3b1&quot;
Last-Modified: Thu, 11 Jul 2024 14:34:01 GMT
Vary: Origin
Referrer-Policy: strict-origin-when-cross-origin
Strict-Transport-Security: max-age=31536000; includeSubDomains
</code></pre>
Expected behavior:
<p>uv should be able to download packages from custom package repositories even if the Content-Length Header is not present in the response. pip does not require this header, and uv should strive to maintain compatibility with pip.</p>
Suggested solution:
<p>Consider adding support for downloading packages without the Content-Length Header, or provide an option to disable the requirement for this header. This would allow uv to work seamlessly with custom package repositories that do not provide this header.</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">compatibility</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-11 15:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">network</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-11 15:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-11 16:01</div>
            <div class="timeline-body"><p>Thanks for the report.</p>
<p>This error is coming from a dependency</p>
<p>https://github.com/prefix-dev/async_http_range_reader/blob/f65c0c94ca4e3035b8561ee2ff8b1d5221b66abb/src/lib.rs#L319-L326</p>
<p>which we invoke at</p>
<p>https://github.com/astral-sh/uv/blob/d833910a5d210d72690ed25b03f4211607585f07/crates/uv-client/src/registry_client.rs#L578</p>
<p>We&#x27;ll need to fallback to downloading the entire file â€” which we do support but we might need to make some changes to the stream library to handle streaming without a content-length?</p>
<p>Note this is going to drastically impact performance as we need to inspect each wheel for metadata and this will bypass our optimizations that avoid downloading the full file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">great writeup</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-11 16:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-11 16:15</div>
            <div class="timeline-body"><p>With a little more investigation, it looks like <code>async_http_range_reader</code> needs the content length to allocate a memory map. It seems like a stretch to make it content-length agnostic? cc @baszalmstra (just a heads up)</p>
<p>I think we&#x27;d need a separate code path that doesn&#x27;t do async streaming which sounds like a pain.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hoechenberger">@hoechenberger</a> on 2024-07-11 16:53</div>
            <div class="timeline-body"><p>Seems to me like a problem the custom repository should fix ðŸ˜… and it would be an easy fix too, at least theoretically</p>
<p>still doesn&#x27;t help users who want to use uv as a drop-in replacement for pip, though</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-12 00:46</div>
            <div class="timeline-body"><p>I think we already have a fallback path that avoids the async reader. This should just be another case of that... I&#x27;ll look into it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-12 00:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-12 01:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-12 01:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-12 03:33</div>
            <div class="timeline-body"><p>Ah thanks @charliermarsh I thought we had that but somehow couldn&#x27;t find the path to it in the code.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:31:59 UTC
    </footer>
</body>
</html>
