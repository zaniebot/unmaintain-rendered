<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>lowest-direct resolution error with constraints - astral-sh/uv #8819</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>lowest-direct resolution error with constraints</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/8819">#8819</a>
        opened by <a href="https://github.com/azmeuk">@azmeuk</a>
        on 2024-11-04 22:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/azmeuk">@azmeuk</a></div>
            <div class="timeline-body"><p>The following dockerfile is the minimum reproducible example of a situation I met in a real project CI.</p>
<p>The <code>Dockerfile</code> runs with python 3.10 but there is a <code>setuptools</code> dependency for python 3.12+ in <code>pyproject.toml</code>.
The other dependency in <code>pyproject.toml</code> is pycountry, on its 22.1.10 version, and it has a <a href="https://github.com/pycountry/pycountry/blob/c02741e5e6c2de531c4a9a323794ad4029d6f216/setup.py#L43">loose dependency to setuptools</a>.</p>
<p>In this situation I would expect <code>setuptools</code> to not be a direct dependency. However <code>uv --resolution=lowest-direct</code> appears to resolve at the minimum setuptools available, that is 0.7.2. Of course, this is an old incompatible version, and the installation fails.</p>
<p>Removing the <code>python_version&gt;=&#x27;3.12&#x27;</code> constraint on the setuptools dependency appears to solve the issue, so I suppose this is a cause of the bug.</p>
<p>pyproject.toml</p>
<pre><code>[build-system]
requires = [&quot;hatchling&quot;]
build-backend = &quot;hatchling.build&quot;

[project]
name = &quot;foobar&quot;
version = &quot;0.0.1&quot;
requires-python = &quot;&gt;=3.10&quot;

dependencies = [
    &quot;pycountry &gt;= 22.1.10&quot;,
    &quot;setuptools &gt;= 50.0.0; python_version&gt;=&#x27;3.12&#x27;&quot;
]
</code></pre>
<p>Dockerfile</p>
<pre><code>FROM ghcr.io/astral-sh/uv:0.4-python3.10-bookworm-slim
WORKDIR /foobar
COPY foobar pyproject.toml /foobar/
RUN uv sync --resolution=lowest-direct
</code></pre>
<pre><code>docker build .           
[+] Building 11.3s (8/8) FINISHED                                                                                           docker:default
 =&gt; [internal] load build definition from Dockerfile                                                                                  0.1s
 =&gt; =&gt; transferring dockerfile: 185B                                                                                                  0.0s
 =&gt; [internal] load metadata for ghcr.io/astral-sh/uv:0.4-python3.10-bookworm-slim                                                    0.0s
 =&gt; [internal] load .dockerignore                                                                                                     0.1s
 =&gt; =&gt; transferring context: 2B                                                                                                       0.0s
 =&gt; [1/4] FROM ghcr.io/astral-sh/uv:0.4-python3.10-bookworm-slim                                                                      0.0s
 =&gt; [internal] load build context                                                                                                     0.1s
 =&gt; =&gt; transferring context: 326B                                                                                                     0.0s
 =&gt; CACHED [2/4] WORKDIR /foobar                                                                                                      0.0s
 =&gt; [3/4] COPY foobar pyproject.toml /foobar/                                                                                         0.3s
 =&gt; ERROR [4/4] RUN uv sync --resolution=lowest-direct                                                                               10.5s
------                                                                                                                                     
 &gt; [4/4] RUN uv sync --resolution=lowest-direct:                                                                                           
1.423 Using CPython 3.10.15 interpreter at: /usr/local/bin/python                                                                          
1.423 Creating virtual environment at: .venv                                                                                               
1.425 warning: No `requires-python` value found in the workspace. Defaulting to `&gt;=3.10`.                                                  
8.149 Resolved 4 packages in 6.72s                                                                                                         
9.249 error: Failed to prepare distributions
9.249   Caused by: Failed to download and build `setuptools==0.7.2`
9.249   Caused by: Build backend failed to determine requirements with `build_wheel()` (exit status: 1)
9.249 
9.249 [stdout]
9.249 --- build/src/tests/api_tests.txt	(original)
9.249 +++ build/src/tests/api_tests.txt	(refactored)
9.249 @@ -39,7 +39,7 @@
9.249      &gt;&gt;&gt; dist.py_version == sys.version[:3]
9.249      True
9.249  
9.249 -    &gt;&gt;&gt; print dist.platform
9.249 +    &gt;&gt;&gt; print(dist.platform)
9.249      None
9.249  
9.249  Including various computed attributes::
9.249 @@ -199,7 +199,7 @@
9.249  You can ask a WorkingSet to ``find()`` a distribution matching a requirement::
9.249  
9.249      &gt;&gt;&gt; from pkg_resources import Requirement
9.249 -    &gt;&gt;&gt; print ws.find(Requirement.parse(&quot;Foo==1.0&quot;))    # no match, return None
9.249 +    &gt;&gt;&gt; print(ws.find(Requirement.parse(&quot;Foo==1.0&quot;)))    # no match, return None
9.249      None
9.249  
9.249      &gt;&gt;&gt; ws.find(Requirement.parse(&quot;Bar==0.9&quot;))  # match, return distribution
9.249 @@ -212,7 +212,7 @@
9.249      ...     ws.find(Requirement.parse(&quot;Bar==1.0&quot;))
9.249      ... except pkg_resources.VersionConflict:
9.249      ...     exc = sys.exc_info()[1]
9.249 -    ...     print(str(exc))
9.249 +    ...     print((str(exc)))
9.249      ... else:
9.249      ...     raise AssertionError(&quot;VersionConflict was not raised&quot;)
9.249      (Bar 0.9 (http://example.com/something), Requirement.parse(&#x27;Bar==1.0&#x27;))
9.249 @@ -222,7 +222,7 @@
9.249  once for each existing distribution in the working set, and then is called
9.249  again for new distributions added thereafter::
9.249  
9.249 -    &gt;&gt;&gt; def added(dist): print &quot;Added&quot;, dist
9.249 +    &gt;&gt;&gt; def added(dist): print(&quot;Added&quot;, dist)
9.249      &gt;&gt;&gt; ws.subscribe(added)
9.249      Added Bar 0.9
9.249      &gt;&gt;&gt; foo12 = Distribution(project_name=&quot;Foo&quot;, version=&quot;1.2&quot;, location=&quot;f12&quot;)
9.249 @@ -338,52 +338,52 @@
9.249      &gt;&gt;&gt; from pkg_resources import invalid_marker as im, evaluate_marker as em
9.249      &gt;&gt;&gt; import os
9.249  
9.249 -    &gt;&gt;&gt; print(im(&quot;sys_platform&quot;))
9.249 +    &gt;&gt;&gt; print((im(&quot;sys_platform&quot;)))
9.249      Comparison or logical expression expected
9.249  
9.249 -    &gt;&gt;&gt; print(im(&quot;sys_platform==&quot;))  # doctest: +ELLIPSIS
9.249 +    &gt;&gt;&gt; print((im(&quot;sys_platform==&quot;)))  # doctest: +ELLIPSIS
9.249      unexpected EOF while parsing (...line 1)
9.249  
9.249 -    &gt;&gt;&gt; print(im(&quot;sys_platform==&#x27;win32&#x27;&quot;))
9.249 -    False
9.249 -
9.249 -    &gt;&gt;&gt; print(im(&quot;sys==&#x27;x&#x27;&quot;))
9.249 +    &gt;&gt;&gt; print((im(&quot;sys_platform==&#x27;win32&#x27;&quot;)))
9.249 +    False
9.249 +
9.249 +    &gt;&gt;&gt; print((im(&quot;sys==&#x27;x&#x27;&quot;)))
9.249      Unknown name &#x27;sys&#x27;
9.249  
9.249 -    &gt;&gt;&gt; print(im(&quot;(extra)&quot;))
9.249 +    &gt;&gt;&gt; print((im(&quot;(extra)&quot;)))
9.249      Comparison or logical expression expected
9.249  
9.249 -    &gt;&gt;&gt; print(im(&quot;(extra&quot;))  # doctest: +ELLIPSIS
9.249 +    &gt;&gt;&gt; print((im(&quot;(extra&quot;)))  # doctest: +ELLIPSIS
9.249      unexpected EOF while parsing (...line 1)
9.249  
9.249 -    &gt;&gt;&gt; print(im(&quot;os.open(&#x27;foo&#x27;)==&#x27;y&#x27;&quot;))
9.249 +    &gt;&gt;&gt; print((im(&quot;os.open(&#x27;foo&#x27;)==&#x27;y&#x27;&quot;)))
9.249      Language feature not supported in environment markers
9.249  
9.249 -    &gt;&gt;&gt; print(im(&quot;&#x27;x&#x27;==&#x27;y&#x27; and os.open(&#x27;foo&#x27;)==&#x27;y&#x27;&quot;))   # no short-circuit!
9.249 +    &gt;&gt;&gt; print((im(&quot;&#x27;x&#x27;==&#x27;y&#x27; and os.open(&#x27;foo&#x27;)==&#x27;y&#x27;&quot;)))   # no short-circuit!
9.249      Language feature not supported in environment markers
9.249  
9.249 -    &gt;&gt;&gt; print(im(&quot;&#x27;x&#x27;==&#x27;x&#x27; or os.open(&#x27;foo&#x27;)==&#x27;y&#x27;&quot;))   # no short-circuit!
9.249 +    &gt;&gt;&gt; print((im(&quot;&#x27;x&#x27;==&#x27;x&#x27; or os.open(&#x27;foo&#x27;)==&#x27;y&#x27;&quot;)))   # no short-circuit!
9.249      Language feature not supported in environment markers
9.249  
9.249 -    &gt;&gt;&gt; print(im(&quot;&#x27;x&#x27; &lt; &#x27;y&#x27;&quot;))
9.249 +    &gt;&gt;&gt; print((im(&quot;&#x27;x&#x27; &lt; &#x27;y&#x27;&quot;)))
9.249      &#x27;&lt;&#x27; operator not allowed in environment markers
9.249  
9.249 -    &gt;&gt;&gt; print(im(&quot;&#x27;x&#x27; &lt; &#x27;y&#x27; &lt; &#x27;z&#x27;&quot;))
9.249 +    &gt;&gt;&gt; print((im(&quot;&#x27;x&#x27; &lt; &#x27;y&#x27; &lt; &#x27;z&#x27;&quot;)))
9.249      Chained comparison not allowed in environment markers
9.249  
9.249 -    &gt;&gt;&gt; print(im(&quot;r&#x27;x&#x27;==&#x27;x&#x27;&quot;))
9.249 +    &gt;&gt;&gt; print((im(&quot;r&#x27;x&#x27;==&#x27;x&#x27;&quot;)))
9.249      Only plain strings allowed in environment markers
9.249  
9.249 -    &gt;&gt;&gt; print(im(&quot;&#x27;&#x27;&#x27;x&#x27;&#x27;&#x27;==&#x27;x&#x27;&quot;))
9.249 +    &gt;&gt;&gt; print((im(&quot;&#x27;&#x27;&#x27;x&#x27;&#x27;&#x27;==&#x27;x&#x27;&quot;)))
9.249      Only plain strings allowed in environment markers
9.249  
9.249 -    &gt;&gt;&gt; print(im(&#x27;&quot;&quot;&quot;x&quot;&quot;&quot;==&quot;x&quot;&#x27;))
9.249 +    &gt;&gt;&gt; print((im(&#x27;&quot;&quot;&quot;x&quot;&quot;&quot;==&quot;x&quot;&#x27;)))
9.249      Only plain strings allowed in environment markers
9.249  
9.249 -    &gt;&gt;&gt; print(im(r&quot;&#x27;x\n&#x27;==&#x27;x&#x27;&quot;))
9.249 +    &gt;&gt;&gt; print((im(r&quot;&#x27;x\n&#x27;==&#x27;x&#x27;&quot;)))
9.249      Only plain strings allowed in environment markers
9.249  
9.249 -    &gt;&gt;&gt; print(im(&quot;os.open==&#x27;y&#x27;&quot;))
9.249 +    &gt;&gt;&gt; print((im(&quot;os.open==&#x27;y&#x27;&quot;)))
9.249      Language feature not supported in environment markers
9.249  
9.249      &gt;&gt;&gt; em(&#x27;&quot;x&quot;==&quot;x&quot;&#x27;)
9.249 
9.249 [stderr]
9.249 RefactoringTool: Skipping optional fixer: buffer
9.249 RefactoringTool: Skipping optional fixer: idioms
9.249 RefactoringTool: Skipping optional fixer: set_literal
9.249 RefactoringTool: Skipping optional fixer: ws_comma
9.249 RefactoringTool: Refactored build/src/tests/api_tests.txt
9.249 RefactoringTool: Files that were modified:
9.249 RefactoringTool: build/src/tests/api_tests.txt
9.249 root: copying setuptools/tests/indexes/test_links_priority/external.html -&gt; build/src/setuptools/tests/indexes/test_links_priority
9.249 root: copying setuptools/tests/indexes/test_links_priority/simple/foobar/index.html -&gt; build/src/setuptools/tests/indexes/test_links_priority/simple/foobar
9.249 root: copying docs/conf.py -&gt; build/src/docs
9.249 root: copying docs/formats.txt -&gt; build/src/docs
9.249 root: copying docs/index.txt -&gt; build/src/docs
9.249 root: copying docs/easy_install.txt -&gt; build/src/docs
9.249 root: copying docs/python3.txt -&gt; build/src/docs
9.249 root: copying docs/using.txt -&gt; build/src/docs
9.249 root: copying docs/setuptools.txt -&gt; build/src/docs
9.249 root: copying docs/merge.txt -&gt; build/src/docs
9.249 root: copying docs/roadmap.txt -&gt; build/src/docs
9.249 root: copying docs/pkg_resources.txt -&gt; build/src/docs
9.249 root: copying docs/merge-faq.txt -&gt; build/src/docs
9.249 root: copying docs/_theme/nature/theme.conf -&gt; build/src/docs/_theme/nature
9.249 root: copying docs/_theme/nature/static/pygments.css -&gt; build/src/docs/_theme/nature/static
9.249 root: copying docs/_theme/nature/static/nature.css_t -&gt; build/src/docs/_theme/nature/static
9.249 root: copying docs/Makefile -&gt; build/src/docs
9.249 root: copying docs/_templates/indexsidebar.html -&gt; build/src/docs/_templates
9.249 root: copying _markerlib/markers.py -&gt; build/src/_markerlib
9.249 root: copying _markerlib/__init__.py -&gt; build/src/_markerlib
9.249 root: copying ez_setup.py -&gt; build/src
9.249 root: copying release.py -&gt; build/src
9.249 root: copying setup.py -&gt; build/src
9.249 root: copying distribute_setup.py -&gt; build/src
9.249 root: copying pkg_resources.py -&gt; build/src
9.249 root: copying easy_install.py -&gt; build/src
9.249 root: copying CHANGES.txt -&gt; build/src
9.249 root: copying CONTRIBUTORS.txt -&gt; build/src
9.249 root: copying DEVGUIDE.txt -&gt; build/src
9.249 root: copying README.txt -&gt; build/src
9.249 root: copying MANIFEST.in -&gt; build/src
9.249 root: copying launcher.c -&gt; build/src
9.249 Traceback (most recent call last):
9.249   File &quot;&lt;string&gt;&quot;, line 14, in &lt;module&gt;
9.249   File &quot;/root/.cache/uv/builds-v0/.tmpiFWFBR/lib/python3.10/site-packages/setuptools/build_meta.py&quot;, line 333, in get_requires_for_build_wheel
9.249     return self._get_build_requires(config_settings, requirements=[])
9.249   File &quot;/root/.cache/uv/builds-v0/.tmpiFWFBR/lib/python3.10/site-packages/setuptools/build_meta.py&quot;, line 303, in _get_build_requires
9.249     self.run_setup()
9.249   File &quot;/root/.cache/uv/builds-v0/.tmpiFWFBR/lib/python3.10/site-packages/setuptools/build_meta.py&quot;, line 521, in run_setup
9.249     super().run_setup(setup_script=setup_script)
9.249   File &quot;/root/.cache/uv/builds-v0/.tmpiFWFBR/lib/python3.10/site-packages/setuptools/build_meta.py&quot;, line 319, in run_setup
9.249     exec(code, locals())
9.249   File &quot;&lt;string&gt;&quot;, line 34, in &lt;module&gt;
9.249 AttributeError: module &#x27;distutils.util&#x27; has no attribute &#x27;run_2to3&#x27;
------
Dockerfile:4
--------------------
   2 |     WORKDIR /foobar
   3 |     COPY foobar pyproject.toml /foobar/
   4 | &gt;&gt;&gt; RUN uv sync --resolution=lowest-direct
   5 |     
--------------------
ERROR: failed to solve: process &quot;/bin/sh -c uv sync --resolution=lowest-direct&quot; did not complete successfully: exit code: 2
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;lowest-direct resolution also lowers indirect dependencies&quot; to &quot;lowest-direct resolution error with constraints&quot; by <a href="https://github.com/azmeuk">@azmeuk</a> on 2024-11-05 11:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-05 13:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-05 13:27</div>
            <div class="timeline-body"><p>Ah interesting... I do think this is a bug. We consider anything listed in the <code>pyproject.toml</code> to be direct for all environments, even if it&#x27;s only listed as direct in a specific environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-05 13:27</div>
            <div class="timeline-body"><p>(I assume this is not urgent / blocking since you can just remove the marker or add a <code>[tool.uv.constraint-dependencies]</code>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-05 14:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-05 21:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-05 21:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/azmeuk">@azmeuk</a> on 2024-11-05 21:34</div>
            <div class="timeline-body"><p>Thank you for the quick fix!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:35:14 UTC
    </footer>
</body>
</html>
