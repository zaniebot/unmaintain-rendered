<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv publish fails to upload package to nexus in CI but is able to push to nexus locally. - astral-sh/uv #11469</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>uv publish fails to upload package to nexus in CI but is able to push to nexus locally.</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/11469">#11469</a>
        opened by <a href="https://github.com/shoaibkhanz">@shoaibkhanz</a>
        on 2025-02-13 02:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/shoaibkhanz">@shoaibkhanz</a> on 2025-02-13 02:02</div>
            <div class="timeline-body"><h3>Question</h3>
<p>I am in the process of migrating over to uv from poetry. The last piece I am testing is publishing packages. My current issue is that while I am able to publish to nexus (uses the index from pyproject.toml) when I am testing locally but fails to do so during CI (github actions), now all permissions are set and I can able to push packages using poetry, so its some issue with CI permission in general.</p>
<p>Below is snippet of GH action job and the associated pyproject.toml</p>
<pre><code>  publish:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Build and Publish Release
        env:

          UV_PUBLISH_USERNAME: ${{ secrets.NEXUS_USERNAME}}
          UV_PUBLISH_PASSWORD: ${{ secrets.NEXUS_PASSWORD}}
        run: |
          uv build --no-sources
          uv publish --index nexus
</code></pre>
<p>here is the snippet from my pyproject.toml, I expect uv publish to respect my publish index within pyproject.toml even in CI.</p>
<pre><code>[[tool.uv.index]]
name = &quot;nexus&quot;
url = &quot;https://nexus.abc.com/repository/pypi-all/simple&quot;
publish-url = &quot;https://nexus.abc.com/repository/pypi/&quot;
default = true # exclude PyPI from the list of index

</code></pre>
<p>So my key question is why does it fail to publish when it can locally, I did try passing --publish-url but that hasnt worked. Any help would be appreciated. Please let me know if further details are needed.</p>
<h3>Platform</h3>
<p>macos (Darwin 24.3.0 arm64)</p>
<h3>Version</h3>
<p>uv 0.5.29 (Homebrew 2025-02-06)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @shoaibkhanz on 2025-02-13 02:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "uv publish fails to upload package to nexus in CI but is successful locally." to "uv publish fails to upload package to nexus in CI but is able to push to nexus from locally." by @shoaibkhanz on 2025-02-13 02:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "uv publish fails to upload package to nexus in CI but is able to push to nexus from locally." to "uv publish fails to upload package to nexus in CI but is able to push to nexus locally." by @shoaibkhanz on 2025-02-13 02:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-13 02:05</div>
            <div class="timeline-body"><p>Does the error message include any additional info? (And have you verified that the secrets are being set / propagated correctly in your CI pipeline? Like, that <code>UV_PUBLISH_USERNAME</code> is non-empty?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/shoaibkhanz">@shoaibkhanz</a> on 2025-02-13 02:18</div>
            <div class="timeline-body"><blockquote>
<p>Does the error message include any additional info? (And have you verified that the secrets are being set / propagated correctly in your CI pipeline? Like, that <code>UV_PUBLISH_USERNAME</code> is non-empty?)</p>
</blockquote>
<p>yes the username and password, seem to work as expected, to test it I also ran the publish using poetry to make sure I was able to publish using the same secrets, I could.</p>
<pre><code>here are the logs, 
2025-02-13T01:39:44.3357526Z   UV_CACHE_DIR: /home/runner/work/_temp/setup-uv-cache
2025-02-13T01:39:44.3358110Z   UV_PUBLISH_URL: https://nexus.abc.com/repository/pypi/
2025-02-13T01:39:44.3358875Z   UV_PUBLISH_USERNAME: ***
2025-02-13T01:39:44.3359243Z   UV_PUBLISH_PASSWORD: ***
2025-02-13T01:39:44.3359558Z ##[endgroup]
2025-02-13T01:39:44.3985740Z Building source distribution...
2025-02-13T01:39:44.7840907Z   × Failed to build `/home/runner/work/project/project`
2025-02-13T01:39:44.7857138Z   ├─▶ Failed to resolve requirements from `build-system.requires`
2025-02-13T01:39:44.7857957Z   ├─▶ No solution found when resolving: `hatchling`
2025-02-13T01:39:44.7860102Z   ╰─▶ Because hatchling was not found in the package registry and you require
2025-02-13T01:39:44.7861886Z       hatchling, we can conclude that your requirements are unsatisfiable.
2025-02-13T01:39:44.7863064Z 
2025-02-13T01:39:44.7863815Z       hint: An index URL (https://nexus.abc.com/repository/pypi-all/simple)
2025-02-13T01:39:44.7866345Z       could not be queried due to a lack of valid authentication credentials
2025-02-13T01:39:44.7866950Z       (401 Unauthorized).
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/shoaibkhanz">@shoaibkhanz</a> on 2025-02-13 02:20</div>
            <div class="timeline-body"><p>Just so you have the full CI here, it is</p>
<pre><code>name: Test and Publish

on:
  pull_request:
  release:
    types:
      - published

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python_version: [ '3.13' ]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python_version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        # with:
        #   python-version: ${{ matrix.python_version }}

      - name: Enable Caching
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: &quot;uv.lock&quot;

      - name: Install Python Dependencies
        if: steps.setup-uv.outputs.cache-hit != 'true'
        env:
          UV_INDEX_NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          UV_INDEX_NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
        run: |
          uv sync

      # - name: Github Payload # for debugging
      #   run: echo &quot;payload:\n${PAYLOAD}\n&quot;
      #   env:
      #     PAYLOAD: ${{ toJSON(github.event) }}

      - name: Test
        run: |
          uv run task test

      - name: Minimize uv cache
        run: uv cache prune --ci

  publish:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Build and Publish Release
        env:

          UV_PUBLISH_USERNAME: ${{ secrets.NEXUS_USERNAME}}
          UV_PUBLISH_PASSWORD: ${{ secrets.NEXUS_PASSWORD}}
        run: |
          uv build --no-sources
          uv publish --index nexus


</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-13 02:29</div>
            <div class="timeline-body"><p>It looks like it's failing on <code>uv build</code> because you don't have <code>UV_INDEX_NEXUS_PASSWORD</code> set for read permissions?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/shoaibkhanz">@shoaibkhanz</a> on 2025-02-13 02:43</div>
            <div class="timeline-body"><p>that actually fixed it thanks, I didnt think building would need access to nexus, thought that would happen within CI and then pushed to nexus, which indeed not the case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/shoaibkhanz">@shoaibkhanz</a> on 2025-02-13 02:45</div>
            <div class="timeline-body"><p>I have follow up question though, would I need to then have <code>UV_INDEX_NEXUS_PASSWORD</code> and <code>UV_PUBLISH_PASSWORD</code> , that seem to be the case</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/shoaibkhanz">@shoaibkhanz</a> on 2025-02-13 02:51</div>
            <div class="timeline-body"><p>I understand that during build uv isnt only packaging my code, its verifying and resolving the dependency as well and hence needs index username and password.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-13 03:01</div>
            <div class="timeline-body"><p>We're building the source distribution (packaging your code) and that requires a build system, in this case, <code>build-system.requires</code> is <code>hatchling</code> so we need to download it. Presumably you'd be interested in #3957 which would avoid needing to fetch any Python dependencies to build your package.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @shoaibkhanz on 2025-02-13 11:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:25 UTC
    </footer>
</body>
</html>
