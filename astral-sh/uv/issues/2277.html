<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Getting &quot;Received some unexpected HTML when working with&quot; error installing from extra-index - astral-sh/uv #2277</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Getting &quot;Received some unexpected HTML when working with&quot; error installing from extra-index</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/2277">#2277</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-03-07 14:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><p>Originally reported by @korneevm.</p>
<hr>
<p>Hi!</p>
<p>I&#x27;m using <code>uv 0.1.15 (a8ac7b1eb 2024-03-05)</code> от Mac (intel). I&#x27;ve set env variable <code>UV_EXTRA_INDEX_URL=&quot;https://readonly:secret@pypi.localrepo.tech/pypi/&quot;</code> (<a href="https://pypicloud.readthedocs.io/en/latest/">PyPICloud</a>).</p>
<p>When I do <code>uv --verbose pip install internal-library==1.1.0</code> to install my package, I&#x27;m getting an error:</p>
<pre><code>uv::requirements::from_source source=internal-library==1.1.0
    0.001615s DEBUG uv_interpreter::python_environment Found a virtualenv through VIRTUAL_ENV at: /Users/korneevm/projects/some_project/env
    0.001929s DEBUG uv_interpreter::interpreter Cached interpreter info for Python 3.11.6, skipping probing: /Users/korneevm/projects/some_project/env/bin/python
    0.001946s DEBUG uv::commands::pip_install Using Python 3.11.6 environment at /Users/korneevm/projects/some_project/env/bin/python
    0.005726s DEBUG uv_client::registry_client Using registry request timeout of 300s
 uv_client::flat_index::from_entries
 uv_resolver::resolver::solve
      0.328674s   0ms DEBUG uv_resolver::resolver Solving with target Python version 3.11.6
   uv_resolver::resolver::choose_version package=root
   uv_resolver::resolver::get_dependencies package=root, version=0a0.dev0
        0.328779s   0ms DEBUG uv_resolver::resolver Adding direct dependency: internal-library==1.1.0
   uv_resolver::resolver::choose_version package=internal-library
     uv_resolver::resolver::package_wait package_name=internal-library
 uv_resolver::resolver::process_request request=Versions internal-library
   uv_client::registry_client::simple_api package=internal-library
     uv_client::cached_client::get_cacheable
       uv_client::cached_client::read_and_parse_cache file=/Users/korneevm/Library/Caches/uv/simple-v3/f8028b1c869304e5/internal-library.rkyv
 uv_resolver::resolver::process_request request=Prefetch internal-library ==1.1.0
 uv_client::cached_client::from_path_sync path=&quot;/Users/korneevm/Library/Caches/uv/simple-v3/f8028b1c869304e5/internal-library.rkyv&quot;
          0.329441s   0ms DEBUG uv_client::cached_client Found stale response for: https://pypi.localrepo.tech/pypi/internal-library/
          0.329451s   0ms DEBUG uv_client::cached_client Sending revalidation request for: https://pypi.localrepo.tech/pypi/internal-library/
       uv_client::cached_client::revalidation_request url=&quot;https://pypi.localrepo.tech/pypi/internal-library/&quot;
          1.624882s   1s  DEBUG uv_client::cached_client Found modified response for: https://pypi.localrepo.tech/pypi/internal-library/
       uv_client::cached_client::new_cache file=/Users/korneevm/Library/Caches/uv/simple-v3/f8028b1c869304e5/internal-library.rkyv
       uv_client::registry_client::parse_simple_api package=internal-library
         uv_client::html::parse url=https://readonly:secret@pypi.localrepo.tech/pypi/internal-library/
   uv_resolver::version_map::from_metadata
   uv_distribution::distribution_database::get_or_build_wheel_metadata dist=internal-library==1.1.0
     uv_client::registry_client::wheel_metadata built_dist=internal-library==1.1.0
       uv_client::cached_client::get_serde
         uv_client::cached_client::get_cacheable
           uv_client::cached_client::read_and_parse_cache file=/Users/korneevm/Library/Caches/uv/wheels-v0/index/f8028b1c869304e5/internal-library/internal_library-1.1.0-py3-none-any.msgpack
        1.628458s   1s  DEBUG uv_resolver::resolver Searching for a compatible version of internal-library (==1.1.0)
 uv_client::cached_client::from_path_sync path=&quot;/Users/korneevm/Library/Caches/uv/wheels-v0/index/f8028b1c869304e5/internal-library/internal_library-1.1.0-py3-none-any.msgpack&quot;
        1.628501s   1s  DEBUG uv_resolver::resolver Selecting: internal-library==1.1.0 (internal_library-1.1.0-py3-none-any.whl)
   uv_resolver::resolver::get_dependencies package=internal-library, version=1.1.0
     uv_resolver::resolver::distributions_wait package_id=internal-library-1.1.0
              1.628580s   0ms DEBUG uv_client::cached_client No cache entry for: https://pypi.localrepo.tech/api/package/internal-library/internal_library-1.1.0-py3-none-any.whl#sha256=c34eb6ca75eca3956b00a03c7d17ea871636e850266db9176b597af32f95a095
           uv_client::cached_client::fresh_request url=&quot;https://pypi.localrepo.tech/api/package/internal-library/internal_library-1.1.0-py3-none-any.whl#sha256=c34eb6ca75eca3956b00a03c7d17ea871636e850266db9176b597af32f95a095&quot;
           uv_client::cached_client::new_cache file=/Users/korneevm/Library/Caches/uv/wheels-v0/index/f8028b1c869304e5/internal-library/internal_library-1.1.0-py3-none-any.msgpack
           uv_client::registry_client::read_metadata_range_request wheel=internal_library-1.1.0-py3-none-any.whl
          1.939138s 310ms  WARN uv_client::registry_client Range requests not supported for internal_library-1.1.0-py3-none-any.whl; downloading wheel
        2.560580s 932ms DEBUG uv_resolver::resolver Adding transitive dependency: structlog&gt;=22.1.0
        2.560611s 932ms DEBUG uv_resolver::resolver Adding transitive dependency: orjson&gt;=3.7.8
        2.560620s 932ms DEBUG uv_resolver::resolver Adding transitive dependency: structlog-sentry&gt;=2.0.0
   uv_resolver::resolver::choose_version package=structlog
     uv_resolver::resolver::package_wait package_name=structlog
 uv_resolver::resolver::process_request request=Versions structlog
   uv_client::registry_client::simple_api package=structlog
     uv_client::cached_client::get_cacheable
       uv_client::cached_client::read_and_parse_cache file=/Users/korneevm/Library/Caches/uv/simple-v3/f8028b1c869304e5/structlog.rkyv
 uv_resolver::resolver::process_request request=Versions orjson
   uv_client::registry_client::simple_api package=orjson
     uv_client::cached_client::get_cacheable
       uv_client::cached_client::read_and_parse_cache file=/Users/korneevm/Library/Caches/uv/simple-v3/f8028b1c869304e5/orjson.rkyv
 uv_client::cached_client::from_path_sync path=&quot;/Users/korneevm/Library/Caches/uv/simple-v3/f8028b1c869304e5/structlog.rkyv&quot;
 uv_resolver::resolver::process_request request=Versions structlog-sentry
   uv_client::registry_client::simple_api package=structlog-sentry
     uv_client::cached_client::get_cacheable
       uv_client::cached_client::read_and_parse_cache file=/Users/korneevm/Library/Caches/uv/simple-v3/f8028b1c869304e5/structlog-sentry.rkyv
 uv_resolver::resolver::process_request request=Prefetch structlog-sentry &gt;=2.0.0
 uv_resolver::resolver::process_request request=Prefetch orjson &gt;=3.7.8
 uv_resolver::resolver::process_request request=Prefetch structlog &gt;=22.1.0
          2.561054s   0ms DEBUG uv_client::cached_client No cache entry for: https://pypi.localrepo.tech/pypi/structlog/
       uv_client::cached_client::fresh_request url=&quot;https://pypi.localrepo.tech/pypi/structlog/&quot;
 uv_client::cached_client::from_path_sync path=&quot;/Users/korneevm/Library/Caches/uv/simple-v3/f8028b1c869304e5/orjson.rkyv&quot;
 uv_client::cached_client::from_path_sync path=&quot;/Users/korneevm/Library/Caches/uv/simple-v3/f8028b1c869304e5/structlog-sentry.rkyv&quot;
          2.561158s   0ms DEBUG uv_client::cached_client No cache entry for: https://pypi.localrepo.tech/pypi/orjson/
       uv_client::cached_client::fresh_request url=&quot;https://pypi.localrepo.tech/pypi/orjson/&quot;
          2.561229s   0ms DEBUG uv_client::cached_client No cache entry for: https://pypi.localrepo.tech/pypi/structlog-sentry/
       uv_client::cached_client::fresh_request url=&quot;https://pypi.localrepo.tech/pypi/structlog-sentry/&quot;
       uv_client::cached_client::new_cache file=/Users/korneevm/Library/Caches/uv/simple-v3/f8028b1c869304e5/structlog.rkyv
       uv_client::registry_client::parse_simple_api package=structlog
         uv_client::html::parse url=https://pypi.org/project/structlog/
error: Received some unexpected HTML from https://pypi.org/project/structlog/
  Caused by: Unexpected fragment (expected `#sha256=...`) on URL: content
</code></pre>
<p>While <code>pip install internal-library==1.1.0</code> works fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-07 14:14</div>
            <div class="timeline-body"><p>@korneevm -- Heads up I recreated your issue here as your initial post may have included some sensitive credentials in the verbose logging.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">registry</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-07 14:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-07 14:15</div>
            <div class="timeline-body"><p>Do you have an <code>--index-url</code> or <code>UV_INDEX_URL</code> set?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-07 14:20</div>
            <div class="timeline-body"><p>For some reason at the end you&#x27;re looking in https://pypi.org/project/structlog/ instead of https://pypi.org/simple/structlog/, so I&#x27;m wondering if the index URL was overridden with the wrong value.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-07 14:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/korneevm">@korneevm</a> on 2024-03-08 02:08</div>
            <div class="timeline-body"><p>@charliermarsh thanks! I didn&#x27;t override <code>index-url</code> in any way, just added <code>UV_EXTRA_INDEX_URL</code> to the envs with the same value as <code>PIP_EXTRA_INDEX_URL</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-08 02:27</div>
            <div class="timeline-body"><p>As far as I can tell from the logs, it seems like your index is redirecting from <code>https://pypi.localrepo.tech/pypi/structlog</code> to <code>https://pypi.org/project/structlog</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/korneevm">@korneevm</a> on 2024-03-08 02:28</div>
            <div class="timeline-body"><p>I&#x27;ve checked it again - when I do <code>pip install any-package --verbose</code> I get <code>Looking in indexes: https://pypi.org/simple, https://readonly:****@pypi.localrepo.tech/pypi/</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-08 05:59</div>
            <div class="timeline-body"><p>Is it possible that your index is redirecting when packages aren&#x27;t present? What happens if you navigate to https://readonly:secret@pypi.localrepo.tech/pypi/structlog in your browser or with cURL?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/korneevm">@korneevm</a> on 2024-03-08 08:54</div>
            <div class="timeline-body"><p>@charliermarsh I think I&#x27;ve found a way to reproduce this issue:</p>
<ol>
<li>We use the latest https://hub.docker.com/r/stevearc/pypicloud/tags with default config</li>
<li>If I set <code>UV_EXTRA_INDEX_URL</code> to https://readonly:****@pypi.localrepo.tech/pypi/ install fails with the error above</li>
<li>If I set it to https://readonly:****@pypi.localrepo.tech/simple/ it works like a charm</li>
</ol>
<p><code>uv</code> here definitely behaves differently from pip/pip-tools but I&#x27;m not sure how many people will have the same problem, I&#x27;ll fix pip URLs in my repos and call it a day :-)</p>
<p>Thanks a lot for your help, I definitely wouldn&#x27;t be able to figure this out alone.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-08 20:31</div>
            <div class="timeline-body"><p>Oh interesting! That&#x27;s good to know. Perhaps your index does some redirecting and preserves the <code>pypi</code>. My guess is that when <code>pip</code> tries <code>https://pypi.localrepo.tech/pypi/structlog</code> (which is invalid), it then moves on to checking PyPI, whereas we stop at the first &quot;valid&quot; index.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-08 20:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:30:20 UTC
    </footer>
</body>
</html>
