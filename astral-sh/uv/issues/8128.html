<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv dendency resolution upper-bound problem leading to a suboptimal resolution - astral-sh/uv #8128</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv dendency resolution upper-bound problem leading to a suboptimal resolution</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/8128">#8128</a>
        opened by <a href="https://github.com/muellerzr">@muellerzr</a>
        on 2024-10-11 14:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/muellerzr">@muellerzr</a></div>
            <div class="timeline-body"><p>Hi! I&#x27;m trying to upgrade <a href="https://github.com/huggingface/accelerate">accelerate</a> to use <code>uv pip install</code> and we&#x27;re hitting a weird issue where the dependency resolution wants to only install a very old version of <code>datasets</code> and as a result our suite fails. I&#x27;m specifying the exact same environment and everything as the working old installation via just <code>pip install</code> &amp; python 3.8. As a result it <em>should</em> be installing datasets 3.0.0 like the original workflow does, however we&#x27;re finding it&#x27;s installing an old 2.x.x version instead.</p>
<p>Any help would be appreciated.</p>
<p>Here is the <a href="https://github.com/huggingface/accelerate/blob/main/.github/workflows/test.yml">old workflow</a> and here is the <a href="https://github.com/huggingface/accelerate/blob/uv-take2/.github/workflows/test.yml">new one</a>.</p>
<p>A broken run log is available <a href="https://github.com/huggingface/accelerate/actions/runs/11293674113/job/31412352964">here</a>, which is showing that the wrong version of <code>datasets</code> is being installed (should be 3.0.0+)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-11 14:13</div>
            <div class="timeline-body"><p>Hey. I&#x27;m happy to look into <em>why</em> that version of datasets is selected, but it&#x27;s likely that this is an equally valid resolution to whatever you&#x27;re seeing with <code>pip install</code>. Your datasets dependency is unconstrained, so my guess is that uv is installing a new version of some other package (as compared to pip&#x27;s resolution) which is leading us to be forced into selecting an older version of datasets. In the absence of defined constraints, it&#x27;s not clear that using datasets 3.0.0 is better than 2.x.x (assuming we&#x27;re giving you a newer version of some other package than in pip&#x27;s resolution). My suggestion here is typically to add a constraint on datasets itself, if you&#x27;re <em>expecting</em> a certain version to be used.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-11 14:14</div>
            <div class="timeline-body"><p>(I&#x27;ll try to figure out the dependencies that are leading to this resolution, though. It&#x27;s typically because something else you depend on is applying an upper-bound on datasets.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/muellerzr">@muellerzr</a> on 2024-10-11 14:15</div>
            <div class="timeline-body"><p>@charliermarsh however the key is it&#x27;s <em>not</em>. Using <code>pip install</code> natively gives a <strong>different valid</strong> resolution than using <code>uv</code>. If that were the case, I&#x27;d expect them to be the same as well but they are <strong>not</strong></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-11 14:17</div>
            <div class="timeline-body"><p>Can you clarify your comment? There are many equally-valid resolutions for that set of requirements. Separately, do you have a reference to pip&#x27;s resolution that I can use for comparison (e.g., a comparable CI run)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/muellerzr">@muellerzr</a> on 2024-10-11 14:19</div>
            <div class="timeline-body"><p>@charliermarsh sure.</p>
<p>Currently working run: https://github.com/huggingface/accelerate/actions/runs/11285497593/job/31412054466?pr=3154</p>
<p>Broken run: https://github.com/huggingface/accelerate/actions/runs/11293796747/job/31412771583</p>
<p>(See the Show Installed Libraries steps)</p>
<p>Otherwise phrased as:</p>
<ul>
<li><code>uv pip install</code>&#x27;s resolution version for <code>datasets</code> leads to <code>datasets==2.14.4</code></li>
<li><code>pip install</code>&#x27;s resolution version for <code>datasets</code> leads to the expected <code>datasets==3.0.1</code></li>
</ul>
<p>Everything is the same between both runs except using <code>uv</code> to do the installs</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-11 14:35</div>
            <div class="timeline-body"><p>Ok... So it looks like the uv resolution ends up choosing a more recent version of fsspec (<code>fsspec==2024.9.0</code>), while the pip resolution ends up with <code>fsspec==2024.6.1</code>. <code>datasets</code> then applies an upper-bound constraint to <code>fsspec</code> (<code>fsspec[http] (&lt;=2024.6.1,&gt;=2023.1.0)</code>), so we backtrack to an older version of datasets that does not have such a bound.</p>
<p>pip&#x27;s resolution is more intuitive in that case (and we&#x27;re working on adding better heuristics for these kinds of upper-bound cases -- it also happens often with Numba, which puts an upper-bound on Numba), but formally both are correct -- they&#x27;re just different solutions given the set of constraints. That&#x27;s why I&#x27;d typically recommend adding a <code>datasets&gt;=3</code> lower-bound to your requirements. Otherwise, it&#x27;s not <em>incorrect</em> for a resolver to give you a resolution that prioritizes getting the most recent <code>fsspec</code>, even if it&#x27;s not the preferred outcome.</p>
<p>\cc @konstin as another example of this upper-bound problem leading to a suboptimal resolution</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/muellerzr">@muellerzr</a> on 2024-10-11 14:40</div>
            <div class="timeline-body"><p>Sadly doing such a large pin like that is a bit of a non-negotiable with our testing and resolutions since we build our frameworks to be backwards compatible as much as possible. I&#x27;d rather wait to upgrade to <code>uv</code> until this problem can be fixed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-11 14:40</div>
            <div class="timeline-body"><p>To clarify, I consider the resolution here to be formally correct, but unintuitive for users (and want to change it -- the same pattern has come up before).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-11 14:41</div>
            <div class="timeline-body"><p>Another option is you can reorder your dependencies to instruct uv to prioritize datasets over other packages.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-11 14:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;UV resolution seems to not be working properly?&quot; to &quot;uv depdendency resolution upper-bound problem leading to a suboptimal resolution&quot; by <a href="https://github.com/muellerzr">@muellerzr</a> on 2024-10-11 14:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;uv depdendency resolution upper-bound problem leading to a suboptimal resolution&quot; to &quot;uv dendency resolution upper-bound problem leading to a suboptimal resolution&quot; by <a href="https://github.com/muellerzr">@muellerzr</a> on 2024-10-11 14:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-10-11 16:06</div>
            <div class="timeline-body"><p>I want to offer a more general perspective on version constraints: Using the APIs of your dependencies, you require at least a certain version of that dependency implictly: There&#x27;s a specific version under which your code works, and lower version that doesn&#x27;t have the APIs you use yet. By specifying lower bounds on your dependencies, you make those bounds explicit, and you avoid your users accidentally installing an older, incompatible version due to other (transitive) dependencies they have: In your case, datasets v3 is selectable, but in other cases, a user may depend on a library foo that has <code>datasets&lt;3</code>, they get a broken accelerate and don&#x27;t realize that it&#x27;s due to the transitive datasets v2 that should have never been selected.</p>
<p>You can test your lower version bounds with <code>--resolution lowest</code> or <code>--resolution lowest-direct</code> (https://docs.astral.sh/uv/concepts/resolution/#lower-bounds). We recommend a CI jobs that checks whether the package works with one of these resolution-lowest settings.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/muellerzr">@muellerzr</a> on 2024-10-11 16:17</div>
            <div class="timeline-body"><p>As a user who was advertised to use uv as a drop in replacement, this comes with expectations that behaviors, including resolutions, will be the same between uv and standard pip. The point of this issue is it&#x27;s not, and if I have the choice of running a debugging script to figure out sudden lower bounds and using the same, I will stick to using what doesn&#x27;t break. (Until it&#x27;s fixed)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-10-11 17:29</div>
            <div class="timeline-body"><p>As someone who contributes to pip&#x27;s resolution code it should be noted that pip makes no guarantees it will produce the same resolution between pip versions, in fact pip makes no guarantees it would produce the same resolution on the same version of pip when run <a href="https://github.com/pypa/pip/issues/10824">twice in a row</a>.</p>
<p>Pip only guarantees that <em>if</em> it produces a resolution, it will be a valid resolution, so if uv is doing that then I would consider that compatible with pip. As pip can just as easily break your assumptions about what it should resolve to between versions.</p>
<p><em>That said</em>, I have been a long advocate that Python package resolution algorithms should prefer requirements with upper bounds. I plan to open a PR this weekend to solve <a href="https://github.com/pypa/pip/issues/12993">pypa/pip#12993</a> on the pip side, it is a less extreme version of my <a href="https://github.com/astral-sh/uv/issues/1398#issuecomment-2013504447">previous suggestion</a> but it seems to have significant real world improvement, in my testing, of both solving faster and giving a resolution more intuitive to a user.</p>
<p>I think uv should probably do the same, but they would need to do their own testing. But, like, if uv could hold off for a bit, I might be able to brag I made a PR that made pip resolve faster than uv in a handful of extreme edge cases ðŸ˜‰ .</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-27 14:29</div>
            <div class="timeline-body"><p>I&#x27;ve confirmed that more recent versions of uv correctly resolves to <code>datasets==3.2.0</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-27 14:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-27 14:29</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:34:41 UTC
    </footer>
</body>
</html>
