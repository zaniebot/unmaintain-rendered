<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv pip install` ignores explicit package when it's in `override-dependencies` - astral-sh/uv #16933</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`uv pip install` ignores explicit package when it's in `override-dependencies`</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/16933">#16933</a>
        opened by <a href="https://github.com/jreiml">@jreiml</a>
        on 2025-12-02 17:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/jreiml">@jreiml</a> on 2025-12-02 17:09</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Possibly related to #9073.</p>
<p>When a package is listed in <code>[tool.uv] override-dependencies</code>, <code>uv pip install</code> ignores the version/URL/file you specify and resolves from indexes instead.</p>
<p><strong>Minimal reproduction:</strong></p>
<pre><code class="language-bash">mkdir /tmp/uv-bug-repro &amp;&amp; cd /tmp/uv-bug-repro

cat &gt; pyproject.toml &lt;&lt; 'EOF'
[project]
name = &quot;uv-bug-repro&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = []

[tool.uv]
override-dependencies = [&quot;ray&quot;]
EOF

uv venv .venv

# Try to install ray 3.0.0.dev0 from direct URL
uv pip install --python .venv --no-deps \
  &quot;https://s3-us-west-2.amazonaws.com/ray-wheels/master/def11199f9b2cef89e63f7d67c18ec221aed2c16/ray-3.0.0.dev0-cp312-cp312-manylinux2014_x86_64.whl&quot;
</code></pre>
<p><strong>Expected:</strong> <code>ray==3.0.0.dev0</code> installed from the URL</p>
<p><strong>Actual:</strong> <code>ray==2.52.1</code> installed from PyPI</p>
<pre><code>Resolved 1 package in 23ms
Downloading ray (68.9MiB)
 Downloaded ray
Prepared 1 package in 540ms
Installed 1 package in 99ms
 + ray==2.52.1
</code></pre>
<p>The same happens with version specifiers and local files:</p>
<pre><code class="language-bash">uv pip install --python .venv --no-deps &quot;ray==2.51.0&quot;
# Installs ray==2.52.1 instead of 2.51.0

uv pip install --python .venv --no-deps /tmp/ray-3.0.0.dev0-cp312-cp312-manylinux2014_x86_64.whl
# Installs ray==2.52.1 instead of the local file
</code></pre>
<details>
<summary>Verbose output (<code>-vvv</code>)</summary>

<pre><code>DEBUG uv 0.9.14
DEBUG At least one requirement is not satisfied: https://s3-us-west-2.amazonaws.com/ray-wheels/master/.../ray-3.0.0.dev0-cp312-cp312-manylinux2014_x86_64.whl
DEBUG Adding direct dependency: ray*
TRACE Fetching metadata for ray from https://pypi.org/simple/ray/
...
TRACE Sending fresh GET request for https://pypi.org/packages/.../ray-2.52.1-cp312-cp312-manylinux2014_x86_64.whl
...
 + ray==2.52.1
</code></pre>
<p>The URL/file we provided is never fetched. uv resolves <code>ray</code> from PyPI instead.</p>
</details>

<p><strong>Workaround:</strong></p>
<pre><code class="language-bash">UV_NO_CONFIG=1 uv pip install --python .venv --no-deps &quot;https://...&quot;
# Correctly installs ray==3.0.0.dev0
</code></pre>
<p><strong>Additional notes:</strong></p>
<ul>
<li><code>--prerelease allow</code> does not help</li>
<li>Adding <code>[tool.uv.sources]</code> with the same URL does not help</li>
<li>Without <code>override-dependencies</code>, it works correctly</li>
</ul>
<h3>Platform</h3>
<p>Linux 5.15.0-1070-nvidia x86_64 GNU/Linux</p>
<h3>Version</h3>
<p>uv 0.9.14</p>
<h3>Python version</h3>
<p>Python 3.12.3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @jreiml on 2025-12-02 17:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-12-03 05:54</div>
            <div class="timeline-body"><p>Can you say more about the use-case? On first glance this seems correct, since putting <code>ray</code> in overrides is equivalent to replacing any dependency on Ray with, well, <code>ray</code> (i.e., &quot;Accept any version of <code>ray</code> from any listed registry).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jreiml">@jreiml</a> on 2025-12-03 21:22</div>
            <div class="timeline-body"><p>Thanks for having a look! Regarding the use-case: This impacts CI/docker workflows where I rely on <code>uv export</code> + <code>uv pip install</code>.</p>
<p>While I understand that <code>override-dependencies</code> is intended to reset constraints, the current behavior is problematic because <strong><code>uv pip install</code> applies the project configuration partially.</strong></p>
<p>It reads <code>pyproject.toml</code> to apply the <code>override-dependencies</code> (stripping the version/URL provided via CLI), but it ignores <code>[tool.uv.sources]</code>.</p>
<p>This leaves <code>uv</code> in an inconsistent state: it enforces the override (removing CLI constraints), causing it to incorrectly default to PyPI.</p>
<p>If <code>uv pip install</code> respects <code>override-dependencies</code>, it must also respect <code>tool.uv.sources</code>.</p>
<p>From https://docs.astral.sh/uv/pip/compatibility/#packages-that-exist-on-multiple-indexes:</p>
<blockquote>
<p>&quot;uv's behavior is such that if a package exists on an internal index, it should always be installed from the internal index, and never from PyPI.&quot;</p>
</blockquote>
<h2>Examples</h2>
<p>If I define a source in <code>[tool.uv.sources]</code>, <code>ray</code> should resolve to that source.</p>
<hr />
<h3>Example 1: URL via <code>tool.uv.sources</code> (inconsistent)</h3>
<pre><code class="language-toml">[project]
name = &quot;project-a&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = [&quot;project-b&quot;]  # depends on ray==2.52.1

[tool.uv]
override-dependencies = [&quot;ray&quot;]

[tool.uv.sources]
ray = { url = &quot;https://s3-us-west-2.amazonaws.com/ray-wheels/master/def11199f9b2cef89e63f7d67c18ec221aed2c16/ray-3.0.0.dev0-cp312-cp312-manylinux2014_x86_64.whl&quot; }
</code></pre>
<p>| Command | Result |
|---------|--------|
| <code>uv sync</code> | ✅ Installs <code>ray==3.0.0.dev0</code> from URL |
| <code>uv pip install &quot;ray @ https://...&quot;</code> | ❌ Installs <code>ray==2.52.1</code> from PyPI |</p>
<p><code>uv pip install</code> applies the override (replacing my CLI URL with bare <code>ray</code>) but ignores <code>tool.uv.sources</code>, so it resolves from PyPI.</p>
<hr />
<h3>Example 2: URL inlined in <code>override-dependencies</code> (works)</h3>
<pre><code class="language-toml">[tool.uv]
override-dependencies = [&quot;ray @ https://s3-us-west-2.amazonaws.com/ray-wheels/master/def11199f9b2cef89e63f7d67c18ec221aed2c16/ray-3.0.0.dev0-cp312-cp312-manylinux2014_x86_64.whl&quot;]
</code></pre>
<p>| Command | Result |
|---------|--------|
| <code>uv sync</code> | ✅ Installs <code>ray==3.0.0.dev0</code> from URL |
| <code>uv pip install &quot;ray @ https://...&quot;</code> | ✅ Installs <code>ray==3.0.0.dev0</code> from URL |</p>
<p>This works because the URL is baked into the override itself.</p>
<hr />
<h3>Example 3: Custom index via <code>tool.uv.index</code> (works)</h3>
<pre><code class="language-toml">[tool.uv]
override-dependencies = [&quot;ray==3.0.0.dev0+custom&quot;]

[[tool.uv.index]]
url = &quot;https://pypi.internal&quot;
name = &quot;pypi-internal&quot;
</code></pre>
<p>| Command                                   | Result                                                                      |
|-------------------------------------------|-----------------------------------------------------------------------------|
| <code>uv sync</code>                                 | ✅ Installs custom build from <code>pypi-internal</code>                                |
| <code>uv pip install &quot;ray==3.0.0.dev0+custom&quot;</code> | ✅ Installs custom build from <code>pypi-internal</code>                                |</p>
<p>This works because <code>uv pip install</code> searches all non-explicit indexes.</p>
<hr />
<h3>Example 4: Explicit index via <code>tool.uv.sources</code> (broken)</h3>
<pre><code class="language-toml">[tool.uv]
override-dependencies = [&quot;ray==3.0.0.dev0+custom&quot;]

[[tool.uv.index]]
url = &quot;https://pypi.internal&quot;
name = &quot;pypi-internal&quot;
explicit = true

[tool.uv.sources]
ray = { index = &quot;pypi-internal&quot; }
</code></pre>
<p>| Command                                   | Result                                                                      |
|-------------------------------------------|-----------------------------------------------------------------------------|
| <code>uv sync</code>                                 | ✅ Installs custom build from <code>pypi-internal</code>                                |
| <code>uv pip install &quot;ray==3.0.0.dev0+custom&quot;</code> | ❌ Ignores <code>pypi-internal</code>, searches PyPI instead                            |
| <code>uv pip install &quot;ray==2.52.1&quot;</code>            | ❌ Applies override <code>ray==3.0.0.dev0+custom</code>, while ignoring <code>pypi-internal</code> |</p>
<p>Unlike Example 2, there's no (simple) workaround here. You can't inline an index into <code>override-dependencies</code>, and <code>UV_NO_CONFIG=1</code> doesn't help either.
<code>uv export</code> doesn't include index information in its output, so <code>uv pip install</code> will search PyPI where the custom version doesn't exist.</p>
<hr />
<p><strong>tl;dr</strong>: <code>uv pip install</code> reads <code>override-dependencies</code> but ignores <code>tool.uv.sources</code>. If applying <code>override-dependencies</code> is intended, it should apply both.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 03:18:04 UTC
    </footer>
</body>
</html>
