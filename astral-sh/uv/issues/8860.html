<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv not using cache when called from Tox/Nox in container - astral-sh/uv #8860</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv not using cache when called from Tox/Nox in container</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/8860">#8860</a>
        opened by <a href="https://github.com/FCamborda">@FCamborda</a>
        on 2024-11-06 10:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/FCamborda">@FCamborda</a></div>
            <div class="timeline-body"><p>Hi,</p>
<p>sorry if this is not the right place. I&#x27;m hesitating whether this is the scope of uv or nox. I get the same behavior with Tox, so it could also be a problem of my understanding/usage.</p>
<p>Basically, we have a container with preinstalled dependencies that we run for CI/CD, including uv, ruff, nox, and other tools. We aim to have a static environment (or as static as it gets) to have a controlled upgrade of third-party dependencies.</p>
<p>We have a noxfile with different sessions where we install our (hopefully pre-installed) dependencies. Due to needs of a more complex environment, we do not want to remove the <code>session.install</code> or use <code>ruff</code> from <code>PATH</code> (i.e. pass <code>external=True</code>).</p>
<p>A minimal reproducible case would be the following:</p>
<pre><code># noxfile.py

import nox

@nox.session
def ruff(session):
    session.install(&quot;ruff&quot;)
    stdout = session.run(&quot;ruff&quot;, &quot;--version&quot;, silent=True)
    installed_version = stdout.split()[-1]
    if installed_version != &quot;0.6.9&quot;:
        session.error(f&quot;Expected &#x27;0.6.9&#x27;, instead got &#x27;{installed_version}&#x27;&quot;)
</code></pre>
<p>In our Dockerfile, we have a lot of different tools, but the uv/Python specifics are:</p>
<ul>
<li>Install uv (we pin the version, but for example sake I used latest)</li>
<li>Install Python interpreters with uv</li>
<li>Install a venv and activate it by default
Note: This part is vital for our setup, we cannot simply install onto <code>--system</code></li>
<li>Pre-install a set of dependencies (here an outdated Ruff)</li>
</ul>
<pre><code># Dockerfile
FROM ubuntu:20.04
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

ENV PYVERSION=3.11

# Install Python 3.11 using uv
RUN uv python install ${PYVERSION}

# Install Python globally + venv
ENV VIRTUAL_ENV=/.venv/
ENV UV_PYTHON_INSTALL_DIR=/.python/
RUN uv python install ${PYVERSION} &amp;&amp; \
    uv venv ${VIRTUAL_ENV} --python ${PYVERSION}

# Activate venv
ENV PATH_NO_VENV=$PATH
ENV PATH=${VIRTUAL_ENV}/bin:$PATH

# Install ruff and Nox into the virtual environment
ENV OUTDATED_RUFF=0.6.9
RUN uv pip install ruff==${OUTDATED_RUFF}

# Force Nox usage
ENV NOX_DEFAULT_VENV_BACKEND=&quot;uv&quot;

COPY noxfile.py /noxfile.py

CMD [&quot;uvx&quot;, &quot;nox&quot;, &quot;-f&quot;, &quot;/noxfile.py&quot;]
</code></pre>
<p>If I copy the Noxfile next to the Dockerfile locally, I get the following error:</p>
<pre><code>&gt; docker run $(docker build -q .)
Installed 8 packages in 21ms
nox &gt; Running session ruff
nox &gt; Creating virtual environment (uv) using python in .nox/ruff
nox &gt; uv pip install ruff
nox &gt; ruff --version
nox &gt; Session ruff aborted: Expected &#x27;0.6.9&#x27;, instead got &#x27;0.7.2&#x27;.
</code></pre>
<p>Interestingly enough, if I simply run <code>uv pip install ruff</code>, I will get the cached version.</p>
<pre><code>&gt;docker run -it --entrypoint /bin/bash $(docker build -q .)
&gt;&gt; uv pip install ruff
Audited 1 package in 0.45ms
&gt;&gt; ruff --version
ruff 0.6.9
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Force Nox to use uv cache (in container)&quot; to &quot;Force Nox to use uv pip cache (in container)&quot; by <a href="https://github.com/FCamborda">@FCamborda</a> on 2024-11-06 10:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Force Nox to use uv pip cache (in container)&quot; to &quot;uv not using cache (in container) when called from Tox/Nox&quot; by <a href="https://github.com/FCamborda">@FCamborda</a> on 2024-11-07 07:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;uv not using cache (in container) when called from Tox/Nox&quot; to &quot;uv not using cache when called from Tox/Nox in container&quot; by <a href="https://github.com/FCamborda">@FCamborda</a> on 2024-11-07 07:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-07 13:30</div>
            <div class="timeline-body"><p>Are you sure that <code>CMD [&quot;uvx&quot;, &quot;nox&quot;, &quot;-f&quot;, &quot;/noxfile.py&quot;]</code> is running in the project environment? I don&#x27;t see where it&#x27;s being installed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-07 13:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/FCamborda">@FCamborda</a> on 2024-11-07 19:42</div>
            <div class="timeline-body"><p>@charliermarsh I&#x27;m not sure I understood what you mean by project environment: the venv?
(the CMD command is just to make it a nice one-liner to explain the problem and avoid different types of shells)</p>
<p>In this case I used uvx from the uv container directly to install Nox. In my understanding, even if it wasn&#x27;t part of the activated venv, uv should use the cache nevertheless.</p>
<p>I can also refrain from using uvx. If I install Nox directly into the environment that includes Ruff, we get the same behavior</p>
<pre><code># Dockerfile
FROM ubuntu:20.04
COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/

ENV PYVERSION=3.11

# Install Python 3.11 using uv
RUN uv python install ${PYVERSION}

# Install Python globally + venv
ENV VIRTUAL_ENV=/.venv/
ENV UV_PYTHON_INSTALL_DIR=/.python/
RUN uv python install ${PYVERSION} &amp;&amp; \
    uv venv ${VIRTUAL_ENV} --python ${PYVERSION}

# Activate venv
ENV PATH_NO_VENV=$PATH
ENV PATH=${VIRTUAL_ENV}/bin:$PATH

# Install ruff and Nox into the virtual environment
ENV OUTDATED_RUFF=0.6.9
RUN uv pip install ruff==${OUTDATED_RUFF} nox

# Force Nox usage
ENV NOX_DEFAULT_VENV_BACKEND=&quot;uv&quot;

COPY noxfile.py /noxfile.py

CMD [&quot;nox&quot;, &quot;-f&quot;, &quot;/noxfile.py&quot;]
</code></pre>
<pre><code>&gt; docker run $(docker build -q .)
Installed 8 packages in 21ms
nox &gt; Running session ruff
nox &gt; Creating virtual environment (uv) using python in .nox/ruff
nox &gt; uv pip install ruff
nox &gt; ruff --version
nox &gt; Session ruff aborted: Expected &#x27;0.6.9&#x27;, instead got &#x27;0.7.2&#x27;.
</code></pre>
<p>Same thing for the interactive shell:</p>
<pre><code>&gt; docker run -it --entrypoint /bin/bash $(docker build -q .)
&gt;&gt; uv pip install ruff
Audited 1 package in 0.45ms
&gt;&gt; ruff --version
ruff 0.6.9
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-07 21:31</div>
            <div class="timeline-body"><p>Sorry, I think my question was not useful -- my bad.</p>
<p>It looks like Nox installs into its own isolated environment? If you run with <code>--verbose</code>:</p>
<pre><code>nox &gt; Running session ruff
nox &gt; Creating virtual environment (uv) using python3 in .nox/ruff
Using CPython 3.11.10 interpreter at: /.venv/bin/python3
Creating virtual environment at: /.nox/ruff

nox &gt; uv pip install ruff
Using Python 3.11.10 environment at /.nox/ruff
Resolved 1 package in 46ms
Prepared 1 package in 336ms
Installed 1 package in 0.53ms
 + ruff==0.7.2

nox &gt; ruff --version
ruff 0.7.2

nox &gt; Session ruff aborted: Expected &#x27;0.6.9&#x27;, instead got &#x27;0.7.2&#x27;.
</code></pre>
<p>So it looks like Nox is looking in a different place than you&#x27;re installing Ruff into.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-07 21:33</div>
            <div class="timeline-body"><p>I&#x27;m not familiar enough with Nox to know if there&#x27;s a way for you to &quot;pre-install&quot; into the session like this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/FCamborda">@FCamborda</a> on 2024-11-07 23:51</div>
            <div class="timeline-body"><p>Ahh I think I got it: Yes, Nox creates a new virtual environment for every session. And I think then that the uv pip cache is shared only for the venv and the Python interpreter it was created from? I thought that the cache was globally accessible (if the Python version matches)</p>
<p>Is there a way to tell uv to install a (compatible) version of a package if found in the cache, I&#x27;m assuming that the different venvs are created from the same Python version.
That is</p>
<pre><code>uv python install 3.11
uv venv foo --python 3.11
source foo/bin/activate
uv pip install ruff==0.6.2
deactivate
uv venv bar --python 3.11
source foo/bin/activate
uv pip install ruff  # install 0.6.2, not latest
</code></pre>
<p>I guess this could be achieved by installing in the global Python and using something like system site packages? But we do not want to install directly in the system/global Python...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2024-11-11 16:53</div>
            <div class="timeline-body"><p>I think you are trying to rely on implementation specific behavior; I don&#x27;t think installers usually guarantee that they will or won&#x27;t pull from a cache. Here it seems uv is being smart and realizing <code>==0.6.9</code> isn&#x27;t the latest version when you later request the latest version. I think what you want is <code>pip download</code> (which last I checked wasn&#x27;t in uv yet), which would allow you to do this explicitly by pre-downloading the packages then installing from that directory.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/FCamborda">@FCamborda</a> on 2024-11-11 17:58</div>
            <div class="timeline-body"><p>That is a very fair point to make. Thanks! IIRC we were relying on system site packages when using pip.</p>
<p>I will explore other possible solutions and have already reached out for the Nox developers. I will comment again if I find something, but you can close this issue if you prefer. I think this is an interesting feature for those of us who have to be a bit careful about third-party dependencies.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2024-11-11 19:12</div>
            <div class="timeline-body"><p>What about using a constraints file?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:35:16 UTC
    </footer>
</body>
</html>
