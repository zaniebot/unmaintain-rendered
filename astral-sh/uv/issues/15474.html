<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv venv -c .` wipes working directory and fails to create a venv - astral-sh/uv #15474</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`uv venv -c .` wipes working directory and fails to create a venv</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/15474">#15474</a>
        opened by <a href="https://github.com/notatallshaw">@notatallshaw</a>
        on 2025-08-23 17:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2025-08-23 17:46</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I have a habit of accidentally writing <code>uv venv .</code> instead of <code>uv venv</code> or <code>uv venv .venv</code>, since <code>uv venv</code> now deletes everything in the directory this deleted my entire working directory.</p>
<h3>Example</h3>
<pre><code class="language-bash"># DO NOT DO THIS:
cd $HOME
uv venv -c .
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @notatallshaw on 2025-08-23 17:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Refuse or throw a more scary error when user tries to create venv in current or parent directory" to "Refuse or throw a more scary error when `uv venv` is called in current or parent directory" by @notatallshaw on 2025-08-23 17:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Refuse or throw a more scary error when `uv venv` is called in current or parent directory" to "Refuse or throw a more scary error when `uv venv` is called in current or parent directories" by @notatallshaw on 2025-08-23 17:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-23 18:53</div>
            <div class="timeline-body"><p>Hm, I think <code>uv venv --clear</code> should fail if it's not a virtual environment (though I confirmed it does not). I'll need to look at the implementation again and see if that was mistakenly changed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2025-08-23 19:05</div>
            <div class="timeline-body"><blockquote>
<p>Hm, I think <code>uv venv --clear</code> should fail if it's not a virtual environment (though I confirmed it does not). I'll need to look at the implementation again and see if that was mistakenly changed.</p>
</blockquote>
<p>I should have more carefully provided steps to reproduce, sorry:</p>
<pre><code class="language-bash">$ mkdir foo

$ cd foo

$ touch foo bar baz

$ ls -ltr
total 0
-rw-r--r-- 1 damian damian 0 Aug 23 15:04 foo
-rw-r--r-- 1 damian damian 0 Aug 23 15:04 baz
-rw-r--r-- 1 damian damian 0 Aug 23 15:04 bar

$ uv venv -c .
Using CPython 3.13.7
Creating virtual environment at: .
error: Failed to create virtual environment
  Caused by: No such file or directory (os error 2)

$ ls -ltr
total 0
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2025-08-23 19:08</div>
            <div class="timeline-body"><p>Maybe I misunderstood what was happening, it appears to have cleared the directory before determining whether it can create the virtual environment or not. Seems like a bug?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-23 19:10</div>
            <div class="timeline-body"><p>Huh I don't know why it fails to create it there</p>
<p>https://github.com/astral-sh/uv/blob/3f83390e342dcb6fccc449335c15d1255885ad20/crates/uv-virtualenv/src/virtualenv.rs#L115-L119</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2025-08-23 22:42</div>
            <div class="timeline-body"><p>¯⁠\⁠<em>⁠(⁠ツ⁠)⁠</em>⁠/⁠¯, I dunno but it both wiped my working directory and failed to create a virtual environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Refuse or throw a more scary error when `uv venv` is called in current or parent directories" to "`uv venv -c .` wipes working directory and fails to create a venv" by @notatallshaw on 2025-08-23 22:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> removed by @zanieb on 2025-08-24 14:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2025-08-24 14:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DhavalGojiya">@DhavalGojiya</a> on 2025-08-26 08:21</div>
            <div class="timeline-body"><p>Yes, I also can reproduce it. See below:</p>
<pre><code class="language-bash">mkdir interstellar
cd interstellar
mkdir sun moon earth
ls -lh
</code></pre>
<p>Output:</p>
<pre><code class="language-text">total 12K
drwxrwxr-x 2 dhaval dhaval 4.0K Aug 26 13:47 earth
drwxrwxr-x 2 dhaval dhaval 4.0K Aug 26 13:47 moon
drwxrwxr-x 2 dhaval dhaval 4.0K Aug 26 13:47 sun
</code></pre>
<p>Then I tried to create a virtual environment using <code>uv</code>:</p>
<pre><code class="language-bash">uv venv -c .
</code></pre>
<p>Output:</p>
<pre><code class="language-text">Using CPython 3.12.11
Creating virtual environment at: .
error: Failed to create virtual environment
  Caused by: No such file or directory (os error 2)
</code></pre>
<p>After that, checking the directory again:</p>
<pre><code class="language-bash">ls -lh
</code></pre>
<p>Output:</p>
<pre><code class="language-text">total 0
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2025-08-26 14:39</div>
            <div class="timeline-body"><p>I can confirm later but I think this is new to 0.8, previously uv venv would create a venv in the current directory but not wipe everything.</p>
<p>This behavior is pretty dangerous, I almost lost a bunch of work, thankfully I had already committed everything remotely.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-26 14:43</div>
            <div class="timeline-body"><p>Hm? That's not what happened before 0.8</p>
<pre><code>❯ uvx --from 'uv&lt;0.8' uv venv .
Installed 1 package in 5ms
Using CPython 3.14.0rc2 interpreter at: /Users/zb/.local/bin/python3.14
Creating virtual environment at: .
uv::venv::creation

  × Failed to create virtualenv
  ╰─▶ The directory `.` exists, but it's not a virtual environment
</code></pre>
<p>Anyway, this is a high priority bug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-26 14:45</div>
            <div class="timeline-body"><p>I will look now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-26 14:47</div>
            <div class="timeline-body"><p>I think <code>--clear</code> should require <code>--force</code> or something to clear a non-virtual environment directory. At the very least, we should not prompt to clear the directory unless it's a virtual environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2025-08-26 14:49</div>
            <div class="timeline-body"><blockquote>
<p>Hm? That's not what happened before 0.8</p>
</blockquote>
<p>Oh yeah, maybe I was misremembering a different tool or maybe there's something about my workspace which makes uv think it is a venv. Side discussion, but thanks for checking, I'll make a new issue if I can reproduce it on the latest version of uv.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-26 14:53</div>
            <div class="timeline-body"><p>It does reproduce on the latest version, it's definitely a regression from the <code>--clear</code> work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2025-08-26 14:53</div>
            <div class="timeline-body"><blockquote>
<p>I think <code>--clear</code> should require <code>--force</code> or something to clear a non-virtual environment directory.</p>
</blockquote>
<p>Same for the prompt, I'm using <code>uv venv -c . </code> as the reproducible step but I actually did the command <code>uv venv . </code> and just immediately hit enter at the prompt (because prompts just train users to hit enter if they default to doing an action, IMO prompts are therefore a bad UX and make other things like scripting more difficult).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-26 14:56</div>
            <div class="timeline-body"><p>So it sounds like:</p>
<ul>
<li>We should error (not prompt) if it's a non-empty, non-virtual environment, and the user didn't pass <code>-c</code>.</li>
<li>We should error if it's a non-empty, non-virtual environment, and the user did pass <code>-c</code>? Tell them to delete it manually? Seems safest honestly.</li>
<li>We should <em>not</em> fail to re-create the environment if it's the CWD; it's sort of a weird use-case, but failing does seem like a bug.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-26 14:59</div>
            <div class="timeline-body"><p>(The bug, specifically, is that accessing <code>CWD</code> fails because we deleted the current directory.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2025-08-26 14:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-26 15:01</div>
            <div class="timeline-body"><p>Yeah that sounds right!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2025-08-26 15:35</div>
            <div class="timeline-body"><blockquote>
<ul>
<li>We should <em>not</em> fail to re-create the environment if it's the CWD; it's sort of a weird use-case, but failing does seem like a bug.</li>
</ul>
</blockquote>
<p>To be clear, this isn't a use case for me, it's a typo caused by crosswires in how I think about the command compared to other commands, I'm thinking &quot;I want a venv in this directory&quot; so I accidentally type <code>uv venv .</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-08-26 17:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 03:26:53 UTC
    </footer>
</body>
</html>
