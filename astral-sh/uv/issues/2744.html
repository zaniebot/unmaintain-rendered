<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bad interpreter due to incorrect shebang when running scripts from setuptools setup scripts - astral-sh/uv #2744</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Bad interpreter due to incorrect shebang when running scripts from setuptools setup scripts</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/2744">#2744</a>
        opened by <a href="https://github.com/hodeinavarro">@hodeinavarro</a>
        on 2024-03-31 23:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/hodeinavarro">@hodeinavarro</a></div>
            <div class="timeline-body">Issue
<p>Executing a bin installed from &quot;scripts&quot; tag at <code>setup</code> from setuptools errors</p>
<pre><code>‚ùØ my_package
zsh: /Users/hodeinavarro/Developer/astral.sh/uv-bin-scripts-mre/with-uv/bin/my_package: bad interpreter: /Users/hodeinavarro/Library/Caches/uv/.tmp7Y2T4Y/.venv/bin/python: no such file or directory
</code></pre>
MRE
<p><a href="https://github.com/hodeinavarro/uv-bin-scripts-mre/">See reproduction and reproduction steps on repo</a>.</p>
Platform
<p>macOS Sonoma 14.4.1 M1 Max
zsh &amp; oh-my-zsh &amp; iTerm2</p>
Version
<pre><code>‚ùØ uv --version
uv 0.1.24 (a5cae0292 2024-03-22)
</code></pre>
<p>Also confirmed with newest</p>
<pre><code>‚ùØ uv --version
uv 0.1.26 (7b685a815 2024-03-28)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-01 01:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-01 02:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-01 02:56</div>
            <div class="timeline-body"><p>Reproduced, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-01 02:57</div>
            <div class="timeline-body"><p>(Only with an editable install.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-01 03:13</div>
            <div class="timeline-body"><p>Huh, I guess this comes from a behavior whereby if the shebang contains <code>python</code> in it, Distutils will replace it with the current Python interpreter: https://docs.python.org/3.11/distutils/setupscript.html#installing-scripts. That doesn&#x27;t work here, because we build the wheel in a temporary virtual environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-01 03:22</div>
            <div class="timeline-body"><p>When we build as a non-editable, the shebang is correctly <code>#!python</code> when we go to install the wheel, and so we replace it with the interpreter path -- all good.</p>
<p>When we build the wheel as editable, by the time we go to replace the shebang, it&#x27;s already set to <code>#!/private/var/folders/nt/6gf2v7_s3k13zq_t3944rwz40000gn/T/.tmpDZLVal/.tmpebUcQR/.venv/bin/python</code> or whatever the temporary environment path is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-01 03:37</div>
            <div class="timeline-body"><p>I have no clue why the build system is changing the shebang when building an editable, nor how to stop it from doing so, nor why <code>pip</code> doesn&#x27;t suffer from the same issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-01 03:48</div>
            <div class="timeline-body"><p>@jaraco -- Sorry to bother, but do you know why we would be seeing a shebang rewrite for the attached script when we build via the PEP 660 editable hooks, but not the PEP 517 build hooks (which seem to preserve <code>#!python</code>, allowing us to rewrite it when we install the wheel later)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-01 14:55</div>
            <div class="timeline-body"><p>My guess is that pip isn&#x27;t affected by this because it builds in the same environment, but uses <code>--prefix</code> (I think?) to isolate the installed packages.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jaraco">@jaraco</a> on 2024-04-01 18:13</div>
            <div class="timeline-body"><p>Here is the code that Setuptools (and also distutils) uses to <a href="https://github.com/pypa/setuptools/blob/6ee23bf0579c52e1cbe7c97fc20fd085ff2a25c7/setuptools/_distutils/command/build_scripts.py#L104-L123">rewrite shebangs</a>. It looks like it constructs the executable from sysconfig variables BIN_DIR, VERSION, and EXE. It&#x27;s conceivable pip alters those configuration values (BIN_DIR in particular) to affect the rewrite. I traced through the PEP 660 code and it appears to be reaching the build_script command through the build, but that doesn&#x27;t explain why the behavior is different for non-editable installs.</p>
<p>Aha, I think I see why. The PEP 517 build uses <code>bdist_wheel</code> to produce the build, which is implemented in the <a href="/pypa/wheel">wheel</a> project and <a href="https://github.com/pypa/wheel/blob/fa33dfd01fd665c1fd90097563b34bce4b5527ef/src/wheel/bdist_wheel.py#L360-L362">specifically sets the executable</a> to <code>&quot;python&quot;</code> when &quot;building&quot; scripts.</p>
<p>That almost certainly explains the disparity. And it sort-of makes sense in that a pure &quot;wheel&quot; is portable and doesn&#x27;t know where it&#x27;s going to be installed but an &quot;editable wheel&quot; is not portable and presumed to be running from the current environment. That&#x27;s consistent with &quot;pip isn&#x27;t affected because it builds in the same environment.&quot;</p>
<p>I&#x27;m not sure the right thing to do here. My instinct is that the most expedient thing to do would be for UV to rewrite the shebangs in these scripts when moving them. The proper solution is probably more involved and would entail updating the spec to make scripts portable and require installers to rewrite them the same way they do regular. It&#x27;s possible the spec already does that and Setuptools is violating it by not re-using the wheel building logic across PEP 517 and PEP 660 builds.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-01 18:25</div>
            <div class="timeline-body"><p>Thanks!</p>
<p>I suppose another option would be to try and rewrite the shebangs <em>before</em> invoking setuptools... But that would require that we introspect the project contents (e.g., we can&#x27;t really know where the scripts are stored without making assumptions about the build backend and configuration, I think).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ripatrick">@ripatrick</a> on 2024-04-16 23:52</div>
            <div class="timeline-body"><blockquote>
<p>That almost certainly explains the disparity. And it sort-of makes sense in that a pure &quot;wheel&quot; is portable and doesn&#x27;t know where it&#x27;s going to be installed but an &quot;editable wheel&quot; is not portable and presumed to be running from the current environment. That&#x27;s consistent with &quot;pip isn&#x27;t affected because it builds in the same environment.&quot;</p>
</blockquote>
<p>On the other hand, if an &quot;editable wheel&quot; is presumed to be running in the current environment, why would they rewrite the shebang at all? ü§î  If they were trying to cover that corner case presumably they could leave it at what the package developer has hard coded.</p>
<p>I&#x27;ve been trying to switch our infra to uv and ran into this issue with one of our local packages. If there is a substring that matches <code>python</code> in the shebang, the whole line gets rewritten.  In my particular case (macos 14.4.1) it&#x27;s a reference to a temp cache <code>#!/Users/patrick/Library/Caches/uv/.tmp87qDc8/.venv/bin/python</code> that does not exist after <code>uv pip install -e</code> is finished.</p>
<p>Hopefully you can find a reasonable solution,  my vote, not that I get one, is to rewrite it to <code>#!python</code> like the wheel project.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sbidoul">@sbidoul</a> on 2024-09-13 10:39</div>
            <div class="timeline-body"><blockquote>
<p>Aha, I think I see why. The PEP 517 build uses bdist_wheel to produce the build, which is implemented in the <a href="https://github.com/pypa/wheel">wheel</a> project and <a href="https://github.com/pypa/wheel/blob/fa33dfd01fd665c1fd90097563b34bce4b5527ef/src/wheel/bdist_wheel.py#L360-L362">specifically sets the executable</a> to &quot;python&quot; when &quot;building&quot; scripts.</p>
</blockquote>
<p>@jaraco FYI it seems the problem persists with setuptools 74.1.2 which now does not dependend on <code>wheel</code>, I think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jaraco">@jaraco</a> on 2024-09-13 15:26</div>
            <div class="timeline-body"><p>Confirmed, now setuptools <a href="https://github.com/pypa/setuptools/blob/56fc3111ba97470d81bf98b1be997dcf791d4a5a/setuptools/command/bdist_wheel.py#L377">specifically sets the executable</a> to &quot;python&quot;. That could make it easier to possibly converge the behavior, although it may still prove impractical to know what&#x27;s the best shebang to put there, as it&#x27;s only doing a build and not an install. Probably the installers need to take responsibility to rewrite the shebangs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sbidoul">@sbidoul</a> on 2024-09-14 14:02</div>
            <div class="timeline-body"><p>@jaraco Now I&#x27;m confused. I tried running the <code>build_editable</code> hook manually with setuptools 74.1.2 on <code>setup.py</code> with a <code>scripts</code> key referring to a script with <code>#!/usr/bin/env python3</code> as shebang. In the resulting wheel there is a <code>*.data/scripts</code> directory where the script has had the shebang replaced with the full path of the python used to run <code>build_editable</code>.</p>
<p>When I run <code>build_wheel</code>, however, the shebang in the wheel is <code>#!python</code>, as expected.</p>
<p>So I tend to think the problem is still present in setuptools for editable wheels?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jaraco">@jaraco</a> on 2024-09-14 20:38</div>
            <div class="timeline-body"><p>Sorry. I didn&#x27;t mean to confuse. I don&#x27;t believe anything <em>changed</em> with setuptools, except where the code for setting the executable for non-editable builds is found (formerly wheel, now embedded in setuptools).</p>
<p>For PEP 660 <code>build_editable</code> installs, the behavior remains unchanged, relying on the old distutils behavior to rewrite the shebang.</p>
<p>What I don&#x27;t yet understand is why pip isn&#x27;t subject to this issue, or what setuptools should possibly do differently.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sbidoul">@sbidoul</a> on 2024-09-15 09:39</div>
            <div class="timeline-body"><blockquote>
<p>why pip isn&#x27;t subject to this issue</p>
</blockquote>
<p>I&#x27;ll try to find out</p>
<blockquote>
<p>what setuptools should possibly do differently</p>
</blockquote>
<p>My instinct says <code>build_editable</code> should emit the same <code>#!python</code> shebang as <code>build_wheel</code>.
From the point of view of installers, a PEP 660 wheel is no different than any other wheel, so the <a href="https://packaging.python.org/en/latest/specifications/binary-distribution-format/#recommended-installer-features"><code>rewrite #!python</code> part of the wheel spec</a> applies.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sbidoul">@sbidoul</a> on 2025-02-26 17:58</div>
            <div class="timeline-body"><p>@jaraco I have looked at this again.</p>
<p>I can confirm that setuptools&#x27; <code>build_wheel</code> replaces the shebang of scripts to <code>#!python</code> while <code>build_editable</code> sets it to the interpreter used for the build.</p>
<p>pip is not affected by this issue because it does not use a venv to build but the current python with a modified sys.path, so the build interpreter happens to be the desired one, but this is accidental.</p>
<p>IMO, the fix is for setuptools to emit <code>#!python</code> for <code>build_editable</code> too. Note this issue is only for scripts, not for entrypoints, which behave correctly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">external</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-05 00:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Bad interpreter when running scripts from setuptools setup scripts&quot; to &quot;Bad interpreter due to incorrect shebang when running scripts from setuptools setup scripts&quot; by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-05 00:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sbidoul">@sbidoul</a> on 2025-03-07 06:50</div>
            <div class="timeline-body"><p>I have opened <a href="https://github.com/pypa/setuptools/issues/4863">pypa/setuptools#4863</a> at setuptools.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jaraco">@jaraco</a> on 2025-03-09 13:45</div>
            <div class="timeline-body"><p>Setuptools 76 implements the proposed change. Can you confirm that it addresses this issue?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hodeinavarro">@hodeinavarro</a> on 2025-03-09 13:59</div>
            <div class="timeline-body"><p>Hello @jaraco</p>
<p>Here&#x27;s my testing with the MRE provided initially.</p>
<p>With uv:</p>
<pre><code>‚ùØ git clone git@github.com:pypa/setuptools

‚ùØ git clone git@github.com:hodeinavarro/uv-bin-scripts-are

‚ùØ uv venv with-uv

‚ùØ source with-uv/bin/activate

‚ùØ uv pip install ./setuptools
Using Python 3.13.1 environment at: with-uv
Resolved 1 package in 1ms
   Built setuptools @ file:///Users/hodeinavarro/Developer/astral.sh/setuptools
Prepared 1 package in 922ms
Installed 1 package in 6ms
 + setuptools==76.0.0.post20250309 (from file:///Users/hodeinavarro/Developer/astral.sh/setuptools)

‚ùØ uv pip install -e uv-bin-scripts-mre
Using Python 3.13.1 environment at: with-uv
Resolved 1 package in 357ms
   Built my-package @ file:///Users/hodeinavarro/Developer/astral.sh/uv-bin-scripts-mre
Prepared 1 package in 366ms
Installed 1 package in 1ms
 + my-package==0.0.0 (from file:///Users/hodeinavarro/Developer/astral.sh/uv-bin-scripts-mre)

‚ùØ my_package
zsh: /Users/hodeinavarro/Developer/astral.sh/with-uv/bin/my_package: bad interpreter: /Users/hodeinavarro/.cache/uv/builds-v0/.tmptIfgrL/bin/python: no such file or directory
</code></pre>
<p>With venv:</p>
<pre><code>‚ùØ python -m venv with-venv

‚ùØ source with-venv/bin/activate

‚ùØ pip install ./setuptools
Processing ./setuptools
  Getting requirements to build wheel ... done
  Preparing metadata (pyproject.toml) ... done
Building wheels for collected packages: setuptools
  Building wheel for setuptools (pyproject.toml) ... done
  Created wheel for setuptools: filename=setuptools-76.0.0.post20250309-py3-none-any.whl size=1236284 sha256=dd420fa33634a87d583091b5a822fd831b2c8ee41e9fe8f04375cdffef1a1349
  Stored in directory: /private/var/folders/w9/rdnqdz5j1xs58zzxw40mgslh0000gn/T/pip-ephem-wheel-cache-53jvpz0v/wheels/44/be/9d/dbe67eafc72df6ae93e883e3bb0a03cd6f3c9adacb14de334d
Successfully built setuptools
Installing collected packages: setuptools
Successfully installed setuptools-76.0.0.post20250309

[notice] A new release of pip is available: 24.3.1 -&gt; 25.0.1
[notice] To update, run: pip install --upgrade pip

‚ùØ pip install -e ./uv-bin-scripts-mre
Obtaining file:///Users/hodeinavarro/Developer/astral.sh/uv-bin-scripts-mre
  Installing build dependencies ... done
  Checking if build backend supports build_editable ... done
  Getting requirements to build editable ... done
  Preparing editable metadata (pyproject.toml) ... done
Building wheels for collected packages: my_package
  Building editable for my_package (pyproject.toml) ... done
  Created wheel for my_package: filename=my_package-0.0.0-0.editable-py3-none-any.whl size=2989 sha256=fae4e46ba17f74546a4f8f2977ee47de8217f259dd9e3650f2116601fab268be
  Stored in directory: /private/var/folders/w9/rdnqdz5j1xs58zzxw40mgslh0000gn/T/pip-ephem-wheel-cache-oi77wpjz/wheels/34/ff/a6/f563530381b2a7f7e5239615a644e89c508ad2d1e5f863e895
Successfully built my_package
Installing collected packages: my_package
Successfully installed my_package-0.0.0

[notice] A new release of pip is available: 24.3.1 -&gt; 25.0.1
[notice] To update, run: pip install --upgrade pip

‚ùØ my_package
Hello, World!
</code></pre>
<p>Thank you everyone involved for your work :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-09 15:04</div>
            <div class="timeline-body"><p>Awesome, thanks @jaraco!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-09 15:04</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:30:41 UTC
    </footer>
</body>
</html>
