<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTTP Authentication doesn't work for google artifact registry python index - astral-sh/uv #2822</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>HTTP Authentication doesn&#x27;t work for google artifact registry python index</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/2822">#2822</a>
        opened by <a href="https://github.com/ArshanKhanifar">@ArshanKhanifar</a>
        on 2024-04-04 18:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ArshanKhanifar">@ArshanKhanifar</a></div>
            <div class="timeline-body">

<p>I&#x27;ve created a google cloud artifact repo, and I&#x27;ve created a service account &amp; granted the following permissions to it:</p>
<pre><code># Service account creation and permissions (this is typically only done once)
# create the service account
deployer-service-account:
	gcloud iam service-accounts create $(sa_name) --display-name=&quot;Pypi publisher&quot;

grant-permissions:
	gcloud artifacts repositories add-iam-policy-binding $(artifact_repo) \
		--location=$(artifact_location) \
		--project=$(gcp_project) \
		--member=serviceAccount:$(sa_name)@$(gcp_project).iam.gserviceaccount.com \
		--role=roles/artifactregistry.writer --rle=roles/artifactregistry.reader
</code></pre>
<p>I&#x27;m able to get the artifact settings like so:</p>
<pre><code># show the pypi registry settings (useful for modifying the ~/.pypirc file)
show-artifact-settings:
	gcloud artifacts print-settings python \
	    --project=$(gcp_project) \
	    --repository=$(artifact_repo) \
	    --location=$(artifact_location)
</code></pre>
<p>This gave me an output like this:</p>
<pre><code># Insert the following snippet into your pip.conf

[global]
extra-index-url = https://_json_key_base64:&lt;somesecret&gt;=@&lt;somerepo&gt;.pkg.dev/&lt;gcp-project&gt;/&lt;registry&gt;/simple/
</code></pre>
<p>Now with this, I&#x27;m able to install my package from <code>pip</code>.</p>
<pre><code>pip install my-private-package
</code></pre>
<p>Setting <code>UV_EXTRA_INDEX_URL</code> or with the <code>--extra-index-url</code> command-line argument, I&#x27;m not able to install the package.</p>
<pre><code>root:shared/ (main✗) # make uv-install                        [18:15:36]
uv pip install -vv --index-url https://_json_key_base64:&lt;sercret&gt;=@&lt;location&gt;-python.pkg.dev/&lt;gcp-project&gt;/&lt;gcp-artifact&gt;/simple/ --extra-index-url https://pypi.org/simple my_private_package 2&gt;&amp;1 &gt; error.log
 uv_requirements::specification::from_source source=my_private_package
    0.000187s DEBUG uv_interpreter::python_environment Found a virtualenv named .venv at: /home/shared/.venv
    0.000535s DEBUG uv_interpreter::interpreter Cached interpreter info for Python 3.11.9, skipping probing: .venv/bin/python
    0.000546s DEBUG uv::commands::pip_install Using Python 3.11.9 environment at .venv/bin/python
 uv_client::linehaul::linehaul
    0.001797s DEBUG uv_client::base_client Using registry request timeout of 300s
 uv_client::flat_index::from_entries
 uv_resolver::resolver::solve
      0.002260s   0ms DEBUG uv_resolver::resolver Solving with target Python version 3.11.9
   uv_resolver::resolver::choose_version package=root
   uv_resolver::resolver::get_dependencies package=root, version=0a0.dev0
        0.002310s   0ms DEBUG uv_resolver::resolver Adding direct dependency: my-private-package*
   uv_resolver::resolver::choose_version package=my-private-package
     uv_resolver::resolver::package_wait package_name=my-private-package
 uv_resolver::resolver::process_request request=Versions my-private-package
   uv_client::registry_client::simple_api package=my-private-package
     uv_client::cached_client::get_cacheable
       uv_client::cached_client::read_and_parse_cache file=/root/.cache/uv/simple-v6/pypi/my-private-package.rkyv
 uv_resolver::resolver::process_request request=Prefetch my-private-package *
 uv_client::cached_client::from_path_sync path=&quot;/root/.cache/uv/simple-v6/pypi/my-private-package.rkyv&quot;
          0.002601s   0ms DEBUG uv_client::cached_client No cache entry for: https://pypi.org/simple/my-private-package/
       uv_client::cached_client::fresh_request url=&quot;https://pypi.org/simple/my-private-package/&quot;
            0.002625s   0ms DEBUG uv_auth::middleware No credentials found for: https://pypi.org/simple/my-private-package/
     uv_client::cached_client::get_cacheable
       uv_client::cached_client::read_and_parse_cache file=/root/.cache/uv/simple-v6/&lt;somehash&gt;/my-private-package.rkyv
 uv_client::cached_client::from_path_sync path=&quot;/root/.cache/uv/simple-v6/&lt;somehash&gt;/my-private-package.rkyv&quot;
          0.081441s   0ms DEBUG uv_client::cached_client Found stale response for: https://&lt;location&gt;-python.pkg.dev/&lt;gcp-project&gt;/&lt;gcp-artifact&gt;/simple/my-private-package/
          0.081456s   0ms DEBUG uv_client::cached_client Sending revalidation request for: https://&lt;location&gt;-python.pkg.dev/&lt;gcp-project&gt;/&lt;gcp-artifact&gt;/simple/my-private-package/
       uv_client::cached_client::revalidation_request url=&quot;https://&lt;location&gt;-python.pkg.dev/&lt;gcp-project&gt;/&lt;gcp-artifact&gt;/simple/my-private-package/&quot;
            0.081469s   0ms DEBUG uv_auth::middleware Request already has an authorization header: https://&lt;location&gt;-python.pkg.dev/&lt;gcp-project&gt;/&lt;gcp-artifact&gt;/simple/my-private-package/
          0.389440s 308ms DEBUG uv_client::cached_client Found modified response for: https://&lt;location&gt;-python.pkg.dev/&lt;gcp-project&gt;/&lt;gcp-artifact&gt;/simple/my-private-package/
       uv_client::cached_client::new_cache file=/root/.cache/uv/simple-v6/&lt;somehash&gt;/my-private-package.rkyv
       uv_client::registry_client::parse_simple_api package=my-private-package
         uv_client::html::parse url=https://&lt;location&gt;-python.pkg.dev/&lt;gcp-project&gt;/&lt;gcp-artifact&gt;/simple/my-private-package/
   uv_resolver::version_map::from_metadata
   uv_distribution::distribution_database::get_or_build_wheel_metadata dist=my-private-package==0.1.0.post1
     uv_client::cached_client::get_serde
       uv_client::cached_client::get_cacheable
         uv_client::cached_client::read_and_parse_cache file=/root/.cache/uv/built-wheels-v2/index/&lt;somehash&gt;/my-private-package/0.1.0.post1/manifest.msgpack
        0.392549s 390ms DEBUG uv_resolver::resolver Searching for a compatible version of my-private-package (*)
        0.392590s 390ms DEBUG uv_resolver::resolver Selecting: my-private-package==0.1.0.post1 (my_private_package-0.1.0.post1.tar.gz)
 uv_client::cached_client::from_path_sync path=&quot;/root/.cache/uv/built-wheels-v2/index/&lt;somehash&gt;/my-private-package/0.1.0.post1/manifest.msgpack&quot;
   uv_resolver::resolver::get_dependencies package=my-private-package, version=0.1.0.post1
     uv_resolver::resolver::distributions_wait package_id=my-private-package-0.1.0.post1
            0.392790s   0ms DEBUG uv_client::cached_client No cache entry for: https://&lt;location&gt;-python.pkg.dev/&lt;gcp-project&gt;/&lt;gcp-artifact&gt;/my-private-package/my_private_package-0.1.0.post1.tar.gz#sha256=&lt;package-sha256&gt;
         uv_client::cached_client::fresh_request url=&quot;https://&lt;location&gt;-python.pkg.dev/&lt;gcp-project&gt;/&lt;gcp-artifact&gt;/my-private-package/my_private_package-0.1.0.post1.tar.gz#sha256=&lt;package-sha256&gt;&quot;
              0.392893s   0ms DEBUG uv_auth::middleware Adding authentication to already-seen URL: https://&lt;location&gt;-python.pkg.dev/&lt;gcp-project&gt;/&lt;gcp-artifact&gt;/my-private-package/my_private_package-0.1.0.post1.tar.gz#sha256=&lt;package-sha256&gt;
error: Failed to download and build: my-private-package==0.1.0.post1
  Caused by: HTTP status client error (401 Unauthorized) for url (https://&lt;location&gt;-python.pkg.dev/&lt;gcp-project&gt;/&lt;gcp-artifact&gt;/my-private-package/my_private_package-0.1.0.post1.tar.gz#sha256=&lt;package-sha256&gt;)
make: *** [Makefile:52: uv-install] Error 2

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ArshanKhanifar">@ArshanKhanifar</a> on 2024-04-04 18:23</div>
            <div class="timeline-body"><p>My UV version:</p>
<pre><code>root:shared/ (main✗) # uv --version                           [18:23:23]
uv 0.1.28
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-04 18:24</div>
            <div class="timeline-body"><p>I will try to reproduce this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-04 18:24</div>
            <div class="timeline-body"><p>Hm the logs indicate that we are propagating authentication. Perhaps we are parsing it incorrectly. Could be related to the <code>_</code> in the username or the <code>=</code> at the end of the password?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-04 18:25</div>
            <div class="timeline-body"><p>Is there an <code>@</code> in the secret?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ArshanKhanifar">@ArshanKhanifar</a> on 2024-04-04 18:28</div>
            <div class="timeline-body"><p>The secret ends with a <code>=</code> but doesn&#x27;t have an <code>@</code> or <code>=</code> anywhere else</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ArshanKhanifar">@ArshanKhanifar</a> on 2024-04-04 18:33</div>
            <div class="timeline-body"><p>Looks like <a href="https://cloud.google.com/artifact-registry/docs/python/authentication">google cloud uses</a> <code>_json_key_base64</code> by default.</p>
<p>I wanted to see if I can use a different kind of secret, but doesn&#x27;t seem like they export the key in any other format.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-04 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-04 22:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-04 22:28</div>
            <div class="timeline-body"><p>Okay, I went through the setup and unfortunately it&#x27;s working for me without issue? I&#x27;ll note that my base64 key does <em>not</em> end in an equals sign. Is it possible that you&#x27;ve generated it incorrectly?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-05 00:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-05 00:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2024-04-05 00:49</div>
            <div class="timeline-body"><p>If it&#x27;s base64 encoding, it could very likely end with <code>=</code> or <code>==</code> per <a href="https://datatracker.ietf.org/doc/html/rfc4648#page-4">RFC4648</a> and any character from it&#x27;s alphabet is also fair game (e.g. <code>+</code>, <code>/</code> and the URL safe variants of those <code>-</code>, <code>_</code> respectively)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/avelychko12">@avelychko12</a> on 2024-04-09 22:28</div>
            <div class="timeline-body"><p>Have exactly the same issue, but I have <code>==</code> in the end of the key.
It stopped working in 0.1.19</p>
<p>As far as I can understand, you are not decoding password here
https://github.com/astral-sh/uv/blob/7bcca28b12cd12a6fdf902ec8ae2c48630ba7356/crates/uv-auth/src/store.rs#L110
so later you will try to base64 into <code>%3D%3D</code> instead of <code>==</code>
but pip is doing unquote for password so <code>%3D%3D</code> will be converted to <code>==</code> https://github.com/pypa/pip/blob/06d21db4ff1ab69665c22a88718a4ea9757ca293/src/pip/_internal/utils/misc.py#L499</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-09 22:47</div>
            <div class="timeline-body"><p>@avelychko12 thanks for the investigation! I put up <a href="https://github.com/astral-sh/uv/pull/2947">astral-sh/uv#2947</a> if anyone wants to give it a try while I try to write a decent test case for this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-09 22:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-09 22:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> removed by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-09 22:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-09 22:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ArshanKhanifar">@ArshanKhanifar</a> on 2024-04-09 23:50</div>
            <div class="timeline-body"><p>@charliermarsh thanks for following up with this, so my workaround currently for this is to just use a different kind of token.</p>
<p>Basically after activating the service account:</p>
<pre><code>activate-service-account:
	gcloud auth activate-service-account --key-file=$(keyfile_name)
</code></pre>
<p>I get the auth token via:</p>
<pre><code>gcloud auth print-access-token
</code></pre>
<p>Then I use that with <code>_token</code> set as username:</p>
<pre><code># Gets the service account&#x27;s credentials &amp; sets them
get_index_url:
	$(eval token := $(shell gcloud auth print-access-token))
	$(eval index_url := &quot;https://_token:$(token)@$(artifact_location)-python.pkg.dev/$(gcp_project)/$(artifact_repo))/simple/&quot;)
</code></pre>
<p>my scripts are make scripts so apologies if it seems a bit confusing but all of the above summarized is to get the token via <code>gcloud auth print-access-token</code> then use <code>_token:$ACCESS_TOKEN@url</code> as the pypi index url.</p>
<p>But still with <code>base64</code> encoded json keys I wasn&#x27;t able to run this correctly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-16 16:49</div>
            <div class="timeline-body"><p>Should be resolved by <a href="https://github.com/astral-sh/uv/pull/2976">astral-sh/uv#2976</a> and available in the next release.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-16 16:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:30:44 UTC
    </footer>
</body>
</html>
