```yaml
number: 11671
title: Corrupt .pth in site-packages
type: issue
state: open
author: NilsUUID
labels:
  - bug
  - windows
assignees: []
created_at: 2025-02-20T16:05:51Z
updated_at: 2025-03-04T13:47:38Z
url: https://github.com/astral-sh/uv/issues/11671
synced_at: 2026-01-10T01:57:26Z
```

# Corrupt .pth in site-packages

---

_Issue opened by @NilsUUID on 2025-02-20 16:05_

### Summary

I have this pyproject.toml file defining my environement :

[pyproject.toml.txt](https://github.com/user-attachments/files/18891242/pyproject.toml.txt)

When I run uv sync the venv gets created without problems, but if I look in /.venv/Lib/site-packages I have some .pth files that are visibly corrupt:

[distutils-precedence.pth.txt](https://github.com/user-attachments/files/18890161/distutils-precedence.pth.txt)

[pytest-cov.pth.txt](https://github.com/user-attachments/files/18890093/pytest-cov.pth.txt)

These corrupt files cause concern afterwards when running python scripts within the environement:
```
C:\Users\xxx\Documents\Dev\sandbox\uv_pth_corrupt>uv run python -V
error: Querying Python at `C:\Users\xxx\Documents\Dev\sandbox\uv_pth_corrupt\.venv\Scripts\python.exe` failed with exit status exit code: 1

[stderr]
Fatal Python error: init_import_site: Failed to import the site module
Python runtime state: initialized
Traceback (most recent call last):
  File "<frozen importlib._bootstrap>", line 1176, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1147, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 690, in _load_unlocked
  File "<frozen importlib._bootstrap>", line 980, in exec_module
  File "<frozen site>", line 626, in <module>
  File "<frozen site>", line 609, in main
  File "<frozen site>", line 541, in venv
  File "<frozen site>", line 394, in addsitepackages
  File "<frozen site>", line 236, in addsitedir
  File "<frozen site>", line 188, in addpackage
  File "C:\xxx\Python\Python3.11-64\Lib\encodings\cp1252.py", line 23, in decode
    return codecs.charmap_decode(input,self.errors,decoding_table)[0]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
UnicodeDecodeError: 'charmap' codec can't decode byte 0x9d in position 41: character maps to <undefined>
```

As a consequence the virtual environment is unusable.

### Platform

Windows 10

### Version

0.6.1

### Python version

3.11.9

---

_Label `bug` added by @NilsUUID on 2025-02-20 16:05_

---

_Comment by @charliermarsh on 2025-02-20 20:03_

I can test this when I'm back home and have my Windows machine available. Alternatively, maybe @konstin or @Gankra can test.

---

_Label `windows` added by @charliermarsh on 2025-02-20 20:03_

---

_Comment by @kdheepak on 2025-02-21 14:27_

I was having a possibly similar / possibly related issue on a colleague's computer. On Windows, we are seeing the following error:

```
Error processing line 1 of C:\Users\USERNAME\miniforge3\envs\conda-env-name\lib\site-packages\distutils-precedence.pth:

  Traceback (most recent call last):
    File "C:\Users\USERNAME\miniforge3\envs\conda-env-name\lib\site-packages\...", 
  ModuleNotFoundError: No module named '_distutils_hack'
```

In similar issues, people recommend `pip install -U setuptools pip`: https://github.com/conda/conda/issues/11931

But that didn't work when we tried it.

I am using the following to install a `uv` managed environment into a conda environment:

```
conda activate conda-env-name
export UV_PROJECT_ENVIRONMENT=$CONDA_PREFIX
uv sync --all-extras --dev 
```

I'm not sure if this is because of the same issue as the OP. I can open a new issue if this happens again. One thing to note is that I've only seen this on a Windows 11 machine. 

---

_Comment by @Gankra on 2025-02-21 14:32_

I performed the following steps to try to reproduce on arm64 windows 11, uv 0.6.1 (unsuccessfully, everything worked fine for me):

```
uv init corrupt_uv_pth
<update pyproject.toml to what you have>
uv sync
<fails due to python version requirements>
uv python pin 3.11
uv sync
uv run python -V
```

It seems like an encoding mess but I can't tell what it would be... out of curiosity what's the windows Version in System Information? (Wondering if it's a really old win10 that lacks some system utf8 support...)

---

_Comment by @NilsUUID on 2025-02-21 14:45_

I'm running win10 22h2 on an x86-64 platform.

---

_Comment by @Gankra on 2025-02-21 16:32_

Thanks! That indeed should be well supported. (Which unfortunately means I'm not sure what could cause this...)

---

_Comment by @notatallshaw on 2025-02-21 16:45_

I tried reproducing on Windows 10 22H2 inside a Powershell terminal window and couldn't reproduce:

```

PS C:\Users\damia\opensource\uv\11671> uv self update
info: Checking for updates...
success: Upgraded uv from v0.5.6 to v0.6.2! https://github.com/astral-sh/uv/releases/tag/0.6.2

PS C:\Users\damia\opensource\uv\11671> uv init corrupt_uv_pth
Initialized project `corrupt-uv-pth` at `C:\Users\damia\opensource\uv\11671\corrupt_uv_pth`

PS C:\Users\damia\opensource\uv\11671> cd .\corrupt_uv_pth\

~~ copied over pyproject.toml ~~

PS C:\Users\damia\opensource\uv\11671\corrupt_uv_pth> uv sync
Using CPython 3.10.15
error: The Python request from `.python-version` resolved to Python 3.10.15, which is incompatible with the project's Python requirement: `==3.11.*`. Use `uv python pin` to update the `.python-version` file to a compatible version.

PS C:\Users\damia\opensource\uv\11671\corrupt_uv_pth> uv python pin 3.11
warning: No interpreter found for Python 3.11 in managed installations, search path, or registry
Updated `.python-version` from `3.10` -> `3.11`

PS C:\Users\damia\opensource\uv\11671\corrupt_uv_pth> uv sync
Using CPython 3.11.11
Creating virtual environment at: .venv
Resolved 137 packages in 816ms
Prepared 134 packages in 11.05s
Installed 134 packages in 2.18s
 ~~ long list of packages ~~
 
PS C:\Users\damia\opensource\uv\11671\corrupt_uv_pth> uv run python -V
Python 3.11.11

```

---

_Comment by @NilsUUID on 2025-02-24 08:51_

Did you also check the .pth files and proper python execution? Today my python -V command was ok, but python was still broken (and .pth files were scrambled):

```
C:\Users\xxx\Documents\Dev\sandbox\uv_pth_corrupt_issue>uv run python -V
Python 3.11.9

C:\Users\xxx\Documents\Dev\sandbox\uv_pth_corrupt_issue>uv run python
Fatal Python error: init_import_site: Failed to import the site module
Python runtime state: initialized
Traceback (most recent call last):
  File "<frozen importlib._bootstrap>", line 1176, in _find_and_load
  File "<frozen importlib._bootstrap>", line 1147, in _find_and_load_unlocked
  File "<frozen importlib._bootstrap>", line 690, in _load_unlocked
  File "<frozen importlib._bootstrap>", line 980, in exec_module
  File "<frozen site>", line 626, in <module>
  File "<frozen site>", line 609, in main
  File "<frozen site>", line 541, in venv
  File "<frozen site>", line 394, in addsitepackages
  File "<frozen site>", line 236, in addsitedir
  File "<frozen site>", line 188, in addpackage
  File "C:\xxx\Python\Python3.11-64\Lib\encodings\cp1252.py", line 23, in decode
    return codecs.charmap_decode(input,self.errors,decoding_table)[0]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
UnicodeDecodeError: 'charmap' codec can't decode byte 0x9d in position 41: character maps to <undefined>
```

---

_Comment by @DouisLavid on 2025-03-04 13:43_

Hello, I report seemingly the very same problem, also on win10, and i observed that when deleting the venv and re running `uv sync` *after* having ran `uv cache clean`, sometimes not the same pth files are corrupted. While trying a few times, i finally got lucky and got no corrupted files and a working venv, but there is definitely something nondeterministic going on with venv creation, and, i guess, package installation and caching.
If it helps here is my pyproject.toml :

```
[project]
name = "parsers"
version = "0.1.0"
description = ""
readme = "README.md"
authors = [{ name = "Louis David", email = "" }]
requires-python = ">=3.13"
dependencies = ["attrs>=25.1.0", "lark>=1.2.2", "pandas>=2.2.3"]


[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[dependency-groups]
dev = [
    "mypy>=1.15.0",
    "pandas-stubs>=2.2.3.241126",
    "pytest>=8.3.4",
    "pytest-cov>=6.0.0",
    "ruff>=0.9.7",
    "sphinx>=8.2.1",
]
```
I noticed that .venv\Lib\site-packages\sphinxcontrib_jsmath-1.0.1-py3.7-nspkg.pth and .venv\Lib\site-packages\pytest-cov.pth (as in the original issue) seemed to be scrambled more often than the rest, but my sample size is small and it very well could be non significant. I believe i have seen all other pth files scrambled at least once except .venv\Lib\site-packages\_virtualenv.pth (but again, i could have been lucky).

---

_Referenced in [astral-sh/uv#13274](../../astral-sh/uv/issues/13274.md) on 2025-05-03 14:30_

---
