<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Installation order matters due to lower bounds generated by `uv add` - astral-sh/uv #11981</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Installation order matters due to lower bounds generated by <code>uv add</code></h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/11981">#11981</a>
        opened by <a href="https://github.com/hoechenberger">@hoechenberger</a>
        on 2025-03-05 16:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/hoechenberger">@hoechenberger</a></div>
            <div class="timeline-body"><h3>Question</h3>
<p>Hello, today at work we were running into a peculiar issue. It's not a bug <em>per se,</em> but something that gave us a bit of a headache.</p>
<p>In a situation where we couldn't <code>uv add</code> all dependencies in a single call, the lower bounds added to <code>pyproject.toml</code> through the first call made it impossible to add another dependency in subsequent calls:</p>
<p>First call:</p>
<pre><code class="language-shell">‚ùØ uv init -p 3.13 test
Initialized project `test` at `/private/tmp/test`
‚ùØ cd test
‚ùØ uv add numpy
Using CPython 3.13.1
Creating virtual environment at: .venv
Resolved 2 packages in 127ms
Prepared 1 package in 204ms
Installed 1 package in 15ms
 + numpy==2.2.3
</code></pre>
<p>Second call:</p>
<pre><code class="language-shell">‚ùØ uv add --dev numba
Resolved 5 packages in 293ms
  √ó Failed to build `numba==0.53.1`
  ‚îú‚îÄ‚ñ∂ The build backend returned an error
  ‚ï∞‚îÄ‚ñ∂ Call to `setuptools.build_meta:__legacy__.build_wheel` failed (exit status: 1)

      [stderr]
      Traceback (most recent call last):
        File &quot;&lt;string&gt;&quot;, line 14, in &lt;module&gt;
          requires = get_requires_for_build({})
        File
      &quot;/Users/richardhochenberger/Library/Caches/uv/builds-v0/.tmpGkijwM/lib/python3.13/site-packages/setuptools/build_meta.py&quot;,
      line 334, in get_requires_for_build_wheel
          return self._get_build_requires(config_settings, requirements=[])
                 ~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        File
      &quot;/Users/richardhochenberger/Library/Caches/uv/builds-v0/.tmpGkijwM/lib/python3.13/site-packages/setuptools/build_meta.py&quot;,
      line 304, in _get_build_requires
          self.run_setup()
          ~~~~~~~~~~~~~~^^
        File
      &quot;/Users/richardhochenberger/Library/Caches/uv/builds-v0/.tmpGkijwM/lib/python3.13/site-packages/setuptools/build_meta.py&quot;,
      line 522, in run_setup
          super().run_setup(setup_script=setup_script)
          ~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^
        File
      &quot;/Users/richardhochenberger/Library/Caches/uv/builds-v0/.tmpGkijwM/lib/python3.13/site-packages/setuptools/build_meta.py&quot;,
      line 320, in run_setup
          exec(code, locals())
          ~~~~^^^^^^^^^^^^^^^^
        File &quot;&lt;string&gt;&quot;, line 50, in &lt;module&gt;
        File &quot;&lt;string&gt;&quot;, line 47, in _guard_py_ver
      RuntimeError: Cannot install on Python version 3.13.1; only versions &gt;=3.6,&lt;3.10 are
      supported.

      hint: This usually indicates a problem with the package or the build environment.
  help: `numba` (v0.53.1) was included because `test:dev` (v0.1.0) depends on `numba`
</code></pre>
<p>The latest version of <code>numba</code> is actually 0.61.0; <code>uv</code> is backtracking to using version <code>0.53.1</code>, which doesn't support Python 3.13.</p>
<p>Third call, explicitly requesting <code>numba==0.61</code>:</p>
<pre><code class="language-shell">‚ùØ uv add --dev &quot;numba==0.61&quot;
  √ó No solution found when resolving dependencies:
  ‚ï∞‚îÄ‚ñ∂ Because numba==0.61.0 depends on numpy&gt;=1.24,&lt;2.2 and test:dev depends on numba==0.61, we can
      conclude that test:dev depends on numpy&gt;=1.24,&lt;2.2.
      And because your project depends on numpy&gt;=2.2.3, we can conclude that your project and
      test:dev are incompatible.
      And because your project requires your project and test:dev, we can conclude that your
      project's requirements are unsatisfiable.
  help: If you want to add the package regardless of the failed resolution, provide the `--frozen`
        flag to skip locking and syncing.
</code></pre>
<p>Numba 0.61 only supports NumPy up to 2.1.</p>
<p>Obviously, after lowering the NumPy version requirement in <code>pyproject.toml</code> to 2.1, the <code>numba</code> installation succeeds.</p>
<p>It also succeeds if I install both packages, <code>numpy</code> and <code>numba</code>, in a single invocation of <code>uv add</code>.</p>
<p>However, in the above example, I had to split <code>uv add</code> into two separate calls since I wanted to add <code>numba</code> to the <code>dev</code> dependency group.</p>
<p>I know that this behavior is most probably intentional, and what we've seen in the second call may be due to a <code>numba</code> packaging bug (forgetting to set an upper bound for NumPy). But to make things work, we now either have to do:</p>
<pre><code class="language-shell">‚ùØ uv add &quot;numpy&lt;=2.1&quot;
‚ùØ uv add --dev numba
</code></pre>
<p>or, if we want to avoid having to explicitly set upper bounds:</p>
<pre><code class="language-shell">‚ùØ uv add --dev numba
‚ùØ uv add numpy
</code></pre>
<p>But this isn't something we can always ensure when working on an &quot;organically evolving&quot; project ‚Äì¬†we would like to add dependencies in any order, at any time.</p>
<p>I would have preferred if <code>uv</code> had offered to downgrade the <code>numpy</code> requirement in order to accommodate my explicit request for <code>numba</code>.</p>
<h3>Platform</h3>
<p>macOS Sequoia 15.3.1, arm64</p>
<h3>Version</h3>
<p>uv 0.6.4 (04db70662 2025-03-03)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @hoechenberger on 2025-03-05 16:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-05 21:51</div>
            <div class="timeline-body"><p>Tricky. Thanks for the report. I'm not sure what we can do here.</p>
<p>cc @konstin presumably you'd find this interesting</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-03-06 08:21</div>
            <div class="timeline-body"><p>That's tricky.</p>
<p>One option would be improving the error message by noting that we're backtracking on the recently added package, which is likely wrong.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">error messages</span> added by @konstin on 2025-03-06 08:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hoechenberger">@hoechenberger</a> on 2025-03-06 09:15</div>
            <div class="timeline-body"><p>I think this would already help a bunch, yes!</p>
<p>Still wouldn't solve the problem that &quot;order matters&quot; though üòï</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hoechenberger">@hoechenberger</a> on 2025-03-06 12:33</div>
            <div class="timeline-body"><p>FWIW, <code>uv pip install</code> behaves more the way I would expect (and prefer):</p>
<pre><code class="language-shell">‚ùØ uv init -p 3.13 test &amp;&amp; cd test &amp;&amp; uv venv &amp;&amp; uv pip install numpy &amp;&amp; uv pip install numba
Initialized project `test` at `/private/tmp/test`
Using CPython 3.13.1
Creating virtual environment at: .venv
Activate with: source .venv/bin/activate
Resolved 1 package in 140ms
Installed 1 package in 23ms
 + numpy==2.2.3
Resolved 3 packages in 176ms
Uninstalled 1 package in 56ms
Installed 3 packages in 21ms
 + llvmlite==0.44.0
 + numba==0.61.0
 - numpy==2.2.3
 + numpy==2.1.3
</code></pre>
<p>Of course, I know it doesn't respect any dependencies in <code>pyproject.toml</code> or a lock file; but the general flow ‚Äì user explicitly requests a package, so we downgrade conflicting ones ‚Äì feels natural to me. It didn't need to backtrack on <code>numba</code>.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:30:16 UTC
    </footer>
</body>
</html>
