<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issue with `uv@0.2.7` in Dockerfile + venv - astral-sh/uv #4072</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Issue with `uv@0.2.7` in Dockerfile + venv</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/4072">#4072</a>
        opened by <a href="https://github.com/omarish">@omarish</a>
        on 2024-06-05 20:31
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/omarish">@omarish</a> on 2024-06-05 20:31</div>
            <div class="timeline-body"><p>I think I've encountered an issue related to (I believe) virtualenv detection when using uv in a dockerfile. Specifically, I noticed that my company's CI started failing on all images that rely on uv.</p>
<p>For reference, here is the dockerfile:</p>
<pre><code class="language-dockerfile"># syntax = docker/dockerfile:1.0-experimental

# Base image
FROM python:3.12.2 as build
RUN apt-get update &amp;&amp; apt-get install -y build-essential curl libpq-dev
ENV VIRTUAL_ENV=/opt/venv \
  PATH=&quot;/opt/venv/bin:$PATH&quot;

ADD https://astral.sh/uv/install.sh /install.sh
RUN chmod -R 655 /install.sh &amp;&amp; /install.sh &amp;&amp; rm /install.sh
COPY ./packages/waldo-db-proxy/requirements.txt .
RUN /root/.cargo/bin/uv venv /opt/venv &amp;&amp; \
  /root/.cargo/bin/uv pip install --no-cache -r requirements.txt

# App image
FROM python:3.12.2-slim-bookworm
RUN apt-get update &amp;&amp; apt-get install -y build-essential curl libpq-dev
COPY --from=build /opt/venv /opt/venv
ENV PATH=&quot;/opt/venv/bin:$PATH&quot;
WORKDIR /app
COPY  ./packages/waldo-db-proxy ./
EXPOSE  5432
CMD [ &quot;python&quot;, &quot;-m&quot;, &quot;app&quot;, &quot;start&quot; ]
</code></pre>
<p>This started failing universally this morning.</p>
<p>I hopped in to a partial image (before this line that activates the venv <code>RUN /root/.cargo/bin/uv venv /opt/venv</code>), and found that it was running uv@0.2.7.</p>
<p>This image works without issue when I replace <code>https://astral.sh/uv/install.sh</code> with <code>https://github.com/astral-sh/uv/releases/download/0.2.6/uv-installer.sh</code>.</p>
<p>I haven't had time to further debug, but just wanted to raise this issue in case others are trying to debug.</p>
<p>Edit: it seems to fail at this step on 0.2.7:</p>
<pre><code class="language-sh"> &gt; [build 6/6] RUN /root/.cargo/bin/uv venv /opt/venv &amp;&amp;   /root/.cargo/bin/uv pip install --no-cache -r requirements.txt:
#19 0.100   × failed to canonicalize path `/opt/venv/bin/python3`
#19 0.100   ╰─▶ No such file or directory (os error 2)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Issue with uv 0.2.7 when running in Dockerfile with virtualenv" to "Issue with `uv@0.2.7` in Dockerfile + venv" by @omarish on 2024-06-05 20:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-05 20:32</div>
            <div class="timeline-body"><p>FWIW, you can also use <code>https://astral.sh/uv/0.2.6/install.sh</code> as the installer link.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-05 20:33</div>
            <div class="timeline-body"><p>Can you share any more on what is failing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-05 20:36</div>
            <div class="timeline-body"><p>Modifying the Dockerfile a bit, I eventually get:</p>
<pre><code> &gt; [build 6/6] RUN /root/.cargo/bin/uv venv /opt/venv &amp;&amp;   /root/.cargo/bin/uv pip install --no-cache -r requirements.txt:
#19 0.100   × failed to canonicalize path `/opt/venv/bin/python3`
#19 0.100   ╰─▶ No such file or directory (os error 2)
</code></pre>
<p>Does that look familiar?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/omarish">@omarish</a> on 2024-06-05 20:37</div>
            <div class="timeline-body"><p>Sorry for not posting that in the original issue. Yes, that's the issue I ran into using 0.2.7.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-05 20:37</div>
            <div class="timeline-body"><p>Okay, thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-06-05 20:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-05 20:49</div>
            <div class="timeline-body"><p>Thanks! We'll have a fix out shortly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-06-05 20:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/omarish">@omarish</a> on 2024-06-05 21:09</div>
            <div class="timeline-body"><p>That was fast! Thank you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-05 21:35</div>
            <div class="timeline-body"><p>The release should be out now. Let us know if you run into any more problems :)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 05:34:13 UTC
    </footer>
</body>
</html>
