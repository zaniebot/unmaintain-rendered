<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transitive PROJECT_ROOT is expanded in requirements.txt - astral-sh/uv #3750</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Transitive PROJECT_ROOT is expanded in requirements.txt</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/3750">#3750</a>
        opened by <a href="https://github.com/patrick-kidger">@patrick-kidger</a>
        on 2024-05-22 18:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/patrick-kidger">@patrick-kidger</a> on 2024-05-22 18:11</div>
            <div class="timeline-body"><p><strong>Reproduction:</strong> Given the following directories:</p>
<pre><code>one/pyproject.toml
two/pyproject.toml
three/pyproject.toml
</code></pre>
<p>with contents:</p>
<pre><code class="language-toml"># one/pyproject.toml
[project]
name = &quot;one&quot;
version = &quot;0.0.1&quot;
dependencies = [&quot;two @ file://${PROJECT_ROOT}/../two&quot;]
# two/pyproject.toml
[project]
name = &quot;two&quot;
version = &quot;0.0.1&quot;
dependencies = [&quot;three @ file://${PROJECT_ROOT}/../three&quot;]
# three/pyproject.toml
[project]
name = &quot;three&quot;
version = &quot;0.0.1&quot;
dependencies = []
</code></pre>
<p>then running</p>
<pre><code>one&gt; uv pip compile pyproject.toml -o requirements.txt
</code></pre>
<p>will (correctly) produce a <code>requirements.txt</code> with the contents</p>
<pre><code># This file was autogenerated by uv via the following command:
#    uv pip compile pyproject.toml -o requirements.txt
three @ file://${PROJECT_ROOT}/../three
    # via two
two @ file://${PROJECT_ROOT}/../two
    # via one (pyproject.toml)
</code></pre>
<p>however a second invocation of the same command now produces a <code>requirements.txt</code> with the contents</p>
<pre><code># This file was autogenerated by uv via the following command:
#    uv pip compile pyproject.toml -o requirements.txt
three @ file:///Absolute/Path/To/three
    # via two
two @ file://${PROJECT_ROOT}/../two
    # via one (pyproject.toml)
</code></pre>
<p>which has had <code>PROJECT_ROOT</code> expanded in the transitive dependency!</p>
<p><strong>Expected behaviour</strong> is for <code>PROJECT_ROOT</code> to be preserved in <code>requirements.txt</code>, and for <code>uv pip compile</code> to be idempotent.</p>
<p>Calling <code>uv cache clean</code> will result in the next invocation of <code>uv pip compile</code> being correct, so this seems to be a caching issue.
This is using <code>uv</code> version <code>0.1.45</code> on macOS.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-05-22 18:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-23 00:13</div>
            <div class="timeline-body"><p>Def a bug, thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-23 00:13</div>
            <div class="timeline-body"><p>\cc @konstin - could this be related to any of your URL work?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-05-23 10:40</div>
            <div class="timeline-body"><p>I've confirmed that this bug exists since 0.1.25 when env vars in pyproject.toml was introduced. The problem is complex to solve: When we cache requirements, we store them as string with their env var resolved, losing the verbatim representation on the url. I tried to change the cache representation of requirements to the extended from (0cb98f419c01935da19b5a82c48d2ec1f2159407), but this clashes with the build hooks and toml parsing trying to return metadata through serde too, but having requirements as string because they come from python or toml respectively, with <code>Metadata23</code> being used both with the stringly case and in the cache.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wild-endeavor">@wild-endeavor</a> on 2025-04-25 20:01</div>
            <div class="timeline-body"><p>unrelated to this, but is it possible to find out what the value of PROJECT_ROOT is as an absolute path?  (basically where the lock/pyproject file is, but is this programmatically available somehow?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jiridanek">@jiridanek</a> on 2025-12-22 11:55</div>
            <div class="timeline-body"><p>I've observed this with <code>pylock.toml</code> as well as with requirements.txt.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../opendatahub-io/notebooks/pulls/2795.html">opendatahub-io/notebooks#2795</a> on 2025-12-22 12:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:27 UTC
    </footer>
</body>
</html>
