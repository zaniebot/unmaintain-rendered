<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lockfile with package that has no distributions with environments - astral-sh/uv #17067</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Lockfile with package that has no distributions with environments</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/17067">#17067</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2025-12-10 11:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/konstin">@konstin</a> on 2025-12-10 11:14</div>
            <div class="timeline-body"><p>Using <code>tool.uv.environments</code> with an index that mismatches those environments creates a lockfile with an entry with no distributions. The resolution should instead fail.</p>
<pre><code class="language-toml">[project]
name = &quot;uv-reproducer&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;==3.13.*&quot;
dependencies = [
    &quot;charset-normalizer==3.4.4&quot;,
]

[[tool.uv.index]]
url = &quot;./platform-mismatch&quot;
format = &quot;flat&quot;

[[tool.uv.index]]
url = &quot;./default&quot;
format = &quot;flat&quot;

[tool.uv]
environments = [&quot;sys_platform == 'linux'&quot;]
</code></pre>
<pre><code class="language-toml">version = 1
revision = 3
requires-python = &quot;==3.13.*&quot;
resolution-markers = [
    &quot;sys_platform == 'linux'&quot;,
]
supported-markers = [
    &quot;sys_platform == 'linux'&quot;,
]

[[package]]
name = &quot;charset-normalizer&quot;
version = &quot;3.4.4&quot;
source = { registry = &quot;platform-mismatch&quot; }

[[package]]
name = &quot;uv-reproducer&quot;
version = &quot;0.1.0&quot;
source = { virtual = &quot;.&quot; }
dependencies = [
    { name = &quot;charset-normalizer&quot;, marker = &quot;sys_platform == 'linux'&quot; },
]

[package.metadata]
requires-dist = [{ name = &quot;charset-normalizer&quot;, specifier = &quot;==3.4.4&quot; }]
</code></pre>
<p>To reproduce:</p>
<pre><code>pushd default/
# Source file for charset-normalizer
curl -O https://files.pythonhosted.org/packages/13/69/33ddede1939fdd074bce5434295f38fae7136463422fe4fd3e0e89b98062/charset_normalizer-3.4.4.tar.gz
# And of course we need setuptools
curl -O https://files.pythonhosted.org/packages/a3/dc/17031897dae0efacfea57dfd3a82fdd2a2aeb58e0ff71b77b87e44edc772/setuptools-80.9.0-py3-none-any.whl
popd

# Works so long as you're not on a Windows on ARM host
pushd platform-mismatch/
curl -O https://files.pythonhosted.org/packages/af/8f/3ed4bfa0c0c72a7ca17f0380cd9e4dd842b09f664e780c13cff1dcf2ef1b/charset_normalizer-3.4.4-cp313-cp313-win_arm64.whl
popd
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/17068.html">astral-sh/uv#17068</a> on 2025-12-10 11:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/12721.html">astral-sh/uv#12721</a> on 2025-12-10 11:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-12-11 15:19</div>
            <div class="timeline-body"><p>Is this only true of flat indexes?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-12-11 15:29</div>
            <div class="timeline-body"><p>It works with a regular index too:</p>
<pre><code class="language-toml">[project]
name = &quot;debug&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = [
  &quot;mkl==2025.3.0&quot;,
]

[[tool.uv.index]]
url = &quot;https://download.pytorch.org/whl/&quot;

[tool.uv]
environments = [&quot;sys_platform == 'darwin'&quot;]
</code></pre>
<pre><code class="language-toml">[[package]]
name = &quot;mkl&quot;
version = &quot;2025.3.0&quot;
source = { registry = &quot;https://download.pytorch.org/whl/&quot; }
dependencies = [
    { name = &quot;intel-openmp&quot;, marker = &quot;sys_platform == 'darwin'&quot; },
    { name = &quot;onemkl-license&quot;, marker = &quot;sys_platform == 'darwin'&quot; },
    { name = &quot;tbb&quot;, marker = &quot;sys_platform == 'darwin'&quot; },
]
</code></pre>
<p><code>required-environments</code> correctly fails the resolution.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:33:15 UTC
    </footer>
</body>
</html>
