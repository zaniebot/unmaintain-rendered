<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi stage docker builds fails for binary libraries - astral-sh/uv #16510</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Multi stage docker builds fails for binary libraries</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/16510">#16510</a>
        opened by <a href="https://github.com/erikvanoosten">@erikvanoosten</a>
        on 2025-10-30 09:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/erikvanoosten">@erikvanoosten</a></div>
            <div class="timeline-body">Summary
<p>The Docker integration documentation suggests to use a multi stage docker process, where we copy the python installation from the first image into the final image. See https://docs.astral.sh/uv/guides/integration/docker/#non-editable-installs</p>
<p>However, this process does not work when there is a dependency on a binary library. In my tests with <code>bookworm-slim</code>, these <code>so</code> files land in <code>/usr/lib/aarch64-linux-gnu</code> (which also contains a ton of other files). Since they don&#x27;t land in the directory given by <code>UV_PYTHON_INSTALL_DIR</code>, they won&#x27;t be copied into the final image.</p>
<p>For example, the python <code>shapely</code> package depends on the <code>geos</code> library. Even though <code>UV_PYTHON_INSTALL_DIR</code> is set to <code>/python</code>, that library is downloaded/created in the first stage as file <code>/usr/lib/aarch64-linux-gnu/libgeos_c.so</code>.</p>
Minimized example application
<p>The following ZIP file contains a minimal project that demonstrates the issue.</p>
<p><a href="https://github.com/user-attachments/files/23230070/example-app.zip">example-app.zip</a></p>
<p>After unzipping: build and run the multi-stage project:</p>
<pre><code>uv lock
docker build --tag example-app:multi .
docker run --rm -ti example-app:multi
</code></pre>
<p>Results in:</p>
<pre><code>OSError: Could not find lib geos_c or load any of its variants [&#x27;libgeos_c.so.1&#x27;, &#x27;libgeos_c.so&#x27;].
</code></pre>
<p>Build and run the single-stage project:</p>
<pre><code>uv lock
docker build -f Dockerfile-single-stage --tag example-app:single .
docker run --rm -ti example-app:single
</code></pre>
<p>Results in:</p>
<pre><code>PI is roughly 3.1365484905459398 
</code></pre>
Platform
<p>macOS 15 host, colima, debian (bookworm-slim) docker images</p>
Version
<p>uv 0.8.17</p>
Python version
<p>Python 3.11.13</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/erikvanoosten">@erikvanoosten</a> on 2025-10-30 09:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/erikvanoosten">@erikvanoosten</a> on 2025-10-30 13:17</div>
            <div class="timeline-body"><p><strong>UPDATE:</strong> see addition at the end of this comment</p>
<p>-- old text --</p>
<p>Here is a workaround for the exampleapp in the zip file:</p>
<p>In <code>Dockerfile</code> after the lines:</p>
<pre><code># Install only the dependencies
RUN ...elided... uv sync --locked --no-install-project --no-editable --no-dev
</code></pre>
<p>add:</p>
<pre><code># Install binary libraries:
RUN cp /usr/lib/*/libgeos* /python/*/lib/
</code></pre>
<p>It is a bit crappy because we need to explicitly add every additional library. Also, it is only tested for ARM64 environments, not sure if it works on AMD64 machines.</p>
<p>-- end of old text --</p>
<p><strong>Update:</strong> the proposed workaround here is not very reliable. It is better to use <code>apt</code> and install the library again in the second stage.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2025-11-01 03:41</div>
            <div class="timeline-body"><p>Are these system libraries installed via <code>apt</code>, or some other mechanism? In case its a system library I&#x27;d typically suggest reinstall your system libraries (usually without dev headers) on your final stage rather than copying so files as links could easily get broken and cause unintended side-effects.</p>
<p>To expand, if these .so files are not packaged by a python wheel (e.g. shapely), you would still need to install them yourself. Wheels can decide to package these for you using tools like <a href="https://github.com/pypa/auditwheel">auditwheel</a>, but may not do so possibly due to license restrictions or other limitations.</p>
<p><code>UV_PYTHON_INSTALL_DIR</code> does not dictate where system libraries are installed, but if a wheel does package so files, they&#x27;ll be in the expected site-packages location in most cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by <a href="https://github.com/samypr100">@samypr100</a> on 2025-11-01 03:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">external</span> added by <a href="https://github.com/samypr100">@samypr100</a> on 2025-11-01 03:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/erikvanoosten">@erikvanoosten</a> on 2025-11-01 09:17</div>
            <div class="timeline-body"><p>Thanks for replying!</p>
<p>Does this mean that support from uv is not something that we can expect (not even in the future)?</p>
<blockquote>
<p>Are these system libraries installed via apt, or some other mechanism?</p>
</blockquote>
<p>As far as I can tell the lib_geos library somehow comes with the shapely package.</p>
<blockquote>
<p>UV_PYTHON_INSTALL_DIR does not dictate where system libraries are installed</p>
</blockquote>
<p>I understand. But they <em>could</em> be installed in UV_PYTHON_INSTALL_DIR/*/lib (where * is the name of the specific python version), at least this is true for cpython.</p>
<blockquote>
<p>I&#x27;d typically suggest reinstall your system libraries... on your final stage</p>
</blockquote>
<p>I was hoping we&#x27;d not have to pollute the final stage with transient apt files. But I guess this is the best solution.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2025-11-01 18:37</div>
            <div class="timeline-body"><blockquote>
<p>As far as I can tell the lib_geos library somehow comes with the shapely package.</p>
</blockquote>
<p>I see, in that case it would be great if you could share more about your build process instead to understand why its failing and how we can help more efficiently. A minimal reproducible example would be great.</p>
<p>I tried a quick check and I see no problems with installing shapely and it does seem to package it&#x27;s own .so files and runs correctly.</p>
<pre><code>$ docker run -it --rm --name build-test ghcr.io/astral-sh/uv:python3.14-trixie bash -c &#x27;cd /root &amp;&amp; uv init &amp;&amp; uv add shapely &amp;&amp; find .venv -iname libgeos* &amp;&amp; uv run python -c &quot;import shapely; print(shapely.__version__)&quot;&#x27;
Initialized project `root`
Using CPython 3.14.0 interpreter at: /usr/local/bin/python3.14
Creating virtual environment at: .venv
Resolved 3 packages in 333ms
Prepared 2 packages in 1.21s
Installed 2 packages in 45ms
 + numpy==2.3.4
 + shapely==2.1.2
.venv/lib/python3.14/site-packages/shapely.libs/libgeos_c-abcdd5fa.so.1.19.2
.venv/lib/python3.14/site-packages/shapely.libs/libgeos-3ef06f11.so.3.13.1
2.1.2
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">external</span> removed by <a href="https://github.com/samypr100">@samypr100</a> on 2025-11-01 18:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by <a href="https://github.com/samypr100">@samypr100</a> on 2025-11-01 18:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/erikvanoosten">@erikvanoosten</a> on 2025-11-01 18:40</div>
            <div class="timeline-body"><blockquote>
<p>A minimal reproducible example would be great.</p>
</blockquote>
<p>I added one to the description of this issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2025-11-01 19:25</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>A minimal reproducible example would be great.</p>
</blockquote>
<p>I added one to the description of this issue.</p>
</blockquote>
<p>Thanks, I can&#x27;t reproduce <code>OSError: Could not find lib geos_c or load any of its variants [&#x27;libgeos_c.so.1&#x27;, &#x27;libgeos_c.so&#x27;].</code> from the attached example either.</p>
<p>I see libgeos is correctly added.</p>
<pre><code>$ ls -la /app/.venv/lib/python3.11/site-packages/shapely.libs/*
-rwxr-xr-x 1 root root 5315353 Nov  1 19:10 /app/.venv/lib/python3.11/site-packages/shapely.libs/libgeos-3ef06f11.so.3.13.1
-rwxr-xr-x 1 root root  514225 Nov  1 19:10 /app/.venv/lib/python3.11/site-packages/shapely.libs/libgeos_c-abcdd5fa.so.1.19.2
</code></pre>
<pre><code>$ ls -l /app/.venv/lib/python3.11/site-packages
total 48
drwxr-xr-x  2 root root 4096 Nov  1 19:10 __pycache__
-rw-r--r--  1 root root   18 Nov  1 19:10 _virtualenv.pth
-rw-r--r--  1 root root 4342 Nov  1 19:10 _virtualenv.py
drwxr-xr-x  3 root root 4096 Nov  1 19:11 example_app
drwxr-xr-x  2 root root 4096 Nov  1 19:11 example_app-0.1.0.dist-info
drwxr-xr-x 25 root root 4096 Nov  1 19:10 numpy
drwxr-xr-x  2 root root 4096 Nov  1 19:10 numpy-2.3.4.dist-info
drwxr-xr-x  2 root root 4096 Nov  1 19:10 numpy.libs
drwxr-xr-x  7 root root 4096 Nov  1 19:10 shapely
drwxr-xr-x  3 root root 4096 Nov  1 19:10 shapely-2.1.2.dist-info
drwxr-xr-x  2 root root 4096 Nov  1 19:10 shapely.libs
</code></pre>
<p>I tried both x86_64 and arm64 variants with the same result. Are you using a different shapely version than 2.1.2? Can you also attach your lock file?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2025-11-01 19:30</div>
            <div class="timeline-body"><p>I also removed <code>RUN apt update &amp;&amp; apt install -y libgeos-dev build-essential</code> as it shouldn&#x27;t be needed, and the application still ran sucessfully.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/erikvanoosten">@erikvanoosten</a> on 2025-11-03 08:11</div>
            <div class="timeline-body"><p>With shapely 2.1.2 everything is okay indeed! My apologies, I didn&#x27;t test the minimizer properly.</p>
<p>The application that the example-app minimizer is based on, uses shapely 1.8.5. Changing <code>pyproject.toml</code> as follows:</p>
<pre><code>dependencies = [
    &quot;shapely==1.8.5&quot;, # &lt;-- add version
]
</code></pre>
<p>will make the problematic behavior appear.</p>
<p>Here is my lock file after making the above change:
<a href="https://github.com/user-attachments/files/23297974/uv.lock.zip">uv.lock.zip</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/erikvanoosten">@erikvanoosten</a> on 2025-11-03 12:18</div>
            <div class="timeline-body"><p>Closing this issue. The underlying problem is that shapely 1.8.5 does not install the library, also not in the first stage. This is not a uv problem. This was not immediately clear due to a lot of confusing factors.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/erikvanoosten">@erikvanoosten</a> on 2025-11-03 12:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:40:51 UTC
    </footer>
</body>
</html>
