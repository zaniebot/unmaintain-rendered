<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv add` struggles with an auto-generated entry in `uv.lock` - astral-sh/uv #4267</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`uv add` struggles with an auto-generated entry in `uv.lock`</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/4267">#4267</a>
        opened by <a href="https://github.com/hoechenberger">@hoechenberger</a>
        on 2024-06-12 12:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/hoechenberger">@hoechenberger</a> on 2024-06-12 12:39</div>
            <div class="timeline-body"><p><code>uv add</code> creates a lockfile <code>uv.lock</code> it cannot parse again on re-run.</p>
<h3>Steps to reproduce:</h3>
<ul>
<li>Check out <a href="https://github.com/mne-tools/mne-python.git"><code>mne-python</code></a></li>
<li>run <code>uv add</code> to add an entry to <code>pyproject.toml</code>. This will also create a <code>uv.lock</code> lockfile:</li>
</ul>
<pre><code class="language-shell">$ uv toolchain install 3.12
warning: `uv toolchain install` is experimental and may change without warning.
Looking for Python 3.12
Downloading cpython-3.12.3-linux-aarch64-gnu
Installed Python 3.12.3 to /home/mne-user/.local/share/uv/toolchains/cpython-3.12.3-linux-aarch64-gnu
$ uv venv -p /home/mne-user/.local/share/uv/toolchains/cpython-3.12.3-linux-aarch64-gnu/install/bin/python
$ . .venv/bin/activate
$ uv add ipython
warning: `uv add` is experimental and may change without warning.
Resolved 286 packages in 3.61s
error: found distribution vtk==9.3.0 @ registry+https://pypi.org/simple with neither wheels nor source distribution
</code></pre>
<p>All good so far: <code>pyproject.toml</code> got updated. The error message about <code>vtk</code> is irritating because <code>vtk</code> is only an &quot;extra&quot; dependency, but this can be ignored for now.</p>
<p>Ok, now let's try to <code>uv add</code> another package:</p>
<pre><code class="language-shell">$ uv add cowsay 
warning: `uv add` is experimental and may change without warning.
Failed to parse lockfile; ignoring locked requirements: TOML parse error at line 492, column 10
    |
492 | marker = &quot;&quot;
    |          ^^
Expected marker value, found end of dependency specification

^
Resolved 287 packages in 1.18s
error: found distribution vtk==9.3.0 @ registry+https://pypi.org/simple with neither wheels nor source distribution
</code></pre>
<p>Looking at <code>uv.lock</code>, it turns out the problematic <code>marker</code> entry is for the <code>numpy</code> dependency:</p>
<pre><code class="language-toml">[[distribution.dependencies]]
name = &quot;numpy&quot;
version = &quot;1.26.4&quot;
source = &quot;registry+https://pypi.org/simple&quot;
marker = &quot;&quot;
</code></pre>
<h3>System info</h3>
<pre><code class="language-shell">$ uv --version 
uv 0.2.11
$ uname -a    
Linux 1a34753d5e98 6.6.26-linuxkit #1 SMP Sat Apr 27 04:13:19 UTC 2024 aarch64 GNU/Linux
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-12 12:56</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-06-12 12:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-06-12 12:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @charliermarsh on 2024-06-12 12:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-12 13:00</div>
            <div class="timeline-body"><p>You can reproduce this with: <code>dependencies = [&quot;cftime==1.6.4&quot;]</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4271.html">astral-sh/uv#4271</a> on 2024-06-12 14:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-06-12 14:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:29 UTC
    </footer>
</body>
</html>
