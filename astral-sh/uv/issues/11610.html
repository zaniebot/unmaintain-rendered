<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv export creating constraint files that use python_full_version where they could be using just python_version - astral-sh/uv #11610</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv export creating constraint files that use python_full_version where they could be using just python_version</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/11610">#11610</a>
        opened by <a href="https://github.com/gibsondan">@gibsondan</a>
        on 2025-02-18 23:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/gibsondan">@gibsondan</a> on 2025-02-18 23:28</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Running 'uv export --no-hashes' on this pyproject.toml file:</p>
<pre><code>[project]
name = &quot;jaffle_platform&quot;
requires-python = &quot;&gt;=3.9,&lt;3.13&quot;
version = &quot;0.1.0&quot;
dependencies = [
    &quot;pytest&quot;,
]
</code></pre>
<p>Outputs this:</p>
<pre><code># This file was autogenerated via `uv export`.
colorama==0.4.6 ; sys_platform == 'win32'
exceptiongroup==1.2.2 ; python_full_version &lt; '3.11'
iniconfig==2.0.0
packaging==24.2
pluggy==1.5.0
pytest==8.3.4
tomli==2.2.1 ; python_full_version &lt; '3.11'
</code></pre>
<p>Note the line that says</p>
<pre><code>python_full_version &lt; '3.11'
</code></pre>
<p>Should this instead ve</p>
<pre><code>python_version &lt; '3.11'
</code></pre>
<p>?</p>
<p><code>python_full_version</code> is not available in all build environments, notably PEX when using the --platform argument: https://pex.readthedocs.io/en/v2.1.66/buildingpex.html#platform</p>
<p>So this issue makes it impossible to run <code>uv export</code> and pass the result into PEX to build a PEX file from a uv project.</p>
<h3>Platform</h3>
<p>Darwin 23.6.0 arm64</p>
<h3>Version</h3>
<p>uv 0.4.8 (956cadd1a 2024-09-09)</p>
<h3>Python version</h3>
<p>Python 3.11.9</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @gibsondan on 2025-02-18 23:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-18 23:54</div>
            <div class="timeline-body"><p>Hm. We always normalize these to the full version for consistency, as it avoids subtle bugs https://github.com/astral-sh/uv/pull/6126</p>
<p>We could simplify them back to <code>python_version</code> in output when feasible, but I'm not sure it's worth it.</p>
<p>Why can't you use Pex's <code>--complete-platform</code> option? per</p>
<blockquote>
<p>Constraints: when --platform is used the <a href="https://www.python.org/dev/peps/pep-0508/#environment-markers">environment marker</a> python_full_version is not available, because its value cannot be determined from a platform where only a two-digit string representing the python version can be specified (e.g., 38), while python_full_version is meant to have 3 digits (e.g., 3.8.10). If python_full_version is found an UndefinedEnvironmentName exception will be raised. To remedy this, use --complete-platform instead.</p>
</blockquote>
<p>I'm not sure I entirely follow why they cannot support <code>python_full_version</code> there, but I'm not familiar with the workings of Pex.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @zanieb on 2025-02-18 23:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-18 23:55</div>
            <div class="timeline-body"><p>cc @jsirois I'd appreciate any context you could provide.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gibsondan">@gibsondan</a> on 2025-02-19 00:02</div>
            <div class="timeline-body"><p>We’re looking into using —complete-platform - that might work to unblock us here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jsirois">@jsirois</a> on 2025-02-19 00:21</div>
            <div class="timeline-body"><p>@gibsondan definitely use <code>--complete-platform</code>. That said, if you know the full version you're targeting, read the last paragraph of the <code>--platform</code> docs: https://docs.pex-tool.org/buildingpex.html#platform</p>
<p>@zanieb Pex historically (since maybe 2011) has supported cross-resolving with a <code>--platform</code> argument that looks like so: <code>linux_x86_64-cp-36-cp36m</code>. This argument is akin to the 4 Pip arguments: <code>--platform</code>, <code>--python-version</code>, <code>--implementation</code>, and <code>--abi</code>.</p>
<p>It's a bad idea, since the information supplied is not enough to use to impersonate an interpreter on the foreign platform with full fidelity for the purposes of evaluating environment markers and wheel tags.</p>
<p>That said, it works in many cases. I made the cases where it doesn't work strict. For <code>--platform linux_x86_64-cp-36-cp36m</code> and an environment marker <code>python_full_version &gt;= '3.6.2'</code> I don't have enough information and fail fast. I don't even look at the marker condition, I just see <code>python_full_version</code> and die since that marker is intended to address X.Y.Z and <code>python_version</code> is generally used if the constraint is only sensitive to X.Y or just X.</p>
<p>It looks like uv often (always?) uses <code>python_full_version</code> even when the condition only needs <code>python_version</code> to evaluate correctly. This trips Pex up when evaluating a <code>--platform</code> resolve.</p>
<p>Hopefully that makes sense.</p>
<p>Clearly Pex could go the extra mile, parse the marker condition and rewrite as <code>python_version</code> when that's all that needed to allow the foreign <code>--platform</code> resolve to continue, but I've been actively discouraging <code>--platform</code> use for a while now; so I'm not inclined to go that extra mile.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-19 00:29</div>
            <div class="timeline-body"><p>Thanks for taking the time to write that up!</p>
<blockquote>
<p>It looks like uv often (always?) uses python_full_version even when the condition only needs python_version to evaluate correctly.</p>
</blockquote>
<p>Yeah we always transform <code>python_version</code> to <code>python_full_version</code> so we don't need to worry about mixed representations when performing marker algebra (it's hard enough as is!).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gibsondan">@gibsondan</a> on 2025-02-19 19:09</div>
            <div class="timeline-body"><p>--complete-platform is working great, so this is no longer blocking for us.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-19 19:10</div>
            <div class="timeline-body"><p>I'll close this out for now — we can reconsider if there are more use-cases where the normalization is problematic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-02-19 19:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:02 UTC
    </footer>
</body>
</html>
