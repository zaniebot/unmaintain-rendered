<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv` sync in workspace during docker build doesn't install dependencies - astral-sh/uv #8460</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>uv</code> sync in workspace during docker build doesn't install dependencies</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/8460">#8460</a>
        opened by <a href="https://github.com/VVoruganti">@VVoruganti</a>
        on 2024-10-22 14:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/VVoruganti">@VVoruganti</a></div>
            <div class="timeline-body"><p>I have a project that is making use of the <code>uv</code> workspaces feature. It has the following structure</p>
<pre><code>.
├── pyproject.toml
├── uv.lock
├── bot/
│   └── pyproject.toml
├── api/
│   └── pyproject.toml
└── agent/
    ├── agent/
    ├── pyroject.toml
    └── dist/
</code></pre>
<p>This is my root <code>pyproject.toml</code></p>
<pre><code class="language-toml">[project]
name = &quot;tutor-gpt&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.11&quot;
dependencies = [
    &quot;honcho-ai&gt;=0.0.15&quot;,
    &quot;python-dotenv&gt;=1.0.1&quot;,
]

[tool.uv.sources]
agent = { workspace = true }
api = { workspace = true }
bot = { workspace = true }

[tool.uv.workspace]
members = [&quot;agent/&quot;, &quot;api/&quot;, &quot;bot/&quot;]
exclude = [&quot;www/*&quot;]
</code></pre>
<p>The <code>agent</code> package is installed by the other two apps.</p>
<p>I need to build a docker image that setups up the <code>api</code> package so I modified the cached example in the docs.</p>
<pre><code class="language-Dockerfile">FROM python:3.11-slim-bullseye

COPY --from=ghcr.io/astral-sh/uv:0.4.9 /uv /bin/uv

# Set Working directory
WORKDIR /app

RUN addgroup --system app &amp;&amp; adduser --system --group app
RUN chown -R app:app /app
USER app

# Enable bytecode compilation
ENV UV_COMPILE_BYTECODE=1

# Copy from the cache instead of linking since it's a mounted volume
ENV UV_LINK_MODE=copy

# Install the project's dependencies using the lockfile and settings
RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,source=uv.lock,target=uv.lock \
    --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
    uv sync --frozen --no-install-workspace --no-dev

# Copy only requirements to cache them in docker layer
COPY --chown=app:app pyproject.toml uv.lock  /app/

# Place executables in the environment at the front of the path
ENV PATH=&quot;/app/.venv/bin:$PATH&quot;

EXPOSE 8000

COPY --chown=app:app agent/ /app/agent/
COPY --chown=app:app bot/ /app/bot/
COPY --chown=app:app api/ /app/api/

RUN --mount=type=cache,target=/root/.cache/uv \
      uv sync --frozen --package api

CMD [&quot;fastapi&quot;, &quot;run&quot;, &quot;--host&quot;, &quot;0.0.0.0&quot;, &quot;api/main.py&quot;]
</code></pre>
<p>When I run my container I'm getting the following error which indicated to me that none of the packages installed.</p>
<pre><code>docker: Error response from daemon: failed to create task for container: failed to create shim task: OCI runtime create failed: runc create failed: unable to start container process: exec: &quot;fastapi&quot;: executable file not found in $PATH: unknown.
</code></pre>
<p>I verified this by opening a shell in the container</p>
<pre><code>app@612b3a28fa65:/app$ uv pip list
app@612b3a28fa65:/app$ uv sync --package api
Resolved 54 packages in 2ms
Audited in 0.00ms
app@612b3a28fa65:/app$
</code></pre>
<p>I've noticed that I can force the container to install packages if I remove the <code>uv.lock</code> and the <code>--frozen</code> tag, but that not desirable for having truly reproducible builds.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-22 14:53</div>
            <div class="timeline-body"><p>Do you mind providing a reproduction with code, like a Git repo I can clone? I'm happy to help but it's time consuming to scaffold this stuff.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @charliermarsh on 2024-10-22 14:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/VVoruganti">@VVoruganti</a> on 2024-10-23 15:42</div>
            <div class="timeline-body"><blockquote>
<p>Do you mind providing a reproduction with code, like a Git repo I can clone? I'm happy to help but it's time consuming to scaffold this stuff.</p>
</blockquote>
<p>Yes I've been working out of this repo: https://github.com/plastic-labs/tutor-gpt</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vilim">@vilim</a> on 2024-10-25 17:10</div>
            <div class="timeline-body"><p>I have a similar issue, and am not able to e.g. run pytest from the second package.
The example is here
https://github.com/vilim/uv-workspace-test
inside the docker container running <code>uv tree</code> yields the expected</p>
<pre><code>subproject1 v0.1.0
└── pydantic v2.9.2
    ├── annotated-types v0.7.0
    ├── pydantic-core v2.23.4
    │   └── typing-extensions v4.12.2
    └── typing-extensions v4.12.2
subproject2 v0.1.0
└── pytest v8.3.3 (group: dev)
    ├── iniconfig v2.0.0
    ├── packaging v24.1
    └── pluggy v1.5.0
</code></pre>
<p>however when running pytest I get</p>
<pre><code>uv run --package subproject2 pytest

Installed 4 packages in 9ms
Bytecode compiled 98 files in 340ms
============================================================================= test session starts =============================================================================
platform linux -- Python 3.12.7, pytest-8.3.3, pluggy-1.5.0
rootdir: /app
configfile: pyproject.toml
collected 0 items / 1 error                                                                                                                                                   

=================================================================================== ERRORS ====================================================================================
_________________________________________________________________ ERROR collecting subproject2/test_hello.py __________________________________________________________________
ImportError while importing test module '/app/subproject2/test_hello.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/local/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
subproject2/test_hello.py:1: in &lt;module&gt;
    from hello import main
subproject2/hello.py:1: in &lt;module&gt;
    from subproject1 import module
E   ModuleNotFoundError: No module named 'subproject1'
=========================================================================== short test summary info ===========================================================================
ERROR subproject2/test_hello.py
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
============================================================================== 1 error in 0.11s ===============================================================================
</code></pre>
<p>which has two issues, first that the packages get downloaded and installed (again?), and then the dependency is not found.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-25 17:11</div>
            <div class="timeline-body"><p>I think you need to add a <code>[build-system]</code> to <code>subproject1</code>. It's not marked as a package right now, so it won't be installed in the environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vilim">@vilim</a> on 2024-10-25 17:34</div>
            <div class="timeline-body"><p>I added a build system, still the same result</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-25 17:44</div>
            <div class="timeline-body"><p>You have a couple different issues with your project: (1) <code>subproject2</code> doesn't declare a dependency on <code>subproject1</code>, so it can't import it; and (2) your projects aren't laid out as valid, buildable Python packages.</p>
<pre><code class="language-diff">diff --git a/.gitignore b/.gitignore
new file mode 100644
index 0000000..b5bbca2
--- /dev/null
+++ b/.gitignore
@@ -0,0 +1,3 @@
+__pycache__
+.pytest_cache
+.venv
diff --git a/subproject1/pyproject.toml b/subproject1/pyproject.toml
index bea73c3..1e483dd 100644
--- a/subproject1/pyproject.toml
+++ b/subproject1/pyproject.toml
@@ -10,4 +10,4 @@ dependencies = [
 
 [build-system]
 requires = [&quot;hatchling&quot;]
-build-backend = &quot;hatchling.build&quot;
\ No newline at end of file
+build-backend = &quot;hatchling.build&quot;
diff --git a/subproject1/src/subproject1/__init__.py b/subproject1/src/subproject1/__init__.py
new file mode 100644
index 0000000..e69de29
diff --git a/subproject1/module.py b/subproject1/src/subproject1/module.py
similarity index 78%
rename from subproject1/module.py
rename to subproject1/src/subproject1/module.py
index 7060ad1..70a8fe4 100644
--- a/subproject1/module.py
+++ b/subproject1/src/subproject1/module.py
@@ -4,4 +4,4 @@ class T(BaseModel):
     a: str
 
 def dependency():
-    return T(a=&quot;ABC&quot;)
\ No newline at end of file
+    return T(a=&quot;ABC&quot;)
diff --git a/subproject2/pyproject.toml b/subproject2/pyproject.toml
index 6dbbbd8..9cca09f 100644
--- a/subproject2/pyproject.toml
+++ b/subproject2/pyproject.toml
@@ -4,9 +4,16 @@ version = &quot;0.1.0&quot;
 description = &quot;Add your description here&quot;
 readme = &quot;README.md&quot;
 requires-python = &quot;&gt;=3.11&quot;
-dependencies = []
+dependencies = [&quot;subproject1&quot;]
+
+[tool.uv.sources]
+subproject1 = { workspace = true }
 
 [tool.uv]
 dev-dependencies = [
     &quot;pytest&gt;=8.3.3&quot;,
 ]
+
+[build-system]
+requires = [&quot;hatchling&quot;]
+build-backend = &quot;hatchling.build&quot;
diff --git a/subproject2/src/subproject2/__init__.py b/subproject2/src/subproject2/__init__.py
new file mode 100644
index 0000000..e69de29
diff --git a/subproject2/hello.py b/subproject2/src/subproject2/hello.py
similarity index 100%
rename from subproject2/hello.py
rename to subproject2/src/subproject2/hello.py
diff --git a/subproject2/test_hello.py b/subproject2/test_hello.py
deleted file mode 100644
index 5a94c31..0000000
--- a/subproject2/test_hello.py
+++ /dev/null
@@ -1,4 +0,0 @@
-from hello import main
-
-def test_hello():
-    main()
\ No newline at end of file
diff --git a/subproject2/tests/test_hello.py b/subproject2/tests/test_hello.py
new file mode 100644
index 0000000..63081ff
--- /dev/null
+++ b/subproject2/tests/test_hello.py
@@ -0,0 +1,4 @@
+from subproject2.hello import main
+
+def test_hello():
+    main()
diff --git a/uv.lock b/uv.lock
index 021736a..ddb8189 100644
--- a/uv.lock
+++ b/uv.lock
@@ -136,7 +136,7 @@ wheels = [
 [[package]]
 name = &quot;subproject1&quot;
 version = &quot;0.1.0&quot;
-source = { virtual = &quot;subproject1&quot; }
+source = { editable = &quot;subproject1&quot; }
 dependencies = [
     { name = &quot;pydantic&quot; },
 ]
@@ -147,7 +147,10 @@ requires-dist = [{ name = &quot;pydantic&quot;, specifier = &quot;&gt;=2.9.2&quot; }]
 [[package]]
 name = &quot;subproject2&quot;
 version = &quot;0.1.0&quot;
-source = { virtual = &quot;subproject2&quot; }
+source = { editable = &quot;subproject2&quot; }
+dependencies = [
+    { name = &quot;subproject1&quot; },
+]
 
 [package.dev-dependencies]
 dev = [
@@ -155,6 +158,7 @@ dev = [
 ]
 
 [package.metadata]
+requires-dist = [{ name = &quot;subproject1&quot;, editable = &quot;subproject1&quot; }]
 
 [package.metadata.requires-dev]
 dev = [{ name = &quot;pytest&quot;, specifier = &quot;&gt;=8.3.3&quot; }]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-25 17:46</div>
            <div class="timeline-body"><p>Here it is as a PR: https://github.com/vilim/uv-workspace-test/pull/1</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vilim">@vilim</a> on 2024-10-25 19:08</div>
            <div class="timeline-body"><p>Thank you very much, this works now! (in the original code where I had the issue I had the proper package layout, dependencies and sources configured, but not the build system, adding just the build system makes it work). Maybe it would be a good idea to mention this in the workspace documentation?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/VVoruganti">@VVoruganti</a> on 2024-11-05 16:15</div>
            <div class="timeline-body"><p>@charliermarsh Can you let me know if any more additional information is needed to reproduce the error I was having. This repo has a the uv workspace defined at the top level:</p>
<p>https://github.com/plastic-labs/tutor-gpt</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-14 20:04</div>
            <div class="timeline-body"><p>@VVoruganti -- Just checking, is this still relevant? I copied over the Dockerfile above and built + ran the container, and it seemed to find <code>fastapi</code> without issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/VVoruganti">@VVoruganti</a> on 2025-02-19 20:13</div>
            <div class="timeline-body"><blockquote>
<p><a href="https://github.com/VVoruganti">@VVoruganti</a> -- Just checking, is this still relevant? I copied over the Dockerfile above and built + ran the container, and it seemed to find <code>fastapi</code> without issue.</p>
</blockquote>
<p>Hey Charlie not relevant anymore we have migrated away from our original architecture. Unsure what the problem was.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-02-19 20:24</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:27:53 UTC
    </footer>
</body>
</html>
