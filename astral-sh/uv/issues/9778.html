<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unable to publish package to Google Artifact Registry - astral-sh/uv #9778</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Unable to publish package to Google Artifact Registry</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/9778">#9778</a>
        opened by <a href="https://github.com/joaodaher">@joaodaher</a>
        on 2024-12-10 15:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/joaodaher">@joaodaher</a> on 2024-12-10 15:59</div>
            <div class="timeline-body"><p>We're currently migrating from Poetry to uv.
We use Google Artifact Registry as our private PyPI server.</p>
<p>I was able to <strong>download</strong> private packages using <code>uv</code> with the <code>pyproject.toml</code> config:</p>
<pre><code>[[tool.uv.index]]
name = &quot;private-pypi&quot;
url = &quot;https://oauth2accesstoken@us-east1-python.pkg.dev/nilo-prd/python-nilo/simple/&quot;

[tool.uv.sources]
our-private-lib = { index = &quot;private-pypi&quot; }
</code></pre>
<p>But I <strong>cannot publish/upload</strong> any private package.</p>
<p>I'm using:
<code>uv publish --keyring-provider subprocess --username __token__ --publish-url https://us-east1-python.pkg.dev/nilo-prd/python-libs/</code></p>
<p>And I get the output (when verbose) followed by a stuck execution:</p>
<pre><code>DEBUG Checking keyring for credentials for __token__@https://us-east1-python.pkg.dev/nilo-prd/python-libs/
DEBUG Found credentials in keyring for https://us-east1-python.pkg.dev/nilo-prd/python-libs/
DEBUG Response code for https://us-east1-python.pkg.dev/nilo-prd/python-libs/: 401 Unauthorized
</code></pre>
<p>With <strong>twine</strong> I can execute:</p>
<pre><code>twine upload --repository-url https://us-east1-python.pkg.dev/nilo-dev/python-libs/ dist/*
</code></pre>
<p>And successfully publish the package. So the keyring seems to be working fine.</p>
<p>Any idea of what I'm missing here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thejosephstevens">@thejosephstevens</a> on 2024-12-20 05:43</div>
            <div class="timeline-body"><p>Unfortunately I'm in the same boat, but I'd like to see a solution here (super excited to see #7839 !) . I've tried both of the documented solutions <a href="https://docs.astral.sh/uv/guides/integration/alternative-indexes/#google-artifact-registry">here</a> and have not been able to get either of them to work. The same twine upload command works just fine for us (that's what we've been using with <code>rye</code>). I have never been able to get anything other than a 401 or 404 with <code>uv publish</code>. What I've run into:</p>
<ul>
<li>If I set keyring provider to subprocess I get a 404 and the command never returns (same as above)</li>
<li>If I have <code>oauth2accesstoken@</code> in the publish url I get a failure due to redirect on publishing. The error instructs me to use the canonical url</li>
<li>If I pass <code>oauth2accesstoken</code> and the token in basic auth in the publish url, I get prompted for username/password</li>
<li>If I use the canonical url (with <code>/simple</code>) and I explicitly pass in the token, I get a 404 and the command never returns.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2025-01-07 19:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-07 19:14</div>
            <div class="timeline-body"><p>cc @konstin</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mmisiewicz-yext">@mmisiewicz-yext</a> on 2025-01-07 22:19</div>
            <div class="timeline-body"><p>I hit the same issue attempting to publish to a Google Artifact Repository in a Github Action. I was able to work around by running:</p>
<pre><code>          ARTIFACT_REGISTRY_TOKEN=$(gcloud auth application-default print-access-token)
          uv publish --index my-registry-here -u oauth2accesstoken -p $ARTIFACT_REGISTRY_TOKEN dist/*

</code></pre>
<p>in my GitHub action.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/10469.html">astral-sh/uv#10469</a> on 2025-01-10 12:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-01-10 12:48</div>
            <div class="timeline-body"><p>There's two interleaving things: The google cloud artifact registry uses <code>oauth2accesstoken</code> as username, not <code>__token__</code> as pypi does, so you need set <code>--username oauth2accesstoken</code>. We also read the username from the URL if you want to set it there, but there was a bug in uv due to how redirects with POST requests are handled, which should be fixed with https://github.com/astral-sh/uv/pull/10469. With that PR, you should be able to specify <code>oauth2accesstoken</code> as username both in the CLI and the URL and publish with e.g.</p>
<pre><code>uv publish --index gcp-index --username oauth2accesstoken --keyring-provider subprocess
</code></pre>
<p>where the index is defined as:</p>
<pre><code class="language-toml">[tool.uv.index]
name = &quot;gcp-index&quot;
index-url = &quot;https://&lt;REGION&gt;-python.pkg.dev/&lt;PROJECT&gt;/&lt;REPOSITORY&gt;/simple/&quot;
publish-url = &quot;https://&lt;REGION&gt;-python.pkg.dev/&lt;PROJECT&gt;/&lt;REPOSITORY&gt;/&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tlienart">@tlienart</a> on 2025-01-17 22:36</div>
            <div class="timeline-body"><p>I wasted a bit of time on this so in case it helps someone @konstin's answer should be adjusted for</p>
<pre><code>uv publish --index $INDEX_NAME --username oauth2accesstoken --password $ACCESS_TOKEN --keyring-provider subprocess
</code></pre>
<p>where ACCESS_TOKEN locally can be <code>$(gcloud auth application-default print-access-token)</code> as in @mmisiewicz-yext 's answer or, on github action, using <code>google-github-actions/auth@v2</code> with token format access token.</p>
<p>and in the pyproject.toml</p>
<pre><code>[[tool.uv.index]]
name = &quot;&lt;INDEX_NAME&gt;&quot;
url = &quot;https://&lt;REGION&gt;-python.pkg.dev/&lt;PROJECT&gt;/&lt;REPOSITORY&gt;/simple/&quot;
publish-url = &quot;https://&lt;REGION&gt;-python.pkg.dev/&lt;PROJECT&gt;/&lt;REPOSITORY&gt;/&quot;
</code></pre>
<p>at least that's what I needed to get it to work</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-01-20 09:02</div>
            <div class="timeline-body"><p>#10469 is released, if there are still problems with the google artifact registry, don't hesitate to open a new issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-01-20 09:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/7839.html">astral-sh/uv#7839</a> on 2025-01-28 15:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/11032.html">astral-sh/uv#11032</a> on 2025-01-28 18:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:24 UTC
    </footer>
</body>
</html>
