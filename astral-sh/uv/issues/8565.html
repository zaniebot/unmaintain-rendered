<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication reused in two named indexes from the same GitLab - astral-sh/uv #8565</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Authentication reused in two named indexes from the same GitLab</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/8565">#8565</a>
        opened by <a href="https://github.com/hbeukers">@hbeukers</a>
        on 2024-10-25 13:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/hbeukers">@hbeukers</a> on 2024-10-25 13:33</div>
            <div class="timeline-body"><p>First, thank you for making uv, we are very happy with it.</p>
<p>Currently, we have a problem with the use of named indexes.
The behavior showed up in the docker <code>ghcr.io/astral-sh/uv:0.4.26-python3.11-bookworm-slim</code> on GitLab for running the pipelines.</p>
<p>Our company has a GitLab with two different indexes from which we download packages.</p>
<p>Our project looks something like this:</p>
<pre><code class="language-toml">[project]
name = &quot;mypackage&quot;
dependencies = [
    &quot;firstpackage&gt;=1.0.0&quot;,
    &quot;secondpackage&gt;=1.0.0&quot;,
]
requires-python = &quot;&gt;=3.11&quot;

[tool.uv.sources]
firstpackage = { index = &quot;firstindex&quot; }
secondpackage = { index = &quot;secondindex&quot; }

[[tool.uv.index]]
name = &quot;firstindex&quot;
url = &quot;https://gitlab.mycompany.com/api/v4/projects/2177/packages/pypi/simple&quot;
explicit = true

[[tool.uv.index]]
name = &quot;secondindex&quot;
url = &quot;https://gitlab.mycompany.com/api/v4/projects/6172/packages/pypi/simple&quot;
explicit = true
</code></pre>
<p>Setting <code>UV_INDEX_FIRSTPACKAGE_PASSWORD</code> and <code>UV_INDEX_SECONDPACKAGE_PASSWORD</code> (and the usernames) gave the following error:</p>
<p><code>Creating virtual environment at: .venv error: Failed to download </code>secondpackage==1.0.0<code>   Caused by: HTTP status client error (404 Not Found) for url (https://gitlab.company.com/api/v4/projects/6122/packages/pypi/files/d1f9d072c85428dc20d5813c9cecdcedd593284573474353487598f60d9804/secondpackage-1.0.0-py3-none-any.whl#sha256=d1f9d072c85428dc20d5813c4285782457837502540d4ac3b18033c8f60d9804)</code></p>
<p>By playing around with the access tokens I found the following structure. We can make tokens specific for an index or general and valid for both.
The following token combinations give the following results</p>
<ul>
<li>first: specific, second: specific -&gt; error</li>
<li>first: general, second: specific -&gt; works</li>
<li>first: specific, second: general -&gt; error</li>
<li>first: general, second: general -&gt; works</li>
<li>first: general, second: no token set -&gt; works</li>
</ul>
<p>It also works if I remove firstpackage and just use a specific token for the secondpackage.</p>
<p>It seems that the authentication of the first index is also used for the second one. We can now solve it by using a token that is valid for both, but we would prefer to use tokens that are specific for each index.</p>
<p>Is this something that is in line with how it was intended?
Are there additional tests/outputs you would need to understand the behavior?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-25 13:36</div>
            <div class="timeline-body"><p>I think @zanieb is most qualified to answer this since I'm guessing it has to do with the fact that the indexes use the same realm.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-25 13:39</div>
            <div class="timeline-body"><p>Hm, this shouldn't happen. We should check the URL-level credential cache first, then, only if a request fails, should we check the realm-level credential cache.</p>
<p>Can you share <code>RUST_LOG=uv=trace</code> logs? Be sure to redact your credentials.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @zanieb by @zanieb on 2024-10-25 13:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hbeukers">@hbeukers</a> on 2024-10-25 14:04</div>
            <div class="timeline-body"><pre><code>DEBUG uv 0.4.26
DEBUG Found project root: `/builds/myteam/mypackage`
DEBUG No workspace root found, using project root
DEBUG Discovered project `mypackage` at: /builds/myteam/mypackage
DEBUG Reading requests from `/builds/myteam/mypackage/.python-version`
DEBUG Searching for Python 3.11 in managed installations or system path
DEBUG Searching for managed installations at `/root/.local/share/uv/python`
TRACE ld path: /lib64/ld-linux-x86-64.so.2
TRACE stdout output from `ld`: &quot;&quot;
TRACE stderr output from `ld`: &quot;/lib64/ld-linux-x86-64.so.2: missing program name\nTry '/lib64/ld-linux-x86-64.so.2 --help' for more information.\n&quot;
TRACE Tried to find musl version by running `&quot;/lib64/ld-linux-x86-64.so.2&quot;`, but failed: Could not find musl version in output of: `/lib64/ld-linux-x86-64.so.2`
TRACE Tried to find libc version from possible symlink at &quot;/lib64/ld-linux-x86-64.so.2&quot;, but failed: Failed to find glibc version in the filename of linker: `/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2`
TRACE stdout output from `ldd --version`: &quot;ld.so (Debian GLIBC 2.36-9+deb12u8) stable release version 2.36.\nCopyright (C) 2022 Free Software Foundation, Inc.\nThis is free software; see the source for copying conditions.\nThere is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A\nPARTICULAR PURPOSE.\n&quot;
TRACE Found manylinux 2.36 in stdout of `ldd --version`
TRACE Searching PATH for executables: python, python3, python3.11
TRACE Checking `PATH` directory for interpreters: /usr/local/bin
TRACE Found possible Python executable: /usr/local/bin/python
TRACE Querying interpreter executable at /usr/local/bin/python
DEBUG Found `cpython-3.11.10-linux-x86_64-gnu` at `/usr/local/bin/python` (search path)
Using CPython 3.11.10 interpreter at: /usr/local/bin/python
Creating virtual environment at: .venv
TRACE Caching credentials for https://gitlab.mycompany.com/api/v4/projects/6172/packages/pypi/simple
TRACE Caching credentials for https://gitlab.mycompany.com/api/v4/projects/2177/packages/pypi/simple
DEBUG Using request timeout of 30s
DEBUG Found static `pyproject.toml` for: mypackage @ file:///builds/myteam/mypackage
DEBUG No workspace root found, using project root
TRACE Performing lookahead for mypackage @ file:///builds/myteam/mypackage
DEBUG Solving with installed Python version: 3.11.10
DEBUG Solving with target Python version: &gt;=3.11
DEBUG Adding direct dependency: mypackage*
DEBUG Searching for a compatible version of mypackage @ file:///builds/myteam/mypackage (*)
DEBUG Adding transitive dependency for mypackage==0.1.0: secondpackage&gt;=1.0.0, &lt;1.0.dev0
DEBUG Adding transitive dependency for mypackage==0.1.0: firstpackage&gt;=1.0.0, &lt;1.0.dev0
TRACE Fetching metadata for secondpackage from https://gitlab.mycompany.com/api/v4/projects/6172/packages/pypi/simple/secondpackage/
TRACE Fetching metadata for firstpackage from https://gitlab.mycompany.com/api/v4/projects/2177/packages/pypi/simple/firstpackage/
TRACE No cache entry exists for /root/.cache/uv/simple-v13/index/70a791461bf74635/secondpackage.rkyv
DEBUG No cache entry for: https://gitlab.mycompany.com/api/v4/projects/6172/packages/pypi/simple/secondpackage/
TRACE Sending fresh GET request for https://gitlab.mycompany.com/api/v4/projects/6172/packages/pypi/simple/secondpackage/
TRACE Handling request for https://gitlab.mycompany.com/api/v4/projects/6172/packages/pypi/simple/secondpackage/
TRACE Request for https://gitlab.mycompany.com/api/v4/projects/6172/packages/pypi/simple/secondpackage/ is unauthenticated, checking cache
TRACE Found cached credentials for URL https://gitlab.mycompany.com/api/v4/projects/6172/packages/pypi/simple/secondpackage/
TRACE Request for https://gitlab.mycompany.com/api/v4/projects/6172/packages/pypi/simple/secondpackage/ is fully authenticated
TRACE No cache entry exists for /root/.cache/uv/simple-v13/index/b83c37047cbdf300/firstpackage.rkyv
DEBUG No cache entry for: https://gitlab.mycompany.com/api/v4/projects/2177/packages/pypi/simple/firstpackage/
TRACE Sending fresh GET request for https://gitlab.mycompany.com/api/v4/projects/2177/packages/pypi/simple/firstpackage/
TRACE Handling request for https://gitlab.mycompany.com/api/v4/projects/2177/packages/pypi/simple/firstpackage/
TRACE Request for https://gitlab.mycompany.com/api/v4/projects/2177/packages/pypi/simple/firstpackage/ is unauthenticated, checking cache
TRACE Found cached credentials for URL https://gitlab.mycompany.com/api/v4/projects/2177/packages/pypi/simple/firstpackage/
TRACE Request for https://gitlab.mycompany.com/api/v4/projects/2177/packages/pypi/simple/firstpackage/ is fully authenticated
TRACE cached request https://gitlab.mycompany.com/api/v4/projects/6172/packages/pypi/simple/secondpackage/ is storable because this is a shared cache and its response has a 'private' cache-control directive
TRACE Received package metadata for: secondpackage
DEBUG Searching for a compatible version of secondpackage (&gt;=1.0.0, &lt;1.1.dev0)
TRACE Selecting candidate for secondpackage with range &gt;=1.0.0, &lt;1.1.dev0 with 7 remote versions
TRACE found candidate for package PackageName(&quot;secondpackage&quot;) with range Range { segments: [(Included(&quot;1.0.0&quot;), Excluded(&quot;1.1.dev0&quot;))] } after 1 steps: &quot;1.0.0&quot; version
DEBUG Selecting: secondpackage==1.0.0 [compatible] (secondpackage-1.0.0-py3-none-any.whl)
TRACE No cache entry exists for /root/.cache/uv/wheels-v2/index/70a791461bf74635/secondpackage/secondpackage-1.0.0-py3-none-any.msgpack
DEBUG No cache entry for: https://gitlab.company.com/api/v4/projects/6122/packages/pypi/files/d1f9d072c85428dc20d5813c9cecdcedd593284573474353487598f60d9804/secondpackage-1.0.0-py3-none-any.whl#sha256=d1f9d072c85428dc20d5813c4285782457837502540d4ac3b18033c8f60d9804
TRACE Sending fresh HEAD request for https://gitlab.company.com/api/v4/projects/6122/packages/pypi/files/d1f9d072c85428dc20d5813c9cecdcedd593284573474353487598f60d9804/secondpackage-1.0.0-py3-none-any.whl#sha256=d1f9d072c85428dc20d5813c4285782457837502540d4ac3b18033c8f60d9804
TRACE Handling request for https://gitlab.company.com/api/v4/projects/6122/packages/pypi/files/d1f9d072c85428dc20d5813c9cecdcedd593284573474353487598f60d9804/secondpackage-1.0.0-py3-none-any.whl#sha256=d1f9d072c85428dc20d5813c4285782457837502540d4ac3b18033c8f60d9804
TRACE Request for https://gitlab.company.com/api/v4/projects/6122/packages/pypi/files/d1f9d072c85428dc20d5813c9cecdcedd593284573474353487598f60d9804/secondpackage-1.0.0-py3-none-any.whl#sha256=d1f9d072c85428dc20d5813c4285782457837502540d4ac3b18033c8f60d9804 is unauthenticated, checking cache
TRACE No credentials in cache for URL https://gitlab.company.com/api/v4/projects/6122/packages/pypi/files/d1f9d072c85428dc20d5813c9cecdcedd593284573474353487598f60d9804/secondpackage-1.0.0-py3-none-any.whl#sha256=d1f9d072c85428dc20d5813c4285782457837502540d4ac3b18033c8f60d9804
TRACE Attempting unauthenticated request for https://gitlab.company.com/api/v4/projects/6122/packages/pypi/files/d1f9d072c85428dc20d5813c9cecdcedd593284573474353487598f60d9804/secondpackage-1.0.0-py3-none-any.whl#sha256=d1f9d072c85428dc20d5813c4285782457837502540d4ac3b18033c8f60d9804
TRACE cached request https://gitlab.mycompany.com/api/v4/projects/2177/packages/pypi/simple/firstpackage/ is storable because this is a shared cache and its response has a 'private' cache-control directive
TRACE Received package metadata for: firstpackage
TRACE Request for https://gitlab.company.com/api/v4/projects/6122/packages/pypi/files/d1f9d072c85428dc20d5813c9cecdcedd593284573474353487598f60d9804/secondpackage-1.0.0-py3-none-any.whl#sha256=d1f9d072c85428dc20d5813c4285782457837502540d4ac3b18033c8f60d9804 failed with 401 Unauthorized, checking for credentials
TRACE Found cached credentials for realm https://gitlab.mycompany.com
TRACE Retrying request for https://gitlab.company.com/api/v4/projects/6122/packages/pypi/files/d1f9d072c85428dc20d5813c9cecdcedd593284573474353487598f60d9804/secondpackage-1.0.0-py3-none-any.whl#sha256=d1f9d072c85428dc20d5813c4285782457837502540d4ac3b18033c8f60d9804 with credentials from cache Credentials { username: Username(Some(&quot;firstindex-token&quot;)), password: Some(&quot;[MASKED]&quot;) }
WARN Range requests not supported for secondpackage-1.0.0-py3-none-any.whl; streaming wheel
TRACE No cache entry exists for /root/.cache/uv/wheels-v2/index/70a791461bf74635/secondpackage/secondpackage-1.0.0-py3-none-any.msgpack
DEBUG No cache entry for: https://gitlab.company.com/api/v4/projects/6122/packages/pypi/files/d1f9d072c85428dc20d5813c9cecdcedd593284573474353487598f60d9804/secondpackage-1.0.0-py3-none-any.whl#sha256=d1f9d072c85428dc20d5813c4285782457837502540d4ac3b18033c8f60d9804
TRACE Sending fresh GET request for https://gitlab.company.com/api/v4/projects/6122/packages/pypi/files/d1f9d072c85428dc20d5813c9cecdcedd593284573474353487598f60d9804/secondpackage-1.0.0-py3-none-any.whl#sha256=d1f9d072c85428dc20d5813c4285782457837502540d4ac3b18033c8f60d9804
TRACE Handling request for https://gitlab.company.com/api/v4/projects/6122/packages/pypi/files/d1f9d072c85428dc20d5813c9cecdcedd593284573474353487598f60d9804/secondpackage-1.0.0-py3-none-any.whl#sha256=d1f9d072c85428dc20d5813c4285782457837502540d4ac3b18033c8f60d9804
TRACE Request for https://gitlab.company.com/api/v4/projects/6122/packages/pypi/files/d1f9d072c85428dc20d5813c9cecdcedd593284573474353487598f60d9804/secondpackage-1.0.0-py3-none-any.whl#sha256=d1f9d072c85428dc20d5813c4285782457837502540d4ac3b18033c8f60d9804 is unauthenticated, checking cache
TRACE No credentials in cache for URL https://gitlab.company.com/api/v4/projects/6122/packages/pypi/files/d1f9d072c85428dc20d5813c9cecdcedd593284573474353487598f60d9804/secondpackage-1.0.0-py3-none-any.whl#sha256=d1f9d072c85428dc20d5813c4285782457837502540d4ac3b18033c8f60d9804
TRACE Attempting unauthenticated request for https://gitlab.company.com/api/v4/projects/6122/packages/pypi/files/d1f9d072c85428dc20d5813c9cecdcedd593284573474353487598f60d9804/secondpackage-1.0.0-py3-none-any.whl#sha256=d1f9d072c85428dc20d5813c4285782457837502540d4ac3b18033c8f60d9804
TRACE Request for https://gitlab.company.com/api/v4/projects/6122/packages/pypi/files/d1f9d072c85428dc20d5813c9cecdcedd593284573474353487598f60d9804/secondpackage-1.0.0-py3-none-any.whl#sha256=d1f9d072c85428dc20d5813c4285782457837502540d4ac3b18033c8f60d9804 failed with 401 Unauthorized, checking for credentials
TRACE Found cached credentials for realm https://gitlab.mycompany.com
TRACE Retrying request for https://gitlab.company.com/api/v4/projects/6122/packages/pypi/files/d1f9d072c85428dc20d5813c9cecdcedd593284573474353487598f60d9804/secondpackage-1.0.0-py3-none-any.whl#sha256=d1f9d072c85428dc20d5813c4285782457837502540d4ac3b18033c8f60d9804 with credentials from cache Credentials { username: Username(Some(&quot;firstindex-token&quot;)), password: Some(&quot;[MASKED]&quot;) }
error: Failed to download `secondpackage==1.0.0`
  Caused by: HTTP status client error (404 Not Found) for url (https://gitlab.company.com/api/v4/projects/6122/packages/pypi/files/d1f9d072c85428dc20d5813c9cecdcedd593284573474353487598f60d9804/secondpackage-1.0.0-py3-none-any.whl#sha256=d1f9d072c85428dc20d5813c4285782457837502540d4ac3b18033c8f60d9804)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-25 14:20</div>
            <div class="timeline-body"><p>So you can see a log</p>
<pre><code>No credentials in cache for URL https://gitlab.company.com/api/v4/projects/6122/packages/pypi/files/d1f9d072c85428dc20d5813c9cecdcedd593284573474353487598f60d9804/secondpackage-1.0.0-py3-none-any.whl#sha256=d1f9d072c85428dc20d5813c4285782457837502540d4ac3b18033c8f60d9804
</code></pre>
<p>The problem is that the package URL is not a subset of the index URL <code>https://gitlab.mycompany.com/api/v4/projects/6122/packages/pypi/simple</code> so we fall back to the realm cache which contains the credentials for your other index.</p>
<p>The authentication middleware requires a strict URL prefix match to use URL-level credentials. This is important for cases like GitHub repositories where  <code>https://github.com/astral-sh/uv</code> and <code>https://github.com/astral-sh/ruff</code> need different credentials. The solution here is to special case credential handling for index URLs #4583 in the URL cache to allow credentials for <code>https://gitlab.mycompany.com/api/v4/projects/6122/packages/pypi/simple</code> to be used for <code>https://gitlab.company.com/api/v4/projects/6122/packages/pypi/files/...</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-10-25 14:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hbeukers">@hbeukers</a> on 2024-10-25 15:05</div>
            <div class="timeline-body"><p>Thank you for the fast responses. Then we'll wait for #4583 to be implemented and, in the meantime, use a token that authorizes for both indexes at once.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/9741.html">astral-sh/uv#9741</a> on 2024-12-09 22:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/11074.html">astral-sh/uv#11074</a> on 2025-01-29 20:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-01-30 16:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-01-30 16:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/11244.html">astral-sh/uv#11244</a> on 2025-02-05 15:15</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:23 UTC
    </footer>
</body>
</html>
