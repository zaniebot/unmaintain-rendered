```yaml
number: 14665
title: "Unexpected behavior with `--index-strategy first-index` and missing package in primary index"
type: issue
state: closed
author: leoschleier
labels:
  - bug
assignees: []
created_at: 2025-07-16T16:18:05Z
updated_at: 2025-07-16T19:13:13Z
url: https://github.com/astral-sh/uv/issues/14665
synced_at: 2026-01-10T01:57:33Z
```

# Unexpected behavior with `--index-strategy first-index` and missing package in primary index

---

_Issue opened by @leoschleier on 2025-07-16 16:18_

### Summary

Hi everyone,

Thank you for your work on this project! I love `uv` and appreciate the work that is going into this project.

I have encountered a behavior that seemed unexpected, and I would be grateful for some clarification. Also, I was not able to find a related issue and hope that I have not missed anything.

## Scenario

I have two indexes ("primary" and "secondary") specified.

In `test-project` I try to add `my-package` as a dependency. This package is only contained in index "secondary". Index "primary" does not contain any version of this package.

The documentation says:

> first-index (default): Search for each package across all indexes, limiting the candidate versions to those present in the first index that contains the package.

From this, I would expect that the package is installed from the secondary index since this is "the first index that contains the package".

## Settings

The settings in `pyproject.toml` are as follows:

```toml
[project]
name = "test-project"
version = "0.1.0"
requires-python = "==3.13.*"
dependencies = []

[[tool.uv.index]]
name = "primary"
url = "https://my-registry.com/path/to/index"

[[tool.uv.index]]
name = "secondary"
url = "https://my-other-registry.com/path/to/index"
default = true
```

## Command

```powershell
uv add my-package -v
```

Output:

```powershell
PS C:\Users\my-user\Workspace\test-project> uv add my-package -v
DEBUG uv 0.7.21 (77c771c7f 2025-07-14)
DEBUG Found project root: `C:\Users\my-user\Workspace\test-project`
DEBUG No workspace root found, using project root
DEBUG Acquired lock for `C:\Users\my-user\Workspace\test-project`
DEBUG No Python version file found in workspace: C:\Users\my-user\Workspace\test-project
DEBUG Using Python request `==3.13.*` from `requires-python` metadata
DEBUG Checking for Python environment at `.venv`
DEBUG The project environment's Python version satisfies the request: `Python ==3.13.*`
DEBUG Released lock at `C:\Users\my-user\AppData\Local\Temp\uv-ad1b05f90942fef3.lock`
DEBUG Acquired lock for `.venv`
DEBUG Using request timeout of 30s
DEBUG Found static `pyproject.toml` for: test-project @ file:///C:/Users/my-user/Workspace/test-project
DEBUG No workspace root found, using project root
DEBUG Ignoring existing lockfile due to mismatched requirements for: `test-project==0.1.0`
  Requested: {Requirement { name: PackageName("my-package"), extras: [], groups: [], marker: true, source: Registry { specifier: VersionSpecifiers([]), index: None, conflict: None }, origin: None }}
  Existing: {}
DEBUG Solving with installed Python version: 3.13.2
DEBUG Solving with target Python version: ==3.13.*
DEBUG Adding direct dependency: test-project*
DEBUG Adding direct dependency: test-project:dev*
DEBUG Searching for a compatible version of test-project @ file:///C:/Users/my-user/Workspace/test-project (*)
DEBUG Adding direct dependency: my-package*
DEBUG Searching for a compatible version of test-project @ file:///C:/Users/my-user/Workspace/test-project (*)
DEBUG Adding direct dependency: test-project:dev==0.1.0
DEBUG Acquired lock for `C:\Users\my-user\AppData\Local\uv\cache\simple-v16\index\38748d71f414d183\my-package.lock`
DEBUG Searching for a compatible version of test-project @ file:///C:/Users/my-user/Workspace/test-project (==0.1.0)
DEBUG No cache entry for: https://my-registry.com/path/to/index
DEBUG Released lock at `C:\Users\my-user\AppData\Local\uv\cache\simple-v16\index\38748d71f414d183\my-package.lock`
DEBUG Indexes search failed because of status code failure: 403 Forbidden
DEBUG Searching for a compatible version of my-package (*)
DEBUG No compatible version found for: my-package
DEBUG Recording unit propagation conflict of my-package from incompatibility of (test-project)
DEBUG Searching for a compatible version of test-project @ file:///C:/Users/my-user/Workspace/test-project (<0.1.0 | >0.1.0)
DEBUG No compatible version found for: test-project
DEBUG Reverting changes to `pyproject.toml`
DEBUG Reverting changes to `uv.lock`
  × No solution found when resolving dependencies:
  ╰─▶ Because my-package was not found in the package registry and your project depends on my-package, we can conclude that your project's requirements are
      unsatisfiable.

      hint: An index URL (https://my-registry.com/path/to/index) could not be queried due to a lack of valid authentication credentials (403
      Forbidden).
  help: If you want to add the package regardless of the failed resolution, provide the `--frozen` flag to skip locking and syncing.
DEBUG Released lock at `C:\Users\my-user\Workspace\test-project\.venv\.lock`
```

## Additional Observations

Despite this error, the dependency can still be added using the "unsafe" index strategies. That is,

```powershell
uv add my-package --index-strategy unsafe-first-match
```

and

```powershell
uv add my-package --index-strategy unsafe-best-match
```

will succeed in adding the dependency and installing the package.

Although the output reports an authentication error with the primary index, adding other existing packages from this index does not cause any problems.

Could you kindly clarify whether the observed behavior is intended? If so, it appears that this specific case may not be fully covered in the documentation.


### Platform

Windows 11 x86_64

### Version

uv 0.7.21 (77c771c7f 2025-07-14)

### Python version

Python 3.13.2

---

_Label `bug` added by @leoschleier on 2025-07-16 16:18_

---

_Comment by @charliermarsh on 2025-07-16 18:04_

Can you try setting the option described here? Specifically, `ignore-error-codes = [403]` https://docs.astral.sh/uv/concepts/indexes/#ignoring-error-codes-when-searching-across-indexes

---

_Comment by @leoschleier on 2025-07-16 19:13_

Ah, I completely missed that section. Turns out the answer was right there all along! Thanks for pointing me in the right direction, and for your help. Much appreciated!


---

_Closed by @leoschleier on 2025-07-16 19:13_

---
