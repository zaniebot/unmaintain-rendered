```yaml
number: 6169
title: "uv ignores `python_version` marker when conjoined with platform markers"
type: issue
state: closed
author: edgarrmondragon
labels:
  - bug
assignees: []
created_at: 2024-08-17T16:02:37Z
updated_at: 2024-08-17T19:53:56Z
url: https://github.com/astral-sh/uv/issues/6169
synced_at: 2026-01-10T04:53:49Z
```

# uv ignores `python_version` marker when conjoined with platform markers

---

_Issue opened by @edgarrmondragon on 2024-08-17 16:02_

<!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

For example, SQLAlchemy 2.0.32 has a dependency on greenlet, marked for certain platforms and only for Python < 3.13[^1]:

```
greenlet != 0.4.17;(python_version<"3.13" and (platform_machine=='aarch64' or (platform_machine=='ppc64le' or (platform_machine=='x86_64' or (platform_machine=='amd64' or (platform_machine=='AMD64' or (platform_machine=='win32' or platform_machine=='WIN32')))))))
```

Now, something changed in uv 0.2.37 that the `python_version` marker is ignored. For example:

```
# requirements.txt
sqlalchemy==2.0.32
```

With uv 0.2.36

```console
$ UV_NO_CACHE=1 uv@0.2.36 pip compile --python python3.13 --python-platform x86_64-manylinux_2_31 requirements.txt
Resolved 2 packages in 1.16s
# This file was autogenerated by uv via the following command:
#    uv pip compile --python python3.13 --python-platform x86_64-manylinux_2_31 requirements.txt
sqlalchemy==2.0.32
    # via -r requirements.txt
typing-extensions==4.12.2
    # via sqlalchemy
```

but with uv 0.2.37

```console
$ UV_NO_CACHE=1 uv@0.2.37 pip compile --python python3.13 --python-platform x86_64-manylinux_2_31 requirements.txt
Resolved 3 packages in 1.16s
# This file was autogenerated by uv via the following command:
#    uv pip compile --python python3.13 --python-platform x86_64-manylinux_2_31 requirements.txt
greenlet==3.0.3
    # via sqlalchemy
sqlalchemy==2.0.32
    # via -r requirements.txt
typing-extensions==4.12.2
    # via sqlalchemy
```

When the platform is not one of those in the markers, the dependency is correctly excluded:

```console
$ UV_NO_CACHE=1 uv@0.2.37 pip compile --python python3.13 --python-platform aarch64-apple-darwin requirements.txt
Resolved 2 packages in 1.17s
# This file was autogenerated by uv via the following command:
#    uv pip compile --python python3.13 --python-platform aarch64-apple-darwin requirements.txt
sqlalchemy==2.0.32
    # via -r requirements.txt
typing-extensions==4.12.2
    # via sqlalchemy
```

Maybe related:

- https://github.com/astral-sh/uv/issues/6168

[^1]: https://github.com/sqlalchemy/sqlalchemy/blob/62c242b78dee306738a2cd22f548679e9818a1ac/setup.cfg#L41



---

_Comment by @charliermarsh on 2024-08-17 16:10_

Interesting, thanks.

---

_Label `bug` added by @charliermarsh on 2024-08-17 16:10_

---

_Comment by @charliermarsh on 2024-08-17 16:13_

I’ll try to take a look at this today.

---

_Comment by @charliermarsh on 2024-08-17 16:45_

I have at least one idea of what’s going on here.

---

_Assigned to @charliermarsh by @charliermarsh on 2024-08-17 16:53_

---

_Comment by @charliermarsh on 2024-08-17 16:56_

Ah ok I see the issue.

---

_Comment by @charliermarsh on 2024-08-17 16:58_

(It's unique to 3.13, since only pre-releases are available, and it relates to a mishandling of pre-releases there. Will fix.)

---

_Closed by @charliermarsh on 2024-08-17 19:29_

---

_Closed by @charliermarsh on 2024-08-17 19:29_

---

_Comment by @edgarrmondragon on 2024-08-17 19:51_

Thanks @charliermarsh!

---

_Comment by @charliermarsh on 2024-08-17 19:53_

Thanks for reporting!

---
