<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>How to associate optional `override-dependencies` with a specific `optional-dependencies` - astral-sh/uv #11153</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>How to associate optional `override-dependencies` with a specific `optional-dependencies`</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/11153">#11153</a>
        opened by <a href="https://github.com/tlambert03">@tlambert03</a>
        on 2025-02-01 17:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/tlambert03">@tlambert03</a> on 2025-02-01 17:39</div>
            <div class="timeline-body"><h3>Question</h3>
<p>I'm aware that I can use <code>override-dependencies</code> to essentially block a transitive dependency.  For example,
if I depend on <code>'direct-dependency'</code> which depends on <code>'preferred-backend'</code>, even though it
has been tested on and supports an <code>'alternate-backend'</code> that I would like to be using</p>
<pre><code class="language-toml">[project]
dependencies = [
    &quot;direct-dependency&quot;,  # this package declares a dependency on &quot;preferred-backend&quot;
    &quot;alternate-backend&quot;
]

[tool.uv]
override-dependencies = [&quot;preferred-backend ;  sys_platform == 'never'&quot;]
</code></pre>
<p><strong>my question:</strong></p>
<p>can I override <code>preferred-backend</code> <em>only</em> when one of my <code>optional-dependencies</code> is included:</p>
<pre><code class="language-toml">[project]
dependencies = [
    &quot;direct-dependency&quot;  # this package declares a dependency on &quot;preferred-backend&quot;
]

[project.optional-dependencies]
variant = [&quot;alternate-backend&quot;]  # my extra

[tool.uv]
# how to override only when `--extra variant` is expressed
override-dependencies = [&quot;preferred-backend ;  sys_platform == 'never'&quot;]
</code></pre>
<pre><code class="language-sh">uv sync --extra variant  # -&gt; uninstall preferred-backend  and install alternate-backend 
</code></pre>
<h3>Platform</h3>
<p><em>No response</em></p>
<h3>Version</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @tlambert03 on 2025-02-01 17:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-01 17:53</div>
            <div class="timeline-body"><p>I was hoping something like this would work</p>
<pre><code class="language-toml">[project]
name = &quot;example&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = [&quot;anyio&quot;]

[project.optional-dependencies]
foo = []

[tool.uv]
override-dependencies = [&quot;sniffio ; (extra == 'foo' and sys_platform == 'never') or extra != 'foo'&quot;]
</code></pre>
<p>but I don't think we respect the <code>extra == ...</code> as it's normalized out in the lockfile</p>
<pre><code class="language-toml">[manifest]
overrides = [{ name = &quot;sniffio&quot;, marker = &quot;sys_platform == 'never' or extra != 'foo'&quot; }]

[[package]]
name = &quot;anyio&quot;
version = &quot;4.8.0&quot;
source = { registry = &quot;https://pypi.org/simple&quot; }
dependencies = [
    { name = &quot;idna&quot; },
    { name = &quot;sniffio&quot;, marker = &quot;sys_platform == 'never'&quot; },
    { name = &quot;typing-extensions&quot;, marker = &quot;python_full_version &lt; '3.13'&quot; },
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../stfc/janus-core/issues/420.html">stfc/janus-core#420</a> on 2025-02-14 16:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../ultralytics/ultralytics/pulls/17527.html">ultralytics/ultralytics#17527</a> on 2025-03-15 14:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tlambert03">@tlambert03</a> on 2025-05-05 14:48</div>
            <div class="timeline-body"><p>hey @zanieb, gentle ping: have any new clever approaches for allowing either an extra or a dependency group to override a dependency come up in the last few months?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/alexeldeib">@alexeldeib</a> on 2025-06-28 19:34</div>
            <div class="timeline-body"><p>I also find myself needing this.</p>
<p>I have a set of common dependencies, and some extras. jax is one of the common dependencies with different extras. other direct dependencies pull jax as a transitive dependency. to make matters worse, I have to build some of the extra/jax wheels myself, while some are directly available on pypi.</p>
<p>I need a version of my project that works with jax across all these variations, consumable by other downstream dependencies. I've been trying to split my core deps into multiple extras to deliver this.</p>
<p>I've tried combining <code>override-dependencies</code> with <code>never</code>, <code>optional-dependencies</code>, and <code>conflicts</code> in various forms to no avail. my issue is the common deps create a transitive dependency on the wrong wheel (pypi vs private, same package name, different index) for one of the extras, even when the extra specifies the index directly. I can use <code>override-dependencies</code> with <code>never</code> or e.g. <code>uv export --no-emit</code> to solve that, but then I still need to figure out another way for the extra to install the package. And similarly to your comment https://github.com/astral-sh/uv/issues/11153#issuecomment-2629046693 I can't use the extra or index markers in the override-dependencies block to fix it.</p>
<p>The best solution I have found is skip emitting those libraries, uv export into an environment where I manually pip installed the package, and then pip install the export on top of that.</p>
<p>Ideally I could use optional depedencies + per-extra override + per-extra sources to say, &quot;for this extra, this package should come from this index, and override the transitive dependency to use this version as well&quot;. I can't seem to find a way to do that and this issue seems like it would do the trick!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @zanieb on 2025-06-28 19:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @zanieb on 2025-06-28 19:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-design</span> added by @zanieb on 2025-06-28 19:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-06-28 19:37</div>
            <div class="timeline-body"><p>Thanks for sharing another use-case!</p>
<p>This sounds challenging to implement, so we'll need to take a deeper look here but I'm not sure when we'll have the resources to do so.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ARKAD97">@ARKAD97</a> on 2025-09-21 15:10</div>
            <div class="timeline-body"><p>One more use-case.</p>
<p><a href="https://github.com/axolotl-ai-cloud/axolotl">axolotl</a> dependencies vary based on the version of torch that is installed in the project environment. Solution proposed in the <a href="https://docs.astral.sh/uv/concepts/projects/config/#dynamic-metadata">documentation</a> is to specify <code>extra-build-dependencies</code>:</p>
<pre><code class="language-toml">[tool.uv.extra-build-dependencies]
axolotl = [&quot;torch==2.7.1&quot;]
</code></pre>
<p>However, it doesn't work when you want to support multiple CUDA /torch versions via optional-dependencies as <code>extra-build-dependencies</code> don't respect them too. The only axolotl dependencies of axolotl that vary are <code>xformers</code> and <code>vllm</code>. So I could just override them for each CUDA/torch version if only <code>override-dependencies</code> respected optional dependencies.</p>
<p>One solution is to provide metadata for axolotl upfront as proposed in the <a href="https://docs.astral.sh/uv/concepts/resolution/#dependency-metadata">documentation</a>. But I'll have to list all dependencies and it's quite messy.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-09-21 15:12</div>
            <div class="timeline-body"><p>I'm not sure I understand the details there, but it sounds like you want <code>match-runtime = true</code> instead of pinning the torch version? See https://docs.astral.sh/uv/concepts/projects/config/#augmenting-build-dependencies</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:02 UTC
    </footer>
</body>
</html>
