```yaml
number: 14886
title: uv installs pypy version into cpython venv
type: issue
state: open
author: tekumara
labels:
  - question
assignees: []
created_at: 2025-07-25T10:15:28Z
updated_at: 2025-07-27T03:50:42Z
url: https://github.com/astral-sh/uv/issues/14886
synced_at: 2026-01-10T01:57:33Z
```

# uv installs pypy version into cpython venv

---

_Issue opened by @tekumara on 2025-07-25 10:15_

### Summary

The following results in `urllib3==1.26.20` being installed when I expect `urllib3==2.5.0`:

```
❯ uv init
Initialized project `uvbug`
❯ uv add vcrpy
Using CPython 3.12.3
Creating virtual environment at: .venv
Resolved 10 packages in 468ms
Prepared 3 packages in 79ms
Installed 8 packages in 13ms
 + idna==3.10
 + multidict==6.6.3
 + propcache==0.3.2
 + pyyaml==6.0.2
 + urllib3==2.5.0
 + vcrpy==7.0.0
 + wrapt==1.17.2
 + yarl==1.20.1
❯ uv add google-cloud-dlp
Resolved 25 packages in 340ms
Prepared 2 packages in 1.67s
Installed 15 packages in 45ms
 + cachetools==5.5.2
 + certifi==2025.7.14
 + charset-normalizer==3.4.2
 + google-api-core==2.25.1
 + google-auth==2.40.3
 + google-cloud-dlp==3.31.0
 + googleapis-common-protos==1.70.0
 + grpcio==1.74.0
 + grpcio-status==1.74.0
 + proto-plus==1.26.1
 + protobuf==6.31.1
 + pyasn1==0.6.1
 + pyasn1-modules==0.4.2
 + requests==2.32.4
 + rsa==4.9.1
❯ rm uv.lock
❯ uv sync
Resolved 24 packages in 9ms
Uninstalled 1 package in 5ms
Installed 1 package in 5ms
 - urllib3==2.5.0
 + urllib3==1.26.20
```

vcrpy resolves to [urllib<2 for pypy](https://github.com/kevin1024/vcrpy/blob/19bd4e012c8fd6970fd7f2af3cc60aed1e5f1ab5/setup.py#L39-L41)  because of the following marker:

```
"urllib3 <2; platform_python_implementation =='PyPy'"
```

But I'm using a Cython implementation, so I was expecting urllib>=2. There is some interaction between vcrpy and google-cloud-dlp because this doesn't happen with vcrpy alone.


Side note:

The lock file generated by subsequent `uv add`s differs from what I get if I remove the lock file and `uv sync` (see above) - is this to be expected? 




### Platform

macos

### Version

uv 0.8.3 (Homebrew 2025-07-24)

### Python version

python 3.12.3

---

_Label `bug` added by @tekumara on 2025-07-25 10:15_

---

_Comment by @tekumara on 2025-07-25 10:17_

As a workaround for now, I've asked uv not to resolve a pypy environment:

```
[tool.uv]
environments = [
    "platform_python_implementation != 'PyPy'"
]
```

which gets me  `urllib3==2.5.0` when I `uv sync` from a clean slate (ie: without a uv.lock file or .venv).

---

_Comment by @zanieb on 2025-07-25 22:52_

uv's resolution is implementation agnostic by default, so this behavior is expected and your fix seems appropriate — the resolver is just preferring coherent versions across Python implementations. You could add a `urllib>=2; platform_python_implementation != 'PyPy'"` constraint the resolver would select separate versions for CPython and PyPy.

---

_Label `bug` removed by @zanieb on 2025-07-25 22:54_

---

_Label `question` added by @zanieb on 2025-07-25 22:54_

---

_Comment by @tekumara on 2025-07-26 12:42_

Thanks for the response! I think I'm missing something because given the following [taken from vcrpy](https://github.com/kevin1024/vcrpy/blob/19bd4e012c8fd6970fd7f2af3cc60aed1e5f1ab5/setup.py#L39-L44):
```
[project]
name = "foo"
version = "0.1.0"
description = "Add your description here"
readme = "README.md"
requires-python = ">=3.12"
dependencies = [
    "urllib3 <2; python_version <'3.10'",
    # https://github.com/kevin1024/vcrpy/pull/775#issuecomment-1847849962
    "urllib3 <2; platform_python_implementation =='PyPy'",
    # Workaround for Poetry with CPython >= 3.10, problem description at:
    # https://github.com/kevin1024/vcrpy/pull/826
    "urllib3; platform_python_implementation !='PyPy' and python_version >='3.10'",
]
```

When I run `uv sync` within CPython 3.12.3, then I end up with `urllib==2.5.0` (as I expect) and not a PyPy compatible version < 2 as above. Why does the outcome differ here from the above case?




---

_Comment by @zanieb on 2025-07-26 13:20_

I'm not sure off the top of my head, but we might be forking based on your first-party markers in a way we won't do for a third-party package?

The resolver is pretty complicated, it'd take a lot of investigation to explain why it takes a particular path in an edge case like this. 

---

_Comment by @tekumara on 2025-07-27 03:50_

Ah, so I've compared the forking. 

The `foo` pyproject.toml above generates these splits in the top-level of uv.lock:
```
resolution-markers = [
    "platform_python_implementation != 'PyPy'",
    "platform_python_implementation == 'PyPy'",
]
```

Whereas in the original case (ie: `uv add vcrpy google-cloud-dlp`) I have top-level splits for:

```
resolution-markers = [
    "python_full_version >= '3.13' and platform_python_implementation == 'PyPy'",
    "python_full_version >= '3.13' and platform_python_implementation != 'PyPy'",
    "python_full_version < '3.13' and platform_python_implementation != 'PyPy'",
    "python_full_version < '3.13' and platform_python_implementation == 'PyPy'",
]
```

I see the [3.13 split is being introduced by google-api-core](https://github.com/googleapis/python-api-core/blob/2c983853e930d1ad4a3ece6b6b55a6dc72206a17/pyproject.toml#L50) (a dependency of google-cloud-dlp).

So I suspect the combination of splits is causing the instability in resolution, and difference in outcome, ie:
1. `uv add vcrpy && uv add google-cloud-dlp` has urllib 2.5.0 and urllib 1.26.20 in the lock file with the relevant resolution makers
2. `uv add vcrpy google-cloud-dlp` has only urllib 1.26.20 (with no resolution markers).


---
