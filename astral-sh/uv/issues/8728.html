<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>When tool.uv.index.url contains a username, it can't be overridden in UV_INDEX - astral-sh/uv #8728</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>When tool.uv.index.url contains a username, it can't be overridden in UV_INDEX</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/8728">#8728</a>
        opened by <a href="https://github.com/torarvid">@torarvid</a>
        on 2024-10-31 15:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/torarvid">@torarvid</a> on 2024-10-31 15:29</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

<p>Hello üëãüèª</p>
<p><code>uv 0.4.28</code></p>
<p>We have an issue where our pyproject.toml has the equivalent of:</p>
<pre><code class="language-toml">[project]
name = &quot;foo&quot;
version = &quot;0.0.1&quot;
description = &quot;desc&quot;
authors = [{ name = &quot;Me&quot;, email = &quot;me@example.com&quot; }]
license = { text = &quot;UNLICENSED&quot; }
requires-python = &quot;&gt;=3.12.6, &lt;3.13&quot;
dependencies = [
    &quot;priv_package==0.3.8&quot;,
]

[tool.uv]
dev-dependencies = [
    &quot;mypy&gt;=1.12.0,&lt;1.13.0&quot;,
]
package = true

[tool.uv.sources]
priv_package = { index = &quot;priv&quot; }

[[tool.uv.index]]
name = &quot;priv&quot;
url = &quot;https://oauth2accesstoken@europe-python.pkg.dev/foo/python/simple&quot;
explicit = true
</code></pre>
<p>So a private package on GCP artifact registry and a public package (the public package might not matter for the bug).</p>
<p>By having the <code>oauth2accesstoken</code> as a username in the private package url, all human users in the company are able to export <code>UV_KEYRING_PROVIDER=subprocess</code> and use <code>keyring</code> (with <code>keyring-gcloud</code>) to hav <code>uv</code> fetch-and-refresh their gcloud access tokens automatically use it for authentication. Perfect so far üëçüèº</p>
<p>However, in Github we use <a href="https://www.mend.io/renovate/">Renovate</a> to bump our dependencies, and for that to work, we have this in our renovate config:</p>
<pre><code class="language-json5">{
  description: &quot;Preset to fetch deps from Google Artifact Registry&quot;,
  hostRules: [
    {
      description: &quot;Authenticate to GCP Artifact Registry&quot;,
      matchHost: &quot;europe-python.pkg.dev&quot;,
      username: &quot;_json_key_base64&quot;,
      password: &quot;{{ secrets.OUR_ARTIFACT_REGISTRY_JSON_KEY }}&quot;,
    }
}
</code></pre>
<p>So Renovate needs a long-lived secret for authentication to be practical, but the company prefers that employees use a less-important secret (a google access token in our case).</p>
<p>This used to work with Renovate+uv a while ago, but it stopped working some time in the past 5‚Äì7 days. I'm not really sure how the public Renovate bot chooses the version of <code>uv</code> that they run, so I can't say on what version this started failing for us.</p>
<p>I can repro locally by ensuring the only <code>UV_&lt;...&gt;</code> env var is <code>UV_INDEX=https://_json_key_base64:$PASSWORD@europe-python.pkg.dev/foo/python/simple</code>, and then do <code>rm -rf .venv &amp;&amp; uv sync --no-cache</code> (not sure if the <code>--no-cache</code> is needed). I can also work around the issue by changing <code>oauth2accesstoken</code> to <code>_json_key_base64</code> in pyproject.toml.</p>
<p>I'm not sure what I want the solution to be ‚Äî not even sure this is a bug (maybe I can improve my configuration to avoid this being a problem?). But perhaps it could be an idea that if I have a url in pyproject.toml of the <code>https://alice@domain.tld</code> format and there is a <code>UV_INDEX=https://bob:pwd@domain.tld</code>, then the <code>bob</code> user should &quot;step in&quot; for <code>alice</code> since env vars usually are prioritized over config files (?)</p>
<p>Happy to hear your thoughts. Thanks for an otherwise excellent tool!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-31 17:08</div>
            <div class="timeline-body"><p>Does anything change if you instead do: <code>UV_INDEX=priv=https://_json_key_base64:$PASSWORD@europe-python.pkg.dev/foo/python/simple</code>? I.e., add <code>priv=</code> before the URL</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2024-10-31 17:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/torarvid">@torarvid</a> on 2024-10-31 19:47</div>
            <div class="timeline-body"><p>@charliermarsh Just tried now, ~but sadly, it does not change anything.~</p>
<p>‚òùüèª Whoops, it turns out I confused myself when trying this out, since I actually exported <code>UV_INDEX_PRIV_PACKAGE_USERNAME</code> and <code>_PASSWORD</code> (so I fell into the danger of substituting my &quot;real&quot; index+package names with &quot;priv&quot; and &quot;priv-package&quot;).</p>
<p>So when trying it again, this tip <strong>also</strong> works.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-31 19:50</div>
            <div class="timeline-body"><p>Oh sorry -- what about this?</p>
<pre><code>export UV_INDEX_PRIV_USERNAME= _json_key_base64
export UV_INDEX_PRIV_PASSWORD={{ PASSWORD }}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/torarvid">@torarvid</a> on 2024-10-31 20:03</div>
            <div class="timeline-body"><p>Yes! Thank you, that worked üéâ</p>
<p>Ok, so I think that means that our easiest path forward is to <strong>not</strong> put the <code>oauth2accesstoken@</code> prefix into our pyproject.toml (that would make Renovate start working again, I now presume), and then I guess employees would just export <code>UV_INDEX_PRIV_USERNAME=oauth2accesstoken</code>.</p>
<p>Thanks, feel free to close this issue if that feels right to you üëçüèº</p>
<p>(PS: I updated my previous comment since your previous tip also did work on my second try üôà)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-31 20:08</div>
            <div class="timeline-body"><p>Oh perfect, ok! I'm gonna close out then. Glad I could help.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-10-31 20:08</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:31:21 UTC
    </footer>
</body>
</html>
