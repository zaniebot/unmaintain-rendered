<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv publish` doesn't respect the `--allow-insecure-host` flag - astral-sh/uv #8423</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`uv publish` doesn't respect the `--allow-insecure-host` flag</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/8423">#8423</a>
        opened by <a href="https://github.com/oriori1703">@oriori1703</a>
        on 2024-10-21 18:31
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/oriori1703">@oriori1703</a> on 2024-10-21 18:31</div>
            <div class="timeline-body"><p>It seems like <code>uv publish</code> doesn't respect the <code>--allow-insecure-host</code> flag</p>
<h2>steps to reproduce</h2>
<h3>uv command</h3>
<pre><code class="language-shell">uv publish --publish-url https://localhost --allow-insecure-host &quot;localhost&quot; --verbose --username=&quot;test&quot; --password=&quot;test&quot;
</code></pre>
<p>output:</p>
<pre><code>DEBUG uv 0.4.25
warning: `uv publish` is experimental and may change without warning
Publishing 2 files https://localhost/
DEBUG Using request timeout of 900s
Uploading sigmatcher-1.3.1-py3-none-any.whl (14.1KiB)
DEBUG Using username/password basic auth
DEBUG Transient request failure for https://localhost/, retrying: error sending request for url (https://localhost/)
  Caused by: client error (Connect)
  Caused by: invalid peer certificate: UnknownIssuer
warning: Transient request failure for https://localhost/, retrying
DEBUG Using username/password basic auth
DEBUG Transient request failure for https://localhost/, retrying: error sending request for url (https://localhost/)
  Caused by: client error (Connect)
  Caused by: invalid peer certificate: UnknownIssuer
warning: Transient request failure for https://localhost/, retrying
DEBUG Using username/password basic auth
error: Failed to publish `dist/sigmatcher-1.3.1-py3-none-any.whl` to https://localhost/
  Caused by: Failed to send POST request
  Caused by: error sending request for url (https://localhost/)
  Caused by: client error (Connect)
  Caused by: invalid peer certificate: UnknownIssuer
</code></pre>
<h3>mock server</h3>
<p>I used the following steps to create a mock https server with self signed certs that can reproduce the issue.</p>
<ol>
<li>generate the cert using:</li>
</ol>
<pre><code class="language-sh">openssl genrsa  -out server.key 2048
openssl req -new -key server.key -out server.csr -subj &quot;/CN=localhost&quot;
openssl x509 -req -days 1024 -in server.csr -signkey server.key -out server.crt
cat server.crt server.key &gt; server.pem
</code></pre>
<ol start="2">
<li>run this python script:</li>
</ol>
<pre><code class="language-python">from http.server import HTTPServer, BaseHTTPRequestHandler
import ssl


httpd = HTTPServer(('localhost', 443), BaseHTTPRequestHandler)

context = ssl.SSLContext(ssl.PROTOCOL_TLS_SERVER)
context.load_cert_chain('server.pem', 'server.key')

httpd.socket = context.wrap_socket(httpd.socket, server_side=True)

httpd.serve_forever()
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/j178">@j178</a> on 2024-10-22 07:18</div>
            <div class="timeline-body"><p>Seems related to #6985</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oriori1703">@oriori1703</a> on 2024-10-22 08:47</div>
            <div class="timeline-body"><blockquote>
<p>Seems related to #6985</p>
</blockquote>
<p>Are you sure? <code>uv python install</code> doesn't accept <code>--allow-insecure-host</code> at all, while <code>uv publish</code> does accept and uses it (but doesn't work).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @konstin on 2024-10-22 09:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @konstin by @konstin on 2024-10-22 09:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">great writeup</span> added by @konstin on 2024-10-22 09:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/8440.html">astral-sh/uv#8440</a> on 2024-10-22 09:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-10-22 09:27</div>
            <div class="timeline-body"><p>Thank you for the great reproducer!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2024-10-22 11:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oriori1703">@oriori1703</a> on 2024-10-22 15:43</div>
            <div class="timeline-body"><p>Thanks ðŸ˜Š</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/7839.html">astral-sh/uv#7839</a> on 2024-11-03 18:09</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:00 UTC
    </footer>
</body>
</html>
