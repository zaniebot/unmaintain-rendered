<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`tool.uv.index` supercedes default PyPI for package resolution - astral-sh/uv #12021</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>tool.uv.index</code> supercedes default PyPI for package resolution</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/12021">#12021</a>
        opened by <a href="https://github.com/daviles-gcs">@daviles-gcs</a>
        on 2025-03-06 21:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/daviles-gcs">@daviles-gcs</a> on 2025-03-06 21:18</div>
            <div class="timeline-body"><h3>Summary</h3>
<h3>Goal:</h3>
<p>Build package and publish to PyPi and Test PyPI</p>
<h3>Assumption (based on Docs):</h3>
<p>Adding an index to test-pypi will allow me to use <code>uv publish --index testpypi</code></p>
<pre><code class="language-py">[[tool.uv.index]]
name = &quot;testpypi&quot;
url = &quot;https://test.pypi.org/simple&quot;
publish-url = &quot;https://test.pypi.org/legacy/&quot;
default = false
</code></pre>
<p><code>uv publish</code>  with no <code>--index</code> will publish to PyPI</p>
<h3>Problem:</h3>
<p>Running other commands specific to package resolution after adding an index to <code>pyproject.toml</code> result in errors</p>
<h3>Example:</h3>
<p>Using <code>uv add pandas</code> results in:</p>
<p><img src="https://github.com/user-attachments/assets/71022829-4572-46a8-9574-9def432f9115" alt="Image" /></p>
<p>Changing the index to:</p>
<pre><code class="language-py">[[tool.uv.index]]
name = &quot;testpypi&quot;
url = &quot;https://example.pypi.org/simple&quot;
publish-url = &quot;https://test.pypi.org/legacy/&quot;
default = false
</code></pre>
<p>yields</p>
<p><img src="https://github.com/user-attachments/assets/266e1833-822f-4b56-8700-7742ec4b4966" alt="Image" /></p>
<p>This is confirmation that PyPI is no longer the default index to search for packages.</p>
<p><code>uv</code>, ideally, should default to PyPI for package resolution unless specified otherwise by an <code>--index</code> flag which would require a <code>tool.uv.index</code> in the <code>pyproject.toml</code> file</p>
<h3>Platform</h3>
<p>Windows 11</p>
<h3>Version</h3>
<p>0.6.4</p>
<h3>Python version</h3>
<p>3.12.7</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @daviles-gcs on 2025-03-06 21:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fellnerse">@fellnerse</a> on 2025-03-13 08:42</div>
            <div class="timeline-body"><p>I have the same issue! The docs are not reflecting the behavior of uv:
https://docs.astral.sh/uv/configuration/indexes/#defining-an-index</p>
<blockquote>
<p>Indexes are prioritized in the order in which they’re defined, such that the first index listed in the configuration file is the first index consulted when resolving dependencies, with indexes provided via the command line taking precedence over those in the configuration file.</p>
<p>By default, uv includes the Python Package Index (PyPI) as the &quot;default&quot; index, i.e., the index used when a package is not found on any other index. To exclude PyPI from the list of indexes, set default = true on another index entry (or use the --default-index command-line option):</p>
</blockquote>
<pre><code>[[tool.uv.index]]
name = &quot;pytorch&quot;
url = &quot;https://download.pytorch.org/whl/cpu&quot;
default = true
</code></pre>
<blockquote>
<p>The default index is always treated as lowest priority, regardless of its position in the list of indexes.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-14 00:51</div>
            <div class="timeline-body"><p>Ah, so I think this is working as intended. We query indexes in order, so in the above example, we query the <code>https://example.pypi.org/simple </code> first. When it fails, we throw an error. If it succeeded but returned a 404 (i.e., if the package didn't exist on the index), then we'd move on to the next index (in that case, PyPI, the default).</p>
<p>The reason you're seeing that failure with Test PyPI is that Pandas <em>does</em> exist on Test PyPI, so we stop looking. But it doesn't contain any <em>distributions</em> for Pandas. That's sort of a very-specific-weird-case where the package exists but doesn't have any versions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/daviles-gcs">@daviles-gcs</a> on 2025-03-14 00:59</div>
            <div class="timeline-body"><blockquote>
<p>Ah, so I think this is working as intended. We query indexes in order, so in the above example, we query the <code>https://example.pypi.org/simple </code> first. When it fails, we throw an error. If it succeeded but returned a 404 (i.e., if the package didn't exist on the index), then we'd move on to the next index (in that case, PyPI, the default).</p>
<p>The reason you're seeing that failure with Test PyPI is that Pandas <em>does</em> exist on Test PyPI, so we stop looking. But it doesn't contain any <em>distributions</em> for Pandas. That's sort of a very-specific-weird-case where the package exists but doesn't have any versions.</p>
</blockquote>
<p>Understood. I would question if the uv tool should always default to pypi so long as the <code>--index</code> flag is not used.</p>
<p>If the <code>--index</code> flag is used, it should use <code>tool.uv.index</code> according to its name.</p>
<p>Defaulting package resolution to your custom index just seem counter intuitive.</p>
<p>Almost always will package resolution come from PyPI, at least in my experience. There are a few scenarios that I want to pull a distribution from  Test PyPI but makes more sense to use an <code>--index</code> flag that would distinguish the separation between PyPI as the source as well as any other <em><strong>sources</strong></em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-14 01:04</div>
            <div class="timeline-body"><blockquote>
<p>Defaulting package resolution to your custom index just seem counter intuitive.</p>
</blockquote>
<p>I think this is very normal, unless I'm misunderstanding. If you have a custom index, and a package exists on both that index and PyPI, you almost certainly want to get it from your custom index. If it doesn't exist on your custom index, then you should get it from PyPI (which we do). I believe this all working as intended though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/daviles-gcs">@daviles-gcs</a> on 2025-03-14 01:24</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>Defaulting package resolution to your custom index just seem counter intuitive.</p>
</blockquote>
<p>I think this is very normal, unless I'm misunderstanding. If you have a custom index, and a package exists on both that index and PyPI, you almost certainly want to get it from your custom index. If it doesn't exist on your custom index, then you should get it from PyPI (which we do). I believe this all working as intended though.</p>
</blockquote>
<p>I appreciate the feedback!</p>
<p>My understanding is PyPI serves as the defacto standard for production ready distributions.</p>
<p>I will use my particular use case as an example.</p>
<p>I have a package I want to publish to both pypi for production and test-pypi for development purposes. I add tool.uv.index to be able to publish using an index name as opposed to having to use the full url in the CLI each time.</p>
<p>Publishing works well.</p>
<p>As time progresses and I realize I need a library to add, let's say Semver, when I run <code>uv add semver</code> and semver also happens to have a package on test-pypi but, perhaps outdated and with bugs. <code>uv</code> adds the packag,  and unbeknownst to me, it was added from the latest published version in test-pypi because that is the highest priority.</p>
<p>This will continue to happen so long as the package you want to add also has an existing package in test-pypi.</p>
<p>Which I believe could lead to unforseen issues using code not meant for production use.</p>
<p>A quick excerpt from Python packaging details</p>
<blockquote>
<p>TestPyPI is a separate instance of the Python Package Index (PyPI) that allows you to try out the distribution tools and process without worrying about affecting the real index. TestPyPI is hosted at test.pypi.org</p>
</blockquote>
<p>This would confirm that test-pypi is a testing ground and I would not want it to take precedence over PyPI.</p>
<p>This is one particular scenario, but any amount of custom indexes would fall under this issue.</p>
<p>This description, I believe, adds validity to what the default package resolution should be. Any other sources you want to use should be distinctively annotated through CLI flags, <code>--index</code> in particular.</p>
<p>Thank you in advance for your time and consideration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fellnerse">@fellnerse</a> on 2025-03-14 07:51</div>
            <div class="timeline-body"><p>@charliermarsh thanks for your quick answers, that clears up a bit on how the indexes are working. I didn't understood that from the documentation.
So let me repeat:
When I want to use pypi as <code>default</code> index in such a way, that it is <strong>always</strong> queried first, I would have to add it manually as index as well, like this:</p>
<pre><code class="language-toml">[[tool.uv.index]]
name = &quot;pypi&quot;
url = &quot;https://pypi.org/simple/&quot;
default = true
</code></pre>
<p>Then in any case a package is not found, uv will try to use the next index in line to query a package.</p>
<p>My understanding from the docs was that this is the <strong>default</strong> behavior, but I guess I got confused from that sentence:</p>
<blockquote>
<p>The default index is always treated as lowest priority, regardless of its position in the list of indexes.</p>
</blockquote>
<p>I thought that was meant in regards to lowest index priority..</p>
<p>As our <code>secondary</code> index automatically mirrors automatically dependencies from pypi, this lead to undesired behavior. But I suppose, this is again one of those <code>edge cases</code>. Maybe a bit more info in the docs would have helped in my case.</p>
<p>In any case, awesome tool, I love using UV! ❤️</p>
<p>@daviles-gcs I believe you can solve this issue by adding <code>explicit = True</code> to your test index. Then only the packages that you <strong>really</strong> want to add from the test repo are pulled from there. I think in our case it's the same, using the <code>explicit</code> keyword solves it, and uv uses the <code>default</code> pypi index first.</p>
<p>I think I found a open MR yesterday, adding this <code>explicit</code> keyword to some examples with the pypi test index even..
Edit:
found it: https://github.com/astral-sh/uv/pull/12148</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/daviles-gcs">@daviles-gcs</a> on 2025-03-14 12:19</div>
            <div class="timeline-body"><p>@fellnerse @charliermarsh</p>
<p>Thank you both for your time and collaboration on this topic.</p>
<p>I confirm <code>explicit = true</code> solves my concern. This flag makes the tool much more flexible which I prefer over my original solution.</p>
<p>Having this flag allows us to add any index and we can include or exclude it from the package resolution hierarchy. Incredible!</p>
<p><code>uv</code> has been a gamechanger :heart:</p>
<p>Thank you again!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @daviles-gcs on 2025-03-14 12:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-14 12:29</div>
            <div class="timeline-body"><p>Thanks for following up!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:30:57 UTC
    </footer>
</body>
</html>
