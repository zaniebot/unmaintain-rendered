<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reconsider priority of CONDA_PREFIX when discovering virtual environments - astral-sh/uv #8940</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Reconsider priority of CONDA_PREFIX when discovering virtual environments</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/8940">#8940</a>
        opened by <a href="https://github.com/simonw">@simonw</a>
        on 2024-11-08 14:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/simonw">@simonw</a> on 2024-11-08 14:03</div>
            <div class="timeline-body"><p>Is the current treatment of <code>CONDA_PREFIX</code> definitely the right thing to do?</p>
<p>https://docs.astral.sh/uv/pip/environments/#discovery-of-python-environments</p>
<blockquote>
<p>When running a command that mutates an environment such as uv pip sync or uv pip install, uv will search for a virtual environment in the following order:</p>
<ul>
<li>An activated virtual environment based on the VIRTUAL_ENV environment variable.</li>
<li>An activated Conda environment based on the CONDA_PREFIX environment variable.</li>
<li>A virtual environment at .venv in the current directory, or in the nearest parent directory.</li>
</ul>
</blockquote>
<p>Here's the problem: like many Python users (I imagine), while I don't actually use Conda I did end up with it on my system after one of many frustrating bouts of trying to use one machine learning library or another.</p>
<p>This means most of my shells now have that environment variable set.</p>
<p>As a result, <code>uv</code> was behaving <em>very</em> strangely for me. I made a bunch of notes in figuring this out here: https://gist.github.com/simonw/975dfa41e9b03bca2513a986d9aa3dcf</p>
<p>TLDR: Running <code>uv pip install -e '.[test]'</code> installed stuff in my global Conda environment and not my local <code>.venv/</code> folder and I couldn't figure out why.</p>
<p>I doubt I'm the only person who has been confused by this. Is the current behavior an irreversible decision at this point?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-08 14:05</div>
            <div class="timeline-body"><p>Hey @simonw — did you try 0.5.0? We actually just special-cased the &quot;base&quot; Conda environment #7691</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Reconsider the CONDA_PREFIX feature" to "Reconsider priority of CONDA_PREFIX when discovering virtual environments" by @simonw on 2024-11-08 14:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/simonw">@simonw</a> on 2024-11-08 14:16</div>
            <div class="timeline-body"><p>Yes - I can confirm this is fixed in 0.5!</p>
<p>Here's my experiment to prove it - I tried uv 0.4 and the package was installed in the Conda environment, but under 0.5 the same thing put it in <code>.venv</code> instead:</p>
<pre><code>$ pip install 'uv&lt;0.5' 
Collecting uv&lt;0.5
  Downloading uv-0.4.30-py3-none-macosx_11_0_arm64.whl.metadata (11 kB)
Downloading uv-0.4.30-py3-none-macosx_11_0_arm64.whl (12.5 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 12.5/12.5 MB 22.2 MB/s eta 0:00:00
Installing collected packages: uv
  Attempting uninstall: uv
    Found existing installation: uv 0.5.0
    Uninstalling uv-0.5.0:
      Successfully uninstalled uv-0.5.0
Successfully installed uv-0.4.30
$ uv --version
uv 0.4.30 (61ed2a236 2024-11-04)
$ mkdir /tmp/uv4
$ cd /tmp/uv4
$ uv venv
Using CPython 3.11.1
Creating virtual environment at: .venv
Activate with: source .venv/bin/activate
$ uv pip install cowsay
Using Python 3.10.10 environment at /opt/homebrew/Caskroom/miniconda/base
Resolved 1 package in 96ms
Installed 1 package in 3ms
 + cowsay==6.1
$ uv run which cowsay
/opt/homebrew/Caskroom/miniconda/base/bin/cowsay
$ mkdir /tmp/uv5
$ cd /tmp/uv5
$ pip install 'uv&gt;=0.5'
Collecting uv&gt;=0.5
  Using cached uv-0.5.0-py3-none-macosx_11_0_arm64.whl.metadata (11 kB)
Using cached uv-0.5.0-py3-none-macosx_11_0_arm64.whl (12.5 MB)
Installing collected packages: uv
  Attempting uninstall: uv
    Found existing installation: uv 0.4.30
    Uninstalling uv-0.4.30:
      Successfully uninstalled uv-0.4.30
Successfully installed uv-0.5.0
$ uv venv
Using CPython 3.10.10 interpreter at: /opt/homebrew/Caskroom/miniconda/base/bin/python3
Creating virtual environment at: .venv
Activate with: source .venv/bin/activate
$ uv pip install cowsay
Resolved 1 package in 2ms
Installed 1 package in 2ms
 + cowsay==6.1
$ uv run which cowsay
/private/tmp/uv5/.venv/bin/cowsay
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @simonw on 2024-11-08 14:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/simonw">@simonw</a> on 2024-11-08 14:18</div>
            <div class="timeline-body"><p>Turns out this issue was a dupe of:</p>
<ul>
<li>#7124</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-08 14:19</div>
            <div class="timeline-body"><p>Great timing :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/15604.html">astral-sh/uv#15604</a> on 2025-09-02 22:07</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:31:27 UTC
    </footer>
</body>
</html>
