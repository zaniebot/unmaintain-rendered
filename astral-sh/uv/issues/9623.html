<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>virtualenv detection skipped when running via `python -m uv` - astral-sh/uv #9623</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>virtualenv detection skipped when running via <code>python -m uv</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/9623">#9623</a>
        opened by <a href="https://github.com/tjni">@tjni</a>
        on 2024-12-03 22:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tjni">@tjni</a></div>
            <div class="timeline-body"><pre><code>/path/to/system/python -m uv python find
</code></pre>
<p>When run in a project with a virtual environment, this returns the invoking interpreter. I would expect it to find the virtual environment's Python interpreter. This is a consequence of https://github.com/astral-sh/uv/pull/3736. I think it's reasonable that the invoking interpreter is discoverable but would expect it to still check for a virtual environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-12-03 22:44</div>
            <div class="timeline-body"><p>Can you explain the use-case? As you noted, it's intentional that if you invoke uv from a parent interpreter we'll use that environment. I don't think we should check for a <code>VIRTUAL_ENV</code> in this case, the parent interpreter takes precedence. As an example scenario, the following behavior seems &quot;correct&quot;:</p>
<pre><code>❯ uv venv foo
Using CPython 3.12.7
Creating virtual environment at: foo
Activate with: source foo/bin/activate
❯ uv venv bar
Using CPython 3.12.7
Creating virtual environment at: bar
Activate with: source bar/bin/activate
❯ uv pip install --python foo uv
Using Python 3.12.7 environment at foo
Resolved 1 package in 196ms
Prepared 1 package in 1.05s
Installed 1 package in 6ms
 + uv==0.5.6
❯ source bar/bin/activate
❯ ./foo/bin/python -m uv python find
/Users/zb/workspace/uv/foo/bin/python
❯ ./foo/bin/uv python find
/Users/zb/workspace/uv/bar/bin/python3
❯ uv python find
/Users/zb/workspace/uv/bar/bin/python3
</code></pre>
<p>Perhaps you want <code>/path/to/system/python/bin/uv python find</code> instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tjni">@tjni</a> on 2024-12-03 23:17</div>
            <div class="timeline-body"><p>My use case is a bit more complicated: I am trying to invoke uv from a separate Python script by reusing the <code>__main__</code> entrypoint, and this is the reduced reproducer.</p>
<p>I wanted to discuss it because, after thinking about it, I feel that the current behavior is unexpected. I view <code>python -m uv</code> as primarily a way to launch uv and not a way to forcefully override the interpreter. The default behavior of uv to adapt its behavior based on what the current virtual environment is seems desirable even when launched this way.</p>
<p>The resolved issues point out that it's surprising that uv doesn't prefer the invoking interpreter over other interpreters on the PATH, especially during venv creation, and I do like that uv defaults to what it's invoked with in that case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @zanieb on 2024-12-04 00:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">breaking</span> added by @zanieb on 2024-12-04 00:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-12-04 00:18</div>
            <div class="timeline-body"><blockquote>
<p>I view python -m uv as primarily a way to launch uv and not a way to forcefully override the interpreter.</p>
</blockquote>
<p>Hm. Fair.</p>
<p>I'm not sure if we should change this or not, but it's breaking regardless so we can wait to see if we get additional feedback.</p>
<blockquote>
<p>I am trying to invoke uv from a separate Python script by reusing the <code>__main__</code> entrypoint, and this is the reduced reproducer.</p>
</blockquote>
<p>Could you share a minimal example of this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tjni">@tjni</a> on 2024-12-04 00:32</div>
            <div class="timeline-body"><p>In a project that has a dependency on <code>uv</code>, it would look like:</p>
<pre><code>from uv.__main__ import _run

def main():
    # Do some stuff like setting environment variables
    _run()

if __name__ == &quot;__main__&quot;:
    main()
</code></pre>
<p>The actual setup makes a little more sense: we build a <a href="https://github.com/linkedin/shiv">shiv</a> and at the top add a shebang, so it is just invoked directly instead of through an explicit Python interpreter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-06-20 13:51</div>
            <div class="timeline-body"><p>I think given the lack of feedback from other users, I'm going to close this for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-06-20 13:51</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:28:41 UTC
    </footer>
</body>
</html>
