<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caching of workspace on Github Action does not work well. - astral-sh/uv #9263</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Caching of workspace on Github Action does not work well.</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/9263">#9263</a>
        opened by <a href="https://github.com/higumachan">@higumachan</a>
        on 2024-11-20 03:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/higumachan">@higumachan</a></div>
            <div class="timeline-body"><p>When creating a workspace with multiple sub project, the cache for subdirectories does not work as expected.</p>
uv version
<pre><code>0.5.3
</code></pre>
Prerequisites
<p>For example, when running the following in a GitHub Action:</p>
<pre><code>      - name: &quot;Install the project&quot;
        run: uv sync --no-editable --all-extras --dev --frozen -vvv  --all-packages
        env:
          UV_CONCURRENT_BUILDS: 1
          UV_CONCURRENT_DOWNLOADS: 1
          UV_CONCURRENT_INSTALLS: 1
</code></pre>
<p>This issue occurs in projects using uv with multiple <code>pyproject.toml</code> files, such as the following structure:</p>
<pre><code>.
├── pyproject.toml
└── src/
    └── packages/
        ├── package1/
        │   ├── src
        │   └── pyproject.toml
        └── package2/
            ├── src
            └── pyproject.toml
</code></pre>
<p>Here is an example <code>pyproject.toml</code>:</p>
<pre><code>[project]
name = &quot;some_project&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.12&quot;
classifiers = [
    &quot;Programming Language :: Rust&quot;,
    &quot;Programming Language :: Python :: Implementation :: CPython&quot;,
    &quot;Programming Language :: Python :: Implementation :: PyPy&quot;,
]
dependencies = [
    &quot;package1&quot;,
    &quot;package2&quot;,
]
</code></pre>
Observed Behavior
<p>Even when configuring the uv cache directory on GitHub Actions, the cache is not applied correctly within uv.</p>
Cause
<p>The issue seems to stem from a combination of two factors:</p>
<ol>
<li><strong>Timestamp updates during <code>git clone</code></strong>: Files managed by Git have their timestamps updated to the clone time. As a result, the source files are always considered &quot;newer&quot; than the cache files, causing uv to bypass the cache.</li>
<li><strong>Reliance on <code>ctime</code> in uv</strong>: Since uv uses <code>ctime</code> to determine cache freshness, workarounds like using the <code>touch</code> command cannot be applied.</li>
</ol>
Ideas
Use hash-based cache management in CI mode
<p>Similar to the <code>--ci</code> option for <code>cache prune</code>, a <code>--ci</code> option for <code>sync</code> and <code>run</code> commands could enable hash-based cache management instead of timestamp-based.</p>
Use <code>mtime</code> instead of <code>ctime</code>
<p>Using <code>mtime</code> would allow workarounds such as <code>touch</code> to function. However, as noted in #1060, this approach may have its own drawbacks and is not ideal.</p>
<hr>
<p>If there are other potential solutions, please share! Especially if there&#x27;s a way to resolve this issue with the current version of uv.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/higumachan">@higumachan</a> on 2024-11-20 04:09</div>
            <div class="timeline-body">Use <code>mtime</code> with <code>ctime</code>
<p>Adopt <code>mtime</code> and <code>ctime</code> which is ahead in time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ottowayi">@ottowayi</a> on 2025-12-10 22:35</div>
            <div class="timeline-body"><p>I&#x27;m having issues with this as well in Azure DevOps pipelines.  I have a workspace with ~175 members in a pipeline with a couple dozen jobs.  Using the pipeline caching it was taking a couple seconds to recreate the venv in each job, but that was on self-hosted agents where I believe the repo persists between jobs.  But on cloud agents, each job is a fresh clone of the repo and the timestamps don&#x27;t match the ones in the cache from the previous job.  With <code>setuptools</code> this added ~2mins per job, I was able to get it down to ~45s with switch to <code>hatchling</code>, but that&#x27;s still more that doubling my build times.  I had tried between the git checkout and calling <code>uv sync</code>, having it override the <code>cache-keys</code> in every <code>pyproject.toml</code> to just be the git commit one, but that didn&#x27;t appear to have any effect.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:35:37 UTC
    </footer>
</body>
</html>
