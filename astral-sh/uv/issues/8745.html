<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv offers wrong Python when inside Docker with Rosetta in AMD linux on Mac ARM - astral-sh/uv #8745</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv offers wrong Python when inside Docker with Rosetta in AMD linux on Mac ARM</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/8745">#8745</a>
        opened by <a href="https://github.com/bepuca">@bepuca</a>
        on 2024-11-01 06:44
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bepuca">@bepuca</a></div>
            <div class="timeline-body">

<p>The situation is a bit special: I usually work on <a href="https://code.visualstudio.com/docs/devcontainers/containers">devcontainers</a>. Sadly, there are still many packages that do not have support for ARM architecture. Thus, many times I end up within a Docker container running rosetta since my Mac is sillicon.</p>
Minimal Example
<pre><code># devcontainer/Dockerfile
FROM --platform=linux/amd64 mcr.microsoft.com/devcontainers/base:jammy

# Install uv
COPY --from=ghcr.io/astral-sh/uv:0.4.29 /uv /uvx /bin/
</code></pre>
<pre><code>// devcontainer/devcontainer.json
{
    &quot;name&quot;: &quot;minimal&quot;,
    &quot;build&quot;: { &quot;dockerfile&quot;: &quot;Dockerfile&quot; },
    &quot;workspaceFolder&quot;: &quot;/workspaces/${localWorkspaceFolderBasename}&quot;,
    &quot;remoteEnv&quot;: {
        // Ensure venv is always first in PATH
        &quot;PATH&quot;: &quot;${containerWorkspaceFolder}/.venv/bin:${containerEnv:PATH}&quot;,
    },
    &quot;remoteUser&quot;: &quot;vscode&quot;,
}
</code></pre>
<p>To reproduce you will need:</p>
<ul>
<li>A Mac with AppleSillicon</li>
<li>VSCode with the <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers">devcontainer extension</a> installed</li>
<li>Docker in your machine</li>
</ul>
<p>Then, open the command palette of VSCode (if not directly prompted) and &quot;reopen in container&quot;.</p>
<p>Once it builds, if I go to the terminal and run:</p>
<pre><code>$uv python list

cpython-3.13.0+freethreaded-linux-aarch64-gnu    &lt;download available&gt;
cpython-3.12.7-linux-aarch64-gnu                 &lt;download available&gt;
cpython-3.11.10-linux-aarch64-gnu                &lt;download available&gt;
cpython-3.10.15-linux-aarch64-gnu                &lt;download available&gt;
cpython-3.10.12-linux-x86_64-gnu                 /usr/bin/python3.10
cpython-3.10.12-linux-x86_64-gnu                 /usr/bin/python3 -&gt; python3.10
cpython-3.10.12-linux-x86_64-gnu                 /bin/python3.10
cpython-3.10.12-linux-x86_64-gnu                 /bin/python3 -&gt; python3.10
cpython-3.9.20-linux-aarch64-gnu                 &lt;download available&gt;
cpython-3.8.20-linux-aarch64-gnu                 &lt;download available&gt;
pypy-3.10.14-linux-aarch64-gnu                   &lt;download available&gt;
pypy-3.9.19-linux-aarch64-gnu                    &lt;download available&gt;
pypy-3.8.16-linux-aarch64-gnu                    &lt;download available&gt;
pypy-3.7.13-linux-aarch64-gnu                    &lt;download available&gt;
</code></pre>
<p>As we can see, it finds the AMD arch python that comes pre-installed but everything else it offers is ARM. Thus, nothing works because it crashes when trying to use any of these pythons because they have the wrong architecture. For reference, this is the error:</p>
<pre><code>$uv sync

error: Failed to query Python interpreter at `/home/vscode/.local/share/uv/python/cpython-3.11.10-linux-aarch64-gnu/bin/python3.11`
  Caused by: No such file or directory (os error 2)
</code></pre>
<p>I am not sure if I am installing uv wrong somehow or if I can do something to direct it to the right arch. Any help will be super appreciated, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-01 13:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-01 13:40</div>
            <div class="timeline-body"><p>Can you share verbose logs for <code>uv sync</code>? It&#x27;s not clear to me why we&#x27;re trying to query that specific interpreter.</p>
<p>Does <code>uv sync -p cpython-3.11.10-linux-x86_64-gnu</code> work?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bepuca">@bepuca</a> on 2024-11-01 16:52</div>
            <div class="timeline-body"><p>[Edited as some cache was causing less logs than expected]</p>
<p>The logs with verbose (if I understand correctly how to get them):</p>
<pre><code>$ uv sync -v

DEBUG uv 0.4.29
DEBUG Found project root: `/workspaces/minimal`
DEBUG No workspace root found, using project root
DEBUG Reading requests from `/workspaces/minimal/.python-version`
DEBUG Searching for Python 3.11 in managed installations or system path
DEBUG Searching for managed installations at `/home/vscode/.local/share/uv/python`
DEBUG Found `cpython-3.10.12-linux-x86_64-gnu` at `/usr/bin/python3` (search path)
DEBUG Skipping interpreter at `/usr/bin/python3` from search path: does not satisfy request `3.11`
DEBUG Found `cpython-3.10.12-linux-x86_64-gnu` at `/bin/python3` (search path)
DEBUG Skipping interpreter at `/bin/python3` from search path: does not satisfy request `3.11`
DEBUG Requested Python not found, checking for available download...
DEBUG Acquired lock for `/home/vscode/.local/share/uv/python`
DEBUG Using request timeout of 30s
INFO Fetching requested Python...
DEBUG Downloading https://github.com/indygreg/python-build-standalone/releases/download/20241016/cpython-3.11.10%2B20241016-aarch64-unknown-linux-gnu-install_only_stripped.tar.gz to temporary location: /home/vscode/.local/share/uv/python/.cache/.tmpInXmxQ
DEBUG Extracting cpython-3.11.10%2B20241016-aarch64-unknown-linux-gnu-install_only_stripped.tar.gz
DEBUG Moving /home/vscode/.local/share/uv/python/.cache/.tmpInXmxQ/python to /home/vscode/.local/share/uv/python/cpython-3.11.10-linux-aarch64-gnu
DEBUG Released lock at `/home/vscode/.local/share/uv/python/.lock`
error: Failed to query Python interpreter at `/home/vscode/.local/share/uv/python/cpython-3.11.10-linux-aarch64-gnu/bin/python3.11`
  Caused by: No such file or directory (os error 2)
</code></pre>
<p>And running the command you suggest:</p>
<pre><code>$ uv sync -p cpython-3.11.10-linux-x86_64-gnu -v

DEBUG uv 0.4.29
DEBUG Found project root: `/workspaces/minimal`
DEBUG No workspace root found, using project root
DEBUG Searching for cpython-3.11.10-linux-x86_64-gnu in managed installations or system path
DEBUG Searching for managed installations at `/home/vscode/.local/share/uv/python`
DEBUG Found `cpython-3.10.12-linux-x86_64-gnu` at `/usr/bin/python3` (search path)
DEBUG Skipping interpreter at `/usr/bin/python3` from search path: does not satisfy request `3.11.10`
DEBUG Found `cpython-3.10.12-linux-x86_64-gnu` at `/bin/python3` (search path)
DEBUG Skipping interpreter at `/bin/python3` from search path: does not satisfy request `3.11.10`
DEBUG Requested Python not found, checking for available download...
DEBUG Acquired lock for `/home/vscode/.local/share/uv/python`
DEBUG Using request timeout of 30s
INFO Fetching requested Python...
DEBUG Downloading https://github.com/indygreg/python-build-standalone/releases/download/20241016/cpython-3.11.10%2B20241016-x86_64-unknown-linux-gnu-install_only_stripped.tar.gz to temporary location: /home/vscode/.local/share/uv/python/.cache/.tmpPCQxbN
DEBUG Extracting cpython-3.11.10%2B20241016-x86_64-unknown-linux-gnu-install_only_stripped.tar.gz
DEBUG Moving /home/vscode/.local/share/uv/python/.cache/.tmpPCQxbN/python to /home/vscode/.local/share/uv/python/cpython-3.11.10-linux-x86_64-gnu
DEBUG Released lock at `/home/vscode/.local/share/uv/python/.lock`
Using CPython 3.11.10
Creating virtual environment at: .venv
DEBUG Using request timeout of 30s
DEBUG Found static `pyproject.toml` for: minimal @ file:///workspaces/minimal
DEBUG No workspace root found, using project root
DEBUG Solving with installed Python version: 3.11.10
DEBUG Solving with target Python version: &gt;=3.11
DEBUG Adding direct dependency: minimal*
DEBUG Searching for a compatible version of minimal @ file:///workspaces/minimal (*)
DEBUG Tried 1 versions: minimal 1
DEBUG Split universal resolution took 0.000s
Resolved 1 package in 4ms
DEBUG Using request timeout of 30s
Audited in 0.03ms
</code></pre>
<p>Alright, so the command you suggested does work. For my understanding, this is a bug then? Is there a way I can specify this somewhere so I do not have to pass it every time? Or I only need this add init time?</p>
<p>Let me know if there is anything else I can do to provide more info. Thank you very much for the prompt response!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-01 23:27</div>
            <div class="timeline-body"><p>I think it&#x27;s a bug, in that when we fill the platform information at</p>
<p>https://github.com/astral-sh/uv/blob/893257bb0b2a0df4196410f279d5a837effafee0/crates/uv-python/src/downloads.rs#L192-L194</p>
<p>and</p>
<p>https://github.com/astral-sh/uv/blob/2b0e16cb75911bc291c92f7186512223c2d2d899/crates/uv-python/src/platform.rs#L76-L78</p>
<p>we think it&#x27;s <code>aarch64</code> instead of <code>x86_64</code>. I&#x27;m not really sure why yet.</p>
<p>You could put that full version tag in a <code>UV_PYTHON</code> environment variable and we should respect it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-01 23:31</div>
            <div class="timeline-body"><p>Are you copying uv from the right image? I wonder if you need the <code>--platform</code> flag there? You can also specify the SHA.</p>
<p>https://github.com/astral-sh/uv/pkgs/container/uv/298017082?tag=latest</p>
<img alt="Screenshot 2024-11-01 at 6 30 24â€¯PM" src="https://github.com/user-attachments/assets/b7a578e2-af18-4226-afa1-b9c81f61de98">

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2024-11-02 01:42</div>
            <div class="timeline-body"><p>Agreed with @zanieb. Usually you&#x27;d pass <code>--platform</code> to your <code>docker buildx build --platform=linux/amd64 -t foo-linux-amd64 /path/to/context</code> to resolve this as it will then pick the right manifest entry.</p>
<p>That would allow you to cleanup the <code>Dockerfile</code></p>
<pre><code># devcontainer/Dockerfile
FROM mcr.microsoft.com/devcontainers/base:jammy

# Install uv
COPY --from=ghcr.io/astral-sh/uv:0.4.29 /uv /uvx /bin/
</code></pre>
<p>Alternatively would be using raw sha</p>
<pre><code># devcontainer/Dockerfile
FROM --platform=linux/amd64 mcr.microsoft.com/devcontainers/base:jammy

# Install uv
COPY --from=ghcr.io/astral-sh/uv:0.4.29@sha256:c17127bc372350d61bae20be54c85540a8937eaa691c61840a7abc80e284fc8d /uv /uvx /bin/
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2024-11-02 01:47</div>
            <div class="timeline-body"><p>On VSCode, you may be able to do this by leveraging devcontainers extension <a href="https://containers.dev/implementors/json_reference/#image-specific">build.options</a> setting. e.g.</p>
<pre><code>    &quot;build&quot;: { 
        ...
        &quot;options&quot;: [
            &quot;--platform=linux/amd64&quot;
        ]
    },
</code></pre>
<p>Alternatively, you could also try the approach shown in <a href="https://github.com/astral-sh/uv/issues/8737">astral-sh/uv#8737</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-02 02:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-02 02:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-02 02:22</div>
            <div class="timeline-body"><p>We should add some notes to the documentation about using cross-platform images.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bepuca">@bepuca</a> on 2024-11-02 15:44</div>
            <div class="timeline-body"><p>It does seem I might have been using the wrong uv using a naive copy. I would still have expected that to work but using curl is an option and does seem to solve the issue. Thank you very much for the help!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-02 15:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:35:11 UTC
    </footer>
</body>
</html>
