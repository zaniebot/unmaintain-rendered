<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv lock --check` fails even though `uv lock` gives no updates - astral-sh/uv #13614</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`uv lock --check` fails even though `uv lock` gives no updates</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/13614">#13614</a>
        opened by <a href="https://github.com/mikeweltevrede">@mikeweltevrede</a>
        on 2025-05-23 07:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/mikeweltevrede">@mikeweltevrede</a> on 2025-05-23 07:21</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I hope you can help me with this :)</p>
<p>Running <code>uv lock --check</code> seems to fail even though when I run <code>uv lock</code> there are no updates:</p>
<pre><code>(my-repo) my-device my-repo % uv self version
uv 0.7.3 (3c413f74b 2025-05-07)
(my-repo) my-device my-repo % uv lock --check
Resolved 345 packages in 5.88s
error: The lockfile at `uv.lock` needs to be updated, but `--locked` was provided. To update the lockfile, run `uv lock`.
(my-repo) my-device my-repo % uv lock
Resolved 345 packages in 9.68s
(my-repo) my-device my-repo % uv lock --check
Resolved 345 packages in 5.05s
error: The lockfile at `uv.lock` needs to be updated, but `--locked` was provided. To update the lockfile, run `uv lock`.
</code></pre>
<p>The pyproject.toml looks something like this (not shared entirely for confidentiality):</p>
<pre><code>[project]
requires-python = &quot;&lt;4.0,&gt;=3.9&quot;
dependencies = [
    &quot;typing-extensions&gt;=4.6.0; python_version &lt; '3.13'&quot;,
]

[dependency-groups]
local = [
    &quot;typing-extensions==4.9.0&quot;,
]
dev = [
    &quot;numba==0.55.1; python_version == '3.9'&quot;,
    &quot;numba==0.56.4; python_version == '3.10'&quot;,
    &quot;numba==0.57.1; python_version == '3.11'&quot;,
    &quot;numba; python_version &gt; '3.11'&quot;,
    &quot;numpy==1.21.5; python_version == '3.9'&quot;,
    &quot;numpy==1.23.5; python_version == '3.10' or python_version == '3.11'&quot;,
    &quot;numpy; python_version &gt; '3.11'&quot;,
]
lint = [
    &quot;pre-commit==4.2.0&quot;,
    &quot;pre-commit-hooks==5.0.0&quot;,
    &quot;ruff==0.11.7&quot;,
]
</code></pre>
<p>This is the <code>uv.toml</code> file:</p>
<pre><code>prerelease = &quot;allow&quot;
python-downloads = &quot;never&quot;
python-preference = &quot;only-system&quot;
link-mode = &quot;symlink&quot;

[[index]]
name = &quot;my-corporate-proxy&quot;
url = &quot;https://my-corporate-proxy.com&quot;
default = true
verify_ssl = true

[pip]
strict = true
verify-hashes = true
no-build-isolation-package = [&quot;numba&quot;]
</code></pre>
<p>The venv is created with the following make command (locally, we use <code>uv venv --python 3.10</code> and on the CI the Python version is selected on the build agent so <code>uv venv</code> is used):</p>
<pre><code># `export CC` reason: https://stackoverflow.com/questions/79137098/macos-python-3-9-no-module-named-distutils-msvccompiler
.PHONY: install-project
install-project:
	@echo &quot;ðŸš€ Creating virtual environment using uv&quot;
	@uv self version
	@uv venv
	@echo &quot;ðŸš€ Installing numba without build isolation&quot;
	@make install-root
	@export CC=/usr/bin/clang &amp;&amp; export CXX=/usr/bin/clang++
	@uv pip install setuptools numpy &amp;&amp; uv pip install numba
	@echo &quot;ðŸš€ Installing project (with all dependencies)&quot;
	@uv sync --all-groups --all-extras
	@uv run pre-commit install
</code></pre>
<p>What I already checked:</p>
<ul>
<li>Deleting the lock file and recreating it</li>
<li>The Github issues. No similar ones come up.</li>
<li>Look at the docs, e.g. <a href="https://docs.astral.sh/uv/reference/cli/#uv-lock">uv lock</a>, <a href="https://docs.astral.sh/uv/concepts/projects/sync/#locking-and-syncing">Locking and syncing</a>, <a href="https://docs.astral.sh/uv/reference/troubleshooting/build-failures/#troubleshooting-build-failures">Troubleshooting build failures</a>, and <a href="https://docs.astral.sh/uv/pip/compile/#locking-environments">Locking environments</a></li>
</ul>
<h3>Platform</h3>
<p>Darwin 24.5.0 arm64 (macOS 15.5 Sequoia)</p>
<h3>Version</h3>
<p>uv 0.7.3 (3c413f74b 2025-05-07)</p>
<h3>Python version</h3>
<p>Python 3.9.22, 3.10.17, 3.11.12 (all on Azure DevOps CI), Python 3.10.5 (Locally)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @mikeweltevrede on 2025-05-23 07:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Lock file" to "`uv lock --check` fails even though `uv lock` gives no updates" by @mikeweltevrede on 2025-05-23 08:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mikeweltevrede">@mikeweltevrede</a> on 2025-05-23 08:13</div>
            <div class="timeline-body"><p>PS: One thing that would already be great, if possible, is if the error message would mention why it needs to be updated. For example, is it a specific library, Python version, etcetera.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-23 11:20</div>
            <div class="timeline-body"><p>Unfortunately I can't reproduce this as-is. Are you able to put together a minimal example that we can reproduce? Something that we can <code>git clone</code> and a command we can run? You can use <code>https://public:heron@pypi-proxy.fly.dev/basic-auth/simple/</code> instead of your own index if you need an alternative.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @charliermarsh on 2025-05-23 11:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-05-23 11:53</div>
            <div class="timeline-body"><p>Can you share verbose logs? Those should contain the reason for the lockfile invalidation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mikeweltevrede">@mikeweltevrede</a> on 2025-05-23 12:09</div>
            <div class="timeline-body"><blockquote>
<p>Can you share verbose logs? Those should contain the reason for the lockfile invalidation.</p>
</blockquote>
<p>@konstin Thanks, I did not know of that flag. This is the bottom of the verbose logs. There is not much in the rest of the logs. It does not tell me anything, is there anything that draws your attention?</p>
<p><img src="https://github.com/user-attachments/assets/5a0fd9b5-4993-4360-8065-d2fa7d8578a9" alt="Image" /></p>
<p>PS: Running <code>RUST_LOG=error uv lock --check --verbose</code> to decrease the immense amount of <code>DEBUG</code> logs yields no output (no ERROR logs). Using <code>RUST_LOG=info</code> yields some results that don't tell me anything either (<code>&quot;INFO add_decision: Id::&lt;PubGrubPackage&gt;(340) @ 1.17.1 without checking dependencies&quot;</code> for multiple versions)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mikeweltevrede">@mikeweltevrede</a> on 2025-05-23 12:10</div>
            <div class="timeline-body"><blockquote>
<p>Unfortunately I can't reproduce this as-is. Are you able to put together a minimal example that we can reproduce? Something that we can <code>git clone</code> and a command we can run? You can use <code>https://public:heron@pypi-proxy.fly.dev/basic-auth/simple/</code> instead of your own index if you need an alternative.</p>
</blockquote>
<p>Thanks @charliermarsh I will look into whether I can make an MRE</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-05-23 12:42</div>
            <div class="timeline-body"><p>Can you share the verbose logs for <code>uv lock --check</code>, either <code>uv lock --check -v</code> or <code>uv lock --check -vv</code>, potentially as a GitHub gist?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mikeweltevrede">@mikeweltevrede</a> on 2025-05-23 12:52</div>
            <div class="timeline-body"><p>@konstin here is a gist for the <code>-v</code> log: https://gist.github.com/mikeweltevrede/4da89b4f35393fe415689cc092f26c64. The <code>-vv</code> log was too big and timed out the gist upload. Thanks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-05-23 12:57</div>
            <div class="timeline-body"><p>Thanks!</p>
<p>We're missing a normalization somewhere, requested is <code>marker: false</code>, we're seeing <code>marker: python_full_version &lt; '0'</code> (which is another way to write false)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @Gankra by @konstin on 2025-05-23 12:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mikeweltevrede">@mikeweltevrede</a> on 2025-05-23 14:54</div>
            <div class="timeline-body"><p>Thanks @konstin. Good to know that I will be out of office until June 5 so my delays might not be that quick. I appreciate your timely responses and hope we can find a solution soon. Please let me know in case I need to check or test something.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-05-23 14:55</div>
            <div class="timeline-body"><p>With those logs I have a minimal reproducer, so we should be able to fix it in the next release</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Gankra on 2025-05-26 18:17</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 03:35:35 UTC
    </footer>
</body>
</html>
