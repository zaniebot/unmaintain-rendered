<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Should preserve symlink to specified python interpreter - astral-sh/uv #1795</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Should preserve symlink to specified python interpreter</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/1795">#1795</a>
        opened by <a href="https://github.com/bulletmark">@bulletmark</a>
        on 2024-02-21 05:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/bulletmark">@bulletmark</a> on 2024-02-21 05:03</div>
            <div class="timeline-body"><p>This describes an issue where <code>uv venv</code> operates in an incompatible and less-optimal way compared to <code>python -m venv</code>.</p>
<pre><code class="language-sh">$ uv --version
uv 0.1.6
</code></pre>
<p>I use <a href="https://github.com/pyenv/pyenv"><code>pyenv</code></a> to install multiple python versions etc. I don't use the pyenv shims and just specify the pyenv python executable when building my venv's. So I have  symlinks to the latest minor versions, i.e:</p>
<pre><code class="language-sh">$ cd ~/.pyenv/versions
$ ls -l
lrwxrwxrwx - mark mark 13 Jan 12:47 3.7 -&gt; 3.7.17/
drwxr-xr-x - mark mark 13 Jun  2023 3.7.17/
lrwxrwxrwx - mark mark 13 Jan 12:47 3.8 -&gt; 3.8.18/
drwxr-xr-x - mark mark 29 Aug  2023 3.8.18/
lrwxrwxrwx - mark mark 13 Jan 12:47 3.9 -&gt; 3.9.18/
drwxr-xr-x - mark mark 29 Aug  2023 3.9.18/
lrwxrwxrwx - mark mark 13 Jan 12:47 3.10 -&gt; 3.10.13/
drwxr-xr-x - mark mark 29 Aug  2023 3.10.13/
lrwxrwxrwx - mark mark 18 Feb 13:04 3.11 -&gt; 3.11.8/
drwxr-xr-x - mark mark 18 Feb 13:04 3.11.8/
lrwxrwxrwx - mark mark 21 Feb 11:32 3.12 -&gt; 3.12.2/
drwxr-xr-x - mark mark 21 Feb 11:18 3.12.1/
drwxr-xr-x - mark mark 18 Feb 12:53 3.12.2/
</code></pre>
<p>Now witness the difference in the created symlinks to the interpreter when making a venv using these links:</p>
<pre><code class="language-sh">$ ~/.pyenv/versions/3.12/bin/python -m venv venv
$ ls -l venv/bin/python
lrwxrwxrwx - mark mark 21 Feb 12:36 venv/bin/python -&gt; /home/mark/.pyenv/versions/3.12/bin/python*

$ uv venv -p ~/.pyenv/versions/3.12/bin/python uvenv
Using Python 3.12.2 interpreter at /home/mark/.pyenv/versions/3.12.2/bin/python3.12
Creating virtualenv at: uvenv
Activate with: source uvenv/bin/activate
$ ls -l uvenv/bin/python
lrwxrwxrwx - mark mark 21 Feb 12:42 uvenv/bin/python -&gt; /home/mark/.pyenv/versions/3.12.2/bin/python3.12
</code></pre>
<p>I.e. <code>python -m venv</code> creates a <code>3.12</code> link as I specified but <code>uv venv</code> dereferences that <code>3.12</code> path and creates a final link to <code>3.12.2</code>.</p>
<p>This is undesirable because it means when <code>3.12</code> gets it's next compatible maintenance release, e.g. <code>3.12.3</code> and the pyenv link is updated, then the <code>python -m venv</code> venv will automatically use that <code>3.12.3</code> update but the <code>uv venv</code> uvenv will continue to use the older release and requires the venv to be rebuilt against the new version.</p>
<p>So is there any reason <code>uv venv</code> needs to resolve that symlink?  It seems better to do what <code>python -m venv</code> does and just use it directly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-21 05:10</div>
            <div class="timeline-body"><p>This was changed in https://github.com/astral-sh/uv/pull/966 to fix something else. Maybe @konstin knows if we actually need to resolve symlinks there, or if we just needed to convert to an absolute path or something.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-02-21 11:34</div>
            <div class="timeline-body"><p>We need to resolve symlinks for the caching, but i think we can use the resolved version for caching and the original version for the venv. I think we should special case venv-from-venv cases, otherwise the new venv will break when deleting the venv it was created from.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/1791.html">astral-sh/uv#1791</a> on 2024-02-21 11:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-02-21 17:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">virtualenv</span> added by @zanieb on 2024-02-21 17:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-07 21:44</div>
            <div class="timeline-body"><p>This is related to a few other issues, but note that virtualenv (on <code>main</code>) also resolves symlinks like this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-07 21:45</div>
            <div class="timeline-body"><p>For the future: similar to https://github.com/astral-sh/uv/issues/1640. Need to decide if we want to preserve symlinks in these various cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/2327.html">astral-sh/uv#2327</a> on 2024-03-10 06:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gschaffner">@gschaffner</a> on 2024-03-10 06:55</div>
            <div class="timeline-body"><blockquote>
<pre><code class="language-shell">$ ~/.pyenv/versions/3.12/bin/python -m venv venv
$ ls -l venv/bin/python
lrwxrwxrwx - mark mark 21 Feb 12:36 venv/bin/python -&gt; /home/mark/.pyenv/versions/3.12/bin/python*

$ uv venv -p ~/.pyenv/versions/3.12/bin/python uvenv
Using Python 3.12.2 interpreter at /home/mark/.pyenv/versions/3.12.2/bin/python3.12
Creating virtualenv at: uvenv
Activate with: source uvenv/bin/activate
$ ls -l uvenv/bin/python
lrwxrwxrwx - mark mark 21 Feb 12:42 uvenv/bin/python -&gt; /home/mark/.pyenv/versions/3.12.2/bin/python3.12
</code></pre>
</blockquote>
<p>#2327 is related—when creating the same <code>uv venv</code> but without passing <code>--python</code>, uv's report states that <code>uv venv</code> didn't resolve <code>versions/3.12</code> to <code>versions/3.12.2</code>:</p>
<pre><code class="language-console">+ type python
python is /home/ganden/.pyenv/shims/python
+ python -c 'import sys; print(sys.executable)'
/home/ganden/.pyenv/versions/3.12/bin/python
+ readlink -f /home/ganden/.pyenv/versions/3.12/bin/python
/home/ganden/.pyenv/versions/3.12.2/bin/python3.12
+ : '^^^ the above resolution is due to the symlinks'
+ readlink /home/ganden/.pyenv/versions/3.12 /home/ganden/.pyenv/versions/3.12.2/bin/python
3.12.2
python3.12
+ :
+ uv venv
Using Python 3.12.2 interpreter at: /home/ganden/.pyenv/versions/3.12/bin/python3
Creating virtualenv at: .venv
Activate with: source .venv/bin/activate
+ : '^^^ uv reports using versions/3.12'
+ readlink .venv/bin/python
/home/ganden/.pyenv/versions/3.12.2/bin/python3.12
+ : '^^^ but actually uses versions/3.12.2'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-11 19:44</div>
            <div class="timeline-body"><p>I'm not totally sure what we're supposed to do when creating a virtualenv from within a virtualenv.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-11 19:45</div>
            <div class="timeline-body"><p><code>python -m venv</code> seems to use the existing virtualenv as the base:</p>
<pre><code>❯ cat .nested-venv/pyvenv.cfg
home = /Users/crmarsh/workspace/uv/.venv/bin
include-system-site-packages = false
version = 3.8.18
</code></pre>
<p>However, <code>virtualenv</code> does not seem to do this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3060.html">astral-sh/uv#3060</a> on 2024-04-16 13:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CharString">@CharString</a> on 2024-05-13 11:03</div>
            <div class="timeline-body"><p>I this is how it's supposed to work, then what's the proposed workflow to upgrade, say, 3.9.18 to 3.9.19 and repair all my venvs that I created to use 3.9? freeze, rm, venv, sync?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-13 14:15</div>
            <div class="timeline-body"><p>Yeah, that's technically the correct thing to do, because you <em>could</em> have packages in your environment that are compatible with the previous but not the updated patch version; or packages whose dependencies differ by patch version. Both of those things are allowed in Python / per the spec though are very rare in practice when talking about patch versions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-13 14:15</div>
            <div class="timeline-body"><p>(We may change our behavior here eventually to preserve the symlink; undecided right now.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CharString">@CharString</a> on 2024-05-13 17:55</div>
            <div class="timeline-body"><p>Hmmm, right. Then maybe the correct thing would be the addition of some <code>venv rebuild</code> command, the way <code>pipx</code> has the <code>reinstall</code> and <code>reinstall-all</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3560.html">astral-sh/uv#3560</a> on 2024-05-14 14:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/4450.html">astral-sh/uv#4450</a> on 2024-06-23 17:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/2831.html">astral-sh/uv#2831</a> on 2024-06-25 11:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ncoghlan">@ncoghlan</a> on 2024-06-25 12:19</div>
            <div class="timeline-body"><p>As far as creating virtualenvs from within virtualenvs goes, the <code>python -m venv</code> behaviour is questionable, since it won't work in the general case (if you want to layer virtual environments together in a way that actually works, you currently need to add a <code>sitecustomize.py</code> file to the upper layers to get everything resolving correctly at runtime, simply referencing a venv layout as your &quot;base Python&quot; environment may not work reliably because some of the files can end up in the wrong relative locations, especially when Python has been compiled as a shared library with a wrapper executable). (I haven't gone looking to see if there's an open bug report about this though)</p>
<p>Outside the specific scenario of being passed a virtual environment symlink, using a provided symlink as given rather than resolving it feels like it would be more correct, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-25 12:22</div>
            <div class="timeline-body"><p>Interesting. Perhaps what we want then, is: resolve the symlink if it's a virtualenv, preserve it if not?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/itamarst">@itamarst</a> on 2024-10-15 13:35</div>
            <div class="timeline-body"><blockquote>
<p>I this is how it's supposed to work, then what's the proposed workflow to upgrade, say, 3.9.18 to 3.9.19 and repair all my venvs that I created to use 3.9? freeze, rm, venv, sync?</p>
</blockquote>
<p>Note that this is a security concern: users will almost never want a specific patch release, they will want &quot;the latest 3.12&quot; or whatever so they can get security fixes when they update. This is the typical behavior with e.g. Linux distro-managed virtualenvs; I don't go and upgrade every single venv when the distro does a security updates.</p>
<p>You can also approach this from a user intention perspective in how the venv was originally created:</p>
<pre><code>$ uv venv --python=3.12
$ uv venv --python=3.12.6
</code></pre>
<p>The first one fairly clearly does <em>not</em> care about patch releases, and arguably should be updated to the latest available one. The second <em>does</em> case about the specific patch release and should not be upgraded.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/8217.html">astral-sh/uv#8217</a> on 2024-10-15 13:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-10-21 20:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/8433.html">astral-sh/uv#8433</a> on 2024-10-22 00:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-22 00:20</div>
            <div class="timeline-body"><p>PR here: https://github.com/astral-sh/uv/pull/8433</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/8481.html">astral-sh/uv#8481</a> on 2024-10-22 23:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MRigal">@MRigal</a> on 2024-11-01 13:59</div>
            <div class="timeline-body"><p>Partially solved with the release of uv 0.4.29 which includes #8481 or waiting to be ungated (Preview) to close it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-01 14:01</div>
            <div class="timeline-body"><p>It'll be in v0.5.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-11-07 20:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bulletmark">@bulletmark</a> on 2024-12-05 22:46</div>
            <div class="timeline-body"><p>I raised this issue but it was not resolved for me:</p>
<pre><code>$ uv --version
uv 0.5.6 (b70c4f30e 2024-12-03)

$ ls -l /home/mark/.local/share/pystand/3.12
lrwxrwxrwx 1 mark mark 6 Dec  6 07:51 /home/mark/.local/share/pystand/3.12 -&gt; 3.12.8

$ ~/.local/share/pystand/3.12/bin/python -m venv py-venv
$ ls -l py-venv/bin/python
lrwxrwxrwx    - mark mark  6 Dec 08:23 python -&gt; /home/mark/.local/share/pystand/3.12/bin/python*

$ uv venv -p ~/.local/share/pystand/3.12/bin/python uv-venv
Using CPython 3.12.8 interpreter at: .local/share/pystand/3.12/bin/python
Creating virtual environment at: uv-venv
Activate with: source uv-venv/bin/activate
$ ls -l uv-venv/bin/python
lrwxrwxrwx    - mark mark  6 Dec 08:24 python -&gt; /home/mark/.local/share/pystand/3.12.8/bin/python3.12*
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-05 23:41</div>
            <div class="timeline-body"><p>Do you have the same experience with <code>python -m venv</code> on that Python?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bulletmark">@bulletmark</a> on 2024-12-06 00:50</div>
            <div class="timeline-body"><p>Sorry, not sure what you mean. I've made two venvs just above. Isn't the first one what you are asking for?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-06 00:53</div>
            <div class="timeline-body"><p>Sorry, I missed that! Where does this Python come from? Did you install it with uv?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bulletmark">@bulletmark</a> on 2024-12-06 01:02</div>
            <div class="timeline-body"><p>I installed that myself from python-build-standalone (not using <code>uv</code>). I would have thought the build of python was irrelevant but I just tried the same sequence using 3.12.7 from <code>pyenv</code> and in that case <code>uv</code> did set <code>uv-venv/bin/python -&gt; /home/mark/.pyenv/versions/3.12/bin/python</code>. Why would that work there but not with the PBS build?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-06 01:27</div>
            <div class="timeline-body"><p>Yeah, it's about this issue: https://github.com/indygreg/python-build-standalone/issues/380. Basically, if you create an arbitrary symlink to a PBS interpreter, invoking it can crash (note that there's no <code>uv</code> here):</p>
<pre><code>❯ ln -s /Users/crmarsh/.local/share/uv/python/cpython-3.12.6-macos-aarch64-none/bin/python pbs3.12
❯ ./pbs3.12 -m venv --without-pip pbs3.12-venv-link
❯ ./pbs3.12-venv-link/bin/python
Could not find platform independent libraries &lt;prefix&gt;
Could not find platform dependent libraries &lt;exec_prefix&gt;
Python path configuration:
  PYTHONHOME = (not set)
  PYTHONPATH = (not set)
  program name = './pbs3.12-venv-link/bin/python'
  isolated = 0
  environment = 1
  user site = 1
  safe_path = 0
  import site = 1
  is in build tree = 0
  stdlib dir = '/install/lib/python3.12'
  sys._base_executable = '/Users/crmarsh/.local/share/uv/python/cpython-3.12.6-macos-aarch64-none/bin/python3.12'
  sys.base_prefix = '/install'
  sys.base_exec_prefix = '/install'
  sys.platlibdir = 'lib'
  sys.executable = '/Users/crmarsh/workspace/uv/foo/pbs3.12-venv-link/bin/python'
  sys.prefix = '/install'
  sys.exec_prefix = '/install'
  sys.path = [
    '/install/lib/python312.zip',
    '/install/lib/python3.12',
    '/install/lib/python3.12/lib-dynload',
  ]
Fatal Python error: init_fs_encoding: failed to get the Python codec of the filesystem encoding
Python runtime state: core initialized
ModuleNotFoundError: No module named 'encodings'

Current thread 0x00000001fdf34c00 (most recent call first):
  &lt;no Python frame&gt;
</code></pre>
<p>(What you're doing seems to work, I think because you're symlinking the entire <code>bin</code> directory or something? I'm not totally sure.)</p>
<p>So right now in uv we conservatively resolve symlinks for all PBS-based environments. We can probably stop doing that once the upstream issue is fixed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bulletmark">@bulletmark</a> on 2024-12-06 01:32</div>
            <div class="timeline-body"><p>Thanks. Would perhaps be good if you reopened this bug as a reminder here though :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-10 20:42</div>
            <div class="timeline-body"><p>@bulletmark -- I think your use-case <em>should</em> be resolved by https://github.com/astral-sh/uv/pull/9723.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bulletmark">@bulletmark</a> on 2024-12-10 23:22</div>
            <div class="timeline-body"><p>@charliermarsh thanks, I will test that and report here when it appears in a release.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bulletmark">@bulletmark</a> on 2024-12-11 22:09</div>
            <div class="timeline-body"><p>I tested today's new release 0.5.7 -&gt; 0.5.8 and 0.5.8 does fix this bug. Thanks very much for fixing this.</p>
<p>This fixes a significant deficit. Now when a user updates their local build of python 3.x.y -&gt; 3.x.(y+1) for a maintenance update (e.g. using <code>pyenv</code>) then this will automatically be reflected in derived <code>uv</code> venvs like they are in standard python venvs, assuming of course they were created from a 3.x link. Before this fix, the user had to run around and manually update all his/her derived <code>uv</code> built venvs by hand because they otherwise still point to the old version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-11 22:12</div>
            <div class="timeline-body"><p>Awesome, thanks for re-testing @bulletmark.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:57 UTC
    </footer>
</body>
</html>
