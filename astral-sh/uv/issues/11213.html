<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>new docker image bookworm-slim makes `uv build` fail - astral-sh/uv #11213</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>new docker image bookworm-slim makes `uv build` fail</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/11213">#11213</a>
        opened by <a href="https://github.com/Morgadoooo">@Morgadoooo</a>
        on 2025-02-04 12:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Morgadoooo">@Morgadoooo</a> on 2025-02-04 12:11</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Hi,</p>
<p>I'm running CI on gitlab using their saas runners (linux amd64)</p>
<p>I don't know if i'm the only one here but I noticed that since latest docker images have dropped my CI are failing to <code>uv build</code>.</p>
<p>Tried to run without cache / with different python version (bookworm-slim 3.8 / 3.9 / 3.12)</p>
<pre><code class="language-bash">&gt; uv build
Building source distribution...
  × Failed to build `/builds/test/a_package`
  ├─▶ failed to unpack
  │   `/builds/test/a_package/.uv-cache/sdists-v7/.tmp1n3mUq/test/a_package-1.0.0/.uv-cache/archive-v0/xnIKTmXwjjeTGFKmNQ04g/lib/python3.12/site-packages/typing_extensions.py`
  ╰─▶ No such file or directory (os error 2) while canonicalizing
      /builds/test/a_package/.uv-cache/sdists-v7/.tmp1n3mUq/test/a_package-1.0.0/.uv-cache/archive-v0/xnIKTmXwjjeTGFKmNQ04g/lib/python3.12/site-packages/a_package-1.0.0/.uv-cache/archive-v0/fQx_zMdWQeLktREBUY0-Z/typing_extensions.py
</code></pre>
<p>Using the ghcr.io/astral-sh/uv:0.5.26-python3.12-bookworm-slim does work for me</p>
<h3>Platform</h3>
<p>linux amd64</p>
<h3>Version</h3>
<p>uv 0.5.27</p>
<h3>Python version</h3>
<p>3.12</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @Morgadoooo on 2025-02-04 12:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "new bookworm make my `uv build` failed pipelines" to "new docker image bookworm-slim makes `uv build` fail" by @Morgadoooo on 2025-02-04 12:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-02-04 12:50</div>
            <div class="timeline-body"><p>What build system and build system settings are you using (the <code>[build-system]</code> table)? Can your (redacted) pyproject.toml?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Morgadoooo">@Morgadoooo</a> on 2025-02-04 12:52</div>
            <div class="timeline-body"><p>Yes sorry forgot to forward it with the initial message</p>
<pre><code class="language-toml">[build-system]
requires = [&quot;hatchling&quot;]
build-backend = &quot;hatchling.build&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-02-04 13:02</div>
            <div class="timeline-body"><p>Unfortunately i can't reproduce this:</p>
<pre><code>$ docker run --rm -it ghcr.io/astral-sh/uv:0.5.27-python3.12-bookworm-slim bash
root@tempid:/# mkdir -p /builds/test
root@tempid:/# cd /builds/test
root@tempid:/builds/test# uv init --lib a_package
Initialized project `a-package` at `/builds/test/a_package`
root@tempid:/builds/test# cd a_package/
root@tempid:/builds/test/a_package# uv build
Building source distribution...
Building wheel from source distribution...
Successfully built dist/a_package-0.1.0.tar.gz
Successfully built dist/a_package-0.1.0-py3-none-any.whl
root@tempid:/builds/test/a_package# cat pyproject.toml 
[project]
name = &quot;a-package&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = []

[build-system]
requires = [&quot;hatchling&quot;]
build-backend = &quot;hatchling.build&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @konstin on 2025-02-04 13:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Morgadoooo">@Morgadoooo</a> on 2025-02-04 13:33</div>
            <div class="timeline-body"><p>The problem might be on our end but just to be sure</p>
<pre><code class="language-bash">docker run --rm -it ghcr.io/astral-sh/uv:0.5.27-python3.12-bookworm-slim bash
Unable to find image 'ghcr.io/astral-sh/uv:0.5.27-python3.12-bookworm-slim' locally
0.5.27-python3.12-bookworm-slim: Pulling from astral-sh/uv
root@3d4d403b95e6:/# mkdir -p test
root@3d4d403b95e6:/# cd test/
root@3d4d403b95e6:/test# uv init --lib a_package
Initialized project `a-package` at `/test/a_package`
root@3d4d403b95e6:/test# cd a_package/
root@3d4d403b95e6:/test/a_package# export UV_CACHE_DIR=.uv-cache
root@3d4d403b95e6:/test/a_package# uv build
Building source distribution...
  × Failed to build `/test/a_package`
  ├─▶ failed to unpack `/test/a_package/.uv-cache/sdists-v7/.tmppBrVL8/a_package-0.1.0/.uv-cache/builds-v0/.tmpY0p9D8/lib/python3.12/site-packages/hatchling/__about__.py`
  ╰─▶ No such file or directory (os error 2) while canonicalizing
      /test/a_package/.uv-cache/sdists-v7/.tmppBrVL8/a_package-0.1.0/.uv-cache/builds-v0/.tmpY0p9D8/lib/python3.12/site-packages/hatchling/a_package-0.1.0/.uv-cache/archive-v0/_2EI4Ur_6bHqMSVqQDuEx/hatchling/__about__.py
</code></pre>
<p>Seems like using <code>export UV_CACHE_DIR=.uv-cache</code> makes the issue appear can reproduce this using the same steps ?</p>
<p>Am I doing something wrong here ?</p>
<p>And FYI</p>
<pre><code class="language-bash"> docker run --rm -it ghcr.io/astral-sh/uv:0.5.26-python3.12-bookworm-slim bash
root@7f52a30394c4:/# mkdir -p test
root@7f52a30394c4:/# cd test/
root@7f52a30394c4:/test# uv init --lib a_package
Initialized project `a-package` at `/test/a_package`
root@7f52a30394c4:/test# cd a_package/
root@7f52a30394c4:/test/a_package# export UV_CACHE_DIR=.uv-cache
root@7f52a30394c4:/test/a_package# uv build
Building source distribution...
Building wheel from source distribution...
Successfully built dist/a_package-0.1.0.tar.gz
Successfully built dist/a_package-0.1.0-py3-none-any.whl
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-04 13:36</div>
            <div class="timeline-body"><p>Are you able to share a minimal package that reproduces this problem? It seems to be something specific to the package. E.g., does it contain any hardlinks or symlinks?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-04 13:37</div>
            <div class="timeline-body"><p>Sorry, nevermind -- it's just <code>uv init --lib</code>? Ok, thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Morgadoooo">@Morgadoooo</a> on 2025-02-04 13:39</div>
            <div class="timeline-body"><p>If you need more details or info on my side (regarding my specific package) I'd be happy to give more details</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> removed by @konstin on 2025-02-04 13:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-02-04 13:41</div>
            <div class="timeline-body"><p>Thanks, <code>UV_CACHE_DIR=.uv-cache</code> was the relevant detail, i can reproduce this now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-04 15:36</div>
            <div class="timeline-body"><p>I assume you can workaround this for now by setting <code>UV_CACHE_DIR</code> to an absolute path? Like <code>UV_CACHE_DIR=$(pwd)/.uv-cache</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-02-04 16:16</div>
            <div class="timeline-body"><p>The problem is that the uv is cache is inside the project, so it gets packaged into the source dist including the hard links in the cache, and then there's the regression I'll fix that we don't support hardlinks in source distributions anymore.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/11221.html">astral-sh/uv#11221</a> on 2025-02-04 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Morgadoooo">@Morgadoooo</a> on 2025-02-04 17:12</div>
            <div class="timeline-body"><p>I can totally do a workaround for now like you said.</p>
<p>For more context in case it can be of some help, using previous uv version we noticed that sometimes the cache <code>.uv-cache</code> caused this issue but &quot;cleaning&quot; the runner cache always solved the problem but not for the new version. That is why I opened the issue.</p>
<p>Now that I understand it better i'll change my cache logic to prevent this.</p>
<p>Thanks for the help guys really appreciate it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-02-04 17:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-02-04 17:38</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:02 UTC
    </footer>
</body>
</html>
