<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repeated markers in `resolution-markers` - astral-sh/uv #9296</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Repeated markers in `resolution-markers`</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/9296">#9296</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-11-20 23:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-20 23:36</div>
            <div class="timeline-body"><p>If you lock:</p>
<pre><code class="language-toml">[project]
name = &quot;project&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.12.0&quot;
dependencies = []

[project.optional-dependencies]
cpu = [
  &quot;torch&gt;=2.5.1&quot;,
  &quot;torchvision&gt;=0.20.1&quot;,
]
cu124 = [
  &quot;torch&gt;=2.5.1&quot;,
  &quot;torchvision&gt;=0.20.1&quot;,
]

[tool.uv]
conflicts = [
  [
    { extra = &quot;cpu&quot; },
    { extra = &quot;cu124&quot; },
  ],
]
environments = [&quot;platform_system != 'Darwin'&quot;, &quot;platform_system == 'Darwin'&quot;]

[tool.uv.sources]
torch = [
  { index = &quot;pytorch-cpu&quot;, extra = &quot;cpu&quot;, marker = &quot;platform_system != 'Darwin'&quot; },
]
torchvision = [
  { index = &quot;pytorch-cpu&quot;, extra = &quot;cpu&quot;, marker = &quot;platform_system != 'Darwin'&quot; },
]

[[tool.uv.index]]
name = &quot;pytorch-cpu&quot;
url = &quot;https://download.pytorch.org/whl/cpu&quot;
explicit = true
</code></pre>
<p>Then the top of the lockfile includes:</p>
<pre><code class="language-toml">resolution-markers = [
    &quot;platform_system != 'Darwin'&quot;,
    &quot;platform_system != 'Darwin'&quot;,
    &quot;platform_system != 'Darwin'&quot;,
    &quot;platform_system == 'Darwin'&quot;,
    &quot;platform_system == 'Darwin'&quot;,
    &quot;platform_system == 'Darwin'&quot;,
]
</code></pre>
<p>And the packages have entries like:</p>
<pre><code class="language-toml">[[package]]
name = &quot;torch&quot;
version = &quot;2.5.1&quot;
source = { registry = &quot;https://pypi.org/simple&quot; }
resolution-markers = [
    &quot;platform_system != 'Darwin'&quot;,
    &quot;platform_system != 'Darwin'&quot;,
    &quot;platform_system != 'Darwin'&quot;,
    &quot;platform_system == 'Darwin'&quot;,
    &quot;platform_system == 'Darwin'&quot;,
    &quot;platform_system == 'Darwin'&quot;,
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-11-20 23:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-11-21 00:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @charliermarsh by @charliermarsh on 2024-11-21 00:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-21 00:50</div>
            <div class="timeline-body"><p>@BurntSushi -- I think this is somehow related to #9289. When we first fork, we create three forks:</p>
<pre><code>DEBUG fork: ResolverEnvironment { kind: Universal { initial_forks: [platform_system != 'Darwin', platform_system == 'Darwin'], markers: platform_system != 'Darwin', exclude: {ConflictItem { package: PackageName(&quot;project&quot;), conflict: Extra(ExtraName(&quot;cu124&quot;)) }, ConflictItem { package: PackageName(&quot;project&quot;), conflict: Extra(ExtraName(&quot;cpu&quot;)) }} } }
DEBUG fork: ResolverEnvironment { kind: Universal { initial_forks: [platform_system != 'Darwin', platform_system == 'Darwin'], markers: platform_system != 'Darwin', exclude: {ConflictItem { package: PackageName(&quot;project&quot;), conflict: Extra(ExtraName(&quot;cu124&quot;)) }} } }
DEBUG fork: ResolverEnvironment { kind: Universal { initial_forks: [platform_system != 'Darwin', platform_system == 'Darwin'], markers: platform_system != 'Darwin', exclude: {ConflictItem { package: PackageName(&quot;project&quot;), conflict: Extra(ExtraName(&quot;cpu&quot;)) }} } }
</code></pre>
<p>But those aren't &quot;differentiated&quot; in their markers.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-11-21 12:38</div>
            <div class="timeline-body"><p>Hmmm. This might be a separate issue from #9289. I think the problem here is that we've traditionally assumed that forks are disjoint based on markers. But with forking based on extras, multiple forks can have the same markers. So we might be able to just de-deduplicate them?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-21 12:46</div>
            <div class="timeline-body"><p>Maybe, I’m not sure though… The forks do represent something different than one another, but it’s not captured by the markers. Is that ok?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-11-21 12:51</div>
            <div class="timeline-body"><p>It should be captured by the conflicts written to the lock file.</p>
<p>I guess I do wonder if perhaps the forks need their markers associated with the specific conflicts that arise for that fork during resolution.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-21 13:58</div>
            <div class="timeline-body"><p>Yeah we may be able to dedupe. It just feels slightly off, so I'm unsure. Maybe just think on it as you solve the deeper issue around transitive deps with conflicts etc.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-07 00:51</div>
            <div class="timeline-body"><p>@BurntSushi -- Do you know how this changes with your PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-12-09 13:28</div>
            <div class="timeline-body"><p>I don't think there are any specific changes. It would, I believe, be pretty straight-forward to include conflict markers in the lock file's <code>resolution-markers</code> now, but I don't know what the full implications of that are. I don't think we have any cases where conflict markers are required in that context.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @BurntSushi by @BurntSushi on 2024-12-09 16:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-12-10 15:10</div>
            <div class="timeline-body"><p>I've thought about this, and while I'm not 100% certain about it, I can't think of a case where we need to record the conflict markers in <code>resolution-markers</code>. So I'm going to submit a PR that just de-duplicates them. At the very least, this can't be <em>more</em> wrong than the status quo.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2024-12-10 19:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2024-12-10 19:58</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 04:39:07 UTC
    </footer>
</body>
</html>
