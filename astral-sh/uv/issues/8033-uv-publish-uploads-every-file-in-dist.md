```yaml
number: 8033
title: "`uv publish` uploads every file in `/dist`"
type: issue
state: closed
author: david-waterworth
labels: []
assignees: []
created_at: 2024-10-09T06:01:24Z
updated_at: 2024-10-12T21:34:00Z
url: https://github.com/astral-sh/uv/issues/8033
synced_at: 2026-01-10T04:45:10Z
```

# `uv publish` uploads every file in `/dist`

---

_Issue opened by @david-waterworth on 2024-10-09 06:01_

I'm not sure if this expected but I noticed `uv publish` uploaded every single file it found in `/dist` to (our private) pypi. On the plus side this surfaced a build script bug (post-build clean step not running) - but it was a little suprising.

The behaviour of `poetry publish` is to only publish the `the package, previously built with the build command` - i.e. (I'm assuming) it uses the version from pyproject.toml to ensure the correct sdist / wheel is uploaded.

---

_Assigned to @konstin by @charliermarsh on 2024-10-09 12:35_

---

_Comment by @TiansuYu on 2024-10-09 15:59_

potentially duplicate to this one https://github.com/astral-sh/uv/issues/7917

---

_Comment by @zanieb on 2024-10-09 16:04_

I don't think this is a duplicate, though this is sort of discussed there.

I think this behavior is pretty reasonable, though maybe we can improve it or have different modes? I think we'd need to read the package from the `pyproject.toml` if we wanted to limit the scope.

---

_Comment by @david-waterworth on 2024-10-10 01:52_

Also wheel/sdist filenames contain a version string that's "canonicalised" and doens't necesarily match the version string in `pyproject.toml` - in order to get the filename of the wheel in my ci process (in which the version is generated by `python-semantic-release` I had to use the `packaging` package, i.e.

```
from packaging.version import Version

def canonicalise(version: str):
    return str(Version(version))
```


---

_Comment by @konstin on 2024-10-10 07:12_

Canonicalizing the name is a requirement from the Python packaging specs (https://packaging.python.org/en/latest/specifications/binary-distribution-format/#escaping-and-unicode)

---

_Comment by @david-waterworth on 2024-10-10 07:40_

Yeah but that’s just the {version} in the package filename though right? The actual package version doesn’t have to be canonical as far as I’m aware?

---

_Comment by @konstin on 2024-10-12 19:01_

The spec says:

> Version numbers should be normalised according to the [Version specifier specification](https://packaging.python.org/en/latest/specifications/version-specifiers/#version-specifiers). Normalised version numbers cannot contain -.

The critical part is that we can't have the `-` in a version because then you can't tell whether it's part of the version or starting the next section in the wheel filename.

---

I'd recommend cleaning the dist directory before doing a new publish and then relying on globs to find your files, basically the workflow below:

```
rm -r dist/
uv build
[other uv build command if you publish a workspace]
[smoke test commands, such as installing the `mypkg-*.tar.gz`/`mypkg-*.whl` in a fresh venv and running `python -c "import mypkg"`]
uv publish
```

Would a workflow like that work for your use case?

---

_Comment by @david-waterworth on 2024-10-12 21:29_

Yeah I understand that - "The canonical public version identifiers MUST comply with the following scheme:" `[N!]N(.N)*[{a|b|rc}N][.postN][.devN]` and the filename needs to contain the canonicalized version for the reason you mention.

But I don't think the package version needs to - i.e. later in the same document

```
Post releases allow a .,-, or _ separator as well as omitting the separator all together. The normal form of this is with the . separator. This allows versions such as 1.2-post2 or 1.2post2 which normalize to 1.2.post2.
```

So it's allowed to have the version in the project.toml to contain `1.2-post2` but the build backend must canonicalise this - so the point I was trying to make is given a valid version, in order to find the corresponding wheel you need to canonicalise it - but you also must not enfore that the version string is canonical in the first place as far as I understand. So you should expect that that matching a wheel to a valid version isn't trivial.

It's no big deal though, I've already updated our build process to ensure that the dist folder was cleaned out (along with ensuring it doesn't publish the same version twice) to ensure uv behaves in the same manner as poetry. So I'm fine if you want to close this as not doing. 

---

_Comment by @konstin on 2024-10-12 21:34_

Thanks - will close.

---

_Closed by @konstin on 2024-10-12 21:34_

---
