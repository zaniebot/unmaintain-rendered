<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python version removal from the Windows registry can race - astral-sh/uv #14714</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Python version removal from the Windows registry can race</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/14714">#14714</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2025-07-18 11:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-18 11:50</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>e.g., this flake in CI</p>
<pre><code>    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    Snapshot: python_install_default-3
    Source: V:\uv:1215
    ───────────────────────────────────────────────────────────────────────────────
    Expression: snapshot
    ───────────────────────────────────────────────────────────────────────────────
    -old snapshot
    +new results
    ────────────┬──────────────────────────────────────────────────────────────────
        2     2 │ ----- stdout -----
        3     3 │ 
        4     4 │ ----- stderr -----
        5     5 │ Searching for Python installations
              6 │+warning: Failed to remove orphan registry key HKCU:/Software/Python/Astral/CPython3.9.18: The system cannot find the file specified. (0x80070002)
        6     7 │ Uninstalled Python 3.13.5 in [TIME]
        7     8 │  - cpython-3.13.5-[PLATFORM] (python, python3, python3.13)
</code></pre>
<h3>Platform</h3>
<p>Windows</p>
<h3>Version</h3>
<p>main</p>
<h3>Python version</h3>
<p>n/a</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2025-07-18 11:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-18 11:51</div>
            <div class="timeline-body"><p>This may be unique to the test suite, we could turn off the registry in some of those tests? but we probably want this to be silent</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-07-18 12:07</div>
            <div class="timeline-body"><p>The warning looks correct in the sense that it sees a key that is indeed dangling, and that we can't do it better as there's no transaction-like concept where we could make the change to the filesystem and the one to the register at the same time. We should just turn the registry off for the tests, we don't want to change a dev machine's registry anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-18 12:12</div>
            <div class="timeline-body"><p>I think if we fail to remove it because it was already removed, we shouldn't report a warning? <code>The system cannot find the file specified. (0x80070002)</code> being the key part of the error.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-18 12:12</div>
            <div class="timeline-body"><p>I don't have any qualms with the warning in general, but I think we could handle this case and just make it concurrency safe</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-18 12:16</div>
            <div class="timeline-body"><p>We actually handle this in other cases, I'll just put up a PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-07-18 12:18</div>
            <div class="timeline-body"><p>I'm assuming that the case we're hitting is a TOCTOU race condition:</p>
<ul>
<li>A removes the files for CPython3.9.18</li>
<li>B sees the key CPython3.9.18</li>
<li>B sees that CPython3.9.18 has no files</li>
<li>A removes the key for CPython3.9.18</li>
<li>B try to removes the key for CPython3.9.18, sees it's already gone</li>
</ul>
<p>So we can handle this both by making this more resilient on removal, and we can fix this by removing the registry key first, and then uninstall.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-07-18 12:19</div>
            <div class="timeline-body"><p>I have the change ready</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-07-18 12:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 03:35:55 UTC
    </footer>
</body>
</html>
