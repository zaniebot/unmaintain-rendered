<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inconsistent behavior with override-dependencies across package sources - astral-sh/uv #9073</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Inconsistent behavior with override-dependencies across package sources</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/9073">#9073</a>
        opened by <a href="https://github.com/philipqueen">@philipqueen</a>
        on 2024-11-12 23:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/philipqueen">@philipqueen</a></div>
            <div class="timeline-body"><p>I'm trying to use the overrides feature to exclude a package download, as described in https://github.com/astral-sh/uv/issues/4422#issuecomment-2254182800</p>
<p>So, I added the following to my <code>pyproject.toml</code>:</p>
<pre><code>[tool.uv]
override-dependencies = [&quot;opencv-python; sys_platform == 'never'&quot;]
</code></pre>
<p>The issue I'm trying to solve is that we depend on multiple pose estimation libraries, including <code>mediapipe</code>, which depends on <code>opencv-python</code>, and <code>ultralytics</code>, which depends on <code>opencv-contrib-python</code>, a superset of <code>opencv-python</code>. <code>opencv-python</code> and <code>opencv-contrib-python</code> conflict with each other, but running <code>pip check</code> with both in the same environment passes.</p>
<p>I tried testing the change with different package sources (based on this https://docs.astral.sh/uv/pip/packages/), and got different results based on different sources:</p>
<p>With <code>uv pip install -e.</code>: when installing from within the project folder, this works as intended - no <code>opencv-python</code>, the override works
With <code>uv pip install 'freemocap @ /Users/philipqueen/Documents/GitHub/freemocap/'</code>: when installing from disk (with the correct branch active), this doesn't work. <code>opencv-python</code> is still downloaded, override doesn't seem to work
With <code>uv pip install &quot;git+https://github.com/freemocap/freemocap@philip/use_uv&quot;</code>: when installing from git (on the correct branch), this doesn't work. <code>opencv-python</code> is still downloaded, override doesn't seem to work.</p>
<p>I may be doing something wrong, or using the feature outside its intended purpose, but it seems like a bug that it works with some package sources and not others.</p>
<p>My goal is that when I publish to PyPI, running <code>uv pip install freemocap</code> doesn't install <code>opencv-python</code>. I really appreciate <code>uv</code> adding support for this reature</p>
<h2>Platform/Version Info</h2>
<p>uv version: uv 0.5.1 (95e7d8702 2024-11-12)
uv platform: mac 12.6.2</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-13 03:00</div>
            <div class="timeline-body"><p>In the pip interface, we don't respect the constraints in the <code>pyproject.toml</code> <em>within</em> an arbitrary project (which is how <code>uv pip install</code> sees <code>freemocap @ /Users/philipqueen/Documents/GitHub/freemocap/</code>. We only discover the constraints from the discovered configuration file, which would be the <code>pyproject.toml</code> in the current working directory or parent directory.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-13 03:01</div>
            <div class="timeline-body"><p>It's not really intended to be part of the published package metadata -- you could view it as local project configuration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2024-11-13 03:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/philipqueen">@philipqueen</a> on 2024-11-13 03:58</div>
            <div class="timeline-body"><p>Thanks for the quick response!</p>
<p>That makes sense as a general approach. Is there any way it could be extended to be part of the published package metadata?</p>
<p>The project I'm working on is designed for direct use by end users. Like a lot of end-user python packages, it's recommended the user creates an environment, and installs just our package in it. It would be great if there were some way to say &quot;when you're installing <code>freemocap</code>, don't install <code>opencv-python</code>&quot;.  If the user already has the conflicting package in their environment, that would be their fault, but now there doesn't seem to be a way around downloading the conflicting packages, uninstalling both, and reinstalling both. This is a big hurdle for non technical users.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw-gts">@notatallshaw-gts</a> on 2024-11-13 14:46</div>
            <div class="timeline-body"><blockquote>
<p>That makes sense as a general approach. Is there any way it could be extended to be part of the published package metadata?</p>
</blockquote>
<p>Package metadata is part of the Python packaging standards (https://packaging.python.org/en/latest/specifications/core-metadata/), such discussion to extend the metadata is held at: https://discuss.python.org/c/packaging/14</p>
<p>I'm not sure if uv could add it's own non-standard metadata, I know PyPI is now doing <em>some</em> metadata validation but not sure if it blocks unknown fields, but what would happen is if these packages got uploaded then uv would start treating packages differently than other installers (pip, poetry, pdm, hatch, etc.) and it would bifurcate the packaging ecosystem.</p>
<p>Though, expect to receive serious pushback around standardizing fields which allow for broken resolutions to be installed. Also be prepared to answer questions like, what if two different packages try to override each other, which one wins?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw-gts">@notatallshaw-gts</a> on 2024-11-13 14:58</div>
            <div class="timeline-body"><blockquote>
<p>The project I'm working on is designed for direct use by end users. Like a lot of end-user python packages, it's recommended the user creates an environment, and installs just our package in it. It would be great if there were some way to say &quot;when you're installing <code>freemocap</code>, don't install <code>opencv-python</code>&quot;. If the user already has the conflicting package in their environment, that would be their fault, but now there doesn't seem to be a way around downloading the conflicting packages, uninstalling both, and reinstalling both. This is a big hurdle for non technical users.</p>
</blockquote>
<p>Your problem is not unique, but I don't know a &quot;best way&quot; to handle this, especially for non-technical users. Here are solutions I have seen:</p>
<ul>
<li>Create scripts that a user &quot;just runs&quot; that installs everything correctly inside an environment: https://github.com/lllyasviel/stable-diffusion-webui-forge?tab=readme-ov-file#installing-forge</li>
<li>Provide a constraints (or lock) file that specifies everything exactly and instruct your users on how to use: https://airflow.apache.org/docs/apache-airflow/stable/installation/installing-from-pypi.html#installation-tools</li>
<li>Have your requirements lock to specific versions: https://community.plotly.com/t/dash-is-planning-to-lock-flask-werkzeug-versions/74829</li>
<li>Provide a single binary executable of your project (there are many different libraries that do this with different trade offs, but the most popular is https://pyinstaller.org/en/stable/ and then perhaps https://nuitka.net/)</li>
</ul>
<p>There is definitely space for someone, like astral / uv ðŸ˜‰, to provide a disruptive solution that better answers how to distribute application-like Python tools to users. But I don't exactly know what the solution would look like.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/philipqueen">@philipqueen</a> on 2024-11-14 17:18</div>
            <div class="timeline-body"><p>@notatallshaw-gts Thanks for the thoughtful answer! It's definitely helping me understand python packaging better. I'll have to dig into the process more to understand fully.</p>
<p>As far as extending project metadata goes, I don't know if that's the best solution, or if what I want could be achieved other ways. As far as broken resolutions go, it's an interesting problem. The only working version of our software fails <code>pip check</code> (or <code>uv pip check</code>), and the versions that pass the check don't run. Of course, you could say this is ultimately a problem with opencv's python packaging, but they haven't responded to issues about it yet. So we're stuck working around a major player in the ecosystem.</p>
<p>If it's true the problem we're facing is deeper than Python can currently handle, it may be best to go the <code>curl {installation_script} | sh</code> route. I've never liked the security risk of that approach - it's easy enough for me to trust that the Rust Foundation is handling the security here well, much harder for me to trust myself to make such a script and avoid all the security pitfalls.</p>
<p>We've also tried the executable methods, and while the binary installers have failed, PyApp has been very promising. It's not perfect yet, but it does get some of our users over the technical hump.</p>
<p>Thanks again for the help. I think this is a real trouble in the python packaging ecosystem, and it would be amazing if the astral folks could find a way to handle it gracefully.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:28:19 UTC
    </footer>
</body>
</html>
