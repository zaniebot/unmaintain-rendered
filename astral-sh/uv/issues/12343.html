<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[Bug] venv created by uv works not well with pyo3 - astral-sh/uv #12343</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>[Bug] venv created by uv works not well with pyo3</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/12343">#12343</a>
        opened by <a href="https://github.com/clouds56">@clouds56</a>
        on 2025-03-20 16:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/clouds56">@clouds56</a> on 2025-03-20 16:34</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Like #10598, when build project using pyo3 with uv-managed python, but for windows.
It would build successfully but could not run since no python.dll found</p>
<p>env:</p>
<pre><code>VIRTUAL_ENV=D:\S\agent\.venv
</code></pre>
<p>log for build</p>
<pre><code>[pyo3-ffi 0.24.0] cargo:rustc-link-lib=pythonXY:python313
[pyo3-ffi 0.24.0] cargo:rustc-link-search=native=C:\Users\clouds\AppData\Local\Programs\Python\Python313\libs
</code></pre>
<p>dependencies of built exe</p>
<pre><code>ldd target\debug\deps\engine-2d69d82a736905e2.exe
        ntdll.dll =&gt; /c/WINDOWS/SYSTEM32/ntdll.dll (0x7ffc7f660000)
        KERNEL32.DLL =&gt; /c/WINDOWS/System32/KERNEL32.DLL (0x7ffc7ea40000)
        KERNELBASE.dll =&gt; /c/WINDOWS/System32/KERNELBASE.dll (0x7ffc7cbe0000)
        apphelp.dll =&gt; /c/WINDOWS/SYSTEM32/apphelp.dll (0x7ffc796c0000)
        bcryptprimitives.dll =&gt; /c/WINDOWS/System32/bcryptprimitives.dll (0x7ffc7d330000)
        ucrtbase.dll =&gt; /c/WINDOWS/System32/ucrtbase.dll (0x7ffc7d1e0000)
        VCRUNTIME140.dll =&gt; /c/WINDOWS/SYSTEM32/VCRUNTIME140.dll (0x7ffc5fae0000)
        userenv.dll =&gt; /c/WINDOWS/SYSTEM32/userenv.dll (0x7ffc7bcf0000)
        RPCRT4.dll =&gt; /c/WINDOWS/System32/RPCRT4.dll (0x7ffc7e920000)
        python313.dll =&gt; not found
        api-ms-win-crt-math-l1-1-0.dll =&gt; /c/Program Files/Microsoft Visual Studio/2022/BuildTools/Common7/IDE/api-ms-win-crt-math-l1-1-0.dll (?)
        api-ms-win-crt-runtime-l1-1-0.dll =&gt; /c/Program Files/Microsoft Visual Studio/2022/BuildTools/Common7/IDE/api-ms-win-crt-runtime-l1-1-0.dll (?)
        api-ms-win-crt-stdio-l1-1-0.dll =&gt; /c/Program Files/Microsoft Visual Studio/2022/BuildTools/Common7/IDE/api-ms-win-crt-stdio-l1-1-0.dll (?)
        api-ms-win-crt-locale-l1-1-0.dll =&gt; /c/Program Files/Microsoft Visual Studio/2022/BuildTools/Common7/IDE/api-ms-win-crt-locale-l1-1-0.dll (?)
        api-ms-win-crt-heap-l1-1-0.dll =&gt; /c/Program Files/Microsoft Visual Studio/2022/BuildTools/Common7/IDE/api-ms-win-crt-heap-l1-1-0.dll (?)
</code></pre>
<p>Shall we copy <code>python313.dll</code> to <code>.env/Scripts</code> like what <code>python -m venv .venv</code> does (see also https://github.com/pypa/virtualenv/issues/1050#issuecomment-305678969)</p>
<h3>Platform</h3>
<p>Windows 11 x86_64</p>
<h3>Version</h3>
<p>0.6.0</p>
<h3>Python version</h3>
<p>Python 3.13.2</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @clouds56 on 2025-03-20 16:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/buptsad">@buptsad</a> on 2025-03-29 20:42</div>
            <div class="timeline-body"><p>Got similar error, and solved by manually copy the dll into the Scripts folder. It surely requires a copy or hard link to python dll.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">windows</span> added by @zanieb on 2025-04-01 21:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-04-01 21:20</div>
            <div class="timeline-body"><p>cc @geofft</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Svalorzen">@Svalorzen</a> on 2025-04-02 11:32</div>
            <div class="timeline-body"><p>Same exact issue here, on multiple Mac machines: I'm compiling a C++ project using CMake, with the following script:</p>
<pre><code>    # Create empty venv
    find_program (UV_PATH uv REQUIRED)
    execute_process(
        COMMAND &quot;${UV_PATH}&quot; venv &quot;${VENV_FOLDER}&quot; --python ${PYTHON_VERSION} --managed-python
    )

    # Find Python and related dev libraries that match the venv
    # Note that headers should be provided by uv, but might be in the uv local cache folder (not in the venv itself)
    # You can print ${Python3_INCLUDE_DIRS} to make sure it's not using system-wise ones.
    set(Python3_ROOT_DIR &quot;${VENV_FOLDER}&quot;)
    find_package(Python3 COMPONENTS Interpreter Development REQUIRED)
</code></pre>
<p>CMake correctly identifies the CPython library in <code>.local</code>, but <code>otool -D</code> shows how the final executables are searching the library in the wrong install path:</p>
<pre><code>dyld[95593]: Library not loaded: /install/lib/libpython3.13.dylib
</code></pre>
<p>One weird thing is that on one mac everything seems to work correctly, but that mac doesn't have a root <code>/install</code> folder; perhaps that has something to do with it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/clouds56">@clouds56</a> on 2025-04-02 14:17</div>
            <div class="timeline-body"><p>@Svalorzen for mac you could see this PR https://github.com/astral-sh/uv/pull/10629/files#diff-59b5f06938f826cd9b0657938f1cb0b1f2f112b2fb0689bee13ae918d5538820R514-R534
<code>install_name_tool</code> might be run on built executable, see also https://stackoverflow.com/questions/33991581/install-name-tool-to-update-a-executable-to-search-for-dylib-in-mac-os-x</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-04-02 14:29</div>
            <div class="timeline-body"><p>@Svalorzen please open a new issue instead of adding a different case to an existing one</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:26 UTC
    </footer>
</body>
</html>
