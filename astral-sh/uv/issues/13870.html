<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add local lock for parallel commands - astral-sh/uv #13870</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add local lock for parallel commands</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/13870">#13870</a>
        opened by <a href="https://github.com/leviska">@leviska</a>
        on 2025-06-05 19:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/leviska">@leviska</a></div>
            <div class="timeline-body">Summary
<p>Running <code>uv sync</code> twice in the same repo can cause issues with installing, and also if cache is clear can download files twice.
I suggest adding optional lock file, so if another instance of uv is already syncing this repo/downloading files, current instance will wait for that to finish (similar to how <code>cargo</code> does this)</p>
<p>The problem becomes larger in cluster environments (we use <code>ray</code>), where this can be done hundreds of times simultaneously</p>
Example
<p>Create a pyproject, add a few dependencies and run <code>uv cache clean &amp;&amp; rm -rf .venv &amp;&amp; (uv sync | uv sync)</code>
I had this command even fail with</p>
<pre><code>failed to rename file from [...]/.venv/lib/python3.12/site-packages/.tmpkICzSS/package.json.orig to [...]/.venv/lib/python3.12/site-packages/jupyterlab_widgets-3.0.13.data/data/share/jupyter/labextensions/@jupyter-widgets/jupyterlab-manager/schemas/@jupyter-widgets/jupyterlab-manager/package.json.orig: No such file or directory (os error 2)
</code></pre>
<p>Also this command will download files twice</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by <a href="https://github.com/leviska">@leviska</a> on 2025-06-05 19:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-06-05 19:16</div>
            <div class="timeline-body"><p>For the latter case, we&#x27;re fixing this in <a href="https://github.com/astral-sh/uv/pull/13869">astral-sh/uv#13869</a>.</p>
<p>For a cluster, I recommend a <code>uv sync</code> ahead of time and reusing the cache and/or venv instead of spawning <code>uv sync</code> for each task. We&#x27;re unlikely to add a global lock, the current architecture allows running e.g. downloads and builds in separate projects to run in parallel without incurring high complexity for it (cargo is different to Python here in that it has small downloads, while all builds are isolated).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/leviska">@leviska</a> on 2025-06-05 19:20</div>
            <div class="timeline-body"><p>We&#x27;re reusing the venv by running all the tasks from the same directory with <code>uv run</code>, but it itself syncs...
It works fine when cache is filled (I think our parallelism is slower than uv syncing), but breaks on clear run
Thanks for the link to the issue! Local lock should fix our issue too</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/leviska">@leviska</a> on 2025-06-05 19:20</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:38:56 UTC
    </footer>
</body>
</html>
