<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>When running project with uv run, homebrew-installed dynamic libraries on MacOS are not found. - astral-sh/uv #7764</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>When running project with uv run, homebrew-installed dynamic libraries on MacOS are not found.</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/7764">#7764</a>
        opened by <a href="https://github.com/tcwalther">@tcwalther</a>
        on 2024-09-28 18:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tcwalther">@tcwalther</a></div>
            <div class="timeline-body"><p>I'm using torchaudio to load audio files, which under the hood uses ffmpeg. On MacOS with Apple Silicon, ffmpeg's libraries will be installed to /opt/homebrew/lib.</p>
<p>When I run my script regularly with Python's good old venv and <code>python scripts/worker.py</code>, torchaudio successfully finds ffmpeg in /opt/homebrew/lib. When I run my script with <code>uv run worker</code>, whereas <code>worker</code> is a defined script in <code>pyproject.toml</code>, torchaudio can't find ffmpeg and says that the search paths are:</p>
<ul>
<li><code>$PROJECT_DIR/.venv/lib/python3.10/site-packages/torch/lib/libavutil.56.dylib</code></li>
<li><code>/usr/lib/libavutil.56.dylib</code></li>
<li><code>libavutil.56.dylib</code></li>
<li><code>/usr/local/lib/libavutil.56.dylib</code></li>
<li><code>/usr/lib/libavutil.56.dylib</code></li>
</ul>
<p>(not sure why /usr/lib is duplicated; I'm just copying the output)</p>
<p>The file, however, is located at <code>/opt/homebrew/lib/libavutil.56.dylib</code>. Why is the dyld search path different when running my script via <code>uv run</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-29 15:26</div>
            <div class="timeline-body"><p>Is the Python interpreter different? i.e. are you using a Brew interpreter in one case and a uv-managed interpreter in the other?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tcwalther">@tcwalther</a> on 2024-10-11 13:41</div>
            <div class="timeline-body"><p>@zanieb yes, that is probably the case. Thanks for pointing that out.</p>
<p>I solved it by symlinking ffmpeg into /usr/local/lib. Not perfect but works. I also looked at pixi, which I know uses uv under the hood, but found it a bit confusing tbh.</p>
<p>Would you consider adding /opt/homebrew/lib to the search path? Given homebrew's widespread adoption I believe it would be very helpful, and at least in my eyes it would be expected behaviour.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-25 20:24</div>
            <div class="timeline-body"><p>I'm pretty hesitant to add a special-case like that for all macOS users. We can definitely consider it though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sonnen-coviance">@sonnen-coviance</a> on 2024-10-25 21:00</div>
            <div class="timeline-body"><p>Also experiencing this issue. I think having a simple workaround documented may be helpful. It would be nice if <code>uv</code> could somehow account for this, maybe with a flag during <code>uv python install</code></p>
<p>A minimal example to cause this error, make a project with <code>uv</code> that uses the <code>filemagic</code> python library, which relies on the C lib <code>libmagic</code>.</p>
<p>Install libmagic with brew</p>
<pre><code class="language-Shell">brew install libmagic
</code></pre>
<p>Bootstrap a UV project</p>
<pre><code class="language-Shell">uv init
uv add filemagic
uv python install
</code></pre>
<p>in your <code>hello.py</code> add the following</p>
<pre><code class="language-Python">import magic


with magic.Magic() as m:
    print(&quot;This will cause an error&quot;)

</code></pre>
<p>Now run the file.</p>
<pre><code class="language-Shell">uv run hello.py
</code></pre>
<p>And see the error caused at runtime:</p>
<pre><code class="language-Shell">Traceback (most recent call last):
  File &quot;&lt;dir&gt;/example/hello.py&quot;, line 1, in &lt;module&gt;
    import magic
  File &quot;&lt;dir&gt;/example/.venv/lib/python3.11/site-packages/magic/__init__.py&quot;, line 18, in &lt;module&gt;
    from magic.identify import Magic, MagicError
  File &quot;&lt;dir&gt;/example/.venv/lib/python3.11/site-packages/magic/identify.py&quot;, line 16, in &lt;module&gt;
    from magic import api
  File &quot;&lt;dir&gt;/example/.venv/lib/python3.11/site-packages/magic/api.py&quot;, line 22, in &lt;module&gt;
    raise ImportError('Unable to find magic library')
ImportError: Unable to find magic library
</code></pre>
<p>If you now uninstall the <code>uv</code> instance of python and install it via homebrew the error no longer occurs.</p>
<pre><code class="language-Shell">uv python uninstall 3.11
rm -rf .venv
brew install python@3.11
uv sync
uv run hello.py
</code></pre>
<p>The reason this works for homebrew installed versions of python is because the setup script mutates <code>Lib/ctypes/macholib/dyld.py</code> see here: https://github.com/Homebrew/homebrew-core/blob/7bf4109b2502839ff5facd1982522c51709749e1/Formula/p/python%403.11.rb#L192-L199</p>
<p>The default values can be found in <code>cpython</code> source code here:
https://github.com/python/cpython/blob/c5b99f5c2c5347d66b9da362773969c531fb6c85/Lib/ctypes/macholib/dyld.py#L29-L34</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dryan">@dryan</a> on 2024-11-12 16:51</div>
            <div class="timeline-body"><p>Via #6971, <code>export DYLD_FALLBACK_LIBRARY_PATH=&quot;$HOMEBREW_PREFIX/lib&quot;</code> in my <code>.zshrc</code> has solved this issue for me (with libcairo).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/helmut-hoffer-von-ankershoffen">@helmut-hoffer-von-ankershoffen</a> on 2024-12-23 07:39</div>
            <div class="timeline-body"><p>You can add the fallback library path within python. Make sure you call before the <code>import</code> loading a module that depends on a homebrew installed library.</p>
<pre><code>def patch_for_homebrew_libs():
    os.environ[&quot;DYLD_FALLBACK_LIBRARY_PATH&quot;] = (
        f&quot;{os.getenv('HOMEBREW_PREFIX', '/opt/homebrew')}/lib/&quot;
    )
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tibbe">@tibbe</a> on 2025-01-29 13:25</div>
            <div class="timeline-body"><blockquote>
<p>Via <a href="https://github.com/astral-sh/uv/issues/6971">#6971</a>, <code>export DYLD_FALLBACK_LIBRARY_PATH=&quot;$HOMEBREW_PREFIX/lib&quot;</code> in my <code>.zshrc</code> has solved this issue for me (with libcairo).</p>
</blockquote>
<p>This doesn't work for me. It seems that macOS protections filter out <code>DYLD_FALLBACK_LIBRARY_PATH</code> (https://developer.apple.com/library/archive/documentation/Security/Conceptual/System_Integrity_Protection_Guide/RuntimeProtections/RuntimeProtections.html). For example, if I set <code>DYLD_FALLBACK_LIBRARY_PATH</code> in <code>~/.zshrc</code> and start a new shell it's not in <code>env</code>. Same in a terminal launched in VSCode.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Iamrodos">@Iamrodos</a> on 2025-08-24 07:13</div>
            <div class="timeline-body"><blockquote>
<p>You can add the fallback library path within python. Make sure you call before the <code>import</code> loading a module that depends on a homebrew installed library.</p>
<pre><code>def patch_for_homebrew_libs():
    os.environ[&quot;DYLD_FALLBACK_LIBRARY_PATH&quot;] = (
        f&quot;{os.getenv('HOMEBREW_PREFIX', '/opt/homebrew')}/lib/&quot;
    )
</code></pre>
</blockquote>
<p>Migrated to uv and hit the same issue as everyone else here. This is the only thing that would solve it for me. Thanks</p>
<pre><code class="language-py"> if sys.platform == &quot;darwin&quot; and os.getenv(&quot;HOMEBREW_PREFIX&quot;):
        os.environ[&quot;DYLD_FALLBACK_LIBRARY_PATH&quot;] = (
            f&quot;{os.getenv('HOMEBREW_PREFIX', '/opt/homebrew')}/lib/&quot;
        )
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:27:23 UTC
    </footer>
</body>
</html>
