<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hardlinking dependencies causes issues when trying to delete a `.venv` via python on Windows - astral-sh/uv #7918</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>hardlinking dependencies causes issues when trying to delete a <code>.venv</code> via python on Windows</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/7918">#7918</a>
        opened by <a href="https://github.com/linde12">@linde12</a>
        on 2024-10-04 09:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/linde12">@linde12</a></div>
            <div class="timeline-body">Scenario
<p>I have a script in a venv (EnvA) that:</p>
<ul>
<li>creates a new uv venv (EnvB)</li>
<li>installs some packages to the new venv (EnvB)</li>
<li>runs a script in that venv(EnvB)</li>
<li>tries to delete EnvB via the EnvA script.</li>
</ul>
<p>However the venv deletion fails on Windows since there are overlapping dependencies between the two environments (both depend on e.g. <code>markupsafe</code> which contains <code>pyd</code> files that are automatically loaded by python)</p>
<p>This is because UV uses hardlinks to the uv cache, so deleting that file fails since it is hardlinked to the file in uv cache and that file (.pyd) is automatically loaded by python.</p>
<p>Switching to using symlinks solves the issue, but i don&#x27;t have control over how users will run this script. What is the decision behind using hardlinks by default on windows? I have little control over how the application runs <code>uv</code> (done by 3rd party library) so this is causing issues for my users. I guess i could patch the environment variable <code>UV_LINK_MODE</code> env var before invoking the 3rd party lib, but that feels like a hack and i&#x27;m not sure if it will work well.</p>
Minimally reproducible example
<ol>
<li>Create a new venv: <code>uv venv .venv</code></li>
<li>Install <code>markupsafe</code> into that venv: <code>uv pip install markupsafe</code></li>
<li>Create a <code>main.py</code> with contents like so:</li>
</ol>
<pre><code>import subprocess
import shutil
import os

os.mkdir(&quot;testdir&quot;)
subprocess.run([&quot;uv&quot;, &quot;venv&quot;, &quot;.venv&quot;], cwd=&quot;./testdir&quot;)
subprocess.run([&quot;uv&quot;, &quot;pip&quot;, &quot;install&quot;, &quot;markupsafe&quot;], cwd=&quot;./testdir&quot;)
shutil.rmtree(&quot;testdir&quot;)
</code></pre>
<ol>
<li>Run <code>main.py</code> via <code>python main.py</code></li>
<li>Notice that it will fail on Windows: <code>PermissionError: [WinError 5] Access is denied: &#x27;testdir\\.venv\\Lib\\site-packages\\markupsafe\\_speedups.cp310-win_amd64.pyd&#x27;</code></li>
<li>Try changing link mode (e.g. via environment variable) to symlink and see that it then works when running <code>python main.py</code></li>
</ol>
<p>I think it boils down to python automatically loading <code>.pyd</code> files in your venv and then uv hardlinking to the cache, and when the file is loaded/has open file descriptors windows will not allow us to delete the hardlink. This is not only an issue for only markupsafe, but all libraries that use <code>.pyd</code> files, this was just an example.</p>
tl;dr
<p>if you have a python script, with any dependency containing a <code>.pyd</code> file, and this script tries to delete a <code>.venv</code> containing a hardlink to the same <code>.pyd</code> file then Windows will throw you an &quot;Access is denied&quot; error.</p>
Version
<p>uv: <code>0.4.17</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/linde12">@linde12</a> on 2024-10-04 13:06</div>
            <div class="timeline-body"><blockquote>
<p>I guess i could patch the environment variable UV_LINK_MODE env var before invoking the 3rd party lib, but that feels like a hack and i&#x27;m not sure if it will work well.</p>
</blockquote>
<p>symlink mode won&#x27;t work either (unless developer mode or admin) but copy can be a workaround i guess :-/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-04 13:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">windows</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-04 13:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cache</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-04 13:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-04 13:12</div>
            <div class="timeline-body"><p>I appreciate the clear write-up but I&#x27;m not sure that this is a bug and I&#x27;m also not sure that there&#x27;s anything for us to do here. I guess we could &quot;always&quot; copy <code>.pyd</code> files on Windows, even if hardlinks are enabled?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-04 13:21</div>
            <div class="timeline-body"><p>It seems weird that you can&#x27;t delete any hardlink when an fd is open? It seems like they should just stop you from deleting the last one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/linde12">@linde12</a> on 2024-10-04 13:50</div>
            <div class="timeline-body"><blockquote>
<p>I appreciate the clear write-up but I&#x27;m not sure that this is a bug and I&#x27;m also not sure that there&#x27;s anything for us to do here. I guess we could &quot;always&quot; copy <code>.pyd</code> files on Windows, even if hardlinks are enabled?</p>
</blockquote>
<p>Thanks. Yeah i&#x27;m not sure either, just wanted to bring it up. It&#x27;s a foot-shotgun turned rabbit hole that i encountered.</p>
<p>Copying would solve the problem, at the cost of disk space and performance (?) I&#x27;m not sure if that&#x27;s better in favor of being more compatible with how it works using pip/virtualenv, or if this can be considered an acceptable discrepancy? Maybe it&#x27;s fine if it is documented somehow, but its also kind of very specific.</p>
<blockquote>
<p>It seems weird that you can&#x27;t delete any hardlink when an fd is open? It seems like they should just stop you from deleting the last one.</p>
</blockquote>
<p>Right?! I was confused as well, i guess its windows-related :shrug:</p>
<p>@charliermarsh @zanieb
Thanks for all your hard work by the way, <code>uv</code> is <strong>awesome</strong>!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bluss">@bluss</a> on 2024-10-04 15:42</div>
            <div class="timeline-body"><p>Thanks @linde12, you explained some of the problems I&#x27;ve seen in windows CI. I&#x27;ll test the link mode as a solution to them.. (edit: yes :slightly_smiling_face: )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-04 16:21</div>
            <div class="timeline-body"><p>It sort of feels like we should just force copy of these files :/ I don&#x27;t love it though</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kahojyun">@kahojyun</a> on 2024-10-04 16:21</div>
            <div class="timeline-body"><p>Unable to reproduce on my computer. I can delete the whole uv cache folder successfully with matplotlib window opened, and the <code>File Locksmith</code> utility from powertoys shows that lots of pyd files under matplotlib and numpy are in use.
This might be related to other factors like Windows version or Windows defender scanning the newly created venv.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/linde12">@linde12</a> on 2024-10-04 16:38</div>
            <div class="timeline-body"><p>@kahojyun mind running the example just to make sure? I was able to reproduce it on the two different windows 10 (i don&#x27;t run windows myself and can&#x27;t test on win11) machines, both when running mingw bash and regular powershell. One with python 3.8 and the other python 3.10 (just to make sure it wasn&#x27;t python acting up).</p>
<p>I used <code>strace</code> (mingw) and could see that the <code>.pyd</code> was being loaded (regardless if i imported <code>markupsafe</code> or not) and as soon as that happened i could delete the entire <code>.venv</code> except the <code>.pyd</code> file.</p>
<p>Maybe also, to be extra sure, set the <code>UV_LINK_MODE</code> to <code>hardlink</code> explicitly? E.g. <code>UV_LINK_MODE=hardlink strace python main.py</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kahojyun">@kahojyun</a> on 2024-10-04 16:59</div>
            <div class="timeline-body"><p>Tried with powershell 7 on win11:</p>
<pre><code>~\uvtest
‚ùØ rm env:UV_CACHE_DIR

~\uvtest
‚ùØ $env:UV_LINK_MODE=&quot;hardlink&quot;

~\uvtest
‚ùØ $env:UV_PYTHON=&quot;3.8&quot;

~\uvtest
‚ùØ uv venv .venv
Using CPython 3.8.20
Creating virtual environment at: .venv
Activate with: .venv\Scripts\activate

~\uvtest
‚ùØ uv pip install markupsafe
Resolved 1 package in 1.16s
Prepared 1 package in 90ms
Installed 1 package in 10ms
 + markupsafe==2.1.5

~\uvtest
‚ùØ nvim main.py

~\uvtest via üêç v3.12.6 took 9s
‚ùØ uv run main.py
Using CPython 3.8.20
Creating virtual environment at: .venv
Activate with: .venv\Scripts\activate
Audited 1 package in 1ms

~\uvtest via üêç v3.12.6
‚ùØ .\.venv\Scripts\python.exe .\main.py
Using CPython 3.8.20
Creating virtual environment at: .venv
Activate with: .venv\Scripts\activate
Resolved 1 package in 7ms
Installed 1 package in 10ms
 + markupsafe==2.1.5
</code></pre>
<p>I don&#x27;t have mingw and bash to try the exact command.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/linde12">@linde12</a> on 2024-10-04 17:02</div>
            <div class="timeline-body"><p>Interesting, maybe the .pyd in question isnt being loaded</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/linde12">@linde12</a> on 2024-10-04 17:17</div>
            <div class="timeline-body"><p>Here is a repo with two actions. One running win-11 and one win-10. It uses the example, but now i also import and use <code>markupsafe</code> (because it worked fine when i did not import it apparently, not sure why i got different behaviors)</p>
<p>https://github.com/linde12/uv-py-hardlink-windows</p>
<p><img src="https://github.com/user-attachments/assets/905df2d2-b7ca-4cf3-bcbb-5b454e2ca0b4" alt="image"></p>
<p><img src="https://github.com/user-attachments/assets/28642dc8-4ab2-4245-b126-c02f1503f0fb" alt="image"></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kahojyun">@kahojyun</a> on 2024-10-04 19:41</div>
            <div class="timeline-body"><blockquote>
<p>Here is a repo with two actions. One running win-11 and one win-10. It uses the example, but now i also import and use <code>markupsafe</code> (because it worked fine when i did not import it apparently, not sure why i got different behaviors)</p>
<p>https://github.com/linde12/uv-py-hardlink-windows</p>
</blockquote>
<p>I tried tweaking these workflows and found that <a href="https://github.com/kahojyun/uv-py-hardlink-windows/actions/runs/11185535371">running with pwsh instead of bash exited normally</a>. Weird</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/linde12">@linde12</a> on 2024-10-04 21:11</div>
            <div class="timeline-body"><p>Weird yeah... https://github.com/linde12/uv-py-hardlink-windows/actions/runs/11187011758/job/31103231396</p>
<p>Without strace it works? I&#x27;m too tired for this... I&#x27;m almost sure i observed the same issue in pwsh too, but i might be wrong</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chrisrodrigue">@chrisrodrigue</a> on 2024-10-05 01:05</div>
            <div class="timeline-body"><blockquote>
<p>It sort of feels like we should just force copy of these files :/ I don&#x27;t love it though</p>
</blockquote>
<p>Even though copying seems suboptimal I think it‚Äôs actually a good working solution.</p>
<p>(Along with the omission of Bash, Microsoft‚Äôs decision to restrict symlink creation to elevated users in Windows seems like it was deliberately intended to break OS interoperability.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chrisrodrigue">@chrisrodrigue</a> on 2024-10-05 01:11</div>
            <div class="timeline-body"><p>Symlinks made in WSL also don‚Äôt work‚Ä¶ could have been a cool workaround :/</p>
<p>https://blog.trailofbits.com/2024/02/12/why-windows-cant-follow-wsl-symlinks/</p>
<p>Although‚Ä¶</p>
<blockquote>
<p>One last thing to point out is that when Bill Demirkapi tested this behavior, he noticed that Windows could follow WSL‚Äôs symlinks when they were created with a relative path but not with an absolute path. On all systems I tested, Windows couldn‚Äôt follow any symlinks created by WSL. So there is still some mystery left here to investigate.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/linde12">@linde12</a> on 2024-10-06 15:30</div>
            <div class="timeline-body"><p>I modified my script slightly to compare to my real usecase.</p>
<p>I create a <code>noxfile.py</code> which installs markupsafe and runs some script that uses it, then i run <code>nox -f noxfile.py</code> and try to delete the <code>testdir</code> after this. This fails, even without <code>strace</code> and using pwsh: https://github.com/linde12/uv-py-hardlink-windows/actions/runs/11203062664/job/31139882483</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kahojyun">@kahojyun</a> on 2024-10-06 17:24</div>
            <div class="timeline-body"><p>It seems that <a href="https://superuser.com/questions/678357/how-to-delete-windows-ntfs-hard-link-mklink-h-while-original-is-in-use">if any program opens the file without <code>FILE_SHARE_DELETE</code> flag, all of the hardlink-peers can&#x27;t be deleted</a>. If we want to avoid this kind of error we have to use symlink or copy.</p>
<p>(I&#x27;m okay with copy by default as long as <a href="https://devblogs.microsoft.com/engineering-at-microsoft/copy-on-write-in-win32-api-early-access/">Microsoft brings automatic CoW to Dev Drive</a>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/linde12">@linde12</a> on 2024-10-06 17:55</div>
            <div class="timeline-body"><blockquote>
<p>It seems that <a href="https://superuser.com/questions/678357/how-to-delete-windows-ntfs-hard-link-mklink-h-while-original-is-in-use">if any program opens the file without <code>FILE_SHARE_DELETE</code> flag, all of the hardlink-peers can&#x27;t be deleted</a>. If we want to avoid this kind of error we have to use symlink or copy.</p>
<p>(I&#x27;m okay with copy by default as long as <a href="https://devblogs.microsoft.com/engineering-at-microsoft/copy-on-write-in-win32-api-early-access/">Microsoft brings automatic CoW to Dev Drive</a>.)</p>
</blockquote>
<p>I was actually reading the same post the other day, but was confused as to why we were seeing different behaviors. Especially when i was using <code>strace</code> :eyes: Copying the <code>.pyd</code> might be the least bad fix IMO</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/parched">@parched</a> on 2025-12-03 00:56</div>
            <div class="timeline-body"><p>We&#x27;re hitting this too, we have a windows machine where end-to-end testing regularly creates then deletes a lot of venvs but we also have a python process permanently running that uses all the same packages. The venv tear down is failing leaving all these half empty venvs full of <code>pyd</code>s</p>
<p>What&#x27;s needed to get this issue fixed? As far as I understand, based on the links above, uv shouldn&#x27;t expect hardlinking to work on Windows. Should I submit a PR changing the default <code>link-mode</code> to <code>copy</code> on Windows?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:34:29 UTC
    </footer>
</body>
</html>
