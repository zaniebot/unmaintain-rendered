<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feat: Create a cached lock file for `uv run` with scripts - astral-sh/uv #9688</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Feat: Create a cached lock file for `uv run` with scripts</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/9688">#9688</a>
        opened by <a href="https://github.com/notatallshaw">@notatallshaw</a>
        on 2024-12-06 16:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-12-06 16:12</div>
            <div class="timeline-body"><p>This is a follow up to https://github.com/astral-sh/uv/issues/7538, I wanted to make a clear feature request. Basically I don't want <code>uv run ...</code> to resolve when it's already done it once, unless I pass something like <code>uv run --upgrade ...</code>.</p>
<p>The current behavior is problematic when the network is having transient issues or is very slow, for example a firewall decides to start blocking access to a package then <code>uv run</code> fails even though it previously installed all the dependencies, or if the network is very slow and is randomly dropping packets then every time you run <code>uv run</code> you end up with it saying <code>Раи Resolving dependencies...</code> for several seconds.</p>
<p>In general, I think the expected user experience (perhaps incorrectly) of <code>uv run ...</code> is there is no network activity required unless absolutely necessary.</p>
<p>FYI, I'm not currently impacted by this issue, so it's not a big priority for me, but I have seen it in the past, and in general it does feel like a better user experience.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/FishAlchemist">@FishAlchemist</a> on 2024-12-06 16:26</div>
            <div class="timeline-body"><p>If it's not a frequent problem, would adding <code>--offline</code> to force UV to not access the network be a solution?</p>
<pre><code>--offline
Disable network access.

When disabled, uv will only use locally cached data and locally available files.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-12-06 16:37</div>
            <div class="timeline-body"><blockquote>
<p>If it's not a frequent problem, would adding <code>--offline</code> to force UV to not access the network be a solution?</p>
</blockquote>
<p>Yeah, that's what I do: https://github.com/astral-sh/uv/issues/7538#issuecomment-2427886315.</p>
<p>But that means I have to remember whether I've run a script before or not, and if I'm wrong I either get an error for the dependencies not being installed or if I'm having a network issue a slow resolution or a network error. So it's mental overhead and/or poor user experience.</p>
<p>And my understanding is for some users it is a frequent issue (consider some users might be permanently on spotty internet connections).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-12-06 16:45</div>
            <div class="timeline-body"><p>Oh, I should mention this extends to <code>uv tool run</code> / <code>uvx</code>, I actually avoid that command because of this and instead use <code>uv tool install</code>, but there's no equivalent simple workaround for <code>uv run</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/FishAlchemist">@FishAlchemist</a> on 2024-12-06 16:52</div>
            <div class="timeline-body"><p>@notatallshaw If the network is unstable, I've encountered environments where I've been throttled. In such cases, I usually set the default offline mode to true and only specify <code>--no-offline</code> when I need to access the network.
Although <code>--no-offline</code> is not explicitly shown, it's a feature that the CLI happens to support.
If <code>offline = true</code> can be configured in a user-level settings file, then a cached lock file is unnecessary for my use case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Feat: Create a cached lock file for `uv run`" to "Feat: Create a cached lock file for `uv run` with scripts" by @konstin on 2024-12-06 16:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-12-06 16:56</div>
            <div class="timeline-body"><blockquote>
<p>Although <code>--no-offline</code> is not explicitly shown, it's a feature that the CLI happens to support.</p>
</blockquote>
<p>Yeah, I didn't even know that existed, it's not a user feature if it's not documented anywhere. It's also still not a great user experience, as again it puts the mental overhead on the user to remember if something has been run before or not.</p>
<p>I'm really not making the case that I need this, I'm making the case that the current behavior is a bad user experience for some and there's at least no documented solution.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/FishAlchemist">@FishAlchemist</a> on 2024-12-06 17:10</div>
            <div class="timeline-body"><p>@notatallshaw I have a few questions about locking dependencies.
If you lock the dependencies for <code>uv run script</code>, when should the lock file be considered outdated?
If it's permanent, should users be aware that they're using outdated dependencies?
Additionally, if dependencies are locked, how can we prevent behavioral inconsistencies caused by different dependency versions on different devices?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-12-06 17:31</div>
            <div class="timeline-body"><blockquote>
<p>If you lock the dependencies for <code>uv run script</code>, when should the lock file be considered outdated?</p>
</blockquote>
<p>I would prefer never, unless something forced the change (e.g. a change in requirements, providing <code>--upgrade</code>, or a change in uv's cache format). When I &quot;run&quot; something on my computer I don't expect the code it's running to change unless I've done something to change it (changed requirments, explicitly asked to update requirements, updated uv, etc.).</p>
<blockquote>
<p>If it's permanent, should users be aware that they're using outdated dependencies?</p>
</blockquote>
<p>This is an interesting user experience question, and I'm not sure of the answer. If I was designing uv I would give options to warn on outdated or automatically re-resolve each time, but not make them default. But I understand the uv team might have different design goals.</p>
<blockquote>
<p>Additionally, if dependencies are locked, how can we prevent behavioral inconsistencies caused by different dependency versions on different devices?</p>
</blockquote>
<p>I don't understand the context of this question. Since when is <code>uv run</code>  supposed to be consistent across different machines?</p>
<p>If I run something on Windows machine I might require a dependency that someone running on Linux won't machine won't, and so my code exection may be different. And if I run something one machine at one time and a different machine at a different time it can now resolve to different versions. And if I run something on two machines at the same time they might resolve to different versions due to CDN or other caching.</p>
<p>Are there some guarantees uv is providing here that I'm not aware of?</p>
<p>And moreso, what about behavioral inconsistencies of running the same script on the same machine 10 minutes apart from each other?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @konstin on 2024-12-06 17:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/FishAlchemist">@FishAlchemist</a> on 2024-12-06 17:47</div>
            <div class="timeline-body"><blockquote>
<p>if dependencies are locked, how can we prevent behavioral inconsistencies caused by different dependency versions on different devices?</p>
</blockquote>
<p>Actually, I mean if the cache time is set very long, even on the same operating system and instruction set architecture, the dependency versions obtained by running the <code>uv run script</code> at different times will be different. Different dependency versions may cause differences in execution results, unless the initial dependency descriptions are written well enough.</p>
<p>For example, if a dependency on NumPy is specified without a version constraint, running <code>uv run script</code> in February would install version 1 of NumPy, but running it in August might install version 2.</p>
<pre><code class="language-py"># dependencies = [
#     &quot;numpy&quot;,
# ]
</code></pre>
<p>Edit:
Note that the two executions of the uv run script were on different devices</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-12-06 17:53</div>
            <div class="timeline-body"><p>Agreed, and I would find this surprising that the script which I have been running successfully for months suddently starts failing because a dependency updated even though I never did anything that would indicate I want new dependencies.</p>
<p>Worse, what if it was a transative dependency, so even if I pinned all my main depdnencies I now need to start pinning transative dependencies in the dependencies block?</p>
<p>I understand the solution here I propose might not align the uv team's design goals, but the problems and user experience issues I pose here I think are quite real, maybe there is a better solution to them though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-12-06 18:04</div>
            <div class="timeline-body"><p>Here's me thinking out loud about a solution that would resolve both concerns, say I run <code>uv run --lock my-script.py</code> and if one didn't exist it would create a <code>my-script.py.lock</code> and if it did exist it would use that lock file for <code>my-script.py</code> dependencies <em>if</em> they hadn't changed, else it would update the <code>my-script.py.lock</code>.</p>
<p>This behavior is explicit rather than implicit and a user could take that lock file to different machines. Again just thinking out loud, so not tied to any of the specifics of this proposal.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-12-11 21:47</div>
            <div class="timeline-body"><p>Note we're also discussing this in https://github.com/astral-sh/uv/issues/6318</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-12-11 22:03</div>
            <div class="timeline-body"><p>Minor note regarding <code>--no-offline</code></p>
<blockquote>
<p>Yeah, I didn't even know that existed, it's not a user feature if it's not documented anywhere.</p>
</blockquote>
<p>We have hidden inversions of nearly all of our boolean flags.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-12-27 13:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-01-08 20:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-01-08 20:34</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 04:30:18 UTC
    </footer>
</body>
</html>
