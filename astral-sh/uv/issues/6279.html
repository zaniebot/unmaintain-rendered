<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Requirements from underscored extras are accidentally included as package dependencies - astral-sh/uv #6279</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Requirements from underscored extras are accidentally included as package dependencies</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/6279">#6279</a>
        opened by <a href="https://github.com/adaamz">@adaamz</a>
        on 2024-08-20 21:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/adaamz">@adaamz</a> on 2024-08-20 21:55</div>
            <div class="timeline-body"><p>Hello,
I would like to ask/report one issue with <code>uv pip compile</code> when using &quot;private&quot; extras (underscored extras).</p>
<p>It happens on new uv <code>0.3.0</code> and also the previous one <code>0.2.37</code> on linux mint with python 3.9 in venv.</p>
<p>My humble tip that causing this issue is that <code>our-internal-package</code> has some underscored extra <code>_sqlalchemy</code> that the metadata parser just skips and takes all _sqlalchemy's dependencies as the base deps for the package (because it was parsing the section before):</p>
<pre><code>Requires-Dist: python-dateutil &gt;=2.6.1
Requires-Dist: pyyaml &gt;=3.12
Provides-Extra: _sqlalchemy    &lt;!---- this line probably gets ignored
Requires-Dist: sqlalchemy &lt;=1.4.31,&gt;=1.3.18 ; extra == '_sqlalchemy'
Requires-Dist: zope.sqlalchemy &gt;=1.0 ; extra == '_sqlalchemy'
</code></pre>
<details>
<summary>METADATA taken from wheel of our-internal-package</summary>

<pre><code>Metadata-Version: 3.1
Name: our-internal-package
Version: 4.1.0
Summary: xxx
Home-page: https://gitlab.hidden.com/group/our-internal-pacakge
Author: we
Author-email: our@email.com
License: UNKNOWN
Platform: UNKNOWN
Classifier: Private :: Do Not Upload
Classifier: Development Status :: 5 - Production/Stable
Classifier: Intended Audience :: Developers
Classifier: Operating System :: OS Independent
Classifier: Programming Language :: Python
Classifier: Programming Language :: Python :: 3
Requires-Python: &gt;=3.9
Description-Content-Type: text/markdown
Requires-Dist: python-dateutil &gt;=2.6.1
Requires-Dist: pyyaml &gt;=3.12
Provides-Extra: _sqlalchemy
Requires-Dist: sqlalchemy &lt;=1.4.31,&gt;=1.3.18 ; extra == '_sqlalchemy'
Requires-Dist: zope.sqlalchemy &gt;=1.0 ; extra == '_sqlalchemy'
Provides-Extra: config
Requires-Dist: jsonschema &gt;=2.6.0 ; extra == 'config'
Provides-Extra: encryption
Requires-Dist: pycryptodome ; extra == 'encryption'
Provides-Extra: fastapi
Requires-Dist: fastapi ; extra == 'fastapi'
Provides-Extra: injector
Requires-Dist: sphinxcontrib-napoleon &gt;=0.6.1 ; extra == 'injector'
Provides-Extra: logutils
Requires-Dist: transaction &gt;=2.2.1 ; extra == 'logutils'
Requires-Dist: flask &gt;=1.0.1 ; extra == 'logutils'
Requires-Dist: pyyaml &gt;=3.12 ; extra == 'logutils'
Requires-Dist: opentracing-instrumentation &gt;=2.4.1 ; extra == 'logutils'
</code></pre>
</details>

<details>
<summary>requirements.in for our app</summary>

<pre><code>--extra-index-url https://gitlab.hidden.com/api/v4/groups/7/-/packages/pypi/simple
our-internal-package[encryption]
</code></pre>
</details>
<details>
<summary>generated requrements.txt</summary>

<pre><code># This file was autogenerated by uv via the following command:
#    uv pip compile requirements.in -o requirements.txt --no-cache
greenlet==3.0.3
    # via sqlalchemy
our-internal-package==4.1.0
    # via -r requirements.in
packaging==24.1
    # via zope-sqlalchemy
pycryptodome==3.20.0
    # via our-internal-package
python-dateutil==2.9.0.post0
    # via our-internal-package
pyyaml==6.0.2
    # via our-internal-package
setuptools==73.0.1
    # via
    #   zope-interface
    #   zope-sqlalchemy
six==1.16.0
    # via python-dateutil
sqlalchemy==1.4.31
    # via
    #   our-internal-package
    #   zope-sqlalchemy
transaction==4.0
    # via zope-sqlalchemy
zope-interface==7.0.1
    # via
    #   transaction
    #   zope-sqlalchemy
zope-sqlalchemy==3.1
    # via our-internal-package
</code></pre>
</details>
<details>
<summary>verbose logs with removed warnings about skipping files</summary>

<pre><code>DEBUG uv 0.2.37
DEBUG Starting Python discovery for any Python
DEBUG Looking for exact match for request any Python
DEBUG Searching for Python interpreter in system path
DEBUG Found `cpython-3.9.13-linux-x86_64-gnu` at `/xxx/.direnv/python-3.9.13/bin/python3` (active virtual environment)
DEBUG Using Python 3.9.13 interpreter at /xxx/.direnv/python-3.9.13/bin/python3 for builds
DEBUG Using request timeout of 30s
DEBUG Solving with installed Python version: 3.9.13
DEBUG Adding direct dependency: our-internal-package*
DEBUG Adding direct dependency: our-internal-package[encryption]*
DEBUG No cache entry for: https://gitlab.hidden.com/api/v4/groups/7/-/packages/pypi/simple/our-internal-package/
DEBUG Checking netrc for credentials for https://gitlab.hidden.com/api/v4/groups/7/-/packages/pypi/simple/our-internal-package/
DEBUG Found credentials in netrc file for https://gitlab.hidden.com/api/v4/groups/7/-/packages/pypi/simple/our-internal-package/
DEBUG Searching for a compatible version of our-internal-package[encryption] (*)
DEBUG Selecting: our-internal-package==4.1.0 [preference] (our_internal_package-4.1.0-py3-none-any.whl)
DEBUG Adding transitive dependency for our-internal-package==4.1.0: our-internal-package==4.1.0
DEBUG Adding transitive dependency for our-internal-package==4.1.0: our-internal-package[encryption]==4.1.0
DEBUG Searching for a compatible version of our-internal-package (==4.1.0)
DEBUG No cache entry for: https://gitlab.hidden.com/api/v4/groups/7/-/packages/pypi/files/e08f3cf9386c46b36a0a5f74b44594d168ec51181b9df4bc7458b615acad4172/our_internal_package-4.1.0-py3-none-any.whl#sha256=e08f3cf9386c46b36a0a5f74b44594d168ec51181b9df4bc7458b615acad4172
DEBUG Selecting: our-internal-package==4.1.0 [preference] (our_internal_package-4.1.0-py3-none-any.whl)
DEBUG Adding transitive dependency for our-internal-package==4.1.0: python-dateutil&gt;=2.6.1
DEBUG Adding transitive dependency for our-internal-package==4.1.0: pyyaml&gt;=3.12
DEBUG Adding transitive dependency for our-internal-package==4.1.0: sqlalchemy&gt;=1.3.18, &lt;=1.4.31
DEBUG Adding transitive dependency for our-internal-package==4.1.0: zope-sqlalchemy&gt;=1.0
DEBUG Searching for a compatible version of our-internal-package[encryption] (==4.1.0)
DEBUG Selecting: our-internal-package==4.1.0 [preference] (our_internal_package-4.1.0-py3-none-any.whl)
DEBUG Adding transitive dependency for our-internal-package==4.1.0: pycryptodome*
DEBUG No cache entry for: https://gitlab.hidden.com/api/v4/groups/7/-/packages/pypi/simple/python-dateutil/
DEBUG No cache entry for: https://gitlab.hidden.com/api/v4/groups/7/-/packages/pypi/simple/pyyaml/
DEBUG No cache entry for: https://gitlab.hidden.com/api/v4/groups/7/-/packages/pypi/simple/sqlalchemy/
DEBUG No cache entry for: https://gitlab.hidden.com/api/v4/groups/7/-/packages/pypi/simple/zope-sqlalchemy/
DEBUG No cache entry for: https://gitlab.hidden.com/api/v4/groups/7/-/packages/pypi/simple/pycryptodome/
DEBUG Searching for a compatible version of python-dateutil (&gt;=2.6.1)
DEBUG Selecting: python-dateutil==2.9.0.post0 [preference] (python_dateutil-2.9.0.post0-py2.py3-none-any.whl)
DEBUG No cache entry for: https://files.pythonhosted.org/packages/ec/57/56b9bcc3c9c6a792fcbaf139543cee77261f3651ca9da0c93f5c1221264b/python_dateutil-2.9.0.post0-py2.py3-none-any.whl.metadata
DEBUG No cache entry for: https://files.pythonhosted.org/packages/af/20/5f29ec45462360e7f61e8688af9fe4a0afae057edfabdada662e11bf97e7/pycryptodome-3.20.0-cp35-abi3-manylinux_2_17_x86_64.manylinux2014_x86_64.whl.metadata
DEBUG No cache entry for: https://files.pythonhosted.org/packages/86/36/875db361ce975a226456388f3bc0f060db95191b7b011025c8c97d3888c5/zope.sqlalchemy-3.1-py3-none-any.whl.metadata
DEBUG Adding transitive dependency for python-dateutil==2.9.0.post0: six&gt;=1.5
DEBUG No cache entry for: https://gitlab.hidden.com/api/v4/groups/7/-/packages/pypi/simple/six/
DEBUG Searching for a compatible version of pyyaml (&gt;=3.12)
DEBUG Selecting: pyyaml==6.0.2 [preference] (PyYAML-6.0.2-cp39-cp39-manylinux_2_17_x86_64.manylinux2014_x86_64.whl)
DEBUG No cache entry for: https://files.pythonhosted.org/packages/54/2a/f247980111202ef39d7d3b3fb5591c6e5af4a351d36d9440a799ceacb1ca/SQLAlchemy-1.4.31-cp39-cp39-manylinux_2_5_x86_64.manylinux1_x86_64.manylinux_2_17_x86_64.manylinux2014_x86_64.whl.metadata
DEBUG No cache entry for: https://files.pythonhosted.org/packages/3d/32/e7bd8535d22ea2874cef6a81021ba019474ace0d13a4819c2a4bce79bd6a/PyYAML-6.0.2-cp39-cp39-manylinux_2_17_x86_64.manylinux2014_x86_64.whl.metadata
DEBUG Searching for a compatible version of sqlalchemy (&gt;=1.3.18, &lt;=1.4.31)
DEBUG Selecting: sqlalchemy==1.4.31 [preference] (SQLAlchemy-1.4.31-cp39-cp39-manylinux_2_5_x86_64.manylinux1_x86_64.manylinux_2_17_x86_64.manylinux2014_x86_64.whl)
DEBUG Adding transitive dependency for sqlalchemy==1.4.31: greenlet{(python_full_version &gt;= '3' and platform_machine == 'AMD64') or (python_full_version &gt;= '3' and platform_machine == 'WIN32') or (python_full_version &gt;= '3' and platform_machine == 'aarch64') or (python_full_version &gt;= '3' and platform_machine == 'amd64') or (python_full_version &gt;= '3' and platform_machine == 'ppc64le') or (python_full_version &gt;= '3' and platform_machine == 'win32') or (python_full_version &gt;= '3' and platform_machine == 'x86_64')}&lt;0.4.17 | &gt;0.4.17
DEBUG Searching for a compatible version of zope-sqlalchemy (&gt;=1.0)
DEBUG Selecting: zope-sqlalchemy==3.1 [preference] (zope.sqlalchemy-3.1-py3-none-any.whl)
DEBUG Adding transitive dependency for zope-sqlalchemy==3.1: packaging*
DEBUG Adding transitive dependency for zope-sqlalchemy==3.1: setuptools*
DEBUG Adding transitive dependency for zope-sqlalchemy==3.1: sqlalchemy&gt;=1.1, &lt;1.4.0 | &gt;1.4.0, &lt;1.4.1 | &gt;1.4.1, &lt;1.4.2 | &gt;1.4.2, &lt;1.4.3 | &gt;1.4.3, &lt;1.4.4 | &gt;1.4.4, &lt;1.4.5 | &gt;1.4.5, &lt;1.4.6 | &gt;1.4.6
DEBUG Adding transitive dependency for zope-sqlalchemy==3.1: transaction&gt;=1.6.0
DEBUG Adding transitive dependency for zope-sqlalchemy==3.1: zope-interface&gt;=3.6.0
DEBUG No cache entry for: https://gitlab.hidden.com/api/v4/groups/7/-/packages/pypi/simple/greenlet/
DEBUG Searching for a compatible version of pycryptodome (*)
DEBUG Selecting: pycryptodome==3.20.0 [preference] (pycryptodome-3.20.0-cp35-abi3-manylinux_2_17_x86_64.manylinux2014_x86_64.whl)
DEBUG No cache entry for: https://gitlab.hidden.com/api/v4/groups/7/-/packages/pypi/simple/setuptools/
DEBUG No cache entry for: https://gitlab.hidden.com/api/v4/groups/7/-/packages/pypi/simple/packaging/
DEBUG No cache entry for: https://gitlab.hidden.com/api/v4/groups/7/-/packages/pypi/simple/zope-interface/
DEBUG No cache entry for: https://gitlab.hidden.com/api/v4/groups/7/-/packages/pypi/simple/transaction/
DEBUG Searching for a compatible version of six (&gt;=1.5)
DEBUG Selecting: six==1.16.0 [preference] (six-1.16.0-py2.py3-none-any.whl)
DEBUG No cache entry for: https://files.pythonhosted.org/packages/d9/5a/e7c31adbe875f2abbb91bd84cf2dc52d792b5a01506781dbcf25c91daf11/six-1.16.0-py2.py3-none-any.whl.metadata
DEBUG No cache entry for: https://files.pythonhosted.org/packages/fa/42/0c8b2fdf178bfa0a4d79eddafa1cf2d8ff0686d266347efbfd65edf63708/transaction-4.0-py3-none-any.whl.metadata
DEBUG No cache entry for: https://files.pythonhosted.org/packages/08/aa/cc0199a5f0ad350994d660967a8efb233fe0416e4639146c089643407ce6/packaging-24.1-py3-none-any.whl.metadata
DEBUG No cache entry for: https://files.pythonhosted.org/packages/3e/13/960dcfb8845d3921408fc7c18e262e6a802ddf230af25ae756cce96f5e50/zope.interface-7.0.1-cp39-cp39-manylinux_2_5_x86_64.manylinux1_x86_64.manylinux_2_17_x86_64.manylinux2014_x86_64.whl.metadata
DEBUG No cache entry for: https://files.pythonhosted.org/packages/07/6a/0270e295bf30c37567736b7fca10167640898214ff911273af37ddb95770/setuptools-73.0.1-py3-none-any.whl.metadata
DEBUG Searching for a compatible version of greenlet{(python_full_version &gt;= '3' and platform_machine == 'AMD64') or (python_full_version &gt;= '3' and platform_machine == 'WIN32') or (python_full_version &gt;= '3' and platform_machine == 'aarch64') or (python_full_version &gt;= '3' and platform_machine == 'amd64') or (python_full_version &gt;= '3' and platform_machine == 'ppc64le') or (python_full_version &gt;= '3' and platform_machine == 'win32') or (python_full_version &gt;= '3' and platform_machine == 'x86_64')} (&lt;0.4.17 | &gt;0.4.17)
DEBUG Selecting: greenlet==3.0.3 [preference] (greenlet-3.0.3-cp39-cp39-manylinux_2_24_x86_64.manylinux_2_28_x86_64.whl)
DEBUG Adding transitive dependency for greenlet==3.0.3: greenlet==3.0.3
DEBUG Adding transitive dependency for greenlet==3.0.3: greenlet{(python_full_version &gt;= '3' and platform_machine == 'AMD64') or (python_full_version &gt;= '3' and platform_machine == 'WIN32') or (python_full_version &gt;= '3' and platform_machine == 'aarch64') or (python_full_version &gt;= '3' and platform_machine == 'amd64') or (python_full_version &gt;= '3' and platform_machine == 'ppc64le') or (python_full_version &gt;= '3' and platform_machine == 'win32') or (python_full_version &gt;= '3' and platform_machine == 'x86_64')}==3.0.3
DEBUG Searching for a compatible version of greenlet{(python_full_version &gt;= '3' and platform_machine == 'AMD64') or (python_full_version &gt;= '3' and platform_machine == 'WIN32') or (python_full_version &gt;= '3' and platform_machine == 'aarch64') or (python_full_version &gt;= '3' and platform_machine == 'amd64') or (python_full_version &gt;= '3' and platform_machine == 'ppc64le') or (python_full_version &gt;= '3' and platform_machine == 'win32') or (python_full_version &gt;= '3' and platform_machine == 'x86_64')} (==3.0.3)
DEBUG Selecting: greenlet==3.0.3 [preference] (greenlet-3.0.3-cp39-cp39-manylinux_2_24_x86_64.manylinux_2_28_x86_64.whl)
DEBUG No cache entry for: https://files.pythonhosted.org/packages/af/05/b7e068070a6c143f34dfcd7e9144684271b8067e310f6da68269580db1d8/greenlet-3.0.3-cp39-cp39-manylinux_2_24_x86_64.manylinux_2_28_x86_64.whl.metadata
DEBUG Searching for a compatible version of greenlet (==3.0.3)
DEBUG Selecting: greenlet==3.0.3 [preference] (greenlet-3.0.3-cp39-cp39-manylinux_2_24_x86_64.manylinux_2_28_x86_64.whl)
DEBUG Searching for a compatible version of packaging (*)
DEBUG Selecting: packaging==24.1 [preference] (packaging-24.1-py3-none-any.whl)
DEBUG Searching for a compatible version of setuptools (*)
DEBUG Selecting: setuptools==73.0.1 [preference] (setuptools-73.0.1-py3-none-any.whl)
DEBUG Searching for a compatible version of transaction (&gt;=1.6.0)
DEBUG Selecting: transaction==4.0 [preference] (transaction-4.0-py3-none-any.whl)
DEBUG Adding transitive dependency for transaction==4.0: zope-interface*
DEBUG Searching for a compatible version of zope-interface (&gt;=3.6.0)
DEBUG Selecting: zope-interface==7.0.1 [preference] (zope.interface-7.0.1-cp39-cp39-manylinux_2_5_x86_64.manylinux1_x86_64.manylinux_2_17_x86_64.manylinux2014_x86_64.whl)
DEBUG Adding transitive dependency for zope-interface==7.0.1: setuptools*
DEBUG Tried 12 versions: greenlet 1, packaging 1, pycryptodome 1, python-dateutil 1, pyyaml 1, setuptools 1, six 1, sqlalchemy 1, our-internal-package 1, transaction 1, zope-interface 1, zope-sqlalchemy 1
DEBUG Split specific environment resolution took 1.735s
</code></pre>
</details>

<p>edit 2024-08-21: enclosed uv logs to code block for better readability</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-20 21:56</div>
            <div class="timeline-body"><p>Thanks for the report. Do you know if that's standards compliant? (I kind of presume not)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/adaamz">@adaamz</a> on 2024-08-20 22:03</div>
            <div class="timeline-body"><p>@zanieb I suppose it is not standard: https://packaging.python.org/en/latest/specifications/core-metadata/#provides-extra-multiple-use</p>
<p>Maybe the whole section can be ignored instead of that one line? pip-compile just ignores whole requires section of this underscored extras.</p>
<p>Do you think there is any other way how to add marker/anchor/fragment for dependencies?</p>
<p>e.g. our setup.cfg looks something like this</p>
<pre><code>[options]
packages = find_namespace:
package_dir = = src
include_package_data = true
python_requires = &gt;= 3.9
install_requires =
    python-dateutil&gt;=2.6.1
    pyyaml&gt;=3.12

[options.packages.find]
where = src

[options.extras_require]
common =
    %(_sqlalchemy)s
    %(config)s

db =
    %(_sqlalchemy)s


_sqlalchemy =
    sqlalchemy&gt;=1.3.18,&lt;=1.4.31
    zope.sqlalchemy&gt;=1.0

config =
    jsonschema&gt;=2.6.0
</code></pre>
<p>We don't want to expose the <code>_sqlalchemy</code> to the public (but if it's the only way... we can use it) and we want to use this fragment in other extras as reference.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-20 23:35</div>
            <div class="timeline-body"><p>Interesting. Thanks for the details. We'll need to chat about this as a team.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">compatibility</span> added by @zanieb on 2024-08-20 23:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-20 23:43</div>
            <div class="timeline-body"><blockquote>
<p>If a value would be invalid following the rules for Name: in any core metadata version, the user SHOULD be warned and the value ignored to avoid ambiguity. Tools MAY choose to raise an error when reading an invalid name for older metadata versions.</p>
</blockquote>
<p>Hm. &quot;ignored&quot; is kind of ambiguous.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-21 03:27</div>
            <div class="timeline-body"><p>Does this happen with the latest version of <code>pip-tools</code> / <code>pip</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/adaamz">@adaamz</a> on 2024-08-21 08:40</div>
            <div class="timeline-body"><p>@zanieb Yes, we use <code>pip-compile</code> latest version currently and we are trying to switch to <code>uv pip compile</code> ðŸ™‚</p>
<pre><code>(python-3.9.13) adam@adpc:~/xxx/test_minimal$ pip-compile --version
pip-compile, version 7.4.1
(python-3.9.13) adam@adpc:~/xxx/test_minimal$ pip-compile requirements.in
WARNING: --strip-extras is becoming the default in version 8.0.0. To silence this warning, either use --strip-extras to opt into the new default or use --no-strip-extras to retain the existing behavior.
#
# This file is autogenerated by pip-compile with Python 3.9
# by the following command:
#
#    pip-compile requirements.in
#
--extra-index-url https://gitlab.hidden.com/api/v4/groups/7/-/packages/pypi/simple

our-internal-package[encryption]==4.1.0
    # via -r requirements.in
pycryptodome==3.20.0
    # via tm-pythonlib
python-dateutil==2.9.0.post0
    # via tm-pythonlib
pyyaml==6.0.2
    # via tm-pythonlib
six==1.16.0
    # via python-dateutil
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/6324.html">astral-sh/uv#6324</a> on 2024-08-21 13:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-08-21 13:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-21 13:44</div>
            <div class="timeline-body"><p>Just confirming that this a bug on our end.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-21 13:48</div>
            <div class="timeline-body"><p>Well, I guess it's a bit nuanced. Those are technically invalid extra names, and so the spec says we &quot;should&quot; ignore them (per @zanieb's comment above), which just means those dependencies should <em>never</em> be enabled.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-21 13:49</div>
            <div class="timeline-body"><p>But normalizing the <code>_sqlalchemy</code> extra to <code>sqlalchemy</code> is a bug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/adaamz">@adaamz</a> on 2024-08-21 14:00</div>
            <div class="timeline-body"><p>@charliermarsh I think it is not normalizing.</p>
<p>In <code>our-internal-package</code> there is <em>extras</em> with name <code>_sqlalchemy</code> that has these requirements:</p>
<pre><code>    sqlalchemy&gt;=1.3.18,&lt;=1.4.31
    zope.sqlalchemy&gt;=1.0
</code></pre>
<p>and they get it into main requirements of the package - next to these</p>
<pre><code>install_requires =
    python-dateutil&gt;=2.6.1
    pyyaml&gt;=3.12
</code></pre>
<p>The wheel file I attached brings me some idea how the <code>uv</code> gets the dependencies (from the <code>METADATA</code> file), but maybe i'm completely wrong there ðŸ™‚</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-21 14:04</div>
            <div class="timeline-body"><p>To clarify, you <em>want</em> <code>sqlalchemy</code> <em>not</em> to be installed, right?</p>
<p>You should try running with <code>uv pip compile --no-strip-extras</code> to visualize the extras that are being attached.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/adaamz">@adaamz</a> on 2024-08-21 14:22</div>
            <div class="timeline-body"><p>Yes, for this case <code>sqlalchemy</code> shouldn't be installed because any extras with sqlalchemy is not required (even <code>_sqlalchemy</code> itself).</p>
<pre><code># This file was autogenerated by uv via the following command:
#    uv pip compile --no-strip-extras requirements.in -o requirements.txt
greenlet==3.0.3
    # via sqlalchemy
our-internal-package[encryption]==4.1.0
    # via -r requirements.in
packaging==24.1
    # via zope-sqlalchemy
pycryptodome==3.20.0
    # via our-internal-package
python-dateutil==2.9.0.post0
    # via our-internal-package
pyyaml==6.0.2
    # via our-internal-package
setuptools==73.0.1
    # via
    #   zope-interface
    #   zope-sqlalchemy
six==1.16.0
    # via python-dateutil
sqlalchemy==1.4.31
    # via
    #   our-internal-package
    #   zope-sqlalchemy
transaction==4.0
    # via zope-sqlalchemy
zope-interface==7.0.1
    # via
    #   transaction
    #   zope-sqlalchemy
zope-sqlalchemy==3.1
    # via our-internal-package
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-21 14:28</div>
            <div class="timeline-body"><p>Is there any way you can create a small reproduction that I can run locally?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/adaamz">@adaamz</a> on 2024-08-21 17:35</div>
            <div class="timeline-body"><p>I created simple local package via <code>setup.py</code>, used it in <code>requirements.in</code> and also attached output of <code>uv</code> (<em>requirements_uv.txt</em>) and <code>pip-compile</code> (<em>requirements.txt</em>).</p>
<p><a href="https://github.com/user-attachments/files/16695883/test_minimal.zip">test_minimal.zip</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-21 20:53</div>
            <div class="timeline-body"><p>Awesome, thanks so much.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-08-22 00:02</div>
            <div class="timeline-body"><p>Looking at the minimal example, I guess this is a bug in uv because uv is resolving for an extra that was never requested?</p>
<p>But this concept of a &quot;private&quot; extra certainly isn't within the spec, itâ€™s not clear to me if you are expecting any behaviour from pip / pip-tools / setuptools right now, but if it has an invalid name according to the spec, it might just break one day.</p>
<p>For &quot;private&quot; extras behaviour you could have in an somewhat officially supported way, one thing you can do is use a custom build hook (with Hatch or other backends) and specify which extras you want available for editable installs and which extras you want available for the published package, e.g. apache-airflow does this with their <code>devel</code> extras. Perhaps thereâ€™s even a backend that supports this out of the box (Iâ€™ve never gone looking sorry).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-22 00:06</div>
            <div class="timeline-body"><p>Yeah I generally agree -- there's some uv bug here, but those extras are also not compliant.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-22 00:09</div>
            <div class="timeline-body"><p>I <em>think</em> what's happening here is that we fail to parse <code>_sqlalchemy</code> since it's an invalid extra, and by default we then treat the marker <code>extra == &quot;_sqlalchemy&quot;</code> as <code>true</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-22 00:10</div>
            <div class="timeline-body"><p>I will try to invert that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-08-22 00:14</div>
            <div class="timeline-body"><p>I think assuming invalid markers are always true or always false has been considered before: https://github.com/astral-sh/uv/pull/3681</p>
<p>But https://github.com/astral-sh/uv/pull/5898 reverted it, it was reported in https://github.com/astral-sh/uv/issues/6085 but that issue was fixed by specifically supporting <code>in</code>.</p>
<p>If I'm following all of these issues right.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-22 00:15</div>
            <div class="timeline-body"><p>Yeah, I was gonna try just fixing this case of an invalid extra.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-22 00:16</div>
            <div class="timeline-body"><p>Honestly it would be easier to do what setuptools does and cast it to <code>sqlalchemy</code> by stripping the leading <code>_</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-08-22 00:18</div>
            <div class="timeline-body"><p>You already do some &quot;fix ups&quot; to versions and requirements which don't conform to standards, for uv's use case of being drop in replacement, makes sense to do it for invalid extas ðŸ™ƒ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/6395.html">astral-sh/uv#6395</a> on 2024-08-22 00:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-08-22 01:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-08-22 01:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:21 UTC
    </footer>
</body>
</html>
