<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv sync` with  `--prerelease` fails unexpectedly - astral-sh/uv #9395</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`uv sync` with  `--prerelease` fails unexpectedly</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/9395">#9395</a>
        opened by <a href="https://github.com/dariocurr">@dariocurr</a>
        on 2024-11-24 13:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dariocurr">@dariocurr</a> on 2024-11-24 13:49</div>
            <div class="timeline-body"><p>I’m working with the following setup:
1.	library A: currently in development with version <code>0.2.0.dev2</code>
2.	library B: expands the functionality of library A and depends explicitly on <code>A==0.2.0.dev2</code>. Library B has version <code>0.1.0.dev1</code>
3.	application: relies on library B and specifies the dependency <code>B==0.1.0.dev1</code></p>
<p>When running <code>uv sync</code>, all <code>--prerelease</code> options (<code>if-necessary</code>, <code>explicit</code>, <code>if-necessary-or-explicit</code>) fail unless the <code>allow</code> one.
The issue arises because there’s a pre-release version in a third-party library dependency.</p>
<p>Since library B explicitly specifies <code>A==0.2.0.dev2</code>, I would expect the <code>explicit</code> option to handle this scenario.
My intent is to avoid globally allowing pre-release versions (<code>allow</code>) across all dependencies and instead restrict it to cases where they are explicitly required, even if these are third-party libraries.</p>
<p>This behaviour works as expected with <code>pip</code>, where such explicit versioning doesn’t cause any issues.</p>
<p>uv version: <code>0.5.4</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Uv sync `--prerelease` missing option" to "Uv sync with  `--prerelease` fails unexpectedly" by @dariocurr on 2024-11-24 13:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-24 16:27</div>
            <div class="timeline-body"><p>I believe this is working as intended. <code>A==0.2.0.dev2</code> enables pre-releases for <code>A</code>, but not for whatever the transitive dependency is. I think you'd want to either use <code>allow</code>, or add the transitive dependency as a first-party dependency with a pre-release marker.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2024-11-24 16:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">resolver</span> added by @samypr100 on 2024-11-24 19:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dariocurr">@dariocurr</a> on 2024-11-25 06:58</div>
            <div class="timeline-body"><p>Using allow would mean enabling pre-release versions for all dependencies, which introduces unintended side effects and it's very dangerous.
For instance, if library A has a dependency like <code>X&gt;=1.1,&lt;1.2</code>, this approach could select <code>1.1.5.dev5</code> instead of the latest stable version <code>1.1.4 for X</code>.
These <em>all-or-nothing</em> options of pre-releases are not viable solutions in our scenario.</p>
<p>I strongly believe the <code>if-necessary</code> option should address this use case (as <code>pip</code> does)</p>
<p>Alternatively, <code>uv</code> could consider adding a new option, such as <code>if-necessary-with-third-party</code>, to explicitly handle situations where third-party dependencies have <strong>explicit</strong> pre-release requirements (<code>==</code>) specified in the dependency chain. If I explicitly specified it, I am explicitly accepting it</p>
<p>Such an enhancement would ensure that explicit versioning requirements are respected without globally relaxing constraints for all dependencies</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-11-25 15:37</div>
            <div class="timeline-body"><p>I do think the uv option is badly named, to better describe what it does it should be something like <code>if-only-prereleases</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dariocurr">@dariocurr</a> on 2025-01-07 08:21</div>
            <div class="timeline-body"><p>Any updates on this? This is critical for us to ship <code>uv</code> in our pipelines</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-07 18:45</div>
            <div class="timeline-body"><p>Why can't you add the pre-release dependency as a first-party requirement to explicitly opt-in?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dariocurr">@dariocurr</a> on 2025-01-07 18:53</div>
            <div class="timeline-body"><blockquote>
<p>Why can't you add the pre-release dependency as a first-party requirement to explicitly opt-in?</p>
</blockquote>
<p>Because that's not the way it should be, and I don't want to force my team to do something that shouldn't be done.
Again, this is the way <code>pip</code> works. This is the way <code>cargo</code> works. I only encountered this behavior when working with <code>uv</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-07 18:57</div>
            <div class="timeline-body"><p>Sorry, but &quot;shouldn't be done&quot; is subjective and <code>pip</code> is not a standard. Our motivation and stance this is explained in detail at https://docs.astral.sh/uv/pip/compatibility/#pre-release-compatibility</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2025-01-07 19:13</div>
            <div class="timeline-body"><p>Well, I will point out that uv <em>isn't</em> following the standards here, which do state a prerelease should be selected when there is no other option. But this discrepancy is documented in the compatibility guide, and the standards are only well defined for a single specifier, not a resolution.</p>
<p>Also pip doesn't follow the standard here fully either, as it inherits this behavior from packaging and I've found packaging hasn't consistently implemented this: https://github.com/pypa/packaging/issues/856</p>
<p>P.s. let's not get into a discussion on standards here, they're not very clearly laid out or worded, so it can be easy to jump to wrong conclusions for them and this isn't the right forum. If you're interested in the latest thinking on pre-releaees in the standards see: https://discuss.python.org/t/proposal-intersect-and-disjoint-operations-for-python-version-specifiers/71888</p>
<p>I'm hoping we get a new PEP proposal on this soon where we can have a productive discussion on this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/neamaddin">@neamaddin</a> on 2025-03-15 13:20</div>
            <div class="timeline-body"><p>Hey everyone. Can we add another option (we can discuss the name) that would allow installing a specific <strong>subdependency</strong> as a pre-release if it is explicitly specified in the package (e.g., <code>some-package==0.0.1-pre1</code>), while installing all other dependencies as usual? If you’re okay with this approach, I’d like to take on this task. I can’t promise it will be done quickly, but it’s better than nothing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2025-03-15 14:02</div>
            <div class="timeline-body"><p>I am working on that for pip right now: https://github.com/pypa/pip/issues/13221. With the interface mirroring selecting wheels or sdists.</p>
<p>Once I was a bit further along I was going to ask the astral folks if they had any bike shedding input on the names of the options. But I only work on this in my spare time and it's on a list of different things I am working on, so for pip the likely earliest this will be ready is in a few months, whereas uv seems to get stuff done in a few hours once they agree to it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/foxmulder900">@foxmulder900</a> on 2025-08-13 21:09</div>
            <div class="timeline-body"><blockquote>
<p>add the transitive dependency as a first-party dependency with a pre-release marker.</p>
</blockquote>
<p>Highlighting this as a workable solution for testing purposes, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Uv sync with  `--prerelease` fails unexpectedly" to "uv sync with  `--prerelease` fails unexpectedly" by @dariocurr on 2025-08-14 08:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "uv sync with  `--prerelease` fails unexpectedly" to "`uv sync` with  `--prerelease` fails unexpectedly" by @dariocurr on 2025-08-14 08:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/superlevure">@superlevure</a> on 2025-11-12 11:46</div>
            <div class="timeline-body"><p>This is a blocker for our company to adopt <code>uv</code> unfortunately</p>
<blockquote>
<p>Why can't you add the pre-release dependency as a first-party requirement to explicitly opt-in?</p>
</blockquote>
<p>In our case, many of our first-party dependencies are depending on pre-releases of their own dependencies, and having to bring those upward adds a maintenance burden that is not acceptable: we would end up maintaining in sync pre-releases requirements in many different repo and the build CI would break whenever the requirements are not in synced anymore.</p>
<p>Having a <code>--prerelease=explicit-third-party-too</code> (badly named but you get it) would enable <code>uv</code> adoption for us. We can't use <code>--prelease=allow</code> for the reasons mentioned above.</p>
<p>Thank you for the work on this amazing tool that is <code>ruff</code>, we are looking forward to finally replacing <code>pip</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dariocurr">@dariocurr</a> on 2025-11-12 11:49</div>
            <div class="timeline-body"><blockquote>
<p>This is a blocker for our company to adopt <code>uv</code> unfortunately</p>
<blockquote>
<p>Why can't you add the pre-release dependency as a first-party requirement to explicitly opt-in?</p>
</blockquote>
<p>In our case, many of our first-party dependencies are depending on pre-releases of their own dependencies, and having to bring those upward adds a maintenance burden that is not acceptable: we would end up maintaining in sync pre-releases requirements in many different repo and the build CI would break whenever the requirements are not in synced anymore.</p>
<p>Having a <code>--prerelease=explicit-third-party-too</code> (badly named but you get it) would enable <code>uv</code> adoption for us. We can't use <code>--prelease=allow</code> for the reasons mentioned above.</p>
<p>Thank you for the work on this amazing tool that is <code>ruff</code>, we are looking forward to finally replacing <code>pip</code></p>
</blockquote>
<p>I strongly agree with everything you said.
This is a blocker for our company too</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-11-12 14:52</div>
            <div class="timeline-body"><p>Unfortunately this isn't just a trivial &quot;add a new option&quot; problem, uv's resolver needs to know what packages pre-releases are enabled for upfront.</p>
<blockquote>
<p>we would end up maintaining in sync pre-releases requirements in many different repo and the build CI would break whenever the requirements are not in synced anymore.</p>
</blockquote>
<p>I'm not sure I understand? You don't need to pin specific pre-releases, just include a pre-release specifier in the dependency. If we added something like</p>
<pre><code>[tool.uv]
prerelease-packages = [&quot;...&quot;, &quot;...&quot;]
</code></pre>
<p>would that address your use-case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/superlevure">@superlevure</a> on 2025-11-12 15:42</div>
            <div class="timeline-body"><p>Thanks for the reply.</p>
<p>Unfortunately no because we would still end up maintaining a list of all of our third-party dependencies' pre-release dependencies in <code>prerelease-packages</code>. We don't want to go that route because suddenly Package A has to explicitly know about Package B dependencies and that doesn't come without issues. For example, when one of the third party package switches from a pre-release to a normal release for one of its dependency, the <code>prerelease-packages</code> field you suggest would go obsolete without us noticing. This is the kind of &quot;maintaining requirements in sync&quot; issue that is not acceptable for us.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-11-12 16:39</div>
            <div class="timeline-body"><p>What's the cost of that becoming obsolete? We could emit a warning (or in the future, a lint diagnostic) if a package in the list isn't being used though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/superlevure">@superlevure</a> on 2025-11-12 17:03</div>
            <div class="timeline-body"><blockquote>
<p>What's the cost of that becoming obsolete?</p>
</blockquote>
<p>Not only it would not adhere to our quality standard, it would actually be dangerous since it would allow pre-releases for a dependency even though not explicitly asked by any third party packages.</p>
<pre><code># Day 1
package-a  # prerelease-packages = [&quot;package-c&quot;]
├─ package-b # requires &quot;package-c==2.0.0a1&quot;
│  ├─ package-c@2.0.0a1  # &lt;- good: gets installed as expected

# Day 2 - `package-c@2.0.0` gets released
package-a  # prerelease-packages = [&quot;package-c&quot;]  (obsolete now)
├─ package-b # now requires &quot;package-c~=2.0&quot;
│  ├─ package-c@2.0.0  # &lt;- good: gets installed as expected

# Day 3 - `package-c@2.1.0a1` gets released
package-a  # prerelease-packages = [&quot;package-c&quot;]  (obsolete now)
├─ package-b # still requires &quot;package-c~=2.0&quot;
│  ├─ package-c@2.1.0.a1  # &lt;- bad /!\ : gets installed even though not explicitly specified by `package-b`
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 03:17:18 UTC
    </footer>
</body>
</html>
