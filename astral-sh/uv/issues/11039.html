<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consider changing the default behaviour of `python-preference` - astral-sh/uv #11039</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Consider changing the default behaviour of `python-preference`</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/11039">#11039</a>
        opened by <a href="https://github.com/wzyboy">@wzyboy</a>
        on 2025-01-28 20:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/wzyboy">@wzyboy</a> on 2025-01-28 20:32</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Currently the default value of <a href="https://docs.astral.sh/uv/reference/settings/#python-preference">python-preference</a> is <code>managed</code>, which may cause confusion if user is not aware of this.</p>
<p>My Linux distro ships Python 3.13. If I haven't downloaded Python distributions with <code>uv python</code>, then <code>uvx</code> invokes system python (note <code>python version = 3.13.1</code>):</p>
<pre><code class="language-bash">$ uvx --from ansible-core ansible --version
[...]
  python version = 3.13.1 (main, Dec  4 2024, 18:05:56) [GCC 14.2.1 20240910] (/home/wzyboy/.cache/uv/archive-v0/PI5AnOv_fdp-Cj5MJw9UF/bin/python)
[...]

$ readlink -f /home/wzyboy/.cache/uv/archive-v0/PI5AnOv_fdp-Cj5MJw9UF/bin/python
/usr/bin/python3.13
</code></pre>
<p>But once I downloaded any version of managed Python distributions, <code>uvx</code> uses the managed version (e.g. 3.11 below):</p>
<pre><code class="language-bash">$ uvx --from ansible-core ansible --version
[...]
  python version = 3.11.11 (main, Jan  5 2025, 05:33:30) [Clang 19.1.6 ] (/home/wzyboy/.cache/uv/archive-v0/-guMtmimmxwb3QgDqwOIc/bin/python)
[...]

$ readlink -f /home/wzyboy/.cache/uv/archive-v0/-guMtmimmxwb3QgDqwOIc/bin/python
/home/wzyboy/.local/share/uv/python/cpython-3.11.11-linux-x86_64-gnu/bin/python3.11
</code></pre>
<p>This default behaviour is confusing because:</p>
<ul>
<li>different versions of Python may have incompatibility</li>
<li>uv-managed Python behaves <a href="https://gregoryszorc.com/docs/python-build-standalone/main/quirks.html#use-of-libedit-on-linux">differently</a> than system Python, espeically on Linux, e.g. use of libedit instead of GNU readline, use of musl instead of glibc, etc. (a bug caused by the incompatibility of libedit and readline is what led my surprise finding of <code>python-preference</code> option ðŸ˜„ )</li>
</ul>
<p>The fact that uv is ultra-fast makes the automatic installation of python versions even harder to notice. ðŸ˜ƒ User might go into a random project that uses uv and unknowningly installed a managed version of Python that is different from system python. (the default behaviour is to auto-download Python)</p>
<h2>Proposed Change</h2>
<p>Only use managed version if running within a project, or if there is a <code>.python-version</code> file. For ad-hoc commands like <code>uvx</code>, always use system Python.</p>
<p>This could a new option like <code>managed-if-within-a-project</code> or something similar (sorry I'm bad at naming)</p>
<h3>Example</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @wzyboy on 2025-01-28 20:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/T-256">@T-256</a> on 2025-01-30 21:12</div>
            <div class="timeline-body"><blockquote>
<p>But once I downloaded any version of managed Python distributions, <code>uvx</code> uses the managed version</p>
</blockquote>
<p>Current workaround is using user/system level's <code>uv.toml</code>, see <a href="https://docs.astral.sh/uv/configuration/files/#:~:text=For%20tool%20commands%2C%20which%20operate%20at%20the%20user%20level%2C%20local%20configuration%20files%20will%20be%20ignored.">here</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wzyboy">@wzyboy</a> on 2025-01-30 22:25</div>
            <div class="timeline-body"><p>Thank you! I'm aware of the option that configures the default behaviour.</p>
<p>I'm suggesting this behaviour change because I fell for pitfall as a new user of uv and I hope future new users won't fall for the same pitfall like me.</p>
<p>My story, if anyone is interested:</p>
<p><strong>Step 1</strong>: I discovered <code>uv</code> and immediately loved it. I tried the <code>uvx</code> feature a bit, and I <strong>gained the impression that <code>uvx</code> invokes system Python</strong> by default. I migrated my projects to use uv.</p>
<p><strong>Step 2</strong>: A few days later, I used <code>uv python download</code> for the first time.</p>
<p><strong>Step 3</strong>: More days passed, I was developing a project that migrated to uv in step 3. I wanted to test a code behaviour in an old release. Instead of doing <code>git checkout v0.1</code>, I just run <code>uvx --from foo-package==0.1 foo /path/to/file</code> as a one-time command, under the impression I gained from step 1 that this would invoke system Python, which is the same as the project venv.</p>
<p><strong>Step 4</strong>: I continued to work on the git master version of the code, but this time there were some strange <code>OSError</code> that I never saw before.</p>
<p>I spent hours trying to debug <code>OSError</code>. The reasons behind this:</p>
<ul>
<li>The venv in step 3 was created before step 2, linking to system Python (GNU readline)</li>
<li>I was under the impression that the <code>uvx</code> command in step 3 used system Python as well, but it actually used uv-managed Python (libedit)</li>
<li>The hisotory file generated by GNU readline and libedit are incompatible. In step 4, the <code>OSError</code> is raised because GNU readline was trying to process the file generated by libedit in step 3.</li>
</ul>
<p>If the behaviour of <code>uvx</code> is consistent, i.e. does not change before/after a uv-managed Python is downloaded, this kind of confusing behaviour for new users can be avoided.</p>
<p>My use case might be niche, but there are <a href="https://gregoryszorc.com/docs/python-build-standalone/main/quirks.html">other documented quirks</a> of uv-managed Python distributions. Other users may encounter similar pitfalls like mine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/12122.html">astral-sh/uv#12122</a> on 2025-03-12 17:53</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:25 UTC
    </footer>
</body>
</html>
