<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv ignores `python_version` marker when conjoined with platform markers - astral-sh/uv #6169</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv ignores <code>python_version</code> marker when conjoined with platform markers</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/6169">#6169</a>
        opened by <a href="https://github.com/edgarrmondragon">@edgarrmondragon</a>
        on 2024-08-17 16:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/edgarrmondragon">@edgarrmondragon</a></div>
            <div class="timeline-body">

<p>For example, SQLAlchemy 2.0.32 has a dependency on greenlet, marked for certain platforms and only for Python &lt; 3.13<a href="https://github.com/sqlalchemy/sqlalchemy/blob/62c242b78dee306738a2cd22f548679e9818a1ac/setup.cfg#L41">^1</a>:</p>
<pre><code>greenlet != 0.4.17;(python_version&lt;&quot;3.13&quot; and (platform_machine==&#x27;aarch64&#x27; or (platform_machine==&#x27;ppc64le&#x27; or (platform_machine==&#x27;x86_64&#x27; or (platform_machine==&#x27;amd64&#x27; or (platform_machine==&#x27;AMD64&#x27; or (platform_machine==&#x27;win32&#x27; or platform_machine==&#x27;WIN32&#x27;)))))))
</code></pre>
<p>Now, something changed in uv 0.2.37 that the <code>python_version</code> marker is ignored. For example:</p>
<pre><code># requirements.txt
sqlalchemy==2.0.32
</code></pre>
<p>With uv 0.2.36</p>
<pre><code>$ UV_NO_CACHE=1 uv@0.2.36 pip compile --python python3.13 --python-platform x86_64-manylinux_2_31 requirements.txt
Resolved 2 packages in 1.16s
# This file was autogenerated by uv via the following command:
#    uv pip compile --python python3.13 --python-platform x86_64-manylinux_2_31 requirements.txt
sqlalchemy==2.0.32
    # via -r requirements.txt
typing-extensions==4.12.2
    # via sqlalchemy
</code></pre>
<p>but with uv 0.2.37</p>
<pre><code>$ UV_NO_CACHE=1 uv@0.2.37 pip compile --python python3.13 --python-platform x86_64-manylinux_2_31 requirements.txt
Resolved 3 packages in 1.16s
# This file was autogenerated by uv via the following command:
#    uv pip compile --python python3.13 --python-platform x86_64-manylinux_2_31 requirements.txt
greenlet==3.0.3
    # via sqlalchemy
sqlalchemy==2.0.32
    # via -r requirements.txt
typing-extensions==4.12.2
    # via sqlalchemy
</code></pre>
<p>When the platform is not one of those in the markers, the dependency is correctly excluded:</p>
<pre><code>$ UV_NO_CACHE=1 uv@0.2.37 pip compile --python python3.13 --python-platform aarch64-apple-darwin requirements.txt
Resolved 2 packages in 1.17s
# This file was autogenerated by uv via the following command:
#    uv pip compile --python python3.13 --python-platform aarch64-apple-darwin requirements.txt
sqlalchemy==2.0.32
    # via -r requirements.txt
typing-extensions==4.12.2
    # via sqlalchemy
</code></pre>
<p>Maybe related:</p>
<ul>
<li>https://github.com/astral-sh/uv/issues/6168</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-17 16:10</div>
            <div class="timeline-body"><p>Interesting, thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-17 16:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-17 16:13</div>
            <div class="timeline-body"><p>I’ll try to take a look at this today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-17 16:45</div>
            <div class="timeline-body"><p>I have at least one idea of what’s going on here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-17 16:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-17 16:56</div>
            <div class="timeline-body"><p>Ah ok I see the issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-17 16:58</div>
            <div class="timeline-body"><p>(It&#x27;s unique to 3.13, since only pre-releases are available, and it relates to a mishandling of pre-releases there. Will fix.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-17 19:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-17 19:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/edgarrmondragon">@edgarrmondragon</a> on 2024-08-17 19:51</div>
            <div class="timeline-body"><p>Thanks @charliermarsh!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-17 19:53</div>
            <div class="timeline-body"><p>Thanks for reporting!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:32:47 UTC
    </footer>
</body>
</html>
