<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>resolver struggles - astral-sh/uv #7879</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>resolver struggles</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/7879">#7879</a>
        opened by <a href="https://github.com/stas00">@stas00</a>
        on 2024-10-02 19:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/stas00">@stas00</a> on 2024-10-02 19:27</div>
            <div class="timeline-body"><p>using <code>uv-0.4.18</code></p>
<pre><code>$ uv pip install tensorrt_llm~=0.12 --pre --extra-index-url https://pypi.nvidia.com
Collecting uv
  Downloading uv-0.4.18-py3-none-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (12.9 MB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 12.9/12.9 MB 63.3 MB/s eta 0:00:00
Installing collected packages: uv
Successfully installed uv-0.4.18
WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv
  x No solution found when resolving dependencies:
  `-&gt; Because there is no version of nvidia-cudnn-cu12{platform_machine == 'x86_64' and platform_system == 'Linux'}==9.1.0.70 and
      torch==2.4.0 depends on nvidia-cudnn-cu12{platform_machine == 'x86_64' and platform_system == 'Linux'}==9.1.0.70, we can conclude
      that torch==2.4.0 cannot be used.
      And because only the following versions of torch are available:
          torch&lt;2.4.0a0
          torch&gt;=2.4.0
      and tensorrt-llm&gt;=0.12.0 depends on torch&gt;=2.4.0a0,&lt;=2.4.0, we can conclude that tensorrt-llm&gt;=0.12.0 cannot be used.
      And because only the following versions of tensorrt-llm are available:
          tensorrt-llm&lt;=0.12.0
          tensorrt-llm==0.13.0.dev2024081300
          tensorrt-llm==0.13.0.dev2024082000
          tensorrt-llm==0.13.0.dev2024082700
          tensorrt-llm==0.13.0.dev2024090300
          tensorrt-llm==0.13.0
          tensorrt-llm==0.14.0.dev2024091000
          tensorrt-llm==0.14.0.dev2024091700
          tensorrt-llm==0.14.0.dev2024092400
          tensorrt-llm==0.14.0.dev2024092401
          tensorrt-llm==0.14.0.dev2024100100
      and you require tensorrt-llm&gt;=0.12, we can conclude that your requirements are unsatisfiable.

      hint: `tensorrt-llm` was found on https://pypi.nvidia.com/, but not at the requested version (all of:
          tensorrt-llm&gt;0.12.0,&lt;0.13.0.dev2024081300
          tensorrt-llm&gt;0.13.0.dev2024081300,&lt;0.13.0.dev2024082000
          tensorrt-llm&gt;0.13.0.dev2024082000,&lt;0.13.0.dev2024082700
          tensorrt-llm&gt;0.13.0.dev2024082700,&lt;0.13.0.dev2024090300
          tensorrt-llm&gt;0.13.0.dev2024090300,&lt;0.13.0
          tensorrt-llm&gt;0.13.0,&lt;0.14.0.dev2024091000
          tensorrt-llm&gt;0.14.0.dev2024091000,&lt;0.14.0.dev2024091700
          tensorrt-llm&gt;0.14.0.dev2024091700,&lt;0.14.0.dev2024092400
          tensorrt-llm&gt;0.14.0.dev2024092400,&lt;0.14.0.dev2024092401
          tensorrt-llm&gt;0.14.0.dev2024092401,&lt;0.14.0.dev2024100100
          tensorrt-llm&gt;0.14.0.dev2024100100,&lt;1.dev0
      ). A compatible version may be available on a subsequent index (e.g., https://pypi.org/simple). By default, uv will only consider
      versions that are published on the first index that contains a given package, to avoid dependency confusion attacks. If all
      indexes are equally trusted, use `--index-strategy unsafe-best-match` to consider all versions from all indexes, regardless of the
      order in which they were defined.
</code></pre>
<p>whereas <code>pip</code> installs just fine:</p>
<pre><code>pip install tensorrt_llm~=0.12 --pre --extra-index-url https://pypi.nvidia.com
</code></pre>
<p>I'm installing into the <code>nvidia/cuda:12.5.1-devel-ubuntu22.04</code> docker image.</p>
<p>here is the full repro:</p>
<pre><code>docker run -it --gpus all --ipc=host --ulimit memlock=-1 --ulimit stack=67108864 nvidia/cuda:12.5.1-devel-ubuntu22.04

apt-get update &amp;&amp; apt-get -y install python3.10 python3-pip python-is-python3 openmpi-bin libopenmpi-dev wget git git-lfs unzip jq
export UV_SYSTEM_PYTHON=1
pip install uv
# uv pip install torch==2.4.0
uv pip install tensorrt_llm~=0.12 --pre --extra-index-url https://pypi.nvidia.com
</code></pre>
<p>if I manually do this first:</p>
<pre><code>uv pip install torch==2.4.0
</code></pre>
<p>then the resolver works. somehow it can't figure out it can install <code>torch==2.4.0</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-02 19:36</div>
            <div class="timeline-body"><p>Did you try following the hint after the error?</p>
<blockquote>
<p>A compatible version may be available on a subsequent index (e.g., https://pypi.org/simple). By default, uv will only consider versions that are published on the first index that contains a given package, to avoid dependency confusion attacks. If all indexes are equally trusted, use <code>--index-strategy unsafe-best-match</code> to consider all versions from all indexes, regardless of the order in which they were defined.</p>
</blockquote>
<p>More information in the <a href="https://docs.astral.sh/uv/pip/compatibility/#packages-that-exist-on-multiple-indexes">documentation</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stas00">@stas00</a> on 2024-10-02 19:37</div>
            <div class="timeline-body"><p>and then it fails again doing another pip install:</p>
<pre><code>git clone https://github.com/NVIDIA/TensorRT-Model-Optimizer/
cd TensorRT-Model-Optimizer/llm_ptq/
uv pip install -r requirements.txt
</code></pre>
<pre><code> Updated https://github.com/Dao-AILab/flash-attention.git (53a4f34)
error: Build backend failed to determine requirements with `build_wheel()` (exit status: 1)
--- stdout:

--- stderr:
Traceback (most recent call last):
  File &quot;&lt;string&gt;&quot;, line 14, in &lt;module&gt;
  File &quot;/root/.cache/uv/builds-v0/.tmpG2T258/lib/python3.10/site-packages/setuptools/build_meta.py&quot;, line 332, in get_requires_for_build_wheel
    return self._get_build_requires(config_settings, requirements=[])
  File &quot;/root/.cache/uv/builds-v0/.tmpG2T258/lib/python3.10/site-packages/setuptools/build_meta.py&quot;, line 302, in _get_build_requires
    self.run_setup()
  File &quot;/root/.cache/uv/builds-v0/.tmpG2T258/lib/python3.10/site-packages/setuptools/build_meta.py&quot;, line 503, in run_setup
    super().run_setup(setup_script=setup_script)
  File &quot;/root/.cache/uv/builds-v0/.tmpG2T258/lib/python3.10/site-packages/setuptools/build_meta.py&quot;, line 318, in run_setup
    exec(code, locals())
  File &quot;&lt;string&gt;&quot;, line 7, in &lt;module&gt;
ModuleNotFoundError: No module named 'torch'
---
  Caused by: This error likely indicates that git+https://github.com/Dao-AILab/flash-attention.git#subdirectory=csrc/rotary depends on torch, but doesn't declare it as a build dependency. If git+https://github.com/Dao-AILab/flash-attention.git#subdirectory=csrc/rotary is a first-party package, consider adding torch to its `build-system.requires`. Otherwise, `uv pip install torch` into the environment and re-run with `--no-build-isolation`.
</code></pre>
<p>it messes something up here with <code>PYTHONPATH</code> perhaps, since:</p>
<pre><code>python -c &quot;import torch&quot;
</code></pre>
<p>works just fine.</p>
<p>And again switching to <code>pip</code> works fine as well.</p>
<p>for context: I'm trying to build a simpler and faster version of https://github.com/NVIDIA/TensorRT-Model-Optimizer/blob/main/docker/Dockerfile replacing <code>s/pip/uv pip/</code> - hence the same issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-02 19:39</div>
            <div class="timeline-body"><p>Similarly, <code>flash-attention</code> notoriously cannot be used with build isolation (see #2252). More details in <a href="https://docs.astral.sh/uv/pip/compatibility/#pep-517-build-isolation">the documentation</a>.</p>
<p>There's a dedicated hint for this too</p>
<blockquote>
<p>Caused by: This error likely indicates that git+https://github.com/Dao-AILab/flash-attention.git#subdirectory=csrc/rotary depends on torch, but doesn't declare it as a build dependency. If git+https://github.com/Dao-AILab/flash-attention.git#subdirectory=csrc/rotary is a first-party package, consider adding torch to its <code>build-system.requires</code>. Otherwise, <code>uv pip install torch</code> into the environment and re-run with <code>--no-build-isolation</code>.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stas00">@stas00</a> on 2024-10-02 19:47</div>
            <div class="timeline-body"><p>thank you for the hints, @zanieb</p>
<p>I have a feature request then: can we have a new env var that if set makes <code>uv</code> work exactly like <code>pip</code> so in any situation where <code>pip</code> succeeds <code>uv pip</code> will succeed?</p>
<p>I'm sort of sitting on the fence here, wanting to use <code>uv</code> for its speed, but don't have the time to constantly figure out the more precise way <code>uv</code> works and adding flags and env vars in too many places. That was the main reason I hardly every run <code>conda install</code> these days, because 99.999% of the time <code>pip</code> does the right thing out of the box, and conda was making things too restrictive and prescriptive.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-02 19:54</div>
            <div class="timeline-body"><p>I don't think you should need to constantly figure things out, the differences are described thoroughly in the compatibility document. I don't think we can / will provide a flag that makes uv &quot;act exactly like pip&quot; — we usually have strong justifications for differing on our defaults. It's an interesting suggestion though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stas00">@stas00</a> on 2024-10-02 20:08</div>
            <div class="timeline-body"><p>but you're <code>uv</code>'s core developer, whereas, we, users, want things to just work because we have so many more things to figure and if there is a tool that creates less friction at a cost of a slower speed I'll choose that over the much faster tool that ends up costing me a lot more time and the limited brain juice to constantly lookup docs and deal with edge cases.</p>
<p>Moreover I most likely will figure things out, but not everybody on my team will and they will complain and then I will need to spend even more time supporting them.</p>
<p>My intuition is that for a great <code>uv</code> adoption, the first step should be: exactly the same behavior as pip but faster - then let people optimize when there is an actual need to do so.</p>
<p>&quot;Keep simple things simple, and difficult things doable&quot; or something of sorts is a good motto some projects have</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-02 20:21</div>
            <div class="timeline-body"><p>For what it’s worth, that build isolation behavior you’re seeing (the second error you referenced) will almost certainly be true in future versions of pip too. They have not made the PEP 517 standard a default yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @stas00 on 2024-10-02 20:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stas00">@stas00</a> on 2024-10-02 20:24</div>
            <div class="timeline-body"><p>I think for now I will just stick to <code>pip</code> when I need to try out something new and massive like the huge dependencies of nvidia's packages and use <code>uv</code> in repetitive situations where everybody saves time and one time figuring out saves the time repeatedly on subsequent runs of the same install recipe.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:00 UTC
    </footer>
</body>
</html>
