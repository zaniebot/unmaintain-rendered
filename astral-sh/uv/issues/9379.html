<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frozen vs Locked unexpected behavior - astral-sh/uv #9379</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Frozen vs Locked unexpected behavior</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/9379">#9379</a>
        opened by <a href="https://github.com/TurtleOrangina">@TurtleOrangina</a>
        on 2024-11-23 09:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/TurtleOrangina">@TurtleOrangina</a></div>
            <div class="timeline-body"><p>Hi,</p>
<p>in my Dockerfile I do:</p>
<pre><code># Install python dependencies (only main, not dev dependencies)
RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,source=uv.lock,target=uv.lock \
    --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
    uv sync --frozen --no-install-project --no-dev
</code></pre>
<p>This works fine, and installs only the dependencies, not the project itself. But, I would like to check if the uv.lock file is actually up-to-date with the pyproject.toml file. So I added <code>--locked</code>. This doesn&#x27;t work due to:
<code>error: the argument &#x27;--frozen&#x27; cannot be used with &#x27;--locked&#x27;</code>. So I remove --frozen, but that seems to change something with regards to build behavior, because I no longer manage to pass this step in my Docker container, I get:</p>
<pre><code>#16 [builder  8/10] RUN --mount=type=cache,target=/root/.cache/uv     --mount=type=bind,source=uv.lock,target=uv.lock     --mount=type=bind,source=pyproject.toml,target=pyproject.toml     uv sync --locked --no-install-project --no-dev
#16 0.089 Using CPython 3.13.0 interpreter at: /usr/local/bin/python3
#16 0.089 Creating virtual environment at: /venv
#16 0.493 error: Failed to generate package metadata for `workoutsummary==0.3.0 @ editable+.`
#16 0.493   Caused by: Build backend failed to determine metadata through `prepare_metadata_for_build_editable` (exit status: 1)
#16 0.493 
#16 0.493 [stdout]
#16 0.493 Checking for Rust toolchain....
#16 0.493 Running `maturin pep517 write-dist-info --metadata-directory /root/.cache/uv/builds-v0/.tmpVutI4o/metadata_directory --interpreter /root/.cache/uv/builds-v0/.tmpVutI4o/bin/python`
#16 0.493 
#16 0.493 [stderr]
#16 0.493 ðŸ’¥ maturin failed
#16 0.493   Caused by: Can&#x27;t find /app/Cargo.toml (in /app)
#16 0.493 Error running maturin: Command &#x27;[&#x27;maturin&#x27;, &#x27;pep517&#x27;, &#x27;write-dist-info&#x27;, &#x27;--metadata-directory&#x27;, &#x27;/root/.cache/uv/builds-v0/.tmpVutI4o/metadata_directory&#x27;, &#x27;--interpreter&#x27;, &#x27;/root/.cache/uv/builds-v0/.tmpVutI4o/bin/python&#x27;]&#x27; returned non-zero exit status 1.
#16 ERROR: process &quot;/bin/sh -c uv sync --locked --no-install-project --no-dev&quot; did not complete successfully: exit code: 2
------
 &gt; [builder  8/10] RUN --mount=type=cache,target=/root/.cache/uv     --mount=type=bind,source=uv.lock,target=uv.lock     --mount=type=bind,source=pyproject.toml,target=pyproject.toml     uv sync --locked --no-install-project --no-dev:
0.493   Caused by: Build backend failed to determine metadata through `prepare_metadata_for_build_editable` (exit status: 1)
0.493 
0.493 [stdout]
0.493 Checking for Rust toolchain....
0.493 Running `maturin pep517 write-dist-info --metadata-directory /root/.cache/uv/builds-v0/.tmpVutI4o/metadata_directory --interpreter /root/.cache/uv/builds-v0/.tmpVutI4o/bin/python`
0.493 
0.493 [stderr]
0.493 ðŸ’¥ maturin failed
0.493   Caused by: Can&#x27;t find /app/Cargo.toml (in /app)
0.493 Error running maturin: Command &#x27;[&#x27;maturin&#x27;, &#x27;pep517&#x27;, &#x27;write-dist-info&#x27;, &#x27;--metadata-directory&#x27;, &#x27;/root/.cache/uv/builds-v0/.tmpVutI4o/metadata_directory&#x27;, &#x27;--interpreter&#x27;, &#x27;/root/.cache/uv/builds-v0/.tmpVutI4o/bin/python&#x27;]&#x27; returned non-zero exit status 1.
------
Dockerfile:41
--------------------
  40 |     # Install python dependencies (only main, not dev dependencies)
  41 | &gt;&gt;&gt; RUN --mount=type=cache,target=/root/.cache/uv \
  42 | &gt;&gt;&gt;     --mount=type=bind,source=uv.lock,target=uv.lock \
  43 | &gt;&gt;&gt;     --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
  44 | &gt;&gt;&gt;     uv sync --locked --no-install-project --no-dev
  45 |     
--------------------
ERROR: failed to solve: process &quot;/bin/sh -c uv sync --locked --no-install-project --no-dev&quot; did not complete successfully: exit code: 2
</code></pre>
<p>As context, this is a mixed python+rust project, with <code>maturin</code> as build-backend. The unexpected behavior here is that maturin is called in a way that demands a <code>Cargo.toml</code> file when I use <code>--locked</code> vs <code>--frozen</code>.</p>
<p>What I would have wished for:</p>
<ul>
<li><code>--locked</code> and <code>--frozen</code> being non exclusive, as frozen seems to be more than just the instruction to not write the uv.lock file.</li>
<li>Alternatively, if <code>--frozen</code> really only would skip the writing of the <code>uv.lock</code> file, I would expect the above error to not occur when I substitute <code>--frozen</code> with <code>--locked</code>.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TurtleOrangina">@TurtleOrangina</a> on 2024-11-23 09:56</div>
            <div class="timeline-body"><p>If required, I can create a minimal example to reproduce. Just let me know if that would be useful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/FishAlchemist">@FishAlchemist</a> on 2024-11-23 10:13</div>
            <div class="timeline-body"><p>Isn&#x27;t using <code>--locked</code> sufficient to check if uv.lock is up-to-date?</p>
<pre><code>uv sync --locked
</code></pre>
<p>If you simply want the lock file to be automatically updated to the latest version, then you don&#x27;t need to use either --locked or --frozen</p>
<blockquote>
<p>The project is re-locked before syncing unless the --locked or --frozen flag is provided.</p>
</blockquote>
<p>By using both <code>--locked</code> and <code>--frozen</code>, are you attempting to make UV verify that the lock file is current without allowing it to modify the lock file?</p>
<p>https://docs.astral.sh/uv/reference/cli/#uv-sync
<code>--locked</code></p>
<pre><code>Assert that the uv.lock will remain unchanged.

Requires that the lockfile is up-to-date. If the lockfile is missing or needs to be updated, uv will exit with an error.

May also be set with the UV_LOCKED environment variable.
</code></pre>
<p><code>--frozen</code></p>
<pre><code>Sync without updating the uv.lock file.

Instead of checking if the lockfile is up-to-date, uses the versions in the lockfile as the source of truth. If the lockfile is missing, uv will exit with an error. If the pyproject.toml includes changes to dependencies that have not been included in the lockfile yet, they will not be present in the environment.

May also be set with the UV_FROZEN environment variable.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-23 13:02</div>
            <div class="timeline-body"><p><code>--locked</code> requires that we can access the project metadata. Are you using dynamic metadata, or something like that? If so, we have to build the project from source.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-23 13:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/TurtleOrangina">@TurtleOrangina</a> on 2024-11-23 16:55</div>
            <div class="timeline-body"><blockquote>
<p><code>--locked</code> requires that we can access the project metadata. Are you using dynamic metadata, or something like that? If so, we have to build the project from source.</p>
</blockquote>
<p>Indeed, my <code>pyproject.toml</code> contained <code>dynamic = [&quot;version&quot;]</code> - I am not sure why. I don&#x27;t think it was necessary, as the version itself was a fixed string. Removing this line makes it work with <code>--locked</code> instead of <code>--frozen</code>.</p>
<p>I have also made a example that reproduces it, in case it is useful:
https://github.com/Lingepumpe/uv_locked_frozen_reproduction</p>
<p>Simply running <code>docker build .</code> in the repo will result in the error - commenting out the dynamic line in pyproject.toml will avoid the error.</p>
<p>The question remains: Why does <code>--locked</code> require extra steps when compared with <code>--frozen</code>? In the scenario of the Dockerfile, the idea is to check the uv.lock file and install the dependencies as early as possible, without needing to copy in the full source tree, for optimal layer caching.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-23 17:06</div>
            <div class="timeline-body"><blockquote>
<p>The question remains: Why does --locked require extra steps when compared with --frozen?</p>
</blockquote>
<p>Because <code>--locked</code> has to validate that the lockfile is up-to-date, which requires accessing the project&#x27;s metadata, which in your case requires building the project. <code>--frozen</code> doesn&#x27;t have to validate anything, so it doesn&#x27;t need to build the metadata, since you&#x27;re not installing the project.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-23 17:06</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:35:42 UTC
    </footer>
</body>
</html>
