<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support `--unsafe-package` in `uv pip compile` - astral-sh/uv #1415</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Support <code>--unsafe-package</code> in <code>uv pip compile</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/1415">#1415</a>
        opened by <a href="https://github.com/hauntsaninja">@hauntsaninja</a>
        on 2024-02-16 02:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/hauntsaninja">@hauntsaninja</a> on 2024-02-16 02:43</div>
            <div class="timeline-body"><p>pip-compile has this flag that's a useful escape hatch. There's some software we use where we care about the specific build. We don't want the build from the index and we don't want it in our lock file, we want to manually manage how it gets installed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @charliermarsh on 2024-02-16 02:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">compatibility</span> added by @charliermarsh on 2024-02-16 02:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kummerer94">@kummerer94</a> on 2024-02-18 23:20</div>
            <div class="timeline-body"><p>Strong +1 for this feature.</p>
<p>To add another usecase: If you develop on Windows and run <code>uv pip compile ...</code>, you will sometimes have dependencies in your output file that are only necessary for Windows (like <code>pywin32</code>).</p>
<p>Now, I understand that cross compilation is a problem itself (see <a href="https://github.com/jazzband/pip-tools?tab=readme-ov-file#should-i-commit-requirementsin-and-requirementstxt-to-source-control">here</a>) and <code>pip-compile</code> itself does not solve it. But <code>--unsafe-package</code> gets you very far without having to go through the hassle of creating different <code>requirements.in</code> files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-02-19 00:04</div>
            <div class="timeline-body"><p>Can you share a bit more about the workflow for this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hauntsaninja">@hauntsaninja</a> on 2024-02-19 00:30</div>
            <div class="timeline-body"><p>Sure! So one of the packages for which we care about the specific build is torch. Now we have some service that's a Python package that has <code>torch</code> in its dependencies. We run something that basically boils down to something like <code>pip-compile package/pyproject.toml --unsafe-package torch --generate-hashes -o requirements.txt</code> to produce a lock file that does not contain torch. When building the deployment, we <code>pip install --no-deps -r requirements.txt</code> and then do some custom thing to install the specific build of torch we want for that deployment.</p>
<p>This is not a critical feature in that we could be unblocked by writing a wrapper script that parses requirements.txt and removes the packages we don't want from it, but it is something pip-compile currently supports</p>
<p>(This is a thing that maybe sounds like it could be solved by using a custom index or maybe by using URL requirements, but neither of those really works for us in practice)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hmc-cs-mdrissi">@hmc-cs-mdrissi</a> on 2024-02-20 23:07</div>
            <div class="timeline-body"><p>I originally contributed unsafe-package to pip-compile mostly as an escape hatch. My main use case was handing multiple editable installs. I work in monorepo with several libraries. My requirements.in looks like this,</p>
<pre><code>-e file:lib1/
-e file:lib2/
...
</code></pre>
<p>and I pip compile that with pip-compile requirements.in --unsafe-package lib1 --unsafe-package lib2. This allows resolving dependencies of repository with hashes but without editable requirements. Afterwards we then do <code>pip install --no-dependencies requirements.txt &amp;&amp; pip install --no-dependencies requirements.in</code>.</p>
<p>pip requirements.txt does not support a dependency with hashes + editable dependency in same file. This is open <a href="https://github.com/pypa/pip/issues/4995">issue</a>. For my specific usage if requirements.txt file could support both hashed non-editable dependencies and editable dependencies together then I probably wouldn't use it. The feature was made as broader escape hatch though mostly because it was easier. pip-compile already had a few packages marked unsafe by default (setuptools/pip), so extending that logic to user custom unsafe was straight forward.</p>
<p>edit: Name unsafe only comes from it being based on default unsafe packages that existed for many years prior. A more obvious name might be --output-exclude-package (or maybe brief --exclude-package). Here exclusion applies only to output requirements file made. The package is still used as normal during resolution time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gilfree">@gilfree</a> on 2024-02-21 07:04</div>
            <div class="timeline-body"><p>If I might add a use case - some packages depend on non-python stuff. For example, cupy depends on cuda. It uses naming scheme like cupy-cuda12x.</p>
<p>We pip compile our requirements, to pinned dependencies of such packages, but as we have multiple cuda versions we work with, we have a later command that checks the cuda version and installs the relevant package.</p>
<p>We want to have the dependencies of these packages to be pinned and be included in the generated requirements package, but we can't have these cuda-versioned packeges there.</p>
<p>Having a flag that says - &quot;omit cupy from the generated file&quot; will be great. (We can solve this by post processing the requirements file, but I think it will be safer to have this explicit)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-02-22 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-22 16:49</div>
            <div class="timeline-body"><p>I will add.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-22 16:50</div>
            <div class="timeline-body"><p>I'm tempted to use a different name but...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-22 17:09</div>
            <div class="timeline-body"><p>If anyone has suggestions, feel free to share, though I reserve the right to just go with <code>--unsafe-package</code> and move on :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-22 17:10</div>
            <div class="timeline-body"><p>Actually, I'll likely <em>at least</em> use <code>--unsafe-package</code> for compatibility.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @zanieb by @charliermarsh on 2024-02-22 19:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @charliermarsh by @charliermarsh on 2024-02-22 19:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-02-22 19:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @zanieb by @charliermarsh on 2024-02-22 19:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nathanjmcdougall">@nathanjmcdougall</a> on 2024-02-22 20:10</div>
            <div class="timeline-body"><p>I think <code>--exclude</code> would be a good alias.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-02-23 18:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/msharp9">@msharp9</a> on 2024-09-20 22:28</div>
            <div class="timeline-body"><p>I don't see --unsafe-package in the docs: https://docs.astral.sh/uv/reference/cli/#uv-pip-compile.  I don't get an error when I include the flag and I see the PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-20 22:29</div>
            <div class="timeline-body"><p>It’s “no-emit-package”.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:30:27 UTC
    </footer>
</body>
</html>
