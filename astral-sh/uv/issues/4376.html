<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`crates/uv/tests/toolchain_find.rs` fails on Gentoo Linux - astral-sh/uv #4376</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`crates/uv/tests/toolchain_find.rs` fails on Gentoo Linux</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/4376">#4376</a>
        opened by <a href="https://github.com/mgorny">@mgorny</a>
        on 2024-06-18 06:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/mgorny">@mgorny</a> on 2024-06-18 06:32</div>
            <div class="timeline-body"><p>To be honest, I can't really figure out what the test is supposed to do.</p>
<p>In our &quot;standard&quot; test setup that exposes Python 3.12 as the &quot;default&quot; version and that used to satisfy tests so far, it fails with:</p>
<pre><code>     Running `/var/tmp/portage/dev-python/uv-0.2.12/work/uv-0.2.12/target/debug/deps/toolchain_find-8ef0a312fec15b41`

running 1 test
test toolchain_find ... FAILED^O

failures:

---- toolchain_find stdout ----
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot: toolchain_find
Source: crates/uv/tests/toolchain_find.rs:13
────────────────────────────────────────────────────────────────────────────────
Expression: snapshot
────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬───────────────────────────────────────────────────────────────────
    0     0 │ success: true
    1     1 │ exit_code: 0
    2     2 │ ----- stdout -----
    3       │-[PYTHON-3.11]
          3 │+/usr/lib/python-exec/python3.12/python3
    4     4 │ 
    5     5 │ ----- stderr -----
────────────┴───────────────────────────────────────────────────────────────────
To update snapshots run `cargo insta review`
Stopped on the first failure. Run `cargo insta test` to run all snapshots.
thread 'toolchain_find' panicked at /var/tmp/portage/dev-python/uv-0.2.12/work/cargo_home/gentoo/insta-1.39.0/src/runtime.rs:562:9:
snapshot assertion for 'toolchain_find' failed in line 13
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace


failures:
    toolchain_find

test result: FAILED^O. 0 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out; finished in 1.34s

error: test failed, to rerun pass `--test toolchain_find`
</code></pre>
<p>If I change the setup to expose 3.11 instead, it fails as well (and this setup also makes <code>create_venv_ignores_virtual_env_variable</code> test fail):</p>
<pre><code>     Running `/var/tmp/portage/dev-python/uv-0.2.12/work/uv-0.2.12/target/debug/deps/toolchain_find-8ef0a312fec15b41`

running 1 test
test toolchain_find ... FAILED^O

failures:

---- toolchain_find stdout ----
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot: toolchain_find
Source: crates/uv/tests/toolchain_find.rs:13
────────────────────────────────────────────────────────────────────────────────
Expression: snapshot
────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬───────────────────────────────────────────────────────────────────
    0     0 │ success: true
    1     1 │ exit_code: 0
    2     2 │ ----- stdout -----
    3       │-[PYTHON-3.11]
          3 │+/usr/lib/python-exec/python[PYTHON-3.11]
    4     4 │ 
    5     5 │ ----- stderr -----
────────────┴───────────────────────────────────────────────────────────────────
To update snapshots run `cargo insta review`
Stopped on the first failure. Run `cargo insta test` to run all snapshots.
thread 'toolchain_find' panicked at /var/tmp/portage/dev-python/uv-0.2.12/work/cargo_home/gentoo/insta-1.39.0/src/runtime.rs:562:9:
snapshot assertion for 'toolchain_find' failed in line 13
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace


failures:
    toolchain_find

test result: FAILED^O. 0 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.55s

error: test failed, to rerun pass `--test toolchain_find`
     Running `/var/tmp/portage/dev-python/uv-0.2.12/work/uv-0.2.12/target/debug/deps/venv-895a2f90bedd3361`
</code></pre>
<p>For the purpose of testing, we're putting a directory with the following wrappers on top of <code>PATH</code>:</p>
<pre><code>==&gt; /var/tmp/portage/dev-python/uv-0.2.12/temp/python3.12/bin/python &lt;==
#!/bin/sh
exec &quot;/usr/bin/python3.12&quot; &quot;${@}&quot;

==&gt; /var/tmp/portage/dev-python/uv-0.2.12/temp/python3.12/bin/python-config &lt;==
#!/bin/sh
exec &quot;/usr/bin/python3.12-config&quot; &quot;${@}&quot;

==&gt; /var/tmp/portage/dev-python/uv-0.2.12/temp/python3.12/bin/python2 &lt;==
#!/bin/sh
echo &quot;: _python_wrapper_setup: python2 is not supported by python3.12 (PYTHON_COMPAT)&quot; &gt;&amp;2
exit 127

==&gt; /var/tmp/portage/dev-python/uv-0.2.12/temp/python3.12/bin/python2-config &lt;==
#!/bin/sh
echo &quot;: _python_wrapper_setup: python2-config is not supported by python3.12 (PYTHON_COMPAT)&quot; &gt;&amp;2
exit 127

==&gt; /var/tmp/portage/dev-python/uv-0.2.12/temp/python3.12/bin/python3 &lt;==
#!/bin/sh
exec &quot;/usr/bin/python3.12&quot; &quot;${@}&quot;

==&gt; /var/tmp/portage/dev-python/uv-0.2.12/temp/python3.12/bin/python3-config &lt;==
#!/bin/sh
exec &quot;/usr/bin/python3.12-config&quot; &quot;${@}&quot;
</code></pre>
<p><code>/usr/bin/python3.11</code> and <code>/usr/bin/python3.12</code> as the actual executables installed by respective Python versions. However, <code>/usr/bin/python</code> and <code>/usr/bin/python3</code> (that shouldn't have been called because of <code>PATH</code> set) are C wrappers that effectively calls <code>/usr/lib/python-exec/python3.12/python</code> or <code>/python3</code> in that setup, which in turns are symlinks leading to <code>/usr/bin/python3.12</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @zanieb by @zanieb on 2024-06-19 00:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-19 00:23</div>
            <div class="timeline-body"><p>Hi! Regarding <code>toolchain_find</code>, this test provides coverage for our toolchain discovery command e.g. <code>uv toolchain find</code> should give the path to an interpreter that meets the given request. During each test, we create a test context with the requested interpreters.</p>
<p>https://github.com/astral-sh/uv/blob/05870609ee5cc7ca4ff96eb1d2ce357fc96aa382/crates/uv/tests/toolchain_find.rs#L10</p>
<p>We discover the required interpreters and place their paths into a special <code>PATH</code> variable so the tests are properly isolated from the rest of the system.</p>
<p>https://github.com/astral-sh/uv/blob/b22ee82f0d3af607cc49d3f3870805769ea0b6e6/crates/uv/tests/common/mod.rs#L525</p>
<p>We then filter these paths with dedicated snapshot filters (e.g. <code>[PYTHON-&lt;VERSION&gt;]</code>) so that the test snapshots are independent of the system you're running on.</p>
<p>https://github.com/astral-sh/uv/blob/b22ee82f0d3af607cc49d3f3870805769ea0b6e6/crates/uv/tests/common/mod.rs#L146-L150</p>
<p>It looks like here, the <code>toolchain find</code> output contains a path that doesn't match our expected filters. Probably because of the shims you're using?</p>
<p>We display the <code>sys.executable</code> of the found interpreter at https://github.com/astral-sh/uv/blob/accbb9b695418318e136f628fe366e845bc224f2/crates/uv/src/commands/toolchain/find.rs#L39 but our filtering is applied to the executable we find on the path.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-19 00:25</div>
            <div class="timeline-body"><p>Though actually it looks like that executable path should also be relative to the <code>sys.executable</code></p>
<p>https://github.com/astral-sh/uv/blob/b22ee82f0d3af607cc49d3f3870805769ea0b6e6/crates/uv/tests/common/mod.rs#L702-L703</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @zanieb on 2024-06-19 00:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgorny">@mgorny</a> on 2024-06-19 13:19</div>
            <div class="timeline-body"><p>The matched path aside, the first problem is why is it finding Python 3.12 when it's looking for Python 3.11? <code>python</code> and <code>python3</code> here are 3.12, and explicit <code>python3.11</code> and <code>python3.12</code> executables are available on <code>PATH</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-19 14:39</div>
            <div class="timeline-body"><p>Yeah sounds weird. I don't have any ideas — but the way I debug things like this is to add the <code>-v</code> flag to the command invocation in the test. <code>RUST_LOG=uv=trace</code> will also be really helpful for toolchain discovery debugging too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgorny">@mgorny</a> on 2024-06-19 15:10</div>
            <div class="timeline-body"><p>With unmangled <code>PATH</code>:</p>
<pre><code>$ echo $PATH
/home/mgorny/perl5/bin:/home/mgorny/node_modules/.bin/:/home/mgorny/bin:/usr/i686-pc-linux-gnu/gcc-bin/4.9.2:/usr/local/sbin:/usr/local/bin:/usr/bin:/opt/bin:/usr/sbin:/sbin:/usr/lib/llvm/19/bin:/usr/lib/llvm/18/bin:/usr/lib/llvm/17/bin:/usr/lib/llvm/9/bin:/etc/eselect/wine/bin:/home/mgorny/.local/bin
$ RUST_LOG=uv=trace cargo test -p uv --test toolchain_find
    Finished `test` profile [unoptimized + debuginfo] target(s) in 0.32s
     Running tests/toolchain_find.rs (target/debug/deps/toolchain_find-ad7d4b038b9c38d8)

running 1 test
test toolchain_find ... FAILED

failures:

---- toolchain_find stdout ----
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot: toolchain_find
Source: crates/uv/tests/toolchain_find.rs:13
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
Expression: snapshot
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
    0     0 │ success: true
    1     1 │ exit_code: 0
    2     2 │ ----- stdout -----
    3       │-[PYTHON-3.11]
          3 │+/usr/lib/python-exec/python3.12/python3
    4     4 │ 
    5       │------ stderr -----
          5 │+----- stderr -----
          6 │+DEBUG uv 0.2.13 (e486eb86b 2024-06-18)
          7 │+DEBUG Only considering search path, provided path, and active environments due to `UV_TEST_PYTHON_PATH`
          8 │+DEBUG Searching for Python interpreter in provided path, active virtual environment, or search path
          9 │+TRACE Searching PATH for executables: python3, python
         10 │+DEBUG Python interpreter not found at `[VENV]/bin/python3`
         11 │+TRACE Skipping missing interpreter at [VENV]/bin/python3
         12 │+TRACE Checking `PATH` directory for interpreters: /usr/bin
         13 │+TRACE Found possible Python executable: [PYTHON-3.11]
         14 │+TRACE Querying interpreter executable at [PYTHON-3.11]
         15 │+DEBUG Found cpython 3.12.[X] at `[PYTHON-3.11]
────────────┴──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
To update snapshots run `cargo insta review`
Stopped on the first failure. Run `cargo insta test` to run all snapshots.
thread 'toolchain_find' panicked at /home/mgorny/.cargo/registry/src/index.crates.io-6f17d22bba15001f/insta-1.39.0/src/runtime.rs:562:9:
snapshot assertion for 'toolchain_find' failed in line 13
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace


failures:
    toolchain_find

test result: FAILED. 0 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.45s

error: test failed, to rerun pass `-p uv --test toolchain_find`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-19 15:26</div>
            <div class="timeline-body"><p>It looks like when we setup the test context we think the Python 3.12 executable is Python 3.11? Or I mangled the filtering somehow. Weird. I'll probably have to try to reproduce and resolve on my end unless you want to dig into the dark world of our test context tooling.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgorny">@mgorny</a> on 2024-06-19 15:29</div>
            <div class="timeline-body"><p>Yeah, I'm totally confused what assumptions are being made here. Thanks for looking into it. I don't think I have the energy to try figuring out all of this right now, but if you need more details about the system, or need me to test anything, please let me know.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-19 15:31</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4443.html">astral-sh/uv#4443</a> on 2024-06-21 21:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-21 21:41</div>
            <div class="timeline-body"><p>I believe I've found the problem at https://github.com/astral-sh/uv/pull/4443</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-06-23 15:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-06-23 15:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgorny">@mgorny</a> on 2024-06-25 05:29</div>
            <div class="timeline-body"><p>Ehh, I'm sorry to say but it seems that I didn't test the patch sufficiently, and it only works for a very specific setting of <code>PATH=/usr/lib/python-exec/python3.12</code>. However, it still fails if the first <code>python*</code> on <code>PATH</code> is not that directory, e.g. with plain <code>/usr/bin</code>, I'm getting:</p>
<pre><code>━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot: toolchain_find-10
Source: crates/uv/tests/toolchain_find.rs:111
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
Expression: snapshot
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
    0     0 │ success: true
    1     1 │ exit_code: 0
    2     2 │ ----- stdout -----
    3       │-[PYTHON-3.12]
          3 │+/usr/lib/python-exec/python3.13/python3
    4     4 │ 
    5     5 │ ----- stderr -----
────────────┴──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</code></pre>
<p>After stripping away previous tests, the debug log gives:</p>
<pre><code>━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot: toolchain_find
Source: crates/uv/tests/toolchain_find.rs:16
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
Expression: snapshot
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
    0     0 │ success: true
    1     1 │ exit_code: 0
    2     2 │ ----- stdout -----
    3       │-[PYTHON-3.12]
          3 │+/usr/lib/python-exec/python3.13/python3
    4     4 │ 
    5       │------ stderr -----
          5 │+----- stderr -----
          6 │+DEBUG uv [VERSION] ([COMMIT] DATE)
          7 │+DEBUG Searching for Python interpreter in system toolchains
          8 │+TRACE Searching PATH for executables: python3, python
          9 │+TRACE Checking `PATH` directory for interpreters: /usr/bin
         10 │+TRACE Found possible Python executable: /usr/bin/python3
         11 │+TRACE Querying interpreter executable at /usr/bin/python3
         12 │+DEBUG Found cpython 3.13.0b2 at `/usr/bin/python3` (search path)
────────────┴───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</code></pre>
<p>Can you reopen the bug, or should I file a new one?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:29 UTC
    </footer>
</body>
</html>
