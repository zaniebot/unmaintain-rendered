<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Can we speed up installation/pyc compilation for reused inline packages. - astral-sh/uv #12960</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Can we speed up installation/pyc compilation for reused inline packages.</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/12960">#12960</a>
        opened by <a href="https://github.com/Light2Dark">@Light2Dark</a>
        on 2025-04-18 03:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Light2Dark">@Light2Dark</a> on 2025-04-18 03:41</div>
            <div class="timeline-body"><h3>Question</h3>
<p>Hey, I'm from the marimo team. We've noticed that if we create two python files with the same inline script deps, it takes a similar amount of time for the script to run. Here's the test script:</p>
<p><code>new.py</code></p>
<pre><code class="language-python"># /// script
# requires-python = &quot;&gt;=3.13&quot;
# dependencies = [
#     &quot;scikit-learn==1.6.1&quot;,
# ]
# ///

import time

start = time.perf_counter()
import sklearn

sklearn.__version__
elapsed = time.perf_counter() - start
print(f&quot;Time taken: {elapsed} seconds&quot;)
</code></pre>
<pre><code class="language-shell">uv run --compile-bytecode new.py
Installed 5 packages in 39ms
Bytecode compiled 1968 files in 738ms
Time taken: 12.03030412492808 seconds
</code></pre>
<p>Now, if I create another file, with the exact same content as the above and rename it to new_copy.py</p>
<pre><code class="language-shell">uv run --compile-bytecode new_copy.py
Installed 5 packages in 40ms
Bytecode compiled 1968 files in 706ms
Time taken: 18.827942791976966 seconds
</code></pre>
<p>What I expect is that the second script would take a much shorter time, because if I reran the first script again, it would be much much faster (~500ms). It'd be nice to understand what's happening ðŸ˜…. cc @akshayka</p>
<h3>Platform</h3>
<p>Darwin 24.3.0 arm64</p>
<h3>Version</h3>
<p>uv 0.6.14 (Homebrew 2025-04-09)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @Light2Dark on 2025-04-18 03:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-04-21 01:48</div>
            <div class="timeline-body"><p>Thanks for filing. I don't think the <code>.pyc</code> files are the issue here -- notice that bytecode compilation only takes 700ms, but <code>import sklearn</code> takes 12s and 18s. I think almost all of the time in <code>import sklearn</code> is spent loading shared objects into memory. You can watch this (on macOS at least) with <code>DYLD_PRINT_LIBRARIES=1 uv run new.py</code> -- you'll just see a stream like:</p>
<pre><code>dyld[10806]: &lt;E3A31AB3-3AE5-3371-87D0-7FD870A41A0D&gt; /Users/crmarsh/.cache/uv/environments-v2/baz-9c365906405eec04/lib/python3.13/site-packages/sklearn/.dylibs/libomp.dylib
</code></pre>
<p>If you run across a second environment, you'll see:</p>
<pre><code>dyld[10905]: &lt;E3A31AB3-3AE5-3371-87D0-7FD870A41A0D&gt; /Users/crmarsh/.cache/uv/environments-v2/bar-80505d6015bc5369/lib/python3.13/site-packages/sklearn/.dylibs/libomp.dylib
</code></pre>
<p>Note that the UUIDs are the same, but I guess the OS doesn't treat them as the same physical file and so they get loaded twice.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Light2Dark">@Light2Dark</a> on 2025-04-23 13:56</div>
            <div class="timeline-body"><p>Thank you, that makes sense. Likely using a common env is suitable for this use case. Happy to close this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-04-23 13:58</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:03 UTC
    </footer>
</body>
</html>
