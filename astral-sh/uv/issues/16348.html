<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provide a way for `uv lock` to ignore and replace existing and/or broken `uv.lock` files - astral-sh/uv #16348</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Provide a way for `uv lock` to ignore and replace existing and/or broken `uv.lock` files</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/16348">#16348</a>
        opened by <a href="https://github.com/namurphy">@namurphy</a>
        on 2025-10-17 19:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/namurphy">@namurphy</a> on 2025-10-17 19:58</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>There are occasions when <code>uv.lock</code> breaks, in particular when there is a git merge conflict (#5633, #11185).  When <code>uv.lock</code> is not a valid TOML file, running <code>uv lock</code> or <code>uv lock --upgrade</code> results in an error.  Potential workarounds for lockfile merge conflicts are ~~to manually delete <code>uv.lock</code> before running <code>uv lock</code> again, or~~ to check out <code>uv.lock</code> from one of the branches before running <code>uv.lock</code>.</p>
<p>It would be helpful if there was a graceful way to recreate <code>uv.lock</code> that works even when there is a merge conflict or problem with <code>uv.lock</code>.  Two possibilities would be to:</p>
<ol>
<li>Create a new option for <code>uv lock</code> to ignore and replace existing lockfiles (perhaps <code>--replace</code>, <code>--recreate</code>, or <code>--redo</code>?)</li>
<li>~~Have <code>uv lock --upgrade</code> create a fresh new <code>uv.lock</code> instead of failing when the current <code>uv.lock</code> is invalid, possibly while issuing a warning.~~</li>
</ol>
<p>Doing <code>uv lock --replace</code> (option 1) wouldn't change the behavior of existing options, would be more deterministic, and would be intuitive with the right name.</p>
<p>~~Enabling <code>uv lock --upgrade</code> to replace broken <code>uv.lock</code> files (option 2) seems intuitive since my mental model with this command is to upgrade the environment to include the ≈newest allowed versions of dependencies, but would change the behavior of existing options.~~ ← Replacing <code>uv.lock</code> would unpin versions, so this approach would likely cause things to break.</p>
<p>Thank you as always!</p>
<h3>Example</h3>
<p>Start by creating a project with a broken <code>uv.lock</code>.</p>
<pre><code class="language-bash">$ uv init
$ uv lock
$ echo &quot;reminder: adding text to uv.lock will break it!&quot; &gt;&gt; uv.lock
</code></pre>
<p>Running <code>uv lock</code> or <code>uv lock --upgrade</code> when <code>uv.lock</code> then gives the following error (with uv 0.9.3):</p>
<pre><code class="language-bash">$ uv lock --upgrade
Using CPython 3.13.3
error: Failed to parse `uv.lock`
  Caused by: TOML parse error at line 9, column 11
  |
9 | reminder: adding text to uv.lock will break it!
  |           ^
key with no value, expected `=`
</code></pre>
<p>My desired behavior would be something like:</p>
<pre><code class="language-bash">$ uv lock --replace
Using CPython 3.13.3
Resolved 1 package in 1ms
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @namurphy on 2025-10-17 19:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/11185.html">astral-sh/uv#11185</a> on 2025-10-17 20:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-10-17 20:19</div>
            <div class="timeline-body"><p>The <code>--force</code> flag seems like a good candidate for this behavior, xref #15757</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-10-17 20:21</div>
            <div class="timeline-body"><blockquote>
<p>Potential workarounds for lockfile merge conflicts are to manually delete uv.lock before running uv lock again, or to check out uv.lock from one of the branches before running uv.lock.</p>
</blockquote>
<p>Only the latter is appropriate for merge conflicts. The former will unpin any versions, and should generally not be used unless there's no recourse.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/namurphy">@namurphy</a> on 2025-10-20 17:21</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>Potential workarounds for lockfile merge conflicts are to manually delete uv.lock before running uv lock again, or to check out uv.lock from one of the branches before running uv.lock.</p>
</blockquote>
<p>Only the latter is appropriate for merge conflicts. The former will unpin any versions, and should generally not be used unless there's no recourse.</p>
</blockquote>
<p>That is helpful to know! Given that replacing <code>uv.lock</code> would unpin any versions, it seems very likely that having <code>uv lock --upgrade</code> replace a <code>uv.lock</code> with a merge conflict (option 2) would cause problems. I'll adjust the issue accordingly. Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-10-20 18:39</div>
            <div class="timeline-body"><p>Should we skip reading the lockfile altogether with <code>--upgrade</code>? This circumvents this problem and it's faster.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> removed by @konstin on 2025-12-18 16:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @konstin on 2025-12-18 16:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:30 UTC
    </footer>
</body>
</html>
