<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Non-base packages don't collapse versions in resolution conflict traces. - astral-sh/uv #15199</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Non-base packages don't collapse versions in resolution conflict traces.</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/15199">#15199</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2025-08-10 11:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/konstin">@konstin</a> on 2025-08-10 11:20</div>
            <div class="timeline-body"><p><strong>Summary</strong> Error messages for non-base package, i.e. those with a marker, a badly verbose.</p>
<p>Let's build a simple conflict:</p>
<pre><code class="language-toml">requires-python = &quot;&gt;=3.9&quot;
dependencies = [
  &quot;anyio&gt;=4.4.0&quot;,
  &quot;anyio&lt;=4.3.0&quot;,
]
</code></pre>
<p>We get a 2 line error with a succinct explanation:</p>
<pre><code>  × No solution found when resolving dependencies:
  ╰─▶ Because your project depends on anyio&gt;=4.4.0 and anyio&lt;=4.3.0, we can conclude that your project's requirements are unsatisfiable.
</code></pre>
<p>Let's add a marker: The conflict is still the same.</p>
<pre><code>requires-python = &quot;&gt;=3.9&quot;
dependencies = [
  &quot;anyio&gt;=4.4.0&quot;,
  &quot;anyio&lt;=4.3.0; sys_platform == 'linux'&quot;,
]
</code></pre>
<p>We get a 42 line error for the same problem:</p>
<pre><code>  × No solution found when resolving dependencies for split (markers: sys_platform == 'linux'):
  ╰─▶ Because only the following versions of anyio{sys_platform == 'linux'} are available:
          anyio{sys_platform == 'linux'}==1.0.0
          anyio{sys_platform == 'linux'}==1.1.0
          anyio{sys_platform == 'linux'}==1.2.0
          anyio{sys_platform == 'linux'}==1.2.1
          anyio{sys_platform == 'linux'}==1.2.2
          anyio{sys_platform == 'linux'}==1.2.3
          anyio{sys_platform == 'linux'}==1.3.0
          anyio{sys_platform == 'linux'}==1.3.1
          anyio{sys_platform == 'linux'}==1.4.0
          anyio{sys_platform == 'linux'}==2.0.0
          anyio{sys_platform == 'linux'}==2.0.1
          anyio{sys_platform == 'linux'}==2.0.2
          anyio{sys_platform == 'linux'}==2.1.0
          anyio{sys_platform == 'linux'}==2.2.0
          anyio{sys_platform == 'linux'}==3.0.0
          anyio{sys_platform == 'linux'}==3.0.1
          anyio{sys_platform == 'linux'}==3.1.0
          anyio{sys_platform == 'linux'}==3.2.0
          anyio{sys_platform == 'linux'}==3.2.1
          anyio{sys_platform == 'linux'}==3.3.0
          anyio{sys_platform == 'linux'}==3.3.1
          anyio{sys_platform == 'linux'}==3.3.2
          anyio{sys_platform == 'linux'}==3.3.3
          anyio{sys_platform == 'linux'}==3.3.4
          anyio{sys_platform == 'linux'}==3.4.0
          anyio{sys_platform == 'linux'}==3.5.0
          anyio{sys_platform == 'linux'}==3.6.0
          anyio{sys_platform == 'linux'}==3.6.1
          anyio{sys_platform == 'linux'}==3.6.2
          anyio{sys_platform == 'linux'}==3.7.0
          anyio{sys_platform == 'linux'}==3.7.1
          anyio{sys_platform == 'linux'}==4.0.0
          anyio{sys_platform == 'linux'}==4.1.0
          anyio{sys_platform == 'linux'}==4.2.0
          anyio{sys_platform == 'linux'}&gt;=4.3.0
      and your project depends on anyio&gt;=4.4.0, we can conclude that your project and anyio{sys_platform == 'linux'}&lt;=4.3.0 are incompatible.
      And because your project depends on anyio{sys_platform == 'linux'}&lt;=4.3.0, we can conclude that your project's requirements are
      unsatisfiable.

      hint: Pre-releases are available for `anyio` in the requested range (e.g., 4.0.0rc1), but pre-releases weren't enabled (try:
      `--prerelease=allow`)
</code></pre>
<p>Let's add 2 markers:</p>
<pre><code class="language-toml">requires-python = &quot;&gt;=3.9&quot;
dependencies = [
  &quot;anyio&lt;=4.3.0; sys_platform == 'linux'&quot;,
  &quot;anyio&gt;=4.4.0; python_version &lt; '3.11'&quot;,
]
</code></pre>
<p>We get a 700 line error with repeated listings of all sorts of anyio versions: https://gist.github.com/konstin/be22add47c5695ce79b56f9a63b85b75</p>
<p>The problem is that a) pubgrub does not realize that <code>foo{&lt;marker&gt;}</code> of a range implies <code>foo</code> of that range, and that b) we don't simplify <code>foo{&lt;marker&gt;}</code> of a range implies <code>foo</code> of that range in errors, skipping over enumerating the versions of <code>foo{marker}</code> when they are the same as <code>foo</code>. It is a also a performance concern, since we're trying all those versions of <code>foo{&lt;marker&gt;}</code>, when we could use a single combined incompatibility.</p>
<p>The examples above are MREs, but I'm seeing these long lists with real resolutions too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">error messages</span> added by @konstin on 2025-08-10 11:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/15200.html">astral-sh/uv#15200</a> on 2025-08-10 11:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-08-10 11:28</div>
            <div class="timeline-body"><p>CC @eh2406 You may be interested in this and https://github.com/astral-sh/uv/pull/15200. I'm interested in what you think about this problem (pubgrub can't see past proxy packages to the base packages) and the attempt in the branch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/15201.html">astral-sh/uv#15201</a> on 2025-08-10 11:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-09-22 11:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:33:11 UTC
    </footer>
</body>
</html>
