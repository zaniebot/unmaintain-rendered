<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pip compile --no-deps fails with extras - astral-sh/uv #1801</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>pip compile --no-deps fails with extras</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/1801">#1801</a>
        opened by <a href="https://github.com/mitsuhiko">@mitsuhiko</a>
        on 2024-02-21 09:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mitsuhiko">@mitsuhiko</a></div>
            <div class="timeline-body"><p>It looks like the <code>--no-deps</code> mode somehow fails with <code>pip-compile</code> when extras are specified.</p>
<pre><code>$ echo &#x27;flask[dotenv]&#x27; | uv pip compile - --no-deps
thread &#x27;main&#x27; panicked at crates/uv-resolver/src/resolution.rs:136:29:
Every package should have metadata: NameVersion(PackageName(&quot;flask&quot;), &quot;3.0.2&quot;)
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre>
<p>vs</p>
<pre><code>$ echo &#x27;flask[dotenv]&#x27; | uv pip compile -
# This file was autogenerated by uv via the following command:
#    uv pip compile -
blinker==1.7.0
    # via flask
click==8.1.7
    # via flask
flask==3.0.2
itsdangerous==2.1.2
    # via flask
jinja2==3.1.3
    # via flask
markupsafe==2.1.5
    # via
    #   jinja2
    #   werkzeug
python-dotenv==1.0.1
    # via flask
werkzeug==3.0.1
    # via flask
</code></pre>
<p>Happens with <code>uv 0.1.6</code> and earlier.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/konstin">@konstin</a> on 2024-02-21 10:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-21 12:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-21 14:19</div>
            <div class="timeline-body"><p>Fixing now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-21 14:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-22 05:00</div>
            <div class="timeline-body"><p>Should be fixed in v0.1.7 (out now).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rachtsingh">@rachtsingh</a> on 2024-02-24 19:58</div>
            <div class="timeline-body"><p>Is this fixed? I think the final result should be <code>flask[dotenv]==3.0.2</code>, at least that&#x27;s what <code>pip-compile</code> tells me:</p>
<pre><code>~$ echo &#x27;flask[dotenv]&#x27; | pip-compile - --output-file test.in
WARNING: --strip-extras is becoming the default in version 8.0.0. To silence this warning, either use --strip-extras to opt into the new default or use --no-strip-extras to retain the existing behavior.
#
# This file is autogenerated by pip-compile with Python 3.10
# by the following command:
#
#    pip-compile --output-file=test.in -
#
blinker==1.7.0
    # via flask
click==8.1.7
    # via flask
flask[dotenv]==3.0.2
    # via -r -
itsdangerous==2.1.2
    # via flask
jinja2==3.1.3
    # via flask
markupsafe==2.1.5
    # via
    #   jinja2
    #   werkzeug
python-dotenv==1.0.1
    # via flask
werkzeug==3.0.1
    # via flask
</code></pre>
<p>with uv (0.1.10):</p>
<pre><code>~ ❯ echo &#x27;flask[dotenv]&#x27; | uv pip compile -
Resolved 8 packages in 8ms
# This file was autogenerated by uv via the following command:
#    uv pip compile -
blinker==1.7.0
    # via flask
click==8.1.7
    # via flask
flask==3.0.2
itsdangerous==2.1.2
    # via flask
jinja2==3.1.3
    # via flask
markupsafe==2.1.5
    # via
    #   jinja2
    #   werkzeug
python-dotenv==1.0.1
    # via flask
werkzeug==3.0.1
    # via flask
</code></pre>
<p>I think this is the cause of <a href="https://github.com/mitsuhiko/rye/issues/745">mitsuhiko/rye#745</a>, and a related JAX issue I filed with rye.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rachtsingh">@rachtsingh</a> on 2024-02-24 20:12</div>
            <div class="timeline-body"><p>Oh, I see - <code>python-dotenv</code> is included in both places, which is why <code>uv pip install flask[dotenv]</code> works correctly, but <code>rye add flask[dotenv]</code> breaks because it tries to desugar the feature into <code>flask==3.0.2</code> and <code>python-dotenv==1.0.1</code>, and <code>rye</code> only matches against the first.</p>
<p>I&#x27;m not familiar enough with the implications and uv&#x27;s goals to say this isn&#x27;t what uv wants, but I would personally prefer if <code>uv pip compile</code> did <em>not</em> expand <code>flask[dotenv]</code> to <code>flask + python-dotenv</code>, at least from rye&#x27;s perspective (for example if I type <code>rye add flask[dotenv]</code> I want <code>flask[dotenv]==3.0.2</code> in my <code>pyproject.toml</code>. Maybe there&#x27;s a higher level API rye could be using instead (I think currently spawning a subprocess)? Let me know if you want me to create a new issue for visibility/clarity.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-24 22:21</div>
            <div class="timeline-body"><p>I believe what <code>uv</code> is doing is correct. It&#x27;s right to omit the <code>[dotenv]</code> in the output file, since it doesn&#x27;t have any meaning (the &quot;extras&quot; are already included by way of including the dependencies themselves). You can see with the <code>--strip-extras is becoming the default in version 8.0.0.</code> warning that <code>pip-tools</code> is moving to that default soon (IIUC).</p>
<p>It seems like the issue here is around <code>rye add</code> with extras, which it&#x27;s using to lock the correct version of a single dependency. I think <code>rye</code> either needs to re-add the extra with some manual parsing, or we&#x27;d need a flag or another workflow for it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-26 21:11</div>
            <div class="timeline-body"><p>I tried <code>rye add &quot;flask[dotenv]&quot;</code> and it added the &quot;right&quot; dependency:</p>
<pre><code>--- a/pyproject.toml
+++ b/pyproject.toml
@@ -30,6 +30,9 @@ classifiers = [
   &quot;Topic :: Software Development :: Libraries&quot;,
 ]
 readme = &quot;README.md&quot;
+dependencies = [
+    &quot;flask[dotenv]&gt;=3.0.2&quot;,
+]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rachtsingh">@rachtsingh</a> on 2024-02-26 21:25</div>
            <div class="timeline-body"><p>Huh, I have a different result (maybe it&#x27;s a zsh issue?):</p>
<pre><code>~/proj/test-proj main ?5 ❯ rye add &quot;flask[dotenv]&quot;
Initializing new virtualenv in /home/singhrac/proj/test-proj/.venv
Python version: cpython@3.12.1
Added flask&gt;=3.0.2 as regular dependency
Reusing already existing virtualenv
Generating production lockfile: /home/singhrac/proj/test-proj/requirements.lock
Generating dev lockfile: /home/singhrac/proj/test-proj/requirements-dev.lock
Installing dependencies
   Built file:///home/singhrac/proj/test-proj                                                                                                                  Built 1 editable in 202ms
Resolved 1 package in 1ms
Downloaded 1 package in 35ms
Installed 8 packages in 7ms
 + blinker==1.7.0
 + click==8.1.7
 + flask==3.0.2
 + itsdangerous==2.1.2
 + jinja2==3.1.3
 + markupsafe==2.1.5
 + test-proj==0.1.0 (from file:///home/singhrac/proj/test-proj)
 + werkzeug==3.0.1
Done!
~/proj/test-proj main ?7 ❯ cat pyproject.toml
[project]
name = &quot;test-proj&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
authors = [
    { name = &quot;Rachit Singh&quot;, email = &quot;rachitsingh@outlook.com&quot; }
]
dependencies = [
    &quot;flask&gt;=3.0.2&quot;,
]
readme = &quot;README.md&quot;
requires-python = &quot;&gt;= 3.8&quot;

[build-system]
requires = [&quot;hatchling&quot;]
build-backend = &quot;hatchling.build&quot;

[tool.rye]
managed = true
dev-dependencies = []

[tool.hatch.metadata]
allow-direct-references = true

[tool.hatch.build.targets.wheel]
packages = [&quot;src/test_proj&quot;]
</code></pre>
<p>Do you have rye configured to use <code>uv</code> by default (i.e. <code>rye config --set-bool behavior.use-uv=true</code>)? I think it works that way when that flag is off (when it uses <code>pip-compile</code> + its semantics, which as you pointed out is going to be deprecated).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-26 23:09</div>
            <div class="timeline-body"><p>Thanks, I had to set the Rye config! It&#x27;s a Rye issue. I&#x27;ll open one there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-26 23:11</div>
            <div class="timeline-body"><p>@rachtsingh - Tracking as <a href="https://github.com/astral-sh/rye/issues/745">astral-sh/rye#745</a> (existing issue in Rye).</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:29:51 UTC
    </footer>
</body>
</html>
