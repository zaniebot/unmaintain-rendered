<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keyring stderr is not displayed - astral-sh/uv #4162</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Keyring stderr is not displayed</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/4162">#4162</a>
        opened by <a href="https://github.com/Rogdham">@Rogdham</a>
        on 2024-06-08 15:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Rogdham">@Rogdham</a> on 2024-06-08 15:27</div>
            <div class="timeline-body"><p>When calling <code>keyring</code> as a subprocess, its <code>stderr</code> is hidden when using <code>uv</code> version 0.2.9 on Linux while <code>pip</code> version 24.0 displays it to the user.</p>
<p>Showing the <code>stderr</code> output seems important as it allows <code>keyring</code> to tell what's wrong in case of error or to ask user to perform some actions (e.g. clicking on an URL for authentication via a web browser).</p>
<h3>Preparation</h3>
<p>I have modified my <code>$PATH</code> variable so that the <code>keyring</code> binary is the following:</p>
<pre><code class="language-bash">#!/bin/bash
echo &quot;  ~~~&gt; KEYRING: called with $@&quot; &gt;&amp;2
exit 1
</code></pre>
<p>Also I have a web server on <code>localhost:8000</code> that returns a 401 error no matter what.</p>
<h3>UV</h3>
<pre><code>$ uv pip install --keyring-provider subprocess --index-url=http://user@localhost:8000/simple/ custompkg==0.0.1
  × No solution found when resolving dependencies:
  ╰─▶ Because custompkg was not found in the package registry and you require custompkg==0.0.1, we can conclude that the requirements are unsatisfiable.
</code></pre>
<details><summary>With trace info</summary>
<p>

<pre><code>$ RUST_LOG=uv=trace uv pip install --keyring-provider subprocess --index-url=http://user@localhost:8000/simple/ custompkg==0.0.1 --verbose
DEBUG Searching for Python interpreter in virtual environments
TRACE Cached interpreter info for Python 3.12.3, skipping probing: uv/bin/python3
DEBUG Found CPython 3.12.3 at `/redacted/bin/python3` (active virtual environment)
DEBUG Using Python 3.12.3 environment at uv/bin/python3
TRACE Checking lock for `uv`
DEBUG Acquired lock for `uv`
DEBUG At least one requirement is not satisfied: custompkg==0.0.1
TRACE Caching credentials for http://user@localhost:8000/simple/
DEBUG Using registry request timeout of 30s
DEBUG Solving with installed Python version: 3.12.3
DEBUG Adding direct dependency: custompkg==0.0.1
TRACE Fetching metadata for custompkg from http://user@localhost:8000/simple/custompkg/
TRACE No cache entry exists for /home/redacted/.cache/uv/simple-v8/7fc49dbfbd1b2ee9/custompkg.rkyv
DEBUG No cache entry for: http://localhost:8000/simple/custompkg/
TRACE Sending fresh GET request for http://localhost:8000/simple/custompkg/
TRACE Handling request for http://user@localhost:8000/simple/custompkg/
TRACE Request for http://user@localhost:8000/simple/custompkg/ is missing a password, looking for credentials
TRACE No password in cache for realm user@http://localhost:8000
DEBUG Checking netrc for credentials for http://localhost:8000/simple/custompkg/
DEBUG Checking keyring for credentials for user@http://localhost:8000/simple/custompkg/
TRACE Checking keyring for URL http://localhost:8000/simple/custompkg/
TRACE Checking keyring for host localhost
TRACE Received package metadata for: custompkg
DEBUG Searching for a compatible version of custompkg (==0.0.1)
TRACE selecting candidate for package custompkg with range Range { segments: [(Included(&quot;0.0.1&quot;), Included(&quot;0.0.1&quot;))] } with 0 remote versions
DEBUG No compatible version found for: custompkg
  × No solution found when resolving dependencies:
  ╰─▶ Because custompkg was not found in the package registry and you require custompkg==0.0.1, we can conclude that the requirements are unsatisfiable.
</code></pre>
</p>
</details> 

<h3>Pip</h3>
<pre><code>$ PIP_FORCE_KEYRING=1 PIP_KEYRING_PROVIDER=subprocess pip install --index-url http://user@localhost:8000/simple/ custompkg==0.0.1
Looking in indexes: http://****@localhost:8000/simple/
  ~~~&gt; KEYRING: called with get http://localhost:8000/simple/ user
  ~~~&gt; KEYRING: called with get localhost:8000 user
WARNING: 401 Error, Credentials not correct for http://localhost:8000/simple/custompkg/
ERROR: Could not find a version that satisfies the requirement custompkg==0.0.1 (from versions: none)
ERROR: No matching distribution found for custompkg==0.0.1
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-08 17:01</div>
            <div class="timeline-body"><p>Thanks for raising this issue.</p>
<p>If someone wants to look into forwarding the output, it should be relatively simple. I'm not sure if we should do it always or just on failure?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @zanieb on 2024-06-08 17:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">tracing</span> added by @zanieb on 2024-06-08 17:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Rogdham">@Rogdham</a> on 2024-06-08 18:00</div>
            <div class="timeline-body"><blockquote>
<p>If someone wants to look into forwarding the output, it should be relatively simple. I'm not sure if we should do it always or just on failure?</p>
</blockquote>
<p>I suggest to always display <code>keyring</code>'s <code>stderr</code>.</p>
<p>First, this is what <code>pip</code> is doing.</p>
<p>And foremost because it allows the keyring plugin to do some kind of user interaction. A typical example would to ask the user to open a browser to finalize authentication, displaying a message like the following:</p>
<pre><code>Visit https://auth.example.com/?nonce=ABCDEF to authenticate
</code></pre>
<p><em>This would be the case of <code>artifacts-keyring</code> plugin for Azure Devops Artifact, except for https://github.com/microsoft/artifacts-keyring/pull/73. In fact this ticket might be needed for #3260.</em></p>
<p>As a result, please don't wait for the <code>keyring</code> command to terminate before displaying its <code>stderr</code> to the user!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-08 18:20</div>
            <div class="timeline-body"><p>I don't think we support interactive keyring prompts at all right now, we might need to consider what that looks like more holistically.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Rogdham">@Rogdham</a> on 2024-06-09 06:17</div>
            <div class="timeline-body"><blockquote>
<p>interactive keyring prompts</p>
</blockquote>
<p>Just to be clear on that, in my last message I was speaking about displaying <code>keyring</code>'s <code>stderr</code> to the end user as soon as it is available (without waiting for the <code>keyring</code> process to terminate). I was not speaking at all about sending <code>uv</code>'s <code>stdin</code> to <code>keyring</code>'s <code>stdin</code>.</p>
<p>So maybe there are 3 levels of implementation:</p>
<ol>
<li>Display <code>keyring</code>'s <code>stderr</code> to the user when the <code>keyring</code> process is terminated</li>
<li>Display <code>keyring</code>'s <code>stderr</code> to the user as soon as it is available (streaming)</li>
<li>Last point plus allow the user to pass input to <code>keyring</code>'s <code>stdin</code></li>
</ol>
<p>As far as I'm concerned, level 2 would be good enough for me (this is <a href="https://github.com/pypa/pip/blob/main/src/pip/_internal/network/auth.py#L137-L142">what <code>pip</code> does</a>), and level 1 would be a good step forward. Of course you decide on what you want to support!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4343.html">astral-sh/uv#4343</a> on 2024-06-16 18:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-06-17 18:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Rogdham">@Rogdham</a> on 2024-06-17 19:03</div>
            <div class="timeline-body"><p>I'm confirming #4343 fixes this issue by displaying <code>keyring</code>'s <code>stderr</code> to the user as soon as it is available :tada:</p>
<p>Thanks @samypr100  @zanieb :hugs:</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:28 UTC
    </footer>
</body>
</html>
