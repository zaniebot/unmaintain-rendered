```yaml
number: 8924
title: "Weird resolution error with `uv==0.5.0` and unsatisfiable requirements"
type: issue
state: open
author: jamesbraza
labels:
  - bug
  - needs-mre
assignees: []
created_at: 2024-11-08T07:49:56Z
updated_at: 2024-11-08T20:26:23Z
url: https://github.com/astral-sh/uv/issues/8924
synced_at: 2026-01-10T01:57:20Z
```

# Weird resolution error with `uv==0.5.0` and unsatisfiable requirements

---

_Issue opened by @jamesbraza on 2024-11-08 07:49_

I have a situation where: package `b` depends on `a`, and `a` has `b` as an extra. Or more concretely, `a` = [`fhaviary`](https://pypi.org/project/fhaviary/) and `b` = [`paper-qa`](https://pypi.org/project/paper-qa/)

This leads to a weird `uv sync` resolution error:

```none
  Ã— No solution found when resolving dependencies for split
  â”‚ (python_full_version == '3.11.*' and platform_python_implementation ==
  â”‚ 'PyPy'):
  â•°â”€â–¶ Because only the following versions of paper-qa are available:
          paper-qa<=5.0.0
          paper-qa==5.0.1
...
          paper-qa==5.3.1
          paper-qa==5.3.2
      and paper-qa==5.3.2 depends on fhaviary, we can conclude that
      paper-qa>5.3.1 depends on fhaviary.
      And because paper-qa>=5.0.0,<=5.3.1 depends on fhaviary, we can conclude
      that paper-qa>=5.0.0 depends on fhaviary.
      And because fhaviary[paperqa] depends on paper-qa>=5 and your workspace
      requires fhaviary[paperqa], we can conclude that your workspace's
      requirements are unsatisfiable.

      hint: The package `paper-qa` depends on the package `fhaviary` but the
      name is shadowed by one of your workspace members. Consider changing the
      name of the workspace member.
```

So to break it down:
1. The statement that "paper-qa>=5.0.0 depends on fhaviary" is correct ðŸ¥³
2. Then "fhaviary[paperqa] depends on paper-qa>=5 and your workspace
      requires fhaviary[paperqa]" is also correct
3. However, "we can conclude that your workspace's requirements are unsatisfiable" is incorrect

Why can't `uv` realize `fhaviary` is the same in both places? Here is my `pyproject.toml`:

```toml
[project]
...
name = "fhaviary"
...
requires-python = ">=3.11"

[tool.uv.sources]
"aviary.gsm8k" = {workspace = true}
"aviary.hotpotqa" = {workspace = true}
fhaviary = {workspace = true}

[tool.uv.workspace]
members = ["packages/*"]
```

My set up was working fine just a few days ago :/

---

_Renamed from "Weird resolution error with `uv==0.5.0` and " to "Weird resolution error with `uv==0.5.0` and unsatisfiable requirements" by @jamesbraza on 2024-11-08 07:50_

---

_Label `bug` added by @konstin on 2024-11-08 11:16_

---

_Comment by @charliermarsh on 2024-11-08 14:55_

Can you bisect the uv version in which this stopped working for you? Or provide a reproduction we can use to debug?

---

_Label `needs-mre` added by @charliermarsh on 2024-11-08 14:55_

---

_Comment by @jamesbraza on 2024-11-08 19:16_

I tried bisecting just now and am seeing weird stuff. Note this issue does not occur on my Mac, just in GitHub Actions:

- 3 days ago (11/5/2024) with `uv==0.4.30`: both `uv sync` and `uv sync --python-preference=only-managed` work
- Yesterday (11/7/2024) with `uv==0.4.30`: `uv sync` works, and `uv sync --python-preference=only-managed` hit this error
- Yesterday (11/7/2024) with `uv==0.5.0`: both `uv sync` and `uv sync --python-preference=only-managed` hit this error

And neither repo (https://github.com/Future-House/aviary and https://github.com/Future-House/paper-qa) changed their dependencies. Looking at the `uv sync --verbose` logs with `uv==0.4.30`:

```none
DEBUG Solving with installed Python version: 3.12.7
DEBUG Solving with target Python version: >=3.12.7
```

And with `uv==0.5.0`:

```none
DEBUG Solving with installed Python version: 3.12.7
DEBUG Solving with target Python version: >=3.11
```

So this seems to be different. I am still digging

---

_Comment by @zanieb on 2024-11-08 19:29_

Since your project has `requires-python = ">=3.11"` it seems like it'd make sense to solve with that target Python version range.

---

_Comment by @zanieb on 2024-11-08 19:29_

If you set `UV_INTERNAL__SHOW_DERIVATION_TREE=1` we might get some information that's helpful for understanding the error message.

---

_Comment by @jamesbraza on 2024-11-08 19:53_

Okay, I figured it out, but still don't know why it suddenly broke.

---

Firstly, thank you @zanieb for the `UV_INTERNAL__SHOW_DERIVATION_TREE=1` tip. This is the same GitHub Action CI [logs without](https://github.com/Future-House/aviary/actions/runs/11747999443/job/32731143534) and [logs with](https://github.com/Future-House/aviary/actions/runs/11748489012/job/32732666524) that, and they seems identical to me. I am not sure if I am missing something there, but perhaps `UV_INTERNAL__SHOW_DERIVATION_TREE` didn't actually cover this case

---

So the `paper-qa` (package `b`) in my scenario has: `fhaviary[llm]>=0.8.2`. I observed in `fhaviary`'s CI logs:

```none
Installed 124 packages in 121ms
...
 + fhaviary==0.1.dev1+g6ddf4a0 (from file:///home/runner/work/aviary/aviary)
```

This is wrong, `fhaviary` should be at least `0.9.1` ðŸ”¥ . And `fhaviary` uses `setuptools-scm` for its backend. This led me to https://github.com/pypa/setuptools-scm/issues/952, which shows me I need:

```diff
      - uses: actions/checkout@v4
+++        with:
+++          fetch-depth: 0 # For setuptools-scm
```

---

I tried to think of a possible way for `uv` to improve from this, and I have concluded the best way is for a more precise impossible resolution message. Here's the original one:

```none
      And because paper-qa>=5.0.0,<=5.3.1 depends on fhaviary, we can conclude
      that paper-qa>=5.0.0 depends on fhaviary.
      And because fhaviary[paperqa] depends on paper-qa>=5 and your workspace
      requires fhaviary[paperqa], we can conclude that your workspace's
      requirements are unsatisfiable.
```

What I think `uv` should have said was (note that `paper-qa==5.0.0` depended on `fhaviary[llm]>=0.6`):

```none
      And because paper-qa>=5.0.0,<=5.3.1 depends on fhaviary>=0.6, we can conclude
      that paper-qa>=5.0.0 depends on fhaviary>=0.6.
      And because fhaviary[paperqa]==0.1.dev1+g6ddf4a0 depends on paper-qa>=5 and your workspace
      requires fhaviary[paperqa]==0.1.dev1+g6ddf4a0, we can conclude that your workspace's
      requirements are unsatisfiable.
```

Note that basically more versions were added to this message. What do you think?

Also, feel free to close this out

---

_Comment by @zanieb on 2024-11-08 19:57_

The derivation tree is logged right before the resolver error

```
Resolver derivation tree before reduction
  root==0a0.dev0 depends on fhaviary[paperqa]*
    no versions of fhaviary[paperqa]<0.1.dev1+gd3c1bb2.d20241108 | >0.1.dev1+gd3c1bb2.d20241108
      fhaviary[paperqa]==0.1.dev1+gd3c1bb2.d20241108 depends on paper-qa>=5
          paper-qa==5.3.2 depends on fhaviary>=0.8.2
          no versions of paper-qa>5.0.0, <5.0.1 | >5.0.1, <5.0.2 | >5.0.2, <5.0.3 | >5.0.3, <5.0.4 | >5.0.4, <5.0.5 | >5.0.5, <5.0.6 | >5.0.6, <5.0.7 | >5.0.7, <5.0.8 | >5.0.8, <5.0.9 | >5.0.9, <5.0.10 | >5.0.10, <5.1.0 | >5.1.0, <5.1.1 | >5.1.1, <5.2.0 | >5.2.0, <5.2.1 | >5.2.1, <5.3.0 | >5.3.0, <5.3.1 | >5.3.1, <5.3.2 | >5.3.2
        paper-qa==5.0.0 | ==5.0.1 | ==5.0.2 | ==5.0.3 | ==5.0.4 | ==5.0.5 | ==5.0.6 | ==5.0.7 | ==5.0.8 | ==5.0.9 | ==5.0.10 | ==5.1.0 | ==5.1.1 | ==5.2.0 | ==5.2.1 | ==5.3.0 | ==5.3.1 depends on fhaviary>=0.6
Resolver derivation tree after reduction
  root==0a0.dev0 depends on fhaviary[paperqa]*
    fhaviary[paperqa]==0.1.dev1+gd3c1bb2.d20241108 depends on paper-qa>=5
        paper-qa==5.3.2 depends on fhaviary>=0.8.2
        no versions of paper-qa>5.0.0, <5.0.1 | >5.0.1, <5.0.2 | >5.0.2, <5.0.3 | >5.0.3, <5.0.4 | >5.0.4, <5.0.5 | >5.0.5, <5.0.6 | >5.0.6, <5.0.7 | >5.0.7, <5.0.8 | >5.0.8, <5.0.9 | >5.0.9, <5.0.10 | >5.0.10, <5.1.0 | >5.1.0, <5.1.1 | >5.1.1, <5.2.0 | >5.2.0, <5.2.1 | >5.2.1, <5.3.0 | >5.3.0, <5.3.1 | >5.3.1, <5.3.2 | >5.3.2
      paper-qa==5.0.0 | ==5.0.1 | ==5.0.2 | ==5.0.3 | ==5.0.4 | ==5.0.5 | ==5.0.6 | ==5.0.7 | ==5.0.8 | ==5.0.9 | ==5.0.10 | ==5.1.0 | ==5.1.1 | ==5.2.0 | ==5.2.1 | ==5.3.0 | ==5.3.1 depends on fhaviary>=0.6
```

---

_Comment by @zanieb on 2024-11-08 19:57_

It looks like we're leaving out an important part of the version during display.

---

_Comment by @jamesbraza on 2024-11-08 20:02_

Ah nice, thanks for following up per the resolver derivation tree. I can see in that resolver derivation tree that `uv` was able to discern `fhaviary>=0.6`, nice!

So yeah I agree with your interpretation that including more versions in the display is good

---

_Comment by @charliermarsh on 2024-11-08 20:03_

@zanieb -- Apologies as I haven't been reading closely, but could it be related to the transforms we added in v0.5 around local versions?

---

_Comment by @zanieb on 2024-11-08 20:26_

I don't think so, the transformed tree looks fine. Did you adjust the display of local segments? Maybe we've just never rendered them? I'd have to look at the implementation.

---
