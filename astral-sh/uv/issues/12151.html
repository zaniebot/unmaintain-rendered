<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>python run by uv is not the real python process - astral-sh/uv #12151</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>python run by uv is not the real python process</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/12151">#12151</a>
        opened by <a href="https://github.com/fabioz">@fabioz</a>
        on 2025-03-13 12:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/fabioz">@fabioz</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>As far as I understand, this is by design, but it still gives me headaches, so, reporting as bug (feel free to move to feature request or close if it will never be changed).</p>
<p>i.e.: in some code as:</p>
<pre><code>def main():
    import os
    import sys

    print(sys.executable)
    if len(sys.argv) &gt; 1 and sys.argv[1] == &quot;check subprocess&quot;:
        print(&quot;In subprocess&quot;, sys.executable, &quot;pid&quot;, os.getpid())

    else:
        import subprocess

        opened_process = subprocess.Popen(
            [sys.executable, __file__, &quot;check subprocess&quot;]
        )
        print(&quot;Current process&quot;, os.getpid())
        print(&quot;Opened process&quot;, opened_process.pid)


if __name__ == &quot;__main__&quot;:
    main()
</code></pre>
<p>the output is actually:</p>
<pre><code>&lt;path&gt;\.venv\Scripts\python.exe
Current process 8188
Opened process 26060
&lt;path&gt;\.venv\Scripts\python.exe
In subprocess &lt;path&gt;\.venv\Scripts\python.exe pid 25536
</code></pre>
<p>So, there are 3 different processes in play! Seeing in the process explorer it actually shows <code>&lt;user&gt;\Roaming\uv\python\cpython-3.11.11-windows-x86_64-none\python.exe</code> instead of the python from uv, which is pretty misleading...</p>
<p>Note: I found this because tests were failing and I had no idea why the pid written to a lock file wasn't matching the pid of the process I just launched.</p>
<p>Isn't it possible for <code>uv run python ...</code> to launch the final executable instead of a launcher which then launches the final executable?... it seems that <code>uv run</code> could build the whole env and run the final python directly instead of that shim (and then even terminating that call would do the right thing instead of having to always terminate the whole tree).</p>
<h3>Platform</h3>
<p>Windows 11 x86_64</p>
<h3>Version</h3>
<p>uv 0.6.4 (04db70662 2025-03-03)</p>
<h3>Python version</h3>
<p>Python 3.11.11</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @fabioz on 2025-03-13 12:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/FishAlchemist">@FishAlchemist</a> on 2025-03-16 13:47</div>
            <div class="timeline-body"><p>After doing some research, I found that you're actually right. It is indeed Python calling Python. The <code>.venv\Scripts\python.exe</code>  reads the <code>home</code> from <code>pyvenv.cfg</code>  and then uses it to call Python. So, the final program that executes your code is <code>&lt;user&gt;\Roaming\uv\python\cpython-3.11.11-windows-x86_64-none\python.exe</code>, not <code>&lt;path&gt;\.venv\Scripts\python.exe</code></p>
<p>Call Graph by <code>subprocess.popen</code>:
<code>&lt;path&gt;\.venv\Scripts\python.exe</code> (The PID obtained by subprocess.Popen)
└── <code>&lt;user&gt;\Roaming\uv\python\cpython-3.11.11-windows-x86_64-none\python.exe</code> (The PID obtained from a subprocess executing code)</p>
<p>By the way, it seems that the standard built-in venv is like that too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-16 14:05</div>
            <div class="timeline-body"><p>I could see how this would be confusing, but I think this is the same as if you activated the environment and ran <code>python.exe</code>? I don't think we can differ from the &quot;standard&quot; way of invoking Python here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @zanieb on 2025-03-16 14:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2025-03-16 14:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-16 14:06</div>
            <div class="timeline-body"><p>The <code>python</code> executables in virtual environments are just &quot;launchers&quot;</p>
<p>ref https://github.com/python/cpython/blob/d457345bbc6414db0443819290b04a9a4333313d/Lib/venv/<strong>init</strong>.py#L261-L267</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fabioz">@fabioz</a> on 2025-03-16 15:22</div>
            <div class="timeline-body"><blockquote>
<p>I don't think we can differ from the &quot;standard&quot; way of invoking Python here.</p>
</blockquote>
<p>Why not? i.e.: What I'm used to use is conda, where python gives me the real python (I find that a better experience than double launching which actually is responsible for issues such as killing but leaving orphaned process, pid reference which is not the real pid).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2025-03-16 16:58</div>
            <div class="timeline-body"><p>Some background, Conda virtual environments are not Python virtual environments: https://docs.conda.io/projects/conda/en/latest/user-guide/concepts/environments.html#virtual-environments</p>
<p>Conda environments act more like user Python installations, e.g, they accept user site packages by default, and they don't conform to standards that virtual environments match, also they do a lot more control over env variables and binaries available. This leads to pros and cons of such an environment, but scripts and applications can be broken by this kind of change (e.g. I’ve had to do a lot of support work in the past of applications that are broken by having the conda OpenSSL on that path in an activated conda environment).</p>
<p>I don't have a strong understand of the spec here, if this actually is part of the spec or venvs implementation, but I would caution the uv team from creating some alternative that deviates from the spec until they are confident they know what they want to do and support, as there is endless edge case behavior on stuff like this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-10-19 12:27</div>
            <div class="timeline-body"><p>It's important that <code>sys.executable</code> points to the venv Python to ensure that subprocesses start with the same Python environment. If we were to launch the base Python executable and someone were to launch a Python child process, that process wouldn't have the packages available in the current process. An example where this is important in PEP 517.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-10-19 15:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:30:24 UTC
    </footer>
</body>
</html>
