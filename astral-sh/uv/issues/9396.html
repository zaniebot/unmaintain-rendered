<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`--locked` does not always report an error even when the lockfile needs to be regenerated - astral-sh/uv #9396</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>--locked</code> does not always report an error even when the lockfile needs to be regenerated</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/9396">#9396</a>
        opened by <a href="https://github.com/DetachHead">@DetachHead</a>
        on 2024-11-24 14:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/DetachHead">@DetachHead</a></div>
            <div class="timeline-body">environment
<ul>
<li>uv: tested on 0.5.2 and 0.5.4</li>
<li>python tested on 3.11, 3.12, 3.13</li>
<li>windows</li>
</ul>
to reproduce
<p>sorry this isn&#x27;t a minimal repro, i can&#x27;t get it to happen reliably so this is the best i can do.</p>
<p>note that the project uses pyprojectx so it installs uv automatically</p>
<ol>
<li><code>git clone https://github.com/detachhead/basedpyright</code> (commit <code>6d94c2aca2683aaa1f36e5d1687c6240e239b315</code>)</li>
<li><code>cd basedpyright</code></li>
<li>run <code>./pw uv lock --locked</code> (no error)</li>
<li>delete <code>uv.lock</code></li>
<li>run <code>./pw uv lock</code></li>
<li>run <code>git diff uv.lock</code></li>
</ol>
<pre><code>diff --git a/uv.lock b/uv.lock
index aca6ec6ee..f165035b0 100644
--- a/uv.lock
+++ b/uv.lock
@@ -1,8 +1,7 @@
 version = 1
 requires-python = &quot;&gt;=3.8&quot;
 resolution-markers = [
-    &quot;python_full_version &lt; &#x27;3.9&#x27;&quot;,
-    &quot;python_full_version &gt;= &#x27;3.9&#x27; and python_full_version &lt; &#x27;3.11&#x27;&quot;,
+    &quot;python_full_version &lt; &#x27;3.11&#x27;&quot;,
     &quot;python_full_version == &#x27;3.11.*&#x27;&quot;,
     &quot;python_full_version &gt;= &#x27;3.12&#x27;&quot;,
 ]
@@ -250,8 +249,7 @@ name = &quot;docify&quot;
 version = &quot;1.0.0&quot;
 source = { registry = &quot;https://pypi.org/simple&quot; }
 dependencies = [
-    { name = &quot;libcst&quot;, version = &quot;1.1.0&quot;, source = { registry = &quot;https://pypi.org/simple&quot; }, marker = &quot;python_full_version &lt; &#x27;3.9&#x27;&quot; },
-    { name = &quot;libcst&quot;, version = &quot;1.5.0&quot;, source = { registry = &quot;https://pypi.org/simple&quot; }, marker = &quot;python_full_version &gt;= &#x27;3.9&#x27;&quot; },
+    { name = &quot;libcst&quot; },
     { name = &quot;tqdm&quot; },
 ]
 sdist = { url = &quot;https://files.pythonhosted.org/packages/b2/cc/d403e8dbe89826340a18909e0aa26ed917981d41579ba91145e2e1b954c8/docify-1.0.0.tar.gz&quot;, hash = &quot;sha256:8d779f8348dd8d46796709c0db7d710cbc6354935d90a727c9ff3ab77b4cd3bf&quot;, size = 7186 }
@@ -356,13 +354,10 @@ wheels = [
 name = &quot;libcst&quot;
 version = &quot;1.1.0&quot;
 source = { registry = &quot;https://pypi.org/simple&quot; }
-resolution-markers = [
-    &quot;python_full_version &lt; &#x27;3.9&#x27;&quot;,
-]
 dependencies = [
-    { name = &quot;pyyaml&quot;, marker = &quot;python_full_version &lt; &#x27;3.9&#x27;&quot; },
-    { name = &quot;typing-extensions&quot;, marker = &quot;python_full_version &lt; &#x27;3.9&#x27;&quot; },
-    { name = &quot;typing-inspect&quot;, marker = &quot;python_full_version &lt; &#x27;3.9&#x27;&quot; },
+    { name = &quot;pyyaml&quot; },
+    { name = &quot;typing-extensions&quot; },
+    { name = &quot;typing-inspect&quot; },
 ]
</code></pre>
<p>(the diff is larger than this but i only included the first few changes)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/FishAlchemist">@FishAlchemist</a> on 2024-11-24 15:31</div>
            <div class="timeline-body"><p>I noticed you mentioned using this. Perhaps some of the comments in this issue(<a href="https://github.com/astral-sh/uv/issues/9379">astral-sh/uv#9379</a>#issuecomment-2495472831) can shed some light on your problem. However, since I&#x27;m not familiar with dynamic metadata, if that doesn&#x27;t solve it, we&#x27;ll have to wait for someone more knowledgeable to explain.</p>
<pre><code>dynamic = [&quot;version&quot;]
</code></pre>
<p>However, based on my observations of how UV behaves, the lockfile wouldn&#x27;t be regenerated if you haven&#x27;t modified the project metadata. Since there were no modifications, the lock file didn&#x27;t need updating, so it passed the check.</p>
<p>Edit:
If the lock files generated by different UV versions are not necessarily identical, forcing regeneration and then checking for verify seems prone to false positives</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DetachHead">@DetachHead</a> on 2024-11-25 08:21</div>
            <div class="timeline-body"><blockquote>
<p>However, based on my observations of how UV behaves, the lockfile wouldn&#x27;t be regenerated if you haven&#x27;t modified the project metadata. Since there were no modifications, the lock file didn&#x27;t need updating, so it passed the check.</p>
</blockquote>
<p>in this case, the metadata had been updated since the lockfile was last generated. specifically, i removed this part from my <code>pyproject.toml</code> because i mistakenly thought it wasn&#x27;t needed for my project, then i forgot to regenerate the lockfile:</p>
<pre><code>[dependency-groups]
docstubs = [
    # ...
    &quot;libcst&gt;=1.5.0 ; python_version&gt;=&#x27;3.9&#x27;&quot;,
    &quot;libcst==1.1.0 ; python_version&lt;&#x27;3.9&#x27;&quot;,
]
</code></pre>
<p>in https://github.com/DetachHead/basedpyright/commit/4e58bf7a022ac7c2e7e94a021da5381b0c1c429f</p>
<p>it was only once i regenerated the lockfile a few days later and saw these changes that i realized it was necessary after all, because the <code>uv lock --check</code> in my ci failed to recognize that my lockfile needed to be updated</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/FishAlchemist">@FishAlchemist</a> on 2024-11-25 08:48</div>
            <div class="timeline-body"><p>@DetachHead Actually, <code>uv sync</code> and <code>uv run</code> will automatically check if the lock file is up-to-date, unless you&#x27;ve used the <code>--frozen</code> flag.
So theoretically, as long as you&#x27;ve used  them before committing, your lock file should be up-to-date.</p>
<p><code>uv sync</code>
<code>--frozen</code></p>
<pre><code>Sync without updating the uv.lock file.

Instead of checking if the lockfile is up-to-date, uses the versions in the lockfile as the source of truth. If the lockfile is missing, uv will exit with an error. If the pyproject.toml includes changes to dependencies that have not been included in the lockfile yet, they will not be present in the environment.

May also be set with the UV_FROZEN environment variable.
</code></pre>
<p>https://docs.astral.sh/uv/concepts/projects/sync/#checking-if-the-lockfile-is-up-to-date</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DetachHead">@DetachHead</a> on 2024-11-25 09:31</div>
            <div class="timeline-body"><p>i think it only happens when deleting the lockfile before running <code>uv sync</code> or <code>uv lock</code> again. if the lockfile isn&#x27;t deleted first, it doesn&#x27;t seem to regenerate it which would explain why <code>--locked</code> doesn&#x27;t think there are any changes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-27 16:03</div>
            <div class="timeline-body"><p>This is generally intentional... <code>--locked</code> confirms that the <code>uv.lock</code> is up-to-date with the given requirements, <em>not</em> that a fresh <code>uv lock</code> would produce the same lockfile. These are subtly different. For example, we might change how we represent some metadata in <code>uv.lock</code>, or we might change prioritization within the resolver. Both of those changes could be backwards-compatible, so existing <code>uv.lock</code> files work fine and still represent a valid resolution for the given inputs. But if you remove the <code>uv.lock</code>, we might then make different choices in resolving.</p>
<p>If you actually want to enforce <em>this</em> guarantee, I&#x27;d probably do it manually by moving <code>mv uv.lock before.lock</code> then <code>uv lock</code> and diffing the two files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-27 16:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-27 16:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-27 16:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DetachHead">@DetachHead</a> on 2025-01-03 12:05</div>
            <div class="timeline-body"><p>@charliermarsh if i&#x27;m understanding correctly, you&#x27;re saying that it&#x27;s ok for the newly generated lockfile to be different as long as it&#x27;s functionally the same as the previous one.</p>
<p>that doesn&#x27;t seem to be the case here though, because as far as i can tell there definitely is a functional difference between these two versions of the lockfile, which was caused by removing these dependencies from <code>pyproject.toml</code></p>
<pre><code>[dependency-groups]
docstubs = [
    # ...
    &quot;libcst&gt;=1.5.0 ; python_version&gt;=&#x27;3.9&#x27;&quot;,
    &quot;libcst==1.1.0 ; python_version&lt;&#x27;3.9&#x27;&quot;,
]
</code></pre>
<p>(from <a href="https://github.com/astral-sh/uv/issues/9396">astral-sh/uv#9396</a>#issuecomment-2497207219)</p>
<p>i&#x27;m still extremely confused as to what happened here because as far as i can tell this doesn&#x27;t appear to be intentional. <code>uv lock --check</code> seems to only <em>sometimes</em> complain about this specific discrepancy. but unfortunately i couldn&#x27;t reliably reproduce the issue :(</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-03 14:54</div>
            <div class="timeline-body"><p>Sorry yes, if the input dependencies change, then locked should error. I would need a reproduction to help though :(</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:35:43 UTC
    </footer>
</body>
</html>
