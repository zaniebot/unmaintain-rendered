<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Should uv pip compile --prerelease=if-necessary-or-explicit work for explicit dependencies of dependencies? - astral-sh/uv #2630</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Should uv pip compile --prerelease=if-necessary-or-explicit work for explicit dependencies of dependencies?</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/2630">#2630</a>
        opened by <a href="https://github.com/VerdantFox">@VerdantFox</a>
        on 2024-03-22 23:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/VerdantFox">@VerdantFox</a> on 2024-03-22 23:57</div>
            <div class="timeline-body"><p>uv version: 0.1.24
Platform: WSL on Windows 11
uv was installed by <code>pipx</code></p>
<p>I'm using <code>uv pip compile</code> to generate a <code>requirements.txt</code> file from a <code>pyproject.toml</code> file. Based on version requirements in the <code>pyproject.toml</code> file, one of the dependencies of my dependencies appears to require a prerelease version. I set the <code>--prerelease=if-necessary-or-explicit</code> flag (which says it's the default anyway), but the compile fails, saying that <code>--prerelease=allow</code> is required. If I use <code>--prerelease=allow</code>, the compile does indeed work. However, if I use <code>--prerelease=allow</code>, uv eagerly sets other dependencies to prerelease versions that don't need to be prerelease, which I don't want.</p>
<ol>
<li>Is this a bug? Should <code>--prerelease=if-necessary-or-explicit</code> resolve dependencies as I'd expect in this case?</li>
<li>If it isn't a bug, is there a way to do what I want? i.e., only resolve prerelease versions if it is absolutely needed to resolve my dependencies?</li>
</ol>
<p>Here's a simplified <code>pyproject.toml</code> file that reproduces my problem:</p>
<pre><code class="language-toml">[project]
name = &quot;example&quot;
requires-python = &quot;&gt;=3.10&quot;
dependencies = [
    &quot;azure-cli&gt;2.50.0&quot;,
    &quot;beautifulsoup4&quot;
]
</code></pre>
<p>Here's the command that produces the error:</p>
<pre><code class="language-bash">$ uv pip compile --generate-hashes --upgrade --prerelease=if-necessary-or-explicit --output-file=requirements.txt pyproject.toml
  Ã— No solution found when resolving dependencies:
  â•°â”€â–¶ Because there is no version of azure-keyvault-keys==4.8.0b2 and azure-cli&gt;=2.51.0,&lt;=2.53.1 depends on azure-keyvault-keys==4.8.0b2, we can conclude that azure-cli&gt;=2.51.0,&lt;=2.53.1 cannot
      be used.
      And because only the following versions of azure-cli are available:
          azure-cli&lt;=2.50.0
          azure-cli==2.51.0
          azure-cli==2.52.0
          azure-cli==2.53.0
          azure-cli==2.53.1
          azure-cli==2.54.0
          azure-cli==2.55.0
          azure-cli==2.56.0
          azure-cli==2.57.0
          azure-cli==2.58.0
      we can conclude that azure-cli&gt;2.50.0,&lt;2.54.0 cannot be used. (1)

      Because there is no version of azure-keyvault-administration==4.4.0b2 and azure-cli&gt;=2.54.0 depends on azure-keyvault-administration==4.4.0b2, we can conclude that azure-cli&gt;=2.54.0 cannot
      be used.
      And because we know from (1) that azure-cli&gt;2.50.0,&lt;2.54.0 cannot be used, we can conclude that azure-cli&gt;2.50.0 cannot be used.
      And because example depends on azure-cli&gt;2.50.0, we can conclude that the requirements are unsatisfiable.

      hint: azure-keyvault-keys was requested with a pre-release marker (e.g., azure-keyvault-keys==4.8.0b2), but pre-releases weren't enabled (try: `--prerelease=allow`)

      hint: azure-keyvault-administration was requested with a pre-release marker (e.g., azure-keyvault-administration==4.4.0b2), but pre-releases weren't enabled (try: `--prerelease=allow`)
</code></pre>
<p>Again, with the <code>--prerelease=allow</code> flag, the command works, but then <code>beautfulsoup4</code> resolves to <code>beautifulsoup4==4.13.0b2</code>. Without the <code>--prerelease=allow</code> flag beautifulsoup4 resolves to <code>beautifulsoup4==4.12.3</code>, the version I would like it to resolve to.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Shouldn't uv pip compile --prerelease=if-necessary-or-explicit work for explicit dependencies of dependencies?" to "Should uv pip compile --prerelease=if-necessary-or-explicit work for explicit dependencies of dependencies?" by @VerdantFox on 2024-03-22 23:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-22 23:58</div>
            <div class="timeline-body"><p>I don't think uv supports what you're looking for. It's described in more detail here: https://github.com/astral-sh/uv/blob/main/PIP_COMPATIBILITY.md#pre-release-compatibility. The core idea is that we need to know upfront which packages are <em>allowed</em> to use pre-releases, because changing the set of <em>allowed</em> packages over the course of resolution creates a lot of complexity.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/VerdantFox">@VerdantFox</a> on 2024-03-23 00:05</div>
            <div class="timeline-body"><p>Wow, thanks for the incredibly fast reply (&lt; 2 minutes ðŸ¤¯) and the link to that documentation. I can work with that. This project and ruff are awesome; keep up the good work! ðŸ™‚</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @VerdantFox on 2024-03-23 00:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-23 00:13</div>
            <div class="timeline-body"><p>No prob! I'm hoping to expand pre-release support at some point but it's tricky and the spec needs to evolve a bit to make the expectations clear for tools.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:57 UTC
    </footer>
</body>
</html>
