<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv pip install` not respecting `index.authenticate` on followup requests - astral-sh/uv #13737</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>uv pip install</code> not respecting <code>index.authenticate</code> on followup requests</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/13737">#13737</a>
        opened by <a href="https://github.com/JoshuaHassler">@JoshuaHassler</a>
        on 2025-05-30 17:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JoshuaHassler">@JoshuaHassler</a></div>
            <div class="timeline-body">Summary
<p><a href="https://github.com/astral-sh/uv/pull/12470">PR #12470 </a> updated the pip commands to respect the <code>index.authenticate</code> settings, however, this seems to only apply to the initial request. Once the package is found the subsequent request to download the package is first made unauthenticated. I can verify this both in the uv logs and by looking at the logs of our Python index. Due to the specifics of our index setup, this causes the download to fail.</p>
<p><strong>UV logs</strong>
Initial good request:</p>
<pre><code>DEBUG No cache entry for: https://&lt;REPO_URL&gt;/root/pypi/+simple/&lt;PACKAGE&gt;/
TRACE Sending fresh GET request for https://&lt;REPO_URL&gt;/root/pypi/+simple/&lt;PACKAGE&gt;/
TRACE Handling request for https://&lt;REPO_URL&gt;/root/pypi/+simple/&lt;PACKAGE&gt;/ with authentication policy always
</code></pre>
<p>Followup bad request:</p>
<pre><code>DEBUG No cache entry for: https://&lt;REPO_URL&gt;/root/pypi/+&lt;HASH&gt;/&lt;PACKAGE&gt;-py3-none-any.whl
TRACE Sending fresh HEAD request for https://&lt;REPO_URL&gt;/root/pypi/+&lt;HASH&gt;/&lt;PACKAGE&gt;-py3-none-any.whl
TRACE Handling request for https://&lt;REPO_URL&gt;/root/pypi/+&lt;HASH&gt;/&lt;PACKAGE&gt;-py3-none-any.whl with authentication policy auto
</code></pre>
Platform
<p>Fedora Linux 6.14.6-300.fc42.x86_64 x86_64 GNU/Linux</p>
Version
<p>uv 0.7.8</p>
Python version
<p>Python 3.13.3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/JoshuaHassler">@JoshuaHassler</a> on 2025-05-30 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-05-30 17:50</div>
            <div class="timeline-body"><p>We&#x27;ll need complete logs, example commands, and your configuration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JoshuaHassler">@JoshuaHassler</a> on 2025-05-30 18:35</div>
            <div class="timeline-body"><p>Sorry, it took me a minute to redact the logs. I have attached the requested information.</p>
<p>To give some more insight the index is being run with Devpi using the devpi-tokens plugin. I have it set up so that if the token is present (in this case as the password in the basic auth header) it uses that. If the token is not present it will redirect the user to a login page.</p>
<p>With this setup it does require <code>index.authenticate</code> to be set to always. This allows UV to hit the index page without having its requests redirected. During install when it tries to actually download the whl file it does the default of first attempting to download with no authentication. It receives a 304 followed by a 200 OK where it gets &quot;served&quot; the login page. It then tries to use the login page as a whl leading to the error <code>WARN cryptography has an invalid package format: Failed to read from zip file</code></p>
<p>I only consider this a bug in UV since it seems like <code>index.authenticate</code> should affect all requests to the index. Additionally, vanilla pip includes the auth header in all requests and I have verified it works with this setup.</p>
<p>Lastly, this might be related to <a href="https://github.com/astral-sh/uv/issues/11636">Issue 11636</a>. This seems like something that would pop up for repos that use OIDC/Oauth2 for the web interface and auth tokens for CLI apps.</p>
<p>Thanks, and let me know if you would like any more information or testing!</p>
<p>example command:</p>
<pre><code>uv pip install -vv --no-cache --force-reinstall cryptography==45.0.3
</code></pre>
<p>uv config:</p>
<pre><code>[[index]]
name = &quot;local-pypi&quot;
url = &quot;https://username:password@python.localhost/root/awepy/+simple&quot;
default = true
authenticate = &quot;always&quot;
</code></pre>
<p>complete logs:</p>
<pre><code>DEBUG uv 0.7.8
DEBUG Searching for default Python interpreter in virtual environments
TRACE Querying interpreter executable at /home/&lt;USER&gt;/&lt;PACKAGE&gt;/.venv/bin/python3
DEBUG Found `cpython-3.13.3-linux-x86_64-gnu` at `/home/&lt;USER&gt;/&lt;PACKAGE&gt;/.venv/bin/python3` (active virtual environment)
DEBUG Using Python 3.13.3 environment at: .venv
TRACE Checking lock for `.venv` at `.venv/.lock`
DEBUG Acquired lock for `.venv`
TRACE Caching credentials for https://username:password@python.localhost/root/pypi/+simple
DEBUG Using request timeout of 30s
DEBUG Solving with installed Python version: 3.13.3
DEBUG Solving with target Python version: &gt;=3.13.3
TRACE Assigned packages:
TRACE Chose package for decision: root. remaining choices:
DEBUG Adding direct dependency: cryptography&gt;=45.0.3, &lt;45.0.3+
TRACE Assigned packages: root==0a0.dev0
TRACE Chose package for decision: cryptography. remaining choices:
TRACE Fetching metadata for cryptography from https://python.localhost/root/pypi/+simple/cryptography/
TRACE No cache entry exists for /tmp/.tmpiJ8Mht/simple-v16/index/7647f7ee1191f67b/cryptography.rkyv
DEBUG No cache entry for: https://python.localhost/root/pypi/+simple/cryptography/
TRACE Sending fresh GET request for https://python.localhost/root/pypi/+simple/cryptography/
TRACE Handling request for https://username:****@python.localhost/root/pypi/+simple/cryptography/ with authentication policy always
TRACE Request for https://username:****@python.localhost/root/pypi/+simple/cryptography/ already contains username and password
TRACE Updating cached credentials for https://python.localhost/root/pypi/+simple/cryptography/ to Basic { username: Username(Some(&quot;username&quot;)), password: Some(****) }
TRACE Cached request https://python.localhost/root/pypi/+simple/cryptography/ is not storable because its response has a &#x27;no-store&#x27; cache-control directive
TRACE Received package metadata for: cryptography
TRACE Selecting candidate for cryptography with range &gt;=45.0.3, &lt;45.0.3+ with 141 remote versions
TRACE Found candidate for package cryptography with range &gt;=45.0.3, &lt;45.0.3+ after 1 steps: 45.0.3 version
TRACE Returning candidate for package cryptography with range &gt;=45.0.3, &lt;45.0.3+ after 1 steps
DEBUG Searching for a compatible version of cryptography (&gt;=45.0.3, &lt;45.0.3+)
TRACE Selecting candidate for cryptography with range &gt;=45.0.3, &lt;45.0.3+ with 141 remote versions
TRACE Found candidate for package cryptography with range &gt;=45.0.3, &lt;45.0.3+ after 1 steps: 45.0.3 version
TRACE Returning candidate for package cryptography with range &gt;=45.0.3, &lt;45.0.3+ after 1 steps
DEBUG Selecting: cryptography==45.0.3 [compatible] (cryptography-45.0.3-cp311-abi3-manylinux_2_34_x86_64.whl)
TRACE No cache entry exists for /tmp/.tmpiJ8Mht/wheels-v5/index/7647f7ee1191f67b/cryptography/45.0.3-cp311-abi3-manylinux_2_34_x86_64.msgpack
DEBUG No cache entry for: https://python.localhost/root/pypi/+f/c82/4c9281cb62801/cryptography-45.0.3-cp311-abi3-manylinux_2_34_x86_64.whl
TRACE Sending fresh HEAD request for https://python.localhost/root/pypi/+f/c82/4c9281cb62801/cryptography-45.0.3-cp311-abi3-manylinux_2_34_x86_64.whl
TRACE Handling request for https://python.localhost/root/pypi/+f/c82/4c9281cb62801/cryptography-45.0.3-cp311-abi3-manylinux_2_34_x86_64.whl with authentication policy auto
TRACE Request for https://python.localhost/root/pypi/+f/c82/4c9281cb62801/cryptography-45.0.3-cp311-abi3-manylinux_2_34_x86_64.whl is unauthenticated, checking cache
TRACE No credentials in cache for URL https://python.localhost/root/pypi/+f/c82/4c9281cb62801/cryptography-45.0.3-cp311-abi3-manylinux_2_34_x86_64.whl
TRACE Attempting unauthenticated request for https://python.localhost/root/pypi/+f/c82/4c9281cb62801/cryptography-45.0.3-cp311-abi3-manylinux_2_34_x86_64.whl
TRACE Cached request https://python.localhost/root/pypi/+f/c82/4c9281cb62801/cryptography-45.0.3-cp311-abi3-manylinux_2_34_x86_64.whl is storable because its response has a heuristically cacheable status code 200
TRACE Considering retry of error: Error { kind: AsyncHttpRangeReader(Url { scheme: &quot;https&quot;, cannot_be_a_base: false, username: &quot;&quot;, password: None, host: Some(Domain(&quot;python.localhost&quot;)), port: None, path: &quot;/root/pypi/+f/c82/4c9281cb62801/cryptography-45.0.3-cp311-abi3-manylinux_2_34_x86_64.whl&quot;, query: None, fragment: None }, HttpRangeRequestUnsupported) }
TRACE Cannot retry error: not an IO error
WARN Range requests not supported for cryptography-45.0.3-cp311-abi3-manylinux_2_34_x86_64.whl; streaming wheel
TRACE No cache entry exists for /tmp/.tmpiJ8Mht/wheels-v5/index/7647f7ee1191f67b/cryptography/45.0.3-cp311-abi3-manylinux_2_34_x86_64.msgpack
DEBUG No cache entry for: https://python.localhost/root/pypi/+f/c82/4c9281cb62801/cryptography-45.0.3-cp311-abi3-manylinux_2_34_x86_64.whl
TRACE Sending fresh GET request for https://python.localhost/root/pypi/+f/c82/4c9281cb62801/cryptography-45.0.3-cp311-abi3-manylinux_2_34_x86_64.whl
TRACE Handling request for https://python.localhost/root/pypi/+f/c82/4c9281cb62801/cryptography-45.0.3-cp311-abi3-manylinux_2_34_x86_64.whl with authentication policy auto
TRACE Request for https://python.localhost/root/pypi/+f/c82/4c9281cb62801/cryptography-45.0.3-cp311-abi3-manylinux_2_34_x86_64.whl is unauthenticated, checking cache
TRACE No credentials in cache for URL https://python.localhost/root/pypi/+f/c82/4c9281cb62801/cryptography-45.0.3-cp311-abi3-manylinux_2_34_x86_64.whl
TRACE Attempting unauthenticated request for https://python.localhost/root/pypi/+f/c82/4c9281cb62801/cryptography-45.0.3-cp311-abi3-manylinux_2_34_x86_64.whl
TRACE Cached request https://python.localhost/root/pypi/+f/c82/4c9281cb62801/cryptography-45.0.3-cp311-abi3-manylinux_2_34_x86_64.whl is storable because its response has a heuristically cacheable status code 200
TRACE Considering retry of error: Metadata(&quot;https://python.localhost/root/pypi/+f/c82/4c9281cb62801/cryptography-45.0.3-cp311-abi3-manylinux_2_34_x86_64.whl&quot;, AsyncZip(UnexpectedHeaderError(1329865020, 67324752)))
TRACE Cannot retry error: not an IO error
TRACE Received built distribution metadata for: cryptography==45.0.3
WARN cryptography==45.0.3 has an invalid package format: Failed to read from zip file
WARN cryptography has an invalid package format: Failed to read from zip file
TRACE Assigned packages: root==0a0.dev0
TRACE Chose package for decision: cryptography. remaining choices:
DEBUG Searching for a compatible version of cryptography (&gt;45.0.3, &lt;45.0.3+)
TRACE Selecting candidate for cryptography with range &gt;45.0.3, &lt;45.0.3+ with 141 remote versions
TRACE Exhausted all candidates for package cryptography with range &gt;45.0.3, &lt;45.0.3+ after 0 steps
DEBUG No compatible version found for: cryptography
TRACE Selecting candidate for cryptography with range &gt;45.0.3, &lt;45.0.3+ with 141 remote versions
TRACE Exhausted all candidates for package cryptography with range &gt;45.0.3, &lt;45.0.3+ after 0 steps
TRACE Resolver derivation tree before reduction
term root==0a0.dev0
  root==0a0.dev0 depends on cryptography==45.0.3
  cryptography==45.0.3 an invalid package format
TRACE Resolver derivation tree after reduction
term root==0a0.dev0
  root==0a0.dev0 depends on cryptography==45.0.3
  cryptography==45.0.3 an invalid package format
  × No solution found when resolving dependencies:
  ╰─▶ Because cryptography==45.0.3 has an invalid package format and you require cryptography==45.0.3, we can conclude that
      your requirements are unsatisfiable.

      hint: The structure of `cryptography` (v45.0.3) was invalid:
        Failed to read from zip file
DEBUG Released lock at `/home/&lt;USER&gt;/&lt;PACKAGE&gt;/.venv/.lock`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-05-30 20:49</div>
            <div class="timeline-body"><p>This could be because we don&#x27;t propagate credentials to URLs with a different root unless the index URL ends in exactly <code>/simple</code></p>
<p>https://github.com/astral-sh/uv/blob/c19a294a48351ca84f18149fd6bcbf17d9e20bd9/crates/uv-distribution-types/src/index_url.rs#L70-L89</p>
<p><code>https://python.localhost/root/pypi/+simple/cryptography/ </code> authenticates because it&#x27;s a child of your given index URL <code>https://python.localhost/root/pypi/+simple</code>, but <code> https://python.localhost/root/pypi/+f/c82/4c9281cb62801/</code> does not because it&#x27;s on a different path.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-05-30 20:53</div>
            <div class="timeline-body"><p>Could you try <a href="https://github.com/astral-sh/uv/pull/13743">astral-sh/uv#13743</a> please? There will be a uv binary attached to the CI job summary when it completes, otherwise, you can build from source.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JoshuaHassler">@JoshuaHassler</a> on 2025-05-30 21:23</div>
            <div class="timeline-body"><p>That build fixes the issue! Thanks for the quick turnaround.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-05-30 21:27</div>
            <div class="timeline-body"><p>Wonderful, we&#x27;ll get that released.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-06-02 00:20</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:38:52 UTC
    </footer>
</body>
</html>
