<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`UV_INDEX_URL` with AWS CodeArtifact index consistently fails on large packages - astral-sh/uv #4402</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`UV_INDEX_URL` with AWS CodeArtifact index consistently fails on large packages</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/4402">#4402</a>
        opened by <a href="https://github.com/ringohoffman">@ringohoffman</a>
        on 2024-06-18 20:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ringohoffman">@ringohoffman</a> on 2024-06-18 20:22</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

<p>I have a project with a ton of dependencies, and an AWS CodeArtifact PyPI server that I host my dependencies in. When I use it as my index URL, I am consistently getting failures as compared to when I do not.</p>
<p>Related:</p>
<ul>
<li>https://github.com/astral-sh/uv/issues/1426</li>
<li>https://github.com/astral-sh/uv/issues/2586</li>
<li>https://github.com/astral-sh/uv/issues/3514</li>
</ul>
<p><strong><code>requirements.txt</code></strong>:</p>
<pre><code class="language-python">nvidia-cublas-cu12==12.1.3.1
nvidia-cuda-cupti-cu12==12.1.105
nvidia-cuda-nvrtc-cu12==12.1.105
nvidia-cuda-runtime-cu12==12.1.105
nvidia-cudnn-cu12==8.9.2.26
nvidia-cufft-cu12==11.0.2.54
nvidia-curand-cu12==10.3.2.106
nvidia-cusolver-cu12==11.4.5.107
nvidia-cusparse-cu12==12.1.0.106
nvidia-nccl-cu12==2.20.5
nvidia-nvjitlink-cu12==12.5.40
nvidia-nvtx-cu12==12.1.105
</code></pre>
<p>The above packages are the main offenders. Notably, they are all large. To pick a few (the ones that appear in the error messages):</p>
<ul>
<li><a href="https://pypi.org/project/nvidia-nccl-cu12/2.20.5/#files"><code>nvidia-nccl-cu12==2.20.5</code> is 176.2 MB</a></li>
<li><a href="https://pypi.org/project/nvidia-cusparse-cu12/12.1.0.106/#files"><code>nvidia-cusparse-cu12==12.1.0.106</code> is 196.0 MB</a></li>
<li><a href="https://pypi.org/project/nvidia-cusolver-cu12/11.4.5.107/#files"><code>nvidia-cusolver-cu12==11.4.5.107</code> is 124.2 MB</a></li>
</ul>
<p>To reproduce:</p>
<pre><code class="language-console">$ rm -rf ~/.cache/uv
$ conda create -n uvtest python=3.10 -y
$ conda activate uvtest
$ pip install uv
...
Installing collected packages: uv
Successfully installed uv-0.2.13
$ aws sso login
$ ...
$ export UV_INDEX_URL=&quot;https://aws:${CODEARTIFACT_AUTH_TOKEN}@${CODEARTIFACT_DOMAIN}-${AWS_ACCOUNT_ID}.d.codeartifact.${AWS_PIP_REGION}.amazonaws.com/pypi/${CODEARTIFACT_REPO}&quot;
$ export UV_HTTP_TIMEOUT=60
$ uv pip install -r requirements.txt
...
error: Failed to download distributions
  Caused by: Failed to fetch wheel: nvidia-nccl-cu12==2.20.5
  Caused by: Failed to extract archive
  Caused by: error decoding response body
  Caused by: request or response body error
  Caused by: error reading a body from connection
  Caused by: end of file before message length reached
</code></pre>
<p>a different time:</p>
<pre><code class="language-console">$ uv pip install -r requirements.txt
error: Failed to download distributions
  Caused by: Failed to fetch wheel: nvidia-cusparse-cu12==12.1.0.106
  Caused by: Failed to extract archive
  Caused by: error decoding response body
  Caused by: request or response body error
  Caused by: error reading a body from connection
  Caused by: peer closed connection without sending TLS close_notify: https://docs.rs/rustls/latest/rustls/manual/_03_howto/index.html#unexpected-eof
</code></pre>
<p>a different time:</p>
<pre><code class="language-console">$ uv pip install -r requirements.txt
error: Failed to download distributions
  Caused by: Failed to fetch wheel: nvidia-cusolver-cu12==11.4.5.107
  Caused by: Failed to extract archive
  Caused by: error decoding response body
  Caused by: request or response body error
  Caused by: error reading a body from connection
  Caused by: peer closed connection without sending TLS close_notify: https://docs.rs/rustls/latest/rustls/manual/_03_howto/index.html#unexpected-eof
</code></pre>
<p>I do <strong>not</strong> see these errors when running with <code>--verbose</code>??</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-06-18 20:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">network</span> added by @zanieb on 2024-06-18 20:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../materialsproject/pymatgen/pulls/3826.html">materialsproject/pymatgen#3826</a> on 2024-07-13 13:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ThermodynamicBeta">@ThermodynamicBeta</a> on 2024-11-19 23:03</div>
            <div class="timeline-body"><p>I got this today for a random big package, installed from a self-hosted Pypi. It would error on random dependencies from the big package, same error message: <code>Caused by: peer closed connection without sending TLS close_notify: https://docs.rs/rustls/latest/rustls/manual/_03_howto/index.html#unexpected-eof</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-19 23:23</div>
            <div class="timeline-body"><p>Lemme see if the retries I just added cover this case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-19 23:26</div>
            <div class="timeline-body"><p>Okay I believe this is a form of <code>UnexpectedEof</code> so the error itself should be covered:</p>
<p>https://github.com/rustls/rustls/blob/20de56876d8bc45224c351339337c61126c1c954/rustls/src/conn.rs#L185</p>
<p>I'll test it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ThermodynamicBeta">@ThermodynamicBeta</a> on 2024-11-19 23:27</div>
            <div class="timeline-body"><p>@charliermarsh I love you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-20 00:07</div>
            <div class="timeline-body"><p>Ok based on my testing this should be solved by #9253. If you see it after the next release, ping note it here and I'll re-open.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-11-20 00:08</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:29 UTC
    </footer>
</body>
</html>
