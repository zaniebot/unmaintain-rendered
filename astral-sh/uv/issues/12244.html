<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv panics when resizing terminal window - astral-sh/uv #12244</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv panics when resizing terminal window</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/12244">#12244</a>
        opened by <a href="https://github.com/SteveMcGrath">@SteveMcGrath</a>
        on 2025-03-17 18:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/SteveMcGrath">@SteveMcGrath</a></div>
            <div class="timeline-body">Summary
<p>Whenever i resize my terminal window, I get spammed with the following (or similar) errors for as long as I am resizing my window.  I started getting these when a switch to using ghostty as my terminal app and am wondering if the refresh/repaint interval on the resize is just faster than expected.</p>
<pre><code>❯ thread &#x27;main2&#x27; panicked at /Users/brew/Library/Caches/Homebrew/cargo_cache/registry/src/index.crates.io-6f17d22bba15001f/clap_complete-4.5.44/src/aot/shells/fish.rs:45:33:
failed to write completion file: Os { code: 32, kind: BrokenPipe, message: &quot;Broken pipe&quot; }
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
thread &#x27;main&#x27; panicked at /private/tmp/uv-20250219-7867-jnorhr/uv-0.6.2/crates/uv/src/lib.rs:1933:10:
</code></pre>
<p>When i enable the full backtrace im getting:</p>
<pre><code>❯ thread &#x27;main2&#x27; panicked at /Users/brew/Library/Caches/Homebrew/cargo_cache/registry/src/index.crates.io-6f17d22bba15001f/clap_complete-4.5.44/src/aot/shells/fish.rs:269:8:
failed to write completion file: Os { code: 32, kind: BrokenPipe, message: &quot;Broken pipe&quot; }
stack backtrace:
   0:        0x1004b8e70 - __mh_execute_header
   1:        0x1001a04cc - __mh_execute_header
   2:        0x1004b8c64 - __mh_execute_header
   3:        0x1004b7638 - __mh_execute_header
   4:        0x1004b9334 - __mh_execute_header
   5:        0x1004b92a4 - __mh_execute_header
   6:        0x1004b6da4 - __mh_execute_header
   7:        0x101643640 - __mh_execute_header
   8:        0x1016435cc - __mh_execute_header
   9:        0x1001915c4 - __mh_execute_header
  10:        0x10069c338 - __mh_execute_header
  11:        0x100685184 - __mh_execute_header
  12:        0x100c802ec - __mh_execute_header
  13:        0x10009a5ec - __mh_execute_header
  14:        0x100495810 - __mh_execute_header
  15:        0x18101c2e4 - __pthread_deallocate
thread &#x27;main&#x27; panicked at /private/tmp/uv-20250219-7867-jnorhr/uv-0.6.2/crates/uv/src/lib.rs:1933:10:
Tokio executor failed, was there a panic?: Any { .. }
stack backtrace:
   0:        0x1004b8e70 - __mh_execute_header
   1:        0x1001a04cc - __mh_execute_header
   2:        0x1004b8c64 - __mh_execute_header
   3:        0x1004b7638 - __mh_execute_header
   4:        0x1004b9334 - __mh_execute_header
   5:        0x1004b92a4 - __mh_execute_header
   6:        0x1004b6da4 - __mh_execute_header
   7:        0x101643640 - __mh_execute_header
   8:        0x1016435cc - __mh_execute_header
   9:        0x100da1eec - __mh_execute_header
  10:        0x100c7c7fc - __mh_execute_header
</code></pre>
<p>system details:</p>
<pre><code>❯ neofetch
                    &#x27;c.          steve@Aviendha.local
                 ,xNMM.          --------------------
               .OMMMMo           OS: macOS 15.3.2 24D81 arm64
               OMMM0,            Host: MacBookPro18,2
     .;loddo:&#x27; loolloddol;.      Kernel: 24.3.0
   cKMMMMMMMMMMNWMMMMMMMMMM0:    Uptime: 2 hours, 34 mins
 .KMMMMMMMMMMMMMMMMMMMMMMMWd.    Packages: 424 (brew)
 XMMMMMMMMMMMMMMMMMMMMMMMX.      Shell: fish 3.7.1
;MMMMMMMMMMMMMMMMMMMMMMMM:       Resolution: 5120x1440
:MMMMMMMMMMMMMMMMMMMMMMMM:       DE: Aqua
.MMMMMMMMMMMMMMMMMMMMMMMMX.      WM: Quartz Compositor
 kMMMMMMMMMMMMMMMMMMMMMMMMWd.    WM Theme: Blue (Light)
 .XMMMMMMMMMMMMMMMMMMMMMMMMMMk   Terminal: ghostty
  .XMMMMMMMMMMMMMMMMMMMMMMMMK.   CPU: Apple M1 Max
    kMMMMMMMMMMMMMMMMMMMMMMd     GPU: Apple M1 Max
     ;KMMMMMMMWXXWMMMMMMMk.      Memory: 8484MiB / 65536MiB
       .cooc,.    .,coo:.
</code></pre>
Platform
<p>macOS 15.3</p>
Version
<p>uv 0.6.2</p>
Python version
<p>Python 3.12.9</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/SteveMcGrath">@SteveMcGrath</a> on 2025-03-17 18:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/geofft">@geofft</a> on 2025-03-17 22:15</div>
            <div class="timeline-body"><p>At one level, what&#x27;s going on here is that the shell completion generation code is trying to write a script but the reader is exiting/closing the pipe before it&#x27;s done, which you can repro in isolation with e.g. <code>uv generate-shell-completion fish | head</code>.</p>
<p>So there&#x27;s sort of two angles here. The first is, should uv exit quietly if that happens? I <em>think</em> the answer is yes. The traditional UNIX behavior is for programs to just exit quietly via the SIGPIPE signal defaulting to killing the process (just like SIGINT, SIGKILL, etc. do); indeed, <code>| head</code> basically expects that behavior. I believe that this is largely happening because Rust by default ignores SIGPIPE (rust-lang/rust#62569), and so if you actually do a write to a broken pipe, instead of the program exiting you get an error from the write syscall, which turns into this panic. (There might be something more complicated with Tokio but I think there isn&#x27;t.) If uv resets SIGPIPE back to the default UNIX behavior, then it would exit quietly and you wouldn&#x27;t see the error message. There is an argument that diagnostics about the fact that the completion wasn&#x27;t fully written are useful &quot;explicit is better than implicit&quot;). I&#x27;m not sure if that&#x27;s a real concern here.</p>
<p>The second angle is, why is this code running on resize, and why is it getting into a broken pipe situation? My initial guess is this has something to do with Ghostty&#x27;s built-in fish integration. The <a href="https://docs.astral.sh/uv/getting-started/installation/#shell-autocompletion">uv setup instructions</a> encourage you to put a <code>uv generate-shell-completion fish | source</code> in ~/.config/fish/config.fish, and fish says that config.fish runs on <em>every</em> shell invocation, including non-interactive ones. Perhaps Ghostty is invoking a subshell on every resize step and terminating it before the next resize step, or something? That does seem like a lot of code to run on every single resize step, and it sort of feels at odds with the Ghostty philosphy (which uv shares) of being fast.</p>
<p>It does seem like it might be better anyway to <a href="https://fishshell.com/docs/current/language.html#configuration">only generate shell completion in the interactive case as the fish docs encourage</a>, e.g. something like</p>
<pre><code>status --is-interactive; and uv generate-shell-completion fish | source
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/SteveMcGrath">@SteveMcGrath</a> on 2025-03-18 17:18</div>
            <div class="timeline-body"><p>So i can definitely confirm that checking for interactivity first seems to solve the issue.  Maybe a minor adjustment to the docs are in order?</p>
<pre><code>status --is-interactive; and uv generate-shell-completion fish | source
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-18 17:57</div>
            <div class="timeline-body"><p>That seems prudent</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2025-06-01 04:58</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:37:48 UTC
    </footer>
</body>
</html>
