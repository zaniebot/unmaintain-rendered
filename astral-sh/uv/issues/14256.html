<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Best practices for Docker builds to exploit layer caching - astral-sh/uv #14256</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Best practices for Docker builds to exploit layer caching</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/14256">#14256</a>
        opened by <a href="https://github.com/timchap">@timchap</a>
        on 2025-06-25 09:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/timchap">@timchap</a></div>
            <div class="timeline-body">Question
<p>A problem that often arises when optimising Docker builds for Python projects is that if your Python project includes an auto-incremented version in the pyproject.toml, this invalidates the build cache:</p>
<pre><code>...
# This line invalidates the cache when version is bumped from 0.1.0 to 0.1.1, 
# even if external dependencies are unchanged
COPY pyproject.toml uv.lock ./
RUN uv sync --frozen
...
</code></pre>
<p>As a long-time Poetry user, I have previously used an approach like the following:</p>
<pre><code>...
# Intermediate target to clobber pyproject.toml version
FROM base AS prevent-pyproject-cache-misses

COPY pyproject.toml ./
RUN sed -i &#x27;/^version = &quot;[^&quot;]*&quot;/s/version = &quot;[^&quot;]*&quot;/version = &quot;0.0.0&quot;/&#x27; pyproject.toml

FROM base AS installer
COPY --from=prevent-pyproject-cache-misses pyproject.toml .
COPY poetry.lock
...
</code></pre>
<p>This is obviously a bit of a hack, and it doesn&#x27;t seem to work in all build environments, but in most cases it correctly ensures that the hash of the clobbered pyproject.toml is found in the build cache.</p>
<p>In <code>uv</code>, this seems to be even more difficult as the version of the current root package seems to be included in uv.lock itself. This means that both uv.lock and pyproject.toml will invalidate the cache when the root package version is auto-incremented, even when the external dependencies are unchanged. And I&#x27;m a bit reluctant to try the same trick with the lockfile...</p>
<p>What is the guidance for this? For projects with extremely slow external dependency builds, the ability to cache a Docker layer which includes the venv (but no project files) is very important. It seems like the general advice is to pin using requirements.txt instead, but to my mind this has a few disadvantages:</p>
<ul>
<li>This requires a pre-commit and/or other CI to ensure that the requirements.txt doesn&#x27;t drift with respect to uv.lock</li>
<li>Requirements.txt doesn&#x27;t play as nicely with exotic package indexes and platform markers. In particular, I&#x27;ve had trouble installing from private package indexes when using the exported requirements.txt (maybe I need to try harder though).</li>
</ul>
<p>Has anyone else got a good solution working?</p>
Platform
<p><em>No response</em></p>
Version
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/timchap">@timchap</a> on 2025-06-25 09:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-06-27 12:17</div>
            <div class="timeline-body"><p>Did you see https://docs.astral.sh/uv/guides/integration/docker/? It contains detailed guidance on caching.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-06-27 13:34</div>
            <div class="timeline-body"><p>I&#x27;m not sure we have a good way to handle the version in the lockfile problem. If it&#x27;s <code>dynamic</code>, we won&#x27;t include it in the lockfile, but I wouldn&#x27;t really recommend that. I guess you could use <code>uv export --no-emit-project</code> then consume a file without your project&#x27;s version in it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/timchap">@timchap</a> on 2025-07-04 12:10</div>
            <div class="timeline-body"><blockquote>
<p>Did you see https://docs.astral.sh/uv/guides/integration/docker/? It contains detailed guidance on caching.</p>
</blockquote>
<p>Yeah, it doesn&#x27;t really discuss the scenario where the cache is invalidated due to root editable project version update though.</p>
<blockquote>
<p>I&#x27;m not sure we have a good way to handle the version in the lockfile problem. If it&#x27;s <code>dynamic</code>, we won&#x27;t include it in the lockfile, but I wouldn&#x27;t really recommend that. I guess you could use <code>uv export --no-emit-project</code> then consume a file without your project&#x27;s version in it.</p>
</blockquote>
<p>Ok, this is more or less what we are doing already üëç as mentioned, the main downside is that it requires (the way I see it) one of the following:</p>
<ul>
<li>add some CI to run the export before <code>docker build</code>, in which case building locally requires additional manually steps</li>
<li>add a pre-commit to run the export, in which case developers need to be careful to install the pre-commit in order to avoid drifts between <code>uv.lock</code> and the exported lockfile.</li>
</ul>
<p>@zanieb you mentioned using <code>dynamic</code>, which I&#x27;m not familiar with. Searching the docs I see a discussion of this in the context of cache-keys, but it&#x27;s not clear to what <code>dynamic</code> (in code-quotes) refers to here. Can you clarify how you would use it in this scenario, and why you would recommend against it?</p>
<p><img alt="Image" src="https://github.com/user-attachments/assets/182c1b41-e190-4e6a-944f-3fda229581df"></p>
<p>Many thanks.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:39:10 UTC
    </footer>
</body>
</html>
