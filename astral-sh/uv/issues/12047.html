<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv uses stale project pth file when switching from flat to src layout - astral-sh/uv #12047</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv uses stale project pth file when switching from flat to src layout</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/12047">#12047</a>
        opened by <a href="https://github.com/dalukes-csob-cz">@dalukes-csob-cz</a>
        on 2025-03-07 15:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dalukes-csob-cz">@dalukes-csob-cz</a> on 2025-03-07 15:32</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I inherited a project with flat layout, migrated it to uv, added a few <code>project.scripts</code>, then decided to switch to a src layout, at which point the scripts stopped working.</p>
<p>After fiddling around a little bit, I noticed that the project's pth file in the virtualenv wasn't reflecting the new src layout, even if I recreated the virtualenv. This tipped me off it might be a cache issue, and indeed, when I cleared the cache, everything started working again.</p>
<p>Here's a Containerfile with an MRE:</p>
<details>

<pre><code class="language-Containerfile">FROM --platform=linux/arm64 ghcr.io/astral-sh/uv:0.6.5-debian-slim

RUN &lt;&lt;-EOF
echo 'INIT PROJECT WITH FLAT LAYOUT + PROJECT SCRIPT ----------------------------------'
uv init mre
cd mre
echo '
[project.scripts]
main = &quot;mre.main:main&quot;

[build-system]
requires = [&quot;hatchling&quot;]
build-backend = &quot;hatchling.build&quot;
' &gt;&gt;pyproject.toml
mkdir mre
touch mre/__init__.py
mv -t mre main.py

echo
echo 'RUNNING PROJECT SCRIPT WORKS FINE -----------------------------------------------'
uv run main

echo
echo 'PTH FILE IS CORRECT -------------------------------------------------------------'
cat .venv/lib/python*/site-packages/_mre.pth
echo

echo
echo 'SWITCH TO SRC LAYOUT ------------------------------------------------------------'
mkdir src
mv -t src mre

echo
echo 'RECREATE VENV WITH CACHE --------------------------------------------------------'
rm -rf .venv
uv sync

echo
echo 'RUNNING PROJECT SCRIPT FAILS ----------------------------------------------------'
uv run main

echo
echo 'PTH FILE IS STALE FROM CACHE ----------------------------------------------------'
cat .venv/lib/python*/site-packages/_mre.pth
echo

echo
echo 'RECREATE VENV WITHOUT CACHE -----------------------------------------------------'
uv cache clean
rm -rf .venv
uv sync

echo
echo 'RUNNING PROJECT SCRIPT WORKS FINE AGAIN -----------------------------------------'
uv run main

echo
echo 'PTH FILE HAS BEEN UPDATED FOR SRC LAYOUT ----------------------------------------'
cat .venv/lib/python*/site-packages/_mre.pth
echo
EOF
</code></pre>
</details>

<p>Would it be possible for uv to invalidate the cache entry for the project package in case of layout changes of this kind? I guess part of the problem might be that the src vs flat layout is autodetected, so they both work with no changes to <code>pyproject.toml</code>, which may be why the cache is not getting invalidated...?</p>
<p>And thanks so much for uv, it's awesome :)</p>
<h3>Platform</h3>
<p>macOS 15.3.1 (24D70) arm64</p>
<h3>Version</h3>
<p>uv 0.6.5 (Homebrew 2025-03-06)</p>
<h3>Python version</h3>
<p>Whatever uv in container picks (CPython 3.13.2 as of writing)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dalukes-csob-cz on 2025-03-07 15:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-07 15:52</div>
            <div class="timeline-body"><p>This has come up before though I'm struggling to find the issue... Your diagnosis is correct, though: we cache based on the <code>pyproject.toml</code>, and so if the <code>pyproject.toml</code> doesn't change, we don't invalidate the cache automatically. We could consider adding <code>src</code> as a cache key so that if a <code>src</code> directory is added or removed, we invalidate the cache, which would at least help with this common case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cache</span> added by @charliermarsh on 2025-03-07 15:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dalukes-csob-cz">@dalukes-csob-cz</a> on 2025-03-07 16:12</div>
            <div class="timeline-body"><p>Thanks for the quick reply!</p>
<blockquote>
<p>We could consider adding src as a cache key so that if a src directory is added or removed, we invalidate the cache, which would at least help with this common case?</p>
</blockquote>
<p>Sounds like a good idea as far as I'm concerned :) More exotic layout changes should typically be reflected in explicit config changes within <code>pyproject.toml</code> anyway, see e.g. https://hatch.pypa.io/1.13/config/build/#packages.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2025-03-08 02:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tpgillam">@tpgillam</a> on 2025-03-14 23:50</div>
            <div class="timeline-body"><blockquote>
<p>This has come up before though I'm struggling to find the issue...</p>
</blockquote>
<p>Sounds a bit like https://github.com/astral-sh/uv/issues/10390 perhaps â€” though if so I'm sure that's not the only one!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-03-17 21:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 03:44:23 UTC
    </footer>
</body>
</html>
