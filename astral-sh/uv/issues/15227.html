<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv appropriates project version for dependencies when UV_CACHE_DIR is set to a subdirectory of the project - astral-sh/uv #15227</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv appropriates project version for dependencies when UV_CACHE_DIR is set to a subdirectory of the project</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/15227">#15227</a>
        opened by <a href="https://github.com/mikolak-net">@mikolak-net</a>
        on 2025-08-11 21:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mikolak-net">@mikolak-net</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>It appears uv will &quot;force&quot; a dependency version to be that of the project when building at least some packages, when <code>UV_CACHE_DIR</code> is set to a subpath of the project.</p>
<p><strong>To reproduce</strong></p>
<ol>
<li>Create a new project, e.g. <code>uv init repro</code></li>
<li><code>cd repro</code></li>
<li>Open <code>pyproject.toml</code> and add an affected dependency to the <code>dependencies</code> entry, e.g. <code>dependencies = [&quot;localstack==3.8.1&quot;]</code></li>
<li>Set up the cache dir in the subpath of the project, e.g. <code>export UV_CACHE_DIR=.uv-cache</code>, as provided <a href="https://docs.astral.sh/uv/guides/integration/gitlab/#caching">in a documentation example</a></li>
<li>run <code>uv sync</code></li>
</ol>
<p><strong>Expected result</strong></p>
<p>The project builds.</p>
<p><strong>Encountered result</strong></p>
<p>An error is generated to the tune of:</p>
<pre><code class="language-bash">Using CPython 3.12.xx
Creating virtual environment at: .venv
Resolved 41 packages in 2.54s
      Built pyaes==1.6.1
      Built tailer==0.4.1
      Built localstack==3.8.1                                                                                                                                                                                                    × Failed to download and build `localstack-ext==3.8.1`
  ╰─▶ Package metadata version `0.1.dev0` does not match given version `3.8.1`
  help: `localstack-ext` (v3.8.1) was included because `repro` (v0.1.0) depends on `localstack` (v3.8.1) which depends on `localstack-ext`
</code></pre>
<p>PS. The error reporting is a bit obtuse. In the last line, please take note of the dependencies' version vs the project's version.</p>
<h3>Platform</h3>
<p>Linux</p>
<h3>Version</h3>
<p>uv 0.8.8</p>
<h3>Python version</h3>
<p>Python 3.12</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @mikolak-net on 2025-08-11 21:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-12 02:21</div>
            <div class="timeline-body"><p>I think this is not a bug with uv, but rather a bug with how that package is determining its version. I presume it's escaping the cache directory and reading from your project's git repository or something?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mikolak-net">@mikolak-net</a> on 2025-08-12 11:52</div>
            <div class="timeline-body"><p>@zanieb : it's completely possible that localstack is doing something nonstandard – however, creating an equivalent project using e.g. poetry works fine.</p>
<p>BTW, while the version of the package is somewhat older, localstack isn't exactly the most esoteric project, so I'd assume the maintainers would yank the version in question if it was causing build problems across the board.</p>
<p>FWIW, the latest stable version, i.e. <code>4.7.0</code>, also fails to install.</p>
<p><em>(EDIT: forgot to set cache dir for <code>4.7.0</code> when first checking it – using that version of localstack *also* exhibits the same issue)</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-12 13:54</div>
            <div class="timeline-body"><p>Sorry, but... this still doesn't sound like a problem with uv. They're using setuptools-scm. I don't know why that'd escape the cache when searching for a version, you'll need to raise the problem with setuptools-scm or localstack.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-12 13:54</div>
            <div class="timeline-body"><p>I would also just strongly recommend not putting the cache in your project?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">external</span> added by @zanieb on 2025-08-12 13:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mikolak-net">@mikolak-net</a> on 2025-08-12 15:02</div>
            <div class="timeline-body"><blockquote>
<p>Sorry, but... this still doesn't sound like a problem with uv. [...]</p>
</blockquote>
<p>This is your (as in the uv team's/Astral's) prerogative. All I can say that, as a user, I would find it troubling if such usage problems were readily dismissed, especially given:</p>
<ul>
<li>we're talking about <a href="https://github.com/localstack/localstack">one of the more popular packages</a> in the Python ecosystem, and</li>
<li>the issue is <em>apparently unique to uv</em> and not other package managers.</li>
</ul>
<p>I also suspect localstack's maintainers would be baffled to receive a bug report with this specific scenario. Speaking of which...</p>
<blockquote>
<p>I would also just strongly recommend not putting the cache in your project?</p>
</blockquote>
<p>To reiterate, this use case is reflected <a href="https://docs.astral.sh/uv/guides/integration/gitlab/#caching">in uv's own documentation</a>. And that makes sense, as GitLab's CI requires the cache directory to be placed within the project directory in order to use its, er, caching facility.</p>
<p>As to whether that requirement make sense... personally, I think not. But apparently whoever on your team was writing that documentation page didn't see a problem with uv's usage in this manner.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-12 16:17</div>
            <div class="timeline-body"><p>This is reproducible with <code>pip</code> if you put its build directory in your project:</p>
<pre><code>❯ mkdir example
❯ cd example
❯ git init
❯ mkdir tmp
❯ export TMPDIR=$(pwd)/tmp
❯ uvx python -m venv .venv
❯ .venv/bin/pip install localstack==3.8.1
Collecting localstack==3.8.1
  Downloading localstack-3.8.1.tar.gz (5.7 kB)
  Installing build dependencies ... done
  Getting requirements to build wheel ... done
  Preparing metadata (pyproject.toml) ... done
Collecting localstack-core (from localstack==3.8.1)
  Downloading localstack_core-4.7.0-py3-none-any.whl.metadata (5.6 kB)
Collecting localstack-ext==3.8.1 (from localstack==3.8.1)
  Downloading localstack_ext-3.8.1.tar.gz (7.8 MB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 7.8/7.8 MB 32.3 MB/s  0:00:00
  Installing build dependencies ... done
  Getting requirements to build wheel ... done
  Preparing metadata (pyproject.toml) ... done
  WARNING: Requested localstack-ext==3.8.1 from https://files.pythonhosted.org/packages/fb/1e/8e5404825f32b4ce40faf7160defac104eafb669c3b0db6fa25cfec0df8d/localstack_ext-3.8.1.tar.gz (from localstack==3.8.1), but installing version 0.1.dev0
Discarding https://files.pythonhosted.org/packages/fb/1e/8e5404825f32b4ce40faf7160defac104eafb669c3b0db6fa25cfec0df8d/localstack_ext-3.8.1.tar.gz (from https://pypi.org/simple/localstack-ext/) (requires-python:&gt;=3.8): Requested localstack-ext==3.8.1 from https://files.pythonhosted.org/packages/fb/1e/8e5404825f32b4ce40faf7160defac104eafb669c3b0db6fa25cfec0df8d/localstack_ext-3.8.1.tar.gz (from localstack==3.8.1) has inconsistent version: expected '3.8.1', but metadata has '0.1.dev0'
INFO: pip is looking at multiple versions of localstack to determine which version is compatible with other requirements. This could take a while.
ERROR: Ignored the following yanked versions: 0.0.0, 2.0.0, 3.0.0, 3.0.0.post1, 3.0.0.post2, 3.0.0.post3
ERROR: Could not find a version that satisfies the requirement localstack-ext==3.8.1 (from localstack)
...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-12 16:21</div>
            <div class="timeline-body"><p>As before, I think you need to raise this issue with setuptools-scm. They probably shouldn't go past project boundaries when discovering the version to use? However, I'm not sure about the implications for them, nor am I familiar with their implementation details — that's why I'm trying to redirect you.</p>
<p>Regarding the GitLab CI cache... I'm not really sure what to do there. That was contributed by another user in https://github.com/astral-sh/uv/pull/8000. I'm not an expert on GitLab CI either.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/RonnyPfannschmidt">@RonnyPfannschmidt</a> on 2025-08-12 20:29</div>
            <div class="timeline-body"><p>hi, i just yanked setuptools_scm 9.1.1 - the new feature of simplified self activation resulted in a chain of regressions - an with every iteration i found new interesting ways people configure their projects</p>
<p>the next iteration will use a more robust mechanism - but thats far away</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mikolak-net">@mikolak-net</a> on 2025-08-13 22:20</div>
            <div class="timeline-body"><p>@zanieb : re reproducibility, to clarify – as written <a href="https://github.com/astral-sh/uv/issues/15227#issuecomment-3178993862">in this comment</a>, whether or not the issue is ultimately due to the package performing some shenanigans is not something that's being challenged here.</p>
<p>The aim here was to demonstrate the user's perspective: building works in one system (e.g. poetry), but not in another (uv).</p>
<p>Re GitLab: I believe the uv documentation in question is factually correct. The cache directory <em>has to be</em> contained in the project dir, otherwise GL CI will not pick up the resultant files as &quot;cache&quot;.</p>
<p>In general, I want to stress I am raising awareness of this issue not in a &quot;fix it now&quot; manner, but to highlight something that is potentially happening to many users, but does not clear the threshold of reporting for many of them (in this particular case, caching shaves off little time compared to the overall speed improvements that come from uv adoption).</p>
<hr />
<p>@RonnyPfannschmidt : thanks for the prompt reaction (and kudos to @zanieb if they brought this into your attention)! However, I think the problem you mentioned is not the underlying issue: <code>localstack==3.8.1</code> (or rather, <a href="https://pypi.org/project/localstack-ext/3.8.1/"><code>localstack-ext</code></a> ) pre-dates <a href="https://pypi.org/project/setuptools-scm/9.1.1/"><code>setuptools_scm==9.1.1</code> </a> by almost a year.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-13 22:43</div>
            <div class="timeline-body"><p><code>localstack-ext</code> is being built from source because they don't provide pre-built wheels, so <code>setuptools-scm</code> is being invoked there, and because it is not common to have constraints on build dependencies, the latest version of <code>setuptools-scm</code> is used. It doesn't matter that <code>localstack-ext</code> is old. e.g., there are only lower bound constraints on <code>setuptools-scm</code></p>
<p>https://inspector.pypi.io/project/localstack-ext/3.8.1/packages/fb/1e/8e5404825f32b4ce40faf7160defac104eafb669c3b0db6fa25cfec0df8d/localstack_ext-3.8.1.tar.gz/localstack_ext-3.8.1/pyproject.toml#line.3</p>
<p>Anyway, I think @RonnyPfannschmidt misdiagnosed the problem. It does reproduce on an older version of <code>setuptools-scm</code></p>
<pre><code>❯ echo &quot;setuptools-scm==8.3.1&quot; &gt; constaints.txt
❯ UV_BUILD_CONSTRAINT=constraints.txt uv pip install localstack==3.8.1 --no-cache
Resolved 38 packages in 2.03s
      Built pyaes==1.6.1
      Built tailer==0.4.1
      Built localstack==3.8.1                                                                                                                                                               × Failed to download and build `localstack-ext==3.8.1`
  ╰─▶ Package metadata version `0.1.dev0` does not match given version `3.8.1`
  help: `localstack-ext` (v3.8.1) was included because `localstack` (v3.8.1) depends on `localstack-ext`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2025-08-15 01:04</div>
            <div class="timeline-body"><p>And outside take on this issue:</p>
<blockquote>
<ul>
<li>we're talking about <a href="https://github.com/localstack/localstack">one of the more popular packages</a> in the Python ecosystem, and</li>
</ul>
</blockquote>
<p>localstack appears to be the 5,834th most popular package on PyPI: https://hugovk.github.io/top-pypi-packages/.</p>
<blockquote>
<p>the issue is apparently unique to uv and not other package managers.</p>
</blockquote>
<p>As @zanieb has already shown, this issue <em>does</em> happen with pip and placing the build directory in the project.</p>
<p>It appears the issue here is <em>likely</em> one of:</p>
<ul>
<li>A bug in the way localstack has defined where to source the version number</li>
<li>Or, a design issue in setuptools-scm where protection could be added to prevent this but currently isn't</li>
<li>Or, a design limitation with gitlab, not allowing the much richer uv cache to not interfere with the sdist build process, in which case you may need to turn off cache on gitlab, or find some other workaround configuration to prevent setuptools-scm for inspecting outside the cache</li>
</ul>
<p>What I don't think has been made clear in this discussion, but when a Python package installer frontend (like uv, pip, poetry, etc.) calls a build backend (like setuptools, hatch, etc.) it does not have any control over what the build backend does, the backend code executes and the frontend waits for the results.</p>
<p>So your insistence on saying the cause is uv is <em>likely</em> untrue. At least in the sense of being a bug, and not a series of application designs interacting with each other from multiple projects. If you would like to find out the root cause you need to engage with all the parties of you're very specific case (localstack, localstacks build dependencies, gitlab, uv cache inside the project directory). Maybe uv could add some protection here, but I don't obviously see how.</p>
<p>I suspect this will affect any installer that uses fully expanded packages in their cache with hard links pointing to them. And as uv has shown their cache design brings a lot of benefits other installers, like Poetry, may well adopt this in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/RonnyPfannschmidt">@RonnyPfannschmidt</a> on 2025-08-15 04:14</div>
            <div class="timeline-body"><p>One confusing aspect is that Setuptools_scm intentionally doesn't escape the build directory
Yet it happens here</p>
<p>Logs of the build process with SETUPTOOLS_SCM_DEBUG=1 would help</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:32:34 UTC
    </footer>
</body>
</html>
