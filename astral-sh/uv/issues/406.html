<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treat python version as a dependency when resolving - astral-sh/uv #406</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Treat python version as a dependency when resolving</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/406">#406</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-11-13 08:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>Sometimes the resolution is impossible because a version of a package can only be installed in a more recent python version than the user has. In the example below, pandas 2.1 requires at least python 3.9, while the user has 3.8.</p>
<p>My suggestion: Add a virtual python dependency with root depending on the user specified version. Set the python dependency of each version to the <code>requires-python</code> of the sdist or that of the union of the wheel if there is no sdist.</p>
<h3>puffin</h3>
<pre><code class="language-console">$ VIRTUAL_ENV=.venv38 cargo run --bin puffin -q -- pip-compile pandas-2.1.in 
error: Failed to build distribution: pandas-2.1.0.tar.gz
  Caused by: Build backend failed to determine extras requires with `get_requires_for_build_wheel`:
--- stdout:
+ meson setup /tmp/.tmpoW2Ldn/extracted/pandas-2.1.0 /tmp/.tmpoW2Ldn/extracted/pandas-2.1.0/.mesonpy-i9atvlaf/build -Dbuildtype=release -Db_ndebug=if-release -Db_vscrt=md --vsenv --native-file=/tmp/.tmpoW2Ldn/extracted/pandas-2.1.0/.mesonpy-i9atvlaf/build/meson-python-native-file.ini
The Meson build system
Version: 1.2.3
Source dir: /tmp/.tmpoW2Ldn/extracted/pandas-2.1.0
Build dir: /tmp/.tmpoW2Ldn/extracted/pandas-2.1.0/.mesonpy-i9atvlaf/build
Build type: native build

../../meson.build:5:13: ERROR: Command `/home/konsti/projects/puffin/.venv/bin/python generate_version.py --print` failed with status 1.

A full log can be found at /tmp/.tmpoW2Ldn/extracted/pandas-2.1.0/.mesonpy-i9atvlaf/build/meson-logs/meson-log.txt
--- stderr:

---
</code></pre>
<p>We should have never picked this sdist!</p>
<h3>puffin after #398</h3>
<pre><code>$ VIRTUAL_ENV=.venv38 cargo run --bin puffin -q -- pip-compile pandas-2.1.in 
  × No solution found when resolving dependencies:
  ╰─▶ Because there is no version of pandas available matching ==2.1 and root depends on pandas==2.1,
      version solving failed.
</code></pre>
<p>I can go to pypi and see that there is a pandas 2.1.2 there, why doesn't puffin use it?</p>
<h3>pip/pip-tools</h3>
<p>(also used by pip-tools, but with a backtrace below):</p>
<pre><code class="language-console">$ .venv38/bin/pip install pandas==2.1
ERROR: Ignored the following versions that require a different python version: 2.1.0 Requires-Python &gt;=3.9; 2.1.0rc0 Requires-Python &gt;=3.9; 2.1.1 Requires-Python &gt;=3.9; 2.1.2 Requires-Python &gt;=3.9; 2.1.3 Requires-Python &gt;=3.9
ERROR: Could not find a version that satisfies the requirement pandas==2.1 (from versions: 0.1, 0.2, 0.3.0, 0.4.0, 0.4.1, 0.4.2, 0.4.3, 0.5.0, 0.6.0, 0.6.1, 0.7.0, 0.7.1, 0.7.2, 0.7.3, 0.8.0, 0.8.1, 0.9.0, 0.9.1, 0.10.0, 0.10.1, 0.11.0, 0.12.0, 0.13.0, 0.13.1, 0.14.0, 0.14.1, 0.15.0, 0.15.1, 0.15.2, 0.16.0, 0.16.1, 0.16.2, 0.17.0, 0.17.1, 0.18.0, 0.18.1, 0.19.0, 0.19.1, 0.19.2, 0.20.0, 0.20.1, 0.20.2, 0.20.3, 0.21.0, 0.21.1, 0.22.0, 0.23.0, 0.23.1, 0.23.2, 0.23.3, 0.23.4, 0.24.0, 0.24.1, 0.24.2, 0.25.0, 0.25.1, 0.25.2, 0.25.3, 1.0.0, 1.0.1, 1.0.2, 1.0.3, 1.0.4, 1.0.5, 1.1.0, 1.1.1, 1.1.2, 1.1.3, 1.1.4, 1.1.5, 1.2.0, 1.2.1, 1.2.2, 1.2.3, 1.2.4, 1.2.5, 1.3.0, 1.3.1, 1.3.2, 1.3.3, 1.3.4, 1.3.5, 1.4.0rc0, 1.4.0, 1.4.1, 1.4.2, 1.4.3, 1.4.4, 1.5.0rc0, 1.5.0, 1.5.1, 1.5.2, 1.5.3, 2.0.0rc0, 2.0.0rc1, 2.0.0, 2.0.1, 2.0.2, 2.0.3)
ERROR: No matching distribution found for pandas==2.1
</code></pre>
<p>Why does pip pretend there is no pandas 2.1.2 when i can clearly see it on pypi, is this a caching bug?</p>
<h3>poetry:</h3>
<pre><code class="language-toml">[tool.poetry]
name = &quot;a&quot;
version = &quot;0.1.0&quot;
description = &quot;&quot;
authors = [&quot;konstin &lt;konstin@mailbox.org&gt;&quot;]
readme = &quot;README.md&quot;

[tool.poetry.dependencies]
python = &quot;~3.8&quot;
pandas = &quot;^2.1&quot;

[build-system]
requires = [&quot;poetry-core&quot;]
build-backend = &quot;poetry.core.masonry.api&quot;
</code></pre>
<pre><code>$ VIRTUAL_ENV=.venv38 poetry update
Updating dependencies
Resolving dependencies... (0.2s)

The current project's Python requirement (&gt;=3.8,&lt;3.9) is not compatible with some of the required packages Python requirement:
  - pandas requires Python &gt;=3.9, so it will not be satisfied for Python &gt;=3.8,&lt;3.9
  - pandas requires Python &gt;=3.9, so it will not be satisfied for Python &gt;=3.8,&lt;3.9
  - pandas requires Python &gt;=3.9, so it will not be satisfied for Python &gt;=3.8,&lt;3.9
  - pandas requires Python &gt;=3.9, so it will not be satisfied for Python &gt;=3.8,&lt;3.9

Because no versions of pandas match &gt;2.1,&lt;2.1.1 || &gt;2.1.1,&lt;2.1.2 || &gt;2.1.2,&lt;2.1.3 || &gt;2.1.3,&lt;3.0
 and pandas (2.1.0) requires Python &gt;=3.9, pandas is forbidden.
And because pandas (2.1.1) requires Python &gt;=3.9
 and pandas (2.1.2) requires Python &gt;=3.9, pandas is forbidden.
So, because pandas (2.1.3) requires Python &gt;=3.9
 and a depends on pandas (^2.1), version solving failed.

  • Check your dependencies Python requirement: The Python requirement can be specified via the `python` or `markers` properties
    
    For pandas, a possible solution would be to set the `python` property to &quot;&lt;empty&gt;&quot;
    For pandas, a possible solution would be to set the `python` property to &quot;&lt;empty&gt;&quot;
    For pandas, a possible solution would be to set the `python` property to &quot;&lt;empty&gt;&quot;
    For pandas, a possible solution would be to set the `python` property to &quot;&lt;empty&gt;&quot;

    https://python-poetry.org/docs/dependency-specification/#python-restricted-dependencies,
    https://python-poetry.org/docs/dependency-specification/#using-environment-markers
</code></pre>
<blockquote>
<p>The current project's Python requirement (&gt;=3.8,&lt;3.9) is not compatible</p>
</blockquote>
<blockquote>
<p>pandas requires Python &gt;=3.9</p>
</blockquote>
<p>I see, i have to change the python requirement in pyproject.toml (or use an older pandas version)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">error messages</span> added by @konstin on 2023-11-13 08:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-11-13 12:16</div>
            <div class="timeline-body"><p>Update: Wheels also have a <code>requires-python</code> we have to consider, this also answers the question what we do when there is no source dist</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-13 14:32</div>
            <div class="timeline-body"><p>Do you know how the <code>requires-python</code> on a wheel differs from its tags?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-11-13 15:38</div>
            <div class="timeline-body"><p>In most cases, the tag is <code>py3-none-any</code>, while <code>requires-python</code> specifies a minimum python minor version such as <code>&gt;=3.8</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-02 21:10</div>
            <div class="timeline-body"><p>I will give this a shot.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-01-02 22:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-01-03 15:20</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:23:08 UTC
    </footer>
</body>
</html>
