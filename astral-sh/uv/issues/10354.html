<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caching uv pip install in Gitlab CI - astral-sh/uv #10354</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Caching uv pip install in Gitlab CI</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/10354">#10354</a>
        opened by <a href="https://github.com/ticapix">@ticapix</a>
        on 2025-01-07 10:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ticapix">@ticapix</a></div>
            <div class="timeline-body"><p>Hello,</p>
<p>Reading the doc at https://docs.astral.sh/uv/guides/integration/gitlab/, how do I cache the <code>uv pip install</code> ?</p>
<p>I would have expected the following <code>.gitlab-ci.yml</code> to success.</p>
<pre><code class="language-yaml">variables:
  UV_SYSTEM_PYTHON: 1 # remove the need to create a venv
  UV_CACHE_DIR: .uv-cache

default:
  image: ghcr.io/astral-sh/uv:0.5-python3.11-alpine
  cache:
    - key: test
      paths:
        - $UV_CACHE_DIR

uv-install:
  stage: .pre
  script:
    - uv pip show rdflib || true # fails as expected
    - uv pip install rdflib
    - uv cache prune --ci
    - uv pip show rdflib

test:
  stage: test
  script:
    - uv pip show rdflib # fails here
</code></pre>
<p>But I have the error where rdflib is not installed in the test stage.</p>
<p>Note: <em>I'm using <a href="https://github.com/firecow/gitlab-ci-local">gitlab-ci-local</a> to test locally</em></p>
<pre><code class="language-shell">$ gitlab-ci-local
Unable to retrieve default remote branch, falling back to `main`.
  The default remote branch can be set via `git remote set-head origin &lt;default_branch&gt;`
parsing and downloads finished in 57 ms.
json schema validated in 220 ms
uv-install starting ghcr.io/astral-sh/uv:0.5-python3.11-alpine (.pre)
uv-install copied to docker volumes in 516 ms
uv-install imported cache 'test' in 274 ms
uv-install $ uv pip show rdflib || true
uv-install &gt; Using Python 3.11.11 environment at: /usr/local
uv-install &gt; warning: Package(s) not found for: rdflib
uv-install $ uv pip install rdflib
uv-install &gt; Using Python 3.11.11 environment at: /usr/local
uv-install &gt; Resolved 2 packages in 14ms
uv-install &gt; warning: Failed to hardlink files; falling back to full copy. This may lead to degraded performance.
uv-install &gt;          If the cache and target directories are on different filesystems, hardlinking may not be supported.
uv-install &gt;          If this is intentional, set `export UV_LINK_MODE=copy` or use `--link-mode=copy` to suppress this warning.
uv-install &gt; Installed 2 packages in 10ms
uv-install &gt;  + pyparsing==3.2.1
uv-install &gt;  + rdflib==7.1.1
uv-install $ uv cache prune --ci
uv-install &gt; Pruning cache at: .uv-cache
uv-install &gt; Removed 3422 files (59.5MiB)
uv-install $ uv pip show rdflib
uv-install &gt; Using Python 3.11.11 environment at: /usr/local
uv-install &gt; Name: rdflib
uv-install &gt; Version: 7.1.1
uv-install &gt; Location: /usr/local/lib/python3.11/site-packages
uv-install &gt; Requires: pyparsing
uv-install &gt; Required-by:
uv-install finished in 1.42 s
uv-install exported cache .uv-cache 'test' in 633 ms
test       starting ghcr.io/astral-sh/uv:0.5-python3.11-alpine (test)
test       copied to docker volumes in 503 ms
test       imported cache 'test' in 283 ms
test       $ uv pip show rdflib
test       &gt; Using Python 3.11.11 environment at: /usr/local
test       &gt; warning: Package(s) not found for: rdflib
test       finished in 1.35 s  FAIL 1

 PASS  uv-install
 FAIL  test
  &gt; Using Python 3.11.11 environment at: /usr/local
  &gt; warning: Package(s) not found for: rdflib
pipeline finished in 3.76 s
</code></pre>
<p>Apparently it fails because <code>uv pip</code> installs in <code>/usr/local</code> which is outside the project directory, hence, can't be cached by Gitlab.</p>
<p>To make it work, I have to NOT use <code>UV_SYSTEM_PYTHON: 1</code> and run <code>ux venv</code> in my <code>.pre</code> stage.</p>
<p>Is the config below supposed to be the correct way to cache <code>uv pip install</code> ?</p>
<pre><code class="language-yaml">variables:
  UV_CACHE_DIR: .uv-cache


default:
  image: ghcr.io/astral-sh/uv:0.5-python3.11-alpine
  cache:
    - key: test
      paths:
        - $UV_CACHE_DIR
        - .venv

uv-install:
  stage: .pre
  script:
    - uv venv --allow-existing
    - uv pip show rdflib || true
    - uv pip install rdflib
    - uv cache prune --ci
    - uv pip show rdflib

test:
  stage: test
  script:
    - uv pip show rdflib # works
</code></pre>
<p>Or is there another way to install packages from the <code>pyproject.toml</code> file than <code>uv pip install -r pyproject.toml</code> ?</p>
<p>Thank you,
Pierre</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-07 18:32</div>
            <div class="timeline-body"><p>Yeah I would use a virtual environment, that seems right to me.</p>
<blockquote>
<p>Or is there another way to install packages from the pyproject.toml file than uv pip install -r pyproject.toml ?</p>
</blockquote>
<p>You can use <code>uv sync</code> or <code>uv pip install .</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> added by @zanieb on 2025-01-07 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2025-01-07 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-07 18:33</div>
            <div class="timeline-body"><p>cc @jvacek not sure if you think the documentation should change?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-07 18:34</div>
            <div class="timeline-body"><p>cc @sisp who also worked on these docs</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jvacek">@jvacek</a> on 2025-03-17 16:55</div>
            <div class="timeline-body"><p>@ticapix are you expecting the environment to persist across steps, or are you expecting uv's cache to persist across steps?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:29:10 UTC
    </footer>
</body>
</html>
