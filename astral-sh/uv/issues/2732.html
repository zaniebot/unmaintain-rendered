<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Segmentation fault in tokio worker runtime on iSH  - astral-sh/uv #2732</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Segmentation fault in tokio worker runtime on iSH </h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/2732">#2732</a>
        opened by <a href="https://github.com/gpchn">@gpchn</a>
        on 2024-03-30 13:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/gpchn">@gpchn</a> on 2024-03-30 13:27</div>
            <div class="timeline-body"><h1>Environment</h1>
<h2>platform (result of &quot;uname -a&quot;)</h2>
<p>Linux iPhone-7-Plus 4.20.69-ish SUPER AWESOME May 20 2023 23:41:32 i686 Linux</p>
<p>Note: Alpine Linux's default shell is ash. This may be crucial.</p>
<h2>uv version</h2>
<p>0.1.26</p>
<h2>Method of reproducing</h2>
<p>I'm afraid you have to try to find an Apple device and install iSH to reproduce.</p>
<h1>issue</h1>
<p>I use iSH app to simulate linux on iPhone. Using pip in this case is unbearably slow. So I tried to install uv.
I tried four times, but the installation was not successful. The following are the details of my four attempts.</p>
<ol>
<li><p>I first installed it using the package manager: &quot;apk add uv&quot; (apk is the package manager of Alpine Linux.)  Output shows that there is no such package. Then I ran &quot;apk search uv&quot;, still no.</p>
</li>
<li><p>I ran the installation command in readme. But it raised an error: <strong>ERROR: there isn't a package for i686-unknown-linux-musl-dynamic</strong>. I didn't delve into the reason.</p>
</li>
<li><p>I downloaded <a href="https://github.com/astral-sh/uv/releases/download/0.1.26/uv-i686-unknown-linux-musl.tar.gz">uv-i686-unknown-linux-musl.tar.gz</a>, uncompressed it, and tried running the &quot;uv&quot; file in it. It raised an error again:</p>
</li>
</ol>
<pre><code>thread 'tokio-runtime-worker' panicked at /root/.cargo/registry/src/index.crates.io-6f17d22bba15001f/tokio-1.36.0/src/runtime/scheduler/multi_thread/worker.rs:656:12thread 'tokio-runtime-worker' panicked at /root/.cargo/registry/src/index.crates.io-6f17d22bba15001f/tokio-1.36.0/src/runtime/scheduler/multi_thread/worker.rs:656:12:
:
attempt to calculate the remainder with a divisor of zero
attempt to calculate the remainder with a divisor of zero
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
Segmentation fault
</code></pre>
<p>I thought it might not work this way, So I tried to find another.</p>
<ol start="4">
<li>I browsed the installation script and modified the part of the architecture check. I let it to install <strong>i686-unknown-linux-musl</strong> directly. The installation went smoothly. The output looks like this:</li>
</ol>
<pre><code>downloading uv 0.1.26 i686-unknown-linux-musl
installing to /root/.cargo/bin
  uv
everything's installed!

To add $HOME/.cargo/bin to your PATH, either restart your shell or run:

    source $HOME/.cargo/env

</code></pre>
<p>I ran &quot;source $HOME/.cargo/env&quot; and then ran &quot;uv&quot;, still not working. Error message was the same as the second time.</p>
<h2>my request</h2>
<p>Please see what's wrong with this. Alpine Linux is popular after all.</p>
<p>PS: uv is such a cool program!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-30 14:06</div>
            <div class="timeline-body"><p>Thanks for the issue. We do support Alpine (ref #1392) but perhaps not on i686.</p>
<p>Could you share the output with <code>RUST_BACKTRACE=1</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gpchn">@gpchn</a> on 2024-03-31 08:11</div>
            <div class="timeline-body"><p>Ok, this is the screenshot.
<img src="https://github.com/astral-sh/uv/assets/99541536/bdc1d8d0-5825-4b6b-a42d-155fc2ccf2a9" alt="0B56530C-2AD9-4EC3-9395-B9B800B4BC68" />
Looks like it's the same as before :(</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @charliermarsh on 2024-04-01 14:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andypost">@andypost</a> on 2024-05-14 18:20</div>
            <div class="timeline-body"><p>Today there's <code>uv</code> in <a href="https://gitlab.alpinelinux.org/alpine/aports/-/merge_requests/65643">Alpinelinux</a> testing repo</p>
<p>The only tricky workaround was to disable vendored openssl as Alpine using latest 3.3 via <code>export OPENSSL_NO_VENDOR=1</code></p>
<p>Guess it could be improved but there's so many openssl versions in the stable releases</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../ish-app/ish/issues/2447.html">ish-app/ish#2447</a> on 2024-08-27 15:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lmBored">@lmBored</a> on 2025-01-20 22:41</div>
            <div class="timeline-body"><p>I'm actually still having this issue, currently using <code>Alpine 3.21</code> on ish.app, <code>uv 0.5.21</code></p>
<p><code>uv</code> always returns <code>segmentation fault</code> if it's followed by a command, but it works normally with flags.</p>
<pre><code class="language-bash">&gt; uv venv
segmentation fault
&gt; uv python list
segmentation fault
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-21 01:54</div>
            <div class="timeline-body"><p>@lmBored how are you installing uv? Can you reproduce in a Docker image?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lmBored">@lmBored</a> on 2025-01-21 16:36</div>
            <div class="timeline-body"><blockquote>
<p><a href="https://github.com/lmBored">@lmBored</a> how are you installing uv? Can you reproduce in a Docker image?</p>
</blockquote>
<p>Hi, thanks for looking into this! I tried installing uv using both apk and pip:</p>
<ul>
<li><code>apk add uv</code>: Installed successfully but results in a segmentation fault when I use commands like uv venv or uv python list</li>
<li><code>pip install uv</code>: Installed successfully, but the segmentation fault persists with the same commands.</li>
</ul>
<p>I haven't tested in a Docker container yet. My system is <code>Linux localhost 4.20.69-ish i686 Linux</code>, which for now I'm suspecting that rust doesn't work because of incompatility with <code>i686</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "It doesn't work on Alpine Linux（Actually in iSH app）" to "Segmentation fault in tokio worker runtime on iSH " by @zanieb on 2025-03-26 19:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/geofft">@geofft</a> on 2025-03-27 15:07</div>
            <div class="timeline-body"><p>I think this issue is largely going to be about iSH itself.</p>
<p>With the current uv release (0.6.10) and the current versions of iSH (1.3.2) and the Alpine it installs (v3.14), <code>uv</code> itself runs fine and prints the help message and simple things like <code>uv --version</code> work, but subcommands do not.</p>
<p>If I run an unknown command like <code>uv moo</code> I get an illegal instruction error, currently (uv 0.6.10 release) with the error (from <code>dmesg</code>) pointing towards this instruction (from <code>objdump -S uv</code>):</p>
<pre><code> 86e660a: 66 0f 5e c2                   divpd   %xmm2, %xmm0
</code></pre>
<p>divpd is an SSE2 instruction, and I see a bunch of pull requests/issues in iSH adding various SSE2 operations, but nothing about divpd in particular. Might be worth opening one.</p>
<p>If I run a valid command like <code>uv venv</code> I get a segmentation fault, pointing towards this instruction:</p>
<pre><code> 86f9927: 65 66 0f d6 0d f4 ff ff ff    movq    %xmm1, %gs:-0xc
</code></pre>
<p>which is also an SSE2 thing, but is a much more straightforward SSE2 instruction. There's a <code>movl    $0x1, %gs:-0x18</code> instruction a bit before it, so it seems a little implausible that %gs is an invalid pointer. It might be the case that the segfault is actually being reported about the <em>previous</em> instruction (if the program counter has already been incremented)</p>
<pre><code> 86f9922: 66 0f 70 c8 ee                pshufd  $0xee, %xmm0, %xmm1     # xmm1 = xmm0[2,3,2,3]
</code></pre>
<p>which is a more unusual instruction, but pshufd appears to be implemented (five years ago, in a <a href="https://github.com/ish-app/ish/commit/0b081ebdf0da49131d1ac71fffce42e1d865aef6">commit specifically mentioning Rust as the motivation</a>), and this operation doesn't touch memory at all. So I don't yet know what is actually going wrong here.</p>
<p>I am not having a great time running gdb inside iSH. I do see there's some instructions in the README about running the emulator alone as a command-line tool for testing, which might be worth doing if someone wants to really dig into this. But ultimately I think this should be raised in iSH and not in uv.</p>
<p>There's maybe an argument that the real problem is that i686 is too ambitious for iSH and an older baseline like i386 might work better. I'm not sure if it makes sense for uv (and python-build-standalone, too, probably) to lower the x86-32 baseline specifically for iSH, but in any case, someone could try doing a build of uv without SSE2 support and see if it gets farther.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">external</span> added by @zanieb on 2025-03-27 17:14</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:34:57 UTC
    </footer>
</body>
</html>
