<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv sync --only-group and --no-extra still evaluates other package sources not specified, source = path - astral-sh/uv #11675</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>uv sync --only-group and --no-extra still evaluates other package sources not specified, source = path</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/11675">#11675</a>
        opened by <a href="https://github.com/JWCS">@JWCS</a>
        on 2025-02-20 19:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/JWCS">@JWCS</a> on 2025-02-20 19:13</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>MRE:
<code>chmod +x Dockerfile &amp;&amp; ./Dockerfile &amp;&amp; docker run --network host -it --rm --entrypoint sh mre-exclude-groups:latest</code></p>
<pre><code class="language-Dockerfile">#!/usr/bin/env -S docker build -t mre-exclude-groups:latest . -f
FROM ghcr.io/astral-sh/uv:python3.10-alpine

WORKDIR /app

COPY pyproject.toml .
# ideally, reusing existing uv.lock file; but the chicken-egg problem is without uv.lock file; see --inexact

ENV UV_COMPILE_BYTECODE=1 UV_LINK_MODE=copy

RUN uv venv

# BUG 1
# This doesn't work because &quot;distribution not found at &lt;this path&gt;&quot;, for unspecified group/package groundingdino
#RUN uv sync --inexact --only-group legacy-setup-req

# Ok, install, try again
RUN apk add git &amp;&amp; git clone --depth 1 --single-branch https://github.com/IDEA-Research/GroundingDINO.git

# BUG 2 (might be the same)
#RUN uv sync --inexact --only-group legacy-setup-req
# Failed to build groundingdino at &lt;this path&gt;, no module named torch

# What I want to do
#RUN uv sync --inexact --only-group legacy-setup-req
#RUN uv sync --inexact --no-default-groups --no-install-project
#RUN uv sync --inexact --all-groups --no-install-project
#RUN uv sync -U
</code></pre>
<pre><code class="language-toml">[project]
name = &quot;uv-exclude-groups-mre&quot;
dynamic = [&quot;version&quot;]
requires-python = &quot;&gt;=3.10&quot;
dependencies = [
  &quot;numpy&lt;2&quot;,
  &quot;torch==1.13.1+cu116&quot;,
  &quot;torchvision==0.14.1+cu116&quot;,
]
[dependency-groups]
legacy-setup-req = [ &quot;setuptools&quot;, &quot;torch&quot; ]
groundingdino = [ {include-group=&quot;legacy-setup-req&quot;}, &quot;groundingdino&quot; ]

[tool.uv]
package = false
environments = [
  &quot;sys_platform == 'linux' and implementation_name == 'cpython' and platform_machine == 'x86_64'&quot;,
]

[tool.uv.sources]
torch       = { index = &quot;pytorch-cu116&quot; }
torchvision = { index = &quot;pytorch-cu116&quot; }
groundingdino = { path = &quot;GroundingDINO&quot;, editable = false }

[[tool.uv.index]]
name = &quot;pytorch-cu116&quot;
url = &quot;https://download.pytorch.org/whl/cu116&quot;
explicit = true

# stop uv from building workaround https://github.com/astral-sh/uv/issues/6321
[tool.setuptools]
py-modules = []
</code></pre>
<p>Granted, I know that FWIW, these are all just &quot;temporary&quot; (but crucial) hacks around some cleaner mechanism for dealing with setup.py/pytorch packages; there's a handful of such issues around the repo. Ex #7390 #7722
It's a pain to uv <code>pip install torch</code> not pinned to the version/source specified in the pyproject.toml, and then tier the builds. Ex, this does work:</p>
<p>However, I'm also getting this issue with &quot;optional-dependencies&quot;:</p>
<pre><code class="language-diff">&gt; git diff
diff --git a/Dockerfile b/Dockerfile
index e350a25..f37b630 100755
--- a/Dockerfile
+++ b/Dockerfile
@@ -17,8 +17,14 @@ RUN uv venv
 # Ok, install, try again
 RUN apk add git &amp;&amp; git clone --depth 1 --single-branch https://github.com/IDEA-Research/GroundingDINO.git

-# BUG 2 (might be the same)
-#RUN uv sync --inexact --only-group legacy-setup-req
+# BUG 3: considers optionals!
+RUN --mount=type=cache,target=/root/.cache/uv \
+   uv sync --inexact --no-extra compile # FAILS, tries to parse GroundingDino/setup.py
+RUN --mount=type=cache,target=/root/.cache/uv \
+   uv sync --inexact # FAILS, tries to parse GroundingDino/setup.py
+RUN --mount=type=cache,target=/root/.cache/uv \
+   uv sync --inexact --extra build # FAILS, tries to parse GroundingDino/setup.py
+RUN --mount=type=cache,target=/root/.cache/uv \
+   uv sync --inexact --extra build --extra compile
 # Failed to build groundingdino at &lt;this path&gt;, no module named torch

 # What I want to do
diff --git a/pyproject.toml b/pyproject.toml
index 4c1d845..9b9ea3b 100644
--- a/pyproject.toml
+++ b/pyproject.toml
@@ -7,9 +7,10 @@ dependencies = [
   &quot;torch==1.13.1+cu116&quot;,
   &quot;torchvision==0.14.1+cu116&quot;,
 ]
-[dependency-groups]
-legacy-setup-req = [ &quot;setuptools&quot;, &quot;torch&quot; ]
-groundingdino = [ {include-group=&quot;legacy-setup-req&quot;}, &quot;groundingdino&quot; ]
+
+[project.optional-dependencies]
+build = [&quot;setuptools&quot;, &quot;torch&quot;]
+compile = [&quot;groundingdino&quot;]

 [tool.uv]
 package = false
</code></pre>
<p>The 3 uv sync commands which shouldn't be considering groundingdino all try evaluating its setup.py, which on first run, no torch is installed.</p>
<h3>Platform</h3>
<p>Alpine x64 (uv docker image)</p>
<h3>Version</h3>
<p>uv 0.6.1</p>
<h3>Python version</h3>
<p>Python 3.10</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @JWCS on 2025-02-20 19:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-20 19:45</div>
            <div class="timeline-body"><p>This looks similar to</p>
<ul>
<li>https://github.com/astral-sh/uv/issues/11363</li>
<li>https://github.com/astral-sh/uv/issues/11104</li>
<li>https://github.com/astral-sh/uv/issues/9654</li>
</ul>
<p>We need to resolve all of the packages (including groups and extras) even if you do not want to include them in the <code>sync</code> operation. I don't understand why you can't use the existing lockfile?</p>
<p>Perhaps I'm misunderstanding?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @zanieb on 2025-02-20 19:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2025-02-20 19:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JWCS">@JWCS</a> on 2025-02-20 19:57</div>
            <div class="timeline-body"><p>It's the chicken-and-egg problem. If I have a lockfile, then I can <code>uv sync --frozen</code> install the dependencies (at least, say, setuptools/pytorch). Which enables unlimited further variants of <code>uv sync</code>. But if I don't have a lock file, and I wanted to create it from scratch... then my only option is commenting out the optional or group dependencies, <code>uv sync</code> that to get the initial lock file, then uncomment the optionals/group deps and then <code>uv sync</code> install them.</p>
<p>It's not impossible... but I didn't realize this was the only real way to set this up from scratch, as of 0.6.1.
I guess, the bug is that the documentation (and the recommendations from other gh issues) <em>seems</em> like the behavior of --only-group/--no-extra would even exclude resolving of such packages, especially if they're known to be broken when resolved out of order. There's no mechanism right now to prevent the resolving of packages without commenting out / sed-ing the pyproject.toml file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/12309.html">astral-sh/uv#12309</a> on 2025-03-19 08:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-04-11 11:06</div>
            <div class="timeline-body"><p>fwiw you can use <code>uv lock</code> to generate a lockfile without syncing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eremeevfd">@eremeevfd</a> on 2025-06-30 13:50</div>
            <div class="timeline-body"><p>We also found ourselves in a similar situation. Our case is: we need the libraries from private registry only for testing, but for production build, we don't want to expose credentials for registry and have these dependencies present at all. But it's currently impossible to install only non-private dependencies unfortunately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mrezzamoradi">@mrezzamoradi</a> on 2025-08-08 22:24</div>
            <div class="timeline-body"><p>To my understanding, <code>uv sync</code> by default tries to update the lock file to make sure it's in sync with <code>pyproject.toml</code> <strong>and that's the reason it needs to resolve the dependencies in every group</strong>. Now if you don't want to update the lock file, which is usually the case in Dockerifles and in CI pipelines, just pass <code>--frozen</code> flag to the sync command. That should remove the necessity to resolve the dependencies since it is assuming the paths in the lock file are already correct.</p>
<p>I tried it in a test project and managed to reproduce the issue and solve it with <code>--frozen</code></p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:26 UTC
    </footer>
</body>
</html>
