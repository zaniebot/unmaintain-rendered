<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In uv's official Dockerfile example when uv sync is called 2nd time it removes the .venv it has just created and reinstalls everything from scratch - astral-sh/uv #13207</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>In uv's official Dockerfile example when uv sync is called 2nd time it removes the .venv it has just created and reinstalls everything from scratch</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/13207">#13207</a>
        opened by <a href="https://github.com/Ark-kun">@Ark-kun</a>
        on 2025-04-30 01:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Ark-kun">@Ark-kun</a> on 2025-04-30 01:33</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I'm building a simple uv-based container using Podman, following the official example: https://docs.astral.sh/uv/guides/integration/docker/#intermediate-layers</p>
<p>Running <code>uv sync</code> twice results in uv removing and recreating the virtual environement, thus creating inefficient container images.</p>
<pre><code>STEP 10/11: RUN --mount=type=cache,target=/root/.cache/uv     uv sync --frozen --no-dev
warning: Ignoring existing virtual environment linked to non-existent Python interpreter: .venv/bin/python3 -&gt; python
Using CPython 3.10.14
Removed virtual environment at: .venv
Creating virtual environment at: .venv
</code></pre>
<p>Repro steps:</p>
<ul>
<li><code>git clone https://github.com/astral-sh/uv-docker-example</code></li>
<li><code>cd uv-docker-example</code></li>
<li>Modify Dockerfile to replace the <code>--mount=bind=</code> options with explicit ADD directives as Podman has some Access denied issues with mounted files on Mac OSX</li>
<li><code>podman build -f Dockerfile</code></li>
</ul>
<p>Dockerfile:</p>
<pre><code># Use a Python image with uv pre-installed
FROM ghcr.io/astral-sh/uv:python3.12-bookworm-slim

# Install the project into `/app`
WORKDIR /app

ADD ./.python-version .
ADD ./uv.lock .
ADD ./pyproject.toml .

# Enable bytecode compilation
ENV UV_COMPILE_BYTECODE=1

# Copy from the cache instead of linking since it's a mounted volume
ENV UV_LINK_MODE=copy

# Install the project's dependencies using the lockfile and settings
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --frozen --no-dev --no-install-project       

# Then, add the rest of the project source code and install it
# Installing separately from its dependencies allows optimal layer caching
ADD . /app
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --frozen --no-dev

# Place executables in the environment at the front of the path
ENV PATH=&quot;/app/.venv/bin:$PATH&quot;
</code></pre>
<pre><code>% podman build -f Dockerfile --no-cache=true
STEP 1/11: FROM ghcr.io/astral-sh/uv:python3.12-bookworm-slim
STEP 2/11: WORKDIR /app
--&gt; 49457bdf851e
STEP 3/11: ADD ./.python-version .
--&gt; fdf465cb18e4
STEP 4/11: ADD ./uv.lock .
--&gt; 1d63e6545763
STEP 5/11: ADD ./pyproject.toml .
--&gt; dc2ffdf03748
STEP 6/11: ENV UV_COMPILE_BYTECODE=1
--&gt; 6250b1df44ff
STEP 7/11: ENV UV_LINK_MODE=copy
--&gt; 4d94792101c2
STEP 8/11: RUN     --mount=type=cache,target=/root/.cache/uv     uv sync --frozen --no-dev --no-install-project       
Downloading cpython-3.10.14-linux-aarch64-gnu (download) (18.5MiB)
 Downloading cpython-3.10.14-linux-aarch64-gnu (download)
Using CPython 3.10.14
Creating virtual environment at: .venv
Prepared 6 packages in 0.84ms
Installed 6 packages in 297ms
Bytecode compiled 1950 files in 459ms
 + numpy==2.2.5
 + pandas==2.2.3
 + python-dateutil==2.9.0.post0
 + pytz==2025.2
 + six==1.17.0
 + tzdata==2025.2
--&gt; 801317ba8e02
STEP 9/11: ADD . /app
--&gt; bcf81b48cbbc
STEP 10/11: RUN --mount=type=cache,target=/root/.cache/uv     uv sync --frozen --no-dev
warning: Ignoring existing virtual environment linked to non-existent Python interpreter: .venv/bin/python3 -&gt; python
Using CPython 3.10.14
Removed virtual environment at: .venv
Creating virtual environment at: .venv
Prepared 6 packages in 0.77ms
Installed 6 packages in 357ms
Bytecode compiled 1950 files in 608ms
 + numpy==2.2.5
 + pandas==2.2.3
 + python-dateutil==2.9.0.post0
 + pytz==2025.2
 + six==1.17.0
 + tzdata==2025.2
--&gt; 754eebfe8d34
STEP 11/11: ENV PATH=&quot;/app/.venv/bin:$PATH&quot;
COMMIT
--&gt; 2674781947f2
2674781947f2bcdc7a1a911539a5a6e862d6a70ff552ece3507e17d1056fae6b
</code></pre>
<p>Expected: uv does not delete and re-install .venv.</p>
<h3>Platform</h3>
<p>macOS 15</p>
<h3>Version</h3>
<p>ghcr.io/astral-sh/uv:python3.12-bookworm-slim == uv 0.7.0</p>
<h3>Python version</h3>
<p>cpython-3.10.14</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @Ark-kun on 2025-04-30 01:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "In uv's official Dockerfile example uv sync removes the .venv it has just created and reinstalls everything from scratch" to "In uv's official Dockerfile example when uv sync is called 2nd time it removes the .venv it has just created and reinstalls everything from scratch" by @Ark-kun on 2025-04-30 01:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-04-30 02:00</div>
            <div class="timeline-body"><p>Is your <code>.venv</code> in your <code>.dockerignore</code>? Otherwise, you'll copy it into the image and break the environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-04-30 02:00</div>
            <div class="timeline-body"><p>e.g., see https://github.com/astral-sh/uv-docker-example/blob/main/.dockerignore</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @zanieb on 2025-04-30 13:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2025-04-30 13:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Ark-kun">@Ark-kun</a> on 2025-04-30 22:41</div>
            <div class="timeline-body"><p>I apologize. I think you're right. What a rookie mistake...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Ark-kun on 2025-04-30 22:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:33:05 UTC
    </footer>
</body>
</html>
