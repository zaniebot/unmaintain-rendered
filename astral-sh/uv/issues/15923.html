<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv pip install unexpectedly works against unsourced environment in ~/.local/ - astral-sh/uv #15923</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv pip install unexpectedly works against unsourced environment in ~/.local/</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/15923">#15923</a>
        opened by <a href="https://github.com/dvrogozh">@dvrogozh</a>
        on 2025-09-18 00:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dvrogozh">@dvrogozh</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I was experimenting with installation options which <code>uv</code> provides and came across the following scenario which seems quote confusing. It occurs that if <code>uv</code> virtual environment is created in <code>~/.local/</code> folder, then some of the <code>uv pip</code> commands, specifically - <code>uv pip install</code> - start to pick it up even if environment is not activated while other commands, such as <code>uv pip show</code> and <code>uv pip list</code> ignore it.</p>
<p>Can either the whole this behavior be prohibited entirely (<code>uv pip install</code> to be failed) or allowed and then all the <code>uv</code> commands should support such scenario?</p>
<pre><code>docker run -it --rm ubuntu:24.04
root@b7d54f53e6ef:/# apt-get update &amp;&amp; apt-get install curl
root@b7d54f53e6ef:/# curl -LsSf https://astral.sh/uv/install.sh | sh
downloading uv 0.8.18 x86_64-unknown-linux-gnu
no checksums to verify
installing to /root/.local/bin
  uv
  uvx
everything's installed!

To add $HOME/.local/bin to your PATH, either restart your shell or run:

    source $HOME/.local/bin/env (sh, bash, zsh)
    source $HOME/.local/bin/env.fish (fish)
root@b7d54f53e6ef:/# source $HOME/.local/bin/env

root@b7d54f53e6ef:/# uv pip install numpy
error: No virtual environment found; run `uv venv` to create an environment, or pass `--system` to install into a non-virtual environment

root@b7d54f53e6ef:/# uv venv --allow-existing $HOME/.local
Using CPython 3.13.7
Creating virtual environment at: /root/.local
Activate with: source root/.local/bin/activate

root@b7d54f53e6ef:/# uv pip install numpy
Using Python 3.13.7 environment at: /root/.local
Resolved 1 package in 111ms
Prepared 1 package in 385ms
Installed 1 package in 61ms
 + numpy==2.3.3

root@b7d54f53e6ef:/# uv pip show numpy
Using Python 3.13.7 environment at: /root/.local/share/uv/python/cpython-3.13.7-linux-x86_64-gnu
warning: Package(s) not found for: numpy

root@b7d54f53e6ef:/# uv pip list
Using Python 3.13.7 environment at: /root/.local/share/uv/python/cpython-3.13.7-linux-x86_64-gnu
Package Version
------- -------
pip     24.3.1
</code></pre>
<h3>Platform</h3>
<p>Ubuntu 24.04</p>
<h3>Version</h3>
<p>0.8.18</p>
<h3>Python version</h3>
<p>Python 3.13.7</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dvrogozh on 2025-09-18 00:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-09-18 00:52</div>
            <div class="timeline-body"><p>That's weird, thanks for the reproduction â€” I'll take a look.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-09-18 00:55</div>
            <div class="timeline-body"><p>Oh, it's because you're creating a virtual environment at <code>~/.local</code> which puts a <code>python</code> binary in <code>~/.local/bin</code> which we then find since <code>~/.local/bin</code> is on your <code>PATH</code></p>
<pre><code>TRACE Searching PATH for executables: python, python3
TRACE Checking `PATH` directory for interpreters: /root/.local/bin
TRACE Found possible Python executable: /root/.local/bin/python
TRACE Found cached interpreter info for Python 3.13.7, skipping query of: /root/.local/bin/python
DEBUG Found `cpython-3.13.7-linux-aarch64-gnu` at `/root/.local/bin/python` (first executable in the search path)
</code></pre>
<p>I'd recommend not doing that :)</p>
<p>Perhaps you meant <code>uv venv ~/.local/venv</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @zanieb on 2025-09-18 00:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2025-09-18 00:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-09-18 00:57</div>
            <div class="timeline-body"><p><code>uv pip list</code> finds the non-virtual environment by default</p>
<pre><code>root@bc08349b4fb1:/# uv pip list -v
DEBUG uv 0.8.18
DEBUG Searching for default Python interpreter in virtual environments, managed installations, or search path
DEBUG Searching for managed installations at `/root/.local/share/uv/python`
DEBUG Found managed installation `cpython-3.13.7-linux-aarch64-gnu`
DEBUG Found `cpython-3.13.7-linux-aarch64-gnu` at `/root/.local/share/uv/python/cpython-3.13.7-linux-aarch64-gnu/bin/python3.13` (managed installations)
Using Python 3.13.7 environment at: /root/.local/share/uv/python/cpython-3.13.7-linux-aarch64-gnu
Package Version
------- -------
pip     24.3.1
</code></pre>
<p>while <code>uv pip install</code> is not allowed to find that environment because it's a mutable operation. I can see how that's a bit confusing. I'm not sure if there's a great way to address it though. Most people won't encounter that because the virtual environment interpreter won't be on their <code>PATH</code> without activating the environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dvrogozh">@dvrogozh</a> on 2025-09-18 01:21</div>
            <div class="timeline-body"><blockquote>
<p>I'd recommend not doing that :). Perhaps you meant <code>uv venv ~/.local/venv</code>?</p>
</blockquote>
<p>No, I meant exactly <code>~/.local</code>. Eventually I figured out that's better not to do that. Unfortunately in my case this also means that better not to use <code>uv</code>.</p>
<p>For the background, I don't need virtual environment at all as I am working inside the container for ci. Environment is already isolated and adding another layer of isolation which requires to source environment on each step does not quite make sense. From the other hand I also don't want to install dependencies system wide (with <code>pip install --system</code>) for various reasons one of which being that this would require <code>sudo</code> as in my case container user is not <code>root</code>. This lead to the consideration whether <code>uv</code> supports installation to <code>~/.local/</code> similar to regular <code>pip</code>. Here it occurs that <code>uv</code> does not support <code>--user</code> - there are few issues already filed and closed on that. But in one of the issues which dismissed to introduce <code>--user</code> someone suggested a workaround, see https://github.com/astral-sh/uv/issues/2077#issuecomment-1971579880, which was to create environment in <code>~/.local</code>. So, I did not come myself to try this out, but just tried the approach. Eventually it does not quite work.</p>
<p>Note that <code>uv</code> also has quite strange environment variable <code>UV_PROJECT_ENVIRONMENT</code> which is not supported in some commands including <code>uv pip</code>. While not directly related to the above issue, it does give another layer of confusion and complexity especially for someone who tries things out.</p>
<blockquote>
<p>I'd recommend not doing that :).</p>
</blockquote>
<p>I am totally fine with that. However, can this be translated into the fix in <code>uv</code> to prohibit such scenario?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-09-18 07:37</div>
            <div class="timeline-body"><p>Unfortunately, a venv in <code>~/.local</code> and a <code>--user</code> install work very differently. While I agree that a venv in docker is some sort of double-isolation, venvs do have additional benefits, see e.g. https://hynek.me/articles/docker-virtualenv/. A venv gives you the same experience and paths in and out of docker; maybe it's easier to see the <code>.venv</code> folder as a build artifact rather than an isolation tool: It's a &quot;bundle&quot; of all your dependencies. venvs are also useful for multi-stage builds, you can populate one in a build stage and then don't need to have uv in the run stage. In the Dockerfile, you can set <code>VIRTUAL_ENV</code> and <code>PATH</code> to activate the venv, so you don't need to source the environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-09-18 12:57</div>
            <div class="timeline-body"><p>I think <code>uv pip list</code> and <code>uv pip show</code> listing the managed environment is actually a bug. I tested on 0.7.x and it worked as you'd expect. I think this is a regression from https://github.com/astral-sh/uv/pull/7934  that I missed in https://github.com/astral-sh/uv/pull/15061</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:32:57 UTC
    </footer>
</body>
</html>
