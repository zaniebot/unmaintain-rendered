<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>venv and pip-compile subcommands should respect `requires-python` - astral-sh/uv #832</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>venv and pip-compile subcommands should respect <code>requires-python</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/832">#832</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2024-01-08 13:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/konstin">@konstin</a> on 2024-01-08 13:46</div>
            <div class="timeline-body"><p>Running <code>puffin venv</code> in a directory with a pyproject.toml in it (or in any parent) with e.g.</p>
<pre><code class="language-toml">[project]
name = &quot;foo&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.11,&lt;3.13&quot;
</code></pre>
<p>should default to the highest available python matching the specifiers.</p>
<p>Currently, when <code>python</code> is 3.10, it will create an incompatible venv with python 3.10 instead.</p>
<p>The same goes for the <code>pip-compile</code> with <code>pyproject.toml</code>. Currently, it will resolve for versions mismatching <code>requires-python</code>. It should also try to find a matching <code>python3.x</code> when no python version is activated by iterating over matching supported <code>python3.x</code> until it finds one in <code>PATH</code>.</p>
<p>The <code>venv</code> subcommand should also get a <code>--resolution lowest</code> option to force the lowest compatible python version instead. This is useful to ensure compatibility in CI.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @konstin on 2024-01-08 13:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wish</span> added by @charliermarsh on 2024-01-08 14:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astrofrog">@astrofrog</a> on 2024-03-21 12:34</div>
            <div class="timeline-body"><p>I just ran into this - to give a concrete example, if I have a <code>requirements.in</code> file containing:</p>
<pre><code>numpy
</code></pre>
<p>and run:</p>
<pre><code>uv pip compile requirements.in --resolution=lowest
</code></pre>
<p>it will try and build an ancient version of Numpy that isn't Python 3-compatible:</p>
<pre><code>error: Failed to download and build: numpy==1.3.0
  Caused by: Failed to build: numpy==1.3.0
  Caused by: Build backend failed to determine extra requires with `build_wheel()`:
--- stdout:

--- stderr:
Traceback (most recent call last):
  File &quot;&lt;string&gt;&quot;, line 14, in &lt;module&gt;
  File &quot;/Users/tom/Library/Caches/uv/.tmpm0vE0w/.venv/lib/python3.11/site-packages/setuptools/build_meta.py&quot;, line 325, in get_requires_for_build_wheel
    return self._get_build_requires(config_settings, requirements=['wheel'])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/Users/tom/Library/Caches/uv/.tmpm0vE0w/.venv/lib/python3.11/site-packages/setuptools/build_meta.py&quot;, line 295, in _get_build_requires
    self.run_setup()
  File &quot;/Users/tom/Library/Caches/uv/.tmpm0vE0w/.venv/lib/python3.11/site-packages/setuptools/build_meta.py&quot;, line 487, in run_setup
    super().run_setup(setup_script=setup_script)
  File &quot;/Users/tom/Library/Caches/uv/.tmpm0vE0w/.venv/lib/python3.11/site-packages/setuptools/build_meta.py&quot;, line 311, in run_setup
    exec(code, locals())
  File &quot;&lt;string&gt;&quot;, line 62
    print &quot; --- Could not run svn info --- &quot;
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
SyntaxError: Missing parentheses in call to 'print'. Did you mean print(...)?
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/matterhorn103">@matterhorn103</a> on 2024-06-11 23:07</div>
            <div class="timeline-body"><p>This would also be very useful to me â€“ was trying to get someone unfamiliar with Python up and running using uv (because it makes everything so easy!) and couldn't just tell them to do <code>uv venv</code> because I couldn't rely on <code>python3</code> returning the most recent Python interpreter on the system on Linux.</p>
<p>The toolchains on the horizon will no doubt make this sort of thing a lot easier but even so, it would be nice if the user is prevented from creating a venv with a Python version that doesn't meet the minimum requirements of the project.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/matterhorn103">@matterhorn103</a> on 2024-06-12 14:35</div>
            <div class="timeline-body"><p>It seems that <code>uv tool run</code> also doesn't respect <code>requires-python</code> and just uses whatever interpreter it can find.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-12 14:37</div>
            <div class="timeline-body"><p>If you have a Python requirement, I think you should be providing that with <code>-p</code>? I don't know that it's right for <code>tool run</code> to respect <code>requires-python</code>. <code>tool run</code> is a global install, but <code>requires-python</code> is a project-centric concept.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-12 14:53</div>
            <div class="timeline-body"><p>Well, <code>tool run</code> will read project metadata for project-level tools. It might make sense for it to respect project metadata (like <code>requires-python</code>) by default? I'll definitely need to think about that some.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/matterhorn103">@matterhorn103</a> on 2024-06-12 16:25</div>
            <div class="timeline-body"><blockquote>
<p>If you have a Python requirement, I think you should be providing that with <code>-p</code>? I don't know that it's right for <code>tool run</code> to respect <code>requires-python</code>. <code>tool run</code> is a global install, but <code>requires-python</code> is a project-centric concept.</p>
</blockquote>
<p>I guess it makes sense to make that distinction.</p>
<p>At the same time, I can't think when you would actively <em>want</em> to use a different Python version for a tool as for your project? (Barring the tool not being available for that version, in which case you're surely unlikely to be using it.) Meanwhile I can think of a couple of situations where it might cause an issue by not being synced:</p>
<ol>
<li>My problematic use case was running <code>uv tool run pyinstaller foo.py</code>, because pyinstaller builds the project using the interpreter its run with and doesn't lok at <code>pyproject.toml</code> at all (which you could argue is a flaw with pyinstaller)</li>
<li>If the installed version of a linter/parser like black or ruff is one released when the Python version used for the project was not yet released, the linter/parser will presumably not be equipped to handle the newer syntax of the project</li>
</ol>
<blockquote>
<p><code>tool run</code> is a global install</p>
</blockquote>
<p>But is it really global? If I create a venv using <code>uv venv -p 3.12</code> then <code>tool run</code> uses the 3.12 interpreter, not my default system Python (3.11). Even if I don't activate the venv. So it already adapts to the current directory's contents to some extent. As well as, as @zanieb says, adapting to <code>[tool]</code> tables in <code>pyproject.toml</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-12 18:14</div>
            <div class="timeline-body"><blockquote>
<p>If I create a venv using uv venv -p 3.12 then tool run uses the 3.12 interpreter, not my default system Python (3.11). Even if I don't activate the venv.</p>
</blockquote>
<p>This is probably not intentional. We're just following our standard interpreter discovery order. Arguably that's weird behavior but anyway yeah it seems nice to find an interpreter relevant to where you're working.</p>
<p><code>uv tool install</code> is intended to be more global and should definitely <em>not</em> respect anything in the working directory or active virtual environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-07-09 12:47</div>
            <div class="timeline-body"><p><code>uv sync</code> (currently in preview) creates a venv respects the <code>requires-python</code> in <code>pyproject.toml</code>, i don't think it makes sense changing this in <code>uv venv</code> still.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2024-07-09 12:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:30:26 UTC
    </footer>
</body>
</html>
