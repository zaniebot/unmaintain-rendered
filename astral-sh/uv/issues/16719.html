<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv add` also performs unprompted (and unrelated) toml formatting - astral-sh/uv #16719</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>uv add</code> also performs unprompted (and unrelated) toml formatting</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/16719">#16719</a>
        opened by <a href="https://github.com/neutrinoceros">@neutrinoceros</a>
        on 2025-11-13 11:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/neutrinoceros">@neutrinoceros</a></div>
            <div class="timeline-body">Summary
<p>This is one ((or possibly two) minor) bug(s) I frequently encounter when working on <code>astropy</code>, reproduced here with a minimal example.
Both of these are small sources of friction in my workflow, but I hit them frequently enough that I decided to report them any way.</p>
<p>Starting from the following <code>pyproject.toml</code> contents:</p>
<pre><code>[project]
name = &quot;test-uv&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.10&quot;
dependencies = [
    &quot;attrs&gt;=25.4.0&quot;,     # perhaps weirdly comment formatted comment
]

[build-system]
requires = [&quot;uv_build&gt;=0.9.9,&lt;0.10.0&quot;]
build-backend = &quot;uv_build&quot;

[tool.ruff]
lint.extend-select = []
exclude = []
lint.ignore = []
</code></pre>
<p>And using, for instance</p>
<pre><code>uv add pytest
</code></pre>
<p>produces the following patch</p>
<pre><code>diff --git a/pyproject.toml b/pyproject.toml
index a2b9bad..82d55d1 100644
--- a/pyproject.toml
+++ b/pyproject.toml
@@ -3,7 +3,8 @@ name = &quot;test-uv&quot;
 version = &quot;0.1.0&quot;
 requires-python = &quot;&gt;=3.10&quot;
 dependencies = [
-    &quot;attrs&gt;=25.4.0&quot;,     # perhaps weirdly comment formatted comment
+    &quot;attrs&gt;=25.4.0&quot;, # perhaps weirdly comment formatted comment
+    &quot;pytest&gt;=9.0.1&quot;,
 ]
 
 [build-system]
@@ -12,5 +13,5 @@ build-backend = &quot;uv_build&quot;
 
 [tool.ruff]
 lint.extend-select = []
-exclude = []
 lint.ignore = []
+exclude = []
</code></pre>
<p>The problems should be evident, but let&#x27;s list them anyway:</p>
<ul>
<li>a comment from an unrelated (albeit adjadent) line is moved</li>
<li>a completely unrelated table (here, <code>tool.ruff</code>) is re-formatted</li>
</ul>
<p>At least no actual data is lost, but having larger than strictly needed footprints means that I can&#x27;t just commit the result of a <code>uv add</code> invoke, and must resort to manual editing to only commit the bits I want.</p>
Platform
<p>Darwin 24.6.0 arm64</p>
Version
<p>uv 0.9.9 (4fac4cb7e 2025-11-12)</p>
Python version
<p>Python 3.14.0 (shouldn&#x27;t be relevant though)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/neutrinoceros">@neutrinoceros</a> on 2025-11-13 11:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-11-13 12:00</div>
            <div class="timeline-body"><p>The first change is a bug in how we handle comments, we should fix that in uv.</p>
<p>The second change is this upstream bug: <a href="https://github.com/toml-rs/toml/issues/163">toml-rs/toml#163</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/konstin">@konstin</a> on 2025-11-20 19:15</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:41:00 UTC
    </footer>
</body>
</html>
