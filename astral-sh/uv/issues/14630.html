<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>support to ensure lockfile dev release matches pyproject.toml's - astral-sh/uv #14630</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>support to ensure lockfile dev release matches pyproject.toml's</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/14630">#14630</a>
        opened by <a href="https://github.com/thehesiod">@thehesiod</a>
        on 2025-07-15 17:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/thehesiod">@thehesiod</a> on 2025-07-15 17:25</div>
            <div class="timeline-body"><p><strong>Summary</strong></p>
<p>When developing with <code>uv</code>, we often begin by depending on a <strong>dev release</strong> of a library (e.g. <code>~=1.0.0.dev0</code>). Once the changes are approved and that dev version is promoted to a stable release (e.g. <code>1.0.0</code>), we update the constraint in <code>pyproject.toml</code> to <code>~=1.0</code> and run <code>uv lock</code>.</p>
<p>However, the lockfile continues to contain the previously locked dev version <strong>unless we explicitly pass <code>-P</code></strong>, even though it no longer matches the new constraint.</p>
<h4>Expected Behavior</h4>
<p><code>uv lock</code> should detect that the current dev version no longer satisfies the new constraint and automatically resolve to the latest matching stable version (<code>1.0.0</code>), without requiring <code>-P foo</code>.</p>
<hr />
<h4>Possible Improvements</h4>
<ul>
<li>Automatically <strong>replace prerelease/dev versions</strong> in the lockfile when they no longer satisfy the updated constraint.</li>
<li>Emit a <strong>warning</strong> when a prerelease version is locked but no prerelease is permitted by <code>pyproject.toml</code>.</li>
<li>Support a <strong>pre-release hook</strong> that checks for this situation and can enforce clean production locks.</li>
</ul>
<hr />
<h4>Why It Matters</h4>
<p>This workflow ‚Äî developing against a dev version, then locking to a stable release ‚Äî is common in CI/CD pipelines and collaborative team workflows.</p>
<p>Without automatic resolution or feedback, it's easy to accidentally retain prerelease dependencies in the lockfile even after bumping the constraint to a stable track.</p>
<hr />
<h3>Example</h3>
<h4>Example</h4>
<ol>
<li>Initial state:</li>
</ol>
<pre><code class="language-toml"># pyproject.toml
dependencies = [&quot;foo ~=1.0.0.dev0&quot;]
</code></pre>
<pre><code class="language-bash">uv lock
</code></pre>
<p>Lockfile result:</p>
<pre><code>foo==1.0.0.dev0
</code></pre>
<ol start="2">
<li>Later, we update to:</li>
</ol>
<pre><code class="language-toml"># pyproject.toml
dependencies = [&quot;foo ~=1.0&quot;]
</code></pre>
<p>But after running:</p>
<pre><code class="language-bash">uv lock
</code></pre>
<p>The lockfile still incorrectly contains:</p>
<pre><code>foo==1.0.0.dev0
</code></pre>
<p>even though the latest valid version is <code>1.0.0</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @thehesiod on 2025-07-15 17:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-15 19:10</div>
            <div class="timeline-body"><p>I can't reproduce this in my initial testing. Can you provide a complete minimal reproduction that we can use to help you?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @charliermarsh on 2025-07-15 19:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thehesiod">@thehesiod</a> on 2025-07-15 22:30</div>
            <div class="timeline-body"><p><a href="https://github.com/user-attachments/files/21244223/uv-bug.zip">uv-bug.zip</a></p>
<p>here you go, included is script to run local pypiserver with u/p: admin:admin.</p>
<p>Steps:</p>
<ol>
<li>build + publish <code>module</code> (0.0.1.dev0) (uv publish -v --index local)</li>
<li>go to module-user and lock (locks to 0.0.1.dev0)</li>
<li>go to module and bump to 0.0.1, build + publish</li>
<li>go back to module-user, change required version to ~=0.1, re-lock</li>
</ol>
<p>Result:
module-user uv.lock stays on 0.0.1.dev0 even though 0.0.1 is available and pyproject.toml doesn't list dev version</p>
<p>Expected:
should warn/re-lock to latest production release</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2025-07-15 23:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-16 00:07</div>
            <div class="timeline-body"><p>Thanks, I'll give it a try!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-16 00:48</div>
            <div class="timeline-body"><p>Hmm, I ran this, but I see the expected upgrade:</p>
<pre><code>DEBUG uv 0.7.21+2 (9871bbdc7 2025-07-14)
DEBUG Project is contained in non-workspace project: `/Users/crmarsh/workspace/uv`
DEBUG Found workspace root: `/Users/crmarsh/workspace/uv/uv-bug/module-user`
DEBUG Adding root workspace member: `/Users/crmarsh/workspace/uv/uv-bug/module-user`
DEBUG No Python version file found in workspace: /Users/crmarsh/workspace/uv/uv-bug/module-user
DEBUG Using Python request `&gt;=3.8` from `requires-python` metadata
DEBUG Checking for Python environment at `.venv`
DEBUG Searching for Python &gt;=3.8 in managed installations or search path
DEBUG Searching for managed installations at `/Users/crmarsh/.local/share/uv/python`
DEBUG Found managed installation `cpython-3.14.0b3-macos-aarch64-none`
DEBUG Found `cpython-3.14.0b3-macos-aarch64-none` at `/Users/crmarsh/.local/share/uv/python/cpython-3.14.0b3-macos-aarch64-none/bin/python3.14` (managed installations)
DEBUG Skipping pre-release cpython-3.14.0b3-macos-aarch64-none
DEBUG Found managed installation `cpython-3.13.2-macos-aarch64-none`
DEBUG Found `cpython-3.13.2-macos-aarch64-none` at `/Users/crmarsh/.local/share/uv/python/cpython-3.13.2-macos-aarch64-none/bin/python3.13` (managed installations)
Using CPython 3.13.2
DEBUG Using request timeout of 30s
DEBUG Found static `pyproject.toml` for: hello-world-user @ file:///Users/crmarsh/workspace/uv/uv-bug/module-user
DEBUG Project is contained in non-workspace project: `/Users/crmarsh/workspace/uv`
DEBUG No workspace root found, using project root
DEBUG Ignoring existing lockfile due to mismatched requirements for: `hello-world-user==0.0.1`
  Requested: {Requirement { name: PackageName(&quot;hello-world&quot;), extras: [], groups: [], marker: true, source: Registry { specifier: VersionSpecifiers([VersionSpecifier { operator: TildeEqual, version: &quot;0.0.1&quot; }]), index: None, conflict: None }, origin: None }}
  Existing: {Requirement { name: PackageName(&quot;hello-world&quot;), extras: [], groups: [], marker: true, source: Registry { specifier: VersionSpecifiers([VersionSpecifier { operator: TildeEqual, version: &quot;0.0.1.dev0&quot; }]), index: None, conflict: None }, origin: None }}
DEBUG Solving with installed Python version: 3.13.2
DEBUG Solving with target Python version: &gt;=3.8
DEBUG Adding direct dependency: hello-world-user*
DEBUG Searching for a compatible version of hello-world-user @ file:///Users/crmarsh/workspace/uv/uv-bug/module-user (*)
DEBUG Adding direct dependency: hello-world&gt;=0.0.1, &lt;0.1.dev0
DEBUG Found stale response for: http://localhost:8080/simple/hello-world/
DEBUG Sending revalidation request for: http://localhost:8080/simple/hello-world/
DEBUG Found modified response for: http://localhost:8080/simple/hello-world/
DEBUG Searching for a compatible version of hello-world (&gt;=0.0.1, &lt;0.1.dev0)
DEBUG Selecting: hello-world==0.0.1 [compatible] (hello_world-0.0.1-py3-none-any.whl)
DEBUG No cache entry for: http://localhost:8080/api/package/hello-world/hello_world-0.0.1-py3-none-any.whl
WARN Range requests not supported for hello_world-0.0.1-py3-none-any.whl; streaming wheel
DEBUG No cache entry for: http://localhost:8080/api/package/hello-world/hello_world-0.0.1-py3-none-any.whl
DEBUG Tried 2 versions: hello-world 1, hello-world-user 1
DEBUG all marker environments resolution took 0.024s
Resolved 2 packages in 32ms
Updated hello-world v0.0.1.dev0 -&gt; v0.0.1
</code></pre>
<p>The only thing to note is I ran <code>cargo lock -v</code> (so I ran from <code>main</code>). Are you on a recent uv version?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-16 00:49</div>
            <div class="timeline-body"><p>The only thing I can think of is that we could be caching the result from your index server (if it sends <code>Cache-Control</code> headers). Do you see the same thing if you pass <code>--no-cache</code> or <code>--refresh</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thehesiod">@thehesiod</a> on 2025-07-16 03:37</div>
            <div class="timeline-body"><p>let me get the verbose output for you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thehesiod">@thehesiod</a> on 2025-07-16 03:45</div>
            <div class="timeline-body"><p>so first run pypicloud:</p>
<pre><code class="language-bash">~/uv-bug $ ./run-pypi-cloud.sh 
</code></pre>
<p>and verifying no uv env vars set:</p>
<pre><code class="language-bash">~/uv-bug/module $ ( set -o posix ; set ) | grep '^UV_'
~/uv-bug/module $ 
</code></pre>
<p>now publish dev version of module:</p>
<pre><code class="language-bash">~/uv-bug/module $ uv publish --index local
Publishing 2 files http://localhost:8080/
Enter username ('__token__' if using a token): admin
Enter password: 
Uploading hello_world-0.0.1.dev0-py3-none-any.whl (1.1KiB)
Uploading hello_world-0.0.1.dev0.tar.gz (912.0B)
</code></pre>
<p>now lock module-user to dev version:</p>
<pre><code class="language-bash">~/uv-bug/module-user $ uv lock 
Using CPython 3.11.11
Resolved 2 packages in 39ms
~/uv-bug/module-user $ cat uv.lock 
version = 1
revision = 2
requires-python = &quot;&gt;=3.8&quot;

[[package]]
name = &quot;hello-world&quot;
version = &quot;0.0.1.dev0&quot;
source = { registry = &quot;http://localhost:8080/simple&quot; }
sdist = { url = &quot;http://localhost:8080/api/package/hello-world/hello_world-0.0.1.dev0.tar.gz&quot;, hash = &quot;sha256:e0461d2be2773b59711e02ecc40387d943d7fdd5558f9bc02a0ea5d238deb44a&quot; }
wheels = [
    { url = &quot;http://localhost:8080/api/package/hello-world/hello_world-0.0.1.dev0-py3-none-any.whl&quot;, hash = &quot;sha256:ec5ed452cf94ad94528be03a01b7295d5efe6742d5ea605eb86a96d85234e606&quot; },
]

[[package]]
name = &quot;hello-world-user&quot;
version = &quot;0.0.1&quot;
source = { editable = &quot;.&quot; }
dependencies = [
    { name = &quot;hello-world&quot; },
]

[package.metadata]
requires-dist = [{ name = &quot;hello-world&quot;, specifier = &quot;~=0.0.1.dev0&quot; }]
</code></pre>
<p>now bump and publish non-dev version of module:</p>
<pre><code class="language-bash">$ uv publish --index local
Publishing 2 files http://localhost:8080/
Enter username ('__token__' if using a token): admin
Enter password: 
Uploading hello_world-0.0.1-py3-none-any.whl (1.0KiB)
Uploading hello_world-0.0.1.tar.gz (904.0B)
</code></pre>
<p>now re-lock to non-dev version</p>
<pre><code class="language-bash">~/uv-bug/module-user $ cat pyproject.toml 
[project]
name = &quot;hello-world-user&quot;
version = &quot;0.0.1&quot;
description = &quot;module that uses hello-world&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.8&quot;
dependencies = [
    &quot;hello-world~=0.0.1.dev0&quot;
]

[build-system]
requires = [&quot;setuptools&quot;]
build-backend = &quot;setuptools.build_meta&quot;

[[tool.uv.index]]
name = &quot;local&quot;
url = &quot;http://localhost:8080/simple&quot;
default = true

~/uv-bug/module-user $ uv lock -v
DEBUG uv 0.7.15 (Homebrew 2025-06-25)
DEBUG Found workspace root: `/Users/alexmohr/uv-bug/module-user`
DEBUG Adding root workspace member: `/Users/alexmohr/uv-bug/module-user`
DEBUG No Python version file found in workspace: /Users/alexmohr/uv-bug/module-user
DEBUG Using Python request `&gt;=3.8` from `requires-python` metadata
DEBUG Checking for Python environment at `.venv`
DEBUG Searching for Python &gt;=3.8 in managed installations or search path
DEBUG Searching for managed installations at `/Users/alexmohr/.local/share/uv/python`
DEBUG Found managed installation `cpython-3.11.11-macos-aarch64-none`
DEBUG Found `cpython-3.11.11-macos-aarch64-none` at `/Users/alexmohr/.local/share/uv/python/cpython-3.11.11-macos-aarch64-none/bin/python3.11` (managed installations)
Using CPython 3.11.11
DEBUG Using request timeout of 30s
DEBUG Found static `pyproject.toml` for: hello-world-user @ file:///Users/alexmohr/uv-bug/module-user
DEBUG No workspace root found, using project root
DEBUG Existing `uv.lock` satisfies workspace requirements
Resolved 2 packages in 4ms
</code></pre>
<p>definitely an issue, and I don't think related to my environment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thehesiod">@thehesiod</a> on 2025-07-16 03:47</div>
            <div class="timeline-body"><p>appreciate for looking into this so quickly btw!  This is a very common workflow for us so I'd like a way to protect our main branch from accidental dev version check-ins.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thehesiod">@thehesiod</a> on 2025-07-16 03:47</div>
            <div class="timeline-body"><p>and btw verified uv.lock remains unchanged with .dev version in there</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-16 13:03</div>
            <div class="timeline-body"><p>In the example above, you didn't modify the bounds in <code>pyproject.toml</code>. After &quot;now re-lock to non-dev version&quot;, you still have <code>&quot;hello-world~=0.0.1.dev0&quot;</code>. By default, we avoid modifying locked versions -- i.e., we prefer versions that are already present in the lockfile. You would need to specify <code>--upgrade-package hello-world</code> to force the version to change, <em>or</em> update the bound to <code>&quot;hello-world~=0.0.1&quot;</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thehesiod">@thehesiod</a> on 2025-07-16 15:54</div>
            <div class="timeline-body"><p>I did, note in the pyproject.toml I cat'd above, the version is now set to <code>0.0.1</code>:</p>
<pre><code>[project]
name = &quot;hello-world-user&quot;
version = &quot;0.0.1&quot;
</code></pre>
<p>this is now bound to a non-dev version, the version in uv.lock no longer matches the requirements in the pyproject.toml.  A dev version never matches a top level non-dev version requirement.</p>
<p>IOW given the pyproject.toml with the non-dev version, there is no situation where locking it without the uv.lock present would ever pick a dev version.  This is a pure breach in requirements.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-16 16:00</div>
            <div class="timeline-body"><p>I'm really confused. I must be misunderstanding. I'm referring to this:</p>
<p><img width="700" height="786" alt="Image" src="https://github.com/user-attachments/assets/8f73db18-5f45-4c3f-8f35-5a9e9b1e127f" /></p>
<p>You still have <code>&quot;hello-world~=0.0.1.dev0&quot;</code> in the requirements, so choosing <code>0.0.1.dev0</code> is still a valid choice. (It's not the version you would get if you removed <code>uv.lock</code>, but it <em>is</em> a valid version given the specifier, and we prefer retaining the existing versions.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thehesiod">@thehesiod</a> on 2025-07-16 16:04</div>
            <div class="timeline-body"><p>oh, sorry ü§¶üèº let me re-do the scenario lol. I know it will occur just updated the wrong version</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thehesiod">@thehesiod</a> on 2025-07-16 16:13</div>
            <div class="timeline-body"><p>wow it worked, ok, so it must be more complicated than I thought or perhaps based on secondary requirements?  I'll dig some more</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thehesiod">@thehesiod</a> on 2025-07-16 16:14</div>
            <div class="timeline-body"><p>I'll close this for now since I can't reproduce what I was previously seeing in our project.  Thanks for taking the time to look into this!  sorry for wasting your time :(</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @thehesiod on 2025-07-16 16:14</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:04 UTC
    </footer>
</body>
</html>
