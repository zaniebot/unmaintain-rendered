```yaml
number: 6859
title: "Buggy interplay between `--python`, `--python-version` and dependency with Python upper bound in `pip compile`"
type: issue
state: closed
author: BarrensZeppelin
labels:
  - bug
assignees: []
created_at: 2024-08-30T10:59:36Z
updated_at: 2024-09-02T18:23:44Z
url: https://github.com/astral-sh/uv/issues/6859
synced_at: 2026-01-10T04:45:10Z
```

# Buggy interplay between `--python`, `--python-version` and dependency with Python upper bound in `pip compile`

---

_Issue opened by @BarrensZeppelin on 2024-08-30 10:59_

I use uv@0.4.0 to `pip compile` the dependency specifier `scipy==1.9.0`.
`scipy==1.9.0` has a Python version requirement of `>=3.8,<3.12`.

The command I'm running is
`echo "scipy==1.9.0" | uv pip compile --python X.Y --python-version X.Y [--universal] -`

When the command fails, the error message is always:
```
  Ã— No solution found when resolving dependencies:
  â•°â”€â–¶ Because the current Python version (3.12.5) does not satisfy Python>=3.8,<3.12 and scipy==1.9.0 depends on Python>=3.8,<3.12, we can
      conclude that scipy==1.9.0 cannot be used.
      And because you require scipy==1.9.0, we can conclude that your requirements are unsatisfiable.
```

I've compiled a table of results with different combinations of `--python` and `--python-version` arguments + `--universal` mode.

| --python | --python-version | --universal | Success | Expected |
|----------|------------------|-------------|---------|----------|
| 3.12     | 3.12             | X           | X       | âœ“        |
| 3.12     | 3.11             | X           | X       | X        |
| 3.12     | 3.10             | X           | âœ“       | âœ“        |
| 3.11     | 3.12             | X           | X       | âœ“        |
| 3.11     | 3.11             | X           | âœ“       | âœ“        |
| 3.12     | 3.12             | âœ“           | X       | âœ“        |
| 3.12     | 3.11             | âœ“           | X       | X        |
| 3.12     | 3.10             | âœ“           | âœ“       | âœ“        |
| 3.11     | 3.12             | âœ“           | âœ“       | ?        |
| 3.11     | 3.11             | âœ“           | âœ“       | âœ“        | 

There are two failures that definitely look unexpected to me.
I'm not certain whether `--python 3.11 --python-version 3.12 --universal` is expected to succeed.
Also, I had the impression that python version upper bounds were ignored (in `--universal` mode?), so maybe some of the cases I marked as expected failures are actually unexpected.

---

_Comment by @charliermarsh on 2024-08-30 13:00_

I believe that Python version upper-bounds being ignored is true in `uv lock` but not yet in `uv pip compile`, for somewhat historical reasons.

---

_Comment by @BarrensZeppelin on 2024-08-30 13:07_

Alright. It would be useful (for me) to have that behaviour in `uv pip compile` (possibly behind a flag?).

---

_Comment by @charliermarsh on 2024-08-30 13:10_

I think we just need to change it. There's an open issue somewhere... I may be able to do it today.

---

_Comment by @charliermarsh on 2024-08-30 13:23_

https://github.com/astral-sh/uv/issues/5045

---

_Comment by @BarrensZeppelin on 2024-08-30 13:25_

Right. I actually found that issue earlier, but found (and was confused by the fact) that the universal resolver also fails to resolve the dependency tree.

---

_Comment by @charliermarsh on 2024-08-30 14:37_

I think this actually might be a separate problem, which is that we're refusing _source_ distributions based on the upper-bound because we assume we can't build them. I don't think we should be doing that.

---

_Assigned to @charliermarsh by @charliermarsh on 2024-08-30 14:37_

---

_Label `bug` added by @charliermarsh on 2024-08-30 14:37_

---

_Comment by @charliermarsh on 2024-08-30 18:36_

Ok, I've confirmed this works in https://github.com/astral-sh/uv/pull/6882:

```
# This file was autogenerated by uv via the following command:
#    uv pip compile --python 3.12 --python-version 3.12 --universal -
numpy==1.24.4
    # via scipy
scipy==1.9.0
```

I don't think it will ship today, but in the next few days.

---

_Comment by @BarrensZeppelin on 2024-08-30 19:10_

Very nice! ðŸ¥³

---

_Closed by @charliermarsh on 2024-09-02 18:23_

---

_Closed by @charliermarsh on 2024-09-02 18:23_

---
