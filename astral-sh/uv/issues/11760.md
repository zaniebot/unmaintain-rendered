```yaml
number: 11760
title: Dependency resolution failure on transitive Git build-system requirement
type: issue
state: open
author: astoeckel-abr
labels:
  - question
  - great writeup
assignees: []
created_at: 2025-02-24T22:57:42Z
updated_at: 2025-04-11T10:14:56Z
url: https://github.com/astral-sh/uv/issues/11760
synced_at: 2026-01-10T01:57:27Z
```

# Dependency resolution failure on transitive Git build-system requirement

---

_Issue opened by @astoeckel-abr on 2025-02-24 22:57_

### Summary

Consider a collection of three projects:

* `my-build-plugin`
* `my-foo-lib`
* `my-foo-app`

`my-build-plugin` is a plugin for setuptools. It is included in `pyproject.toml` of `my-foo-lib` through `build-system.requires`:

```toml
[build-system]
requires = ["setuptools", "my-build-plugin"]
build-backend = "setuptools.build_meta"

[project]
name = "my-foo-lib"
version = "1.0.0"
requires-python = ">=3.10"

[tool.uv.sources]
my-build-plugin = { git = "<GIT URL>", subdirectory = "my_build_plugin", rev = "<GIT REV>" }
```

Building the library via
```sh
uv build .
```
works fine; `my-build-plugin` is automatically checked out as part of the build.

Now, in `my-foo-app`, transitively include `my-build-plugin` by depending on `my-foo-lib`. `pyproject.toml`:
```toml
[build-system]
requires = ["setuptools"]
build-backend = "setuptools.build_meta"

[project]
name = "my-foo-app"
version = "1.0.0"
requires-python = ">=3.10"
dependencies = ["my-foo-lib"]

[tool.uv.sources]
my-foo-lib = { git = "<GIT URL>", subdirectory="my_foo_lib", rev = "<GIT REV>"}
```

Executing `uv run` in this project results in the following error:
```
  × Failed to download and build `my-foo-lib @ git+file:///home/astoecke/tmp/uv_build_deps_bug@e64efd7717c64a29adab738cf30d069255e08d87#subdirectory=my_foo_library`
  ├─▶ Failed to resolve requirements from `build-system.requires`
  ├─▶ No solution found when resolving: `setuptools`, `my-build-plugin`
  ╰─▶ Because my-build-plugin was not found in the package registry and you require my-build-plugin, we can conclude that your requirements are unsatisfiable.
  help: `my-foo-lib` was included because `my-foo-app` (v1.0.0) depends on `my-foo-lib`
```

So, for some reason, `uv` does not seem to do a Git checkout for `my-build-plugin`, when including `my-foo-lib` as a dependency, even though it does so when building `my-foo-lib` directly.


-------------------------

Script to re-create the test setup (tested on Linux; `readlink -e` is a GNU extension):

```sh
#!/usr/bin/env bash

mkdir -p uv_build_dep_bug/my_build_plugin uv_build_dep_bug/my_foo_lib uv_build_dep_bug/my_foo_app
cd uv_build_dep_bug
git init .

cat >my_build_plugin/pyproject.toml <<EOL
[build-system]
requires = ["setuptools"]
build-backend = "setuptools.build_meta"

[project]
name = "my-build-plugin"
version = "1.0.0"
requires-python = ">=3.10"
dependencies = []
EOL

cat >my_foo_lib/pyproject.toml <<EOL
[build-system]
requires = ["setuptools", "my-build-plugin"]
build-backend = "setuptools.build_meta"

[project]
name = "my-foo-lib"
version = "1.0.0"
requires-python = ">=3.10"

[tool.uv.sources]
my-build-plugin = { git = "<GIT URL>", subdirectory = "my_build_plugin", rev = "<GIT REV>" }
EOL

cat >my_foo_app/pyproject.toml <<EOL
[build-system]
requires = ["setuptools"]
build-backend = "setuptools.build_meta"

[project]
name = "my-foo-app"
version = "1.0.0"
requires-python = ">=3.10"
dependencies = ["my-foo-lib"]

[tool.uv.sources]
my-foo-lib = { git = "<GIT URL>", subdirectory = "my_foo_lib", rev = "<GIT REV>" }
EOL


# Fill in the Git Repo URL and do an initial commit
sed -i -e "s|<GIT URL>|file://"$(readlink -e . )"|" my_foo_lib/pyproject.toml
sed -i -e "s|<GIT URL>|file://"$(readlink -e . )"|" my_foo_app/pyproject.toml
git add my_*/pyproject.toml
git commit -m "Initial commit"

# Fill in the Git revision for the build plugin dependency
sed -i -e "s|<GIT REV>|"$(git rev-parse HEAD )"|" my_foo_lib/pyproject.toml
git add my_foo_lib/pyproject.toml
git commit -m "Fill in build plugin revision"

# Now fill in the Git revision for the library dependency
sed -i -e "s|<GIT REV>|"$(git rev-parse HEAD )"|" my_foo_app/pyproject.toml
git add my_foo_app/pyproject.toml
git commit -m "Fill in library revision"


# echo "Building my_build_plugin..."
# cd my_build_plugin
# uv build .
# cd ..

# echo "Building my_foo_lib..."
# cd my_foo_lib
# uv build .
# cd ..

echo "Running my_foo_app..."
cd my_foo_app
uv run -v
cd ..
```


----------------------------------

Verbose output:

```
DEBUG uv 0.6.2+41 (2ea1df1a1 2025-02-24)
DEBUG Found project root: `/home/astoecke/tmp/uv_build_dep_bug/my_foo_app`
DEBUG No workspace root found, using project root
DEBUG Discovered project `my-foo-app` at: /home/astoecke/tmp/uv_build_dep_bug/my_foo_app
DEBUG Acquired lock for `/home/astoecke/tmp/uv_build_dep_bug/my_foo_app`
DEBUG Using Python request `>=3.10` from `requires-python` metadata
DEBUG Checking for Python environment at `.venv`
DEBUG Searching for Python >=3.10 in managed installations or search path
DEBUG Found `cpython-3.13.2-linux-x86_64-gnu` at `/usr/bin/python3` (first executable in the search path)
Using CPython 3.13.2 interpreter at: /usr/bin/python3
Creating virtual environment at: .venv
DEBUG Using base executable for virtual environment: /usr/bin/python3
DEBUG Released lock at `/tmp/uv-2b4561dc1510f3a3.lock`
DEBUG Using request timeout of 30s
DEBUG Found static `pyproject.toml` for: my-foo-app @ file:///home/astoecke/tmp/uv_build_dep_bug/my_foo_app
DEBUG No workspace root found, using project root
DEBUG Fetching source distribution from Git: file:///home/astoecke/tmp/uv_build_dep_bug
DEBUG Acquired lock for `file:///home/astoecke/tmp/uv_build_dep_bug`
DEBUG Updating Git source `file:///home/astoecke/tmp/uv_build_dep_bug`
   Updating file:///home/astoecke/tmp/uv_build_dep_bug (880944a06140429e23d55d7d5a23e18acd0eacbc)
DEBUG Performing a Git fetch for: file:///home/astoecke/tmp/uv_build_dep_bug
DEBUG Reset /home/astoecke/.cache/uv/git-v0/checkouts/4e23d374614cfb53/880944a to 880944a06140429e23d55d7d5a23e18acd0eacbc
    Updated file:///home/astoecke/tmp/uv_build_dep_bug (880944a06140429e23d55d7d5a23e18acd0eacbc)
DEBUG Released lock at `/home/astoecke/.cache/uv/git-v0/locks/4e23d374614cfb53`
DEBUG Acquired lock for `/home/astoecke/.cache/uv/sdists-v8/git/45c67979ae0c4d19/880944a06140429e`
DEBUG Found static `pyproject.toml` for: my-foo-lib @ git+file:///home/astoecke/tmp/uv_build_dep_bug@880944a06140429e23d55d7d5a23e18acd0eacbc#subdirectory=my_foo_lib
DEBUG No workspace root found, using project root
DEBUG Released lock at `/home/astoecke/.cache/uv/sdists-v8/git/45c67979ae0c4d19/880944a06140429e/.lock`
DEBUG Solving with installed Python version: 3.13.2
DEBUG Solving with target Python version: >=3.10
DEBUG Adding direct dependency: my-foo-app*
DEBUG Searching for a compatible version of my-foo-app @ file:///home/astoecke/tmp/uv_build_dep_bug/my_foo_app (*)
DEBUG Adding direct dependency: my-foo-lib*
DEBUG Searching for a compatible version of my-foo-lib @ git+file:///home/astoecke/tmp/uv_build_dep_bug@880944a06140429e23d55d7d5a23e18acd0eacbc#subdirectory=my_foo_lib (*)
DEBUG Tried 2 versions: my-foo-app 1, my-foo-lib 1
DEBUG all marker environments resolution took 0.001s
Resolved 2 packages in 41ms
DEBUG Using request timeout of 30s
DEBUG Identified uncached distribution: my-foo-app @ file:///home/astoecke/tmp/uv_build_dep_bug/my_foo_app
DEBUG Identified uncached distribution: my-foo-lib @ git+file:///home/astoecke/tmp/uv_build_dep_bug@880944a06140429e23d55d7d5a23e18acd0eacbc#subdirectory=my_foo_lib
DEBUG Acquired lock for `/home/astoecke/.cache/uv/sdists-v8/editable/dbd5b56341e062d6`
DEBUG Fetching source distribution from Git: file:///home/astoecke/tmp/uv_build_dep_bug
DEBUG Acquired lock for `file:///home/astoecke/tmp/uv_build_dep_bug`
   Building my-foo-app @ file:///home/astoecke/tmp/uv_build_dep_bug/my_foo_app
DEBUG Building: my-foo-app @ file:///home/astoecke/tmp/uv_build_dep_bug/my_foo_app
DEBUG No workspace root found, using project root
DEBUG Using base executable for virtual environment: /usr/bin/python3
DEBUG Ignoring empty directory
DEBUG Using existing Git source `file:///home/astoecke/tmp/uv_build_dep_bug`
DEBUG Resolving build requirements
DEBUG Solving with installed Python version: 3.13.2
DEBUG Solving with target Python version: >=3.13.2
DEBUG Adding direct dependency: setuptools*
DEBUG Found stale response for: https://pypi.org/simple/setuptools/
DEBUG Sending revalidation request for: https://pypi.org/simple/setuptools/
DEBUG Released lock at `/home/astoecke/.cache/uv/git-v0/locks/4e23d374614cfb53`
DEBUG Acquired lock for `/home/astoecke/.cache/uv/sdists-v8/git/45c67979ae0c4d19/880944a06140429e`
   Building my-foo-lib @ git+file:///home/astoecke/tmp/uv_build_dep_bug@880944a06140429e23d55d7d5a23e18acd0eacbc#subdirectory=my_foo_lib
DEBUG Building: my-foo-lib @ git+file:///home/astoecke/tmp/uv_build_dep_bug@880944a06140429e23d55d7d5a23e18acd0eacbc#subdirectory=my_foo_lib
DEBUG Using base executable for virtual environment: /usr/bin/python3
DEBUG Ignoring empty directory
DEBUG Resolving build requirements
DEBUG Solving with installed Python version: 3.13.2
DEBUG Solving with target Python version: >=3.13.2
DEBUG Adding direct dependency: setuptools*
DEBUG Adding direct dependency: my-build-plugin*
DEBUG No cache entry for: https://pypi.org/simple/my-build-plugin/
DEBUG Found not-modified response for: https://pypi.org/simple/setuptools/
DEBUG Searching for a compatible version of setuptools (*)
DEBUG Searching for a compatible version of setuptools (*)
DEBUG Selecting: setuptools==75.8.0 [compatible] (setuptools-75.8.0-py3-none-any.whl)
DEBUG Selecting: setuptools==75.8.0 [compatible] (setuptools-75.8.0-py3-none-any.whl)
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/69/8a/b9dc7678803429e4a3bc9ba462fa3dd9066824d3c607490235c6a796be5a/setuptools-75.8.0-py3-none-any.whl.metadata
DEBUG Tried 1 versions: setuptools 1
DEBUG marker environment resolution took 0.065s
DEBUG Installing in setuptools==75.8.0 in /home/astoecke/.cache/uv/builds-v0/.tmpIADi60
DEBUG Registry requirement already cached: setuptools==75.8.0
DEBUG Installing build requirement: setuptools==75.8.0
DEBUG Creating PEP 517 build environment
DEBUG Calling `setuptools.build_meta.get_requires_for_build_editable()`
DEBUG No netrc file found
DEBUG Searching for a compatible version of my-build-plugin (*)
DEBUG No compatible version found for: my-build-plugin
DEBUG Released lock at `/home/astoecke/.cache/uv/sdists-v8/git/45c67979ae0c4d19/880944a06140429e/.lock`
DEBUG Released lock at `/home/astoecke/.cache/uv/sdists-v8/editable/dbd5b56341e062d6/.lock`
  × Failed to download and build `my-foo-lib @ git+file:///home/astoecke/tmp/uv_build_dep_bug@880944a06140429e23d55d7d5a23e18acd0eacbc#subdirectory=my_foo_lib`
  ├─▶ Failed to resolve requirements from `build-system.requires`
  ├─▶ No solution found when resolving: `setuptools`, `my-build-plugin`
  ╰─▶ Because my-build-plugin was not found in the package registry and you require my-build-plugin, we can conclude that your requirements are unsatisfiable.
  help: `my-foo-lib` was included because `my-foo-app` (v1.0.0) depends on `my-foo-lib`
```


### Platform

Fedora 41

### Version

uv 0.6.2+41 (2ea1df1a1 2025-02-24)

### Python version

Python 3.13.2

---

_Label `bug` added by @astoeckel-abr on 2025-02-24 22:57_

---

_Comment by @Gankra on 2025-02-25 17:55_

Wow fantastic bugreport! I can immediately reproduce this and will look into it.

(Note for macos users running the repro script: replace `$(readlink -e . )` with `$(pwd)` -- macos' readlink doesn't have that flag)

---

_Assigned to @Gankra by @charliermarsh on 2025-02-25 20:14_

---

_Label `great writeup` added by @zanieb on 2025-04-10 16:17_

---

_Label `bug` removed by @Gankra on 2025-04-10 16:43_

---

_Label `wish` added by @Gankra on 2025-04-10 16:43_

---

_Label `wish` removed by @Gankra on 2025-04-10 16:43_

---

_Label `question` added by @Gankra on 2025-04-10 16:43_

---

_Comment by @Gankra on 2025-04-10 17:08_

While at first this seemed like a bug, upon reflection this is unfortunately intended/expected behaviour, and would require substantial deviations from the relevant python specs to support.

`[tool.uv.sources]` is a feature for development builds, just like dependency-groups. Dev builds are a concept that only exist at the top-level, and not for dependencies. So just as you can't depend on a library "with its dependency-group xyz enabled", you can't depend on a library "with its tool.uv.sources enabled".

---

_Referenced in [astral-sh/uv#12815](../../astral-sh/uv/pulls/12815.md) on 2025-04-10 17:23_

---

_Comment by @konstin on 2025-04-11 10:14_

As a workaround, you can use:

```toml
requires = ["setuptools", "my-build-plugin @ git+<GIT URL>@<GIT REV>#subdirectory=my_build_plugin"]
```

---
