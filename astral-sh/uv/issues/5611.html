<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document strategies for sharing the cache - astral-sh/uv #5611</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Document strategies for sharing the cache</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/5611">#5611</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-07-30 17:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-30 17:16</div>
            <div class="timeline-body"><p>Per https://github.com/astral-sh/uv/issues/5581#issuecomment-2258832686, sharing the cache across users can be useful for system-wide uv installations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> added by @zanieb on 2024-07-30 17:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cache</span> added by @zanieb on 2024-07-30 17:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/5581.html">astral-sh/uv#5581</a> on 2024-07-30 17:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stas00">@stas00</a> on 2024-07-31 03:53</div>
            <div class="timeline-body"><p>Here is the summary so far of what needs to be done to make <code>uv</code> work with a shared cache - this helps to save a ton of disk space and inodes when there are many users on a system and files can be shared.</p>
<ol>
<li>add to  <code>~/.bashrc</code> or <code>~/.profile</code> of each user:</li>
</ol>
<pre><code>umask 000 # file creation so that all users's files are a+rw or a+rwx
export UV_LINK_MODE=copy # hardlinking doesn't work with different owners
</code></pre>
<ol start="2">
<li>Then create a shared cache folder:</li>
</ol>
<pre><code>sudo mkdir -p /data/cache/uv
sudo chmod a+rwx /data/cache/uv
</code></pre>
<ol start="3">
<li>Then each user redirecting their local cache to the shared one:</li>
</ol>
<pre><code>rm -r ~/.cache/uv
ln -s /data/cache/uv ~/.cache/uv
</code></pre>
<p>and this requires <code>uv&gt;=0.2.32</code> to work</p>
<p>Done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-31 04:05</div>
            <div class="timeline-body"><p>Thanks! If you're setting environment variables anyway, you can use <code>UV_CACHE_DIR</code> and skip the symbolic link.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stas00">@stas00</a> on 2024-07-31 05:17</div>
            <div class="timeline-body"><p>oh, that's super-useful, then I don't have to go after users and making sure they installed a symlink.</p>
<p>Thank you very much, @zanieb!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2024-07-31 10:43</div>
            <div class="timeline-body"><p>Worth mentioning (or even discussing!) the security implications of this. (cache poisoning can be a huge problem)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MattiasDC">@MattiasDC</a> on 2024-08-09 12:40</div>
            <div class="timeline-body"><p>If you can't or don't want to use umask (as it will change behavior it for all files you create, not only uv cache). You can also use ACL rules on the cache directory, which overrides umask configuration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rabin-io">@rabin-io</a> on 2024-11-11 16:57</div>
            <div class="timeline-body"><p>What if you have many users WRITING to the cache? e.g. starting from a clean folder, and invoking many CI/test jobs at the same time which might want to download their files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chrispy-snps">@chrispy-snps</a> on 2025-01-12 23:39</div>
            <div class="timeline-body"><p>The <code>umask</code> is a significant problem with shared caches. In a corporate environment, most users have their <code>umask</code> set to grant write permissions only to SELF, but a shared cache requires that the cache files be writable by SELF+GROUP (assuming all cache users share a group).</p>
<p>Setting <code>umask</code> to alow SELF+GROUP write permissions account-wide is a non-starter.</p>
<p>My company develops UNIX/Linux software that implements a shared cache across many users. It has been used successfully for over 30 years. The key is that our software explicitly <code>chmod</code>s cache-specific permissions when it creates cache files and directories, thus overriding (and thus not being restricted by) the default permissions resulting from the account <code>umask</code>:</p>
<pre><code>shared_cache_dir_path = &quot;/path/to/cache&quot;
shared_cache_dir_chmod_octal = &quot;770&quot;
shared_cache_file_chmod_octal = &quot;660&quot;
</code></pre>
<p>I think that <code>uv</code> would need to use a solution like this. And it might be challenging if non-<code>uv</code> subprocesses also create files and directories, as all of those would need to be explictly <code>chmod</code>ed too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/grst">@grst</a> on 2025-01-13 06:51</div>
            <div class="timeline-body"><blockquote>
<pre><code>export UV_LINK_MODE=copy # hardlinking doesn't work with different owners
</code></pre>
</blockquote>
<p>Doesn't this defy the purpose of having a shared cache? Maybe the chache size will be reduced, but the individual users' <code>.venv</code> will consume much more space.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chrispy-snps">@chrispy-snps</a> on 2025-01-13 10:48</div>
            <div class="timeline-body"><p>@grst - that was exactly my thought too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/observerw">@observerw</a> on 2025-02-06 10:16</div>
            <div class="timeline-body"><blockquote>
<p>Here is the summary so far of what needs to be done to make <code>uv</code> work with a shared cache - this helps to save a ton of disk space and inodes when there are many users on a system and files can be shared.</p>
<ol>
<li>add to  <code>~/.bashrc</code> or <code>~/.profile</code> of each user:</li>
</ol>
<pre><code>umask 000 # file creation so that all users's files are a+rw or a+rwx
export UV_LINK_MODE=copy # hardlinking doesn't work with different owners
</code></pre>
<ol start="2">
<li>Then create a shared cache folder:</li>
</ol>
<pre><code>sudo mkdir -p /data/cache/uv
sudo chmod a+rwx /data/cache/uv
</code></pre>
<ol start="3">
<li>Then each user redirecting their local cache to the shared one:</li>
</ol>
<pre><code>rm -r ~/.cache/uv
ln -s /data/cache/uv ~/.cache/uv
</code></pre>
<p>and this requires <code>uv&gt;=0.2.32</code> to work</p>
<p>Done.</p>
</blockquote>
<p>Setting <code>umask</code> to 000 does not seem very secure. Inspired by <a href="https://zhuanlan.zhihu.com/p/570747928">this article</a>, a better approach is to manage shared cache permissions by creating a user group.</p>
<p>First, create a new user group named <code>share</code>:</p>
<pre><code class="language-bash">groupadd share
</code></pre>
<p>Then, create a shared cache directory on the storage device, transfer its group ownership to the <code>share</code> group, and allow group members to read and write:</p>
<pre><code class="language-bash">mkdir /data/.uv_cache # Or move an existing .uv_cache: mv &lt;SOURCE&gt;/.uv_cache /data/
chgrp -R share /data/.uv_cache
chmod -R g=rwX,o-rwx /data/.uv_cache # Allow group members to read/write but deny access to others
</code></pre>
<p>Set the SGID bit on all subdirectories to ensure that all newly created directories inherit the group ownership:</p>
<pre><code class="language-bash">find /data/.uv_cache -type d -exec chmod g+s {} +
</code></pre>
<p>Next, modify <code>/etc/uv/uv.toml</code> to point the cache directory to this location. Note that if <code>/data</code> is on a different storage device than the user directory, <code>uv</code> 's default hard link behavior will not work, so <code>link-mode</code> needs to be set to symbolic links:</p>
<pre><code class="language-toml"># /etc/uv/uv.toml

cache-dir=&quot;/data/.uv_cache&quot;
link-mode=&quot;symlink&quot; # when hardlink is not possible
</code></pre>
<p>(I noticed that all <code>uv</code> environment variables have their counterparts in <a href="https://docs.astral.sh/uv/reference/settings/">Settings</a>, so there is no need to export the environment variables separately, just change the settings)</p>
<p>Finally, add users who need access to the shared cache to the <code>share</code> group:</p>
<pre><code class="language-bash">adduser share &lt;USER_NAME&gt;
</code></pre>
<p>If you want new users to be added to the <code>share</code> group by default, add the following lines to <code>/etc/adduser.conf</code>:</p>
<pre><code class="language-conf">EXTRA_GROUPS=&quot;share&quot;
ADD_EXTRA_GROUPS=1
</code></pre>
<p>If you find any problems pls let me know ðŸ˜„</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chrispy-snps">@chrispy-snps</a> on 2025-02-06 11:38</div>
            <div class="timeline-body"><p>@observerw - commands like <code>groupadd</code> and <code>adduser</code> require root privileges. This can be a blocking issue in corporate environments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/13323.html">astral-sh/uv#13323</a> on 2025-05-07 22:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/woutervh">@woutervh</a> on 2025-05-07 22:43</div>
            <div class="timeline-body"><blockquote>
<p>Doesn't this defy the purpose of having a shared cache?
Maybe the chache size will be reduced,
but the individual users' .venv will consume much more space.</p>
</blockquote>
<p>A possible issue not yet mentioned:</p>
<p>if someone needs to troubleshoot a python application running in a venv  and sets a pdb-breakpoint in a library,
you do not want to block all other python-applications running in other venvs.</p>
<p>The first priority of a venv is to provide isolation from other venvs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/12875.html">astral-sh/uv#12875</a> on 2025-06-03 03:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oraluben">@oraluben</a> on 2025-06-03 03:32</div>
            <div class="timeline-body"><p>@observerw Amazing instructions, this is exactly what I'm looking for.</p>
<p>One small nit:</p>
<blockquote>
<p>Finally, add users who need access to the shared cache to the <code>share</code> group:</p>
<p>adduser share &lt;USER_NAME&gt;</p>
</blockquote>
<p>Adding user to group should be: <code>usermod -a -G share &lt;user&gt;</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../ecmwf/WeatherGenerator/issues/344.html">ecmwf/WeatherGenerator#344</a> on 2025-06-25 10:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/yaxiongzhao-genesis">@yaxiongzhao-genesis</a> on 2025-12-10 04:21</div>
            <div class="timeline-body"><p>(I am sorry)
But where is <strong>the instruction</strong>? I saw links to a few places, but I'd expect a link to an official page on uv's home page?
Or this doc is still in prep?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:20 UTC
    </footer>
</body>
</html>
