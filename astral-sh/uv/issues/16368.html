<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Switching torch extra between pypi &amp; torch backend - astral-sh/uv #16368</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Switching torch extra between pypi &amp; torch backend</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/16368">#16368</a>
        opened by <a href="https://github.com/tpgillam">@tpgillam</a>
        on 2025-10-20 09:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/tpgillam">@tpgillam</a> on 2025-10-20 09:04</div>
            <div class="timeline-body"><p>uv 0.9.4. Consider the following pyproject.toml in an otherwise empty directory:</p>
<pre><code class="language-toml">[project]
name = &quot;moo&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.13&quot;
dependencies = [&quot;numpy&quot;]


[project.optional-dependencies]
cpu = [
  &quot;torch&gt;=2.8.0&quot;,
]
cu128 = [
  &quot;torch&gt;=2.8.0&quot;,
]
pypi = [
  &quot;torch&gt;=2.8.0&quot;,
]


[tool.uv]
conflicts = [
  [
    { extra = &quot;cpu&quot; },
    { extra = &quot;cu128&quot; },
    { extra = &quot;pypi&quot; },
  ],
]

[tool.uv.sources]
torch = [
  { index = &quot;pytorch-cpu&quot;, extra = &quot;cpu&quot; },
  { index = &quot;pytorch-cu128&quot;, extra = &quot;cu128&quot; },
  { index = &quot;pytorch-pypi&quot;, extra = &quot;pypi&quot; },
]

[[tool.uv.index]]
name = &quot;pytorch-cpu&quot;
url = &quot;https://download.pytorch.org/whl/cpu&quot;
explicit = true

[[tool.uv.index]]
name = &quot;pytorch-cu128&quot;
url = &quot;https://download.pytorch.org/whl/cu128&quot;
explicit = true

[[tool.uv.index]]
name = &quot;pytorch-pypi&quot;
url = &quot;https://pypi.org/simple/&quot;
explicit = true
</code></pre>
<p>This is basically the same as the <a href="https://docs.astral.sh/uv/guides/integration/pytorch/#configuring-accelerators-with-optional-dependencies">documented example</a>, with the addition of the <code>pytorch-pypi</code> index as an option.</p>
<p>I've now run the following commands on a machine with a GPU:</p>
<pre><code class="language-console">$ uv run --extra cpu python -c &quot;import torch; print(torch.cuda.is_available())&quot;
Using CPython 3.13.7
Creating virtual environment at: .venv
Installed 11 packages in 5.26s
False
$ uv run --extra cu128 python -c &quot;import torch; print(torch.cuda.is_available())&quot;
True
$ uv run --extra pypi python -c &quot;import torch; print(torch.cuda.is_available())&quot;
True
$ uv run --extra cpu python -c &quot;import torch; print(torch.cuda.is_available())&quot;
Uninstalled 1 package in 2.45s
Installed 1 package in 3.90s
False
$ uv run --extra pypi python -c &quot;import torch; print(torch.cuda.is_available())&quot;
False
</code></pre>
<p>A little inspection of the verbose logs shows that, when specifying <code>--extra pypi</code>, no package is added or removed. We can look at the syncs to see a bit more explicitly:</p>
<pre><code class="language-console">$ rm -rf .venv &amp;&amp; uv sync --extra pypi
Using CPython 3.13.7
Creating virtual environment at: .venv
Resolved 31 packages in 0.65ms
Installed 27 packages in 4.70s
 + filelock==3.20.0
 + fsspec==2025.9.0
 + jinja2==3.1.6
 + markupsafe==3.0.3
 + mpmath==1.3.0
 + networkx==3.5
 + numpy==2.3.4
 + nvidia-cublas-cu12==12.8.4.1
 + nvidia-cuda-cupti-cu12==12.8.90
 + nvidia-cuda-nvrtc-cu12==12.8.93
 + nvidia-cuda-runtime-cu12==12.8.90
 + nvidia-cudnn-cu12==9.10.2.21
 + nvidia-cufft-cu12==11.3.3.83
 + nvidia-cufile-cu12==1.13.1.3
 + nvidia-curand-cu12==10.3.9.90
 + nvidia-cusolver-cu12==11.7.3.90
 + nvidia-cusparse-cu12==12.5.8.93
 + nvidia-cusparselt-cu12==0.7.1
 + nvidia-nccl-cu12==2.27.5
 + nvidia-nvjitlink-cu12==12.8.93
 + nvidia-nvshmem-cu12==3.3.20
 + nvidia-nvtx-cu12==12.8.90
 + setuptools==80.9.0
 + sympy==1.14.0
 + torch==2.9.0
 + triton==3.5.0
 + typing-extensions==4.15.0
$ uv sync --extra pypi
Resolved 31 packages in 2ms
Audited 27 packages in 13ms
$ uv sync --extra cpu
Resolved 31 packages in 1ms
Uninstalled 17 packages in 3.05s
Installed 1 package in 4.31s
 - nvidia-cublas-cu12==12.8.4.1
 - nvidia-cuda-cupti-cu12==12.8.90
 - nvidia-cuda-nvrtc-cu12==12.8.93
 - nvidia-cuda-runtime-cu12==12.8.90
 - nvidia-cudnn-cu12==9.10.2.21
 - nvidia-cufft-cu12==11.3.3.83
 - nvidia-cufile-cu12==1.13.1.3
 - nvidia-curand-cu12==10.3.9.90
 - nvidia-cusolver-cu12==11.7.3.90
 - nvidia-cusparse-cu12==12.5.8.93
 - nvidia-cusparselt-cu12==0.7.1
 - nvidia-nccl-cu12==2.27.5
 - nvidia-nvjitlink-cu12==12.8.93
 - nvidia-nvshmem-cu12==3.3.20
 - nvidia-nvtx-cu12==12.8.90
 - torch==2.9.0
 + torch==2.9.0+cpu
 - triton==3.5.0
$ uv sync --extra pypi
Resolved 31 packages in 2ms
Installed 16 packages in 185ms
 + nvidia-cublas-cu12==12.8.4.1
 + nvidia-cuda-cupti-cu12==12.8.90
 + nvidia-cuda-nvrtc-cu12==12.8.93
 + nvidia-cuda-runtime-cu12==12.8.90
 + nvidia-cudnn-cu12==9.10.2.21
 + nvidia-cufft-cu12==11.3.3.83
 + nvidia-cufile-cu12==1.13.1.3
 + nvidia-curand-cu12==10.3.9.90
 + nvidia-cusolver-cu12==11.7.3.90
 + nvidia-cusparse-cu12==12.5.8.93
 + nvidia-cusparselt-cu12==0.7.1
 + nvidia-nccl-cu12==2.27.5
 + nvidia-nvjitlink-cu12==12.8.93
 + nvidia-nvshmem-cu12==3.3.20
 + nvidia-nvtx-cu12==12.8.90
 + triton==3.5.0
$ uv sync --extra cu128
Resolved 31 packages in 2ms
Uninstalled 1 package in 2.75s
Installed 1 package in 4.33s
 - torch==2.9.0+cpu
 + torch==2.9.0+cu128
$ uv sync --extra pypi
Resolved 31 packages in 1ms
Audited 27 packages in 4ms
</code></pre>
<hr />
<p>I presume this is because the torch indices name their wheels e.g. <code>2.9.0+cpu</code> and <code>2.9.0+cu128</code>, whereas the pypi wheel is just <code>2.9.0</code>. But this behaviour did trip us up a bit, so possibly there's some room for improvement here, even if just in the docs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @konstin by @konstin on 2025-10-24 12:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-10-24 12:55</div>
            <div class="timeline-body"><p>This is a bug about how we handle switching from local version to non-local version, we have to fix the invalidation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/16480.html">astral-sh/uv#16480</a> on 2025-10-28 11:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tekeinhor">@tekeinhor</a> on 2025-11-05 12:52</div>
            <div class="timeline-body"><p>Hello team,
I think I have a similar issue. I wanted to add my case here to support this &quot;bug&quot;.</p>
<p>Let's say I have this following pyproject.toml</p>
<pre><code class="language-toml">[project]
name = &quot;foo&quot;
version = &quot;0.1.0&quot;
description = &quot;my description&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = [
    &quot;my-private-pkg&gt;=0.1.0&quot;,
]


[build-system]
requires = [&quot;uv_build&gt;=0.8.0,&lt;0.9&quot;]
build-backend = &quot;uv_build&quot;


[tool.uv.build-backend]
module-root = &quot;&quot;


[tool.uv.sources]
my-private-pkg = { path = &quot;../private-pkg-dir&quot;, editable = true } # editable mode when in dev
#my-private-pkg = { index = &quot;privaterepo&quot; } # index mode when in prod

[[tool.uv.index]]
name = &quot;privaterepo&quot;
url = &quot;&lt;link_to_my_private_repo_index&gt;&quot;

</code></pre>
<p>Steps:</p>
<ol>
<li><code>pyproject.toml</code> use editable mode</li>
<li><code>uv sync</code>  with editable mode, <code>uv.lock</code> updated correctly,  <code>.venv</code> updated  with local file</li>
<li><code>pyproject.toml</code>  from editable mode to index mode (comment line with editable mode and uncomment line with index mode)</li>
<li><code>uv sync</code> again, <code>uv.lock</code> updated, but the <code>.venv</code>  is not getting updated with the index version of <code>my-private-pkg</code></li>
</ol>
<p>It only works when I delete the <code>.venv</code> and re do the <code>uv sync</code>.</p>
<p>PS: It is a delight to use <code>uv</code>. Thanks for ur work !</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-12-14 21:21</div>
            <div class="timeline-body"><p>@tekeinhor Are there any local versions involved? This bug is caused by a specific edge case about local versions that only torch should really be affected by (which hacks GPU support with local versions). Your case seems to be a different on of switching between index and local package: uv sees a matching version of my-private-pkg in the venv, and given that the lockfile requires <code>my-private-pkg</code> at the same version, considers that fitting. There's some nuances around this (people intentionally using a custom install vs. you now have to pass <code>--reinstall-package</code> to <code>uv sync</code>), but they'd fit better in their own issue. You may also want to try using conflict-dependencies to support local editable and index package through extras.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:05 UTC
    </footer>
</body>
</html>
