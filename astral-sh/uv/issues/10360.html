<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allow default index for conflicting groups (torch cpu/cuda) - astral-sh/uv #10360</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Allow default index for conflicting groups (torch cpu/cuda)</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/10360">#10360</a>
        opened by <a href="https://github.com/sglbl">@sglbl</a>
        on 2025-01-07 13:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sglbl">@sglbl</a></div>
            <div class="timeline-body"><p>Suggestion, not a bug: Allow default index for conflicting groups (torch cpu/cuda)</p>
<pre><code># This template toml file works with pytorch cpu and gpu versions @sglbl
# using &#x27;uv sync --extra cpu&#x27; or &#x27;uv sync --extra gpu&#x27; command
[project]
name = &quot;digit-classification&quot;
version = &quot;0.1.0&quot;
description = &quot;Digit classification project&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.10&quot;
dependencies = [
    &quot;gradio==5.6.0&quot;,
    &quot;matplotlib==3.9.2&quot;,
    &quot;numpy==2.1.3&quot;,
    &quot;opencv-python&gt;=4.10.0.84&quot;,
    &quot;transformers&gt;=4.46.3&quot;,
]

[dependency-groups]
dev = [
    &quot;jupyter&gt;=1.1.1&quot;,
    &quot;pytest&gt;=8.3.3&quot;,
]

[project.optional-dependencies]
cpu = [
  &quot;torch&gt;=2.5.1&quot;,
]
gpu = [
  &quot;torch&gt;=2.5.1&quot;,
]

[tool.uv]
conflicts = [
  [
    { extra = &quot;cpu&quot; },
    { extra = &quot;gpu&quot; },
  ],
]

[tool.uv.sources]
torch = [
  { index = &quot;pytorch-cpu&quot;, extra = &quot;cpu&quot;, marker = &quot;platform_system != &#x27;Darwin&#x27;&quot; },
  { index = &quot;pytorch-gpu&quot;, extra = &quot;gpu&quot; },
]

[[tool.uv.index]]
name = &quot;pytorch-cpu&quot;
url = &quot;https://download.pytorch.org/whl/cpu&quot;
explicit = true

[[tool.uv.index]]
name = &quot;pytorch-gpu&quot;
url = &quot;https://download.pytorch.org/whl/cu124&quot;
explicit = true

[tool.pytest.ini_options]
pythonpath = &quot;.&quot;
filterwarnings = [&quot;ignore::DeprecationWarning&quot;, &quot;ignore::FutureWarning&quot;]
</code></pre>
<p>Is there a way to set a default extra so that it installs pytorch gpu/cuda version without adding extra flag?
(something like putting the flag <code>set-default = true</code> under one of the <code>[[tool.uv.index]]</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-design</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-07 13:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-07 18:23</div>
            <div class="timeline-body"><p>Similar to <a href="https://docs.astral.sh/uv/reference/settings/#default-groups"><code>default-groups</code></a>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sglbl">@sglbl</a> on 2025-01-07 18:56</div>
            <div class="timeline-body"><p>@zanieb Yes. Actually I tried to solve the torch cpu/gpu issue with <code>dependency-groups</code>, but it didn&#x27;t work because of the conflicts.
So something like default-groups would be really nice</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-07 18:59</div>
            <div class="timeline-body"><p>We support conflicting group declarations in the same was as extras.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sglbl">@sglbl</a> on 2025-01-08 14:21</div>
            <div class="timeline-body"><p>@zanieb Also, is there a way to set a global default python version (like <code>asdf</code> does)?
Because now when I initialize uv, it initializes with my latest python version installed (if I haven&#x27;t created .python-version file already). It&#x27;s the same for virtual environment.</p>
<p>I have <code>Ubuntu 24.04 Gnome/Wayland</code> with <code>python3.12</code> preinstalled. And in every project I use <code>python3.10</code>. That&#x27;s why I&#x27;m trying to set a default global python version without needing uninstall my Ubuntu Python.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-08 21:12</div>
            <div class="timeline-body"><p>You can <code>cd ~ &amp;&amp; uv python pin 3.10</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/HichemAK">@HichemAK</a> on 2025-01-09 11:03</div>
            <div class="timeline-body"><p>I still have a problem with <code>default-groups</code>. For example, in the following setup:</p>
<pre><code>[project]
name = &quot;example&quot;
version = &quot;0.1.0&quot;
description = &quot;XXXXX&quot;
readme = &quot;README.md&quot;
authors = [
    { name = &quot;Hichem Ammar Khodja&quot;, email = &quot;hichem5696@gmail.com&quot; }
]
requires-python = &quot;&gt;=3.9.7&quot;
dependencies = [
]

[tool.uv]
default-groups = [&quot;cu118&quot;]
conflicts = [
  [
    {extra = &quot;cpu&quot;},
    {extra = &quot;cu118&quot;},
    {extra = &quot;cu121&quot;},
    {extra = &quot;cu124&quot;},
  ],
]

[dependency-groups]
cpu = [
  &quot;torch&quot;,
]
cu118 = [
  &quot;torch&quot;,
]
cu121 = [
  &quot;torch&quot;,
]
cu124 = [
  &quot;torch&quot;,
]


[tool.uv.sources]
torch = [
  { index = &quot;torch-cpu&quot;, extra = &quot;cpu&quot;},
  { index = &quot;torch-cu118&quot;, extra = &quot;cu118&quot;},
  { index = &quot;torch-cu121&quot;, extra = &quot;cu121&quot;},
  { index = &quot;torch-cu124&quot;, extra = &quot;cu124&quot;},
]

[[tool.uv.index]]
name = &quot;torch-cpu&quot;
url = &quot;https://download.pytorch.org/whl/cpu&quot;
explicit = true

[[tool.uv.index]]
name = &quot;torch-cu118&quot;
url = &quot;https://download.pytorch.org/whl/cu118&quot;
explicit = true

[[tool.uv.index]]
name = &quot;torch-cu121&quot;
url = &quot;https://download.pytorch.org/whl/cu121&quot;
explicit = true

[[tool.uv.index]]
name = &quot;torch-cu124&quot;
url = &quot;https://download.pytorch.org/whl/cu124&quot;
explicit = true
</code></pre>
<p>uv returns the following error:</p>
<pre><code>error: Failed to generate package metadata for `example==0.1.0 @ editable+.`
  Caused by: Source entry for `torch` only applies to extra `cpu`, but the `cpu` extra does not exist. When an extra is present on a source (e.g., `extra = &quot;cpu&quot;`), the relevant package must be included in the `project.optional-dependencies` section for that extra (e.g., `project.optional-dependencies = { &quot;cpu&quot; = [&quot;torch&quot;] }`).
</code></pre>
<p>However, if I replace <code>[dependency-groups]</code> to <code>[project.optional-dependencies]</code> (as the error suggests) to include all <code>extra</code>s in optional dependencies, uv tells me that default groups must be mentioned in the dependency table group :</p>
<pre><code>error: Default group `cu118` (from `tool.uv.default-groups`) is not defined in the project&#x27;s `dependency-group` table
</code></pre>
<p>Am I missing something ?</p>
<p><strong>EDIT:</strong> I added <code>tool.uv.conflicts</code> section but the results is the same.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-09 17:18</div>
            <div class="timeline-body"><p>In</p>
<pre><code>conflicts = [
  [
    {extra = &quot;cpu&quot;},
    {extra = &quot;cu118&quot;},
    {extra = &quot;cu121&quot;},
    {extra = &quot;cu124&quot;},
  ],
]
</code></pre>
<p>these should be <code>group =</code> not <code>extra =</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sglbl">@sglbl</a> on 2025-01-10 13:42</div>
            <div class="timeline-body"><blockquote>
<p>You can <code>cd ~ &amp;&amp; uv python pin 3.10</code></p>
</blockquote>
<p>Sorry, it didn&#x27;t work.</p>
<p><img src="https://github.com/user-attachments/assets/5296663e-66fd-452f-8018-60d45f31d4f6" alt="Image"></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxstrobel">@maxstrobel</a> on 2025-01-17 11:10</div>
            <div class="timeline-body"><pre><code>[project]
name = &quot;...&quot;
version = &quot;0.1.0&quot;
description = &quot;...&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.11&quot;
dependencies = []

[dependency-groups]
cpu = [&quot;torch&gt;=2.5.1&quot;]
cu118 = [&quot;torch&gt;=2.5.1&quot;]


[tool.uv]
default-groups = [&quot;cpu&quot;]
conflicts = [[{ group = &quot;cpu&quot; }, { group = &quot;cu118&quot; }]]
[[tool.uv.index]]
name = &quot;pytorch-cpu&quot;
url = &quot;https://download.pytorch.org/whl/cpu&quot;
explicit = true
[[tool.uv.index]]
name = &quot;pytorch-cu118&quot;
url = &quot;https://download.pytorch.org/whl/cu118&quot;
explicit = true
[tool.uv.sources]
torch = [
    { index = &quot;pytorch-cpu&quot;, group = &quot;cpu&quot; },
    { index = &quot;pytorch-cu118&quot;, group = &quot;cu118&quot; },
]
</code></pre>
<p>@sglbl - This works for me. It installs by default <code>cpu</code>. You can enable the CUDA installation via <code>uv sync --group cu118 --no-group cpu</code> - it&#x27;s a bit complicated that you have to disable <code>cpu</code> with <code>--no-group cpu</code>, but that&#x27;s the best I&#x27;ve come up so far.</p>
<p>@zanieb Is it possible to simplify this further, s.t. a <code>uv sync --group cu118</code> would be enough?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxstrobel">@maxstrobel</a> on 2025-01-17 14:13</div>
            <div class="timeline-body"><p>Now I found another issue.</p>
<p>Adding PyTorch standalone with the configuration in <code>pyproject.toml</code> shown above works.</p>
<p>However, if I add now a package that has PyTorch as a requirement, e.g. <code>transformers</code>, some entries in <code>uv.lock</code> will be overwritten and <code>uv sync</code> is no longer possible:</p>
<pre><code>$ uv sync
Resolved 51 packages in 1ms
error: Distribution `torch==2.5.1 @ registry+https://download.pytorch.org/whl/cpu` can&#x27;t be installed because it doesn&#x27;t have a source distribution or wheel for the current platform
</code></pre>
<p>Updated <code>pyproject.toml</code> (with <code>transformers</code> on <code>torch</code>):</p>
<pre><code>[project]
name = &quot;xxx&quot;
version = &quot;0.1.0&quot;
description = &quot;xxx&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.11&quot;
dependencies = []

[dependency-groups]
cpu = [&quot;torch&gt;=2.5.1&quot;]
cu118 = [&quot;torch&gt;=2.5.1&quot;]


[tool.uv]
default-groups = [&quot;cpu&quot;]
conflicts = [[{ group = &quot;cpu&quot; }, { group = &quot;cu118&quot; }]]
[[tool.uv.index]]
name = &quot;pytorch-cpu&quot;
url = &quot;https://download.pytorch.org/whl/cpu&quot;
explicit = true
[[tool.uv.index]]
name = &quot;pytorch-cu118&quot;
url = &quot;https://download.pytorch.org/whl/cu118&quot;
explicit = true
[tool.uv.sources]
torch = [
    { index = &quot;pytorch-cpu&quot;, group = &quot;cpu&quot; },
    { index = &quot;pytorch-cu118&quot;, group = &quot;cu118&quot; },
]
</code></pre>
<p><a href="https://github.com/user-attachments/files/18455629/uv-without-transformer.lock.txt">uv-without-transformer.lock.txt</a>
<a href="https://github.com/user-attachments/files/18455628/uv-with-transformer.lock.txt">uv-with-transformer.lock.txt</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sglbl">@sglbl</a> on 2025-01-17 14:22</div>
            <div class="timeline-body"><p>@maxstrobel That&#x27;s why I use <code>extra</code> with conflicts instead of <code>group</code>. When I was using group I needed to remove uv.lock all the time. It&#x27;s fine with <code>extra</code>. Only thing is missing is a default one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/maxstrobel">@maxstrobel</a> on 2025-01-20 08:55</div>
            <div class="timeline-body"><p>@sglbl Thanks, I can confirm that this works also on my end.</p>
<p>@charliermarsh @zanieb What do you think, should I open a new issue for the conflict described above that comes with groups?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/HichemAK">@HichemAK</a> on 2025-01-21 10:09</div>
            <div class="timeline-body"><blockquote>
<p>In</p>
<pre><code>conflicts = [
  [
    {extra = &quot;cpu&quot;},
    {extra = &quot;cu118&quot;},
    {extra = &quot;cu121&quot;},
    {extra = &quot;cu124&quot;},
  ],
]
</code></pre>
<p>these should be <code>group =</code> not <code>extra =</code></p>
</blockquote>
<p>It works perfectly thanks ðŸ‘Œ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mcdiarmid">@mcdiarmid</a> on 2025-04-09 02:26</div>
            <div class="timeline-body"><blockquote>
<p>@zanieb Is it possible to simplify this further, s.t. a uv sync --group cu118 would be enough?</p>
</blockquote>
<p>I&#x27;m interested in this too.  The ability to choose one of the groups in a defined conflict, rather than appending to the list of groups containing <code>default-groups</code>.  Maybe outside the scope of this issue though.</p>
<p>Perhaps adding a parameter like <code>additional-group-behavior=[append|override]</code>, where default is the current behavior of <code>append</code>.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:36:32 UTC
    </footer>
</body>
</html>
