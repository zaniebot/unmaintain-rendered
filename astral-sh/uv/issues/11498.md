```yaml
number: 11498
title: "uv sync: environment markers ignored when extra is given"
type: issue
state: closed
author: robinjhuang
labels:
  - question
assignees: []
created_at: 2025-02-13T23:38:00Z
updated_at: 2025-02-18T14:34:15Z
url: https://github.com/astral-sh/uv/issues/11498
synced_at: 2026-01-10T01:57:26Z
```

# uv sync: environment markers ignored when extra is given

---

_Issue opened by @robinjhuang on 2025-02-13 23:38_

### Summary

I am trying to make a pyproject.toml that installs different versions of torch for each operating system / accelerators:

I added a environment marker for cu126 to only install on linux. I expected it to reject installing completely on my Windows. However, it succeeds.

```
uv sync --extra cu126
Resolved 102 packages in 5.57s
Prepared 47 packages in 14.92s
Installed 47 packages in 7.68s
 + aiohappyeyeballs==2.4.6                                                                                                                              
 + aiohttp==3.11.12                                                                                                                                     
 + aiosignal==1.3.2                                                                                                                                     
 + attrs==25.1.0                                                                                                                                        
 + certifi==2025.1.31                                                                                                                                   
 + cffi==1.17.1                                                                                                                                         
 + charset-normalizer==3.4.1                                                                                                                            
 + colorama==0.4.6                                                                                                                                      
 + einops==0.8.1                                                                                                                                        
 + filelock==3.17.0                                                                                                                                     
 + frozenlist==1.5.0                                                                                                                                    
 + fsspec==2025.2.0                                                                                                                                     
 + huggingface-hub==0.28.1                                                                                                                              
 + idna==3.10                                                                                                                                           
 + jinja2==3.1.5                                                                                                                                        
 + kornia==0.8.0                                                                                                                                        
 + kornia-rs==0.1.8                                                                                                                                     
 + markupsafe==3.0.2                                                                                                                                    
 + mpmath==1.3.0                                                                                                                                        
 + multidict==6.1.0
 + networkx==3.4.2
 + numpy==2.2.3
 + packaging==24.2
 + pillow==11.1.0
 + propcache==0.2.1
 + psutil==7.0.0
 + pycparser==2.22
 + pyyaml==6.0.2
 + regex==2024.11.6
 + requests==2.32.3
 + safetensors==0.5.2
 + scipy==1.15.1
 + sentencepiece==0.2.0
 + soundfile==0.13.1
 + spandrel==0.4.1
 + sympy==1.13.1
 + tokenizers==0.21.0
 + torch==2.6.0
 + torchaudio==2.6.0
 + torchsde==0.2.6
 + torchvision==0.21.0
 + tqdm==4.67.1
 + trampoline==0.1.2
 + transformers==4.48.3
 + typing-extensions==4.12.2
 + urllib3==2.3.0
 + yarl==1.18.3
```

```
[project]
name = "ComfyUI"
version = "0.3.12"
readme = "README.md"
license = { file = "LICENSE" }
requires-python = ">=3.9"
dependencies = [
    "torchsde",
    "numpy>=1.25.0",
    "einops",
    "transformers>=4.28.1",
    "tokenizers>=0.13.3",
    "sentencepiece",
    "safetensors>=0.4.2",
    "aiohttp",
    "pyyaml",
    "Pillow",
    "scipy",
    "tqdm",
    "psutil",
    # Optional dependencies
    "kornia>=0.7.1",
    "spandrel",
    "soundfile",
]

[project.optional-dependencies]
cpu = [
  "torch",
  "torchvision",
  "torchaudio",
]

cu126 = [
  "torch",
  "torchvision",
  "torchaudio",
]

cu124 = [
  "torch",
  "torchvision",
  "torchaudio",
]

cu118 = [
  "torch",
  "torchvision",
  "torchaudio",
]

rocm = [
  "torch",
  "torchvision",
  "torchaudio",
]

xpus = [
  "torch",
  "torchvision",
  "torchaudio",
]

[tool.uv]
conflicts = [
  [
    { extra = "cpu" },
    { extra = "cu126" },
    { extra = "cu124" },
    { extra = "cu118" },
    { extra = "rocm" },
    { extra = "xpus" },
  ],
]


[project.urls]
homepage = "https://www.comfy.org/"
repository = "https://github.com/comfyanonymous/ComfyUI"
documentation = "https://docs.comfy.org/"

[tool.ruff]
lint.select = [
  "S307", # suspicious-eval-usage
  "S102", # exec
  "T",    # print-usage
  "W",
  # The "F" series in Ruff stands for "Pyflakes" rules, which catch various Python syntax errors and undefined names.
  # See all rules here: https://docs.astral.sh/ruff/rules/#pyflakes-f
  "F",
]
exclude = ["*.ipynb"]


[tool.uv.sources]
torch = [
  { index = "pytorch-cu126", extra = "cu126", marker = "sys_platform == 'linux'"},
  { index = "pytorch-cu124", extra = "cu124" }, 
  { index = "pytorch-cu118", extra = "cu118" },
  { index = "pytorch-cpu", extra = "cpu" },
  { index = "pytorch-rocm", extra = "rocm" },
  { index = "pytorch-xpu", extra = "xpus" },
]
torchvision = [
    { index = "pytorch-cu126", extra = "cu126", marker = "sys_platform == 'linux'"},
    { index = "pytorch-cu124", extra = "cu124" },
    { index = "pytorch-cu118", extra = "cu118" },
    { index = "pytorch-cpu", extra = "cpu" },
    { index = "pytorch-rocm", extra = "rocm"  },
    { index = "pytorch-xpu", extra = "xpus" },
]
torchaudio = [
  { index = "pytorch-cu126", extra = "cu126", marker = "sys_platform == 'linux'" },
  { index = "pytorch-cu124", extra = "cu124" },
  { index = "pytorch-cu118", extra = "cu118" },
  { index = "pytorch-cpu", extra = "cpu" },
  { index = "pytorch-rocm", extra = "rocm" },
  { index = "pytorch-xpu", extra = "xpus" },
]

[[tool.uv.index]]
name = "pytorch-cu126"
url = "https://download.pytorch.org/whl/cu126"
explicit = true

[[tool.uv.index]]
name = "pytorch-cu124"
url = "https://download.pytorch.org/whl/cu124"
explicit = true

[[tool.uv.index]]
name = "pytorch-cu118"
url = "https://download.pytorch.org/whl/cu118"
explicit = true

[[tool.uv.index]]
name = "pytorch-cpu"
url = "https://download.pytorch.org/whl/cpu"
explicit = true

[[tool.uv.index]]
name = "pytorch-rocm"
url = "https://download.pytorch.org/whl/rocm6.2"
explicit = true

[[tool.uv.index]]
name = "pytorch-xpu"
url = "https://download.pytorch.org/whl/xpu"
explicit = true

```

### Platform

Windows Pro 11 Version	10.0.26100 Build 26100 x86_64

### Version

uv 0.5.31 (e38ac4900 2025-02-12)

### Python version

Python 3.11.11

---

_Label `bug` added by @robinjhuang on 2025-02-13 23:38_

---

_Comment by @charliermarsh on 2025-02-13 23:39_

Can you expand on why you expect this to fail on Windows? There are Windows wheels for `2.6.0+cu126`.

---

_Comment by @charliermarsh on 2025-02-14 00:28_

Oh sorry, you're referring to `{ index = "pytorch-cu126", extra = "cu126", marker = "sys_platform == 'linux'" }`? For the markers that aren't covered, uv will fall back to the default index (in this case, PyPI).

---

_Comment by @charliermarsh on 2025-02-14 00:29_

I think what you'd want instead is:

```toml
cu126 = [
  "torch ; sys_platform == 'linux'",
  "torchvision ; sys_platform == 'linux'",
  "torchaudio ; sys_platform == 'linux'",
]
```

---

_Comment by @robinjhuang on 2025-02-15 00:50_

I updated added the markers based on what you said. Looks like it still installed? I am on Windows so I added the markers to the rocm optional dependency.

Pyproject.toml:
```
rocm = [
  "torch ; sys_platform == 'linux'",
  "torchvision ; sys_platform == 'linux'",
  "torchaudio ; sys_platform == 'linux'",
]
```

Output:
```
uv sync --extra rocm --verbose
DEBUG uv 0.5.31 (e38ac4900 2025-02-12)
DEBUG Found project root: `C:\Users\robin\OneDrive\Documents\GitHub\ComfyUI`
DEBUG No workspace root found, using project root
DEBUG Acquired lock for `C:\Users\robin\OneDrive\Documents\GitHub\ComfyUI`
DEBUG Using Python request `>=3.9` from `requires-python` metadata
DEBUG Checking for Python environment at `.venv`
DEBUG The virtual environment's Python version satisfies `>=3.9`
DEBUG Released lock at `C:\Users\robin\AppData\Local\Temp\uv-381baabeb699437b.lock`
DEBUG Using request timeout of 30s
DEBUG Found static `pyproject.toml` for: comfyui @ file:///C:/Users/robin/OneDrive/Documents/GitHub/ComfyUI
DEBUG No workspace root found, using project root
DEBUG Existing `uv.lock` satisfies workspace requirements
Resolved 102 packages in 2ms
DEBUG Using request timeout of 30s
DEBUG Requirement already installed: aiohttp==3.11.12
DEBUG Requirement already installed: einops==0.8.1
DEBUG Requirement already installed: kornia==0.8.0
DEBUG Requirement already installed: numpy==2.2.3
DEBUG Requirement already installed: pillow==11.1.0
DEBUG Requirement already installed: psutil==7.0.0
DEBUG Requirement already installed: pyyaml==6.0.2
DEBUG Requirement already installed: safetensors==0.5.2
DEBUG Requirement already installed: scipy==1.15.1
DEBUG Requirement already installed: sentencepiece==0.2.0
DEBUG Requirement already installed: soundfile==0.13.1
DEBUG Requirement already installed: spandrel==0.4.1
DEBUG Requirement already installed: tokenizers==0.21.0
DEBUG Requirement already installed: torchsde==0.2.6
DEBUG Requirement already installed: tqdm==4.67.1
DEBUG Requirement already installed: transformers==4.48.3
DEBUG Requirement already installed: aiohappyeyeballs==2.4.6
DEBUG Requirement already installed: aiosignal==1.3.2
DEBUG Requirement already installed: attrs==25.1.0
DEBUG Requirement already installed: frozenlist==1.5.0
DEBUG Requirement already installed: multidict==6.1.0
DEBUG Requirement already installed: propcache==0.2.1
DEBUG Requirement already installed: yarl==1.18.3
DEBUG Requirement already installed: kornia-rs==0.1.8
DEBUG Requirement already installed: packaging==24.2
DEBUG Requirement already installed: propcache==0.2.1
DEBUG Requirement already installed: yarl==1.18.3
DEBUG Requirement already installed: kornia-rs==0.1.8
DEBUG Requirement already installed: packaging==24.2
DEBUG Requirement already installed: yarl==1.18.3
DEBUG Requirement already installed: kornia-rs==0.1.8
DEBUG Requirement already installed: packaging==24.2
DEBUG Requirement already installed: kornia-rs==0.1.8
DEBUG Requirement already installed: packaging==24.2
DEBUG Registry requirement already cached: torch==2.6.0
DEBUG Requirement already installed: packaging==24.2
DEBUG Registry requirement already cached: torch==2.6.0
DEBUG Registry requirement already cached: torch==2.6.0
DEBUG Requirement already installed: cffi==1.17.1
DEBUG Registry requirement already cached: torchvision==0.21.0
DEBUG Requirement already installed: typing-extensions==4.12.2
DEBUG Registry requirement already cached: torchvision==0.21.0
DEBUG Requirement already installed: typing-extensions==4.12.2
DEBUG Requirement already installed: typing-extensions==4.12.2
DEBUG Requirement already installed: huggingface-hub==0.28.1
DEBUG Requirement already installed: trampoline==0.1.2
DEBUG Requirement already installed: colorama==0.4.6
DEBUG Requirement already installed: filelock==3.17.0
DEBUG Requirement already installed: regex==2024.11.6
DEBUG Requirement already installed: regex==2024.11.6
DEBUG Requirement already installed: requests==2.32.3
DEBUG Requirement already installed: idna==3.10
DEBUG Requirement already installed: fsspec==2025.2.0
DEBUG Requirement already installed: jinja2==3.1.5
DEBUG Requirement already installed: networkx==3.4.2
DEBUG Requirement already installed: sympy==1.13.1
DEBUG Requirement already installed: pycparser==2.22
DEBUG Requirement already installed: certifi==2025.1.31
DEBUG Requirement already installed: charset-normalizer==3.4.1
DEBUG Requirement already installed: urllib3==2.3.0
DEBUG Requirement already installed: markupsafe==3.0.2
DEBUG Requirement already installed: mpmath==1.3.0
Installed 2 packages in 5.45s
 + torch==2.6.0
 + torchvision==0.21.0
```

---

_Comment by @charliermarsh on 2025-02-15 01:34_

The problem is, you have a bunch of dependencies in `dependencies` that depend on torch. So it still has to be included. You can look at `uv tree --python-platform windows` to understand it. For example, `torchsde` depends on torch, as does `kornia`. So if you don't want torch to be installed on Windows, you need to make _those_ dependencies Linux-only too.

---

_Label `bug` removed by @charliermarsh on 2025-02-15 01:34_

---

_Label `question` added by @charliermarsh on 2025-02-15 01:34_

---

_Closed by @charliermarsh on 2025-02-18 14:34_

---
