<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv does not use mentioned cache directory inside of docker containers when using cache mount. - astral-sh/uv #16383</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>uv does not use mentioned cache directory inside of docker containers when using cache mount.</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/16383">#16383</a>
        opened by <a href="https://github.com/vaibhavmano">@vaibhavmano</a>
        on 2025-10-21 11:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/vaibhavmano">@vaibhavmano</a> on 2025-10-21 11:39</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I've been trying to follow the various examples of a optimal docker usage from this <a href="https://github.com/astral-sh/uv-docker-example/">repository: uv-docker-examples</a> but it seems uv does not write to the mentioned cache directory.</p>
<p><code>/var/lib/jenkins/builds/</code> is the path of the <code>persistantVolume</code> attached to the Jenkins instance. I'm trying to build a docker image from within the Jenkins instance and I have set the <code>ENV</code> as <code>UV_CACHE_DIR=/var/lib/jenkins/builds/.cache/uv</code>. The below is a version of my Dockerfile.</p>
<pre><code>FROM basexg:latest

ENV UV_LINK_MODE=copy UV_CACHE_DIR=/var/lib/jenkins/builds/.cache/uv

COPY /pyproject.toml /build/
COPY /uv.lock /build/
COPY /baselib /build/baselib
COPY /application /build/application

WORKDIR /build
RUN --mount=type=cache,id=uv-cache,target=/var/lib/jenkins/builds/.cache/uv \
    uv sync --active --frozen --no-group dev --package application
</code></pre>
<p>This issue is reproducible in my local machine as well. I've been trying to build the docker image with the above dockerfile and once the image is built, I assumed that the cache will exist in the above path (i.e <code>var/lib/jenkins/builds/.cache/uv</code>) but there is no cache that is being written. All subsequent builds keep downloading the package.</p>
<p>Steps to reproduce</p>
<ol>
<li>Clear all docker cache</li>
<li>Rebuild the image pointing to the local machines cache directory, which can be obtained by using command (<code>uv cache dir</code>)</li>
<li>Docker build and you should see that the packages are being downloaded instead of being copies from the cache.</li>
</ol>
<p>Is this an expected behaviour?</p>
<h3>Platform</h3>
<p>macOS 15.4.1 intel</p>
<h3>Version</h3>
<p>0.8.17 (10960bc13 2025-09-10)</p>
<h3>Python version</h3>
<p>Python 3.12.11</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @vaibhavmano on 2025-10-21 11:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-10-21 14:16</div>
            <div class="timeline-body"><p>Please share a complete reproducible example that demonstrates the issue.</p>
<p>If I write a simplified version of what you've provided, and add <code>--offline</code> to the <code>sync</code> invocation, it succeeds, which indicates that we are successfully reading from the cache.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @zanieb on 2025-10-21 14:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vaibhavmano">@vaibhavmano</a> on 2025-10-22 05:45</div>
            <div class="timeline-body"><p>Hey @zanieb</p>
<p>I've been able to reproduce the issue and I'll use the same Dockerfile provided in the the the <a href="https://github.com/astral-sh/uv-docker-example/blob/main/Dockerfile">uv-docker-example repo</a>.</p>
<p>I cloned the above repo and ran <code>uv sync --refresh</code>. I also verified that the <code>uv cache dir</code> in my system points to <code>/Users/ratchet/.cache/uv</code>. I made sure that there is no existing docker build cache available in my system with <code>docker system df</code>.</p>
<p>TYPE | TOTAL | ACTIVE | SIZE | RECLAIMABLE
-- | -- | -- | -- | --
Images | 0 | 0 | 0B | 0B
Containers | 0 | 0 | 0B | 0B
Local Volumes | 1 | 0 | 0B | 0B
Build Cache | 0 | 0 | 0B | 0B</p>
<p>I made a few changes to the <code>DockerFile</code>. I've made sure to point the cache mount to <code>/Users/ratchet/.cache/uv</code>. It should technically mount my local system (Host) directory for that particular <code>RUN</code> command and I've also added the <code>--offline</code> command to ensure that the package should be picked from the host cache.</p>
<pre><code># Use a Python image with uv pre-installed
FROM ghcr.io/astral-sh/uv:python3.12-bookworm-slim

# Setup a non-root user
RUN groupadd --system --gid 999 nonroot \
 &amp;&amp; useradd --system --gid 999 --uid 999 --create-home nonroot

# Install the project into `/app`
WORKDIR /app

# Enable bytecode compilation
ENV UV_COMPILE_BYTECODE=1

# Copy from the cache instead of linking since it's a mounted volume
ENV UV_LINK_MODE=copy

# Ensure installed tools can be executed out of the box
ENV UV_TOOL_BIN_DIR=/usr/local/bin

# Install the project's dependencies using the lockfile and settings
RUN --mount=type=cache,target=/Users/ratchet/.cache/uv \
    --mount=type=bind,source=uv.lock,target=uv.lock \
    --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
    uv sync --locked --no-install-project --no-dev --offline

# Then, add the rest of the project source code and install it
# Installing separately from its dependencies allows optimal layer caching
COPY . /app
RUN --mount=type=cache,target=/Users/ratchet/.cache/uv \
    uv sync --locked --no-dev --offline

# Place executables in the environment at the front of the path
ENV PATH=&quot;/app/.venv/bin:$PATH&quot;

# Reset the entrypoint, don't invoke `uv`
ENTRYPOINT []

# Use the non-root user to run our application
USER nonroot

# Run the FastAPI application by default
# Uses `fastapi dev` to enable hot-reloading when the `watch` sync occurs
# Uses `--host 0.0.0.0` to allow access from outside the container
# Note in production, you should use `fastapi run` instead
CMD [&quot;fastapi&quot;, &quot;dev&quot;, &quot;--host&quot;, &quot;0.0.0.0&quot;, &quot;src/uv_docker_example&quot;]

</code></pre>
<p>Here is the complete error that I get while trying to build the image</p>
<pre><code> =&gt; ERROR [stage-0 4/6] RUN --mount=type=cache,target=/Users/ratchet/.cache/uv     --mount=t  0.6s
------
 &gt; [stage-0 4/6] RUN --mount=type=cache,target=/Users/ratchet/.cache/uv     --mount=type=bind,source=uv.lock,target=uv.lock     --mount=type=bind,source=pyproject.toml,target=pyproject.toml     uv sync --locked --no-install-project --no-dev --offline:
0.269 warning: The `tool.uv.dev-dependencies` field (used in `pyproject.toml`) is deprecated and will be removed in a future release; use `dependency-groups.dev` instead
0.568 Using CPython 3.12.12 interpreter at: /usr/local/bin/python3
0.568 Creating virtual environment at: .venv
0.574 Resolved 42 packages in 0.99ms
0.580   × Failed to download `pydantic==2.11.10`
0.580   ╰─▶ Network connectivity is disabled, but the
0.580       requested data wasn't found in the cache for:
0.580       `https://files.pythonhosted.org/packages/bd/1f/73c53fcbfb0b5a78f91176df41945ca466e71e9d9d836e5c522abda39ee7/pydantic-2.11.10-py3-none-any.whl`
0.580   help: `pydantic` (v2.11.10) was included because `uv-docker-example`
0.580         (v0.1.0) depends on `fastapi` (v0.118.0) which depends on `pydantic`
</code></pre>
<p>My understanding could be wrong over here but I'm assuming that clearing the docker build cache should have no effect on the cache mount since it's a volume/directory that is temporarily mounted from the host system. Let me know if you'd like more information or any further clarifications.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:30 UTC
    </footer>
</body>
</html>
