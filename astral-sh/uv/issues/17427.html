<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upgrading `reqwest` to `0.13.1` to improve TLS experience - astral-sh/uv #17427</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Upgrading <code>reqwest</code> to <code>0.13.1</code> to improve TLS experience</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/17427">#17427</a>
        opened by <a href="https://github.com/salmonsd">@salmonsd</a>
        on 2026-01-12 22:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/salmonsd">@salmonsd</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>It has been well documented that many end users have experienced issues with <code>--native-tls</code> not working as expected, especially when it comes to using <code>uv</code> with corporate CAs. And using <code>allow-insecure-host</code> is not a great option long-term for security reasons.</p>
<p>By upgrading <code>reqwest</code> to <code>0.13.1</code>, we can take advantage of using <code>rustls</code> as the default backend and utilize <code>rustls-platform-verifier</code> instead of <code>rustls-native-certs</code>, which allows us to use more cert signatures supported through <code>aws-lc</code> instead of <em>ring</em>. We can still include and use <code>native-tls</code> to preserve existing functionality, but this would eliminate the <code>SSL_CERT_DIR</code> and <code>SSL_CERT_FILE</code> env var needs for many end users, provided certs are included in their OS certificate store.</p>
<p>The following updates would need to be made to update <code>reqwest</code> to <code>0.13.1</code> along with updating necessary and/or changed features:</p>
<ul>
<li><a href="https://github.com/astral-sh/reqwest-middleware">astral-sh/reqwest-middleware</a> (merge updates from TrueLayer/reqwest-middleware)<ul>
<li><code>astral-reqwest-middleware</code> --&gt; update to <code>0.5.0</code></li>
<li><code>astral-reqwest-tracing</code> --&gt; update to <code>0.6.0</code></li>
<li><code>astral-reqwest-retry</code> --&gt; update to <code>0.9.0</code></li>
</ul>
</li>
<li><a href="https://github.com/astral-sh/ambient-id">astral-sh/ambient-id</a></li>
<li><a href="https://github.com/astral-sh/async_http_range_reader">astral-sh/async_http_range_reader</a></li>
</ul>
<p>Main updates for <code>uv/Cargo.toml</code> (ambient-id, and dev-dependencies excluded):</p>
<pre><code class="language-toml">reqwest = { version = &quot;0.13.1&quot;, default-features = false, features = [&quot;json&quot;, &quot;gzip&quot;, &quot;deflate&quot;, &quot;zstd&quot;, &quot;stream&quot;, &quot;system-proxy&quot;, &quot;rustls&quot;, &quot;socks&quot;, &quot;multipart&quot;, &quot;http2&quot;, &quot;blocking&quot;, &quot;query&quot;, &quot;form&quot;, &quot;native-tls&quot;] }
reqwest-middleware = { version = &quot;0.5.0&quot;, package = &quot;astral-reqwest-middleware&quot;, features = [&quot;multipart&quot;, &quot;json&quot;, &quot;query&quot;, &quot;form&quot;] }
reqwest-retry = { version = &quot;0.9.0&quot;, package = &quot;astral-reqwest-retry&quot; }
</code></pre>
<p>I was able to build and patch locally and was able to successfully run <code>uv</code> to work with my Corporate Cert.</p>
<p>Related:</p>
<ul>
<li>https://github.com/rustls/rustls-native-certs/tree/main</li>
</ul>
<ul>
<li>https://github.com/astral-sh/uv/issues/11595</li>
<li>https://github.com/astral-sh/uv/issues/9243</li>
<li>https://github.com/astral-sh/uv/issues/4534</li>
<li>https://github.com/astral-sh/uv/issues/16360</li>
<li>https://github.com/astral-sh/uv/issues/17355</li>
<li>https://github.com/astral-sh/uv/issues/16412</li>
<li>https://github.com/rustls/rustls/issues/2825</li>
<li>https://github.com/seanmonstar/reqwest/pull/2915/changes</li>
</ul>
<blockquote>
<p>Instead of this crate, we suggest using rustls-platform-verifier which provides a more robust solution with a simpler API. This crate is still maintained, but mostly for use inside the platform verifier on platforms where no other solution is available. For more context, see deployment considerations.</p>
</blockquote>
<h3>Example</h3>
<p>These changes would only affect the <code>uv-client</code> crate with the subsequent changes.</p>
<ul>
<li>remove all calls for <code>built_in_root_certs</code> no longer available from <code>reqwest</code></li>
<li><code>uv/crates/uv-client/src/base_client.rs</code></li>
</ul>
<pre><code class="language-rust">    fn create_client(
        &amp;self,
        user_agent: &amp;str,
        timeout: Duration,
        _ssl_cert_file_exists: bool,
        _ssl_cert_dir_exists: bool,
        security: Security,
        redirect_policy: RedirectPolicy,
    ) -&gt; Client {
        // Configure the builder.
        let client_builder = ClientBuilder::new()
            .http1_title_case_headers()
            .user_agent(user_agent)
            .pool_max_idle_per_host(20)
            .read_timeout(timeout)
            .redirect(redirect_policy.reqwest_policy());

        // If necessary, accept invalid certificates.
        let client_builder = match security {
            Security::Secure =&gt; client_builder,
            Security::Insecure =&gt; client_builder.danger_accept_invalid_certs(true),
        };

        // Note: SSL_CERT_FILE/SSL_CERT_DIR are NOT supported by rustls-platform-verifier.
        // Users needing custom certificates should either:
        //   1. Install certificates in OS certificate store (recommended)
        //   2. Use --native-tls flag on Linux (uses OpenSSL which supports SSL_CERT_*)
        let client_builder = if self.native_tls {
            client_builder.tls_backend_native()
        } else {
            client_builder.tls_backend_rustls()
        };
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @salmonsd on 2026-01-12 22:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-12 23:09</div>
            <div class="timeline-body"><p>Per your code comment, this would break support for <code>SSL_CERT_FILE</code> and <code>SSL_CERT_DIR</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-12 23:10</div>
            <div class="timeline-body"><p>This would also break the functionality added in https://github.com/astral-sh/uv/pull/14816? cc @nilskch</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nilskch">@nilskch</a> on 2026-01-13 09:01</div>
            <div class="timeline-body"><p>#14816 is not exposed to the uv cli. It's for library consumers only (or it at least was the case when I made the PR). We do not use <code>built_in_root_certs</code> anymore, so it would be fine for us making a breaking change here.</p>
<p>https://github.com/astral-sh/uv/blob/4ee320b0a8c8d1764c32db54a511153092dc13e2/crates/uv-client/src/base_client.rs#L227-L231</p>
<p>We now provide a <code>custom_client</code> (previously called <code>with_custom_client</code>, introduced in #15281):</p>
<p>https://github.com/astral-sh/uv/blob/4ee320b0a8c8d1764c32db54a511153092dc13e2/crates/uv-client/src/base_client.rs#L191-L195</p>
<p>I am not sure if this is a breaking change since I am not very familiar with the latest <code>reqwest</code> client APIs.</p>
<p>cc @schmelczer</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/salmonsd">@salmonsd</a> on 2026-01-13 15:51</div>
            <div class="timeline-body"><blockquote>
<p>Per your code comment, this would break support for <code>SSL_CERT_FILE</code> and <code>SSL_CERT_DIR</code>?</p>
</blockquote>
<p>Correct, with <code>reqwest</code> moving to <code>rustls</code> w/ <code>rustls-platform-verifier</code>, <code>SSL_CERT_FILE</code> and <code>SSL_CERT_DIR</code> are ignored. With the exception of <code>Linux</code> using <code>native-tls</code>, which can use the <code>native-tls</code> backend. In that case, it has full <code>OpenSSL</code> support and that can use <code>SSL_CERT_FILE</code> and <code>SSL_CERT_DIR</code>.</p>
<p>Happy to prove this out further, as needed, and PR it. Just let me know.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-13 15:54</div>
            <div class="timeline-body"><p>Feel free to open a pull request, but we'll need to defer it to a breaking release. I'm also pretty worried about breaking <code>SSL_CERT_FILE</code> and <code>SSL_CERT_DIR</code> but I'm not sure we can do much about that long-term.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">breaking</span> added by @zanieb on 2026-01-13 15:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/salmonsd">@salmonsd</a> on 2026-01-13 16:53</div>
            <div class="timeline-body"><p>Understood, to be clear, this is a breaking change by default.</p>
<p>However, if we want to continue supporting <code>SSL_CERT_FILE</code> AND <code>SSL_CERT_DIR</code>, we could extend the <code>ClientBuilder</code> using <code>tls_certs_merge</code> (<a href="https://github.com/seanmonstar/reqwest/blob/10c31c2d87c29012219c20f58bb637898c7f76d8/src/async_impl/client.rs#L1846-L1857">source</a>).</p>
<p>And then extend<code>base_client.rs</code> to merge the certs:</p>
<pre><code class="language-rust">// Example Mockup, not proposed implementation
let mut client_builder = ClientBuilder::new().tls_backend_rustls();

let mut extra_certs = Vec::new();

// Load from SSL_CERT_FILE
if let Ok(cert_file) = env::var(&quot;SSL_CERT_FILE&quot;) {
    if let Ok(cert_pem) = std::fs::read(&amp;cert_file) {
        if let Ok(cert) = Certificate::from_pem(&amp;cert_pem) {
            extra_certs.push(cert);
        }
    }
}

// Load from SSL_CERT_DIR
if let Ok(cert_dir) = env::var(&quot;SSL_CERT_DIR&quot;) {
    // ... load all .crt/.pem files and add to extra_certs
}

// Merge these certs WITH the OS certificate store
if !extra_certs.is_empty() {
    client_builder = client_builder.tls_certs_merge(extra_certs);
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-13 17:01</div>
            <div class="timeline-body"><p>Oh, we should aspire to do that â€” we really don't like breaking things :)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-13 17:29:11 UTC
    </footer>
</body>
</html>
