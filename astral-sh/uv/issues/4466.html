<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UV upgrades packages inherited with --system-site-packages - astral-sh/uv #4466</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>UV upgrades packages inherited with --system-site-packages</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/4466">#4466</a>
        opened by <a href="https://github.com/lkoelman">@lkoelman</a>
        on 2024-06-24 11:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/lkoelman">@lkoelman</a> on 2024-06-24 11:22</div>
            <div class="timeline-body"><p>Hi there, I'm encountering the following behaviour where uv deviates from <code>pip</code> and is causing one of our builds to fail: when you create a virtual environment with <code>--system-site-packages</code>, and then install a package without specifying a version, UV chooses the upgrade path (install the latest version in the virtual environment), whereas pip just uses the older version inherited from the base environment.</p>
<p>How to reproduce:</p>
<pre><code class="language-bash"># (in your base python environment, I used conda)
pip install 'numpy==1.27.0'
pip install uv

python -m venv --system-site-packages .venv
source .venv/bin/activate
# install without verison requirement
uv pip install numpy
# ==&gt; this installs numpy==2.0.0

# install using pip, without version requirements
pip install numpy
# ==&gt; this doesn't install anything, expected behaviour
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-24 13:45</div>
            <div class="timeline-body"><p>Hi. Is <code>--system-site-packages</code> missing from your reproduction here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-24 14:47</div>
            <div class="timeline-body"><p>(I think this is roughly a known problem, since we don't look at the full <code>sys.path</code>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-24 14:47</div>
            <div class="timeline-body"><p>(Same as #2500.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lkoelman">@lkoelman</a> on 2024-06-24 14:58</div>
            <div class="timeline-body"><blockquote>
<p>Hi. Is <code>--system-site-packages</code> missing from your reproduction here?</p>
</blockquote>
<p>yes it was missing, I updated it in my original post</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-06-24 15:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">compatibility</span> added by @zanieb on 2024-06-24 15:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-24 15:26</div>
            <div class="timeline-body"><p>Yeah I think the root cause is the same as #2500 — maybe we need a separate issue that tracks that functionality. Otherwise it seems reasonable to keep this open to track this effect.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/J3ronimo">@J3ronimo</a> on 2024-06-26 13:19</div>
            <div class="timeline-body"><p>I can confirm that the <code>include-system-site-packages = true</code> in pyvenv.cfg seems to have no effect. All dependencies get installed again into the venv although they are already satisfied in the base installation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-26 13:23</div>
            <div class="timeline-body"><p>It has an effect on <code>python</code> itself -- your interpreter will have access to the system site packages. But we don't respect it in <code>uv</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/J3ronimo">@J3ronimo</a> on 2024-06-26 14:15</div>
            <div class="timeline-body"><p>Ah, understood.</p>
<p>EDIT: I now <a href="https://github.com/astral-sh/uv/issues/2500#issuecomment-2103751174">found</a> it's actually documented to be this way in <code>uv venv --help</code> (the <code>--help</code> is important, in <code>-h</code> you won't see it):</p>
<pre><code>--system-site-packages
    Give the virtual environment access to the system site packages directory.

    Unlike `pip`, when a virtual environment is created with `--system-site-packages`, `uv` will _not_ take
    system site packages into account when running commands like `uv pip list` or `uv pip install`. The
    `--system-site-packages` flag will provide the virtual environment with access to the system site packages
    directory at runtime, but it will not affect the behavior of `uv` commands.
</code></pre>
<p>We're making great use of this &quot;diff install&quot; behavior of pip to minimize venv sizes in our test suite. Each test needs numpy, matplotlib, scipy etc, which are provided through a rich base install (WinPython, similarly Anaconda) and the dependency requirements of the tests are tried to make best use of what's already in there. This way we can typically reduce &gt;200MB full installs to &lt;10MB, which adds up with every test and version thereof.</p>
<p>Is there another feature in uv that would allow this kind of diff install scenario in order save disk space? Do you have plans to add it at some point (or have you already decided not to)?</p>
<p>If I preinstall a <code>.pth</code> file in the venv, pointing to the base install (or some shared libs
folder), would uv respect that?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2024-08-16 16:45</div>
            <div class="timeline-body"><blockquote>
<p>If I preinstall a .pth file in the venv, pointing to the base install (or some shared libs
folder), would uv respect that?</p>
</blockquote>
<p>Just tried that -- it does not, but IMO it should.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chrisrodrigue">@chrisrodrigue</a> on 2024-08-16 20:56</div>
            <div class="timeline-body"><p>I have a similar use case to @J3ronimo</p>
<p>My org is tied to using vetted Python package distributions such as Anaconda/WinPython in environments that lack access to PyPI.</p>
<p>The general idea is to simultaneously:</p>
<ul>
<li>Utilize a base <code>conda</code> environment for access to the interpreter (i.e. <code>python==3.12.4</code> and the <code>site-packages</code> that come bundled with the Anaconda distribution. This is effectively a system python installation with a large number of vetted packages added to it.</li>
<li>Utilize <code>uv</code> with a <code>pyproject.toml</code> file as one normally would</li>
</ul>
<p>IMO, <code>uv</code> should be able to detect if <code>build-system.requires</code>, <code>project.dependencies</code> and <code>project.optional-dependencies</code> versions are already satisfied in the environment of the active python interpreter as the default behavior. That way, running <code>uv sync</code> will not inefficiently download and install all the dependencies again for an online system (or not fail outright on an offline system). However, I would expect <code>uv</code> to be able to install new requirements that aren't in the base environment to the venv.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chrisrodrigue">@chrisrodrigue</a> on 2024-08-16 21:13</div>
            <div class="timeline-body"><p>A cop-out way to get a list of already-satisfied requirements would be to just shell out to <code>python -m pip list</code>, but I'm not sure how one would annotate sources in <code>uv.lock</code>. Maybe the file system path? (i.e. <code>C:\ProgramData\anaconda3\Lib\site-packages\&lt;package&gt;</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BubuOT">@BubuOT</a> on 2024-09-13 13:17</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/uv/issues/7358#issuecomment-2348896632 recommended using <code>uv pip install --system</code> as a workaround, but that is not an option for us, because the system python environment is on a read-only partition.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/awoimbee">@awoimbee</a> on 2024-11-21 11:32</div>
            <div class="timeline-body"><p>Same as #6880</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pradyunsg">@pradyunsg</a> on 2024-12-12 15:44</div>
            <div class="timeline-body"><p>Would a PR for this be welcome?</p>
<blockquote>
<p>If I preinstall a <code>.pth</code> file in the venv, pointing to the base install (or some shared libs folder), would uv respect that?</p>
</blockquote>
<p>Currently, no.</p>
<blockquote>
<p>(I think this is roughly a known problem, since we don't look at the full sys.path.)</p>
</blockquote>
<p>This is accurate. #3500 pulled in sys.path from the interpreter but it's not being used at this time.</p>
<p>Looking through the code for this, it looks like the changes needed here are:</p>
<ul>
<li>Update the environment lookup logic to use sys.path rather than sysconfig paths, for installed distributions.</li>
<li>Track whether something is coming from &quot;outside&quot; the environment, and skip uninstalling such packages (something that'd fail in many cases, in case of missing permissions).</li>
</ul>
<p>Based on taking a quick look at things, these aren't particularly complex and I'd be happy to explore doing both these pieces, if a PR for this would be useful/welcome.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-12 16:16</div>
            <div class="timeline-body"><p>Definitely welcome. I’m happy to answer questions too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jscanvic">@jscanvic</a> on 2025-12-12 19:26</div>
            <div class="timeline-body"><p>@BubuOT Did you end up finding a workaround for read-only system site-packages?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BubuOT">@BubuOT</a> on 2025-12-13 17:44</div>
            <div class="timeline-body"><p>@jscanvic not really, no, besides just accepting that uv will re-download and reinstall all the packages that are already in the system venv.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 03:16:56 UTC
    </footer>
</body>
</html>
