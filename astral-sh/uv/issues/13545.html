<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Requests should retry with backoff on 429 - astral-sh/uv #13545</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Requests should retry with backoff on 429</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/13545">#13545</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2025-05-19 21:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/zanieb">@zanieb</a> on 2025-05-19 21:22</div>
            <div class="timeline-body"><p>I saw this fail on https://github.com/astral-sh/uv/actions/runs/15123326059/job/42510461194?pr=13537</p>
<pre><code>━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot: require_hashes_find_links_valid_hash
Source: crates/uv/tests/it/pip_sync.rs:4675
────────────────────────────────────────────────────────────────────────────────
Expression: snapshot
────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬───────────────────────────────────────────────────────────────────
    0       │-success: true
    1       │-exit_code: 0
          0 │+success: false
          1 │+exit_code: 2
    2     2 │ ----- stdout -----
    3     3 │ 
    4     4 │ ----- stderr -----
    5       │-Resolved 1 package in [TIME]
    6       │-Prepared 1 package in [TIME]
    7       │-Installed 1 package in [TIME]
    8       │- + example-a-961b4c22==1.0.0
          5 │+error: Failed to read `--find-links` URL: https://raw.githubusercontent.com/astral-test/astral-test-hash/main/valid-hash/simple-html/example-a-961b4c22/index.html
          6 │+  Caused by: Failed to fetch: `[https://raw.githubusercontent.com/astral-test/astral-test-hash/main/valid-hash/simple-html/example-a-961b4c22/index.html`](https://raw.githubusercontent.com/astral-test/astral-test-hash/main/valid-hash/simple-html/example-a-961b4c22/index.html%60)
          7 │+  Caused by: HTTP status client error (429 Too Many Requests) for url (https://raw.githubusercontent.com/astral-test/astral-test-hash/main/valid-hash/simple-html/example-a-961b4c22/index.html)
</code></pre>
<p>The test failed in 7s, so... I don't think we're doing a retry here? I haven't confirmed that we didn't yet. I wonder if we should be? At the very least, we should with opt-in?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2025-05-19 21:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @zanieb on 2025-05-19 21:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-05-20 11:47</div>
            <div class="timeline-body"><p>I think we should retry, but with a warning about the too many requests and a higher backoff (several seconds?).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-05-20 13:08</div>
            <div class="timeline-body"><p>The response should include a retry after time, we can respect that with a fallback and fail if it exceeds some configurable threshold?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-05-21 01:43</div>
            <div class="timeline-body"><p>Given https://github.com/astral-sh/uv/pull/13033#discussion_r2098880148 I presume we <em>are</em> retrying here already in some cases? Should be simple to add a test case for this with wiremock as a first step if someone is interested.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @zanieb on 2025-05-21 01:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> removed by @konstin on 2025-05-21 08:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> removed by @konstin on 2025-05-21 08:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-05-21 08:35</div>
            <div class="timeline-body"><p>MRE:</p>
<pre><code class="language-python">from http.server import HTTPServer, BaseHTTPRequestHandler


class TooManyRequestsHandler(BaseHTTPRequestHandler):
    def _send_429(self):
        self.send_response(500)
        self.send_header('Content-type', 'text/plain')
        self.end_headers()
        self.wfile.write(b'Too Many Requests')

    def do_GET(self):
        self._send_429()

    def do_POST(self):
        self._send_429()


if __name__ == '__main__':
    server_address = ('', 8000)
    httpd = HTTPServer(server_address, TooManyRequestsHandler)
    print('Server running on port 8000...')
    httpd.serve_forever()
</code></pre>
<pre><code>uv pip install tqdm --index-url http://localhost:8000 -v
</code></pre>
<p>We are retrying, but we're missing reporting and the logic by which we do seems off.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-06-24 10:04</div>
            <div class="timeline-body"><p>I'm pretty sure this is fixed now by reporting that we retry.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-10-29 11:16</div>
            <div class="timeline-body"><p>This should be solved by https://github.com/astral-sh/uv/blob/51e8da2d1c7a15cd30901de565fba2c19413f6da/crates/uv-client/src/base_client.rs#L1338</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-10-29 11:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:03 UTC
    </footer>
</body>
</html>
