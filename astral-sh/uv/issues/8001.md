```yaml
number: 8001
title: torch + transitive dependency leads to unnecessary packages
type: issue
state: closed
author: senysenyseny16
labels:
  - question
assignees: []
created_at: 2024-10-08T10:57:11Z
updated_at: 2024-12-26T17:00:49Z
url: https://github.com/astral-sh/uv/issues/8001
synced_at: 2026-01-10T01:57:18Z
```

# torch + transitive dependency leads to unnecessary packages

---

_Issue opened by @senysenyseny16 on 2024-10-08 10:57_

Hello! I found that `uv` installs unnecessary (transitive) dependencies:

Reproducing:
```
uv venv -p python3.10
source .venv/bin/activate
uv pip install torch==2.1.2+cpu --index-url https://download.pytorch.org/whl/cpu
```

```
Resolved 9 packages in 3.14s
Installed 9 packages in 255ms
 + filelock==3.13.1
 + fsspec==2024.2.0
 + jinja2==3.1.3
 + markupsafe==2.1.5
 + mpmath==1.3.0
 + networkx==3.2.1
 + sympy==1.12
 + torch==2.1.2+cpu
 + typing-extensions==4.9.0
```

```
uv pip install opencv-python torch==2.1.2  # imagine torch==2.1.2 is opencv-python package dependency
```

```
Resolved 24 packages in 1.49s
Prepared 2 packages in 37.71s
Installed 15 packages in 37ms
 + numpy==2.1.2
 + nvidia-cublas-cu12==12.1.3.1
 + nvidia-cuda-cupti-cu12==12.1.105
 + nvidia-cuda-nvrtc-cu12==12.1.105
 + nvidia-cuda-runtime-cu12==12.1.105
 + nvidia-cudnn-cu12==8.9.2.26
 + nvidia-cufft-cu12==11.0.2.54
 + nvidia-curand-cu12==10.3.2.106
 + nvidia-cusolver-cu12==11.4.5.107
 + nvidia-cusparse-cu12==12.1.0.106
 + nvidia-nccl-cu12==2.18.1
 + nvidia-nvjitlink-cu12==12.6.77
 + nvidia-nvtx-cu12==12.1.105
 + opencv-python==4.10.0.84
 + triton==2.1.0
```

But in this case nvidia/triton deps are not needed, they are from PyPI CUDA torch:

```
DEBUG Searching for a compatible version of torch (==2.1.2)
DEBUG Selecting: torch==2.1.2 [compatible] (torch-2.1.2-cp310-cp310-manylinux1_x86_64.whl)
DEBUG Adding transitive dependency for torch==2.1.2: filelock*
DEBUG Adding transitive dependency for torch==2.1.2: typing-extensions*
DEBUG Adding transitive dependency for torch==2.1.2: sympy*
DEBUG Adding transitive dependency for torch==2.1.2: networkx*
DEBUG Adding transitive dependency for torch==2.1.2: jinja2*
DEBUG Adding transitive dependency for torch==2.1.2: fsspec*
DEBUG Adding transitive dependency for torch==2.1.2: nvidia-cuda-nvrtc-cu12{platform_machine == 'x86_64' and platform_system == 'Linux'}==12.1.105
DEBUG Adding transitive dependency for torch==2.1.2: nvidia-cuda-runtime-cu12{platform_machine == 'x86_64' and platform_system == 'Linux'}==12.1.105
DEBUG Adding transitive dependency for torch==2.1.2: nvidia-cuda-cupti-cu12{platform_machine == 'x86_64' and platform_system == 'Linux'}==12.1.105
DEBUG Adding transitive dependency for torch==2.1.2: nvidia-cudnn-cu12{platform_machine == 'x86_64' and platform_system == 'Linux'}==8.9.2.26
DEBUG Adding transitive dependency for torch==2.1.2: nvidia-cublas-cu12{platform_machine == 'x86_64' and platform_system == 'Linux'}==12.1.3.1
DEBUG Adding transitive dependency for torch==2.1.2: nvidia-cufft-cu12{platform_machine == 'x86_64' and platform_system == 'Linux'}==11.0.2.54
DEBUG Adding transitive dependency for torch==2.1.2: nvidia-curand-cu12{platform_machine == 'x86_64' and platform_system == 'Linux'}==10.3.2.106
DEBUG Adding transitive dependency for torch==2.1.2: nvidia-cusolver-cu12{platform_machine == 'x86_64' and platform_system == 'Linux'}==11.4.5.107
DEBUG Adding transitive dependency for torch==2.1.2: nvidia-cusparse-cu12{platform_machine == 'x86_64' and platform_system == 'Linux'}==12.1.0.106
DEBUG Adding transitive dependency for torch==2.1.2: nvidia-nccl-cu12{platform_machine == 'x86_64' and platform_system == 'Linux'}==2.18.1
DEBUG Adding transitive dependency for torch==2.1.2: nvidia-nvtx-cu12{platform_machine == 'x86_64' and platform_system == 'Linux'}==12.1.105
DEBUG Adding transitive dependency for torch==2.1.2: triton{platform_machine == 'x86_64' and platform_system == 'Linux'}==2.1.0
```

linux x86_64, uv 0.4.11 

Is there work around?
The situation is even worse when installing Torch with a specific version of CUDA (https://download.pytorch.org/whl/cu118 for example)

---

_Comment by @allendred on 2024-10-22 09:53_

What is the reason? I have the same problem.

---

_Comment by @zanieb on 2024-10-22 11:07_

It looks like the marker on the dependencies is just `{platform_machine == 'x86_64' and platform_system == 'Linux'}` which matches your platform so we need to install those dependencies. How would we know not to? 

---

_Label `question` added by @zanieb on 2024-10-22 11:08_

---

_Comment by @zanieb on 2024-10-22 11:08_

Your two examples aren't really comparable since in the first you're installing the `+cpu` package specifically?

---

_Comment by @senysenyseny16 on 2024-10-22 14:02_

> Your two examples aren't really comparable since in the first you're installing the `+cpu` package specifically?

Yes. Let's assume that I need to use the CPU version of PyTorch, and then I want to install some package that depends on PyTorch (any version, doesn't matter if it's CPU, CUDA, or something else). In this case, `uv` will install a large number of unnecessary packages.

---

_Comment by @allendred on 2024-10-23 03:44_

uv pip install torch  --extra-index-url "https://download.pytorch.org/whl/cpu" it's ok
uv add torch  --extra-index-url "https://download.pytorch.org/whl/cpu" error: Distribution `torch==2.5.0 @ registry+https://download.pytorch.org/whl/cpu` can't be installed because it doesn't have a source distribution or wheel for the current platform
(kbqa-llm) root@:/workspace/kbqa-llm/src# uv add torch --extra-index-url "https://download.pytorch.org/whl/cpu"

---

_Comment by @kahojyun on 2024-10-23 06:51_

Edited: This is a known limitation of `uv`: https://docs.astral.sh/uv/pip/compatibility/#local-version-identifiers

It looks like `uv` doesn't follow the [python packaging version specifiers spec](https://packaging.python.org/en/latest/specifications/version-specifiers/#version-matching)

> If the specified version identifier is a public version identifier (no local version label), then the local version label of any candidate versions MUST be ignored when matching versions.
> If the specified version identifier is a local version identifier, then the local version labels of candidate versions MUST be considered when matching versions, with the public version identifier being matched as described above, and the local version label being checked for equivalence using a strict string equality comparison.

`+cpu` is a local version label which should be ignored when matching against `pytorch==2.5.0`, so installing `pytorch==2.5.0` should select wheel with version `2.5.0+cpu` when using `https://download.pytorch.org/whl/cpu` as index-url.

Following are comparison between `pip install` and `uv pip install`:
```
❯ pip3 install torch==2.5.0 --index-url https://download.pytorch.org/whl/cpu
Looking in indexes: https://download.pytorch.org/whl/cpu
Collecting torch==2.5.0
  Using cached https://download.pytorch.org/whl/cpu/torch-2.5.0%2Bcpu-cp311-cp311-linux_x86_64.whl (174.7 MB)
Collecting filelock (from torch==2.5.0)
  Using cached https://download.pytorch.org/whl/filelock-3.13.1-py3-none-any.whl (11 kB)
Collecting typing-extensions>=4.8.0 (from torch==2.5.0)
  Using cached https://download.pytorch.org/whl/typing_extensions-4.9.0-py3-none-any.whl (32 kB)
Collecting networkx (from torch==2.5.0)
  Using cached https://download.pytorch.org/whl/networkx-3.2.1-py3-none-any.whl (1.6 MB)
Collecting jinja2 (from torch==2.5.0)
  Using cached https://download.pytorch.org/whl/Jinja2-3.1.3-py3-none-any.whl (133 kB)
Collecting fsspec (from torch==2.5.0)
  Using cached https://download.pytorch.org/whl/fsspec-2024.2.0-py3-none-any.whl (170 kB)
Collecting sympy==1.13.1 (from torch==2.5.0)
  Using cached https://download.pytorch.org/whl/sympy-1.13.1-py3-none-any.whl (6.2 MB)
Collecting mpmath<1.4,>=1.1.0 (from sympy==1.13.1->torch==2.5.0)
  Using cached https://download.pytorch.org/whl/mpmath-1.3.0-py3-none-any.whl (536 kB)
Collecting MarkupSafe>=2.0 (from jinja2->torch==2.5.0)
  Using cached https://download.pytorch.org/whl/MarkupSafe-2.1.5-cp311-cp311-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (28 kB)
Installing collected packages: mpmath, typing-extensions, sympy, networkx, MarkupSafe, fsspec, filelock, jinja2, torch
Successfully installed MarkupSafe-2.1.5 filelock-3.13.1 fsspec-2024.2.0 jinja2-3.1.3 mpmath-1.3.0 networkx-3.2.1 sympy-1.13.1 torch-2.5.0+cpu typing-extensions-4.9.0
```
```
❯ uv pip install torch==2.5.0 --default-index https://download.pytorch.org/whl/cpu
  × No solution found when resolving dependencies:
  ╰─▶ Because torch==2.5.0 has no wheels with a matching Python implementation tag and you require torch==2.5.0, we can conclude that your requirements are
      unsatisfiable.
```

---

_Comment by @charliermarsh on 2024-12-26 17:00_

We do support local versions entirely now.

---

_Closed by @charliermarsh on 2024-12-26 17:00_

---
