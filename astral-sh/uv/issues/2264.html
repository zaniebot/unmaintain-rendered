<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python discovery still broken for Microsoft Store - astral-sh/uv #2264</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Python discovery still broken for Microsoft Store</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/2264">#2264</a>
        opened by <a href="https://github.com/NMertsch">@NMertsch</a>
        on 2024-03-07 06:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/NMertsch">@NMertsch</a></div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

<p>I followed #2105 (fixed in 0.1.14) and #2208 (fixed in 0.1.15), and still cannot make uv discover my Python executables installed via the Microsoft Store.</p>
<p>With 0.1.13 and 0.1.14, I had the error message mentioned in the previous tickets (<code>failed to canonicalize path 'C:\Users\...\AppData\Local\Microsoft\WindowsApps\python3.11.exe'</code>).</p>
<p>With 0.1.15, I get this: <code>No Python 3.11 found through 'py --list-paths' or in 'PATH'. Is Python 3.11 installed?</code></p>
<p>Details:</p>
<pre><code class="language-text">PS C:\Users\nme&gt; irm https://astral.sh/uv/install.ps1 | iex
Downloading uv 0.1.15 (x86_64-pc-windows-msvc)
Installing to C:\Users\nme\.cargo\bin
  uv.exe
Everything's installed!

PS C:\Users\nme&gt; uv --version
uv 0.1.15 (a8ac7b1eb 2024-03-05)

PS C:\Users\nme&gt; uv venv --verbose --python 3.11
 uv_interpreter::python_query::find_requested_python request=3.11
      0.008891s   0ms DEBUG uv_interpreter::python_query Starting interpreter discovery for Python @ `3.11`
   uv_interpreter::python_query::windows::py_list_paths
      0.016581s   7ms DEBUG uv_interpreter::python_query `py` is not installed
  Ã— No Python 3.11 found through `py --list-paths` or in `PATH`. Is Python 3.11 installed?

PS C:\Users\nme&gt; py --list-paths
py: The term 'py' is not recognized as a name of a cmdlet, function, script file, or executable program.
Check the spelling of the name, or if a path was included, verify that the path is correct and try again.

PS C:\Users\nme&gt; python -V
Python 3.10.11
</code></pre>
<p>The relevant error message seems to be &quot;No Python 3.11 found through <code>py --list-paths</code> or in <code>PATH</code>&quot;:</p>
<ul>
<li><code>py --list-paths</code> does not work (<code>py</code> is unknown)</li>
<li><code>python</code> on my PATH is version 3.10</li>
</ul>
<p>At least on my two Windows machines, the Microsoft Store installs all Python versions as <code>python3.X</code>, but I don't know how it determines which version <code>python</code> is (I always use <code>python3.X</code> explicitly):</p>
<pre><code class="language-text">PS C:\Users\nme&gt; python3.7 -V
Python 3.7.9
PS C:\Users\nme&gt; where.exe python3.7
C:\Users\nme\AppData\Local\Microsoft\WindowsApps\python3.7.exe

PS C:\Users\nme&gt; python3.8 -V
Python 3.8.10
PS C:\Users\nme&gt; where.exe python3.8
C:\Users\nme\AppData\Local\Microsoft\WindowsApps\python3.8.exe

PS C:\Users\nme&gt; python3.9 -V
Python 3.9.13
PS C:\Users\nme&gt; where.exe python3.9
C:\Users\nme\AppData\Local\Microsoft\WindowsApps\python3.9.exe

PS C:\Users\nme&gt; python3.10 -V
Python 3.10.11
PS C:\Users\nme&gt; where.exe python3.10
C:\Users\nme\AppData\Local\Microsoft\WindowsApps\python3.10.exe

PS C:\Users\nme&gt; python3.11 -V
Python 3.11.8
PS C:\Users\nme&gt; where.exe python3.11
C:\Users\nme\AppData\Local\Microsoft\WindowsApps\python3.11.exe
</code></pre>
<p>Interestingly, <code>uv</code> also fails to discover <code>3.10</code>, even though the <code>python</code> in my PATH is <code>3.10</code>:</p>
<pre><code class="language-text">PS C:\Users\nme&gt; uv venv --verbose --python 3.10
 uv_interpreter::python_query::find_requested_python request=3.10
      0.051711s   0ms DEBUG uv_interpreter::python_query Starting interpreter discovery for Python @ `3.10`
   uv_interpreter::python_query::windows::py_list_paths
      0.056948s   5ms DEBUG uv_interpreter::python_query `py` is not installed
  Ã— No Python 3.10 found through `py --list-paths` or in `PATH`. Is Python 3.10 installed?

PS C:\Users\nme&gt; python -V
Python 3.10.11

PS C:\Users\nme&gt; where.exe python
C:\Users\nme\AppData\Local\Microsoft\WindowsApps\python.exe
</code></pre>
<p>(Thanks everyone working on ruff and uv btw! &lt;3)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-07 14:08</div>
            <div class="timeline-body"><p>Hey thanks for the clear write-up! I'll look into this again. It may be hard for me to debug because it is working as expected on my own Windows machine with the Windows Store Python, but I'll try some more of these cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">windows</span> added by @charliermarsh on 2024-03-07 14:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-07 14:09</div>
            <div class="timeline-body"><p>In the meantime, don't hate me but if you're blocked, I might suggest installing Python from the python.org installers? It should give you a more reliable experience (at least with uv, though other tools like virtualenv also include special-casing for Windows Store).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @konstin by @charliermarsh on 2024-03-07 15:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-03-07 16:03</div>
            <div class="timeline-body"><p>Pinging @zooba, apologies if inappropriate.</p>
<p>But if you have a moment, is there a canonical way to determine the Microsoft Store Python installs available?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-07 16:17</div>
            <div class="timeline-body"><p>I think the issue is that we ignore the Windows Store paths (like <code>C:\Users\nme\AppData\Local\Microsoft\WindowsApps\python3.7.exe</code>) when looking at <code>$PATH</code>, and instead rely on <code>py --list-paths</code> to give us the &quot;real&quot; interpreters, which instead look like <code>C:\Users\nme\AppData\Local\Microsoft\WindowsApps\PythonSoftwareFoundation.Python.3.9_qbz5n2kfra8p0\python.exe</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-07 16:18</div>
            <div class="timeline-body"><p>I'm using &quot;real&quot; in quotes because I don't really understand how the Windows Store install is structured -- but I'm generally not sure how to go from <code>C:\Users\nme\AppData\Local\Microsoft\WindowsApps\python3.9.exe</code> to the interpreter path above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-07 16:26</div>
            <div class="timeline-body"><p>Maybe we just shouldn't be &quot;ignoring&quot; those, and should instead avoid trying to canonicalize them (which is where we see failures).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-07 16:35</div>
            <div class="timeline-body"><p>I think the intent of the filtering is to filter out the &quot;App Execution aliases&quot;, there's some commentary that it may open up the Windows Store in some cases? I need to figure out how to reproduce this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-07 16:39</div>
            <div class="timeline-body"><p>Ahhh I see it. I needed to check &quot;App Installer&quot; in &quot;App execution aliases&quot;, I think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-07 16:44</div>
            <div class="timeline-body"><p>So we need a way to reliably detect and filter out the &quot;App Installer&quot; redirects.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-03-07 16:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @konstin by @charliermarsh on 2024-03-07 16:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/NMertsch">@NMertsch</a> on 2024-03-07 16:52</div>
            <div class="timeline-body"><blockquote>
<p>In the meantime, don't hate me but if you're blocked, I might suggest installing Python from the python.org installers?</p>
</blockquote>
<p>I'm not blocked, but thank for once again for the amazing user experience (with ruff, uv, and GitHub Issues ðŸ˜…)! It's highly appreciated.</p>
<p>If I can help with anything (e.g. run some commands, test pre-release builds), please let me know.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-07 16:53</div>
            <div class="timeline-body"><p>I'm now able to reproduce on my machine, I think!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-03-07 16:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-07 17:58</div>
            <div class="timeline-body"><p>The main issue is I can't figure out a reliable way to determine if the <code>python.exe</code> or <code>python3.exe</code> is a redirect to the Windows Store. <code>CreateFileW</code> is returning <code>INVALID_HANDLE_VALUE</code> for one of the two redirectors when trying to read the reparse point.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-03-07 20:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zooba">@zooba</a> on 2024-03-07 22:27</div>
            <div class="timeline-body"><blockquote>
<p>I think the issue is that we ignore the Windows Store paths (like <code>C:\Users\nme\AppData\Local\Microsoft\WindowsApps\python3.7.exe</code>) when looking at <code>$PATH</code>, and instead rely on <code>py --list-paths</code> to give us the &quot;real&quot; interpreters, which instead look like <code>C:\Users\nme\AppData\Local\Microsoft\WindowsApps\PythonSoftwareFoundation.Python.3.9_qbz5n2kfra8p0\python.exe</code>.</p>
</blockquote>
<p>So the difference here is that the shorter path only exists when the user has configured it to be a global alias, while the latter will always be present whenever the app is installed. You could search ``C:\Users\nme\AppData\Local\Microsoft\WindowsApps\PythonSoftwareFoundation.*`, since nobody else can use that publisher name, or code in the full package name. The hash at the end is stable, however if we ever release the standalone MSIX installers then the hash will be different for those (it's essentially based on the code signing certificate used, which doesn't change for the Store, but would change every few years for the standalone one).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zooba">@zooba</a> on 2024-03-07 22:30</div>
            <div class="timeline-body"><p>Also, if you're only looking at the longer paths, you'll never find the redirector stub. However, if you've found it from a PATH search and want to check, the way we do it in py.exe is in these two sections:</p>
<p>https://github.com/python/cpython/blob/5d0cdfe519e6f35ccae1a1adca1ffd7fac10cee0/PC/launcher2.c#L576-L588</p>
<p>https://github.com/python/cpython/blob/5d0cdfe519e6f35ccae1a1adca1ffd7fac10cee0/PC/launcher2.c#L781-L827</p>
<p>(Uses undocumented stuff, but should be stable enough. If anything here changes, then realistically the launcher is going to be significantly changed and probably more stuff needs to change as well.)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:24:16 UTC
    </footer>
</body>
</html>
