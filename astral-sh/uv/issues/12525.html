<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>concurrent `uv run` is very slow even with cache - astral-sh/uv #12525</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>concurrent <code>uv run</code> is very slow even with cache</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/12525">#12525</a>
        opened by <a href="https://github.com/terrykong">@terrykong</a>
        on 2025-03-28 06:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/terrykong">@terrykong</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Hi team. I've been playing around with <code>ray</code>'s new <a href="https://www.anyscale.com/blog/uv-ray-pain-free-python-dependencies-in-clusters">uv+ray integration</a> and I've been unable to figure out why <code>uv</code> is so slow when there are many concurrent actors launched on a ray cluster.</p>
<p>Here is a simple script I've been using to benchmark creating multiple <code>.venv</code>s which is my best guess of what's happening on the ray cluster:</p>
<pre><code class="language-sh">#!/bin/bash

SCRIPT_DIR=$(cd &quot;$(dirname &quot;${BASH_SOURCE[0]}&quot;)&quot; &amp;&amp; pwd)
cd $SCRIPT_DIR

if [[ ! -f /usr/bin/time ]]; then
  apt update &amp;&amp; apt install -y time
fi

echo &quot;Cleaning up workspaces&quot;
find workspaces -type d -exec rm -rf {} + 2&gt;/dev/null || rm -rf workspaces
mkdir -p workspaces

N=1
foobar() {
for i in $(seq 1 $N); do
    # Create a temporary directory for this iteration
    TEMP_DIR=&quot;${SCRIPT_DIR}/workspaces/${i}&quot;
    mkdir -p &quot;$TEMP_DIR&quot;
    cd &quot;$TEMP_DIR&quot;
    rsync -ah $SCRIPT_DIR/pyproject.toml $SCRIPT_DIR/uv.lock $SCRIPT_DIR/foobar $TEMP_DIR/
    uv venv
    /usr/bin/time -v uv run -v echo helloworld 2&gt;&amp;1 | while IFS= read -r line; do echo &quot;[$(date '+%Y-%m-%d %H:%M:%S')] $line&quot;; done | tee $SCRIPT_DIR/workspaces/log-$i &amp;
done

echo waiting....
wait
}
export -f foobar

time foobar 2&gt;&amp;1 | tee $SCRIPT_DIR/workspaces/log
echo &quot;done!&quot;

echo cleaning up...
for i in $(seq 1 $N); do
    ( rm -rf $SCRIPT_DIR/workspaces/${i} ; echo deleted $i ) &amp;
done
echo 'waiting.... for cleanup'
wait
echo 'alllll done'
</code></pre>
<p>When I run with <code>N=1</code> it takes about 3.72 seconds to execute the <code>uv run</code> command, but when I set <code>N=32</code> all the <code>uv run</code>s take about 56 seconds to run which seems to suggest they are all waiting on something? The debug logs also show a large pause here (between <code>23:12:47</code> and <code> 23:13:28</code>):</p>
<pre><code>[2025-03-27 23:12:44] DEBUG File already exists (initial attempt), overwriting: /test-workspaces/workspa
ces/21/.venv/lib/python3.12/site-packages/nvidia/__init__.py
[2025-03-27 23:12:44] DEBUG File already exists (subsequent attempt), overwriting: /test-workspaces/work
spaces/21/.venv/lib/python3.12/site-packages/nvidia/__init__.py
[2025-03-27 23:12:47] DEBUG File already exists (subsequent attempt), overwriting: /test-workspaces/work
spaces/21/.venv/lib/python3.12/site-packages/opencensus/common/__init__.py
[2025-03-27 23:13:28] Installed 149 packages in 51.85s
[2025-03-27 23:13:28]  + aiohappyeyeballs==2.6.1
[2025-03-27 23:13:28]  + aiohttp==3.11.14
</code></pre>
<p>Here is the pyproject.toml for this dummy <code>foobar</code> package:</p>
<pre><code class="language-toml">[build-system]
requires = [&quot;setuptools&gt;=42&quot;, &quot;wheel&quot;]
build-backend = &quot;setuptools.build_meta&quot;

[project]
name = &quot;foobar&quot;
requires-python = &quot;&gt;=3.10&quot;
version = &quot;0.0.1&quot;
dependencies = [
&quot;torch==2.6.0&quot;,
&quot;transformers&quot;,
&quot;vllm&quot;,
&quot;ray[default]==2.43.0&quot;,
]

[tool.setuptools]
packages = [&quot;foobar&quot;]

[project.optional-dependencies]
emoji = [
    &quot;emoji&quot;,
]
pyfiglet = [
    &quot;pyfiglet&quot;,
]

# NOTE: using symlink b/c ray temp-dir is on diff file system than uv-cache
[tool.uv]
link-mode = &quot;symlink&quot;
</code></pre>
<p>I'm very interested in using <code>uv</code> with ray, but the user experience for folks launching with ray isn't ideal since it takes minutes to just start the job despite having all the dependencies available in the uv cache.</p>
<p>Is this performance expected?</p>
<h3>Platform</h3>
<p>Ubuntu 22.04.5 LTS (Jammy Jellyfish)</p>
<h3>Version</h3>
<p>uv 0.6.8</p>
<h3>Python version</h3>
<p>Python 3.12.9</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @terrykong on 2025-03-28 06:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-28 19:18</div>
            <div class="timeline-body"><p>Are you sure it's not just contention on your machine from running 32 tasks in parallel? (Also, if you already have a lockfile, you probably want to be using <code>--frozen</code> there.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/terrykong">@terrykong</a> on 2025-03-28 20:52</div>
            <div class="timeline-body"><p>@charliermarsh Thanks for the <code>--frozen</code> tip, setting it does seem to make things a tiny bit better, but still has this large pause.</p>
<p>Regarding the contention, does the performance I observe match your expectations? Conceptually if I symlink the packages required to build a venv assuming everything is cached, shouldn't this be much quicker? Is there something about how <code>uv</code> is implemented that causes this contention?</p>
<p><img width="1141" alt="Image" src="https://github.com/user-attachments/assets/858b5f48-e1ea-4b6d-af49-6a0788885c32" />
I did notice quite a bit of context switches even running one <code>uv run</code> (left is running 1; right is running 10 in parallel)</p>
<p>FWIW, the ray docs have this simple example:</p>
<pre><code class="language-python">import emoji
import ray

@ray.remote
def f():
    return emoji.emojize('Python is :thumbs_up:')
# Execute 1000 copies of f across a cluster.

print(ray.get([f.remote() for _ in range(1000)]))
</code></pre>
<p>which is actually much worse than my example (1000 venvs...) assuming the same dependencies (which are common for ML applications)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-28 20:57</div>
            <div class="timeline-body"><blockquote>
<p>Regarding the contention, does the performance I observe match your expectations?</p>
</blockquote>
<p>Hmm, not really. There's nothing in uv that should be causing this. It should just be linking from the cache into the various environments. I can try to take a closer look at another time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @charliermarsh on 2025-03-28 20:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2025-03-28 20:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @charliermarsh on 2025-03-28 20:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/terrykong">@terrykong</a> on 2025-03-28 21:03</div>
            <div class="timeline-body"><p>Thanks, much appreciated! If there's any other data points that I can gather that would help, please let me know</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @zanieb on 2025-04-01 22:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:30:40 UTC
    </footer>
</body>
</html>
