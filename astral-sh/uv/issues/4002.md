```yaml
number: 4002
title: Marker expressions in lockfile should be simplified
type: issue
state: closed
author: charliermarsh
labels:
  - preview
assignees: []
created_at: 2024-06-03T23:28:17Z
updated_at: 2024-06-07T20:14:25Z
url: https://github.com/astral-sh/uv/issues/4002
synced_at: 2026-01-10T01:57:08Z
```

# Marker expressions in lockfile should be simplified

---

_Issue opened by @charliermarsh on 2024-06-03 23:28_

Not certain on this but in https://github.com/astral-sh/uv/pull/3998, the test I added yields an entry in the lockfile like:

```toml
[[distribution]]
name = "typing-extensions"
version = "4.7.1"
source = "registry+https://pypi.org/simple"
marker = "python_version < '3.8' or python_version < '3.11'"
```

The marker can be simplified to `python_version < '3.8'`.


---

_Label `preview` added by @charliermarsh on 2024-06-03 23:28_

---

_Comment by @pplmx on 2024-06-04 06:09_

Hi, @charliermarsh 

I am not familiar with the marker, but only from the above content
>
> python_version < '3.8' or python_version < '3.11'
>

==>

>
> python_version < '3.8'
>

The condition has become `more stringent`. Now, it only requires that the Python version be less than 3.8.
Is this what we need?

---

_Comment by @charliermarsh on 2024-06-04 13:28_

Sorry yes, the final condition should be `python_version < '3.11'` -- it's `python_version < '3.8'` that's redundant.

---

_Comment by @charliermarsh on 2024-06-04 13:35_

It's also possible that this is something that's supposed to be solved during resolution.

---

_Comment by @ibraheemdev on 2024-06-04 14:53_

I don't think we need to do this during resolution - the redundant expressions don't get in the way, it only matters when we write the output to the lock file.

---

_Assigned to @ibraheemdev by @ibraheemdev on 2024-06-04 14:53_

---

_Comment by @BurntSushi on 2024-06-04 17:24_

@ibraheemdev You might consider approaching this using "smart constructors." That is, you guarantee that a `MarkerTree` is, by construction, as simple as possible. This approach means there is no separate recursive pass to do simplification. It just happens inductively as part of construction.

The downside of this is that it generally requires making it impossible to build a `MarkerTree` using standard enum variants. Instead, well, you have to use the smart constructors. You can still expose a read-only enum for easy case analysis.

I've used this pattern in `regex-syntax::hir` and I've been very happy with it.

---

_Referenced in [astral-sh/uv#4066](../../astral-sh/uv/pulls/4066.md) on 2024-06-05 19:43_

---

_Closed by @ibraheemdev on 2024-06-07 20:14_

---
