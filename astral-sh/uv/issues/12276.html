<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validate locked versions against constraints in lock file - astral-sh/uv #12276</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Validate locked versions against constraints in lock file</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/12276">#12276</a>
        opened by <a href="https://github.com/rg936672">@rg936672</a>
        on 2025-03-18 12:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/rg936672">@rg936672</a> on 2025-03-18 12:15</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>If <code>uv.lock</code> has locked a version that is incompatible with <code>pyproject.toml</code>, then <code>uv lock</code> and <code>uv sync</code> don't detect the incompatibility. However, <code>uv.lock</code> does record the version constraints from <code>pyproject.toml</code> - it should be fairly straightforward to check that all locked versions satisfy the constraints in the lockfile before using it.</p>
<p>Running <code>uv lock --upgrade</code> or <code>rm uv.lock; uv lock</code> fixes the lockfile, but ideally this should be caught as an invalid lockfile rather than passing silently as it does currently.</p>
<hr />
<p>Here's a minimal reproduction of the problem, which can be caused by someone erroneously trying to manually resolve a merge conflict in uv.lock:</p>
<details>
<summary>Example files</summary>

<h3>pyproject.toml</h3>
<pre><code class="language-toml">[project]
name = &quot;my_package&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = [
    &quot;numpy!=2.2.4&quot;,
]
</code></pre>
<h3>.python-version</h3>
<pre><code>3.12
</code></pre>
<h3>uv.lock</h3>
<pre><code class="language-toml">version = 1
revision = 1
requires-python = &quot;&gt;=3.12&quot;

[[package]]
name = &quot;my-package&quot;
version = &quot;0.1.0&quot;
source = { virtual = &quot;.&quot; }
dependencies = [
    { name = &quot;numpy&quot; },
]

[package.metadata]
requires-dist = [{ name = &quot;numpy&quot;, specifier = &quot;!=2.2.4&quot; }]

[[package]]
name = &quot;numpy&quot;
version = &quot;2.2.4&quot;
source = { registry = &quot;https://pypi.org/simple&quot; }
sdist = { url = &quot;https://files.pythonhosted.org/packages/e1/78/31103410a57bc2c2b93a3597340a8119588571f6a4539067546cb9a0bfac/numpy-2.2.4.tar.gz&quot;, hash = &quot;sha256:9ba03692a45d3eef66559efe1d1096c4b9b75c0986b5dff5530c378fb8331d4f&quot;, size = 20270701 }
wheels = [
    { url = &quot;https://files.pythonhosted.org/packages/a2/30/182db21d4f2a95904cec1a6f779479ea1ac07c0647f064dea454ec650c42/numpy-2.2.4-cp312-cp312-macosx_10_13_x86_64.whl&quot;, hash = &quot;sha256:a7b9084668aa0f64e64bd00d27ba5146ef1c3a8835f3bd912e7a9e01326804c4&quot;, size = 20947156 },
    { url = &quot;https://files.pythonhosted.org/packages/24/6d/9483566acfbda6c62c6bc74b6e981c777229d2af93c8eb2469b26ac1b7bc/numpy-2.2.4-cp312-cp312-macosx_11_0_arm64.whl&quot;, hash = &quot;sha256:dbe512c511956b893d2dacd007d955a3f03d555ae05cfa3ff1c1ff6df8851854&quot;, size = 14133092 },
    { url = &quot;https://files.pythonhosted.org/packages/27/f6/dba8a258acbf9d2bed2525cdcbb9493ef9bae5199d7a9cb92ee7e9b2aea6/numpy-2.2.4-cp312-cp312-macosx_14_0_arm64.whl&quot;, hash = &quot;sha256:bb649f8b207ab07caebba230d851b579a3c8711a851d29efe15008e31bb4de24&quot;, size = 5163515 },
    { url = &quot;https://files.pythonhosted.org/packages/62/30/82116199d1c249446723c68f2c9da40d7f062551036f50b8c4caa42ae252/numpy-2.2.4-cp312-cp312-macosx_14_0_x86_64.whl&quot;, hash = &quot;sha256:f34dc300df798742b3d06515aa2a0aee20941c13579d7a2f2e10af01ae4901ee&quot;, size = 6696558 },
    { url = &quot;https://files.pythonhosted.org/packages/0e/b2/54122b3c6df5df3e87582b2e9430f1bdb63af4023c739ba300164c9ae503/numpy-2.2.4-cp312-cp312-manylinux_2_17_aarch64.manylinux2014_aarch64.whl&quot;, hash = &quot;sha256:c3f7ac96b16955634e223b579a3e5798df59007ca43e8d451a0e6a50f6bfdfba&quot;, size = 14084742 },
    { url = &quot;https://files.pythonhosted.org/packages/02/e2/e2cbb8d634151aab9528ef7b8bab52ee4ab10e076509285602c2a3a686e0/numpy-2.2.4-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl&quot;, hash = &quot;sha256:4f92084defa704deadd4e0a5ab1dc52d8ac9e8a8ef617f3fbb853e79b0ea3592&quot;, size = 16134051 },
    { url = &quot;https://files.pythonhosted.org/packages/8e/21/efd47800e4affc993e8be50c1b768de038363dd88865920439ef7b422c60/numpy-2.2.4-cp312-cp312-musllinux_1_2_aarch64.whl&quot;, hash = &quot;sha256:7a4e84a6283b36632e2a5b56e121961f6542ab886bc9e12f8f9818b3c266bfbb&quot;, size = 15578972 },
    { url = &quot;https://files.pythonhosted.org/packages/04/1e/f8bb88f6157045dd5d9b27ccf433d016981032690969aa5c19e332b138c0/numpy-2.2.4-cp312-cp312-musllinux_1_2_x86_64.whl&quot;, hash = &quot;sha256:11c43995255eb4127115956495f43e9343736edb7fcdb0d973defd9de14cd84f&quot;, size = 17898106 },
    { url = &quot;https://files.pythonhosted.org/packages/2b/93/df59a5a3897c1f036ae8ff845e45f4081bb06943039ae28a3c1c7c780f22/numpy-2.2.4-cp312-cp312-win32.whl&quot;, hash = &quot;sha256:65ef3468b53269eb5fdb3a5c09508c032b793da03251d5f8722b1194f1790c00&quot;, size = 6311190 },
    { url = &quot;https://files.pythonhosted.org/packages/46/69/8c4f928741c2a8efa255fdc7e9097527c6dc4e4df147e3cadc5d9357ce85/numpy-2.2.4-cp312-cp312-win_amd64.whl&quot;, hash = &quot;sha256:2aad3c17ed2ff455b8eaafe06bcdae0062a1db77cb99f4b9cbb5f4ecb13c5146&quot;, size = 12644305 },
    { url = &quot;https://files.pythonhosted.org/packages/2a/d0/bd5ad792e78017f5decfb2ecc947422a3669a34f775679a76317af671ffc/numpy-2.2.4-cp313-cp313-macosx_10_13_x86_64.whl&quot;, hash = &quot;sha256:1cf4e5c6a278d620dee9ddeb487dc6a860f9b199eadeecc567f777daace1e9e7&quot;, size = 20933623 },
    { url = &quot;https://files.pythonhosted.org/packages/c3/bc/2b3545766337b95409868f8e62053135bdc7fa2ce630aba983a2aa60b559/numpy-2.2.4-cp313-cp313-macosx_11_0_arm64.whl&quot;, hash = &quot;sha256:1974afec0b479e50438fc3648974268f972e2d908ddb6d7fb634598cdb8260a0&quot;, size = 14148681 },
    { url = &quot;https://files.pythonhosted.org/packages/6a/70/67b24d68a56551d43a6ec9fe8c5f91b526d4c1a46a6387b956bf2d64744e/numpy-2.2.4-cp313-cp313-macosx_14_0_arm64.whl&quot;, hash = &quot;sha256:79bd5f0a02aa16808fcbc79a9a376a147cc1045f7dfe44c6e7d53fa8b8a79392&quot;, size = 5148759 },
    { url = &quot;https://files.pythonhosted.org/packages/1c/8b/e2fc8a75fcb7be12d90b31477c9356c0cbb44abce7ffb36be39a0017afad/numpy-2.2.4-cp313-cp313-macosx_14_0_x86_64.whl&quot;, hash = &quot;sha256:3387dd7232804b341165cedcb90694565a6015433ee076c6754775e85d86f1fc&quot;, size = 6683092 },
    { url = &quot;https://files.pythonhosted.org/packages/13/73/41b7b27f169ecf368b52533edb72e56a133f9e86256e809e169362553b49/numpy-2.2.4-cp313-cp313-manylinux_2_17_aarch64.manylinux2014_aarch64.whl&quot;, hash = &quot;sha256:6f527d8fdb0286fd2fd97a2a96c6be17ba4232da346931d967a0630050dfd298&quot;, size = 14081422 },
    { url = &quot;https://files.pythonhosted.org/packages/4b/04/e208ff3ae3ddfbafc05910f89546382f15a3f10186b1f56bd99f159689c2/numpy-2.2.4-cp313-cp313-manylinux_2_17_x86_64.manylinux2014_x86_64.whl&quot;, hash = &quot;sha256:bce43e386c16898b91e162e5baaad90c4b06f9dcbe36282490032cec98dc8ae7&quot;, size = 16132202 },
    { url = &quot;https://files.pythonhosted.org/packages/fe/bc/2218160574d862d5e55f803d88ddcad88beff94791f9c5f86d67bd8fbf1c/numpy-2.2.4-cp313-cp313-musllinux_1_2_aarch64.whl&quot;, hash = &quot;sha256:31504f970f563d99f71a3512d0c01a645b692b12a63630d6aafa0939e52361e6&quot;, size = 15573131 },
    { url = &quot;https://files.pythonhosted.org/packages/a5/78/97c775bc4f05abc8a8426436b7cb1be806a02a2994b195945600855e3a25/numpy-2.2.4-cp313-cp313-musllinux_1_2_x86_64.whl&quot;, hash = &quot;sha256:81413336ef121a6ba746892fad881a83351ee3e1e4011f52e97fba79233611fd&quot;, size = 17894270 },
    { url = &quot;https://files.pythonhosted.org/packages/b9/eb/38c06217a5f6de27dcb41524ca95a44e395e6a1decdc0c99fec0832ce6ae/numpy-2.2.4-cp313-cp313-win32.whl&quot;, hash = &quot;sha256:f486038e44caa08dbd97275a9a35a283a8f1d2f0ee60ac260a1790e76660833c&quot;, size = 6308141 },
    { url = &quot;https://files.pythonhosted.org/packages/52/17/d0dd10ab6d125c6d11ffb6dfa3423c3571befab8358d4f85cd4471964fcd/numpy-2.2.4-cp313-cp313-win_amd64.whl&quot;, hash = &quot;sha256:207a2b8441cc8b6a2a78c9ddc64d00d20c303d79fba08c577752f080c4007ee3&quot;, size = 12636885 },
    { url = &quot;https://files.pythonhosted.org/packages/fa/e2/793288ede17a0fdc921172916efb40f3cbc2aa97e76c5c84aba6dc7e8747/numpy-2.2.4-cp313-cp313t-macosx_10_13_x86_64.whl&quot;, hash = &quot;sha256:8120575cb4882318c791f839a4fd66161a6fa46f3f0a5e613071aae35b5dd8f8&quot;, size = 20961829 },
    { url = &quot;https://files.pythonhosted.org/packages/3a/75/bb4573f6c462afd1ea5cbedcc362fe3e9bdbcc57aefd37c681be1155fbaa/numpy-2.2.4-cp313-cp313t-macosx_11_0_arm64.whl&quot;, hash = &quot;sha256:a761ba0fa886a7bb33c6c8f6f20213735cb19642c580a931c625ee377ee8bd39&quot;, size = 14161419 },
    { url = &quot;https://files.pythonhosted.org/packages/03/68/07b4cd01090ca46c7a336958b413cdbe75002286295f2addea767b7f16c9/numpy-2.2.4-cp313-cp313t-macosx_14_0_arm64.whl&quot;, hash = &quot;sha256:ac0280f1ba4a4bfff363a99a6aceed4f8e123f8a9b234c89140f5e894e452ecd&quot;, size = 5196414 },
    { url = &quot;https://files.pythonhosted.org/packages/a5/fd/d4a29478d622fedff5c4b4b4cedfc37a00691079623c0575978d2446db9e/numpy-2.2.4-cp313-cp313t-macosx_14_0_x86_64.whl&quot;, hash = &quot;sha256:879cf3a9a2b53a4672a168c21375166171bc3932b7e21f622201811c43cdd3b0&quot;, size = 6709379 },
    { url = &quot;https://files.pythonhosted.org/packages/41/78/96dddb75bb9be730b87c72f30ffdd62611aba234e4e460576a068c98eff6/numpy-2.2.4-cp313-cp313t-manylinux_2_17_aarch64.manylinux2014_aarch64.whl&quot;, hash = &quot;sha256:f05d4198c1bacc9124018109c5fba2f3201dbe7ab6e92ff100494f236209c960&quot;, size = 14051725 },
    { url = &quot;https://files.pythonhosted.org/packages/00/06/5306b8199bffac2a29d9119c11f457f6c7d41115a335b78d3f86fad4dbe8/numpy-2.2.4-cp313-cp313t-manylinux_2_17_x86_64.manylinux2014_x86_64.whl&quot;, hash = &quot;sha256:e2f085ce2e813a50dfd0e01fbfc0c12bbe5d2063d99f8b29da30e544fb6483b8&quot;, size = 16101638 },
    { url = &quot;https://files.pythonhosted.org/packages/fa/03/74c5b631ee1ded596945c12027649e6344614144369fd3ec1aaced782882/numpy-2.2.4-cp313-cp313t-musllinux_1_2_aarch64.whl&quot;, hash = &quot;sha256:92bda934a791c01d6d9d8e038363c50918ef7c40601552a58ac84c9613a665bc&quot;, size = 15571717 },
    { url = &quot;https://files.pythonhosted.org/packages/cb/dc/4fc7c0283abe0981e3b89f9b332a134e237dd476b0c018e1e21083310c31/numpy-2.2.4-cp313-cp313t-musllinux_1_2_x86_64.whl&quot;, hash = &quot;sha256:ee4d528022f4c5ff67332469e10efe06a267e32f4067dc76bb7e2cddf3cd25ff&quot;, size = 17879998 },
    { url = &quot;https://files.pythonhosted.org/packages/e5/2b/878576190c5cfa29ed896b518cc516aecc7c98a919e20706c12480465f43/numpy-2.2.4-cp313-cp313t-win32.whl&quot;, hash = &quot;sha256:05c076d531e9998e7e694c36e8b349969c56eadd2cdcd07242958489d79a7286&quot;, size = 6366896 },
    { url = &quot;https://files.pythonhosted.org/packages/3e/05/eb7eec66b95cf697f08c754ef26c3549d03ebd682819f794cb039574a0a6/numpy-2.2.4-cp313-cp313t-win_amd64.whl&quot;, hash = &quot;sha256:188dcbca89834cc2e14eb2f106c96d6d46f200fe0200310fc29089657379c58d&quot;, size = 12739119 },
]
</code></pre>
</details>

<p>Given the files above, we have</p>
<pre><code class="language-shell">&gt; uv --version
uv 0.6.7 (029b9e1fc 2025-03-17)
&gt; uv lock --check
Resolved 2 packages in 1ms
&gt; uv sync
Resolved 2 packages in 1ms
Prepared 1 package in 853ms
Installed 1 package in 224ms
 + numpy==2.2.4
</code></pre>
<p>Note that we get <code>numpy==2.2.4</code>, despite the fact that we explicitly specify <code>numpy!=2.2.4</code> in <code>pyproject.toml</code>!</p>
<p>This invalid lockfile thankfully doesn't seem to appear organically - but it might be created as the result of manually resolving a Git merge conflict. However, once the invalid lockfile is there, it silently gives erroneous results.</p>
<h4>Suggested resolution</h4>
<p>Ideally, uv would check that the locked version of numpy (2.2.4) satisfies any constraints in the lockfile, such as the one in <code>packages[0].metadata</code> specifying <code>numpy!=2.2.4</code>. Given that we are just checking version constraints (and erroring out if any don't match) rather than performing any kind of solve, this should be straightforward to implement and should not present a performance hit. Additionally, this shouldn't ever affect a valid (uv-created) lockfile, only ones that have been modified by something other than uv.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @rg936672 on 2025-03-18 12:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-18 13:46</div>
            <div class="timeline-body"><p>If the lockfile is edited outside of uv, we don't make any guarantees about keeping it in-sync with the <code>pyproject.toml</code>. Are you running Dependabot? See: #12254.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rg936672">@rg936672</a> on 2025-03-18 14:17</div>
            <div class="timeline-body"><p>We're not using Dependabot on this particular project. On further investigation, the error was in fact introduced as part of a Git merge conflict resolution. Do you know of a recommended way to avoid this happening in future beyond just telling everyone on the team not to try and do manual resolution on <code>uv.lock</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-03-18 14:22</div>
            <div class="timeline-body"><p>We're trying to add more validations like #12235 to catch this, but yeah in general not trying to conflict-resolve locks is a good policy.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rg936672">@rg936672</a> on 2025-03-18 14:22</div>
            <div class="timeline-body"><p>Does it make sense to raise a separate feature request of &quot;validate that the package versions in <code>uv.lock</code> satisfy all the constraints listed in the <code>uv.lock</code> before using them&quot; then? That seems at a glance like something that would be fairly straightforward to implement, would be very quick as just a sequence of SemVer checks, and would prevent this kind of thing in future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">lock</span> added by @Gankra on 2025-03-18 15:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @Gankra on 2025-03-18 15:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @Gankra on 2025-03-18 15:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-03-18 15:22</div>
            <div class="timeline-body"><p>Yeah I think we'd be happy to accept this kind of improvement, especially if it's as straight-forward as you suggest.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "`uv lock` doesn't detect incompatible locked version" to "Validate locked versions against constraints in lock file" by @rg936672 on 2025-03-18 15:24</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:26 UTC
    </footer>
</body>
</html>
