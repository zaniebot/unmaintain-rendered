<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv `--no-compile-bytecode` seems to have no effect in Docker build - astral-sh/uv #7696</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>uv `--no-compile-bytecode` seems to have no effect in Docker build</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/7696">#7696</a>
        opened by <a href="https://github.com/akx">@akx</a>
        on 2024-09-26 07:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/akx">@akx</a> on 2024-09-26 07:09</div>
            <div class="timeline-body"><p>Given a minimal Dockerfile</p>
<pre><code>FROM ghcr.io/astral-sh/uv:0.4.16-python3.12-bookworm-slim
RUN find / -name '*.pyc' | wc -l
RUN uv pip install --system --no-compile-bytecode --no-cache-dir hai
RUN find / -name '*.pyc' | wc -l
</code></pre>
<p>and building it:</p>
<pre><code>$ env BUILDKIT_PROGRESS=plain docker build .
#0 building with &quot;default&quot; instance using docker driver

#1 [internal] load build definition from Dockerfile
#1 transferring dockerfile: 269B done
#1 DONE 0.0s

#2 [internal] load metadata for ghcr.io/astral-sh/uv:0.4.16-python3.12-bookworm-slim
#2 DONE 0.9s

#3 [internal] load .dockerignore
#3 transferring context: 2B done
#3 DONE 0.0s

#4 [1/4] FROM ghcr.io/astral-sh/uv:0.4.16-python3.12-bookworm-slim@sha256:cdb69914e2b70a8c0c8a01af28780bfe6c1b5fad2167207b7da5f328b3f8cc0f
#4 resolve ghcr.io/astral-sh/uv:0.4.16-python3.12-bookworm-slim@sha256:cdb69914e2b70a8c0c8a01af28780bfe6c1b5fad2167207b7da5f328b3f8cc0f done
[...]
#4 DONE 1.7s

#5 [2/4] RUN find / -name '*.pyc' | wc -l
#5 0.111 0
#5 DONE 0.2s

#6 [3/4] RUN uv pip install --system --no-compile-bytecode --no-cache-dir hai
#6 0.273 Resolved 1 package in 87ms
#6 0.287 Prepared 1 package in 13ms
#6 0.288 Installed 1 package in 0.42ms
#6 0.288  + hai==0.3.0
#6 DONE 0.3s

#7 [4/4] RUN find / -name '*.pyc' | wc -l
#7 0.125 35
#7 DONE 0.1s

#8 exporting to image
#8 exporting layers 0.0s done
#8 writing image sha256:4685627209911f9fe7de6f8993524824553cc4e59c15cd1097f56cc38736a360 done
#8 DONE 0.0s
</code></pre>
<p>See steps 5 and 8 â€“ there were zero <code>pyc</code> files in the container to begin with, after <code>uv pip install --system --no-compile-bytecode</code> there were 35.</p>
<ul>
<li><code>--no-compile-bytecode</code> isn't actually documented either, but <a href="https://docs.astral.sh/uv/reference/settings/#compile-bytecode"><code>compile-bytecode</code></a> is documented to be false by default, so I shouldn't be getting <code>.pyc</code>s anyhow?</li>
<li>Setting <code>PYTHONDONTWRITEBYTECODE=1</code> doesn't have an effect (not that I expected it to).</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-09-26 11:34</div>
            <div class="timeline-body"><p>These files are created earlier then installation and bytecode compilation, they are created during interpreter discovery: uv runs a small script to collect information on the Python interpreter, such which wheel tags it supports. This script runs with <code>-I</code> (https://github.com/astral-sh/uv/pull/2552), so it ignores <code>PYTHONDONTWRITEBYTECODE</code> and other <code>PYTHON*</code> options. This way Python bytecode compiles the parts of std that are used by the script.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @konstin on 2024-09-26 11:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akx">@akx</a> on 2024-09-26 12:30</div>
            <div class="timeline-body"><p>Huh. That seems to imply that there is, at present, no way to actually have no <code>.pyc</code> files get created? ðŸ˜•</p>
<p>EDIT: https://github.com/astral-sh/uv/pull/7707 :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/7707.html">astral-sh/uv#7707</a> on 2024-09-26 12:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2024-09-26 13:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/10773.html">astral-sh/uv#10773</a> on 2025-01-20 08:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/11178.html">astral-sh/uv#11178</a> on 2025-02-11 19:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:22 UTC
    </footer>
</body>
</html>
