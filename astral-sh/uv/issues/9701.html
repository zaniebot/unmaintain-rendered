<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explaining odd behavior with dependency locking and installation. - astral-sh/uv #9701</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Explaining odd behavior with dependency locking and installation.</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/9701">#9701</a>
        opened by <a href="https://github.com/NellyWhads">@NellyWhads</a>
        on 2024-12-07 02:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/NellyWhads">@NellyWhads</a></div>
            <div class="timeline-body"><p>When using the following pyproject.toml, I get some weird behavior:</p>
pyptoject.toml
<p>

<pre><code>[project]
name = &quot;dep-test&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.8,&lt;3.13&quot;

[tool.uv]
environments = [&quot;platform_system == &#x27;Linux&#x27;&quot;, &quot;platform_system == &#x27;Darwin&#x27;&quot;]
# Conflicting groups specified at the project level
conflicts = [[{ group = &quot;mmcv21_torch21&quot; }, { group = &quot;mmcv22_torch24&quot; }]]
# Repo-wide constraints
constraint-dependencies = [
  &quot;torch&gt;=2.1,&lt;2.5&quot;,
  &quot;torchvision&gt;=0.16,&lt;0.20&quot;,
  &quot;mmcv&gt;=2.1,&lt;2.3&quot;,
]

[dependency-groups]
my_group = [&quot;torch&quot;, &quot;torchvision&quot;]
mmcv21_torch21 = [
  &quot;mmcv~=2.1.0 ; platform_system == &#x27;Linux&#x27; and python_version &gt;= &#x27;3.8&#x27; and python_version &lt; &#x27;3.12&#x27;&quot;,
  # Specific dependencies which are not encoded in the wheel
  &quot;torch~=2.1.0&quot;,
  &quot;torchvision~=0.16.0&quot;,
  &quot;setuptools&quot;,
]
mmcv22_torch24 = [
  &quot;mmcv~=2.2.0 ; platform_system == &#x27;Linux&#x27; and python_version &gt;= &#x27;3.8&#x27; and python_version &lt; &#x27;3.13&#x27;&quot;,
  # Specific dependencies which are not encoded in the wheel
  &quot;torch~=2.4.0&quot;,
  &quot;torchvision~=0.19.0&quot;,
  &quot;setuptools&quot;,
]

[tool.uv.sources]
torch = [{ index = &quot;torch-cu118&quot;, marker = &quot;platform_system == &#x27;Linux&#x27;&quot; }]
torchvision = [{ index = &quot;torch-cu118&quot;, marker = &quot;platform_system == &#x27;Linux&#x27;&quot; }]
mmcv = [
  # mmcv 2.1.0, torch 2.1.x
  { group = &quot;mmcv21_torch21&quot;, marker = &quot;platform_system == &#x27;Linux&#x27; and python_version &gt;= &#x27;3.8&#x27; and python_version &lt; &#x27;3.9&#x27;&quot;, url = &quot;https://download.openmmlab.com/mmcv/dist/cu118/torch2.1.0/mmcv-2.1.0-cp38-cp38-manylinux1_x86_64.whl&quot; },
  { group = &quot;mmcv21_torch21&quot;, marker = &quot;platform_system == &#x27;Linux&#x27; and python_version &gt;= &#x27;3.9&#x27; and python_version &lt; &#x27;3.10&#x27;&quot;, url = &quot;https://download.openmmlab.com/mmcv/dist/cu118/torch2.1.0/mmcv-2.1.0-cp39-cp39-manylinux1_x86_64.whl&quot; },
  { group = &quot;mmcv21_torch21&quot;, marker = &quot;platform_system == &#x27;Linux&#x27; and python_version &gt;= &#x27;3.10&#x27; and python_version &lt; &#x27;3.11&#x27;&quot;, url = &quot;https://download.openmmlab.com/mmcv/dist/cu118/torch2.1.0/mmcv-2.1.0-cp310-cp310-manylinux1_x86_64.whl&quot; },
  { group = &quot;mmcv21_torch21&quot;, marker = &quot;platform_system == &#x27;Linux&#x27; and python_version &gt;= &#x27;3.11&#x27; and python_version &lt; &#x27;3.12&#x27;&quot;, url = &quot;https://download.openmmlab.com/mmcv/dist/cu118/torch2.1.0/mmcv-2.1.0-cp311-cp311-manylinux1_x86_64.whl&quot; },
  # mmcv 2.2.0, torch 2.4.x
  { group = &quot;mmcv22_torch24&quot;, marker = &quot;platform_system == &#x27;Linux&#x27; and python_version &gt;= &#x27;3.8&#x27; and python_version &lt; &#x27;3.9&#x27;&quot;, url = &quot;https://download.openmmlab.com/mmcv/dist/cu118/torch2.4.0/mmcv-2.2.0-cp38-cp38-manylinux1_x86_64.whl&quot; },
  { group = &quot;mmcv22_torch24&quot;, marker = &quot;platform_system == &#x27;Linux&#x27; and python_version &gt;= &#x27;3.9&#x27; and python_version &lt; &#x27;3.10&#x27;&quot;, url = &quot;https://download.openmmlab.com/mmcv/dist/cu118/torch2.4.0/mmcv-2.2.0-cp39-cp39-manylinux1_x86_64.whl&quot; },
  { group = &quot;mmcv22_torch24&quot;, marker = &quot;platform_system == &#x27;Linux&#x27; and python_version &gt;= &#x27;3.10&#x27; and python_version &lt; &#x27;3.11&#x27;&quot;, url = &quot;https://download.openmmlab.com/mmcv/dist/cu118/torch2.4.0/mmcv-2.2.0-cp310-cp310-manylinux1_x86_64.whl&quot; },
  { group = &quot;mmcv22_torch24&quot;, marker = &quot;platform_system == &#x27;Linux&#x27; and python_version &gt;= &#x27;3.11&#x27; and python_version &lt; &#x27;3.12&#x27;&quot;, url = &quot;https://download.openmmlab.com/mmcv/dist/cu118/torch2.4.0/mmcv-2.2.0-cp311-cp311-manylinux1_x86_64.whl&quot; },
  { group = &quot;mmcv22_torch24&quot;, marker = &quot;platform_system == &#x27;Linux&#x27; and python_version &gt;= &#x27;3.12&#x27; and python_version &lt; &#x27;3.13&#x27;&quot;, url = &quot;https://download.openmmlab.com/mmcv/dist/cu118/torch2.4.0/mmcv-2.2.0-cp312-cp312-manylinux1_x86_64.whl&quot; },
]

[[tool.uv.index]]
name = &quot;torch-cu118&quot;
url = &quot;https://download.pytorch.org/whl/cu118&quot;
explicit = true
</code></pre>
</p>
 

<p>To verify everything is as expected, I run <code>uv sync --group my_group &amp;&amp; uv pip show torch torchvision</code></p>
<p>I&#x27;m befuddled with the outcome.</p>
Installed versions on MacOS
<p>

<pre><code>Name: torch
Version: 2.1.2
Location: /Users/neil.wadhvana/workspaces/main/torc-robotics/pytorc/projects/dep_test/.venv/lib/python3.10/site-packages
Requires: filelock, fsspec, jinja2, networkx, sympy, typing-extensions
Required-by: torchvision
---
Name: torch
Version: 2.4.1
Location: /Users/neil.wadhvana/workspaces/main/torc-robotics/pytorc/projects/dep_test/.venv/lib/python3.10/site-packages
Requires: filelock, fsspec, jinja2, networkx, sympy, typing-extensions
Required-by: torchvision
---
Name: torchvision
Version: 0.16.2
Location: /Users/neil.wadhvana/workspaces/main/torc-robotics/pytorc/projects/dep_test/.venv/lib/python3.10/site-packages
Requires: numpy, pillow, torch
Required-by:
---
Name: torchvision
Version: 0.19.1
Location: /Users/neil.wadhvana/workspaces/main/torc-robotics/pytorc/projects/dep_test/.venv/lib/python3.10/site-packages
Requires: numpy, pillow, torch
Required-by:
</code></pre>
</p>
 

<ul>
<li>Why (and how) did <code>uv</code> install 2 versions of <code>torch</code> and <code>torchvision</code> on MacOS? Or is this just a readout from the lock file?<ul>
<li>In the <code>.venv</code> site-packages, I only see one installation of each package (the newer versions).</li>
<li>My intuition tells me <code>uv pip show</code> is both parsing the lock file for versions and also reading from the environment, and somehow getting confused.</li>
<li>Running the <code>show</code> without installing / after cleaning up the venv yields only the observed, installed versions.</li>
</ul>
</li>
<li>I can solve  this behavior by specifying the Linux platform for <code>torch</code> and <code>torchvision</code> in the <code>mmcv*</code> groups, but I don&#x27;t yet understand why it&#x27;s necessary - should it be?</li>
</ul>
<p>I understand I&#x27;m not using the <a href="https://docs.astral.sh/uv/guides/integration/pytorch/#installing-pytorch">exact prescribed installation setup described in the docs</a>, but I&#x27;m trying to understand the tool&#x27;s behavior instead of just hard-coding a solution.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-07 02:42</div>
            <div class="timeline-body"><p>I think you&#x27;re running into a variety of bugs that are fixed by <a href="https://github.com/astral-sh/uv/pull/9370">astral-sh/uv#9370</a>. Check out the linked issues there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/NellyWhads">@NellyWhads</a> on 2024-12-07 02:45</div>
            <div class="timeline-body"><p>Is there a quick way to install uv directly from that branch to test it?</p>
<p><em>Also, are you an agentic LLM? Or are your fingers just crazy fast?</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-12-07 02:49</div>
            <div class="timeline-body"><p>There are a limited set of binary artifacts attached to the CI run for the commit https://github.com/astral-sh/uv/actions/runs/12204703226?pr=9370 (scroll to the bottom) — you can download one of those if you don&#x27;t want to  build from source.</p>
<p><em>We&#x27;re all robots</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/NellyWhads">@NellyWhads</a> on 2024-12-07 03:01</div>
            <div class="timeline-body">You&#x27;ve done it again
<p>

<pre><code>$ ~/Downloads/uv sync --group my_group &amp;&amp; ~/Downloads/uv pip show torch torchvision 
Using CPython 3.10.15
Creating virtual environment at: .venv
⠙ Resolving dependencies...                                                                                                                    warning: Missing version constraint (e.g., a lower bound) for `setuptools`
warning: Missing version constraint (e.g., a lower bound) for `torch`
warning: Missing version constraint (e.g., a lower bound) for `torchvision`
Resolved 73 packages in 1.56s
Installed 12 packages in 256ms
 + filelock==3.16.1
 + fsspec==2024.10.0
 + jinja2==3.1.4
 + markupsafe==2.1.5
 + mpmath==1.3.0
 + networkx==3.1
 + numpy==1.24.4
 + pillow==10.4.0
 + sympy==1.13.3
 + torch==2.4.1
 + torchvision==0.19.1
 + typing-extensions==4.12.2
Name: torch
Version: 2.4.1
Location: /Users/neil.wadhvana/workspaces/main/torc-robotics/pytorc/projects/dep_test/.venv/lib/python3.10/site-packages
Requires: filelock, fsspec, jinja2, networkx, sympy, typing-extensions
Required-by: torchvision
---
Name: torchvision
Version: 0.19.1
Location: /Users/neil.wadhvana/workspaces/main/torc-robotics/pytorc/projects/dep_test/.venv/lib/python3.10/site-packages
Requires: numpy, pillow, torch
Required-by:
</code></pre>
</p>
 

<p><em>Teach me your ways. The world is moving too slowly for me.</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-12-10 15:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-12-10 15:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:36:01 UTC
    </footer>
</body>
</html>
