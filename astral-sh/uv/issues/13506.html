<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>constraint-dependencies setting ignores environment markers - astral-sh/uv #13506</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>constraint-dependencies setting ignores environment markers</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/13506">#13506</a>
        opened by <a href="https://github.com/espdev">@espdev</a>
        on 2025-05-17 11:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/espdev">@espdev</a> on 2025-05-17 11:52</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Hello,</p>
<p>I try to use <a href="https://docs.astral.sh/uv/reference/settings/#constraint-dependencies">constraint-dependencies</a> setting to apply constraints for the dependency resolver.</p>
<p>I need to apply constraints because I need to install <code>pyqt5</code> dependency in a Windows/Linux project (Python&gt;=3.10).</p>
<p><code>pyqt5</code> depends on <code>pyqt5-qt5</code> dependency. Without constraint-dependencies I can't add/install <code>pyqt5</code> on Windows because there is no <code>pyqt5-qt5</code> binary distribution on PyPI (This is a mistake by the package maintainers, but nevertheless it is true). The same issue describes <a href="https://github.com/astral-sh/uv/issues/7005">here</a>.</p>
<p>So, I have added <code>constraint-dependencies</code> to the <code>pyproject.toml</code> file:</p>
<pre><code class="language-toml">[project]
name = &quot;my-app&quot;
version = &quot;0.1.0&quot;
description = &quot;My app&quot;
readme = &quot;README.md&quot;

requires-python = &quot;&gt;=3.10, &lt;3.14&quot;

dependencies = [
    &quot;pyqt5&gt;=5.15.11&quot;,
]

[tool.uv]
constraint-dependencies = [
    &quot;pyqt5-qt5&lt;=5.15.2; sys_platform == 'win32'&quot;
]
</code></pre>
<p>And <code>manifest</code> section has been added to <code>uv.lock</code> file:</p>
<pre><code>[manifest]
constraints = [{ name = &quot;pyqt5-qt5&quot;, marker = &quot;sys_platform == 'win32'&quot;, specifier = &quot;&lt;=5.15.2&quot; }]
</code></pre>
<p>It works fine on Windows, now I can install <code>pyqt5==5.15.11</code> and <code>pyqt5-qt5==5.15.2</code>.
However, on Linux I would like to install the latest version of pyqt5-qt5 package: <code>pyqt5-qt5==5.15.16</code> because the latest binary distribution is available for Linux platform. But on Linux I also get <code>pyqt5-qt5==5.15.2</code>. The environment marker <code>&quot;sys_platform == 'win32'&quot;</code> just ignored.</p>
<p>uv even downgrades <code>pyqt5-qt5</code> version if I add <code>constraint-dependencies</code> after:</p>
<pre><code>‚ùØ uv sync
Using CPython 3.10.17
Creating virtual environment at: .venv
Resolved 4 packages in 0.66ms
Prepared 3 packages in 10.66s
Installed 3 packages in 24ms
 + pyqt5==5.15.11
 + pyqt5-qt5==5.15.16
 + pyqt5-sip==12.17.0
</code></pre>
<p>... add <code>constraint-dependencies</code></p>
<pre><code>‚ùØ uv lock
Resolved 5 packages in 149ms
Updated pyqt5-qt5 v5.15.16 -&gt; v5.15.2, v5.15.16
</code></pre>
<p>I think <code>constraint-dependencies</code> setting should take into account environment markers. Especially  the fact that the markers are even indicated in the manifest in <code>uv.lock</code> file.</p>
<h3>Platform</h3>
<p>Windows/Linux</p>
<h3>Version</h3>
<p>uv 0.7.4</p>
<h3>Python version</h3>
<p>Python &gt;= 3.10</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @espdev on 2025-05-17 11:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-17 11:54</div>
            <div class="timeline-body"><p>I don't think the marker is &quot;ignored&quot;; rather, uv tries to find a solution that avoids including multiple versions of <code>pyqt5-qt5</code> unnecessarily. Using <code>5.15.2</code> on Linux is actually totally compatible with the requirements you provided. I might suggest adding another constraint to say you want <code>&gt; 5.15.2</code> on non-Windows.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/espdev">@espdev</a> on 2025-05-17 12:03</div>
            <div class="timeline-body"><p>Interesting note.</p>
<p>So, I just added the constraints and it works as I expect! Thank you @charliermarsh!</p>
<pre><code class="language-toml">[tool.uv]
constraint-dependencies = [
    &quot;pyqt5-qt5&lt;=5.15.2; sys_platform == 'win32'&quot;,
    &quot;pyqt5-qt5&gt;=5.15.16; sys_platform == 'linux'&quot;,
]
</code></pre>
<p>But this seems counter-intuitive to me. I expect the constraint will not apply to another platform. Because if I don't specify any constraints at all, uv will add/install the latest version of the dependency. But the main thing is that it works!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-18 21:24</div>
            <div class="timeline-body"><p>üëç This <em>is</em> working as expected, though there's been consideration in the past to being more &quot;aggressive&quot; in &quot;forking&quot; to include multiple versions here. I think that's best tracked elsewhere, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-05-18 21:24</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:33:06 UTC
    </footer>
</body>
</html>
