<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keyring cli calls differ from pip - astral-sh/uv #4056</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Keyring cli calls differ from pip</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/4056">#4056</a>
        opened by <a href="https://github.com/Rogdham">@Rogdham</a>
        on 2024-06-05 17:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Rogdham">@Rogdham</a> on 2024-06-05 17:34</div>
            <div class="timeline-body"><p>I have noticed a difference in the calls to <code>keyring</code> between <code>pip</code> and <code>uv</code> version 0.2.6 on Linux.</p>
<p>The first call made to <code>keyring</code> specifies the package we want to install and not only the index URL. The second call uses the port while pip does not.</p>
<p>To get those results, I wrote a simple script that dumps the args it is called with, named it <code>keyring</code> and put it first in <code>$PATH</code>.</p>
<h3>Pip</h3>
<pre><code>$ PIP_FORCE_KEYRING=1 PIP_KEYRING_PROVIDER=subprocess pip -v install --index-url http://user@localhost:8000/simple/ custompkg==0.0.1
</code></pre>
<details><summary>Full output</summary>
<p>

<pre><code>Using pip 23.2.1 from /redacted/env/lib/python3.11/site-packages/pip (python 3.11)
Looking in indexes: http://****@localhost:8000/simple/
Keyring provider requested: subprocess
Keyring provider set: subprocess with executable /redacted2/keyring
</code></pre>
</p>
</details> 

<p>Subprocess calls made to keyring:</p>
<ol>
<li><code>keyring get http://localhost:8000/simple/ user</code></li>
<li><code>keyring get localhost:8000 user</code></li>
</ol>
<h3>UV</h3>
<pre><code>RUST_LOG=uv=trace uv pip install --keyring-provider subprocess --extra-index-url=http://user@localhost:8000/simple/ custompkg==0.0.1 --verbose
</code></pre>
<details><summary>Full output</summary>
<p>

<pre><code>DEBUG Searching for Python interpreter in virtual environments
TRACE Cached interpreter info for Python 3.11.6, skipping probing: env/bin/python3
DEBUG Found CPython 3.11.6 at `/redacted/env/bin/python3` (active virtual environment)
DEBUG Using Python 3.11.6 environment at env/bin/python3
TRACE Checking lock for `env`
DEBUG Acquired lock for `env`
DEBUG At least one requirement is not satisfied: custompkg==0.0.1
TRACE Caching credentials for http://user@localhost:8000/simple/
DEBUG Using registry request timeout of 30s
DEBUG Solving with target Python version 3.11.6
DEBUG Adding direct dependency: custompkg==0.0.1
TRACE Fetching metadata for custompkg from http://user@localhost:8000/simple/custompkg/
TRACE No cache entry exists for /home/redacted/.cache/uv/simple-v8/7fc49dbfbd1b2ee9/custompkg.rkyv
DEBUG No cache entry for: http://localhost:8000/simple/custompkg/
TRACE Sending fresh GET request for http://localhost:8000/simple/custompkg/
TRACE Handling request for http://user@localhost:8000/simple/custompkg/
TRACE Request for http://user@localhost:8000/simple/custompkg/ is missing a password, looking for credentials
TRACE No password in cache for realm user@http://localhost:8000
DEBUG Checking keyring for credentials for user@http://localhost:8000/simple/custompkg/
TRACE Checking keyring for URL http://localhost:8000/simple/custompkg/
TRACE Checking keyring for host localhost
TRACE Fetching metadata for custompkg from https://pypi.org/simple/custompkg/
TRACE No cache entry exists for /home/redacted/.cache/uv/simple-v8/pypi/custompkg.rkyv
DEBUG No cache entry for: https://pypi.org/simple/custompkg/
TRACE Sending fresh GET request for https://pypi.org/simple/custompkg/
TRACE Handling request for https://pypi.org/simple/custompkg/
TRACE Request for https://pypi.org/simple/custompkg/ is unauthenticated, checking cache
TRACE No credentials in cache for URL https://pypi.org/simple/custompkg/
TRACE Attempting unauthenticated request for https://pypi.org/simple/custompkg/
TRACE Request for https://pypi.org/simple/custompkg/ failed with 404 Not Found, checking for credentials
TRACE No credentials in cache for realm https://pypi.org
DEBUG Skipping keyring lookup for https://pypi.org/simple/custompkg/ with no username
TRACE Received package metadata for: custompkg
DEBUG Searching for a compatible version of custompkg (==0.0.1)
TRACE selecting candidate for package custompkg with range Range { segments: [(Included(&quot;0.0.1&quot;), Included(&quot;0.0.1&quot;))] } with 0 remote versions
DEBUG No compatible version found for: custompkg
  × No solution found when resolving dependencies:
  ╰─▶ Because custompkg was not found in the package registry and you require custompkg==0.0.1, we can conclude that the requirements
      are unsatisfiable.
</code></pre>
</p>
</details> 

<p>Subprocess calls made to keyring:</p>
<ol>
<li><code>keyring get http://localhost:8000/simple/custompkg/ user</code></li>
<li><code>keyring get localhost user</code></li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-05 18:23</div>
            <div class="timeline-body"><p>Huh interesting. Thanks for the clear report. It's definitely a bug that we don't include the port in the second invocation. I'm not sure about the first one though. Our authentication is implemented as client middleware and it doesn't know that this request is for a package on an index, it just has a URL. We use the full URL first because the authentication <em>could</em> differ per subpath (a good example being GitHub repositories). We might need to make our authentication middleware &quot;aware&quot; of some seeded URLs in order to support special authentication paradigms for indexes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">compatibility</span> added by @zanieb on 2024-06-05 18:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Rogdham">@Rogdham</a> on 2024-06-06 07:28</div>
            <div class="timeline-body"><p>Here is an illustration with the <a href="https://pypi.org/project/artifacts-keyring/"><code>artifacts-keyring</code></a> to authenticate to Azure DevOps and fetch packages from an Azure Artifact feed.</p>
<p>From what I saw (I may be slightly wrong), how it works it that for each URL:</p>
<ol>
<li>if it has a token in cache for that URL, it checks that the token is still valid and returns it</li>
<li>else it gets a new token by asking the user to make manual operations, then stores the token in cache for next time</li>
</ol>
<p>For example, here I am already authenticated a specific <em>feed</em> named <code>myfeed</code>:</p>
<pre><code>$ keyring get 'https://pkgs.dev.azure.com/redacted/_packaging/myfeed/pypi/simple/' VssSessionToken
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</code></pre>
<p>But if I try to get a sub-url (like <code>uv</code> is doing), it tries to re-authenticate me (it waits for user interaction so I killed it with Ctrl+C at the end):</p>
<pre><code>$ keyring get 'https://pkgs.dev.azure.com/redacted/_packaging/myfeed/pypi/simple/custompkg/' VssSessionToken
[Minimal] [CredentialProvider]DeviceFlow: https://pkgs.dev.azure.com/redacted/_packaging/myfeed/pypi/simple/custompkg/
[Minimal] [CredentialProvider]ATTENTION: User interaction required.

    **********************************************************************

    To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code REDACTED to authenticate.

    **********************************************************************

^C
</code></pre>
<p>I believe that as a result, I would need to authenticate for every single package downloaded from the <em>feed</em>. This would be quite cumbersome, especially since Azure Devops can be used as a proxy registry (i.e. configuring it to be a cache of PyPi).</p>
<p>Hope this helps illustrate the issue with passing the package name in the URL to <code>keyring</code>!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-07 00:05</div>
            <div class="timeline-body"><p>Unfortunately the requirements for keyring plugins is entirely unspecified so while this is the case for Azure it may not be (probably isn't) the case for other plugins. It might be worth exploring a change to the Azure plugin itself. Regardless, I can look into this eventually. As I said though, it will be challenging to address.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Rogdham">@Rogdham</a> on 2024-06-08 15:50</div>
            <div class="timeline-body"><p>I agree that the absence of a clear specification is unfortunate. I would have expected <code>uv</code> to just copy what <code>pip</code> is doing in that case. Also my last message highlights a use case where <code>pip</code>'s calls make more sense to me. Maybe it is worth mentioning in the <em>pip compatibility</em> file?</p>
<p>In any case, I acknowledge that I have limited knowledge on the topic, so I leave it into your hands. But feel free to ping me if you want me to try something out!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-20 22:03</div>
            <div class="timeline-body"><p>@jtfmumm I think we could solve this now that we have <code>authenticate = &quot;always&quot;</code>, basically we could eagerly fetch credentials from the keyring for unauthenticated index URLs? At that point, we'd have access to the &quot;index root&quot; and user-specified URL. The only downside to that is that we might fetch credentials before we need to make any network requests, which add overhead to various commands. Perhaps the answer is still to do https://github.com/astral-sh/uv/issues/4583 and tweak our keyring invocation accordingly for index URLs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-20 22:07</div>
            <div class="timeline-body"><p>(I think @konstin is thinking about keyring behaviors too though, I'm not sure what the status of that work is or if it covers this)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on 2025-04-03 14:08</div>
            <div class="timeline-body"><p>#12651 causes uv to check for keyring credentials for the index URL instead of the package URL, but it doesn't address the issue you've raised about excluding the port, which will need further investigation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @jtfmumm by @jtfmumm on 2025-04-03 14:09</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 03:43:56 UTC
    </footer>
</body>
</html>
