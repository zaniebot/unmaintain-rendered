```yaml
number: 1376
title: "uv pip install hexdump==3.3 fails: The top level of the archive must only contain a list directory"
type: issue
state: closed
author: robin-nitrokey
labels:
  - bug
  - good first issue
assignees: []
created_at: 2024-02-15T22:52:27Z
updated_at: 2024-02-17T04:17:37Z
url: https://github.com/astral-sh/uv/issues/1376
synced_at: 2026-01-10T01:57:02Z
```

# uv pip install hexdump==3.3 fails: The top level of the archive must only contain a list directory

---

_Issue opened by @robin-nitrokey on 2024-02-15 22:52_

I cannot install the `hexdump` package with `uv pip install`:

```
$ pipx install uv
  installed package uv 0.1.1, installed using Python 3.11.2
  These apps are now globally available
    - uv
$ uv venv
Using Python 3.11.2 interpreter at /usr/bin/python3.11
Creating virtualenv at: .venv
$ uv pip install hexdump==3.3
error: Failed to download and build: hexdump==3.3
  Caused by: Failed to extract source distribution: The top level of the archive must only contain a list directory, but it contains: [DirEntry { inner: DirEntry("/home/user/.cache/uv/.tmphnfEex/__main__.py") }, DirEntry { inner: DirEntry("/home/user/.cache/uv/.tmphnfEex/hexdump.py") }, DirEntry { inner: DirEntry("/home/user/.cache/uv/.tmphnfEex/data") }, DirEntry { inner: DirEntry("/home/user/.cache/uv/.tmphnfEex/PKG-INFO") }, DirEntry { inner: DirEntry("/home/user/.cache/uv/.tmphnfEex/setup.py") }, DirEntry { inner: DirEntry("/home/user/.cache/uv/.tmphnfEex/README.txt") }]
  Caused by: The top level of the archive must only contain a list directory, but it contains: [DirEntry { inner: DirEntry("/home/user/.cache/uv/.tmphnfEex/__main__.py") }, DirEntry { inner: DirEntry("/home/user/.cache/uv/.tmphnfEex/hexdump.py") }, DirEntry { inner: DirEntry("/home/user/.cache/uv/.tmphnfEex/data") }, DirEntry { inner: DirEntry("/home/user/.cache/uv/.tmphnfEex/PKG-INFO") }, DirEntry { inner: DirEntry("/home/user/.cache/uv/.tmphnfEex/setup.py") }, DirEntry { inner: DirEntry("/home/user/.cache/uv/.tmphnfEex/README.txt") }]
```

It looks like the error comes from this function:

https://github.com/astral-sh/uv/blob/12c19ce50689ee089c1374deb8282555418f9cf4/crates/uv-extract/src/sync.rs#L107-L122

Indeed the [`hexdump-3.3.zip` sdist](https://files.pythonhosted.org/packages/55/b3/279b1d57fa3681725d0db8820405cdcb4e62a9239c205e4ceac4391c78e4/hexdump-3.3.zip) does not follow the spec and directly contains the source files:

```
$ unzip -l hexdump-3.3.zip
Archive:  hexdump-3.3.zip
  Length      Date    Time    Name
---------  ---------- -----   ----
    13829  01-22-2016 17:32   hexdump.py
     8228  01-22-2016 17:40   PKG-INFO
     5731  01-22-2016 17:33   README.txt
     4127  01-22-2016 17:36   setup.py
       32  01-22-2016 16:04   data/hexfile.bin
       51  01-22-2016 17:40   __main__.py
---------                     -------
    31998                     6 files
```

Maybe it uses the legacy sdist format mentioned in the [documentation](https://packaging.python.org/en/latest/specifications/source-distribution-format/)?  The same package can be installed without problem using pip 24.0.

---

_Comment by @charliermarsh on 2024-02-15 22:53_

Oh noo. Okay, that's interesting, will look into it!

---

_Label `bug` added by @charliermarsh on 2024-02-15 22:53_

---

_Comment by @robin-nitrokey on 2024-02-15 22:56_

Thanks!  And thank you for this amazing project!  A big step towards fast and reliable Python development and packaging tools. :)

---

_Comment by @charliermarsh on 2024-02-15 22:57_

Thank you! And thanks for looking into the root cause, the zip structure, etc. That's awesome.

---

_Referenced in [astral-sh/uv#1389](../../astral-sh/uv/pulls/1389.md) on 2024-02-15 23:46_

---

_Comment by @charliermarsh on 2024-02-16 01:47_

Ok, it looks like pip has a slightly different implementation, which is that if every file is scoped under the same directory, it flattens that directory: https://github.com/pypa/pip/blob/51de88ca6459fdd5213f86a54b021a80884572f9/src/pip/_internal/utils/unpacking.py#L62

---

_Label `good first issue` added by @charliermarsh on 2024-02-16 04:58_

---

_Referenced in [astral-sh/uv#1564](../../astral-sh/uv/pulls/1564.md) on 2024-02-17 02:48_

---

_Closed by @charliermarsh on 2024-02-17 04:17_

---
