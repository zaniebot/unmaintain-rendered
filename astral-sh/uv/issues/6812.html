<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>libpython missing - astral-sh/uv #6812</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>libpython missing</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/6812">#6812</a>
        opened by <a href="https://github.com/CowKeyMan">@CowKeyMan</a>
        on 2024-08-29 13:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/CowKeyMan">@CowKeyMan</a> on 2024-08-29 13:37</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

<p>libpython should be left in the environment. This is useful for us developing c libraries with python bindings. And in fact python expects this as well (look at the <code>not found</code> line below):</p>
<pre><code>(myenv) username@device:/opt/pyenvs$ which python
/opt/pyenvs/myenv/bin/python
(myenv) username@device:/opt/pyenvs$ ldd /opt/pyenvs/myenv/bin/python
        linux-vdso.so.1 (0x00007ffc04b9d000)
        /opt/pyenvs/myenv/bin/../lib/libpython3.11.so.1.0 =&gt; not found
        libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007fbf79aec000)
        libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007fbf79ae7000)
        libutil.so.1 =&gt; /lib/x86_64-linux-gnu/libutil.so.1 (0x00007fbf79ae2000)
        libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007fbf799fb000)
        librt.so.1 =&gt; /lib/x86_64-linux-gnu/librt.so.1 (0x00007fbf799f4000)
        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007fbf797cb000)
        /lib64/ld-linux-x86-64.so.2 (0x00007fbf79b0e000)
</code></pre>
<p>Right  now, it is instead being put in: <code>${HOME}.local/share/uv/python/cpython-3.11.9-linux-x86_64-gnu/lib</code>, which is great for and speed, but super awful for portability. Maybe there can be a flag for this? I thought the <code>uv venv --relocatable</code> flag would help, but it does not. Maybe a <code>--portable</code> flag would be good for this?</p>
<p>Thanks for the awesome tool otherwise!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">virtualenv</span> added by @zanieb on 2024-08-29 16:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/frederikschubert">@frederikschubert</a> on 2024-09-13 09:50</div>
            <div class="timeline-body"><p>We are also encountering the same issue when trying to run <a href="https://github.com/triton-inference-server/pytriton">pytriton</a> within a <code>uv</code> environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../astral-sh/python-build-standalone/issues/381.html">astral-sh/python-build-standalone#381</a> on 2024-10-23 19:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/smheidrich">@smheidrich</a> on 2024-10-23 19:38</div>
            <div class="timeline-body"><p>I guess this is only an issue for the <a href="https://github.com/indygreg/python-build-standalone">python-build-standalone</a> binaries <a href="https://docs.astral.sh/uv/concepts/python-versions/#cpython-distributions">uv uses</a> by default.</p>
<p>If you let uv create the venv with a Python binary from another source, e.g. your system Python installation or one installed via <a href="https://github.com/pyenv/pyenv">pyenv</a>, it works just fine because they don't have a shared library dependency on <code>libpython*.so</code>:</p>
<pre><code class="language-console">$ uv venv --python /usr/bin/python3 system-py-venv
...
$ ldd system-py-venv/bin/python
	linux-vdso.so.1 (0x00007ffc870c9000)
	libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007f1233c94000)
	libz.so.1 =&gt; /lib/x86_64-linux-gnu/libz.so.1 (0x00007f1233c75000)
	libexpat.so.1 =&gt; /lib/x86_64-linux-gnu/libexpat.so.1 (0x00007f1233c4a000)
	libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f1233a69000)
	/lib64/ld-linux-x86-64.so.2 (0x00007f1233d9f000)
</code></pre>
<p>Judging by the sizes of these binaries (python-build-standalone: ~2 MB, pyenv/system: ~30 MB), I guess the latter just link libpython statically.</p>
<p>So maybe uv should somehow find out whether the binary in question has a relative <code>libpython*.so</code> dependency or not and only copy/symlink <code>libpython*.so</code> if so?</p>
<p>But this issue also messes with venvs created with python-build-standalone binaries independently of uv, so here's an issue on their side to maybe do something about it:</p>
<ul>
<li>https://github.com/indygreg/python-build-standalone/issues/381</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../Quantinuum/tket-json-rs/issues/85.html">Quantinuum/tket-json-rs#85</a> on 2024-10-25 16:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-02 03:54</div>
            <div class="timeline-body"><p>Is this still an issue on latest uv, if you reinstall Python?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/frederikschubert">@frederikschubert</a> on 2025-01-02 09:50</div>
            <div class="timeline-body"><p>I can confirm that the latest version solves this issue for us! üëç</p>
<p>Repro for testing which failed previously but now succeeds:</p>
<p>Running this <a href="https://github.com/triton-inference-server/pytriton/blob/main/examples/linear_random_pytorch/server.py">script</a> with <code>uv run --with torch --with nvidia-pytriton --isolated server.py</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-01-02 14:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nazdridoy">@nazdridoy</a> on 2025-01-13 06:35</div>
            <div class="timeline-body"><p>no it's not solved for me</p>
<pre><code>‚ùØ source .venv/bin/activate
‚ùØ ldd `which python`
	linux-vdso.so.1 (0x00007f030312d000)
	/home/uv/UV/Workspace/TEMP/miscProjects/uv/.venv/bin/../lib/libpython3.12.so.1.0 =&gt; not found
	libpthread.so.0 =&gt; /usr/lib/libpthread.so.0 (0x00007f03030dd000)
	libdl.so.2 =&gt; /usr/lib/libdl.so.2 (0x00007f03030d8000)
	libutil.so.1 =&gt; /usr/lib/libutil.so.1 (0x00007f03030d3000)
	libm.so.6 =&gt; /usr/lib/libm.so.6 (0x00007f0302fe4000)
	librt.so.1 =&gt; /usr/lib/librt.so.1 (0x00007f0302fdd000)
	libc.so.6 =&gt; /usr/lib/libc.so.6 (0x00007f0302dec000)
	/lib64/ld-linux-x86-64.so.2 =&gt; /usr/lib64/ld-linux-x86-64.so.2 (0x00007f030312f000)

‚ùØ uv --version
uv 0.5.16 (333f03f11 2025-01-08)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @zanieb on 2025-01-13 18:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-13 18:54</div>
            <div class="timeline-body"><pre><code>‚ùØ uv self update
info: Checking for updates...
success: Upgraded uv from v0.5.17 to v0.5.18! https://github.com/astral-sh/uv/releases/tag/0.5.18
‚ùØ uv python install 3.13 --reinstall
Installed Python 3.13.1 in 2.37s
 ~ cpython-3.13.1-linux-x86_64-gnu
‚ùØ uv python find 3.13
/home/zb/.local/share/uv/python/cpython-3.13.1-linux-x86_64-gnu/bin/python3.13
‚ùØ ldd /home/zb/.local/share/uv/python/cpython-3.13.1-linux-x86_64-gnu/bin/python3.13
	linux-vdso.so.1 (0x00007b41f3d00000)
	/home/zb/.local/share/uv/python/cpython-3.13.1-linux-x86_64-gnu/bin/../lib/libpython3.13.so.1.0 (0x00007b41f2400000)
	libpthread.so.0 =&gt; /usr/lib/libpthread.so.0 (0x00007b41f3ccf000)
	libdl.so.2 =&gt; /usr/lib/libdl.so.2 (0x00007b41f3cca000)
	libutil.so.1 =&gt; /usr/lib/libutil.so.1 (0x00007b41f3cc5000)
	libm.so.6 =&gt; /usr/lib/libm.so.6 (0x00007b41f3bd6000)
	librt.so.1 =&gt; /usr/lib/librt.so.1 (0x00007b41f3bcf000)
	libc.so.6 =&gt; /usr/lib/libc.so.6 (0x00007b41f220f000)
	/lib64/ld-linux-x86-64.so.2 =&gt; /usr/lib64/ld-linux-x86-64.so.2 (0x00007b41f3d02000)
‚ùØ uv venv -p 3.13
Using CPython 3.13.1
Creating virtual environment at: .venv
Activate with: source .venv/bin/activate
‚ùØ ldd .venv/bin/python
	linux-vdso.so.1 (0x000076c3c32b0000)
	/fast/workspace/uv/.venv/bin/../lib/libpython3.13.so.1.0 =&gt; not found
	libpthread.so.0 =&gt; /usr/lib/libpthread.so.0 (0x000076c3c327f000)
	libdl.so.2 =&gt; /usr/lib/libdl.so.2 (0x000076c3c327a000)
	libutil.so.1 =&gt; /usr/lib/libutil.so.1 (0x000076c3c3275000)
	libm.so.6 =&gt; /usr/lib/libm.so.6 (0x000076c3c3186000)
	librt.so.1 =&gt; /usr/lib/librt.so.1 (0x000076c3c3181000)
	libc.so.6 =&gt; /usr/lib/libc.so.6 (0x000076c3c2f8e000)
	/lib64/ld-linux-x86-64.so.2 =&gt; /usr/lib64/ld-linux-x86-64.so.2 (0x000076c3c32b2000)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-13 18:55</div>
            <div class="timeline-body"><p>This seems to be &quot;as-designed&quot; upstream https://bugs.python.org/issue43334#msg388720</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-23 02:47</div>
            <div class="timeline-body"><p>Is there anything to resolve here then? Or na?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-23 04:32</div>
            <div class="timeline-body"><p>Unless someone can point to comments contrary to what I linked, yeah I think our current behavior is correct. I guess the build system should handle resolving to the upstream binary?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-01-23 04:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/geofft">@geofft</a> on 2025-01-27 20:05</div>
            <div class="timeline-body"><p>One small note here on something that surprised me: <code>not found</code> in ldd output usually indicates that the binary isn't going to run, but clearly it does run. What's going on is that the <code>bin/python</code> is a symlink to the real location, and the <code>${ORIGIN}</code>-relative path works when computed based on the target of the symlink.</p>
<pre><code>$ ls -l .venv/bin/python
lrwxrwxrwx 1 nixos users 82 Jan 27 19:35 .venv/bin/python -&gt; /home/nixos/.local/share/uv/python/cpython-3.13.1-linux-aarch64-gnu/bin/python3.13
$ ldd .venv/bin/python | grep libpython
        /home/nixos/Downloads/.venv/bin/../lib/libpython3.13.so.1.0 =&gt; not found
$ ldd `readlink -f .venv/bin/python` | grep libpython
        /home/nixos/.local/share/uv/python/cpython-3.13.1-linux-aarch64-gnu/bin/../lib/libpython3.13.so.1.0 (0x0000ffff88610000)
</code></pre>
<p>This appears to be a bug in <code>ldd</code>: https://sourceware.org/bugzilla/show_bug.cgi?id=25263</p>
<details><summary>Notes on why the bug happens:</summary>

<p><code>ldd</code> works by running the dynamic linker (<code>ld.so</code>) in a mode where it dumps out paths and exits instead of actually running the program. In the past, <code>ldd</code> used to just set an environment variable <code>LD_TRACE_LOADED_OBJECTS=1</code> and run the argument. If you do it that way, the output is correct:</p>
<pre><code>$ LD_TRACE_LOADED_OBJECTS=1 .venv/bin/python | grep libpython
        /home/nixos/.local/share/uv/python/cpython-3.13.1-linux-aarch64-gnu/bin/../lib/libpython3.13.so.1.0 (0x0000ffffad130000)
</code></pre>
<p>The problem with this implementation of <code>ldd</code> is that it has unexpected effects if the program you're running is not in fact dynamically linked and doesn't change its behavior with that variable‚Äîyou're actually running the program. So, instead, current versions of <code>ldd</code> run by invoking the dynamic linker explicitly.</p>
<pre><code>$ LD_TRACE_LOADED_OBJECTS=1 /lib/ld-linux-aarch64.so.1 .venv/bin/python | grep libpython
        /home/nixos/Downloads/.venv/bin/../lib/libpython3.13.so.1.0 =&gt; not found
</code></pre>
<p>(On x86-64 the dynamic linker is at <code>/lib64/ld-linux-x86-64.so.2</code>.) Sure enough, if you leave out the environment variable but explicitly invoke the dynamic linker, the program does not start:</p>
<pre><code>$ /lib/ld-linux-aarch64.so.1 .venv/bin/python 
.venv/bin/python: error while loading shared libraries: /home/nixos/Downloads/.venv/bin/../lib/libpython3.13.so.1.0: cannot open shared object file: No such file or directory
</code></pre>
<p>The difference here is that when you invoke <code>ld.so</code> with a path, it gets the path name and uses that for <code>$ORIGIN</code>. However, when you run a program directly, it gets its path by reading the <code>/proc/self/exe</code> symlink (see sysdeps/unix/sysv/linux/dl-origin.c in the glibc source). And <code>/proc/self/exe</code> is computed by looking at the open <code>struct file</code>, which I believe is after symlink resolution (see function <code>proc_exe_link</code> in fs/proc/base.c in the Linux kernel source).</p>
</details>

<p>I wonder if fixing the bug in <code>ldd</code> would be enough to fix whatever build systems are unhappy about this. @CowKeyMan / @nazdridoy, can you comment on what is going wrong at a higher level, e.g., with a pointer to what specific build system is failing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/CowKeyMan">@CowKeyMan</a> on 2025-01-27 20:37</div>
            <div class="timeline-body"><p>It seems that this issue was closed as not planned, which is fair enough. The only provider that offers this is conda. I have since moved on to using a more standard application environment manager - asdf, instead of uv. It also does not offer this functionality, but my workaround now is to find wherever these libraries are stored and link to there, or then copy them over to the python path. Unfortunate workaround :/</p>
<p>To your reply of which system is failing, I had a C++ project which tries to link to the python library. CMake build fails because it does not find the python path. It would not do this when the library is as stated in the post above, but also maybe I'm using the build system wrong. I'll update this post when I have time to get around to tinkering with that again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/geofft">@geofft</a> on 2025-01-27 21:21</div>
            <div class="timeline-body"><p>OK, I'd be curious to take a look when you get a chance. The standard CMake <a href="https://cmake.org/cmake/help/latest/module/FindPython.html">FindPython</a> doesn't seem to have issues:</p>
<pre><code>$ cat CMakeLists.txt 
cmake_minimum_required(VERSION 3.15)
project(cm VERSION 1.0 LANGUAGES C)
find_package(Python COMPONENTS Interpreter Development)
add_executable(cm cm.c)
target_include_directories(cm PRIVATE ${Python_INCLUDE_DIRS})
target_link_libraries(cm PRIVATE Python::Python)
$ cat cm.c
#include &lt;Python.h&gt;

int main(void) {
        Py_Initialize();
        PyRun_SimpleString(&quot;from __future__ import braces&quot;);
}
$ cmake -S . -B build 
-- Could NOT find Python (missing: Python_EXECUTABLE Python_INCLUDE_DIRS Python_LIBRARIES Interpreter Development Development.Module Development.Embed)
[and a bunch of other errors]
$ uv venv -p 3.13
Using CPython 3.13.1
Creating virtual environment at: .venv
Activate with: source .venv/bin/activate
$ ldd .venv/bin/python | grep libpython
        /home/nixos/cm/.venv/bin/../lib/libpython3.13.so.1.0 =&gt; not found
$ source .venv/bin/activate
(cm) $ cmake -S . -B build 
-- Found Python: /home/nixos/cm/.venv/bin/python3.13 (found version &quot;3.13.1&quot;) found components: Interpreter Development Development.Module Development.Embed
-- Configuring done (0.2s)
-- Generating done (0.0s)
-- Build files have been written to: /home/nixos/cm/build
(cm) $ cmake --build build 
[ 50%] Building C object CMakeFiles/cm.dir/cm.c.o
[100%] Linking C executable cm
[100%] Built target cm
(cm) $ build/cm
  File &quot;&lt;string&gt;&quot;, line 1
SyntaxError: not a chance
</code></pre>
<p>(This is on NixOS 24.05 stable inside <code>nix-shell -p cmake</code>, i.e., I have no <code>python</code> command on my PATH.)</p>
<p>Conda by its nature has its own environment implementation. I don't think uv should diverge from how upstream <code>venv</code> works, but it definitely makes sense to make sure that build tools know how to work right with upstream <code>venv</code> and locate things properly, either by changing those build tools (which is I think what the suggestion in the Python bug report was) or changing upstream <code>venv</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/11006.html">astral-sh/uv#11006</a> on 2025-01-27 22:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../linuxserver-labs/docker-simplelogin/pulls/3.html">linuxserver-labs/docker-simplelogin#3</a> on 2025-01-31 12:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/11234.html">astral-sh/uv#11234</a> on 2025-02-05 06:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../vllm-project/vllm/issues/14991.html">vllm-project/vllm#14991</a> on 2025-03-18 09:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../pyinstaller/pyinstaller/issues/8111.html">pyinstaller/pyinstaller#8111</a> on 2025-05-15 19:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../namhyung/uftrace/issues/2014.html">namhyung/uftrace#2014</a> on 2025-08-14 02:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../rstudio/reticulate/issues/1847.html">rstudio/reticulate#1847</a> on 2025-10-25 22:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:35 UTC
    </footer>
</body>
</html>
