<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>thiserror `#[error(transparent)]` payloads get skipped in the source chain - astral-sh/uv #14425</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>thiserror `#[error(transparent)]` payloads get skipped in the source chain</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/14425">#14425</a>
        opened by <a href="https://github.com/oconnor663">@oconnor663</a>
        on 2025-07-02 16:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-07-02 16:53</div>
            <div class="timeline-body"><p>This is a hypothetical bug without an observed smoking gun. (I've only been able to <a href="https://github.com/astral-sh/uv/issues/14171#issuecomment-3014580701">trigger it artificially</a>, not with e.g. a real connection reset on the real network.) Here's some code that might be vulnerable to skipping an IO error, depending on how exactly that error is wrapped: https://github.com/astral-sh/uv/blob/87e9ccfb92e2761433bebddbdd68895de0e20abd/crates/uv-client/src/base_client.rs#L898-L908</p>
<p>The reason this is vulnerable is because of a bad/unexpected interaction between <code>thiserror</code>'s <code>#[error(transparent)]</code> marker and a <code>downcast</code> loop that walks the <code>.source()</code> chain. <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2024&amp;gist=be02dbdc58332cea46ab7b93157036fc">Here's a Playground demo.</a> The <code>io::Error</code> is skipped in that case, because <code>transparent</code> <em>forwards</em> the <code>.source()</code> call to the wrapped error (which returns <code>None</code> in that demo, but it's a problem either way) rather than returning the wrapped error itself. This is <a href="https://docs.rs/thiserror/latest/thiserror/#details">documented behavior</a>, though those docs don't discuss the interaction with <code>downcast</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @oconnor663 on 2025-07-02 16:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2025-07-02 16:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-02 16:54</div>
            <div class="timeline-body"><p>I have a change that I'll at least put up for review. We might decide against it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-07-02 17:01</div>
            <div class="timeline-body"><p>The important question is: Does reqwest actually ever gives a plain IO error, or does it return an <code>io::Error</code> with <code>ErrorKind::Custom</code> with a nested reqwest error that nests an io error? Ideally, we'd have an option in thiserror to get not the error chain without transparent, though that may not be possible with the trait casting restrictions (we could do our custom derive to replace thiseorr, but that would still clash with using anyhow/miette on the top elvels). I'd be cautious about changing our error chains too much without a strong motivation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-02 17:03</div>
            <div class="timeline-body"><p>Couldn't reqwest return basically any of our own variants, which in turn could use a transparent IO error that we'd then miss? Like, don't we often see these as &quot;extraction errors&quot;, which is our own variant?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-07-02 17:36</div>
            <div class="timeline-body"><p>I have an example of what a <code>reqwest</code> error (wrapped in a tar error) looks like at the bottom of <a href="https://github.com/astral-sh/uv/issues/14171#issuecomment-3014580701">this comment</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/14378.html">astral-sh/uv#14378</a> on 2025-07-03 22:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-07-03 22:13</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/uv/actions/runs/16060816582/job/45326189810 includes the added logging from https://github.com/astral-sh/uv/pull/14378 but does not indicate that it retried. Does that make it the smoking gun for this issue?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-03 23:18</div>
            <div class="timeline-body"><p>I'm going to get rid of the transparent variants in <code>uv-extract</code>, let's start there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/14450.html">astral-sh/uv#14450</a> on 2025-07-03 23:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-07-04 09:17</div>
            <div class="timeline-body"><p>Here's the debug representation of an error if a sever the network connection mid-download:</p>
<pre><code>[crates/uv/src/commands/python/install.rs:658:13] &amp;err = ExtractError(
    &quot;cpython-3.14.0b3-20250702-x86_64-unknown-linux-gnu-install_only_stripped.tar.gz&quot;,
    Io(
        Custom {
            kind: Other,
            error: TarError {
                desc: &quot;failed to unpack `/home/konsti/.local/share/uv/python/.temp/.tmpUQWZE4/python/include/python3.14/internal/pycore_runtime_init.h`&quot;,
                io: Custom {
                    kind: Other,
                    error: TarError {
                        desc: &quot;failed to unpack `python/include/python3.14/internal/pycore_runtime_init.h` into `/home/konsti/.local/share/uv/python/.temp/.tmpUQWZE4/python/include/python3.14/internal/pycore_runtime_init.h`&quot;,
                        io: Custom {
                            kind: Other,
                            error: reqwest::Error {
                                kind: Decode,
                                source: reqwest::Error {
                                    kind: Body,
                                    source: TimedOut,
                                },
                            },
                        },
                    },
                },
            },
        },
    ),
)
error: Failed to install cpython-3.14.0b3-linux-x86_64-gnu
  Caused by: Failed to extract archive: cpython-3.14.0b3-20250702-x86_64-unknown-linux-gnu-install_only_stripped.tar.gz
  Caused by: I/O operation failed during extraction
  Caused by: failed to unpack `/home/konsti/.local/share/uv/python/.temp/.tmpUQWZE4/python/include/python3.14/internal/pycore_runtime_init.h`
  Caused by: failed to unpack `python/include/python3.14/internal/pycore_runtime_init.h` into `/home/konsti/.local/share/uv/python/.temp/.tmpUQWZE4/python/include/python3.14/internal/pycore_runtime_init.h`
  Caused by: error decoding response body
  Caused by: request or response body error
  Caused by: operation timed out
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/14458.html">astral-sh/uv#14458</a> on 2025-07-04 09:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-04 11:20</div>
            <div class="timeline-body"><p>Did that <em>not</em> get retried?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-07-04 11:29</div>
            <div class="timeline-body"><p>The logs say this:</p>
<pre><code>TRACE Considering retry of error: ExtractError(&quot;cpython-3.14.0b3-20250702-x86_64-unknown-linux-gnu-install_only_stripped.tar.gz&quot;, Io(Custom { kind: Other, error: TarError { desc: &quot;failed to unpack `/home/konsti/.local/share/uv/python/.temp/.tmpqIjd9b/python/lib/python3.14/tkinter/__init__.py`&quot;, io: Custom { kind: Other, error: TarError { desc: &quot;failed to unpack `python/lib/python3.14/tkinter/__init__.py` into `/home/konsti/.local/share/uv/python/.temp/.tmpqIjd9b/python/lib/python3.14/tkinter/__init__.py`&quot;, io: Custom { kind: Other, error: reqwest::Error { kind: Decode, source: reqwest::Error { kind: Body, source: TimedOut } } } } } } }))
TRACE Cannot retry IO error: not one of `ConnectionReset` or `UnexpectedEof`
TRACE Cannot retry IO error: not one of `ConnectionReset` or `UnexpectedEof`
TRACE Cannot retry IO error: not one of `ConnectionReset` or `UnexpectedEof`
TRACE Cannot retry error: not an IO error
</code></pre>
<p>Adding <code>|| io_err.kind() == io::ErrorKind::TimedOut</code> makes it retried:</p>
<pre><code>error: Failed to install cpython-3.14.0b3-linux-x86_64-gnu
  Caused by: Failed to download https://github.com/astral-sh/python-build-standalone/releases/download/20250702/cpython-3.14.0b3%2B20250702-x86_64-unknown-linux-gnu-install_only_stripped.tar.gz
  Caused by: Request failed after 3 retries
  Caused by: error sending request for url (https://github.com/astral-sh/python-build-standalone/releases/download/20250702/cpython-3.14.0b3%2B20250702-x86_64-unknown-linux-gnu-install_only_stripped.tar.gz)
  Caused by: client error (Connect)
  Caused by: dns error
  Caused by: failed to lookup address information: Name or service not known
DEBUG Released lock at `/home/konsti/.local/share/uv/python/.lock`
</code></pre>
<p>idk if we need to retry that, I just wanted to test the logging.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-08-02 15:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-02 15:32</div>
            <div class="timeline-body"><p>Closing for now as we resolved the proximate symptom.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:04 UTC
    </footer>
</body>
</html>
