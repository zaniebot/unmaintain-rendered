<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Is the brotli feature of the reqwest crate actually used/useful in uv? - astral-sh/uv #5283</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Is the brotli feature of the reqwest crate actually used/useful in uv?</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/5283">#5283</a>
        opened by <a href="https://github.com/musicinmybrain">@musicinmybrain</a>
        on 2024-07-22 12:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/musicinmybrain">@musicinmybrain</a></div>
            <div class="timeline-body"><p>The maintainer (@decathorpe) of the <a href="https://src.fedoraproject.org/rpms/rust-reqwest"><code>rust-reqwest</code> package in Fedora</a>, and of much of the Rust stack in Fedora, “explicitly dropped the <code>brotli</code> feature [from the Fedora package] because the dependencies might not be available in the future. There have been multiple breaking releases of the <code>brotli</code> and <code>brotli-decompressor</code> crates recently, and dropbox upstream is ignoring any pull requests / issues we've filed since those crates were packaged for Fedora.” The maintainer is therefore trying to reduce dependencies on the https://github.com/dropbox/rust-brotli crates.</p>
<p>This prompted me to investigate how the <code>brotli</code> feature was used in <code>uv</code>, to decide if I could easily patch it out downstream and understand what, if anything I might lose by doing so.</p>
<p>What I found was that the feature was originally enabled in 8032d4606e24f15c97d66a9a58a1a7fe854d691d along with other work relating to JSON metadata. I presume that the idea was that it might speed up metadata operations a bit, since in general brotli does compress a little more effectively and decompress with a little less CPU effort than gzip on text content.</p>
<p>The same commit added only <code>Accept-Encoding: gzip</code> to the <code>PypiClient</code>’s request headers, and there are still a couple of <code>.header(&quot;Accept-Encoding&quot;, &quot;gzip&quot;)</code> in the <code>uv-client</code> crate in the current <code>main</code>, 5a23f0579962da26dbf117ca008822c26f5d15e5. There are no explicit references to <code>brotli</code>, nor <code>Accept-Encoding</code> headers that contain <code>br</code>, in the code. However, https://docs.rs/reqwest/latest/reqwest/struct.ClientBuilder.html#method.brotli indicates that, when the <code>brotli</code> feature is enabled, <code>br</code> will be inserted to the <code>AcceptEncoding</code> for any requests that don’t already have an explicit <code>AcceptEncoding</code> header. I assume that there are some cases in which <code>uv</code> makes such requests, although possibly not in <code>uv-client</code>. I also note (using Firefox devtools) that PyPI does not currently appear to compress responses to requests for JSON metadata, e.g. https://pypi.org/pypi/uv/json.</p>
<p>All of this leads me to ask – is it worthwhile to leave this feature enabled? Have I missed a way in which it is significantly useful? Or would it make sense to drop it,</p>
<pre><code class="language-diff">diff --git a/Cargo.toml b/Cargo.toml
index 5a854a41..439d0300 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -117,7 +117,7 @@ quote = { version = &quot;1.0.36&quot; }
 rayon = { version = &quot;1.8.0&quot; }
 reflink-copy = { version = &quot;0.1.15&quot; }
 regex = { version = &quot;1.10.2&quot; }
-reqwest = { version = &quot;0.12.3&quot;, default-features = false, features = [&quot;json&quot;, &quot;gzip&quot;, &quot;brotli&quot;, &quot;stream&quot;, &quot;rustls-tls&quot;, &quot;rustls-tls-native-roots&quot;] }
+reqwest = { version = &quot;0.12.3&quot;, default-features = false, features = [&quot;json&quot;, &quot;gzip&quot;, &quot;stream&quot;, &quot;rustls-tls&quot;, &quot;rustls-tls-native-roots&quot;] }
 reqwest-middleware = { git = &quot;https://github.com/astral-sh/reqwest-middleware&quot;, rev = &quot;21ceec9a5fd2e8d6f71c3ea2999078fecbd13cbe&quot; }
 reqwest-retry = { git = &quot;https://github.com/astral-sh/reqwest-middleware&quot;, rev = &quot;21ceec9a5fd2e8d6f71c3ea2999078fecbd13cbe&quot; }
 rkyv = { version = &quot;0.7.43&quot;, features = [&quot;strict&quot;, &quot;validation&quot;] }
</code></pre>
<p>as it looks like I will be doing downstream in Fedora either way, and thereby remove the crates <code>alloc-no-stdlib</code>, <code>alloc-stdlib</code>, <code>brotli</code>, and <code>brotli-decompressor</code> from <code>uv</code>’s dependency tree? If so, I can easily open a PR.</p>
<p>Mentioning @charliermarsh as the person who originally enabled the crate feature, and who might therefore have an opinion on its ongoing potential usefulness in <code>uv</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2024-07-22 19:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/musicinmybrain">@musicinmybrain</a> on 2024-08-29 21:00</div>
            <div class="timeline-body"><p>Given that the <code>brotli</code> feature was removed from the <code>reqwest</code> crate dependency in 2c5cc62106d88d8a0a94f6f91e89887433ba0da2 (released in 0.4.0), I’m going to consider this question answered as “no, it’s not actually needed.”</p>
<p>https://github.com/astral-sh/uv/commit/2c5cc62106d88d8a0a94f6f91e89887433ba0da2#diff-2e9d962a08321605940b5a657135052fbcef87b5e360662bb527c96d9a615542L122</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @musicinmybrain on 2024-08-29 21:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-29 21:18</div>
            <div class="timeline-body"><p>Sorry about the lack of response!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/musicinmybrain">@musicinmybrain</a> on 2024-08-30 01:43</div>
            <div class="timeline-body"><p>No problem – glad to have closure one way or the other!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:25:42 UTC
    </footer>
</body>
</html>
