<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>langchain version confusion with aiohttp started in uv 0.5.17 - astral-sh/uv #10828</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>langchain version confusion with aiohttp started in uv 0.5.17</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/10828">#10828</a>
        opened by <a href="https://github.com/kendallbailey">@kendallbailey</a>
        on 2025-01-21 21:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/kendallbailey">@kendallbailey</a> on 2025-01-21 21:40</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I get strange results when pip compiling a requirements.in file having <code>aiohttp</code> and <code>langchain</code>.</p>
<p>With <code>uv</code> version 0.5.16 it will select <code>langchain==0.3.15</code> and <code>aiohttp==3.11.11</code>. However, when using <code>uv</code> version 0.5.17, it rejects <code>langchain</code> versions &gt;0.0.133. Seems to be something to do with <code>async-timeout</code> which both packages depend on.</p>
<p>To reproduce the problem, create a <code>reqs.in</code> with content of</p>
<pre><code>aiohttp
langchain
</code></pre>
<p>Then with <code>uv</code> 0.5.17</p>
<pre><code>$ uv pip compile reqs.in | grep langchain=
Resolved 28 packages in 217ms
langchain==0.0.133
</code></pre>
<p>with <code>uv</code> 0.5.16</p>
<pre><code>$ uv pip compile reqs.in | grep langchain=
Resolved 38 packages in 153ms
langchain==0.3.15
</code></pre>
<p>Adding a <code>--verbose</code> flag shows the divergence in behavior refers to <code>async-timeout</code></p>
<p>0.5.17 has</p>
<pre><code>DEBUG Found fresh response for: https://pypi.org/simple/frozenlist/
DEBUG Recording unit propagation conflict of langchain from incompatibility of (langchain, async-timeout{python_full_version &lt; '3.11'})
DEBUG Searching for a compatible version of langchain (&lt;0.3.15 | &gt;0.3.15)
DEBUG Selecting: langchain==0.3.14 [compatible] (langchain-0.3.14-py3-none-any.whl)
</code></pre>
<p>0.5.16 never logs a &quot;unit propagation conflict&quot;.</p>
<p>As it turns out <code>langchain</code> depends on <code>aiohttp</code>. Removing <code>aiohttp</code> from the <code>reqs.in</code> shouldn't change the transitive dependencies, but for <code>uv</code> 0.5.17+ it will eliminate the odd behavior and it will select <code>langchain==0.3.15</code> as expected.</p>
<p>Also, changing the order in the <code>reqs.txt</code> so that <code>aiohttp</code> is after <code>langchain</code> will eliminate the odd behavior. <code>uv</code> will again select <code>langchain==0.3.15</code></p>
<h3>Platform</h3>
<p>Ubuntu Linux 22.04</p>
<h3>Version</h3>
<p>0.5.17</p>
<h3>Python version</h3>
<p>3.10.16</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @kendallbailey on 2025-01-21 21:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-21 21:44</div>
            <div class="timeline-body"><p>The order of dependencies affects the priority of the package in the resolver. Placing <code>aiohttp</code> before <code>langchain</code> means we try to resolve that package first, and it looks like we backtrack in a surprising way. Because you don't specify lower bounds, the resolver happily backtracks to a very old version of <code>langchain</code>.</p>
<p>See also https://github.com/astral-sh/uv/issues/8157</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @zanieb on 2025-01-21 21:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2025-01-21 21:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">resolver</span> added by @zanieb on 2025-01-21 21:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-21 21:48</div>
            <div class="timeline-body"><p>Yeah, it's a &quot;correct&quot; resolution, just unintuitive. It ends up prioritizing choosing the latest <code>async-timeout</code>, which is why that package is upgraded in the version with an &quot;old&quot; LangChain (<code>5.0.1</code> vs. <code>4.0.3</code>).</p>
<p>Maybe @konstin can look at why we didn't shuffle the prioritization. Regardless I'd suggest constraining the dependencies if you aren't happy with all versions of LangChain?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-21 21:51</div>
            <div class="timeline-body"><p>A bit confused by the backtracking because we seem to re-prioritize:</p>
<pre><code>Package async-timeout{python_full_version &lt; '3.11'} has too many conflicts (culprit), deprioritizing and backtracking
</code></pre>
<p>But then we just pick the same version?</p>
<pre><code>DEBUG Package async-timeout{python_full_version &lt; '3.11'} has too many conflicts (culprit), deprioritizing and backtracking
DEBUG Backtracked 1 decisions
DEBUG Searching for a compatible version of async-timeout{python_full_version &lt; '3.11'} (&gt;=4.0, &lt;6.0)
DEBUG Selecting: async-timeout==5.0.1 [compatible] (async_timeout-5.0.1-py3-none-any.whl)
DEBUG Searching for a compatible version of langchain (&lt;0.3.11 | &gt;0.3.11, &lt;0.3.12 | &gt;0.3.12, &lt;0.3.13 | &gt;0.3.13, &lt;0.3.14 | &gt;0.3.14, &lt;0.3.15 | &gt;0.3.15)
DEBUG Selecting: langchain==0.3.10 [compatible] (langchain-0.3.10-py3-none-any.whl)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-21 21:53</div>
            <div class="timeline-body"><p>I'll leave it to @konstin to go deeper.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kendallbailey">@kendallbailey</a> on 2025-01-21 22:06</div>
            <div class="timeline-body"><p>Maybe I'm naive. I hoped that if there's a solution with all explicit first order dependencies at their latest versions, then such a solution would be found and preferred. We'll have to be more diligent in setting and updating lower bounds.  Thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-21 22:14</div>
            <div class="timeline-body"><p>I think that might be very hard to implement â€” I don't know of any Python resolver that makes that guarantee.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-21 22:27</div>
            <div class="timeline-body"><p>I think this probably changed in https://github.com/astral-sh/uv/pull/10441.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kendallbailey">@kendallbailey</a> on 2025-01-21 22:30</div>
            <div class="timeline-body"><p>I understand the general problem is hugely complex... but as a special case, wouldn't it be possible to</p>
<ol>
<li>Gather the latest valid versions of first order dependencies</li>
<li>Pin those, and search for a solution</li>
<li>If step 2 fails, fall back to the general approach in use now
?</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-21 22:33</div>
            <div class="timeline-body"><p>Sorry, I'd be strongly opposed to something like that. You already get that behavior unless you have packages in the tree that apply upper bounds (like LangChain does here). We should just handle this case better in the resolver. There shouldn't be any sort of special-casing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-21 22:37</div>
            <div class="timeline-body"><p>I think I see a path to fixing this case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2025-01-21 22:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-21 22:43</div>
            <div class="timeline-body"><p>Nevermind, my idea would <em>only</em> work for the <code>uv pip</code> interface.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @charliermarsh by @charliermarsh on 2025-01-21 22:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2025-01-21 23:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/10833.html">astral-sh/uv#10833</a> on 2025-01-21 23:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-21 23:15</div>
            <div class="timeline-body"><p>I fixed it here: https://github.com/astral-sh/uv/pull/10833</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-01-22 10:48</div>
            <div class="timeline-body"><blockquote>
<p>To reproduce the problem, create a reqs.in with content of</p>
<pre><code>aiohttp
langchain
</code></pre>
</blockquote>
<p>Please specify lower bounds on your requirements: Without lower bounds, the resolver can't tell which versions are or aren't compatible with your project, and has to potentially backtrack to ancient versions. With just two dependencies it's reasonable to just pin the latest version, but in projects with more requirements we often have to select a version below the latest version even for direct dependencies due to a conflict in the transitive dependencies, hence we're making this trade-off.</p>
<blockquote>
<p>Maybe I'm naive. I hoped that if there's a solution with all explicit first order dependencies at their latest versions, then such a solution would be found and preferred. We'll have to be more diligent in setting and updating lower bounds. Thanks.</p>
</blockquote>
<blockquote>
<p>I understand the general problem is hugely complex... but as a special case, wouldn't it be possible to</p>
<pre><code>1. Gather the latest valid versions of first order dependencies

2. Pin those, and search for a solution

3. If step 2 fails, fall back to the general approach in use now
   ?</code></pre>
</blockquote>
<p>This partially an algorithmic constraint: Finding a valid solution is much easier than reject step 2. Getting a solution requires only showing a single solution, while rejecting requires rejecting all possible sets of (transitive) dependencies, which makes this sequence of steps prohibitively expensive. While I agree that in your case aiohttp==3.11.11 langchain==0.3.15 is the more desirable solution, trying more generally to optimize stronger for (more) direct dependencies would move our resolver into a different class of SAT that needs much more global information than uv's resolver currently uses (we'd have to find a solution that optimizes a score function vs. looking for a solution with some prioritization tricks). Fwiw, we currently prioritize for selecting the versions of direct dependencies first, meaning they get the highest version possible, except when we do conflict resolution, which is the case you ran into.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-01-22 17:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-01-22 17:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-01-23 13:15</div>
            <div class="timeline-body"><p>Tracking down the problem chain:</p>
<ul>
<li>We select <code>aiohttp==3.11.11</code></li>
<li>That requires <code>async-timeout&lt;6.0,&gt;=4.0; python_version &lt; &quot;3.11&quot;</code></li>
<li>The change prioritized async-timeout (that's the bad part now fixed) so we select <code>async-timeout==5.0.1</code></li>
<li>That clashes with <code>langchain==0.3.15: aiohttp&gt;=3.8.3, &lt;4.0.0</code></li>
<li>We run conflict resolution / unit propagation with langchain and aiohttp, with aiohttp winning because it was selected first</li>
<li>We get the undesirable resolution</li>
</ul>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:32:58 UTC
    </footer>
</body>
</html>
