<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consider `execv` for `uv run` on Unix - astral-sh/uv #3095</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Consider <code>execv</code> for <code>uv run</code> on Unix</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/3095">#3095</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-04-17 16:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-17 16:20</div>
            <div class="timeline-body"><p>See https://github.com/astral-sh/uv/pull/3074#issuecomment-2060847595</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @zanieb by @zanieb on 2024-04-17 16:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @zanieb on 2024-04-17 16:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bluss">@bluss</a> on 2024-04-21 14:04</div>
            <div class="timeline-body"><p>Edit: The below concern has found other solutions since then, and is not really relevant.</p>
<p>For the https://github.com/bluss/pyproject-local-kernel usecase (sorry if this is boring), spawn vs exec would make a difference on Linux in terms of how a jupyter notebook is kernel is launched.</p>
<p>jupyter lab launches my python script -&gt; launches uv run -&gt; launches ipykernel.</p>
<p>My script already handles forwarding posix signals to the child (first arrow). If you use exec, the second arrow disappears and posix signals are forwarded to the ipykernel which is useful, in fact the ipykernel doesn't want to start correctly if it doesn't have that signal path. I think exec is generally what you'd want to do. I didn't run into this with rye run, because it uses exec on Linux.</p>
<p>I could configure my kernel <a href="https://jupyter-client.readthedocs.io/en/latest/kernels.html#kernel-specs">with interrupt_mode=message</a> (instead of default signal) to make this issue disappear, but maybe that shouldn't be needed. (Edit, no interrupt_mode=message is only fully supported on Linux, not on Windows, so this is not a great option).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bluss">@bluss</a> on 2024-07-21 13:55</div>
            <div class="timeline-body"><p>Is this still possible, how does the ephemeral venv cleanup work? Is it using a scope based cleanup. I'll file another issue that's related to ipykernel, and maybe we'll find a good solution.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-21 14:55</div>
            <div class="timeline-body"><p>It is not clear how we'd clean up the ephemeral environment, that's a good question.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-21 15:05</div>
            <div class="timeline-body"><p>It runs on Drop.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bluss">@bluss</a> on 2024-07-24 18:50</div>
            <div class="timeline-body"><p>The pyproject-local-kernel usecase seems to work perfectly on Linux now after the #5257 fix I think :star_struck:. Probably should carry over to windows too. Thanks for the help with this :slightly_smiling_face:</p>
<p>uv run --with ipykernel is perfect for the notebook use case, it's very smooth.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-24 18:56</div>
            <div class="timeline-body"><p>Awesome. I did test on my Windows machine and it worked as expected for me, so hopefully good there too...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-04 21:29</div>
            <div class="timeline-body"><p>When you <code>execv</code> is nothing dropped until the process exits? I'm quite naive as to how that is handled. cc @BurntSushi</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-10-07 12:43</div>
            <div class="timeline-body"><p>Basically, you can think of <code>execv</code> (and related functions) as like a <code>std::process::exit</code>. It can be inserted anywhere in your program, and it will unceremoniously stop executing the current program. Destructors are not guaranteed to run.</p>
<p>So to make this work here, we'd probably want to bubble some instruction to &quot;run this <code>exec</code> command&quot; to <code>main</code> in a way that everything else goes out of scope and gets dropped. Otherwise, you'll not just have things like an ephemeral environment hanging around, but all the various allocations and file descriptors won't get dropped either (they will eventually by the OS once the replacing process terminates, AIUI).</p>
<p>Also, we are very likely already using <code>exec</code>. I think what is meant here is that we do not want to <em>fork</em> before an exec. Or stated at a higher level, we want to replace the current process with the thing we want to run.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-07 12:51</div>
            <div class="timeline-body"><p>Hm.. thanks for the details.</p>
<p>I think that supports my concern that we have resources e.g., the ephemeral environment, that can't be removed until the spawned process finishes which makes it hard to entirely cede control?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-10-07 13:19</div>
            <div class="timeline-body"><p>Oh I see, yes, hmmm. That is a conundrum. I am reminded of a trick where you can unlink a file but keep an open file descriptor to it, which at least on Unix, will keep the file around until the descriptor is closed. But, 1) I'm not sure how to make that scale to an entire directory tree and 2) I'm not sure if that concept works on Windows. Failing some trick like that, I'd guess the only way to do this is to introduce some kind of garbage collection? Not sure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-08 21:53</div>
            <div class="timeline-body"><p>Yeah I think the general form of the problem here is that <code>execv</code> won't run Drop, but it we Drop things before deferring to <code>execv</code>, we'll remove things we need like temporary directories.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-08 21:56</div>
            <div class="timeline-body"><p>This feels like a pretty significant blocker for switching to <code>execv</code> â€“ I think we might need to prioritize passing signals to the child in a robust manner?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-08 21:59</div>
            <div class="timeline-body"><p>Yeah, agreed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @zanieb by @zanieb on 2025-02-18 15:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-18 15:21</div>
            <div class="timeline-body"><p>Signal handling was improved https://github.com/astral-sh/uv/pull/11009</p>
<p>I think the <code>Drop</code> question remains a blocker. I'll leave this open for future consideration though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-04-21 15:38</div>
            <div class="timeline-body"><p>More signal handling changes in https://github.com/astral-sh/uv/pull/13017</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tapetersen">@tapetersen</a> on 2025-09-17 13:12</div>
            <div class="timeline-body"><p>While signal propagation to the child correctly solves many problems one issue it still creates is that it blocks systemd's ready-notification in default configuration as it ignores messages from any other process than the root process.
That can be worked around by also using <code>NotifyAccess=all</code> see  https://www.freedesktop.org/software/systemd/man/latest/systemd.service.html#NotifyAccess=</p>
<p>That also has it's downsides though.</p>
<p>Mostly adding as another usecase/reason where child process isn't really the same.</p>
<p>I still don't have a good Idea how handling cleanup in the general case of using exec instead of spawn would work but for the systemd-case it of course has it's own way of providing ethemereal or persistant directories for services which ideally would be used here as well (passed through env-vars as <code>$RUNTIMEDIR</code> and <code>$CACHEDIR</code> for those that would be relevant here).</p>
<p>In those cases something that can just set up the environment needed  somewhere specific and not care itself about would be useful but I'm not sure if it's useful enought that uv should include it.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:30:32 UTC
    </footer>
</body>
</html>
