```yaml
number: 14502
title: Env markers in dependency specifiers ignored?
type: issue
state: open
author: evertlammerts
labels:
  - question
assignees: []
created_at: 2025-07-08T09:24:48Z
updated_at: 2025-07-17T19:06:58Z
url: https://github.com/astral-sh/uv/issues/14502
synced_at: 2026-01-10T01:57:33Z
```

# Env markers in dependency specifiers ignored?

---

_Issue opened by @evertlammerts on 2025-07-08 09:24_

### Question

Am I correct in assuming that environment markers I use in dependency specifiers for a dependency in a dependency group are not considered when syncing requirements? Or am I just doing this wrong[^1]?

For example:
```toml
[dependency-groups]
test = [
    ...,
    "tensorflow==2.14.0; ( sys_platform == 'darwin' or platform_machine == 'aarch64' ) and python_version < '3.12'",
    "tensorflow-cpu>=2.14.0; sys_platform != 'darwin' and platform_machine != 'aarch64' and platform_machine != 'amd64' and python_version < '3.12'",
    "tensorflow-intel==2.18.0; platform_machine == 'amd64' and python_version < '3.13'",
    "numpy<2",
    ...
]
```

and then:
```bash
❯ uv sync
  × No solution found when resolving dependencies for split (python_full_version == '3.11.*' and sys_platform != 'darwin'):
  ╰─▶ Because tensorflow==2.14.0 depends on keras>=2.14.0,<2.15 and tensorflow-intel==2.18.0 depends on keras>=3.5.0, we can conclude that tensorflow-intel==2.18.0 and tensorflow{(python_full_version <
      '3.12' and platform_machine == 'aarch64') or (python_full_version < '3.12' and sys_platform == 'darwin')}==2.14.0 are incompatible.
      And because duckdb:dev depends on tensorflow{(python_full_version < '3.12' and platform_machine == 'aarch64') or (python_full_version < '3.12' and sys_platform == 'darwin')}==2.14.0, we can
      conclude that duckdb:dev and tensorflow-intel{python_full_version < '3.13' and platform_machine == 'amd64'}==2.18.0 are incompatible.
      And because duckdb:dev depends on tensorflow-intel{python_full_version < '3.13' and platform_machine == 'amd64'}==2.18.0 and your project requires duckdb:dev, we can conclude that your project's
      requirements are unsatisfiable.

[^1]: NOTE: I'

      hint: While the active Python version is 3.10, the resolution failed for other Python versions supported by your project. Consider limiting your project's supported Python versions using
      `requires-python`.
```

`tensorflow==2.14.0` and `tensorflow-intel==2.18.0` are mutually exclusive, but the environment markers I used make sure they're never installed on the same system:
* tensorflow: `sys_platform == 'darwin' or platform_machine == 'aarch64'` -> OSX (x86_64 and arm64) and Linux aarch64
* tensorflow-intel: `platform_machine == 'amd64'` -> Windows amd64

[^1]: NOTE: These dependencies are just there for running tests, locally and in CI. I'm trying to get as much coverage as possible on as many platforms as possible. 

### Platform

_No response_

### Version

uv 0.7.14 (Homebrew 2025-06-23)

---

_Label `question` added by @evertlammerts on 2025-07-08 09:24_

---

_Comment by @konstin on 2025-07-08 09:36_

In your case, where two packages with a different name are mutually exclusive, the resolver still tries to do perform a single resolution, as it does not recognize the disjointness in the conflict between the two tensorflows. You can manually get different resolution using `tool.uv.environments` (https://docs.astral.sh/uv/concepts/resolution/#limited-resolution-environments). Additionally, we have to add `sys_platform != 'darwin'` for tensorflow-intel, to ensure that we don't have overlap for Intel Macs. This is a full example that resolves for me, you may need to adapt the environments for your needs:

```toml
[project]
name = "debug"
version = "0.1.0"
requires-python = ">=3.9"

[tool.uv]
environments = [
  "(sys_platform == 'darwin' or platform_machine == 'aarch64') and python_version < '3.12'",
  "sys_platform != 'darwin' and platform_machine != 'aarch64' and platform_machine != 'amd64' and python_version < '3.12'",
  "platform_machine == 'amd64' and sys_platform != 'darwin' and python_version < '3.13'",
]

[dependency-groups]
test = [
  "tensorflow==2.14.0; (sys_platform == 'darwin' or platform_machine == 'aarch64') and python_version < '3.12'",
  "tensorflow-cpu>=2.14.0; sys_platform != 'darwin' and platform_machine != 'aarch64' and platform_machine != 'amd64' and python_version < '3.12'",
  "tensorflow-intel==2.18.0; platform_machine == 'amd64' and sys_platform != 'darwin' and python_version < '3.13'",
  "numpy<2",
]

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"
``` 

---

_Comment by @evertlammerts on 2025-07-08 14:59_

Thanks for the quick reply @konstin! I've learned a lot about dependency resolution with uv today. One thing that caught me was definitely the way universal resolution works with environments. Only after I defined my environments, resolution started to make (some) sense.

My environments are now as follows:
```toml
[tool.uv]
environments = [ # no need to resolve packages beyond these platforms with uv...
    "python_version >= '3.9' and sys_platform == 'darwin' and platform_machine == 'arm64'",
    "python_version >= '3.9' and sys_platform == 'darwin' and platform_machine == 'x86_64'",
    "python_version >= '3.9' and sys_platform == 'win32' and platform_machine == 'AMD64'",
    "python_version >= '3.9' and sys_platform == 'linux' and platform_machine == 'x86_64'",
    "python_version >= '3.9' and sys_platform == 'linux' and platform_machine == 'aarch64'",
]
required-environments = [ # ... but do always resolve for all of them
    "python_version >= '3.9' and sys_platform == 'darwin' and platform_machine == 'arm64'",
    "python_version >= '3.9' and sys_platform == 'darwin' and platform_machine == 'x86_64'",
    "python_version >= '3.9' and sys_platform == 'win32' and platform_machine == 'AMD64'",
    "python_version >= '3.9' and sys_platform == 'linux' and platform_machine == 'x86_64'",
    "python_version >= '3.9' and sys_platform == 'linux' and platform_machine == 'aarch64'",
]
```

Omitting `python_version` from the markers changes the way resolution works in a way I don't understand.
* First of all I was surprised that `requires-python = ">=3.9.0"` seems to be ignored. That may have to do with semantics I'm not aware of, but it was certainly a surprise.
* Second, omitting the `python_version >= '3.9'` marker has surprising consequences. For example, it resolved pytorch as follows:

        [[packages]]
        name = "torch"
        version = "2.7.1+cpu"
        marker = "(platform_machine == 'x86_64' and sys_platform == 'darwin') or (platform_machine == 'aarch64' and sys_platform == 'linux') or (platform_machine == 'x86_64' and sys_platform == 'linux') or (platform_machine == 'AMD64' and sys_platform == 'win32')"
        index = "https://download.pytorch.org/whl/cpu"
        wheels = [ ... bunch of wheels for linux and windows ... ]

    which is incorrect, because there is no available wheel for `(platform_machine == 'x86_64' and sys_platform == 'darwin')`. The problem _might_ be that the resolver just adds all my markers to the `marker` field of the dependency? I'm not quite sure. 

Whatever was happening there, my takeaway is this:
1. `tool.uv.environments` limits resolving to the listed envs
2. `tool.uv.required-environments` forces all dependencies to resolve to the listed envs, while respecting the markers in the dependency specifiers
3. not specifying a dimension in an environment may result in undefined behavior - e.g. omitting `python_version` might result in resolving for a different set of python versions than you expect.

---

_Comment by @konstin on 2025-07-08 15:15_

> Omitting `python_version` from the markers changes the way resolution works in a way I don't understand.

Can you share an MRE for that? I tried the following with and without `python_vestion >= "3.9"` and got the same result:

```
[project]
name = "debug"
version = "0.1.0"
requires-python = ">=3.9"

[tool.uv]
environments = [ # no need to resolve packages beyond these platforms with uv...
  "sys_platform == 'darwin' and platform_machine == 'arm64'",
  "sys_platform == 'darwin' and platform_machine == 'x86_64'",
  "sys_platform == 'win32' and platform_machine == 'AMD64'",
  "sys_platform == 'linux' and platform_machine == 'x86_64'",
  "sys_platform == 'linux' and platform_machine == 'aarch64'",
]
required-environments = [ # ... but do always resolve for all of them
  "sys_platform == 'darwin' and platform_machine == 'arm64'",
  "sys_platform == 'darwin' and platform_machine == 'x86_64'",
  "sys_platform == 'win32' and platform_machine == 'AMD64'",
  "sys_platform == 'linux' and platform_machine == 'x86_64'",
  "sys_platform == 'linux' and platform_machine == 'aarch64'",
]

[dependency-groups]
test = [
  "tensorflow==2.14.0; (sys_platform == 'darwin' or platform_machine == 'aarch64') and python_version < '3.12'",
  "tensorflow-cpu>=2.14.0; sys_platform != 'darwin' and platform_machine != 'aarch64' and platform_machine != 'amd64' and python_version < '3.12'",
  "tensorflow-intel==2.18.0; platform_machine == 'amd64' and sys_platform != 'darwin' and python_version < '3.13'",
  "numpy<2",
]
```

What indexes are you using, are those the same as in https://docs.astral.sh/uv/guides/integration/pytorch/?

---

_Comment by @evertlammerts on 2025-07-08 16:43_

Hm, I may have been wrong about the python version... but there are still some things I don't get.

With the below config:
1. `uv export --only-group test --no-emit-project --format pylock.toml` on the below config **without** `required-environments` ([gist with the resulting pylock.toml](https://gist.github.com/evertlammerts/821d8aba951efc8efc0f433ea35c61dc#file-pylock-toml-L130)) resolves `torch==2.7.1+cpu` for marker `(platform_machine == 'x86_64' and sys_platform == 'darwin')`, but a wheel does not exist for that platform.
2. `uv export --only-group test --no-emit-project --format pylock.toml` on the below config **with** `required-environments` ([gist with the resulting pylock.toml](https://gist.github.com/evertlammerts/206715fde51d5fcfa4c913499c338660#file-pylock-toml-L130)) resolves `torch==2.2.2` for marker `platform_machine == 'x86_64' and sys_platform == 'darwin'`, which does exist for cp39-cp312, but not for cp313.

Both aren't what I expect. But that may be because I don't understand the semantics of `environments` and `required-environments`.

```toml
[project]
name = "mre"
version = "0.1.0"
requires-python = ">=3.9"

[[tool.uv.index]]
name = "pytorch-cpu"
url = "https://download.pytorch.org/whl/cpu"
explicit = true

[tool.uv.sources]
torch = [ { index = "pytorch-cpu" } ]
torchvision = [ { index = "pytorch-cpu" } ]

[tool.uv]
environments = [ # no need to resolve packages beyond these platforms with uv...
    "python_version >= '3.9' and sys_platform == 'darwin' and platform_machine == 'arm64'",
    "python_version >= '3.9' and sys_platform == 'darwin' and platform_machine == 'x86_64'",
    "python_version >= '3.9' and sys_platform == 'win32' and platform_machine == 'AMD64'",
    "python_version >= '3.9' and sys_platform == 'linux' and platform_machine == 'x86_64'",
    "python_version >= '3.9' and sys_platform == 'linux' and platform_machine == 'aarch64'",
]
required-environments = [ # ... but do always resolve for all of them
    "python_version >= '3.9' and sys_platform == 'darwin' and platform_machine == 'arm64'",
    "python_version >= '3.9' and sys_platform == 'darwin' and platform_machine == 'x86_64'",
    "python_version >= '3.9' and sys_platform == 'win32' and platform_machine == 'AMD64'",
    "python_version >= '3.9' and sys_platform == 'linux' and platform_machine == 'x86_64'",
    "python_version >= '3.9' and sys_platform == 'linux' and platform_machine == 'aarch64'",
]

[dependency-groups]
test = [
  "torch>=2.2.2",
]
```

---

_Comment by @konstin on 2025-07-17 19:06_

Looking at https://download.pytorch.org/whl/torch/, there doesn't seem to be any cp313 macos wheel. We should handle this better and actually complain when `python_version >= '3.13' and sys_platform == 'darwin' and platform_machine == 'x86_64'` doesn't have a wheel, but for the use case there seems to be no support from the torch side.

---
