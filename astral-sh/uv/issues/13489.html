<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv downgrades unrelated s3fs package due to aiobotocore and boto3 version incompatibility - astral-sh/uv #13489</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>uv downgrades unrelated s3fs package due to aiobotocore and boto3 version incompatibility</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/13489">#13489</a>
        opened by <a href="https://github.com/cas--">@cas--</a>
        on 2025-05-16 12:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/cas--">@cas--</a> on 2025-05-16 12:40</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Encountered strange bug where s3fs is downgraded to an ancient package due to conflict between aiobotocore and latest boto3</p>
<p>First add fsspec with s3 extra and can see s3fs latest version 2025.3.2 is installed:</p>
<pre><code>❯ uv add fsspec[s3]
Resolved 20 packages in 11ms
Installed 19 packages in 250ms
 + aiobotocore==2.22.0
 + aiohappyeyeballs==2.6.1
 + aiohttp==3.11.18
 + aioitertools==0.12.0
 + aiosignal==1.3.2
 + attrs==25.3.0
 + botocore==1.37.3
 + frozenlist==1.6.0
 + fsspec==2025.3.2
 + idna==3.10
 + jmespath==1.0.1
 + multidict==6.4.3
 + propcache==0.3.1
 + python-dateutil==2.9.0.post0
 + s3fs==2025.3.2
 + six==1.17.0
 + urllib3==2.4.0
 + wrapt==1.17.2
 + yarl==1.20.0
</code></pre>
<p>Then add boto3 and it upgrades <code>botocore</code>, notably to a  version not compatible with <code>aiobotocore</code> which results in <code>s3fs</code> being downgraded to a really old version <code>0.4.2</code>:</p>
<pre><code>❯ uv add boto3
Resolved 10 packages in 8.67s
Uninstalled 2 packages in 50ms
Installed 4 packages in 228ms
 + boto3==1.38.17
 - botocore==1.37.3
 + botocore==1.38.17
 - s3fs==2025.3.2
 + s3fs==0.4.2
 + s3transfer==0.12.0
</code></pre>
<p>For reference here are the install requirements (parsed by setup.py into <code>install_requires</code>) for s3fs:</p>
<ul>
<li>https://github.com/fsspec/s3fs/blob/main/requirements.txt</li>
<li>https://github.com/fsspec/s3fs/blob/0.4.2/requirements.txt</li>
</ul>
<p>With pip it generates an error but still installs latest boto3 and leaves s3fs</p>
<pre><code>❯ pip install fsspec[s3]
Successfully installed aiobotocore-2.22.0 aiohappyeyeballs-2.6.1 aiohttp-3.11.18 aioitertools-0.12.0 aiosignal-1.3.2 attrs-25.3.0 botocore-1.37.3 frozenlist-1.6.0 fsspec-2025.3.2 idna-3.10 jmespath-1.0.1 multidict-6.4.3 propcache-0.3.1 python-dateutil-2.9.0.post0 s3fs-2025.3.2 six-1.17.0 urllib3-2.4.0 wrapt-1.17.2 yarl-1.20.0

❯ pip install boto3
...
ERROR: pip's dependency resolver does not currently take into account all the packages that are installed. This behaviour is the source of the following dependency conflicts.
aiobotocore 2.22.0 requires botocore&lt;1.37.4,&gt;=1.37.2, but you have botocore 1.38.17 which is incompatible.
Successfully installed boto3-1.38.17 botocore-1.38.17 s3transfer-0.12.0

❯ pip list
Package          Version
---------------- -----------
aiobotocore      2.22.0
aiohappyeyeballs 2.6.1
aiohttp          3.11.18
aioitertools     0.12.0
aiosignal        1.3.2
attrs            25.3.0
boto3            1.38.17
botocore         1.38.17
frozenlist       1.6.0
fsspec           2025.3.2
idna             3.10
jmespath         1.0.1
multidict        6.4.3
pip              24.2
propcache        0.3.1
python-dateutil  2.9.0.post0
s3fs             2025.3.2
s3transfer       0.12.0
six              1.17.0
urllib3          2.4.0
wrapt            1.17.2
yarl             1.20.0
</code></pre>
<p>The workaround for now is to specify boto3 1.37 but it was not obvious that this should be the solution:</p>
<pre><code>❯ uv add boto3==1.37
Resolved 10 packages in 484ms
Prepared 3 packages in 1.80s
Uninstalled 3 packages in 143ms
Installed 3 packages in 105ms
 - boto3==1.38.17
 + boto3==1.37.0
 - botocore==1.38.17
 + botocore==1.37.38
 - s3transfer==0.12.0
 + s3transfer==0.11.5

❯ uv sync --upgrade
Resolved 22 packages in 575ms
Prepared 3 packages in 194ms
Uninstalled 3 packages in 40ms
Installed 3 packages in 238ms
 - botocore==1.37.38
 + botocore==1.37.3
 - s3fs==0.4.2
 + s3fs==2025.3.2
 - s3transfer==0.11.5
 + s3transfer==0.11.3
</code></pre>
<h3>Platform</h3>
<p>Ubuntu 22.04</p>
<h3>Version</h3>
<p>0.7.4</p>
<h3>Python version</h3>
<p>Python 3.12.6</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @cas-- on 2025-05-16 12:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-05-16 13:03</div>
            <div class="timeline-body"><p>Both are valid solution from the point of a resolver: uv can't tell which is the better resolution of the two if there is a choice of one of two packages to downgrade. If you require specific minimum version, either you or the project that includes the package originally needs to declare the minimum version. In your case boto3 is a direct dependency, so it is preferred for having a higher version over the transitive dependency s3fs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @konstin on 2025-05-16 13:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @konstin on 2025-05-16 13:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cas--">@cas--</a> on 2025-05-16 14:03</div>
            <div class="timeline-body"><p>Thanks for feedback, I think I can now see what's occurring, I missed that uv in the end removed aiobotocore and that's how it ended up with oldest compatible s3fs.</p>
<p>I was following <a href="https://github.com/fsspec/universal_pathlib/">universal_pathlib</a> recommendation of using <code>fsspec[s3]</code> but seems in this instance specifying <code>s3fs</code> prevents this resolving to older version instead of pinning boto3:</p>
<pre><code class="language-diff"> dependencies = [
+    &quot;boto3&gt;=1.37.3&quot;,
-    &quot;fsspec[s3]&gt;=2025.3.2&quot;,
+    &quot;s3fs&gt;=2025.3.2&quot;,
 ]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @cas-- on 2025-05-16 14:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:27 UTC
    </footer>
</body>
</html>
