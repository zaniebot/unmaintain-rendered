<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Less concise simplification of markers in uv 0.2.35 - astral-sh/uv #6295</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Less concise simplification of markers in uv 0.2.35</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/6295">#6295</a>
        opened by <a href="https://github.com/A5rocks">@A5rocks</a>
        on 2024-08-21 02:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/A5rocks">@A5rocks</a></div>
            <div class="timeline-body">

<p>Noticed in <a href="https://github.com/python-trio/trio/pull/3068">python-trio/trio#3068</a>, I haven&#x27;t tried to get a smaller case. The command is <code>uv pip compile --universal --python-version=3.8 test-requirements.in -o test-requirements.txt</code>. Platform is Ubuntu, <code>uv</code> is version 0.3.0 but we didn&#x27;t run <code>uv --version</code>.</p>
<p>uv 0.3.0 tries to make this change:</p>
<pre><code>-colorama==0.4.6 ; sys_platform == &#x27;win32&#x27; or (implementation_name == &#x27;cpython&#x27; and platform_system == &#x27;Windows&#x27;)
+colorama==0.4.6 ; (implementation_name != &#x27;cpython&#x27; and sys_platform == &#x27;win32&#x27;) or (platform_system != &#x27;Windows&#x27; and sys_platform == &#x27;win32&#x27;) or (implementation_name == &#x27;cpython&#x27; and platform_system == &#x27;Windows&#x27;)
</code></pre>
<p>This might mean <a href="https://github.com/astral-sh/uv/pull/5898">astral-sh/uv#5898</a> doesn&#x27;t simplify in this case as well. Maybe it&#x27;s missing some necessary case?</p>
<p>Why is <code>(implementation_name != &#x27;cpython&#x27; and sys_platform == &#x27;win32&#x27;) or (platform_system != &#x27;Windows&#x27; and sys_platform == &#x27;win32&#x27;) or (implementation_name == &#x27;cpython&#x27; and platform_system == &#x27;Windows&#x27;)</code> equivalent? (just to show the previous result wasn&#x27;t just a bug and since it was a bit confusing to me)</p>
<p>| markers | why is this equivalent |
|--------|--------|
| <code>(implementation_name != &#x27;cpython&#x27; and sys_platform == &#x27;win32&#x27;) or (platform_system != &#x27;Windows&#x27; and sys_platform == &#x27;win32&#x27;) or (implementation_name == &#x27;cpython&#x27; and platform_system == &#x27;Windows&#x27;)</code> | its what we start with |
| <code>(sys_platform == &#x27;win32&#x27; and (implementation_name != &#x27;cpython&#x27; or platform_system != &#x27;Windows&#x27;)) or (implementation_name == &#x27;cpython&#x27; and platform_system == &#x27;Windows&#x27;)</code> | distribution |
| <code>((implementation_name == &#x27;cpython&#x27; and platform_system == &#x27;Windows&#x27;) or (sys_platform == &#x27;win32&#x27;)) and ((implementation_name == &#x27;cpython&#x27; and platform_system == &#x27;Windows&#x27;) or (implementation_name != &#x27;cpython&#x27; or platform_system != &#x27;Windows&#x27;))</code> | distribution |
| <code>((implementation_name == &#x27;cpython&#x27; and platform_system == &#x27;Windows&#x27;) or (sys_platform == &#x27;win32&#x27;)) and ((implementation_name == &#x27;cpython&#x27; and platform_system == &#x27;Windows&#x27;) or NOT (implementation_name == &#x27;cpython&#x27; and platform_system == &#x27;Windows&#x27;))</code> | demorgan&#x27;s law |
| <code>((implementation_name == &#x27;cpython&#x27; and platform_system == &#x27;Windows&#x27;) or (sys_platform == &#x27;win32&#x27;)) and TRUE</code> | negation |
| <code>(implementation_name == &#x27;cpython&#x27; and platform_system == &#x27;Windows&#x27;) or (sys_platform == &#x27;win32&#x27;)</code> | identity |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/A5rocks">@A5rocks</a> on 2024-08-21 02:37</div>
            <div class="timeline-body"><p>Minimal reproduction:</p>
<p><code>x.in</code>:</p>
<pre><code>pytest &gt;= 5.0
black; implementation_name == &quot;cpython&quot;
</code></pre>
<p>Then run <code>uv pip compile x.in --no-strip-markers</code>. I can reproduce this in 0.2.35 and not in 0.2.34. <code>uv --version</code>: <code>uv 0.2.35 (e097f948c 2024-08-09)</code>, reproducing on Windows.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Less concise simplification in uv 0.3.0&#x27;s pip-compile universal mode&quot; to &quot;Less concise simplification of markers in uv 0.2.35&quot; by <a href="https://github.com/A5rocks">@A5rocks</a> on 2024-08-21 02:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-21 02:39</div>
            <div class="timeline-body"><p>I believe this is because we simplify to DNF as a normalized representation. In some cases, though, CNF would be more concise. I think this can be merged into <a href="https://github.com/astral-sh/uv/issues/5992">astral-sh/uv#5992</a>, but let me know if you disagree.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/A5rocks">@A5rocks</a> on 2024-08-21 02:44</div>
            <div class="timeline-body"><p>I don&#x27;t think so, because the simpler version only has <code>or</code> at the top level. But maybe that&#x27;s preventing one of the simplification steps?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wish</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-21 02:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-08-21 13:46</div>
            <div class="timeline-body"><p>Here&#x27;s a comment from our code for DNF simplification:</p>
<pre><code>/// Simplifies a DNF expression.
///
/// A decision diagram is canonical, but only for a given variable order. Depending on the
/// pre-defined order, the DNF expression produced by a decision tree can still be further
/// simplified.
///
/// For example, the decision diagram for the expression `A or B` will be represented as
/// `A or (not A and B)` or `B or (not B and A)`, depending on the variable order. In both
/// cases, the negation in the second clause is redundant.
///
/// Completely simplifying a DNF expression is NP-hard and amounts to the set cover problem.
/// Additionally, marker expressions can contain complex expressions involving version ranges
/// that are not trivial to simplify. Instead, we choose to simplify at the boolean variable
/// level without any truth table expansion. Combined with the normalization applied by decision
/// trees, this seems to be sufficient in practice.
///
/// Note: This function has quadratic time complexity. However, it is not applied on every marker
/// operation, only to user facing output, which are typically very simple.
</code></pre>
<p>The main issue here is that DNF on its own isn&#x27;t actually unique. And full simplification might not be feasible. But I think this might require more investigation. But I think this can be safely folded into #5992, which is, I think, the same problem that is reported here: the marker is correct but not as simple as it could be.</p>
<p>It is really important though that we have something approach a canonical representation for markers, otherwise the lock file might not be stable. This may come at the cost of concise markers.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">duplicate</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-08-21 13:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-08-21 13:50</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:32:53 UTC
    </footer>
</body>
</html>
