<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv tree` shows a transitive dependency at the same depth (root) than the current package - astral-sh/uv #17160</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`uv tree` shows a transitive dependency at the same depth (root) than the current package</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/17160">#17160</a>
        opened by <a href="https://github.com/AlexandreDecan">@AlexandreDecan</a>
        on 2025-12-17 08:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/AlexandreDecan">@AlexandreDecan</a> on 2025-12-17 08:13</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Hello,</p>
<p>I'm currently running several experiments to simulate the installation of various Python packages through time. The process is basically the following one: (1) Create an empty project called &quot;root&quot;; (2) Add the target package as a dependency; (3) Display the dependency tree. With this process, the dependency tree should be something like &quot;root &gt; target_package &gt; [TREE of the target package]&quot;. However, I found many cases where additional packages are reported in the tree, at the same level than <code>root</code>.</p>
<p>Consider the following example with <code>apache-airflow-providers-trino</code> in version <code>4.3.0</code>, whose installation is simulated on <code>2023-01-01</code> with Python 3.11. We start by creating the bare project:
<code>uv init . --bare --name root --python 3.11</code>
Then we add the target package as a dependency:
<code>uv add apache-airflow-providers-trino==4.3.0 --exclude-newer 2023-01-01 --no-sync --python 3.11</code>
A quick look at the <code>pyproject.toml</code> confirms that only <code>apache-airflow-providers-trino</code> was added as a direct dependency:
<code>cat pyproject.toml</code> returns:</p>
<pre><code>[project]
name = &quot;root&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.11&quot;
dependencies = [
    &quot;apache-airflow-providers-trino==4.3.0&quot;,
]
</code></pre>
<p>Then, I use <code>uv tree</code> to display the dependency tree. Since the tree is quite large, I limit its depth to 1 and truncate the output to the first few lines (this is enough to see the &quot;issues&quot;):
<code>uv tree --no-dev --no-dedupe --quiet --depth 1 | head -5 </code></p>
<p>This displays:</p>
<pre><code>root v0.1.0
└── apache-airflow-providers-trino v4.3.0
apache-airflow-core v3.1.5
├── a2wsgi v1.10.10
├── aiosqlite v0.22.0

</code></pre>
<p>My question is: why is <code>apache-airflow-core</code> being reported at the same level than <code>root</code>? It should be somewhere nested below <code>apache-airflow-providers-trino</code> (and actually is reported there as well) only.</p>
<p>Thanks!</p>
<h3>Platform</h3>
<p>Linux 6.17.9-300.fc43.x86_64 x86_64 GNU/Linux</p>
<h3>Version</h3>
<p>uv 0.9.15</p>
<h3>Python version</h3>
<p>3.11</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexandreDecan on 2025-12-17 08:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "uv tree shows a transitive dependency as a direct one" to "`uv tree` shows a transitive dependency as the same level than the current package" by @AlexandreDecan on 2025-12-17 08:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "`uv tree` shows a transitive dependency as the same level than the current package" to "`uv tree` shows a transitive dependency at the same depth (root) than the current package" by @AlexandreDecan on 2025-12-17 08:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-12-17 10:52</div>
            <div class="timeline-body"><p>This is definitively a bug.</p>
<p>MRE:</p>
<pre><code class="language-toml">[project]
name = &quot;debug&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.11&quot;
dependencies = [
  &quot;apache-airflow&quot;,
]
</code></pre>
<p>The problem is that our cycle removing code is orphaning an apache node. When adding some debug prints in <code>TreeDisplay</code>:</p>
<pre><code>$ uv tree
Resolved 127 packages in 7ms
Removing cycle edge: Some((NodeIndex(2), NodeIndex(3)))
Removing cycle edge: Some((NodeIndex(4), NodeIndex(3)))
NodeIndex(0) Root
NodeIndex(1) Package(PackageId { name: PackageName(&quot;debug&quot;), version: Some(&quot;0.1.0&quot;), source: Editable(&quot;&quot;) })
NodeIndex(2) Package(PackageId { name: PackageName(&quot;apache-airflow&quot;), version: Some(&quot;3.1.5&quot;), source: Registry(Url(UrlString(&quot;https://pypi.org/simple&quot;))) })
NodeIndex(3) Package(PackageId { name: PackageName(&quot;apache-airflow-core&quot;), version: Some(&quot;3.1.5&quot;), source: Registry(Url(UrlString(&quot;https://pypi.org/simple&quot;))) })
NodeIndex(4) Package(PackageId { name: PackageName(&quot;apache-airflow-task-sdk&quot;), version: Some(&quot;1.1.5&quot;), source: Registry(Url(UrlString(&quot;https://pypi.org/simple&quot;))) })
NodeIndex(5) Package(PackageId { name: PackageName(&quot;a2wsgi&quot;), version: Some(&quot;1.10.10&quot;), source: Registry(Url(UrlString(&quot;https://pypi.org/simple&quot;))) })
</code></pre>
<pre><code>debug v0.1.0
└── apache-airflow v3.1.5
    ├── apache-airflow-core v3.1.5
    │   ├── a2wsgi v1.10.10
    │   ├── aiosqlite v0.22.0
...
    └── apache-airflow-task-sdk v1.1.5 (*)
apache-airflow-core v3.1.5 (*)
(*) Package tree already displayed
</code></pre>
<p>CC @charliermarsh re https://github.com/astral-sh/uv/pull/8564, it looks like we're removing edges in a reachable cycle, but I don't understand why we're defining roots as having no incoming edges, instead of starting at the workspace members.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexandreDecan">@AlexandreDecan</a> on 2025-12-17 11:24</div>
            <div class="timeline-body"><p>I'm glad I found something useful :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/17212.html">astral-sh/uv#17212</a> on 2025-12-21 22:53</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:06 UTC
    </footer>
</body>
</html>
