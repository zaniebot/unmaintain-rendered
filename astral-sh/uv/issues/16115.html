<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dependencies for irrelevant platform markers should be ignored during `uv sync` - astral-sh/uv #16115</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Dependencies for irrelevant platform markers should be ignored during `uv sync`</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/16115">#16115</a>
        opened by <a href="https://github.com/mmisiewicz">@mmisiewicz</a>
        on 2025-10-03 14:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/mmisiewicz">@mmisiewicz</a> on 2025-10-03 14:59</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I have a pyproject.toml that supports a project which depends on CUDA Torch. This project needs to work on both amd64 and arm64 hosts. However, torch builds with cuda support for arm64 are not published to pypi, so we host a wheel on an internal server (x86-64 <em>is</em> pushed to pypi available to the internet). I have the following pyproject.toml:</p>
<pre><code>[project]
name = &quot;footer&quot;
version = &quot;0.1.0&quot;
description = &quot;foo&quot;
readme = &quot;README.md&quot;
requires-python = &quot;==3.12.*&quot;
dependencies = [
    &quot;fastapi[standard]&gt;=0.115.6&quot;,
    &quot;rich&gt;=13.9.4&quot;,
    &quot;sentence-transformers&gt;=3.3.1&quot;,
    &quot;starlette-compress&gt;=1.4.0&quot;,
    &quot;torch&gt;=2.5.1&quot;,
]

# Torch needs to be installed from the nightly repo, since CUDA ARM builds are not currently being pushed to pypi.
[tool.uv.sources]
torch = [
    # gets nightly pytoch cuda for arm linux machines, everyone else uses the regular stable
    { url = &quot;http://internal-server.net/bin/torch-2.5.0a0+gita8d6afb-cp312-cp312-linux_aarch64.whl&quot;, marker = &quot;sys_platform == 'linux' and platform_machine == 'aarch64'&quot; },
]

[[tool.uv.index]]
name = &quot;pytorch-nightly&quot;
url = &quot;https://download.pytorch.org/whl/nightly/cu126&quot;
explicit = true
</code></pre>
<p>The issue is, our host <code>internal-server.net</code> went down and exposed the following issue while running <code>uv sync</code>:</p>
<pre><code>14.69   Caused by: Failed to fetch: `http://internal-server.net/bin/torch-2.5.0a0+gita8d6afb-cp312-cp312-linux_aarch64.whl`
14.69   Caused by: Request failed after 3 retries
14.69   Caused by: error sending request for url (http://internal-server.net/bin/torch-2.5.0a0+gita8d6afb-cp312-cp312-linux_aarch64.whl)
14.69   Caused by: client error (Connect)
14.69   Caused by: tcp connect error
14.69   Caused by: Host is unreachable (os error 113)
------

</code></pre>
<p>Given that the sync command is running on an amd64 platform, why are dependencies for arm64 being retrieved at all? Since this wheel is about 1GiB size, it's a significant resource draw, and not necessary at all. The offline server exposed this issue.</p>
<p>Can platform markers be checked before downloading remote wheels?</p>
<h3>Platform</h3>
<p>Ubuntu  Linux 5.15.0-140-generic x86_64 GNU/Linux</p>
<h3>Version</h3>
<p>0.8.22</p>
<h3>Python version</h3>
<p>3.12</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @mmisiewicz on 2025-10-03 14:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-11-01 21:03</div>
            <div class="timeline-body"><p>In order to create, update, or validate a <code>uv.lock</code> file, uv needs to be able to access all of the declared dependencies to extract their metadata -- even those that won't ultimately be installed. So it's correct for uv to look in the <code>internal-server.net</code> registry even on non-ARM machines, as the lockfile is intended to be used across <em>all</em> platforms.</p>
<p>If you create a <code>uv.lock</code> and check it in, you can (e.g.) install on a non-ARM machine using <code>uv sync --frozen</code> and we won't hit that index. In other words, if the lockfile already exists, uv can use it and doesn't require access to dependencies it won't install; but to <em>create</em> (or update, or validate) the lockfile, we need access to all of them.</p>
<p>As an aside, it's not inherently necessary to download entire wheels just to determine their dependencies. If your server supports <a href="https://peps.python.org/pep-0658/">PEP 658</a>, uv can just fetch the <code>http://internal-server.net/bin/torch-2.5.0a0+gita8d6afb-cp312-cp312-linux_aarch64.whl.metadata</code> file; or if your server supports range requests, uv can extract it with range requests. (For example, all of PyPI supports PEP 658, so fetching metadata from PyPI does not require downloading wheels.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-11-01 21:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mmisiewicz">@mmisiewicz</a> on 2025-11-07 17:17</div>
            <div class="timeline-body"><p>Thank you for the incredibly helpful response @charliermarsh !</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:05 UTC
    </footer>
</body>
</html>
