<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv-managed python installed into .local/bin can't be used with venv module - astral-sh/uv #8821</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv-managed python installed into .local/bin can't be used with venv module</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/8821">#8821</a>
        opened by <a href="https://github.com/bluss">@bluss</a>
        on 2024-11-05 02:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/bluss">@bluss</a> on 2024-11-05 02:13</div>
            <div class="timeline-body"><p>uv 0.4.30</p>
<p><code>python3.12 -m venv</code> fails to create a virtual environment.</p>
<p>Steps how I reproduced this problem. Using <code>3.12.6</code> to use a version that was not already installed.</p>
<pre><code class="language-console">rm .local/bin/python3.12
uv python install --preview 3.12.6
# Installed Python 3.12.6 in 2.60s
#  + cpython-3.12.6-linux-x86_64-gnu (python3.12)
which python3.12
# /home/user/.local/bin/python3.12
python3.12 -V
# Python 3.12.6
python3.12 -m venv new_environment
# Error: Command '['/home/user/new_environment/bin/python3.12', '-m', 'ensurepip', '--upgrade', '--default-pip']' returned non-zero exit status 1.
</code></pre>
<p>Let's try execute the python in the venv:</p>
<pre><code>./new_environment/bin/python3.12
</code></pre>
<pre><code>Could not find platform independent libraries &lt;prefix&gt;
Could not find platform dependent libraries &lt;exec_prefix&gt;
Python path configuration:
  PYTHONHOME = (not set)
  PYTHONPATH = (not set)
  program name = './new_environment/bin/python3.12'
  isolated = 0
  environment = 1
  user site = 1
  safe_path = 0
  import site = 1
  is in build tree = 0
  stdlib dir = '/install/lib/python3.12'
  sys._base_executable = '/home/user/.local/share/uv/python/cpython-3.12.6-linux-x86_64-gnu/bin/python3.12'
  sys.base_prefix = '/install'
  sys.base_exec_prefix = '/install'
  sys.platlibdir = 'lib'
  sys.executable = '/home/user/new_environment/bin/python3.12'
  sys.prefix = '/install'
  sys.exec_prefix = '/install'
  sys.path = [
    '/install/lib/python312.zip',
    '/install/lib/python3.12',
    '/install/lib/python3.12/lib-dynload',
  ]
Fatal Python error: init_fs_encoding: failed to get the Python codec of the filesystem encoding
Python runtime state: core initialized
ModuleNotFoundError: No module named 'encodings'

Current thread 0x00007136928b6740 (most recent call first):
  &lt;no Python frame&gt;
</code></pre>
<p>Is the symlink in the virtual environment resolved? (no)</p>
<pre><code class="language-console">ls -l ./new_environment/bin/python3.12 
# lrwxrwxrwx 1 user user 33 nov  5 03:08 ./new_environment/bin/python3.12 -&gt; /home/user/.local/bin/python3.12*
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-05 02:13</div>
            <div class="timeline-body"><p>This is known and reported upstream: https://github.com/indygreg/python-build-standalone/issues/380</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">upstream</span> added by @charliermarsh on 2024-11-05 13:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/8879.html">astral-sh/uv#8879</a> on 2024-11-07 13:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-07 13:52</div>
            <div class="timeline-body"><p>See also #8429</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/garyo">@garyo</a> on 2024-12-12 22:02</div>
            <div class="timeline-body"><p>I'm running into this; uv-installed python symlinked into <code>$HOME/.local/bin</code> fails to create a working venv. I've read #8429 above and https://github.com/indygreg/python-build-standalone/issues/380 as well. Is there any workaround at the user level that I can use? My specific use case is in a github workflow; one of the actions calls <code>python -m venv .action-bin</code> and I can't change that, but I can adjust anything else beforehand.
I have uv 0.5.8, installed just now, into a CentOS 7 docker container.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-12-12 22:30</div>
            <div class="timeline-body"><p>I think <code>export PYTHONHOME=&quot;$(dirname $(dirname $(realpath $(which python))))&quot;</code> should work, though it's pretty hacky.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/garyo">@garyo</a> on 2024-12-12 22:48</div>
            <div class="timeline-body"><blockquote>
<p>I think <code>export PYTHONHOME=&quot;$(dirname $(dirname $(realpath $(which python))))&quot;</code> should work, though it's pretty hacky.</p>
</blockquote>
<p>Sadly, that doesn't work:</p>
<pre><code>[root@4b801b307a52 aswf]# curl -LsSf https://astral.sh/uv/install.sh | sh
System glibc version (`2.17') is too old; checking alternatives
downloading uv 0.5.8 x86_64-unknown-linux-musl-static
no checksums to verify
installing to /root/.local/bin
  uv
  uvx
everything's installed!

To add $HOME/.local/bin to your PATH, either restart your shell or run:

    source $HOME/.local/bin/env (sh, bash, zsh)
    source $HOME/.local/bin/env.fish (fish)
[root@4b801b307a52 aswf]# source ~/.local/bin/env
[root@4b801b307a52 aswf]# uv python install --preview 3.11
Installed Python 3.11.11 in 2.10s
 + cpython-3.11.11-linux-x86_64-gnu (python3.11)
[root@4b801b307a52 aswf]# (cd ~/.local/bin; ln -sf python3.11 python3; ln -sf python3.11 python)
[root@4b801b307a52 aswf]# which python
/root/.local/bin/python
[root@4b801b307a52 aswf]# python --version
Python 3.11.11
[root@4b801b307a52 aswf]# export PYTHONHOME=&quot;$(dirname $(dirname $(realpath $(which python))))&quot;
[root@4b801b307a52 aswf]# echo $PYTHONHOME
/root/.local/share/uv/python/cpython-3.11.11-linux-x86_64-gnu
[root@4b801b307a52 aswf]# python -mvenv foo
Error: Command '['/opt/aswf/foo/bin/python', '-m', 'ensurepip', '--upgrade', '--default-pip']' returned non-zero exit status 1.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-12-12 22:54</div>
            <div class="timeline-body"><p>Alas, if you use <code>--without-pip</code> it works fine. I'm... not sure why the <code>ensurepip</code> call fails there. Of course there's <code>VIRTUALENV_WITHOUT_PIP</code> but no <code>venv</code> equivalent to my knowledge.</p>
<p>Annoyingly, it works in isolation which makes it hard to inspect:</p>
<pre><code>❯ python -m venv .venv
Error: Command '['/Users/zb/workspace/uv/.venv/bin/python', '-m', 'ensurepip', '--upgrade', '--default-pip']' returned non-zero exit status 1.
 - pip==24.2
❯ .venv/bin/python -m ensurepip --upgrade --default-pip
Looking in links: /var/folders/6p/k5sd5z7j31b31pq4lhn0l8d80000gn/T/tmpgx6oozdb
Processing /var/folders/6p/k5sd5z7j31b31pq4lhn0l8d80000gn/T/tmpgx6oozdb/pip-24.2-py3-none-any.whl
Installing collected packages: pip
Successfully installed pip-24.2
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/garyo">@garyo</a> on 2024-12-13 17:00</div>
            <div class="timeline-body"><p>I ended up prepending the actual python bin dir to $PATH. That seems to work for me.</p>
<p>Details at https://github.com/AcademySoftwareFoundation/openfx/commit/8276ac8156b55147da6343765cb1211d81c6ef23 if anyone’s interested.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sgherdao">@sgherdao</a> on 2025-03-10 09:51</div>
            <div class="timeline-body"><p>this works for me</p>
<p><code>export PATH=$(dirname $(realpath $(which python))):$PATH</code></p>
<p>@garyo might be better than using <code>ls -1</code> which may not work if you have multiple python interpreter</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/12743.html">astral-sh/uv#12743</a> on 2025-04-08 17:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../scikit-image/scikit-image/issues/7783.html">scikit-image/scikit-image#7783</a> on 2025-05-02 10:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../moonrepo/plugins/issues/51.html">moonrepo/plugins#51</a> on 2025-05-17 21:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @jtfmumm by @jtfmumm on 2025-06-10 20:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/treyhunner">@treyhunner</a> on 2025-09-18 20:29</div>
            <div class="timeline-body"><p>I launch Python (REPL, scripts, venv, etc.) with different versions of Python frequently when teaching and am trying to use uv as a pyenv-replacement (and much more) by using <code>uv python install --default</code> and I ran across this issue while trying to create virtual environments in uv-managed Python versions.</p>
<p>@sgherdao's <code>PATH</code> hack worked for me for my default <code>python</code> command.</p>
<p>Since I need this for all installed Python versions, I am using this:</p>
<pre><code># Add all uv-managed Python tool bins to PATH
uv python list --managed-python --only-installed --color=never \
  | awk '{print $2}' \
  | tac \
  | while read python_executable; do
    python_bin_dir=&quot;$(dirname &quot;$python_executable&quot;)&quot;
    case &quot;:$PATH:&quot; in
      *&quot;:$python_bin_dir:&quot;*) :;; # Already in PATH
      *) PATH=&quot;$python_bin_dir:$PATH&quot;;; # Not yet in PATH
    esac
  done
</code></pre>
<p>The <code>tac</code> reverses the output (with the assumption that the newest Python versions come first and oldest last which <em>seems</em> to be the current output order of <code>uv python list --managed-python --only-installed</code>.
This overwrites my global <code>pip</code> command and <code>python</code> command of course, but that's fine for my use case as I always alias <code>python</code> to the latest installed version.</p>
<p><strong>This is a hack</strong>, but it seems to work for my use case for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @geofft by @zanieb on 2025-09-18 20:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @jtfmumm by @zanieb on 2025-09-18 20:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-09-18 20:41</div>
            <div class="timeline-body"><p>We're looking at fixing this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/16411.html">astral-sh/uv#16411</a> on 2025-10-22 17:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DIMFLIX">@DIMFLIX</a> on 2025-10-27 08:58</div>
            <div class="timeline-body"><p>Bypassing via PATH doesn't work for me :(</p>
<pre><code>╭╴  dimflix at ~                                                                                                                                                                󱑈 11:54
╰─󰍟 uv python list --managed-python --only-installed
cpython-3.12.11-linux-x86_64-gnu    .local/share/uv/python/cpython-3.12-linux-x86_64-gnu/bin/python3.12
cpython-3.11.13-linux-x86_64-gnu    .local/share/uv/python/cpython-3.11-linux-x86_64-gnu/bin/python3.11
cpython-3.9.23-linux-x86_64-gnu     .local/share/uv/python/cpython-3.9.23-linux-x86_64-gnu/bin/python3.9

╭╴  dimflix at ~                                                                                                                                                                󱑈 11:57
╰─󰍟 echo $(dirname $(realpath $(which python)))
/home/dimflix/.local/share/uv/python/cpython-3.11.13-linux-x86_64-gnu/bin

╭╴  dimflix at ~                                                                                                                                                                󱑈 11:57
╰─󰍟 /home/dimflix/.local/share/uv/python/cpython-3.11.13-linux-x86_64-gnu/bin/python -m venv .venv
Error: Command '['/home/dimflix/.venv/bin/python', '-m', 'ensurepip', '--upgrade', '--default-pip']' returned non-zero exit status 1.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/byron-hawkins">@byron-hawkins</a> on 2025-12-04 12:52</div>
            <div class="timeline-body"><p>Not sure about the consequences of messing with <code>$HOME</code>, but this workaround does just what I need:</p>
<pre><code>USER root
ENV HOME &quot;${APP}&quot;                                                                                                                                                 

RUN --mount=from=ghcr.io/astral-sh/uv,source=/uv,target=/bin/uv \
    --mount=type=cache,target=${UV_CACHE_DIR} \
    uv sync                                                                                                                                                          

ENV HOME &quot;/root&quot;  
</code></pre>
<p>Python gets installed as <code>${APP}/.local/share/uv/python/cpython-3.14.1-.../bin/python3.14</code>, making it available for all users. Activating the <code>.venv</code> is then simply:</p>
<pre><code>ENV PATH &quot;${APP}/.venv/bin:$PATH&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-12-16 14:52</div>
            <div class="timeline-body"><p>This has been fixed in the latest uv with the latest Python patch versions (https://github.com/astral-sh/python-build-standalone/issues/380), you can use <code>uv python upgrade --reinstall</code> to update.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-12-16 14:52</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:01 UTC
    </footer>
</body>
</html>
