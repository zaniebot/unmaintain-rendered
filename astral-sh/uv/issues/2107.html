<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv pip install --python=.venv/bin/python` error: failed to create file `/usr/.lock` - astral-sh/uv #2107</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`uv pip install --python=.venv/bin/python` error: failed to create file `/usr/.lock`</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/2107">#2107</a>
        opened by <a href="https://github.com/gschaffner">@gschaffner</a>
        on 2024-03-01 11:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/gschaffner">@gschaffner</a> on 2024-03-01 11:12</div>
            <div class="timeline-body"><p>here's a reproducer (latest is v0.1.13 at time of writing): <code>cargo build --target=x86_64-unknown-linux-musl --features=vendored-libgit2,vendored-openssl</code> and then</p>
<pre><code class="language-bash">#!/usr/bin/env -S sh -c '&lt; &quot;$0&quot; podman run --rm -i -v=./target/x86_64-unknown-linux-musl/debug/uv:/usr/bin/uv:ro --pull=newer docker.io/archlinux/archlinux bash &quot;$@&quot;'

shopt -s inherit_errexit
set -o errexit -o errtrace -o nounset -o pipefail -o xtrace

pacman --noconfirm -Syu sudo
useradd --create-home --groups=wheel user
echo '%wheel ALL=(ALL:ALL) NOPASSWD: ALL' &gt; /etc/sudoers.d/wheel
&lt;&lt;'EOF' sudo -u user bash
    shopt -s inherit_errexit
    set -o errexit -o errtrace -o nounset -o pipefail -o xtrace

    cd ~
    sudo pacman --noconfirm -S python
    uv venv
    # uv pip install uv  # succeeds
    uv pip install --python=.venv/bin/python uv  # fails
EOF
</code></pre>
<p>this also reproduces on <code>docker.io/debian:stable-slim</code>. it also reproduces on my Arch Linux host if i remove pyenv from <code>$PATH</code> s.t. <code>which python</code> -&gt; <code>/usr/bin/python</code>.</p>
<p>possibly the problem is that <code>PythonEnvironment::from_requested_python</code> is using the installation's (base) prefix for the root instead of using the venv's prefix? the following patchset seems to work: https://github.com/astral-sh/uv/compare/main...ea8257a25404ce1bbec32d601df60670266585af</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-01 13:55</div>
            <div class="timeline-body"><p>Ah yeah, that should be prefix - thanks! PR welcome if youâ€™re interested.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @konstin on 2024-03-01 13:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-01 17:55</div>
            <div class="timeline-body"><p>Fixing now so I can include in release.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-03-01 17:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-03-01 18:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 05:43:07 UTC
    </footer>
</body>
</html>
