<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhancement: Change order of discovery of python environments for `uv pip install`  - astral-sh/uv #7124</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Enhancement: Change order of discovery of python environments for <code>uv pip install</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/7124">#7124</a>
        opened by <a href="https://github.com/kdheepak">@kdheepak</a>
        on 2024-09-06 11:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kdheepak">@kdheepak</a></div>
            <div class="timeline-body"><p>From https://docs.astral.sh/uv/pip/environments/#discovery-of-python-environments</p>
<blockquote>
<p>When running a command that mutates an environment such as <code>uv pip sync</code> or <code>uv pip install</code>, uv
will search for a virtual environment in the following order:</p>
<ul>
<li>An activated virtual environment based on the <code>VIRTUAL_ENV</code> environment variable.</li>
<li>An activated Conda environment based on the <code>CONDA_PREFIX</code> environment variable.</li>
<li>A virtual environment at <code>.venv</code> in the current directory, or in the nearest parent directory.</li>
</ul>
<p>If no virtual environment is found, uv will prompt the user to create one in the current directory
via <code>uv venv</code>.</p>
</blockquote>
<p>I believe the implementation should be changed to check for the conda environment at the very end, i.e. this is the order it should operate in:</p>
<pre><code>1. An activated virtual environment based on the `VIRTUAL_ENV` environment variable.
2. A virtual environment at `.venv` in the current directory, or in the nearest parent directory. (currently this is 3.)
3. An activated Conda environment based on the `CONDA_PREFIX` environment variable. (currently this is 2.)
</code></pre>
<p>This is because most users that have installed conda will have auto activate base enabled, since that is the default. For example:</p>
<img alt="image" src="https://github.com/user-attachments/assets/cf172296-7fd2-4e22-b66b-de1a6a944ce9">

<p>This means when someone runs <code>uv pip install</code> even with a <code>.venv</code> folder in the current directory, it&#x27;ll install all the dependencies into the conda environment, which in my opinion is not what users would want. If a <code>.venv</code> folder doesn&#x27;t exist, I think it is appropriate to install into <code>CONDA_PREFIX</code>.</p>
<p>I made this mistake and accidentally installed all the project dependencies into my base conda environment environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-06 12:58</div>
            <div class="timeline-body"><p>Hm. I think you have a fair point but we can&#x27;t tell if it&#x27;s a conda base environment or if it&#x27;s an <em>actual</em> active conda environment, right? If it&#x27;s not the base environment I would expect us to prefer it over <code>.venv</code>.</p>
<p>Note this would be a breaking change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">breaking</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-06 12:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kdheepak">@kdheepak</a> on 2024-09-06 13:05</div>
            <div class="timeline-body"><blockquote>
<p>If it&#x27;s not the base environment I would expect us to prefer it over .venv.</p>
</blockquote>
<p>I thought about that too and I think there&#x27;s an argument to be made for it either way.</p>
<p>For consistency, I personally think it is easier to remember it as &quot;<code>uv</code> always prefers virtual environments&quot;, i.e. <code>CONDA_PREFIX</code> would be preferred last.</p>
<p>By changing the order, if a user really wants to install it in <code>CONDA_PREFIX</code>, all they have to do is delete the <code>.venv</code> folder. And a user that does activate a conda environment with a <code>.venv</code> folder present, wouldn&#x27;t be surprised if <code>uv</code> installed into their <code>.venv</code> folder, given how much the documentation focuses on virtual environments and how little the documentation mentions system or conda environments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-09-06 15:09</div>
            <div class="timeline-body"><blockquote>
<p>Hm. I think you have a fair point but we can&#x27;t tell if it&#x27;s a conda base environment or if it&#x27;s an <em>actual</em> active conda environment, right? If it&#x27;s not the base environment I would expect us to prefer it over <code>.venv</code>.</p>
</blockquote>
<p>If I am understanding the issue correctly I don&#x27;t think this matters, virtual environments can be children of conda environments, but not the otherway around.</p>
<p>If I am using both conda and venv my typical worfklow would be:</p>
<ol>
<li><code>conda activate my_env </code></li>
<li><code>python -m venv .venv</code> / <code>uv venv</code></li>
<li><code>source .venv/bin/activate</code></li>
<li><code>uv pip install {foo}</code></li>
</ol>
<p>I would expect that final <code>uv</code> command to install in to my virtual environment, not my conda environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-09-06 15:17</div>
            <div class="timeline-body"><p>Wait, does sourcing a virtual environment always create the env variable <code>VIRTUAL_ENV</code>? In that case I don&#x27;t agree with @kdheepak</p>
<p>In particular if I run:</p>
<ol>
<li><code>conda activate my_env </code></li>
<li><code>uv pip install {foo}</code></li>
</ol>
<p>And there happens to be a &quot;.venv&quot; in my folder, I would expect uv to install in the conda environment, not in the the virtual environment. Perhaps print a warning that &quot;.venv&quot; folder was detected but not activated, so installing in conda environment.</p>
<p>In general, if a user is using conda, I would have an expectation that they want to install into conda environments, unless a virtual environment was explicitly activated.</p>
<p>So going back to the &quot;base&quot; environment issue, IMO conda should solve this on their side my adding an <code>EXTERNALLY-MANAGED</code> marker to that environment (<a href="https://github.com/conda/conda/issues/12245">conda/conda#12245</a>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kdheepak">@kdheepak</a> on 2024-09-06 16:43</div>
            <div class="timeline-body"><p>Can I ask when do you expect a user to do both <code>conda activate my_env </code> and <code>python -m venv .venv</code>? And if someone explicitly does create an environment, why would you want <code>uv</code> to install into the conda environment ever.</p>
<p>If someone explicitly does choose to create a <code>.venv</code>, then if that exists in that folder, I&#x27;d expect all installs to go into that environment.  Otherwise, if it did install into conda environment, then imagine for instance a situation where you are working in a folder with a <code>.venv</code>, you <code>cd</code> out into a different folder, activate a conda environment, do something else, and come back to the folder with a <code>.venv</code>, and now your installs with <code>uv</code> will affect the conda environment.</p>
<p>Additionally, I can imagine users wanting to install <code>jupyter</code>, <code>jq</code>, <code>fzf</code>, <code>bat</code>, <code>nodejs</code> etc in a conda environment, and have that activated across different projects, (e.g. <code>conda activate dev</code>) and have <code>uv</code> manage individual python project environments, and in that case they&#x27;d want <code>uv</code> to install into an individual folder&#x27;s <code>.venv</code>.</p>
<p>I guess my point is that if there&#x27;s a <code>.venv</code> folder, <code>uv</code> should always only install in there because that&#x27;s probably almost always going to be more foolproof.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-09-06 16:56</div>
            <div class="timeline-body"><blockquote>
<p>Can I ask when do you expect a user to do both <code>conda activate my_env </code> and <code>python -m venv .venv</code>? And if someone explicitly does create an environment, why would you want <code>uv</code> to install into the conda environment ever.</p>
</blockquote>
<p>When I want to create a virtual environment for a specific project, but have it based on the Python versions created by conda. This can happen either because of how some dependencies are managed, or because some tooling/testing works well with virtual environments but not conda environments but I can still use conda to create the binaries (such as Python executable, openssl, etc.), I have done this a lot in the past for pip test suite.</p>
<blockquote>
<p>Otherwise, if it did install into conda environment, then imagine for instance a situation where you are working in a folder with a .venv, you cd out into a different folder, activate a conda environment, do something else, and come back to the folder with a .venv, and now your installs with uv will affect the conda environment.</p>
</blockquote>
<p>The opposite conclusion can be reached with similar reasoning, I&#x27;m cding around, I remember I need to install something in my conda environment, I activate it, I install with uv, and to my surprise it doesn&#x27;t get installed in my conda environment when I try and run <code>python -m {thingIjustinstalled}</code></p>
<blockquote>
<p>I guess my point is that if there&#x27;s a .venv folder, uv should always only install in there because that&#x27;s probably almost always going to be more foolproof.</p>
</blockquote>
<p>I do think uv should be explicit about if this is always true or not, even if it is the default behaviour, I think there should be some option to install into my conda environment regardless of if there is a <code>.venv</code>, the other way around is easy, you activate the <code>.venv</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kdheepak">@kdheepak</a> on 2024-09-06 17:05</div>
            <div class="timeline-body"><p>Fair points. Accidentally installing into <code>base</code> is my real gripe here. If someone explicitly activates a conda environment and also has a <code>.venv</code>, I&#x27;d be happy with either installing into conda, installing into <code>.venv</code> or even just prompting the user on what to do.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-06 17:16</div>
            <div class="timeline-body"><p>I guess this really goes back to</p>
<blockquote>
<p>We can&#x27;t tell if it&#x27;s a conda base environment or if it&#x27;s an actual active conda environment, right?</p>
</blockquote>
<p>If we can tell, we can have better behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-09-06 17:22</div>
            <div class="timeline-body"><p>You could manually add the <code>EXTERNALLY-MANAGED</code> file to your base environment üòÇ.</p>
<blockquote>
<p>If we can tell, we can have better behavior.</p>
</blockquote>
<p>btw, is there a plan to try and locate all environments and the details from environment managers like conda? (I think https://github.com/microsoft/python-environment-tools attempts to do this). Then you would know if it&#x27;s the base environment because it would be the conda environment either called &quot;base&quot; or &quot;root&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-06 17:25</div>
            <div class="timeline-body"><p>Naw, we don&#x27;t intend to read other environment managers or tools at this time. I think it&#x27;s better to read from standard locations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kdheepak">@kdheepak</a> on 2024-09-06 17:29</div>
            <div class="timeline-body"><p>Given that there&#x27;s not an easy way to tell the difference, and without special casing <code>base</code>, my vote is for changing the order. Primarily because changing CONDA_PREFIX&#x27;s dependencies unintentionally seems like a bad idea (a user likely manages that with a <code>environment.yml</code> file).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-09-06 17:42</div>
            <div class="timeline-body"><p>Thinking on it this would directly affect my tooling which does the following:</p>
<ol>
<li>Creates a series of conda environments for the user</li>
<li>Activates each one and installs specific requirements into them with uv</li>
</ol>
<p>If the order is changed, and the user happens to have created a virtual environment in the directory they run the script, then it would keep installing the requirements for each environment in the venv.</p>
<p>So, while I&#x27;m not against changing the ordering, I think it should be made a very explicit change, with an option to ignore the local &quot;.venv&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-06 17:47</div>
            <div class="timeline-body"><p>We&#x27;re pretty unlikely to change the order. This is the first complaint we&#x27;ve gotten and the behavior has been this way for a while. Furthermore, active environments always take precedence over <code>.venv</code> detection in the <code>uv pip</code> interface. I think this is correct and best matches pip&#x27;s behavio. If you use the project interface or <code>uv run</code>, you shouldn&#x27;t have this problem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kdheepak">@kdheepak</a> on 2024-09-06 19:24</div>
            <div class="timeline-body"><p>Can you clarify what is the project interface?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-06 19:27</div>
            <div class="timeline-body"><p>Like these commands: https://docs.astral.sh/uv/getting-started/features/#projects</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kdheepak">@kdheepak</a> on 2024-09-06 19:41</div>
            <div class="timeline-body"><p>I see, thanks for sharing.</p>
<p>I will defer to your judgement on this, you definitely will have a better sense of what users will likely want.</p>
<p>I do want to make two counter arguments though:</p>
<ol>
<li>My intuition is most people that use conda don&#x27;t use <code>uv</code> at the moment, and manage environments manually with conda. So past complaints or lack thereof may not be descriptive.</li>
<li>I see <code>uv</code> equivalent to <code>npm</code> for python projects, and I see <code>.venv</code> folders equivalent to <code>node_modules</code>. Having <code>uv pip install</code> do what is the equivalent of <code>npm install -g</code> (i.e. installing into the <code>base</code> conda environment) seems like a bad idea imho. By default, conda auto activates <code>base</code>, so anyone that uses <code>uv pip install</code> will run into this accidentally, and as <code>uv</code> continues to grow in the scientific community you&#x27;ll have more users potentially run into this. <code>uv</code> even comes with <code>--system</code> for explicitly installing into the system version of python, i.e. <code>uv pip install --system</code> and currently it is only the <code>CONDA_PREFIX</code> feature that behaves differently. I see this one and only one feature as incongruent with what is otherwise a clean, well designed and self contained python packaging solution.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-09-06 21:20</div>
            <div class="timeline-body"><p>FWIW, it appears you can detect if the base environment is currently activated if <code>CONDA_PREFIX_1</code> is not set or <code>CONDA_DEFAULT_ENV</code> is equal to <code>base</code> (on very old versions of conda this was named <code>root</code>) :</p>
<p>https://conda.io/projects/conda/en/latest/dev-guide/deep-dives/activation.html#conda-activate</p>
<p>If someone wants to make a seperate issue about uv avoiding installing into conda base environments as though they were system versions of Python?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-09-06 21:23</div>
            <div class="timeline-body"><p>Nevermind, I just made it: <a href="https://github.com/astral-sh/uv/issues/7137">astral-sh/uv#7137</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-07 15:18</div>
            <div class="timeline-body"><p>Thanks @notatallshaw! I wonder if we should close this in favor of that?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-15 23:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chrisrodrigue">@chrisrodrigue</a> on 2024-09-18 20:42</div>
            <div class="timeline-body"><blockquote>
<p>We can&#x27;t tell if it&#x27;s a conda base environment or if it&#x27;s an <em>actual</em> active conda environment, right?</p>
</blockquote>
<p>Thinking out loud here.</p>
<p>Anaconda let&#x27;s the user customize the installation location (on Windows it defaults to <code>C:\ProgramFiles\anaconda3</code>) so reading from there is unreliable. Additionally, it would probably be bad practice to read Anaconda config files (which also have platform-specific locations).</p>
<p>It seems that the conda philosophy is to not mutate/pollute the system path or use environment variables and instead it utilizes the current shell context by modifying the shell startup scripts via the <code>conda init</code> command. The base conda environment is named <code>base</code> by default (t was called <code>root</code> in legacy versions).</p>
<p>I think that calling/shelling out to a <code>conda</code> command/subprocess could be a viable option to tell apart a conda env from a conda base env. We can always rely on the <code>conda</code> command being accessible regardless of the platform, installation location, or whether it is accessed via shell context or path presence.</p>
<p><code>conda env list</code> returns a list of environments with an asterisk next to the active one:</p>
<pre><code>(base) PS C:\Users\me&gt; conda env list
# conda environments:
#
base                  *  C:\ProgramData\anaconda3
</code></pre>
<p>This would probably be good enough, but as an extra precaution it could be cross-referenced with the <code>conda info</code> command to be dead certain that the true base environment is the same as the active named environment (in case someone renamed the base environment or something).</p>
<pre><code>(base) PS C:\Users\me&gt; conda info

     active environment : base
     # ...
       base environment : C:\ProgramData\anaconda3  (read only)
     # ...
</code></pre>
<p>Note that the conda base environment is marked as read-only in the output of <code>conda info</code>, so I think that it is definitely incorrect behavior for any tool to mutate the conda base environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chrisrodrigue">@chrisrodrigue</a> on 2024-09-18 21:27</div>
            <div class="timeline-body"><p>The output of <code>conda info</code> / <code>conda env list</code> should be the same across platforms so you could use some regex to parse out the base env path.</p>
<pre><code>let conda_info_pattern = r&quot;base environment\s*:\s*(.+?)(?:\s*\(read only\))?\s*$&quot;;
let conda_env_list_pattern = r&quot;^\s*\*\s+([^\s]+)\s+([^\s]+)&quot;;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chrisrodrigue">@chrisrodrigue</a> on 2024-09-18 21:59</div>
            <div class="timeline-body"><p>Maybe a helper function to do this can look something like this?</p>
<pre><code>/// Checks if the current conda environment is the base environment.
///
/// This function runs `conda info` and `conda env list` commands asynchronously,
/// captures the relevant information using regular expressions, and compares
/// the base environment path with the active environment path.
///
/// # Returns
/// - `Ok(true)` if the current environment is the base environment.
/// - `Ok(false)` if the current environment is not the base environment.
/// - `Err` if there is an error running the commands or processing the output.
async fn is_conda_base_env() -&gt; Result&lt;bool, Box&lt;dyn Error&gt;&gt; {
    let base_env_pattern = Regex::new(r&quot;base environment\s*:\s*(.+?)(?:\s*\(read only\))?\s*$&quot;)?;
    let active_env_pattern = Regex::new(r&quot;^\s*\*\s+([^\s]+)\s+([^\s]+)&quot;)?;

    let (conda_info_output, conda_env_list_output) = try_join!(
        Command::new(&quot;conda&quot;).arg(&quot;info&quot;).output(),
        Command::new(&quot;conda&quot;).arg(&quot;env&quot;).arg(&quot;list&quot;).output()
    )?;

    Ok(
        base_env_pattern
            .captures(&amp;String::from_utf8_lossy(&amp;conda_info_output.stdout))
            .and_then(|caps| caps.get(1).map(|m| m.as_str().trim()))
            == active_env_pattern
                .captures(&amp;String::from_utf8_lossy(&amp;conda_env_list_output.stdout))
                .and_then(|caps| caps.get(2).map(|m| m.as_str()))
    )
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-18 22:06</div>
            <div class="timeline-body"><p>Thanks for digging into this. I&#x27;m very hesitant to shell out to conda, it seems brittle and slow. Do you some data about how long that invocation takes?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chrisrodrigue">@chrisrodrigue</a> on 2024-09-18 22:11</div>
            <div class="timeline-body"><p>I don&#x27;t, just hacked this together real quick. Not really sure what the best entrypoint for this check could be or how to go about caching the conda environment state.</p>
<p>Probably way better ways to do this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chrisrodrigue">@chrisrodrigue</a> on 2024-09-18 22:25</div>
            <div class="timeline-body"><p>Environment variables might be a lot faster. Seems like conda has quite a few of them so there&#x27;s probably more than one way to get the correct paths.</p>
<p>This page shows a lot of the environment variables that conda uses: https://conda.io/projects/conda/en/latest/dev-guide/deep-dives/activation.html#activation-deactivation-scripts</p>
<pre><code>/// Checks if the current conda environment is the base environment.
///
/// This function reads the `CONDA_PREFIX` and `CONDA_DEFAULT_ENV` environment variables,
/// extracts the last component of the `CONDA_PREFIX` path, and compares it with `CONDA_DEFAULT_ENV`.
///
/// # Returns
/// - `true` if the current environment is the base environment.
/// - `false` if the current environment is not the base environment or if either environment variable does not exist.
fn is_conda_base_env() -&gt; bool {
    if let (Ok(conda_prefix), Ok(base_env)) = (env::var(&quot;CONDA_PREFIX&quot;), env::var(&quot;CONDA_DEFAULT_ENV&quot;)) {
        if let Some(current_env) = Path::new(&amp;conda_prefix).file_name().and_then(|s| s.to_str()) {
            return current_env == base_env;
        }
    }
    false
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-09-18 23:06</div>
            <div class="timeline-body"><blockquote>
<p>Thanks for digging into this. I&#x27;m very hesitant to shell out to conda, it seems brittle and slow. Do you some data about how long that invocation takes?</p>
</blockquote>
<p>I would concur, from yy experience wrapping conda, particularly on Windows with lots of security tools installed, you can be talking about a few seconds to get a response back.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-25 17:56</div>
            <div class="timeline-body"><p>What about this though?</p>
<img alt="Screenshot 2024-09-25 at 12 55 00‚ÄØPM" src="https://github.com/user-attachments/assets/867f2df7-9c57-4048-b6db-893f7e990820">

<p>Seems like <code>CONDA_DEFAULT_ENV</code> doesn&#x27;t just give for the base environment based on that. Should we just check if it&#x27;s called <code>base</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-25 18:03</div>
            <div class="timeline-body"><p>Hm</p>
<p>This might work actually..</p>
<pre><code>(base) root@ba74a7a304f6:/# echo $CONDA_DEFAULT_ENV
base
(base) root@ba74a7a304f6:/# echo $CONDA_PREFIX     
/usr/local
(base) root@ba74a7a304f6:/# conda activate foo
(foo) root@ba74a7a304f6:/# echo $CONDA_PREFIX
/usr/local/envs/foo
(foo) root@ba74a7a304f6:/# echo $CONDA_DEFAULT_ENV
foo
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-25 19:02</div>
            <div class="timeline-body"><p>I think I have the right idea in <a href="https://github.com/astral-sh/uv/pull/7691">astral-sh/uv#7691</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-09-25 19:23</div>
            <div class="timeline-body"><p>That&#x27;s just <a href="https://github.com/astral-sh/uv/issues/7137">astral-sh/uv#7137</a> with the suggestions of env vars I made there right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-25 19:38</div>
            <div class="timeline-body"><p>Sorry I forgot about that issue and was riffing off of @chrisrodrigue&#x27;s function. It is similar to your suggestion there, though the heuristic is a little different. I&#x27;m not sure which approach is better.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-09-25 20:23</div>
            <div class="timeline-body"><p>As long as you don&#x27;t make any assumptions about the relationship of the paths between the base environment and the other environments you should be fine. As users can both change where non-base environments are created, and in fact manually specify the directory for them on each creation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-25 20:47</div>
            <div class="timeline-body"><p>Basically the assumption is that a base environment is always named &quot;root&quot; or &quot;base&quot; and doesn&#x27;t have a prefix path ending in the name.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-09-27 17:06</div>
            <div class="timeline-body"><blockquote>
<p>Basically the assumption is that a base environment is always named &quot;root&quot; or &quot;base&quot; and doesn&#x27;t have a prefix path ending in the name.</p>
</blockquote>
<p>This is probably fine, but be aware nothing stops a user installing their conda software into a directory called &quot;base&quot;, e.g. <code>$HOME/.miniforge3/base</code>. I think the absense of <code>CONDA_PREFIX_1</code> <em>might</em> be a safer heuristic, but I&#x27;m no conda expert.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chrisrodrigue">@chrisrodrigue</a> on 2024-10-02 00:15</div>
            <div class="timeline-body"><p>Is <code>CONDA_PREFIX_1</code> supposed to be the previously active conda env? That could be a good check to make sure that <code>base</code> is the ‚Äúofficial‚Äù base created by default by conda.</p>
<p>Could an arbitrary user created conda env called base be exploited in this context?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-10-02 00:32</div>
            <div class="timeline-body"><blockquote>
<p>Is <code>CONDA_PREFIX_1</code> supposed to be the previously active conda env? That could be a good check to make sure that <code>base</code> is the ‚Äúofficial‚Äù base created by default by conda.</p>
</blockquote>
<p>I did a bit of investigation and found it doesn&#x27;t do what I think, so I take back my suggestion for using <code>CONDA_PREFIX_1</code>! Apologies!</p>
<p>What I found was there are a series of <code>CONDA_PREFIX_{N}</code> variables that show which environments are activates on top of the other, e.g. if you start a terminal with base activates and do:</p>
<ol>
<li>&quot;conda activate abc&quot;  -  <code>CONDA_PREFIX</code>  gets pointed to abc environment and <code>CONDA_PREFIX_1</code> points to base environment</li>
<li>&quot;conda activate def&quot; - <code>CONDA_PREFIX</code>  gets pointed to def environment and <code>CONDA_PREFIX_2</code> points to abc environment</li>
<li>etc.</li>
</ol>
<p>This is problematic to use as an indication of what is base then because the user can activate base again via <code>conda activate base</code>, and they might not even start in the base environment as you can configure conda not to activate an environment, e.g. <code>auto_activate_base: False</code>, and then they could start with <code>conda activate abc</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chrisrodrigue">@chrisrodrigue</a> on 2024-10-02 00:50</div>
            <div class="timeline-body"><p>Good find!</p>
<p>I wish the conda environment variable documentation were a little more verbose so that we didn‚Äôt need to experiment üòÖ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-07 20:29</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:33:45 UTC
    </footer>
</body>
</html>
