<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv init` hangs forever unless I add `--python-preference only-managed` - astral-sh/uv #7667</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`uv init` hangs forever unless I add `--python-preference only-managed`</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/7667">#7667</a>
        opened by <a href="https://github.com/will-henney">@will-henney</a>
        on 2024-09-24 18:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/will-henney">@will-henney</a> on 2024-09-24 18:29</div>
            <div class="timeline-body"><p>Hi,</p>
<p>Just trying out uv for the first time (previous experience with rye), and weirdly I ran into problems running the first example command in the Getting Started docs:</p>
<pre><code>$ uv -v init example
DEBUG uv 0.4.15
DEBUG Searching for default Python interpreter in managed installations or system path
DEBUG Searching for managed installations at `.local/share/uv/python`
</code></pre>
<p>and it just hangs forever until killed, using almost no CPU resources.</p>
<p>I guessed it was a problem with the search for pre-existing local python installations, so I tried it with</p>
<pre><code>$ uv -v init example --python-preference only-managed
</code></pre>
<p>and that works fine.</p>
<p>System is macOS Sonoma 14.2.1 (23C71) running on intel</p>
<pre><code>$ uv --version
uv 0.4.15 (0d81bfbc6 2024-09-21)

$ uname -a
Darwin gris.local 23.2.0 Darwin Kernel Version 23.2.0: Wed Nov 15 21:54:10 PST 2023; root:xnu-10002.61.3~2/RELEASE_X86_64 x86_64
</code></pre>
<p>Thanks</p>
<p>Will</p>
<!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-24 18:32</div>
            <div class="timeline-body"><p>That's really weird — can you share the output of <code>RUST_LOG=uv=trace uv python find -v</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/will-henney">@will-henney</a> on 2024-09-24 19:46</div>
            <div class="timeline-body"><p>So, now that I have run once with <code>only-managed</code> it seems to be working fine even without that flag. I get</p>
<pre><code>$ RUST_LOG=uv=trace uv python find -v
DEBUG uv 0.4.15
DEBUG Searching for default Python interpreter in managed installations or system path
DEBUG Searching for managed installations at `/Users/will/.local/share/uv/python`
DEBUG Found managed installation `cpython-3.12.6-macos-x86_64-none`
TRACE Cached interpreter info for Python 3.12.6, skipping probing: /Users/will/.local/share/uv/python/cpython-3.12.6-macos-x86_64-none/bin/python3
DEBUG Found `cpython-3.12.6-macos-x86_64-none` at `/Users/will/.local/share/uv/python/cpython-3.12.6-macos-x86_64-none/bin/python3` (managed installations)
/Users/will/.local/share/uv/python/cpython-3.12.6-macos-x86_64-none/bin/python3
</code></pre>
<p>However, if I try and get back to the initial conditions after installing uv for the first time by nuking .local/share/uv, then I can reproduce the hanging behavior:</p>
<pre><code>$ rm -r ~/.local/share/uv
$ RUST_LOG=uv=trace uv python find -v
DEBUG uv 0.4.15
DEBUG Searching for default Python interpreter in managed installations or system path
DEBUG Searching for managed installations at `/Users/will/.local/share/uv/python`
TRACE Searching PATH for executables: python3, python
TRACE Checking `PATH` directory for interpreters: /Users/will/.cargo/bin
TRACE Checking `PATH` directory for interpreters: /Users/will/.gem/ruby/2.6.0/bin
TRACE Checking `PATH` directory for interpreters: /Users/will/mambaforge/condabin
TRACE Checking `PATH` directory for interpreters: /Users/will/.rye/shims
TRACE Found possible Python executable: /Users/will/.rye/shims/python3
TRACE Querying interpreter executable at /Users/will/.rye/shims/python3
^C
</code></pre>
<p>So it looks like the problem might be with the rye-installed python. I will check this next</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-24 19:53</div>
            <div class="timeline-body"><p>I wonder if the Rye shim is invoking uv so it cycles?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-09-24 19:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">uv python</span> added by @zanieb on 2024-09-24 19:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/will-henney">@will-henney</a> on 2024-09-24 23:57</div>
            <div class="timeline-body"><p>Could be ...</p>
<pre><code>$ ls -l /Users/will/.rye/shims/python3
lrwxr-xr-x  1 will  staff  26 Aug 14 13:17 /Users/will/.rye/shims/python3 -&gt; /Users/will/.rye/shims/rye

$ rye --version
rye 0.38.0
commit: 0.38.0 (3e3c8540f 2024-08-02)
platform: macos (x86_64)
self-python: cpython@3.12.1
symlink support: true
uv enabled: true
</code></pre>
<p>I did <code>rye self update</code> so it is now on 0.39.0 but that did not help</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bluss">@bluss</a> on 2024-09-25 06:46</div>
            <div class="timeline-body"><p>Could you run the rye shim (in the same directory as previous experiments) and <code>print(sys.executable)</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/will-henney">@will-henney</a> on 2024-09-25 17:18</div>
            <div class="timeline-body"><p>OK, we seem to be getting somewhere. It turns out that the rye shim hangs when I try to run it outside of any rye or uv managed project. So this explains the <code>uv init</code> hangs</p>
<p>Looking at the rye docs, it seems that it should be finding the system python in this case, which I guess is the part that seems to be broken on my machine.</p>
<p>If I do</p>
<pre><code>$ rye config --set-bool behavior.global-python=true
</code></pre>
<p>then the shim now does work in non-managed directories:</p>
<pre><code># will @ gris in ~/tmp [10:46:53]
$ /Users/will/.rye/shims/python
Python 3.12.1 (main, Jan  8 2024, 06:38:22) [Clang 16.0.3 ] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import sys; print(sys.executable)
/Users/will/.rye/py/cpython@3.12.1/install/bin/python3
</code></pre>
<p>and <code>uv init</code> now works fine, even starting from an empty ~/.local/share/uv folder:</p>
<pre><code>$ uv -v init example-4
DEBUG uv 0.4.16
DEBUG Searching for default Python interpreter in managed installations or system path
DEBUG Searching for managed installations at `/Users/will/.local/share/uv/python`
DEBUG Found `cpython-3.12.1-macos-x86_64-none` at `/Users/will/.rye/shims/python` (search path)
DEBUG Writing Python versions to `/Users/will/tmp/example-4/.python-version`
Initialized project `example-4` at `/Users/will/tmp/example-4`
</code></pre>
<p>Oddly, this now seems to be picking up a homebrew version of python</p>
<pre><code>$ (cd example-4; uv run hello.py)
Using CPython 3.12.4 interpreter at: /usr/local/opt/python@3.12/bin/python3.12
Creating virtual environment at: .venv
Hello from example-4!
</code></pre>
<p>Then I double-checked by running</p>
<pre><code>rye config --set-bool behavior.global-python=false
mv ~/.local/share/uv/python ~/.local/share/uv/python-MOVED
uv -v init example-6
</code></pre>
<p>and that reproduced the hang again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kazuar">@kazuar</a> on 2024-12-18 21:16</div>
            <div class="timeline-body"><p>Happened to me as well.</p>
<p>Running <code>rye config --set-bool behavior.global-python=true</code> solved the issue.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:00 UTC
    </footer>
</body>
</html>
