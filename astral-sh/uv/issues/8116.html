<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duplicated --extra-index-url in requirements - astral-sh/uv #8116</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Duplicated --extra-index-url in requirements</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/8116">#8116</a>
        opened by <a href="https://github.com/dabljues">@dabljues</a>
        on 2024-10-10 23:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dabljues">@dabljues</a> on 2024-10-10 23:36</div>
            <div class="timeline-body"><p>I'm utilizing <code>uv</code> to speed up my current dev environment. Basically, I operate on <code>pyproject.toml</code> and plain <code>requirements*</code> files.</p>
<p>I want to use <code>uv</code> to speed up the process of compiling the requirements files via <code>pip-compile</code>.</p>
<p>Minimum reproducible example would be this:</p>
<p><code>pyproject.toml</code>:</p>
<pre><code class="language-toml">[project]
name = &quot;foo&quot;
version = &quot;0.0.0&quot;
requires-python = &quot;&gt;=3.10&quot;
dependencies = [
    &quot;requests==2.32.3&quot;
]

[project.optional-dependencies]
dev = [
    &quot;ruff==0.6.8&quot;,
]
</code></pre>
<p>Now, I have two separate requirements files:</p>
<ul>
<li><code>requirements.txt</code> which contains my package dependencies</li>
<li><code>requirements-test.txt</code> which contain my package dependencies + dev dependencies like <code>ruff</code>, <code>mypy</code> etc - for CI jobs (ran via <code>tox</code>, but this doesn't matter)</li>
</ul>
<p>Okay, so in order to compile/generate those both files I run:</p>
<pre><code class="language-sh">uv pip compile --upgrade --build-isolation --emit-index-url --output-file=requirements.txt pyproject.toml
uv pip compile --upgrade --build-isolation --emit-index-url --extra=dev --constraint=requirements.txt --output-file=requirements-test.txt pyproject.toml
</code></pre>
<p>(<code>UV_EXTRA_INDEX_URL</code> env variable defined)</p>
<p>I've added <code>--emit-index-url</code> here, becaue <code>pip-compile</code> adds the index URLs by default and I also want them here with <code>uv</code>.</p>
<p>The <code>requirements.txt</code> comes out just as I want it to:</p>
<pre><code class="language-python"># This file was autogenerated by uv via the following command:
#    uv pip compile --build-isolation --emit-index-url --output-file=requirements.txt pyproject.toml
--index-url https://pypi.org/simple
--extra-index-url https://foo.bar/simple

certifi==2024.8.30
    # via requests
charset-normalizer==3.4.0
    # via requests
idna==3.10
    # via requests
requests==2.32.3
    # via foo (pyproject.toml)
urllib3==2.2.3
    # via requests
</code></pre>
<p>However, the second file has duplicated extra index URLs:</p>
<pre><code class="language-python"># This file was autogenerated by uv via the following command:
#    uv pip compile --build-isolation --emit-index-url --extra=dev --constraint=requirements.txt --output-file=requirements-test.txt pyproject.toml
--index-url https://pypi.org/simple
--extra-index-url https://foo.bar/simple
--extra-index-url https://foo.bar/simple

certifi==2024.8.30
    # via
    #   -c requirements.txt
    #   requests
charset-normalizer==3.4.0
    # via
    #   -c requirements.txt
    #   requests
idna==3.10
    # via
    #   -c requirements.txt
    #   requests
requests==2.32.3
    # via
    #   -c requirements.txt
    #   foo (pyproject.toml)
ruff==0.6.8
    # via foo (pyproject.toml)
urllib3==2.2.3
    # via
    #   -c requirements.txt
    #   requests
</code></pre>
<p>Now, this is probably not a problem per se, but is undesired. If I remove the <code>--extra-index-url</code> line from <code>requirements.txt</code> (after running the first command) and then run the second command, the <code>--extra-index-url</code> lines in <code>requirements-test.txt</code> are not duplicated. It's like <code>uv pip-compile</code> takes that extra index url from the <code>requirements.txt</code>, adds it to the other file, but then also adds the URL from the env variable (or the other way around, but still).</p>
<p>Am I doing something wrong? And if not - would you consider fixing that? I mean, <code>pip-compile</code> doesn't do that, when using <code>pip-compile</code>, I have one <code>--extra-index-url</code> line per requirements file.</p>
<p>It kinda looks like a simple duplication check (when adding --extra-index-url to the requirements file) would suffice.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-12 03:48</div>
            <div class="timeline-body"><p>Yeah what you're seeing is roughly right: when you pass <code>--constraint=requirements.txt</code>, we read the <code>--extra-index-url</code> from the <code>requirements.txt</code> (which is correct), and then we also read the variable from your environment. I think it makes sense to dedupe these, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-10-12 03:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-10-12 03:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dabljues">@dabljues</a> on 2024-10-12 15:27</div>
            <div class="timeline-body"><p>It's not the end of the world, currently I went with this solution and I have these duplicated, but I also agree that this should be deduped (and after I glanced at the code it looks like it could potentially be an easy fix - not a Rust expert tho)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/8226.html">astral-sh/uv#8226</a> on 2024-10-15 18:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-10-16 12:45</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:00 UTC
    </footer>
</body>
</html>
