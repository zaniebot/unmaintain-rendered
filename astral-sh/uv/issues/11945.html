<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv failed to resolve pytorch dependencies in project with `cu126` - astral-sh/uv #11945</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv failed to resolve pytorch dependencies in project with <code>cu126</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/11945">#11945</a>
        opened by <a href="https://github.com/hv0905">@hv0905</a>
        on 2025-03-04 10:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/hv0905">@hv0905</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I'm trying to integrate <code>PyTorch</code> with uv following <a href="https://docs.astral.sh/uv/guides/integration/pytorch/#configuring-accelerators-with-optional-dependencies">this tutorial</a>, and I wrote the following <code>pyproject.toml</code> file:</p>
<pre><code class="language-toml">[project]
# ...
requires-python = &quot;&gt;=3.10,&lt;3.13&quot;
dependencies = [
  # some pytorch-unrelated dependencies
]

[dependency-groups]
dev = [
  # some pytorch-unrelated dependencies
]

# All the dependencies that related to PyTorch goes here
[project.optional-dependencies]
cpu = [
    &quot;torch&gt;=2.6.0&quot;,
    &quot;torchvision&quot;,
    &quot;easypaddleocr&gt;=0.3&quot;,
    &quot;transformers&gt;=4.49.0&quot;,
]
cu126 = [
    &quot;torch&gt;=2.6.0&quot;,
    &quot;torchvision&quot;,
    &quot;easypaddleocr&gt;=0.3&quot;,
    &quot;transformers&gt;=4.49.0&quot;,
]
cu124 = [
    &quot;torch&gt;=2.6.0&quot;,
    &quot;torchvision&quot;,
    &quot;easypaddleocr&gt;=0.3&quot;,
    &quot;transformers&gt;=4.49.0&quot;,
]
cu118 = [
    &quot;torch&gt;=2.6.0&quot;,
    &quot;torchvision&quot;,
    &quot;easypaddleocr&gt;=0.3&quot;,
    &quot;transformers&gt;=4.49.0&quot;,
]

[tool.uv]
conflicts = [
    [
        { extra = &quot;cpu&quot; },
        { extra = &quot;cu126&quot; },
        { extra = &quot;cu124&quot; },
        { extra = &quot;cu118&quot; },
    ],
]

[tool.uv.sources]
torch = [
    { index = &quot;pytorch-cpu&quot;, extra = &quot;cpu&quot; },
    { index = &quot;pytorch-cu126&quot;, extra = &quot;cu126&quot; },
    { index = &quot;pytorch-cu124&quot;, extra = &quot;cu124&quot; },
    { index = &quot;pytorch-cu118&quot;, extra = &quot;cu118&quot; }
]
torchvision = [
    { index = &quot;pytorch-cpu&quot;, extra = &quot;cpu&quot; },
    { index = &quot;pytorch-cu126&quot;, extra = &quot;cu126&quot; },
    { index = &quot;pytorch-cu124&quot;, extra = &quot;cu124&quot; },
    { index = &quot;pytorch-cu118&quot;, extra = &quot;cu118&quot; }
]

[[tool.uv.index]]
name = &quot;pytorch-cpu&quot;
url = &quot;https://download.pytorch.org/whl/cpu&quot;
explicit = true

[[tool.uv.index]]
name = &quot;pytorch-cu126&quot;
url = &quot;https://download.pytorch.org/whl/cu126&quot;
explicit = true

[[tool.uv.index]]
name = &quot;pytorch-cu124&quot;
url = &quot;https://download.pytorch.org/whl/cu124&quot;
explicit = true

[[tool.uv.index]]
name = &quot;pytorch-cu118&quot;
url = &quot;https://download.pytorch.org/whl/cu118&quot;
explicit = true

</code></pre>
<p><em>(View the full pyproject.toml <a href="https://github.com/hv0905/NekoImageGallery/blob/7f6c4a2bce18cd79415aef5d562217fa9aea760f/pyproject.toml#L1">here</a>, if necessary)</em></p>
<p>However, when I'm trying to run <code>uv sync --extra cu126 --dev</code> on a Linux x86_64 platform, uv failed to resolve some nvidia-related dependencies (like nvidia-cudnn-cu12 and nvidia-cublas-cu12) for torch==2.6.0+cu126, which cause torch failed to start.</p>
<p><img src="https://github.com/user-attachments/assets/36c727de-3670-4d45-9b49-3659a0511e1f" alt="Image" /></p>
<p>Iâ€˜ve reviewed <code>uv.lock</code> file generated by <code>uv</code>, it seems that uv resolve a wrong list of dependencies of torch, as follows:</p>
<p><img src="https://github.com/user-attachments/assets/d0f77b38-7d77-434d-9967-bb5493cb0c8a" alt="Image" /></p>
<p>However, torch==2.6.0+cu126 requires more dependencies than this, checking it by <code>uv run pip show torch</code></p>
<p><img src="https://github.com/user-attachments/assets/3b17b3f3-717d-448c-bcc1-62864e00d6e2" alt="Image" /></p>
<p>It seems that this is a bug of uv dependencies resolver.</p>
<h3>Platform</h3>
<p>Ubuntu 24.04 x86_64</p>
<h3>Version</h3>
<p>v0.6.4</p>
<h3>Python version</h3>
<p>python 3.12.7</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @hv0905 on 2025-03-04 10:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-04 15:21</div>
            <div class="timeline-body"><p>The problem here is that PyTorch is returning inconsistent metadata for those wheels.</p>
<p>If you download https://download.pytorch.org/whl/cu126/torch-2.6.0%2Bcu126-cp310-cp310-linux_aarch64.whl.metadata, you'll see:</p>
<pre><code>Requires-Dist: filelock
Requires-Dist: typing-extensions&gt;=4.10.0
Requires-Dist: setuptools; python_version &gt;= &quot;3.12&quot;
Requires-Dist: sympy==1.13.1; python_version &gt;= &quot;3.9&quot;
Requires-Dist: networkx
Requires-Dist: jinja2
Requires-Dist: fsspec
Provides-Extra: optree
Requires-Dist: optree&gt;=0.13.0; extra == &quot;optree&quot;
Provides-Extra: opt-einsum
Requires-Dist: opt-einsum&gt;=3.3; extra == &quot;opt-einsum&quot;
</code></pre>
<p>But if you download https://download.pytorch.org/whl/cu126/torch-2.6.0%2Bcu126-cp310-cp310-manylinux_2_28_x86_64.whl.metadata, you'll see:</p>
<pre><code>Requires-Dist: filelock
Requires-Dist: typing-extensions&gt;=4.10.0
Requires-Dist: setuptools; python_version &gt;= &quot;3.12&quot;
Requires-Dist: sympy==1.13.1; python_version &gt;= &quot;3.9&quot;
Requires-Dist: networkx
Requires-Dist: jinja2
Requires-Dist: fsspec
Requires-Dist: nvidia-cuda-nvrtc-cu12==12.6.77; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;
Requires-Dist: nvidia-cuda-runtime-cu12==12.6.77; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;
Requires-Dist: nvidia-cuda-cupti-cu12==12.6.80; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;
Requires-Dist: nvidia-cudnn-cu12==9.5.1.17; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;
Requires-Dist: nvidia-cublas-cu12==12.6.4.1; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;
Requires-Dist: nvidia-cufft-cu12==11.3.0.4; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;
Requires-Dist: nvidia-curand-cu12==10.3.7.77; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;
Requires-Dist: nvidia-cusolver-cu12==11.7.1.2; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;
Requires-Dist: nvidia-cusparse-cu12==12.5.4.2; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;
Requires-Dist: nvidia-cusparselt-cu12==0.6.3; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;
Requires-Dist: nvidia-nccl-cu12==2.21.5; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;
Requires-Dist: nvidia-nvtx-cu12==12.6.77; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;
Requires-Dist: nvidia-nvjitlink-cu12==12.6.85; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;
Requires-Dist: triton==3.2.0; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;
Provides-Extra: optree
Requires-Dist: optree&gt;=0.13.0; extra == &quot;optree&quot;
Provides-Extra: opt-einsum
Requires-Dist: opt-einsum&gt;=3.3; extra == &quot;opt-einsum&quot;
</code></pre>
<p>This has to be solved in PyTorch: https://github.com/pytorch/pytorch/issues/146679 / https://github.com/pytorch/pytorch/pull/145021.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @charliermarsh on 2025-03-04 15:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">external</span> added by @charliermarsh on 2025-03-04 15:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-04 15:23</div>
            <div class="timeline-body"><p>I can give you a manual workaround in the meantime.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-04 15:31</div>
            <div class="timeline-body"><p>You can add this to your <code>pyproject.toml</code> to override the registry metadata:</p>
<pre><code class="language-toml">[[tool.uv.dependency-metadata]]
name = &quot;torch&quot;
version = &quot;2.6.0+cu126&quot;
requires-python = &quot;&gt;=3.9.0&quot;
requires-dist = [
    'filelock',
    'typing-extensions&gt;=4.10.0',
    'setuptools; python_version &gt;= &quot;3.12&quot;',
    'sympy==1.13.1; python_version &gt;= &quot;3.9&quot;',
    'networkx',
    'jinja2',
    'fsspec',
    'nvidia-cuda-nvrtc-cu12==12.6.77; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;',
    'nvidia-cuda-runtime-cu12==12.6.77; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;',
    'nvidia-cuda-cupti-cu12==12.6.80; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;',
    'nvidia-cudnn-cu12==9.5.1.17; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;',
    'nvidia-cublas-cu12==12.6.4.1; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;',
    'nvidia-cufft-cu12==11.3.0.4; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;',
    'nvidia-curand-cu12==10.3.7.77; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;',
    'nvidia-cusolver-cu12==11.7.1.2; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;',
    'nvidia-cusparse-cu12==12.5.4.2; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;',
    'nvidia-cusparselt-cu12==0.6.3; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;',
    'nvidia-nccl-cu12==2.21.5; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;',
    'nvidia-nvtx-cu12==12.6.77; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;',
    'nvidia-nvjitlink-cu12==12.6.85; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;',
    'triton==3.2.0; platform_system == &quot;Linux&quot; and platform_machine == &quot;x86_64&quot;',
    'optree&gt;=0.13.0; extra == &quot;optree&quot;',
    'opt-einsum&gt;=3.3; extra == &quot;opt-einsum&quot;',
]
provides-extras = [
    'optree',
    'opt-einsum'
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hv0905">@hv0905</a> on 2025-03-04 15:38</div>
            <div class="timeline-body"><p>Thanks! I will stay on cuda 12.4 until Pytorch team resolve this problem in the next release.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "uv failed to resolve pytorch dependencies in project using extra markers" to "uv failed to resolve pytorch dependencies in project with `cu126`" by @charliermarsh on 2025-03-04 15:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-05 16:18</div>
            <div class="timeline-body"><p>Gonna close for now since this is &quot;upstream&quot; and we have a workaround here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-03-05 16:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2025-03-05 16:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:30:14 UTC
    </footer>
</body>
</html>
