<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unable to package django app with staticfiles - astral-sh/uv #9352</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Unable to package django app with staticfiles</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/9352">#9352</a>
        opened by <a href="https://github.com/Mapiarz">@Mapiarz</a>
        on 2024-11-22 10:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Mapiarz">@Mapiarz</a> on 2024-11-22 10:16</div>
            <div class="timeline-body"><p>Hi. I have a django app and I cannot build a docker image with django's staticfiles artifact.</p>
<p>Here's my dockerfile (this is just the first stage of my image, in the second stage I copy the environment)</p>
<pre><code class="language-dockerfile">FROM python:3.11-slim-bookworm AS builder

COPY --from=ghcr.io/astral-sh/uv:0.5 /uv /bin/


WORKDIR /myapp

# Copy app source code
...

# Create the virtual environment with myapp in it
RUN uv sync --frozen --no-dev --no-cache --compile-bytecode --no-editable

# Activate the environment - we will need it for commands below
ENV PATH=&quot;/myapp/.venv/bin:$PATH&quot;

# Install static files
RUN COLLECT_STATIC=True python manage.py collectstatic

# Add the static files to .venv
RUN uv sync --frozen --no-dev --no-cache --compile-bytecode --no-editable
</code></pre>
<p>This is a pretty simple set up. Copy the app source code, run <code>uv sync</code> to install all the dependencies. Once that's done, I can start up my django app and collect the static files. The files are placed in the source folder. Then, I run <code>uv sync</code> again so that the staticfiles are copied to virtual environment. The problem is they are not.</p>
<pre><code>#16 [builder  8/10] RUN uv sync --frozen --no-dev --no-cache --compile-bytecode --no-editable
#16 0.257 Using CPython 3.11.10 interpreter at: /usr/local/bin/python3
#16 0.257 Creating virtual environment at: .venv
#16 3.969 Prepared 141 packages in 3.69s
#16 4.107 Installed 141 packages in 138ms
#16 5.654 Bytecode compiled 6109 files in 1.54s
...
#16 DONE 6.2s

#17 [builder  9/10] RUN COLLECT_STATIC=True python manage.py collectstatic
#17 1.869 177 static files copied to '/myapp/myapp/staticfiles', 497 post-processed.
#17 DONE 2.4s

#18 [builder 10/10] RUN uv sync --frozen --no-dev --no-cache --compile-bytecode --no-editable
#18 0.216 Audited 141 packages in 0.52ms
#18 DONE 0.2s
</code></pre>
<p>Here's also the relevant part in pyproject.toml</p>
<pre><code class="language-toml">[build-system]
requires = [&quot;hatchling&quot;]
build-backend = &quot;hatchling.build&quot;

[tool.hatch.metadata]
allow-direct-references = true

[tool.hatch.build.targets.wheel]
only-include = [&quot;myapp&quot;, &quot;manage.py&quot;]
artifacts = [&quot;myapp/staticfiles&quot;]
</code></pre>
<p>I'm completely lost on what's going on for 2 primary reasons:</p>
<ol>
<li>In my local dev env, I can follow this procedure and it works: uv sync, collect static files, uv sync again and the app is packaged correctly with the static files.</li>
<li>I can add <code>RUN rm -rf .venv</code> to my dockerfile before the second invocation of <code>uv sync</code> and the static files will be then collected correctly.</li>
</ol>
<p>Please advise.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-22 13:57</div>
            <div class="timeline-body"><p>Thanks for the issue. I think I wouldn't expect this to work either locally or in CI, because we won't re-build / re-install your project after the static files are generated. By default, we only re-build / re-install local projects if the <code>pyproject.toml</code>, <code>setup.py</code>, or <code>setup.cfg</code> files change -- it's similar to https://docs.astral.sh/uv/concepts/cache/#dynamic-metadata, but this is about extra content and not dynamic metadata per se.</p>
<p>I think you probably want <code>--reinstall-package {project_name}</code> in the second command.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2024-11-22 13:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Mapiarz">@Mapiarz</a> on 2024-11-26 08:44</div>
            <div class="timeline-body"><p>@charliermarsh Thanks. That nudged me in the right direction. In fact, I utilized <code>--no-install-project</code> to first build the environment but not the app itself. Then I generate my artifacts and then I redo the sync and my app is installed into the environment for the first time, together with all the artifacts. No need for <code>--reinstall-package</code>.</p>
<p>That approach is much better because now I don't have to get all the dependencies every time the source code of my app changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Mapiarz on 2024-11-26 08:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:31:36 UTC
    </footer>
</body>
</html>
