<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv sync includes packages from excluded dependency group when using `--no-group`/`--only-group` - astral-sh/uv #16396</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv sync includes packages from excluded dependency group when using <code>--no-group</code>/<code>--only-group</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/16396">#16396</a>
        opened by <a href="https://github.com/jiito">@jiito</a>
        on 2025-10-21 17:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jiito">@jiito</a></div>
            <div class="timeline-body">Summary
<p>When excluding a dependency group via --no-group or selecting only another group via --only-group, uv sync still includes packages from the excluded group. The resolver reports inclusion due to the project’s gpu group even when that group is explicitly excluded.</p>
<p>Use case: Install a subset of dependencies on Mac machine.</p>
Minimal Reproducible Example:
<p>https://github.com/jiito/uv-groups-reproduction</p>
<ul>
<li>includes <code>-vvv</code> output logs</li>
</ul>
<pre><code>      rm -rf .venv uv.lock
      uv sync -vvv --no-group gpu
      rm -rf .venv uv.lock
      uv sync -vvv --only-group web
      rm -rf .venv uv.lock
      uv sync -vvv --no-default-groups --no-group gpu
</code></pre>
Expected behavior
<p>When passing --no-group gpu, no packages from the gpu group should be resolved or installed.
When passing --only-group web, only web group packages should be resolved/installed.</p>
Platform
<p>Darwin 24.5.0 arm64</p>
Version
<p>uv 0.9.4 (88f519a3b 2025-10-18)</p>
Python version
<p>Python 3.11.14</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/jiito">@jiito</a> on 2025-10-21 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/artpelling">@artpelling</a> on 2025-10-24 09:55</div>
            <div class="timeline-body"><p>Facing the same issue with latest <code>uv</code> (0.9.5).</p>
<p>Steps to reproduce:</p>
<pre><code>uv init mwe
cd mwe
uv add typer
uv add --dev numpy
uv run python -c &quot;import typer&quot;  # works
uv run --no-dev python -c &quot;import numpy&quot;  # works but should not ?
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-10-29 00:07</div>
            <div class="timeline-body"><p>@artpelling -- I think your case is <code>uv run</code> does an inexact sync by default (i.e., it will add packages as needed but avoids removing extraneous packages). If you add <code>--exact</code>, you should see the expected behavior:</p>
<pre><code>❯ uv run --exact --no-dev python -c &quot;import numpy&quot;
Uninstalled 1 package in 40ms
Traceback (most recent call last):
  File &quot;&lt;string&gt;&quot;, line 1, in &lt;module&gt;
    import numpy
ModuleNotFoundError: No module named &#x27;numpy&#x27;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-10-29 00:17</div>
            <div class="timeline-body"><p>I can&#x27;t reproduce this:</p>
<pre><code>❯ uv sync --no-group gpu
Resolved 16 packages in 318ms
Prepared 3 packages in 214ms
Installed 11 packages in 17ms
 + annotated-doc==0.0.3
 + annotated-types==0.7.0
 + anyio==4.11.0
 + fastapi==0.120.1
 + idna==3.11
 + pydantic==2.12.3
 + pydantic-core==2.41.4
 + sniffio==1.3.1
 + starlette==0.49.1
 + typing-extensions==4.15.0
 + typing-inspection==0.4.2
</code></pre>
<p>(I changed to <code>gpu = [&quot;requests&quot;]</code> so that I could resolve on macOS.)</p>
<p>Are you just seeing that it&#x27;s downloading the packages in the group and trying to build them? Or that it&#x27;s actually installing them? uv has to download and run those packages in order to get their dependencies, since the authors don&#x27;t publish static metadata. Once the lockfile is created, though, it shouldn&#x27;t be running them or similar.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-10-29 00:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-10-29 00:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-10-29 00:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/artpelling">@artpelling</a> on 2025-10-29 12:58</div>
            <div class="timeline-body"><blockquote>
<p><a href="https://github.com/artpelling">@artpelling</a> -- I think your case is <code>uv run</code> does an inexact sync by default (i.e., it will add packages as needed but avoids removing extraneous packages). If you add <code>--exact</code>, you should see the expected behavior:</p>
</blockquote>
<p>Works perfectly. Thanks for the quick support!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/zanieb">@zanieb</a> on 2025-10-29 14:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jiito">@jiito</a> on 2025-11-06 02:28</div>
            <div class="timeline-body"><blockquote>
<p>Are you just seeing that it&#x27;s downloading the packages in the group and trying to build them? Or that it&#x27;s actually installing them? uv has to download and run those packages in order to get their dependencies, since the authors don&#x27;t publish static metadata. Once the lockfile is created, though, it shouldn&#x27;t be running them or similar.</p>
</blockquote>
<p>I did not understand this nuance, my apologies for the mistake. Thanks for the guidance!</p>
<p>For posterity:</p>
<p>To remedy this, I added a <code>dependency-metadata</code> field to my <code>pyproject.toml</code> following the suggestion in <a href="https://github.com/astral-sh/uv/issues/7985">astral-sh/uv#7985</a>.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:40:45 UTC
    </footer>
</body>
</html>
