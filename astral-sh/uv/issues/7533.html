<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lock files don't mesh with dynamic package version info - astral-sh/uv #7533</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Lock files don't mesh with dynamic package version info</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/7533">#7533</a>
        opened by <a href="https://github.com/hynek">@hynek</a>
        on 2024-09-19 05:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/hynek">@hynek</a> on 2024-09-19 05:59</div>
            <div class="timeline-body"><p>Since tox-uv just shipped lock files, I took a stab at moving attrs to a fully-locked dev environment.</p>
<p>Here's the experiment PR: https://github.com/python-attrs/attrs/pull/1349</p>
<p>A problem I've run into is that packages often use dynamic packaging data that is based on git metadata (setuptools-scm, hatch-vcs, etc). As such, attrs's package version changes after every commit, which allows us to upload to test PyPI and continually verify our package. See, for example, https://test.pypi.org/project/attrs/24.2.1.dev19/</p>
<p>Unfortunately the current project gets locked like this:</p>
<pre><code class="language-toml">[[package]]
name = &quot;attrs&quot;
version = &quot;24.2.1.dev20&quot;
source = { editable = &quot;.&quot; }
</code></pre>
<p>Which means it's outdated after each commit, because every commit increments the number behind <code>dev</code>.</p>
<p>Is there a way around this that I've missed? If not, could there be built one? üòá AFAICT, this is currently the biggest blocker for FOSS use from <em>uv</em>'s side. I'm also not sure what the point of that version lock is in the first place for the current, editable project? But that's a topic for another day. :)</p>
<hr />
<pre><code>‚ùØ uv --version
uv 0.4.12 (2545bca69 2024-09-18)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sbidoul">@sbidoul</a> on 2024-09-19 06:23</div>
            <div class="timeline-body"><p>@hynek have you seen <code>tool.uv.cache-keys</code> ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hynek">@hynek</a> on 2024-09-19 06:29</div>
            <div class="timeline-body"><p>I have while searching this bug tracker, but I couldn't find a way for it to affect <code>uv.lock</code>? Changing the value to <code>cache-keys = [{ git = true }, { file = &quot;pyproject.toml&quot; }]</code> at least doesn't do anything when running <code>uv.lock</code>.</p>
<p>From the documentation (and its name ü§ì) I've gathered it's mostly about how caching, not about locking? And TBH it sounds to me as if adding git as a git key, I'm actually <em>adding</em> cache busting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-20 02:59</div>
            <div class="timeline-body"><p>I think you could pass <code>--upgrade-package attrs</code> to ensure that <code>attrs</code> is rebuilt and that the lockfile is updated. Or even set it in your configuration:</p>
<pre><code class="language-toml">[tool.uv]
upgrade-package = [&quot;attrs&quot;]
</code></pre>
<p>But there's sort of an infinite loop here, right? Since every time you commit the lockfile, it will be outdated. So you then re-lock, and commit again, etc. I don't know how to solve this holistically. We could omit versions for editables, maybe? Or even, write &quot;dynamic&quot; or something for the version, for packages that have dynamic versions?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hynek">@hynek</a> on 2024-09-20 03:27</div>
            <div class="timeline-body"><blockquote>
<p>But there's sort of an infinite loop here, right? Since every time you commit the lockfile, it will be outdated. So you then re-lock, and commit again, etc. We could omit versions for editables, maybe? Or even, write &quot;dynamic&quot; or something for the version, for packages that have dynamic versions?</p>
</blockquote>
<p>Yeah that's what I meant in my last sentence, but I'm always assuming Chesterton's Fence. :) Setting it to <code>dynamic</code> seems the best way since it maps nicely to <code>project.dynamic</code>. Just dunno if it would be a problem that there's a case where there's an invalid version &quot;number&quot; in the field which would speak for omitting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jkeifer">@jkeifer</a> on 2024-09-20 17:52</div>
            <div class="timeline-body"><p>I too have this problem. I generally subscribe to the philosophy that I use a VCS for versioning, thus what is in the VSC repo shouldn't track it's own version because that's what I'm using the VCS for. Said another way, at best a version tracked within repo is imperfect for exactly the reasons described above about how you can't update a version from a commit without making another commit, i.e., a new version.</p>
<p>I'd love to understand the rationale behind storing this version in the lock file. Can anyone elaborate on that?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/burgholzer">@burgholzer</a> on 2024-09-26 15:53</div>
            <div class="timeline-body"><p>We are also facing a similar problem over at https://github.com/cda-tum/mqt-core/pull/706 where we use renovate to keep the <code>uv</code> lock file up to date, which would be pretty convenient in principle.
However, currently it triggers a never ending chain of renovate update PRs because every update to the lock file adds a commit, which changes the <code>setuptools-scm</code> version, which causes another update PR to be triggered. (see https://github.com/cda-tum/mqt-core/pull/703, https://github.com/cda-tum/mqt-core/pull/704, https://github.com/cda-tum/mqt-core/pull/705, https://github.com/cda-tum/mqt-core/pull/706)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LordFckHelmchen">@LordFckHelmchen</a> on 2024-10-01 11:36</div>
            <div class="timeline-body"><p>This problem is not only for dynamic versioning. We have a release-please workflow, which will create a PR for the next release. This will update the pyproject.toml version correctly but of course does not know about the uv.lock version.
If there would be an option to omit the project version from the uv.lock it would be great, as I currently also don't understand why it needs to be kept in the lock-file itself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/7994.html">astral-sh/uv#7994</a> on 2024-10-08 09:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/david-waterworth">@david-waterworth</a> on 2024-10-08 22:22</div>
            <div class="timeline-body"><p>As I mentioned in  ttps://github.com/astral-sh/uv/issues/7994 I use<code>python-semantic-release</code> which behaves the same. The way I work around the infinite build loop is to configure my Jenkins script to skip commits that contains the <code>python-semantic-release</code> message - these commits include the changed <code>pyproject.toml</code> and <code>__version__.py</code> file, along with a generated CHANGELOG.md</p>
<p>As a workaround, I also added <code>uv lock</code> at the start of the build script and <code>git add uv.lock</code> at the end - this ensures that <code>python-semantic-release</code> commit includes the correctly versioned <code>uv.lock</code> file (I'm not sure yet if this causes other problems, i.e. updating other packages - ideally there would be a way of only updating the package version in <code>uv.lock</code> and nothing else.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../edgarrmondragon/meltano-hub-api/issues/143.html">edgarrmondragon/meltano-hub-api#143</a> on 2024-10-17 01:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/8590.html">astral-sh/uv#8590</a> on 2024-10-26 11:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/alejandrodnm">@alejandrodnm</a> on 2024-10-31 10:59</div>
            <div class="timeline-body"><p>I've just encountered this. We are also using release-please and uv in an internal project, after a release then the surprise is that the uv.lock was outdated.</p>
<p>Ours plans were to add uv to https://github.com/timescale/pgai but since we are already using release-please, we are hesitant due to this issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/6860.html">astral-sh/uv#6860</a> on 2024-11-04 10:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../localstack/localstack-sdk-python/pulls/5.html">localstack/localstack-sdk-python#5</a> on 2024-11-05 09:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/RazerM">@RazerM</a> on 2024-11-06 11:49</div>
            <div class="timeline-body"><p>While the setuptools-scm case seems difficult to solve, I think another common reason[^1] a dynamic version is used is when the version is statically defined but not in <code>pyproject.toml</code>. Typically as a <code>__version__</code> attribute like in this example:</p>
<ol>
<li><p>Create example project</p>
<pre><code class="language-bash">uv init --lib mpypkg &amp;&amp; cd mpypkg
</code></pre>
</li>
<li><p>Configure <code>pyproject.toml</code> to use a dynamic version</p>
<pre><code class="language-bash">cat &lt;&lt;EOF &gt; pyproject.toml
[build-system]
requires = [&quot;setuptools&quot;]
build-backend = &quot;setuptools.build_meta&quot;

[project]
name = &quot;mpypkg&quot;
requires-python = &quot;&gt;=3.12&quot;
dynamic = [&quot;version&quot;]

[tool.uv]
cache-keys = [{ file = &quot;pyproject.toml&quot; }, { file = &quot;src/mpypkg/__init__.py&quot; }]

[tool.setuptools.dynamic]
version = { attr = &quot;mpypkg.__version__&quot; }

[tool.setuptools]
package-dir = { &quot;&quot; = &quot;src&quot; }

[tool.setuptools.packages.find]
where = [&quot;src&quot;]
EOF
</code></pre>
</li>
<li><p>Add <code>__version__</code> attribute to <code>__init__.py</code></p>
<pre><code class="language-bash">cat &lt;&lt;EOF &gt;&gt; src/mpypkg/__init__.py
__version__ = &quot;1.0&quot;
EOF
</code></pre>
</li>
<li><p>Run <code>uv lock</code></p>
</li>
<li><p>Change version number</p>
<pre><code class="language-bash">sed -i.bak 's/__version__ = &quot;1\.0&quot;/__version__ = &quot;1.1&quot;/' src/mpypkg/__init__.py
</code></pre>
</li>
<li><p>Run <code>uv lock</code></p>
</li>
</ol>
<p>What I expected:</p>
<pre><code class="language-diff"> version = 1
 requires-python = &quot;&gt;=3.12&quot;
 
 [[package]]
 name = &quot;mpypkg&quot;
-version = &quot;1.0&quot;
+version = &quot;1.1&quot;
 source = { editable = &quot;.&quot; }
</code></pre>
<p>What happened: uv.lock still has <code>version = &quot;1.0&quot;</code></p>
<p>I've also tried <code>uv lock --no-cache --refresh</code> to no avail.</p>
<p>The version doesn't change until I do an unrelated <code>uv add</code> or something. This seems like a cache invalidation problem more than anything else, which I expected <code>cache-keys</code> to solve.</p>
<p>[^1]: sometimes for backward compatibility reasons or in my case I can't move version into pyproject.toml until some other tooling I use catches up.</p>
<hr />
<pre><code>‚ùØ uv --version
uv 0.4.30 (61ed2a236 2024-11-04)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-06 13:59</div>
            <div class="timeline-body"><p>We can fix this, but I still strongly recommend against setting the version dynamically like that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/8866.html">astral-sh/uv#8866</a> on 2024-11-06 16:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-06 16:31</div>
            <div class="timeline-body"><p>I've fixed the issue @RazerM pointed out in https://github.com/astral-sh/uv/pull/8867. I guess I'll leave <em>this</em> issue open though since it's more about the inherent incompatibility between lockfiles and VCS-based versioning.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cpascual">@cpascual</a> on 2024-11-06 18:44</div>
            <div class="timeline-body"><p>Hi @charliermarsh, you mention <em>&quot;inherent incompatibility of lock files and VCS-based versioning&quot;</em> , but you also mentioned:</p>
<blockquote>
<p>We could omit versions for editables, maybe? Or even, write &quot;dynamic&quot; or something for the version, for packages that have dynamic versions?</p>
</blockquote>
<p>To me the above workaround seems good enough, specially if it is controlled by an opt-in configuration (e.g. <code>omit_lock_version=[&quot;mypackage&quot;,]</code>).</p>
<p>Is there any fundamental problem with this approach?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cpascual">@cpascual</a> on 2024-11-06 18:44</div>
            <div class="timeline-body"><p>my use case is that I use <code>setuptools-scm</code> and the presence of commit-dependent version numbers in <code>uv.lock</code> is a frustrating cause of git merge conflicts preventing what otherwise would be an automated merge.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ceejatec">@ceejatec</a> on 2024-11-08 08:15</div>
            <div class="timeline-body"><blockquote>
<p>We can fix this, but I still strongly recommend against setting the version dynamically like that.</p>
</blockquote>
<p>@charliermarsh Out of curiosity, why?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Coruscant11">@Coruscant11</a> on 2024-11-08 18:03</div>
            <div class="timeline-body"><p>I just discovered this issue with the recent release 0.5.0. Using --locked when syncing the project makes everything fails. I have a dynamic version based on git tags, and when we release we tag our repository. So the lock file can be outdated without any code change.</p>
<p>I think excluding editable dependencies in the lock file could be a good workaround. Or we can also write &quot;dynamic&quot; as a version. By the way I will check what tools like poetry for example are doing in this use case.
@charliermarsh Is there any news on this? In the meantime, we will pin our version to the 0.4.30.</p>
<p>By the way I would suggest to list it in the breaking changes of the release</p>
<p>Thanks !!!</p>
<p>Edit: Forgot to mention, I was wondering if you already have some implementation ideas, I totally volunteer to work on this if needed. I will try a draft pull-request on my side for fun</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Stealthii">@Stealthii</a> on 2024-11-13 00:14</div>
            <div class="timeline-body"><blockquote>
<p>We can fix this, but I still strongly recommend against setting the version dynamically like that.</p>
</blockquote>
<p>If references or opinion articles exist around this topic, they are few in number. I think a few on this issue would be interested in wider discussion around this. <a href="https://peps.python.org/pep-0621/">PEP 621</a> introduced toml metadata, and as of writing the <a href="https://packaging.python.org/en/latest/specifications/pyproject-toml/#pyproject-toml-spec">official specification</a> still allows <code>version</code> to be set dynamically, with no recommendation to the contrary.</p>
<p>It's a pretty standard paradigm (see <a href="https://github.com/ofek/hatch-vcs">hatch-vcs</a>, <a href="https://github.com/pypa/setuptools-scm">setuptools-scm</a>, <a href="https://github.com/mtkennerly/poetry-dynamic-versioning">poetry-dynamic-versioning</a>) for single project repos where versioning, point release branches, development builds, etc. are all managed and controlled via VCS change control.</p>
<p>Whilst alternatives exist for separating static versions (such as <code>0.5.1</code> from a generated identifier ref like <code>f399a5271</code> in <code>uv 0.5.1 (f399a5271 2024-11-08)</code>), there are some compelling reasons to use dynamic (such as <a href="https://github.com/mtkennerly/dunamai">dunamai</a>) formed versions:</p>
<ul>
<li>Unique reference of all release, post, dev, dirty distributions of Python packages</li>
<li>All tarball/wheel builds being uniquely available in an internal PyPI repository for further testing or triage</li>
<li>Rules around versioning and releases can be set by project owners irrespective of development language</li>
<li>No room for user error (such as forgetting to update a static version of <code>0.5.1</code> for the git tag <code>v0.5.1</code> and publishing builds)</li>
<li>Exposing the version in test logs, headers, etc. automatically shows the exact build used, aiding debugging</li>
</ul>
<hr />
<p>My expectation for the project package that has a <strong>dynamic</strong> version (<code>source = { editable = &quot;.&quot; }</code> specifically) would be simply not defining version in <code>uv.lock</code> for the local package (or providing a dynamic reference). This by nature isn't a lockable reference (especially when set by VCS signatures) whereas other uses of <code>uv lock</code> such as multi-project mono repos or static versions uphold the current behaviour.</p>
<p>It's worth noting that although version is defined dynamically in source control, builds of the package provide the version statically:</p>
<pre><code class="language-console">‚ùØ ls -1 dist/*
dist/mypackage-0.5.0.dev5+g5d056c1-py3-none-any.whl
dist/mypackage-0.5.0.dev5+g5d056c1.tar.gz
‚ùØ unzip -p dist/*.whl '*.dist-info/METADATA' | grep -E '^Version: '
Version: 0.5.0.dev5+g5d056c1
‚ùØ tar -Oxf dist/*.tar.gz '*.egg-info/PKG-INFO' | grep -E '^Version: '
Version: 0.5.0.dev5+g5d056c1
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-13 03:05</div>
            <div class="timeline-body"><blockquote>
<p>If references or opinion articles exist around this topic, they are few in number.</p>
</blockquote>
<p>This is just my personal opinion! Dynamic metadata makes a number of things more complicated than they need to be. I understand the use-case for scm versioning, but in my opinion using dynamic metadata to read a version from <code>__init__.py</code> is a really heavy hammer with the only benefit being that you get to avoid writing out a constant twice -- I was responding to that specific case, where I don't think the tradeoffs are very good.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-13 03:06</div>
            <div class="timeline-body"><blockquote>
<p>...simply not defining version in uv.lock for the local package (or providing a dynamic reference)</p>
</blockquote>
<p>Unfortunately it's not super simple -- it breaks the fundamental assumption that packages have versions, so we have to take that into account everywhere.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Coruscant11">@Coruscant11</a> on 2024-11-13 06:07</div>
            <div class="timeline-body"><blockquote>
<p>Unfortunately it's not super simple -- it breaks the fundamental assumption that packages have versions, so we have to take that into account everywhere.</p>
</blockquote>
<p>Yes this is what I saw this week-end when I was trying to contribute on this ü•≤
But anyway, I had the opportunity to deep dive in the code base so it's fine.
We will have to trust you on this üòÑ (No need to worry at all then)</p>
<p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ceejatec">@ceejatec</a> on 2024-11-13 06:19</div>
            <div class="timeline-body"><blockquote>
<p>it breaks the fundamental assumption that packages have versions</p>
</blockquote>
<p>Not exactly, I don't think. The package always DOES have a version. It's just that the version may change outside of uv's immediate notice. Perhaps it would be fine if <code>uv lock</code> and <code>uv sync</code> and similar commands re-assessed the version if it's marked <code>dynamic</code> in the <code>pyproject.toml</code>. That wouldn't handle cases where the dynamic version contains the git commit SHA in some form, but I suspect that's pretty much an intractable problem.</p>
<p>That said, I feel like a cleaner solution would be to omit the main package from <code>uv.lock</code> entirely. However I'm definitely not familiar with the implementation here, so I don't know what unforeseen consequences that might have.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hynek">@hynek</a> on 2024-11-13 08:25</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>If references or opinion articles exist around this topic, they are few in number.</p>
</blockquote>
<p>This is just my personal opinion! Dynamic metadata makes a number of things more complicated than they need to be. I understand the use-case for scm versioning, but in my opinion using dynamic metadata to read a version from <code>__init__.py</code> is a really heavy hammer with the only benefit being that you get to avoid writing out a constant twice -- I was responding to that specific case, where I don't think the tradeoffs are very good.</p>
</blockquote>
<p>By the way, this can be inverted and made more standard-compliant while doing so by putting something like this into your <code>__init__.py</code>:</p>
<pre><code class="language-python">def __getattr__(name: str) -&gt; str:
    if name != &quot;__version__&quot;:
        msg = f&quot;module {__name__} has no attribute {name}&quot;
        raise AttributeError(msg)

    from importlib.metadata import version

    return version(&quot;YOUR-PACKAGE&quot;)
</code></pre>
<p>You get static metadata with no duplication.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ninoseki">@ninoseki</a> on 2024-11-13 08:35</div>
            <div class="timeline-body"><p>I have the same pain point and would like to share how many projects in the wild do Git based versioning for your information.</p>
<ul>
<li><a href="https://github.com/search?q=path%3Apyproject.toml+%22hatch-vcs%22+%22dynamic+%3D+%5B%5C%22version%5C%22%5D%22&amp;type=code">hatch-vcs</a>: 2.2k files</li>
<li><a href="https://github.com/search?q=path%3Apyproject.toml+%22tool.poetry-dynamic-versioning%22+%22enable+%3D+true%22&amp;type=code">poetry-dynamic-versioning</a>: 1.6k files</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/roteiro">@roteiro</a> on 2024-11-13 09:36</div>
            <div class="timeline-body"><blockquote>
<p>I have the same pain point and would like to share how many projects in the wild do Git based versioning for your information.</p>
<ul>
<li><a href="https://github.com/search?q=path%3Apyproject.toml+%22hatch-vcs%22+%22dynamic+%3D+%5B%5C%22version%5C%22%5D%22&amp;type=code">hatch-vcs</a>: 2.2k files</li>
<li><a href="https://github.com/search?q=path%3Apyproject.toml+%22tool.poetry-dynamic-versioning%22+%22enable+%3D+true%22&amp;type=code">poetry-dynamic-versioning</a>: 1.6k files</li>
</ul>
</blockquote>
<p>add to that:</p>
<ul>
<li><a href="https://github.com/search?q=path%3Apyproject.toml+%22versioningit%22+%22dynamic+%3D+%5B%5C%22version%5C%22%5D%22&amp;type=code">versioningit</a> 420 files</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jamesbraza">@jamesbraza</a> on 2024-11-13 18:21</div>
            <div class="timeline-body"><p>I think https://github.com/astral-sh/uv/pull/8867 released in <code>uv==0.5.0</code> leads <code>uv</code> to correctly respect dynamic metadata, which now breaks <code>setuptools-scm</code> + <code>pre-commit</code> users using the <code>uv-lock</code> hook: https://github.com/astral-sh/uv-pre-commit/issues/25.</p>
<p>This is textbook <a href="https://www.hyrumslaw.com/">Hyrum's Law</a> üòÜ</p>
<hr />
<p>To share on the SCM versioning debate, I use <code>setuptools-scm</code> as it's a nice way for an automated (no human error) workflow of GitHub tagged release to PyPI publish with matching version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-13 18:24</div>
            <div class="timeline-body"><p>Yeah, it seems like fundamentally the only way to make this work with <code>setuptools-scm</code> is to omit the version or otherwise mark it as dynamic. I don't think it's <em>impossible</em>, but it's not, like, an hour of work. I'm also fairly worried about how we would integrate this if PEP 751 gets approved -- the PEP doesn't make any carveouts for dynamic versions, and there hasn't been any discussion of it in the <a href="https://discuss.python.org/t/pep-751-now-with-graphs/69721/1">PEP thread</a>. If we add a feature like this here, and it doesn't make it into the PEP, we'll have to remove it later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../Future-House/ldp/pulls/152.html">Future-House/ldp#152</a> on 2024-11-13 18:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-design</span> added by @zanieb on 2024-11-14 15:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @zanieb on 2024-11-14 15:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/apollo13">@apollo13</a> on 2024-11-14 15:53</div>
            <div class="timeline-body"><blockquote>
<p>I think #8867 released in <code>uv==0.5.0</code> leads <code>uv</code> to correctly respect dynamic metadata, which now breaks <code>setuptools-scm</code> + <code>pre-commit</code> users using the <code>uv-lock</code> hook: <a href="https://github.com/astral-sh/uv-pre-commit/issues/25">astral-sh/uv-pre-commit#25</a>.</p>
</blockquote>
<p>Can confirm that our workflow (using hatchling as build backend with a dynamic version) breaks when trying to do <code>uv sync --locked</code> since uv <code>0.5</code>. <code>0.4.30</code> is fine. Whether it is actually #8867 that broke it I cannot tell, but sounds plausible.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-14 16:16</div>
            <div class="timeline-body"><p>It likely was https://github.com/astral-sh/uv/pull/8867 that led to the change, though sadly that really was a bugfix -- the existing behavior was wrong. Right now there just isn't a clear way to use scm-based versioning with lockfiles, but I'm thinking about it. My biggest hesitation to investing in it deeply is the aforementioned PEP 751. I don't want to do something that will become invalid once the standard exists.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dsully">@dsully</a> on 2024-11-14 17:40</div>
            <div class="timeline-body"><p>Is @brettcannon aware of this problem? Should PEP-751 take this usage into account?</p>
<p>(I'm also not 100% sold we need a universal lockfile format. I believe the 715 discussion thread also mentions this. ü§∑ )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-14 18:04</div>
            <div class="timeline-body"><p>I've been deeply involved in the thread and don't <em>think</em> it's come up, but I'll post about it today.</p>
<p>(Edit: @hynek already did.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/apollo13">@apollo13</a> on 2024-11-14 18:18</div>
            <div class="timeline-body"><blockquote>
<p>(I'm also not 100% sold we need a universal lockfile format. I believe the 715 discussion thread also mentions this. ü§∑ )</p>
</blockquote>
<p>Having a universal lockfile seems better than trying to add support for 100 different lock file formats to every other SBOM tool out there :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/brettcannon">@brettcannon</a> on 2024-11-14 18:21</div>
            <div class="timeline-body"><blockquote>
<p>Having a universal lockfile seems better than trying to add support for 100 different lock file formats to every other SBOM tool out there :D</p>
</blockquote>
<p>I'm going to ask that if @dsully or anyone else wants to express concern over standardizing lock files they bring it up on the PEP 751 discussion over on discuss.python.org and not here as I don't think the uv issue tracker is the best place to talk about PEPs that affect the wider Python packaging ecosystem üòâ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/9126.html">astral-sh/uv#9126</a> on 2024-11-14 18:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hynek">@hynek</a> on 2024-11-14 18:34</div>
            <div class="timeline-body"><p>For posterity: https://discuss.python.org/t/pep-751-now-with-graphs/69721/86</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dsully">@dsully</a> on 2024-11-15 17:52</div>
            <div class="timeline-body"><p>Will do @brettcannon, thanks! Though looks like Hynek got there first üòé</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../reservoir-data/tap-fedidb/issues/25.html">reservoir-data/tap-fedidb#25</a> on 2024-11-15 18:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tomrutter">@tomrutter</a> on 2024-11-17 23:59</div>
            <div class="timeline-body"><p>Sorry to pipe in on a largely completed debate but I have one idea to put.</p>
<p>My issue here seems the same as many other users:</p>
<ol>
<li>My python package uses automatic versioning based on git tag for fewer user errors and easier tracking of built artefacts.</li>
<li>The package version is included in lock file, which when committed changes commit tag and thus the version.</li>
<li>As part of CI, I check lock file is up to date (for reproducibility). This check fails because of the version change of the local workspace package.</li>
</ol>
<p>Changing any one of these links could fix the issue. I think most of the discussion has been about 1 and 2. That is, either moving away from dynamic versioning or changing how lock files work for local packages.</p>
<p>However, a simpler resolution might be via step 3? If uv were to allow users to check that lock files are up to date apart from the versions of any current workspace packages that have dynamic versions then the current workflow would be able to continue. Effectively this returns to the workflow of the pre 0.5.0 uv, while still correctly updating the lock file (and re-installing the package). I would expect this would catch most of the current use cases for <code>uv lock --frozen</code></p>
<p>This could work by adding an option to <code>uv lock --frozen</code> etc to allow versions of local packages with dynamic versioning to change but to error if any other dependencies change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-18 13:48</div>
            <div class="timeline-body"><p>I think the solution here will ultimately be to stop storing versions for source trees (either entirely, or when dynamic -- I prefer doing so entirely, and not based on whether it's dynamic). I just want PEP 751 to play out a little more before I make any change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-18 13:50</div>
            <div class="timeline-body"><p>(Once we have clarity on what we want to do, I'll prioritize the change.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nathanjmcdougall">@nathanjmcdougall</a> on 2024-11-19 03:46</div>
            <div class="timeline-body"><p>As a temporary kind of hacky semi-workaround, I am using <code>uv export</code> via <a href="https://github.com/astral-sh/uv-pre-commit">uv-pre-commit</a>. Changes to the dependencies in <code>pyproject.toml</code> get reflected in a changed <code>requirements.txt</code> file, failing the hook. Since the <code>requirements.txt</code> file doesn't include the version of the editable-installed package, it doesn't suffer from the same issue as checking against <code>uv.lock</code> directly.</p>
<p>In theory, the user could still get around this by modifying both the <code>pyproject.toml</code> and <code>requirements.txt</code> files but not the <code>uv.lock</code> file, since the hook is not checking the lockfile directly. I don't really think that would be possible in most cases without creating a <code>requirements.txt</code> file that mismatches what would get created by <code>uv export</code> so it would still fail, forcing a lockfile update.</p>
<p>It protects against a situation where a dependency gets declared in <code>pyproject.toml</code> but the user forgets to run <code>uv sync</code> or <code>uv lock</code> - the pre-commit would fail, and the lockfile would be updated as a side-effect. But if the user is using <code>uv add</code> then this adds little benefit since it's unlikely the user would declare in <code>pyproject.toml</code> manually in the first place.</p>
<p>My plan is to get my organization to stop using dynamic versioning in packages...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/9233.html">astral-sh/uv#9233</a> on 2024-11-19 16:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mjpieters">@mjpieters</a> on 2024-11-19 16:48</div>
            <div class="timeline-body"><p>We use a <a href="https://taskfile.dev/"><code>Taskfile.yml</code> task definition</a>, so I have a <em>little</em> more flexibility, and I use it to apply an ugly work-around: When we update the lock I force the version to be <code>0.0.0</code> by setting <code>SETUPTOOLS_SCM_PRETEND_VERSION</code> (which works for either <code>hatch-vcs</code> or <code>setuptools-scm</code>):</p>
<pre><code>  dev:lock:
    aliases:
      - lock
    desc: Lock dependencies
    preconditions:
      - sh: type &quot;uv&quot; &amp;&gt;/dev/null
        msg: Please install uv, see https://docs.astral.sh/uv/getting-started/installation/
    sources:
      - pyproject.toml
    generates:
      - pyproject.toml
      - uv.lock
    env:
      # avoid locking with a dynamic (hatch-vcs) version.
      SETUPTOOLS_SCM_PRETEND_VERSION: 0.0.0
    cmds:
      - uv lock
</code></pre>
<p>and then, when linting:</p>
<pre><code>  dev:lint:
    aliases:
      - lint
    desc: Runs linters
    preconditions:
      - sh: type &quot;uv&quot; &amp;&gt;/dev/null
        msg: Please install uv, see https://docs.astral.sh/uv/getting-started/installation/
    cmds:
      - |
        SETUPTOOLS_SCM_PRETEND_VERSION=0.0.0 uv lock --locked 2&gt;/dev/null || {
          echo -e '\033[0;31mThe lockfile at `uv.lock` needs to be updated. To update the lockfile, run `task dev:lock`\033[0m'.
          exit 1
        } &gt;&amp;2
</code></pre>
<p>This lets us at least avoid recording the current dynamic version in the lock file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../zanieb/uv/issues/6.html">zanieb/uv#6</a> on 2024-11-26 17:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/9452.html">astral-sh/uv#9452</a> on 2024-11-26 21:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thcrt">@thcrt</a> on 2024-12-11 00:02</div>
            <div class="timeline-body"><p>Just checking- is there any way to use dynamic versioning and build with GitHub Actions while also including <code>uv.lock</code>in version control?</p>
<p>I haven't been able to get it working, and I'm not  sure whether this is a problem with <a href="https://github.com/actions/checkout">actions/checkout</a>, with <a href="https://github.com/ofek/hatch-vcs">hatch-vcs</a>, with <a href="https://github.com/pypa/setuptools-scm">setuptools-scm</a> or with uv.</p>
<p>I can run <code>uv build</code> on my own machine just fine, and when I do this after having tagged the latest commit, the resulting builds have the version of the tag. However, I've found it impossible to get the same thing to happen via a workflow. The <code>uv sync</code> step <em>always</em> seems to set the version to include a <a href="https://packaging.python.org/en/latest/specifications/version-specifiers/#developmental-releases">developmental release segment</a> and a <a href="https://packaging.python.org/en/latest/specifications/version-specifiers/#local-version-identifiers">local version identifier</a>, such as <code>0.2.2.dev0+g38cf6c2.d20241210</code>.</p>
<p>The only way that I can find to prevent this from happening is removing <code>uv.lock</code> from version control. Obviously, this isn't ideal.</p>
<p>I'd love to know if there's something I'm missing, and it's possible to use <code>hatch-vcs</code>, <code>uv</code> and GitHub Actions workflows together. If this is an issue with one of the other projects involved, let me know and I'll report it to them :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nathanjmcdougall">@nathanjmcdougall</a> on 2024-12-11 02:22</div>
            <div class="timeline-body"><p>@thcrt This probably isn't exactly what you're looking for, but I've found this works:</p>
<p>https://gist.github.com/nathanjmcdougall/42135563c719cfda59a1de317da5116b</p>
<p>Note that this deliberately avoids running <code>uv sync</code>, to avoid the issue. I'm using <code>hatch-vcs</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thcrt">@thcrt</a> on 2024-12-11 11:17</div>
            <div class="timeline-body"><p>@nathanjmcdougall Incredible. You are a <em>saint</em> (and a fellow Kiwi!)</p>
<p>Genuinely, thank you so much, this has been a major headache for me in two different projects.</p>
<p>I imagine that not running <code>uv sync</code> in CI may have its downsides, but I'm happy to run it locally and manually if that's the tradeoff for having builds work properly.</p>
<p>Thank you so much again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/roteiro">@roteiro</a> on 2024-12-12 06:54</div>
            <div class="timeline-body"><p>Since <a href="https://discuss.python.org/t/pep-751-now-with-graphs/69721">PEP 751</a> and therefore a holistic solution within uv looks like it will take some more time, here is my work-around to avoid the <code>uv sync</code> &lt;-&gt; <code>git commit</code> loop of <code>uv.lock</code>, aimed at local development of an app <code>myapp</code>:</p>
<p>Instead of running <code>uv sync</code> or e.g. <code>uv run myentrypoint</code> which calls <code>uv sync</code> implicitely, I do the following:</p>
<pre><code>uv sync
sed -i -e '/myapp/ {' -e 'n; s/.*/version = \&quot;0.0+dynamic\&quot;/' -e '}' uv.lock # replace next line in uv.lock with dynamic version if previous line matches name of our package. Taken from: https://stackoverflow.com/questions/18620153/find-matching-text-and-replace-next-line/18620241#comment76950756_18620241:
uv run --frozen myentrypoint
</code></pre>
<p>I take care to only commit the modified <code>uv.lock</code> with <code>version = 0.0+dynamic</code>. I'm sure that this approach could be integrated into a pre-commit rule as well, but haven't looked into it yet. Of course, this can also be integrated into the task runner of your choice, I use <a href="https://taskfile.dev/">task</a> and my <code>Taskfile.yml</code> has something like:</p>
<pre><code class="language-yaml">tasks:
  dynamic-version:
    desc: replace next line in uv.lock with dynamic version if previous line matches name of our package, see  https://stackoverflow.com/questions/18620153/find-matching-text-and-replace-next-line/18620241#comment76950756_18620241
    cmds:
      - sed -i -e '/myapp/ {' -e 'n; s/.*/version = \&quot;0.0+dynamic\&quot;/' -e '}' uv.lock
     
  sync:
    desc: runs a uv sync followed by resetting the package version to dynamic
    cmds:
      - uv sync
      - task: dynamic-version
      
  run:
    desc: runs myapp
    cmds:
        - task: sync
        - uv run --frozen myentrypoint


</code></pre>
<p>For the moment, this serves me well. If there are any unintentional side-effects, I'm eager to learn about them</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/5633.html">astral-sh/uv#5633</a> on 2024-12-12 14:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/9874.html">astral-sh/uv#9874</a> on 2024-12-13 17:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/superlopuh">@superlopuh</a> on 2024-12-13 19:28</div>
            <div class="timeline-body"><p>Would it be possible to allow for this behaviour?</p>
<pre><code>uv sync --locked # Fails due to dynamic version mismatch
uv sync --locked --allow-editable # Succeeds
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ayjayt">@ayjayt</a> on 2024-12-16 03:34</div>
            <div class="timeline-body"><p>from @charliermarsh:</p>
<blockquote>
<p>But there's sort of an infinite loop here, right? Since every time you commit the lockfile, it will be outdated. So you then re-lock, and commit again, etc. I don't know how to solve this holistically. We could omit versions for editables, maybe? Or even, write &quot;dynamic&quot; or something for the version, for packages that have dynamic versions?</p>
</blockquote>
<p>Narrowing things down, this specific issue is only when you are trying to pin the version of the repository you are currently working in. No other dependency matters, editable, dynamic, or not, since <code>uv.lock</code> updates won't cause the infinite loop if they don't effect those repos (so I'll ignore whether or not its helpful to try and lock a <code>-e</code>).</p>
<p>Furthermore, you don't <em>need</em> to mark the version in <code>uv.lock</code> of the current repository, theoretically, because the <code>uv.lock</code> will be checked into git against that version anyway.</p>
<p>So I propose something like</p>
<p><code>version = &quot;self&quot;</code> if the <code>uv.lock</code> is storing metadata for the same project from which a <code>pyproject.toml</code> is in that same directory.</p>
<h3>Side Note: Further Spooky Behavior (extra notes I'm writing for if I come back to this convo)</h3>
<p>nevermind about side note, its just https://github.com/astral-sh/uv/issues/6860 + not knowing when <code>uv lock --upgrade</code> runs or doesn't</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JacobHayes">@JacobHayes</a> on 2024-12-16 04:20</div>
            <div class="timeline-body"><p>If you're using <code>hatch-vcs</code>, I've been working around this by setting <code>SETUPTOOLS_SCM_PRETEND_VERSION</code> as documented <a href="https://github.com/ofek/hatch-vcs#version-source-environment-variables">here</a>.</p>
<p>Eg, I've added this to my <code>.envrc</code> (for <a href="https://direnv.net">direnv</a>):</p>
<pre><code class="language-sh"># `uv` pins the version in the `uv.lock` file, but this leads to churn with each commit when using
# `hatch-vcs`. Instead, we can override the version to force stability until [1] is resolved.
#
# 1: https://github.com/astral-sh/uv/issues/7533
export SETUPTOOLS_SCM_PRETEND_VERSION=&quot;0.1.0&quot;
</code></pre>
<p>and then all <code>uv sync</code> commands I run <em>locally</em> build a wheel with that version, meaning the <code>uv.lock</code> is stable. I've tested adding a dependency to <code>project.dependencies</code> and a subsequent <code>uv sync</code> detects that and adds it to the <code>uv.lock</code>.</p>
<p>Seems to be working fine, but I'm not sure what other ramifications it might have - at the least, it probably doesn't play as well with projects with non-python (ie: built) dependencies.</p>
<hr />
<p>edit: ah, I see <code>SETUPTOOLS_SCM_PRETEND_VERSION</code> was <a href="https://github.com/astral-sh/uv/issues/7533#issuecomment-2486235749">noted above too</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../xdslproject/xdsl/pulls/3639.html">xdslproject/xdsl#3639</a> on 2024-12-16 08:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../urllib3/urllib3/pulls/3530.html">urllib3/urllib3#3530</a> on 2024-12-16 18:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sciyoshi">@sciyoshi</a> on 2024-12-19 16:41</div>
            <div class="timeline-body"><p>Note that neither setting <a href="https://docs.astral.sh/uv/reference/settings/#package">package = false in [tool.uv]</a> nor using --no-install-project addresses the issue, because it seems like the project is still included in uv.lock regardless.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/brandon-avantus">@brandon-avantus</a> on 2024-12-19 17:36</div>
            <div class="timeline-body"><p>Here's a temporary fix for those using <code>hatch-vcs</code> that doesn't require setting environment variables in your development environment, unless you want to override the version, such as when rolling a distribution.</p>
<p>Copy the following code block, paste it into a file named <code>hatch_build.py</code>, and save it next to <code>pyproject.toml</code>. Then add <code>[tool.hatch.metadata.hooks.custom]</code> to <code>pyproject.toml</code>.</p>
<pre><code class="language-python"># hatch_build.py

&quot;&quot;&quot;Hatchling custom metadata hook.

Temporary fix until Astral decides how to handle dynamic project versions
in the uv.lock file.

See https://github.com/astral-sh/uv/issues/7533

To enable, place this file next to and add the following line to the
pyproject.toml file:

    [tool.hatch.metadata.hooks.custom]

To override, set SETUPTOOLS_SCM_PRETEND_VERSION environment variable to the
desired version before building, or set CI=1 (already set in GitHub actions)
to let hatch-vcs (using setuptools-scm) determine the version from the git tag.
&quot;&quot;&quot;

import os

from hatchling.metadata.plugin.interface import MetadataHookInterface

if not os.environ.get(&quot;SETUPTOOLS_SCM_PRETEND_VERSION&quot;) and not os.environ.get(&quot;CI&quot;):
    os.environ[&quot;SETUPTOOLS_SCM_PRETEND_VERSION&quot;] = &quot;0.dev0+local&quot;

class CustomMetadataHook(MetadataHookInterface):
    def update(self, metadata: dict) -&gt; None:
        pass
</code></pre>
<p>This uses the <code>hatchling</code> hook system to set the <code>SETUPTOOLS_SCM_PRETEND_VERSION</code> environment variable automatically during the build process, but only if the variable isn't already set and the <code>CI</code> environment variable isn't set, such as when building with GitHub actions.</p>
<p>Of course, feel free to set the default version to something that fits your project.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/10054.html">astral-sh/uv#10054</a> on 2024-12-20 13:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../rst2pdf/rst2pdf/pulls/1256.html">rst2pdf/rst2pdf#1256</a> on 2024-12-24 16:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/10167.html">astral-sh/uv#10167</a> on 2024-12-26 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../googleapis/release-please/issues/2455.html">googleapis/release-please#2455</a> on 2024-12-31 00:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2025-01-08 16:40</div>
            <div class="timeline-body"><p>The solution <a href="https://github.com/astral-sh/uv/issues/7533#issuecomment-2486235749">here</a> is what should be preferred for <code>hatch-vcs</code>, <code>setuptools-scm</code>, etc. Basically, only temporarily set the <code>SETUPTOOLS_SCM_PRETEND_VERSION</code> environment variable when running <code>uv lock</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/10559.html">astral-sh/uv#10559</a> on 2025-01-13 09:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../astropy/astropy/issues/17596.html">astropy/astropy#17596</a> on 2025-01-13 09:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../PlasmaPy/PlasmaPy/issues/2940.html">PlasmaPy/PlasmaPy#2940</a> on 2025-01-14 23:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/10622.html">astral-sh/uv#10622</a> on 2025-01-15 02:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-15 02:38</div>
            <div class="timeline-body"><p>I'm working on omitting dynamic versions from the lockfile: https://github.com/astral-sh/uv/pull/10622</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-01-15 16:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-01-15 16:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../devminds-ch/project-python/pulls/15.html">devminds-ch/project-python#15</a> on 2025-01-15 18:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/namurphy">@namurphy</a> on 2025-01-15 22:01</div>
            <div class="timeline-body"><p>Many thanks for making this change and including it in <code>v0.15.9</code>!  üéâüéÇüíñüéÜü™©üååü•¶</p>
<p>I just recreated <code>uv.lock</code> for a project with a dynamic version, and can confirm that the resulting <code>uv.lock</code> no longer contains the dynamic version for the project.  I deleted the prior <code>uv.lock</code> before running <code>uv lock</code> with <code>v0.15.9</code>, just to be safe.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../urllib3/urllib3/pulls/3550.html">urllib3/urllib3#3550</a> on 2025-01-15 23:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../django-commons/drf-excel/pulls/110.html">django-commons/drf-excel#110</a> on 2025-01-19 13:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/brendan-morin">@brendan-morin</a> on 2025-01-28 21:06</div>
            <div class="timeline-body"><p>Perhaps I am misunderstanding the fix action, using this improperly, or this is a <code>hatch-vcs</code> problem, but are we sure this is working as intended? It seems that the behavior is inconsistent and flip flops depending on the state of uv's locking/my venv. Please let me know if this is better suited for a separate issue thread.</p>
<pre><code>uv --version
uv 0.5.24 (Homebrew 2025-01-23)
</code></pre>
<p>I have a <code>pyproject.toml</code> like this:</p>
<pre><code class="language-pyproject.toml">[project]
dynamic = [&quot;version&quot;]

[build-system]
requires = [&quot;hatchling&quot;, &quot;hatch-vcs&quot;]
build-backend = &quot;hatchling.build&quot;

[tool.hatch.version]
source = &quot;vcs&quot;
</code></pre>
<p>As a caveat, I experienced a huge amount of inconsistency in reproduction (generally almost always ending in a state where the version <em>was</em> included in the <code>uv.lock</code> file), so I am not 100% confident these steps will repro for others. But this is what I used to repro my observed behavior.</p>
<ol>
<li>delete <code>uv.lock</code> + <code>.venv</code></li>
<li>run <code>uv lock</code>. This initially works as expected, no dynamic version in <code>uv.lock</code></li>
<li>run <code>uv sync</code>. Still fine, no dynamic version in <code>uv.lock</code>. But we see the package has been built according to the logs:</li>
</ol>
<pre><code>$ uv sync
Resolved 108 packages in 1ms
   Built mypackage @ file:///...
Prepared 2 packages in 1.55s
Uninstalled 2 packages in 57ms
Installed 2 packages in 9ms
 ...
 ~ mypackage==5.1.29.dev1+gdd9890e.d20250128 (from file:///...)
</code></pre>
<ol start="4">
<li>run <code>uv lock</code> again. Now we see these new logs:</li>
</ol>
<pre><code>$ uv lock
Resolved 108 packages in 30ms
Updated mypackage (dynamic) -&gt; v5.1.29.dev1+gdd9890e.d20250128
</code></pre>
<p>And the dynamic version is present in the lock file:</p>
<pre><code>[[package]]
name = &quot;mypackage&quot;
version = &quot;5.1.29.dev1+gdd9890e.d20250128&quot;
</code></pre>
<ol start="5">
<li>Now no matter how many times I delete uv.lock, venv, run <code>uv lock</code>, or <code>uv sync</code>, the dynamic version remains. There's probably other ways, but if I want to reset the process, I can add this to pyproject.toml and rerun <code>uv lock</code>:</li>
</ol>
<pre><code class="language-pyproject.toml">[tool.hatch.build.hooks.vcs]
version-file = &quot;_version.py&quot; 
</code></pre>
<p>and <code>uv lock</code> yields:</p>
<pre><code>uv lock
Resolved 108 packages in 1m 42s
Updated mypackage v5.1.29.dev1+gdd9890e.d20250128 -&gt; (dynamic)
</code></pre>
<ol start="6">
<li>Repeat the process by running <code>uv sync</code> and <code>uv lock</code> again:</li>
</ol>
<pre><code>$ uv sync            
Resolved 108 packages in 1ms
   Built mypackage @ file:///...
Prepared 1 package in 945ms
Uninstalled 1 package in 0.58ms
Installed 1 package in 1ms
 ~ mypacakge==5.1.29.dev1+gdd9890e.d20250128 (from file:///...)
$ uv lock
Resolved 108 packages in 3.25s
Updated mypackage (dynamic) -&gt; v5.1.29.dev1+gdd9890e.d20250128
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-28 21:13</div>
            <div class="timeline-body"><p>That seems unusual. Are you able to put together a project that I can use to reproduce?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/apollo13">@apollo13</a> on 2025-01-28 21:22</div>
            <div class="timeline-body"><p>I am seeing the same but having a hard time reproducing why this is happening. In my case it is enough to remove <code>uv.lock</code> and run <code>uv lock</code> again. Any debug logs that might have anything helpful?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/apollo13">@apollo13</a> on 2025-01-28 21:29</div>
            <div class="timeline-body"><p>Okay, <code>uv lock -vvv</code> showed stuf like:</p>
<pre><code> uv_distribution::distribution_database::get_or_build_wheel_metadata dist=oversight @ file:///home/florian/dev/projectx/oversight
    0.014659s   0ms DEBUG uv_distribution::source No static `pyproject.toml` available for: oversight @ file:///home/florian/dev/projectx/oversight (PyprojectToml(DynamicField(&quot;version&quot;)))
    0.015007s DEBUG uv_fs Acquired lock for `/home/florian/.cache/uv/sdists-v6/editable/5bff42cdde91dde7`
    0.015906s   1ms DEBUG uv_distribution::source Using cached metadata for: oversight @ file:///home/florian/dev/projectx/oversight
    0.016398s   2ms DEBUG uv_workspace::workspace No workspace root found, using project root
    0.016577s   2ms DEBUG uv_fs Released lock at `/home/florian/.cache/uv/sdists-v6/editable/5bff42cdde91dde7/.lock`
 uv_resolver::resolver::solve 
    0.018200s   0ms DEBUG uv_resolver::resolver Solving with installed Python version: 3.13.1
    0.018216s   0ms DEBUG uv_resolver::resolver Solving with target Python version: &gt;=3.13.0, &lt;3.14
   uv_resolver::resolver::get_dependencies_forking package=root, version=0a0.dev0
     uv_resolver::resolver::get_dependencies package=root, version=0a0.dev0
    0.018550s   0ms DEBUG uv_resolver::resolver Adding direct dependency: oversight[container]*
    0.018629s   0ms DEBUG uv_resolver::resolver Searching for a compatible version of oversight @ file:///home/florian/dev/projectx/oversight (*)
   uv_resolver::resolver::get_dependencies_forking package=oversight[container], version=0.4.1.dev31+ga536f6c.d20250128
     uv_resolver::resolver::get_dependencies package=oversight[container], version=0.4.1.dev31+ga536f6c.d20250128
    0.018700s   0ms DEBUG uv_resolver::resolver Adding direct dependency: oversight==0.4.1.dev31+ga536f6c.d20250128
    0.018724s   0ms DEBUG uv_resolver::resolver Adding direct dependency: oversight[container]==0.4.1.dev31+ga536f6c.d20250128
    0.018761s   0ms DEBUG uv_resolver::resolver Searching for a compatible version of oversight @ file:///home/florian/dev/projectx/oversight (==0.4.1.dev31+ga536f6c.d20250128)
   uv_resolver::resolver::get_dependencies_forking package=oversight, version=0.4.1.dev31+ga536f6c.d20250128
     uv_resolver::resolver::get_dependencies package=oversight, version=0.4.1.dev31+ga536f6c.d20250128
    0.018960s   0ms DEBUG uv_resolver::resolver Adding direct dependency: dj-database-url&gt;=2.2.0
</code></pre>
<p>After running a <code>uv cache clean</code> <code>uv lock</code> no longer seems to write the version into <code>uv.lock</code>.  Now running <code>uv sync</code> and removing <code>uv.lock</code> and rerunning <code>uv lock</code> again writes it back.</p>
<p>So I wonder if this depends on the cache?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nathanjmcdougall">@nathanjmcdougall</a> on 2025-01-28 21:32</div>
            <div class="timeline-body"><p>I'm having a similar issue. To provide another data point, I have a project where:</p>
<ol>
<li>Using the project created pre-v0.15.9 will fail to use remove the version from the lockfile, even when deleting the lockfile and .venv.</li>
<li>A fresh clone and running <code>uv lock</code> will remove the version from the lock file no problem.</li>
</ol>
<p>So a cache issue seems likely to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/neutrinoceros">@neutrinoceros</a> on 2025-01-28 21:36</div>
            <div class="timeline-body"><p>@Brendan-Morin Maybe a bit random but I noticed that your <code>[project]</code> table is lacking a <code>requires-python</code> entry, which seemed to be crucial in my encounter with a similar problem.</p>
<p>xref https://github.com/astral-sh/uv-pre-commit/issues/35</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-28 21:38</div>
            <div class="timeline-body"><p>Is anyone able to upload a project that I can use to reproduce this? I'd love to fix it. I'm happy to fix it tonight.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/apollo13">@apollo13</a> on 2025-01-28 21:43</div>
            <div class="timeline-body"><p>@charliermarsh Use this repo: https://github.com/apollo13/uv-bug</p>
<p>Follow this to the letter (I am not sure if you can repro if you do anything different):</p>
<ul>
<li><code>uv cache clean</code></li>
<li><code>uv lock</code> and observe that <code>git status</code> shows no changes</li>
<li><code>uv sync</code></li>
<li><code>rm -rf uv.lock .venv</code></li>
<li><code>uv lock</code></li>
<li>Run <code>git diff</code> and see the version written into the lock file (shouldn't be)</li>
<li><code>uv cache clean</code></li>
<li><code>rm -rf uv.lock .venv</code></li>
<li><code>uv lock</code> (No version written -&gt; okay)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-28 21:44</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/11047.html">astral-sh/uv#11047</a> on 2025-01-29 01:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-29 01:14</div>
            <div class="timeline-body"><p>Thank you, this was a real bug. Fix here: https://github.com/astral-sh/uv/pull/11046.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/brendan-morin">@brendan-morin</a> on 2025-01-29 01:22</div>
            <div class="timeline-body"><p>Awesome, thank you for the quick repro @apollo13  and @charliermarsh for the quick fix!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../bihealth/cubi-tk/pulls/255.html">bihealth/cubi-tk#255</a> on 2025-02-03 13:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../prefix-dev/pixi/issues/2512.html">prefix-dev/pixi#2512</a> on 2025-04-24 09:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../nathanjmcdougall/postmodern-python-ci/issues/1.html">nathanjmcdougall/postmodern-python-ci#1</a> on 2025-05-08 09:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../prefix-dev/pixi/issues/1274.html">prefix-dev/pixi#1274</a> on 2025-05-28 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/aqib-bhat">@aqib-bhat</a> on 2025-06-15 11:15</div>
            <div class="timeline-body"><p>I was experiencing the <code>uv.lock</code> going out of sync when <code>python-semantic-release</code> would bump the version in <code>pyproject.toml</code>. I fixed this by:</p>
<ul>
<li>Adding a step after the semantic release that updates the version of my project in the <code>uv.lock</code> file by running: <code>uv lock --upgrade-package &lt;project_name&gt;</code> followed by committing and pushing the change.<ul>
<li>Link to my GitHub workflow file: https://github.com/aqib-oss/sonar-qube-gh-action/blob/main/.github/workflows/main-workflow.yaml#L74</li>
<li>Thankfully, this does not trigger another run of the <code>main</code> branch workflow, however, if it did, it can easily be handled by adding a pre-check job that determines if the last commit was for syncing the project version in the <code>uv.lock</code> file, and the main job will run only if the output from the pre-check job is <code>true</code>.</li>
</ul>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/14137.html">astral-sh/uv#14137</a> on 2025-06-20 17:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/aqib-bhat">@aqib-bhat</a> on 2025-06-23 03:51</div>
            <div class="timeline-body"><p>I created an issue in the <code>python-semantic-release</code> repo as well because their uv integration guide only ensures that the project version is synced just before the semantic release action runs in the merge to main workflow. Other than that, for most of the time, the <code>uv.ock</code> file will remain out of sync.
https://github.com/python-semantic-release/python-semantic-release/issues/1280</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-design</span> removed by @konstin on 2025-06-23 09:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> removed by @konstin on 2025-06-23 09:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-06-23 09:49</div>
            <div class="timeline-body"><p>A plain <code>uv lock</code> should get the <code>uv.lock</code> synced with the bumped version. Note that there's also <code>uv version --bump</code>, which does also update <code>uv.lock</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../LEB-EPFL/just-focus/pulls/8.html">LEB-EPFL/just-focus#8</a> on 2025-08-05 08:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:22 UTC
    </footer>
</body>
</html>
