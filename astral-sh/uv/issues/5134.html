<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python conditional marker causing resolution issue where it shouldn't - astral-sh/uv #5134</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Python conditional marker causing resolution issue where it shouldn&#x27;t</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/5134">#5134</a>
        opened by <a href="https://github.com/mkniewallner">@mkniewallner</a>
        on 2024-07-16 21:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mkniewallner">@mkniewallner</a></div>
            <div class="timeline-body"><p>Stumbled upon what I think is a bug in the dependency resolution algorithm.</p>
<p>If a project:</p>
<ul>
<li>requires a minimum Python version (say <code>&gt;= 3.8</code>)</li>
<li>depends on a package that requires a higher minimum Python version than the project (say <code>&gt;= 3.9</code>)</li>
<li>conditionally requires the dependency above to match the minimum Python version of the dependency (say <code>&gt;= 3.9</code>)</li>
</ul>
<p>then dependency resolution fails:</p>
<pre><code>$ uv sync --preview
  × No solution found when resolving dependencies:
  ╰─▶ Because the requested Python version (&gt;=3.8) does not satisfy Python&gt;=3.9 and foo==0.0.1 depends on pre-commit{python_version &gt;= &#x27;3.9&#x27;}==3.7.1, we can conclude that foo==0.0.1 cannot be used.
      And because only foo==0.0.1 is available and you require foo, we can conclude that the requirements are unsatisfiable.
</code></pre>
<p>I would understand why it fails if not setting a condition for the dependency, since it&#x27;s unsolvable, but because of the condition on the Python version, I would expect the resolution to work, as the dependency would simply not be installed on Python 3.8.</p>
Minimal reproducer
<pre><code>[project]
name = &quot;foo&quot;
version = &quot;0.0.1&quot;
requires-python = &quot;&gt;=3.8&quot;
dependencies = [&quot;pre-commit==3.7.1; python_version &gt;= &#x27;3.9&#x27;&quot;]
</code></pre>
<pre><code>$ uv sync --preview --verbose
DEBUG uv 0.2.25
DEBUG Found project root: `/home/mathieu/Workspaces/throwaways/foo`
DEBUG No workspace root found, using project root
DEBUG Searching for Python &gt;=3.8 in managed installations or system path
DEBUG Searching for managed installations at `/home/mathieu/.local/share/uv/python`
DEBUG Found managed Python `cpython-3.12.1-linux-x86_64-gnu`
DEBUG Found cpython 3.12.1 at `/home/mathieu/.local/share/uv/python/cpython-3.12.1-linux-x86_64-gnu/bin/python3` (managed installations)
Using Python 3.12.1 interpreter at: /home/mathieu/.local/share/uv/python/cpython-3.12.1-linux-x86_64-gnu/bin/python3
Creating virtualenv at: .venv
DEBUG Using request timeout of 30s
DEBUG Starting clean resolution.
DEBUG Acquired lock for `/home/mathieu/.cache/uv/built-wheels-v3/editable/74f2787c29c91621`
DEBUG Preparing metadata for: foo @ file:///home/mathieu/Workspaces/throwaways/foo
DEBUG No static `PKG-INFO` available for: foo @ file:///home/mathieu/Workspaces/throwaways/foo (MissingPkgInfo)
DEBUG Found static `pyproject.toml` for: foo @ file:///home/mathieu/Workspaces/throwaways/foo
DEBUG No workspace root found, using project root
DEBUG Solving with installed Python version: 3.12.1
DEBUG Solving with target Python version: &gt;=3.8
DEBUG Adding direct dependency: foo*
DEBUG Searching for a compatible version of foo @ file:///home/mathieu/Workspaces/throwaways/foo (*)
DEBUG Adding transitive dependency for foo==0.0.1: pre-commit{python_version &gt;= &#x27;3.9&#x27;}==3.7.1
DEBUG Found fresh response for: https://pypi.org/simple/pre-commit/
DEBUG Searching for a compatible version of pre-commit{python_version &gt;= &#x27;3.9&#x27;} (==3.7.1)
DEBUG No compatible version found for: Python
DEBUG Searching for a compatible version of foo @ file:///home/mathieu/Workspaces/throwaways/foo (&lt;0.0.1 | &gt;0.0.1)
DEBUG No compatible version found for: foo
  × No solution found when resolving dependencies:
  ╰─▶ Because the requested Python version (&gt;=3.8) does not satisfy Python&gt;=3.9 and foo==0.0.1 depends on pre-commit{python_version &gt;= &#x27;3.9&#x27;}==3.7.1, we can conclude that foo==0.0.1 cannot be used.
      And because only foo==0.0.1 is available and you require foo, we can conclude that the requirements are unsatisfiable.
</code></pre>
<p>You can see the minimum required Python version of the version of <code>pre-commit</code> used in the reproducer <a href="https://github.com/pre-commit/pre-commit/blob/v3.7.1/setup.cfg#L27">here</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-16 21:47</div>
            <div class="timeline-body"><p>Thanks for the clear report! We have a lot of work in-flight in this area, someone should be able to weigh in with some details soon. cc @konstin / @BurntSushi</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">great writeup</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-16 21:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">resolver</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-16 21:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-17 01:18</div>
            <div class="timeline-body"><p>I believe this is the same as <a href="https://github.com/astral-sh/uv/issues/4669">astral-sh/uv#4669</a>. Gonna merge into that issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-17 01:19</div>
            <div class="timeline-body"><p>Or, more specifically, it&#x27;s the same as <a href="https://github.com/astral-sh/uv/issues/4668">astral-sh/uv#4668</a> (which is slightly different).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-17 01:19</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:32:03 UTC
    </footer>
</body>
</html>
