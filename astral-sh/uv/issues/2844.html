<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>re-running &quot;uv pip install -e ...&quot; does not re-invoke the build system on the package - astral-sh/uv #2844</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>re-running &quot;uv pip install -e ...&quot; does not re-invoke the build system on the package</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/2844">#2844</a>
        opened by <a href="https://github.com/mmerickel">@mmerickel</a>
        on 2024-04-05 22:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mmerickel">@mmerickel</a></div>
            <div class="timeline-body"><p>uv version: 0.1.29
platform: macos 14.4.1 (m1 max)</p>
<p>Setup a simple project using the below <code>pyproject.toml</code> and <code>setup.py</code> files. With those created, observe some differences between <code>.venv/bin/pip install -e .</code> and <code>uv pip install -e .</code> in how <code>setup.py</code> is invoked:</p>
example using pip as expected baseline
<pre><code>$ python3 -m venv .venv
$ .venv/bin/pip install -e .
$ cat /tmp/foo
setup.py 1712355322.544586 [&#x27;/Users/michael.merickel/scratch/uv-test/.venv/lib/python3.12/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py&#x27;, &#x27;egg_info&#x27;]
setup.py 1712355323.1131861 [&#x27;/Users/michael.merickel/scratch/uv-test/.venv/lib/python3.12/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py&#x27;, &#x27;dist_info&#x27;, &#x27;--output-dir&#x27;, &#x27;/private/var/folders/0b/gyxh16fx56d7hd_nqbxj1mxc0000gp/T/pip-modern-metadata-g5m4gr57&#x27;, &#x27;--keep-egg-info&#x27;]
setup.py 1712355323.9759429 [&#x27;/Users/michael.merickel/scratch/uv-test/.venv/lib/python3.12/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py&#x27;, &#x27;editable_wheel&#x27;, &#x27;--dist-dir&#x27;, &#x27;/private/var/folders/0b/gyxh16fx56d7hd_nqbxj1mxc0000gp/T/pip-wheel-3imq0g2d/.tmp-b981_kcm&#x27;]
editable_wheel 1712355324.003723
$ .venv/bin/pip install -e .
$ cat /tmp/foo
setup.py 1712355322.544586 [&#x27;/Users/michael.merickel/scratch/uv-test/.venv/lib/python3.12/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py&#x27;, &#x27;egg_info&#x27;]
setup.py 1712355323.1131861 [&#x27;/Users/michael.merickel/scratch/uv-test/.venv/lib/python3.12/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py&#x27;, &#x27;dist_info&#x27;, &#x27;--output-dir&#x27;, &#x27;/private/var/folders/0b/gyxh16fx56d7hd_nqbxj1mxc0000gp/T/pip-modern-metadata-g5m4gr57&#x27;, &#x27;--keep-egg-info&#x27;]
setup.py 1712355323.9759429 [&#x27;/Users/michael.merickel/scratch/uv-test/.venv/lib/python3.12/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py&#x27;, &#x27;editable_wheel&#x27;, &#x27;--dist-dir&#x27;, &#x27;/private/var/folders/0b/gyxh16fx56d7hd_nqbxj1mxc0000gp/T/pip-wheel-3imq0g2d/.tmp-b981_kcm&#x27;]
editable_wheel 1712355324.003723
setup.py 1712355340.953567 [&#x27;/Users/michael.merickel/scratch/uv-test/.venv/lib/python3.12/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py&#x27;, &#x27;egg_info&#x27;]
setup.py 1712355341.528934 [&#x27;/Users/michael.merickel/scratch/uv-test/.venv/lib/python3.12/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py&#x27;, &#x27;dist_info&#x27;, &#x27;--output-dir&#x27;, &#x27;/private/var/folders/0b/gyxh16fx56d7hd_nqbxj1mxc0000gp/T/pip-modern-metadata-ipk6za2b&#x27;, &#x27;--keep-egg-info&#x27;]
setup.py 1712355341.7226088 [&#x27;/Users/michael.merickel/scratch/uv-test/.venv/lib/python3.12/site-packages/pip/_vendor/pyproject_hooks/_in_process/_in_process.py&#x27;, &#x27;editable_wheel&#x27;, &#x27;--dist-dir&#x27;, &#x27;/private/var/folders/0b/gyxh16fx56d7hd_nqbxj1mxc0000gp/T/pip-wheel-_y_0b5q7/.tmp-2qq74dsf&#x27;]
editable_wheel 1712355341.753067
</code></pre>
example using uv as problematic
<pre><code>$ rm -rf myapp.egg-info /tmp/foo .venv
$ uv venv
$ uv pip install -e .
$ cat /tmp/foo
setup.py 1712355432.5460742 [&#x27;-c&#x27;, &#x27;egg_info&#x27;]
setup.py 1712355432.703499 [&#x27;-c&#x27;, &#x27;editable_wheel&#x27;, &#x27;--dist-dir&#x27;, &#x27;/Users/michael.merickel/Library/Caches/uv/.tmp8VJ4yj/.tmpdHFyuf/.tmp-b485ccgd&#x27;]
editable_wheel 1712355432.751647
$ uv pip install -e .
$ cat /tmp/foo
setup.py 1712355432.5460742 [&#x27;-c&#x27;, &#x27;egg_info&#x27;]
setup.py 1712355432.703499 [&#x27;-c&#x27;, &#x27;editable_wheel&#x27;, &#x27;--dist-dir&#x27;, &#x27;/Users/michael.merickel/Library/Caches/uv/.tmp8VJ4yj/.tmpdHFyuf/.tmp-b485ccgd&#x27;]
editable_wheel 1712355432.751647
</code></pre>
Discussion
<p><code>uv pip install</code> is not invoking <code>editable_wheel</code> (or any other commands) if it determines that the package is already installed. It only re-invokes things if I change <code>setup.py</code> or <code>pyproject.toml</code>, but not other files in the project. I have also tested adding a MANIFEST.in and related files, and when I change any of those files the edit is not run.</p>
Why is this a problem?
<p>The issue is we are hooking the commands below to invoke other builds (<code>yarn build</code> to generate webassets for our projects), and if <code>uv</code> does not invoke the install, we have to go into each project and do this, circumventing setuptools as our build system.</p>
<p><code>uv</code> appears to be too aggressive in caching here, it should re-invoke <code>editable_wheel</code> on any editable install every time it is passed to <code>uv pip install -e ...</code>.</p>
Other notes
<p>I tried using <code>uv pip install --refresh -e .</code> and it has no effect on the result.</p>
Repro example files
pyproject.toml
<pre><code>[build-system]
requires = [&quot;setuptools&quot;]
build-backend = &quot;setuptools.build_meta&quot;

[project]
name = &quot;myapp&quot;
version = &quot;0.0.0&quot;
classifiers = [
    &quot;Private :: Do Not Upload&quot;,
]
</code></pre>
setup.py
<pre><code>from setuptools import setup
from setuptools.command.build import build as _BuildCommand
from setuptools.command.develop import develop as _DevelopCommand
from setuptools.command.sdist import sdist as _SDistCommand
from setuptools.command.editable_wheel import editable_wheel as _EditableWheelCommand
import sys
import time


with open(&#x27;/tmp/foo&#x27;, &#x27;a+&#x27;) as fp:
    fp.write(f&#x27;setup.py {time.time()} {sys.argv}\n&#x27;)

class SDistCommand(_SDistCommand):
    def run(self):
        super().run()
        with open(&#x27;/tmp/foo&#x27;, &#x27;a+&#x27;) as fp:
            fp.write(f&#x27;sdist {time.time()}\n&#x27;)


class BuildCommand(_BuildCommand):
    def run(self):
        super().run()
        with open(&#x27;/tmp/foo&#x27;, &#x27;a+&#x27;) as fp:
            fp.write(f&#x27;build {time.time()}\n&#x27;)


class DevelopCommand(_DevelopCommand):
    def run(self):
        super().run()
        with open(&#x27;/tmp/foo&#x27;, &#x27;a+&#x27;) as fp:
            fp.write(f&#x27;develop {time.time()}\n&#x27;)


class EditableWheelCommand(_EditableWheelCommand):
    def run(self):
        super().run()
        with open(&#x27;/tmp/foo&#x27;, &#x27;a+&#x27;) as fp:
            fp.write(f&#x27;editable_wheel {time.time()}\n&#x27;)


setup(
    cmdclass={
        &#x27;sdist&#x27;: SDistCommand,
        &#x27;develop&#x27;: DevelopCommand,
        &#x27;build&#x27;: BuildCommand,
        &#x27;editable_wheel&#x27;: EditableWheelCommand,
    }
)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-05 22:26</div>
            <div class="timeline-body"><p>FWIW you can use <code>--reinstall</code> to force a rebuild.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mmerickel">@mmerickel</a> on 2024-04-05 22:48</div>
            <div class="timeline-body"><p>Yeah missed that option - it does work. Guess I&#x27;ll leave it up to you whether the inconsistency with pip on the caching here is right for <code>uv</code> or not. Thank you for the quick response!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mmerickel">@mmerickel</a> on 2024-04-06 02:12</div>
            <div class="timeline-body"><p>To add to that - editable mode is tricky and I’d prefer / expect uv to rebuild it every time. Keep the current logic for non-editable packages such that reinstall isn’t needed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-07 00:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danielhollas">@danielhollas</a> on 2024-04-09 08:44</div>
            <div class="timeline-body"><blockquote>
<p>To add to that - editable mode is tricky and I’d prefer / expect uv to rebuild it every time. Keep the current logic for non-editable packages such that reinstall isn’t needed.</p>
</blockquote>
<p>I&#x27;d agree. Supposedly, editable installs are used by developers, and the only time time one needs to run <code>uv pip install</code> again on a editable package is when something important changed, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mmerickel">@mmerickel</a> on 2024-04-09 12:58</div>
            <div class="timeline-body"><p>That’s the general idea yeah. It’s intended to be used during local development. There’s nothing in the spec to support optimizing an editable install unfortunately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2024-05-12 06:31</div>
            <div class="timeline-body"><p>Running <code>-e.</code> (or even <code>.</code>) again is a common way to rebuild binary packages, and it&#x27;s a lot less convenient if it doesn&#x27;t actually do anything. I don&#x27;t think local packages should be cached. Local packages tend to have changes without releasing versions (since you are developing on the package).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kdeldycke">@kdeldycke</a> on 2024-07-20 10:14</div>
            <div class="timeline-body"><p>I can confirm the behavior with latest <code>uv</code>:</p>
<pre><code>$ uv --version
uv 0.2.26 (fe403576c 2024-07-17)
</code></pre>
<p>I have <a href="https://github.com/kdeldycke/kevin-deldycke-blog">a blog</a> built with Python-based Pelican and its theme calls <a href="https://github.com/kdeldycke/plumage">Plumage</a>. So when I&#x27;m working on it I&#x27;d like to tweak stuff on my local dev environment in both repositories.</p>
<p>The <a href="https://github.com/kdeldycke/kevin-deldycke-blog/blob/b12e2c4a2bc9fc6219e257dda1bcc4607f498121/pyproject.toml#L28-L53">blog has a <code>pyproject.toml</code></a> which boils down to:</p>
<pre><code>[project]
name = &quot;blog&quot;
dependencies = [
    &quot;pelican [Markdown] ~= 4.9.1&quot;,
    &quot;plumage&quot;,
]

[tool.uv.sources]
plumage = { path = &quot;../plumage&quot; }
</code></pre>
<p>To generate the blog with its local modifications, I call <code>uv run -- pelican</code>. But it never picks the recent changes in <code>../plumage</code>.</p>
<p>The files found in the <code>blog</code>&#x27;s virtualenv in <code>./.venv/lib/python3.12/site-packages/plumage/</code> are not refreshed. And none of the following invocation force its refresh:</p>
<pre><code>$ uv run --refresh-package plumage -- pelican
$ uv run --upgrade -- pelican
$ uv run --upgrade-package plumage -- pelican
$ uv run --no-cache -- pelican
</code></pre>
<p>My only option is to call:</p>
<pre><code>$ uv run --reinstall-package plumage -- pelican
</code></pre>
<p>In which case <code>./.venv/lib/python3.12/site-packages/plumage</code> become a copy of the local package from <code>../plumage</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-20 16:16</div>
            <div class="timeline-body"><p>@kdeldycke that is a different issue, you&#x27;re not using <code>uv pip install --editable</code>. Path dependency sources are not editable by default, you need to include <code>editable = true</code> in the source entry.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kdeldycke">@kdeldycke</a> on 2024-07-23 13:50</div>
            <div class="timeline-body"><blockquote>
<p>@kdeldycke that is a different issue, you&#x27;re not using <code>uv pip install --editable</code>. Path dependency sources are not editable by default, you need to include <code>editable = true</code> in the source entry.</p>
</blockquote>
<p>Oh ok I see.</p>
<p>Still, should we requalify my observation into a separate issue? I mean, isn&#x27;t a path-based local dependency the same as a Git remote branch?</p>
<p>A requirement like <code>plumage @ git+https://github.com/kdeldycke/plumage.git@main</code> gets updated each time I call <code>uv run</code>:</p>
<pre><code>$ uv run -- pelican
warning: `uv run` is experimental and may change without warning
 Updated https://github.com/kdeldycke/plumage.git (eb17482)
(...)
</code></pre>
<p>So I was expecting a local-path dependency to be, semantically, the same kind of moving target as a remote <code>@main</code> branch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-10 01:44</div>
            <div class="timeline-body"><p>We have a new API whereby you can add additional files to consider when invalidating the cache. You can also include the current Git commit (i.e., invalidate whenever the SHA changes).</p>
<p>Looks like this:</p>
<pre><code>[tool.uv]
cache-keys = [{ file = &quot;pyproject.toml&quot; }, { file = &quot;requirements.txt&quot; }, { git = true }]
</code></pre>
<p>See: https://docs.astral.sh/uv/concepts/cache/#dynamic-metadata.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-13 12:56</div>
            <div class="timeline-body"><p>Gonna close in favor of #7282.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-13 12:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:30:45 UTC
    </footer>
</body>
</html>
