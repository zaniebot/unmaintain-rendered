<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>universal locking: allow forking when respecting Python version? - astral-sh/uv #5647</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>universal locking: allow forking when respecting Python version?</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/5647">#5647</a>
        opened by <a href="https://github.com/alex">@alex</a>
        on 2024-07-31 11:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/alex">@alex</a> on 2024-07-31 11:29</div>
            <div class="timeline-body"><pre><code>~ ❯❯❯ uv --version
uv 0.2.30 (Homebrew 2024-07-26)
</code></pre>
<p>Consider this command:</p>
<pre><code>~ ❯❯❯ echo 'nox' | uv pip compile - --universal -p 3.7
warning: The requested Python version 3.7 is not available; 3.12.4 will be used to build dependencies instead.
Resolved 13 packages in 6ms
# This file was autogenerated by uv via the following command:
#    uv pip compile - --universal -p 3.7
argcomplete==3.1.2
    # via nox
colorama==0.4.6 ; sys_platform == 'win32'
    # via colorlog
colorlog==6.8.2
    # via nox
distlib==0.3.8
    # via virtualenv
filelock==3.12.2
    # via virtualenv
importlib-metadata==6.7.0 ; python_version &lt; '3.8'
    # via
    #   argcomplete
    #   nox
    #   virtualenv
nox==2024.4.15
packaging==24.0
    # via nox
platformdirs==4.0.0
    # via virtualenv
tomli==2.0.1 ; python_version &lt; '3.11'
    # via nox
typing-extensions==4.7.1 ; python_version &lt; '3.8'
    # via
    #   importlib-metadata
    #   nox
    #   platformdirs
virtualenv==20.26.3
    # via nox
zipp==3.15.0 ; python_version &lt; '3.8'
    # via importlib-metadata
</code></pre>
<p><code>argcomplete</code> is pinned to version 3.1.2, because this is the newest version that supports Python 3.7. However, there are newer versions (3.4.0) available.</p>
<p>It'd be helpful (though maybe difficult!) if it were possible for <code>--universal</code> to emit &quot;forks&quot; for Python version:</p>
<pre><code>argcomplete==3.1.2; python_version&lt;3.8
argcomplete==3.4.0; python_version&gt;=3.8
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @konstin on 2024-07-31 11:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> removed by @konstin on 2024-07-31 11:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">resolver</span> added by @konstin on 2024-07-31 11:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-07-31 11:46</div>
            <div class="timeline-body"><p>This looks similar to https://github.com/astral-sh/uv/issues/4668.</p>
<p>In general, we try to reduce the number of diverging packages in your resolution (more different behaviors, more versions to audit, large lockfile). If you know that you want to split, you can manually get two distinct resolutions with:</p>
<pre><code>nox; python_version&lt;'3.8'
nox; python_version&gt;='3.8'
</code></pre>
<p>Does nox need to be installed into the project venv? If not, would having it as a separate tool work for you? It's mostly like <code>uvx nox</code> is today: Your project and your <code>.venv</code> can use 3.7, while nox gets installed into a separate hidden venv with python 3.12, except that the nox version is specified in <code>pyproject.toml</code> and locked in <code>uv.lock</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/alex">@alex</a> on 2024-07-31 11:53</div>
            <div class="timeline-body"><p><code>nox</code> was just an example where we see this. That's an interesting note about simply specifying it twice with two different constraints, that makes sense!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-07-31 11:55</div>
            <div class="timeline-body"><p>Do you have other examples where this happens? Having specific problem cases is very helpful for choosing the right defaults in the resolver.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/alex">@alex</a> on 2024-07-31 11:58</div>
            <div class="timeline-body"><p>Sure, <code>echo 'mypy' | uv pip compile - --universal -p 3.7</code> is another example, where <code>typing-extensions</code> is the impacted package.</p>
<p>In general, every dependency in https://github.com/pyca/cryptography/blob/main/ci-constraints-requirements.txt that has a <code>python_version</code> marker is a place where we care about this.</p>
<p>Our overall use case is: We want to pin dependencies in CI for reproducibility. We also want to test against the newest versions (using dependabot). And we want to test on multiple python versions/environments.</p>
<p>Our ideal behavior, therefore, would be a single lockfile that gets us the newest versions for each platform.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/alex">@alex</a> on 2024-08-27 00:09</div>
            <div class="timeline-body"><p>I should have posted this before, but the trick with specifying the root dep 2x to force forking doesn't seem to work:</p>
<pre><code>~ ❯❯❯ echo &quot;nox; python_version&lt;'3.8'
      nox; python_version&gt;='3.8'&quot; | uv pip compile - --universal -p 3.7
warning: The requested Python version 3.7 is not available; 3.12.5 will be used to build dependencies instead.
Resolved 13 packages in 8ms
# This file was autogenerated by uv via the following command:
#    uv pip compile - --universal -p 3.7
argcomplete==3.1.2
    # via nox
colorama==0.4.6 ; sys_platform == 'win32'
    # via colorlog
colorlog==6.8.2
    # via nox
distlib==0.3.8
    # via virtualenv
filelock==3.12.2
    # via virtualenv
importlib-metadata==6.7.0 ; python_full_version &lt; '3.8'
    # via
    #   argcomplete
    #   nox
    #   virtualenv
nox==2024.4.15
packaging==24.0
    # via nox
platformdirs==4.0.0
    # via virtualenv
tomli==2.0.1 ; python_full_version &lt; '3.11'
    # via nox
typing-extensions==4.7.1 ; python_full_version &lt; '3.8'
    # via
    #   importlib-metadata
    #   nox
    #   platformdirs
virtualenv==20.26.3
    # via nox
zipp==3.15.0 ; python_full_version &lt; '3.8'
    # via importlib-metadata
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-27 01:51</div>
            <div class="timeline-body"><p>So, this actually <em>is</em> possible now with a PR I coincidentally merged tonight. It's not yet released though. You can add this to a <code>uv.toml</code> in the working or any parent directory:</p>
<pre><code class="language-toml">environments = [&quot;python_version &gt;= '3.8'&quot;, &quot;python_version &lt; '3.8'&quot;]
</code></pre>
<p>Or you can put it in a <code>pyproject.toml</code>, like:</p>
<pre><code class="language-toml">[tool.uv]
environments = [&quot;python_version &gt;= '3.8'&quot;, &quot;python_version &lt; '3.8'&quot;]
</code></pre>
<p>Then uv will solve those two forks, in order. So you end up with:</p>
<pre><code># This file was autogenerated by uv via the following command:
#    uv pip compile - --universal -p 3.7
argcomplete==3.1.2 ; python_full_version &lt; '3.8'
    # via nox
argcomplete==3.5.0 ; python_full_version &gt;= '3.8'
    # via nox
colorama==0.4.6 ; sys_platform == 'win32'
    # via colorlog
colorlog==6.8.2
    # via nox
distlib==0.3.8
    # via virtualenv
filelock==3.12.2 ; python_full_version &lt; '3.8'
    # via virtualenv
filelock==3.15.4 ; python_full_version &gt;= '3.8'
    # via virtualenv
importlib-metadata==6.7.0 ; python_full_version &lt; '3.8'
    # via
    #   argcomplete
    #   nox
    #   virtualenv
nox==2024.4.15
packaging==24.0 ; python_full_version &lt; '3.8'
    # via nox
packaging==24.1 ; python_full_version &gt;= '3.8'
    # via nox
platformdirs==4.0.0 ; python_full_version &lt; '3.8'
    # via virtualenv
platformdirs==4.2.2 ; python_full_version &gt;= '3.8'
    # via virtualenv
tomli==2.0.1 ; python_full_version &lt; '3.11'
    # via nox
typing-extensions==4.7.1 ; python_full_version &lt; '3.8'
    # via
    #   importlib-metadata
    #   nox
    #   platformdirs
virtualenv==20.26.3
    # via nox
zipp==3.15.0 ; python_full_version &lt; '3.8'
    # via importlib-metadata
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-27 01:53</div>
            <div class="timeline-body"><p>(In general, we prioritize solves in an order that attempts to minimize the number of selected versions. We could actually consider adding different strategies for this... I could imagine a strategy where we attempt to select the most recent version for every fork, rather than trying to minimize the number of versions.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-08-27 01:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/alex">@alex</a> on 2024-08-27 02:06</div>
            <div class="timeline-body"><p>Oooh, I'll play with this in the next release!</p>
<p>FWIW, I think our use case is kind of strange in the world of corporate development, but fairly normal in OSS.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-28 21:10</div>
            <div class="timeline-body"><p>This is fixed in the next release without the need for <code>environments</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-10-28 21:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 04:38:39 UTC
    </footer>
</body>
</html>
