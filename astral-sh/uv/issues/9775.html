<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv tool` does not respect `UV_INDEX_*` for registry authentication when pulling dependencies - astral-sh/uv #9775</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`uv tool` does not respect `UV_INDEX_*` for registry authentication when pulling dependencies</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/9775">#9775</a>
        opened by <a href="https://github.com/ot-goegelem">@ot-goegelem</a>
        on 2024-12-10 14:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/ot-goegelem">@ot-goegelem</a> on 2024-12-10 14:55</div>
            <div class="timeline-body"><ul>
<li>uv version: <code>uv 0.5.6</code></li>
<li>operating system: <code>Debian GNU/Linux 11 (bullseye)</code></li>
</ul>
<p>I have a project where I developed a cli tool and I wanted to install my local package (without pushing it to a remote registry before)</p>
<p>Because I have some private dependencies from a private gitlab registry I added a new index to the <code>pyproject.toml</code>
This is pushed to a repository I did not want to put the credentials in the URL.
Instead I set them via the environment variables:
<code>export UV_INDEX_PRIVATE_GITLAB_USERNAME=__token__</code>
<code>export UV_INDEX_PRIVATE_GITLAB_PASSWORD=&lt;gitlab_token&gt;</code></p>
<p><em>pyproject.toml</em></p>
<pre><code class="language-toml">...
dependencies = [
	...
	&quot;private-dep==version&quot;,
        ...
]

[tool.uv.sources]
private-dep = { index = &quot;private-gitlab&quot; }

[[tool.uv.index]]
name = &quot;private-gitlab&quot;
url = &quot;https://gitlab.com/api/v4/groups/&lt;group_id&gt;/-/packages/pypi/simple&quot;
default = true
...
</code></pre>
<p>In order to install the local cli tool I used this command:
<code>uv tool run --from . &lt;tool_name&gt;</code></p>
<p>I don't want to post the full log of the command, but in the log (with verbose enabled and RUST_LOG=trace) you can see the following:</p>
<pre><code>...
uv_client::cached_client::revalidation_request url=&quot;https://gitlab.com/api/v4/groups/&lt;group_id&gt;/-/packages/pypi/simple/private-dep/&quot;
            0.039609s   0ms TRACE uv_auth::middleware Handling request for https://gitlab.com/api/v4/groups/&lt;group_id&gt;/-/packages/pypi/simple/private-dep/
            0.039635s   0ms TRACE uv_auth::middleware Request for https://gitlab.com/api/v4/groups/&lt;group_id&gt;/-/packages/pypi/simple/private-dep/ is unauthenticated, checking cache
            0.039826s   0ms TRACE uv_auth::cache No credentials in cache for URL https://gitlab.com/api/v4/groups/&lt;group_id&gt;/-/packages/pypi/simple/private-dep/
            0.039925s   0ms TRACE uv_auth::middleware Attempting unauthenticated request for https://gitlab.com/api/v4/groups/&lt;group_id&gt;/-/packages/pypi/simple/private-dep/
            0.040096s   0ms TRACE hyper_util::client::legacy::pool checkout waiting for idle connection: (&quot;https&quot;, gitlab.com)
            0.040292s   0ms DEBUG reqwest::connect starting new connection: https://gitlab.com/
            0.040930s   1ms TRACE hyper_util::client::legacy::connect::http Http::connect; scheme=Some(&quot;https&quot;), host=Some(&quot;gitlab.com&quot;), port=None
...
0.547996s TRACE h2::proto::streams::streams drop_stream_ref; stream=Stream { id: StreamId(1), state: State { inner: Closed(EndStream) }, is_counted: false, ref_count: 2, next_pending_send: None, is_pending_send: false, send_flow: FlowControl { window_size: Window(65535), available: Window(0) }, requested_send_capacity: 0, buffered_send_data: 0, send_task: None, pending_send: Deque { indices: None }, next_pending_send_capacity: None, is_pending_send_capacity: false, send_capacity_inc: false, next_open: None, is_pending_open: false, is_pending_push: false, next_pending_accept: None, is_pending_accept: false, recv_flow: FlowControl { window_size: Window(2097122), available: Window(2097122) }, in_flight_recv_data: 30, next_window_update: None, is_pending_window_update: false, reset_at: None, next_reset_expire: None, pending_recv: Deque { indices: Some(Indices { head: 1, tail: 2 }) }, is_recv: true, recv_task: None, push_task: None, pending_push_promises: Queue { indices: None, _p: PhantomData&lt;h2::proto::streams::stream::NextAccept&gt; }, content_length: Remaining(0) }
    0.548040s TRACE h2::proto::streams::counts transition_after; stream=StreamId(1); state=State { inner: Closed(EndStream) }; is_closed=true; pending_send_empty=true; buffered_send_data=0; num_recv=0; num_send=0
            0.548129s 508ms TRACE uv_auth::middleware Request for https://gitlab.com/api/v4/groups/&lt;group_id&gt;/-/packages/pypi/simple/private-dep/ failed with 401 Unauthorized, checking for credentials
            0.548163s 508ms TRACE uv_auth::cache No credentials in cache for realm https://gitlab.com
            0.548220s 508ms DEBUG uv_auth::middleware No netrc file found
          0.548266s 519ms TRACE h2::proto::streams::streams drop_stream_ref; stream=Stream { id: StreamId(1), state: State { inner: Closed(EndStream) }, is_counted: false, ref_count: 1, next_pending_send: None, is_pending_send: false, send_flow: FlowControl { window_size: Window(65535), available: Window(0) }, requested_send_capacity: 0, buffered_send_data: 0, send_task: None, pending_send: Deque { indices: None }, next_pending_send_capacity: None, is_pending_send_capacity: false, send_capacity_inc: false, next_open: None, is_pending_open: false, is_pending_push: false, next_pending_accept: None, is_pending_accept: false, recv_flow: FlowControl { window_size: Window(2097122), available: Window(2097122) }, in_flight_recv_data: 30, next_window_update: None, is_pending_window_update: false, reset_at: None, next_reset_expire: None, pending_recv: Deque { indices: None }, is_recv: false, recv_task: None, push_task: None, pending_push_promises: Queue { indices: None, _p: PhantomData&lt;h2::proto::streams::stream::NextAccept&gt; }, content_length: Remaining(0) }
          0.548305s 519ms TRACE h2::proto::streams::recv auto-release closed stream (StreamId(1)) capacity: 30
          0.548327s 519ms TRACE h2::proto::streams::recv release_connection_capacity; size=30, connection in_flight_data=30
          0.548346s 519ms TRACE h2::proto::streams::counts transition_after; stream=StreamId(1); state=State { inner: Closed(EndStream) }; is_closed=true; pending_send_empty=true; buffered_send_data=0; num_recv=0; num_send=0
        0.548380s 520ms TRACE uv_client::base_client Attempting to retry error: Error { kind: WrappedReqwestError(Url { scheme: &quot;https&quot;, cannot_be_a_base: false, username: &quot;&quot;, password: None, host: Some(Domain(&quot;gitlab.com&quot;)), port: None, path: &quot;/api/v4/groups/&lt;group_id&gt;/-/packages/pypi/simple/private-dep/&quot;, query: None, fragment: None }, WrappedReqwestError(Reqwest(reqwest::Error { kind: Status(401), url: &quot;https://gitlab.com/api/v4/groups/&lt;group_id&gt;/-/packages/pypi/simple/private-dep/&quot; }))) }
        0.548446s 520ms TRACE uv_client::base_client Cannot retry error: not an IO error (`WrappedReqwestError`)
...
</code></pre>
<h2>Scenarios</h2>
<ul>
<li>running <code>uv run &lt;tool_name&gt;</code> <strong>with environment variables</strong> -&gt; works ðŸŸ¢</li>
<li>running <code>uv tool run --from . &lt;tool_name&gt;</code> <strong>with environment variables</strong> -&gt; does <strong>not</strong> work ðŸ”´</li>
<li>running <code>uv tool install --from . &lt;tool_name&gt;</code> <strong>with environment variables</strong> -&gt; does <strong>not</strong> work ðŸ”´</li>
<li>running <code>uv tool run --from . &lt;tool_name&gt;</code> <strong>with credentials in index url in <code>pyproject.toml</code></strong> -&gt; works ðŸŸ¢</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-10 14:55</div>
            <div class="timeline-body"><p><code>uv tool</code> doesn't look at your <code>pyproject.toml</code>, since it's a global command (but <code>pyproject.toml</code> is scoped to a project).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ot-goegelem">@ot-goegelem</a> on 2024-12-10 15:06</div>
            <div class="timeline-body"><p>But running <code>uv tool run --from . &lt;tool_name&gt;</code> with credentials in index url in <code>pyproject.toml</code> <strong>works</strong></p>
<p>I understand that <code>uv tool</code> normally doesn't look at the <code>pyproject.toml</code>, but when I am doing <code>--from .</code> it should look at my current project and take <code>pyproject.toml</code> into account.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-12-10 15:26</div>
            <div class="timeline-body"><blockquote>
<p>understand that uv tool normally doesn't look at the pyproject.toml, but when I am doing --from . it should look at my current project and take pyproject.toml into account.</p>
</blockquote>
<p>I don't know if I agree. <code>--from .</code> should probably build the package as-if for production â€” I don't think it should even use <code>sources</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/SalttownUser">@SalttownUser</a> on 2024-12-20 18:14</div>
            <div class="timeline-body"><p>I have a similar using the <code>uv publish</code> command. I'm trying to upload a package to a private GitLab package registry and getting check error.</p>
<p>The index url is a GitLab group url combining packages from several projects:</p>
<pre><code>[[tool.uv.index]]
name = &quot;gitlab-private&quot;
url = &quot;https://example.org/api/v4/groups/1/packages/pypi/simple&quot;
default = true
publish-url = &quot;https://example.org/api/v4/projects/2/packages/pypi&quot;
</code></pre>
<p>I did use these environment variable with credentials for url:</p>
<pre><code>UV_INDEX_GITLAB_PRIVATE_PASSWORD
UV_INDEX_GITLAB_PRIVATE_USERNAME
</code></pre>
<p>and</p>
<pre><code>UV_PUBLISH_USERNAME
UV_PUBLISH_PASSWORD
</code></pre>
<p>containing the credentials for publish-url.</p>
<pre><code>uv publish --index gitlab-private -v
DEBUG uv 0.5.11 (c4d0caaee 2024-12-19)
warning: `uv publish` is experimental and may change without warning
DEBUG Publishing with index gitlab-private
DEBUG Not a distribution filename: `.gitignore`
Publishing 6 files https://example.org/api/v4/projects/2/packages/pypi
DEBUG Using request timeout of 900s
DEBUG Checking for my_package-py3-none-any.whl in the registry
DEBUG No cache entry for: https://example.org/api/v4/projects/2/packages/pypi/simple/my_package/
DEBUG No netrc file found
error: Failed to query check URL
  Caused by: Package `my_package` was not found in the registry
</code></pre>
<p>When I add the credentials to the url with <code>url = &quot;https://user:password@example.org/api/v4/groups/1/packages/pypi/simple&quot;</code> everything works.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-07 19:23</div>
            <div class="timeline-body"><p>@SalttownUser please open a separate issue, that looks unrelated to this one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @zanieb on 2025-01-07 19:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/10386.html">astral-sh/uv#10386</a> on 2025-01-08 09:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rbetts">@rbetts</a> on 2025-08-14 15:41</div>
            <div class="timeline-body"><p>I was confused (as a uv novice) that <code>uv pip install</code> finds a package in a private registry that <code>uv tool install</code> does not find. This issue explains clearly why that is. However, I was unable to understand the reason from the error messages or from the index documentation and only understood after finding this issue.</p>
<p>Perhaps https://docs.astral.sh/uv/concepts/tools/#relationship-to-uv-run could gain a section on using <code>uv tool install</code> with a private index?  Or https://docs.astral.sh/uv/concepts/indexes/#-index-url-and-extra-index-url could gain a section describing the (non-)interaction with <code>uv tool</code>?</p>
<p>(It also took me a bit to realize that the <code>[[tool.uv.index]]</code> syntax in pyproject has nothing to do with <code>uv tool</code>... which, in hindsight, is obvious.)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:31:47 UTC
    </footer>
</body>
</html>
