<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explicitly declare extra depenendcy conflicts - astral-sh/uv #10238</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Explicitly declare extra depenendcy conflicts</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/10238">#10238</a>
        opened by <a href="https://github.com/martinitus">@martinitus</a>
        on 2024-12-30 12:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/martinitus">@martinitus</a> on 2024-12-30 12:58</div>
            <div class="timeline-body"><p>Hey  folks,
I have a followup question  / issue to the &quot;conflicting extras / groups&quot; features that were merged the last weeks (e.g. #8976).</p>
<p>I would like to declare conflicting extras - however these dependencies have no <em>inherent</em> conflict in the package or version. Instead they happen to use the same module namespace  - <code>databricks-connect</code> and <code>pyspark</code> both use <code>pyspark</code> as module names.</p>
<p>So my goal is to have a package, for which the user has to explicitly enable either of the two extras, but cannot enable both.</p>
<p>What I tried so far was</p>
<pre><code class="language-toml">
[project.optional-dependencies]
databums = [&quot;databricks-connect&gt;=16.0.0&quot;,]
vanilla = [&quot;pyspark&gt;=3.5.4&quot;,]

[tool.uv]
conflicts = [
    [
        {extra = &quot;databums&quot; },
        {extra = &quot;vanilla&quot; },
    ]
]
</code></pre>
<p>However, when I run <code>uv lock</code> or <code>uv pip install -v -e  .[databums,vanilla]</code> or even just <code>uv pip -e .</code> it happily installs both packages (and screws up the site-package directory afaik).</p>
<p>I presume the current implementation only prevents scenarios where the dependency resolution would have failed due to conflicting optional dependencies. Whereas what I want is explicitly declaring dependencies as conflicting?</p>
<p>Let me know if I missed something and this should actually be possible!</p>
<p>BTW: I also tried it with optional groups, but groups are not exposed to pip (yet, afaik). As I want to be able to install my package with pip on downstream systems, dependency groups seem to not be an option yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/8976.html">astral-sh/uv#8976</a> on 2024-12-30 12:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-30 15:29</div>
            <div class="timeline-body"><p>These conflicts would only be enforced in <code>uv sync</code>, <code>uv run</code>, etc. They aren't currently enforced in the <code>uv pip</code> interface, since that interface doesn't use lockfiles.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2024-12-30 15:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/martinitus">@martinitus</a> on 2025-01-02 09:49</div>
            <div class="timeline-body"><p>I see, just tried that and indeed when using <code>uv sync</code> and <code>uv run</code> I get part of the behavior I am looking for üëçüèº</p>
<p>I guess, then I would turn my question into a feature request to also support this via the pip interface. Poetry finally supports this since https://github.com/python-poetry/poetry/pull/9553 was merged.</p>
<p>For reference, I have a small repo with poetry and uv test case here:</p>
<ul>
<li>poetry: https://github.com/martinitus/databums/tree/main</li>
<li>uv: https://github.com/martinitus/databums/tree/uv</li>
</ul>
<p>It's not a huge deal, but rather an inconvenience, as switching between the two implementations in my experience usually is only necessary during development. However, it would be nice if one has the same user experience both on the developer side (uv sync &amp; co) and the user side (pip install &amp; co).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-06 20:33</div>
            <div class="timeline-body"><p>I don't quite see how we can support this. Your users could be using <em>any</em> installer. I don't think this is enforceable with the existing standards.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/martinitus">@martinitus</a> on 2025-01-07 17:30</div>
            <div class="timeline-body"><p>Well, I have no idea how poetry did it but I'm quite sure it worked. Will double check this week... maybe it only works when installing via pip? What other installers would there be? Conda?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-07 17:46</div>
            <div class="timeline-body"><p>I don't see how it would work by installing via pip? The metadata is in a Poetry-specific section? Perhaps they construct some sort of metadata that does what you're looking for in the installable package ‚Äî but then it'd have to be standards compliant which means it's feasible to do in uv too. Can you share a link to the published package?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-07 17:47</div>
            <div class="timeline-body"><p>It's possible the Poetry build backend enforces these relationships, which would work for <code>pip install -e .</code> and source distributions, I guess? but not installation from a wheel.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/10405.html">astral-sh/uv#10405</a> on 2025-01-08 19:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/martinitus">@martinitus</a> on 2025-03-14 15:16</div>
            <div class="timeline-body"><p>Hey there - sorry for the long delay. I finally came back to testing this - the GIST: You were correct, it seems it is not possible (with poetry) to enforce this as part of a published package! :-)</p>
<p>When installing the package (built with poetry) via
<code>pip install /path/to/package.whl[databums,vanilla]</code>
pip indeed just installs both conflicting dependencies and as a result messes up the environment.</p>
<p>For reference, the <code>METADATA</code> block of the wheel looks as follows:</p>
<pre><code>Metadata-Version: 2.3
Name: spark-databums-conflict
Version: 0.1.0
Summary: Testing optional conflicting dependencies with poetry
Author: Martin Rueckl
Author-email: martin.rueckl@codecentric.de
Requires-Python: &gt;=3.12,&lt;4.0
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.12
Classifier: Programming Language :: Python :: 3.13
Provides-Extra: databums
Provides-Extra: vanilla
Requires-Dist: databricks-connect (==15.3.0) ; extra == &quot;databums&quot; and extra != &quot;vanilla&quot;
Requires-Dist: pyspark (==3.5.3) ; extra == &quot;vanilla&quot; and extra != &quot;databums&quot;
Description-Content-Type: text/markdown

... readme ...
</code></pre>
<p>What is left for me now is to figure out a way to achieve at least the same results with uv, but I think that is already possible with the changes from last year üëçüèº</p>
<p>Thank you for your explanations and a wonderful tool! ‚ù§</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @martinitus on 2025-03-14 15:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-14 15:21</div>
            <div class="timeline-body"><p>Thank you for following up!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:01 UTC
    </footer>
</body>
</html>
