<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add `--extracted` flag to `uv cache prune` to remove unzipped wheels - astral-sh/uv #5282</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add <code>--extracted</code> flag to <code>uv cache prune</code> to remove unzipped wheels</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/5282">#5282</a>
        opened by <a href="https://github.com/Jorricks">@Jorricks</a>
        on 2024-07-22 12:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Jorricks">@Jorricks</a></div>
            <div class="timeline-body"><p>First of all, thank you for the awesome package. It's working blazingly fast and our developers are loving the new speed they have locally.</p>
<p>In our pipelines, the speed has not really improved. The main reason is that pip tools cache is considerably smaller than <em>uv</em>. When we store the <em>uv</em> cache, the Gitlab pipeline is spending much more time on zipping the small files, then it is spending on downloading the files new. The difference is considerable; it's 2 times slower when we use Gitlab caches on the <em>uv</em> cache.</p>
<p>A small app easily generates 16000 small files in <em>uv</em> cache and easily comes to</p>
<pre><code>/builds/my_user/my_repository/.cache/uv: found 16373 matching artifact files and directories 
</code></pre>
<p>This is not only visible in Gitlab, but also in Github as mentioned in this ticket;
https://github.com/actions/setup-python/issues/822#issuecomment-1963717925</p>
<p>Would it maybe be possible to add a flag for CI/CD to concentrate the cache in larger files?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-07-22 12:20</div>
            <div class="timeline-body"><p>The uv cache contains all the wheels we install unpacked (in the <code>archive-v0</code> bucket, linked to <code>wheels-v1</code>), so we can install them quickly by reflinking or hardlinking. Those should be the many small files you're seeing. Does it work better when excluding those directories?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Jorricks">@Jorricks</a> on 2024-07-22 13:20</div>
            <div class="timeline-body"><blockquote>
<p>The uv cache contains all the wheels we install unpacked (in the <code>archive-v0</code> bucket, linked to <code>wheels-v1</code>), so we can install them quickly by reflinking or hardlinking. Those should be the many small files you're seeing. Does it work better when excluding those directories?</p>
</blockquote>
<p>Same package, wildly different result after running <code>rm -rf .cache/uv/archive-v0</code>;</p>
<pre><code>/builds/my_user/my_repository/.cache/uv: found 2675 matching artifact files and directories 
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-22 13:22</div>
            <div class="timeline-body"><p>I think you instead want <code>rm -rf .cache/uv/wheels-v1</code>, and then <code>uv cache prune</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Jorricks">@Jorricks</a> on 2024-07-22 13:32</div>
            <div class="timeline-body"><blockquote>
<p>I think you instead want <code>rm -rf .cache/uv/wheels-v1</code>, and then <code>uv cache prune</code>.</p>
</blockquote>
<p>You seem to be right;</p>
<pre><code>Caused by: failed to read directory `/builds/my_user/my_repository/.cache/uv/archive-v0/3vlR8U66f3qKdzSrxDtyR`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-22 13:34</div>
            <div class="timeline-body"><p>I think we should consider adding some options to <code>uv cache prune</code> to streamline this, since it's not good for users to be manipulating the cache arbitrarily (even though I told you to do it 11 minutes ago here :))</p>
<p>It doesn't make a ton of sense to be storing <code>.cache/uv/wheels-v1</code> in the CI cache, since you're just downloading and unzipping it in future jobs anyway. The only difference being that you're getting it from GitLab rather than PyPI or similar.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-22 13:37</div>
            <div class="timeline-body"><p>If you see improvement with something like <code>rm -rf .cache/uv/wheels-v1</code> and <code>uv cache prune</code>, that would be good to know...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Jorricks">@Jorricks</a> on 2024-07-22 13:45</div>
            <div class="timeline-body"><p>Interestingly enough, when I execute;</p>
<pre><code>- rm -rf ${CI_PROJECT_DIR}/.cache/uv/wheels-v1
- uv cache prune --cache-dir ${CI_PROJECT_DIR}/.cache/uv
[2024-07-22 13:42:08] Pruning cache at: .cache/uv
[2024-07-22 13:42:08] Removed 10794 files (402.5MiB)
</code></pre>
<p>I get</p>
<pre><code>/builds/bigdata/adyen_pyspark/.cache/uv: found 3035 matching artifact files and directories 
</code></pre>
<p>I kinda expected less matching artifact files then when I just ran <code>rm -rf .cache/uv/wheels-v1</code>. Does it make sense it's more?</p>
<p>I'll see if I can do some performance tuning on our Github helpers CPU &amp; Memory. They seem to be capping.
<img src="https://github.com/user-attachments/assets/16bec743-b2de-4e55-9fd0-856bb969579a" alt="image" /></p>
<p>I'll report back afterwards :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-22 13:48</div>
            <div class="timeline-body"><p>I think &quot;more&quot; is correct. With <code>rm -rf .cache/uv/archive-v0</code>, you were likely removing some directories that were symlinked elsewhere in the cache (causing those <code>failed to read directory</code> errors). So you were removing too many entries before.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Jorricks">@Jorricks</a> on 2024-07-22 16:10</div>
            <div class="timeline-body"><p>Although we cleaned quite a bit, the size is still very large:</p>
<pre><code>1.2G	.cache/uv
...
.cache/uv: found 3103 matching artifact files and directories 
</code></pre>
<p>Using the <a href="https://docs.gitlab.com/runner/configuration/feature-flags.html#available-feature-flags">FF_USE_FASTZIP</a> flag in combination with <code>CACHE_COMPRESSION_LEVEL</code> I managed to get quite fast zipping/extracting performance.</p>
<p>We have 200MB/s internet speed for our S3 cache back-end, but still it seems faster to just download the artifacts from our Python repository.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Jorricks">@Jorricks</a> on 2024-07-22 16:14</div>
            <div class="timeline-body"><p>So I listed the 100 largest file in the <code>uv</code> cache.
It seems most of it is coming from one big package; <code>pyspark==3.2.3</code>:</p>
<pre><code>[2024-07-22 16:09:28] $ find .cache/uv -type f -exec du -h {} + | sort -rh | head -n 100
[2024-07-22 16:09:28] 269M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3-py2.py3-none-any.whl
[2024-07-22 16:09:28] 35M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/rocksdbjni-6.20.3.jar
[2024-07-22 16:09:28] 35M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/rocksdbjni-6.20.3.jar
[2024-07-22 16:09:28] 35M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/rocksdbjni-6.20.3.jar
[2024-07-22 16:09:28] 31M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/hadoop-client-runtime-3.3.1.jar
[2024-07-22 16:09:28] 31M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/hadoop-client-runtime-3.3.1.jar
[2024-07-22 16:09:28] 31M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/hadoop-client-runtime-3.3.1.jar
[2024-07-22 16:09:28] 19M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/hadoop-client-api-3.3.1.jar
[2024-07-22 16:09:28] 19M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/hadoop-client-api-3.3.1.jar
[2024-07-22 16:09:28] 19M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/hadoop-client-api-3.3.1.jar
[2024-07-22 16:09:28] 14M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/breeze_2.12-1.2.jar
[2024-07-22 16:09:28] 14M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/breeze_2.12-1.2.jar
[2024-07-22 16:09:28] 14M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/breeze_2.12-1.2.jar
[2024-07-22 16:09:28] 12M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/spark-catalyst_2.12-3.2.3.jar
[2024-07-22 16:09:28] 12M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/spark-catalyst_2.12-3.2.3.jar
[2024-07-22 16:09:28] 12M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/spark-catalyst_2.12-3.2.3.jar
[2024-07-22 16:09:28] 11M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/spark-core_2.12-3.2.3.jar
[2024-07-22 16:09:28] 11M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/scala-compiler-2.12.15.jar
[2024-07-22 16:09:28] 11M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/hive-exec-2.3.9-core.jar
[2024-07-22 16:09:28] 11M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/spark-core_2.12-3.2.3.jar
[2024-07-22 16:09:28] 11M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/scala-compiler-2.12.15.jar
[2024-07-22 16:09:28] 11M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/hive-exec-2.3.9-core.jar
[2024-07-22 16:09:28] 11M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/spark-core_2.12-3.2.3.jar
[2024-07-22 16:09:28] 11M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/scala-compiler-2.12.15.jar
[2024-07-22 16:09:28] 11M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/hive-exec-2.3.9-core.jar
[2024-07-22 16:09:28] 8.0M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/spark-sql_2.12-3.2.3.jar
[2024-07-22 16:09:28] 8.0M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/spark-sql_2.12-3.2.3.jar
[2024-07-22 16:09:28] 8.0M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/spark-sql_2.12-3.2.3.jar
[2024-07-22 16:09:28] 7.9M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/hive-metastore-2.3.9.jar
[2024-07-22 16:09:28] 7.9M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/hive-metastore-2.3.9.jar
[2024-07-22 16:09:28] 7.9M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/hive-metastore-2.3.9.jar
[2024-07-22 16:09:28] 7.1M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/mesos-1.4.0-shaded-protobuf.jar
[2024-07-22 16:09:28] 7.1M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/mesos-1.4.0-shaded-protobuf.jar
[2024-07-22 16:09:28] 7.1M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/mesos-1.4.0-shaded-protobuf.jar
[2024-07-22 16:09:28] 7.0M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/spire_2.12-0.17.0.jar
[2024-07-22 16:09:28] 7.0M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/spire_2.12-0.17.0.jar
[2024-07-22 16:09:28] 7.0M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/spire_2.12-0.17.0.jar
[2024-07-22 16:09:28] 6.5M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/zstd-jni-1.5.0-4.jar
[2024-07-22 16:09:28] 6.5M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/zstd-jni-1.5.0-4.jar
[2024-07-22 16:09:28] 6.5M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/zstd-jni-1.5.0-4.jar
[2024-07-22 16:09:28] 5.9M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/spark-mllib_2.12-3.2.3.jar
[2024-07-22 16:09:28] 5.9M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/spark-mllib_2.12-3.2.3.jar
[2024-07-22 16:09:28] 5.9M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/spark-mllib_2.12-3.2.3.jar
[2024-07-22 16:09:28] 5.2M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/scala-library-2.12.15.jar
[2024-07-22 16:09:28] 5.2M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/scala-library-2.12.15.jar
[2024-07-22 16:09:28] 5.2M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/scala-library-2.12.15.jar
[2024-07-22 16:09:28] 4.4M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/netty-all-4.1.68.Final.jar
[2024-07-22 16:09:28] 4.4M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/netty-all-4.1.68.Final.jar
[2024-07-22 16:09:28] 4.4M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/netty-all-4.1.68.Final.jar
[2024-07-22 16:09:28] 3.6M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/scala-reflect-2.12.15.jar
[2024-07-22 16:09:28] 3.6M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/kubernetes-model-core-5.4.1.jar
[2024-07-22 16:09:28] 3.6M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/scala-reflect-2.12.15.jar
[2024-07-22 16:09:28] 3.6M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/kubernetes-model-core-5.4.1.jar
[2024-07-22 16:09:28] 3.6M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/scala-reflect-2.12.15.jar
[2024-07-22 16:09:28] 3.6M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/kubernetes-model-core-5.4.1.jar
[2024-07-22 16:09:28] 3.3M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/hadoop-shaded-guava-1.1.1.jar
[2024-07-22 16:09:28] 3.3M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/hadoop-shaded-guava-1.1.1.jar
[2024-07-22 16:09:28] 3.3M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/hadoop-shaded-guava-1.1.1.jar
[2024-07-22 16:09:28] 3.2M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/cats-kernel_2.12-2.1.1.jar
[2024-07-22 16:09:28] 3.2M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/cats-kernel_2.12-2.1.1.jar
[2024-07-22 16:09:28] 3.2M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/cats-kernel_2.12-2.1.1.jar
[2024-07-22 16:09:28] 3.1M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/shapeless_2.12-2.3.3.jar
[2024-07-22 16:09:28] 3.1M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/derby-10.14.2.0.jar
[2024-07-22 16:09:28] 3.1M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/shapeless_2.12-2.3.3.jar
[2024-07-22 16:09:28] 3.1M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/derby-10.14.2.0.jar
[2024-07-22 16:09:28] 3.1M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/shapeless_2.12-2.3.3.jar
[2024-07-22 16:09:28] 3.1M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/derby-10.14.2.0.jar
[2024-07-22 16:09:28] 2.4M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/spark-network-common_2.12-3.2.3.jar
[2024-07-22 16:09:28] 2.4M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/curator-client-2.13.0.jar
[2024-07-22 16:09:28] 2.4M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/spark-network-common_2.12-3.2.3.jar
[2024-07-22 16:09:28] 2.4M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/curator-client-2.13.0.jar
[2024-07-22 16:09:28] 2.4M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/spark-network-common_2.12-3.2.3.jar
[2024-07-22 16:09:28] 2.4M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/curator-client-2.13.0.jar
[2024-07-22 16:09:28] 2.1M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/guava-14.0.1.jar
[2024-07-22 16:09:28] 2.1M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/guava-14.0.1.jar
[2024-07-22 16:09:28] 2.1M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/guava-14.0.1.jar
[2024-07-22 16:09:28] 2.0M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/parquet-column-1.12.2.jar
[2024-07-22 16:09:28] 2.0M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/datanucleus-core-4.1.17.jar
[2024-07-22 16:09:28] 2.0M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/commons-math3-3.4.1.jar
[2024-07-22 16:09:28] 2.0M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/parquet-column-1.12.2.jar
[2024-07-22 16:09:28] 2.0M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/datanucleus-core-4.1.17.jar
[2024-07-22 16:09:28] 2.0M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/commons-math3-3.4.1.jar
[2024-07-22 16:09:28] 2.0M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/parquet-column-1.12.2.jar
[2024-07-22 16:09:28] 2.0M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/datanucleus-core-4.1.17.jar
[2024-07-22 16:09:28] 2.0M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/commons-math3-3.4.1.jar
[2024-07-22 16:09:28] 1.9M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/snappy-java-1.1.8.4.jar
[2024-07-22 16:09:28] 1.9M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/datanucleus-rdbms-4.1.19.jar
[2024-07-22 16:09:28] 1.9M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/snappy-java-1.1.8.4.jar
[2024-07-22 16:09:28] 1.9M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/datanucleus-rdbms-4.1.19.jar
[2024-07-22 16:09:28] 1.9M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/snappy-java-1.1.8.4.jar
[2024-07-22 16:09:28] 1.9M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/datanucleus-rdbms-4.1.19.jar
[2024-07-22 16:09:28] 1.8M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/parquet-jackson-1.12.2.jar
[2024-07-22 16:09:28] 1.8M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/parquet-jackson-1.12.2.jar
[2024-07-22 16:09:28] 1.8M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/parquet-jackson-1.12.2.jar
[2024-07-22 16:09:28] 1.7M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/hive-service-rpc-3.1.2.jar
[2024-07-22 16:09:28] 1.7M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/deps/jars/arrow-vector-2.0.0.jar
[2024-07-22 16:09:28] 1.7M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/hive-service-rpc-3.1.2.jar
[2024-07-22 16:09:28] 1.7M	.cache/uv/built-wheels-v3/index/fd2c9579c1c6f924/pyspark/3.2.3/unfW3Zpiflv9HaTeaDE6C/pyspark-3.2.3.tar.gz/build/lib/pyspark/jars/arrow-vector-2.0.0.jar
[2024-07-22 16:09:28] 1.7M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/hive-service-rpc-3.1.2.jar
[2024-07-22 16:09:28] 1.7M	.cache/uv/archive-v0/gekN10oQ_Vp-g2TxEYqsD/pyspark/jars/arrow-vector-2.0.0.jar
</code></pre>
<p>It contains the large Wheel and then it also contains the extracted items. The 90 biggest files are all Jars from this specific wheel. Is there a way to remove these JARs / extracted files?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-22 16:54</div>
            <div class="timeline-body"><p>You could run <code>uv cache clean pyspark</code> to remove the PySpark entries specifically. But you'll then have to rebuild it on every CI job?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Jorricks">@Jorricks</a> on 2024-07-22 17:54</div>
            <div class="timeline-body"><blockquote>
<p>It seems most of it is coming from one big package; <code>pyspark==3.2.3</code>:</p>
</blockquote>
<p>Wow.. It seems that was 858.0MB of the 1.2G, as we have 311MB remaining -&gt; 73% was taken from one package.
While the wheel itself was 269MB.</p>
<pre><code>[2024-07-22 17:49:34] $ uv cache clean pyspark --cache-dir .cache/uv
[2024-07-22 17:49:34] Removed 1474 files for pyspark (858.0MiB)
[2024-07-22 17:49:34] $ du -sh .cache/uv
[2024-07-22 17:49:34] 311M	.cache/uv
</code></pre>
<p>I think <code>uv</code> would really benefit from having an option to cache all the artifacts but not storing the extracted files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-22 17:59</div>
            <div class="timeline-body"><p>Like, store the built wheel, but none of the unzipped archives? We could probably support that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Jorricks">@Jorricks</a> on 2024-07-22 18:10</div>
            <div class="timeline-body"><blockquote>
<p>Like, store the built wheel, but none of the unzipped archives? We could probably support that.</p>
</blockquote>
<p>Exactly that. At that point, caching the <code>uv cache</code> in CI/CD runners would add extra performance. Now it feels that in most cases, you are better off discarding the cache.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-22 18:14</div>
            <div class="timeline-body"><p>It would be easy to support <code>uv cache prune --extracted</code> or something, to delete all the extracted files prior to uploading the cache. Think that's worth trying...?</p>
<p>We <em>could</em> also support unzipping the wheel directly into the virtual environment (rather than to the cache first). That's probably the &quot;right&quot; solution for this use-case, but it's a lot more work. (For pre-built wheels that we download from a registry, we don't even <em>save</em> the wheel itself -- we unzip the extracted files directly to disk.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Jorricks">@Jorricks</a> on 2024-07-22 18:31</div>
            <div class="timeline-body"><blockquote>
<p>It would be easy to support <code>uv cache prune --extracted</code> or something, to delete all the extracted files prior to uploading the cache. Think that's worth trying...?</p>
<p>We <em>could</em> also support unzipping the wheel directly into the virtual environment (rather than to the cache first). That's probably the &quot;right&quot; solution for this use-case, but it's a lot more work. (For pre-built wheels that we download from a registry, we don't even <em>save</em> the wheel itself -- we unzip the extracted files directly to disk.)</p>
</blockquote>
<p>I think the first part would fit my use-case perfectly. At first I was thinking of an environment variable like <code>UV_MINIFY_CACHE</code>, but I think making it a separate action such as <code>uv cache prune --extracted</code> is probably more in line with what is really happening. That is because I am assuming that this directly hurts the performance of the next <code>uv</code> run as well in case it needs to reinstall one of the (earlier) unpacked packages? So if you run multiple <code>uv pip sync</code> operations, where run 1 installs, run 2 uninstalls and run 3 installs it again, you might still want the output of the previous runs around.
Also the cleanup commands are incredibly fast, so there is no problem for me running that üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-22 19:17</div>
            <div class="timeline-body"><p>That should be straightforward to implement. I'll try to find time, but will also mark this as help wanted.</p>
<p>Basically, we want to remove these symlink directories in the <code>Cache::prune</code> method:</p>
<p><img src="https://github.com/user-attachments/assets/61ca2bce-e0a0-4d25-b18d-fd491624e179" alt="Screenshot 2024-07-22 at 3 16 46‚ÄØPM" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "UV cache creating a lot of small files" to "Add `--extracted` flag to `uv cache prune` to remove unzipped wheels" by @charliermarsh on 2024-07-22 19:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @charliermarsh on 2024-07-22 19:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">good first issue</span> added by @charliermarsh on 2024-07-22 19:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @charliermarsh on 2024-07-22 19:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-07-24 01:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-24 01:53</div>
            <div class="timeline-body"><p>Added here: https://github.com/astral-sh/uv/pull/5391</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-07-24 19:34</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:25:42 UTC
    </footer>
</body>
</html>
