```yaml
number: 17143
title: uv.lock keeps the longest hash from the index but only uses sha256 during installation, which causes hash mismatch error
type: issue
state: closed
author: putradimas
labels:
  - bug
assignees: []
created_at: 2025-12-16T13:03:09Z
updated_at: 2025-12-17T16:02:01Z
url: https://github.com/astral-sh/uv/issues/17143
synced_at: 2026-01-10T01:57:37Z
```

# uv.lock keeps the longest hash from the index but only uses sha256 during installation, which causes hash mismatch error

---

_Issue opened by @putradimas on 2025-12-16 13:03_

### Summary

I use a package manager called ProGet that can do on-demand, partial mirroring of PyPI. Essentially, it's a caching proxy.

For each cached package, four hashes are generated and served via the simple json API.

https://proget.local/pypi/pypi/simple/flask returns the following entries:
```json
{
    "filename": "flask-3.1.2-py3-none-any.whl",
    "url": "https://proget.local/pypi/pypi/download/flask/3.1.2/flask-3.1.2-py3-none-any.whl",
    "requires-python": ">=3.9",
    "hashes": {
        "md5": "6d99ed48deab8d1311f6980d4fa670c9",
        "sha1": "2574502178c4fab8df63ebade8c8cfadb86be6c9",
        "sha256": "ca1d8112ec8a6158cc29ea4858963350011b5c846a414cdb7a954aa9e967d03c",
        "sha512": "0f844fd28be701a57e0a3bab39cbd08459a2301c0de2d0fa0b8e03b7590573b8b9fb3d012c5ab767558c29f7fc08bfffcecdeb20b5ffbbc695ad40d6f8a665f8"
    }
},
{
    "filename": "flask-3.1.2.tar.gz",
    "url": "https://proget.local/pypi/pypi/download/flask/3.1.2/flask-3.1.2.tar.gz",
    "requires-python": ">=3.9",
    "yanked": false,
    "hashes": {
        "sha256": "bf656c15c80190ed628ad08cdfd3aaa35beb087855e2f494910aa3774cc4fd87"
    }
}
```

The file `flask-3.1.2.tar.gz` only returns a single hash because the mirroring software has not yet cached it. The file `flask-3.1.2-py3-none-any.whl` has been downloaded, so the mirror cached the file and calculated the hashes.

This is https://pypi.org/simple/flask responses:
```json
{
    ....
    "filename": "flask-3.1.2-py3-none-any.whl",
    "hashes": {
        "sha256": "ca1d8112ec8a6158cc29ea4858963350011b5c846a414cdb7a954aa9e967d03c"
    },
    "requires-python": ">=3.9",
    "url": "https://files.pythonhosted.org/packages/ec/f9/7f9263c5695f4bd0023734af91bedb2ff8209e8de6ead162f35d8dc762fd/flask-3.1.2-py3-none-any.whl",
    "yanked": false
},
{
    ....
    "filename": "flask-3.1.2.tar.gz",
    "hashes": {
        "sha256": "bf656c15c80190ed628ad08cdfd3aaa35beb087855e2f494910aa3774cc4fd87"
    },
    "requires-python": ">=3.9",
    "url": "https://files.pythonhosted.org/packages/dc/6d/cfe3c0fcc5e477df242b98bfe186a4c34357b4847e87ecaef04507332dab/flask-3.1.2.tar.gz",
    "yanked": false
}
```

As you can see, the `sha256` hash is identical.

`uv` seems to prefer keeping the longest hash in the `uv.lock` file.

```toml
[[package]]
name = "flask"
version = "3.1.2"
source = { registry = "https://proget.local/pypi/pypi/simple" }
dependencies = [
    { name = "blinker" },
    { name = "click" },
    { name = "itsdangerous" },
    { name = "jinja2" },
    { name = "markupsafe" },
    { name = "werkzeug" },
]
sdist = { url = "https://proget.local/pypi/pypi/download/flask/3.1.2/flask-3.1.2.tar.gz", hash = "sha256:bf656c15c80190ed628ad08cdfd3aaa35beb087855e2f494910aa3774cc4fd87" }
wheels = [
    { url = "https://proget.local/pypi/pypi/download/flask/3.1.2/flask-3.1.2-py3-none-any.whl", hash = "sha512:0f844fd28be701a57e0a3bab39cbd08459a2301c0de2d0fa0b8e03b7590573b8b9fb3d012c5ab767558c29f7fc08bfffcecdeb20b5ffbbc695ad40d6f8a665f8" },
]
```

But during CI, `UV_FROZEN=true UV_NO_DEV=true uv sync` seems to only compare the sha256 hash, ignoring other algorithms.

```
  × Failed to download `flask==3.1.2`
  ╰─▶ Hash mismatch for `flask==3.1.2`
      Expected:
        sha256:bf656c15c80190ed628ad08cdfd3aaa35beb087855e2f494910aa3774cc4fd87
        sha512:0f844fd28be701a57e0a3bab39cbd08459a2301c0de2d0fa0b8e03b7590573b8b9fb3d012c5ab767558c29f7fc08bfffcecdeb20b5ffbbc695ad40d6f8a665f8
      Computed:
        sha256:ca1d8112ec8a6158cc29ea4858963350011b5c846a414cdb7a954aa9e967d03c
```

### Platform

Ubuntu 24.04 amd64

### Version

uv 0.9.17

### Python version

Python 3.14

---

_Label `bug` added by @putradimas on 2025-12-16 13:03_

---

_Renamed from "uv.lock keeps the highest hash algorithm from index but only uses sha256 during install. causing hash mismatch error" to "uv.lock keeps the longest hash from index but only uses sha256 during install. causing hash mismatch error" by @putradimas on 2025-12-16 13:03_

---

_Renamed from "uv.lock keeps the longest hash from index but only uses sha256 during install. causing hash mismatch error" to "uv.lock keeps the longest hash from the index but only uses sha256 during installation, which causes hash mismatch error" by @putradimas on 2025-12-16 13:04_

---

_Comment by @konstin on 2025-12-16 14:01_

CC @charliermarsh 

---

_Comment by @charliermarsh on 2025-12-16 14:04_

I can take a look.

---

_Assigned to @charliermarsh by @charliermarsh on 2025-12-17 01:42_

---

_Comment by @charliermarsh on 2025-12-17 01:54_

I believe I understand why this is happening (and how to fix it) but it's a bit difficult to test.

---

_Referenced in [astral-sh/uv#17157](../../astral-sh/uv/pulls/17157.md) on 2025-12-17 02:08_

---

_Comment by @charliermarsh on 2025-12-17 02:08_

PR here: https://github.com/astral-sh/uv/pull/17157

---

_Closed by @charliermarsh on 2025-12-17 16:02_

---
