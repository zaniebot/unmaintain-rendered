<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application of config settings when installing package depends on content of uv cache - astral-sh/uv #7028</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Application of config settings when installing package depends on content of uv cache</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/7028">#7028</a>
        opened by <a href="https://github.com/smackesey">@smackesey</a>
        on 2024-09-04 15:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/smackesey">@smackesey</a> on 2024-09-04 15:14</div>
            <div class="timeline-body"><p>We use <code>uv</code> to build the python environments that we run pyright against for our large codebase <a href="https://github.com/dagster-io/dagster">Dagster</a>. Pyright environments do not handle Python import hooks correctly. It is therefore important that all editables installs in the environment use a &quot;legacy&quot; style, where the pth file contains a static path instead of an import hook.</p>
<p>Modern style:</p>
<pre><code>### __editable__.foo-0.1.0.pth

import __editable___foo_0_1_0_finder; __editable___foo_0_1_0_finder.install()
</code></pre>
<p>Legacy style:</p>
<pre><code>### __editable__.foo-0.1.0.pth

/path/to/foo
</code></pre>
<p>The way you force a legacy style when <code>setuptools</code> is used as build backend (which is what our packages use) is to pass <code>editable_mode=compat</code> as a config option. So this should work, and has worked in the past:</p>
<pre><code>uv pip install --config-setting editable_mode=compat -e my_package
</code></pre>
<p>However, it seems like the cache is interfering in this command working properly. If the package has already been installed as editable without <code>editable_mode=compat</code> in one environment, then attempting to install it into a new environment with <code>editable_mode=compat</code> does not work.</p>
<h3>uv version</h3>
<pre><code>uv 0.4.3 (Homebrew 2024-09-02)
</code></pre>
<h3>Repro</h3>
<p>Create a toy package <code>foo</code>:</p>
<pre><code>mkdir foo
mkdir foo/foo
touch foo/__init__.py

cat &gt;foo/pyproject.toml &lt;&lt;EOF
[project]
name = &quot;foo&quot;
version = &quot;0.1.0&quot;
EOF
</code></pre>
<p>Create a venv and install foo as an editable:</p>
<pre><code>uv venv .venv-1
uv pip install --python=.venv-1/bin/python -e foo
cat .venv-1/lib/python3.12/site-packages/__editable__.foo-0.1.0.pth

# =&gt; import __editable___foo_0_1_0_finder; __editable___foo_0_1_0_finder.install()
</code></pre>
<p>Notice the content of the above pth is an import hook. That's expected.</p>
<p>But now create another venv and install foo as an editable using <code>--config-setting editable_mode=compat</code>. This should cause the content of the <code>pth</code> file to be a straight path instead of an import hook:</p>
<pre><code>uv venv .venv-2
uv pip install --python=.venv-2/bin/python --config-setting editable_mode=compat -e foo
cat .venv-2/lib/python3.12/site-packages/__editable__.foo-0.1.0.pth

# =&gt; import __editable___foo_0_1_0_finder; __editable___foo_0_1_0_finder.install()
</code></pre>
<p>It looks like <code>editable_mode=compat</code> was ignored because we still have an import hook. Now repeat the above but with <code>--no-cache</code>:</p>
<pre><code>uv venv .venv-3
uv pip install --python=.venv-3/bin/python --config-setting editable_mode=compat --no-cache -e foo
cat .venv-3/lib/python3.12/site-packages/__editable__.foo-0.1.0.pth

# =&gt; /path/to/foo
</code></pre>
<p>Now it works. So it looks like <code>--config-setting editable_mode=compat</code> is being passed through dependent on whether we are using the uv cache.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-04 23:49</div>
            <div class="timeline-body"><p>Yeah, I think these definitely aren't included in the cache key.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-09-04 23:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cache</span> added by @charliermarsh on 2024-09-04 23:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-05 20:00</div>
            <div class="timeline-body"><p>I think using <code>--reinstall</code> would also work here (or <code>--reinstall-package foo</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/smackesey">@smackesey</a> on 2024-09-06 14:11</div>
            <div class="timeline-body"><blockquote>
<p>I think using --reinstall would also work here (or --reinstall-package foo).</p>
</blockquote>
<p>Thanks, this is working and has enabled a workaround</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-06 15:02</div>
            <div class="timeline-body"><p>üëç I‚Äôm still looking into fixing it as part of some other caching improvements.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-09-06 21:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-09-10 01:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-09-10 01:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 04:47:46 UTC
    </footer>
</body>
</html>
