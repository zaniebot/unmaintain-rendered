<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UV fails to fetch during concurrent downloads - astral-sh/uv #12054</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>UV fails to fetch during concurrent downloads</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/12054">#12054</a>
        opened by <a href="https://github.com/nithish-b">@nithish-b</a>
        on 2025-03-07 18:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/nithish-b">@nithish-b</a> on 2025-03-07 18:18</div>
            <div class="timeline-body"><h3>Question</h3>
<p>We in our project recently upgraded the uv version from <code>0.4.9</code> to <code>0.5.30</code>.
The <code>uv</code> commands which worked with <code>0.4.9</code> started failing and could work only when the the concurrent downloads is limited by setting the variable <code>UV_CONCURRENT_DOWNLOADS</code> to  4.
This reduces the overall performance of <code>uv</code> and sometimes the package installation still fails and the <code>UV_CONCURRENT_DOWNLOADS</code> has to be set to 1.
We are behind a corporate proxy and we have several internally hosted python package index repositories in Artifactory which has to be queried during package installation.</p>
<p>I share here the example command for one package when the default value of <code>UV_CONCURRENT_DOWNLOADS</code> is used and also attached the detailed logs.
I have used the dummy index url just to get an idea what are we actually doing and the number of repositories to be queried to fetch a matching version.</p>
<p>Example Command</p>
<pre><code>uv pip install twine \
--index-url https://pypi.org/simple \
--extra-index-url https://artifactory.com/artifactory/api/pypi/pypi-local-2/simple \
--extra-index-url https://artifactory.com/artifactory/api/pypi/pypi-local-3/simple \
--extra-index-url https://artifactory.com/artifactory/api/pypi/pypi-local-4/simple \
--extra-index-url https://artifactory.com/artifactory/api/pypi/pypi-local-5/simple \
--extra-index-url https://artifactory.com/artifactory/api/pypi/pypi-local-6/simple \
--extra-index-url https://artifactory.com/artifactory/api/pypi/pypi-local-7/simple \
--extra-index-url https://artifactory.com/artifactory/api/pypi/pypi-local-8/simple \
--extra-index-url https://artifactory.com/artifactory/api/pypi/pypi-local-9/simple \
--extra-index-url https://artifactory.com/artifactory/api/pypi/pypi-local-10/simple \
--extra-index-url https://artifactory.com/artifactory/api/pypi/pypi-local-11/simple \
--extra-index-url https://artifactory.com/artifactory/api/pypi/pypi-local-12/simple \
--extra-index-url https://artifactory.com/artifactory/api/pypi/pypi-local-13/simple \
--index-strategy unsafe-best-match -vv
</code></pre>
<p>Error</p>
<pre><code>error: Failed to fetch: `https://artifactory.com/artifactory/api/pypi/pypi-local-8/simple/jaraco-functools/`
  Caused by: error sending request for url (https://artifactory.com/artifactory/api/pypi/pypi-local-8/simple/jaraco-functools/)
  Caused by: client error (SendRequest)
  Caused by: connection error
  Caused by: stream closed because of a broken pipe
</code></pre>
<p>The error differs for every run here the error is throw failing to fetch <code>jaraco-functools</code> but this can be a different package in next run.</p>
<p>PS: We have several internally hosted python repositories in Artifactory and we install around 300 packages in our docker container.
We use the commands <code>uv pip compile</code> to generate requirements.txt, <code>uv sync</code> to update the uv cache and <code>uv pip install</code> for dependency package installation while running <code>nox</code> build.
Also important to note that the package from internet can also be installed.</p>
<p><a href="https://github.com/user-attachments/files/19131503/uv_verbose.log">uv_verbose.log</a></p>
<h3>Platform</h3>
<p>Linux 5.4.0-204-generic x86_64 GNU/Linux</p>
<h3>Version</h3>
<p>uv 0.5.30</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @nithish-b on 2025-03-07 18:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-07 18:39</div>
            <div class="timeline-body"><p>Hmm, I'm not really sure what to do here -- it seems like it's a problem with your server, not with the client?</p>
<p>I guess we should verify that the requests are being retried, though that's more a bandaid than anything else. Do you see evidence that the requests are being retried, if you look at the <code>-v</code> logs?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-07 18:43</div>
            <div class="timeline-body"><p>Have you tried contacting JFrog about it? Does it work differently when you're not behind your proxy? Are there proxy logs that show errors?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-07 18:45</div>
            <div class="timeline-body"><p>Also, if you run with <code>-v</code> and <code>UV_CONCURRENT_DOWNLOADS=4</code>, can you verify that we're only making four requests at a time?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nithish-b">@nithish-b</a> on 2025-03-09 00:37</div>
            <div class="timeline-body"><blockquote>
<p>Also, if you run with <code>-v</code> and <code>UV_CONCURRENT_DOWNLOADS=4</code>, can you verify that we're only making four requests at a time?</p>
</blockquote>
<p>From the logs I could check that the retry is being done, but couldn't confirm how many requests are being made at a time. Is there any way to capture this information? I tried all possible options but not able to pin point the requests done at a time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nithish-b">@nithish-b</a> on 2025-03-09 01:12</div>
            <div class="timeline-body"><p>With <code>RUST_LOG=uv=trace</code> I observed the following difference in fetching the package metadata. I am not sure if this means anything.</p>
<p>Here there is no multiple requests and the package download was successful</p>
<details>
 <summary>UV_CONCURRENT_DOWNLOADS=4</summary>
TRACE Fetching metadata for rich from https://artifactory.com/artifactory/api/pypi/pypi-local-12/simple/rich/

<p>TRACE Cached request https://artifactory.com/artifactory/api/pypi/pypi-local-12/simple/rich/ is storable because its response has an 'max-age' cache-control directive
TRACE Freshness lifetime found via cache-control max age setting: 60s
DEBUG Found fresh response for: https://artifactory.com/artifactory/api/pypi/pypi-local-12/simple/rich/</p>
</details>

<p>Here there is an error: unsupported status code 304</p>
<details>
 <summary>UV_CONCURRENT_DOWNLOADS=50</summary>
TRACE Request for https://artifactory.com/artifactory/api/pypi/pypi-local-12/simple/rich/ failed with 401 Unauthorized, checking for credentials

<p>TRACE Found cached credentials for realm https://artifactory.com
TRACE Retrying request for https://artifactory.com/artifactory/api/pypi/pypi-local-12/simple/rich/ with credentials from cache Credentials { username: Username(Some(&quot;xxxxx&quot;)), password: Some(&quot;xxxxxxxxxxxxxxxxxx&quot;) }
DEBUG Found modified response for: https://artifactory.com/artifactory/api/pypi/pypi-local-12/simple/rich/
<strong><em>TRACE Cached request https://artifactory.com/artifactory/api/pypi/pypi-local-12/simple/rich/ is not storable because its response has unsupported status code 304</em></strong>
<strong><em>WARN Server returned unusable 304 for:</em></strong> https://artifactory.com/artifactory/api/pypi/pypi-local-12/simple/rich/
TRACE Sending fresh GET request for https://artifactory.com/artifactory/api/pypi/pypi-local-12/simple/rich/
TRACE Handling request for https://artifactory.com/artifactory/api/pypi/pypi-local-12/simple/rich/
TRACE Request for https://artifactory.com/artifactory/api/pypi/pypi-local-12/simple/rich/ is unauthenticated, checking cache
TRACE No credentials in cache for URL https://artifactory.com/artifactory/api/pypi/pypi-local-12/simple/rich/
TRACE Attempting unauthenticated request for https://artifactory.com/artifactory/api/pypi/pypi-local-12/simple/rich/
TRACE Considering retry of error: Reqwest(reqwest::Error { kind: Request, url: &quot;https://artifactory.com/artifactory/api/pypi/pypi-local-12/simple/rich/&quot;, source: hyper_util::client::legacy::Error(SendRequest, hyper::Error(Io, Custom { kind: BrokenPipe, error: &quot;stream closed because of a broken pipe&quot; })) })
TRACE Cannot retry error: not one of <code>ConnectionReset</code> or <code>UnexpectedEof</code>
TRACE Considering retry of error: Error { kind: WrappedReqwestError(Url { scheme: &quot;https&quot;, cannot_be_a_base: false, username: &quot;&quot;, password: None, host: Some(Domain(&quot;artifactory.com&quot;)), port: None, path: &quot;/artifactory/api/pypi/pypi-local-12/simple/rich/&quot;, query: None, fragment: None }, WrappedReqwestError(Middleware(error sending request for url (https://artifactory.com/artifactory/api/pypi/pypi-local-12/simple/rich/)</p>
<p>Caused by:
0: client error (SendRequest)
1: connection error
2: stream closed because of a broken pipe))) }
TRACE Cannot retry error: not one of <code>ConnectionReset</code> or <code>UnexpectedEof</code>
DEBUG Released lock at <code>/.venv/.lock</code>
error: Failed to fetch: <code>https://artifactory.com/artifactory/api/pypi/pypi-local-12/simple/rich/</code>
Caused by: error sending request for url (https://artifactory.com/artifactory/api/pypi/pypi-local-12/simple/rich/)
Caused by: client error (SendRequest)
Caused by: connection error
Caused by: stream closed because of a broken pipe</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nithish-b">@nithish-b</a> on 2025-03-10 10:29</div>
            <div class="timeline-body"><p>Also please note that I can still run the uv pip installation successfully with the exact number of index urls as mentioned above on the same environment with the uv version <code>0.4.9</code> and the command fails with <code>0.5.0</code> and higher. The major difference in these versions is the way uv is installed, earlier it used <code>CARGO_HOME</code> and now it uses <code>~/.local/bin</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nithish-b">@nithish-b</a> on 2025-03-10 15:05</div>
            <div class="timeline-body"><blockquote>
<p>Have you tried contacting JFrog about it? Does it work differently when you're not behind your proxy? Are there proxy logs that show errors?</p>
</blockquote>
<p>@zanieb  We have the same behavior while running the uv installation commands in the Azure cloud (which is outside proxy). So I believe this behavior is seen with or without proxy.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-07-18 07:20</div>
            <div class="timeline-body"><p>We're now also retrying broken pipe errors.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-07-18 07:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">network</span> added by @konstin on 2025-09-18 07:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 03:26:33 UTC
    </footer>
</body>
</html>
