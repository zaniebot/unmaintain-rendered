<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv add workspace fails misteriously from git but not locally - astral-sh/uv #8887</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv add workspace fails misteriously from git but not locally</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/8887">#8887</a>
        opened by <a href="https://github.com/PhilipVinc">@PhilipVinc</a>
        on 2024-11-07 14:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/PhilipVinc">@PhilipVinc</a></div>
            <div class="timeline-body"><p>I tried to add as a dependency to a project a workspace that is found on git by doing</p>
<pre><code class="language-python">uv init
uv add git+https://github.com/NeuralQXLab/omnia  --no-sync
</code></pre>
<p>this fails with the error</p>
<pre><code class="language-bash">❯ uv add git+https://github.com/NeuralQXLab/omnia  --no-sync
 Updated https://github.com/NeuralQXLab/omnia (5d97a5b)
error: Requirements contain conflicting URLs for package `netket` in split `python_full_version == '3.12.*'`:
- file:///Users/filippo.vicentini/.cache/uv/git-v0/checkouts/75e22c3618b1966a/5d97a5b/external/netket
- file:///Users/filippo.vicentini/.cache/uv/git-v0/checkouts/75e22c3618b1966a/5d97a5b/external/netket
</code></pre>
<p>Instead, if I do the same but from a cloned version of the workspace, it just works</p>
<pre><code class="language-python">uv init
git clone https://github.com/NeuralQXLab/omnia
uv add ./omnia
</code></pre>
<p>While the workspace is private, the structure is something that looks like</p>
<pre><code># omnia/pyproject.toml
[project]
name = &quot;omnia&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = [
    &quot;ipykernel&gt;=6.29.5&quot;,
    &quot;netket&quot;,
    &quot;netket_pro&quot;,
    &quot;netket_checkpoint&quot;,
    &quot;deepnets&quot;,
]

[tool.uv]
dev-dependencies = [
    &quot;networkx&gt;=3.4.2&quot;,
    &quot;pytest-xdist&gt;=3.6.1&quot;,
    &quot;pytest&gt;=8.3.3&quot;,
]

[tool.uv.sources]
netket = { workspace = true }
netket_pro = { workspace = true }
netket_checkpoint = { workspace = true }
deepnets = { workspace = true }

[tool.uv.workspace]
members = [&quot;packages/*&quot;, &quot;utils/*&quot;, &quot;external/netket&quot;]
exclude = [&quot;utils/jax-rocm-autoinstall&quot;]
</code></pre>
<p>However the error is not very telling, and I do not understand what I can do to fix it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-07 14:07</div>
            <div class="timeline-body"><p>Are you on a fairly recent version of uv? \cc @konstin</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-07 14:08</div>
            <div class="timeline-body"><p>Separately @konstin any idea how we're getting that specific error when the URLs <em>are</em> the same...?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "uv add git+....workspace " to "uv add workspace fails misteriously from git but not locally" by @PhilipVinc on 2024-11-07 14:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/PhilipVinc">@PhilipVinc</a> on 2024-11-07 14:23</div>
            <div class="timeline-body"><p>❯ uv --version
uv 0.4.30 (61ed2a236 2024-11-04)</p>
<p>Here is the gist of the error when running in verbose mode.
https://gist.github.com/PhilipVinc/b6929ae0d315a90cd08df864bc839e83</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/PhilipVinc">@PhilipVinc</a> on 2024-11-07 14:32</div>
            <div class="timeline-body"><p>@charliermarsh I cleaned up the workspace to publish it.
You can run the following to reproduce</p>
<pre><code class="language-python">mkdir test
cd test
uv init
uv add git+https://github.com/PhilipVinc/uvtest
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @konstin on 2024-11-07 14:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2024-11-08 05:50</div>
            <div class="timeline-body"><p>It looks like while the <code>VerbatimUrl</code>s are the same, the <code>ParsedUrl</code>s differ. In particular, the fork has an existing url that's a <code>ParsedUrl::Git</code> and we're trying to replace it with a <code>ParsedUrl::Directory</code> (see below). I'm guessing the former is because the <code>add</code> command is given a git url and then <code>tool.uv.sources</code> gives us a relative URL for <code>netket</code> on top of that. I'm unfamiliar with this part of the code and thus as of yet unsure where the <code>Directory</code> url is coming from. For reference, <a href="https://github.com/astral-sh/uv/blob/0db38844d976d61c44bb00a38aaa0f8c9497675d/crates/uv-resolver/src/fork_urls.rs#L36">here</a>'s the check that's failing.</p>
<pre><code>URL 1: VerbatimParsedUrl { parsed_url: Git(ParsedGitUrl { url: GitUrl { repository: Url { scheme: &quot;https&quot;, cannot_be_a_base: false, username: &quot;&quot;, password: None, host: Some(Domain(&quot;github.com&quot;)), port: None, path: &quot;/PhilipVinc/uvtest&quot;, query: None, fragment: None }, reference: DefaultBranch, precise: None }, subdirectory: Some(&quot;external/netket&quot;) }), verbatim: VerbatimUrl { url: Url { scheme: &quot;file&quot;, cannot_be_a_base: false, username: &quot;&quot;, password: None, host: None, port: None, path: &quot;/home/ericmarkmartin/.cache/uv/git-v0/checkouts/e76e56b4d32bffcc/dab673b/external/netket&quot;, query: None, fragment: None }, given: None } }
URL 2: VerbatimParsedUrl { parsed_url: Directory(ParsedDirectoryUrl { url: Url { scheme: &quot;file&quot;, cannot_be_a_base: false, username: &quot;&quot;, password: None, host: None, port: None, path: &quot;/home/ericmarkmartin/.cache/uv/git-v0/checkouts/e76e56b4d32bffcc/dab673b/external/netket&quot;, query: None, fragment: None }, install_path: &quot;/home/ericmarkmartin/.cache/uv/git-v0/checkouts/e76e56b4d32bffcc/dab673b/external/netket&quot;, editable: true, virtual: false }), verbatim: VerbatimUrl { url: Url { scheme: &quot;file&quot;, cannot_be_a_base: false, username: &quot;&quot;, password: None, host: None, port: None, path: &quot;/home/ericmarkmartin/.cache/uv/git-v0/checkouts/e76e56b4d32bffcc/dab673b/external/netket&quot;, query: None, fragment: None }, given: None } }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-11-08 09:14</div>
            <div class="timeline-body"><p>For a git dependency that is a workspace, we first clone the repository to the cache dir, then do workspace discovery inside the cache directory. That means if you depend on A in a git repo and A depends on B in that same git repo, we get B as a directory. If you also depend on B from that git repo, we get the conflict. I had hoped to have fixed that in https://github.com/astral-sh/uv/pull/8665 by rewriting the directory back to a git URL, but apparently this branch is still wrong.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @konstin on 2024-11-08 09:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2024-11-10 19:58</div>
            <div class="timeline-body"><p>I could maybe take a swing at this but could use some pointers on where to look for things</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-11-11 14:16</div>
            <div class="timeline-body"><p>The workspace section of <code>lowering.rs</code> as well as the workspace discovery in <code>workspace.rs</code> are probably the best starting points, esp. https://github.com/astral-sh/uv/pull/8665/files#diff-56eaccbf913b25ab6ebc621027c1e8e66017e9c353001cf69c16a235e5323072R224-R241. My hunch is this is similar to #8665 overall.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/PhilipVinc">@PhilipVinc</a> on 2024-11-20 23:26</div>
            <div class="timeline-body"><p>@konstin I'm not very familiar with rust, but I think that the condition you linked to above is correct.
The problem is that <a href="https://github.com/astral-sh/uv/blob/c62c83c37ada63eae4efb77551e2ec7a0f0113d8/crates/uv-distribution/src/metadata/lowering.rs#L269"><code>let source = if let Some(git_member) </code></a> tests False because <a href="https://github.com/astral-sh/uv/blob/c62c83c37ada63eae4efb77551e2ec7a0f0113d8/crates/uv-distribution/src/metadata/lowering.rs#L49"><code>LoweredRequirement::from_requirement(</code></a> is called with a <code>git_member</code> that is None in <a href="https://github.com/astral-sh/uv/blob/c62c83c37ada63eae4efb77551e2ec7a0f0113d8/crates/uv-distribution/src/metadata/requires_dist.rs#L176">requires_dist</a>.</p>
<p>I'm unsure how to proceed from here, however..</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/PhilipVinc">@PhilipVinc</a> on 2024-11-20 23:59</div>
            <div class="timeline-body"><p>Ok, some more debugging lead me to the conclusion that:</p>
<ul>
<li>the first time that uv calls <a href="https://github.com/astral-sh/uv/blob/c62c83c37ada63eae4efb77551e2ec7a0f0113d8/crates/uv-distribution/src/source/mod.rs#L1324"><code>git_metadata</code></a> the check <a href="https://github.com/astral-sh/uv/blob/c62c83c37ada63eae4efb77551e2ec7a0f0113d8/crates/uv-distribution/src/source/mod.rs#L1363"><code>if Some(metadata)</code></a> passes, so the <a href="https://github.com/astral-sh/uv/blob/c62c83c37ada63eae4efb77551e2ec7a0f0113d8/crates/uv-distribution/src/source/mod.rs#L1366"><code>git_member</code></a> gets constructed correctly.</li>
<li>When parsing the dependencies of the sub package, and getting the git metadata the condition above fails so we end up <a href="https://github.com/astral-sh/uv/blob/c62c83c37ada63eae4efb77551e2ec7a0f0113d8/crates/uv-distribution/src/source/mod.rs#L1399">hitting the cache here</a> where the git repository is not built.</li>
</ul>
<p>By changing those lines to</p>
<pre><code class="language-rust">            if let Some(metadata) = read_cached_metadata(&amp;metadata_entry).await? {
                let path = if let Some(subdirectory) = resource.subdirectory {
                    Cow::Owned(fetch.path().join(subdirectory))
                } else {
                    Cow::Borrowed(fetch.path())
                };
                let git_member = GitWorkspaceMember {
                    fetch_root: fetch.path(),
                    git_source: resource,
                };
                    return Ok(ArchiveMetadata::from(
                    Metadata::from_workspace(
                        metadata,
                        &amp;path,
                        Some(&amp;git_member),
                        self.build_context.locations(),
                        self.build_context.sources(),
                        self.build_context.bounds(),
                    )
</code></pre>
<p>my ignorant test case (<code>cargo run run --with git+https://github.com/PhilipVinc/uvtest python</code>) does not fail for the same reason as my bug report.
However I suspect that this change breaks ùv` but maybe this is enough for you to understand where the problem is coming from?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/PhilipVinc">@PhilipVinc</a> on 2024-11-21 00:47</div>
            <div class="timeline-body"><p>Ah!</p>
<p>I think I understand.</p>
<blockquote>
<p>For a git dependency that is a workspace, we first clone the repository to the cache dir, then do workspace discovery inside the cache directory. That means if you depend on A in a git repo and A depends on B in that same git repo, we get B as a directory. If you also depend on B from that git repo, we get the conflict. I had hoped to have fixed that in https://github.com/astral-sh/uv/pull/8665 by rewriting the directory back to a git URL, but apparently this branch is still wrong.</p>
</blockquote>
<p>The error stems when any among repository A or B have a dynamic <code>pyproject.toml</code> file.
The logic is too hard for me to follow, but I believe that if they have a dynamic pyproject file uv does not reuse the git workspace information...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2024-11-23 03:33</div>
            <div class="timeline-body"><blockquote>
<p>However I suspect that this change breaks ùv`</p>
</blockquote>
<p>Was looking at this again, I don't see any immediate problems with this, and doesn't seem to cause any issues with the test suite (I do have 3 failing tests locally but 2 are due to rate limiting and the last one fails even without the change, so I'm assuming it's irrelevant).</p>
<p>@konstin wdyt?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-23 03:46</div>
            <div class="timeline-body"><p>I'd be happy to review a PR (or at least, it'd probably be easier for me to comment on the changes as a diff since there's a lot of context here).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2024-11-23 16:53</div>
            <div class="timeline-body"><p>Threw something up at #9388. If you think the PR makes sense I can get into writing some tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-11-26 21:08</div>
            <div class="timeline-body"><p>The PR code makes sense to me</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-12-03 05:07</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:28:11 UTC
    </footer>
</body>
</html>
