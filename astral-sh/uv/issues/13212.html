<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`version::self_version_json` and `version::version_get_fallback_unmanaged_json` test failures (outside git checkout?) - astral-sh/uv #13212</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`version::self_version_json` and `version::version_get_fallback_unmanaged_json` test failures (outside git checkout?)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/13212">#13212</a>
        opened by <a href="https://github.com/mgorny">@mgorny</a>
        on 2025-04-30 04:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/mgorny">@mgorny</a> on 2025-04-30 04:19</div>
            <div class="timeline-body"><h3>Summary</h3>
<pre><code>failures:

---- version::self_version_json stdout ----

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Unfiltered output ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
----- stdout -----
{
  &quot;package_name&quot;: &quot;uv&quot;,
  &quot;version&quot;: &quot;0.7.0&quot;,
  &quot;commit_info&quot;: null
}

----- stderr -----

────────────────────────────────────────────────────────────────────────────────

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot: self_version_json
Source: crates/uv/tests/it/version.rs:1178
────────────────────────────────────────────────────────────────────────────────
Expression: snapshot
────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬───────────────────────────────────────────────────────────────────
    2     2 │ ----- stdout -----
    3     3 │ {
    4     4 │   &quot;package_name&quot;: &quot;uv&quot;,
    5     5 │   &quot;version&quot;: &quot;[VERSION]&quot;,
    6       │-  &quot;commit_info&quot;: {
    7       │-    &quot;short_commit_hash&quot;: &quot;[LONGHASH]&quot;,
    8       │-    &quot;commit_hash&quot;: &quot;[LONGHASH]&quot;,
    9       │-    &quot;commit_date&quot;: &quot;[DATE]&quot;,
   10       │-    &quot;last_tag&quot;: &quot;[TAG]&quot;,
   11       │-    &quot;commits_since_last_tag&quot;: [COUNT]
   12       │-  }
          6 │+  &quot;commit_info&quot;: null
   13     7 │ }
   14     8 │ 
   15     9 │ ----- stderr -----
────────────┴───────────────────────────────────────────────────────────────────
To update snapshots run `cargo insta review`
Stopped on the first failure. Run `cargo insta test` to run all snapshots.

thread 'version::self_version_json' panicked at /var/tmp/portage/dev-python/uv-0.7.0/work/cargo_home/gentoo/insta-1.43.0/src/runtime.rs
:679:13:
snapshot assertion for 'self_version_json' failed in line 1178
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace

---- version::version_get_fallback_unmanaged_json stdout ----

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Unfiltered output ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
----- stdout -----
{
  &quot;package_name&quot;: &quot;uv&quot;,
  &quot;version&quot;: &quot;0.7.0&quot;,
  &quot;commit_info&quot;: null
}

----- stderr -----
warning: Failed to read project metadata (The project is marked as unmanaged: `/var/tmp/portage/dev-python/uv-0.7.0/homedir/.local/shar
e/uv/tests/.tmpApoa5j/temp`). Running `uv self version` for compatibility. This fallback will be removed in the future; pass `--preview
` to force an error.

────────────────────────────────────────────────────────────────────────────────

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot: version_get_fallback_unmanaged_json
Source: crates/uv/tests/it/version.rs:947
────────────────────────────────────────────────────────────────────────────────
Expression: snapshot
────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬───────────────────────────────────────────────────────────────────
    2     2 │ ----- stdout -----
    3     3 │ {
    4     4 │   &quot;package_name&quot;: &quot;uv&quot;,
    5     5 │   &quot;version&quot;: &quot;[VERSION]&quot;,
    6       │-  &quot;commit_info&quot;: {
    7       │-    &quot;short_commit_hash&quot;: &quot;[LONGHASH]&quot;,
    8       │-    &quot;commit_hash&quot;: &quot;[LONGHASH]&quot;,
    9       │-    &quot;commit_date&quot;: &quot;[DATE]&quot;,
   10       │-    &quot;last_tag&quot;: &quot;[TAG]&quot;,
   11       │-    &quot;commits_since_last_tag&quot;: [COUNT]
   12       │-  }
          6 │+  &quot;commit_info&quot;: null
   13     7 │ }
   14     8 │ 
   15     9 │ ----- stderr -----
   16    10 │ warning: Failed to read project metadata (The project is marked as unmanaged: `[TEMP_DIR]/`). Running `uv self version` f
or compatibility. This fallback will be removed in the future; pass `--preview` to force an error.
────────────┴───────────────────────────────────────────────────────────────────
To update snapshots run `cargo insta review`
Stopped on the first failure. Run `cargo insta test` to run all snapshots.

thread 'version::version_get_fallback_unmanaged_json' panicked at /var/tmp/portage/dev-python/uv-0.7.0/work/cargo_home/gentoo/insta-1.4
3.0/src/runtime.rs:679:13:
snapshot assertion for 'version_get_fallback_unmanaged_json' failed in line 947
</code></pre>
<p>My educated guess would be that the tests are assuming they're going to be run from a git checkout, whereas we're running them from unpacked GitHub archives.</p>
<h3>Platform</h3>
<p>Gentoo Linux amd64</p>
<h3>Version</h3>
<p>0.7.0</p>
<h3>Python version</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @mgorny on 2025-04-30 04:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgorny">@mgorny</a> on 2025-04-30 04:20</div>
            <div class="timeline-body"><p>CC @Gankra.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @Gankra by @konstin on 2025-04-30 09:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-04-30 14:20</div>
            <div class="timeline-body"><p>interesting, we can definitely loosen the test but it is accurately reflecting that your tarball build of uv can't report this info.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-04-30 20:28</div>
            <div class="timeline-body"><p>Just confirmed: <code>uv self version --output-format json</code> for the prebuilt version of uv we provide does produce this commit_info regardless of where you run it. So it's not that the test suite expects to be run in the repo, but rather that the test suite expects the built binary to have this feature (and the built binary only has this feature if it was built in the repo, which our prebuilt binaries were).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-04-30 20:33</div>
            <div class="timeline-body"><p>Digging into it more, you can ensure gentoo builds of uv have this metadata by setting the following env-vars at build time:</p>
<pre><code class="language-rust">    let commit_info = option_env_str!(&quot;UV_COMMIT_HASH&quot;).map(|commit_hash| CommitInfo {
        short_commit_hash: option_env_str!(&quot;UV_COMMIT_SHORT_HASH&quot;).unwrap(),
        commit_hash,
        commit_date: option_env_str!(&quot;UV_COMMIT_DATE&quot;).unwrap(),
        last_tag: option_env_str!(&quot;UV_LAST_TAG&quot;),
        commits_since_last_tag: option_env_str!(&quot;UV_LAST_TAG_DISTANCE&quot;)
            .as_deref()
            .map_or(0, |value| value.parse::&lt;u32&gt;().unwrap_or(0)),
    });
</code></pre>
<p>That is:</p>
<ul>
<li>UV_COMMIT_HASH</li>
<li>UV_COMMIT_SHORT_HASH</li>
<li>UV_COMMIT_DATE</li>
<li>UV_LAST_TAG</li>
<li>UV_LAST_TAG_DISTANCE</li>
</ul>
<p>Example values in <code>0.7.2</code>:</p>
<pre><code>&quot;commit_info&quot;: {
    &quot;short_commit_hash&quot;: &quot;481d05d8d&quot;,
    &quot;commit_hash&quot;: &quot;481d05d8dfb8627612dec72840a02c17b926b263&quot;,
    &quot;commit_date&quot;: &quot;2025-04-30&quot;,
    &quot;last_tag&quot;: null,
    &quot;commits_since_last_tag&quot;: 0
  }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-04-30 20:38</div>
            <div class="timeline-body"><p>The code we generate these values from is here, for reference:</p>
<p>https://github.com/astral-sh/uv/blob/0593b967ba848909c46b4c95f4ba8cbdcba147e9/crates/uv-cli/build.rs#L53-L90</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-04-30 20:38</div>
            <div class="timeline-body"><p>I'm happy to loosen the tests if setting these values would be a huge pain for gentoo, or somehow &quot;wrong&quot; with the packaging philosophy though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgorny">@mgorny</a> on 2025-05-01 02:26</div>
            <div class="timeline-body"><p>Yes, it would be a huge pain for us to have to manually edit commit hashes for every <code>uv</code> release. I suppose we could set tag-related variables, since presumably these would always match the package version and 0, respectively, is that correct?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-05-01 11:52</div>
            <div class="timeline-body"><p>I believe they'd always be <code>null</code>, <code>0</code> indicating &quot;this is a tagged commit&quot;. This is also in some sense the most important info, because it signals &quot;this is Really 0.7.2 and not some random commit after 0.7.2&quot;.</p>
<p>That said those values are discarded if UV_COMMIT_HASH isn't also set, so it's a moot point.</p>
<p>I'll go ahead and loosen the test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgorny">@mgorny</a> on 2025-05-01 12:11</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Gankra on 2025-05-21 19:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 03:35:29 UTC
    </footer>
</body>
</html>
