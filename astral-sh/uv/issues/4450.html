<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Venvs from uv and from native python works a little different on nix - astral-sh/uv #4450</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Venvs from uv and from native python works a little different on nix</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/4450">#4450</a>
        opened by <a href="https://github.com/Rubikoid">@Rubikoid</a>
        on 2024-06-22 19:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Rubikoid">@Rubikoid</a></div>
            <div class="timeline-body"><h1>About issue</h1>
<p>uv platform: MacOS Sonoma 14.3.1
uv version: <code>uv 0.2.13</code></p>
<p><code>sys_prefix</code> on uv-created venvs points to the wrong place on nix-managed python.</p>
<p>I'm using Nix for python installation, so I have kinda two variations of python:</p>
<ul>
<li><code>/nix/store/blahA-python3-3.12.3/</code> with pure python without any packages</li>
<li><code>/nix/store/blahB-python3-3.12.3-env/</code> with partially symlinks to <code>/nix/store/blahA-python3-3.12.3/</code> and have packages installed.</li>
</ul>
<p>From the user view, all symlinks to python goes to <code>*-env</code> thing.</p>
<p>When creating venvs with uv they have wrong <code>sys_prefix</code> set, so it is impossible to install any package in read-only python site-packages.</p>
<h1>Reproducing</h1>
<p>uv thinks that my <code>*-env</code> python is not &quot;system&quot; (which it quite right) so when I specify just <code>-p $version</code> to uv, it founds nothing</p>
<pre><code class="language-sh">-&gt; % uv venv uv-venv -vv -p 3.12
    0.002848s DEBUG uv_toolchain::discovery Searching for Python 3.12 in search path
    0.005586s DEBUG uv_toolchain::discovery Found CPython 3.12.3 at `/Users/rubikoid/.nix-profile/bin/python3.12` (search path)
    0.005749s DEBUG uv_toolchain::discovery Ignoring Python interpreter at `/nix/store/blahB-python3-3.12.3-env/bin/python3.12`: system interpreter required
    0.077956s DEBUG uv_toolchain::discovery Found CPython 3.12.3 at `/Users/rubikoid/.nix-profile/bin/python3` (search path)
    0.077974s DEBUG uv_toolchain::discovery Ignoring Python interpreter at `/nix/store/blahB-python3-3.12.3-env/bin/python3.12`: system interpreter required
    0.109480s DEBUG uv_toolchain::discovery Found CPython 3.12.3 at `/Users/rubikoid/.nix-profile/bin/python` (search path)
    0.109498s DEBUG uv_toolchain::discovery Ignoring Python interpreter at `/nix/store/blahB-python3-3.12.3-env/bin/python3.12`: system interpreter required
    0.306166s DEBUG uv_toolchain::discovery Found CPython 3.9.6 at `/usr/bin/python3` (search path)
  × No interpreter found for Python 3.12 in search path
</code></pre>
<p>Because of it i have to specify direct path to python.</p>
<h2>Creating venvs with vu</h2>
<p>So for the first i create venv with <code>*-env</code> python:</p>
<pre><code class="language-sh">-&gt; % uv venv uv-venv -vv -p /nix/store/blahB-python3-3.12.3-env/bin/python3.12
    0.003919s DEBUG uv_toolchain::discovery Checking for Python interpreter at path `/nix/store/blahB-python3-3.12.3-env/bin/python3.12`
Using Python 3.12.3 interpreter at: /nix/store/blahB-python3-3.12.3-env/bin/python3.12
Creating virtualenv at: uv-venv
Activate with: source uv-venv/bin/activate
</code></pre>
<p>And then venv from &quot;original&quot; python:</p>
<pre><code class="language-sh">-&gt; % uv venv uv-venv-2 -vv -p /nix/store/blahA-python3-3.12.3/bin/python3.12
    0.003196s DEBUG uv_toolchain::discovery Checking for Python interpreter in directory `/nix/store/blahA-python3-3.12.3`
Using Python 3.12.3 interpreter at: /nix/store/blahA-python3-3.12.3/bin/python3
Creating virtualenv at: uv-venv-2
Activate with: source uv-venv-2/bin/activate
</code></pre>
<h2>Creating venvs with python venv module</h2>
<p>And then the same thing, but with the native venv module:</p>
<pre><code class="language-sh">/nix/store/blahB-python3-3.12.3-env/bin/python3.12 -m venv py-venv
/nix/store/blahA-python3-3.12.3/bin/python3.12 -m venv py-venv-2
</code></pre>
<h2>Checking results</h2>
<p>Everything run at <code>uv/crates/uv-toolchain</code>:</p>
<h3>uv</h3>
<p>uv venv created from <code>*-env</code> python:</p>
<pre><code class="language-sh">-&gt; % ~/test/uv-venv/bin/python3.12 -m python.get_interpreter_info | jq '. | {sys_prefix: .sys_prefix, sys_base_prefix: .sys_base_prefix, sys_path: .sys_path}'
{
  &quot;sys_prefix&quot;: &quot;/nix/store/blahB-python3-3.12.3-env&quot;,
  &quot;sys_base_prefix&quot;: &quot;/nix/store/blahA-python3-3.12.3&quot;,
  &quot;sys_path&quot;: [
    &quot;/Users/rubikoid/projects/git/uv/crates/uv-toolchain&quot;,
    &quot;/nix/store/blahA-python3-3.12.3/lib/python312.zip&quot;,
    &quot;/nix/store/blahA-python3-3.12.3/lib/python3.12&quot;,
    &quot;/nix/store/blahA-python3-3.12.3/lib/python3.12/lib-dynload&quot;,
    &quot;/nix/store/blahA-python3-3.12.3/lib/python3.12/site-packages&quot;,
    &quot;/nix/store/blahB-python3-3.12.3-env/lib/python3.12/site-packages&quot;
  ]
}
</code></pre>
<p>uv venv created from fresh python:</p>
<pre><code class="language-sh">-&gt; % ~/test/uv-venv-2/bin/python3.12 -m python.get_interpreter_info | jq '. | {sys_prefix: .sys_prefix, sys_base_prefix: .sys_base_prefix, sys_path: .sys_path}'
{
  &quot;sys_prefix&quot;: &quot;/Users/rubikoid/test/uv-venv-2&quot;,
  &quot;sys_base_prefix&quot;: &quot;/nix/store/blahA-python3-3.12.3&quot;,
  &quot;sys_path&quot;: [
    &quot;/Users/rubikoid/projects/git/uv/crates/uv-toolchain&quot;,
    &quot;/nix/store/blahA-python3-3.12.3/lib/python312.zip&quot;,
    &quot;/nix/store/blahA-python3-3.12.3/lib/python3.12&quot;,
    &quot;/nix/store/blahA-python3-3.12.3/lib/python3.12/lib-dynload&quot;,
    &quot;/Users/rubikoid/test/uv-venv-2/lib/python3.12/site-packages&quot;
  ]
}
</code></pre>
<h3>Native python</h3>
<p>Native python venv, created from <code>*-env</code> python:</p>
<pre><code class="language-sh">-&gt; % ~/test/py-venv/bin/python3.12 -m python.get_interpreter_info | jq '. | {sys_prefix: .sys_prefix, sys_base_prefix: .sys_base_prefix, sys_path: .sys_path}'
{
  &quot;sys_prefix&quot;: &quot;/Users/rubikoid/test/py-venv&quot;,
  &quot;sys_base_prefix&quot;: &quot;/nix/store/blahA-python3-3.12.3&quot;,
  &quot;sys_path&quot;: [
    &quot;/Users/rubikoid/projects/git/uv/crates/uv-toolchain&quot;,
    &quot;/nix/store/blahA-python3-3.12.3/lib/python312.zip&quot;,
    &quot;/nix/store/blahA-python3-3.12.3/lib/python3.12&quot;,
    &quot;/nix/store/blahA-python3-3.12.3/lib/python3.12/lib-dynload&quot;,
    &quot;/Users/rubikoid/test/py-venv/lib/python3.12/site-packages&quot;
  ]
}
</code></pre>
<p>Native python venv, created from fresh python:</p>
<pre><code class="language-sh">-&gt; % ~/test/py-venv-2/bin/python3.12 -m python.get_interpreter_info | jq '. | {sys_prefix: .sys_prefix, sys_base_prefix: .sys_base_prefix, sys_path: .sys_path}'
{
  &quot;sys_prefix&quot;: &quot;/Users/rubikoid/test/py-venv-2&quot;,
  &quot;sys_base_prefix&quot;: &quot;/nix/store/65ackbgqn02p6fy75rksjbp17zj6440j-python3-3.12.3&quot;,
  &quot;sys_path&quot;: [
    &quot;/Users/rubikoid/projects/git/uv/crates/uv-toolchain&quot;,
    &quot;/nix/store/blahA-python3-3.12.3/lib/python312.zip&quot;,
    &quot;/nix/store/blahA-python3-3.12.3/lib/python3.12&quot;,
    &quot;/nix/store/blahA-python3-3.12.3/lib/python3.12/lib-dynload&quot;,
    &quot;/Users/rubikoid/test/py-venv-2/lib/python3.12/site-packages&quot;
  ]
}
</code></pre>
<h2>Result</h2>
<p><code>sys_prefix</code> for the first created venv different from others.</p>
<p>Impossible to install package:</p>
<pre><code class="language-sh">-&gt; % uv pip install -vv -p ~/test/uv-venv uv
 uv_requirements::specification::from_source source=uv
    0.005069s DEBUG uv_toolchain::discovery Checking for Python interpreter in directory `/Users/rubikoid/test/uv-venv`
    0.007050s DEBUG uv::commands::pip::install Using Python 3.12.3 environment at /nix/store/blahB-python3-3.12.3-env/bin/python3.12
error: failed to create file `/nix/store/blahB-python3-3.12.3-env/.lock`
  Caused by: Permission denied (os error 13)
</code></pre>
<p>Maybe this is more a nix than uv issue, if so - feel free to say it and close this.</p>
<p>I don't find anything about patching venvs on nix, only <code>site</code> <a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/development/interpreters/python/sitecustomize.py">customisation</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-23 17:20</div>
            <div class="timeline-body"><p>Is this roughly the same as https://github.com/astral-sh/uv/issues/1795 -- that if we resolved the symlink on the interpreter, we would match the behavior you're expecting?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2024-06-23 17:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">virtualenv</span> added by @charliermarsh on 2024-06-23 17:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">compatibility</span> added by @charliermarsh on 2024-06-23 17:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Rubikoid">@Rubikoid</a> on 2024-06-23 21:36</div>
            <div class="timeline-body"><blockquote>
<p>that if we resolved the symlink on the interpreter, we would match the behavior you're expecting</p>
</blockquote>
<p>I'm not sure.</p>
<p><code>/nix/store/blahB-python3-3.12.3-env/bin/python3.12</code> is not a symlink, in fact it is a wrapper, which updates few env vars (such as <code>NIX_PYTHONPREFIX</code>, they are used further in <code>site</code> customization thing) and then execve original <code>/nix/store/blahA-python3-3.12.3/bin/python3.12</code>.</p>
<p>Sounds like this more about creating venv from existing venv.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kreha1">@kreha1</a> on 2024-07-05 20:11</div>
            <div class="timeline-body"><p>The fact that python from nix store isn't treated as a system interpreter isn't really an issue imo, as we can easily set the UV_PYTHON env dynamically in a derivation.</p>
<p>The real issue is the fact that uv wants to create a <code>.lock</code> file in there, but <code>/nix/store</code> is read-only, so that won't be possible.
While looking for a workaround, I found a similar issue with flutter https://github.com/NixOS/nix/issues/3217</p>
<p>And with that said, I think we would need to at least be able to set where the lock file is created... unless that defeats the purpose of a lock file, but I don't know if that's a standard for python-related software to be honest...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-05 20:27</div>
            <div class="timeline-body"><p>We could make the <code>.lock</code> stuff fallible (just skip it if we can't write, or fallback to a different location).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kreha1">@kreha1</a> on 2024-07-05 20:39</div>
            <div class="timeline-body"><p>Hmm, I think the problem could be elsewhere. I've managed to make <code>uv pip install</code> work with newly created venv (via <code>uv venv</code>).</p>
<p>So for my setup which uses nix flake, the first fix was to make <code>uv</code> always use my selected python version, basically
<code>export UV_PYTHON=${supportedPython}</code> which then turns into <code>export UV_PYTHON=/nix/store/j6j5mv16lbx32m4qjhj5zsygqy0p5zcf-python3-3.10.14-env</code> when entering a shell.</p>
<p>Since this is a nix flake and not NixOS distro which has the entire /nix/store directory mounted as read-only, I just made that path <code>sudo chmod +w</code> and I thought that it would work, but packages still wanted to be installed to the nix store location.</p>
<p>Then I've realized that after I unset the variable, the lock gets created, as I suspect correctly, inside <code>.venv</code> directory. That would suggest it's a bug, where setting <code>UV_PYTHON</code> variable prevents <code>uv</code> from installing packages in a virtual environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Rubikoid">@Rubikoid</a> on 2024-07-05 23:04</div>
            <div class="timeline-body"><blockquote>
<p>The real issue is the fact that uv wants to create a .lock file in there</p>
</blockquote>
<p>I think, I quite disagree there.</p>
<p>.lock problem is kinda a symptom, while wrong pythons selection / strange venvs are disease.</p>
<blockquote>
<p>Then I've realized that after I unset the variable, the lock gets created, as I suspect correctly, inside .venv directory.</p>
</blockquote>
<p>That’s interesting. I did not use environment variables at all, only cli args. I’ll recheck this issue using env vars.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kreha1">@kreha1</a> on 2024-07-05 23:16</div>
            <div class="timeline-body"><p>Well, there is an issue with symlink resolution for sure, but I agree 100% with what you are saying.</p>
<p>After reproducing this issue on a different machine, I realized that I didn't manage to make it work... What worked was actually a different tool (hatch), as since it can be configured to use uv, I mistakenly assumed that it also uses it for venv creation.
So, sorry for giving incorrect info.</p>
<p>I believe that hatch uses <code>python -m venv</code> under the hood, hence why it worked (but it's just a guess).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kreha1">@kreha1</a> on 2024-07-05 23:23</div>
            <div class="timeline-body"><p>And now I'm really confused. Creating venv via <code>python -m venv</code> and <code>uv venv</code> will resolve different nix store paths.</p>
<h3>python module</h3>
<pre><code>$ /nix/store/j6j5mv16lbx32m4qjhj5zsygqy0p5zcf-python3-3.10.14-env/bin/python3 -m venv .venv
$ readlink .venv/bin/python3
/nix/store/igfc19nl0zv95wj77sf7nnmkbykb4idj-python3-3.10.14/bin/python3
</code></pre>
<h3>uv venv</h3>
<pre><code>$ uv venv -p /nix/store/j6j5mv16lbx32m4qjhj5zsygqy0p5zcf-python3-3.10.14-env/bin/python3
Using Python 3.10.14 interpreter at: /nix/store/j6j5mv16lbx32m4qjhj5zsygqy0p5zcf-python3-3.10.14-env/bin/python3.10
Creating virtualenv at: .venv
Activate with: source .venv/bin/activate
$ readlink .venv/bin/python
/nix/store/j6j5mv16lbx32m4qjhj5zsygqy0p5zcf-python3-3.10.14-env/bin/python3.10
</code></pre>
<p>And fun fact, with venv module, <code>.venv/bin/python</code> points to <code>.venv/bin/python3</code> and for uv venv it's reversed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Rubikoid">@Rubikoid</a> on 2024-07-05 23:42</div>
            <div class="timeline-body"><blockquote>
<p>And now I'm really confused. Creating venv via python -m venv and uv venv will resolve different nix store paths.</p>
</blockquote>
<p>Yeah -)</p>
<p>This is literally the spirit of this issue)</p>
<p>uv’s venv have python pointing to python wrapper in nix’s python environment, while the native python venv have py pointing to original python binary (and derivation, ofc)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-05 23:45</div>
            <div class="timeline-body"><p>I just need to find time to setup Nix and play around with the behaviors. It’s a little hard for me to keep track of what’s going wrong from here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/darinkishore">@darinkishore</a> on 2024-07-06 06:09</div>
            <div class="timeline-body"><p>Please correct me if I'm wrong, @Rubikoid @kreha1 , but this is an issue if you're using uv and trying to point to a globally managed nix python installation, right?</p>
<p>I think this is the case because I currently use a devshell for managing python/uv, and i haven't had a single installation issue.</p>
<p>Isn't using a devshell the solution to this? I know @kreha1 you said you only got it working through hatch, but I don't think you need hatch, pretty sure you can use uv to install things alongside the python from nixpkgs.</p>
<p>Here's the devshell <code>flake.nix</code> I'm using:</p>
<pre><code class="language-nix">
{
  description = &quot;Python development environment with uv&quot;;

  inputs = {
    nixpkgs.url = &quot;github:NixOS/nixpkgs/nixos-unstable&quot;;
    flake-utils.url = &quot;github:numtide/flake-utils&quot;;
  };

  outputs = { self, nixpkgs, flake-utils }:
    flake-utils.lib.eachDefaultSystem (system:
      let
        pkgs = import nixpkgs { inherit system; };
      in
      {
        devShells.default = pkgs.mkShell {
          buildInputs = with pkgs; [
            python312
            uv
          ];

          # this runs when we do `nix develop .` 
          shellHook = ''
            # Create a virtual environment if it doesn't exist
            if [ ! -d &quot;.venv&quot; ]; then
              uv venv .venv
            fi
            source .venv/bin/activate
            echo &quot;uv pip env ready&quot;
          '';
        };
      }
    );
}
</code></pre>
<p>direnv bonus copy paste: <code>echo &quot;use flake&quot; &gt;&gt; .envrc</code></p>
<p>Have installed torch w/cuda support, jupyter, all sorts of things that are usually a massive pain on nixos with a modified version of this flake.</p>
<p>Could you let me know if this solves or helps the issue, or if I'm just misunderstanding things?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/darinkishore">@darinkishore</a> on 2024-07-06 06:17</div>
            <div class="timeline-body"><blockquote>
<p>I just need to find time to setup Nix and play around with the behaviors. It’s a little hard for me to keep track of what’s going wrong from here.</p>
</blockquote>
<p>I started a couple months ago! It's a LOT.</p>
<p>Fastest way to hit the ground running and have a uv + py nix-managed environment is:</p>
<ol>
<li><p>install nix via: https://github.com/DeterminateSystems/nix-installer (just run <code>curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s — install</code>, if you don't mind curl to sh)</p>
</li>
<li><p>make a new directory, copy the code in the previous response into a file called <code>flake.nix</code> inside your new dir (remove shellHook if you don't want a venv off the bat)</p>
</li>
<li><p>Run <code>nix develop .</code> and try <code>which uv</code>. To exit this temporary shell, just do <code>exit</code>!</p>
</li>
<li><p>(optional) if you think you're going to be doing this more often, <code>zero-to-nix</code> is a great starting resource for practical, usable nix. <a href="https://direnv.net/docs/installation.html">direnv</a>  with <a href="https://github.com/nix-community/nix-direnv">nix-direnv</a> (use the nix-profile install method) makes activating and deactivating the shell an afterthought. finally, <a href="https://devenv.sh">devenv</a> is a great layer of abstraction over nix, especially for beginners.</p>
</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kreha1">@kreha1</a> on 2024-07-06 12:48</div>
            <div class="timeline-body"><p>@darinkishore This is exactly what I'm doing, but not on all systems this works.</p>
<pre><code class="language-nix">{
  description = &quot;A Nix-flake-based Python development environment&quot;;

  inputs.nixpkgs.url = &quot;github:nixos/nixpkgs?ref=nixos-unstable&quot;;

  outputs = { self, nixpkgs }:
    let
      supportedSystems = [ &quot;x86_64-linux&quot; &quot;aarch64-linux&quot; &quot;x86_64-darwin&quot; &quot;aarch64-darwin&quot; ];
      forEachSupportedSystem = f: nixpkgs.lib.genAttrs supportedSystems (system: f rec {
        pkgs = import nixpkgs { inherit system; };
        supportedPython = pkgs.python310;
      });
    in
    {
      devShells = forEachSupportedSystem ({ pkgs, supportedPython }: {
        default = pkgs.mkShell {
          venvDir = &quot;.venv&quot;;
          packages = [
            (supportedPython.withPackages(ps: [ps.uv]))
          ];
          shellHook = ''
            rm -rf .venv &amp;&amp; echo &quot; * Deleted previous .venv&quot;
            uv venv -p ${supportedPython} -v
            . .venv/bin/activate
            echo &quot; * Active python $(which python3) resolves to $(realpath $(which python3))&quot;
            uv pip install numpy -v
            echo &quot; * All python versions:&quot;
            which -a python3 | while read path; do echo &quot;$path is $($path -V)&quot;; done
            echo &quot; * System info:&quot;
            lsb_release -a
          '';
        };
      });
    };
}
</code></pre>
<h3>Ubuntu 20.04 (has only system python 3.8.10 installed)</h3>
<pre><code>  * Deleted previous .venv
DEBUG uv 0.2.15
DEBUG Checking for Python interpreter in directory `/nix/store/igfc19nl0zv95wj77sf7nnmkbykb4idj-python3-3.10.14`
DEBUG Checking for Python interpreter at directory `/nix/store/igfc19nl0zv95wj77sf7nnmkbykb4idj-python3-3.10.14`
Using Python 3.10.14 interpreter at: /nix/store/igfc19nl0zv95wj77sf7nnmkbykb4idj-python3-3.10.14/bin/python3
Creating virtualenv at: .venv
Activate with: source .venv/bin/activate
 * Active python /home/kreha1/git/nix-python-template/.venv/bin/python3 resolves to /nix/store/igfc19nl0zv95wj77sf7nnmkbykb4idj-python3-3.10.14/bin/python3.10
DEBUG uv 0.2.15
DEBUG Searching for Python interpreter in system toolchains
DEBUG Found cpython 3.10.14 at `/home/kreha1/git/nix-python-template/.venv/bin/python3` (active virtual environment)
DEBUG Using Python 3.10.14 environment at .venv/bin/python3
DEBUG Acquired lock for `.venv`
DEBUG At least one requirement is not satisfied: numpy
DEBUG Using request timeout of 30s
DEBUG Solving with installed Python version: 3.10.14
DEBUG Adding direct dependency: numpy*
DEBUG Found fresh response for: https://pypi.org/simple/numpy/
DEBUG Searching for a compatible version of numpy (*)
DEBUG Selecting: numpy==2.0.0 (numpy-2.0.0-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl)
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/d6/a8/6a2419c40c7b6f7cb4ef52c532c88e55490c4fa92885964757d507adddce/numpy-2.0.0-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl.metadata
DEBUG Tried 1 versions: numpy 1
Resolved 1 package in 8ms
DEBUG Requirement already cached: numpy==2.0.0
Installed 1 package in 10ms
 + numpy==2.0.0
 * All python versions:
/home/kreha1/git/nix-python-template/.venv/bin/python3 is Python 3.10.14
/nix/store/j6j5mv16lbx32m4qjhj5zsygqy0p5zcf-python3-3.10.14-env/bin/python3 is Python 3.10.14
/usr/bin/python3 is Python 3.8.10
 * System info:
No LSB modules are available.
Distributor ID: Ubuntu
Description:    Ubuntu 20.04.6 LTS
Release:        20.04
Codename:       focal
</code></pre>
<h3>Ubuntu 22.04 (system python 3.10.12 and pyenv managed versions)</h3>
<pre><code> * Deleted previous .venv
DEBUG uv 0.2.15
DEBUG Checking for Python interpreter in directory `/nix/store/igfc19nl0zv95wj77sf7nnmkbykb4idj-python3-3.10.14`
DEBUG Checking for Python interpreter at directory `/nix/store/igfc19nl0zv95wj77sf7nnmkbykb4idj-python3-3.10.14`
Using Python 3.10.14 interpreter at: /nix/store/j6j5mv16lbx32m4qjhj5zsygqy0p5zcf-python3-3.10.14-env/bin/python3.10
Creating virtualenv at: .venv
Activate with: source .venv/bin/activate
 * Active python /home/kreha1/git/nix-python-template/.venv/bin/python3 resolves to /nix/store/j6j5mv16lbx32m4qjhj5zsygqy0p5zcf-python3-3.10.14-env/bin/python3.10
DEBUG uv 0.2.15
DEBUG Searching for Python interpreter in system toolchains
DEBUG Found cpython 3.10.14 at `/home/kreha1/git/nix-python-template/.venv/bin/python3` (active virtual environment)
DEBUG Using Python 3.10.14 environment at /nix/store/j6j5mv16lbx32m4qjhj5zsygqy0p5zcf-python3-3.10.14-env/bin/python3.10
error: failed to create file `/nix/store/j6j5mv16lbx32m4qjhj5zsygqy0p5zcf-python3-3.10.14-env/.lock`
  Caused by: Permission denied (os error 13)
 * All python versions:
/home/kreha1/git/nix-python-template/.venv/bin/python3 is Python 3.10.14
/nix/store/j6j5mv16lbx32m4qjhj5zsygqy0p5zcf-python3-3.10.14-env/bin/python3 is Python 3.10.14
/home/kreha1/.pyenv/shims/python3 is Python 3.10.13
/usr/bin/python3 is Python 3.10.12
/bin/python3 is Python 3.10.12
 * System info:
No LSB modules are available.
Distributor ID: Ubuntu
Description:    Ubuntu 22.04.4 LTS
Release:        22.04
Codename:       jammy
</code></pre>
<p>So maybe it because of pyenv? @Rubikoid do you also have pyenv managed python on your system?</p>
<p>But still, without providing explicitly python version, on both system the non-nix version gets selected (pyenv &gt; system version)</p>
<p>I might try to containerize this flake, as to eliminate any noise once I have more time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Rubikoid">@Rubikoid</a> on 2024-07-06 13:16</div>
            <div class="timeline-body"><p>@darinkishore,</p>
<blockquote>
<p>but this is an issue if you're using uv and trying to point to a globally managed nix python installation, right?</p>
</blockquote>
<p>Partially. I have globally managed nix python installation <em>with some additional python packages</em>, builded using <code>python.withPackages</code>.
I add the most used packages to global python environment with nix, and want to manage per-project deps using uv.</p>
<p>Due to how nix work, when you use <code>python.withPackages</code>, you end up with two derivations in store: &quot;clean&quot; python and &quot;dirty&quot; python with requested packages and python wrapper, which points to &quot;clean&quot; python.</p>
<p>So my setup is more like this:</p>
<pre><code class="language-nix">{
  inputs.nixpkgs.url = &quot;github:NixOS/nixpkgs/nixos-unstable&quot;;

  outputs = { self, nixpkgs }:
    let
      supportedSystems = [ &quot;x86_64-linux&quot; &quot;aarch64-darwin&quot; &quot;x86_64-darwin&quot; &quot;aarch64-linux&quot; ];
      forEachSystem = f: nixpkgs.lib.genAttrs supportedSystems (system: f {
        pkgs = import nixpkgs { inherit system; };
      });
    in
    {
      devShells = forEachSystem ({ pkgs }: {
        default = pkgs.mkShell (let 
          python = pkgs.python312;
          pythonWithEnv = (python.withPackages (ps: [ ps.pydantic ]));
        in {
          venvDir = &quot;.venv&quot;;
          packages = [
            python
            pythonWithEnv
            pkgs.uv
          ];
          shellHook = ''
            rm -rf .venv &amp;&amp; echo &quot; * Deleted previous .venv&quot;
            uv venv -p ${pythonWithEnv} -v
            . .venv/bin/activate
            echo &quot; * Active python $(which python3) resolves to $(realpath $(which python3))&quot;
            uv pip install numpy -v
            echo &quot; * All python versions:&quot;
            which -a python3 | while read path; do echo &quot;$path is $($path -V)&quot;; done
          '';
        });
      });
    };
}
</code></pre>
<p>With result of:</p>
<pre><code> * Deleted previous .venv
DEBUG Checking for Python interpreter in directory `/nix/store/g5s961289kggv2cah6wh3mc4alyailk7-python3-3.12.3-env`
Using Python 3.12.3 interpreter at: /nix/store/g5s961289kggv2cah6wh3mc4alyailk7-python3-3.12.3-env/bin/python3.12
Creating virtualenv at: .venv
Activate with: source .venv/bin/activate
 * Active python /Users/rubikoid/projects/personal/infra/py-repro/.venv/bin/python3 resolves to /nix/store/g5s961289kggv2cah6wh3mc4alyailk7-python3-3.12.3-env/bin/python3.12
DEBUG Searching for Python interpreter in virtual environments
DEBUG Found CPython 3.12.3 at `/Users/rubikoid/projects/personal/infra/py-repro/.venv/bin/python3` (active virtual environment)
DEBUG Using Python 3.12.3 environment at /nix/store/g5s961289kggv2cah6wh3mc4alyailk7-python3-3.12.3-env/bin/python3.12
error: failed to create file `/nix/store/g5s961289kggv2cah6wh3mc4alyailk7-python3-3.12.3-env/.lock`
  Caused by: Permission denied (os error 13)
 * All python versions:
/Users/rubikoid/projects/personal/infra/py-repro/.venv/bin/python3 is Python 3.12.3
/nix/store/65ackbgqn02p6fy75rksjbp17zj6440j-python3-3.12.3/bin/python3 is Python 3.12.3
/nix/store/g5s961289kggv2cah6wh3mc4alyailk7-python3-3.12.3-env/bin/python3 is Python 3.12.3
/nix/store/327bf08j5b7l9cnzink3g4vp32y5352j-python3-3.11.9/bin/python3 is Python 3.11.9
/Users/rubikoid/.nix-profile/bin/python3 is Python 3.12.3
/usr/bin/python3 is Python 3.9.6
(py-repro) bash-5.2$
</code></pre>
<p>So here:
<code>/nix/store/65ackbgqn02p6fy75rksjbp17zj6440j-python3-3.12.3/bin/python3</code> - is &quot;clean&quot; python
<code>/nix/store/g5s961289kggv2cah6wh3mc4alyailk7-python3-3.12.3-env/bin/python3</code> - is &quot;dirty&quot; python env with pydantic, which i created with <code>python.withPackages</code>.</p>
<p>Also, if I replace <code>uv venv -p ${pythonWithEnv} -v</code> with <code>uv venv -p ${python} -v</code>, everything will work perfectly.</p>
<p>@kreha1, no, i don't use <code>pyenv</code> at all, only nix's <code>python.withPackages</code>.
The reason, why your example on ubuntu succeeded, is because you hardcoded &quot;clean&quot; python in <code>uv venv -p</code>, while adding &quot;dirty&quot; python with packages to shell environment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kreha1">@kreha1</a> on 2024-07-06 13:52</div>
            <div class="timeline-body"><p>That makes sense, thanks for explaining, as I don't have much experience with nix :).</p>
<p>But that is still odd, that this same flake results in different behaviour on two systems - on 20.04 uv venv chooses clean python as provided, but on 22.04 it will choose dirty python, resulting in writing to read-only directory.</p>
<pre><code class="language-nix">shellHook = ''
  echo &quot;Clean python is ${supportedPython}&quot;
  which -a python3 | while read path; do echo &quot;$path is $($path -V)&quot;; done
  rm -rf .venv &amp;&amp; echo &quot; * Deleted previous .venv&quot;
  uv venv -p ${supportedPython} -v
'';
</code></pre>
<h3>ubuntu 20.04</h3>
<pre><code>Clean python is /nix/store/igfc19nl0zv95wj77sf7nnmkbykb4idj-python3-3.10.14
/nix/store/j6j5mv16lbx32m4qjhj5zsygqy0p5zcf-python3-3.10.14-env/bin/python3 is Python 3.10.14
/usr/bin/python3 is Python 3.8.10

 * Deleted previous .venv
DEBUG uv 0.2.15
DEBUG Checking for Python interpreter in directory `/nix/store/igfc19nl0zv95wj77sf7nnmkbykb4idj-python3-3.10.14`
DEBUG Checking for Python interpreter at directory `/nix/store/igfc19nl0zv95wj77sf7nnmkbykb4idj-python3-3.10.14`
Using Python 3.10.14 interpreter at: /nix/store/igfc19nl0zv95wj77sf7nnmkbykb4idj-python3-3.10.14/bin/python3
...
</code></pre>
<h3>ubuntu 22.04</h3>
<pre><code>Clean python is /nix/store/igfc19nl0zv95wj77sf7nnmkbykb4idj-python3-3.10.14
/nix/store/j6j5mv16lbx32m4qjhj5zsygqy0p5zcf-python3-3.10.14-env/bin/python3 is Python 3.10.14
/home/t.rymkiewicz/.pyenv/shims/python3 is Python 3.10.13
/usr/bin/python3 is Python 3.10.12
/bin/python3 is Python 3.10.12
 * Deleted previous .venv
DEBUG uv 0.2.15
DEBUG Checking for Python interpreter in directory `/nix/store/igfc19nl0zv95wj77sf7nnmkbykb4idj-python3-3.10.14`
DEBUG Checking for Python interpreter at directory `/nix/store/igfc19nl0zv95wj77sf7nnmkbykb4idj-python3-3.10.14`
Using Python 3.10.14 interpreter at: /nix/store/j6j5mv16lbx32m4qjhj5zsygqy0p5zcf-python3-3.10.14-env/bin/python3.10
...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akaihola">@akaihola</a> on 2024-09-14 14:56</div>
            <div class="timeline-body"><p>I have this problem with all virtualenvs on NixOS, whether created with <code>uv venv</code> or <code>python -m venv</code>:</p>
<pre><code class="language-shell">$ source .venv/bin/activate
$ pip install -U pip
error: failed to create file `/nix/store/pnavhjx4pdya95nx2apl2yxz6x46snh2-python3-3.12.4-env/.lock`
  Caused by: Read-only file system (os error 30)
</code></pre>
<p>I'm working around it by making sure I always</p>
<ul>
<li>create my virtualenv using <code>python -m venv</code></li>
<li>do this before using <code>uv pip</code>:</li>
</ul>
<pre><code class="language-shell">source .venv/bin/activate
export UV_PYTHON=$VIRTUAL_ENV/bin/python
</code></pre>
<p>See #7395 for more details.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Rubikoid">@Rubikoid</a> on 2024-09-14 15:46</div>
            <div class="timeline-body"><p>So far, I've come to the following bizzare solution for creating working envs:</p>
<pre><code class="language-sh">uv venv -p `python3 -c 'import sys; from pathlib import Path; print(str(Path(sys.path[1]).parent.parent))'`
</code></pre>
<p>This works on <code>a58bc8ad779655e790115244571758e8de055e3d</code> rev of nixpkgs</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ShaddyDC">@ShaddyDC</a> on 2024-09-18 09:19</div>
            <div class="timeline-body"><p>Instead of setting all the environment variables in bash, it seems much better to set them in your nix flake or whatever you're using for your environment. It's more robust and precise.
Something like</p>
<pre><code class="language-nix">UV_PYTHON_PREFERENCE = &quot;only-system&quot;;
UV_PYTHON = &quot;${pkgs.python310}&quot;;
</code></pre>
<p>Unfortunately, the uv-installed numpy version isn't nixos compatible (<code>ImportError: libstdc++.so.6: cannot open shared object file: No such file or directory</code>).
I was thinking of using <code>uv sync --no-install-package numpy</code> and a nix python environment that pulls in numpy with <code>withPackages</code>, but that fails because it tries to create the lockfile in the nix store as others have reported.
For now I'm just using distrobox.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Rubikoid">@Rubikoid</a> on 2024-09-18 17:33</div>
            <div class="timeline-body"><blockquote>
<p>UV_PYTHON</p>
</blockquote>
<p>Yeah, great idea, I did't mind.</p>
<blockquote>
<p>Unfortunately, the uv-installed numpy version isn't nixos compatible</p>
</blockquote>
<p>I guess, this can be fixed if (or when) the &quot;using packages from other venv in venv&quot; thing is implemented, which is, i think, core issue here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jakob1379">@jakob1379</a> on 2024-10-12 20:05</div>
            <div class="timeline-body"><p>Just to add to the plathora of solutions I usually just have this which haven't caused any issues so far</p>
<p><em>EDIT</em>: tried in Ubuntu, NixOS, and PiOS.</p>
<pre><code class="language-nix">{
  inputs = { utils.url = &quot;github:numtide/flake-utils&quot;; };
  outputs = { self, nixpkgs, utils }:
    utils.lib.eachDefaultSystem (system:
      let pkgs = nixpkgs.legacyPackages.${system};
      in {
        devShell = pkgs.mkShell {
          buildInputs = with pkgs; [ uv python312 ];
          shellHook = ''
            export UV_PYTHON=${pkgs.python312}
            uv venv
          '';
        };
      });
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @zanieb on 2024-10-21 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wish</span> added by @zanieb on 2024-10-21 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/purepani">@purepani</a> on 2024-11-13 15:49</div>
            <div class="timeline-body"><blockquote>
<p>Instead of setting all the environment variables in bash, it seems much better to set them in your nix flake or whatever you're using for your environment. It's more robust and precise. Something like</p>
<pre><code class="language-nix">UV_PYTHON_PREFERENCE = &quot;only-system&quot;;
UV_PYTHON = &quot;${pkgs.python310}&quot;;
</code></pre>
<p>Unfortunately, the uv-installed numpy version isn't nixos compatible (<code>ImportError: libstdc++.so.6: cannot open shared object file: No such file or directory</code>). I was thinking of using <code>uv sync --no-install-package numpy</code> and a nix python environment that pulls in numpy with <code>withPackages</code>, but that fails because it tries to create the lockfile in the nix store as others have reported. For now I'm just using distrobox.</p>
</blockquote>
<p>I would like to point out that this is normal in nix and not something that is solvable by UV.
Numpy requires dynamic libraries to be installed, which wheels don't automatically install. The &quot;correct&quot; nix solution would be to expose whatever dynamic libraries are needed for whatever libraries to the Python interpreter when declaring the nix shell, or even better, using something like <a href="https://github.com/nix-community/dream2nix">dream2nix</a>(which doesn't support UV yet but could) or <a href="https://github.com/adisbladis/uv2nix">uv2nix</a> where you can declare the dynamic  libraries needed for whatever packages you're using.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Alsiri0n">@Alsiri0n</a> on 2025-02-18 15:22</div>
            <div class="timeline-body"><p>uv platform: MacOS Sequoia 15.3.1
uv version: uv 0.6.1</p>
<p>Hello, I'm a little bit of confused behaviour of uv and creating venv. Possible I incorrectly create venv with help uv.
Before uv I'm used to default command for creating venv. And after I checked with help pip the location of my venv</p>
<pre><code class="language-shell">-&gt; % python3.11 -m venv .pyvenv
-&gt; % source .pyvenv/bin/activate
-&gt; % pip -V
pip 24.0 from /Users/alsiri0n/coding/python/test/.pyvenv/lib/python3.11/site-packages/pip (python 3.11)
</code></pre>
<p>But if I use uv, I got another path</p>
<pre><code class="language-shell">-&gt; % uv venv 
Using CPython 3.11.9 interpreter at: /Library/Frameworks/Python.framework/Versions/3.11/bin/python3.11
Creating virtual environment at: .venv
Activate with: source .venv/bin/activate
-&gt; % source .venv/bin/activate 
-&gt; % pip -V
pip 25.0.1 from /Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/pip (python 3.11)
</code></pre>
<p>This path some frustrated me and I don't know how to trust with path.
I didn't find any related topics instead this one. Maybe anyone know community chats or something else) or any related issue.
Maybe it's correct behaviour for pip, but it's differed at default path.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-18 15:31</div>
            <div class="timeline-body"><p>@Alsiri0n this issue is for using uv with Nix, which it looks like you're not using. We don't install <code>pip</code> in new virtual environments by default, you want <code>uv venv --seed</code> to include that. Please read #9452 and open a new issue if you have more questions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Alsiri0n">@Alsiri0n</a> on 2025-02-18 22:41</div>
            <div class="timeline-body"><p>Thank you very much! I thought that standard behaviour at the moment of creation virtual environment is to add pip</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/iniw">@iniw</a> on 2025-02-19 02:08</div>
            <div class="timeline-body"><p>For reference, if anyone bumps into this issue, here's a devshell that allows you to mix nix-managed and uv-managed libraries:</p>
<pre><code class="language-nix">{
  inputs = {
    nixpkgs.url = &quot;github:NixOS/nixpkgs/nixpkgs-unstable&quot;;
    flake-utils.url = &quot;github:numtide/flake-utils&quot;;
  };

  outputs =
    {
      self,
      nixpkgs,
      flake-utils,
    }:
    flake-utils.lib.eachDefaultSystem (
      system:
      let
        pkgs = import nixpkgs { inherit system; };
        python = pkgs.python3;
        pythonEnv = python.withPackages (p: [
          # Here goes all the libraries that can't be managed by uv because of dynamic linking issues
          # or that you just want to be managed by nix for one reason or another
          p.pandas
        ]);
      in
      {
        devShells.default =
          with pkgs;
          mkShell {
            packages = [
              uv
              python
              pythonEnv
            ];

            shellHook = ''
              export UV_PYTHON_PREFERENCE=&quot;only-system&quot;;
              export UV_PYTHON=${python}
            '';
          };
      }
    );
}
</code></pre>
<p>You can even do <code>uv add pandas</code> just to add it to the lockfile, which is great for working in projects with non-nix users :)</p>
<p><em>Originally posted in <a href="https://github.com/astral-sh/uv/issues/11529#issuecomment-2667294194">#11529</a></em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lucasew">@lucasew</a> on 2025-07-21 23:18</div>
            <div class="timeline-body"><p>Standard NixOS, for not being FHS compliant, often do not run binaries not packaged for it because how the programs do dynamic linking. You can use steam-run or make a FHS wrapper like how it's done in Conda.</p>
<p>I prefer this approach: https://github.com/lucasew/nixcfg/blob/master/nix/nodes/common/nix-ld.nix</p>
<p>It allows even appimages to work out of the box</p>
<p>Edit 1: as it's not NixOS, I'd suggest to just use the UV python directly. Mixing stuff up can cause weird bugs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Rubikoid">@Rubikoid</a> on 2025-07-22 01:08</div>
            <div class="timeline-body"><blockquote>
<p>Standard NixOS, for not being FHS compliant, often do not run binaries not packaged for it because how the programs do dynamic linking.</p>
</blockquote>
<p>The problem is not with dynamic linking nor FHS compatibility, the problem in complex python system for package search, which somehow works different on python's venv and uv's venv.</p>
<p>This affects native libraries, but only as a side effect.</p>
<blockquote>
<p>as it's not NixOS, I'd suggest to just use the UV python directly. Mixing stuff up can cause weird bugs.</p>
</blockquote>
<p>This is not depends on which distro/nix installation you use.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:25:20 UTC
    </footer>
</body>
</html>
