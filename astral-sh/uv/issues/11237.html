<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Two `run.rs` test regressions in 0.5.28, apparently due to installing `typing-extensions` (?) - astral-sh/uv #11237</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Two <code>run.rs</code> test regressions in 0.5.28, apparently due to installing <code>typing-extensions</code> (?)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/11237">#11237</a>
        opened by <a href="https://github.com/mgorny">@mgorny</a>
        on 2025-02-05 07:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/mgorny">@mgorny</a> on 2025-02-05 07:56</div>
            <div class="timeline-body"><h3>Summary</h3>
<pre><code>$ cargo test
[…]
failures:

---- run::run_repeated stdout ----

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Unfiltered output ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
----- stdout -----

----- stderr -----
Using CPython 3.13.1 interpreter at: /home/mgorny/.local/share/uv/tests/.tmpp1Kpy8/python/3.13/python3
Creating virtual environment at: .venv
Resolved 2 packages in 373ms
Prepared 1 package in 116ms
Installed 1 package in 14ms
 + iniconfig==2.0.0
Resolved 1 package in 307ms
Prepared 1 package in 113ms
Installed 1 package in 1ms
 + typing-extensions==4.10.0

────────────────────────────────────────────────────────────────────────────────


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Unfiltered output ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
----- stdout -----

----- stderr -----
Resolved 2 packages in 97ms
Audited 1 package in 0.04ms
Resolved 1 package in 12ms
Installed 1 package in 8ms
 + typing-extensions==4.10.0

────────────────────────────────────────────────────────────────────────────────

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot: run_repeated-2
Source: crates/uv/tests/it/run.rs:3914
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
Expression: snapshot
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
    3     3 │ 
    4     4 │ ----- stderr -----
    5     5 │ Resolved 2 packages in [TIME]
    6     6 │ Audited 1 package in [TIME]
    7       │-Resolved 1 package in [TIME]
          7 │+Resolved 1 package in [TIME]
          8 │+Installed 1 package in [TIME]
          9 │+ + typing-extensions==4.10.0
────────────┴──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
To update snapshots run `cargo insta review`
Stopped on the first failure. Run `cargo insta test` to run all snapshots.
thread 'run::run_repeated' panicked at /home/mgorny/.cargo/registry/src/index.crates.io-6f17d22bba15001f/insta-1.42.1/src/runtime.rs:679:13:
snapshot assertion for 'run_repeated-2' failed in line 3914
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace

---- run::run_without_overlay stdout ----

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Unfiltered output ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
----- stdout -----

----- stderr -----
Using CPython 3.13.1 interpreter at: /home/mgorny/.local/share/uv/tests/.tmpsb7AWS/python/3.13/python3
Creating virtual environment at: .venv
Resolved 2 packages in 444ms
Prepared 1 package in 132ms
Installed 1 package in 9ms
 + iniconfig==2.0.0
Resolved 1 package in 324ms
Prepared 1 package in 162ms
Installed 1 package in 26ms
 + typing-extensions==4.10.0

────────────────────────────────────────────────────────────────────────────────


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Unfiltered output ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
----- stdout -----

----- stderr -----
Resolved 1 package in 20ms
Traceback (most recent call last):
  File &quot;&lt;string&gt;&quot;, line 1, in &lt;module&gt;
    import typing_extensions; import iniconfig
                              ^^^^^^^^^^^^^^^^
ModuleNotFoundError: No module named 'iniconfig'

────────────────────────────────────────────────────────────────────────────────


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Unfiltered output ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
----- stdout -----

----- stderr -----
Resolved 2 packages in 305ms
Audited 1 package in 0.04ms
Resolved 1 package in 9ms
Installed 1 package in 9ms
 + typing-extensions==4.10.0

────────────────────────────────────────────────────────────────────────────────

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot: run_without_overlay-3
Source: crates/uv/tests/it/run.rs:4001
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
Expression: snapshot
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
    3     3 │ 
    4     4 │ ----- stderr -----
    5     5 │ Resolved 2 packages in [TIME]
    6     6 │ Audited 1 package in [TIME]
    7       │-Resolved 1 package in [TIME]
          7 │+Resolved 1 package in [TIME]
          8 │+Installed 1 package in [TIME]
          9 │+ + typing-extensions==4.10.0
────────────┴──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
To update snapshots run `cargo insta review`
Stopped on the first failure. Run `cargo insta test` to run all snapshots.
thread 'run::run_without_overlay' panicked at /home/mgorny/.cargo/registry/src/index.crates.io-6f17d22bba15001f/insta-1.42.1/src/runtime.rs:679:13:
snapshot assertion for 'run_without_overlay-3' failed in line 4001


failures:
    run::run_repeated
    run::run_without_overlay

test result: FAILED. 1656 passed; 2 failed; 4 ignored; 0 measured; 0 filtered out; finished in 557.08s

error: test failed, to rerun pass `-p uv --test it`
</code></pre>
<h3>Platform</h3>
<p>Gentoo Linux</p>
<h3>Version</h3>
<p>0.5.28</p>
<h3>Python version</h3>
<p>3.13.1</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @mgorny on 2025-02-05 07:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-05 13:51</div>
            <div class="timeline-body"><p>This looks like evidence of a real bug. You shouldn’t need to reinstall there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-05 13:56</div>
            <div class="timeline-body"><p>Is there a Dockerfile I can use to reproduce this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgorny">@mgorny</a> on 2025-02-05 14:22</div>
            <div class="timeline-body"><p>I've hit it from the git repo as my user. I'll try to write a Dockerfile and see if it reproduces in a minute.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-05 14:35</div>
            <div class="timeline-body"><p>Thank you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @zanieb on 2025-02-05 15:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgorny">@mgorny</a> on 2025-02-05 16:33</div>
            <div class="timeline-body"><p>Would a Dockerfile that triggers a few failures more work? I've already spent a little too much time on it, and I really have no clue what's up with these venv tests (I don't see it locally).</p>
<p>The two relevant cases are:</p>
<pre><code>    run::run_repeated
    run::run_without_overlay
</code></pre>
<p>I see the dockerfile also triggers <code>build_backend::preserve_executable_bit</code> failing because I've skipped <code>git</code> feature to make it more contained. Feel free to ignore the rest. I can try improving it later if necessary.</p>
<pre><code>FROM gentoo/python
RUN wget --progress=dot:mega -O - https://github.com/gentoo-mirror/gentoo/archive/master.tar.gz | tar -xz \
 &amp;&amp; mv gentoo-master /var/db/repos/gentoo
RUN getuto
RUN printf &quot;[binhost]\nsync-uri = https://distfiles.gentoo.org/releases/amd64/binpackages/23.0/x86-64/\n&quot; &gt; /etc/portage/binrepos.conf/gentoobinhost.conf
RUN emerge -vng dev-vcs/git dev-lang/rust-bin dev-build/cmake dev-build/ninja --jobs
RUN git clone --depth=1 https://github.com/astral-sh/uv
RUN cd uv &amp;&amp; cargo test --no-default-features --features=python,pypi
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-05 16:33</div>
            <div class="timeline-body"><p>Yeah this is plenty. Thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-05 17:58</div>
            <div class="timeline-body"><p>Just to confirm, do you disable the use of the <code>python-build-standalone</code> Pythons in the test suite?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2025-02-05 19:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-02-05 20:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-02-05 20:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgorny">@mgorny</a> on 2025-02-06 04:01</div>
            <div class="timeline-body"><blockquote>
<p>Just to confirm, do you disable the use of the <code>python-build-standalone</code> Pythons in the test suite?</p>
</blockquote>
<p>Yes, we run on the system Pythons.</p>
<p>Thanks for the prompt fix! Unfortunately, I couldn't test it during the morning work, but I'll confirm the fix later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgorny">@mgorny</a> on 2025-02-06 12:41</div>
            <div class="timeline-body"><p>Confirmed working. Thanks!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:30:54 UTC
    </footer>
</body>
</html>
