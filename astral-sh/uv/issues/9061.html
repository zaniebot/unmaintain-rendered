<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Running unit tests with pytest in scripts - astral-sh/uv #9061</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Running unit tests with pytest in scripts</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/9061">#9061</a>
        opened by <a href="https://github.com/wrdls">@wrdls</a>
        on 2024-11-12 15:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/wrdls">@wrdls</a></div>
            <div class="timeline-body"><p>I use <code>uv</code> to run scripts with <a href="https://docs.astral.sh/uv/guides/scripts/#declaring-script-dependencies">inline dependencies</a>.</p>
<p>Sometimes I have a need to add a unit test to scripts. Usually my use case is something like the below example where the <code>normalize()</code> function starts off simple and grows in complexity over time (e.g. to handle edge cases) and I want to test these changes.</p>
<p><code>my_script.py</code></p>
<pre><code>def normalize(paths):
  return [p.rstrip(&quot;/&quot;) for p in paths]

def test_normalize():
  assert [&quot;foo&quot;, &quot;bar&quot;] == normalize([&quot;foo/&quot;, &quot;bar&quot;])
</code></pre>
<p>If the scripts keeps growing in size, it probably makes sense to convert this to a project, but at least initially this feels like overkill.</p>
<p>Before <code>uv</code>, I&#x27;d execute these like this with the dependencies installed system wide or in a venv:</p>
<pre><code>python my_script.py  # run the script
pytest my_script.py  # test the script
</code></pre>
<p>What would be the best way to approach this in <code>uv</code>? I feel like I&#x27;m missing something obvious, so please let me know if this is the case.</p>
<p>Ideally I&#x27;d be able to run it like</p>
<pre><code>uv run my_script.py   # run the script with uv
uv run pytest my_script.py  # test the script with uv??
</code></pre>
<p>Another option I thought of was converting the inline dependencies to a venv (e.g., <code>uv venv --from-script my_script.py</code>). This adds steps and complexity for testing, but avoids it for runtime.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Running unit tests in scripts&quot; to &quot;Running unit tests with pytest in scripts&quot; by <a href="https://github.com/wrdls">@wrdls</a> on 2024-11-12 15:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-12 16:42</div>
            <div class="timeline-body"><p>Yep, both of those should work! Let me know if either does not.
If you don&#x27;t want to install <code>pytest</code> in your project, you can also use <code>uvx pytest my_script.py</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-12 16:44</div>
            <div class="timeline-body"><p><code>uv run pytest my_script.py</code> won&#x27;t work because we won&#x27;t read the PEP 723 metadata anymore. Nor will <code>uvx</code>. I&#x27;m not sure we have a good solution yet. I think we need a new <code>uv run</code> option.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-12 17:00</div>
            <div class="timeline-body"><p>Edit: Ignore this, see OP&#x27;s comment below. (My examples worked with pytest because I didn&#x27;t actually import the dependency.)</p>
<hr>
<p>Really? Both of those worked for me (but I&#x27;m doing something shady somewhere...?):</p>
<pre><code>➜  uvexamples uv init inline
Initialized project `inline` at `/Users/dmbp/Documents/dev/uvexamples/inline`
➜  uvexamples cd inline
➜  inline git:(main) ✗ hx my_script.py
</code></pre>
<p>(copied and pasted OP&#x27;s script)</p>
<pre><code>➜  inline git:(main) ✗ uv add --script my_script.py &quot;rich&quot;
Updated `my_script.py`
➜  inline git:(main) ✗ uv run my_script.py
Reading inline script metadata from `my_script.py`
⠙ Resolving dependencies...                                                             INFO add_decision: root @ 0a0.dev0 without checking dependencies
⠙ rich==13.9.4                                                                          INFO add_decision: rich @ 13.9.4 without checking dependencies
⠙ markdown-it-py==3.0.0                                                                 INFO add_decision: markdown-it-py @ 3.0.0 without checking dependencies
⠙ pygments==2.18.0                                                                      INFO add_decision: pygments @ 2.18.0 without checking dependencies
⠙ mdurl==0.1.2                                                                          INFO add_decision: mdurl @ 0.1.2 without checking dependencies
Installed 4 packages in 10ms
➜  inline git:(main) ✗ uvx pytest my_script.py
⠙ Resolving dependencies...                                                             INFO add_decision: root @ 0a0.dev0 without checking dependencies
⠙ pytest==8.3.3                                                                         INFO add_decision: pytest @ 8.3.3 without checking dependencies
⠙ iniconfig==2.0.0                                                                      INFO add_decision: iniconfig @ 2.0.0 without checking dependencies
⠙ packaging==24.2                                                                       INFO add_decision: packaging @ 24.2 without checking dependencies
⠙ pluggy==1.5.0                                                                         INFO add_decision: pluggy @ 1.5.0 without checking dependencies
================================= test session starts ==================================
platform darwin -- Python 3.11.5, pytest-8.3.3, pluggy-1.5.0
rootdir: /Users/dmbp/Documents/dev/uvexamples/inline
configfile: pyproject.toml
collected 1 item

my_script.py .                                                                   [100%]

================================== 1 passed in 0.00s ===================================
➜  inline git:(main) ✗
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wrdls">@wrdls</a> on 2024-11-12 17:28</div>
            <div class="timeline-body"><p>This doesn&#x27;t work for me with the following script.</p>
<pre><code># /// script
# requires-python = &quot;&gt;=3.12&quot;
# dependencies = [
#     &quot;rich&quot;,
# ]
# ///
import rich

def normalize(paths):
  return [p.rstrip(&quot;/&quot;) for p in paths]

def test_normalize():
  assert [&quot;foo&quot;, &quot;bar&quot;] == normalize([&quot;foo/&quot;, &quot;bar&quot;])

if __name__ == &quot;__main__&quot;:
  rich.print(normalize([&quot;foo/&quot;]))

</code></pre>
<p>Testing in Docker to get a clean environment:</p>
<pre><code>❯ docker run --rm -it --entrypoint=bash python:3
root@b441346070f6:/# apt update &amp;&amp; apt install -y vim
...
root@b441346070f6:/# pip install uv
Collecting uv
  Downloading uv-0.5.1-py3-none-manylinux_2_28_aarch64.whl.metadata (11 kB)
Downloading uv-0.5.1-py3-none-manylinux_2_28_aarch64.whl (13.0 MB)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 13.0/13.0 MB 17.7 MB/s eta 0:00:00
Installing collected packages: uv
Successfully installed uv-0.5.1
WARNING: Running pip as the &#x27;root&#x27; user can result in broken permissions and conflicting behaviour with the system package manager, possibly rendering your system unusable.It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv. Use the --root-user-action option if you know what you are doing and want to suppress this warning.

[notice] A new release of pip is available: 24.2 -&gt; 24.3.1
[notice] To update, run: pip install --upgrade pip
root@b441346070f6:/# vim my_script.py
root@b441346070f6:/# uv run my_script.py
Reading inline script metadata from `my_script.py`
Installed 4 packages in 6ms
[&#x27;foo&#x27;]
root@b441346070f6:/# uvx pytest my_script.py
Installed 4 packages in 5ms
========================================================================================== test session starts ===========================================================================================
platform linux -- Python 3.13.0, pytest-8.3.3, pluggy-1.5.0
rootdir: /
collected 0 items / 1 error                                                                                                                                                                              

================================================================================================= ERRORS =================================================================================================
_____________________________________________________________________________________ ERROR collecting my_script.py ______________________________________________________________________________________
ImportError while importing test module &#x27;/my_script.py&#x27;.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
usr/local/lib/python3.13/importlib/__init__.py:88: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
my_script.py:7: in &lt;module&gt;
    import rich
E   ModuleNotFoundError: No module named &#x27;rich&#x27;
======================================================================================== short test summary info =========================================================================================
ERROR my_script.py
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: 1 error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
============================================================================================ 1 error in 0.06s ============================================================================================
root@b441346070f6:/# 
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-11-12 18:40</div>
            <div class="timeline-body"><p>Ah, thank you! That was helpful - I guess I didn&#x27;t try actually importing the dependency in the previous example.</p>
<p>If there are only a few dependencies then you could get around it for now with <code>uvx --with rich pytest my_script.py</code> (but that defeats the purpose of inline dependencies...)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-12 18:59</div>
            <div class="timeline-body"><p>Related</p>
<ul>
<li>https://github.com/astral-sh/uv/issues/8609</li>
<li>#8652</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-12 19:00</div>
            <div class="timeline-body"><p>We&#x27;ve also discussed like <code>--with-requirements &lt;script-path&gt;</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/janosh">@janosh</a> on 2025-04-15 19:19</div>
            <div class="timeline-body"><p>maybe <code>uv run pytest path/to/test_script.py</code> deserves special meaning? seems like the cleanest user interface to me for running test files but still have <code>uv</code> take care of installing test file dependencies</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/klmr">@klmr</a> on 2025-04-19 16:09</div>
            <div class="timeline-body"><p>@janosh This feature request is independent from pytest, it affects any tool which interacts with the code inside the script — even if it doesn’t execute it. In fact, I stumble across this daily when editing such scripts. I’d like to be able to run <code>uv nvim script.py</code> and have the LSP inside NeoVim run in the context of the virtual environment of the script (insert your own favourite IDE instead of NeoVim). Of course for LSP support the long-term answer might be that the LSP will itself support PEP 723, i.e. read the metadata, create its own virtual environment and install the script dependencies. But honestly that feels like pretty complex compared to adding script support for arbitrary <code>uv run</code> invocations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-04-19 16:13</div>
            <div class="timeline-body"><p>See <a href="https://github.com/astral-sh/uv/pull/12763">astral-sh/uv#12763</a></p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:35:27 UTC
    </footer>
</body>
</html>
