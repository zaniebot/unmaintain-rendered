<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`required-environments`: only require that some extras build in some environments - astral-sh/uv #14974</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>required-environments</code>: only require that some extras build in some environments</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/14974">#14974</a>
        opened by <a href="https://github.com/tbrugere">@tbrugere</a>
        on 2025-07-30 14:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tbrugere">@tbrugere</a></div>
            <div class="timeline-body">Question
<p>As all dependency problems, this one originates from <code>torch</code>.</p>
<p>I need to support cuda 12.4  on x86_64, and cuda 12.8 on arm64.  Importantly, pytorch does not provide builds for cuda 12.4 on arm64 platforms.</p>
<p>so I wrote my <code>pyproject.toml</code>  the following way, using, specifying the <code>extra</code> field in <code>required-environments</code> to limit which version of cuda uv would try to resolve for depending on which platform</p>
<pre><code>[project]
name = &quot;minimal_reproduction&quot;
version = &quot;0.1.0&quot;
description = &quot;&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.13&quot;
dependencies = []

[tool.uv]
conflicts = [
    [{extra=&quot;cu128&quot;}, {extra=&quot;cu124&quot;}]
    ]
required-environments = [
    &quot;sys_platform == &#x27;linux&#x27; and platform_machine == &#x27;x86_64&#x27;  and extra == &#x27;cu124&#x27;&quot;,
    &quot;sys_platform == &#x27;linux&#x27; and platform_machine == &#x27;aarch64&#x27; and extra == &#x27;cu128&#x27;&quot;,
]
index-strategy = &quot;unsafe-best-match&quot;



[project.optional-dependencies]
cu124 = [
    &quot;torch==2.6.0+cu124&quot;, 
]

cu128 = [
    &quot;torch==2.7.0+cu128&quot;, 
]

[[tool.uv.index]]
name = &quot;torch-cu128&quot;
url = &quot;https://download.pytorch.org/whl/cu128&quot;

[[tool.uv.index]]
name = &quot;torch-cu124&quot;
url = &quot;https://download.pytorch.org/whl/cu124&quot;
</code></pre>
<p>But it seems <code>uv</code> ignores the <code>extra</code> field, and still complains that it cannot build <code>cu124</code> on <code>arm</code></p>
<pre><code>× No solution found when resolving dependencies for split (python_full_version ==
  │ &#x27;3.13.*&#x27; and platform_machine == &#x27;aarch64&#x27; and sys_platform == &#x27;linux&#x27; and extra ==
  │ &#x27;cu128&#x27;):
  ╰─▶ Because torch==2.6.0+cu124 has no `python_full_version == &#x27;3.13.*&#x27; and
      platform_machine == &#x27;aarch64&#x27; and sys_platform == &#x27;linux&#x27; and extra ==
      &#x27;cu128&#x27;`-compatible wheels and test[cu124] depends on torch==2.6.0+cu124, we can
      conclude that test[cu124]&#x27;s requirements are unsatisfiable.
      And because your project requires test[cu124], we can conclude that your project&#x27;s
      requirements are unsatisfiable.

      hint: The resolution failed for an environment that is not the current one, consider
      limiting the environments with `tool.uv.environments`.
</code></pre>
<p>Is there a way to limit which extras uv will try to build on certain environments?</p>
Platform
<p>Ubuntu 22.04.5 LTS Linux 5.15.0-126-generic x86_64 GNU/Linux</p>
Version
<p>uv 0.8.0</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/tbrugere">@tbrugere</a> on 2025-07-30 14:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-30 14:33</div>
            <div class="timeline-body"><p>We need to solve the full dependency tree to produce a lockfile.</p>
<p>We&#x27;re trying to build the package during resolution in order to determine its metadata. Otherwise, we cannot tell what its dependencies are.</p>
<p>You could probably define static metadata for the package to avoid that? https://docs.astral.sh/uv/concepts/resolution/#dependency-metadata</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tbrugere">@tbrugere</a> on 2025-07-30 14:40</div>
            <div class="timeline-body"><p>Hi @zanieb , thanks for your answer</p>
<p>I&#x27;m not sure which package you are talking about that needs to be built? Is it torch? It is only available as pre-build distributions, there&#x27;s nothing to build there.</p>
<p>I can hardcode its dependencies in my pyproject, but I am not sure how that would solve the problem.</p>
<p>It seems the difficulty lies with the fact that I need two different versions on two different platforms, and uv is trying to resolve for both versions on both platforms (which is impossible). How is adding static dependencies going to solve that?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-30 14:43</div>
            <div class="timeline-body"><p>Sorry, I was reading into your title. What did you mean by &quot;require that some extras build&quot;?</p>
<p>I&#x27;ll look closer at the resolver error here...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-30 14:44</div>
            <div class="timeline-body"><p>I think the crux here is that we&#x27;re not considering the extra we&#x27;re solving for when assessing <code>required-environment</code> markers so <code>and extra == &#x27;cu128&#x27;</code> is ignored?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-30 14:45</div>
            <div class="timeline-body"><p>This might resolve if you add the platform marker to your dependency?</p>
<p>e.g.,</p>
<pre><code>cu124 = [
    &quot;torch==2.6.0+cu124; sys_platform == &#x27;linux&#x27; and platform_machine == &#x27;x86_64&#x27;&quot;, 
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-30 14:50</div>
            <div class="timeline-body"><p>Separately...</p>
<blockquote>
<p>required-environments to limit which version of cuda uv would try to resolve for depending on which platform</p>
</blockquote>
<p>I&#x27;m also not sure this is a correct use of <code>required-environments</code>.</p>
<blockquote>
<p>The required-environments setting can be used to ensure that the resulting resolution contains wheels for specific platforms, or fails if no such wheels are available.</p>
</blockquote>
<p>from https://docs.astral.sh/uv/concepts/resolution/#required-environments</p>
<p>Perhaps you&#x27;re just looking for <code>environments</code>?</p>
<blockquote>
<p>If your project supports only a limited set of platforms or Python versions, you can constrain the set of solved platforms via the environments setting, [...]. In other words, you can use the environments setting to reduce the set of supported platforms.</p>
</blockquote>
<p>from https://docs.astral.sh/uv/concepts/resolution/#limited-resolution-environments</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tbrugere">@tbrugere</a> on 2025-07-30 15:19</div>
            <div class="timeline-body"><p>It does resolve now! thank you ! I wasn&#x27;t aware you could add full platform markers in dependencies.</p>
<p>Yes it probably should be environments, thanks for catching that too</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/tbrugere">@tbrugere</a> on 2025-07-30 15:19</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:39:46 UTC
    </footer>
</body>
</html>
