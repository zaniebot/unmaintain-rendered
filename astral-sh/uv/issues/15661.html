<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>extra-build-dependencies resolves match-runtime requirement even when not needed - astral-sh/uv #15661</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>extra-build-dependencies resolves match-runtime requirement even when not needed</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/15661">#15661</a>
        opened by <a href="https://github.com/befelix">@befelix</a>
        on 2025-09-03 13:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/befelix">@befelix</a></div>
            <div class="timeline-body">Summary
<p>Specifying a requirement together with <code>match-runtime = true</code> for an <code>extra-build-dependencies</code> overwrite, currently has a hard-requirement that the requirement is always in the dependency resolution when running <code>uv sync</code> (i.e., part of the main dependencies or dev dependencies). However, frequently these will be dependency groups that we do not want to include always.</p>
<p>Here&#x27;s a minimal example of the error. I have the following <code>pyproject.toml</code> file:</p>
<pre><code>[project]
name = &quot;project&quot;
version = &quot;0.1.0&quot;
description = &quot;...&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = []

[dependency-groups]
cuda = [
  &quot;torch&quot;,
  &quot;flash-attn&gt;=2.7.2.post1,&lt;3&quot;,
]

[tool.uv.extra-build-dependencies]
flash-attn = [{ requirement = &quot;torch&quot;, match-runtime = true }]
</code></pre>
<p>Running <code>uv sync --group cuda</code> works fine, but <code>uv sync</code> errors out with</p>
<pre><code>warning: The `extra-build-dependencies` option is experimental and may change without warning. Pass `--preview-features extra-build-dependencies` to disable this warning.
Resolved 28 packages in 12ms
error: `torch` was declared as an extra build dependency with `match-runtime = true`, but was not found in the resolution
</code></pre>
<p>The expected behavior would be to not look for the <code>torch</code> requirement if <code>flash-attn</code> is not part of the installed packages in the environment.</p>
Platform
<p>Ubuntu 24.04</p>
Version
<p>uv 0.8.14</p>
Python version
<p>Python 3.12</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/befelix">@befelix</a> on 2025-09-03 13:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;extra-build-dependencies resolves match-runtime even when not needed&quot; to &quot;extra-build-dependencies resolves match-runtime requirement even when not needed&quot; by <a href="https://github.com/befelix">@befelix</a> on 2025-09-03 13:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-09-03 13:38</div>
            <div class="timeline-body"><p>Thanks! That looks like a bug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/huntjk">@huntjk</a> on 2025-09-03 19:01</div>
            <div class="timeline-body"><p>Experiencing a similar issue, except additionally <code>uv run ...</code> throws the same error, even when all optional dependencies are installed.</p>
<pre><code>[project]
name = &quot;project&quot;
version = &quot;0.1.0&quot;
description = &quot;...&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = []

[project.optional-dependencies]
cuda = [
  &quot;torch&quot;,
  &quot;flash-attn&quot;,
]

[tool.uv.extra-build-dependencies]
flash-attn = [{ requirement = &quot;torch&quot;, match-runtime = true }]
</code></pre>
<p>Running <code>uv sync --all-extras</code>, followed by <code>uv run python ...</code> throws:</p>
<pre><code>$ uv run python -m foo_script
warning: The `extra-build-dependencies` option is experimental and may change without warning. Pass `--preview-features extra-build-dependencies` to disable this warning.
error: `torch` was declared as an extra build dependency with `match-runtime = true`, but was not found in the resolution
</code></pre>
<p>This error does not occur when <code>torch</code> and <code>flash_attn</code> are defined in the standard <code>dependencies = [...]</code> list, after running <code>uv sync</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-09-03 20:06</div>
            <div class="timeline-body"><p>When using <code>uv run</code> after a sync operation you either need to include <code>--no-sync</code> or repeat the flags, e.g., <code>uv run --all-extras python ...</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-09-04 02:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-09-04 12:34</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:40:14 UTC
    </footer>
</body>
</html>
