<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv publish` failed to retry on a 502 bad gateway error - astral-sh/uv #12027</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>uv publish</code> failed to retry on a 502 bad gateway error</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/12027">#12027</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2025-03-06 22:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-06 22:52</div>
            <div class="timeline-body"><p>See https://github.com/astral-sh/uv/actions/runs/13707864294/job/38338658887</p>
<p>I'm not sure why this is the case? We special case retries during publish though, so I would not be surprised if we were handling something incorrectly?</p>
<p>https://github.com/astral-sh/uv/blob/4611690745c2358aaec407bcd620ac1255520255/crates/uv-publish/src/lib.rs#L398-L411</p>
<p>5XX is supposedly handled in the <code>DefaultRetryableStrategy</code> from <code>reqwest-retry</code></p>
<pre><code class="language-rust">/// Default request success retry strategy.
///
/// Will only retry if:
/// * The status was 5XX (server error)
/// * The status was 408 (request timeout) or 429 (too many requests)
///
/// Note that success here means that the request finished without interruption, not that it was logically OK.
pub fn default_on_request_success(success: &amp;reqwest::Response) -&gt; Option&lt;Retryable&gt; {
    let status = success.status();
    if status.is_server_error() {
        Some(Retryable::Transient)
    } else if status.is_client_error()
        &amp;&amp; status != StatusCode::REQUEST_TIMEOUT
        &amp;&amp; status != StatusCode::TOO_MANY_REQUESTS
    {
        Some(Retryable::Fatal)
    } else if status.is_success() {
        None
    } else if status == StatusCode::REQUEST_TIMEOUT || status == StatusCode::TOO_MANY_REQUESTS {
        Some(Retryable::Transient)
    } else {
        Some(Retryable::Fatal)
    }
}
</code></pre>
<p>and</p>
<pre><code class="language-rust">    /// Check if status is within 500-599.
    #[inline]
    pub fn is_server_error(&amp;self) -&gt; bool {
        600 &gt; self.0.get() &amp;&amp; self.0.get() &gt;= 500
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2025-03-06 22:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-06 23:17</div>
            <div class="timeline-body"><p>This log is present</p>
<p>https://github.com/astral-sh/uv/blob/748582ee6f3ff1007692f131fa4b59d7c100ec66/crates/uv-client/src/base_client.rs#L441</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-06 23:22</div>
            <div class="timeline-body"><p>But it looks like we set the retries to zero?</p>
<p>https://github.com/astral-sh/uv/blob/3b83b48fd27fc224c5fd534f88a2c0fb28ffdd06/crates/uv/src/commands/publish.rs#L57</p>
<p>which is propagated at</p>
<p>https://github.com/astral-sh/uv/blob/4611690745c2358aaec407bcd620ac1255520255/crates/uv-publish/src/lib.rs#L382</p>
<p>https://github.com/astral-sh/uv/blob/748582ee6f3ff1007692f131fa4b59d7c100ec66/crates/uv-client/src/base_client.rs#L414-L417</p>
<p>and checked at</p>
<p>https://github.com/astral-sh/uv/blob/4611690745c2358aaec407bcd620ac1255520255/crates/uv-publish/src/lib.rs#L400</p>
<pre><code class="language-rust">impl RetryPolicy for ExponentialBackoff {
    fn should_retry(&amp;self, _request_start_time: SystemTime, n_past_retries: u32) -&gt; RetryDecision {
        if self.too_many_attempts(n_past_retries) {
            RetryDecision::DoNotRetry
        } else {
            ...
</code></pre>
<pre><code class="language-rust">    fn too_many_attempts(&amp;self, n_past_retries: u32) -&gt; bool {
        self.max_n_retries
            .is_some_and(|max_n| max_n &lt;= n_past_retries)
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-06 23:28</div>
            <div class="timeline-body"><p>Possible this regressed in</p>
<ul>
<li>https://github.com/astral-sh/uv/pull/9213</li>
<li>https://github.com/astral-sh/uv/pull/9276</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-07 01:31</div>
            <div class="timeline-body"><p>It might be as simple as removing <code>.retries(0)</code>, but I don't fully understand the comment above it. @konstin can you take this one please?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @konstin by @charliermarsh on 2025-03-07 01:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-03-07 12:55</div>
            <div class="timeline-body"><p>We need to keep the <code>retries(0)</code> as the auth middleware is incompatible with upload bodies (https://github.com/seanmonstar/reqwest/issues/2416), we need to construct the retry policy ourselves.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-03-10 11:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-03-10 11:38</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:30:57 UTC
    </footer>
</body>
</html>
