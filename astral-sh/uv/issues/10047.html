<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add instructions to make a docker file that doesn't use root at runtime - astral-sh/uv #10047</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add instructions to make a docker file that doesn't use root at runtime</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/10047">#10047</a>
        opened by <a href="https://github.com/danieltalsky">@danieltalsky</a>
        on 2024-12-20 03:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/danieltalsky">@danieltalsky</a> on 2024-12-20 03:26</div>
            <div class="timeline-body"><p>I really appreciate this example:
https://github.com/astral-sh/uv-docker-example/blob/main/Dockerfile</p>
<p>But sometimes people need to install uv and switch to a non-root user at runtime.</p>
<p>I could NOT get it to work.  Here's a somewhat commented out example of what I tried but not everything.  I tried installing uv to a non-root folder and giving the web user access to the cache, install directory, and virtual environment but I couldn't get ANYTHING to work.  We're talking about two determined devs collaborating for multiple hours.  Is there any way y'all could produce a version of the uv docker example that allows installation and package installation during the build but still allows another user to run the uv entrypoint?  We can't be the only people trying to do this.</p>
<pre><code class="language-dockerfile">FROM python:3.12

ENV DEBIAN_FRONTEND noninteractive

RUN apt-get update &amp;&amp; apt-get install -y apt-utils
RUN apt-get update &amp;&amp; apt-get install -y --upgrade \
    ca-certificates \
    curl \
    git \
    nginx \
    gettext \
    locales \
    supervisor \
    vim

# Install supervisord conf
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Setup nginx
RUN rm /etc/nginx/sites-enabled/default
RUN ln -s /code/nginx.conf /etc/nginx/sites-enabled/tungsten.conf

# Localization / terminal UTF-8 handling
RUN locale-gen en_US.UTF-8
RUN update-locale en_US.UTF-8
ENV LANG=en_US.UTF-8

# Create and use web-user
RUN groupadd web-user --gid 2001
RUN useradd --uid 2001 --gid 2001 -d /code web-user

# nginx and gunicorn setup
COPY . /code

# Download uv installer
ADD https://astral.sh/uv/install.sh /code/uv-installer.sh

RUN chown -R 2001:2001 /code
RUN chown -R 2001:2001 /var/lib/nginx
RUN chown -R 2001:2001 /var/log/nginx

RUN mkdir /logs
RUN chown 2001:2001 /logs

RUN mkdir /logs/nginx
RUN chown 2001:2001 /logs/nginx

RUN mkdir /logs/gunicorn
RUN chown 2001:2001 /logs/gunicorn

USER 2001:2001

# Configure Django project

# Install uv
RUN mkdir -p /code/uv-cache/uv
ENV UV_CACHE_DIR=/code/uv-cache
RUN sh /code/uv-installer.sh &amp;&amp; rm /code/uv-installer.sh
ENV PATH=&quot;/root/.cargo/bin/:$PATH&quot;
mkdir -p /code/uv-cache/uv
ENV PATH=&quot;/code/.cargo/uv/:$PATH&quot;

# Enable bytecode compilation
ENV UV_COMPILE_BYTECODE=1
# Copy from the cache instead of linking since it's a mounted volume
ENV UV_LINK_MODE=copy

ENV DJANGO_PRODUCTION=true
ENV DJANGO_SETTINGS_MODULE=tungsten.settings

# Set workdir
WORKDIR /code
ENV PATH=&quot;/code/.venv/bin:$PATH&quot;

# Install dependencies
# we did try this with /code/
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync

# Place executables in the environment at the front of the path
RUN chmod ug+x /code/setup_cert.sh
RUN chmod ug+x /code/initialize.sh

## Create a registry of static files
RUN uv run /code/manage.py collectstatic --noinput

# Still using a local memory database for a few things
RUN uv run /code/manage.py migrate --noinput

# Compile translation files
RUN uv run /code/manage.py compilemessages

# Expose ports
# 80 = Nginx
# 8000 = Gunicorn
# 3306 = postgres
EXPOSE 80 8000 3306

# Run Supervisor (i.e., start postgres, nginx, and gunicorn)
ENTRYPOINT [&quot;uv&quot;, &quot;run&quot;, &quot;/code/initialize.sh&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Add instructions to make a docker file that doesn't use root" to "Add instructions to make a docker file that doesn't use root at runtime" by @danieltalsky on 2024-12-20 03:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zed">@zed</a> on 2024-12-20 08:48</div>
            <div class="timeline-body"><p>you could prefix <code>RUN --mount=type=cache,target=${UV_CACHE_DIR}</code> to any command that works with <code>$UV_CACHE_DIR</code> (not just <code>uv sync</code>). For example:</p>
<pre><code class="language-dockerfile"># workaround &quot;Permission denied (os error 13)&quot; error in
#    &quot;RUN --mount=type=cache&quot; in `uv sync` below
RUN --mount=type=cache,target=${UV_CACHE_DIR}                     \
    [ -d &quot;${UV_CACHE_DIR}&quot; ] &amp;&amp; chown -R &quot;${UID}:${UID}&quot; &quot;${UV_CACHE_DIR}&quot;
</code></pre>
<p>Then</p>
<pre><code class="language-dockerfile"># install the project's dependencies
RUN --mount=type=cache,target=${UV_CACHE_DIR}                     \
    --mount=type=bind,source=uv.lock,target=uv.lock               \
    --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
     uv sync --frozen --no-install-project
</code></pre>
<p>succeeds.</p>
<p>Alternatively, you could use uid:</p>
<pre><code class="language-dockerfile">RUN --mount=type=cache,target=${UV_CACHE_DIR},uid=${UID}                     \
...
</code></pre>
<p>no <code>chown</code> is necessary for the cache dir in this case.</p>
<p>btw, COPY accepts --chown option too:</p>
<pre><code class="language-dockerfile">COPY --chown=&quot;${UID}:${UID}&quot; . . 
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danieltalsky">@danieltalsky</a> on 2024-12-21 13:50</div>
            <div class="timeline-body"><p>Thank you for pointing me in the right direction!  Any chance you would consider adding a fully working example recommendation to your dockerfile example repo?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-12-21 17:08</div>
            <div class="timeline-body"><p>@zed doesn't work here, they're just being helpful :)</p>
<p>Yes it seems reasonable to add an example to our repositories. I'd review a contribution doing so.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> added by @zanieb on 2024-12-21 18:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/scrat247">@scrat247</a> on 2025-01-02 21:25</div>
            <div class="timeline-body"><p>We've spend some time with this as well and circumvented the problem by focussing on a system-wide install because then switching the user isn't an issue at all.</p>
<p>Some glitch with this is that uv itself isn't available to that unprivileged user - but tbh we don't consider this an issue.</p>
<pre><code>FROM python:3.8.3-slim

# set work directory
WORKDIR /usr/src/app

RUN apt-get update \
    &amp;&amp; apt-get install -y --no-install-recommends curl ca-certificates \
    &amp;&amp; rm -rf /var/lib/apt/lists/*

# Download the installer
ADD https://astral.sh/uv/0.5.13/install.sh /uv-installer.sh

# Run the installer then remove it
RUN sh /uv-installer.sh &amp;&amp; rm /uv-installer.sh

# Ensure the installed binary is on the `PATH`
ENV PATH=&quot;/root/.local/bin/:$PATH&quot;

# Utilize system wide install via uv
ENV UV_PROJECT_ENVIRONMENT=&quot;/usr/local/&quot;
ENV UV_SYSTEM_PYTHON=&quot;true&quot;
ENV UV_PYTHON_PREFERENCE=&quot;only-system&quot;
ENV UV_LINK_MODE=copy

RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,source=uv.lock,target=uv.lock \
    --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
    uv sync --frozen

# replace &lt;GID&gt; with desired group id
# replace &lt;GROUP_NAME&gt; with desired group name
# replace &lt;UID&gt; with desired user id
# replace &lt;USER_NAME&gt; with desired user name
RUN addgroup -gid &lt;GID&gt;&lt;GROUP_NAME&gt; &amp;&amp; adduser --disabled-password --gecos &quot;&quot; --gid &lt;GID&gt; --uid &lt;UID&gt; &lt;USER_NAME&gt;
USER &lt;USER_NAME&gt;

#copy project
COPY . .
</code></pre>
<p>Small warning: Obviously we haven't put that to production (see outdated python version),  but for our local development environments while updating the project it seems to work great so far.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../returnDanilo/uv/pulls/1.html">returnDanilo/uv#1</a> on 2025-02-19 11:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/11617.html">astral-sh/uv#11617</a> on 2025-02-19 11:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:31:53 UTC
    </footer>
</body>
</html>
