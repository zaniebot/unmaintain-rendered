<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv sync` removes necessary dependencies when two packages include the same module - astral-sh/uv #15238</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`uv sync` removes necessary dependencies when two packages include the same module</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/15238">#15238</a>
        opened by <a href="https://github.com/jaseemabid">@jaseemabid</a>
        on 2025-08-12 12:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/jaseemabid">@jaseemabid</a> on 2025-08-12 12:54</div>
            <div class="timeline-body"><h3>Bug Description</h3>
<p><code>uv sync --frozen --no-dev</code> removes runtime dependencies (<code>types-boto3-ecr</code>)
even though they are required in the lock file.</p>
<h3>Reproduction</h3>
<p>The full project is here in a gist, but this is what I did to get there:</p>
<p>https://gist.github.com/jaseemabid/e2acd88b8ccb59e5d60b591247a4655c</p>
<p>This is a fairly tiny project with 2 runtime and 1 dev dependency.</p>
<pre><code class="language-bash">
❯ uv init
❯ uv add &quot;boto3&gt;=1.40&quot;
❯ uv add &quot;types-boto3-ecr&gt;=1.40&quot;

❯ uv add --dev &quot;types-boto3[full]==1.40&quot;
❯ uv sync
</code></pre>
<p>The full lockfile is included in the gist.</p>
<h3>Expected vs Actual</h3>
<p>I expected this to work fine, since the package is explicitly requested:</p>
<pre><code>❯ uv run --no-dev python -c 'import types_boto3_ecr'
Traceback (most recent call last):
  File &quot;&lt;string&gt;&quot;, line 1, in &lt;module&gt;
    import types_boto3_ecr
ModuleNotFoundError: No module named 'types_boto3_ecr'
</code></pre>
<p>This only works without the <code>--no-dev</code> flag, but I can't tell why.</p>
<pre><code>❯ uv run python -c 'import types_boto3_ecr'
</code></pre>
<p><strong>Expected:</strong> <code>types-boto3-ecr</code> should be available (it's a runtime dependency)
<strong>Actual:</strong> <code>ModuleNotFoundError</code> - package is missing despite being in runtime
dependencies</p>
<p>This is pretty concerning that a package I have explicitly mentioned in
project.toml which UV also added to uv.lock isn't in the final virtual env.</p>
<p>I had runtime crashes because of this issue and it's kinda bad.</p>
<h3>Environment</h3>
<ul>
<li>uv 0.8.6 (Homebrew 2025-08-07)</li>
<li>Python 3.13.6</li>
<li>Reproduced on macOS and Docker Linux</li>
</ul>
<h3>Platform</h3>
<p>Darwin 24.6.0 arm64</p>
<h3>Version</h3>
<p>uv 0.8.6 (Homebrew 2025-08-07)</p>
<h3>Python version</h3>
<p>Python 3.13.6</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @jaseemabid on 2025-08-12 12:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-12 14:27</div>
            <div class="timeline-body"><p>I can't reproduce this:</p>
<pre><code>❯ uv init foo
Initialized project `foo` at `/Users/crmarsh/workspace/uv/foo`

❯ uv add &quot;boto3&gt;=1.40&quot;
Using CPython 3.14.0rc1
Creating virtual environment at: .venv
Resolved 8 packages in 169ms
Prepared 2 packages in 356ms
Installed 7 packages in 18ms
 + boto3==1.40.7
 + botocore==1.40.7
 + jmespath==1.0.1
 + python-dateutil==2.9.0.post0
 + s3transfer==0.13.1
 + six==1.17.0
 + urllib3==2.5.0

❯ uv add &quot;types-boto3-ecr&gt;=1.40&quot;
Resolved 9 packages in 201ms
Prepared 1 package in 105ms
Installed 1 package in 2ms
 + types-boto3-ecr==1.40.0

❯ uv add --dev &quot;types-boto3[full]==1.40&quot;
Resolved 14 packages in 118ms
Prepared 5 packages in 810ms
Installed 5 packages in 86ms
 + botocore-stubs==1.38.46
 + types-awscrt==0.27.5
 + types-boto3==1.40.0
 + types-boto3-full==1.40.7
 + types-s3transfer==0.13.0

❯ uv venv
Using CPython 3.14.0rc1
Creating virtual environment at: .venv
Activate with: source .venv/bin/activate

❯ uv run --no-dev python -c 'import types_boto3_ecr'
Installed 8 packages in 25ms
</code></pre>
<p>Did you somehow corrupt your cache? Does <code>uv cache clean</code> help?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @charliermarsh on 2025-08-12 14:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-12 14:29</div>
            <div class="timeline-body"><p>Do you have example logs from <code>uv sync --frozen --no-dev</code> removing that package? There's no output of <code>uv sync</code> above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jaseemabid">@jaseemabid</a> on 2025-08-12 15:31</div>
            <div class="timeline-body"><p>@charliermarsh The example here doesn't show the package removed in logs but it's clearly breaking the next import.</p>
<p>Here is a complete session:</p>
<ol>
<li>Sync the packages.</li>
</ol>
<pre><code>❯ uv sync
Resolved 14 packages in 1ms
Installed 5 packages in 117ms
 + botocore-stubs==1.38.46
 + types-awscrt==0.27.5
 + types-boto3==1.40.0
 + types-boto3-full==1.40.7
 + types-s3transfer==0.13.0
</code></pre>
<ol start="2">
<li>Package import works.</li>
</ol>
<pre><code>❯ .venv/bin/python -c 'import types_boto3_ecr'
</code></pre>
<ol start="3">
<li>Sync again with <code>--no-dev</code>.</li>
</ol>
<pre><code>❯ uv sync --no-dev
Resolved 14 packages in 1ms
Uninstalled 5 packages in 400ms
 - botocore-stubs==1.38.46
 - types-awscrt==0.27.5
 - types-boto3==1.40.0
 - types-boto3-full==1.40.7
 - types-s3transfer==0.13.0
</code></pre>
<ol start="4">
<li>The logs don't mention removing <code>types-boto3-full</code> explicitly, but it's clearly gone now.</li>
</ol>
<pre><code>❯ .venv/bin/python -c 'import types_boto3_ecr'
Traceback (most recent call last):
  File &quot;&lt;string&gt;&quot;, line 1, in &lt;module&gt;
    import types_boto3_ecr
ModuleNotFoundError: No module named 'types_boto3_ecr'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-12 15:53</div>
            <div class="timeline-body"><p>Thanks. The problem is that <code>types-boto3-full</code> overlaps with <code>types-boto3-ecr</code>. It's a superset of that package, and includes the same contents. So when <code>types-boto3-full</code> gets uninstalled, it removes the <code>types_boto3_ecr</code> module (since that's listed in the <code>RECORD</code> file), but it doesn't appear as uninstalled to any installers, because <code>types_boto3_ecr-1.40.0.dist-info</code> still exists.</p>
<p>I don't really know what we can do here -- it's kind of a natural fallout of how they've designed these packages, and isn't really specific to uv. You can see the exact same behavior with pip:</p>
<pre><code>❯ python -m venv .venv
❯ .venv/bin/pip install types-boto3-ecr
❯ .venv/bin/pip install types-boto3-full
❯ .venv/bin/pip uninstall types-boto3-full
❯ .venv/bin/python -c 'import types_boto3_ecr'
Traceback (most recent call last):
  File &quot;&lt;string&gt;&quot;, line 1, in &lt;module&gt;
    import types_boto3_ecr
ModuleNotFoundError: No module named 'types_boto3_ecr'
</code></pre>
<p>Even reinstalling won't help, because the package appears to be installed:</p>
<pre><code>❯ .venv/bin/pip install types-boto3-ecr
Requirement already satisfied: types-boto3-ecr in ./.venv/lib/python3.14/site-packages (1.40.0)
❯ .venv/bin/python -c 'import types_boto3_ecr'
Traceback (most recent call last):
  File &quot;&lt;string&gt;&quot;, line 1, in &lt;module&gt;
    import types_boto3_ecr
ModuleNotFoundError: No module named 'types_boto3_ecr'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> removed by @charliermarsh on 2025-08-12 15:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-12 16:01</div>
            <div class="timeline-body"><p>It would be nice if we could either (1) detect incomplete installs or (2) avoid removing those files when they're referenced in another <code>RECORD</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jaseemabid">@jaseemabid</a> on 2025-08-12 16:28</div>
            <div class="timeline-body"><p>@charliermarsh Thanks, that makes sense. It took me a while to wrap my head around <code>RECORD</code> and how things can be deps but not shown in <code>uv tree</code> output. I'll go read up more on the details of it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-12 16:29</div>
            <div class="timeline-body"><p>Yeah, I think <code>types-boto3-ecr</code> isn't formally a dependency of <code>types-boto3-full</code> -- <code>types-boto3-full</code> just includes verbatim the <code>types_boto3_ecr</code> module, so it doesn't get tracked as a dependency, it just gets &quot;inlined&quot;, so-to-speak.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jaseemabid">@jaseemabid</a> on 2025-08-12 16:30</div>
            <div class="timeline-body"><p>@charliermarsh Also what workaround would you suggest so that uv would make sure that uv won't remove the package from runtime deps?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-12 16:38</div>
            <div class="timeline-body"><p>I think the most robust thing, which is obviously not ideal, would be remove the <code>types-boto3-full</code> dependency and replace it with the enumerated packages that you need (like <code>types-boto3-ecr</code>, <code>types-boto3-billing</code>, etc.). Then uv would be able to track them correctly. Otherwise, I <em>think</em> you'd have to do something like <code>uv sync --reinstall-package types-boto3-ecr</code> to force uv to reinstall it and ignore the existing <code>.dist-info</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jaseemabid">@jaseemabid</a> on 2025-08-12 16:53</div>
            <div class="timeline-body"><p>Gotcha.</p>
<p>I understand this is a pretty odd edge case and I'll figure out a solution locally.</p>
<p>In the long run it would be great if UV can infer these deps even if packages do silly crimes under the hood.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-12 16:54</div>
            <div class="timeline-body"><p>I agree. Let's leave this open. (I may tweak the title.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "`uv sync --frozen --no-dev` incorrectly removes runtime dependencies" to "`uv sync` removes necessary dependencies when two packages include the same module" by @charliermarsh on 2025-08-12 16:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/15239.html">astral-sh/uv#15239</a> on 2025-08-13 14:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/13437.html">astral-sh/uv#13437</a> on 2025-08-18 07:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/15357.html">astral-sh/uv#15357</a> on 2025-08-18 16:36</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:33:11 UTC
    </footer>
</body>
</html>
