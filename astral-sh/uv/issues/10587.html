<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv run with a prefixed command - astral-sh/uv #10587</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv run with a prefixed command</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/10587">#10587</a>
        opened by <a href="https://github.com/codefromthecrypt">@codefromthecrypt</a>
        on 2025-01-14 09:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/codefromthecrypt">@codefromthecrypt</a></div>
            <div class="timeline-body"><p>I have a script like below, and I run it like this <code>uv run -q --env-file .env chat.py</code></p>
<pre><code># /// script
# dependencies = [&quot;openai&quot;]
# ///

import os

import openai

CHAT_MODEL = os.environ[&quot;CHAT_MODEL&quot;]


def main():
    client = openai.Client()

    messages = [
        {
            &quot;role&quot;: &quot;user&quot;,
            &quot;content&quot;: &quot;Answer in up to 3 words: Which ocean contains Bouvet Island?&quot;,
        }
    ]

    chat_completion = client.chat.completions.create(model=CHAT_MODEL, messages=messages)
    print(chat_completion.choices[0].message.content)


if __name__ == &quot;__main__&quot;:
    main()
</code></pre>
<p>I would like to use comment syntax to run it via <code>opentelemetry-instrument</code>, which is installed as a part of the dependency <a href="https://pypi.org/project/elastic-opentelemetry/">elastic-opentelemetry</a>. I would prefer to handle that inside the <code>/// script</code> stanza instead of making a separate file to configure it. Basically I want <code>uv</code> to manage the env and installing the dep, then invoke <code>opentelemetry-instrument python chat.py</code> somehow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-14 13:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-14 13:44</div>
            <div class="timeline-body"><p>I think this is a bit specific to <code>opentelemetry-instrument</code>, so I don&#x27;t know that we&#x27;ll be able to solve it here. Do they offer an API to use it as a library, rather than via the CLI?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codefromthecrypt">@codefromthecrypt</a> on 2025-01-15 03:52</div>
            <div class="timeline-body"><p>Thanks, @charliermarsh. Indeed it would be similar to dotenv etc that have a lib alternative (though I don&#x27;t need dotenv as uv has the features; )</p>
<p>I tried to run it as a library and so far no good (vs requirements.txt)</p>
<pre><code># /// script
# dependencies = [
#   &quot;openai&quot;,
#   &quot;elastic-opentelemetry&quot;,
#   &quot;elastic-opentelemetry-instrumentation-openai&quot;
# ]
# ///

from opentelemetry.instrumentation.auto_instrumentation.sitecustomize import initialize

initialize()

import os

import openai

CHAT_MODEL = os.environ[&quot;CHAT_MODEL&quot;]


def main():
    client = openai.Client()

    messages = [
        {
            &quot;role&quot;: &quot;user&quot;,
            &quot;content&quot;: &quot;Answer in up to 3 words: Which ocean contains Bouvet Island?&quot;,
        }
    ]

    chat_completion = client.chat.completions.create(model=CHAT_MODEL, messages=messages)
    print(chat_completion.choices[0].message.content)


if __name__ == &quot;__main__&quot;:
    main()
</code></pre>
<p>Then, try to run this way..</p>
<pre><code>$ uv run -q --env-file .env ../chat.py
Traceback (most recent call last):
  File &quot;/Users/adriancole/oss/otel-ollama/examples/platform/vllm/../chat.py&quot;, line 9, in &lt;module&gt;
    from opentelemetry.instrumentation.auto_instrumentation.sitecustomize import initialize
  File &quot;/Users/adriancole/.cache/uv/archive-v0/TgKyz8U0Fs6gFbZqueytY/lib/python3.12/site-packages/opentelemetry/instrumentation/auto_instrumentation/sitecustomize.py&quot;, line 44, in &lt;module&gt;
    initialize()
  File &quot;/Users/adriancole/.cache/uv/archive-v0/TgKyz8U0Fs6gFbZqueytY/lib/python3.12/site-packages/opentelemetry/instrumentation/auto_instrumentation/sitecustomize.py&quot;, line 32, in initialize
    environ[&quot;PYTHONPATH&quot;], dirname(abspath(__file__)), pathsep
    ~~~~~~~^^^^^^^^^^^^^^
  File &quot;&lt;frozen os&gt;&quot;, line 714, in __getitem__
KeyError: &#x27;PYTHONPATH&#x27;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codefromthecrypt">@codefromthecrypt</a> on 2025-01-15 05:41</div>
            <div class="timeline-body"><p>@charliermarsh I notice that uv sets <code>VIRTUAL_ENV</code> when running scripts. Any chance it can materialize a <code>PYTHONPATH</code> var?</p>
<p>Right now, I can get it to work, but I have to materialize it manually like this:</p>
<pre><code>virtual_env = os.environ.get(&#x27;VIRTUAL_ENV&#x27;)

site_packages_path = os.path.join(virtual_env, &#x27;lib&#x27;, f&#x27;python{os.sys.version_info.major}.{os.sys.version_info.minor}&#x27;,
                                  &#x27;site-packages&#x27;)

# Set the PYTHONPATH environment variable
os.environ[&#x27;PYTHONPATH&#x27;] = site_packages_path
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:36:40 UTC
    </footer>
</body>
</html>
