<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv sync --no-source` breaking from 0.4 - astral-sh/uv #7572</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`uv sync --no-source` breaking from 0.4</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/7572">#7572</a>
        opened by <a href="https://github.com/lambda-science">@lambda-science</a>
        on 2024-09-20 07:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/lambda-science">@lambda-science</a> on 2024-09-20 07:47</div>
            <div class="timeline-body"><p>Hello,</p>
<p>My basic TOML:</p>
<pre><code class="language-toml">[project]
name = &quot;pythia-streamlit&quot;
version = &quot;0.4.0&quot;
dependencies = [
    &quot;numpy&quot;,
    &quot;pythia-client&gt;=0.6.3&quot;,
]
requires-python = &quot;&gt;=3.12&quot;

[tool.uv.sources]
pythia-client = { workspace = true }

[tool.uv.workspace]
members = [
    &quot;../pythia-client&quot;
]
</code></pre>
<p>In UV 0.3.5 this worked for me:</p>
<pre><code class="language-docker">COPY --from=ghcr.io/astral-sh/uv:0.3.5 /uv /bin/uv
ENV UV_COMPILE_BYTECODE=1
ENV UV_NO_CACHE=1
ENV PATH=&quot;/code/.venv/bin:$PATH&quot;
# Install dependencies
WORKDIR /code
COPY pyproject.toml /code/
RUN uv sync --no-install-project --no-sources
</code></pre>
<p><code>docker build .</code>
Output: <code>[+] Building FINISHED </code></p>
<p>In UV 0.4.13 it doesn't work anymore:</p>
<pre><code class="language-docker">COPY --from=ghcr.io/astral-sh/uv:0.4.13 /uv /bin/uv
ENV UV_COMPILE_BYTECODE=1
ENV UV_NO_CACHE=1
ENV PATH=&quot;/code/.venv/bin:$PATH&quot;
# Install dependencies
WORKDIR /code
COPY pyproject.toml /code/
RUN uv sync --no-install-project --no-sources
</code></pre>
<p>Output:</p>
<pre><code class="language-docker"> =&gt; ERROR [stage-0 6/8] RUN uv sync --no-install-project --no-sources                                                                                                                                                                              0.7s 
------
 &gt; [stage-0 6/8] RUN uv sync --no-install-project --no-sources:
0.613 Using Python 3.12.6 interpreter at: /usr/local/bin/python3
0.613 Creating virtual environment at: .venv
0.620 error: Failed to build: `pythia-streamlit @ file:///code`
0.620   Caused by: Failed to parse entry for: `pythia-client`
0.620   Caused by: Package is not included as workspace package in `tool.uv.workspace`
------
Dockerfile:18
--------------------
  16 |     WORKDIR /code
  17 |     COPY pyproject.toml /code/
  18 | &gt;&gt;&gt; RUN uv sync --no-install-project --no-sources
  19 |
  20 |     COPY src/pythia_streamlit /code/pythia_streamlit
--------------------
ERROR: failed to solve: process &quot;/bin/sh -c uv sync --no-install-project --no-sources&quot; did not complete successfully: exit code: 2
</code></pre>
<p>My setup is a workspace with 3 parts: two app (<code>pythia-streamlit</code>, <code>pythia-api</code>) and a python package (<code>pythia-client</code>). The Dockerfile snippet is coming from production image where I want to install <code>pythia-client</code> from Pypi. In local developement environnement I remove the <code>--no-sources</code> to install from local folder (from parent directory).</p>
<p>The update from 0.4 broke by CI/CD pipeline, because the image would not build anymore due to the error above.
Any idea why ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-09-20 14:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-20 14:15</div>
            <div class="timeline-body"><p>Hmm... I guess we should allow this when running with <code>--no-sources</code>? \cc @zanieb @konstin</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @charliermarsh on 2024-09-20 14:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-09-20 15:47</div>
            <div class="timeline-body"><p>This is a complicated one, because <code>--no-sources</code> should take the package from pypi (behaving as if it were a published package), so in this case, we should re-lock with the pypi version of the dep?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-20 18:17</div>
            <div class="timeline-body"><p>Yeah this seems like a bug? We should not be trying to use the source entry from the lockfile when <code>--no-sources</code> is provided right? Roughly agree with what @konstin is saying.</p>
<p>At the very least, the error message is horrible. What's the suggestion if we were to keep the existing behavior and just improve the error? To run<code> uv lock --no-sources</code> first?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-20 18:21</div>
            <div class="timeline-body"><p>I think there's a bug because we shouldn't even be trying to resolve the sources here (which is where the failure happens).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> removed by @charliermarsh on 2024-09-20 18:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-09-20 18:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/7599.html">astral-sh/uv#7599</a> on 2024-09-20 18:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-09-20 19:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-09-20 19:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gita-unlearn">@gita-unlearn</a> on 2024-09-23 23:52</div>
            <div class="timeline-body"><p>@charliermarsh
Im on <code>uv 0.4.15</code> and I am having the same problem</p>
<pre><code>0.445 error: Failed to build: `gita-current_package` @ file:///opt/dagster/dagster_home/gita-current_package`
0.446   Caused by: Failed to parse entry for: `gita-package1`
0.446   Caused by: Package is not included as workspace package in `tool.uv.workspace`
------

 2 warnings found (use docker --debug to expand):
 - FromAsCasing: 'as' and 'FROM' keywords' casing do not match (line 4)
 - FromAsCasing: 'as' and 'FROM' keywords' casing do not match (line 31)
Dockerfile.backend:40
--------------------
  38 |     RUN uv sync --no-sources --python 3.11 --extra-index-url https://${PRIVATE_PYPI}
  39 |     
  40 | &gt;&gt;&gt; RUN uv run pip install --no-cache-dir dagster-cloud
</code></pre>
<p>Weirdly the uv sync works, it is when it goes to the next RUN command that it fails</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-23 23:55</div>
            <div class="timeline-body"><p>You'd have to pass <code>--no-sources</code> to each command (<code>uv run --no-sources</code>). We do not store sync &quot;state&quot; across commands.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gita-unlearn">@gita-unlearn</a> on 2024-09-23 23:57</div>
            <div class="timeline-body"><p>ah okay, thank you for the quick reply &lt;3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/7945.html">astral-sh/uv#7945</a> on 2025-06-26 01:17</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:53 UTC
    </footer>
</body>
</html>
