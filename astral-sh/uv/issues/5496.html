<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>shared uv cache: `metadata.msgpack` gets too restrictive perms for `built-wheels` - astral-sh/uv #5496</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>shared uv cache: <code>metadata.msgpack</code> gets too restrictive perms for <code>built-wheels</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/5496">#5496</a>
        opened by <a href="https://github.com/stas00">@stas00</a>
        on 2024-07-26 23:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/stas00">@stas00</a> on 2024-07-26 23:14</div>
            <div class="timeline-body"><p>we use a shared pip/uv cache and have to use a <code>umask</code> for it to work. But we end up with files that prevent sharing.</p>
<pre><code>umask 000
uv pip install deepspeed
</code></pre>
<p>w/ <code>uv==0.2.15</code> results in:</p>
<pre><code>-rw------- 1 stas  stas  3.2K Jul 26 22:56  /data/env/cache/uv/built-wheels-v3/pypi/deepspeed/0.14.4/ot_dfLaltQTYsvOYBuYLl/metadata.msgpack
</code></pre>
<p>w/ <code>uv==0.2.30</code> things improve:</p>
<pre><code>-rw-r--r-- 1 stas  stas  3.2K Jul 26 22:56  /data/env/cache/uv/built-wheels-v3/pypi/deepspeed/0.14.4/ot_dfLaltQTYsvOYBuYLl/metadata.msgpack
</code></pre>
<p>but we are still not there. To work correctly it should be:</p>
<pre><code>-rw-rw-rw- 1 stas  stas  3.2K Jul 26 22:56  /data/env/cache/uv/built-wheels-v3/pypi/deepspeed/0.14.4/ot_dfLaltQTYsvOYBuYLl/metadata.msgpack
</code></pre>
<p>As I have dealt with this issue with other packages, usually the culprit is the use of <code>tempfile</code> facility, where things are done on <code>/tmp</code> and then moved to the target dir but the perms are wrong - as <code>tempfile</code> disregards <code>umask</code>. So usually the fix is to identify where that file gets moved and restore its perms according to <code>umask</code> setting. I don't know if that's the case with <code>uv</code>.</p>
<p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-26 23:41</div>
            <div class="timeline-body"><p>I can look into this, but isn't umask exclusively used to <em>remove</em> permissions? And a umask of <code>000</code> would have no effect? I may be misunderstanding.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-26 23:49</div>
            <div class="timeline-body"><p>I think the issue is just that we aren't creating with the correct default permissions. I'm not sure that the umask itself is relevant though?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stas00">@stas00</a> on 2024-07-26 23:54</div>
            <div class="timeline-body"><p>It sounds like you're correct, @charliermarsh</p>
<p>It's just usually once a file is created by <code>tempfile</code> it ends up having more restrictive perms than it should be, as is the case with <code>uv==0.2.15</code> exemplification in the OP. That's why I usually suspect <code>tempfile</code> use as the cause of the issue.</p>
<p>So your observation sounds correct and yes, you need to have <code>0666</code> perms by default.</p>
<p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "umask isn't being respected for built-wheels" to "shared uv cache: `metadata.msgpack` gets too restrictive perms for `built-wheels`" by @stas00 on 2024-07-26 23:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-26 23:55</div>
            <div class="timeline-body"><p>Yeah, this sounds right to me. It's funny because this came up recently in #5457 (but never before).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stas00">@stas00</a> on 2024-07-26 23:56</div>
            <div class="timeline-body"><p>I edited the title / the OP to reflect your corrections, @charliermarsh</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stas00">@stas00</a> on 2024-07-26 23:58</div>
            <div class="timeline-body"><blockquote>
<p>Yeah, this sounds right to me. It's funny because this came up recently in https://github.com/astral-sh/uv/pull/5457</p>
</blockquote>
<p>Ah that explains the update from <code>-rw-------</code> to <code>-rw-r--r--</code> in <code>uv==0.2.30</code></p>
<blockquote>
<p>(but never before)</p>
</blockquote>
<p>More people discover this gem and start using it, so you get more use cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stas00">@stas00</a> on 2024-07-26 23:59</div>
            <div class="timeline-body"><p>And I see from PR that indeed you're using tempfile, which is almost always the cause of this issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-26 23:59</div>
            <div class="timeline-body"><p>For some reason I changed it to 644 rather than 666. I don't know why I did that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stas00">@stas00</a> on 2024-07-27 00:01</div>
            <div class="timeline-body"><p>may be it'd be good to add a comment, like:</p>
<blockquote>
<p>0666 to support shared cache setups</p>
</blockquote>
<p>so someone else won't undo it later, since 0644 is quite common and 0666 is an odd ball (only shared envs).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-27 00:06</div>
            <div class="timeline-body"><p>üëç I'm pretty sure 0666 is the correct default (and I found it in the Rust source too). It's just that the default umask (at least for me) is 022, which results in 0644... I think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-07-27 00:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stas00">@stas00</a> on 2024-07-27 00:09</div>
            <div class="timeline-body"><p>That's correct, that's how most Unix boxes are setup <code>022</code> and if the user and group are the same then <code>002</code>.</p>
<p>But in order to be able to share files and everybody write to them <code>0000</code> is needed :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-27 00:10</div>
            <div class="timeline-body"><p>üëç Thanks for pointing this out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stas00">@stas00</a> on 2024-07-27 00:18</div>
            <div class="timeline-body"><p>I tried to validate the fix, but I am not able to install from <code>main</code>:</p>
<pre><code>uv pip install git+https://github.com/astral-sh/uv.git@main
 Updated https://github.com/astral-sh/uv.git (4f3dde34)
error: The project is marked as unmanaged: `/data/env/cache/uv/git-v0/checkouts/5d8dbe36cd6ea14f/4f3dde34`
</code></pre>
<p>I then went back to normal pip and it actually told me what the problem is:</p>
<pre><code>pip install git+https://github.com/astral-sh/uv.git@main
Collecting git+https://github.com/astral-sh/uv.git@main
  Cloning https://github.com/astral-sh/uv.git (to revision main) to /var/tmp/pip-req-build-5hbguc0e
  Running command git clone --filter=blob:none --quiet https://github.com/astral-sh/uv.git /var/tmp/pip-req-build-5hbguc0e
  Resolved https://github.com/astral-sh/uv.git to commit 4f3dde34dc7959d697a70bb420fcae687518e11f
  Installing build dependencies ... done
  Getting requirements to build wheel ... done
  Preparing metadata (pyproject.toml) ... error
  error: subprocess-exited-with-error

  √ó Preparing metadata (pyproject.toml) did not run successfully.
  ‚îÇ exit code: 1
  ‚ï∞‚îÄ&gt; [6 lines of output]

      Cargo, the Rust package manager, is not installed or is not on PATH.
      This package requires Rust and Cargo to compile extensions. Install it through
      the system's package manager or via https://rustup.rs/

      Checking for Rust toolchain....
      [end of output]

  note: This error originates from a subprocess, and is likely not a problem with pip.
error: metadata-generation-failed

√ó Encountered error while generating package metadata.
‚ï∞‚îÄ&gt; See above for output.

note: This is an issue with the package mentioned above, not pip.
hint: See above for details.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stas00">@stas00</a> on 2024-07-27 00:26</div>
            <div class="timeline-body"><p>and after <code>apt install rustc cargo</code>, my Ubuntu has <code>rustc-1.76</code> as the highest, but <code>uv</code> builder wants 1.77 or higher, so will have to wait till the next release to validate.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:30:36 UTC
    </footer>
</body>
</html>
