<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Is there a way to specify that you don't care about pypy when creating a lockfile? - astral-sh/uv #9473</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Is there a way to specify that you don't care about pypy when creating a lockfile?</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/9473">#9473</a>
        opened by <a href="https://github.com/wlach">@wlach</a>
        on 2024-11-27 15:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/wlach">@wlach</a> on 2024-11-27 15:25</div>
            <div class="timeline-body"><p>Consider this pyproject.toml:</p>
<pre><code class="language-toml">[project]
name = &quot;test-clickhouse-driver&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.11&quot;
dependencies = [
    &quot;databricks-sql-connector==3.6.0&quot;,
    &quot;clickhouse-driver[lz4]==0.2.9&quot;,
]
</code></pre>
<p>These dependencies are mutually compatible using regular cpython, but not with pypy because <code>clickhouse-driver[lz4]</code> specifies that you need an older version of <code>lz4</code> (that's incompatible with <code>databricks-sql-connector</code>) on that platform:</p>
<p>https://github.com/mymarilyn/clickhouse-driver/blob/8a4e7c5b99b532df2b015651d893a6f36288a22c/setup.py#L131</p>
<p>Thus running <code>uv sync</code> fails:</p>
<pre><code>❯ uv sync
Using CPython 3.11.9 interpreter at: /Users/wlach/.local/share/mise/installs/python/3.11/bin/python3.11
Creating virtual environment at: .venv
  × No solution found when resolving dependencies for split
  │ (implementation_name == 'pypy'):
  ╰─▶ Because only the following versions of lz4{implementation_name ==
      'pypy'} are available:
          lz4{implementation_name == 'pypy'}==0.1
          lz4{implementation_name == 'pypy'}==0.2
          ...
          lz4{implementation_name == 'pypy'}&gt;=3.0.1
      and databricks-sql-connector==3.6.0 depends on lz4&gt;=4.0.2,
      we can conclude that databricks-sql-connector==3.6.0 and
      lz4{implementation_name == 'pypy'}&lt;=3.0.1 are incompatible.
      And because clickhouse-driver[lz4]==0.2.9 depends on
      lz4{implementation_name == 'pypy'}&lt;=3.0.1, we can conclude that
      databricks-sql-connector==3.6.0 and clickhouse-driver[lz4]==0.2.9 are
      incompatible.
      And because your project depends on clickhouse-driver[lz4]==0.2.9 and
      databricks-sql-connector==3.6.0, we can conclude that your project's
      requirements are unsatisfiable.
</code></pre>
<p>Locally we can workaround this by adding <code>;implementation_name != 'pypy'</code> to the clickhouse driver specification:</p>
<pre><code>[project]
name = &quot;test-clickhouse-driver&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.11&quot;
dependencies = [
    &quot;databricks-sql-connector==3.6.0&quot;,
    &quot;clickhouse-driver[lz4]==0.2.9;implementation_name != 'pypy'&quot;,
]
</code></pre>
<p>However that doesn't help if one of your dependencies is also depending on the generic <code>clickhouse-driver[lz4]</code>. Is there any way I can say that I just don't care about pypy when creating a uv lockfile? I know they're supposed to be cross-platform/implementation but for our use cases at least we don't really need this guarantee.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-27 15:30</div>
            <div class="timeline-body"><p>Does a <a href="https://docs.astral.sh/uv/concepts/projects/config/#limited-resolution-environments">limited resolution environment</a> work for you?</p>
<p>I think it'd be</p>
<pre><code class="language-toml">[tool.uv]
environments = [
    &quot;implementation_name != 'pypy'&quot;
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-27 15:32</div>
            <div class="timeline-body"><p>You can also use <a href="https://docs.astral.sh/uv/concepts/resolution/#dependency-overrides">dependency overrides</a> to override a transitive dependency</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2024-11-27 15:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">great writeup</span> added by @zanieb on 2024-11-27 15:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wlach">@wlach</a> on 2024-11-27 15:35</div>
            <div class="timeline-body"><blockquote>
<p>Does a <a href="https://docs.astral.sh/uv/concepts/projects/config/#limited-resolution-environments">limited resolution environment</a> work for you?</p>
<p>I think it'd be</p>
<p>[tool.uv]
environments = [
&quot;implementation_name != 'pypy'&quot;
]</p>
</blockquote>
<p>Yes! That was exactly what I was looking for. Might make sense to mention pypy there as well?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/9475.html">astral-sh/uv#9475</a> on 2024-11-27 15:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-11-27 15:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-11-27 15:53</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:24 UTC
    </footer>
</body>
</html>
