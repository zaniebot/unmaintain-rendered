<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiple OpenMP versions cause segfault - astral-sh/uv #16072</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Multiple OpenMP versions cause segfault</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/16072">#16072</a>
        opened by <a href="https://github.com/anstadnik">@anstadnik</a>
        on 2025-09-30 10:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/anstadnik">@anstadnik</a> on 2025-09-30 10:46</div>
            <div class="timeline-body"><h3>Question</h3>
<p>When I install <code>pycolmap</code> and <code>torch</code> using uv on mac os, and run:</p>
<pre><code class="language-python">import pycolmap
from torch import nn
</code></pre>
<p>I get a segfault, which is caused by multiple openmp versions running simultaneously.
It can be suppressed (for example, sklearn does it <a href="https://github.com/scikit-learn/scikit-learn/blob/e891db8003c2e7b14f7f4e314958e31fbdc6ccc5/sklearn/__init__.py#L48-L56">link</a>), but that only suppresses the error. AFAIK, OpenMP uses some weird global shared state, and doesn't support multiple versions running at the same time.
Conda solves this issue by forcing all wheels have the same version <a href="https://conda-forge.org/docs/maintainer/knowledge_base/#openmp">link</a>.
Which would be the correct approach to solving this issue? I can rewrite dylibs to point to a single (homebrew) openMP, but that sounds like a terrible solution. I can suppress the error, and hope nothing breaks, and that there won't be concurrent runs of openmp. I can compile libs myself.
All of those solutions sound wrong, I hope that you can give me a more professional view on the problem as you have a lot more knowledge in those types of issues.</p>
<h3>Platform</h3>
<p>Darwin 25.1.0 arm64</p>
<h3>Version</h3>
<p>uv 0.8.22 (Homebrew 2025-09-23)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @anstadnik on 2025-09-30 10:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-09-30 10:51</div>
            <div class="timeline-body"><p>Unfortunately, I don't think there's a good solution for this atm, as Python packaging currently can't inspect compiled into wheels such as OpenMP.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/geofft">@geofft</a> on 2025-09-30 13:43</div>
            <div class="timeline-body"><p>Some background on this over at the excellent pypackaging-native site:</p>
<ul>
<li>https://pypackaging-native.github.io/key-issues/native-dependencies/blas_openmp/</li>
<li>https://pypackaging-native.github.io/key-issues/abi/</li>
</ul>
<p>I think at this point there's community consensus that this is a real problem but not yet consensus on how to solve it. It's not something that can be <em>solved</em> in uv itself, in that even if it did inspect the wheels, the most uv could do you &quot;Sorry, this combination isn't going to work, you need to compile something from source.&quot; You need actual builds of the two wheels that use the same OpenMP library. The conda ecosystem is in a better position to be able to make that happen because they do the builds, but wheels on PyPI are built by each individual project.</p>
<p>So one option is to ask the colmap project if they could build differently in a way that is compatible with PyTorch (or vice versa), but maybe they're doing it this way for a reason. (Or maybe they're willing to release multiple wheels, one with a built-in OpenMP and one that expects to be imported in an environment where torch is already imported, or something.)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 03:17:45 UTC
    </footer>
</body>
</html>
