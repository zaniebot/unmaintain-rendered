<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Locking of build dependencies - astral-sh/uv #5190</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Locking of build dependencies</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/5190">#5190</a>
        opened by <a href="https://github.com/sbidoul">@sbidoul</a>
        on 2024-07-18 15:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/sbidoul">@sbidoul</a> on 2024-07-18 15:55</div>
            <div class="timeline-body"><p>Coming from https://github.com/astral-sh/uv/issues/3611#issuecomment-2226921962 and following comments.</p>
<p>Caveat: this is certainly not a complete proposal, and I reckon I have not investigated the capabilities of uv lock/sync in any detail, so consider this as thoughts to start the conversation on the usefulness of such features.</p>
<p><strong>What</strong></p>
<p>The <code>uv.lock</code> format supports locking source distributions (from sdists, git source trees, ...). This is great!</p>
<p>I would find it useful that</p>
<ul>
<li>commands that install from a lock file fail (by default?) if they need to install build dependencies that are not locked</li>
<li>the lock command grows a mean to lock the build system requirements of the source dependencies declared in the lock file it produces</li>
</ul>
<p><strong>Why</strong></p>
<p>When installing from a lock file I expect that everything that the installation downloads (or obtains from cache) is checked against the hashes (or immutable VCS commit hashes) that are present in the lock file, for repeatability and security.</p>
<p>If, during installation, other artifacts are downloaded (or obtained from cache) without my knowledge (to build source distributions), the security and repeatability of the process is weakened.</p>
<p><strong>Some thoughts</strong></p>
<ul>
<li>this may have performance implications for the lock command if sdists have to be downloaded to know the build requirements (https://github.com/astral-sh/uv/issues/3611#issuecomment-2226993337)</li>
<li>some build dependencies are dynamic (<code>get_requires_for_build_{wheel,editable}</code>), further complicating the locking operation</li>
<li>different locked source distributions may require different versions of the same build dependency</li>
<li>a first valuable step could be to lock build dependencies for which no wheel is available, and warn when an artifact that is not locked is downloaded when syncing</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @charliermarsh on 2024-07-19 01:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2024-07-21 16:17</div>
            <div class="timeline-body"><p>I was going to raise this same issue as well. Currently <code>build-system.requires</code> is completely unconstrained/unconstrainable and this is causing problems with build reproducibility.</p>
<p>This is causing real-life inconveniences in our organisation as, for example, new versions of <code>setuptools</code> appear but are not yet given the all-clear by our scanning suite. Versions that are not cleared yield a HTTP 403 upon download. The end result is a de-facto intractable state where no one can build (or even editably install) packages. (unless the developer decides to hard-constrain @ <code>pyproject.toml</code>, which is terrible UX and also doesn't help with the dependency-on-sdist problem.)</p>
<p>(I will probably also raise a separate issue w.r.t the handling of 403 codes -- this is a pain point with <code>pip</code> and it would be awesome if <code>uv</code> could do better)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-28 00:35</div>
            <div class="timeline-body"><p>Definitely agree that we should do this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/5551.html">astral-sh/uv#5551</a> on 2024-07-29 09:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/5639.html">astral-sh/uv#5639</a> on 2024-08-01 19:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-10 00:06</div>
            <div class="timeline-body"><p>I really want to do this (lock the build requirements).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../astral-sh/python-build-standalone/issues/300.html">astral-sh/python-build-standalone#300</a> on 2024-09-10 08:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../pyproject-nix/pyproject.nix/issues/169.html">pyproject-nix/pyproject.nix#169</a> on 2024-11-01 00:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../pyproject-nix/uv2nix/pulls/44.html">pyproject-nix/uv2nix#44</a> on 2024-11-01 11:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vlad-ivanov-name">@vlad-ivanov-name</a> on 2024-11-15 07:10</div>
            <div class="timeline-body"><p>This is becoming more relevant with newer python versions that don't ship setuptools by default anymore</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-15 14:01</div>
            <div class="timeline-body"><p>I really want to do this and would like to spend time on it personally, but I'm worried about how it will intersect with PEP 751.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vlad-ivanov-name">@vlad-ivanov-name</a> on 2024-11-15 14:09</div>
            <div class="timeline-body"><p>Hmm but that's more about lockfiles in general, not specific to build-time deps?</p>
<p>Correct me if I'm wrong but to me this PEP looks to be in early stages, and uv.lock looks way more mature as it is now. I would expect the introduction of this PEP to be orthogonal to the goal of being able to lock build dependencies - in the end if uv does decide to adopt the format, the build dependency group will probably be locked in a similar way to other dependency groups regardless of the final lock file format</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-11-15 14:34</div>
            <div class="timeline-body"><blockquote>
<p>I really want to do this and would like to spend time on it personally, but I'm worried about how it will intersect with PEP 751.</p>
</blockquote>
<p>Last I saw build time dependencies were dropped from PEP 751: https://discuss.python.org/t/pep-751-lock-files-again/59173/222 (end of that post).</p>
<p>I don't think anything changed: https://peps.python.org/pep-0751/#locking-build-requirements-for-sdists (FYI I really hope the &quot;it confused enough people &quot; isn't directed at me, I had some clarifying questions, and was mostly happy with the answers).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-15 16:50</div>
            <div class="timeline-body"><p>@notatallshaw -- No, I agree with you, it's just that: if we add support for it here, what happens if PEP 751 comes out and we can't translate that support to the PEP?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bluss">@bluss</a> on 2024-11-15 17:12</div>
            <div class="timeline-body"><p>Could you use the space for tool specific data in the PEP 751 lock file? Or even using one of the main fields like <code>groups</code> using some kind of convention that makes it possible for locked build deps to co-exist with other named things stored there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-11-15 17:12</div>
            <div class="timeline-body"><p>Yeah, makes sense to see the finalized version of PEP 751 first.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vlad-ivanov-name">@vlad-ivanov-name</a> on 2024-11-16 00:12</div>
            <div class="timeline-body"><blockquote>
<p>what happens if PEP 751 comes out and we can't translate that support to the PEP?</p>
</blockquote>
<p>I mean, this wouldn't be the first feature that uv supports that vanilla python tooling doesn't. This is important enough to implement regardless of what python itself does; after all, even locking of regular dependencies is not really supported out of the box, doesn't mean that uv should be restricted by that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dimbleby">@dimbleby</a> on 2024-11-19 19:20</div>
            <div class="timeline-body"><p>similar proposals in poetry, pdm: https://github.com/python-poetry/poetry/issues/8261 (and several duplicates), https://github.com/pdm-project/pdm/issues/2465</p>
<p>I mostly think that people who care about reproducible builds would be better served by avoiding sdists altogether with <code>--only-binary</code> or similar.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/10233.html">astral-sh/uv#10233</a> on 2025-01-03 12:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/giftig">@giftig</a> on 2025-03-24 16:40</div>
            <div class="timeline-body"><p>+1 for this; I've just had an existing, locked dependency fail to install because a new version of <code>setuptools</code> refuses to install dependencies using deprecated <code>description-file</code> syntax in <code>setup.cfg</code>, which is confusing and slightly frustrating (though not the fault of <code>uv</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sbidoul">@sbidoul</a> on 2025-03-24 17:32</div>
            <div class="timeline-body"><p>Yep, to me this would be the killer feature to switch to <code>uv.lock</code>.</p>
<p>Build contraints help but they'd need to be managed manually, won't work if there are conflicting build constraints in the project, and it's easy to forget a build constraint, which you only realize months or years later when a build fails.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/purepani">@purepani</a> on 2025-04-01 01:04</div>
            <div class="timeline-body"><p>Since PEP 751 is now accepted, and the resulting lock file isn't immediately usable for <code>uv</code> as a project lock file, perhaps it makes sense to add this as a <code>uv.lock</code> feature.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-04-01 01:37</div>
            <div class="timeline-body"><p>We're hoping to start working on this soon.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/7052.html">astral-sh/uv#7052</a> on 2025-04-01 12:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../pyca/cryptography/issues/11548.html">pyca/cryptography#11548</a> on 2025-04-29 00:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/13416.html">astral-sh/uv#13416</a> on 2025-05-13 02:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @Gankra by @zanieb on 2025-05-18 12:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/13798.html">astral-sh/uv#13798</a> on 2025-06-03 08:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../hermetoproject/pybuild-deps/issues/307.html">hermetoproject/pybuild-deps#307</a> on 2025-07-03 18:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../NixOS/nixpkgs/pulls/425219.html">NixOS/nixpkgs#425219</a> on 2025-08-02 16:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jiridanek">@jiridanek</a> on 2025-08-06 17:40</div>
            <div class="timeline-body"><blockquote>
<p>Build contraints help but they'd need to be managed manually, won't work if there are conflicting build constraints in the project, and it's easy to forget a build constraint, which you only realize months or years later when a build fails.</p>
</blockquote>
<p>Building with <code>--require-hashes</code> seems to be a decent check for a forgotten build constraint. With</p>
<pre><code>❯ uv --version
uv 0.8.5
</code></pre>
<p>I get, when I use <code>--build-constraints=./requirements.txt --no-binary=:all:</code></p>
<pre><code>❯ uv pip install --strict --no-deps --no-cache --no-config --no-progress --require-hashes --index-strategy=unsafe-best-match --requirements=./requirements.txt --build-constraints=./requirements.txt --no-binary=:all:
Using Python 3.12.11 environment at: pepa
Resolved 71 packages in 268ms
   Building nbclient==0.10.2
   Building ptyprocess==0.7.0
   Building typing-extensions==4.14.1
   Building jupyter-core==5.7.2
   Building tinycss2==1.4.0
  × Failed to download and build `nbclient==0.10.2`
  ├─▶ Failed to resolve requirements from `build-system.requires`
  ├─▶ No solution found when resolving: `hatchling&gt;=1.10.0`
  ╰─▶ In `--require-hashes` mode, all requirements must be pinned upfront with `==`, but found: `hatchling`
</code></pre>
<p>The above is actually a great inconvenience to me, but I see some may benefit from this behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @Gankra by @konstin on 2025-08-06 18:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/15146.html">astral-sh/uv#15146</a> on 2025-08-07 19:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bruno-fs">@bruno-fs</a> on 2025-08-08 02:40</div>
            <div class="timeline-body"><p>I find it a bit sad that new &quot;universal lockfile format&quot; from PEP 751 <a href="https://peps.python.org/pep-0751/#locking-build-requirements-for-sdists">won't support locking build requirements for sdists</a>, but I'm glad to hear uv is interested in solving this problem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../opendatahub-io/notebooks/issues/1882.html">opendatahub-io/notebooks#1882</a> on 2025-08-11 19:38</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:20 UTC
    </footer>
</body>
</html>
