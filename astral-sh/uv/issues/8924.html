<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weird resolution error with `uv==0.5.0` and unsatisfiable requirements - astral-sh/uv #8924</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Weird resolution error with `uv==0.5.0` and unsatisfiable requirements</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/8924">#8924</a>
        opened by <a href="https://github.com/jamesbraza">@jamesbraza</a>
        on 2024-11-08 07:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/jamesbraza">@jamesbraza</a> on 2024-11-08 07:49</div>
            <div class="timeline-body"><p>I have a situation where: package <code>b</code> depends on <code>a</code>, and <code>a</code> has <code>b</code> as an extra. Or more concretely, <code>a</code> = <a href="https://pypi.org/project/fhaviary/"><code>fhaviary</code></a> and <code>b</code> = <a href="https://pypi.org/project/paper-qa/"><code>paper-qa</code></a></p>
<p>This leads to a weird <code>uv sync</code> resolution error:</p>
<pre><code class="language-none">  Ã— No solution found when resolving dependencies for split
  â”‚ (python_full_version == '3.11.*' and platform_python_implementation ==
  â”‚ 'PyPy'):
  â•°â”€â–¶ Because only the following versions of paper-qa are available:
          paper-qa&lt;=5.0.0
          paper-qa==5.0.1
...
          paper-qa==5.3.1
          paper-qa==5.3.2
      and paper-qa==5.3.2 depends on fhaviary, we can conclude that
      paper-qa&gt;5.3.1 depends on fhaviary.
      And because paper-qa&gt;=5.0.0,&lt;=5.3.1 depends on fhaviary, we can conclude
      that paper-qa&gt;=5.0.0 depends on fhaviary.
      And because fhaviary[paperqa] depends on paper-qa&gt;=5 and your workspace
      requires fhaviary[paperqa], we can conclude that your workspace's
      requirements are unsatisfiable.

      hint: The package `paper-qa` depends on the package `fhaviary` but the
      name is shadowed by one of your workspace members. Consider changing the
      name of the workspace member.
</code></pre>
<p>So to break it down:</p>
<ol>
<li>The statement that &quot;paper-qa&gt;=5.0.0 depends on fhaviary&quot; is correct ðŸ¥³</li>
<li>Then &quot;fhaviary[paperqa] depends on paper-qa&gt;=5 and your workspace
requires fhaviary[paperqa]&quot; is also correct</li>
<li>However, &quot;we can conclude that your workspace's requirements are unsatisfiable&quot; is incorrect</li>
</ol>
<p>Why can't <code>uv</code> realize <code>fhaviary</code> is the same in both places? Here is my <code>pyproject.toml</code>:</p>
<pre><code class="language-toml">[project]
...
name = &quot;fhaviary&quot;
...
requires-python = &quot;&gt;=3.11&quot;

[tool.uv.sources]
&quot;aviary.gsm8k&quot; = {workspace = true}
&quot;aviary.hotpotqa&quot; = {workspace = true}
fhaviary = {workspace = true}

[tool.uv.workspace]
members = [&quot;packages/*&quot;]
</code></pre>
<p>My set up was working fine just a few days ago :/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Weird resolution error with `uv==0.5.0` and " to "Weird resolution error with `uv==0.5.0` and unsatisfiable requirements" by @jamesbraza on 2024-11-08 07:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @konstin on 2024-11-08 11:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-08 14:55</div>
            <div class="timeline-body"><p>Can you bisect the uv version in which this stopped working for you? Or provide a reproduction we can use to debug?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @charliermarsh on 2024-11-08 14:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jamesbraza">@jamesbraza</a> on 2024-11-08 19:16</div>
            <div class="timeline-body"><p>I tried bisecting just now and am seeing weird stuff. Note this issue does not occur on my Mac, just in GitHub Actions:</p>
<ul>
<li>3 days ago (11/5/2024) with <code>uv==0.4.30</code>: both <code>uv sync</code> and <code>uv sync --python-preference=only-managed</code> work</li>
<li>Yesterday (11/7/2024) with <code>uv==0.4.30</code>: <code>uv sync</code> works, and <code>uv sync --python-preference=only-managed</code> hit this error</li>
<li>Yesterday (11/7/2024) with <code>uv==0.5.0</code>: both <code>uv sync</code> and <code>uv sync --python-preference=only-managed</code> hit this error</li>
</ul>
<p>And neither repo (https://github.com/Future-House/aviary and https://github.com/Future-House/paper-qa) changed their dependencies. Looking at the <code>uv sync --verbose</code> logs with <code>uv==0.4.30</code>:</p>
<pre><code class="language-none">DEBUG Solving with installed Python version: 3.12.7
DEBUG Solving with target Python version: &gt;=3.12.7
</code></pre>
<p>And with <code>uv==0.5.0</code>:</p>
<pre><code class="language-none">DEBUG Solving with installed Python version: 3.12.7
DEBUG Solving with target Python version: &gt;=3.11
</code></pre>
<p>So this seems to be different. I am still digging</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-08 19:29</div>
            <div class="timeline-body"><p>Since your project has <code>requires-python = &quot;&gt;=3.11&quot;</code> it seems like it'd make sense to solve with that target Python version range.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-08 19:29</div>
            <div class="timeline-body"><p>If you set <code>UV_INTERNAL__SHOW_DERIVATION_TREE=1</code> we might get some information that's helpful for understanding the error message.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jamesbraza">@jamesbraza</a> on 2024-11-08 19:53</div>
            <div class="timeline-body"><p>Okay, I figured it out, but still don't know why it suddenly broke.</p>
<hr />
<p>Firstly, thank you @zanieb for the <code>UV_INTERNAL__SHOW_DERIVATION_TREE=1</code> tip. This is the same GitHub Action CI <a href="https://github.com/Future-House/aviary/actions/runs/11747999443/job/32731143534">logs without</a> and <a href="https://github.com/Future-House/aviary/actions/runs/11748489012/job/32732666524">logs with</a> that, and they seems identical to me. I am not sure if I am missing something there, but perhaps <code>UV_INTERNAL__SHOW_DERIVATION_TREE</code> didn't actually cover this case</p>
<hr />
<p>So the <code>paper-qa</code> (package <code>b</code>) in my scenario has: <code>fhaviary[llm]&gt;=0.8.2</code>. I observed in <code>fhaviary</code>'s CI logs:</p>
<pre><code class="language-none">Installed 124 packages in 121ms
...
 + fhaviary==0.1.dev1+g6ddf4a0 (from file:///home/runner/work/aviary/aviary)
</code></pre>
<p>This is wrong, <code>fhaviary</code> should be at least <code>0.9.1</code> ðŸ”¥ . And <code>fhaviary</code> uses <code>setuptools-scm</code> for its backend. This led me to https://github.com/pypa/setuptools-scm/issues/952, which shows me I need:</p>
<pre><code class="language-diff">      - uses: actions/checkout@v4
+++        with:
+++          fetch-depth: 0 # For setuptools-scm
</code></pre>
<hr />
<p>I tried to think of a possible way for <code>uv</code> to improve from this, and I have concluded the best way is for a more precise impossible resolution message. Here's the original one:</p>
<pre><code class="language-none">      And because paper-qa&gt;=5.0.0,&lt;=5.3.1 depends on fhaviary, we can conclude
      that paper-qa&gt;=5.0.0 depends on fhaviary.
      And because fhaviary[paperqa] depends on paper-qa&gt;=5 and your workspace
      requires fhaviary[paperqa], we can conclude that your workspace's
      requirements are unsatisfiable.
</code></pre>
<p>What I think <code>uv</code> should have said was (note that <code>paper-qa==5.0.0</code> depended on <code>fhaviary[llm]&gt;=0.6</code>):</p>
<pre><code class="language-none">      And because paper-qa&gt;=5.0.0,&lt;=5.3.1 depends on fhaviary&gt;=0.6, we can conclude
      that paper-qa&gt;=5.0.0 depends on fhaviary&gt;=0.6.
      And because fhaviary[paperqa]==0.1.dev1+g6ddf4a0 depends on paper-qa&gt;=5 and your workspace
      requires fhaviary[paperqa]==0.1.dev1+g6ddf4a0, we can conclude that your workspace's
      requirements are unsatisfiable.
</code></pre>
<p>Note that basically more versions were added to this message. What do you think?</p>
<p>Also, feel free to close this out</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-08 19:57</div>
            <div class="timeline-body"><p>The derivation tree is logged right before the resolver error</p>
<pre><code>Resolver derivation tree before reduction
  root==0a0.dev0 depends on fhaviary[paperqa]*
    no versions of fhaviary[paperqa]&lt;0.1.dev1+gd3c1bb2.d20241108 | &gt;0.1.dev1+gd3c1bb2.d20241108
      fhaviary[paperqa]==0.1.dev1+gd3c1bb2.d20241108 depends on paper-qa&gt;=5
          paper-qa==5.3.2 depends on fhaviary&gt;=0.8.2
          no versions of paper-qa&gt;5.0.0, &lt;5.0.1 | &gt;5.0.1, &lt;5.0.2 | &gt;5.0.2, &lt;5.0.3 | &gt;5.0.3, &lt;5.0.4 | &gt;5.0.4, &lt;5.0.5 | &gt;5.0.5, &lt;5.0.6 | &gt;5.0.6, &lt;5.0.7 | &gt;5.0.7, &lt;5.0.8 | &gt;5.0.8, &lt;5.0.9 | &gt;5.0.9, &lt;5.0.10 | &gt;5.0.10, &lt;5.1.0 | &gt;5.1.0, &lt;5.1.1 | &gt;5.1.1, &lt;5.2.0 | &gt;5.2.0, &lt;5.2.1 | &gt;5.2.1, &lt;5.3.0 | &gt;5.3.0, &lt;5.3.1 | &gt;5.3.1, &lt;5.3.2 | &gt;5.3.2
        paper-qa==5.0.0 | ==5.0.1 | ==5.0.2 | ==5.0.3 | ==5.0.4 | ==5.0.5 | ==5.0.6 | ==5.0.7 | ==5.0.8 | ==5.0.9 | ==5.0.10 | ==5.1.0 | ==5.1.1 | ==5.2.0 | ==5.2.1 | ==5.3.0 | ==5.3.1 depends on fhaviary&gt;=0.6
Resolver derivation tree after reduction
  root==0a0.dev0 depends on fhaviary[paperqa]*
    fhaviary[paperqa]==0.1.dev1+gd3c1bb2.d20241108 depends on paper-qa&gt;=5
        paper-qa==5.3.2 depends on fhaviary&gt;=0.8.2
        no versions of paper-qa&gt;5.0.0, &lt;5.0.1 | &gt;5.0.1, &lt;5.0.2 | &gt;5.0.2, &lt;5.0.3 | &gt;5.0.3, &lt;5.0.4 | &gt;5.0.4, &lt;5.0.5 | &gt;5.0.5, &lt;5.0.6 | &gt;5.0.6, &lt;5.0.7 | &gt;5.0.7, &lt;5.0.8 | &gt;5.0.8, &lt;5.0.9 | &gt;5.0.9, &lt;5.0.10 | &gt;5.0.10, &lt;5.1.0 | &gt;5.1.0, &lt;5.1.1 | &gt;5.1.1, &lt;5.2.0 | &gt;5.2.0, &lt;5.2.1 | &gt;5.2.1, &lt;5.3.0 | &gt;5.3.0, &lt;5.3.1 | &gt;5.3.1, &lt;5.3.2 | &gt;5.3.2
      paper-qa==5.0.0 | ==5.0.1 | ==5.0.2 | ==5.0.3 | ==5.0.4 | ==5.0.5 | ==5.0.6 | ==5.0.7 | ==5.0.8 | ==5.0.9 | ==5.0.10 | ==5.1.0 | ==5.1.1 | ==5.2.0 | ==5.2.1 | ==5.3.0 | ==5.3.1 depends on fhaviary&gt;=0.6
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-08 19:57</div>
            <div class="timeline-body"><p>It looks like we're leaving out an important part of the version during display.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jamesbraza">@jamesbraza</a> on 2024-11-08 20:02</div>
            <div class="timeline-body"><p>Ah nice, thanks for following up per the resolver derivation tree. I can see in that resolver derivation tree that <code>uv</code> was able to discern <code>fhaviary&gt;=0.6</code>, nice!</p>
<p>So yeah I agree with your interpretation that including more versions in the display is good</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-08 20:03</div>
            <div class="timeline-body"><p>@zanieb -- Apologies as I haven't been reading closely, but could it be related to the transforms we added in v0.5 around local versions?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-08 20:26</div>
            <div class="timeline-body"><p>I don't think so, the transformed tree looks fine. Did you adjust the display of local segments? Maybe we've just never rendered them? I'd have to look at the implementation.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:31:26 UTC
    </footer>
</body>
</html>
