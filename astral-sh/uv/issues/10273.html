<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Better error message with `--locked` when `upgrade` is requested - astral-sh/uv #10273</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Better error message with `--locked` when `upgrade` is requested</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/10273">#10273</a>
        opened by <a href="https://github.com/sayandipdutta">@sayandipdutta</a>
        on 2025-01-02 16:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/sayandipdutta">@sayandipdutta</a> on 2025-01-02 16:29</div>
            <div class="timeline-body"><h2>Description:</h2>
<p>Currently, if <code>upgrade</code> is requested, <code>uv lock/sync --locked/--check</code> fails with the following error:</p>
<blockquote>
<p>error: The lockfile at <code>uv.lock</code> needs to be updated, but <code>--locked</code> was provided. To update the lockfile, run <code>uv lock</code>.</p>
</blockquote>
<p>I was initially surprised by this, because I thought if no updates are available for any packages, the lockfile shouldn't need to change.<br />
However, <a href="https://github.com/astral-sh/uv/blob/a3307d91a355efc56df8560e6f7f243b310ec947/crates/uv/src/commands/project/lock.rs#L808">the code</a> seems to suggest otherwise, or I misunderstood and it is actually a bug. I am not sure why this was done, but I guess searching the web to determine whether updates are available is not an option, or maybe it simply cannot be done. Either way, I can live with that. However, this means, it is always known that if <code>upgrade==true</code> and <code>--locked/--check</code> is provided, the command cannot succeed. So my suggestion would be to either add more specific error message or provide additional context as warning for this specific case.</p>
<h2>Minimum Reproducible Example:</h2>
<pre><code class="language-bash">uv init foo &amp;&amp; cd foo &amp;&amp; uv lock &amp;&amp; uv lock --locked --upgrade
</code></pre>
<p>While the above is quite unlikely, the following is less so:</p>
<pre><code class="language-shell">uv init foo &amp;&amp; cd foo &amp;&amp; uv lock &amp;&amp; echo &quot;\n[tool.uv]\nupgrade = true&quot; &gt;&gt; pyproject.toml &amp;&amp; uv lock --locked
</code></pre>
<pre><code class="language-toml"># pyproject.toml
[project]
name = &quot;foo&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.13.0&quot;
dependencies = []

[tool.uv]
upgrade=true
</code></pre>
<h2>Actual Behavior:</h2>
<pre><code class="language-shell">Initialized project `foo` at `/home/sayandip/github/uv/foo`
Using CPython 3.13.0
Resolved 1 package in 13ms
Using CPython 3.13.0
Creating virtual environment at: .venv
Resolved 1 package in 10ms
error: The lockfile at `uv.lock` needs to be updated, but `--locked` was provided. To update the lockfile, run `uv lock`.
</code></pre>
<h2>Expected Behavior:</h2>
<pre><code class="language-shell">Initialized project `foo` at `/home/sayandip/github/uv/foo`
Using CPython 3.13.0
Resolved 1 package in 13ms
Using CPython 3.13.0
Creating virtual environment at: .venv
warning: Failed to validate existing lockfile: The lockfile needs to be updated when `upgrade` is requested. Either disable upgrade in settings, or pass `--no-upgrade`.
Resolved 1 package in 10ms
error: The lockfile at `uv.lock` needs to be updated, but `--locked` was provided. To update the lockfile, run `uv lock`.
</code></pre>
<p>Or,</p>
<pre><code class="language-shell">Initialized project `foo` at `/home/sayandip/github/uv/foo`
Using CPython 3.13.0
Resolved 1 package in 27ms
Using CPython 3.13.0
Creating virtual environment at: .venv
error: The lockfile at `uv.lock` needs to be updated when `upgrade` is requested, either omit `--locked` to update the lockfile, or pass `--no-upgrade` to disable update.
</code></pre>
<h2>System Information:</h2>
<p>Ubuntu 24.04.1 LTS (via WSL2 on win11)
uv 0.5.13
WSL Info:
WSL version: 2.3.26.0
Kernel version: 5.15.167.4-1
Windows version: 10.0.27764.1000</p>
<hr />
<p><strong>NOTE:</strong> The <a href="https://docs.astral.sh/uv/concepts/resolution/#dependency-preferences">docs</a> say the following:</p>
<blockquote>
<p>.... This means that locked or installed versions will not change unless an incompatible version is requested or an upgrade is explicitly requested with <code>--upgrade</code>.</p>
</blockquote>
<p>Technically, one can still interpret this as:</p>
<blockquote>
<p>locked or installed versions may or may not change if an incompatible version is requested or an upgrade is explicitly requested with <code>--upgrade</code>.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sayandipdutta">@sayandipdutta</a> on 2025-01-02 16:30</div>
            <div class="timeline-body"><p>If it is deemed as an issue and either of the solutions are acceptable, I would to be glad to contribute.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-03 15:32</div>
            <div class="timeline-body"><p>Perhaps we should just mark those options as conflicting on the CLI?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">error messages</span> added by @charliermarsh on 2025-01-03 15:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sayandipdutta">@sayandipdutta</a> on 2025-01-03 16:38</div>
            <div class="timeline-body"><p>I thought about it, but I didn't find a way to express conflicts between Lock options and Global options. I will look again.</p>
<p>Edit: <code>upgrade=true</code> could be set in config file as well. So not sure what will be the best place to raise.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 04:30:22 UTC
    </footer>
</body>
</html>
