<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The test suite fails if another Python version than 3.11.7 is installed - astral-sh/uv #2165</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>The test suite fails if another Python version than 3.11.7 is installed</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/2165">#2165</a>
        opened by <a href="https://github.com/mgorny">@mgorny</a>
        on 2024-03-04 17:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/mgorny">@mgorny</a> on 2024-03-04 17:22</div>
            <div class="timeline-body"><p>I'm trying to package <code>uv</code> for Gentoo Linux. While running the test suite for 0.1.13, I'm getting the following test failure:</p>
<pre><code>     Running `/var/tmp/portage/dev-python/uv-0.1.13/work/uv-0.1.13/target/debug/deps/pip_compile_scenarios-c46f31b1c84ace09`

running 8 tests
test requires_incompatible_python_version_compatible_override_other_wheel ... ok^O
test requires_python_patch_version_override_no_patch ... ok^O
test requires_incompatible_python_version_compatible_override_no_wheels ... ok^O
test requires_incompatible_python_version_compatible_override_no_compatible_wheels ... ok^O
test requires_compatible_python_version_incompatible_override ... FAILED^O
test requires_incompatible_python_version_compatible_override ... ok^O
test requires_python_patch_version_override_patch_compatible ... ok^O
test requires_incompatible_python_version_compatible_override_no_wheels_available_system ... ok^O

failures:

---- requires_compatible_python_version_incompatible_override stdout ----
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot: requires_compatible_python_version_incompatible_override
Source: crates/uv/tests/pip_compile_scenarios.rs:132
────────────────────────────────────────────────────────────────────────────────
Expression: snapshot
────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬───────────────────────────────────────────────────────────────────
    1     1 │ exit_code: 1
    2     2 │ ----- stdout -----
    3     3 │ 
    4     4 │ ----- stderr -----
    5       │-warning: The requested Python version 3.9 is not available; 3.11.7 will be used to build dependencies instead.
          5 │+warning: The requested Python version 3.9 is not available; 3.11.8 will be used to build dependencies instead.
    6     6 │   × No solution found when resolving dependencies:
    7     7 │   ╰─▶ Because the requested Python version (3.9) does not satisfy Python&gt;=3.10 and albatross==1.0.0 depends on Python&gt;=3.10, we can conclude that albatross==1.0.0 cannot be used.
    8     8 │       And because you require albatross==1.0.0, we can conclude that the requirements are unsatisfiable.
────────────┴───────────────────────────────────────────────────────────────────
To update snapshots run `cargo insta review`
Stopped on the first failure. Run `cargo insta test` to run all snapshots.
thread 'requires_compatible_python_version_incompatible_override' panicked at /var/tmp/portage/dev-python/uv-0.1.13/work/cargo_home/gentoo/insta-1.35.1/src/runtime.rs:563:9:
snapshot assertion for 'requires_compatible_python_version_incompatible_override' failed in line 132
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace


failures:
    requires_compatible_python_version_incompatible_override

test result: FAILED^O. 7 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out; finished in 11.11s
</code></pre>
<p>Could you, please, make the test suite work with any up-to-date Python rather than requiring a very specific version?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @charliermarsh on 2024-03-04 17:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-04 17:25</div>
            <div class="timeline-body"><p>Have you looked at the bootstrapping that we do in <code>ci.yml</code>, by calling into <code>scripts/bootstrap/install.py</code>? We assume a specific set of Python versions are available; otherwise, there's no way to get a reliable test suite.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-04 17:26</div>
            <div class="timeline-body"><p>You can also see the <a href="https://github.com/astral-sh/uv/blob/main/.python-versions">specific Python versions</a> we require for testing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgorny">@mgorny</a> on 2024-03-04 17:29</div>
            <div class="timeline-body"><blockquote>
<p>Have you looked at the bootstrapping that we do in <code>ci.yml</code>, by calling into <code>scripts/bootstrap/install.py</code>? We assume a specific set of Python versions are available; otherwise, there's no way to get a reliable test suite.</p>
</blockquote>
<p>I don't think that's going to work for us. We really want to make sure everything works with the same Python versions that will be used in production, not a temporary build used during test run.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-04 17:38</div>
            <div class="timeline-body"><p>We need to be able to test cases where there are multiple Python versions available e.g. different Python 3.8 patch versions. I'm not sure what we could do for you here.</p>
<p>Perhaps it's not worth including these tests in your distribution?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-04 17:44</div>
            <div class="timeline-body"><p>For reference, they seem to be using our Python versions in the <a href="https://gitlab.archlinux.org/archlinux/packaging/packages/uv/-/blob/21448fdf29b67b919b38a193abd5eb770222d4f1/PKGBUILD#L36-37">Arch Linux package</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgorny">@mgorny</a> on 2024-03-04 17:55</div>
            <div class="timeline-body"><p>Would it be possible to skip these tests when required Python version doesn't match?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eli-schwartz">@eli-schwartz</a> on 2024-03-04 18:02</div>
            <div class="timeline-body"><blockquote>
<p>We need to be able to test cases where there are multiple Python versions available e.g. different Python 3.8 patch versions. I'm not sure what we could do for you here.</p>
</blockquote>
<p>Shouldn't you be using mocks for this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-04 20:59</div>
            <div class="timeline-body"><blockquote>
<p>Shouldn't you be using mocks for this?</p>
</blockquote>
<p>What would we mock? Like.. create a several Python interpreters that report fake versions but make use of a single version behind the scenes? A part of what we're testing is retrieving Python version information from interpreters.</p>
<p>We don't really use &quot;mocks&quot; for testing here. Most of these are end-to-end tests of the CLI and aren't really suitable for that.</p>
<blockquote>
<p>Would it be possible to skip these tests when required Python version doesn't match?</p>
</blockquote>
<p>Yeah, but wouldn't that be easier to do on your end? We don't want these to be silently skipped on our end. We could consider putting tests that rely on specific Python versions behind a separate feature flag you could turn off, but since resolutions are Python-version dependent this would either exclude a lot of tests or introduce brittleness into our test suite.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-04 21:09</div>
            <div class="timeline-body"><p>To be clear, I would like to make it easy for you to package <code>uv</code> but I don't want to degrade our test suite to do it and we have limited resources for pursuing entirely different testing strategies.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eli-schwartz">@eli-schwartz</a> on 2024-03-04 21:38</div>
            <div class="timeline-body"><blockquote>
<p>What would we mock? Like.. create a several Python interpreters that report fake versions but make use of a single version behind the scenes? A part of what we're testing is retrieving Python version information from interpreters.</p>
</blockquote>
<p>Based on the failure message, it superficially looks like that test is testing the resolver behavior, assuming a given python version and expecting it to produce a specific style of &quot;good error message&quot; when resolving possible package version installations.</p>
<p>Is there a specific reason that such a test also needs to test how uv retrieves python version information from interpreters? Seems like a test to test how uv retrieves python version information from interpreters should be an entirely independent test (and perhaps one that can get away with testing whichever versions of python are available).</p>
<blockquote>
<p>Yeah, but wouldn't that be easier to do on your end? We don't want these to be silently skipped on our end. We could consider putting tests that rely on specific Python versions behind a separate feature flag you could turn off, but since resolutions are Python-version dependent this would either exclude a lot of tests or introduce brittleness into our test suite.</p>
</blockquote>
<p>I am not so sure that specifying test exclusions manually in distro packaging is all that scalable. Consider also that Gentoo is <em>not</em> the only distro that will be facing this problem. Actually, Arch Linux is the odd one out here as Arch Linux has no official policy on build environment sanitization. Debian, Fedora, OpenSUSE etc. also have rules that forbid downloading arbitrary binaries from the internet during build or testing.</p>
<p>(Aside for which: the architecture support for arbitrary prebuilts here is <em>terrible</em>. It cannot run on musl systems except on x86_64 specifically, and the only arch support even for glibc is i686/x86_64, plus arm64 and s390x and ppc64le. For Gentoo in particular this means more architectures are NOT supported than are. In particular, there are 6 platforms which Gentoo provides rust for, but the indygreg binaries don't cover.)</p>
<p>Anyways, point is that doing whatever is the cargo nextest equivalent of python pytest's &quot;pytest.mark.requires_picky_pythons&quot; and allowing people to deselect that based on category, feels like the most correct way to allow packagers to skip tests.</p>
<p>Excluding a lot of tests only when packagers ask for it, is better than all those same tests failing, probably.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgorny">@mgorny</a> on 2024-03-05 04:02</div>
            <div class="timeline-body"><blockquote>
<p>Yeah, but wouldn't that be easier to do on your end? We don't want these to be silently skipped on our end. We could consider putting tests that rely on specific Python versions behind a separate feature flag you could turn off, but since resolutions are Python-version dependent this would either exclude a lot of tests or introduce brittleness into our test suite.</p>
</blockquote>
<p>I think feature flags would help, yes. Specifically a separate flag for test that require specific x.y.z version (vs just x.y.*). I'm not really familiar with <code>cargo test</code>, but I wasn't able to find a clean way of skipping tests equivalent to <code>pytest --deselect</code>, nor even a clean way of sed-ing them. So far I've ended up with a large patch which is far from optimal and will probably need to be updated frequently.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-05 15:27</div>
            <div class="timeline-body"><p>I'll look into that and report back.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @zanieb by @zanieb on 2024-03-05 16:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/2930.html">astral-sh/uv#2930</a> on 2024-04-09 13:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/2940.html">astral-sh/uv#2940</a> on 2024-04-09 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-04-10 14:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-10 14:01</div>
            <div class="timeline-body"><p>With https://github.com/astral-sh/uv/pull/2940 and https://github.com/astral-sh/uv/pull/2930 you should now be able to disable the very few tests that actually require specific patch versions. Thanks for your patience!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgorny">@mgorny</a> on 2024-04-10 14:54</div>
            <div class="timeline-body"><blockquote>
<p>With #2940 and #2930 you should now be able to disable the very few tests that actually require specific patch versions. Thanks for your patience!</p>
</blockquote>
<p>Thanks a lot! I'll test it with the next release.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgorny">@mgorny</a> on 2024-04-16 06:13</div>
            <div class="timeline-body"><p>Thanks a lot again! This resolved almost all test failures we were having. I'll file a separate bug for the one I'm seeing right now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/3051.html">astral-sh/uv#3051</a> on 2024-04-16 06:17</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:24 UTC
    </footer>
</body>
</html>
