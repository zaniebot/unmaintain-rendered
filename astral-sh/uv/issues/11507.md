```yaml
number: 11507
title: uv pip cannot add upstream packages to Azure DevOps feed while authenticated
type: issue
state: closed
author: thomasaarholt
labels:
  - bug
assignees: []
created_at: 2025-02-14T12:17:57Z
updated_at: 2025-04-29T21:37:05Z
url: https://github.com/astral-sh/uv/issues/11507
synced_at: 2026-01-10T01:57:26Z
```

# uv pip cannot add upstream packages to Azure DevOps feed while authenticated

---

_Issue opened by @thomasaarholt on 2025-02-14 12:17_

### Summary

Hello!

I have a [public Azure DevOps feed](https://dev.azure.com/thomasaarholt/thomasaarholt-python/_artifacts/feed/thomas-python-feed). It is backed by PyPI. Anyone can install a package that has been added to the feed via `pip install` or `uv pip install`. You can see which packages are added to the feed by the "in this feed" tag, e.g. for [scipy](https://dev.azure.com/thomasaarholt/thomasaarholt-python/_artifacts/feed/thomas-python-feed/PyPI/scipy/upstreams/1.15.1).

### The problem
When I am authenticated against the feed using my credentials, I can run `pip install <some-package>==<some-version>` in order to automatically add an upstream package (typically from PyPI) to the feed, and install it in the venv.

This works with `pip`. I am not able to get it to work with `uv`, even when following the [guidelines on using alternative indexes](https://docs.astral.sh/uv/guides/integration/alternative-indexes/#using-keyring).

### Repro
Here is a minimum repro for uv and pip. I do think you need the dotnet runtime installed for keyring-artifacts to work, but you wouldn't be able to authenticate without my credentials anyway. (For further debugging, you could make a public feed on ADO, it is free and I can help set this up).

```fish
# uv repro
export UV_INDEX='https://VssSessionToken@pkgs.dev.azure.com/thomasaarholt/thomasaarholt-python/_packaging/thomas-python-feed/pypi/simple/'
export RUST_LOG=trace;
uv venv --seed --quiet
source .venv/bin/activate.fish # activate however you normally do
uv pip install artifacts-keyring
uv pip install scipy==1.14.0 --index-url=$UV_INDEX --keyring-provider='subprocess' -v  &> log.txt # this fails
``` 
[uv log](https://gist.github.com/thomasaarholt/97440c1eaf369d13a4998c45cab8ea41)


```fish
# pip repro
export PIP_INDEX='https://pkgs.dev.azure.com/thomasaarholt/thomasaarholt-python/_packaging/thomas-python-feed/pypi/simple/'
uv venv --seed --quiet
source .venv/bin/activate.fish # activate however you normally do
uv pip install artifacts-keyring
pip install --index-url=$PIP_INDEX scipy==1.14.1 -v &> pip_log.txt # this succeeds
```
[pip log](https://gist.github.com/thomasaarholt/2e5c43bde9bd2b4b612ac14674b7f557)

Once pip has run and the package has been added to the index, then uv is able to find the package.

### Platform

Windows 11

### Version

0.15.14

### Python version

3.11.11

---

_Label `bug` added by @thomasaarholt on 2025-02-14 12:17_

---

_Comment by @zanieb on 2025-02-14 13:02_

Thanks for the logs


```
TRACE Fetching metadata for scipy from https://VssSessionToken@pkgs.dev.azure.com/thomasaarholt/thomasaarholt-python/_packaging/thomas-python-feed/pypi/simple/scipy/
TRACE Sending fresh GET request for https://pkgs.dev.azure.com/thomasaarholt/thomasaarholt-python/_packaging/thomas-python-feed/pypi/simple/scipy/
TRACE Handling request for https://VssSessionToken@pkgs.dev.azure.com/thomasaarholt/thomasaarholt-python/_packaging/thomas-python-feed/pypi/simple/scipy/
TRACE Request for https://VssSessionToken@pkgs.dev.azure.com/thomasaarholt/thomasaarholt-python/_packaging/thomas-python-feed/pypi/simple/scipy/ is missing a password, looking for credentials
TRACE No password in cache for realm VssSessionToken@https://pkgs.dev.azure.com
TRACE No password in cache for URL https://pkgs.dev.azure.com/thomasaarholt/thomasaarholt-python/_packaging/thomas-python-feed/pypi/simple/scipy/
DEBUG No netrc file found
DEBUG Checking keyring for credentials for VssSessionToken@https://pkgs.dev.azure.com/thomasaarholt/thomasaarholt-python/_packaging/thomas-python-feed/pypi/simple/scipy/
TRACE Checking keyring for URL https://pkgs.dev.azure.com/thomasaarholt/thomasaarholt-python/_packaging/thomas-python-feed/pypi/simple/scipy/
TRACE Checking keyring for host pkgs.dev.azure.com
```

I believe the issue is that the Azure keyring plugin won't return credentials for a child URL like `https://pkgs.dev.azure.com/thomasaarholt/thomasaarholt-python/_packaging/thomas-python-feed/pypi/simple` and instead requires the exact index URL like `https://pkgs.dev.azure.com/thomasaarholt/thomasaarholt-python/_packaging/thomas-python-feed/pypi`.

https://github.com/astral-sh/uv/issues/4583 tracks a general fix for this.

There are duplicate reports at

- https://github.com/astral-sh/uv/issues/11236
- https://github.com/astral-sh/uv/issues/11391

---

_Comment by @thomasaarholt on 2025-02-14 13:21_

Fantastic, thank you Zanie. I expected this to be another one on our end with ADO. ðŸ˜…

I believe this is currently preventing anyone using `uv pip` or an uv project with _only_ an Azure feed from getting the latest PyPI packages without somehow running `pip install -U` for all dependencies intermittently.

---

_Comment by @zanieb on 2025-02-14 13:26_

Yeah, it's kind of an unfortunate quirk with our authentication model which doesn't special-case index roots. I will try to fix it soon.

---

_Referenced in [astral-sh/uv#12651](../../astral-sh/uv/pulls/12651.md) on 2025-04-03 15:34_

---

_Assigned to @jtfmumm by @jtfmumm on 2025-04-11 08:08_

---

_Closed by @zanieb on 2025-04-29 21:37_

---

_Referenced in [astral-sh/uv#13208](../../astral-sh/uv/issues/13208.md) on 2025-04-30 07:52_

---
