<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cache invalidation on local dependencies when using docker - astral-sh/uv #9191</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Cache invalidation on local dependencies when using docker</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/9191">#9191</a>
        opened by <a href="https://github.com/hxyannay">@hxyannay</a>
        on 2024-11-18 10:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/hxyannay">@hxyannay</a> on 2024-11-18 10:11</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

<p>Hello.</p>
<p>I am having difficulties using uv in docker. My project structure has two python libraries, one is an API server, and the other is an internal library.
The problem I am encountering is that after building, when running the image, the <code>uv run</code> reinstalls my internal libraries, with the following message: <code>Requirement installed, but not fresh: ...</code>. This is problematic, because as per docker best practices, it is good to ensure that the install actually happens on the build stage, and not in the actual running phase of my application.
When debugging the issue further, I found out that it happens because the ctime of my <code>pyproject.toml</code> of the internal library changes between the docker build and the actual run.</p>
<p>I finally validated that symptom using the following dockerfile:</p>
<pre><code>FROM ubuntu:22.04

RUN touch a &amp;&amp; stat a &gt; /root/stat-a
RUN sleep 5
</code></pre>
<p>And running: <code>docker build --no-cache . -t playground &amp;&amp; docker run playground sh -c 'cat /root/stat-a &amp;&amp; stat a'</code>
The output that I received was:</p>
<pre><code>  File: a
  Size: 0               Blocks: 0          IO Block: 4096   regular empty file
Device: e3h/227d        Inode: 1336246     Links: 1
Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)
Access: 2024-11-18 10:04:52.462498005 +0000
Modify: 2024-11-18 10:04:52.462498005 +0000
Change: 2024-11-18 10:04:52.462498005 +0000
 Birth: 2024-11-18 10:04:52.462498005 +0000
---
  File: a
  Size: 0               Blocks: 0          IO Block: 4096   regular empty file
Device: e3h/227d        Inode: 225316      Links: 1
Access: (0644/-rw-r--r--)  Uid: (    0/    root)   Gid: (    0/    root)
Access: 2024-11-18 10:04:52.000000000 +0000
Modify: 2024-11-18 10:04:52.000000000 +0000
Change: 2024-11-18 10:04:57.680498008 +0000
 Birth: 2024-11-18 10:04:57.680498008 +0000
</code></pre>
<p>As seen, two things are changing between the build and run - both the inode number, and the Change &amp; Birth times.
This seems like an odd behavior of docker, but as I dived deeper it seems inherent to the layering system of docker.</p>
<p>I think that the solution to that issue should come from uv's side, as the usage for similar type of projects in docker should be very common.</p>
<p>A possible approach that would solve both the cache freshness problem and would work with docker's odd behavior would be using checksums for local dependencies freshness check.</p>
<p>Some additional information:</p>
<ul>
<li>uv version: v0.5.1</li>
<li>Platform: MacOS with Docker Desktop</li>
</ul>
<p>Thanks in advance!
Yannay</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-18 13:36</div>
            <div class="timeline-body"><p>Thanks for the write-up. I think it'd be much easier to help out if you could provide a full reproduction for the behavior you're seeing, just so I can understand how you're structuring and running your application.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @charliermarsh on 2024-11-18 13:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hxyannay">@hxyannay</a> on 2024-11-18 18:07</div>
            <div class="timeline-body"><p>Hey,
So I worked a bit to reproduce it, created <a href="https://github.com/hxyannay/uv-docker-example">this</a> fork of the example from the official documentation of uv
Added <a href="https://github.com/astral-sh/uv-docker-example/commit/43a86be439084d53d9bc40171d4fb5dee5fdc365">one commit</a> that changes the command to use <code>uv run</code> instead of modifying the <code>ENV</code> (which is better anyways in my opinion).</p>
<p>When running the build and then run:</p>
<pre><code>$ docker build -t uv-example .
$ docker run uv-example
Uninstalled 1 package in 0.68ms
Installed 2 packages in 10ms
...
</code></pre>
<p>As seen in the last two rows, it uninstalled and reinstalled the package of the example, as the symptoms that I encountered.</p>
<p>Thanks for responding so fast!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-18 20:03</div>
            <div class="timeline-body"><p>Thanks! Interestingly, with that example I see:</p>
<pre><code>❯ docker run uv-example
Installed 1 package in 6ms
Bytecode compiled 1143 files in 49ms
INFO     Using path src/uv_docker_example
INFO     Resolved absolute path /app/src/uv_docker_example
</code></pre>
<p>Am I misunderstanding the output, or does it look like a platform difference?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hxyannay">@hxyannay</a> on 2024-11-18 20:12</div>
            <div class="timeline-body"><p>Yeah it does seem different, I am running this on MacOS with docker desktop.
Though in your output it still shows that it installed a package, is it the expected behavior? I would expect it to not install any package as we run <code>uv sync</code> in the dockerfile.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-18 20:14</div>
            <div class="timeline-body"><p>Sorry, I haven't looked at all -- I just noticed that it differed from the above so wanted to ask first. (I'm also on macOS with Docker Desktop.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hxyannay">@hxyannay</a> on 2024-11-18 20:16</div>
            <div class="timeline-body"><p>This is very odd then.
I am running on M2 with macOS Sequoia 15.1 and Docker Desktop v4.35.1 with docker engine v27.3.1</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-18 20:44</div>
            <div class="timeline-body"><p>Are ya'll definitely testing the same uv version? The image could be cached if you're just using that example repository.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-19 03:45</div>
            <div class="timeline-body"><p>So in my case at least, the installed package in <code>Installed 1 package</code> is Ruff, due to the use of <code>--no-dev</code> when syncing the Dockerfile. (<code>uv run</code> will sync dev by default.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-19 03:45</div>
            <div class="timeline-body"><p>Have you considered using <code>uv run --frozen</code> in your <code>CMD</code> instead? I think that's more appropriate given that you may not even want to re-validate the lockfile on container startup.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-19 03:48</div>
            <div class="timeline-body"><p>(I'm also on Docker version 27.3.1. M3, Sonoma 14.5.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hxyannay">@hxyannay</a> on 2024-11-20 08:12</div>
            <div class="timeline-body"><p>Still the same when running with <code>--frozen</code> flag.
The uv version from inside the container is <code>0.5.3</code>.
Could it be related to the VM options in docker?
I am using Apple Virtualization framework with Rosetta enabled and VirtioFS for file sharing implementation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hxyannay">@hxyannay</a> on 2024-11-24 12:51</div>
            <div class="timeline-body"><blockquote>
<p>(I'm also on Docker version 27.3.1. M3, Sonoma 14.5.)</p>
</blockquote>
<p>Hey @charliermarsh, is there any more information I can share that will help you reproduce it locally?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-25 23:29</div>
            <div class="timeline-body"><p>I also cannot reproduce (similarly, on an M3 with Docker Desktop)</p>
<pre><code>❯ docker build -t uv-example .
[+] Building 3.0s (10/10) FINISHED                                                                                                                                                                                                                        docker:desktop-linux
 =&gt; [internal] load build definition from Dockerfile                                                                                                                                                                                                                      0.0s
 =&gt; =&gt; transferring dockerfile: 1.18kB                                                                                                                                                                                                                                    0.0s
 =&gt; [internal] load metadata for ghcr.io/astral-sh/uv:0.5.3-python3.12-bookworm-slim                                                                                                                                                                                      0.8s
 =&gt; [internal] load .dockerignore                                                                                                                                                                                                                                         0.0s
 =&gt; =&gt; transferring context: 106B                                                                                                                                                                                                                                         0.0s
 =&gt; [stage-0 1/5] FROM ghcr.io/astral-sh/uv:0.5.3-python3.12-bookworm-slim@sha256:090b8acad6ffaeb1fbbec6ed7b052c3837ae6c407b5164d0b09e61e9a38311ab                                                                                                                        1.2s
 =&gt; =&gt; resolve ghcr.io/astral-sh/uv:0.5.3-python3.12-bookworm-slim@sha256:090b8acad6ffaeb1fbbec6ed7b052c3837ae6c407b5164d0b09e61e9a38311ab                                                                                                                                0.0s
 =&gt; =&gt; sha256:6c1729b16fda6af1e58192a3723fb0a8229a126ea9ee1e73ff5a2aae275ca1fb 1.25kB / 1.25kB                                                                                                                                                                            0.0s
 =&gt; =&gt; sha256:b0751293b2c29a56170f36ed84d79f872bb2923e426099166290e46865865459 6.35kB / 6.35kB                                                                                                                                                                            0.0s
 =&gt; =&gt; sha256:2d87e44c35ccf73088373150fe7de8d6b2b2958dd33d8d0c2825048a687a4f7e 13.52MB / 13.52MB                                                                                                                                                                          1.1s
 =&gt; =&gt; sha256:090b8acad6ffaeb1fbbec6ed7b052c3837ae6c407b5164d0b09e61e9a38311ab 2.22kB / 2.22kB                                                                                                                                                                            0.0s
 =&gt; =&gt; extracting sha256:2d87e44c35ccf73088373150fe7de8d6b2b2958dd33d8d0c2825048a687a4f7e                                                                                                                                                                                 0.1s
 =&gt; [internal] load build context                                                                                                                                                                                                                                         0.0s
 =&gt; =&gt; transferring context: 205.50kB                                                                                                                                                                                                                                     0.0s
 =&gt; [stage-0 2/5] WORKDIR /app                                                                                                                                                                                                                                            0.0s
 =&gt; [stage-0 3/5] RUN --mount=type=cache,target=/root/.cache/uv     --mount=type=bind,source=uv.lock,target=uv.lock     --mount=type=bind,source=pyproject.toml,target=pyproject.toml     uv sync --frozen --no-install-project --no-dev                                  0.4s
 =&gt; [stage-0 4/5] ADD . /app                                                                                                                                                                                                                                              0.0s
 =&gt; [stage-0 5/5] RUN --mount=type=cache,target=/root/.cache/uv     uv sync --frozen --no-dev                                                                                                                                                                             0.4s
 =&gt; exporting to image                                                                                                                                                                                                                                                    0.1s 
 =&gt; =&gt; exporting layers                                                                                                                                                                                                                                                   0.1s 
 =&gt; =&gt; writing image sha256:be88ded41d630245cb1ef290561c9885f61b039ef7381cced4de0abf15de5bdf                                                                                                                                                                              0.0s
 =&gt; =&gt; naming to docker.io/library/uv-example                                                                                                                                                                                                                             0.0s

What's next:
    View a summary of image vulnerabilities and recommendations → docker scout quickview 
❯ docker run uv-example
Installed 1 package in 14ms
</code></pre>
<pre><code class="language-diff">diff --git a/Dockerfile b/Dockerfile
index d7acf90..f0aed3f 100644
--- a/Dockerfile
+++ b/Dockerfile
@@ -1,5 +1,5 @@
 # Use a Python image with uv pre-installed
-FROM ghcr.io/astral-sh/uv:python3.12-bookworm-slim
+FROM ghcr.io/astral-sh/uv:0.5.3-python3.12-bookworm-slim
 
 # Install the project into `/app`
 WORKDIR /app
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-25 23:30</div>
            <div class="timeline-body"><p>I'm also using the default settings, which afaict includes VirtioFS, Rosetta, and the Virtualization framework.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/helmut-hoffer-von-ankershoffen">@helmut-hoffer-von-ankershoffen</a> on 2024-12-20 19:23</div>
            <div class="timeline-body"><p>Same issue on my side - following <a href="https://github.com/astral-sh/uv-docker-example/blob/main/Dockerfile">this example</a> leads to <code>Uninstalled 1 package [..] Installed 1 package</code>. Using --verbose on uv run surfaces &quot;Requirement installed, but not fresh&quot;, with the requirement being the project itself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../speaches-ai/speaches/issues/127.html">speaches-ai/speaches#127</a> on 2025-01-06 18:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/czechnology">@czechnology</a> on 2025-05-12 12:44</div>
            <div class="timeline-body"><p>My colleagues using Docker Desktop on Windows are encountering this as well.
Is there a way to bypass or &quot;trick&quot; the freshness check? How does uv decide whether a package is not fresh and requires rebuilding?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/stisti">@stisti</a> on 2025-05-12 13:35</div>
            <div class="timeline-body"><p>Me and other my team mates are encountering this issue. Everyone with the issue is running Docker Desktop, either on macOS or Windows. Team mates who have installed Docker community edition in WSL2 do not have this issue. We noticed the issue rather quickly after we switched to using uv because we:</p>
<ol>
<li>run docker build where Dockerfile runs uv to install dependencies using <code>uv sync --frozen</code></li>
<li>using the image from step 1, we <code>docker run --rm --network none uv run --frozen pytest</code> (and pylint and other tools)</li>
</ol>
<p>The step 2 fails for people using Docker Desktop because uv tries to rebuild the project and download some libraries (setuptools). Step 2 succeeds for people using Docker community edition.</p>
<p>Of course we can work around the problem by removing <code>--network none</code> but it revealed this problem that uv tries to rebuild the python project during docker run.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Nugine">@Nugine</a> on 2025-05-17 15:04</div>
            <div class="timeline-body"><p>Is there any workaround? I don't want to re-install anything on container startup.</p>
<hr />
<p>Use this command</p>
<pre><code class="language-bash">.venv/bin/python main.py
</code></pre>
<p>instead of</p>
<pre><code class="language-bash">uv run main.py
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @jtfmumm by @jtfmumm on 2025-07-28 14:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @jtfmumm by @konstin on 2025-09-12 13:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jmesterh">@jmesterh</a> on 2025-10-18 18:15</div>
            <div class="timeline-body"><p>We are switching to Chainguard images, which requires a multi-stage build where you build in one stage with the &quot;-dev&quot; container, and copy the build artifacts into the final stage which doesn't have /bin/sh, etc.</p>
<p>The Docker COPY command doesn't preserve timestamps, so in the final stage when it tries to run the program:</p>
<pre><code>CMD [ &quot;uv&quot;, &quot;run&quot;, ... ]
</code></pre>
<p>uv says the &quot;Requirement installed, but not fresh&quot; for the project itself and it tries to reinstall.</p>
<p>We can't just call the project directly vs <code>uv run</code> because the library we use (Prefect) calls <code>uv run</code> internally with lots of arguments l don't have control over like <code>--python</code> and <code>--with</code></p>
<p>I would like an environment variable that tells uv not to try and do <em>anything</em> and just run the program.</p>
<p><em>edit</em> it seems this combination of environment variables at the end of the Dockerfile works:</p>
<pre><code>ENV UV_NO_MANAGED_PYTHON=true \
    UV_SYSTEM_PYTHON=true \
    UV_LOCKED=1 \
    UV_NO_SYNC=1 \
    UV_NO_CACHE=1 \
    UV_NO_DEV=1
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:24 UTC
    </footer>
</body>
</html>
