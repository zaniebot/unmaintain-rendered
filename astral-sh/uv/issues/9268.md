```yaml
number: 9268
title: "Python conditional package dependencies for `psycopg[c]` on `==armv7` | `psycopg[binary]` on `!=armv7`"
type: issue
state: closed
author: zarch
labels:
  - question
assignees: []
created_at: 2024-11-20T10:00:56Z
updated_at: 2024-11-20T14:58:16Z
url: https://github.com/astral-sh/uv/issues/9268
synced_at: 2026-01-10T01:57:21Z
```

# Python conditional package dependencies for `psycopg[c]` on `==armv7` | `psycopg[binary]` on `!=armv7`

---

_Issue opened by @zarch on 2024-11-20 10:00_

Hi all,

I'm working on a project that is using `psycopg`, unfortunately I need to support different platform and architectures.
In particular when I'm on `armv7` I need to install `psycopg[c]` to properly compile the package for the specific architecture of the host, while for the other platform that I've tested it is fine to install `psycopg[binary]`.

I tried to follow the documentation example on [pytorch](https://docs.astral.sh/uv/guides/integration/pytorch/), but still I was not able to get a working `pyproject.toml` configuration file. This is my attempt:

```toml
[project]
name = "pg"
version = "0.1.0"
description = "Add your description here"
readme = "README.md"
authors = [
    { name = "Zarch", email = "zarch@email.com" }
]
requires-python = ">=3.12"
dependencies = ["psycpg"]

[project.optional-dependencies]
pg = [
  "psycopg[binary]>=3.2.3",
]
pg_armv7 = [
  "psycopg[c]>=3.2.3",
]

[tool.uv]
conflicts = [
  [
    { extra = "pg" },
    { extra = "pg_armv7" },
  ],
]

[tool.uv.sources]
psycpg = [
    {index = "psycopg[binary]>=3.2.3", extra="pg", marker="platform_machine != 'armv7'"},
    {index = "psycopg[c]>=3.2.3", extra="pg_armv7", marker="platform_machine == 'armv7'"},
]

[project.scripts]
pg = "pg:main"

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"
```

If I try to sync I got:
```bash
❯ uv sync --all-packages
error: Failed to parse: `pyproject.toml`
  Caused by: TOML parse error at line 30, column 14
   |
30 |     {index = "psycopg[binary]>=3.2.3", extra="pg", marker="platform_machine != 'armv7'"},
   |              ^^^^^^^^^^^^^^^^^^^^^^^^
Index names may only contain letters, digits, hyphens, underscores, and periods, but found unsupported character (`[`) in: `psycopg[binary]>=3.2.3`
```

Should the index names also allow `[]` characters?
Am I using the correct approach?

<!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->


---

_Comment by @konstin on 2024-11-20 10:07_

For this, you don't need to declare the index (it's all pypi), but you can use markers in dependencies:

```
dependencies = [
    "psycopg[binary]>=3.2.3; platform_machine != 'armv7'",
    "psycopg[c]>=3.2.3; platform_machine == 'armv7'",
    ...
]
```

---

_Label `question` added by @konstin on 2024-11-20 10:07_

---

_Comment by @zarch on 2024-11-20 11:37_

@konstin thank you for your answer, I've missed your point and I lost myself on the uv source and index management :-)

I changed the `pyproject.toml` to:

```toml
[project]
name = "pg"
version = "0.1.0"
description = "Add your description here"
readme = "README.md"
authors = [
    { name = "Zarch", email = "zarch@email.com" }
]
requires-python = ">=3.12"
dependencies = [
    "psycopg[binary]>=3.2.3; platform_machine == 'x86_64'",
    "psycopg[c]>=3.2.3; platform_machine == 'armv7l'",
]

[project.scripts]
pg = "pg:main"

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"
```

on linux `x86_64` if I comment the second line (`"psycopg[c]>=3.2.3; platform_machine == 'armv7l'",`) I'm able to sync:

```bash
❯ uv sync
Resolved 5 packages in 6ms
   Built pg @ file:///data/src/syn/test/testpsycopg
Prepared 3 packages in 4.15s
Installed 4 packages in 9ms
 + pg==0.1.0 (from file:///data/src/syn/test/testpsycopg)
 + psycopg==3.2.3
 + psycopg-binary==3.2.3
 + typing-extensions==4.12.2
```

However, if I let both the lines and I execute again the sync I get:

```bash
❯ uv sync
  × Failed to download and build `psycopg-c==3.2.3`
  ╰─▶ Build backend failed to determine metadata through `prepare_metadata_for_build_wheel` (exit status: 1)

      [stdout]
      running dist_info
      creating /home/zarch/.cache/uv/builds-v0/.tmpnA0zrK/metadata_directory/psycopg_c.egg-info
      writing /home/zarch/.cache/uv/builds-v0/.tmpnA0zrK/metadata_directory/psycopg_c.egg-info/PKG-INFO
      writing dependency_links to /home/zarch/.cache/uv/builds-v0/.tmpnA0zrK/metadata_directory/psycopg_c.egg-info/dependency_links.txt
      writing top-level names to /home/zarch/.cache/uv/builds-v0/.tmpnA0zrK/metadata_directory/psycopg_c.egg-info/top_level.txt
      writing manifest file '/home/zarch/.cache/uv/builds-v0/.tmpnA0zrK/metadata_directory/psycopg_c.egg-info/SOURCES.txt'

      [stderr]
      couldn't run 'pg_config' --includedir: [Errno 2] No such file or directory: 'pg_config'
      error: [Errno 2] No such file or directory: 'pg_config'

  help: `psycopg-c` was included because `pg==0.1.0` depends on `psycopg==3.2.3` which depends on `psycopg-c==3.2.3` which depends on
        `psycopg-c`
```

So it seems that `uv` tried to install `psycopg[c]` even if the `system_platform` condition is not satisfied.

I've noticed that the function [platform_machine](https://github.com/astral-sh/uv/blob/ccc0962cbd01777a53aa2dec8ff2b8f0f7de3a70/crates/uv-configuration/src/target_triple.rs#L404) defined in `uv-configuration` does not return `armv7l` pip allow archs seems to be, [see](https://github.com/pypa/pip/blob/fe0925b3c00bf8956a0d33408df692ac364217d4/src/pip/_vendor/packaging/_manylinux.py#L55):

- `armv7l`
- `i686`
- `x86_64`
- `aarch64`
- `ppc64`
- `ppc64le`
- `s390x`
- `loongarch64`
- `riscv64`

few of them seems to be not defined / supported by uv, perhaps actually they are not supported by `rust`... anyway... I'm not sure if this is link to the issue that I'm experimenting.

I report the full verbose log to give you better context informations

```bash
❯ RUST_LOG=trace uv sync --verbose
DEBUG uv 0.5.2
DEBUG Found project root: `/data/src/syn/test/testpsycopg`
DEBUG No workspace root found, using project root
DEBUG Reading Python requests from version file at `/data/src/syn/test/testpsycopg/.python-version`
DEBUG Using Python request `3.12` from version file at `.python-version`
TRACE Cached interpreter info for Python 3.12.7, skipping probing: .venv/bin/python3
DEBUG The virtual environment's Python version satisfies `3.12`
DEBUG Using request timeout of 30s
DEBUG Found static `pyproject.toml` for: pg @ file:///data/src/syn/test/testpsycopg
DEBUG No workspace root found, using project root
DEBUG Ignoring existing lockfile due to mismatched `requires-dist` for: `pg==0.1.0`
  Expected: {Requirement { name: PackageName("psycopg"), extras: [ExtraName("binary")], marker: platform_machine == 'x86_64', source: Registry { sp
  Actual: {Requirement { name: PackageName("psycopg"), extras: [ExtraName("binary")], marker: platform_machine == 'x86_64', source: Registry { spec
TRACE Performing lookahead for pg @ file:///data/src/syn/test/testpsycopg
DEBUG Solving with installed Python version: 3.12.7
DEBUG Solving with target Python version: >=3.12
DEBUG Narrowed `requires-python` bound to: >=3.12
DEBUG Narrowed `requires-python` bound to: >=3.12
DEBUG Solving split (platform_machine == 'x86_64' and python_full_version >= '3.12') (requires-python: RequiresPython { specifiers: VersionSpecifie
DEBUG Adding direct dependency: pg*
INFO add_decision: root @ 0a0.dev0 without checking dependencies
DEBUG Searching for a compatible version of pg @ file:///data/src/syn/test/testpsycopg (*)
TRACE skipping psycopg[c]>=3.2.3 ; platform_machine == 'armv7l' because of split `platform_machine == 'x86_64' and python_full_version >= '3.12'`
DEBUG Adding transitive dependency for pg==0.1.0: psycopg{platform_machine == 'x86_64'}>=3.2.3
DEBUG Adding transitive dependency for pg==0.1.0: psycopg[binary]>=3.2.3
INFO add_decision: pg @ 0.1.0 without checking dependencies
TRACE Fetching metadata for psycopg from https://pypi.org/simple/psycopg/
TRACE cached request https://pypi.org/simple/psycopg/ is storable because its response has a 'public' cache-control directive
TRACE freshness lifetime found via cache-control max age setting: 600s
DEBUG Found fresh response for: https://pypi.org/simple/psycopg/
TRACE Received package metadata for: psycopg
DEBUG Searching for a compatible version of psycopg[binary] (>=3.2.3)
TRACE Using preference psycopg 3.2.3
DEBUG Selecting: psycopg==3.2.3 [preference] (psycopg-3.2.3-py3-none-any.whl)
DEBUG Adding transitive dependency for psycopg==3.2.3: psycopg==3.2.3
DEBUG Adding transitive dependency for psycopg==3.2.3: psycopg[binary]==3.2.3
DEBUG Adding transitive dependency for psycopg==3.2.3: psycopg{platform_machine == 'x86_64'}==3.2.3
DEBUG Adding transitive dependency for psycopg==3.2.3: psycopg[binary]{platform_machine == 'x86_64'}==3.2.3
INFO add_decision: psycopg[binary] @ 3.2.3 without checking dependencies
DEBUG Searching for a compatible version of psycopg[binary]{platform_machine == 'x86_64'} (==3.2.3)
TRACE Using preference psycopg 3.2.3
DEBUG Selecting: psycopg==3.2.3 [preference] (psycopg-3.2.3-py3-none-any.whl)
TRACE Using preference psycopg 3.2.3
TRACE cached request https://files.pythonhosted.org/packages/ce/21/534b8f5bd9734b7a2fcd3a16b1ee82ef6cad81a4796e95ebf4e0c6a24119/psycopg-3.2.3-py3-n
TRACE freshness lifetime found via cache-control max age setting: 365000000s
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/ce/21/534b8f5bd9734b7a2fcd3a16b1ee82ef6cad81a4796e95ebf4e0c6a24119/psycopg-
TRACE Received built distribution metadata for: psycopg==3.2.3
TRACE skipping backports-zoneinfo>=0.2.0 ; python_full_version < '3.9' because of Requires-Python: >=3.12
DEBUG Adding transitive dependency for psycopg==3.2.3: psycopg-binary{implementation_name != 'pypy'}>=3.2.3, <3.2.3+
INFO add_decision: psycopg[binary]{platform_machine == 'x86_64'} @ 3.2.3 without checking dependencies
DEBUG Searching for a compatible version of psycopg (==3.2.3)
TRACE Using preference psycopg 3.2.3
TRACE Fetching metadata for psycopg-binary from https://pypi.org/simple/psycopg-binary/
DEBUG Selecting: psycopg==3.2.3 [preference] (psycopg-3.2.3-py3-none-any.whl)
TRACE skipping backports-zoneinfo>=0.2.0 ; python_full_version < '3.9' because of Requires-Python: >=3.12
DEBUG Adding transitive dependency for psycopg==3.2.3: typing-extensions{python_full_version < '3.13'}>=4.6
DEBUG Adding transitive dependency for psycopg==3.2.3: tzdata{sys_platform == 'win32'}*
INFO add_decision: psycopg @ 3.2.3 without checking dependencies
DEBUG Searching for a compatible version of psycopg[binary] (==3.2.3)
TRACE Using preference psycopg 3.2.3
DEBUG Selecting: psycopg==3.2.3 [preference] (psycopg-3.2.3-py3-none-any.whl)
TRACE Fetching metadata for typing-extensions from https://pypi.org/simple/typing-extensions/
TRACE skipping backports-zoneinfo>=0.2.0 ; python_full_version < '3.9' because of Requires-Python: >=3.12
DEBUG Adding transitive dependency for psycopg==3.2.3: psycopg-binary{implementation_name != 'pypy'}>=3.2.3, <3.2.3+
INFO add_decision: psycopg[binary] @ 3.2.3 without checking dependencies
DEBUG Searching for a compatible version of psycopg{platform_machine == 'x86_64'} (==3.2.3)
TRACE Using preference psycopg 3.2.3
DEBUG Selecting: psycopg==3.2.3 [preference] (psycopg-3.2.3-py3-none-any.whl)
TRACE skipping backports-zoneinfo>=0.2.0 ; python_full_version < '3.9' because of Requires-Python: >=3.12
TRACE Fetching metadata for tzdata from https://pypi.org/simple/tzdata/
DEBUG Adding transitive dependency for psycopg==3.2.3: typing-extensions{python_full_version < '3.13'}>=4.6
DEBUG Adding transitive dependency for psycopg==3.2.3: tzdata{sys_platform == 'win32'}*
INFO add_decision: psycopg{platform_machine == 'x86_64'} @ 3.2.3 without checking dependencies
DEBUG Searching for a compatible version of psycopg{platform_machine == 'x86_64'} (>=3.2.3)
TRACE Using preference psycopg 3.2.3
DEBUG Selecting: psycopg==3.2.3 [preference] (psycopg-3.2.3-py3-none-any.whl)
DEBUG Adding transitive dependency for psycopg==3.2.3: psycopg==3.2.3
DEBUG Adding transitive dependency for psycopg==3.2.3: psycopg{platform_machine == 'x86_64'}==3.2.3
INFO add_decision: psycopg{platform_machine == 'x86_64'} @ 3.2.3 without checking dependencies
TRACE cached request https://pypi.org/simple/typing-extensions/ is storable because its response has a 'public' cache-control directive
TRACE freshness lifetime found via cache-control max age setting: 600s
DEBUG Found fresh response for: https://pypi.org/simple/typing-extensions/
TRACE Received package metadata for: typing-extensions
TRACE cached request https://pypi.org/simple/tzdata/ is storable because its response has a 'public' cache-control directive
TRACE freshness lifetime found via cache-control max age setting: 600s
DEBUG Found fresh response for: https://pypi.org/simple/tzdata/
TRACE Received package metadata for: tzdata
TRACE cached request https://pypi.org/simple/psycopg-binary/ is storable because its response has a 'public' cache-control directive
TRACE freshness lifetime found via cache-control max age setting: 600s
DEBUG Found fresh response for: https://pypi.org/simple/psycopg-binary/
TRACE Received package metadata for: psycopg-binary
DEBUG Searching for a compatible version of psycopg-binary{implementation_name != 'pypy'} (>=3.2.3, <3.2.3+)
TRACE Using preference psycopg-binary 3.2.3
DEBUG Selecting: psycopg-binary==3.2.3 [preference] (psycopg_binary-3.2.3-cp312-cp312-macosx_12_0_x86_64.whl)
DEBUG Adding transitive dependency for psycopg-binary==3.2.3: psycopg-binary==3.2.3
DEBUG Adding transitive dependency for psycopg-binary==3.2.3: psycopg-binary{implementation_name != 'pypy'}==3.2.3
INFO add_decision: psycopg-binary{implementation_name != 'pypy'} @ 3.2.3 without checking dependencies
DEBUG Searching for a compatible version of psycopg-binary{implementation_name != 'pypy'} (==3.2.3)
TRACE Using preference psycopg-binary 3.2.3
DEBUG Selecting: psycopg-binary==3.2.3 [preference] (psycopg_binary-3.2.3-cp312-cp312-macosx_12_0_x86_64.whl)
TRACE Using preference psycopg-binary 3.2.3
TRACE cached request https://files.pythonhosted.org/packages/55/6b/9805a5c743c1d54dcd035bd5c069202fde21b4cf69857ca40c2a55e69f8c/psycopg_binary-3.2.
TRACE freshness lifetime found via cache-control max age setting: 365000000s
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/55/6b/9805a5c743c1d54dcd035bd5c069202fde21b4cf69857ca40c2a55e69f8c/psycopg_
TRACE Received built distribution metadata for: psycopg-binary==3.2.3
INFO add_decision: psycopg-binary{implementation_name != 'pypy'} @ 3.2.3 without checking dependencies
DEBUG Searching for a compatible version of psycopg-binary (==3.2.3)
TRACE Using preference psycopg-binary 3.2.3
DEBUG Selecting: psycopg-binary==3.2.3 [preference] (psycopg_binary-3.2.3-cp312-cp312-macosx_12_0_x86_64.whl)
INFO add_decision: psycopg-binary @ 3.2.3 without checking dependencies
DEBUG Searching for a compatible version of typing-extensions{python_full_version < '3.13'} (>=4.6)
TRACE Using preference typing-extensions 4.12.2
DEBUG Selecting: typing-extensions==4.12.2 [preference] (typing_extensions-4.12.2-py3-none-any.whl)
DEBUG Adding transitive dependency for typing-extensions==4.12.2: typing-extensions==4.12.2
DEBUG Adding transitive dependency for typing-extensions==4.12.2: typing-extensions{python_full_version < '3.13'}==4.12.2
INFO add_decision: typing-extensions{python_full_version < '3.13'} @ 4.12.2 without checking dependencies
DEBUG Searching for a compatible version of typing-extensions{python_full_version < '3.13'} (==4.12.2)
TRACE Using preference typing-extensions 4.12.2
DEBUG Selecting: typing-extensions==4.12.2 [preference] (typing_extensions-4.12.2-py3-none-any.whl)
TRACE Using preference typing-extensions 4.12.2
TRACE cached request https://files.pythonhosted.org/packages/26/9f/ad63fc0248c5379346306f8668cda6e2e2e9c95e01216d2b8ffd9ff037d0/typing_extensions-4
TRACE freshness lifetime found via cache-control max age setting: 365000000s
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/26/9f/ad63fc0248c5379346306f8668cda6e2e2e9c95e01216d2b8ffd9ff037d0/typing_e
TRACE Received built distribution metadata for: typing-extensions==4.12.2
INFO add_decision: typing-extensions{python_full_version < '3.13'} @ 4.12.2 without checking dependencies
DEBUG Searching for a compatible version of typing-extensions (==4.12.2)
TRACE Using preference typing-extensions 4.12.2
DEBUG Selecting: typing-extensions==4.12.2 [preference] (typing_extensions-4.12.2-py3-none-any.whl)
INFO add_decision: typing-extensions @ 4.12.2 without checking dependencies
DEBUG Searching for a compatible version of tzdata{sys_platform == 'win32'} (*)
TRACE Using preference tzdata 2024.2
DEBUG Selecting: tzdata==2024.2 [preference] (tzdata-2024.2-py2.py3-none-any.whl)
DEBUG Adding transitive dependency for tzdata==2024.2: tzdata==2024.2
DEBUG Adding transitive dependency for tzdata==2024.2: tzdata{sys_platform == 'win32'}==2024.2
INFO add_decision: tzdata{sys_platform == 'win32'} @ 2024.2 without checking dependencies
DEBUG Searching for a compatible version of tzdata{sys_platform == 'win32'} (==2024.2)
TRACE Using preference tzdata 2024.2
DEBUG Selecting: tzdata==2024.2 [preference] (tzdata-2024.2-py2.py3-none-any.whl)
TRACE Using preference tzdata 2024.2
TRACE cached request https://files.pythonhosted.org/packages/a6/ab/7e5f53c3b9d14972843a647d8d7a853969a58aecc7559cb3267302c94774/tzdata-2024.2-py2.p
TRACE freshness lifetime found via cache-control max age setting: 365000000s
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/a6/ab/7e5f53c3b9d14972843a647d8d7a853969a58aecc7559cb3267302c94774/tzdata-2
TRACE Received built distribution metadata for: tzdata==2024.2
INFO add_decision: tzdata{sys_platform == 'win32'} @ 2024.2 without checking dependencies
DEBUG Searching for a compatible version of tzdata (==2024.2)
TRACE Using preference tzdata 2024.2
DEBUG Selecting: tzdata==2024.2 [preference] (tzdata-2024.2-py2.py3-none-any.whl)
INFO add_decision: tzdata @ 2024.2 without checking dependencies
DEBUG Tried 5 versions: pg 1, psycopg 1, psycopg-binary 1, typing-extensions 1, tzdata 1
DEBUG split `platform_machine == 'x86_64' and python_full_version >= '3.12'` resolution took 0.005s
DEBUG Solving split (platform_machine != 'x86_64' and python_full_version >= '3.12') (requires-python: RequiresPython { specifiers: VersionSpecifie
DEBUG Adding direct dependency: pg*
INFO add_decision: root @ 0a0.dev0 without checking dependencies
DEBUG Searching for a compatible version of pg @ file:///data/src/syn/test/testpsycopg (*)
TRACE skipping psycopg[binary]>=3.2.3 ; platform_machine == 'x86_64' because of split `platform_machine != 'x86_64' and python_full_version >= '3.1
DEBUG Pre-fork split `platform_machine != 'x86_64' and python_full_version >= '3.12'` took 0.000s
DEBUG Splitting resolution on pg==0.1.0 over psycopg into 2 resolution with separate markers
DEBUG Narrowed `requires-python` bound to: >=3.12
INFO add_decision: pg @ 0.1.0 without checking dependencies
DEBUG Narrowed `requires-python` bound to: >=3.12
DEBUG Adding transitive dependency for pg==0.1.0: psycopg{platform_machine == 'armv7l'}>=3.2.3
DEBUG Adding transitive dependency for pg==0.1.0: psycopg[c]>=3.2.3
INFO add_decision: pg @ 0.1.0 without checking dependencies
DEBUG Solving split (platform_machine == 'armv7l' and python_full_version >= '3.12') (requires-python: RequiresPython { specifiers: VersionSpecifie
DEBUG Searching for a compatible version of psycopg[c] (>=3.2.3)
TRACE Using preference psycopg 3.2.3
DEBUG Selecting: psycopg==3.2.3 [preference] (psycopg-3.2.3-py3-none-any.whl)
DEBUG Adding transitive dependency for psycopg==3.2.3: psycopg==3.2.3
DEBUG Adding transitive dependency for psycopg==3.2.3: psycopg[c]==3.2.3
DEBUG Adding transitive dependency for psycopg==3.2.3: psycopg{platform_machine == 'armv7l'}==3.2.3
DEBUG Adding transitive dependency for psycopg==3.2.3: psycopg[c]{platform_machine == 'armv7l'}==3.2.3
INFO add_decision: psycopg[c] @ 3.2.3 without checking dependencies
DEBUG Searching for a compatible version of psycopg[c]{platform_machine == 'armv7l'} (==3.2.3)
TRACE Using preference psycopg 3.2.3
DEBUG Selecting: psycopg==3.2.3 [preference] (psycopg-3.2.3-py3-none-any.whl)
TRACE Using preference psycopg 3.2.3
TRACE skipping backports-zoneinfo>=0.2.0 ; python_full_version < '3.9' because of Requires-Python: >=3.12
DEBUG Adding transitive dependency for psycopg==3.2.3: psycopg-c{implementation_name != 'pypy'}>=3.2.3, <3.2.3+
INFO add_decision: psycopg[c]{platform_machine == 'armv7l'} @ 3.2.3 without checking dependencies
DEBUG Searching for a compatible version of psycopg (==3.2.3)
TRACE Using preference psycopg 3.2.3
DEBUG Selecting: psycopg==3.2.3 [preference] (psycopg-3.2.3-py3-none-any.whl)
TRACE Fetching metadata for psycopg-c from https://pypi.org/simple/psycopg-c/
TRACE skipping backports-zoneinfo>=0.2.0 ; python_full_version < '3.9' because of Requires-Python: >=3.12
DEBUG Adding transitive dependency for psycopg==3.2.3: typing-extensions{python_full_version < '3.13'}>=4.6
DEBUG Adding transitive dependency for psycopg==3.2.3: tzdata{sys_platform == 'win32'}*
INFO add_decision: psycopg @ 3.2.3 without checking dependencies
DEBUG Searching for a compatible version of psycopg[c] (==3.2.3)
TRACE Using preference psycopg 3.2.3
DEBUG Selecting: psycopg==3.2.3 [preference] (psycopg-3.2.3-py3-none-any.whl)
TRACE skipping backports-zoneinfo>=0.2.0 ; python_full_version < '3.9' because of Requires-Python: >=3.12
DEBUG Adding transitive dependency for psycopg==3.2.3: psycopg-c{implementation_name != 'pypy'}>=3.2.3, <3.2.3+
INFO add_decision: psycopg[c] @ 3.2.3 without checking dependencies
DEBUG Searching for a compatible version of psycopg{platform_machine == 'armv7l'} (==3.2.3)
TRACE Using preference psycopg 3.2.3
DEBUG Selecting: psycopg==3.2.3 [preference] (psycopg-3.2.3-py3-none-any.whl)
TRACE skipping backports-zoneinfo>=0.2.0 ; python_full_version < '3.9' because of Requires-Python: >=3.12
TRACE cached request https://pypi.org/simple/psycopg-c/ is storable because its response has a 'public' cache-control directive
TRACE freshness lifetime found via cache-control max age setting: 600s
DEBUG Found fresh response for: https://pypi.org/simple/psycopg-c/
DEBUG Adding transitive dependency for psycopg==3.2.3: typing-extensions{python_full_version < '3.13'}>=4.6
DEBUG Adding transitive dependency for psycopg==3.2.3: tzdata{sys_platform == 'win32'}*
INFO add_decision: psycopg{platform_machine == 'armv7l'} @ 3.2.3 without checking dependencies
DEBUG Searching for a compatible version of psycopg{platform_machine == 'armv7l'} (>=3.2.3)
TRACE Using preference psycopg 3.2.3
DEBUG Selecting: psycopg==3.2.3 [preference] (psycopg-3.2.3-py3-none-any.whl)
TRACE Received package metadata for: psycopg-c
DEBUG Adding transitive dependency for psycopg==3.2.3: psycopg==3.2.3
DEBUG Adding transitive dependency for psycopg==3.2.3: psycopg{platform_machine == 'armv7l'}==3.2.3
INFO add_decision: psycopg{platform_machine == 'armv7l'} @ 3.2.3 without checking dependencies
DEBUG Searching for a compatible version of psycopg-c{implementation_name != 'pypy'} (>=3.2.3, <3.2.3+)
TRACE Selecting candidate for psycopg-c with range >=3.2.3, <3.2.3+ with 45 remote versions
TRACE Found candidate for package psycopg-c with range >=3.2.3, <3.2.3+ after 1 steps: 3.2.3 version
TRACE Returning candidate for package psycopg-c with range >=3.2.3, <3.2.3+ after 1 steps
DEBUG Selecting: psycopg-c==3.2.3 [compatible] (psycopg_c-3.2.3.tar.gz)
DEBUG Adding transitive dependency for psycopg-c==3.2.3: psycopg-c==3.2.3
DEBUG Adding transitive dependency for psycopg-c==3.2.3: psycopg-c{implementation_name != 'pypy'}==3.2.3
INFO add_decision: psycopg-c{implementation_name != 'pypy'} @ 3.2.3 without checking dependencies
DEBUG Searching for a compatible version of psycopg-c{implementation_name != 'pypy'} (==3.2.3)
TRACE Selecting candidate for psycopg-c with range ==3.2.3 with 45 remote versions
TRACE Found candidate for package psycopg-c with range ==3.2.3 after 1 steps: 3.2.3 version
TRACE Returning candidate for package psycopg-c with range ==3.2.3 after 1 steps
DEBUG Selecting: psycopg-c==3.2.3 [compatible] (psycopg_c-3.2.3.tar.gz)
TRACE Selecting candidate for psycopg-c with range ==3.2.3 with 45 remote versions
TRACE Found candidate for package psycopg-c with range ==3.2.3 after 1 steps: 3.2.3 version
TRACE Returning candidate for package psycopg-c with range ==3.2.3 after 1 steps
TRACE Checking lock for `/home/zarch/.cache/uv/sdists-v6/pypi/psycopg-c/3.2.3` at `/home/zarch/.cache/uv/sdists-v6/pypi/psycopg-c/3.2.3/.lock`
DEBUG Acquired lock for `/home/zarch/.cache/uv/sdists-v6/pypi/psycopg-c/3.2.3`
TRACE cached request https://files.pythonhosted.org/packages/53/ba/74caf4eab78d95a173e65cb81507a589365aeafb1d9c84f374002b51dc53/psycopg_c-3.2.3.tar
TRACE freshness lifetime found via cache-control max age setting: 365000000s
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/53/ba/74caf4eab78d95a173e65cb81507a589365aeafb1d9c84f374002b51dc53/psycopg_
DEBUG No static `pyproject.toml` available for: psycopg-c==3.2.3 (PyprojectToml(FieldNotFound("project")))
DEBUG No static `PKG-INFO` available for: psycopg-c==3.2.3 (PkgInfo(UnsupportedMetadataVersion("2.1")))
DEBUG No static `egg-info` available for: psycopg-c==3.2.3 (MissingRequiresTxt)
DEBUG Preparing metadata for: psycopg-c==3.2.3
DEBUG Ignoring empty directory
DEBUG Resolving build requirements
DEBUG Solving with installed Python version: 3.12.7
DEBUG Solving with target Python version: >=3.12.7
TRACE skipping tomli>=2.0.1 ; python_full_version < '3.11' because of Requires-Python: >=3.12.7
DEBUG Adding direct dependency: setuptools>=49.2.0
DEBUG Adding direct dependency: wheel>=0.37
INFO add_decision: root @ 0a0.dev0 without checking dependencies
TRACE Fetching metadata for setuptools from https://pypi.org/simple/setuptools/
TRACE Fetching metadata for wheel from https://pypi.org/simple/wheel/
TRACE cached request https://pypi.org/simple/wheel/ is storable because its response has a 'public' cache-control directive
TRACE freshness lifetime found via cache-control max age setting: 600s
DEBUG Found fresh response for: https://pypi.org/simple/wheel/
TRACE Received package metadata for: wheel
TRACE Selecting candidate for wheel with range >=0.37 with 77 remote versions
TRACE Found candidate for package wheel with range >=0.37 after 1 steps: 0.45.0 version
TRACE Returning candidate for package wheel with range >=0.37 after 1 steps
TRACE cached request https://files.pythonhosted.org/packages/92/81/65ae90d584a73ca976d8f1eb83e2f58447a4055a9fb3ae69b28721070bdf/wheel-0.45.0-py3-no
TRACE freshness lifetime found via cache-control max age setting: 365000000s
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/92/81/65ae90d584a73ca976d8f1eb83e2f58447a4055a9fb3ae69b28721070bdf/wheel-0.
TRACE Received built distribution metadata for: wheel==0.45.0
TRACE cached request https://pypi.org/simple/setuptools/ is storable because its response has a 'public' cache-control directive
TRACE freshness lifetime found via cache-control max age setting: 600s
DEBUG Found fresh response for: https://pypi.org/simple/setuptools/
TRACE Received package metadata for: setuptools
TRACE Selecting candidate for setuptools with range >=49.2.0 with 584 remote versions
DEBUG Searching for a compatible version of setuptools (>=49.2.0)
TRACE Selecting candidate for setuptools with range >=49.2.0 with 584 remote versions
TRACE Found candidate for package setuptools with range >=49.2.0 after 1 steps: 75.5.0 version
TRACE Found candidate for package setuptools with range >=49.2.0 after 1 steps: 75.5.0 version
TRACE Returning candidate for package setuptools with range >=49.2.0 after 1 steps
TRACE Returning candidate for package setuptools with range >=49.2.0 after 1 steps
DEBUG Selecting: setuptools==75.5.0 [compatible] (setuptools-75.5.0-py3-none-any.whl)
TRACE cached request https://files.pythonhosted.org/packages/fe/df/88ccbee85aefbca071db004fdc8f8d2507d55d5a9dc27ebb93c92edb1bd8/setuptools-75.5.0-p
TRACE freshness lifetime found via cache-control max age setting: 365000000s
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/fe/df/88ccbee85aefbca071db004fdc8f8d2507d55d5a9dc27ebb93c92edb1bd8/setuptoo
TRACE Received built distribution metadata for: setuptools==75.5.0
TRACE skipping importlib-metadata>=6 ; python_full_version < '3.10' and extra == 'core' because of Requires-Python: >=3.12.7
TRACE skipping tomli>=2.0.1 ; python_full_version < '3.11' and extra == 'core' because of Requires-Python: >=3.12.7
TRACE skipping importlib-metadata>=7.0.2 ; python_full_version < '3.10' and extra == 'type' because of Requires-Python: >=3.12.7
INFO add_decision: setuptools @ 75.5.0 without checking dependencies
DEBUG Searching for a compatible version of wheel (>=0.37)
TRACE Selecting candidate for wheel with range >=0.37 with 77 remote versions
TRACE Found candidate for package wheel with range >=0.37 after 1 steps: 0.45.0 version
TRACE Returning candidate for package wheel with range >=0.37 after 1 steps
DEBUG Selecting: wheel==0.45.0 [compatible] (wheel-0.45.0-py3-none-any.whl)
INFO add_decision: wheel @ 0.45.0 without checking dependencies
DEBUG Tried 2 versions: setuptools 1, wheel 1
DEBUG marker environment resolution took 0.002s
TRACE Resolution: ResolverEnvironment { kind: Specific { marker_env: ResolverMarkerEnvironment(MarkerEnvironment { inner: MarkerEnvironmentInner {
TRACE Resolution edge: ROOT -> wheel
TRACE Resolution edge:     0a0.dev0 -> 0.45.0
TRACE Resolution edge: ROOT -> setuptools
TRACE Resolution edge:     0a0.dev0 -> 75.5.0
DEBUG Installing in wheel==0.45.0, setuptools==75.5.0 in /home/zarch/.cache/uv/builds-v0/.tmpDv3v5T
DEBUG Requirement already cached: wheel==0.45.0
DEBUG Requirement already cached: setuptools==75.5.0
DEBUG Installing build requirements: wheel==0.45.0, setuptools==75.5.0
TRACE Extracting file name=PackageName("wheel")
TRACE Extracting file name=PackageName("setuptools")
TRACE Extracted 37 files name=PackageName("wheel")
TRACE Writing entrypoints name=PackageName("wheel")
TRACE No data name=PackageName("wheel")
TRACE Writing extra metadata name=PackageName("wheel")
TRACE Writing record name=PackageName("wheel")
TRACE Extracted 504 files name=PackageName("setuptools")
TRACE No entrypoints name=PackageName("setuptools")
TRACE No data name=PackageName("setuptools")
TRACE Writing extra metadata name=PackageName("setuptools")
TRACE Writing record name=PackageName("setuptools")
DEBUG Creating PEP 517 build environment
DEBUG Calling `cython_backend.get_requires_for_build_wheel()`
DEBUG Calling `cython_backend.prepare_metadata_for_build_wheel()`
DEBUG running dist_info
DEBUG creating /home/zarch/.cache/uv/builds-v0/.tmpDv3v5T/metadata_directory/psycopg_c.egg-info
DEBUG writing /home/zarch/.cache/uv/builds-v0/.tmpDv3v5T/metadata_directory/psycopg_c.egg-info/PKG-INFO
DEBUG writing dependency_links to /home/zarch/.cache/uv/builds-v0/.tmpDv3v5T/metadata_directory/psycopg_c.egg-info/dependency_links.txt
DEBUG writing top-level names to /home/zarch/.cache/uv/builds-v0/.tmpDv3v5T/metadata_directory/psycopg_c.egg-info/top_level.txt
DEBUG writing manifest file '/home/zarch/.cache/uv/builds-v0/.tmpDv3v5T/metadata_directory/psycopg_c.egg-info/SOURCES.txt'
DEBUG couldn't run 'pg_config' --includedir: [Errno 2] No such file or directory: 'pg_config'
DEBUG error: [Errno 2] No such file or directory: 'pg_config'
DEBUG Released lock at `/home/zarch/.cache/uv/sdists-v6/pypi/psycopg-c/3.2.3/.lock`
TRACE Received source distribution metadata for: psycopg-c==3.2.3
  × Failed to download and build `psycopg-c==3.2.3`
  ╰─▶ Build backend failed to determine metadata through `prepare_metadata_for_build_wheel` (exit status: 1)

      [stdout]
      running dist_info
      creating /home/zarch/.cache/uv/builds-v0/.tmpDv3v5T/metadata_directory/psycopg_c.egg-info
      writing /home/zarch/.cache/uv/builds-v0/.tmpDv3v5T/metadata_directory/psycopg_c.egg-info/PKG-INFO
      writing dependency_links to /home/zarch/.cache/uv/builds-v0/.tmpDv3v5T/metadata_directory/psycopg_c.egg-info/dependency_links.txt
      writing top-level names to /home/zarch/.cache/uv/builds-v0/.tmpDv3v5T/metadata_directory/psycopg_c.egg-info/top_level.txt
      writing manifest file '/home/zarch/.cache/uv/builds-v0/.tmpDv3v5T/metadata_directory/psycopg_c.egg-info/SOURCES.txt'

      [stderr]
      couldn't run 'pg_config' --includedir: [Errno 2] No such file or directory: 'pg_config'
      error: [Errno 2] No such file or directory: 'pg_config'

  help: `psycopg-c` was included because `pg==0.1.0` depends on `psycopg==3.2.3` which depends on `psycopg-c==3.2.3` which depends on
        `psycopg-c`
```


---

_Comment by @konstin on 2024-11-20 12:40_

uv tries to build a universal resolution that works on all targets, so it needs to know the dependencies of psycopg-c to lock only packages that are compatible on armv7l. In this case, we need to build because psycopg-c has only a source distribution, and this specific source distribution doesn't tell us dependency metadata without a build. There are some options for this:

* Installing the postgres headers on your dev machine (they don't need to exist on x86_64 target machines)
* psycopg-c updates their build backend to publish a source distribution with Metadata-Version 2.2 or higher. Currently, the source distribution has Metadata-Version 2.1, which uv can't use for resolution (https://peps.python.org/pep-0643/)
* Specify an override https://docs.astral.sh/uv/concepts/resolution/#dependency-metadata

---

> ```toml
> dependencies = [
>    "psycopg[binary]>=3.2.3; platform_machine == 'x86_64'",
>    "psycopg[c]>=3.2.3; platform_machine == 'armv7l'",
> ]
> ```

Note that you're now not installing psycopg at all on other architectures. If you're only interested in those two architectures, you can set `tool.uv.environments` to those two.

---

> I've noticed that the function [platform_machine](https://github.com/astral-sh/uv/blob/ccc0962cbd01777a53aa2dec8ff2b8f0f7de3a70/crates/uv-configuration/src/target_triple.rs#L404) defined in uv-configuration does not return armv7l pip allow archs seems to be, [see](https://github.com/pypa/pip/blob/fe0925b3c00bf8956a0d33408df692ac364217d4/src/pip/_vendor/packaging/_manylinux.py#L55)

These are only used for downloading pre-built python interpreters (because we don't have a python interpreter yet as reference), which have a limited list of supported platforms. When resolving or installing, we're asking the real python interpreter for its values for the environment markers.

---

_Comment by @zarch on 2024-11-20 14:58_

Hi @konstin,

thank you for the support!

> Installing the postgres headers on your dev machine (they don't need to exist on x86_64 target machines)

I confirm that installing on my `x86_64` machine the `libpq-dev` fix the issues, `uv` is able to sync without compiling.

---

_Closed by @zarch on 2024-11-20 14:58_

---
