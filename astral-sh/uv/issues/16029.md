```yaml
number: 16029
title: Confused about publishing workspace members
type: issue
state: open
author: anentropic
labels:
  - question
assignees: []
created_at: 2025-09-25T18:08:59Z
updated_at: 2025-10-16T14:41:09Z
url: https://github.com/astral-sh/uv/issues/16029
synced_at: 2026-01-10T01:57:35Z
```

# Confused about publishing workspace members

---

_Issue opened by @anentropic on 2025-09-25 18:08_

### Question

I have a workspace project with multiple libs in it, i.e. a root `pyproject.toml` and then libs in sub-dirs each with a `pyproject.toml`

I want to publish the libs to a private AWS CodeArtifact repository

My first thought was just to cd into each lib and run `uv publish`.

I added `[[tool.uv.index]]` block to each of the libs' `pyproject.toml` files. But `uv publish --index myindex` returned:

> error: No indexes were found, can't use index: myindex

Removing the index blocks from the libs and adding it instead to the root workspace `pyproject.toml` brought progress. This means that although I'm cd'd into the lib package dir, it's the parent workspace config which `uv publish --index myindex` is looking at.

Next I got:

> error: No files found to publish

I realised I was supposed to `uv build` first.

Adding that step I see output like:

> adding 'mylib/__init__.py'
> adding 'mylib/cli.py'
> adding 'mylib/errors.py'
> adding 'mylib-2025.9.24.0+263c8ca.dist-info/METADATA'
> adding 'mylib-2025.9.24.0+263c8ca.dist-info/WHEEL'
> adding 'mylib-2025.9.24.0+263c8ca.dist-info/entry_points.txt'
> adding 'mylib-2025.9.24.0+263c8ca.dist-info/top_level.txt'
> adding 'mylib-2025.9.24.0+263c8ca.dist-info/RECORD'
> removing build/bdist.linux-x86_64/wheel
> Successfully built /home/circleci/project/libs/dist/mylib-2025.9.24.0+263c8ca.tar.gz
> Successfully built /home/circleci/project/libs/dist/mylib-2025.9.24.0+263c8ca-py3-none-any.whl
> error: No files found to publish
> 
> Exited with code exit status 2

Although I am cd'd into `/home/circleci/project/libs/mylib` this seems to have built the result to `/home/circleci/project/libs` i.e. the workspace root, and then `uv publish` doesn't find it.

So first up I am confused about when/why the `uv` command is preferring the parent workspace vs the local project context, it seems a bit half one and half the other.

Amending the build command to `uv build ./` solves that for now.

### Platform

macOS 14.6.1 arm64

### Version

uv 0.7.13 (62ed17b23 2025-06-12)

---

_Label `question` added by @anentropic on 2025-09-25 18:09_

---

_Comment by @anentropic on 2025-09-25 18:43_

Also...

I have ended up with `uv publish --check-url "$REPO_URL" --publish-url "$REPO_URL"` (I removed the `[[index]]` toml config that was only wanted for publishing) 

But when I re-run the CI job I still get:

> Uploading mylib-2025.9.24.0+263c8ca-py3-none-any.whl (5.4KiB)
> error: Failed to publish `dist/mylib-2025.9.24.0+263c8ca-py3-none-any.whl` to https://anentropic-************.d.codeartifact.eu-west-1.amazonaws.com/pypi/repo
>   Caused by: Upload failed with status code 409 Conflict. Server says: Asset 'mylib-2025.9.24.0+263c8ca-py3-none-any.whl' already exists.

I thought the `--check-url` was supposed to prevent that error?

---

_Assigned to @konstin by @zanieb on 2025-09-25 18:50_

---

_Comment by @konstin on 2025-09-26 13:33_

The idea with workspace is that you can build and publish from the workspace root. You could build and publish two libraries `foolib` and `barlib` with one command:

```
uv build --package foolib
uv build --package barlib
uv publish
```

The matching index configuration also goes into the workspace root `pyproject.toml`, you should usually only need to a publish URL to your existing index.

Re `uv publish --check-url "$REPO_URL" --publish-url "$REPO_URL"`: `--check-url` and `--publish-url` should be different, is `--check-url` the simple index URL matching `--publish-url`?

---

_Comment by @anentropic on 2025-09-26 13:38_

currently `export REPO_URL="https://anentropic-<account>.d.codeartifact.eu-west-1.amazonaws.com/pypi/myrepo"`

I had `/simple` on the end previously but publishing didn't work

should `--check-url` have `/simple` on the end?

---

_Comment by @anentropic on 2025-09-26 13:39_

(thanks for your attention!)

---

_Comment by @konstin on 2025-09-26 13:39_

Yes, `--check-url` needs to be the URL that you can install from with `uv pip install --index-url`.

---

_Comment by @anentropic on 2025-09-29 13:02_

`uv publish --check-url "$REPO_URL/simple" --publish-url "$REPO_URL"`
`uv publish --check-url "$REPO_URL" --publish-url "$REPO_URL"`
both give the same 409 error

is `--check-url` able to use the `UV_PUBLISH_PASSWORD` to authenticate against the private repo?

I'm wondering if the check fails silently and uv falls back to attempting to publish 

---

_Comment by @konstin on 2025-09-29 13:03_

Can you try with the latest version? There was a bug of not using `UV_PUBLISH_PASSWORD` that has been fixed a while ago.

Can you run with `-v` if that doesn't work? This should give you more information. 

---

_Comment by @anentropic on 2025-09-29 13:18_

```
DEBUG uv 0.8.22
DEBUG Not a distribution filename: `.gitignore`
Publishing 2 files to https://anentropic-************.d.codeartifact.eu-west-1.amazonaws.com/pypi/myrepo
DEBUG Using request timeout of 900s
DEBUG Checking for anentropic_mylib-2025.9.24.0+263c8ca-py3-none-any.whl in the registry
DEBUG No cache entry for: https://anentropic-************.d.codeartifact.eu-west-1.amazonaws.com/pypi/myrepo/simple/anentropic-dbt-yaml-merge/
DEBUG No netrc file found
DEBUG Acquired lock for `credentials store`
DEBUG Released lock at `/home/circleci/.local/share/uv/credentials/credentials.toml.lock`
DEBUG No credentials file found at /home/circleci/.local/share/uv/credentials/credentials.toml
DEBUG Indexes search failed because of status code failure: 401 Unauthorized
WARN Package not found in the registry; skipping upload check for anentropic_mylib-2025.9.24.0+263c8ca-py3-none-any.whl
Uploading anentropic_mylib-2025.9.24.0+263c8ca-py3-none-any.whl (5.4KiB)
DEBUG Hashing dist/anentropic_mylib-2025.9.24.0+263c8ca-py3-none-any.whl
DEBUG Skipping validation request for unsupported publish URL: https://anentropic-************.d.codeartifact.eu-west-1.amazonaws.com/pypi/myrepo
DEBUG Using HTTP Basic authentication
DEBUG Response code for https://anentropic-************.d.codeartifact.eu-west-1.amazonaws.com/pypi/myrepo: 409 Conflict
DEBUG Upload error response: Asset 'anentropic_mylib-2025.9.24.0+263c8ca-py3-none-any.whl' already exists.
DEBUG Checking for anentropic_mylib-2025.9.24.0+263c8ca-py3-none-any.whl in the registry
DEBUG No cache entry for: https://anentropic-************.d.codeartifact.eu-west-1.amazonaws.com/pypi/myrepo/simple/anentropic-dbt-yaml-merge/
DEBUG Indexes search failed because of status code failure: 401 Unauthorized
WARN Package not found in the registry; skipping upload check for anentropic_mylib-2025.9.24.0+263c8ca-py3-none-any.whl
error: Failed to publish `dist/anentropic_mylib-2025.9.24.0+263c8ca-py3-none-any.whl` to https://anentropic-************.d.codeartifact.eu-west-1.amazonaws.com/pypi/myrepo
  Caused by: Upload failed with status code 409 Conflict. Server says: Asset 'anentropic_mylib-2025.9.24.0+263c8ca-py3-none-any.whl' already exists.

Exited with code exit status 2
```
this is with `export UV_PUBLISH_PASSWORD="$AWS_CODEARTIFACT_TOKEN"` just before it


---

_Comment by @anentropic on 2025-09-29 13:31_

adding `/simple` to the publish-url didn't help

> DEBUG Skipping validation request for unsupported publish URL: https://anentropic-************.d.codeartifact.eu-west-1.amazonaws.com/pypi/myrepo/simple

maybe the problem is 
> DEBUG Indexes search failed because of status code failure: 401 Unauthorized

---

_Comment by @konstin on 2025-09-29 13:33_

Sorry, I misunderstood the question, `--check-url` uses regular index authentication, not the publish credentials. (This is because there's often separate keys for read (simple index) access and write (publish) access)

---

_Comment by @anentropic on 2025-09-29 15:48_

I added `UV_INDEX_PRIVATE_REGISTRY_USERNAME` and `UV_INDEX_PRIVATE_REGISTRY_PASSWORD` env var exports but it didn't help, there is still `DEBUG Indexes search failed because of status code failure: 401 Unauthorized`

---

_Comment by @konstin on 2025-09-29 16:08_

Does `uv pip install --index-url <check-url> anentropic_mylib==2025.9.24.0+263c8ca` work?

---

_Comment by @anentropic on 2025-09-29 16:17_

yes install succeeds

---

_Comment by @anentropic on 2025-09-30 10:10_

I can sort of get around this at bash level by grepping for "status code 409" in the error response from `uv publish` and ignoring that error, if I keep cd-ing into each package and publishing individually

> The idea with workspace is that you can build and publish from the workspace root. You could build and publish two libraries `foolib` and `barlib` with one command:
> 
> ```
> uv build --package foolib
> uv build --package barlib
> uv publish
> ```

`uv build --all-packages` works nicely for what I need, it builds workspace members but not the workspace itself

but to do an all in one `uv publish` I need the check-url stuff to work, otherwise it fails on first package without trying the rest

The latest code I tried is:

```bash
export REPO_URL="https://********.d.codeartifact.eu-west-1.amazonaws.com/pypi/myrepo"

cat \<< EOF > uv.toml
[[index]]
name = "hub"
url = "$REPO_URL/simple/"
explicit = true
EOF

export UV_INDEX_HUB_USERNAME=aws
export UV_INDEX_HUB_PASSWORD="$AWS_CODEARTIFACT_TOKEN"
export UV_PUBLISH_USERNAME=aws
export UV_PUBLISH_PASSWORD="$AWS_CODEARTIFACT_TOKEN"

uv build --all-packages
uv publish -v \
  --check-url "$REPO_URL/simple/" \
  --publish-url "$REPO_URL"
```

but it gets `DEBUG Indexes search failed because of status code failure: 401 Unauthorized`

I am unclear which auth args / env vars are required for the check-url request ?

It doesn't seem to use either the 'index' or the 'publish' creds?

---

_Comment by @anentropic on 2025-09-30 10:59_

I'm not very good at reading Rust code but it looks to me like the check-url request doesn't use any credentials

First here in `publish` we gather credentials:
https://github.com/astral-sh/uv/blob/ab2f394019903b2ea1245e3188b4deda65d6c6fe/crates/uv/src/commands/publish.rs#L139-L152

Later the `validate` and `upload` calls both take those credentials and use them:
https://github.com/astral-sh/uv/blob/ab2f394019903b2ea1245e3188b4deda65d6c6fe/crates/uv/src/commands/publish.rs#L205-L232

But before that the `check_url` request doesn't appear to take any credentials:
https://github.com/astral-sh/uv/blob/ab2f394019903b2ea1245e3188b4deda65d6c6fe/crates/uv/src/commands/publish.rs#L160-L174

So I feel like this is never going to work for private repos currently?

For now I guess I will roll my own check by comparing `aws codeartifact list-package-versions ... | jq ".defaultDisp
layVersion"` and `uv version --short` (iterating over packages within the workspace in a loop as I was originally)

---

_Comment by @konstin on 2025-10-15 21:19_

Does it work with this?

```bash
export REPO_URL="https://********.d.codeartifact.eu-west-1.amazonaws.com/pypi/myrepo"

cat \<< EOF > uv.toml
[[index]]
name = "hub"
url = "$REPO_URL/simple/"
publish-url =  "$REPO_URL"
explicit = true
EOF

export UV_INDEX_HUB_USERNAME=aws
export UV_INDEX_HUB_PASSWORD="$AWS_CODEARTIFACT_TOKEN"
export UV_PUBLISH_USERNAME=aws
export UV_PUBLISH_PASSWORD="$AWS_CODEARTIFACT_TOKEN"

uv build --all-packages
uv publish -v --index hub
```

Regarding the Rust implementation, the check URL credentials are fetched the same way they are for `uv pip install`, only the publish credentials are implemented separately in the publish code. There's several sources and layers that process them, from the `AuthMiddleware` over `cache_index_credentials` to the passed optional keyring.



---

_Comment by @anentropic on 2025-10-16 12:35_

I haven't tried it yet but the above probably works... my understanding was that without `--check-url` no "already published" check is made, and it seemed to be that step that is failing after the rest of it was working fine

---

_Comment by @konstin on 2025-10-16 14:41_

`--index` also does this check by reading `index.url`; It's usually the better check. I'm a bit surprised at the difference with `uv pip install` wrt to authentication, I might need to dig into this, though I'd like to confirm that `--index` works as expected for that.

---
