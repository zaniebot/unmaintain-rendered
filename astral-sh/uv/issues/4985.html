<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv pip compile --no-build` won't build when using dynamic metadata for dependencies in `pyproject.toml` - astral-sh/uv #4985</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`uv pip compile --no-build` won't build when using dynamic metadata for dependencies in `pyproject.toml`</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/4985">#4985</a>
        opened by <a href="https://github.com/9ao9ai9ar">@9ao9ai9ar</a>
        on 2024-07-11 04:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/9ao9ai9ar">@9ao9ai9ar</a> on 2024-07-11 04:11</div>
            <div class="timeline-body"><p>I am trying to use the <a href="https://pip.pypa.io/en/stable/topics/secure-installs/">secure installs</a> mechanism of <code>pip</code>, but encounters a problem when I specify the dependencies as dynamic metadata inside my <code>pyproject.toml</code> file:</p>
<pre><code class="language-toml">[build-system]
requires = [&quot;setuptools &gt;= 65.5.1&quot;]
build-backend = &quot;setuptools.build_meta&quot;

[project]
name = &quot;my-project&quot;
version = &quot;2024.07.11&quot;
requires-python = &quot;&gt;= 3.10&quot;
dynamic = [&quot;dependencies&quot;, &quot;optional-dependencies&quot;]

[tool.setuptools.packages.find]
namespaces = false

[tool.setuptools.dynamic]
dependencies = { file = [&quot;requirements/base.in&quot;] }
optional-dependencies.dev = { file = [&quot;requirements/dev.in&quot;] }

[tool.uv]
native-tls = true

[tool.uv.pip]
emit-index-url = true
generate-hashes = true
no-build = true
no-deps = true
python-version = &quot;3.10&quot;
require-hashes = true
strict = true
universal = true
upgrade = true
</code></pre>
<p>The output:</p>
<pre><code class="language-powershell">&gt; uv pip compile .\pyproject.toml --verbose --output-file=requirements.txt
DEBUG uv 0.2.23
DEBUG Starting Python discovery for Python 3.10
DEBUG Looking for exact match for request Python 3.10
DEBUG Searching for Python 3.10 in system path or `py` launcher
DEBUG Found cpython 3.12.4 at `[omitted]` (active virtual environment)
DEBUG Found cpython 3.12.4 at `[omitted]` (virtual environment)
DEBUG Found cpython 3.12.4 at `[omitted]` (search path)
DEBUG Looking for Python installation with any version
DEBUG Searching for Python interpreter in system path or `py` launcher
DEBUG Found cpython 3.12.4 at `[omitted]` (active virtual environment)
DEBUG Using Python 3.12.4 interpreter at .venv\Scripts\python.exe for builds
warning: The requested Python version 3.10 is not available; 3.12.4 will be used to build dependencies instead.
DEBUG Using request timeout of 30s
error: Building source distributions is disabled
</code></pre>
<p>The same configuration seems to work fine in <code>pip-tools</code>. I can work around this in <code>uv</code> if I specify <code>dependencies</code> and <code>optional-dependencies</code> statically; or by commenting out the <code>no-build = true</code> line, but then an unwanted <code>my-project.egg-info</code> directory gets created, which doesn't happen with the first workaround (<code>my-project</code> is in flat layout intended to be run as a script).</p>
<p>Is this intended behavior or a bug?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-11 04:57</div>
            <div class="timeline-body"><p>If you set <code>no-build = true</code>, we won't run the arbitrary Python code required to determine your project's dependencies, because such builds are explicitly disabled. So I think this is intended?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/9ao9ai9ar">@9ao9ai9ar</a> on 2024-07-11 12:49</div>
            <div class="timeline-body"><p>Dumb question: what is the &quot;arbitrary Python code&quot; required to determine my project's dependencies? Can I whitelist it using <code>--no-binary</code>? What I don't understand is why the same configuration works when the dependencies aren't set external to <code>pyproject.toml</code>? I could also run <code>pip install --only-binary=:all: --use-pep517 -r .\requirements\base.in</code> without problems, if the flags are supposed to mean the same thing.</p>
<p>Something is clearly wrong with Python's packaging story when like half of all PEPs revolve around it. But I digress. I still want to list my dependencies in a requirements file to save typing those <code>&quot;</code> and <code>,</code>, and because it is cleaner and more VCS-friendly. Anyways, if I understood the article section <a href="https://lil.law.harvard.edu/blog/2019/05/20/improving-pip-compile-generate-hashes/#the-problem-with-pinning-python-packages">The problem with pinning Python packages</a> correctly, specifying <code>no-build = true</code> is actually more susceptible to supply chain attacks than <code>no-binary = true</code>, so I might just not use it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-12 21:06</div>
            <div class="timeline-body"><p>Yeah, you can actually do this:</p>
<pre><code class="language-toml">[tool.uv.pip]
no-build = true
no-binary = [&quot;my-project&quot;]
</code></pre>
<p>To &quot;override&quot; the <code>no-build</code> setting, and allow that specific package.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-12 21:11</div>
            <div class="timeline-body"><blockquote>
<p>Dumb question: what is the &quot;arbitrary Python code&quot; required to determine my project's dependencies?</p>
</blockquote>
<p>We're a little stricter about <code>--no-build</code>. When metadata is &quot;dynamic&quot;, the way it gets filled-in is that you have to create a virtual environment, install the package's build backend, and ask the backend to determine the dynamic values. We don't allow that to happen when <code>--no-build</code> is specified, since the intent there is that we won't run that &quot;arbitrary&quot; Python code that packages need to fill in the dynamic values.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-12 21:12</div>
            <div class="timeline-body"><p>IIRC, pip doesn't actually enforce <code>--no-build</code> and <code>--no-binary</code> for direct URL dependencies at all. For example, this works:</p>
<pre><code>pip install --force-reinstall --only-binary :all: https://files.pythonhosted.org/packages/41/e1/d104c83026f8d35dfd2c261df7d64738341067526406b40190bc063e829a/flask-3.0.3.tar.gz
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-12 21:12</div>
            <div class="timeline-body"><p>See https://github.com/astral-sh/uv/blob/main/PIP_COMPATIBILITY.md#--only-binary-enforcement for documentation on that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-07-12 21:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2024-07-12 21:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/9ao9ai9ar">@9ao9ai9ar</a> on 2024-07-13 07:03</div>
            <div class="timeline-body"><blockquote>
<p>Yeah, you can actually do this:</p>
<pre><code class="language-toml">[tool.uv.pip]
no-build = true
no-binary = [&quot;my-project&quot;]
</code></pre>
<p>To &quot;override&quot; the <code>no-build</code> setting, and allow that specific package.</p>
</blockquote>
<p>Ahh, I was whitelisting the package <code>myproject</code> only, not the whole project. Thank you for pointing it out for me.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:30 UTC
    </footer>
</body>
</html>
