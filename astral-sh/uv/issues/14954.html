<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv lock --upgrade-package doesn't update git commit hash for individual subdirectory dependencies from the same repository - astral-sh/uv #14954</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>uv lock --upgrade-package doesn't update git commit hash for individual subdirectory dependencies from the same repository</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/14954">#14954</a>
        opened by <a href="https://github.com/redartera">@redartera</a>
        on 2025-07-29 13:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/redartera">@redartera</a> on 2025-07-29 13:11</div>
            <div class="timeline-body"><h2>Description</h2>
<p>When using <code>uv lock --upgrade-package</code> to update a specific git dependency that comes from a subdirectory of a repository, the commit hash in <code>uv.lock</code> is not updated unless <strong>all</strong> dependencies from the same repository are included in the upgrade command. This behavior is unexpected and makes it difficult to selectively update individual packages.</p>
<p>The goal here is to keep updating a git-based dependency when new commits are pushed to its <code>main</code> branch.</p>
<p>This issue is related to #4317 but focuses on a specific edge case with subdirectory dependencies.</p>
<h2>Current Behavior</h2>
<p>Given a <code>pyproject.toml</code> with multiple dependencies from different subdirectories of the same git repository:</p>
<pre><code class="language-toml">[project]
name = &quot;foobar&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.11&quot;
dependencies = [
    &quot;package-a&quot;,
    &quot;package-b&quot;, 
    &quot;package-c&quot;,
]

[tool.uv.sources]
package-a = { git = &quot;https://github.com/example/monorepo.git&quot;, subdirectory = &quot;libs/package-a&quot; }
package-b = { git = &quot;https://github.com/example/monorepo.git&quot;, subdirectory = &quot;libs/package-b&quot; }
package-c = { git = &quot;https://github.com/example/monorepo.git&quot;, subdirectory = &quot;libs/package-c&quot; }
</code></pre>
<p>Running:</p>
<pre><code class="language-bash">uv lock --upgrade-package package-a
</code></pre>
<p>Does <strong>not</strong> update the commit hash in <code>uv.lock</code> even if new commits exist in the repository.</p>
<h2>Expected Behavior</h2>
<p>The command should update the commit hash for the specified package to the latest commit from the repository's default branch.</p>
<h2>Workaround</h2>
<p>Currently, the only way to update the commit hash is to include ALL packages from the same repository:</p>
<pre><code class="language-bash">uv lock --upgrade-package package-a --upgrade-package package-b --upgrade-package package-c
</code></pre>
<p>This is less invasive than <code>uv lock --upgrade</code> which would upgrade all dependencies in the project, but still requires knowing and listing all packages from the same repository.</p>
<h2>Reproduction Steps</h2>
<ol>
<li>Create a <code>pyproject.toml</code> with multiple dependencies from subdirectories of the same git repository</li>
<li>Run <code>uv lock</code> to create initial lock file</li>
<li>Wait for new commits to be pushed to the git repository</li>
<li>Run <code>uv lock --upgrade-package &lt;single-package-name&gt;</code></li>
<li>Observe that the commit hash in <code>uv.lock</code> is not updated</li>
<li>Run <code>uv lock --upgrade-package &lt;package-a&gt; --upgrade-package &lt;package-b&gt; --upgrade-package &lt;package-c&gt;</code> (all packages from the repo)</li>
<li>Observe that now the commit hash is updated</li>
</ol>
<h2>Environment</h2>
<ul>
<li>uv version: 0.8.3</li>
<li>OS: Linux/macOS</li>
</ul>
<h2>Impact</h2>
<p>This behavior makes it difficult to:</p>
<ul>
<li>Selectively update individual packages from a monorepo</li>
<li>Automate dependency updates in CI/CD pipelines</li>
<li>Maintain fine-grained control over dependency versions</li>
</ul>
<p>The current behavior seems to suggest that uv treats all subdirectory dependencies from the same repository as a single unit when determining whether to update the commit hash.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2025-07-29 17:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2025-08-01 02:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-01 02:20</div>
            <div class="timeline-body"><p>I was able to reproduce this, thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @charliermarsh by @charliermarsh on 2025-08-01 02:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-01 02:27</div>
            <div class="timeline-body"><p>I think the &quot;optimal&quot; semantics here are actually a little tricky. Like, if you add a new dependency that's a different subdirectory in the same Git repo, you probably <em>do</em> want to reuse the the same Git SHA. So, like, you <em>only</em> want to use a new SHA in this specific case with an explicit <code>--upgrade-package</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/14684.html">astral-sh/uv#14684</a> on 2025-08-01 02:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-01 02:33</div>
            <div class="timeline-body"><p>Would it be an improvement if <code>--upgrade-package package-a</code> caused all of <code>package-a</code>, <code>package-b</code>, and <code>package-c</code> to get upgraded...? I dunno, that also seems bad.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/redartera">@redartera</a> on 2025-08-01 17:55</div>
            <div class="timeline-body"><p>Personally as a user - It would be preferable for me to just upgrade <code>package-a</code> without affecting <code>package-b</code> or <code>package-c</code>.</p>
<p>There are some cases where <code>package-a</code> may need to use a repo's latest commit, but <code>package-b</code> may not want to have its <code>uv.lock</code> commit updated if for example some breaking changes were introduced to it in later commits.</p>
<p>I realize this gets a bit complicated, but as a user I'd prefer to manage the complexity myself of making sure I keep track of the commits used by the different libraries I'm consuming from a git repo.</p>
<p>I don't think too many users put themselves in this usage pattern, but those who do would probably want to have some control over the commits they're consuming for the different libs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../MountainGod2/chaturbate_poller/pulls/614.html">MountainGod2/chaturbate_poller#614</a> on 2025-08-18 23:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ZinkLu">@ZinkLu</a> on 2025-11-04 08:28</div>
            <div class="timeline-body"><p>I usually use workspace/monorepo to manage some utility packages and reference them in via github + subDirectory the main service (also workspace/monorepo). And I have encountered the same issue.</p>
<p>I now have to use <code>uv lock --upgrade-package &lt;all_packages_from_this_repo&gt;</code> to update all packages in order to update the new commit hash in the lock file.</p>
<p>I also think that the versions (hash commits) between different monorepos should not affect each other, that is, <code>uv lock --upgrade-package package-a</code> will not affect the hash commits of other monorepos.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:29 UTC
    </footer>
</body>
</html>
