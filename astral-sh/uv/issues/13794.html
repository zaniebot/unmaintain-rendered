<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>How do I handle switching deepspeed in a pyproject.toml? - astral-sh/uv #13794</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>How do I handle switching deepspeed in a pyproject.toml?</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/13794">#13794</a>
        opened by <a href="https://github.com/032004129xuzhiyong">@032004129xuzhiyong</a>
        on 2025-06-03 03:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/032004129xuzhiyong">@032004129xuzhiyong</a> on 2025-06-03 03:40</div>
            <div class="timeline-body"><h3>Question</h3>
<p>UV is not able to handle the deepspeed package, although it is able to configure torch/torchvision/torchaudio/torch-scatter/etc. to adapt to different cuda versions in a single pyproject.toml file (showing the extra field set to conflicts). I've tried different settings, including setting the group or extra configured as conflicts. it seems to install, but when I detect it using the ds_report tool that comes with deepspeed, I find that the torch that deepspeed relies on at build time gets overwritten with the same torch+cuda version. In summary, I can't use uv sync --extra cuxxx or uc sync --group cuxxx to switch between deepspeed packages that depend on different torch+cuda, even if I force the installation of a different version (but it is possible to switch between packages such as torch). I'm wondering what the problem is, whether it's because uv's cache recognises different cuda versions of torch with different suffixes but deepspeed doesn't, or whether it's because I've set a specific index for torch that deepspeed doesn't have (and it doesn't need).
My python version is cp312 with both cuda121 and cuda124 versions of the torch configured (2.5.1).
Here is my configuration before installing deepspeed.</p>
<pre><code>[project]
name = &quot;hello-world&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = [
    &quot;accelerate&gt;=1.7.0&quot;,
    &quot;blobfile&gt;=3.0.0&quot;,
    &quot;charset-normalizer&gt;=3.4.2&quot;,
    &quot;datasets&gt;=3.6.0&quot;,
    &quot;einops&gt;=0.8.1&quot;,
    &quot;hdf5storage&gt;=0.2.0&quot;,
    &quot;markupsafe&lt;3.0.2&quot;,
    &quot;ogb&gt;=1.3.6&quot;,
    &quot;optuna&gt;=4.3.0&quot;,
    &quot;optuna-dashboard&gt;=0.18.0&quot;,
    &quot;peft&gt;=0.15.2&quot;,
    &quot;polars-u64-idx&gt;=1.30.0&quot;,
    &quot;polars[all]&gt;=1.30.0&quot;,
    &quot;python-benedict[all]&gt;=0.34.1&quot;,
    &quot;rdkit&gt;=2025.3.2&quot;,
    &quot;scikit-learn&gt;=1.6.1&quot;,
    &quot;sentencepiece&gt;=0.2.0&quot;,
    &quot;sympy==1.13.1&quot;,
    &quot;tensorboard&gt;=2.19.0&quot;,
    &quot;tiktoken&gt;=0.9.0&quot;,
    &quot;torch-geometric&gt;=2.6.1&quot;,
    &quot;transformers&gt;=4.52.4&quot;,
    &quot;yarl&gt;=1.20.0&quot;,
]

[project.optional-dependencies]
cu121 = [
    &quot;pyg-lib&gt;=0.4.0&quot;,
    &quot;torch==2.5.1&quot;,
    &quot;torch-cluster&gt;=1.6.3&quot;,
    &quot;torch-scatter&gt;=2.1.2&quot;,
    &quot;torch-sparse&gt;=0.6.18&quot;,
    &quot;torch-spline-conv&gt;=1.2.2&quot;,
    &quot;torchaudio==2.5.1&quot;,
    &quot;torchvision==0.20.1&quot;,
]
cu124 = [
    &quot;pyg-lib&gt;=0.4.0&quot;,
    &quot;torch==2.5.1&quot;,
    &quot;torch-cluster&gt;=1.6.3&quot;,
    &quot;torch-scatter&gt;=2.1.2&quot;,
    &quot;torch-sparse&gt;=0.6.18&quot;,
    &quot;torch-spline-conv&gt;=1.2.2&quot;,
    &quot;torchaudio==2.5.1&quot;,
    &quot;torchvision==0.20.1&quot;,
]

[tool.uv]
conflicts = [
  [
    {extra = &quot;cu121&quot;},
    {extra = &quot;cu124&quot;},
  ]
]
no-build-isolation-package = [
  &quot;torch-cluster&quot;,
  &quot;torch-scatter&quot;,
  &quot;torch-sparse&quot;,
  &quot;torch-spline-conv&quot;,
  &quot;torchaudio&quot;,
  &quot;torchvision&quot;
]

[tool.uv.sources]
torch = [
  { index = &quot;indexcu121&quot;, extra = &quot;cu121&quot; },
  { index = &quot;indexcu124&quot;, extra = &quot;cu124&quot; },
]
torchvision = [
  { index = &quot;indexcu121&quot;, extra = &quot;cu121&quot; },
  { index = &quot;indexcu124&quot;, extra = &quot;cu124&quot; },
]
torchaudio = [
  { index = &quot;indexcu121&quot;, extra = &quot;cu121&quot; },
  { index = &quot;indexcu124&quot;, extra = &quot;cu124&quot; },
]
pyg-lib = [
  { index = &quot;indexpygcu121&quot;, extra = &quot;cu121&quot; },
  { index = &quot;indexpygcu124&quot;, extra = &quot;cu124&quot; },
]
torch-scatter = [
  { index = &quot;indexpygcu121&quot;, extra = &quot;cu121&quot; },
  { index = &quot;indexpygcu124&quot;, extra = &quot;cu124&quot; },
]
torch-sparse = [
  { index = &quot;indexpygcu121&quot;, extra = &quot;cu121&quot; },
  { index = &quot;indexpygcu124&quot;, extra = &quot;cu124&quot; },
]
torch-cluster = [
  { index = &quot;indexpygcu121&quot;, extra = &quot;cu121&quot; },
  { index = &quot;indexpygcu124&quot;, extra = &quot;cu124&quot; },
]
torch-spline-conv = [
  { index = &quot;indexpygcu121&quot;, extra = &quot;cu121&quot; },
  { index = &quot;indexpygcu124&quot;, extra = &quot;cu124&quot; },
]

[[tool.uv.index]]
name = &quot;indexcu124&quot;
url = &quot;https://download.pytorch.org/whl/cu124&quot;
explicit = true

[[tool.uv.index]]
name = &quot;indexcu121&quot;
url = &quot;https://download.pytorch.org/whl/cu121&quot;
explicit = true

[[tool.uv.index]]
name = &quot;indexpygcu124&quot;
url = &quot;https://data.pyg.org/whl/torch-2.5.0+cu124.html&quot;
format = &quot;flat&quot;
explicit = true

[[tool.uv.index]]
name = &quot;indexpygcu121&quot;
url = &quot;https://data.pyg.org/whl/torch-2.5.0+cu121.html&quot;
format = &quot;flat&quot;
explicit = true
</code></pre>
<h3>Platform</h3>
<p>Linux 5.4.0-214-generic x86_64 GNU/Linux</p>
<h3>Version</h3>
<p>0.7.8</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @032004129xuzhiyong on 2025-06-03 03:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-06-03 09:23</div>
            <div class="timeline-body"><p>uv's cache assumes that it can reuse a build for deepspeed (same as pip does). In your case however, deepspeed gets compiles against a torch version, but a packaging tool like uv doesn't see that. <code>uv cache clean deepspeed</code> can remove the existing build from the cache. This is currently recognized as a major missing feature in the Python packaging ecosystem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/032004129xuzhiyong">@032004129xuzhiyong</a> on 2025-06-03 10:12</div>
            <div class="timeline-body"><p>I have another question: when I force two different versions of deepspeed and switch them with <code>uv sync --extra cuxxx</code>, uv seems to rely on the source environment's torch to build the deepspeed rather than the target environment's torch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-06-03 10:17</div>
            <div class="timeline-body"><p>This is also a known problem we're trying to solve.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:04 UTC
    </footer>
</body>
</html>
