<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alternative index config is not correctly used with build requires - astral-sh/uv #9854</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Alternative index config is not correctly used with build requires</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/9854">#9854</a>
        opened by <a href="https://github.com/AKuederle">@AKuederle</a>
        on 2024-12-12 22:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/AKuederle">@AKuederle</a> on 2024-12-12 22:51</div>
            <div class="timeline-body"><p>I have a package that uses torch as dependency as builds custom Cuda extensions. Therefore, I need torch as a build requirement. However, for the build to work, the Cuda version of torch needs to be installed. At the moment my index configurations are not correctly considered when the build requirements are resolved.</p>
<p>I followed the documentation (https://docs.astral.sh/uv/guides/integration/pytorch/#configuring-accelerators-with-optional-dependencies) to setup torch using the &quot;multiple extras&quot; options.</p>
<p>This results in the following config in the pyproject.toml file:</p>
<pre><code>[project.optional-dependencies]
cu118 = [
  &quot;torch==2.2.0&quot;,
  &quot;torchaudio==2.2.0&quot;,
  &quot;torchvision==0.1.6&quot;,
]
cu124 = [
  &quot;torch==2.4.0&quot;,
  &quot;torchaudio==2.4.0&quot;,
  &quot;torchvision==0.1.6&quot;,
]

[tool.uv]
conflicts = [
  [
    { extra = &quot;cu118&quot; },
    { extra = &quot;cu124&quot; },
  ],
]

[tool.uv.sources]
torch = [
  { index = &quot;pytorch-cu118&quot;, extra = &quot;cu118&quot; },
  { index = &quot;pytorch-cu124&quot;, extra = &quot;cu124&quot; },
]

[[tool.uv.index]]
name = &quot;pytorch-cu118&quot;
url = &quot;https://download.pytorch.org/whl/cu118&quot;
explicit = true


[[tool.uv.index]]
name = &quot;pytorch-cu124&quot;
url = &quot;https://download.pytorch.org/whl/cu124&quot;
explicit = true

[build-system]
requires = [&quot;setuptools&gt;=69.0.3&quot;, &quot;wheel&quot;, &quot;torch==2.4.0&quot;, &quot;numpy&quot;, &quot;ninja&quot;]
build-backend = &quot;setuptools.build_meta:__legacy__&quot;
</code></pre>
<p>When I now run <code>uv sync --extra cu124</code> I expected the cuda 12.4 torch version to be installed in the pep517 build env, to make sure that my cuda extensions are build for the cuda version I will also have installed in the actual venv.
However, uv ignores the index selected via the extra marker and resolves the cpu version of torch.</p>
<p>While debugging this issue, a related issue surfaced as well:
Further config parameters for the index don't seemed to be used when installing build requirements.
Specifically, I had <code>allow-insecure-host = [&quot;https://download.pytorch.org&quot;]</code> set up (due to a broken root certifcate issue on my machine). This setting works when torch is installed in the main venv, but when installed as a install require, I get a https error, indicating that the setting is not applied.
I assume, this might be true for further index configs as well.</p>
<p>Expected Behaviors:</p>
<ul>
<li>Installing build requires should use the same setting for package resolution as the main package.</li>
<li>Installing build dependencies should follow all settings affecting download and install.</li>
</ul>
<p>Thanks in advance! Let me know, if further details are required.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-02 04:03</div>
            <div class="timeline-body"><p>I'm unsure if this should work... I'm a little uncomfortable with the idea that an enabled extra would be propagated to the build backend, and that's roughly what's being described here (i.e., that <code>--extra cu124</code> affects the PEP 517 build).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @charliermarsh on 2025-01-02 04:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AKuederle">@AKuederle</a> on 2025-01-03 10:01</div>
            <div class="timeline-body"><p>Hi Charlie, thanks for the response. I agree that it seems scary that selecting an extra effects the isolated build.
However, just from a pure user experience perspective, it is not clear that <code>tool.uv.sources</code> config does not apply to the build system if the selection is conditional on an extra.
(It took me a surprisingly long time to realize what the problem was).</p>
<p>My intuition was, that all <code>uv</code> config should affect all cases where uv does dependency resolution. From this perspective the use of <code>extras</code> to switch sources seems counter intuitive, as this (as you mentioned), is a concept that is confined to the dependency installation.</p>
<p>Maybe an additional way of conditional switching the index is required? Like extras, but for indices?
At the moment it is possible to switch indexes via the cli (https://docs.astral.sh/uv/configuration/indexes/#defining-an-index). But this can become tedious, when you have to switch multiple packages (e.g. torch, torchaudio, ...) and is hard to &quot;discover&quot;, as you can not just look at the pyproject.toml to understand how the package is expected to be installed.
If there would be a way to specify &quot;source configurations&quot; and then have a cli flag to trigger them, the required information could be put into the pyptoject.toml file.</p>
<p>Something like this:</p>
<pre><code>[tool.uv.sources]
torch = [
  { index = &quot;pytorch-cu118&quot;, source_config = &quot;cu118&quot; },
  { index = &quot;pytorch-cu124&quot;, source_config = &quot;cu124&quot; },
]

uv sync --source_config=cu118
</code></pre>
<p>In my specific case, it would also be possible to deactivate build isolation (I think). But it always feels like something you shouldn't do.</p>
<p>EDIT: I tested deactivating build-isolation again. This fails as it can not find setup tools, even when setuptools it a direct dependency of the project (and not just a build requirement). That seems like a separate issue though. Will investigate.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:31:49 UTC
    </footer>
</body>
</html>
