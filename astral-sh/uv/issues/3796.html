<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv` is caching installs based on config, even if build-backend is in-tree - astral-sh/uv #3796</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>uv</code> is caching installs based on config, even if build-backend is in-tree</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/3796">#3796</a>
        opened by <a href="https://github.com/thejcannon">@thejcannon</a>
        on 2024-05-23 14:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/thejcannon">@thejcannon</a></div>
            <div class="timeline-body"><p>ðŸ‘‹ Ok this one took me a while to figure out, lol</p>
<pre><code class="language-console">$ echo &quot;First make package \`foo\`&quot; &gt; /dev/null
$ mkdir foo
$ cat &lt;&lt; EOF &gt; foo/pyproject.toml
[build-system]
requires = []
build-backend = &quot;bar&quot;
backend-path = [&quot;.&quot;]

[project]
name = &quot;foo&quot;
dynamic = [&quot;version&quot;, &quot;dependencies&quot;]
EOF
$ echo &quot;Now make hooks \`bar\`&quot; &gt; /dev/null
$ cat &lt;&lt; EOF &gt; foo/bar.py
def build_wheel(*args) -&gt; str:
    import setuptools.build_meta

    return setuptools.build_meta.build_wheel(*args)


def prepare_metadata_for_build_wheel(*args) -&gt; str:
    import setuptools.build_meta

    return setuptools.build_meta.prepare_metadata_for_build_wheel(*args)
EOF
$ echo &quot;Great! Lets make a venv and install \`foo\`&quot; &gt; /dev/null
$ uv venv .venv --seed
$ uv pip install --python .venv/bin/python ./foo --no-build-isolation
$ echo &quot;Ok, but I think theres a bug in \`bar\` it actually should error.&quot; &gt; /dev/null
$ cat &lt;&lt; EOF &gt; foo/bar.py
def build_wheel(*args) -&gt; str:
    raise Exception(&quot;DEPRECATED&quot;)


def prepare_metadata_for_build_wheel(*args) -&gt; str:
    raise Exception(&quot;DEPRECATED&quot;)
EOF
$ echo &quot;Lets reinstall foo&quot; &gt; /dev/null
$ uv pip uninstall --python .venv/bin/python foo
$ uv pip install --python .venv/bin/python ./foo --no-build-isolation
$ echo &quot;Hey! That didn't error!&quot; &gt; /dev/null
</code></pre>
<p>The smoking gun is:</p>
<pre><code class="language-console">$ touch foo/pyproject.toml
$ uv pip uninstall --python .venv/bin/python foo
$ uv pip install --python .venv/bin/python ./foo
</code></pre>
<p>Which errors because we touched the timestamp of <code>pyproject.toml</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thejcannon">@thejcannon</a> on 2024-05-23 14:49</div>
            <div class="timeline-body"><p>In the real-deal, what's changing is the dynamic <code>dependencies</code> METADATA (which isn't being picked up)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "`uv` is caching installs based on config, even if build-backend is in-repo" to "`uv` is caching installs based on config, even if build-backend is in-tree" by @thejcannon on 2024-05-23 14:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-24 00:05</div>
            <div class="timeline-body"><p>In general we don't rebuild local packages unless <code>pyproject.toml</code> or similar changes. There's some discussion of it elsewhere -- you should be able to pass with <code>--refresh</code> to avoid this. However, we should be rebuilding when <code>dynamic</code> is present? And we seem to do so in my own testing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thejcannon">@thejcannon</a> on 2024-05-24 14:46</div>
            <div class="timeline-body"><blockquote>
<p>And we seem to do so in my own testing?</p>
</blockquote>
<p>Did you try the reproducer above? (FWIW I'm on <code>uv 0.1.44 (d417daad7 2024-05-14)</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thejcannon">@thejcannon</a> on 2024-05-24 14:46</div>
            <div class="timeline-body"><p>But <code>--refresh</code> is good advice! ðŸ™Œ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-24 18:44</div>
            <div class="timeline-body"><p>Oh, the thing that's changing here is literally the build backend itself? No, we definitely don't support that right now. I'm not sure that we will -- how can we reliably detect that it has changed? Any ideas? <code>--refresh</code> feels like the right answer here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @charliermarsh on 2024-05-24 18:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thejcannon">@thejcannon</a> on 2024-05-24 18:58</div>
            <div class="timeline-body"><p>I think your choices are:</p>
<ul>
<li>If <code>pyproject.toml</code> uses <code>backend-path</code> be a coward and always run (pun intended)<ul>
<li>If you wanted you could scope to &quot;only if it has <code>dynamic</code> attributes&quot;, but that's still leaving room for error</li>
</ul>
</li>
<li>&lt;this bug&gt;, which admittedly did make me spin my wheels for an hour or two (pun also intended)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-24 21:01</div>
            <div class="timeline-body"><p>Yeah, we <em>could</em> treat these as if they're dynamic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-05-24 21:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/xmo-odoo">@xmo-odoo</a> on 2026-01-16 10:13</div>
            <div class="timeline-body"><blockquote>
<p>Oh, the thing that's changing here is literally the build backend itself? No, we definitely don't support that right now. I'm not sure that we will -- how can we reliably detect that it has changed? Any ideas? <code>--refresh</code> feels like the right answer here.</p>
</blockquote>
<p><code>cache-keys</code> seems like it would be a good solution there, however:</p>
<ul>
<li>it doesn't really work in the case I hit (which I assume is the original case) where the build backend collates dependencies information from various sources, as those sources may be changeable and even dynamically resolved, and I didn't find a dynamic version of <code>cache-keys</code></li>
<li>adding the in-tree build backend to the cache keys behaves very strangely, I have a test backend which simply overrides <code>prepare_metadata_for_build_editable</code> to append a bunch of <code>Requires-Dist</code> to <code>METADATA</code>, if I add the file to the cache-keys, sync, remove one of the dependencies, sync, uv sees that and removes the dep from the env, but then on the next run it somehow finds cached metadata with <em>no</em> dependencies, and removes everything from the env</li>
</ul>
<p>I also tried using <code>reinstall-package</code> but it does a bit <em>too</em> much: as the name indicates it always reinstalls the thing, not checking if the metadata have changed. So when there are lots of non-trivial dependencies (as is likely the case for a project which needs to resolve dependencies dynamically) it's quite painful.</p>
<p><code>--refresh</code> currently seems the least bad option, but having to specify it every time is icky.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/xmo-odoo">@xmo-odoo</a> on 2026-01-16 10:22</div>
            <div class="timeline-body"><p>Incidentally the <code>reinstall</code> setting says</p>
<blockquote>
<p>Reinstall all packages, regardless of whether they're already installed. Implies <code>refresh</code>.</p>
</blockquote>
<p>but <code>refresh</code> is not currently a valid setting (I assume reinstall is both a setting and a flag and the docs are shared).</p>
<p>Maybe <code>refresh</code> could be promoted to whatever status <code>reinstall</code> has, so a project which needs this behavior could just set <code>tool.uv.refresh = true</code> and be on its merry way? Obviously at the cost of re-resolving the metadata every time but...</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-16 10:58:55 UTC
    </footer>
</body>
</html>
