<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv 0.4.11 failing to read distribution cache in github actions - astral-sh/uv #7485</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv 0.4.11 failing to read distribution cache in github actions</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/7485">#7485</a>
        opened by <a href="https://github.com/winwinashwin">@winwinashwin</a>
        on 2024-09-18 06:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/winwinashwin">@winwinashwin</a></div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

<p>Our Github Actions CI started failing with the following error when running <code>uv pip install pyspark==3.2.1</code></p>
<pre><code>Using Python 3.8.18 interpreter at: /__w/_tool/Python/3.8.18/x64/bin/python3
Creating virtualenv with seed packages at: venv
warning: Failed to hardlink files; falling back to full copy. This may lead to degraded performance.
         If the cache and target directories are on different filesystems, hardlinking may not be supported.
         If this is intentional, set `export UV_LINK_MODE=copy` or use `--link-mode=copy` to suppress this warning.
 + pip==24.2
 + setuptools==75.1.0
 + wheel==0.44.0
error: Failed to download and build `pyspark==3.2.1`
  Caused by: Failed to read from the distribution cache
  Caused by: failed to read directory `/__w/_temp/setup-uv-cache/built-wheels-v3/pypi/pyspark/3.2.1/IStJ-q5m0o-G-eruFFpEK/pyspark-3.2.1.tar.gz`
  Caused by: No such file or directory (os error 2)
</code></pre>
<p>This started happening after the latest 0.4.11 release.</p>
<details><summary>Workflow Declaration</summary>

<pre><code class="language-yaml">- name: Setup Python
  uses: actions/setup-python@v5
  with:
    python-version: '3.8'

- name: Install uv
  uses: astral-sh/setup-uv@v2
  with:
    enable-cache: true

- run: |
    uv venv venv --seed
    uv pip install -r requirements.txt pyarrow pyspark==3.2.1 --python venv  # &lt;--- FAILS HERE
  shell: bash
</code></pre>
</details>

<details><summary><code>astral-sh/setup-uv</code> logs</summary>

<pre><code>&gt; Run astral-sh/setup-uv@v2
  with:
    enable-cache: true
    version: latest
    github-token: ***
  env:
    pythonLocation: /__w/_tool/Python/3.8.18/x64
    PKG_CONFIG_PATH: /__w/_tool/Python/3.8.18/x64/lib/pkgconfig
    Python_ROOT_DIR: /__w/_tool/Python/3.8.18/x64
    Python2_ROOT_DIR: /__w/_tool/Python/3.8.18/x64
    Python3_ROOT_DIR: /__w/_tool/Python/3.8.18/x64
    LD_LIBRARY_PATH: /__w/_tool/Python/3.8.18/x64/lib:/opt/oracle/instantclient_21_8/
/usr/bin/docker exec  b1f1b19e402573bba171b6a6d208b411385eed518d4f720827a31a93cb1a6f88 sh -c &quot;cat /etc/*release | grep ^ID&quot;
Downloading uv from &quot;https://github.com/astral-sh/uv/releases/latest/download/uv-x86_64-unknown-linux-gnu.tar.gz&quot; ...
/usr/bin/tar xz --warning=no-unknown-keyword --overwrite -C /__w/_temp/5138b5d3-39fd-4adf-abe8-9a6b348864e2 -f /__w/_temp/ef8159c7-bfe3-439b-b565-b6a11cf5126c
Added /__w/_tool/uv/0.4.11/x86_64 to the path
Successfully installed uv version latest
Set UV_CACHE_DIR to /__w/_temp/setup-uv-cache
Trying to restore uv cache from GitHub Actions cache with key: setup-uv-1-x86_64-unknown-linux-gnu-0.4.11
-no-dependency-glob
Received 0 of 301099792 (0.0%), 0.0 MBs/sec
Received 33554432 of 301099792 (11.1%), 16.0 MBs/sec
Received 67108864 of 301099792 (22.3%), 21.3 MBs/sec
Received 109051904 of 301099792 (36.2%), 26.0 MBs/sec
Received 150994944 of 301099792 (50.1%), 28.8 MBs/sec
Received 184549376 of 301099792 (61.3%), 29.3 MBs/sec
Received 213909504 of 301099792 (71.0%), 29.1 MBs/sec
Received 251658240 of 301099792 (83.6%), 30.0 MBs/sec
Received 288516880 of 301099792 (95.8%), 30.5 MBs/sec
Cache Size: ~287 MB (301099792 B)
/usr/bin/tar -xf /__w/_temp/92d12651-008f-4643-8d55-d87145b39532/cache.tgz -P -C /__w/&lt;PRIVATE-REPOSITORY&gt; -z
Received 301099792 of 301099792 (100.0%), 28.7 MBs/sec
Cache restored successfully
uv cache restored from GitHub Actions cache with key: setup-uv-1-x86_64-unknown-linux-gnu-0.4.11
</code></pre>
</details>

<details><summary><code>uv pip install ...</code> complete logs</summary>

<pre><code>&gt; Run uv venv venv --seed
  uv venv venv --seed
  uv pip install -r requirements.txt pyarrow pyspark==3.2.1 --python venv
  shell: bash --noprofile --norc -e -o pipefail {0}
  env:
    pythonLocation: /__w/_tool/Python/3.8.18/x64
    PKG_CONFIG_PATH: /__w/_tool/Python/3.8.18/x64/lib/pkgconfig
    Python_ROOT_DIR: /__w/_tool/Python/3.8.18/x64
    Python2_ROOT_DIR: /__w/_tool/Python/3.8.18/x64
    Python3_ROOT_DIR: /__w/_tool/Python/3.8.18/x64
    LD_LIBRARY_PATH: /__w/_tool/Python/3.8.18/x64/lib:/opt/oracle/instantclient_21_8/
    UV_CACHE_DIR: /__w/_temp/setup-uv-cache
    JAVA_HOME: /__w/_tool/Java_Corretto_jdk/8.422.05-1/x64
    JAVA_HOME_8_X64: /__w/_tool/Java_Corretto_jdk/8.422.05-1/x64
    PNPM_HOME: /github/home/setup-pnpm/node_modules/.bin
Using Python 3.8.18 interpreter at: /__w/_tool/Python/3.8.18/x64/bin/python3
Creating virtualenv with seed packages at: venv
warning: Failed to hardlink files; falling back to full copy. This may lead to degraded performance.
         If the cache and target directories are on different filesystems, hardlinking may not be supported.
         If this is intentional, set `export UV_LINK_MODE=copy` or use `--link-mode=copy` to suppress this warning.
 + pip==24.2
 + setuptools==75.1.0
 + wheel==0.44.0
error: Failed to download and build `pyspark==3.2.1`
  Caused by: Failed to read from the distribution cache
  Caused by: failed to read directory `/__w/_temp/setup-uv-cache/built-wheels-v3/pypi/pyspark/3.2.1/IStJ-q5m0o-G-eruFFpEK/pyspark-3.2.1.tar.gz`
  Caused by: No such file or directory (os error 2)
</code></pre>
</details>

<p>Tried reproducing this on my local machine with <code>uv self update</code> followed by a <code>uv pip install pyspark==3.2.1</code> but couldn't reproduce the failure.</p>
<h2>CI Runner Info</h2>
<ol>
<li>All our actions run inside our private CI docker image which is based on Ubuntu 22.04 LTS</li>
<li>Host OS<pre><code>Distribution: Amazon Linux release 2023.5.20240805 (Amazon Linux)
Architecture: x86_64
</code></pre>
</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/winwinashwin">@winwinashwin</a> on 2024-09-18 06:26</div>
            <div class="timeline-body"><p>Seems to be related? https://github.com/astral-sh/uv/issues/7479</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/winwinashwin">@winwinashwin</a> on 2024-09-18 07:33</div>
            <div class="timeline-body"><p>After going through the release notes for 0.4.11, I was able to reproduce this locally. This seem to be linked to the newly added <code>uv cache prune --ci</code> option.</p>
<p>NOTE - We don't explicitly invoke <code>uv cache prune --ci</code> in our CI. Just adding the below MRE here if it helps as it was the only way I could reproduce this in my local.</p>
<pre><code class="language-bash">$ uv cache clean
Clearing cache at: /home/ashwin/.cache/uv
Removed 14 files (269.7MiB)

$ uv venv venv-1 --python 3.8
Using Python 3.8.19
Creating virtualenv at: venv-1
Activate with: source venv-1/bin/activate

$ uv pip install pyspark==3.2.1 --python venv-1
Resolved 2 packages in 36.30s
   Built pyspark==3.2.1
Prepared 2 packages in 17.55s
Installed 2 packages in 25ms
 + py4j==0.10.9.3
 + pyspark==3.2.1

$ tree -L 2 `uv cache dir`/built-wheels-v3/pypi/pyspark/3.2.1/
/home/ashwin/.cache/uv/built-wheels-v3/pypi/pyspark/3.2.1/
├── MlQraUk4JIaysmTs9mj2e
│   ├── metadata.msgpack
│   ├── pyspark-3.2.1-py2.py3-none-any -&gt; /home/ashwin/.cache/uv/archive-v0/LbVUP3RZg8fwvcArKRmt8
│   ├── pyspark-3.2.1-py2.py3-none-any.whl
│   └── pyspark-3.2.1.tar.gz
└── revision.http

3 directories, 3 files

$ uv cache --prune ci
Pruning cache at: /home/ashwin/.cache/uv
Removed 2816 files (887.9MiB)

$ uv venv venv-2 --python 3.8
Using Python 3.8.19
Creating virtualenv at: venv-2
Activate with: source venv-2/bin/activate

$ uv pip install pyspark==3.2.1 --python venv-2
⠙ pyspark==3.2.1                                                                                                                                                                                                 error: Failed to download and build `pyspark==3.2.1`
  Caused by: Failed to read from the distribution cache
  Caused by: failed to read directory `/home/ashwin/.cache/uv/built-wheels-v3/pypi/pyspark/3.2.1/MlQraUk4JIaysmTs9mj2e/pyspark-3.2.1.tar.gz`
  Caused by: No such file or directory (os error 2)

$ tree -L 2 `uv cache dir`/built-wheels-v3/pypi/pyspark/3.2.1/
/home/ashwin/.cache/uv/built-wheels-v3/pypi/pyspark/3.2.1/
├── MlQraUk4JIaysmTs9mj2e
│   ├── metadata.msgpack
│   └── pyspark-3.2.1-py2.py3-none-any.whl
└── revision.http

1 directory, 3 files

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kazy">@Kazy</a> on 2024-09-18 10:12</div>
            <div class="timeline-body"><p>This happened to us as well. Reverting to 0.4.10 and busting the cache solve the issue. If you re-use a cache done in 0.4.11 with <code>uv cache prune --ci</code> called but with a previous version of <code>uv</code> (like if you're in a CI and you just change the version of <code>uv</code> installed), it will also fail. It seems that <code>uv cache prune --ci</code> in 0.4.11 corrupts the cache since <code>uv sync</code> or <code>uv lock --locked</code> don't work after that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-18 12:23</div>
            <div class="timeline-body"><p>Thanks for the report! We'll look into this right away cc @charliermarsh</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-09-18 12:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cache</span> added by @zanieb on 2024-09-18 12:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MRigal">@MRigal</a> on 2024-09-18 12:38</div>
            <div class="timeline-body"><p>I can confirm a similar issue with Gitlab, also using <code>prune --ci</code>. Breaks installs on CI</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MRigal">@MRigal</a> on 2024-09-18 12:41</div>
            <div class="timeline-body"><p>I think this comes from https://github.com/astral-sh/uv/pull/7446 as it happens for me with the package https://pypi.org/project/pytest-clarity/#files which has no wheels</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-18 12:43</div>
            <div class="timeline-body"><p>#7446 is the very likely cause yeah</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MRigal">@MRigal</a> on 2024-09-18 12:58</div>
            <div class="timeline-body"><p>Here some output to maybe ease spotting the error:</p>
<pre><code class="language-sh">(.venv) ➜  dataworker git:(main) uv cache prune --ci                                                                                                                                                   git:(main|⚑7)
Pruning cache at: /Users/mrigal/Library/Caches/uv
Removed 18847 files (587.2MiB)

(.venv) ➜  dataworker git:(main) uv pip uninstall pytest-clarity                                                                                                                                       git:(main|⚑7)
Uninstalled 1 package in 26ms
 - pytest-clarity==1.0.1
 
(.venv) ➜  dataworker git:(main) uv sync --frozen                                                                                                                                                      git:(main|⚑7)
error: Failed to prepare distributions
  Caused by: Failed to fetch wheel: pytest-clarity==1.0.1
  Caused by: /Users/mrigal/Library/Caches/uv/built-wheels-v3/pypi/pytest-clarity/1.0.1/yE42-NVZgq4lK-UrXRJnS/pytest-clarity-1.0.1.tar.gz does not appear to be a Python project, as neither `pyproject.toml` nor `setup.py` are present in the directory

(.venv) ➜  dataworker git:(main) uv sync                                                                                                                                                               git:(main|⚑7)
⠙ faktory==1.1.0                                                                                                                                                                                                      error: Failed to download and build `pytest-clarity==1.0.1`
  Caused by: Failed to read from the distribution cache
  Caused by: failed to read directory `/Users/mrigal/Library/Caches/uv/built-wheels-v3/pypi/pytest-clarity/1.0.1/yE42-NVZgq4lK-UrXRJnS/pytest-clarity-1.0.1.tar.gz`
  Caused by: No such file or directory (os error 2)
</code></pre>
<p>And verbose:</p>
<pre><code class="language-sh">(.venv) ➜  dataworker git:(main) uv sync -v                                                                                                                                                            git:(main|⚑7)
DEBUG uv 0.4.11
DEBUG Found project root: `/Users/mrigal/dev/prospect-server/dataworker`
DEBUG No workspace root found, using project root
DEBUG The virtual environment's Python version satisfies `Python &gt;=3.12`
DEBUG Using request timeout of 30s
DEBUG Found static `pyproject.toml` for: dataworker @ file:///Users/mrigal/dev/prospect-server/dataworker
DEBUG No workspace root found, using project root
DEBUG Ignoring existing lockfile due to mismatched dev dependencies for: `dataworker==0.1.0`
[... noisy output of dependencies listing]
DEBUG Starting clean resolution
DEBUG Found static `pyproject.toml` for: dataworker @ file:///Users/mrigal/dev/prospect-server/dataworker
DEBUG No workspace root found, using project root
DEBUG Solving with installed Python version: 3.12.3
DEBUG Solving with target Python version: &gt;=3.12
DEBUG Narrowed `requires-python` bound to: &gt;=3.12
DEBUG Narrowed `requires-python` bound to: &gt;=3.12
DEBUG Solving split python_full_version == '3.12.*' (requires-python: RequiresPython { specifiers: VersionSpecifiers([VersionSpecifier { operator: GreaterThanEqual, version: &quot;3.12&quot; }]), range: RequiresPythonRange(LowerBound(Included(&quot;3.12&quot;)), UpperBound(Excluded(&quot;3.13&quot;))) })
DEBUG Adding direct dependency: dataworker*
DEBUG Searching for a compatible version of dataworker @ file:///Users/mrigal/dev/prospect-server/dataworker (*)
DEBUG Adding transitive dependency for dataworker==0.1.0: arrow&gt;=1.3.0
[... similar lines]
DEBUG Adding transitive dependency for dataworker==0.1.0: pytest-clarity&gt;=1.0.1
DEBUG Searching for a compatible version of faktory @ file:///Users/mrigal/dev/prospect-server/dataworker/faktory-1.1.0-py3-none-any.whl (*)
DEBUG Found stale response for: https://pypi.org/simple/arrow/
DEBUG Sending revalidation request for: https://pypi.org/simple/arrow/
[... similar lines from pypi]
DEBUG Acquired lock for `/Users/mrigal/Library/Caches/uv/built-wheels-v3/pypi/pytest-clarity/1.0.1`
-------&gt; Maybe also interesting
DEBUG No cache entry for: https://files.pythonhosted.org/packages/e2/14/c8a7d861262139688fa465d2e27ff7113764d6fa03b15b9c7b666729ea2e/dynaconf-3.2.6-py2.py3-none-any.whl.metadata
DEBUG No cache entry for: https://files.pythonhosted.org/packages/8a/0e/0f755db36f47f96464463385552f8f132a981731356837c9a30a11ab2d35/psycopg-3.2.1-py3-none-any.whl.metadata
DEBUG No cache entry for: https://files.pythonhosted.org/packages/6a/3e/b68c118422ec867fa7ab88444e1274aa40681c606d59ac27de5a5588f082/python_dotenv-1.0.1-py3-none-any.whl.metadata
DEBUG No cache entry for: https://files.pythonhosted.org/packages/24/d3/00e575657422055c4ea220b2f80e8cc6026ab7130372b7067444d1b0ac10/pytest_randomly-3.15.0-py3-none-any.whl.metadata
DEBUG No cache entry for: https://files.pythonhosted.org/packages/dd/49/de869130028fb8d90e25da3b7d8fb13e40f5afa4c4af1781583eb1ff3839/pandas-2.2.2-cp312-cp312-macosx_10_9_x86_64.whl.metadata
-----&gt;&gt;&gt; See here
DEBUG Found fresh response for: https://files.pythonhosted.org/packages/52/5c/cafa97944de55738a6a2c5a7cee00d073cb80495032d2b112c4546525eca/pytest-clarity-1.0.1.tar.gz
DEBUG No static `pyproject.toml` available for: pytest-clarity==1.0.1 (MissingPyprojectToml)
DEBUG No static `PKG-INFO` available for: pytest-clarity==1.0.1 (MissingPkgInfo)
DEBUG Released lock at `/Users/mrigal/Library/Caches/uv/built-wheels-v3/pypi/pytest-clarity/1.0.1/.lock`

error: Failed to download and build `pytest-clarity==1.0.1`
  Caused by: Failed to read from the distribution cache
  Caused by: failed to read directory `/Users/mrigal/Library/Caches/uv/built-wheels-v3/pypi/pytest-clarity/1.0.1/yE42-NVZgq4lK-UrXRJnS/pytest-clarity-1.0.1.tar.gz`
  Caused by: No such file or directory (os error 2)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @BurntSushi by @zanieb on 2024-09-18 12:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @zanieb on 2024-09-18 12:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-18 13:03</div>
            <div class="timeline-body"><p>Thanks, I’ll take a look.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-18 13:03</div>
            <div class="timeline-body"><p>We can also just revert that change and re-release, it’s not a critical change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MRigal">@MRigal</a> on 2024-09-18 13:07</div>
            <div class="timeline-body"><p>Actually, the root cause is possibly deeper. After reverting to 0.4.10, it fixes the behaviour for <code>uv sync</code> but not for <code>uv pip install</code>:</p>
<pre><code class="language-sh">
(.venv) ➜  dataworker git:(main) ✗ uv self update 0.4.10                                                                                                                                              git:(main|✚1⚑7
info: Checking for updates...
success: Upgraded uv from v0.4.11 to v0.4.10! https://github.com/astral-sh/uv/releases/tag/0.4.10
(.venv) ➜  dataworker git:(main) ✗ uv pip install pytest-clarity                                                                                                                                      git:(main|✚1⚑7
⠙ pytest-clarity==1.0.1                                                                                                                                                                                               error: Failed to download and build `pytest-clarity==1.0.1`
  Caused by: Failed to read from the distribution cache
  Caused by: failed to read directory `/Users/mrigal/Library/Caches/uv/built-wheels-v3/pypi/pytest-clarity/1.0.1/yE42-NVZgq4lK-UrXRJnS/pytest-clarity-1.0.1.tar.gz`
  Caused by: No such file or directory (os error 2)
(.venv) ➜  dataworker git:(main) ✗ uv sync --frozen                                                                                                                                                   git:(main|✚1⚑7
Prepared 1 package in 3ms
Installed 1 package in 1ms
 + pytest-clarity==1.0.1
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-18 13:12</div>
            <div class="timeline-body"><p>I wouldn’t expect downgrading to help. Once the cache is in a bad state, any version would fail.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-09-18 13:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MRigal">@MRigal</a> on 2024-09-18 14:55</div>
            <div class="timeline-body"><p>Thanks for the quick action! I confirm that 0.4.12 fixes the issue!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:27:12 UTC
    </footer>
</body>
</html>
