<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv export not correctly handling extra markers - astral-sh/uv #16661</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv export not correctly handling extra markers</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/16661">#16661</a>
        opened by <a href="https://github.com/jsiverskog">@jsiverskog</a>
        on 2025-11-10 09:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/jsiverskog">@jsiverskog</a> on 2025-11-10 09:06</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>hi,
i have a project that (among other things) have a package setup like this:</p>
<pre><code>[project]
name = &quot;my-project&quot;
version = &quot;0.0.0&quot;
requires-python = &quot;&gt;=3.11&quot;
dependencies = [
  &quot;opencv-python-headless==4.12.0.88; extra != 'dev'&quot;,
]

[project.optional-dependencies]
dev = [
  &quot;opencv-python==4.12.0.88&quot;,
]
</code></pre>
<p>running <code>uv export</code> yields:</p>
<pre><code>DEBUG uv 0.9.8
DEBUG Acquired shared lock for `[...]`
DEBUG Found project root: `[...]`
DEBUG No workspace root found, using project root
DEBUG Reading Python requests from version file at `[...]/.python-version`
DEBUG Using Python request `3.11.13` from version file at `.python-version`
DEBUG Checking for Python environment at: `[...]`
DEBUG The project environment's Python version satisfies the request: `Python 3.11.13`
DEBUG Using request timeout of 30s
DEBUG Found static `pyproject.toml` for: my-project @ file:///[...]
DEBUG No workspace root found, using project root
DEBUG Existing `uv.lock` satisfies workspace requirements
Resolved 3 packages in 0.46ms
# This file was autogenerated by uv via the following command:
#    uv export
DEBUG Released lock at `[...]/.cache/uv/.lock`
</code></pre>
<p>the issue can be reproduced also without the <code>project.optional-dependencies</code> extra specification:</p>
<pre><code>[project]
name = &quot;my-project&quot;
version = &quot;0.0.0&quot;
requires-python = &quot;&gt;=3.11&quot;
dependencies = [
  &quot;opencv-python-headless==4.12.0.88; extra != 'dev'&quot;,
]
</code></pre>
<pre><code>&gt; uv export --verbose 
DEBUG uv 0.9.8
DEBUG Acquired shared lock for [...]
DEBUG Found project root: `[...]`
DEBUG No workspace root found, using project root
DEBUG Reading Python requests from version file at `[...]/.python-version`
DEBUG Using Python request `3.11.13` from version file at `.python-version`
DEBUG Checking for Python environment at: `[...]`
DEBUG The project environment's Python version satisfies the request: `Python 3.11.13`
DEBUG Using request timeout of 30s
DEBUG Found static `pyproject.toml` for: my-project @ file:///[...]
DEBUG No workspace root found, using project root
DEBUG Existing `uv.lock` satisfies workspace requirements
Resolved 1 package in 0.48ms
# This file was autogenerated by uv via the following command:
#    uv export
DEBUG Released lock at `[...]/.cache/uv/.lock`
</code></pre>
<p>in both cases i would expect <code>opencv-python-headless==4.12.0.88</code> to be exported.</p>
<h3>Platform</h3>
<p>Linux 6.17.7-061707-generic x86_64 GNU/Linux</p>
<h3>Version</h3>
<p>uv 0.9.8</p>
<h3>Python version</h3>
<p>python 3.11.13</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @jsiverskog on 2025-11-10 09:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-11-10 11:31</div>
            <div class="timeline-body"><p>This is a limitation with the <code>extra</code> marker: It allows only using <code>extra == &quot;&lt;name&gt;&quot;</code>, and only in a top level conjunction of a marker. Basically, everything that isn't expressible through <code>project.optional-dependencies</code> isn't supported, or put another way round, you should never need to write an <code>extra</code> marker in <code>[project]</code> yourself, this should be abstracted away by <code>project.optional-dependencies</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jsiverskog">@jsiverskog</a> on 2025-11-10 12:05</div>
            <div class="timeline-body"><p>@konstin : right. is this something that will change? we have our reasons for doing as we're doing, but i guess we need to see if we can use <code>project.optional-dependencies</code> for both cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-11-10 12:49</div>
            <div class="timeline-body"><p>I don't think so, the way markers work is loadbearing in some places across the ecosystem, including uv's resolver (it assumes extras are purely additional so packages can never be removed from the resolution graph once selected). We are interested though in adding better support for switching packages between different implementations, there are several cases where this comes up. The closest we currently have is conflicts (https://docs.astral.sh/uv/concepts/projects/config/#conflicting-dependencies).</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:33:14 UTC
    </footer>
</body>
</html>
