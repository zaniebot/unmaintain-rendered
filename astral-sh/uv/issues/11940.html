<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv python list doesn't recognize foreign-arch installs as installed - astral-sh/uv #11940</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv python list doesn't recognize foreign-arch installs as installed</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/11940">#11940</a>
        opened by <a href="https://github.com/geofft">@geofft</a>
        on 2025-03-04 01:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/geofft">@geofft</a> on 2025-03-04 01:46</div>
            <div class="timeline-body"><h3>Summary</h3>
<pre><code>$ uv python install
Installed Python 3.13.2 in 1.62s
 + cpython-3.13.2-linux-aarch64-gnu
$ uv python install cpython-3.13.2-linux-x86_64-gnu
Installed Python 3.13.2 in 1.66s
 + cpython-3.13.2-linux-x86_64-gnu
$ uv python list --all-versions --all-arches --all-platforms | grep cpython-3.13.2-linux
cpython-3.13.2-linux-x86_64_v4-gnu                     &lt;download available&gt;
cpython-3.13.2-linux-x86_64_v3-gnu                     &lt;download available&gt;
cpython-3.13.2-linux-x86_64_v2-gnu                     &lt;download available&gt;
cpython-3.13.2-linux-x86_64-gnu                        &lt;download available&gt;
cpython-3.13.2-linux-s390x-gnu                         &lt;download available&gt;
cpython-3.13.2-linux-riscv64gc-gnu                     &lt;download available&gt;
cpython-3.13.2-linux-powerpc64le-gnu                   &lt;download available&gt;
cpython-3.13.2-linux-armv7-gnueabihf                   &lt;download available&gt;
cpython-3.13.2-linux-armv7-gnueabi                     &lt;download available&gt;
cpython-3.13.2-linux-aarch64-gnu                       /root/.local/share/uv/python/cpython-3.13.2-linux-aarch64-gnu/bin/python3.13
$ uv python list --only-installed --all-versions --all-arches --all-platforms 
cpython-3.13.2-linux-aarch64-gnu    /root/.local/share/uv/python/cpython-3.13.2-linux-aarch64-gnu/bin/python3.13
$ uv python install cpython-3.13.2-linux-x86_64-gnu
$ ls ~/.local/share/uv/python
cpython-3.13.2-linux-aarch64-gnu  cpython-3.13.2-linux-x86_64-gnu
</code></pre>
<h3>Platform</h3>
<p>NixOS 24.05</p>
<h3>Version</h3>
<p>uv 0.6.4</p>
<h3>Python version</h3>
<p>3.13</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @geofft on 2025-03-04 01:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-04 01:55</div>
            <div class="timeline-body"><p>Is this Python interpreter intended to be usable for some reason (i.e., transparently emulated)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/geofft">@geofft</a> on 2025-03-04 02:09</div>
            <div class="timeline-body"><p>Yeah, I was going to turn on Rosetta (this is a Linux VM on an ARM Mac, and <a href="https://developer.apple.com/documentation/virtualization/running-intel-binaries-in-linux-vms-with-rosetta">Apple provides a binfmt-misc handler</a>), but also it'd be nice if we could support <code>--only-binary</code> installs into a completely unrunnable Python? I guess that doesn't work at the moment because</p>
<pre><code>$ uv venv -p cpython-3.13.2-linux-x86_64-gnu /tmp/xe
  × Failed to query Python interpreter at `/root/.local/share/uv/python/cpython-3.13.2-linux-x86_64-gnu/bin/python3.13`
  ╰─▶ Exec format error (os error 8)
</code></pre>
<p>I do get the same behaior of <code>uv python list</code> once I enable Rosetta but I can now create a venv.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-04 02:47</div>
            <div class="timeline-body"><blockquote>
<p>Yeah, I was going to turn on Rosetta (this is a Linux VM on an ARM Mac, and <a href="https://developer.apple.com/documentation/virtualization/running-intel-binaries-in-linux-vms-with-rosetta">Apple provides a binfmt-misc handler</a>)</p>
</blockquote>
<p>Dear goodness, I'm not sure how we're going to detect that case.</p>
<blockquote>
<p>Also it'd be nice if we could support --only-binary installs into a completely unrunnable Python?</p>
</blockquote>
<p>We rely on the Python interpreter to report platform tags, as attempting to assume platform tags from the outside is fraught with problems.</p>
<blockquote>
<p>I do get the same behaior of uv python list once I enable Rosetta but I can now create a venv.</p>
</blockquote>
<p>This should be fixable. I think we filter the installed managed interpreters by platform before querying them, but we can attempt to query them all regardless of architecture.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-04 02:49</div>
            <div class="timeline-body"><p>Specifically, we may just want to remove https://github.com/astral-sh/uv/blob/db4ab9dc8aecd9c4deaffd6036304aae70d93791/crates/uv-python/src/managed.rs#L253-L254</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/geofft">@geofft</a> on 2025-03-04 03:27</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>Yeah, I was going to turn on Rosetta (this is a Linux VM on an ARM Mac, and <a href="https://developer.apple.com/documentation/virtualization/running-intel-binaries-in-linux-vms-with-rosetta">Apple provides a binfmt-misc handler</a>)</p>
</blockquote>
<p>Dear goodness, I'm not sure how we're going to detect that case.</p>
</blockquote>
<p>One way would be to see if the ELF interpreter exists, and assume that if (e.g.) /lib64/ld-linux-x86_64.so.1 exists it's because someone wants to at least try to run those. This may not help for static musl builds etc. though.</p>
<p>On Linux I guess you can do it without any attempted execs by looking at /proc/sys/fs/binfmt_misc/* (which is world-readable) and seeing if a known ELF header for the platform (or even the actual Python binary in question) would match the magic/mask:</p>
<pre><code>$ cat /proc/sys/fs/binfmt_misc/rosetta
enabled
interpreter /var/lib/rosetta/rosetta
flags: POCF
offset 0
magic 7f454c4602010100000000000000000002003e00
mask fffffffffffefe00fffffffffffffffffeffffff
$ xxd -l20 ~/.local/share/uv/python/*x86*/bin/python3
00000000: 7f45 4c46 0201 0100 0000 0000 0000 0000  .ELF............
00000010: 0200 3e00                                ..&gt;.
</code></pre>
<p>This should work for qemu-user, Rosetta, FEX-Emu, etc. (You also separately need to know what the native CPU can support on its own, like i386 on x86-64, but that seems like an easier problem. Note that <a href="https://github.com/axodotdev/cargo-dist/blob/main/cargo-dist/src/platform.rs">cargo-dist's platform.rs</a> does this and also has some heuristics for Mac Rosetta, though not for Linux Rosetta.)</p>
<p>But, more simply, clearly uv &quot;knows&quot; that this installation has been installed, in that asking to install again is a no-op; I just think <code>uv python list</code> should be consistent with that.</p>
<blockquote>
<blockquote>
<p>Also it'd be nice if we could support --only-binary installs into a completely unrunnable Python?</p>
</blockquote>
<p>We rely on the Python interpreter to report platform tags, as attempting to assume platform tags from the outside is fraught with problems.</p>
</blockquote>
<p>For the python-build-standalone builds in particular, can we not trust ourselves about what they are and what platform tags they support? Would we just need to record this somewhere declarative? (I understand the need to query, like, a system Python.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/marcelroed">@marcelroed</a> on 2025-09-03 17:03</div>
            <div class="timeline-body"><p>With <code>uv</code> version <code>0.8.15</code> on Linux, I'm getting a related issue leading to <code>uv python list</code> failing. It works until there is some cross-platform installation in the directory. I'm doing this in order to build cross-platform libraries.</p>
<pre><code class="language-sh">marcel@fred:~$ uv python list
cpython-3.14.0rc2-linux-x86_64-gnu                 &lt;download available&gt;
cpython-3.14.0rc2+freethreaded-linux-x86_64-gnu    &lt;download available&gt;
cpython-3.13.7-linux-x86_64-gnu                    &lt;download available&gt;
cpython-3.13.7+freethreaded-linux-x86_64-gnu       &lt;download available&gt;
cpython-3.13.5-linux-x86_64-gnu                    .local/share/uv/python/cpython-3.13.5-linux-x86_64-gnu/bin/python3.13
cpython-3.12.11-linux-x86_64-gnu                   .local/share/uv/python/cpython-3.12.11-linux-x86_64-gnu/bin/python3.12
cpython-3.12.3-linux-x86_64-gnu                    /usr/bin/python3.12
cpython-3.12.3-linux-x86_64-gnu                    /usr/bin/python3 -&gt; python3.12
cpython-3.11.13-linux-x86_64-gnu                   .local/share/uv/python/cpython-3.11.13-linux-x86_64-gnu/bin/python3.11
cpython-3.10.18-linux-x86_64-gnu                   &lt;download available&gt;
cpython-3.9.23-linux-x86_64-gnu                    &lt;download available&gt;
cpython-3.8.20-linux-x86_64-gnu                    &lt;download available&gt;
pypy-3.11.13-linux-x86_64-gnu                      &lt;download available&gt;
pypy-3.10.16-linux-x86_64-gnu                      &lt;download available&gt;
pypy-3.9.19-linux-x86_64-gnu                       &lt;download available&gt;
pypy-3.8.16-linux-x86_64-gnu                       &lt;download available&gt;
graalpy-3.11.0-linux-x86_64-gnu                    &lt;download available&gt;
graalpy-3.10.0-linux-x86_64-gnu                    &lt;download available&gt;
graalpy-3.8.5-linux-x86_64-gnu                     &lt;download available&gt;
</code></pre>
<pre><code class="language-sh">marcel@fred:~$ uv python install cpython-3.13.7-macos-aarch64-none
Installed Python 3.13.7 in 316ms
 + cpython-3.13.7-macos-aarch64-none (python3.13)
</code></pre>
<pre><code class="language-sh">marcel@fred:~$ uv python list
error: Failed to inspect Python interpreter from first executable in the search path at `.local/bin/python3.13`
  Caused by: Failed to query Python interpreter at `/home/marcel/.local/bin/python3.13`
  Caused by: Exec format error (os error 8)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-09-03 17:56</div>
            <div class="timeline-body"><p>Thanks @marcelroed! That looks like a separate bug. I opened https://github.com/astral-sh/uv/issues/15667 to track it.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 03:26:32 UTC
    </footer>
</body>
</html>
