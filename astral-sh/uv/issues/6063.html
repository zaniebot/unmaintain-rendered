<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv lock` sometimes changes the lock file when run for a second time - astral-sh/uv #6063</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`uv lock` sometimes changes the lock file when run for a second time</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/6063">#6063</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2024-08-13 17:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-08-13 17:24</div>
            <div class="timeline-body"><p>I believe it is true that this should never happen. To reproduce, create a <code>pyproject.toml</code> with:</p>
<pre><code class="language-toml">[project]
name = &quot;uv-lock-instability&quot;
version = &quot;0.1.0&quot;
description = &quot;whatever&quot;
requires-python = &quot;&gt;=3.9.0&quot;
dependencies = [
    &quot;jax==0.4.17&quot;,
]
</code></pre>
<p>And now do a lock followed by another lock:</p>
<pre><code>$ rm -f *.lock
$ cargo r --manifest-path ~/astral/uv/Cargo.toml -p uv -- lock
$ cp uv.lock before.lock
$ cargo r --manifest-path ~/astral/uv/Cargo.toml -p uv -- lock
$ cp uv.lock after.lock
$ diff before.lock after.lock
15c15
&lt;     { name = &quot;zipp&quot; },
---
&gt;     { name = &quot;zipp&quot;, marker = &quot;python_version &lt; '3.10'&quot; },
</code></pre>
<p>The <code>diff</code> output at the end <em>should</em> be empty, but it isn't.</p>
<p>Running the same steps in the <code>ecosystem/transformers</code> directory produces a larger diff (and this MRE was minimized from that).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @BurntSushi on 2024-08-13 17:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-08-13 17:59</div>
            <div class="timeline-body"><p>If the dependency specification is changed to <code>jax==0.4.18</code>, then the instability no longer happens. So there's something in the difference in dependency metadata here that might give a clue:</p>
<pre><code>[andrew@duff instability-mre]$ diff 0.4.17.md 0.4.18.md
3c3
&lt; Version: 0.4.17
---
&gt; Version: 0.4.18
20a21,22
&gt; Requires-Dist: numpy &gt;=1.23.2 ; python_version &gt;= &quot;3.11&quot;
&gt; Requires-Dist: numpy &gt;=1.26.0 ; python_version &gt;= &quot;3.12&quot;
24c26
&lt; Requires-Dist: jaxlib ==0.4.16 ; extra == 'ci'
---
&gt; Requires-Dist: jaxlib ==0.4.17 ; extra == 'ci'
26c28
&lt; Requires-Dist: jaxlib ==0.4.17 ; extra == 'cpu'
---
&gt; Requires-Dist: jaxlib ==0.4.18 ; extra == 'cpu'
28c30
&lt; Requires-Dist: jaxlib ==0.4.17+cuda11.cudnn86 ; extra == 'cuda'
---
&gt; Requires-Dist: jaxlib ==0.4.18+cuda11.cudnn86 ; extra == 'cuda'
30c32
&lt; Requires-Dist: jaxlib ==0.4.17+cuda11.cudnn86 ; extra == 'cuda11_cudnn86'
---
&gt; Requires-Dist: jaxlib ==0.4.18+cuda11.cudnn86 ; extra == 'cuda11_cudnn86'
32c34
&lt; Requires-Dist: jaxlib ==0.4.17+cuda11.cudnn86 ; extra == 'cuda11_local'
---
&gt; Requires-Dist: jaxlib ==0.4.18+cuda11.cudnn86 ; extra == 'cuda11_local'
34c36
&lt; Requires-Dist: jaxlib ==0.4.17+cuda11.cudnn86 ; extra == 'cuda11_pip'
---
&gt; Requires-Dist: jaxlib ==0.4.18+cuda11.cudnn86 ; extra == 'cuda11_pip'
42a45
&gt; Requires-Dist: nvidia-nccl-cu11 &gt;=2.18.3 ; extra == 'cuda11_pip'
44c47
&lt; Requires-Dist: jaxlib ==0.4.17+cuda12.cudnn89 ; extra == 'cuda12_local'
---
&gt; Requires-Dist: jaxlib ==0.4.18+cuda12.cudnn89 ; extra == 'cuda12_local'
46c49
&lt; Requires-Dist: jaxlib ==0.4.17+cuda12.cudnn89 ; extra == 'cuda12_pip'
---
&gt; Requires-Dist: jaxlib ==0.4.18+cuda12.cudnn89 ; extra == 'cuda12_pip'
54a58
&gt; Requires-Dist: nvidia-nccl-cu12 &gt;=2.18.3 ; extra == 'cuda12_pip'
58,59c62,63
&lt; Requires-Dist: jaxlib ==0.4.17 ; extra == 'tpu'
&lt; Requires-Dist: libtpu-nightly ==0.1.dev20231003 ; extra == 'tpu'
---
&gt; Requires-Dist: jaxlib ==0.4.18 ; extra == 'tpu'
&gt; Requires-Dist: libtpu-nightly ==0.1.dev20231006 ; extra == 'tpu'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-13 21:53</div>
            <div class="timeline-body"><p>I think the source of this instability is that <em>some</em> pieces of code are able to enforce the connection between <code>python_version</code> and <code>python_full_version</code>, but the marker disjointness operations do not.</p>
<p>Specifically, <code>markers::requires_python</code> returns a marker that constrains <em>both</em>, no matter <em>which</em> of the two is present in the input tree. So we sometimes filter out branches based on this when resolving, but then fail to compute the correct union when we lock. At least, that's the cause of the instability in https://github.com/astral-sh/uv/pull/6065...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-13 21:55</div>
            <div class="timeline-body"><p>Another observation is that this fork shouldn't exist:</p>
<pre><code>DEBUG Solving split python_full_version &gt; '3.10' and python_version &lt; '3.10' (requires-python: python_full_version &gt; '3.10' and python_version &gt; '3.10')
</code></pre>
<p>Notice that the marker and the requires-python are disjoint. (The marker itself is <code>false</code>, but even if we don't merge <code>python_full_version</code> and <code>python_version</code>, this should still be identified as disjoint.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-13 22:06</div>
            <div class="timeline-body"><p>Something like this diff, which resolves the instability (but then we still write the &quot;bad&quot; fork marker to the lockfile):</p>
<pre><code class="language-diff"> impl Forks {
-    fn new(name_to_deps: BTreeMap&lt;PackageName, Vec&lt;PubGrubDependency&gt;&gt;) -&gt; Forks {
+    fn new(
+        name_to_deps: BTreeMap&lt;PackageName, Vec&lt;PubGrubDependency&gt;&gt;,
+        requires_python: Option&lt;&amp;MarkerTree&gt;,
+    ) -&gt; Self {
         let mut forks = vec![Fork {
             dependencies: vec![],
             markers: MarkerTree::TRUE,
@@ -2780,6 +2788,7 @@ impl Forks {
                 let mut new = vec![];
                 for mut fork in std::mem::take(&amp;mut forks) {
                     if fork.markers.is_disjoint(&amp;markers) {
+                        // If the fork is disjoint with his fork's markers, just re-add it.
                         new.push(fork);
                         continue;
                     }
@@ -2789,11 +2798,25 @@ impl Forks {
                     if !fork.markers.is_disjoint(&amp;not_markers) {
                         let mut new_fork = fork.clone();
                         new_fork.intersect(not_markers);
-                        new.push(new_fork);
+                        if !requires_python.is_some_and(|requires_python| {
+                            requires_python.is_disjoint(&amp;new_fork.markers)
+                                || marker::requires_python(&amp;new_fork.markers).is_some_and(
+                                    |python| python.to_marker_tree().is_disjoint(requires_python),
+                                )
+                        }) {
+                            new.push(new_fork);
+                        }
                     }
                     fork.dependencies.push(dep.clone());
                     fork.intersect(markers);
-                    new.push(fork);
+                    if !requires_python.is_some_and(|requires_python| {
+                        requires_python.is_disjoint(&amp;fork.markers)
+                            || marker::requires_python(&amp;fork.markers).is_some_and(|python| {
+                                python.to_marker_tree().is_disjoint(requires_python)
+                            })
+                    }) {
+                        new.push(fork);
+                    }
                     markers = new_markers;
                 }
                 forks = new;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-13 22:33</div>
            <div class="timeline-body"><p>Sorry, I should clarify: all my comments are about the instability in https://github.com/astral-sh/uv/pull/6065. I haven't looked at the instability here at all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-08-14 02:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-14 02:05</div>
            <div class="timeline-body"><p>@BurntSushi -- I'll look at this, I'm so deep on these problems right now anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-14 02:17</div>
            <div class="timeline-body"><p>I think there are a few different problems, but here's one:</p>
<ul>
<li>The first fork we solve for is <code>python_version &lt; 3.10</code>.</li>
<li><code>jax</code> depends on: <code>importlib-metadata &gt;=4.6 ; python_version &lt; &quot;3.10&quot;</code>.</li>
<li>So in that fork, we add <code>importlib-metadata</code>.</li>
<li><code>importlib-metadata</code> depends on: <code>zipp &gt;=0.5</code></li>
<li>So we solve and include it.</li>
</ul>
<p>The other forks then include:</p>
<pre><code>edge: ResolutionDependencyEdge { from: Some(PackageName(&quot;jax&quot;)), from_version: &quot;0.4.17&quot;, from_url: None, from_extra: None, from_dev: None, to: PackageName(&quot;importlib-metadata&quot;), to_version: &quot;8.2.0&quot;, to_url: None, to_extra: None, to_dev: None, marker: python_version &lt; '3.10' }
</code></pre>
<p>And:</p>
<pre><code>edge: ResolutionDependencyEdge { from: Some(PackageName(&quot;importlib-metadata&quot;)), from_version: &quot;8.2.0&quot;, from_url: None, from_extra: None, from_dev: None, to: PackageName(&quot;zipp&quot;), to_version: &quot;3.20.0&quot;, to_url: None, to_extra: None, to_dev: None, marker: true }
</code></pre>
<p>Because we solve for <code>importlib-metadata</code> <em>before</em> we fork! So each fork includes this dependency and edge, even though it's not relevant to all of them.</p>
<p>The <code>true</code> marker in the second case is problematic. It causes us to remove the <code>python_version &lt; '3.10'</code> when we write out the lockfile.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-14 02:19</div>
            <div class="timeline-body"><p>I suspect @BurntSushi's more aggressive forking strategy would fix this, for one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-08-14 15:18</div>
            <div class="timeline-body"><p>I can confirm that the aggressive forking strategy does fix this particular case of instability.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-14 15:20</div>
            <div class="timeline-body"><p>I think the other way we could fix it is: write the full, standardized metadata to the lockfile.</p>
<p>Then, when we resolve, don't seed the forks. Just proceed with with a &quot;normal&quot; resolution. But continue to respect the fork-preference mapping. And maybe reject the resolution at the end if it creates a fork we didn't see last time?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-08-15 00:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 04:47:33 UTC
    </footer>
</body>
</html>
