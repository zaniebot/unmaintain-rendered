<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copy-up of entry points breaks Python scripts in /usr/local/bin on Debian and Fedora - astral-sh/uv #15113</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Copy-up of entry points breaks Python scripts in /usr/local/bin on Debian and Fedora</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/15113">#15113</a>
        opened by <a href="https://github.com/geofft">@geofft</a>
        on 2025-08-06 18:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/geofft">@geofft</a> on 2025-08-06 18:20</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Starting with uv 0.8.0 (#14447), <code>uv run --with</code> creates an ephemeral virtual environment with a <code>_uv_ephemeral_overlay.pth</code> file to add the base virtual environment's import directory to <code>sys.path</code>. Starting with uv 0.8.1 (#14790), it also copies up detected entry points from the base environment into the ephemeral virtual environment's bin directory. The directory added to <code>sys.path</code> and the directory searched for entry points are taken from the default sysconfig scheme of the base interpreter.</p>
<p>Distributions like Debian and Fedora (and their downstreams) configure their sysconfig scheme to report /usr/local/bin for <code>sysconfig.get_path('scripts')</code> and a subdirectory of /usr/local/lib(64)/python3.x for <code>sysconfig.get_path('purelib')</code> and <code>'platlib</code>, but Python itself is installed into /usr/bin, and OS-packaged Python packages are installed into /usr/lib(64)/python3.x. The reason for this is so that <code>sudo pip install</code> will put both entrypoints and modules into the admin-managed /usr/local/ directory tree, where it won't conflict with the OS-managed /usr/ tree.</p>
<p>The combination of these two is that, on these distributions, the ephemeral environment searches /usr/local/bin/ for potential entrypoints and adds /usr/local/lib(64)/python3.x to <code>sys.path</code>, but does not add /usr/lib(64)/python3.x.</p>
<p>This means that a script in /usr/local/bin/ that depends on system Python and system-packaged dependencies will get copied into the venv and have its shebang modified, and will no longer be able to find its dependencies:</p>
<pre><code>$ cat /usr/local/bin/blah
#!/usr/bin/python3

import debian
print(debian)
$ blah
&lt;module 'debian' from '/usr/lib/python3/dist-packages/debian/__init__.py'&gt;
$ uv run --no-managed-python --with attrs blah
Traceback (most recent call last):
  File &quot;/home/ubuntu/.cache/uv/builds-v0/.tmpA7lg6b/bin/blah&quot;, line 3, in &lt;module&gt;
    import debian
ModuleNotFoundError: No module named 'debian'
</code></pre>
<p>In my opinion, the fact that we're copying this up into the venv is itself a little weird and we should just not do that, but there are other ways to solve this bug, e.g. using <code>--system-site-packages</code> instead of attempting to add the system site packages directory ourselves via the .pth file.</p>
<p>cc @zanieb</p>
<h3>Platform</h3>
<p>Ubuntu 24.04, Fedora 42</p>
<h3>Version</h3>
<p>uv 0.8.5</p>
<h3>Python version</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @geofft on 2025-08-06 18:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/15121.html">astral-sh/uv#15121</a> on 2025-08-07 01:15</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:05 UTC
    </footer>
</body>
</html>
