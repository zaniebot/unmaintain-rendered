```yaml
number: 8343
title: "uv does not respect position of comments in `pyproject.toml`"
type: issue
state: closed
author: notatallshaw
labels:
  - bug
  - help wanted
assignees: []
created_at: 2024-10-18T17:48:18Z
updated_at: 2024-10-20T17:16:14Z
url: https://github.com/astral-sh/uv/issues/8343
synced_at: 2026-01-10T01:57:19Z
```

# uv does not respect position of comments in `pyproject.toml`

---

_Issue opened by @notatallshaw on 2024-10-18 17:48_

uv 0.4.24

Maybe this is already reported but I couldn't find it.

**Steps to reproduce:**

1, `uv init temp`
2. `cd temp`
3. `uv add requests`
4. `uv add whenever~=0.6.9`
5. Edit `project.dependencies` in `pyproject.toml` from:
```toml
dependencies = [
    "requests>=2.32.3",
    "whenever~=0.6.9",
]
```

To:
```toml
dependencies = [
    "requests>=2.32.3", # Should not expect to be updated frequently
    "whenever~=0.6.9", # Pinned to 0.6 due to API not yet being stable
]
```

6. `uv add uv zope`
7. Check `project.dependencies` in `pyproject.toml`:

**Actual output:**

```toml
dependencies = [
    "requests>=2.32.3",
    "uv>=0.4.24",
    # Should not expect to be updated frequently
    "whenever~=0.6.9",
    "zope>=5.11",
     # Pinned to 0.6 due to API not yet being stable
]
```

**Expected output:**


```toml
dependencies = [
    "requests>=2.32.3", # Should not expect to be updated frequently
    "uv>=0.4.24",
    "whenever~=0.6.9", # Pinned to 0.6 due to API not yet being stable
    "zope>=5.11", 
]
```

**Context:**

I often leave comments in my `pyproject.toml` to explain why a particular dependency is pinned or given an upper bound.

I appreciate that comments are a hard problem when reading and writing toml, and there will always be edge cases where the user needs to manually update them (e.g. a requirement is removed), but I don't think this example is an edge case.

---

_Comment by @charliermarsh on 2024-10-18 17:57_

I suppose that's a legitimate bug though end-of-line comments are my mortal enemy from working on the formatter and I don't know if I can work up the courage to fix it myself :)

---

_Label `bug` added by @charliermarsh on 2024-10-18 17:57_

---

_Label `help wanted` added by @charliermarsh on 2024-10-18 17:57_

---

_Comment by @flyaroundme on 2024-10-20 00:24_

Tricky one. The fun thing is that the "current dependency line comment" in this case is becoming a next dependency `prefix`, so in case it is the comment on the last line it is becoming part of `trailing`, that's why it is in the end of the file after adding `zope`.
I am digging into it so feel free to assign on me, but most probably can send the fix more close to the end of the weekend, so I'm totally fine if somebody solves it beforehand

---

_Referenced in [astral-sh/uv#8384](../../astral-sh/uv/pulls/8384.md) on 2024-10-20 15:07_

---

_Closed by @charliermarsh on 2024-10-20 17:16_

---

_Closed by @charliermarsh on 2024-10-20 17:16_

---
