<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tool_install_python_requests test failure - astral-sh/uv #7586</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>tool_install_python_requests test failure</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/7586">#7586</a>
        opened by <a href="https://github.com/mgorny">@mgorny</a>
        on 2024-09-20 14:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mgorny">@mgorny</a></div>
            <div class="timeline-body"><p>On top of 8259600ca6a5d278f3aa7825f5346a8dc7a851c3, Gentoo Linux amd64:</p>
<pre><code>$ cargo test --test=tool_install tool_install_python_requests 
    Finished `test` profile [unoptimized + debuginfo] target(s) in 0.25s
     Running tests/tool_install.rs (target/debug/deps/tool_install-7a5b1e963b5fdf36)

running 1 test
test tool_install_python_requests ... FAILED

failures:

---- tool_install_python_requests stdout ----
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot: tool_install_python_requests-3
Source: crates/uv/tests/tool_install.rs:2126
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
Expression: snapshot
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
    1     1 │ exit_code: 0
    2     2 │ ----- stdout -----
    3     3 │ 
    4     4 │ ----- stderr -----
    5       │-Ignoring existing environment for `black`: the requested Python interpreter does not match the environment interpreter
    6       │-Resolved [N] packages in [TIME]
    7       │-Prepared [N] packages in [TIME]
    8       │-Installed [N] packages in [TIME]
    9       │- + black==24.3.0
   10       │- + click==8.1.7
   11       │- + mypy-extensions==1.0.0
   12       │- + packaging==24.0
   13       │- + pathspec==0.12.1
   14       │- + platformdirs==4.2.0
   15       │-Installed 2 executables: black, blackd
          5 │+`black` is already installed
────────────┴──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
To update snapshots run `cargo insta review`
Stopped on the first failure. Run `cargo insta test` to run all snapshots.
thread &#x27;tool_install_python_requests&#x27; panicked at /home/mgorny/.cargo/registry/src/index.crates.io-6f17d22bba15001f/insta-1.40.0/src/runtime.rs:548:9:
snapshot assertion for &#x27;tool_install_python_requests-3&#x27; failed in line 2126
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace


failures:
    tool_install_python_requests

test result: FAILED. 0 passed; 1 failed; 0 ignored; 0 measured; 32 filtered out; finished in 1.77s

error: test failed, to rerun pass `-p uv --test tool_install`
</code></pre>
<p>After hacking a fair bit to get some debug output, I&#x27;ve got:</p>
<pre><code>          5 │+DEBUG uv [VERSION] ([COMMIT] DATE)
          6 │+DEBUG Searching for Python 3.11 in system path
          7 │+DEBUG Found `cpython-3.11.[X]-linux-x86_64-gnu` at `[PYTHON-3.11]` (search path)
          8 │+DEBUG Acquired lock for `tools`
          9 │+DEBUG Found existing environment for tool `black`: tools/black
         10 │+`black` is already installed
         11 │+DEBUG Released lock at `[TEMP_DIR]/tools/.lock`
</code></pre>
<p>Though it clearly did use Python 3.12 earlier on:</p>
<pre><code>          5 │+DEBUG uv [VERSION] ([COMMIT] DATE)
          6 │+DEBUG Searching for Python 3.12 in system path
          7 │+DEBUG Found `cpython-3.11.[X]-linux-x86_64-gnu` at `[PYTHON-3.11]` (search path)
          8 │+DEBUG Found `cpython-3.12.[X]-linux-x86_64-gnu` at `[PYTHON-3.12]` (search path)
          9 │+DEBUG Acquired lock for `tools`
         10 │+DEBUG Using request timeout of [TIME]
         11 │+DEBUG Solving with installed Python version: 3.12.[X]
         12 │+DEBUG Solving with target Python version: &gt;=3.12.[X]
         13 │+DEBUG Adding direct dependency: black*
         14 │+DEBUG No cache entry for: https://pypi.org/simple/black/
         15 │+DEBUG Searching for a compatible version of black (*)
         16 │+DEBUG Selecting: black==24.3.0 [compatible] (black-24.3.0-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-20 16:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-20 16:37</div>
            <div class="timeline-body"><p>Thanks for the report! We can look into this. Did this regress after #7451?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-20 16:44</div>
            <div class="timeline-body"><p>Do your two interpreter versions have the same <code>sys.base_prefix</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgorny">@mgorny</a> on 2024-09-20 16:58</div>
            <div class="timeline-body"><blockquote>
<p>Thanks for the report! We can look into this. Did this regress after #7451?</p>
</blockquote>
<p>Yes.</p>
<blockquote>
<p>Do your two interpreter versions have the same <code>sys.base_prefix</code>?</p>
</blockquote>
<p>Yes, all have <code>/usr</code>.</p>
<blockquote>
<p>@mgorny sorry for the troubles. If you are already tweaking that test, can you try adding a:</p>
<pre><code>        .arg(&quot;--python-preference&quot;)
        .arg(&quot;only-managed&quot;)
</code></pre>
<p>to the arguments and see if it passes again?</p>
</blockquote>
<p>No problem. Yes, that makes the test pass.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgorny">@mgorny</a> on 2024-09-20 16:59</div>
            <div class="timeline-body"><p>Just to be clear, I&#x27;ve added it to the ultimate call, i.e.:</p>
<pre><code>diff --git a/crates/uv/tests/tool_install.rs b/crates/uv/tests/tool_install.rs
index d045e651..3a0c59f4 100644
--- a/crates/uv/tests/tool_install.rs
+++ b/crates/uv/tests/tool_install.rs
@@ -2126,6 +2126,8 @@ fn tool_install_python_requests() {
     uv_snapshot!(context.filters(), context.tool_install()
         .arg(&quot;-p&quot;)
         .arg(&quot;3.11&quot;)
+        .arg(&quot;--python-preference&quot;)
+        .arg(&quot;only-managed&quot;)
         .arg(&quot;black&quot;)
         .env(&quot;UV_TOOL_DIR&quot;, tool_dir.as_os_str())
         .env(&quot;XDG_BIN_HOME&quot;, bin_dir.as_os_str())
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-20 17:10</div>
            <div class="timeline-body"><p>Note that will fetch an interpreter — which I presume you don&#x27;t want.</p>
<p>We need to improve our heuristic for whether or not a Python interpreter matches another. Right now we just compare the base prefix, but we probably need to compare the canonicalized sys.executable on Unix (we can&#x27;t do that on Windows because they&#x27;re always separate binaries).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-20 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-20 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgorny">@mgorny</a> on 2024-09-20 17:25</div>
            <div class="timeline-body"><p>Perhaps <code>sysconfig.get_path(&quot;stdlib&quot;)</code> would work — it should be unique to every Python version installed to the same prefix, and definitely different for every prefix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-20 17:29</div>
            <div class="timeline-body"><p>Thanks, maybe we&#x27;ll use that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-20 18:11</div>
            <div class="timeline-body"><p>Thanks again for the report, this was a user-facing bug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-20 19:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-20 19:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mgorny">@mgorny</a> on 2024-09-21 05:25</div>
            <div class="timeline-body"><p>Thanks a lot!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:34:13 UTC
    </footer>
</body>
</html>
