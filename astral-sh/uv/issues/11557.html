<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv build` with `hatchling` build backend doesn't include nested package in wheel - astral-sh/uv #11557</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>uv build</code> with <code>hatchling</code> build backend doesn't include nested package in wheel</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/11557">#11557</a>
        opened by <a href="https://github.com/Kayrnt">@Kayrnt</a>
        on 2025-02-16 16:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Kayrnt">@Kayrnt</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<h1>High level problem</h1>
<p>I'm building a package using <code>uv build</code> and the resulting file doesn't contain the package source files when it's unzipped.
I noticed that it happened when I moved my python package from root directory into <code>src</code> directory and had to change the configuration to</p>
<pre><code>[tool.hatch.build]
packages = [&quot;src/&lt;my_package&gt;&quot;]
sources = [&quot;src&quot;]
</code></pre>
<h1>How to reproduce</h1>
<p>Let's consider following project:
https://github.com/dbt-labs/dbt-adapters/tree/main/dbt-bigquery</p>
<p>Let's prepare it with <code>uv</code>:</p>
<pre><code class="language-bash">uv sync
uv build
</code></pre>
<p>Resulting <code>dbt_bigquery-1.10.0a1-py3-none-any.whl</code> in <code>/dist</code> doesn't contain any source file ‚ùå</p>
<p>Then if I try to use hatch directly:</p>
<pre><code>uv add --dev hatch
uv run hatch build
</code></pre>
<p>Resulting <code>dbt_bigquery-1.10.0a1-py3-none-any.whl</code> in <code>/dist</code> <strong>contains</strong> source files as expected ‚úÖ</p>
<h1>Workaround</h1>
<p>As shown previously, using <code>hatch</code> directly through <code>uv</code> works:
<code>uv run hatch build</code></p>
<h2>Note</h2>
<p>it wasn't working either with an older uv version so I suspect it's not a regression.</p>
<h3>Platform</h3>
<p>MacOS 15.3 ARM64</p>
<h3>Version</h3>
<p>uv 0.6.0 (591f38c25 2025-02-14)</p>
<h3>Python version</h3>
<p>Python 3.11.1</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @Kayrnt on 2025-02-16 16:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-16 16:35</div>
            <div class="timeline-body"><p>Does this reproduce with the standard build frontend? <code>uvx --from build pypyproject-build</code></p>
<p>Hatch special-cases its own build-backend and it is not uncommon for the behavior to be different.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kayrnt">@Kayrnt</a> on 2025-02-16 16:38</div>
            <div class="timeline-body"><p>Using <code>uvx --from build pyproject-build</code>, the produced artifact doesn't contain the expected source files either ‚ùå</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-16 16:39</div>
            <div class="timeline-body"><p>Yeah sorry, we're just acting as a standards-complaint build frontend here (same as the official <code>build</code> package).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-16 16:40</div>
            <div class="timeline-body"><p>Similar to https://github.com/astral-sh/uv/issues/10066</p>
<p>cc @ofek</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @zanieb on 2025-02-16 16:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2025-02-16 16:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2025-02-16 16:52</div>
            <div class="timeline-body"><p>Same resolution as here: https://github.com/astral-sh/uv/issues/10391#issuecomment-2588165513</p>
<p>Try to never use the global <code>[tool.hatch.build]</code> table and prefer always the target-specific config like <code>[tool.hatch.build.targets.sdist]</code>. Defining <code>packages</code> or <code>sources</code> for the source distribution means the top-level directory is collapsed and therefore won't maintain the structure. You want:</p>
<pre><code class="language-toml">[tool.hatch.build.targets.wheel]
packages = [&quot;src/&lt;my_package&gt;&quot;]

[tool.hatch.build.targets.sdist]
include = [&quot;/src&quot;, &quot;/tests&quot;]
</code></pre>
<p>edit: it's important to note that the only reason you require any config at all is because (due to the naming convention of your package's ecosystem) the name of the package is different than the directory under <code>src</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kayrnt">@Kayrnt</a> on 2025-02-16 16:55</div>
            <div class="timeline-body"><p>@zanieb Reading through that issue (that I didn't find searching, thanks!), I can confirm that:</p>
<pre><code>[tool.hatch.build]
only-include = [&quot;src&quot;]
</code></pre>
<p>~fixes the issue for my project.~
Edit: it is not producing the expected structure for the sdist artifact as described in https://github.com/astral-sh/uv/issues/11557#issuecomment-2661537345</p>
<p>It might be applicable to my own project but it can't be used on a project that is mainly built with the provided hatch working configuration.</p>
<p>Feel free to close the issue if it's not expected to support that kind of configuration.</p>
<p>@ofek, as you can see on https://github.com/dbt-labs/dbt-adapters/blob/main/dbt-bigquery/hatch.toml#L4-L10:</p>
<pre><code>[build.targets.sdist]
packages = [&quot;src/dbt&quot;]
sources = [&quot;src&quot;]

[build.targets.wheel]
packages = [&quot;src/dbt&quot;]
sources = [&quot;src&quot;]
</code></pre>
<p>also doesn't work as expected with <code>uv build</code> but does with <code>hatch build</code>.</p>
<p>Is that kind of configuration wrong and the right way to do it should be:</p>
<pre><code>[build.targets.sdist]
include = [&quot;/src&quot;]

[build.targets.wheel]
packages = [&quot;src/dbt&quot;]
</code></pre>
<p>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2025-02-16 16:59</div>
            <div class="timeline-body"><blockquote>
<p>Try to never use the global <code>[tool.hatch.build]</code> table and prefer always the target-specific config like <code>[tool.hatch.build.targets.sdist]</code>. Defining <code>packages</code> or <code>sources</code> for the source distribution means the top-level directory is collapsed and therefore won't maintain the structure.</p>
</blockquote>
<p>Here is the example configuration I gave you, replacing <code>&lt;my_package&gt;</code> with the actual directory name:</p>
<pre><code class="language-toml">[tool.hatch.build.targets.wheel]
packages = [&quot;src/dbt&quot;]

[tool.hatch.build.targets.sdist]
only-include = [&quot;src&quot;, &quot;tests&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-02-16 17:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-16 17:02</div>
            <div class="timeline-body"><p>(Thanks @ofek!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kayrnt">@Kayrnt</a> on 2025-02-16 17:05</div>
            <div class="timeline-body"><p>I confirm that:</p>
<pre><code>[tool.hatch.build.targets.wheel]
packages = [&quot;src/dbt&quot;]

[tool.hatch.build.targets.sdist]
only-include = [&quot;src&quot;, &quot;tests&quot;]
</code></pre>
<p>works as intended and produced the same artifacts for <code>uv</code> and <code>hatch</code> üëç
I'll suggest the change on the linked repository, thanks @ofek &amp; @zanieb!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kayrnt">@Kayrnt</a> on 2025-02-16 17:17</div>
            <div class="timeline-body"><p>@ofek Actually unzipping the sdist artifact (<code>&lt;package&gt;.tar.gz</code>) will put directly the <code>src</code> directory instead of <code>&lt;package&gt;</code> directory (which is inside of src directory). Yet the wheel is correctly structured. I guess it still miss something for <code>sdist</code> configuration. I'm trying to figure it out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2025-02-16 17:18</div>
            <div class="timeline-body"><p>The behavior you're seeing is correct as you would want the source distribution structure to match the repository.</p>
<p>edit: perhaps this would be better, could you please articulate in your own words why the config fixed your issue?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kayrnt">@Kayrnt</a> on 2025-02-16 17:31</div>
            <div class="timeline-body"><p>Ok I'm not a Python expert so I assume that existing built files are producing the right file structures.
Let's take https://github.com/dbt-labs/dbt-adapters/blob/main/dbt-bigquery/hatch.toml#L4-L10 as the baseline that produce with hatch (after extracting the artifacts):</p>
<pre><code>.
‚îú‚îÄ‚îÄ dbt_bigquery-1.10.0a1
‚îÇ   ‚îî‚îÄ‚îÄ dbt
‚îî‚îÄ‚îÄ dbt_bigquery-1.10.0a1-py3-none-any
    ‚îú‚îÄ‚îÄ dbt
    ‚îî‚îÄ‚îÄ dbt_bigquery-1.10.0a1.dist-info
</code></pre>
<p>If I go for:</p>
<pre><code>[tool.hatch.build.targets.wheel]
packages = [&quot;src/dbt&quot;]

[tool.hatch.build.targets.sdist]
only-include = [&quot;src&quot;]
</code></pre>
<p>it results in:</p>
<pre><code>.
‚îú‚îÄ‚îÄ dbt_bigquery-1.10.0a1
‚îÇ   ‚îî‚îÄ‚îÄ src
‚îÇ       ‚îî‚îÄ‚îÄ dbt
‚îî‚îÄ‚îÄ dbt_bigquery-1.10.0a1-py3-none-any
    ‚îú‚îÄ‚îÄ dbt
    ‚îî‚îÄ‚îÄ dbt_bigquery-1.10.0a1.dist-info
</code></pre>
<p>Then I suspect that though the second configuration is working with both <code>uv build</code> and <code>uv run hatch build</code>, it is not producing the artifacts that will be expected (src instead dbt at the root of the sdist artifact).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2025-02-16 17:38</div>
            <div class="timeline-body"><p>Yes basically there are two ways to produce a wheel: either from a repository directly or from building inside an unpacked source distribution. Unless instructed otherwise, UV does the latter while Hatch does the former.</p>
<p>In the case of your old config, Hatchling was instructed to strip off the <code>src</code> directory for source distributions just like the wheel. Thus when a frontend builds a wheel via an unpacked source distribution there is no more <code>src</code> directory and only what is underneath. Since the wheel target was configured to look for the <code>src</code> directory and it no longer exists then weird things happen.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kayrnt">@Kayrnt</a> on 2025-02-16 17:47</div>
            <div class="timeline-body"><p>I kinda understand what you mean.</p>
<p>Do you think there could be a hatchling configuration that produces:</p>
<pre><code>.
‚îú‚îÄ‚îÄ dbt_bigquery-1.10.0a1
‚îÇ   ‚îî‚îÄ‚îÄ dbt
‚îî‚îÄ‚îÄ dbt_bigquery-1.10.0a1-py3-none-any
    ‚îú‚îÄ‚îÄ dbt
    ‚îî‚îÄ‚îÄ dbt_bigquery-1.10.0a1.dist-info
</code></pre>
<p>and both works with <code>uv</code> and <code>hatch</code>?
It feels like it's not possible but I might miss the right understanding of how both systems work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2025-02-16 17:51</div>
            <div class="timeline-body"><p>No that would not be possible and I'm not sure why you would want the source distribution to match the structure of the wheel. There is no installer in existence that populates a Python environment based on the contents of only the source distribution. A wheel is first produced from a source distribution and then used to populate an environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kayrnt">@Kayrnt</a> on 2025-02-16 18:12</div>
            <div class="timeline-body"><p>I don't really expect the <code>sdist</code> and <code>wheel</code> structure to be the same, I expect that both provide the package at the root level of their respective artifact. I think that's the expected file structure to have <code>&lt;my_package&gt;</code> at the root level and no <code>src</code>.</p>
<blockquote>
<p>There is no installer in existence that populates a Python environment based on the contents of only the source distribution.</p>
</blockquote>
<p>Maybe it's an useless requirement since I'm producing and pushing the wheel to PyPI (which is probably going to be used in 99.99% of the cases). I feel like that if it's currently working with <code>hatch</code> using its configuration, it should also work with <code>uv</code>.</p>
<p>Maybe we could assume that it's not possible and it won't be &quot;fixed&quot; but maybe the <a href="https://github.com/astral-sh/uv/issues/3957">upcoming uv build backend</a> will provide a way to produce correctly both sdist &amp; wheel with the appropriate file structures. In which case, I could use it for my own project and suggest other OSS to move to uv.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2025-02-16 18:25</div>
            <div class="timeline-body"><blockquote>
<p>maybe the <a href="https://github.com/astral-sh/uv/issues/3957">upcoming uv build backend</a> will provide a way to produce correctly both sdist &amp; wheel with the appropriate file structures</p>
</blockquote>
<p>It won't produce a different structure and I don't know how else to convey the reasons why. Perhaps @charliermarsh or @zanieb could provide assistance here in explaining the difference between a source distribution and wheel.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kayrnt">@Kayrnt</a> on 2025-02-16 18:40</div>
            <div class="timeline-body"><p>I read https://packaging.python.org/en/latest/discussions/package-formats/ to try to understand both.
It's not explicit if it should be mapping the repository file structure or if it should map the package structure.
Asking ChatGPT, it points out it should map the repository structure, in which case, the configuration you suggested and that works with both tools is the &quot;right one&quot;.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:29:57 UTC
    </footer>
</body>
</html>
