<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unexpected behavior with `--index-strategy first-index` and missing package in primary index - astral-sh/uv #14665</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Unexpected behavior with `--index-strategy first-index` and missing package in primary index</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/14665">#14665</a>
        opened by <a href="https://github.com/leoschleier">@leoschleier</a>
        on 2025-07-16 16:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/leoschleier">@leoschleier</a> on 2025-07-16 16:18</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Hi everyone,</p>
<p>Thank you for your work on this project! I love <code>uv</code> and appreciate the work that is going into this project.</p>
<p>I have encountered a behavior that seemed unexpected, and I would be grateful for some clarification. Also, I was not able to find a related issue and hope that I have not missed anything.</p>
<h2>Scenario</h2>
<p>I have two indexes (&quot;primary&quot; and &quot;secondary&quot;) specified.</p>
<p>In <code>test-project</code> I try to add <code>my-package</code> as a dependency. This package is only contained in index &quot;secondary&quot;. Index &quot;primary&quot; does not contain any version of this package.</p>
<p>The documentation says:</p>
<blockquote>
<p>first-index (default): Search for each package across all indexes, limiting the candidate versions to those present in the first index that contains the package.</p>
</blockquote>
<p>From this, I would expect that the package is installed from the secondary index since this is &quot;the first index that contains the package&quot;.</p>
<h2>Settings</h2>
<p>The settings in <code>pyproject.toml</code> are as follows:</p>
<pre><code class="language-toml">[project]
name = &quot;test-project&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;==3.13.*&quot;
dependencies = []

[[tool.uv.index]]
name = &quot;primary&quot;
url = &quot;https://my-registry.com/path/to/index&quot;

[[tool.uv.index]]
name = &quot;secondary&quot;
url = &quot;https://my-other-registry.com/path/to/index&quot;
default = true
</code></pre>
<h2>Command</h2>
<pre><code class="language-powershell">uv add my-package -v
</code></pre>
<p>Output:</p>
<pre><code class="language-powershell">PS C:\Users\my-user\Workspace\test-project&gt; uv add my-package -v
DEBUG uv 0.7.21 (77c771c7f 2025-07-14)
DEBUG Found project root: `C:\Users\my-user\Workspace\test-project`
DEBUG No workspace root found, using project root
DEBUG Acquired lock for `C:\Users\my-user\Workspace\test-project`
DEBUG No Python version file found in workspace: C:\Users\my-user\Workspace\test-project
DEBUG Using Python request `==3.13.*` from `requires-python` metadata
DEBUG Checking for Python environment at `.venv`
DEBUG The project environment's Python version satisfies the request: `Python ==3.13.*`
DEBUG Released lock at `C:\Users\my-user\AppData\Local\Temp\uv-ad1b05f90942fef3.lock`
DEBUG Acquired lock for `.venv`
DEBUG Using request timeout of 30s
DEBUG Found static `pyproject.toml` for: test-project @ file:///C:/Users/my-user/Workspace/test-project
DEBUG No workspace root found, using project root
DEBUG Ignoring existing lockfile due to mismatched requirements for: `test-project==0.1.0`
  Requested: {Requirement { name: PackageName(&quot;my-package&quot;), extras: [], groups: [], marker: true, source: Registry { specifier: VersionSpecifiers([]), index: None, conflict: None }, origin: None }}
  Existing: {}
DEBUG Solving with installed Python version: 3.13.2
DEBUG Solving with target Python version: ==3.13.*
DEBUG Adding direct dependency: test-project*
DEBUG Adding direct dependency: test-project:dev*
DEBUG Searching for a compatible version of test-project @ file:///C:/Users/my-user/Workspace/test-project (*)
DEBUG Adding direct dependency: my-package*
DEBUG Searching for a compatible version of test-project @ file:///C:/Users/my-user/Workspace/test-project (*)
DEBUG Adding direct dependency: test-project:dev==0.1.0
DEBUG Acquired lock for `C:\Users\my-user\AppData\Local\uv\cache\simple-v16\index\38748d71f414d183\my-package.lock`
DEBUG Searching for a compatible version of test-project @ file:///C:/Users/my-user/Workspace/test-project (==0.1.0)
DEBUG No cache entry for: https://my-registry.com/path/to/index
DEBUG Released lock at `C:\Users\my-user\AppData\Local\uv\cache\simple-v16\index\38748d71f414d183\my-package.lock`
DEBUG Indexes search failed because of status code failure: 403 Forbidden
DEBUG Searching for a compatible version of my-package (*)
DEBUG No compatible version found for: my-package
DEBUG Recording unit propagation conflict of my-package from incompatibility of (test-project)
DEBUG Searching for a compatible version of test-project @ file:///C:/Users/my-user/Workspace/test-project (&lt;0.1.0 | &gt;0.1.0)
DEBUG No compatible version found for: test-project
DEBUG Reverting changes to `pyproject.toml`
DEBUG Reverting changes to `uv.lock`
  × No solution found when resolving dependencies:
  ╰─▶ Because my-package was not found in the package registry and your project depends on my-package, we can conclude that your project's requirements are
      unsatisfiable.

      hint: An index URL (https://my-registry.com/path/to/index) could not be queried due to a lack of valid authentication credentials (403
      Forbidden).
  help: If you want to add the package regardless of the failed resolution, provide the `--frozen` flag to skip locking and syncing.
DEBUG Released lock at `C:\Users\my-user\Workspace\test-project\.venv\.lock`
</code></pre>
<h2>Additional Observations</h2>
<p>Despite this error, the dependency can still be added using the &quot;unsafe&quot; index strategies. That is,</p>
<pre><code class="language-powershell">uv add my-package --index-strategy unsafe-first-match
</code></pre>
<p>and</p>
<pre><code class="language-powershell">uv add my-package --index-strategy unsafe-best-match
</code></pre>
<p>will succeed in adding the dependency and installing the package.</p>
<p>Although the output reports an authentication error with the primary index, adding other existing packages from this index does not cause any problems.</p>
<p>Could you kindly clarify whether the observed behavior is intended? If so, it appears that this specific case may not be fully covered in the documentation.</p>
<h3>Platform</h3>
<p>Windows 11 x86_64</p>
<h3>Version</h3>
<p>uv 0.7.21 (77c771c7f 2025-07-14)</p>
<h3>Python version</h3>
<p>Python 3.13.2</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @leoschleier on 2025-07-16 16:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-16 18:04</div>
            <div class="timeline-body"><p>Can you try setting the option described here? Specifically, <code>ignore-error-codes = [403]</code> https://docs.astral.sh/uv/concepts/indexes/#ignoring-error-codes-when-searching-across-indexes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/leoschleier">@leoschleier</a> on 2025-07-16 19:13</div>
            <div class="timeline-body"><p>Ah, I completely missed that section. Turns out the answer was right there all along! Thanks for pointing me in the right direction, and for your help. Much appreciated!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @leoschleier on 2025-07-16 19:13</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:04 UTC
    </footer>
</body>
</html>
