<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Running `uv` in a read-only docker-like filesystem - astral-sh/uv #12650</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Running `uv` in a read-only docker-like filesystem</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/12650">#12650</a>
        opened by <a href="https://github.com/tgrohens">@tgrohens</a>
        on 2025-04-03 13:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/tgrohens">@tgrohens</a> on 2025-04-03 13:00</div>
            <div class="timeline-body"><h3>Question</h3>
<p>Hi,</p>
<p>I'm using <code>uv</code> to manage a project that I would like to run in an HPC environment, by packaging it within a <a href="https://hpc.github.io/charliecloud/">charliecloud</a> (Docker-like) read-only image.</p>
<p>I've followed the <a href="https://docs.astral.sh/uv/guides/integration/docker/">using uv with Docker</a> doc page and come up with the following Dockerfile (using a toy package as example):</p>
<pre><code>FROM ghcr.io/astral-sh/uv:python3.12-bookworm-slim
RUN apt-get update
RUN apt-get -y install git

# Clone the package
WORKDIR /usr/src
RUN git clone https://github.com/tgrohens/test_cowsay.git

# Install Python environment
WORKDIR /usr/src/test_cowsay
RUN uv sync --frozen
RUN uv pip install .
# note that charliecloud does not support the CMD command
</code></pre>
<p>If I build this into an image named <code>cowsay.sqfs</code> and try to run the project from outside the image with a simple <code>uv run</code> like so:</p>
<pre><code>$ ch-run cowsay.sqfs --cd=/usr/src/test_cowsay -- uv run test_cowsay hello
</code></pre>
<p>I get (maybe expectedly):</p>
<pre><code>error: failed to open file `/root/.cache/uv/sdists-v9/.git`: Read-only file system (os error 30)
</code></pre>
<p>I can also run the image with a temporary overlay filesystem:</p>
<pre><code>$ ch-run cowsay.sqfs --write-fake --cd=/usr/src/test_cowsay -- uv run test_cowsay hello
</code></pre>
<p>In that case, I get (maybe also expectedly since there are multiple filesystems involved):</p>
<pre><code>      Built test-cowsay @ file:///usr/src/test_cowsay
  Ã— Failed to build `test-cowsay @ file:///usr/src/test_cowsay`
  â”œâ”€â–¶ Failed to write to the distribution cache
  â•°â”€â–¶ failed to rename file from /root/.cache/uv/.tmpcZhUM8 to
      /root/.cache/uv/archive-v0/aXKPSjE2NUpWA24hZCKqY: Cross-device link (os error 18)
</code></pre>
<p>Am I missing anything here or is this a usecase that's not supported yet?
Cheers,</p>
<h3>Platform</h3>
<p>Debian bookworm slim Linux 6.1.0-28-arm64</p>
<h3>Version</h3>
<p>uv 0.6.12</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @tgrohens on 2025-04-03 13:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-04-03 13:27</div>
            <div class="timeline-body"><p>Have you tried creating a writable mount for the cache directory specifically? You could also try <code>--no-cache</code> and create a writable mount at <code>/tmp</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tgrohens">@tgrohens</a> on 2025-04-03 13:54</div>
            <div class="timeline-body"><p>Thanks for the suggestion!
I hadn't tried that, but it gives me another error within the <code>.venv</code> directory this time:</p>
<pre><code>error: failed to remove file `/usr/src/test_cowsay/.venv/lib/python3.12/site-packages/../../../bin/test_cowsay`: Read-only file system (os error 30)
</code></pre>
<p>With the overlay fs:</p>
<pre><code>error: failed to remove directory `/usr/src/test_cowsay/.venv/lib/python3.12/site-packages/test_cowsay-0.1.0.dist-info`: I/O error (os error 5)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-04-03 14:01</div>
            <div class="timeline-body"><p>You may want <code>uv run --no-sync</code> so we don't attempt to update the environment.</p>
<p>Regarding...</p>
<pre><code>RUN uv sync --frozen
RUN uv pip install .
</code></pre>
<p>Why do you do a <code>pip install</code> operation after syncing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tgrohens">@tgrohens</a> on 2025-04-03 14:19</div>
            <div class="timeline-body"><p>Using both <code>--no-sync</code> and <code>--no-cache</code> works, thank you!
As for using <code>uv pip install</code>, I must have thought this was needed at some point but it works just fine without it.</p>
<p>Thanks for the great support ðŸš€ !</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @tgrohens on 2025-04-03 14:19</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 03:44:33 UTC
    </footer>
</body>
</html>
