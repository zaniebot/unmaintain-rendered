```yaml
number: 1987
title: "Recursive extra dependencies don't compile like pip-tools"
type: issue
state: closed
author: jdawang
labels:
  - bug
assignees: []
created_at: 2024-02-26T16:04:21Z
updated_at: 2024-02-26T21:15:59Z
url: https://github.com/astral-sh/uv/issues/1987
synced_at: 2026-01-12T15:58:33Z
```

# Recursive extra dependencies don't compile like pip-tools

---

_@jdawang_

<!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

Essentially the same issue as https://github.com/jazzband/pip-tools/issues/1685. When you have a recursive extras in a `pyproject.toml` for a private project, `uv pip compile` fails. If the project is uploaded to an index, then it looks in the index first, but I'd expect it to prioritize the self-reference in `pyproject.toml`.

**Info**
- Platform: macOS Sonoma 14.3
- uv version: v0.1.10
- command: `uv pip compile pyproject.toml --extra=dev`

**Reproducible example (from pip-tools issue)**

Minimal `pyproject.toml`
```toml
[project]
name = "privateproject"
version = "0.0.1"
dependencies = [
    "tomli",
]

[project.optional-dependencies]
test = [
    "pep517",
]
dev = [
    "privateproject[test]",
]
```

With pip-tools, this is the output:
```bash
❯ pip-compile pyproject.toml --extra=dev
WARNING: --strip-extras is becoming the default in version 8.0.0. To silence this warning, either use --strip-extras to opt into the new default or use --no-strip-extras to retain the existing behavior.
#
# This file is autogenerated by pip-compile with Python 3.10
# by the following command:
#
#    pip-compile --extra=dev pyproject.toml
#

pep517==0.13.1
    # via privateproject
privateproject[test] @ file:///...
    # via file:///...
tomli==2.0.1
    # via
    #   pep517
    #   privateproject
    #   privateproject (pyproject.toml)
```

With uv, this is the output:
```bash
❯ uv pip compile pyproject.toml --extra=dev
  × No solution found when resolving dependencies:
  ╰─▶ Because privateproject[test] was not found in the package registry and privateproject depends on privateproject[test], we can conclude that
      the requirements are unsatisfiable.
```



---

_Label `bug` added by @charliermarsh on 2024-02-26 19:09_

---

_Assigned to @charliermarsh by @charliermarsh on 2024-02-26 19:09_

---

_Comment by @charliermarsh on 2024-02-26 19:09_

I thought I fixed this but I'll take another look.

---

_Comment by @charliermarsh on 2024-02-26 19:44_

Ahh this is slightly different, you're passing the `pyproject.toml` directly, I see.

---

_Comment by @charliermarsh on 2024-02-26 19:44_

`echo "privateproject[test] @ ./privateproject" | cargo run pip compile - -n` works without issue, for reference.

---

_Closed by @charliermarsh on 2024-02-26 20:44_

---

_Comment by @charliermarsh on 2024-02-26 20:44_

Fixed in the next release, thanks.

---

_Comment by @jdawang on 2024-02-26 21:15_

Thanks for the quick fix!

---
