<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv run behavior with optional dependencies - astral-sh/uv #15222</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv run behavior with optional dependencies</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/15222">#15222</a>
        opened by <a href="https://github.com/andythomas">@andythomas</a>
        on 2025-08-11 15:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/andythomas">@andythomas</a></div>
            <div class="timeline-body">Summary
<p>I found a (to me) inconsistent behavior of <code>uv run</code> when compared to <code>uv pip install</code>. In detail:</p>
<p>In the &#x27;pyproject.toml&#x27;, I have the following lines:</p>
<p>EDIT: in <code>[project.optional-dependencies]</code>!</p>
<pre><code>spi = [
    &quot;spidev; platform_system == &#x27;Linux&#x27; and (platform_machine == &#x27;armv7l&#x27; or platform_machine == &#x27;aarch64&#x27;)&quot;,
    &quot;RPi; platform_system == &#x27;Linux&#x27; and (platform_machine == &#x27;armv7l&#x27; or platform_machine == &#x27;aarch64&#x27;)&quot;,
]
</code></pre>
<p>so I can chose to install the required drivers when running on a raspberry pi. With <code>uv pip install &quot;.[spi]&quot;</code> I get</p>
<pre><code>Using Python 3.12.11 environment at: /Users/thomasa/.venv/matr1x
Resolved 187 packages in 331ms
      Built matr1x @ file:///Users/thomasa/SynologyDrive/Github/IFW_software/core_library
Prepared 1 package in 219ms
Uninstalled 1 package in 17ms
Installed 1 package in 4ms
 ~ matr1x==8.0.1 (from file:///Users/thomasa/SynologyDrive/Github/IFW_software/core_library)
</code></pre>
<p>and it works fine even when running on my desktop mac. It seems to skip the packages, just as I would have expected. However, if I run <code>uv run pytests --verbose</code> it first installs the package in a venv with (presumably) all optional dependencies checked and fails:</p>
<pre><code>warning: `VIRTUAL_ENV=/Users/thomasa/.venv/matr1x` does not match the project environment path `.venv` and will be ignored; use `--active` to target the active environment instead
  × No solution found when resolving dependencies for split (python_full_version &gt;= &#x27;3.12&#x27; and sys_platform != &#x27;win32&#x27;):
  ╰─▶ Because there are no versions of rpi{(platform_machine == &#x27;aarch64&#x27; and sys_platform == &#x27;linux&#x27;) or (platform_machine == &#x27;armv7l&#x27;
      and sys_platform == &#x27;linux&#x27;)} and matr1x[spi] depends on rpi{(platform_machine == &#x27;aarch64&#x27; and sys_platform == &#x27;linux&#x27;) or
      (platform_machine == &#x27;armv7l&#x27; and sys_platform == &#x27;linux&#x27;)}, we can conclude that matr1x[spi]&#x27;s requirements are unsatisfiable.
      And because your project requires matr1x[spi], we can conclude that your project&#x27;s requirements are unsatisfiable.
</code></pre>
<p>My expectation is that either both fail or both work. Both working and skipping the packages would be my desired (and expected) behavior.</p>
<p>The current behavior would force me to put all dependencies that have a platform requirement in the &#x27;dependencies&#x27; section of the toml.</p>
Platform
<p>MacOS; Darwin 24.5.0 arm64</p>
Version
<p>uv 0.8.3 (7e78f54e7 2025-07-24)</p>
Python version
<p>Python 3.13.5</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/andythomas">@andythomas</a> on 2025-08-11 15:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-11 15:41</div>
            <div class="timeline-body"><p><code>uv pip</code> performs a platform-specific resolution for your current environment, while <code>uv run</code> performs a universal resolution to generate a lockfile that works for all developers.</p>
<p>Please read https://docs.astral.sh/uv/concepts/resolution/#platform-specific-resolution</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-11 15:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-11 15:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andythomas">@andythomas</a> on 2025-08-11 16:25</div>
            <div class="timeline-body"><p>Thank you for the insanely quick answer :)</p>
<p>It still feels inconsistent to me. Couldn&#x27;t uv come up with the following universal resolution:<code>spi = [ &quot;spidev&quot;,  &quot;RPi&quot;]</code> for the RasPi and <code>spi = []</code> for all other systems, because that would happen if I would run <code>uv pip install</code> on these systems. Or is there other (edge) cases where this behavior would be undesirable?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-11 16:31</div>
            <div class="timeline-body"><p>So... digging into it a little more. The error says</p>
<blockquote>
<p>there are no versions of rpi{(platform_machine == &#x27;aarch64&#x27; and sys_platform == &#x27;linux&#x27;) or (platform_machine == &#x27;armv7l&#x27; and sys_platform == &#x27;linux&#x27;)}</p>
</blockquote>
<p>Maybe a dumb question, but... where is <code>rpi</code> coming from here? It&#x27;s not on PyPI? https://pypi.org/project/rpi/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andythomas">@andythomas</a> on 2025-08-11 16:40</div>
            <div class="timeline-body"><p>I see now, that is embarrassing. It cannot resolve that for the RasPi platform, because even for that there is no package on PyPi.  It is a typo and presumable means <code>RPi.GPIO</code>. With that I did <code>uv pip compile --universal --extra=spi pyproject.toml </code> and it works! I apologize and appreciate the time you took.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/andythomas">@andythomas</a> on 2025-08-11 16:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-12 02:30</div>
            <div class="timeline-body"><p>No problem, thanks for following up.</p>
<p>This is a good example of <a href="https://github.com/astral-sh/uv/issues/15092">astral-sh/uv#15092</a> where the markers make this error message more confusing than it should be.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:39:57 UTC
    </footer>
</body>
</html>
