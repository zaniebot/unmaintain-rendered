<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv cache clean` fails on Windows when sdist contains special filenames - astral-sh/uv #16586</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>uv cache clean</code> fails on Windows when sdist contains special filenames</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/16586">#16586</a>
        opened by <a href="https://github.com/sunfkny">@sunfkny</a>
        on 2025-11-04 07:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sunfkny">@sunfkny</a></div>
            <div class="timeline-body">Summary
<p>Moved from <a href="https://github.com/astral-sh/uv/issues/15569">astral-sh/uv#15569</a>#issuecomment-3477947525</p>
Description
<p>On Windows, when running <code>uv add uwsgi</code>, the build process fails (which is expected as uwsgi cannot compile on Windows). However, when subsequently running uv cache clean, the command fails because the cached sdist contains a file with a Windows-incompatible name (ending with a period).</p>
Steps to Reproduce
<p>On Windows, create a new project and add <code>uwsgi</code>.</p>
<pre><code>uv init
uv add uwsgi
</code></pre>
<p>The build fails as expected since <code>uwsgi</code> is not supported on Windows.</p>
<p>Then run:</p>
<pre><code>uv cache clean
</code></pre>
Expected Behavior
<p><code>uv cache clean</code> should remove cached source distributions (sdists).</p>
Actual Behavior
<pre><code>Clearing cache at: AppData\Local\uv\cache
error: Failed to clear cache at: AppData\Local\uv\cache
  Caused by: failed to remove file `C:\Users\root\AppData\Local\uv\cache\sdists-v9\index\3ba65c4f41aac3a1\uwsgi\2.0.31\l1w3t3Nrz8OnzxF6ri3eg\src\core\logging.`: The system cannot find the file specified. (os error 2)
</code></pre>
Suggested Fix
<p>Use logic similar to Pythonâ€™s <a href="https://github.com/python/cpython/blob/947bb4642c612b66de7cae815aaf9c570a93882a/Lib/ntpath.py#L311-L316">isreserved</a> to detect and handle reserved or invalid Windows filenames before deletion.</p>
<p>When removing such files, use the extended <code>\\?\</code> path prefix to bypass Win32 path normalization, which allows operations on paths exceeding <code>MAX_PATH</code> or containing characters normally restricted by the Win32 API (such as trailing dots or spaces).</p>
Platform
<p>Windows 11 24H2</p>
Version
<p>uv 0.9.7 (0adb44480 2025-10-30)</p>
Python version
<p>Python 3.13.5</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/sunfkny">@sunfkny</a> on 2025-11-04 07:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">windows</span> added by <a href="https://github.com/konstin">@konstin</a> on 2025-11-04 16:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">great writeup</span> added by <a href="https://github.com/konstin">@konstin</a> on 2025-11-04 16:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by <a href="https://github.com/konstin">@konstin</a> on 2025-12-18 16:19</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:40:54 UTC
    </footer>
</body>
</html>
