<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv lock --upgrade --dry-run` giving &quot;Lockfile changes detected&quot; despite no changes - astral-sh/uv #16839</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>uv lock --upgrade --dry-run</code> giving &quot;Lockfile changes detected&quot; despite no changes</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/16839">#16839</a>
        opened by <a href="https://github.com/shenanigansd">@shenanigansd</a>
        on 2025-11-24 20:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/shenanigansd">@shenanigansd</a></div>
            <div class="timeline-body">Summary
<p>Running <code>uv lock --upgrade --dry-run</code> is showing &quot;<strong>Lockfile changes detected</strong>&quot;, but running without the <code>--dry-run</code> flag makes no changes to the lockfile.</p>
<pre><code>@shenanigansd ➜ /workspaces/core (main) $ uv lock --upgrade --dry-run
Resolved 156 packages in 7.28s
Lockfile changes detected
@shenanigansd ➜ /workspaces/core (main) $ uv lock --upgrade 
Resolved 156 packages in 295ms
@shenanigansd ➜ /workspaces/core (main) $ git status
On branch main
Your branch is up to date with &#x27;origin/main&#x27;.

nothing to commit, working tree clean
@shenanigansd ➜ /workspaces/core (main) $ 
</code></pre>
<p>Dry run logs with <code>-vvv</code>: https://gist.github.com/shenanigansd/786852dc4cbd8f549ad7f8387edab568</p>
Platform
<p>Linux 6.8.0-1030-azure x86_64 GNU/Linux</p>
Version
<p>uv 0.9.11</p>
Python version
<p>Python 3.14.0</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/shenanigansd">@shenanigansd</a> on 2025-11-24 20:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/EliteTK">@EliteTK</a> by <a href="https://github.com/EliteTK">@EliteTK</a> on 2025-12-18 16:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EliteTK">@EliteTK</a> on 2025-12-19 15:46</div>
            <div class="timeline-body"><p>So when we read the original lockfile, we &quot;complexify&quot; the marker trees to include the python version. But the resolution from the resolver (<code>ResolverOutput::fork_markers</code>) doesn&#x27;t include the python version in its marker trees, so when we <a href="https://github.com/astral-sh/uv/blob/1d9672c11c8ec008b27fe158897173c8f1f0cac3/crates/uv/src/commands/project/lock.rs#L984">check to see if the new <code>Lock</code> is different from the previous</a>, we find that it is, but only because of that discrepancy.</p>
<p>You can reproduce this with:</p>
<pre><code>[project]
name = &quot;project&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = [&quot;markupsafe&lt;2 ; sys_platform != &#x27;win32&#x27;&quot;, &quot;markupsafe==2.0.0 ; sys_platform == &#x27;win32&#x27;&quot;]
</code></pre>
<p>Which is directly taken from the <code>lock::lock_upgrade_log_multi_version</code> integration test.</p>
<p>For an example of the difference between what we read (or well, what we &quot;complexified&quot; into after reading), and what we produce, see this gist:</p>
<p>https://gist.github.com/EliteTK/6e9824f46fb49fe8f803fb3670b0994c/revisions</p>
<hr>
<p>As to solving this, we could stop complexifying the existing lockfile. Since we produce one without that data. But I haven&#x27;t checked if this would break things.</p>
<p>Alternatively, the resolver could output complex markers, which probably shouldn&#x27;t break anything as it&#x27;s strictly superfluous information.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:41:07 UTC
    </footer>
</body>
</html>
