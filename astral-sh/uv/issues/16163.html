<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv venv` suspends itself while prompting - astral-sh/uv #16163</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>uv venv</code> suspends itself while prompting</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/16163">#16163</a>
        opened by <a href="https://github.com/roy-work">@roy-work</a>
        on 2025-10-07 20:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/roy-work">@roy-work</a></div>
            <div class="timeline-body"><h3>Question</h3>
<p>At my org, we have a small wrapper script around <code>uv</code>. I'm going to boil that wrapper down to a minimal example here, but just note that the &quot;real world case&quot; is bigger:</p>
<pre><code class="language-sh">#!/bin/bash

set -eu -o pipefail

function have_dyld_correct() {
	zsh -ic 'python3 -c '\''print(&quot;set&quot;)'\'
}

python3 -c 'import sys; li = sys.stdin.readline(); print(repr(li))'
PYTHON_VERSION=&quot;3.9.19&quot;
HAVE_DYLD_CORRECT=&quot;$(have_dyld_correct)&quot;
uv venv --seed --managed-python --python &quot;$PYTHON_VERSION&quot;
</code></pre>
<p>If you run this, and the venv already exists, <code>uv venv</code> will self-suspend into the background, and then fail if resumed:</p>
<pre><code>± /
» ./wat.sh
Using CPython 3.9.19
Creating virtual environment with seed packages at: .venv
? A virtual environment already exists at `.venv`. Do you want to replace it? [y/n] › yes

hint: Use the `--clear` flag or set `UV_VENV_CLEAR=1` to skip this promptzsh: suspended (tty output)  ./wat.sh
± /
(last command got signal SIGTTOU)
» fg
[2]  - continued  ./wat.sh
error: Failed to create virtual environment
  Caused by: Interrupted system call (os error 4)
± /
»
</code></pre>
<p>Note that at the prompt where I type <code>fg</code>, the TTY's state is borked. (Notably, I have no cursor.) The terminal remains borked even after <code>uv</code> fails.</p>
<p>Either is this a bug in <code>uv</code>, or do you know what's going on here?</p>
<hr />
<p>Removing the interactive <code>zsh</code> call causes <code>uv</code> to behave normally, but it isn't clear to me why those two are interacting the way they are.</p>
<details>
<summary>What is the real wrapper script doing / why <tt>zsh -i</tt>?</summary>

<p>As the function names hit at, we have a function in our wrapper that attempts to check if <code>DYLD_LIBRARY_PATH</code> is appropriately set — this helps us ensure devs don't run into issues with Python modules that have dependencies on native code, e.g., on Pango. The reason for invoking <code>zsh -i</code> is that, on macOS and macOS only, checking the value of <code>DYLD_LIBRARY_PATH</code> is tricky: most of the system utilities will remove it from the environment, and thus many attempts to check its value can result in mistakenly thinking it is unset when it is set. Because <em>this script</em> itself is part of our bootstrapping a dev, it too runs under such a system utility, and so by the time we're executing, <code>DYLD_LIBRARY_PATH</code> has already been unset, <em>even if the user has it set</em>. The <code>zsh -i</code> ensures that the child command gets an environment similar to the user's shell, in which we can check on that env var. (Otherwise, bash is perfectly capable of testing if an env var is set, of course.)</p>
<details>

<h3>Platform</h3>
<p>macOS 15.5, <code>Darwin 24.5.0 arm64</code></p>
<h3>Version</h3>
<p><code>uv 0.8.24 (Homebrew 2025-10-07)</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @roy-work on 2025-10-07 20:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-12-18 13:21</div>
            <div class="timeline-body"><p>This isn't uv specific, I can also reproduce this on Ubuntu 24.04 with zsh using a second Python process:</p>
<pre><code>#!/bin/bash

set -eu -o pipefail

function have_dyld_correct() {
	zsh -ic 'python3 -c '\''print(&quot;set&quot;)'\'
}

python3 -c 'import sys; li = sys.stdin.readline(); print(repr(li))' &amp;
PYTHON_VERSION=&quot;3.9.19&quot;
HAVE_DYLD_CORRECT=&quot;$(have_dyld_correct)&quot;

python3 -c 'import sys; li = input(); print(li)'
</code></pre>
<p>I get a &quot;zsh: suspended (tty input)  ./uv.sh&quot; with and without the <code>&amp;</code> I added above, thought without the <code>&amp;</code>, I need to press enter first (might be a linux thing). It seems that the zsh usage generally does some changes to stdin that affect all programs running afterwards trying to use stdin, uv just happens to be the next program in the script.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EliteTK">@EliteTK</a> on 2025-12-31 14:27</div>
            <div class="timeline-body"><p>Regarding the failure on <code>EINTR</code>. I somehow recall this was fixed. I can't get that to happen with <code>0.9.20</code> at least. That is to say, uv still gets suspended but resuming it doesn't lead to that error. But I haven't tried on a mac.</p>
<p>@konstin's example gets a <code>tty input</code> (<code>SIGTTIN</code>) instead of a <code>tty output</code> (<code>SIGTTOU</code>). It took me a moment to figure out why we would ever get a <code>SIGTTOU</code> for output despite the fact that <code>TOSTOP</code> shouldn't be getting set by default, until I found out that terminal ioctls which modify the terminal state can cause this, and we change the terminal configuration as part of setting up to prompt the user. You can replicate the exact scenario with just:</p>
<pre><code>bash -c 'zsh -ic /bin/true; stty sane'
</code></pre>
<p>That being said, if uv didn't call <code>ioctl(0, TCSETSW, ...)</code> you would get konstin's case above, which can be simplified down to:</p>
<pre><code>bash -c 'zsh -ic /bin/true; read'
</code></pre>
<p>There's a great post on <code>SIGTTOU</code> and <code>SIGTTIN</code> here: https://www.linusakesson.net/programming/tty/index.php It's good background reading for this issue.</p>
<p>Now, especially if you've read the above, you might ask: Why are we getting a <code>SIGTTOU</code>/<code>SIGTTIN</code> in the first place? After all, the process which gets signalled should be in the foreground process group?</p>
<p>Well, if you expand the script and sprinkle some <code>ps lT</code>[^psflags] you get:</p>
<pre><code class="language-bash">ps lT
zsh -ic /bin/true
ps lT
read
</code></pre>
<p>This outputs:</p>
<pre><code>F   UID   PID  PPID PRI  NI    VSZ   RSS WCHAN  STAT TTY        TIME COMMAND
0  1000  2561 31326  20   0  10044  6216 sigsus S    pts/12     0:00 zsh
0  1000  2567  2561  20   0   7152  3564 do_wai S+   pts/12     0:00 /bin/bash ./foo
4  1000  2568  2567  20   0   7456  3700 -      R+   pts/12     0:00 ps lT
0  1000 31326  6468  20   0   8472  5440 do_wai Ss   pts/12     0:00 /bin/bash --posix
F   UID   PID  PPID PRI  NI    VSZ   RSS WCHAN  STAT TTY        TIME COMMAND
0  1000  2561 31326  20   0  10044  6216 sigsus S    pts/12     0:00 zsh
0  1000  2567  2561  20   0   7152  3568 do_wai S    pts/12     0:00 /bin/bash ./foo
4  1000  2572  2567  20   0   7456  3740 -      R    pts/12     0:00 ps lT
0  1000 31326  6468  20   0   8472  5440 do_wai Ss   pts/12     0:00 /bin/bash --posix
zsh: suspended (tty input)  ./foo
</code></pre>
<p>Specifically the <code>+</code> in the STAT column for the first invocation indicates that ps and the bash process itself both belong to the foreground process group.</p>
<p>In the second output, after <code>zsh -i</code>, they no longer belong to the foreground process group.</p>
<p>The reason is that when you use <code>zsh -i</code>, <code>zsh</code> (a child process of bash) will put itself in a new process group (<code>setpgid(0, 0)</code>) and then set the current terminal's (<code>pts/12</code> in the example above) foreground process group ID to its new group ID. This means that the bash instance running the script will from that point onwards no longer be in the foreground process group[^restore-pgrp].</p>
<p>So, to confirm, this isn't a uv issue. Although you can pass <code>--clear</code> to work around it.</p>
<p>If you need to keep using <code>zsh -i</code> you can solve this by spawning that instance of zsh in a new terminal using something like <code>script</code> or alternatively using python's <a href="https://docs.python.org/3/library/pty.html">pty</a> module[^ptymod]. That's probably the most &quot;correct&quot; approach.</p>
<p>But an alternative option is just to use python to re-set the terminal's foreground process group:</p>
<pre><code class="language-bash">zsh -ic /bin/echo
python -c '
import os, sys, signal
signal.pthread_sigmask(signal.SIG_BLOCK, [signal.SIGTTOU])
os.tcsetpgrp(sys.stdin.fileno(), os.getpgid(0))
'
read
</code></pre>
<p>Depends on your appetite for horrendous incantations :)</p>
<p>[^psflags]:  <code>ps</code> is too ancient to have long options which can represent these specific flags.
* <code>l</code>: <code>Display BSD long format.</code>
* <code>T</code>: <code>Select all processes associated with this terminal.</code>
[^restore-pgrp]: The bash instance running the script won't restore this when <code>zsh</code> exits because that's only something it does in interactive mode. Which hints at one solution to this problem: <code>bash -ic 'zsh -ic /bin/echo; read'</code> Although this actually will just move your problem up the stack, if you ever run this script itself in some other context where this may matter.
[^ptymod]: e.g.:
<code>    python -c 'import pty; pty.spawn([&quot;zsh&quot;, &quot;-ic&quot;, &quot;/usr/bin/echo&quot;])'     read    </code></p>
<pre><code>But beware of the fact that doing this will merge stderr and stdout, although I guess you already can't guarantee that something else won't write to stdout in your original version.</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:33:05 UTC
    </footer>
</body>
</html>
