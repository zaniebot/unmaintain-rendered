<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>0.7.14 makes `pip compile` fail when non-default index doesn't contain package. - astral-sh/uv #14941</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>0.7.14 makes `pip compile` fail when non-default index doesn't contain package.</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/14941">#14941</a>
        opened by <a href="https://github.com/claudeviool">@claudeviool</a>
        on 2025-07-28 13:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/claudeviool">@claudeviool</a> on 2025-07-28 13:34</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>E.g., having a custom index <code>corp-pypi</code> as the second, non-default entry.
Fails when resolving public packages e.g. click with a 404 error on the custom index.</p>
<pre><code>Resolving requirements with uv...
⠦ Resolving dependencies...                                                                                                                                                                     error: Request failed after 1 retries
  Caused by: Failed to fetch: `https://pypi.corp.com/simple/click/`
  Caused by: HTTP status client error (404 Not Found) for url (https://pypi.corp.com/simple/click/)
</code></pre>
<h3>Platform</h3>
<p>macOS 15</p>
<h3>Version</h3>
<p>Breaks from 0.7.14 (e7f596711 2025-06-23), including 0.8.3</p>
<h3>Python version</h3>
<p>Python 3.13</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @claudeviool on 2025-07-28 13:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-28 13:46</div>
            <div class="timeline-body"><p>Can you please include the <code>--verbose</code> logs? We may need a reproduction to help you here unfortunately. The general case of what you're describing is not broken, so it might be something very specific to your registry.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/frazar">@frazar</a> on 2025-07-30 12:00</div>
            <div class="timeline-body"><p>This reproduces for me also with uv version 0.8.3 (in particular <code>ghcr.io/astral-sh/uv:0.8.3@sha256:ef11ed817e6a5385c02cd49fdcc99c23d02426088252a8eace6b6e6a2a511f36</code>). Given the configuration file <code>~/.config/uv/uv.toml</code> populated with</p>
<pre><code class="language-toml">index-url = &quot;https://pypi.org/simple&quot;
extra-index-url = [&quot;https://pypi.corp.com/artifactory/api/pypi/pypi/simple&quot;]
allow-insecure-host = [&quot;pypi.corp.com&quot;]
index-strategy = &quot;first-index&quot;
</code></pre>
<p>running the following Dockerfile command</p>
<pre><code>RUN --mount=type=secret,id=netrc,target=/root/.netrc \
    --mount=type=secret,id=uv.toml,dst=/root/.config/uv/uv.toml \
    --mount=type=cache,target=/root/.cache/uv \
    uv venv &quot;$UV_PROJECT_ENVIRONMENT&quot; --no-python-downloads &amp;&amp; \
    uv -vvv pip sync requirements.txt dev-requirements.txt
</code></pre>
<p>yields the logs in the attached file: <a href="https://github.com/user-attachments/files/21509119/logs.txt">logs.txt</a></p>
<p>Here are the last few errors for reference</p>
<pre><code>#15 0.853 TRACE Http::connect; scheme=Some(&quot;https&quot;), host=Some(&quot;pypi.corp.com&quot;), port=None
#15 0.859 DEBUG connected to 151.101.192.223:443
#15 0.869 DEBUG connected to 151.101.192.223:443
#15 0.869 TRACE checkout dropped for (&quot;https&quot;, pypi.corp.com)
#15 0.869 DEBUG Transient request failure for https://pypi.corp.com/artifactory/api/pypi/pypi/simple/iniconfig/, retrying: error sending request for url (https://pypi.corp.com/artifactory/api/pypi/pypi/simple/iniconfig/)
#15 0.869   Caused by: client error (Connect)
#15 0.869   Caused by: dns error
#15 0.869   Caused by: failed to lookup address information: Name does not resolve
#15 0.869 WARN Retry attempt #1. Sleeping 627.605159ms before the next attempt
#15 0.870 TRACE checkout dropped for (&quot;https&quot;, pypi.corp.com)
#15 0.870 DEBUG Transient request failure for https://pypi.corp.com/artifactory/api/pypi/pypi/simple/lxml/, retrying: error sending request for url (https://pypi.corp.com/artifactory/api/pypi/pypi/simple/lxml/)
#15 0.870   Caused by: client error (Connect)
#15 0.870   Caused by: dns error
#15 0.870   Caused by: failed to lookup address information: Name does not resolve
#15 0.870 WARN Retry attempt #1. Sleeping 1.516160903s before the next attempt
#15 0.873 TRACE Handling request for https://pypi.corp.com/artifactory/api/pypi/pypi/simple/opentelemetry-instrumentation-requests/ with authentication policy auto
#15 0.873 TRACE Request for https://pypi.corp.com/artifactory/api/pypi/pypi/simple/opentelemetry-instrumentation-requests/ is unauthenticated, checking cache
#15 0.873 TRACE No credentials in cache for URL https://pypi.corp.com/artifactory/api/pypi/pypi/simple/opentelemetry-instrumentation-requests/
#15 0.873 TRACE Attempting unauthenticated request for https://pypi.corp.com/artifactory/api/pypi/pypi/simple/opentelemetry-instrumentation-requests/
#15 0.873 TRACE checkout waiting for idle connection: (&quot;https&quot;, pypi.corp.com)
#15 0.873 DEBUG starting new connection: https://pypi.corp.com/
#15 0.873 TRACE Http::connect; scheme=Some(&quot;https&quot;), host=Some(&quot;pypi.corp.com&quot;), port=None
#15 0.883 TRACE Considering retry of response HTTP 404 Not Found for https://pypi.corp.com/artifactory/api/pypi/pypi/simple/opentelemetry-instrumentation-wsgi/
#15 0.883 TRACE Cannot retry error: not an IO error
#15 0.883 TRACE checkout dropped for (&quot;https&quot;, pypi.corp.com)
#15 0.883 TRACE checkout dropped for (&quot;https&quot;, pypi.org)
#15 0.883 TRACE checkout dropped for (&quot;https&quot;, pypi.org)
#15 0.883 TRACE checkout dropped for (&quot;https&quot;, pypi.org)
#15 0.883 DEBUG Released lock at `/venv/.lock`
#15 0.893 error: Request failed after 1 retries
#15 0.893   Caused by: Failed to fetch: `https://pypi.corp.com/artifactory/api/pypi/pypi/simple/opentelemetry-instrumentation-wsgi/`
#15 0.893   Caused by: HTTP status client error (404 ) for url (https://pypi.corp.com/artifactory/api/pypi/pypi/simple/opentelemetry-instrumentation-wsgi/)
#15 ERROR: process &quot;/bin/sh -c uv venv \&quot;$UV_PROJECT_ENVIRONMENT\&quot; --no-python-downloads &amp;&amp;     uv -vvv pip sync requirements.txt dev-requirements.txt&quot; did not complete successfully: exit code: 2
</code></pre>
<p>I've also noticed that, for some reason, the log line</p>
<pre><code>HTTP status client error (404 ) for url (https://pypi.corp.com/artifactory/api/pypi/pypi/simple/opentelemetry-instrumentation-wsgi/)
</code></pre>
<p>reports error code with a trailing space (<code>404 </code> instead of <code>404</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-31 02:12</div>
            <div class="timeline-body"><p>So all the requests are failing due to a DNS error (prior to even returning a 404)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/frazar">@frazar</a> on 2025-07-31 05:00</div>
            <div class="timeline-body"><blockquote>
<p>So all the requests are failing due to a DNS error (prior to even returning a 404)?</p>
</blockquote>
<p>Yes, for the specific package leading to the error, <code>opentelemetry-instrumentation-wsgi</code>, this seems to be the case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-31 11:53</div>
            <div class="timeline-body"><p>Sounds like https://github.com/astral-sh/uv/issues/8450 ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/frazar">@frazar</a> on 2025-07-31 12:33</div>
            <div class="timeline-body"><p>Thanks zanieb! That is indeed the cause of the DNS resolution errors.</p>
<p>However, the DNS errors do not fully explain my issue. The last request to <code>pypi.corp.com</code> seems to succeed in its DNS resolution. It then receives a 404 response, and only <em>then</em> the <code>uv sync</code> command fails (in a similar way to the initial error report of this issue).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-31 12:57</div>
            <div class="timeline-body"><p>I'm not sure — the index gave us a 404 and we're reporting it. You can access that same URL without credentials with something like <code>curl</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-31 13:20</div>
            <div class="timeline-body"><p>Hard for me to understand how that error message is even possible but it doesn't come from uv, it comes from reqwest: https://github.com/seanmonstar/reqwest/blob/21226a5bc3059a378b95267f2d743fbea44d4c3e/src/error.rs#L296. <code>Status</code> takes <code>StatusCode</code>, which is a <code>NonZeroU16</code>, and if it's 404, it should then print <code>&quot;Not found&quot;</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-31 13:25</div>
            <div class="timeline-body"><p>I could believe that there's a bug in uv whereby if we retry a request, and it returns a 404, we consider it a failure rather than handling the &quot;Not found&quot; case, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2025-07-31 13:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-31 13:27</div>
            <div class="timeline-body"><p>Yeah, I see something that &quot;looks like&quot; that in the code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/frazar">@frazar</a> on 2025-07-31 13:33</div>
            <div class="timeline-body"><blockquote>
<p>I'm not sure — the index gave us a 404 and we're reporting it.</p>
</blockquote>
<p>Yes, and that's expected. But not sure if this is enough to fail the whole command, considering that the main index (<code>index-url = &quot;https://pypi.org/simple&quot;</code> as specified by config.toml) contains it?</p>
<blockquote>
<p>You can access that same URL without credentials with something like curl?</p>
</blockquote>
<p>Yes, and it returns 404 for this URL.</p>
<pre><code>$ curl --netrc -vk https://pypi.corp.com/artifactory/api/pypi/pypi/simple/opentelemetry-instrumentation-wsgi/
... snip ...
* Request completely sent off
* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
&lt; HTTP/1.1 404
&lt; Date: Thu, 31 Jul 2025 13:28:01 GMT
&lt; Content-Type: application/json
&lt; Transfer-Encoding: chunked
&lt; Connection: keep-alive
&lt; X-JFrog-Version: Artifactory/7.111.10 81110900
&lt; X-Artifactory-Id: come id
&lt; X-Artifactory-Node-Id: other-server.corp.com
&lt; X-Content-Type-Options: nosniff
&lt;
{
  &quot;errors&quot; : [ {
    &quot;status&quot; : 404,
    &quot;message&quot; : &quot;Not found&quot;
  } ]
* Connection #0 to host pypy.corp.com left intact
}
</code></pre>
<p>This is expected because the <code>opentelemetry-instrumentation-wsgi</code> package is not present in the &quot;extra&quot; index <code>pypy.corp.com</code>. Instead (in my expectation) it should be fetched from the main index, <code>pypi.org</code>. So I would expect this particular 404 error should be ignored by <code>uv</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-31 13:40</div>
            <div class="timeline-body"><p>Yeah, I think there's a real bug here in which we fail hard if we hit a 404 after a retry (but handle it correctly when no such retries are required).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-31 13:43</div>
            <div class="timeline-body"><p>Ah I see, thanks for the details!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-07-31 21:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 03:26:44 UTC
    </footer>
</body>
</html>
