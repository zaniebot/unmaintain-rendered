```yaml
number: 7479
title: "uv >=4.8 cache error output"
type: issue
state: closed
author: pmbarrett314
labels:
  - bug
  - cache
assignees: []
created_at: 2024-09-17T19:41:10Z
updated_at: 2024-09-18T19:28:56Z
url: https://github.com/astral-sh/uv/issues/7479
synced_at: 2026-01-10T01:57:17Z
```

# uv >=4.8 cache error output

---

_Issue opened by @pmbarrett314 on 2024-09-17 19:41_

UV 4.8 and above is outputting an error that is breaking tests that expect specific console output when caching is enabled. 4.7 works fine.

The error is: 
error: Failed to build: `curses-menu @ file:///home/runner/work/curses-menu/curses-menu`  Caused by: Failed to deserialize cache entry  Caused by: wrong msgpack marker FixArray(2)'

which comes from [this run](https://github.com/pmbarrett314/curses-menu/actions/runs/10899095053/job/30278277407).

It doesn't seem to be causing any issues running most of my tests, only the ones that are using pyte to test the visual output of my code, which leads me to believe the error itself might not be causing the break, but that it might be being output somewhere it shouldn't be (or I'm reading output from somewhere I shouldn't be).

Do I just need to suppress this error somehow or is this an actual bug?

---

_Comment by @zanieb on 2024-09-17 19:43_

Can you point to the uv invocation you're using?

cc @BurntSushi

---

_Label `bug` added by @zanieb on 2024-09-17 19:43_

---

_Label `cache` added by @zanieb on 2024-09-17 19:43_

---

_Comment by @pmbarrett314 on 2024-09-17 19:46_

Here's the relevant job from my GitHub Action

```
  initial-test:
    name: Test One Version First
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: ${{ vars.UV_VERSION }}
          enable-cache: true
      - name: Set up Python
        run: uv python install ${{ vars.MAIN_PYTHON }}
      - name: Install the project
        run: uv sync --all-extras --dev
      - run: uv run pytest
        name: Run tests
      - run: uv run coverage lcov
        name: Generate coverage report for this run
      - name: Upload coverage report for this run to coveralls
        uses: coverallsapp/github-action@main
        with:
          github-token: ${{ secrets.github_token }}
          path-to-lcov: .cov/coverage.lcov
          parallel: true
```

---

_Comment by @charliermarsh on 2024-09-17 19:47_

Do you see the same errors if you avoid using the shared GitHub Actions cache? Like with `enable-cache = false`? I'm trying to understand whether this is a cache compatibility issue (you have some data from pre-4.8, and we broke compatibility in 4.8) or a standalone issue on 4.8.

---

_Comment by @pmbarrett314 on 2024-09-17 19:49_

The issue initially showed up on 4.10, I deleted all of my caches and then tried a few different versions to narrow it down between 4.7 and 4.8. I'll set enable-cache to false and report back.

---

_Comment by @pmbarrett314 on 2024-09-17 19:54_

It does still output that error with enable-cache = false on 4.8 but not 4.7

---

_Comment by @charliermarsh on 2024-09-17 19:57_

Okay thank you! If you run `uv cache clean` before `uv python install`, do you see the same thing?

---

_Comment by @pmbarrett314 on 2024-09-17 20:03_

[I do indeed](https://github.com/pmbarrett314/curses-menu/actions/runs/10910194062/job/30280095212)

---

_Comment by @charliermarsh on 2024-09-17 20:33_

Thanks. I can replicate this just by cloning and running `uv run pytest test/test_graphics.py::TestBasicMenu::test_basic_menu`.

---

_Comment by @pmbarrett314 on 2024-09-17 23:03_

That does also happen for me.

---

_Comment by @charliermarsh on 2024-09-18 00:25_

I can't replicate this as soon as I switch to a local uv build, even at the same commit.

---

_Comment by @charliermarsh on 2024-09-18 00:32_

It looks like that job is running `uv==0.3.1`? I think this is just about the uv resolution in the subprocess or something.

---

_Comment by @charliermarsh on 2024-09-18 00:33_

I think when you run `uv run pytest test/test_graphics.py::TestBasicMenu::test_basic_menu`, then _inner_ `uv run` command is then going to resolve to the uv version of the _project_.

---

_Comment by @pmbarrett314 on 2024-09-18 02:20_

Yep, updating the uv requirement in `uv.lock` followed by `uv cache clean` fixes that on my local machine. Do y'all have any thoughts on my janky "uv-within-uv" scenario other than just making sure I keep the lockfile up to date with the version I'm using in Actions?

---

_Comment by @charliermarsh on 2024-09-18 02:26_

(I do think there may still be a bug here, maybe we forgot to bump a cache version somewhere between 0.3.1 and 0.4.10.)

---

_Comment by @charliermarsh on 2024-09-18 03:00_

Actually, perhaps our behavior is correct... The main issue is we included a change in the cache such that 0.4.7 entries can be read by 0.4.8, but not the other way around.

---

_Comment by @charliermarsh on 2024-09-18 03:03_

I think my suggestion would be to pin the uv version within your `pyproject.toml`. Alternatively, you might want to use a dedicated, separate cache directory for the runs within the project? Like, pass `--cache-dir ./foo` to the `uv run` subprocess calls.

---

_Closed by @charliermarsh on 2024-09-18 03:03_

---

_Referenced in [astral-sh/uv#7485](../../astral-sh/uv/issues/7485.md) on 2024-09-18 06:26_

---

_Comment by @pmbarrett314 on 2024-09-18 19:28_

That sounds good, thanks for looking into it!

---
