<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`exclude-newer` does not influence selection of Python interpreter, should it? - astral-sh/uv #9445</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>exclude-newer</code> does not influence selection of Python interpreter, should it?</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/9445">#9445</a>
        opened by <a href="https://github.com/manzt">@manzt</a>
        on 2024-11-26 15:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/manzt">@manzt</a></div>
            <div class="timeline-body"><p>Context:</p>
<ul>
<li>Prior discussion on <a href="https://discord.com/channels/1039017663004942429/1207998321562619954/1306363222588129392">uv Discord</a></li>
<li>Some confusion about behavior on <a href="https://napari.zulipchat.com/#narrow/channel/212875-general/topic/uv.20.2B.20napari.3A.20run.20scripts.20from.20url/near/484540519">napari zulip</a></li>
</ul>
Motivation
<p>Self-contained scripts with inline metadata and <code>exclude-newer</code> can fail over time when there is a new release of Python, and there are no wheels. For example:</p>
<pre><code>uv init --script foo.py --python=3.8
uv add --script foo.py numpy
uvx juv stamp foo.py --date=2020-01-01
uv run foo.py
</code></pre>
<p>This fails because uv on my machine defaults to Python 3.13. There is no wheel for 3.13, so it tries to build the binary but fails because numpy build from early 2020 depends on distutils, which was removed in Python 3.12. I can of course get the script to work with <code>--python=3.12</code>.</p>
Expected behavior
<p>My naive expectation when using <code>uv  run</code> with <code>exclude-newer</code> would also select an interpreter that respects the upper bound set by the timestamp. However, I think this is more that I&#x27;m starting to assume certain properties about <code>uv run</code> with <code>exclude-newer</code> rather than what <code>exclude-newer</code> is specifically intended for (restricting package resolution by time).</p>
Considerations
<p>As @zanieb mentioned,</p>
<blockquote>
<p>It seems pretty dubious for us to extend it to interpreters since you&#x27;d probably still want the latest patch version for whichever minor? I can see how this would be surprising though.</p>
</blockquote>
<p>Which I had not considered, and agree does seem questionable to extend the semantics in this way.</p>
<p>Right now, the best solution I&#x27;ve found to make the script self-contained is to set an upper bound on the interpreter through <code>requires-python</code> field on a new script, but bringing life back old scripts with <code>exclude-newer</code> right now is a bit of &quot;whack-a-mole&quot; situtation to find the right python version. Also, that &quot;pinning&quot; with <code>requries-python</code> is coupled (implicitly) to what I&#x27;ve set in <code>exclude-newer</code>.</p>
Proposed improvements
<p>It seems like there is some potential to improve the user experience at a minimum. For example, like when the requested interpreter is outside the scripts Python requirement. e.g.,</p>
<blockquote>
<p>Warning: The requested interpreter resolved to Python 3.X.X, which exceeds the upper bound set by exclude-newer (Python 3.X.X). You may want to re-run with the latest patch release for Python 3.X (i.e., --python=3.X).</p>
</blockquote>
<p>Alternatively, perhaps there is a way to achieve the expected behavior automatically.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-26 17:02</div>
            <div class="timeline-body"><p>Thanks for opening this!</p>
<p>I think doing <em>something</em> here is reasonable, a first step is to add Python release date information somewhere — if someone is interested in doing so let&#x27;s talk about the best place for it to go and how we&#x27;ll maintain it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/manzt">@manzt</a> on 2024-11-26 17:18</div>
            <div class="timeline-body"><p>Great! Yes, I was mostly hoping to start a discussion. Perhaps <a href="https://github.com/jwodder/pyversion-info-data">jwooder/pyversion-info-data</a> could be a starting point. cc: @jwodder</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-26 17:25</div>
            <div class="timeline-body"><p>Oh that&#x27;s great, yeah we can probably just download that file and convert it to Rust in the same as we do for Python download metadata.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/manzt">@manzt</a> on 2024-11-26 17:27</div>
            <div class="timeline-body"><p>I’d be happy to make a PR to do so.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw-gts">@notatallshaw-gts</a> on 2024-11-26 17:46</div>
            <div class="timeline-body"><p>One thing that concerns me here is when I am using <code>exclude-newer</code> with CPython pre-releases, these versions were released before the official CPython release date, and popular packages like numpy release wheels for prerelease versions of CPython, e.g. https://pypi.org/project/numpy/2.1.1/#files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">great writeup</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-26 17:51</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:35:47 UTC
    </footer>
</body>
</html>
