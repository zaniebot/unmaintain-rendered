<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dependency resolution failed in offline mode - astral-sh/uv #9277</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Dependency resolution failed in offline mode</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/9277">#9277</a>
        opened by <a href="https://github.com/Winand">@Winand</a>
        on 2024-11-20 14:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Winand">@Winand</a> on 2024-11-20 14:51</div>
            <div class="timeline-body"><p>I'm trying to install a project in offline environment on CentOS 7.
<a href="https://github.com/Winand/uv-offline-project-installation">Here's a project</a> with numpy and pytest dependencies.</p>
<p>First I download all the dependencies for installation on CentOS 7 using <code>uv export</code> and <code>pip download</code>. See <a href="https://github.com/Winand/uv-offline-installation-bug/blob/master/download-requirements.ps1">the script</a>.</p>
<p>On the target system I've put <code>offline=true</code> and <code>no-index=true</code> in uv global settings file.
Then I run <code>uv sync</code> and get an error <em>&quot;no versions of colorama{sys_platform == 'win32'}&quot;</em>. But I'm trying to install on Linux not win32.</p>
<pre><code>[/tmp/uv-offline-installation-bug]$ uv sync -f packages -v
DEBUG uv 0.5.3
DEBUG Found project root: `/tmp/uv-offline-installation-bug`
DEBUG No workspace root found, using project root
DEBUG Reading Python requests from version file at `/tmp/uv-offline-installation-bug/.python-version`
DEBUG Using Python request `3.12` from version file at `.python-version`
DEBUG The virtual environment's Python version satisfies `3.12`
DEBUG Using request timeout of 30s
DEBUG Found 5 packages in `--find-links` entry: file:///tmp/uv-offline-installation-bug/packages
DEBUG Found static `pyproject.toml` for: uv-offline-installation-bug @ file:///tmp/uv-offline-installation-bug
DEBUG No workspace root found, using project root
DEBUG Ignoring existing lockfile due to missing remote index: `numpy` `2.1.3` from `https://pypi.org/simple`
DEBUG Solving with installed Python version: 3.12.3
DEBUG Solving with target Python version: &gt;=3.12
DEBUG Adding direct dependency: uv-offline-installation-bug*
DEBUG Searching for a compatible version of uv-offline-installation-bug @ file:///tmp/uv-offline-installation-bug (*)
DEBUG Adding transitive dependency for uv-offline-installation-bug==0.1.0: numpy&gt;=2.1.3
DEBUG Adding transitive dependency for uv-offline-installation-bug==0.1.0: uv-offline-installation-bug:dev==0.1.0
DEBUG Searching for a compatible version of uv-offline-installation-bug @ file:///tmp/uv-offline-installation-bug (==0.1.0)
DEBUG Adding transitive dependency for uv-offline-installation-bug==0.1.0: uv-offline-installation-bug==0.1.0
DEBUG Adding transitive dependency for uv-offline-installation-bug==0.1.0: uv-offline-installation-bug:dev==0.1.0
DEBUG Searching for a compatible version of uv-offline-installation-bug @ file:///tmp/uv-offline-installation-bug (==0.1.0)
DEBUG Adding transitive dependency for uv-offline-installation-bug==0.1.0: pytest&gt;=8.3.3
DEBUG Searching for a compatible version of numpy (&gt;=2.1.3)
DEBUG Selecting: numpy==2.1.3 [preference] (numpy-2.1.3-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl)
DEBUG Searching for a compatible version of pytest (&gt;=8.3.3)
DEBUG Selecting: pytest==8.3.3 [preference] (pytest-8.3.3-py3-none-any.whl)
DEBUG Adding transitive dependency for pytest==8.3.3: colorama{sys_platform == 'win32'}*
DEBUG Adding transitive dependency for pytest==8.3.3: iniconfig*
DEBUG Adding transitive dependency for pytest==8.3.3: packaging*
DEBUG Adding transitive dependency for pytest==8.3.3: pluggy&gt;=1.5, &lt;2
DEBUG Searching for a compatible version of colorama{sys_platform == 'win32'} (*)
DEBUG No compatible version found for: colorama{sys_platform == 'win32'}
DEBUG Searching for a compatible version of numpy (&gt;=2.1.3)
DEBUG Selecting: numpy==2.1.3 [preference] (numpy-2.1.3-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl)
DEBUG Searching for a compatible version of pytest (&gt;8.3.3)
DEBUG No compatible version found for: pytest
DEBUG Searching for a compatible version of uv-offline-installation-bug @ file:///tmp/uv-offline-installation-bug (&lt;0.1.0 | &gt;0.1.0)
DEBUG No compatible version found for: uv-offline-installation-bug
  × No solution found when resolving dependencies:
  ╰─▶ Because there are no versions of colorama{sys_platform == 'win32'} and pytest==8.3.3 depends on colorama{sys_platform
      == 'win32'}, we can conclude that pytest==8.3.3 cannot be used.
      And because only pytest==8.3.3 is available, we can conclude that all versions of pytest cannot be used.
      And because uv-offline-installation-bug:dev depends on pytest and your project depends on
      uv-offline-installation-bug:dev, we can conclude that your project's requirements are unsatisfiable.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Resolving dependencies in offline mode failed" to "Dependency resolution failed in offline mode" by @Winand on 2024-11-20 14:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-11-20 15:09</div>
            <div class="timeline-body"><p>You can add <code>--frozen</code> to avoid uv doing the resolution, this will make your command pass (e.g. <code>uv sync -f packages -v --no-index --offline --frozen</code>). I'm a bit surprised uv is trying to re-resolve here, maybe due to the new find-links</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Winand">@Winand</a> on 2024-11-20 15:24</div>
            <div class="timeline-body"><p>Unfortunately after adding <code>--frozen</code> I encountered an error as if <code>--no-index</code> had not been specified:</p>
<pre><code>[/tmp/uv-offline-installation-bug]$ uv sync -f packages -v --no-index --offline --frozen
DEBUG uv 0.5.3
DEBUG Found project root: `/tmp/uv-offline-installation-bug`
DEBUG No workspace root found, using project root
DEBUG Reading Python requests from version file at `/tmp/uv-offline-installation-bug/.python-version`
DEBUG Using Python request `3.12` from version file at `.python-version`
DEBUG The virtual environment's Python version satisfies `3.12`
DEBUG Using request timeout of 30s
DEBUG Found 5 packages in `--find-links` entry: file:///tmp/uv-offline-installation-bug/packages
DEBUG Identified uncached distribution: pytest==8.3.3
DEBUG Identified uncached distribution: numpy==2.1.3
DEBUG Identified uncached distribution: iniconfig==2.0.0
DEBUG Identified uncached distribution: packaging==24.2
DEBUG Identified uncached distribution: pluggy==1.5.0
DEBUG No cache entry for: https://files.pythonhosted.org/packages/9e/3e/3757f304c704f2f0294a6b8340fcf2be244038be07da4cccf390fa678a9f/numpy-2.1.3-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
  × Failed to download `numpy==2.1.3`
  ╰─▶ Network connectivity is disabled, but the requested data wasn't found in the cache for:
      `https://files.pythonhosted.org/packages/9e/3e/3757f304c704f2f0294a6b8340fcf2be244038be07da4cccf390fa678a9f/numpy-2.1.3-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl`
  help: `numpy` (v2.1.3) was included because `uv-offline-installation-bug` (v0.1.0) depends on `numpy`
</code></pre>
<p>For comparison:</p>
<pre><code>[/tmp/uv-offline-installation-bug]$ uv sync -f packages -v --offline --no-config
DEBUG uv 0.5.3
DEBUG Found project root: `/tmp/uv-offline-installation-bug`
DEBUG No workspace root found, using project root
DEBUG Ignoring Python version file at `.python-version` due to `--no-config`
DEBUG Using Python request `&gt;=3.12` from `requires-python` metadata
DEBUG The virtual environment's Python version satisfies `&gt;=3.12`
DEBUG Using request timeout of 30s
DEBUG Found 5 packages in `--find-links` entry: file:///tmp/uv-offline-installation-bug/packages
DEBUG Found static `pyproject.toml` for: uv-offline-installation-bug @ file:///tmp/uv-offline-installation-bug
DEBUG No workspace root found, using project root
DEBUG Existing `uv.lock` satisfies workspace requirements
Resolved 7 packages in 3ms
DEBUG Using request timeout of 30s
DEBUG Found 5 packages in `--find-links` entry: file:///tmp/uv-offline-installation-bug/packages
DEBUG Identified uncached distribution: pytest==8.3.3
DEBUG Identified uncached distribution: numpy==2.1.3
DEBUG Identified uncached distribution: iniconfig==2.0.0
DEBUG Identified uncached distribution: packaging==24.2
DEBUG Identified uncached distribution: pluggy==1.5.0
DEBUG No cache entry for: https://files.pythonhosted.org/packages/9e/3e/3757f304c704f2f0294a6b8340fcf2be244038be07da4cccf390fa678a9f/numpy-2.1.3-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
  × Failed to download `numpy==2.1.3`
  ╰─▶ Network connectivity is disabled, but the requested data wasn't found in the cache for:
      `https://files.pythonhosted.org/packages/9e/3e/3757f304c704f2f0294a6b8340fcf2be244038be07da4cccf390fa678a9f/numpy-2.1.3-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl`
  help: `numpy` (v2.1.3) was included because `uv-offline-installation-bug` (v0.1.0) depends on `numpy`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-11-20 15:38</div>
            <div class="timeline-body"><p>The problem is that uv wants to sync from the lockfile, but the lockfile has the packages from pypi locked, and that fails in offline mode if the cache isn't warm (as it was in my case). With <code>-f packages</code>, uv will do a different resolution, locking the <code>packages</code> directory, you can see that in <code>uv.lock</code> after doing <code>uv sync -f packages -v --no-index</code> in online mode. Currently, uv has no support for replacing files from a registry with local files, it only works from cache.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Winand">@Winand</a> on 2024-11-20 16:33</div>
            <div class="timeline-body"><p>~The only solution I've found is to set the folder <code>packages</code> as a default index. Lock file is updated but i can backup and restore it afterwards, so I don't have unstaged changes in repo.~</p>
<details><summary>Log</summary>
<p>

<pre><code>[/tmp/uv-offline-installation-bug]$ uv sync --default-index packages --offline --no-config -v
DEBUG uv 0.5.3
DEBUG Found project root: `/tmp/uv-offline-installation-bug`
DEBUG No workspace root found, using project root
DEBUG Ignoring Python version file at `.python-version` due to `--no-config`
DEBUG Using Python request `&gt;=3.12` from `requires-python` metadata
&lt;...&gt;
Using CPython 3.12.3 interpreter at: /opt/apps/user/.local/bin/python3.12
Creating virtual environment at: .venv
DEBUG Using request timeout of 30s
DEBUG Found static `pyproject.toml` for: uv-offline-installation-bug @ file:///tmp/uv-offline-installation-bug
DEBUG No workspace root found, using project root
DEBUG Existing `uv.lock` satisfies workspace requirements
Resolved 7 packages in 1ms
DEBUG Using request timeout of 30s
DEBUG Requirement already cached: pytest==8.3.3
DEBUG Requirement already cached: numpy==2.1.3
DEBUG Requirement already cached: iniconfig==2.0.0
DEBUG Requirement already cached: packaging==24.2
DEBUG Requirement already cached: pluggy==1.5.0
&lt;...&gt;
warning: Failed to hardlink files; falling back to full copy. This may lead to degraded performance.
         If the cache and target directories are on different filesystems, hardlinking may not be supported.
         If this is intentional, set `export UV_LINK_MODE=copy` or use `--link-mode=copy` to suppress this warning.
Installed 5 packages in 747ms
 + iniconfig==2.0.0
 + numpy==2.1.3
 + packaging==24.2
 + pluggy==1.5.0
 + pytest==8.3.3
</code></pre>
</p>
</details> 

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw-gts">@notatallshaw-gts</a> on 2024-11-20 16:58</div>
            <div class="timeline-body"><blockquote>
<p>The problem is that uv wants to sync from the lockfile, but the lockfile has the packages from pypi locked, and that fails in offline mode if the cache isn't warm (as it was in my case).</p>
</blockquote>
<p>Would it make sense (or at improve user experience) that when a user provides <code>--offline</code> to assume any cache timeout is infinity?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Winand">@Winand</a> on 2024-11-21 06:33</div>
            <div class="timeline-body"><blockquote>
<p>The only solution I've found is to set the folder <code>packages</code> as a default index. Lock file is updated but i can backup and restore it afterwards, so I don't have unstaged changes in repo.</p>
</blockquote>
<p>hmm, it works only with &quot;warm&quot; cache. But I don't remember after which command the cache was updated if I don't have internet access.
upd: i think the cache was updated after I added packages from <code>pip download</code> results on Windows so uv could find <code>colorama</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Winand">@Winand</a> on 2024-11-21 07:52</div>
            <div class="timeline-body"><p>Ok, this solution works.</p>
<p><em>~/.config/uv/uv.toml</em>:</p>
<pre><code class="language-toml">offline = true
no-index = true
</code></pre>
<p>Export to requirements file and install using pip interface:</p>
<pre><code>uv venv
uv export --no-hashes --frozen -o /tmp/requirements.txt
uv pip install -f packages -r /tmp/requirements.txt
rm /tmp/requirements.txt
</code></pre>
<p>The only issue is that I need the project to be installed as a package. So I added it to <code>[tool.hatch.build.targets.wheel]</code> block and now I have to declare <em>hatchling</em> and <em>editables</em> as dev dependencies to download them using <code>pip download</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/miaomiao1992">@miaomiao1992</a> on 2025-03-05 04:10</div>
            <div class="timeline-body"><p>looking forward to solving this issue</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DatHydroGuy">@DatHydroGuy</a> on 2025-03-07 11:38</div>
            <div class="timeline-body"><p>I would also like to see a solution to this issue. If uv could be used to do some sort of <code>uv download</code> on an internet connected machine, and then <code>uv sync</code> against a copy of the downloaded packages on an offline machine, it would be significant.
Using <code>pip</code> works, but dependency resolution seems to be a bit unreliable at times.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Winand">@Winand</a> on 2025-03-20 07:28</div>
            <div class="timeline-body"><blockquote>
<p><code>uv sync</code> against a copy of the downloaded packages on an offline machine</p>
</blockquote>
<p>@DatHydroGuy the problem is that lock-file includes source links by design (to prevent dependency confusion attacks, i think?). So you cannot just say to <code>uv sync</code> that your dependencies are in a folder over there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kcarnold">@kcarnold</a> on 2025-04-08 18:53</div>
            <div class="timeline-body"><p>I hit this and was puzzled by the same thing: why is a Linux install looking for win32-only or darwin-only packages?</p>
<p>Turns out uv tries to resolve in all environments. See https://github.com/astral-sh/uv/issues/11463 — But you can <a href="https://docs.astral.sh/uv/reference/settings/#environments">turn that off</a>. So I added this to my <code>pyproject.toml</code>:</p>
<pre><code class="language-toml">[tool.uv]
# This is necessary to avoid problems like trying to look for colorama, appnope, or pywin32
# since they aren't going to be in our local Linux-only index.
environments = [&quot;sys_platform == 'linux'&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Winand">@Winand</a> on 2025-04-09 06:39</div>
            <div class="timeline-body"><p>@kcarnold earlier in another issue @zanieb said that uv can still access packages from environments not listed in <code>tool.uv.environments</code> (if I get it right)  https://github.com/astral-sh/uv/issues/11664#issuecomment-2671632752</p>
<blockquote>
<p>We might read macOS wheels for metadata, even if they won't become part of the lockfile, because we assume metadata is constant across all wheels for a package.</p>
</blockquote>
<p>But anyways I use this <em>environments</em> feature to keep my lock file smaller.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/krupan">@krupan</a> on 2025-04-24 21:26</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p><code>uv sync</code> against a copy of the downloaded packages on an offline machine</p>
</blockquote>
<p><a href="https://github.com/DatHydroGuy">@DatHydroGuy</a> the problem is that lock-file includes source links by design (to prevent dependency confusion attacks, i think?). So you cannot just say to <code>uv sync</code> that your dependencies are in a folder over there.</p>
</blockquote>
<p>How does recording the source of the package provide any security?  Recording a hash of the package would help a lot more than that, and it would allow uv to be able to get packages from whatever index is available (e.g., locally if on an air-gapped network) as long as the package it gets has the same hash as what it got before.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:01 UTC
    </footer>
</body>
</html>
