<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv pip install ./local/git/repo` locks the git repository, `pip install` does not - astral-sh/uv #9687</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>uv pip install ./local/git/repo</code> locks the git repository, <code>pip install</code> does not</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/9687">#9687</a>
        opened by <a href="https://github.com/Luthaf">@Luthaf</a>
        on 2024-12-06 15:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Luthaf">@Luthaf</a></div>
            <div class="timeline-body"><p>I have some code in my <code>setup.py</code> which calls <code>git update-index --really-refresh</code> and <code>git diff-index --quiet HEAD --</code> to know whether the user is building an unmodified commit or has uncommitted local changes. This is then used to add a local part to the version of the package, for future reference.</p>
<p>This works fine with <code>pip install</code>, but it seems that <code>uv pip install</code> does more on the git side, and I get the following error from <code>git</code>:</p>
<pre><code>fatal: Unable to create '&lt;REPO/PATH&gt;/.git/index.lock': File exists.

Another git process seems to be running in this repository, e.g.
an editor opened by 'git commit'. Please make sure all processes
are terminated then try again. If it still fails, a git process
may have crashed in this repository earlier:
remove the file manually to continue.
</code></pre>
<p>Could it be possible to release the lock before calling <code>setup.py</code>? This happens during <code>Calling setuptools.build_meta.build_wheel(&quot;~/.cache/uv/builds-v0/.tmpmZ68kQ&quot;, {}, None)</code>).</p>
<p>This only seems to happen when the repository is in &quot;dirty&quot; state, with some uncommitted changes.</p>
<p>EDIT: this is with uv version 0.5.6, in a <code>venv</code> virtualenv with Python 3.12.0 on macOS, and <code>git --version</code> is <code>git version 2.39.3 (Apple Git-146)</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-12-06 15:43</div>
            <div class="timeline-body"><p>Thanks for the report. It's not obvious to me where this is happening, might take some digging.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2025-01-07 19:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-07 19:28</div>
            <div class="timeline-body"><p>Is there a simple way to reproduce this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @zanieb on 2025-01-07 19:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Luthaf">@Luthaf</a> on 2025-01-08 09:54</div>
            <div class="timeline-body"><p>I am now unable to reproduce this on the original project that prompted it (for reference, this is https://github.com/metatensor/metatensor). Might have been something strange with my setup, sorry about the noise!</p>
<p>If this happens again I'll try to extract an MRE!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Luthaf on 2025-01-08 09:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/HaoZeke">@HaoZeke</a> on 2025-11-07 16:15</div>
            <div class="timeline-body"><p>This is present still, on dirty repos (with unstaged changes).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2025-11-07 16:29</div>
            <div class="timeline-body"><p>@HaoZeke I would recommend opening a new issue with steps to reproduce</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:28:45 UTC
    </footer>
</body>
</html>
