<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Using --constraint can remove markers from 'uv pip compile --universal' - astral-sh/uv #4575</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Using --constraint can remove markers from 'uv pip compile --universal'</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/4575">#4575</a>
        opened by <a href="https://github.com/Lordshinjo">@Lordshinjo</a>
        on 2024-06-27 08:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Lordshinjo">@Lordshinjo</a> on 2024-06-27 08:46</div>
            <div class="timeline-body"><p>(Note: I suspect the issues also applies to <code>--no-strip-markers</code>, but am only talking about <code>--universal</code> here)</p>
<p>It looks like constraints are considered equal as regular requirements during marker propagation, but constraints do not always contain environment markers (though they can).
This means that when declaring a constraint with no marker on a package, that package and all its transitive dependencies end up stripped of their markers.</p>
<p>AFAIU markers on constraints should be applied but should not result in making markers more open (such as removing the markers or adding a &quot;or&quot;).</p>
<p>The following is a bit of a silly example, but the issue applies nonetheless.</p>
<p><code>requirements.in</code>:</p>
<pre><code>requests; platform_system == &quot;Windows&quot;
</code></pre>
<p><code>constraints.txt</code>:</p>
<pre><code>requests==2.32.3
</code></pre>
<p>Running the command <code>uv pip compile --universal -c constraints.txt -o requirements.txt requirements.in</code>, we get</p>
<ul>
<li>Actual result (<a href="https://gist.githubusercontent.com/Lordshinjo/6edc9ccae94348f6d7490b1de338c854/raw/b3c78e56781307c90c735552bd326465d620d2d0/with-constraints.txt">log</a>):</li>
</ul>
<pre><code>certifi==2024.6.2
    # via requests
charset-normalizer==3.3.2
    # via requests
idna==3.7
    # via requests
requests==2.32.3
    # via
    #   -c constraints.txt
    #   -r requirements.in
urllib3==2.2.2
    # via requests
</code></pre>
<ul>
<li>Expected result (<a href="https://gist.githubusercontent.com/Lordshinjo/6edc9ccae94348f6d7490b1de338c854/raw/b3c78e56781307c90c735552bd326465d620d2d0/without-constraints.txt">log</a>) (which can be obtained running without the <code>-c constraints.txt</code>):</li>
</ul>
<pre><code>certifi==2024.6.2 ; platform_system == 'Windows'
    # via requests
charset-normalizer==3.3.2 ; platform_system == 'Windows'
    # via requests
idna==3.7 ; platform_system == 'Windows'
    # via requests
requests==2.32.3 ; platform_system == 'Windows'
    # via -r requirements.in
urllib3==2.2.2 ; platform_system == 'Windows'
    # via requests
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-06-27 11:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">lock</span> added by @zanieb on 2024-06-27 11:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-06-28 21:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-28 21:10</div>
            <div class="timeline-body"><p>Nice issue, thank you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/4648.html">astral-sh/uv#4648</a> on 2024-06-29 16:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-06-29 16:51</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:20 UTC
    </footer>
</body>
</html>
