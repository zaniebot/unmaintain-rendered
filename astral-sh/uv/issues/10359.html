<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pkgs.dev.azure.com is not cached? - astral-sh/uv #10359</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>pkgs.dev.azure.com is not cached?</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/10359">#10359</a>
        opened by <a href="https://github.com/KalleDK">@KalleDK</a>
        on 2025-01-07 12:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/KalleDK">@KalleDK</a></div>
            <div class="timeline-body"><p>For some reason the cache is missed when using azure index.
I realized it when add / remove of packages that should be cache was redownloaded / refreshed everytime.</p>
<p>Two small examples showing the difference ( I don&#x27;t know if Azure is denying cache and that is the problem )</p>
<pre><code>mkdir test
cd test
uv init .
uv add typing-extensions
uv remove typing-extensions --offline
uv add typing-extensions --offline
# Now add azure index in pyproject.toml
# [tool.uv]
# index-url = &quot;https://VssSessionToken@pkgs.dev.azure.com/XXXx/YYYYY/_packaging/ZZZZ/pypi/simple/&quot;
uv add typing-extensions
uv remove typing-extensions --offline
uv add typing-extensions --offline
# Last here fails with missing in cache
× No solution found when resolving dependencies:
  ╰─▶ Because typing-extensions was not found in the cache and your project depends on typing-extensions, we can conclude that your project&#x27;s requirements are unsatisfiable.

      hint: Packages were unavailable because the network was disabled. When the network is disabled, registry packages may only be read from the cache.
  help: If you want to add the package regardless of the failed resolution, provide the `--frozen` flag to skip locking and syncing.
</code></pre>
<p>Tried with a clean cache, and the package is in the cache.</p>
<p>An even more peculiar is that the remove is also not working, if you have more than one dependency.</p>
<pre><code>mkdir test
cd test
uv init .
uv add typing-extensions
uv add tomlkit
uv remove typing-extensions --offline
uv add typing-extensions --offline
# Now add azure index in pyproject.toml
# [tool.uv]
# index-url = &quot;https://VssSessionToken@pkgs.dev.azure.com/XXXx/YYYYY/_packaging/ZZZZ/pypi/simple/&quot;
uv add typing-extensions
uv add tomlkit
uv remove typing-extensions --offline
# Already fails on the remove for some reason
× No solution found when resolving dependencies:
  ╰─▶ Because tomlkit was not found in the cache and your project depends on tomlkit&gt;=0.13.2, we can conclude that your project&#x27;s requirements are unsatisfiable.

      hint: Packages were unavailable because the network was disabled. When the network is disabled, registry packages may only be read from the cache.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-07 13:45</div>
            <div class="timeline-body"><p>You can run with <code>-vvv</code> and we&#x27;ll give you logs about the caching behavior of the index. My guess is that <code>pkgs.dev.azure.com</code>  does not include any caching headers.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-07 13:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cache</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-07 13:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-14 23:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thomasaarholt">@thomasaarholt</a> on 2025-08-04 20:47</div>
            <div class="timeline-body"><p>I can reproduce this. Here are some logs. An odd observation is that the <em>third</em> time I add it, it caches. But if I remove it and try with <code>--offline</code>, it fails.</p>
<p>With this <a href="https://gist.github.com/thomasaarholt/b8aeac253d1df959730a1aee3829491b">pyproject.toml</a> - and running <code>uv tool install keyring --with artifacts-keyring==1.0.0rc1</code> in order to get a newer rust-based artifacts-keyring that doesn&#x27;t require you installing dotnet. (note that you still won&#x27;t be able to authenticate to my tracker unless I invite you).</p>
<p>This is what I did, with logs:</p>
<ol>
<li><code>uv add polars==1.30</code> log1 - I can try to provide this, but the over 100k lines broke gist.github.com.</li>
<li><code>uv remove polars</code></li>
<li><code>uv add polars==1.30</code> <a href="https://gist.github.com/thomasaarholt/4a238f6c694fd1fff332081b4ea38aad">log2</a></li>
<li><code>uv remove polars</code></li>
<li><code>uv add polars==1.30</code> <a href="https://gist.github.com/thomasaarholt/1407c789a641bd3009ddbfac8e451cfa">log3</a></li>
<li><code>uv remove polars</code></li>
<li><code>uv add polars==1.30 --offline</code> <a href="https://gist.github.com/thomasaarholt/b802e31d9f384f594b68771749941538">log4</a></li>
</ol>
<p>I know that pip doesn&#x27;t cache ADO because ADO uses SAS URLs, which include time-based information in the query string, and pip insists on including the query string when it caches. So because you get a new SAS URL each time, pip will never fulfill it from the cache.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-04 21:44</div>
            <div class="timeline-body"><p>You can set your own caching headers for that index if you want: https://docs.astral.sh/uv/concepts/indexes/#customizing-cache-control-headers. The behavior above seems right? In that as of now, they send <code>no-store</code>:</p>
<pre><code>Cached request https://pkgs.dev.azure.com/thomasaarholt/thomasaarholt-python/_packaging/thomas-python-feed/pypi/simple/polars/ is not storable because its response has a &#x27;no-store&#x27; cache-control directive
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-21 18:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KalleDK">@KalleDK</a> on 2025-08-22 10:15</div>
            <div class="timeline-body"><p>@charliermarsh thanks - I&#x27;ve missed the possibility to change the headers</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:36:32 UTC
    </footer>
</body>
</html>
