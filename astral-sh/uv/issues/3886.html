<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Is uv supposed to use hard links when installing dependencies in virtualenvs? - astral-sh/uv #3886</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Is uv supposed to use hard links when installing dependencies in virtualenvs?</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/3886">#3886</a>
        opened by <a href="https://github.com/pawamoy">@pawamoy</a>
        on 2024-05-28 18:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/pawamoy">@pawamoy</a></div>
            <div class="timeline-body"><p>The README says:</p>
<blockquote>
<p>Disk-space efficient, with a global cache for dependency deduplication.</p>
</blockquote>
<p>I always interpreted this as uv using hard links (or other more efficient platform-specific techniques) to avoid wasting space when installing the same dependencies in many different virtualenvs.</p>
<p>But in practice, it looks like the same module, <code>yaml_env_tag.py</code>, installed in many venvs, for the same Python version (3.11), has a different inode number in each venv:</p>
<pre><code class="language-console">% ls -i */.venv/lib/*/site-packages/yaml_env_tag.py                       
27449386 ansito/.venv/lib/python3.11/site-packages/yaml_env_tag.py
27954769 catalog/.venv/lib/python3.11/site-packages/yaml_env_tag.py
28483068 copier-uv/.venv/lib/python3.11/site-packages/yaml_env_tag.py
32066757 duty/.venv/lib/python3.11/site-packages/yaml_env_tag.py
27450383 fastui/.venv/lib/python3.11/site-packages/yaml_env_tag.py
27463092 fulfill/.venv/lib/python3.11/site-packages/yaml_env_tag.py
30738026 git-changelog/.venv/lib/python3.11/site-packages/yaml_env_tag.py
27609526 griffe2md/.venv/lib/python3.11/site-packages/yaml_env_tag.py
28209604 griffe-inherited-docstrings/.venv/lib/python3.11/site-packages/yaml_env_tag.py
27588071 griffe/.venv/lib/python3.11/site-packages/yaml_env_tag.py
33464782 handler-template/.venv/lib/python3.11/site-packages/yaml_env_tag.py
27529488 markdown-exec/.venv/lib/python3.11/site-packages/yaml_env_tag.py
30676935 mkdocs-autorefs/.venv/lib/python3.11/site-packages/yaml_env_tag.py
27932068 mkdocs-gallery/.venv/lib/python3.11/site-packages/yaml_env_tag.py
28015846 mkdocs-manpage/.venv/lib/python3.11/site-packages/yaml_env_tag.py
27566322 mkdocs-pygments/.venv/lib/python3.11/site-packages/yaml_env_tag.py
34976719 mkdocs-spellcheck/.venv/lib/python3.11/site-packages/yaml_env_tag.py
27672260 mkdocstrings-python/.venv/lib/python3.11/site-packages/yaml_env_tag.py
34634104 mkdocstrings-shell/.venv/lib/python3.11/site-packages/yaml_env_tag.py
30750852 mkdocstrings/.venv/lib/python3.11/site-packages/yaml_env_tag.py
28156683 mono/.venv/lib/python3.11/site-packages/yaml_env_tag.py
28203268 qtile/.venv/lib/python3.11/site-packages/yaml_env_tag.py
28722205 textual/.venv/lib/python3.11/site-packages/yaml_env_tag.py
</code></pre>
<p>Same for any file really:</p>
<pre><code class="language-console">% ls -i */.venv/lib/*/site-packages/griffe/__init__.py
28470384 ansito/.venv/lib/python3.11/site-packages/griffe/__init__.py
27929408 catalog/.venv/lib/python3.11/site-packages/griffe/__init__.py
32619592 duty/.venv/lib/python3.11/site-packages/griffe/__init__.py
30556482 fastapi/.venv/lib/python3.12/site-packages/griffe/__init__.py
28382439 fastui/.venv/lib/python3.11/site-packages/griffe/__init__.py
28274305 fulfill/.venv/lib/python3.11/site-packages/griffe/__init__.py
30922324 git-changelog/.venv/lib/python3.11/site-packages/griffe/__init__.py
30436256 griffe2md/.venv/lib/python3.11/site-packages/griffe/__init__.py
28209421 griffe-inherited-docstrings/.venv/lib/python3.11/site-packages/griffe/__init__.py
27962824 markdown-exec/.venv/lib/python3.11/site-packages/griffe/__init__.py
30695448 mkdocs-autorefs/.venv/lib/python3.11/site-packages/griffe/__init__.py
28720467 mkdocs-gallery/.venv/lib/python3.11/site-packages/griffe/__init__.py
29250701 mkdocs-manpage/.venv/lib/python3.11/site-packages/griffe/__init__.py
33986747 mkdocs-pygments/.venv/lib/python3.11/site-packages/griffe/__init__.py
34981811 mkdocs-spellcheck/.venv/lib/python3.11/site-packages/griffe/__init__.py
27666376 mkdocstrings-python/.venv/lib/python3.11/site-packages/griffe/__init__.py
34639730 mkdocstrings-shell/.venv/lib/python3.11/site-packages/griffe/__init__.py
30723121 mkdocstrings/.venv/lib/python3.11/site-packages/griffe/__init__.py
28185249 qtile/.venv/lib/python3.11/site-packages/griffe/__init__.py
32963180 textual/.venv/lib/python3.11/site-packages/griffe/__init__.py
</code></pre>
<p>So I wonder: is caching enabled by default, and supported on my platform? I'm on ArchLinux.</p>
<p>Coming from PDM, which supports different methods for this (recursive symlinking, hardlinks, etc.), I was happy to see that uv supported it too. Byt maybe I misunderstood?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-28 18:42</div>
            <div class="timeline-body"><p>Yes, we recursively hardlink by default on Linux. On macOS, we recursively reflink.</p>
<p>Is your cache on the same filesystem as your environment?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pawamoy">@pawamoy</a> on 2024-05-28 18:44</div>
            <div class="timeline-body"><p>Thanks for the astral-fast answer. Ah, that might be the issue :thinking: (facepalm) No, uv's cache is on a different disk and partition than my projects. Closing! :slightly_smiling_face: Is there a recommendation here? Should I just move the cache? Or can I have two (or more) cache locations (one per partition or something)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @pawamoy on 2024-05-28 18:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-28 18:46</div>
            <div class="timeline-body"><p>No prob! Thanks for asking, it made me double-check that we're doing it right. I tested on macOS with <code>--link-mode=hardlink</code> and it does seem like the inodes line up:</p>
<pre><code>‚ùØ ls -i venv1/lib/python3.12/site-packages/flask/app.py venv2/lib/python3.12/site-packages/flask/app.py
268196813 venv1/lib/python3.12/site-packages/flask/app.py 268196813 venv2/lib/python3.12/site-packages/flask/app.py
</code></pre>
<p>(They don't line up on macOS <em>by default</em> since we default to reflinks.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-28 18:46</div>
            <div class="timeline-body"><p>Hmm, I'd probably recommend setting <code>UV_CACHE_DIR</code> to something in the same disk / partition as your projects.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pawamoy">@pawamoy</a> on 2024-05-28 18:47</div>
            <div class="timeline-body"><p>I'll do just that. Thanks a lot!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-28 18:48</div>
            <div class="timeline-body"><p>Thank you! Always appreciate your questions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pawamoy">@pawamoy</a> on 2024-05-28 19:01</div>
            <div class="timeline-body"><p>(Just free'd 81GB :flushed:)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:25:03 UTC
    </footer>
</body>
</html>
