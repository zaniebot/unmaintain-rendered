```yaml
number: 6615
title: "Some packages can not be installed with uv contrary to pip, like `ziglang`"
type: issue
state: closed
author: Coruscant11
labels:
  - bug
  - compatibility
assignees: []
created_at: 2024-08-25T19:46:57Z
updated_at: 2024-08-25T22:31:08Z
url: https://github.com/astral-sh/uv/issues/6615
synced_at: 2026-01-10T01:57:14Z
```

# Some packages can not be installed with uv contrary to pip, like `ziglang`

---

_Issue opened by @Coruscant11 on 2024-08-25 19:46_

<!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version`).
-->

Hello ðŸ™‚ First let me thank you for this awesome project !! â¤ï¸ 

## The issue
By using `uv`, I somehow managed to find a strange behaviour in wheel installations.
Indeed, on Linux, I was not able to install the `ziglang` package with `uv`.
Here is the error message:
```console
(fixeduv) root@871e96b7ad46:/uv# uv pip install ziglang
Resolved 1 package in 225ms
error: Failed to install: ziglang-0.13.0-py3-none-manylinux_2_17_aarch64.many
linux2014_aarch64.musllinux_1_1_aarch64.http.whl (ziglang==0.13.0)
  Caused by: The wheel is invalid: Line 5 of the WHEEL file is invalid
```

## The cause

So I looked at the `WHEEL` file content:
```email
Wheel-Version: 1.0
Generator: ziglang make_wheels.py
Root-Is-Purelib: false
Tag:
  py3-none-manylinux_2_17_aarch64.manylinux2014_aarch64.musllinux_1_1_aarch64
```
> Hint: the markdown syntax is `email`
> You can reproduce the parsing error with [a unit test testing this wheel content here](https://github.com/astral-sh/uv/blob/d8c41481ec884cc5166bcfadd95674ff7b2e918d/crates/install-wheel-rs/src/wheel.rs#L843)

Meanwhile, pip can totally install it.
We can directly see that the tag value is containing a linesep and two spaces. So we could say that the wheel is indeed invalid, and `uv` is not to blame here. But the fact is that pip is installing the wheel without any issue...


So i looked at the source code of `uv` and `pip`. And I discovered that the parsing method was not the same.
While [uv is using a simple key value text file parsing method](https://github.com/astral-sh/uv/blob/d8c41481ec884cc5166bcfadd95674ff7b2e918d/crates/install-wheel-rs/src/wheel.rs#L801), `pip` is using `email.message_from_file` function from the python standard library, [as you can see here](https://github.com/pypa/pip/blob/81041f7f573e89361e6ed934436adb6bf40ea3bc/src/pip/_vendor/distlib/wheel.py#L542).

But not only uv, [bdist_wheel too](https://github.com/pypa/wheel/blob/main/src/wheel/_bdist_wheel.py#L462)

So I deduced that the `WHEEL` and `METADATA` files should be generated with email headers syntax.
Furthermore, by looking at the source code of `uv` and `pip`, we can also see that the `Tag` field is totally useless and not read, because both are fetching the tag from the wheel filename. So this issue is only a parsing file method issue.

But then I was then wondering, what could be the reason making uv maintainers not using the same parsing method ? For sure the PEP specification fo the wheels should tell that we need to use email messages formats right ?
But the PEP is in fact only talking about [basic key value format](https://peps.python.org/pep-0491/#file-contents)
<img width="500" alt="image" src="https://github.com/user-attachments/assets/c25cfe37-f641-4808-8167-f6e5f91cb35b">
I should probably contact them in order to have their opinion! ðŸ˜„ 

## Solution

I think the solution here is pretty simple : let's use the same parsing method as `pip`, which is parsing these file as email messages! ðŸš€ 
`uv` needs to be as fast as possible, so I found the [mail_parser crate](https://docs.rs/mail-parser/latest/mail_parser/)
And the test runs as fast as the previous parsing method, sometimes even faster.
I will linked the pull-request #6616: waiting for your opinion! ðŸ˜Š 
I also added a unit test for this specific use case.

Here is the result:
```console
(fixeduv) root@871e96b7ad46:/uv# uv pip install ziglang
Resolved 1 package in 225ms
error: Failed to install: ziglang-0.13.0-py3-none-manylinux_2_17_aarch64.many
linux2014_aarch64.musllinux_1_1_aarch64.http.whl (ziglang==0.13.0)
  Caused by: The wheel is invalid: Line 5 of the WHEEL file is invalid
(fixeduv) root@871e96b7ad46:/uv# ./target/release/uv pip install ziglang
Resolved 1 package in 3ms
Installed 1 package in 177ms
 + ziglang==0.13.0
(fixeduv) root@871e96b7ad46:/uv# uname -a
Linux 871e96b7ad46 6.8.11-300.fc40.aarch64 #1 SMP PREEMPT_DYNAMIC Mon May 27
15:22:03 UTC 2024 aarch64 GNU/Linux
```


Thanks !!! I am open to anything if needed, first contribution on this awesome project here ðŸ˜„ 


---

_Renamed from "Some wheel can not be installed with uv contrary to pip, like `ziglang`" to "Some packages can not be installed with uv contrary to pip, like `ziglang`" by @Coruscant11 on 2024-08-25 19:47_

---

_Referenced in [astral-sh/uv#6616](../../astral-sh/uv/pulls/6616.md) on 2024-08-25 19:56_

---

_Label `bug` added by @charliermarsh on 2024-08-25 20:52_

---

_Label `compatibility` added by @charliermarsh on 2024-08-25 20:52_

---

_Closed by @charliermarsh on 2024-08-25 22:31_

---
