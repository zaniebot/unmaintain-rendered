<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Gitlab CI/CD as a trusted publisher - astral-sh/uv #12754</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Support Gitlab CI/CD as a trusted publisher</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/12754">#12754</a>
        opened by <a href="https://github.com/jamesharr">@jamesharr</a>
        on 2025-04-08 17:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jamesharr">@jamesharr</a></div>
            <div class="timeline-body">Summary
<p>This Issue is a feature request to add Gitlab-CI/CD support as a trusted publisher when working with PyPI repositories.</p>
<p>PyPI has Support for <a href="https://docs.pypi.org/trusted-publishers/using-a-publisher/#gitlab-cicd">Gitlab-CI/CD as a trusted publisher (2)</a> and UV includes support for Github-Actions as a trusted publisher, so I suspect adding Gitlab-CI/CD support would be small incremental work.</p>
<p>It&#x27;s possible that UV might already support this and the only thing required is additional documentation to get the environment variables set correctly. I did not have any luck in making it work on my own after reading UV&#x27;s documentation. It&#x27;s not entirely clear to me as to what underlying tools UV makes use of to do python publishing (I heard Twine mentioned in the Discord community), so my expectation as a user is that the UV docs would include an example+instructions OR link to the documentation of the underlying tool that does the publishing.</p>
<p>During my attempt setting it up, I wound up finding a [blog post (2)] <a href="https://stefan.sofa-rockers.org/2024/11/14/gitlab-trusted-publisher/">1</a> detailing some steps to make it work, however there is some work that needs to be done outside UV to exchange an OAuth2 token for a PyPI JWT token that can be passed in via the CLI.</p>
<p>Example from the <a href="https://stefan.sofa-rockers.org/2024/11/14/gitlab-trusted-publisher/">blog post (1)</a>:</p>
<pre><code>.release-base:
  stage: &#x27;deploy&#x27;
  id_tokens:
    PYPI_ID_TOKEN:
      aud: &#x27;$PYPI_OIDC_AUD&#x27;
  script:
    - &gt;-
      resp=&quot;$(curl -X POST &quot;${PYPI_OIDC_URL}&quot; -d &quot;{\&quot;token\&quot;:\&quot;${PYPI_ID_TOKEN}\&quot;}&quot;)&quot;
    - &gt;-
      publish_token=&quot;$(python -c &quot;import json; print(json.load(&#x27;${resp}&#x27;)[&#x27;token&#x27;])&quot;)&quot;
    - &#x27;uv publish --token &quot;$publish_token&quot;&#x27;

release:
  extends: &#x27;.release-base&#x27;
  rules:
    - if: &#x27;$CI_COMMIT_TAG&#x27;
  environment:
    name: &#x27;release&#x27;
    url: &#x27;https://pypi.org/project/typed-settings/&#x27;
  variables:
    PYPI_OIDC_AUD: &#x27;pypi&#x27;
    PYPI_OIDC_URL: &#x27;https://pypi.org/_/oidc/mint-token&#x27;
    UV_PUBLISH_URL: &#x27;https://upload.pypi.org/legacy/&#x27;
</code></pre>
<p>References:</p>
<ol>
<li><a href="https://stefan.sofa-rockers.org/2024/11/14/gitlab-trusted-publisher/">Publishing to PyPI with a Trusted Publisher from GitLab CI/CD</a> - Stefan Scherfke blog post</li>
<li><a href="https://docs.pypi.org/trusted-publishers/using-a-publisher/#gitlab-cicd">Publishing with a Trusted Publisher</a> - PyPI Docs</li>
<li><a href="https://docs.astral.sh/uv/guides/package/#publishing-your-package">Publishing your package</a> - UV Documentation</li>
<li><a href="https://docs.pypi.org/trusted-publishers/adding-a-publisher/">Using uv in GitLab Ci/CD</a> - UV Documentation</li>
</ol>
Example
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by <a href="https://github.com/jamesharr">@jamesharr</a> on 2025-04-08 17:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/markdoerr">@markdoerr</a> on 2025-05-20 07:36</div>
            <div class="timeline-body"><p>@jamesharr, I have a similar issue.</p>
<p>On gitlab (https://docs.pypi.org/trusted-publishers/using-a-publisher/#gitlab-cicd ) I found the following instructions for
twine using the Trusted Publisher ID:</p>
<pre><code>build-job:
  stage: build
  image: python:3-bookworm
  script:
    - python -m pip install -U build
    - cd python_pkg &amp;&amp; python -m build
  artifacts:
    paths:
      - &quot;python_pkg/dist/&quot;

publish-job:
  stage: deploy
  image: python:3-bookworm
  dependencies:
    - build-job
  id_tokens:
    PYPI_ID_TOKEN:
      # Use &quot;testpypi&quot; if uploading to TestPyPI
      aud: pypi
  script:
    # Install dependencies
    - python -m pip install -U twine

    # Upload to PyPI, add &quot;--repository testpypi&quot; if uploading to TestPyPI
    # With no token specified, twine will use Trusted Publishing
    - twine upload python_pkg/dist/*
</code></pre>
<p>Which I managed to run.</p>
<p>When I try the same with uv, it fails:</p>
<pre><code>release-test:
  stage: publish_pypi
  image: ghcr.io/astral-sh/uv:$UV_VERSION-python$PYTHON_VERSION-$BASE_LAYER
  dependencies:
    - test-build-package
  id_tokens:
    TESTPYPI_ID_TOKEN:
      # Use &quot;testpypi&quot; if uploading to TestPyPI, else use &quot;pypi&quot;
      aud: testpypi
  script:
    # Upload to PyPI, add &quot;--repository testpypi&quot; if uploading to TestPyPI
    - &quot;uv publish --token $TESTPYPI_ID_TOKEN --index testpypi&quot;
  only:
    refs:
      - develop
      - tags
</code></pre>
<p>I get this weird error message from uv when executing the gitlab CI/CD pipeline:</p>
<pre><code>uv publish --index testpypi --token &quot;$TESTPYPI_ID_TOKEN&quot;
error: the argument &#x27;--index &lt;INDEX&gt;&#x27; cannot be used with &#x27;--publish-url &lt;PUBLISH_URL&gt;&#x27;
Usage: uv publish --index &lt;INDEX&gt; --token &lt;TOKEN&gt; --username &lt;USERNAME&gt; --password &lt;PASSWORD&gt; [FILES]...
</code></pre>
<p>as you can see above, I do not use the <code>--publish-url</code> argument. (I configured the testpypi index in pyproject.toml ).</p>
<p>Here is the tools/build system specification part of my pyproject.toml (for reference):</p>
<pre><code>[[tool.uv.index]]
name = &quot;testpypi&quot;
url = &quot;https://test.pypi.org/simple/&quot;
publish-url = &quot;https://test.pypi.org/legacy/&quot;
explicit = true

[build-system]
requires = [&quot;hatchling&quot;]
build-backend = &quot;hatchling.build&quot;

[tool.hatch.version]
path = &quot;src/labscheduler/__init__.py&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jamesharr">@jamesharr</a> on 2025-05-20 10:03</div>
            <div class="timeline-body"><p>@markdoerr , can you edit your reply to include the relevant sections of pyproject.toml? Mostly for reference.</p>
<p>I should also probably provide an update... Below are snippets of what I&#x27;ve settled on for now, but it&#x27;s not what I&#x27;d call an elegant solution. I&#x27;ll be glad to rip it all out when UV has native support.</p>
<p>Full context in this repo:
https://gitlab.com/internet2-collaboration/python-nso-client/</p>
<p>.gitlab-ci.yaml:</p>
<pre><code># Trusted publisher used from:
# https://stefan.sofa-rockers.org/2024/11/14/gitlab-trusted-publisher/
.release-base:
# Abstract base job for &quot;release&quot; jobs.
# Extending jobs must define the following variables:
# - PYPI_OIDC_AUD: Audience for the ID token that GitLab issues to the pipeline job
# - PYPI_OIDC_URL: PyPI endpoint for retrieving a publish token with GitLabâ€™s ID token
# - UV_PUBLISH_URL: PyPI endpoint for the actual upload
  image: ghcr.io/astral-sh/uv:alpine
  stage: &#x27;deploy&#x27;
  dependencies:
    - lint-ruff
    - test-pytest
    - build
  id_tokens:
    PYPI_ID_TOKEN:
      aud: &#x27;$PYPI_OIDC_AUD&#x27;
  script:
    - publish_token=$(uv run --no-project --with httpx util/pypi-token.py)
    - &#x27;uv publish --token &quot;$publish_token&quot;&#x27;
    - &#x27;version=&quot;$(uv run --with hatch-vcs hatchling version)&quot;&#x27;
    - &#x27;echo -e &quot;\033[34;1mPackage on PyPI:\033[0m ${CI_ENVIRONMENT_URL}${version}/&quot;&#x27;

release-test:
  extends: &#x27;.release-base&#x27;
  rules:
    - !reference [.rules, release]
    - !reference [.rules, release-test]
  environment:
    name: &#x27;release-test&#x27;
    url: &#x27;https://test.pypi.org/project/python-nso-client/&#x27;
  variables:
    PYPI_OIDC_AUD: &#x27;testpypi&#x27;
    PYPI_OIDC_URL: &#x27;https://test.pypi.org/_/oidc/mint-token&#x27;
    UV_PUBLISH_URL: &#x27;https://test.pypi.org/legacy/&#x27;

release:
  extends: &#x27;.release-base&#x27;
  rules:
    - !reference [.rules, release]
  environment:
    name: &#x27;release&#x27;
    url: &#x27;https://pypi.org/project/python-nso-client/&#x27;
  variables:
    PYPI_OIDC_AUD: &#x27;pypi&#x27;
    PYPI_OIDC_URL: &#x27;https://pypi.org/_/oidc/mint-token&#x27;
    UV_PUBLISH_URL: &#x27;https://upload.pypi.org/legacy/&#x27;
</code></pre>
<p>util/pypi-token.py:</p>
<pre><code># Python script to convert a GitLab-CI OIDC TOken into a PYPI Token
#   PYPI_OIDC_URL - token generated by GitLab with an &#x27;aud&#x27; of &#x27;pypi&#x27; or &#x27;testpypi&#x27;
#   PYPI_ID_TOKEN - PyPI mint-token URL: https://(test.)pypi.org/_/oidc/mint-token
import os
import httpx
resp = httpx.post(
     os.getenv(&quot;PYPI_OIDC_URL&quot;),
     json={
         &quot;token&quot;: os.getenv(&quot;PYPI_ID_TOKEN&quot;),
     },
)
resp.raise_for_status()
print(resp.json()[&quot;token&quot;])
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Suppert and/or docs to setup Gitlab CI/CD as a trusted publisher&quot; to &quot;Support Gitlab CI/CD as a trusted publisher&quot; by <a href="https://github.com/konstin">@konstin</a> on 2025-05-20 11:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-05-20 11:20</div>
            <div class="timeline-body"><p>Currently, uv only supports GitHub for trusted publishing, but we can add GitLab.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/markdoerr">@markdoerr</a> on 2025-05-20 11:46</div>
            <div class="timeline-body"><p>Dear @konstin ,
thanks for clarification - that is not clear in the uv documentation (and should definitely stated - I tried several hours to get it working ).
@jamesharr, a large community of gitlab users and myself would be very happy, if uv supports trusted publishers :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/markdoerr">@markdoerr</a> on 2025-05-20 11:52</div>
            <div class="timeline-body"><p>@jamesharr,
I added the related part of my pyproject.toml.</p>
<p>Based on @konstin &#x27;s comment, it is now comprehensible, why we failed...</p>
<p>@konstin: shall we open a new issue for the gitlab support ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-05-20 11:53</div>
            <div class="timeline-body"><p>We can use this issue for adding GitLab trusted publishing support.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/markdoerr">@markdoerr</a> on 2025-05-20 11:55</div>
            <div class="timeline-body"><p>@konstin,
great, looking forward :)</p>
<p>(hope, it will not take too long)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jamesharr">@jamesharr</a> on 2025-05-20 12:11</div>
            <div class="timeline-body"><blockquote>
<p>Currently, uv only supports GitHub for trusted publishing, but we can add GitLab.</p>
</blockquote>
<p>@konstin , let me know if this issue needs any clarification, if the team needs testers, or anything else -- I&#x27;ll make myself available. My strength just isn&#x27;t rust or you&#x27;d have a patch now ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/woodruffw">@woodruffw</a> on 2025-09-09 21:10</div>
            <div class="timeline-body"><p>#15583 will add this -- we&#x27;re able to partially test it with mocks, but it&#x27;d be great to have some adventuresome GitLab users give it a test spin as well ðŸ™‚</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/woodruffw">@woodruffw</a> on 2025-09-11 14:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jamesharr">@jamesharr</a> on 2025-09-12 13:43</div>
            <div class="timeline-body"><p>I probably won&#x27;t be able to test it this week, but I&#x27;ll give it a shot.</p>
<p>I&#x27;m not very well versed on rust dev work (and though I do have rust installed). What&#x27;s the easiest/quickest way to get a build from a PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/woodruffw">@woodruffw</a> on 2025-09-12 14:05</div>
            <div class="timeline-body"><blockquote>
<p>I&#x27;m not very well versed on rust dev work (and though I do have rust installed). What&#x27;s the easiest/quickest way to get a build from a PR?</p>
</blockquote>
<p>This is on <code>main</code> now, so the easiest thing to do would probably be to run <code>cargo build --release</code> from the repository root and use the resulting <code>./target/release/uv</code> build ðŸ™‚</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:38:10 UTC
    </footer>
</body>
</html>
