<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>More strict dependency version rules that PEP508 - astral-sh/uv #8326</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>More strict dependency version rules that PEP508</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/8326">#8326</a>
        opened by <a href="https://github.com/Veritaris">@Veritaris</a>
        on 2024-10-18 11:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Veritaris">@Veritaris</a></div>
            <div class="timeline-body"><p>command that was invoked: <code>uv lock</code>
platform: <code>macOS Sonoma 14.6.1</code>
current uv version: <code>uv 0.4.24 (b9cd54913 2024-10-17)</code></p>
<p>Hi team!
Found such more strict beahaviour rather that described in PEP508
If I define dependency as following in <code>pyproject.toml</code>:</p>
<pre><code class="language-toml">dependencies = [
    &quot;httpx==*&quot;,
]
</code></pre>
<p>than after <code>uv lock</code> I get the following error:</p>
<pre><code>ValueError: invalid pyproject.toml config: `project.dependencies[0]`.
configuration error: `project.dependencies[0]` must be pep508
</code></pre>
<p>In <a href="https://docs.astral.sh/uv/concepts/dependencies/#pep-508">docs</a> at PEP508 paragraph it's told that</p>
<blockquote>
<p>A star can be used for the last digit with equals, e.g. foo ==2.1.* will accept any release from the 2.1 series. Similarly, ~= matches where the last digit is equal or higher, e.g., foo ~=1.2 is equal to foo &gt;=1.2,&lt;2, and foo ~=1.2.3 is equal to foo &gt;=1.2.3,&lt;1.3.</p>
</blockquote>
<p>But according to PEP508 <a href="https://peps.python.org/pep-0508/#complete-grammar">grammar</a></p>
<pre><code>wsp           = ' ' | '\t'
version_cmp   = wsp* &lt;'&lt;=' | '&lt;' | '!=' | '==' | '&gt;=' | '&gt;' | '~=' | '==='&gt;
version       = wsp* &lt;( letterOrDigit | '-' | '_' | '.' | '*' | '+' | '!' )+&gt;
version_one   = version_cmp:op version:v wsp* -&gt; (op, v)
version_many  = version_one:v1 (wsp* ',' version_one)*:v2 -&gt; [v1] + v2
versionspec   = ('(' version_many:v ')' -&gt;v) | version_many
</code></pre>
<p>it is also valid to define version via bare wildcard (<code>*</code>)</p>
<p>Was restricting of wildcard usage done intentionally? I understand that I can just remove version constraint, but <code>uv add httpx</code> adds line as in my example</p>
<pre><code class="language-bash">uv add httpx
</code></pre>
<pre><code class="language-toml">dependencies = [
    &quot;httpx==0.27.2&quot;,
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2024-10-18 14:09</div>
            <div class="timeline-body"><p>Packaging also considers this invalid:</p>
<pre><code>&gt;&gt;&gt; import packaging.requirements

&gt;&gt;&gt; packaging.requirements.Requirement(&quot;httpx==1&quot;)
&lt;Requirement('httpx==1')&gt;

&gt;&gt;&gt; packaging.requirements.Requirement(&quot;httpx==1.*&quot;)
&lt;Requirement('httpx==1.*')&gt;

&gt;&gt;&gt; packaging.requirements.Requirement(&quot;httpx==*&quot;)
Traceback (most recent call last):
  File &quot;/home/damian/opensource/support/uv/8326/.venv/lib/python3.13/site-packages/packaging/requirements.py&quot;, line 36, in __init__
    parsed = _parse_requirement(requirement_string)
  File &quot;/home/damian/opensource/support/uv/8326/.venv/lib/python3.13/site-packages/packaging/_parser.py&quot;, line 62, in parse_requirement
    return _parse_requirement(Tokenizer(source, rules=DEFAULT_RULES))
  File &quot;/home/damian/opensource/support/uv/8326/.venv/lib/python3.13/site-packages/packaging/_parser.py&quot;, line 80, in _parse_requirement
    url, specifier, marker = _parse_requirement_details(tokenizer)
                             ~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File &quot;/home/damian/opensource/support/uv/8326/.venv/lib/python3.13/site-packages/packaging/_parser.py&quot;, line 124, in _parse_requirement_details
    marker = _parse_requirement_marker(
        tokenizer,
    ...&lt;5 lines&gt;...
        ),
    )
  File &quot;/home/damian/opensource/support/uv/8326/.venv/lib/python3.13/site-packages/packaging/_parser.py&quot;, line 145, in _parse_requirement_marker
    tokenizer.raise_syntax_error(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        f&quot;Expected end or semicolon (after {after})&quot;,
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        span_start=span_start,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File &quot;/home/damian/opensource/support/uv/8326/.venv/lib/python3.13/site-packages/packaging/_tokenizer.py&quot;, line 167, in raise_syntax_error
    raise ParserSyntaxError(
    ...&lt;3 lines&gt;...
    )
packaging._tokenizer.ParserSyntaxError: Expected end or semicolon (after name and no valid version specifier)
    httpx==*
         ^

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File &quot;&lt;python-input-3&gt;&quot;, line 1, in &lt;module&gt;
    packaging.requirements.Requirement(&quot;httpx==*&quot;)
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File &quot;/home/damian/opensource/support/uv/8326/.venv/lib/python3.13/site-packages/packaging/requirements.py&quot;, line 38, in __init__
    raise InvalidRequirement(str(e)) from e
packaging.requirements.InvalidRequirement: Expected end or semicolon (after name and no valid version specifier)
    httpx==*
         ^
</code></pre>
<blockquote>
<p>it is also valid to define version via bare wildcard (*)</p>
</blockquote>
<p>Are you <em>sure</em>? I would prefer this issue either raised on the <a href="https://github.com/pypa/packaging/issues">packaging repo</a> or the <a href="https://discuss.python.org/c/packaging/14">packaging discussion board </a> before uv breaks compatibility with packaging here (and thus breaks a uv generated <code>pyproject.toml</code> with anything using <code>packaging</code> to parse).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">compatibility</span> added by @zanieb on 2024-10-18 14:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @zanieb on 2024-10-18 14:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">upstream</span> added by @zanieb on 2024-10-18 14:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-18 14:46</div>
            <div class="timeline-body"><p>I'm fairly certain that <code>==*</code> is not valid. From a glance, there are lots of things that are valid in the grammar that aren't actually valid PEP 508 requirements. For example, it looks like <code>==!+!+!</code> would be valid? But yes, I agree with @notatallshaw that this would be better discussed elsewhere since we're in conformance with all the rest of the ecosystem's behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Veritaris">@Veritaris</a> on 2024-10-18 19:41</div>
            <div class="timeline-body"><blockquote>
<p>I would prefer this issue either raised on the <a href="https://github.com/pypa/packaging/issues">packaging repo</a></p>
</blockquote>
<p>I'll create another issue there, thanks, but I've create it here since I faced issue using <strong>uv</strong></p>
<blockquote>
<p>Are you sure?</p>
</blockquote>
<blockquote>
<p>I'm fairly certain that ==* is not valid.</p>
</blockquote>
<p>Yes, and it <em>is</em>, let's compile grammar from PEP508 and see parse result:</p>
<pre><code>&gt;&gt;&gt; from parsley import makeGrammar
&gt;&gt;&gt; grammar = &quot;&quot;&quot;
wsp           = ' ' | '\t'
version_cmp   = wsp* &lt;'&lt;=' | '&lt;' | '!=' | '==' | '&gt;=' | '&gt;' | '~=' | '==='&gt;
version       = wsp* &lt;( letterOrDigit | '-' | '_' | '.' | '*' | '+' | '!' )+&gt;
version_one   = version_cmp:op version:v wsp* -&gt; (op, v)
version_many  = version_one:v1 (wsp* ',' version_one)*:v2 -&gt; [v1] + v2
versionspec   = ('(' version_many:v ')' -&gt;v) | version_many
urlspec       = '@' wsp* &lt;URI_reference&gt;
marker_op     = version_cmp | (wsp* 'in') | (wsp* 'not' wsp+ 'in')
python_str_c  = (wsp | letter | digit | '(' | ')' | '.' | '{' | '}' |
                 '-' | '_' | '*' | '#' | ':' | ';' | ',' | '/' | '?' |
                 '[' | ']' | '!' | '~' | '`' | '@' | '$' | '%' | '^' |
                 '&amp;' | '=' | '+' | '|' | '&lt;' | '&gt;' )
dquote        = '&quot;'
squote        = '\\''
python_str    = (squote &lt;(python_str_c | dquote)*&gt;:s squote |
                 dquote &lt;(python_str_c | squote)*&gt;:s dquote) -&gt; s
env_var       = ('python_version' | 'python_full_version' |
                 'os_name' | 'sys_platform' | 'platform_release' |
                 'platform_system' | 'platform_version' |
                 'platform_machine' | 'platform_python_implementation' |
                 'implementation_name' | 'implementation_version' |
                 'extra' # ONLY when defined by a containing layer
                 ):varname -&gt; lookup(varname)
marker_var    = wsp* (env_var | python_str)
marker_expr   = marker_var:l marker_op:o marker_var:r -&gt; (o, l, r)
              | wsp* '(' marker:m wsp* ')' -&gt; m
marker_and    = marker_expr:l wsp* 'and' marker_expr:r -&gt; ('and', l, r)
              | marker_expr:m -&gt; m
marker_or     = marker_and:l wsp* 'or' marker_and:r -&gt; ('or', l, r)
                  | marker_and:m -&gt; m
marker        = marker_or
quoted_marker = ';' wsp* marker
identifier_end = letterOrDigit | (('-' | '_' | '.' )* letterOrDigit)
identifier    = &lt; letterOrDigit identifier_end* &gt;
name          = identifier
extras_list   = identifier:i (wsp* ',' wsp* identifier)*:ids -&gt; [i] + ids
extras        = '[' wsp* extras_list?:e wsp* ']' -&gt; e
name_req      = (name:n wsp* extras?:e wsp* versionspec?:v wsp* quoted_marker?:m
                 -&gt; (n, e or [], v or [], m))
url_req       = (name:n wsp* extras?:e wsp* urlspec:v (wsp+ | end) quoted_marker?:m
                 -&gt; (n, e or [], v, m))
specification = wsp* ( url_req | name_req ):s wsp* -&gt; s
# The result is a tuple - name, list-of-extras,
# list-of-version-constraints-or-a-url, marker-ast or None
URI_reference = &lt;URI | relative_ref&gt;
URI           = scheme ':' hier_part ('?' query )? ( '#' fragment)?
hier_part     = ('//' authority path_abempty) | path_absolute | path_rootless | path_empty
absolute_URI  = scheme ':' hier_part ( '?' query )?
relative_ref  = relative_part ( '?' query )? ( '#' fragment )?
relative_part = '//' authority path_abempty | path_absolute | path_noscheme | path_empty
scheme        = letter ( letter | digit | '+' | '-' | '.')*
authority     = ( userinfo '@' )? host ( ':' port )?
userinfo      = ( unreserved | pct_encoded | sub_delims | ':')*
host          = IP_literal | IPv4address | reg_name
port          = digit*
IP_literal    = '[' ( IPv6address | IPvFuture) ']'
IPvFuture     = 'v' hexdig+ '.' ( unreserved | sub_delims | ':')+
IPv6address   = (
                  ( h16 ':'){6} ls32
                  | '::' ( h16 ':'){5} ls32
                  | ( h16 )?  '::' ( h16 ':'){4} ls32
                  | ( ( h16 ':')? h16 )? '::' ( h16 ':'){3} ls32
                  | ( ( h16 ':'){0,2} h16 )? '::' ( h16 ':'){2} ls32
                  | ( ( h16 ':'){0,3} h16 )? '::' h16 ':' ls32
                  | ( ( h16 ':'){0,4} h16 )? '::' ls32
                  | ( ( h16 ':'){0,5} h16 )? '::' h16
                  | ( ( h16 ':'){0,6} h16 )? '::' )
h16           = hexdig{1,4}
ls32          = ( h16 ':' h16) | IPv4address
IPv4address   = dec_octet '.' dec_octet '.' dec_octet '.' dec_octet
nz            = ~'0' digit
dec_octet     = (
                  digit # 0-9
                  | nz digit # 10-99
                  | '1' digit{2} # 100-199
                  | '2' ('0' | '1' | '2' | '3' | '4') digit # 200-249
                  | '25' ('0' | '1' | '2' | '3' | '4' | '5') )# %250-255
reg_name = ( unreserved | pct_encoded | sub_delims)*
path = (
        path_abempty # begins with '/' or is empty
        | path_absolute # begins with '/' but not '//'
        | path_noscheme # begins with a non-colon segment
        | path_rootless # begins with a segment
        | path_empty ) # zero characters
path_abempty  = ( '/' segment)*
path_absolute = '/' ( segment_nz ( '/' segment)* )?
path_noscheme = segment_nz_nc ( '/' segment)*
path_rootless = segment_nz ( '/' segment)*
path_empty    = pchar{0}
segment       = pchar*
segment_nz    = pchar+
segment_nz_nc = ( unreserved | pct_encoded | sub_delims | '@')+
                # non-zero-length segment without any colon ':'
pchar         = unreserved | pct_encoded | sub_delims | ':' | '@'
query         = ( pchar | '/' | '?')*
fragment      = ( pchar | '/' | '?')*
pct_encoded   = '%' hexdig
unreserved    = letter | digit | '-' | '.' | '_' | '~'
reserved      = gen_delims | sub_delims
gen_delims    = ':' | '/' | '?' | '#' | '(' | ')?' | '@'
sub_delims    = '!' | '$' | '&amp;' | '\\'' | '(' | ')' | '*' | '+' | ',' | ';' | '='
hexdig        = digit | 'a' | 'A' | 'b' | 'B' | 'c' | 'C' | 'd' | 'D' | 'e' | 'E' | 'f' | 'F'
&quot;&quot;&quot;
&gt;&gt;&gt; compiled = makeGrammar(grammar, {})
&gt;&gt;&gt; compiled(&quot;httpx==*&quot;).specification()
('httpx', [], [('==', '*')], None)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Veritaris">@Veritaris</a> on 2024-10-18 19:47</div>
            <div class="timeline-body"><p>I've also looked into <strong>packaging</strong> tool repo and didn't find if they write anything about PEP508 in their <a href="https://packaging.pypa.io/en/stable/index.html">docs</a>:</p>
<blockquote>
<p>This library provides utilities that implement the interoperability specifications which have clearly one correct behaviour (eg: <a href="https://peps.python.org/pep-0440/">PEP 440</a>) or benefit greatly from having a single shared implementation (eg: <a href="https://peps.python.org/pep-0425/">PEP 425</a>).</p>
</blockquote>
<p>So, I even wouldn't complain about this problem in <strong>uv</strong> but this project <em>does</em> mention PEP508 rules</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-10-18 19:55</div>
            <div class="timeline-body"><blockquote>
<p>I understand that I can just remove version constraint, but uv add httpx adds line as in my example</p>
</blockquote>
<p>That should not happen and is a bug in uv. Can you provide a reproducer? I tried <code>uv init foo &amp;&amp; cd foo &amp;&amp; uv add httpx</code> and got:</p>
<pre><code>[project]
name = &quot;foo&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.11&quot;
dependencies = [
    &quot;httpx&gt;=0.27.2&quot;,
]
</code></pre>
<hr />
<p>The syntax defined by the PEP 508 grammar is more lenient than the semantically valid values. https://peps.python.org/pep-0440/#version-matching says:</p>
<blockquote>
<p>The specified version identifier must be in the standard format described in <a href="https://peps.python.org/pep-0440/#version-scheme">Version scheme</a>, but a trailing .* is permitted on public version identifiers as described below.</p>
</blockquote>
<p>That is, there needs to be a dot before the star, which in turn needs a number before it to be valid,</p>
<p>I don't think we need to extend the spec here, allowing all versions is covered by a plain <code>httpx</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">upstream</span> removed by @konstin on 2024-10-18 19:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">compatibility</span> removed by @konstin on 2024-10-18 19:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> removed by @konstin on 2024-10-18 19:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @konstin on 2024-10-18 19:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Veritaris">@Veritaris</a> on 2024-10-18 20:45</div>
            <div class="timeline-body"><p>Hi konstin!
Ohhh, sorry, I see a code block is lost in my original post â€“ there is no problem with <code>uv add X</code>, just a little bit of work, required to define that I want to use every possible version  (to remove &gt;= and version itself and leave bare requirement name). I'll edit orig post now</p>
<p>Regarding to 440 - well, I don't want to say that there are no other specification ðŸ˜…
But the only one that I found in docs, related to packages version specification, is 508</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> removed by @konstin on 2024-10-18 20:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @konstin on 2024-10-18 20:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @konstin on 2024-10-18 20:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> removed by @konstin on 2024-10-18 21:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-21 00:18</div>
            <div class="timeline-body"><blockquote>
<p>Yes, and it is, let's compile grammar from PEP508 and see parse result:</p>
</blockquote>
<p>Right, I'm not claiming that the grammar forbids it. I'm claiming that it's not a valid PEP 508 specifier despite the grammar allowing it. As Konsti said, the grammar is more lenient than the semantically valid values, like my <code>==!+!+!+</code> example above. (I've also never seen this used or supported in any Python project.) It would be better to raise this elsewhere if you have a problem with the spec itself!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-10-21 00:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Veritaris">@Veritaris</a> on 2024-10-21 08:55</div>
            <div class="timeline-body"><p>Well, I agree that PEP 508 is too wide and allows something that other devs are not using</p>
<p>In such case can we please stop mentioning it in wiki (https://docs.astral.sh/uv/concepts/dependencies/#pep-508) and use PEP 440 instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-10-21 09:26</div>
            <div class="timeline-body"><p>PEP 508 refers to PEP 440 for version specifiers, since dependency specifiers include a version specifier as substring (and PEP 508 doesn't specify any version or version specifier semantics):</p>
<blockquote>
<p>Versions may be specified according to the <a href="https://peps.python.org/pep-0440/">PEP 440</a> rules. (Note: URI is defined in <a href="https://datatracker.ietf.org/doc/html/rfc3986.html">std-66</a>):</p>
</blockquote>
<p>The canonical source has move to https://packaging.python.org/en/latest/specifications/dependency-specifiers/ though, and PEP 440 to https://packaging.python.org/en/latest/specifications/version-specifiers/, so we should refer to those specs instead: #8411</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:27:47 UTC
    </footer>
</body>
</html>
