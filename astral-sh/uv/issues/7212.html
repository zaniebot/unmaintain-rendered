<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv sync: empty directories are assumed to be linked to non-existent interpreters - astral-sh/uv #7212</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv sync: empty directories are assumed to be linked to non-existent interpreters</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/7212">#7212</a>
        opened by <a href="https://github.com/hynek">@hynek</a>
        on 2024-09-09 07:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/hynek">@hynek</a> on 2024-09-09 07:50</div>
            <div class="timeline-body"><p>I've been experimenting a bit with <code>uv python</code> and Docker and it turns out it's systematically kinda awkward if you want non-root user and multi-stage.</p>
<p>But one behavior seems a bug to me: in an attempt to install the python into the service user (called <code>app</code>), I'm trying to create a directory <code>/app</code> as root, chown it to app and then switch to <code>USER app</code> before running sync.</p>
<p>However, when I now try to run <code>uv sync</code> with <code>UV_PROJECT_ENVIRONMENT=/app</code>, it reports:</p>
<pre><code> Ignoring existing virtual environment linked to non-existent Python interpreter: /app/bin/python3
2.391 Using Python 3.12.5
2.433 error: failed to remove directory `/app`
2.433   Caused by: Permission denied (os error 13)
</code></pre>
<p>Basically it wrongly detects that an completely empty directory is linked to <code>/app/bin/python3</code> and tries to recreate it which fails, because it's not root.</p>
<p>I've added an ls to be sure:</p>
<pre><code>#15 0.087 + ls -al /app
#15 0.107 total 0
#15 0.107 drwxr-xr-x 1 app  app  0 Sep  9 09:13 .
#15 0.107 drwxr-xr-x 1 root root 8 Sep  9 09:16 ..
</code></pre>
<p>I've solved it with:</p>
<pre><code class="language-dockerfile">ENV UV_PYTHON=3.12 \
    UV_PYTHON_DOWNLOADS=true \
    UV_PYTHON_INSTALL_DIR=/python

RUN &lt;&lt;EOT
uv venv --python-preference=only-managed /app
chown -R app:app /app
EOT

USER app
RUN &lt;&lt;EOT
cd /_lock
uv sync \
    --frozen \
    --no-dev \
    --no-install-project \
    --python-preference=only-managed
EOT
</code></pre>
<p>But that's a bit awkward. If I could use an empty directory, I wouldn't have to chown. Another option would be that uv doesn't delete the whole directory, but just the contents.</p>
<hr />
<pre><code>‚ùØ uv version
uv 0.4.7 (a178051e8 2024-09-07)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-10 17:57</div>
            <div class="timeline-body"><blockquote>
<p>Ignoring existing virtual environment linked to non-existent Python interpreter: /app/bin/python3</p>
</blockquote>
<p>Is just a bad error message assuming that the given directory either</p>
<ol>
<li>Exists and is actually a virtual environment</li>
<li>Doesn't exist</li>
</ol>
<p>We don't have a case for</p>
<ol start="3">
<li>It exists, but isn't a virtual environment</li>
</ol>
<p>So our special case error message about the interpreter not being properly linked is being shown when really it's just that we didn't find an interpreter in the expected location for a virtual environment and therefore the directory isn't a virtual environment.</p>
<p>We should fix that, but why are you trying to place the virtual environment in an existing directory? So you can change the ownership of it? Why not let us create the directory?</p>
<p>https://github.com/astral-sh/uv/blob/a8bd0211e051223be17d62c812f3de474d1e899b/crates/uv/src/commands/project/mod.rs#L385-L390</p>
<p>https://github.com/astral-sh/uv/blob/64e03ad56cbdf8fb03d24bb79e0f879ae7c1cabc/crates/uv-python/src/environment.rs#L136-L137</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">error messages</span> added by @zanieb on 2024-09-10 17:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-09-10 17:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hynek">@hynek</a> on 2024-09-10 18:23</div>
            <div class="timeline-body"><p>I was running in a few circles until I found <code>UV_PYTHON_INSTALL_DIR</code> and the bug report significantly changed while I was experimenting. :)</p>
<p>In the end I found it worthwhile to report this behavior either way.</p>
<p>I was a bit on the track trying to build as a user, so I left it but the original reason I got on said track was that the python interpreter landed in <code>/root/.local/</code> if I ran <code>uv sync</code> as root; unreachable for the app user without further chmodding.</p>
<p>I guess with <code>UV_PYTHON_INSTALL_DIR=/pythons</code> it makes more sense to just build as root and chown on COPY.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-19 11:52</div>
            <div class="timeline-body"><p>Closed by https://github.com/astral-sh/uv/pull/7527 and #7544</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-09-19 11:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../Fred-Hutch-Innovation-Lab/quarto-vscode-server/issues/1.html">Fred-Hutch-Innovation-Lab/quarto-vscode-server#1</a> on 2025-09-04 19:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:30:44 UTC
    </footer>
</body>
</html>
