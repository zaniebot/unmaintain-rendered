<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>universal resolution occasionally doesn't work with `no-build-package` when the package is a transient dependency of a dependency included in both `dependency-groups` and `build-system.requires` - astral-sh/uv #10977</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>universal resolution occasionally doesn't work with <code>no-build-package</code> when the package is a transient dependency of a dependency included in both <code>dependency-groups</code> and <code>build-system.requires</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/10977">#10977</a>
        opened by <a href="https://github.com/DetachHead">@DetachHead</a>
        on 2025-01-27 04:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/DetachHead">@DetachHead</a> on 2025-01-27 04:14</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>this issue seems to be similar to #9396 in that it seems to happen randomly and i can't reliably reproduce it, despite spending hours trying to come up with a minimal repro.</p>
<p>from my understanding of <a href="https://docs.astral.sh/uv/concepts/resolution/#universal-resolution">universal resolution</a>, if i have a dependency on a package that does not have a single version that can be used for the entire supported <code>requires-python</code> range, multiple versions can be resolved to account for that. however if i try to use this functionality with <code>no-build-package</code>, it seems to sometimes fail to resolve the package:</p>
<pre><code class="language-toml">[project]
name = &quot;asdfads&quot;
description = &quot;asdf&quot;
authors = [ 
    {name = &quot;detachhead&quot;, email = &quot;detachhead@users.noreply.github.com&quot;},
]
dependencies = []
requires-python = &quot;&gt;=3.8&quot;   
readme = &quot;README.md&quot;
license = {text = &quot;MIT&quot;}
version = &quot;1.0.0&quot;
 
[dependency-groups] 
docstubs = [
    &quot;docify&gt;=1.0.0&quot;
]

[build-system]
build-backend = &quot;pdm.backend&quot;
requires = [
    &quot;pdm-backend&gt;=2.3.0&quot;,
    &quot;docify&gt;=1.0.0&quot;,
]

[tool.uv]
default-groups = [&quot;docstubs&quot;]
# transient dependency of docify. needed because there's no single version with wheels for 3.8-3.13 and it fails to build when there's no wheels
no-build-package = [&quot;libcst&quot;]
</code></pre>
<p>here, i expect it to select <code>libcst==1.1.0</code> for python 3.8 and <code>libcst==1.6.0</code> for python &gt;=3.9 because while 1.1.0 supports python 3.8-3.13, there's no wheels for 3.13 and 1.6.0 only supports python &gt;=3.9. it <em>sometimes</em> works as i expect, since i can see this in the generated lockfile:</p>
<pre><code class="language-toml">[[package]]
name = &quot;docify&quot;
version = &quot;1.1.0&quot;
source = { registry = &quot;https://pypi.org/simple&quot; }
dependencies = [
    { name = &quot;libcst&quot;, version = &quot;1.1.0&quot;, source = { registry = &quot;https://pypi.org/simple&quot; }, marker = &quot;python_full_version &lt; '3.9'&quot; },
    { name = &quot;libcst&quot;, version = &quot;1.6.0&quot;, source = { registry = &quot;https://pypi.org/simple&quot; }, marker = &quot;python_full_version &gt;= '3.9'&quot; },
    { name = &quot;tqdm&quot; },
]
sdist = { url = &quot;https://files.pythonhosted.org/packages/5c/43/b6b3ed504910ce076e6b7b6659aba4d26e51da3d3116393232278df22284/docify-1.1.0.tar.gz&quot;, hash = &quot;sha256:d9475055a330b4edc31be5854d78704a9c231dcf29b4c6e79421e4ce2adb90aa&quot;, size = 8610 }
wheels = [
    { url = &quot;https://files.pythonhosted.org/packages/d1/b4/a5ea211025bf8544a1366e04c57efca6c9d1ba45028e53269ce1182bb49d/docify-1.1.0-py3-none-any.whl&quot;, hash = &quot;sha256:9b45a82f0da74e97f80d5ace255b417ec289cb2d22d321bfe3124f38a42df68b&quot;, size = 8652 },
]
</code></pre>
<p>but sometimes it fails to do this</p>
<h3>steps to reproduce</h3>
<ol>
<li><code>uv sync --upgrade</code></li>
</ol>
<p>output:</p>
<pre><code>Using CPython 3.13.0 interpreter at: C:\Program Files\Python313\python.exe
Removed virtual environment at: .venv
Creating virtual environment at: .venv
  Ã— No solution found when resolving dependencies for split (python_full_version &gt;= '3.8.1' and python_full_version &lt; '3.9'):
      And because libcst==1.4.0 has no usable wheels, we can conclude that libcst&gt;=1.4.0 cannot be used. (1)

      Because only the following versions of libcst are available:
          libcst&lt;=1.1.0
          libcst==1.2.0
          libcst==1.3.0
          libcst==1.3.1
          libcst==1.4.0
          libcst==1.5.0
          libcst==1.5.1
      and libcst&gt;=1.1.0,&lt;=1.3.1 has no usable wheels, we can conclude that libcst&gt;=1.1.0,&lt;=1.3.1 cannot be used.
      And because we know from (1) that libcst&gt;=1.4.0 cannot be used, we can conclude that libcst&gt;=1.1.0 cannot be used.
      And because all versions of docify depend on libcst&gt;=1.1.0, we can conclude that all versions of docify cannot be used.
      And because basedpyright:docstubs depends on docify and your project requires basedpyright:docstubs, we can conclude that your project's requirements are unsatisfiable.

      hint: The `requires-python` value (&gt;=3.8) includes Python versions that are not supported by your dependencies (e.g., libcst&gt;=1.5.0 only supports &gt;=3.9). Consider using a more restrictive

      hint: Wheels are required for `libcst` because building from source is disabled for `libcst` (i.e., with `--no-build-package libcst`)
</code></pre>
<p>i realize this probably isn't really a helpful without a consistent repro, but this is the second issue i've run into where uv seems to change its behavior randomly when i haven't changed anything in my project. it's quite frustrating so i would like to try and get to the the bottom of what's causing these issues, so any advice on additional info i can provide / debugging steps would be appreciated. i've tried deleting my <code>.venv</code>, deleting <code>uv.lock</code> and running uv with <code>--no-cache</code> but it doesn't seem to have an impact. my current theory is that it might have something to do with the fact that i upgraded uv from 0.5.20 to 0.5.24, but i can't reliably reproduce it by repeating those steps either :(</p>
<h3>Platform</h3>
<p>windows 10</p>
<h3>Version</h3>
<p>0.5.24</p>
<h3>Python version</h3>
<p>3.13</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @DetachHead on 2025-01-27 04:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "universal resolution occasionally doesn't work with `no-build-package` when the package is included in both dev dependencies and `build-system.requires`" to "universal resolution occasionally doesn't work with `no-build-package` when the package is included in both `dependency-groups` and `build-system.requires`" by @DetachHead on 2025-01-27 04:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "universal resolution occasionally doesn't work with `no-build-package` when the package is included in both `dependency-groups` and `build-system.requires`" to "universal resolution occasionally doesn't work with `no-build-package` when the package is a transient dependency of a dependency included in both `dependency-groups` and `build-system.requires`" by @DetachHead on 2025-01-27 04:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-27 14:02</div>
            <div class="timeline-body"><p>I can look.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2025-01-27 14:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-27 14:18</div>
            <div class="timeline-body"><p>As you guessed it's hard to do much here, I can't reproduce :/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DetachHead">@DetachHead</a> on 2025-01-27 14:23</div>
            <div class="timeline-body"><p>i will try playing around with this some more tomorrow. i'll close this for now and will re-open it if i can figure out a way to reliably reproduce it. either way thanks for looking into it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @DetachHead on 2025-01-27 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-27 14:26</div>
            <div class="timeline-body"><p>Thanks. If you can figure out a reliable repro I'd love to fix it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-27 14:26</div>
            <div class="timeline-body"><p>My guess (?) is that it has something to do with <code>--upgrade</code> interacting with the existing lockfile, but it's hard to say.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-01-27 14:27</div>
            <div class="timeline-body"><p>Apologies for the more narrow comment here, but:</p>
<blockquote>
<p>here, i expect it to select libcst==1.1.0 for python 3.8 and libcst==1.6.0 for python &gt;=3.9 because while 1.1.0 supports python 3.8-3.13, there's no wheels for 3.13 and 1.6.0 only supports python &gt;=3.9. it sometimes works as i expect, since i can see this in the generated lockfile:</p>
</blockquote>
<p>Have you tried doing something like this?</p>
<pre><code>&quot;libcst==1.1.0 ; python_version == '3.8'&quot;,
&quot;libcst&gt;1.1.0 ; python_version &gt;= '3.9'&quot;,
</code></pre>
<p>Sorry if I'm missing something here. And obviously the non-determinism you're seeing here isn't really addressed by this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DetachHead">@DetachHead</a> on 2025-01-27 14:33</div>
            <div class="timeline-body"><p>yeah that's what i was doing originally but i learnt about <code>no-build-package</code> the other day and figured it's a cleaner way to do what i want, but i may just switch back to doing it that way if i can't figure this out</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DetachHead">@DetachHead</a> on 2025-01-28 10:38</div>
            <div class="timeline-body"><p>i think i got it</p>
<ol>
<li><code>git clone https://github.com/DetachHead/uv-issue-repro</code></li>
<li><code>cd uv-issue-repro</code></li>
<li><code>./pw uv sync</code> (using pyprojectx to pin the uv version, currently 0.5.20)</li>
<li><code>./pw --lock</code> (updates the pinned uv version to 0.5.24)</li>
<li><code>./pw uv python pin 3.13</code> (previously 3.12.7)</li>
<li><code>./pw uv sync --upgrade</code></li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @DetachHead on 2025-01-28 10:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-28 14:03</div>
            <div class="timeline-body"><p>Great, thank you! I'll try again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-29 01:33</div>
            <div class="timeline-body"><p>I <em>think</em> the issue is that <code>libcst</code> is both a build dependency and a run-time dependency, and we're incorrectly sharing some resolution data between the two...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-01-29 03:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:30:54 UTC
    </footer>
</body>
</html>
