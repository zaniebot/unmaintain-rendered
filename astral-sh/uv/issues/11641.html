<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrate with pre-commit (or replace it) - astral-sh/uv #11641</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Integrate with pre-commit (or replace it)</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/11641">#11641</a>
        opened by <a href="https://github.com/cliebBS">@cliebBS</a>
        on 2025-02-19 21:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/cliebBS">@cliebBS</a> on 2025-02-19 21:08</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>We currently use Poetry (though this applies to <code>uv</code> as well) for managing our dependencies along with <code>pre-commit</code> for hooking into Git to perform various code lints.  This generally works fine, but for <code>mypy</code> it becomes a huge pain since we need to have our dependencies installed as part of the virtualenv that mypy is installed into.  This results in us needing to replicate our frozen dependencies into the <code>additional_dependencies</code> section for <code>mypy</code> and to keep it in sync with what we have locked by Poetry.</p>
<p>This was painful enough that we created a script that scrapes the <code>poetry.lock</code> file, sees what packages are actually used in our code (to filter out transitive dependencies), tries to resolve type stub packages when the package itself doesn't provide type information, then checks the <code>.pre-commit-config.yaml</code> file to see if it matches what we want.  We run this as part of our CI to prevent Poetry and mypy from diverging in what dependencies we're using, and also have a mode that allows us to run the script and auto-update the <code>.pre-commit-config.yaml</code> file on a dev machine.</p>
<p>It would be amazing if there was a way that <code>uv</code> could provide the packages for tools like <code>mypy</code> run by <code>pre-commit</code> so that we could delete that script.  While <code>additional_dependencies</code> is actually just an argument list to <code>pip install</code>, <code>pre-commit</code> specifically needs to have the dependencies listed directly within its config file (instead of pulled in with <code>-r requirements.txt</code>) so that it knows when to create a new virtualenv with the updated contents since it doesn't understand <code>-r</code> or <code>-c</code> pull in external resources that it needs to cache in order to detect changes.  Additionally, the <code>pre-commit</code> devs refuse to add any kind of improvement in this area, wanting to keep configuration isolated to just their config file (not an unreasonable stance).</p>
<p>In order to fix this, we would either need some kind of <code>uv</code> pre-commit task that wraps other pre-commit plugins and that does environment setup itself, or we would need a way to run <code>uv</code> in &quot;pre-commit emulation&quot; mode where it can operate on <code>.pre-commit-config.yaml</code> files, but where an additional option like <code>install-uv-deps: true</code> or <code>install-requirements: [file_path]</code> is available on hooks that trigger a <code>uv sync</code> or <code>uv pip install -r ...</code> during environment setup.</p>
<p>As a bonus, a &quot;pre-commit emulation&quot; mode would allow all of the virtualenvs to be created using <code>uv</code>, greatly improving the speed at which environment setup occurs :D</p>
<h3>Example</h3>
<p><code>uv</code> adds a <code>pre-commit</code> emulation mode</p>
<ol>
<li>In a repo working copy, run <code>uv pre-commit init</code></li>
<li><code>uv</code> installs relevant scripts into <code>.git/hooks</code> that invoke <code>uv pre-commit run [hook_name] [hook_args...]</code></li>
<li>User runs <code>git commit</code></li>
<li>Git runs the <code>pre-commit</code> hook, which invokes <code>uv pre-commit run pre-commit ...</code></li>
<li><code>uv</code> parses <code>.pre-commit-config.yaml</code></li>
</ol>
<pre><code class="language-yaml">default_stages: [pre-commit]
default_install_hook_types:
  - pre-commit
default_language_version:
  python: python3.12
repos:
- repo: https://github.com/pre-commit/mirrors-mypy
  rev: v1.15.0
  hooks:
    - id: mypy
      use_uv_sync: true
</code></pre>
<ol start="6">
<li><code>uv</code> downloads Python 3.12 using <code>uv python install 3.12</code> if version is not already present</li>
<li>Create new <code>uvx</code> environment named after the hook name, version, and hash of <code>uv.lock</code> file</li>
<li>Checkout <code>https://github.com/pre-commit/mirrors-mypy</code> at tag <code>v1.15.0</code></li>
<li>Run <code>uv pip install setup.py</code>, targeting install at the tool venv</li>
<li>Run <code>uv sync</code>, targeting install at the tool venv</li>
<li><code>uv</code> invokes mypy using command in <code>.pre-commit-hooks.yaml</code> file from <code>mirrors-mypy</code> repo</li>
<li>Hook completes successfully, allowing Git to commit the changes</li>
<li>User makes random changes, but does not change mypy or <code>uv.lock</code></li>
<li>User runs <code>git commit</code></li>
<li><code>uv</code> detects that venv already exists for mypy with correct dependencies installed, invokes mypy</li>
<li>User makes dependency changes, generating changes to <code>uv.lock</code></li>
<li>User runs <code>git commit</code></li>
<li><code>uv</code> generates new tool venv name due to changed hash of <code>uv.lock</code>, then builds it like specified above</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @cliebBS on 2025-02-19 21:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chrisrodrigue">@chrisrodrigue</a> on 2025-02-19 21:44</div>
            <div class="timeline-body"><p>This could also be an opportunity to improve the <a href="https://github.com/pre-commit/pre-commit-hooks">out-of-the-box hooks</a> for pre-commit. Using all of them can be quite slow and lead to developers minimizing the number that they use... seems like a great job for Rust. Zero(-ish) cost hooks for instant commits.</p>
<p>We might even squash the <code>.pre-commit-config.yaml</code> into the <code>pyproject.toml</code> under <code>[tool.uv.hooks]</code> while we're at it.</p>
<p>Also, IMO, pre-commit is somewhat of a misnomer because <a href="https://pre-commit.com/#supported-git-hooks">one can actually use it for hooks other than <code>pre-commit</code></a>, such as <code>commit-msg</code> or <code>pre-push</code>, so maybe there could be a better name for this subcommand.</p>
<p>Maybe <a href="https://pre-commit.com/#command-line-interface"><code>uv hooks</code></a>?</p>
<pre><code class="language-console">uv hooks auto-update [options]
uv hooks clean [options]
uv hooks gc [options]
uv hooks init-templatedir DIRECTORY [options]
uv hooks install [options]
uv hooks install-hooks [options]
uv hooks migrate-config [options]
uv hooks run [hook-id] [options]
uv hooks sample-config [options]
uv hooks try-repo REPO [options]
uv hooks uninstall [option]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wish</span> added by @zanieb on 2025-02-19 21:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cliebBS">@cliebBS</a> on 2025-02-20 14:52</div>
            <div class="timeline-body"><p>I like the idea of moving the configuration into <code>pyproject.toml</code>, though we'd need to think about how to handle the duality of <code>.pre-commit-config.yaml</code> (configure hooks to run against this repository) and <code>.pre-commit-hooks.yaml</code> (hooks provided by this repository).</p>
<p>Also, 100% agree with this misnomer.  It makes documentation hard to search for as well, especially when you are trying to build hooks for phases other than pre-commit.  Perhaps <code>uv vcs-hooks</code> might be more informative since <code>hooks</code> on its own feels a little vague as to what you are hooking, and calling it <code>git-hooks</code> feels like it would be limiting from a design space if you wanted to support other VCS's in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rafalkrupinski">@rafalkrupinski</a> on 2025-03-27 14:26</div>
            <div class="timeline-body"><p>pre-commit does two main things:</p>
<ol>
<li>manages tools</li>
<li>runs them with git hooks</li>
</ol>
<p>uv already has tool manager, but AFAIK only for python tools, and there are other tools that handle git hooks, like lefthook.</p>
<p>My solution that I'm working on is lefthook + mise. Only problem I had so far is configuring lefthook to either include changes done by tools or fail commit when a change appears (work in progress)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cliebBS">@cliebBS</a> on 2025-09-11 15:31</div>
            <div class="timeline-body"><p>Looks like someone beat us to it.  There's a relatively new project called <a href="https://github.com/j178/prek">prek</a> that is a drop-in replacement for <code>pre-commit</code>, but that is written in Rust and that uses <code>uv</code> under the covers to install tools instead of <code>pip</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @cliebBS on 2025-09-11 15:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rafalkrupinski">@rafalkrupinski</a> on 2025-09-11 15:43</div>
            <div class="timeline-body"><p>so it's also python-only?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cliebBS">@cliebBS</a> on 2025-09-11 15:46</div>
            <div class="timeline-body"><p>It appears to support <em>some</em> other languages, just not everything that <code>pre-commit</code> supports currently.  We only use Python, so the lack of support for other languages doesn't impact us, though the shared workspace does for our mono-repo projects that also use MyPy, though apparently multi-workspace support will be added in 0.2.0.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rafalkrupinski">@rafalkrupinski</a> on 2025-09-11 15:49</div>
            <div class="timeline-body"><p>hmm</p>
<blockquote>
<p>üîÑ Fully compatible with the original pre-commit configurations and hooks.</p>
</blockquote>
<p>üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Jamie-BitFlight">@Jamie-BitFlight</a> on 2025-11-27 04:33</div>
            <div class="timeline-body"><p>This pain point resonates - keeping <code>additional_dependencies</code> in sync with your lockfile is tedious.</p>
<p>For the specific case of linting scripts with PEP 723 inline dependencies (or just wanting mypy/pyright to have access to project deps), I built a workaround tool called <code>pep723-loader</code>.</p>
<p>It wraps any linter and auto-installs dependencies before execution:</p>
<pre><code class="language-yaml">- repo: local
  hooks:
    - id: mypy
      name: mypy
      entry: uv run -q --no-sync --with pep723-loader --with mypy pep723-loader mypy
      language: system
      types: [python]
      pass_filenames: true
</code></pre>
<p>How it works:</p>
<ol>
<li>Scans Python files for PEP 723 <code># /// script</code> metadata</li>
<li>Runs <code>uv export --script</code> to extract dependencies</li>
<li>Installs them via <code>uv pip install</code></li>
<li>Executes the wrapped linter</li>
</ol>
<p>This doesn't solve the full &quot;sync pre-commit deps from lockfile&quot; problem you're describing, but it does eliminate the <code>additional_dependencies</code> dance for PEP 723 scripts and lets type checkers see the deps they need.</p>
<p>PyPI: <code>pip install pep723-loader</code>
Repo: https://github.com/bitflight-devops/pre-commit-pep723-linter-wrapper</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:26 UTC
    </footer>
</body>
</html>
