<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dockerfile with a workspace project - astral-sh/uv #6867</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Dockerfile with a workspace project</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/6867">#6867</a>
        opened by <a href="https://github.com/Afoucaul">@Afoucaul</a>
        on 2024-08-30 13:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Afoucaul">@Afoucaul</a> on 2024-08-30 13:14</div>
            <div class="timeline-body"><!--
Thank you for taking the time to report an issue! We're glad to have you involved with uv.

If you're filing a bug report, please consider including the following information:

* A minimal code snippet that reproduces the bug.
* The command you invoked (e.g., `uv pip sync requirements.txt`), ideally including the `--verbose` flag.
* The current uv platform.
* The current uv version (`uv --version
-->

<p>The <a href="https://docs.astral.sh/uv/guides/integration/docker/#intermediate-layers">doc</a> proposes the following Dockerfile to build a project into a Dockerfile while caching intermediate layers (uv version 0.4.0):</p>
<pre><code class="language-Dockerfile"># Install uv
FROM python:3.12-slim
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

# Change the working directory to the `app` directory
WORKDIR /app

# Copy the lockfile and `pyproject.toml` into the image
ADD uv.lock /app/uv.lock
ADD pyproject.toml /app/pyproject.toml

# Install dependencies
RUN uv sync --frozen --no-install-project

# Copy the project into the image
ADD . /app

# Sync the project
RUN uv sync --frozen
</code></pre>
<p>However, when the project is a worskpace, <code>uv sync --frozen --no-install-project</code> won't do anything unless the workspace members are there. As a result, if a workspace contains libs in a <code>libs/</code> dir, one has to also <code>ADD</code> all <code>libs/*/pyproject.toml</code> files so <code>uv sync --frozen --no-install-project</code> actually installs 3rd party dependencies.
We could easily <code>COPY</code> the whole <code>libs/</code> dir, but then the cache would be invalidated every time sources change.</p>
<p>Is there a workaround? Or a workspace-specific strategy for building Docker images?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-01 17:45</div>
            <div class="timeline-body"><p>Have you seen <code>uv sync --frozen --no-install-workspace</code>? That should omit the library and workspace members (but install all dependencies).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2024-09-01 17:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Afoucaul">@Afoucaul</a> on 2024-09-02 08:08</div>
            <div class="timeline-body"><blockquote>
<p>Have you seen <code>uv sync --frozen --no-install-workspace</code>? That should omit the library and workspace members (but install all dependencies).</p>
</blockquote>
<p>Actually I have, and I may be failing to understand what <code>--frozen</code> does.
When I run <code>uv sync --frozen --no-install-workspace</code>, nothing gets installed:</p>
<pre><code class="language-bash">$ uv sync --frozen --no-install-workspace
Using Python 3.8.12
Creating virtualenv at: .venv
Audited in 0.00ms

$ ls -a .venv/lib/python3.8/site-packages 
_virtualenv.pth  _virtualenv.py
</code></pre>
<p>However when I replace <code>--frozen</code> with <code>--locked</code>, packages do get installed, except indeed workspace members:</p>
<pre><code class="language-bash">$ uv sync --locked --no-install-workspace
Resolved 16 packages in 2ms
Prepared 12 packages in 0.79ms
Installed 12 packages in 19ms
 + anyio==4.4.0
 + certifi==2024.8.30
 + charset-normalizer==3.3.2
 + exceptiongroup==1.2.2
 + h11==0.14.0
 + httpcore==1.0.5
 + httpx==0.27.2
 + idna==3.8
 + requests==2.32.3
 + sniffio==1.3.1
 + typing-extensions==4.12.2
 + urllib3==2.2.2

$ ls -a .venv/lib/python3.8/site-packages 
_virtualenv.pth        certifi-2024.8.30.dist-info         h11                       httpx-0.27.2.dist-info     sniffio                             urllib3-2.2.2.dist-info
_virtualenv.py         charset_normalizer                  h11-0.14.0.dist-info      idna                       sniffio-1.3.1.dist-info             
anyio                  charset_normalizer-3.3.2.dist-info  httpcore                  idna-3.8.dist-info         typing_extensions-4.12.2.dist-info  
anyio-4.4.0.dist-info  exceptiongroup                      httpcore-1.0.5.dist-info  requests                   typing_extensions.py                
certifi                exceptiongroup-1.2.2.dist-info      httpx                     requests-2.32.3.dist-info  urllib3
</code></pre>
<p>From what I understand from <code>uv sync --help</code>, <code>--frozen</code> and <code>--locked</code> enforce the same behavior, except that <code>--locked</code> causes a failure if the lock file needs to be updated, while <code>--frozen</code> will proceed anyway:</p>
<pre><code class="language-bash">      --locked                                   Assert that the `uv.lock` will remain unchanged
      --frozen                                   Sync without updating the `uv.lock` file
</code></pre>
<p>On that note, why would <code>--frozen</code> be recommended rather than <code>--locked</code> in Dockerfiles? It looks to me one would want to enforce as many static guarantees as possible at build time - but again I may be misunderstanding the purpose of these flags.</p>
<p>Am I missing something here? (I'm sorry the discussion is drifting a bit, I guess I'm confused with the <code>sync</code> command in general)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Afoucaul">@Afoucaul</a> on 2024-09-02 08:29</div>
            <div class="timeline-body"><p>I can confirm that with uv 0.4.0, and the following layout, <code>uv sync --frozen --no-install-workspace</code> does not install anything if I don't <code>ADD</code> the <code>pyproject.toml</code> file of apps and libs in the Dockerfile</p>
<details>
<summary>Structure</summary>

<pre><code class="language-bash">.
├── Dockerfile
├── README.md
├── apps
│   ├── app1
│   │   ├── README.md
│   │   ├── pyproject.toml
│   │   └── src
│   │       └── app1
│   │           └── __init__.py
│   └── app2
│       ├── README.md
│       ├── pyproject.toml
│       └── src
│           └── app2
│               └── __init__.py
├── libs
│   ├── lib1
│   │   ├── README.md
│   │   ├── pyproject.toml
│   │   └── src
│   │       └── lib1
│   │           └── __init__.py
│   └── lib2
│       ├── README.md
│       ├── pyproject.toml
│       └── src
│           └── lib2
│               └── __init__.py
├── pyproject.toml
├── src
│   └── uv_monorepo_test
│       └── __init__.py
└── uv.lock
</code></pre>
</details>

<h2>With child <code>pyproject.toml</code> files</h2>
<pre><code class="language-Dockerfile"># Install uv
FROM python:3.12-slim
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

# Change the working directory to the `app` directory
WORKDIR /app

# Copy the lockfile and `pyproject.toml` into the image
ADD uv.lock /app/uv.lock
ADD pyproject.toml /app/pyproject.toml

# Add child pyproject.toml files
ADD libs/lib1/pyproject.toml /app/libs/lib1/pyproject.toml
ADD libs/lib2/pyproject.toml /app/libs/lib2/pyproject.toml
ADD apps/app1/pyproject.toml /app/apps/app1/pyproject.toml
ADD apps/app2/pyproject.toml /app/apps/app2/pyproject.toml

# Install dependencies
# Omitting --frozen because I don't understand how it behaves
RUN uv sync --no-install-workspace
</code></pre>
<pre><code class="language-bash">$ docker build --quiet . -t demo &amp;&amp; docker run --rm demo ls -a .venv/lib/python3.12/site-packages
sha256:62dffa4e4e3d9d54af08c172042e1f3f84749fdc0fef56b6aa891407ae04eb44
.
..
_virtualenv.pth
_virtualenv.py
anyio
anyio-4.4.0.dist-info
certifi
certifi-2024.8.30.dist-info
charset_normalizer
charset_normalizer-3.3.2.dist-info
charset_normalizer.libs
h11
h11-0.14.0.dist-info
httpcore
httpcore-1.0.5.dist-info
httpx
httpx-0.27.2.dist-info
idna
idna-3.8.dist-info
requests
requests-2.32.3.dist-info
sniffio
sniffio-1.3.1.dist-info
urllib3
urllib3-2.2.2.dist-info
</code></pre>
<h2>Without child <code>pyproject.toml</code> files</h2>
<pre><code class="language-Dockerfile"># Install uv
FROM python:3.12-slim
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

# Change the working directory to the `app` directory
WORKDIR /app

# Copy the lockfile and `pyproject.toml` into the image
ADD uv.lock /app/uv.lock
ADD pyproject.toml /app/pyproject.toml

# Add child pyproject.toml files
# ADD libs/lib1/pyproject.toml /app/libs/lib1/pyproject.toml
# ADD libs/lib2/pyproject.toml /app/libs/lib2/pyproject.toml
# ADD apps/app1/pyproject.toml /app/apps/app1/pyproject.toml
# ADD apps/app2/pyproject.toml /app/apps/app2/pyproject.toml

# Install dependencies
# Omitting --frozen because I don't understand how it behaves
RUN uv sync --no-install-workspace
</code></pre>
<pre><code class="language-bash">$ docker build --quiet . -t demo &amp;&amp; docker run --rm demo ls -a .venv/lib/python3.12/site-packages
sha256:26cc1ba1a021cdc10d60c60f3015a545579a7a66f516dd81bb37ad1c60718c29
.
..
_virtualenv.pth
_virtualenv.py
</code></pre>
<p>I'd be ok with <code>ADD</code>ing all <code>pyproject.toml</code> files, but Dockerfile <code>ADD</code> doesn't support a structure-preserving glob (eg an <code>ADD */*/pyproject.toml</code> that would add all <code>pyproject.toml</code> files under <code>apps/</code> or <code>libs/</code>, and which would end up at the same location in the Docker image), and <code>ADD</code>ing each file individually is tedious and error prone...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/6935.html">astral-sh/uv#6935</a> on 2024-09-02 12:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Afoucaul">@Afoucaul</a> on 2024-09-02 13:42</div>
            <div class="timeline-body"><p>Closing in favor of https://github.com/astral-sh/uv/issues/6935</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Afoucaul on 2024-09-02 13:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../bgreenawald/bananagrams/pulls/75.html">bgreenawald/bananagrams#75</a> on 2025-08-03 18:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:21 UTC
    </footer>
</body>
</html>
