<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Environmental marker in pyproject.toml ignored for platform‐specific dependencies in uv 0.6.0 - astral-sh/uv #14313</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Environmental marker in pyproject.toml ignored for platform‐specific dependencies in uv 0.6.0</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/14313">#14313</a>
        opened by <a href="https://github.com/19igari">@19igari</a>
        on 2025-06-27 11:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/19igari">@19igari</a> on 2025-06-27 11:23</div>
            <div class="timeline-body"><h3>Summary</h3>
<p><strong>Describe the bug</strong>
When declaring a dependency with an environment marker in pyproject.toml—for example:</p>
<pre><code>[project]
name = &quot;example&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;==3.12&quot;
dependencies = [
  &quot;tensorrt-cu12==10.3.0; sys_platform == 'linux' and platform_machine == 'x86_64'&quot;
]
</code></pre>
<p>uv should evaluate the environment marker (sys_platform == 'linux' and platform_machine == 'x86_64'), skip the tensorrt-cu12 dependency on ARM64, and successfully complete uv sync without error. Instead, on an ARM64 (Jetson Orin) environment, <code>uv sync</code> still tries to build tensorrt-cu12, resulting in a build error.</p>
<p><strong>Minimal reproduction</strong>
Use the following Dockerfile and run docker build .:</p>
<pre><code>FROM ghcr.io/astral-sh/uv:0.6.0-debian-slim

COPY &lt;&lt;EOF /mre/pyproject.toml
[project]
name = &quot;example&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;==3.12&quot;
dependencies = [
  &quot;tensorrt-cu12==10.3.0; sys_platform == 'linux' and platform_machine == 'x86_64'&quot;
]
EOF

WORKDIR /mre
RUN uv sync
</code></pre>
<p><strong>Error output on ARM64 (Jetson Orin)</strong></p>
<pre><code>× Failed to build `tensorrt-cu12==10.3.0`
├─▶ The build backend returned an error
╰─▶ Call to `setuptools.build_meta:__legacy__.build_wheel` failed (exit status: 1)

  [stderr]
  RuntimeError: TensorRT currently only builds wheels for x86_64 processors
  hint: This usually indicates a problem with the package or the build environment.
help: `tensorrt-cu12` (v10.3.0) was included because `example` (v0.1.0) depends on `tensorrt-cu12==10.3.0`
</code></pre>
<p><strong>Additional context</strong></p>
<ul>
<li>This regression appears between uv 0.5.31 (works) and uv 0.6.0 (fails).</li>
</ul>
<h3>Platform</h3>
<p>Ubuntu 22.04.4 ARM64 (Jetson Orin)</p>
<h3>Version</h3>
<p>uv 0.6.0</p>
<h3>Python version</h3>
<p>Python 3.12.0</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @19igari on 2025-06-27 11:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-06-27 14:14</div>
            <div class="timeline-body"><p>I believe this is correct, because <code>uv sync</code> needs to determine the dependencies of <code>tensorrt-cu12==10.3.0</code>, and that package only publishes a <a href="https://pypi.org/project/tensorrt-cu12/10.3.0/#files">source distribution</a>. So, to get the dependencies, we need to run a build step, regardless of what platform you're on.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-06-27 14:15</div>
            <div class="timeline-body"><p>One workaround is to provide the metadata upfront via <a href="https://docs.astral.sh/uv/concepts/resolution/#dependency-metadata"><code>dependency-metadata</code></a>:</p>
<pre><code class="language-toml">[[tool.uv.dependency-metadata]]
name = &quot;tensorrt-cu12&quot;
version = &quot;10.3.0&quot;
requires-dist = [&quot;tensorrt_cu12_libs==10.12.0.36&quot;, &quot;tensorrt_cu12_bindings==10.12.0.36&quot;, &quot;numpy; extra == \&quot;numpy\&quot;&quot;]
provides-extra = [&quot;numpy&quot;]
requires-python = &quot;&gt;=3.6&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @charliermarsh on 2025-06-27 14:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @charliermarsh on 2025-06-27 14:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/19igari">@19igari</a> on 2025-06-28 04:02</div>
            <div class="timeline-body"><p>I’m aware that the <code>tensorrt-cu12</code> package is only available as a source distribution and cannot be built for ARM64. Therefore, I’d like the resolver to simply skip any dependency resolution for <code>tensorrt-cu12</code> on ARM64 as described in <a href="https://docs.astral.sh/uv/concepts/projects/dependencies/#platform-specific-dependencies">platform-specific-dependencies</a></p>
<p>I’m trying to set up an environment where TensorRT can run on both x86 and Jetson platforms. In this setup, I need to include <code>tensorrt-cu12</code> as a dependency for x86, but on Jetson I’m using a self-hosted TensorRT package that works standalone, so there’s no need to add <code>tensorrt-cu12</code> as a dependency there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-06-28 13:18</div>
            <div class="timeline-body"><p>Totally, I understand. What you're describing isn't compatible with <code>uv.lock</code>, though. <code>uv.lock</code> resolves for all environments, so we need to know the dependencies. And that package doesn't declare them statically. So we need to get them somehow. Otherwise, how can we produce a lockfile that works on x86 and ARM? We have to be able to resolve.</p>
<p>(If they release with a newer version of <code>setuptools</code>, then we could extract them statically and it wouldn't be necessary to build the package, even if they don't ship a wheel.)</p>
<p>(If you resolve on x86 and commit the <code>uv.lock</code>, that's another valid answer, since we won't need to build the package on ARM if the lockfile already exists.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/19igari">@19igari</a> on 2025-06-30 01:48</div>
            <div class="timeline-body"><p>I fully understand. Thank you. When I run <code>uv sync</code>, it needs to generate uv.lock, and to do so—even on an arm64 platform—it still tries to build <code>tensorrt-cu12</code> in order to fetch its metadata.</p>
<p>I also now see why uv sync began failing on arm64 in version 0.6.0. When I unpacked the tensorrt-cu12 package from PyPI, I found its metadata stored inside the <code>.egg-info</code> files. In the commit https://github.com/astral-sh/uv/pull/11395 between uv 0.5.31 and 0.6.0, those <code>.egg-info</code> contents are no longer referenced, so the metadata can’t be retrieved anymore.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @19igari on 2025-06-30 02:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-06-30 02:12</div>
            <div class="timeline-body"><p>Ah right, that makes sense. We removed that behavior since it was non-standard and problematic in some cases. Source distributions built with newer versions of <code>setuptools</code> should have reliable static metadata which solves this problem going forward.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:28 UTC
    </footer>
</body>
</html>
