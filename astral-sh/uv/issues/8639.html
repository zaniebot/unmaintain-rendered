<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Variant metadata prototype ideas - astral-sh/uv #8639</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Variant metadata prototype ideas</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/issues/8639">#8639</a>
        opened by <a href="https://github.com/msarahan">@msarahan</a>
        on 2024-10-28 16:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/msarahan">@msarahan</a> on 2024-10-28 16:37</div>
            <div class="timeline-body"><p>Greetings Astral team! I'm looking to build a prototype of the variant metadata idea proposed in https://discuss.python.org/t/selecting-variant-wheels-according-to-a-semi-static-specification/53446/111. I'm doing so with <code>uv</code> to start with because the existing &quot;first match&quot; index priority strategy is necessary for this plan.</p>
<p>A rough diagram of the parts is here:</p>
<p><img src="https://github.com/user-attachments/assets/6fdc6c93-3039-4c9d-bd4b-d7bd697c4a4d" alt="variant_concept_august_2024 drawio" /></p>
<p>From this diagram, uv's part is the lower-right. The installer has 3 new &quot;jobs&quot; in this scheme:</p>
<ol>
<li>Loading a pre-computed local file that represents the desired variants</li>
<li>For each user-configured remote index, try to fetch a list of variants that the index has available. This is probably a per-package list of variants, rather than a whole-index list of variants.</li>
<li>Preserving the order of the lists, intersect them. The intersection represents the ordered set of variants that match the user's preferences. Each item in the set is a URL that matches PyPI's PEP 503 &quot;details&quot; page, listing the distribution files that are specific to a particular variant.</li>
</ol>
<p>The end result is basically that each index URL will be &quot;exploded&quot; into several index URLs - one per variant that matches both the user's configured variants and the variants present on the server.</p>
<p>It seems like this is maybe the right location to add this: https://github.com/astral-sh/uv/blob/main/crates/uv-distribution-types/src/index_url.rs#L249 - does that seem right? Maybe it needs to be deeper, if the variant list is per-package rather than global.</p>
<p>I'm concerned about additional HTTP requests being an issue, but otherwise the splitting of one index into many saves the need for changes to the resolver algorithms. I welcome suggestions and input on any of the ideas here. I can be available for a chat or video call if a higher-bandwidth discussion would be helpful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-28 16:51</div>
            <div class="timeline-body"><p>Thanks @msarahan. Iâ€™m happy to be your point-of-contact on this. Will review and reply later today / tonight.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-10-28 16:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-28 19:52</div>
            <div class="timeline-body"><p>Ok, I think I understand the overall flow here. I would have much better answers / guidance if I attempted to implement it myself, but I'll do my best.</p>
<p>Assuming that you want to make a separate variant request per package per index, I think I'd suggest confining the logic to the registry client:</p>
<p>https://github.com/astral-sh/uv/blob/7948441121b1d54655caa927b3eaadaf90717327/crates/uv-client/src/registry_client.rs#L205-L210</p>
<p>In there, we could make a request to each index as we visit them in the <code>for index in it</code> loop.</p>
<p>If we localize it to the registry client, then we just have to ensure that the registry client itself has access to the user-defined variant manifest (and we can skip these steps entirely if it's not defined). So we need to thread it through to the <code>RegistryClientBuilder</code>, like we do for <code>index_urls</code>. The use of the builder (and making this optional) will also make it easier for you to get this compiling, since you can add support for (e.g.) a single command (like <code>uv pip install</code>) at a time.</p>
<p>To do that threading, you want to get that manifest to be passed in here:</p>
<p>https://github.com/astral-sh/uv/blob/7948441121b1d54655caa927b3eaadaf90717327/crates/uv/src/commands/pip/install.rs#L299-L306</p>
<p>As an aside, can we store the desired variants in a <code>pyproject.toml</code> file? Or do you intend for it to be a separate, standalone file? For the prototype at least, it'd be easiest to store them in the <code>pyproject.toml</code> file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/msarahan">@msarahan</a> on 2024-10-28 23:43</div>
            <div class="timeline-body"><p>Thanks for the guidance! I'll clarify that I'll be thrilled if you want to work on a prototype. I didn't want to lay that on you, though. We have an org where we're trying to centralize the many wheel-enhancing efforts: https://github.com/wheel-next</p>
<p>So far it's only NVIDIA people, but we're hoping that others will join as time goes on. If I end up making the uv prototype (that is, if you don't), it'll be at that org so we can demo it, then PR it over here when we all think it's ready.</p>
<p>I'd be happy to chat more about where variants should live. There are 2 or 3 different contexts:</p>
<ol>
<li>How variants get selected and encoded at build time</li>
<li>How the variants encoded in the package get read by the hosting index</li>
<li>How the end-user client specifies which variant</li>
</ol>
<p>I'm not clear what you mean by your request that variants live in a pyproject.toml file. I think that might fall under the first context. I haven't really fleshed out that part yet. Our plan is to punt on the build-time questions until the hosting and installation prototypes are shown to work (or not).</p>
<p>If you don't mean the build context, you probably mean the client context. I see variants as a per-environment setting. I think they live more in lockfiles or inputs to lockfiles, like https://peps.python.org/pep-0751/.  We're punting on that until a little later too, but it is definitely an essential part of the overall plan.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-29 00:20</div>
            <div class="timeline-body"><p>Ah yeah sorry -- I was referring to (3). I think I was assuming that the user would be encoding the variants they want / expect, and then we'd write those to the lockfile after resolving -- so was trying to figure out how they would be provided / specified by the user. But I'm a little fuzzy on that part of the workflow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-31 16:58</div>
            <div class="timeline-body"><p>I'm happy to prototype this in uv if you have a server / example registry that implements the spec.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/msarahan">@msarahan</a> on 2024-10-31 17:35</div>
            <div class="timeline-body"><p>Early days, but we have this mockup: https://github.com/wheel-next/mockhouse/</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:23 UTC
    </footer>
</body>
</html>
