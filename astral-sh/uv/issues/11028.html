<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Can't compile Meson extensions against managed Python due to pkg-config - astral-sh/uv #11028</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Can't compile Meson extensions against managed Python due to pkg-config</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/11028">#11028</a>
        opened by <a href="https://github.com/lgarrison">@lgarrison</a>
        on 2025-01-28 17:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/lgarrison">@lgarrison</a> on 2025-01-28 17:48</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>When compiling a Python extension using Meson's <code>py_installation.extension_module()</code>, Meson looks for the Python development headers using pkg-config. Because the prefix in python-build-standalone's <code>pc</code> file is <code>/install</code>, the build fails.</p>
<p>The sysconfig paths in PBS are fine, but for better or worse Meson tries pkg-config before sysconfig. There doesn't seem to be a universal way (e.g. one that works for subprojects) to use sysconfig before pkg-config in Meson, but even if there was, it seems like it would be preferable to fix the <code>pc</code> file.</p>
<p>Is that possible? Could uv fix the <code>pc</code> file after extraction? I guess this wouldn't help non-uv PBS users, however.</p>
<p>I realize this is <a href="https://gregoryszorc.com/docs/python-build-standalone/main/quirks.html#references-to-build-time-paths">documented</a>, so apologies for raising a known issue! But it took a little sleuthing to figure out how Meson was even picking up this <code>/install</code> path, so I thought I'd at least share that here.</p>
<p>For completeness, here's the <code>.pc</code> file:</p>
<details><summary>python-3.13.pc</summary>
<p>

<pre><code>‚ùØ cat /mnt/home/lgarrison/.local/share/uv/python/cpython-3.13.1-linux-x86_64-gnu/lib/pkgconfig/python-3.13.pc
# See: man pkg-config
prefix=/install
exec_prefix=${prefix}
libdir=${exec_prefix}/lib
includedir=${prefix}/include

Name: Python
Description: Build a C extension for Python
Requires:
Version: 3.13
Libs.private: -lpthread -ldl  -lutil
Libs: -L${libdir} 
Cflags: -I${includedir}/python3.13
</code></pre>
</p>
</details> 

<p>Here's where Meson tries pkg-config before sysconfig: https://github.com/mesonbuild/meson/blob/0b9baf573bf2b1619d7822f67965a35391172625/mesonbuild/dependencies/python.py#L391</p>
<p>Here's the output of Meson's <code>python_info.py</code> script that uses sysconfig for discovery (looks fine):</p>
<details>
<summary>python_info.py output</summary>

<pre><code>‚ùØ python mesonbuild/scripts/python_info.py | jq | grep /install
    &quot;CONFIG_ARGS&quot;: &quot;'--build=x86_64-unknown-linux-gnu' '--host=x86_64-unknown-linux-gnu' '--prefix=/install' '--with-openssl=/tools/deps' '--with-system-expat' '--with-system-libmpdec' '--without-ensurepip' '--with-readline=editline' '--enable-shared' '--with-mimalloc' '--enable-optimizations' '--with-lto' '--with-build-python=/tools/host/bin/python3.13' '--with-dbmliborder=bdb' 'build_alias=x86_64-unknown-linux-gnu' 'host_alias=x86_64-unknown-linux-gnu' 'CC=clang' 'CFLAGS= -fPIC ' 'LDFLAGS= -Wl,--exclude-libs,ALL -LModules/_hacl' 'CPPFLAGS= -fPIC '&quot;,
    &quot;INSTALL&quot;: &quot;/usr/bin/install -c&quot;,
    &quot;INSTALL_DATA&quot;: &quot;/usr/bin/install -c -m 644&quot;,
    &quot;INSTALL_PROGRAM&quot;: &quot;/usr/bin/install -c&quot;,
    &quot;INSTALL_SCRIPT&quot;: &quot;/usr/bin/install -c&quot;,
    &quot;INSTALL_SHARED&quot;: &quot;/usr/bin/install -c -m 755&quot;,
    &quot;WASM_ASSETS_DIR&quot;: &quot;./install&quot;,
    &quot;WASM_STDLIB&quot;: &quot;./install/lib/python3.13/os.py&quot;,
</code></pre>
</details>

<p>And here's a typical compiler command that Meson emits, with <code>-I/install/...</code>:</p>
<details>
<summary>Compiler command</summary>

<pre><code>ccache cc -I_pycorrfunc.cpython-313-x86_64-linux-gnu.so.p -I. -I../.. -I../../include -I../../lib/theory/DD -I../../lib/common
-I../../subprojects/nanobind-2.2.0/include -I../../subprojects/robin-map-1.3.0/include -I/install/include/python3.13 -fvisibility=hidden
-fdiagnostics-color=always -DNDEBUG -D_FILE_OFFSET_BITS=64 -Wall -Winvalid-pch -Wextra -O3 -DPYCORRFUNC_USE_DOUBLEACCUM -fPIC -fopenmp -ffunction-sections
-fdata-sections -DPYCORRFUNC_USE_DOUBLE -DNB_DOMAIN=d -funroll-loops -MD -MQ _pycorrfunc.cpython-313-x86_64-linux-gnu.so.p/lib_theory_DD_countpairs.c.o
-MF _pycorrfunc.cpython-313-x86_64-linux-gnu.so.p/lib_theory_DD_countpairs.c.o.d -o
_pycorrfunc.cpython-313-x86_64-linux-gnu.so.p/lib_theory_DD_countpairs.c.o -c ../../lib/theory/DD/countpairs.c
../../lib/theory/DD/countpairs.c:7:10: fatal error: Python.h: No such file or directory
 #include &lt;Python.h&gt;
          ^~~~~~~~~~
</code></pre>
</details>

<p>There's a constellation of sort-of similar uv issues around sysconfig variables (e.g. those linked from https://github.com/astral-sh/uv/issues/8429), but I think in this case the issue is specifically with the pkg-config file. I couldn't find an existing issue about that.</p>
<h2>Steps to reproduce</h2>
<p>Here is a reproducer on a small project. I'm happy to work on making it more minimal if that would be helpful.</p>
<pre><code>‚ùØ git clone https://github.com/lgarrison/pycorrfunc.git
‚ùØ cd pycorrfunc
‚ùØ git checkout c869af8feb936960ef3673aa0974eb332c47fc8a
‚ùØ uv sync --python-preference=only-managed
</code></pre>
<h3>Platform</h3>
<p>Rocky 8 Linux</p>
<h3>Version</h3>
<p>0.5.24</p>
<h3>Python version</h3>
<p>Python 3.13</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @lgarrison on 2025-01-28 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-28 17:59</div>
            <div class="timeline-body"><p>cc @eli-schwartz since you've been active on meson-related issues; do you have context on the motivation for this behavior?</p>
<p>I'm fine with patching the pkg-config files on install, as we do for the macOS dylib (#10629). Are you interested in contributing a fix?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @zanieb by @zanieb on 2025-01-28 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">great writeup</span> added by @zanieb on 2025-01-28 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lgarrison">@lgarrison</a> on 2025-01-28 18:09</div>
            <div class="timeline-body"><p>Happy to give it a shot. Time to put those Advent of Code Rust skills to use!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eli-schwartz">@eli-schwartz</a> on 2025-01-28 18:25</div>
            <div class="timeline-body"><p>Meson needs to know the &quot;official interface flags&quot; for linking to libpython, primarily:</p>
<ul>
<li>what <code>-I/path/to/Python-dot-h</code> path to use for compiling</li>
<li>what <code>-L/path/to/libpython -lpython3.XX</code> flags to use for linking:<ul>
<li>when <code>embed: true</code> is used, for example when compiling a python loadable plugin for a C++ application that includes scripting support for perl/python/guile/lua/ruby/tcl</li>
<li>on platforms such as Android or Cygwin, where linking to libpython is required even for compiling importable modules</li>
</ul>
</li>
</ul>
<p>Doing this accurately is a bit of a hodgepodge. The base code for implementing this is at https://github.com/mesonbuild/meson/blob/master/mesonbuild/dependencies/python.py</p>
<p>Notice there are two methods: pkg-config, and sysconfig. The sysconfig method uses <code>find_libpy()</code> and <code>find_libpy_windows()</code> which you will note doesn't actually use sysconfig directly, but does various searches by manually constructing details from sysconfig <code>base</code>, <code>DEBUG_EXT</code>, <code>ABIFLAGS</code>, <code>py_version_nodot</code>, <code>py_version_short</code>, <code>implementation_lower</code>, <code>ABI3DLLLIBRARY</code>, <code>INCLUDEPY</code>, <code>include</code>, <code>platinclude</code>, <code>ABI3DLLLIBRARY</code>, <code>ABI3LDLIBRARY</code>, <code>LDLIBRARY</code>, <code>LIBDIR</code>, etc, as well as hardcoding certain known assumptions about the shape of the install layout for PyPy.</p>
<p>This will hopefully get a lot better when https://peps.python.org/pep-0739/ is approved and deployed, which guarantees that any platform can describe via JSON what pkg-config already consistently describes (but requires pkg-config to be installed, which is not necessarily the case on Windows).</p>
<blockquote>
<p>Here's the output of Meson's <code>python_info.py</code> script that uses sysconfig for discovery (looks fine):</p>
</blockquote>
<p>python_info.py is used for discovery of various things pkg-config doesn't describe, like &quot;whether you are in a venv&quot; or &quot;what are the standard paths for site-packages etc&quot;, &quot;am I PyPY or CPython&quot;, &quot;am I free-threaded&quot;, &quot;what is the limited API suffix&quot;, etc. We also save the exhaustive details of <em>every</em> sysconfig variable, just in case we need it later on (and indeed it's needed for the guesswork in <code>dependencies/python.py</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-28 18:35</div>
            <div class="timeline-body"><p>If the target from <code>pkg-config</code> does not exist should it fallback to <code>sysconfig</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eli-schwartz">@eli-schwartz</a> on 2025-01-28 18:57</div>
            <div class="timeline-body"><p>Currently it assumes the flags are trusted and passes them to the compiler -- it's the compiler that decides they aren't trusted. There are some nuances around for example <code>-I/usr/include/python3.13</code> where that path doesn't exist on your machine, but the compiler will locate it via a sysroot in <code>/usr/aarch64-pc-linux-gnu/usr/include/python3.13</code> so it's not immediately obvious when to second-guess the results.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eli-schwartz">@eli-schwartz</a> on 2025-01-28 19:19</div>
            <div class="timeline-body"><blockquote>
<p>cc <a href="https://github.com/eli-schwartz">@eli-schwartz</a> since you've been active on meson-related issues</p>
</blockquote>
<p>Aside: thanks for pinging me on this. :heart: I'm interested in helping people with meson issues and this overlaps with my interest in the python ecosystem / building code, so I'm absolutely comfortable with being pinged any time you have a question for me or simply think I'd be interested. But I only irregularly remember to check issue trackers, so it's best to summon me explicitly to ensure I notice.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/geofft">@geofft</a> on 2025-01-28 23:23</div>
            <div class="timeline-body"><p>Would it help anything to make the .pc file use relative paths from <code>${pcfiledir}</code>? From <code>man pkg-config</code>:</p>
<blockquote>
<p>The installed location of the .pc file. This can be used to query the location of the .pc file for a particular module, but it can also be used to make .pc files relocatable. For instance:</p>
<pre><code>prefix=${pcfiledir}/../..
exec_prefix=${prefix}
libdir=${exec_prefix}/lib
includedir=${prefix}/include
</code></pre>
</blockquote>
<p>This appears to be what Meson's own <code>pkgconfig.relocatable</code> option does for .pc files it produces. (See also a little discussion in openssl/openssl#13080 which points out some issue with sysroots which might not be relevant to us.)</p>
<p>If so then we can just make this change in python-build-standalone and avoid having to patch on install.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-28 23:32</div>
            <div class="timeline-body"><p>Oh cool, that definitely seems like a better solution if it's viable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eli-schwartz">@eli-schwartz</a> on 2025-01-28 23:35</div>
            <div class="timeline-body"><p>relocatable pkg-config files are a <em><strong>really bad</strong></em> tradeoff for a project that expects to be installed to a non-relocatable place, i.e. /usr and simply have done with. You never ever use the functionality, so any cost is too much. Furthermore, it results in paths such as <code>-I/usr/lib64/pkgconfig/../../include</code> which aren't great since that's a compiler default search path and normally, without <code>--keep-system-cflags</code>, those get stripped.</p>
<p>So of course, openssl cannot simply use them and have done with, which was what that ticket was about.</p>
<p>For python-build-standalone, the same tradeoffs can be made that meson makes when you explicitly enable relocation. You know, on a per project or per binary distribution basis, that it is <em>very</em> likely to be relocated, thus by default the flags are simply broken, but relocatable pkgconfig files transition it from being &quot;broken all the time&quot; to &quot;working most of the time&quot;. That makes it very much worthwhile.</p>
<p>Additionally, uv may not be concerned about people installing python using uv in order to cross compile with a sysroot. Probably, most people using sysroots have careful setups which include building cpython from source. Also, pkgconf is pretty popular these days and people generally don't use the original pkg-config (it isn't 2020 anymore!)</p>
<p>So all in all I think you should use relocatable pkg-config files, yes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/geofft">@geofft</a> on 2025-01-29 01:04</div>
            <div class="timeline-body"><p>Wait, I just saw we already patch the pkg-config files after extracting in #10189, which should be in the version of uv you're using - why isn't that helping here? <code>~/.local/share/uv/python/cpython-3.13.1-linux-x86_64-gnu/lib/pkgconfig/python3.pc</code> does seem to be patched on my system now that I look at it.</p>
<p>(I was looking at a plain python-build-standalone tarball.)</p>
<p>Does doing a <code>uv python uninstall 3.13 &amp;&amp; uv python install 3.13</code> help?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lgarrison">@lgarrison</a> on 2025-01-29 01:31</div>
            <div class="timeline-body"><p>... yes it does. Sorry for not catching that!</p>
<p>There may still be value in making the pkg-config file relocatable upstream; it would make the <code>pc</code> file more useful for non-uv users, and it would save uv from having to patch it at runtime. What do you think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/geofft">@geofft</a> on 2025-01-29 01:41</div>
            <div class="timeline-body"><p>Yes, absolutely - I kind of want to get to the point where uv is no longer patching anything from python-build-standalone.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2025-01-29 03:09</div>
            <div class="timeline-body"><p>If there's still interest in patching, https://github.com/bluss/sysconfigpatcher does already patch .pc files correctly from my past usage experience and it can serve as inspiration (or for testing).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-29 03:21</div>
            <div class="timeline-body"><p>(@geofft -- Just confirming that, yes, we do already patch <code>.pc</code> files -- or, at least, we <em>should</em> be patching <code>.pc</code> files.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/geofft">@geofft</a> on 2025-01-29 03:29</div>
            <div class="timeline-body"><p>@samypr100 https://github.com/astral-sh/uv/blob/0.5.25/crates/uv-python/src/sysconfig/mod.rs does actually reference that project in the comments at the top, so I think that's approximately what we're currently doing. Thanks for the pointer, though, in the sense that it would be nice to make sure that, eventually, neither sysconfigpatcher nor the uv port is necessary :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2025-01-29 04:09</div>
            <div class="timeline-body"><p>My bad @charliermarsh, I completely missed .pc file patching was implemented a bit later after the initial round of patching PR'süòÜ</p>
<p>(I thought it was still a TODO thing)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/11234.html">astral-sh/uv#11234</a> on 2025-02-05 06:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/11291.html">astral-sh/uv#11291</a> on 2025-02-06 19:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../astropy/astropy/issues/17760.html">astropy/astropy#17760</a> on 2025-02-13 07:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-04-01 16:54</div>
            <div class="timeline-body"><p>I think this is fixed?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-04-01 16:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:32:58 UTC
    </footer>
</body>
</html>
