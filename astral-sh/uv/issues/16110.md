```yaml
number: 16110
title: "`uv lock` resolves wrong version when using git source + dynamic version field in (optional) dependency"
type: issue
state: open
author: pausz
labels:
  - bug
assignees: []
created_at: 2025-10-03T05:45:20Z
updated_at: 2025-10-03T06:11:41Z
url: https://github.com/astral-sh/uv/issues/16110
synced_at: 2026-01-10T01:57:35Z
```

# `uv lock` resolves wrong version when using git source + dynamic version field in (optional) dependency

---

_Issue opened by @pausz on 2025-10-03 05:45_

### Summary

I have two packages, [package_a](https://github.com/pausz/package_a) and [package_b](https://github.com/pausz/package_b), where package_b depends on package_a.

- `package_b` specifies `package_a>2.0.0` in its optional dependencies. This is on purpose to highlight the issue.

- In addition, `package_b` configures a uv (git) source pointing to a branch of `package_a` (uv-test/version-1) where the version is 1.0.0 (with a dynamic version field via hatchling) -- also done on purpose to illustrate the problem.

I'm using `uv lock` to generate package_b's lock file for the first time. 

#### package_b's pyproject.toml
```toml
[project]
name = "package-b"
version = "0.5.0"
requires-python = ">=3.12"

[project.optional-dependencies]
models = [
    "package_a>2.0.0",
]

[tool.uv.sources]
package-a = { git = "ssh://git@github.com/pausz/package_a.git", branch = "uv-test/version-1" }
```

`package_a/pyproject.toml` (excerpt):

```toml
[tool.hatch.version]
path = "src/package_a/version.py"
```


### Observed unexpected behaviour

From the verbose logs:

- uv attempts to fetch static metadata but fails because the version is dynamic.
- It falls back to using the existing source.

package_b's lockfile ends up including package_a==1.0.0, despite package_b requiring package_a>2.0.0. This is the funny part, because, in practical terms, it means the version number of `package_a` can be extracted if it ends up in the lock file. 

NOTE: This occurs whether package_a is defined as an optional dependency or base dependency of package_b.

Snippet from running `uv lock --verbose` in package_b (complete logs attached):

```bash
DEBUG Attempting GitHub fast path for: package-a @ git+ssh://git@github.com/pausz/package_a.git@uv-test/version-1
DEBUG Querying GitHub for commit at: https://api.github.com/repos/pausz/package_a/commits/uv-test/version-1
DEBUG Attempting to fetch `pyproject.toml` from: https://raw.githubusercontent.com/pausz/package_a/400f4dec55e0685348c5ce7156e09c72da663c5d/pyproject.toml
DEBUG Failed to extract static metadata from GitHub API for: https://raw.githubusercontent.com/pausz/package_a/400f4dec55e0685348c5ce7156e09c72da663c5d/pyproject.toml
DEBUG Fetching source distribution from Git: ssh://git@github.com/pausz/package_a.git
DEBUG Acquired lock for `ssh://github.com/pausz/package_a`
DEBUG Using existing Git source `ssh://git@github.com/pausz/package_a.git`
DEBUG Released lock at `/home/psanz-leon/.cache/uv/git-v0/locks/c18cd15c7f661949`
DEBUG Acquired lock for `/home/psanz-leon/.cache/uv/sdists-v9/git/a44c012e829cfba8/400f4dec55e06853`
DEBUG No static `pyproject.toml` available for: package-a @ git+ssh://git@github.com/pausz/package_a.git@uv-test/version-1 (DynamicField("version"))
DEBUG No static `PKG-INFO` available for: package-a @ git+ssh://git@github.com/pausz/package_a.git@uv-test/version-1 (MissingPkgInfo)
DEBUG Using cached metadata for: package-a @ git+ssh://git@github.com/pausz/package_a.git@uv-test/version-1

```

### Expected behaviour

- If the uv source references to a version of the package that does not meet the declared requirement, I’d expect uv to:
     - fail resolution with an error, or
     - correctly evaluate the dynamic version from the source, rather than silently falling back to a stale version.

### Questions 

... because it's entirely possible I may have misunderstood how uv + hatchling are supposed to work together. We are not using uv native's build backend yet, because we're still tracking our versioning with the `__version__` attribute either in  `__init__.py` or `version.py` 

- Should uv attempt to evaluate hatchling’s dynamic version in this case?
- Or is it actually expected that a git source with dynamic versions can bypass constraint checks, and a workaround is needed?



### Platform

Ubuntu 24.04.3 LTS

### Version

0.8.22

### Python version

3.12.3

---

_Label `bug` added by @pausz on 2025-10-03 05:45_

---

_Comment by @pausz on 2025-10-03 05:48_

[logs_uv_lock_package_b.txt](https://github.com/user-attachments/files/22674936/logs_uv_lock_package_b.txt)


---

_Comment by @pausz on 2025-10-03 05:49_

Resulting lock file:
[uv.lock.txt](https://github.com/user-attachments/files/22674949/uv.lock.txt)

---

_Referenced in [astral-sh/uv#16343](../../astral-sh/uv/issues/16343.md) on 2025-10-17 13:15_

---
