<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>'uv publish' for mixed python-rust code fails due to unsupported platform tag 'linux_x86_64' - astral-sh/uv #9842</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>'uv publish' for mixed python-rust code fails due to unsupported platform tag 'linux_x86_64'</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/issues/9842">#9842</a>
        opened by <a href="https://github.com/giacomopiccinini">@giacomopiccinini</a>
        on 2024-12-12 15:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/giacomopiccinini">@giacomopiccinini</a> on 2024-12-12 15:43</div>
            <div class="timeline-body"><p>Hi!</p>
<p>We are experiencing the following issue when building and publishing a mixed python-rust codebase to PyPi.</p>
<p>Prior to introducing the rust part, in the same project, we were able to successfully build and publish. No issues whatsoever.</p>
<p>Then, we introduced the rust part with the bindings via pyo3 and maturin. No problem at all with the build part. However, we can't get the code to be published on PyPi due to a &quot;wrong&quot; tag. This is the output we get</p>
<pre><code>Successfully built dist/gemmoai-0.1.19.tar.gz
Successfully built dist/gemmoai-0.1.19-cp38-abi3-linux_x86_64.whl
Please enter your PyPI token:

Publishing package...
warning: `uv publish` is experimental and may change without warning
Publishing 2 files https://upload.pypi.org/legacy/
Uploading gemmoai-0.1.19-cp38-abi3-linux_x86_64.whl (2.5MiB)
error: Failed to publish `dist/gemmoai-0.1.19-cp38-abi3-linux_x86_64.whl` to https://upload.pypi.org/legacy/
  Caused by: Upload failed with status code 400 Bad Request. Server says: 400 Binary wheel 'gemmoai-0.1.19-cp38-abi3-linux_x86_64.whl' has an unsupported platform tag 'linux_x86_64'.
</code></pre>
<p>I suppose the issue is that PyPi requires some flavour of &quot;manylinux&quot; in the tag, but it's unclear where we should enforce this. Our current pyproject.toml reads</p>
<pre><code>[project]
name = &quot;gemmoai&quot;
version = &quot;0.1.19&quot;
description = &quot;GemmoAI Python Library&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.11&quot;
dependencies = [
    &quot;maturin&gt;=1.7.6&quot;,
    &quot;pymupdf&gt;=1.24.14&quot;,
    &quot;tomli&gt;=2.2.1&quot;,
]

[tool.maturin]
python-packages = [&quot;gemmoai&quot;]
python-source = &quot;src&quot;
features = [&quot;pyo3/extension-module&quot;]
module-name = &quot;gemmoai.rust&quot; 

[build-system]
requires = [&quot;maturin&gt;=1.0,&lt;2.0&quot;]
build-backend = &quot;maturin&quot;
</code></pre>
<p>We have tried some solutions based on LLMs suggestion, e.g. adding</p>
<pre><code>[tool.maturin]
manylinux = &quot;manylinux2014&quot;
</code></pre>
<p>or</p>
<pre><code>[tool.maturin]
python-platform = &quot;x8664-manylinux240&quot;
</code></pre>
<p>or</p>
<pre><code>[tool.uv.pip]
python-platform = &quot;x8664-manylinux240&quot;
</code></pre>
<p>The final tag never changes, and hence the upload fails. What is the right solution for this?</p>
<p>Many thanks in advance, and let us know if we can contribute in any way.</p>
<p><strong>Details</strong></p>
<pre><code>uv 0.5.8
Distributor ID:	Ubuntu
Description:	Ubuntu 22.04.5 LTS
Release:	22.04
Codename:	jammy
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/giacomopiccinini">@giacomopiccinini</a> on 2024-12-13 17:52</div>
            <div class="timeline-body"><p>After digging in more I was able to debug this using maturin instead of <code>uv build</code>.</p>
<p>First, I tried to run <code>maturin build</code> but I got this error</p>
<p><em>&quot;Your library is not manylinux_2_17 (aka manylinux2014) compliant because of the presence of too-recent versioned symbols&quot;</em></p>
<p>After digging a little more, I was able to find that I should have run the build inside a container to avoid this issue, i.e. run</p>
<pre><code>docker run --rm \
	-v &quot;${pwd}:/io&quot; \
	-w /io \
	ghcr.io/pyo3/maturin \
	build --release \
	-o /io/dist 
</code></pre>
<p>This created indeed a manylinux wheel that I was then able to upload with <code>uv publish</code>. So basically I replaced in my CI pipeline the <code>uv build</code> with the docker thing above. It's more of a patch I guess, but it's also the patch maturin people suggest.</p>
<p>At this point I am not sure this is an issue (if it ever was), or if you'd need to have some other Docker image built on top of the maturin one with uv installed to replicate the maturin patch?</p>
<p><strong>Bonus</strong>
In trying to replicate the error message <em>&quot;Your library [...]&quot;</em> I re-ran <code>maturin build</code> but this time compiled correctly to manylinux. Not sure why is that. However, <code>uv build</code> keeps creating the &quot;wrong&quot; thing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @konstin by @zanieb on 2024-12-13 18:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @konstin on 2024-12-17 12:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/9970.html">astral-sh/uv#9970</a> on 2024-12-17 12:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2024-12-17 13:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @konstin on 2024-12-17 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @konstin on 2025-01-28 11:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @konstin on 2025-01-28 11:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @konstin by @konstin on 2025-01-28 11:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-01-28 11:48</div>
            <div class="timeline-body"><p><code>uv build</code> doesn't handle anything manylinux-related, that must be done by the build backend, in this case maturin. The maturin containers are convenience wrappers around the containers from https://github.com/pypa/manylinux, which are the official solution for that. If you want to use <code>uv build</code>, you need to install uv in one of those containers for your build, otherwise you've correctly described the <code>maturin build</code> setup.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-01-28 11:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:01 UTC
    </footer>
</body>
</html>
