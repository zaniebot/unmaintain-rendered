<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uv build` crashes with hatchling when different items in sdist and wheel - astral-sh/uv #16634</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>uv build</code> crashes with hatchling when different items in sdist and wheel</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/16634">#16634</a>
        opened by <a href="https://github.com/rzuckerm">@rzuckerm</a>
        on 2025-11-07 16:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/rzuckerm">@rzuckerm</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Here is my original <code>pyproject.toml</code> in poetry:</p>
<pre><code class="language-toml">[tool.poetry]
name = &quot;test_pkg&quot;
version = &quot;0.1.dev&quot;
description = &quot;&quot;
authors = [&quot;rzuckerm&quot;]
include = [
    {path = &quot;a.txt&quot;, format = &quot;sdist&quot;},
    {path = &quot;b.txt&quot;, format = &quot;wheel&quot;}
]

[tool.poetry.dependencies]
python = &quot;^3.10&quot;

[build-system]
requires = [&quot;poetry_core&gt;=1.9.1,&lt;2.0.0&quot;]
build-backend = &quot;poetry.core.masonry.api&quot;
</code></pre>
<p>Here is my project structure:</p>
<pre><code>.
├── a.txt
├── b.txt
├── poetry.lock
├── pyproject.toml
└── test_pkg
    └── __init__.py
</code></pre>
<p>Yes, I am aware that <code>a.txt</code> and <code>b.txt</code> should be in <code>test_pkg</code>, but I'm trying to cover corner cases that I have observed in our developer community.</p>
<p>If I do <code>poetry build</code>, I get this for the sdist:</p>
<pre><code class="language-console">$ tar tf dist/*.gz | sort
test_pkg-0.1.dev0/PKG-INFO
test_pkg-0.1.dev0/a.txt
test_pkg-0.1.dev0/pyproject.toml
test_pkg-0.1.dev0/test_pkg/__init__.py
</code></pre>
<p>and this for the wheel:</p>
<pre><code class="language-console">$ zipinfo -1 dist/*.whl
b.txt
test_pkg-0.1.dev0.dist-info/METADATA
test_pkg-0.1.dev0.dist-info/RECORD
test_pkg-0.1.dev0.dist-info/WHEEL
test_pkg/__init__.py
</code></pre>
<p>I converted my <code>pyproject.toml</code> to uv using <a href="https://github.com/mkniewallner/migrate-to-uv">migrate-to-uv</a> plus some edits since that tool is buggy:</p>
<pre><code class="language-toml">[project]
name = &quot;test_pkg&quot;
version = &quot;0.1.dev&quot;
description = &quot;&quot;
authors = [{ name = &quot;rzuckerm&quot; }]
requires-python = &quot;&gt;=3.10,&lt;4&quot;

[tool.hatch.build.targets.sdist]
include = [&quot;test_pkg&quot;, &quot;a.txt&quot;]

[tool.hatch.build.targets.wheel]
include = [&quot;test_pkg&quot;]

[tool.hatch.build.targets.wheel.force-include]
&quot;b.txt&quot; = &quot;b.txt&quot;

[build-system]
requires = [&quot;hatchling&quot;]
build-backend = &quot;hatchling.build&quot;
</code></pre>
<p>If I just do <code>uv build</code>, then uv builds the sdist and then builds the wheel from the sdist:</p>
<pre><code class="language-console">$ uv build
Building source distribution...
Building wheel from source distribution...
Traceback (most recent call last):
  File &quot;&lt;string&gt;&quot;, line 11, in &lt;module&gt;
  File &quot;/home/rzuckerm/.cache/uv/builds-v0/.tmpPjaY0A/lib/python3.12/site-packages/hatchling/build.py&quot;, line 58, in build_wheel
    return os.path.basename(next(builder.build(directory=wheel_directory, versions=['standard'])))
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/home/rzuckerm/.cache/uv/builds-v0/.tmpPjaY0A/lib/python3.12/site-packages/hatchling/builders/plugin/interface.py&quot;, line 155, in build
    artifact = version_api[version](directory, **build_data)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/home/rzuckerm/.cache/uv/builds-v0/.tmpPjaY0A/lib/python3.12/site-packages/hatchling/builders/wheel.py&quot;, line 477, in build_standard
    for included_file in self.recurse_included_files():
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/home/rzuckerm/.cache/uv/builds-v0/.tmpPjaY0A/lib/python3.12/site-packages/hatchling/builders/plugin/interface.py&quot;, line 177, in recurse_included_files
    yield from self.recurse_forced_files(self.config.get_force_include())
  File &quot;/home/rzuckerm/.cache/uv/builds-v0/.tmpPjaY0A/lib/python3.12/site-packages/hatchling/builders/plugin/interface.py&quot;, line 237, in recurse_forced_files
    raise FileNotFoundError(msg)
FileNotFoundError: Forced include not found: /home/rzuckerm/.cache/uv/sdists-v9/.tmpWKlryw/test_pkg-0.1.dev0/b.txt
  × Failed to build `/tmp/test-pkg`
  ├─▶ The build backend returned an error
  ╰─▶ Call to `hatchling.build.build_wheel` failed (exit status: 1)
      hint: This usually indicates a problem with the package or the build environment.
</code></pre>
<p>However, if I run <code>uv build --sdist</code> and <code>uv build --wheel</code> separately, then I seem to get a result that is similar to poetry. Here is the sdist:</p>
<pre><code class="language-console">$ tar tf dist/*.gz | sort
test_pkg-0.1.dev0/.gitignore
test_pkg-0.1.dev0/PKG-INFO
test_pkg-0.1.dev0/a.txt
test_pkg-0.1.dev0/pyproject.toml
test_pkg-0.1.dev0/test_pkg/__init__.py
</code></pre>
<p>Here is the wheel:</p>
<pre><code class="language-console">$ zipinfo -1 dist/*.whl | sort
b.txt
test_pkg-0.1.dev0.dist-info/METADATA
test_pkg-0.1.dev0.dist-info/RECORD
test_pkg-0.1.dev0.dist-info/WHEEL
test_pkg/__init__.py
</code></pre>
<p>Except for the addition of <code>.gitignore</code> in the sdist that hatchling insists on adding, the files are identical.</p>
<h3>Platform</h3>
<p>Ubuntu 24.04 amd64</p>
<h3>Version</h3>
<p>uv 0.9.7</p>
<h3>Python version</h3>
<p>Python 3.12.11</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @rzuckerm on 2025-11-07 16:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-11-07 20:49</div>
            <div class="timeline-body"><p>This matches our documentation, we build the wheel from the sdist by default (as is best practice because it catches mistakes like a missing file in the sdist). By using <code>--wheel</code>, you opt-in to building the wheel directly from the source tree instead.</p>
<blockquote>
<p><code>uv build</code> accepts a path to a directory or source distribution, which defaults to the current working
directory.</p>
<p>By default, if passed a directory, <code>uv build</code> will build a source distribution (&quot;sdist&quot;) from the source
directory, and a binary distribution (&quot;wheel&quot;) from the source distribution.</p>
<p><code>uv build --sdist</code> can be used to build only the source distribution, <code>uv build --wheel</code> can be used to
build only the binary distribution, and <code>uv build --sdist --wheel</code> can be used to build both
distributions from source.</p>
<p>If passed a source distribution, <code>uv build --wheel</code> will build a wheel from the source distribution.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @zanieb on 2025-11-07 20:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @zanieb on 2025-11-07 20:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rzuckerm">@rzuckerm</a> on 2025-11-07 20:54</div>
            <div class="timeline-body"><p>@zanieb It looks like <code>uv build --sdist --wheel</code> does what I want without having to run <code>uv build</code> twice. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @rzuckerm on 2025-11-07 20:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:33:24 UTC
    </footer>
</body>
</html>
