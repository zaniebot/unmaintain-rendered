<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caching and --config-settings - astral-sh/uv #10575</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Caching and --config-settings</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/issues/10575">#10575</a>
        opened by <a href="https://github.com/suomela">@suomela</a>
        on 2025-01-13 19:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/suomela">@suomela</a></div>
            <div class="timeline-body"><p>I am here using <code>leanblueprint</code> as a random example of a tool I can run like <code>uvx leanblueprint</code>, which also depends on a package (<code>pygraphviz</code>) that requires magic command line switches to compile correctly.</p>
<p>On macOS, this typically fails with a compilation error in <code>pygraphviz</code>:</p>
<pre><code>uv cache clean
uvx leanblueprint
</code></pre>
<p>I can fix it like this:</p>
<pre><code>uvx --config-settings=&quot;--global-option=build_ext&quot; --config-settings=&quot;--global-option=-I$(brew --prefix graphviz)/include/&quot; --config-settings=&quot;--global-option=-L$(brew --prefix graphviz)/lib/&quot; leanblueprint
</code></pre>
<p>After running the above command once, <code>pygraphviz</code> is compiled correctly and cached and I can simply use this:</p>
<pre><code>uvx leanblueprint
</code></pre>
<p>However, if I ever clean the cache with e.g. <code>uv cache clean</code>, I can no longer run <code>uvx leanblueprint</code> until I do the magic thing with all the right <code>--config-settings</code> switches.</p>
<p>Somehow this does not feel right. The cache should be there just to speed things up, right? Cleaning the cache should only mean that next time things will take more time to download &amp; build, but it shouldn't break anything? I would expect e.g. <code>uvx leanblueprint</code> behave in the same way before and after cleaning the cache (other than speed), but that is not the case.</p>
<p>Is this intentional? Or am I just doing something wrong by using <code>--config-settings</code> like this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-13 19:16</div>
            <div class="timeline-body"><p>Let me take a look, I'll see if I can explain what's going on.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-13 19:19</div>
            <div class="timeline-body"><p>I believe this is because we cache the resolved environment. We might want the cached environment to take <code>--config-settings</code> into account, just like we do in the wheel cache itself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2025-01-13 19:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2025-01-13 19:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-13 19:20</div>
            <div class="timeline-body"><p>The thing is, I think that would mean that you need to pass the <code>--config-settings</code> every time you invoke <code>uvx</code>. Which is, I guess, correct to enforce? You could <code>uv tool install</code> instead if you want to avoid that ceremony. Then <code>uvx leanblueprint</code> would use the installed version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/suomela">@suomela</a> on 2025-01-13 19:26</div>
            <div class="timeline-body"><blockquote>
<p>The thing is, I think that would mean that you need to pass the <code>--config-settings</code> every time you invoke <code>uvx</code>. Which is, I guess, correct to enforce?</p>
</blockquote>
<p>Yes, I would expect that if I have to pass <code>--config-settings</code> once, I'd have to pass it every time. That would at least be consistent and non-surprising.</p>
<p>The same thing apparently happens with <code>uv add</code>. This is how I originally noticed this: I was struggling with getting stuff working in one project, I created a brand new project for debugging, I managed to get it working there with <code>uv add --config-settings ...</code>, and to my surprise this also fixed the behavior in another unrelated project. Except that it broke when I cleared the cache.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-13 19:29</div>
            <div class="timeline-body"><p>That one I'm a bit more surprised by, but maybe there's a bug somewhere.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/suomela">@suomela</a> on 2025-01-13 19:34</div>
            <div class="timeline-body"><p>Here are steps to reproduce (getting it working in <code>bar</code> influences what happens in <code>foo</code>):</p>
<pre><code>uv cache clean
uv init foo
uv init bar
cd foo
uv add pygraphviz   # FAILS
cd ..
cd bar
uv add --config-settings=&quot;--global-option=build_ext&quot; --config-settings=&quot;--global-option=-I$(brew --prefix graphviz)/include/&quot; --config-settings=&quot;--global-option=-L$(brew --prefix graphviz)/lib/&quot; pygraphviz
cd ..
cd foo
uv add pygraphviz   # NOW IT WORKS
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-13 20:12</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-13 20:13</div>
            <div class="timeline-body"><p>I can reproduce that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-13 20:55</div>
            <div class="timeline-body"><p>Hmm... I'm not sure what the best option is here... The problem is that setuptools seems to &quot;reuse&quot; the build. Like, this directory gets created, so then subsequent setuptools invocations skip a step in the build, I think. The only solution here would be to shard the cache based on <code>--config-setting</code>. Right now, we store separate built wheels based on <code>--config-setting</code>, but we use the same <code>src</code> directory.</p>
<p><img src="https://github.com/user-attachments/assets/0dd1bc14-9816-4719-aa6c-5151cc7fcd9b" alt="Image" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-13 21:00</div>
            <div class="timeline-body"><p>I think it's related to this: https://github.com/pypa/setuptools/issues/1347</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">upstream</span> added by @konstin on 2025-01-13 21:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:29:18 UTC
    </footer>
</body>
</html>
