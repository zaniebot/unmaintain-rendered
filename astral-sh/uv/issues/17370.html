<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner ignores resolved version difference in favour of cache hit - astral-sh/uv #17370</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Planner ignores resolved version difference in favour of cache hit</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/17370">#17370</a>
        opened by <a href="https://github.com/EliteTK">@EliteTK</a>
        on 2026-01-09 01:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a></div>
            <div class="timeline-body">Summary
<p>Scenario:</p>
<ul>
<li>uv is asked to re-install a dependency with <code>--no-cache</code></li>
<li>the dependency has a dynamic version</li>
<li>the installed version is out of date but the dependency&#x27;s cache-keys have not changed</li>
</ul>
<p>Due to <code>--no-cache</code> uv will call the resolver which will in turn run the necessary bits of the dependency&#x27;s build system to get the actual version. The resolver will report that there is a newer version but the planner will claim the dependency is in-date due to valid cache keys (despite <code>--no-cache</code>?).</p>
<p>It&#x27;s a bit easier to show rather than tell:</p>
<pre><code>#!/usr/bin/env bash

set -e

tempdir=$(mktemp -d)
trap &#x27;rm -rf &quot;$tempdir&quot;&#x27; EXIT

mkdir -p -- &quot;$tempdir/lib&quot;
cat &lt;&lt;EOF &gt;&quot;$tempdir/lib/pyproject.toml&quot;
[project]
name = &quot;lib&quot;
dynamic = [&quot;version&quot;, &quot;description&quot;]
[build-system]
requires = [&quot;flit_core &gt;=3.2,&lt;4&quot;]
build-backend = &quot;flit_core.buildapi&quot;
EOF
cat &lt;&lt;EOF &gt;&quot;$tempdir/lib/lib.py&quot;
&quot;&quot;&quot;.&quot;&quot;&quot;
__version__ = &quot;0.1.0&quot;
EOF

mkdir -p -- &quot;$tempdir/app&quot;
cat &lt;&lt;EOF &gt;&quot;$tempdir/app/pyproject.toml&quot;
[project]
name = &quot;app&quot;
version = &quot;0.1.0&quot;
description = &quot;&quot;
dependencies = [&quot;lib&quot;]
[tool.uv.sources]
lib = { path = &quot;../lib&quot; }
EOF
touch &quot;$tempdir/app/main.py&quot;

set -x

uv --directory &quot;$tempdir/app/&quot; venv
uv --directory &quot;$tempdir/app/&quot; pip install .

sed -i &#x27;s/0\.1\.0/0\.1\.1/&#x27; &quot;$tempdir/lib/lib.py&quot;

uv -vvv --directory &quot;$tempdir/app/&quot; pip install --no-cache . 2&gt;&amp;1 | sed -n &#x27;/TRACE .* lib==0\.1\.1/,/^DEBUG Requirement already installed/p&#x27;
</code></pre>
<p>This produces:</p>
<pre><code>+ uv --directory /tmp/tmp.XyXmVXgZ9t/app/ venv
Using CPython 3.13.11
Creating virtual environment at: .venv
Activate with: source .venv/bin/activate
+ uv --directory /tmp/tmp.XyXmVXgZ9t/app/ pip install .
Resolved 2 packages in 185ms
   Building lib @ file:///tmp/tmp.XyXmVXgZ9t/lib
   Building app @ file:///tmp/tmp.XyXmVXgZ9t/app
      Built lib @ file:///tmp/tmp.XyXmVXgZ9t/lib
      Built app @ file:///tmp/tmp.XyXmVXgZ9t/app
Prepared 2 packages in 505ms
warning: Failed to hardlink files; falling back to full copy. This may lead to degraded performance.
         If the cache and target directories are on different filesystems, hardlinking may not be supported.
         If this is intentional, set `export UV_LINK_MODE=copy` or use `--link-mode=copy` to suppress this warning.
Installed 2 packages in 0.44ms
 + app==0.1.0 (from file:///tmp/tmp.XyXmVXgZ9t/app)
 + lib==0.1.0 (from file:///tmp/tmp.XyXmVXgZ9t/lib)
+ sed -i &#x27;s/0\.1\.0/0\.1\.1/&#x27; /tmp/tmp.XyXmVXgZ9t/lib/lib.py
+ uv -vvv --directory /tmp/tmp.XyXmVXgZ9t/app/ pip install --no-cache .
+ sed -n &#x27;/TRACE .* lib==0\.1\.1/,/^DEBUG Requirement already installed/p&#x27;
TRACE Assigned packages: root==0a0.dev0, app==0.1.0, lib==0.1.1
DEBUG Tried 2 versions: app 1, lib 1
DEBUG marker environment resolution took 0.000s
TRACE Resolution: ResolverEnvironment { kind: Specific { marker_env: ResolverMarkerEnvironment(MarkerEnvironment { inner: MarkerEnvironmentInner { implementation_name: &quot;cpython&quot;, implementation_version: StringVersion { string: &quot;3.13.11&quot;, version: &quot;3.13.11&quot; }, os_name: &quot;posix&quot;, platform_machine: &quot;x86_64&quot;, platform_python_implementation: &quot;CPython&quot;, platform_release: &quot;6.12.63_1&quot;, platform_system: &quot;Linux&quot;, platform_version: &quot;#1 SMP PREEMPT_DYNAMIC Thu Dec 18 18:36:00 UTC 2025&quot;, python_full_version: StringVersion { string: &quot;3.13.11&quot;, version: &quot;3.13.11&quot; }, python_version: StringVersion { string: &quot;3.13&quot;, version: &quot;3.13&quot; }, sys_platform: &quot;linux&quot; } }) } }
TRACE Resolution edge: ROOT -&gt; app
TRACE Resolution edge:     0a0.dev0 -&gt; 0.1.0
TRACE Resolution edge: app -&gt; lib
TRACE Resolution edge:     0.1.0 -&gt; 0.1.1
Resolved 2 packages in 398ms
DEBUG Must revalidate requirement: app
TRACE Comparing installed with source: InstalledDist { kind: Url(InstalledDirectUrlDist { name: PackageName(&quot;lib&quot;), version: &quot;0.1.0&quot;, direct_url: LocalDirectory { url: &quot;file:///tmp/tmp.XyXmVXgZ9t/lib&quot;, dir_info: DirInfo { editable: Some(false) }, subdirectory: None }, url: DisplaySafeUrl { scheme: &quot;file&quot;, cannot_be_a_base: false, username: &quot;&quot;, password: None, host: None, port: None, path: &quot;/tmp/tmp.XyXmVXgZ9t/lib&quot;, query: None, fragment: None }, editable: false, path: &quot;/tmp/tmp.XyXmVXgZ9t/app/.venv/lib/python3.13/site-packages/lib-0.1.0.dist-info&quot;, cache_info: Some(CacheInfo { timestamp: Some(Timestamp(SystemTime { tv_sec: 1767921490, tv_nsec: 849237843 })), commit: None, tags: None, env: {}, directories: {&quot;src&quot;: None} }), build_info: Some(BuildInfo { config_settings: ConfigSettings({}), extra_build_requires: [], extra_build_variables: {} }) }), metadata_cache: OnceLock(&lt;uninit&gt;), tags_cache: OnceLock(&lt;uninit&gt;) } Directory { install_path: &quot;/tmp/tmp.XyXmVXgZ9t/lib&quot;, editable: Some(false), virtual: Some(false), url: VerbatimUrl { url: DisplaySafeUrl { scheme: &quot;file&quot;, cannot_be_a_base: false, username: &quot;&quot;, password: None, host: None, port: None, path: &quot;/tmp/tmp.XyXmVXgZ9t/lib&quot;, query: None, fragment: None }, given: Some(&quot;../lib&quot;) } }
DEBUG Computed cache info: Timestamp(SystemTime { tv_sec: 1767921490, tv_nsec: 849237843 }), None, None, {}, {&quot;src&quot;: None}. Most recently modified: /tmp/tmp.XyXmVXgZ9t/lib/pyproject.toml
DEBUG Requirement already installed: lib==0.1.0 (from file:///tmp/tmp.XyXmVXgZ9t/lib)
+ rm -rf /tmp/tmp.XyXmVXgZ9t
</code></pre>
<p>Specifically note that the resolver reports that <code>lib</code> is now at <code>0.1.1</code> but the planner claims the cache (as in, the installed version itself) is still valid.</p>
<p>This is because of this specific call:</p>
<p>https://github.com/astral-sh/uv/blob/25d691eeafc9089a77d4fe1d82f22ca48006cda0/crates/uv-installer/src/plan.rs#L125-L135</p>
<p>Which passes the name of the resolved dist, and the installed dist, but not the resolved dist&#x27;s version (which at this point is set).</p>
<p>The dynamic version + no-cache situation is contrived, but it seems like this logic might break other things. It&#x27;s just not clear what it would break. It&#x27;s curious why this hasn&#x27;t caused any more noticeable problems so far.</p>
<p>It seems there <em>should</em> be a version check if the resolved version happens to be newer. But it&#x27;s also unclear if that may have unintended side effects.</p>
<p>Probably worth investigating further at some point.</p>
Platform
<p>Linux 6.12.63_1 x86_64 GNU/Linux</p>
Version
<p>uv 0.9.22</p>
Python version
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-09 01:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-09 19:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2026-01-09 20:43</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:41:29 UTC
    </footer>
</body>
</html>
