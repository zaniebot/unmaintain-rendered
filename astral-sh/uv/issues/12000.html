<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`uvx` uses cached environment of a nonexistent Python version - astral-sh/uv #12000</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>uvx</code> uses cached environment of a nonexistent Python version</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/issues/12000">#12000</a>
        opened by <a href="https://github.com/srenfo">@srenfo</a>
        on 2025-03-06 11:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/srenfo">@srenfo</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>After bumping the Python Docker image in our CI <em>with a shared cache</em>, <code>uvx</code> uses a cached env of a now nonexistent Python version. I expected <code>uvx</code> to detect the missing interpreter and create a new environment.</p>
<h2>Use Case</h2>
<p>We have a GitLab CI job pretty much as follows:</p>
<pre><code class="language-yaml">Test:
  image: &quot;ghcr.io/astral-sh/uv:0.6-python3.11-bookworm&quot;
  script:
    - uvx --with tox-uv==1.25.0 -- tox@4.24.1 run -e unit
</code></pre>
<p>After bumping the image to <code>ghcr.io/astral-sh/uv:0.6-python3.12-bookworm</code> (i. e. changing just the Python version), <code>uvx</code> tries to invoke tox using the old 3.11 environment. Notably, <code>XDG_CACHE_HOME</code> points to a directory that is shared between these invocations.</p>
<h2>Minimal Reproducible Example</h2>
<pre><code class="language-sh">docker volume create uvx-tool-test
docker run -v uvx-tool-test:/root/.cache ghcr.io/astral-sh/uv:python3.11-bookworm uvx tox --version
docker run -v uvx-tool-test:/root/.cache ghcr.io/astral-sh/uv:python3.12-bookworm uvx tox --version
</code></pre>
<p>The third command fails to run <code>tox</code>. Sample output, slightly redacted:</p>
<pre><code class="language-sh">$ sudo docker volume create uvx-tool-test
uvx-tool-test

$ sudo docker run -v uvx-tool-test:/root/.cache ghcr.io/astral-sh/uv:python3.11-bookworm uvx tox --version
Downloading virtualenv (4.1MiB)
 Downloaded virtualenv
Installed 11 packages in 22ms
ROOT: No tox.ini or setup.cfg or pyproject.toml or tox.toml found, assuming empty tox.ini at /
4.24.1 from /root/.cache/uv/archive-v0/9tvCQSvNfVTYHrkVKA6MB/lib/python3.11/site-packages/tox/__init__.py

$ sudo docker run -v uvx-tool-test:/root/.cache ghcr.io/astral-sh/uv:python3.12-bookworm uvx tox --version
Traceback (most recent call last):
  File &quot;/root/.cache/uv/archive-v0/9tvCQSvNfVTYHrkVKA6MB/bin/tox&quot;, line 6, in &lt;module&gt;
    from tox.run import run
ModuleNotFoundError: No module named 'tox'
</code></pre>
<p>Note how the <code>9tvCQSvNfVTYHrkVKA6MB</code> token stays the same.</p>
<p>To be extra sure:</p>
<pre><code class="language-sh">sudo docker run -v uvx-tool-test:/root/.cache ghcr.io/astral-sh/uv:python3.12-bookworm cat /root/.cache/uv/archive-v0/9tvCQSvNfVTYHrkVKA6MB/pyvenv.cfg
home = /usr/local/bin
implementation = CPython
uv = 0.6.4
version_info = 3.11.11
include-system-site-packages = false
relocatable = true
</code></pre>
<h2>Workaround</h2>
<p>Adding an explicit Python version works just fine. <code>uvx --python 3.12 ...</code>.</p>
<h3>Platform</h3>
<p>GitLab Runner with Docker images provided by Astral</p>
<h3>Version</h3>
<p>uv 0.6.4</p>
<h3>Python version</h3>
<p>Python 3.11 &amp; 3.12</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @srenfo on 2025-03-06 11:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @jtfmumm by @zanieb on 2025-06-20 14:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on 2025-07-09 12:40</div>
            <div class="timeline-body"><p>I'm unable to replicate this on macOS on the latest uv (0.7.19) running your minimal reproduction commands. I see:</p>
<pre><code>$ docker volume create uvx-tool-test
uvx-tool-test

$ docker run -v uvx-tool-test:/root/.cache ghcr.io/astral-sh/uv:python3.11-bookworm uvx tox --version
Downloading virtualenv (5.8MiB)
 Downloading virtualenv
Installed 11 packages in 33ms
ROOT: No tox.ini or setup.cfg or pyproject.toml or tox.toml found, assuming empty tox.ini at /
4.27.0 from /root/.cache/uv/archive-v0/8r4jCcebY_0XOfnVd5nM7/lib/python3.11/site-packages/tox/__init__.py

$ docker run -v uvx-tool-test:/root/.cache ghcr.io/astral-sh/uv:python3.12-bookworm uvx tox --version
Installed 11 packages in 9ms
ROOT: No tox.ini or setup.cfg or pyproject.toml or tox.toml found, assuming empty tox.ini at /
4.27.0 from /root/.cache/uv/archive-v0/NAbOR_8F1xcCoteNv0sOV/lib/python3.12/site-packages/tox/__init__.py
</code></pre>
<p>Were you running these commands locally? And do you still have this problem after upgrading uv?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/srenfo">@srenfo</a> on 2025-07-09 13:21</div>
            <div class="timeline-body"><p>Yes we were running these commands locally. And no, we can no longer reproduce the problem after upgrading.</p>
<p>I did a little bisecting and it looks like uv 0.7.13 was the last affected version (albeit in a different way than reported here, with empty output rather than a traceback) and the fix must have landed in 0.7.14.</p>
<p>Thank you for following up on this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @srenfo on 2025-07-09 13:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:30:17 UTC
    </footer>
</body>
</html>
