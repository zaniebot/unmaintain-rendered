```yaml
number: 11500
title: "Use a 'minor' version field (`revision`) in the lockfile"
type: pull_request
state: merged
author: charliermarsh
labels:
  - resolver
assignees: []
merged: true
base: main
head: charlie/rev
created_at: 2025-02-14T01:53:40Z
updated_at: 2025-02-14T16:17:28Z
url: https://github.com/astral-sh/uv/pull/11500
synced_at: 2026-01-10T11:10:38Z
```

# Use a 'minor' version field (`revision`) in the lockfile

---

_Pull request opened by @charliermarsh on 2025-02-14 01:53_

## Summary

This is an alternative to the approach we took in #11063 whereby we always included `provides-extra` and `requires-dist`, since we needed some way to differentiate between "no extras" and "lockfile was generated by a uv version that didn't include extras".

Instead, this PR adds a minor version (called a "revision") to the lockfile that we can use to indicate support for this feature. While lockfile version bumps are backwards-incompatible, older uv versions _can_ read lockfiles with a later revision -- they just won't understand all the data.

In a future major version bump, we could simplify things and change the schema to use a (major, minor) format instead of these two separate fields. But this is the only way to do it that's backwards-compatible with existing uv versions.


---

_Comment by @zanieb on 2025-02-14 02:02_

I'm into it ðŸ‘ I'll let @Gankra give the approving review.

---

_Comment by @charliermarsh on 2025-02-14 02:05_

I think I made a mistake by suggesting that we make `provides-extra` non-optional (in order to power feature detection) -- I'm sorry about that. I don't think what I have here is _perfect_, but I do think it's less disruptive (e.g., we don't have to re-make these fields hidden-when-empty when we bump the version in the future) and closer to the principles we use throughout the format (favoring conciseness, etc.).


---

_Marked ready for review by @charliermarsh on 2025-02-14 02:41_

---

_Renamed from "Use a 'minor' version field in the lockfile" to "Use a 'minor' version field (`revision`)in the lockfile" by @charliermarsh on 2025-02-14 02:41_

---

_Renamed from "Use a 'minor' version field (`revision`)in the lockfile" to "Use a 'minor' version field (`revision`) in the lockfile" by @charliermarsh on 2025-02-14 02:41_

---

_Label `compatibility` added by @charliermarsh on 2025-02-14 02:44_

---

_Label `compatibility` removed by @charliermarsh on 2025-02-14 02:44_

---

_Label `resolver` added by @charliermarsh on 2025-02-14 02:44_

---

_Review comment by @Gankra on `crates/uv/src/commands/project/install_target.rs`:266 on 2025-02-14 14:03_

This needs to check for the current lock.version() too, since 3.0 > 2.1 (unless you want 2.100 => 3.101 to be a thing..? that seems weird.)

---

_Review comment by @Gankra on `crates/uv/tests/it/edit.rs`:5602 on 2025-02-14 14:05_

lmao i see our copies of cargo-insta are fighting (I'm on cargo-insta 1.42.0)

---

_@Gankra approved on 2025-02-14 14:06_

One potential issue but yeah this is just better! I was surprised you were happy with making it so much noisier, I wish I knew that adding the minor version would be this easy!

---

_@zanieb reviewed on 2025-02-14 15:53_

---

_Review comment by @zanieb on `crates/uv/src/commands/project/install_target.rs`:266 on 2025-02-14 15:53_

Added in https://github.com/astral-sh/uv/pull/11500/commits/6571d2ffc4f1a320d875ea1f2e5994ad9b2fb414

---

_Review comment by @charliermarsh on `crates/uv/src/commands/project/install_target.rs`:266 on 2025-02-14 16:02_

I think this should be `if (lock.version(), lock.revision()) < (1, 1)` rather than hard-coding 1?

---

_@charliermarsh reviewed on 2025-02-14 16:02_

---

_@charliermarsh reviewed on 2025-02-14 16:03_

---

_Review comment by @charliermarsh on `crates/uv/src/commands/project/install_target.rs`:266 on 2025-02-14 16:03_

I think it's actually impossible to get here since we reject lockfiles that don't match the major, but you're right that we should change this.

---

_@zanieb reviewed on 2025-02-14 16:06_

---

_Review comment by @zanieb on `crates/uv/src/commands/project/install_target.rs`:266 on 2025-02-14 16:06_

Agree on both points

---

_Comment by @charliermarsh on 2025-02-14 16:06_

> One potential issue but yeah this is just better! I was surprised you were happy with making it so much noisier, I wish I knew that adding the minor version would be this easy!

Gah, yeah, I'm sorry that I went back and forth on it and made you do a bunch of extra work. The more I thought about it, the more it felt like the wrong tradeoff. I think the "hard" thing about adding the minor version was just figuring out what it should be called and what the schema should look like (since we need two version fields)... What we have here is _okay_, not perfect, but it's does feel like a better tradeoff.


---

_@zanieb reviewed on 2025-02-14 16:07_

---

_Review comment by @zanieb on `crates/uv/src/commands/project/install_target.rs`:266 on 2025-02-14 16:07_

https://github.com/astral-sh/uv/pull/11500/commits/d11e76c127da7bc40c4d0f975b9f3ba850e1e3c9

---

_@charliermarsh reviewed on 2025-02-14 16:16_

Thanks Zanie!

---

_Merged by @zanieb on 2025-02-14 16:17_

---

_Closed by @zanieb on 2025-02-14 16:17_

---

_Branch deleted on 2025-02-14 16:17_

---
