<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Only include visited packages in error message derivation - astral-sh/uv #1144</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Only include visited packages in error message derivation</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/1144">#1144</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-01-27 01:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>This is my guess as to the source of the resolver flake, based on information and extensive debugging from @zanieb. In short, if we rely on <code>self.index.packages</code> as a source of truth during error reporting, we open ourselves up to a source of non-determinism, because we fetch package metadata asynchronously in the background while we solve -- so packages <em>could</em> be included in or excluded from the index depending on the order in which those requests are returned.</p>
<p>So, instead, we now track the set of packages that <em>were</em> visited by the solver. Visiting a package <em>requires</em> that we wait for its metadata to be available. By limiting analysis to those packages that were visited during solving, we are faithfully representing the state of the solver at the time of failure.</p>
<p>Closes #863</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-27 01:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-27 01:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-27 01:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-resolver/src/error.rs</code>:174 on 2024-01-27 01:50</div>
            <div class="timeline-body"><p>@zanieb - I don&#x27;t think it&#x27;s necessary true that we&#x27;ll always have metadata for all packages in the derivation tree (<code>for package in self.derivation_tree.packages()</code>), since the derivation tree can include <em>dependencies</em> that we haven&#x27;t yet visited.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-27 01:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-resolver/src/error.rs</code>:172 on 2024-01-27 01:50</div>
            <div class="timeline-body"><p>We could &quot;join&quot; <code>visited</code> and <code>package_versions</code> prior to passing it in here, if we want.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-01-27 03:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/puffin-resolver/src/error.rs</code>:195 on 2024-01-27 03:07</div>
            <div class="timeline-body"><p>We need metadata for every package in the derivation tree or we will not be able to simplify ranges when displaying errors regarding that package. This change will degrade error messages; that&#x27;s why I&#x27;m suggesting that we attempt to retrieve the metadata of any packages in the derivation tree that are not available. I can take a shot at implementing it.</p>
<p>If we wanted to use the approach implemented here, we could just skip simplifying if the iterable is empty in <code>simplify_set</code> instead of doing this extra tracking in the resolver. Packages with no versions are represented by a different incompatibility anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-27 03:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-resolver/src/error.rs</code>:195 on 2024-01-27 03:48</div>
            <div class="timeline-body"><p>That feels wrong from a correctness perspective. Doesn&#x27;t it mean we&#x27;re displaying error messages that don&#x27;t represent the current state of the solver?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-27 03:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-resolver/src/error.rs</code>:195 on 2024-01-27 03:53</div>
            <div class="timeline-body"><blockquote>
<p>If we wanted to use the approach implemented here, we could just skip simplifying if the iterable is empty in <code>simplify_set</code> instead of doing this extra tracking in the resolver. Packages with no versions are represented by a different incompatibility anyway.</p>
</blockquote>
<p>This part I don&#x27;t understand (the iterable is <em>not</em> empty today, which is the source of the flake, right? We have no idea if there are no versions of the package that fails this test; we just don&#x27;t know what the versions are yet) but I&#x27;ll defer to you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-01-27 18:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/puffin-resolver/src/error.rs</code>:195 on 2024-01-27 18:34</div>
            <div class="timeline-body"><p>To clarify the current situation, most of the time the iterable is not empty so we say that <code>... depends on bluebird &lt;ranges&gt;</code> and &quot;simplify&quot; the ranges to cover the full range of versions of <code>bluebird</code> available. When the iterable is empty, simplification fails and we enumerate <em>all</em> of the unsimplified ranges of  <code>bluebird</code> that the solver cares about.</p>
<p>If package is present in the derivation tree, we <em>are</em> going to reference it in the error message. The question is whether or not we will ever need to simplify the ranges associated with that package. I&#x27;m struggling to come up with a scenario where this is essential, i.e. where the unsimplified ranges of <code>bluebird</code> are excessively verbose.</p>
<p>I think we should just forward with what you have here until we see real world evidence that simplifying ranges for packages that the solver did not visit is important.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/zanieb">@zanieb</a> on 2024-01-27 18:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-01-27 18:35</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-01-27 18:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/puffin-resolver/src/error.rs</code>:172 on 2024-01-27 18:35</div>
            <div class="timeline-body"><p>This seems clear enough.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-28 03:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-resolver/src/error.rs</code>:195 on 2024-01-28 03:16</div>
            <div class="timeline-body"><p>Ok sounds god -- I will clean this up and merge. Assuming it works, you get all the credit. If it doesn&#x27;t, I will take all the blame.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-28 14:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-28 14:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-01-28 14:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:43:26 UTC
    </footer>
</body>
</html>
