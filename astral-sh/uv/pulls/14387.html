<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preserve original trailing slash if present in `find-links` URLs - astral-sh/uv #14387</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Preserve original trailing slash if present in <code>find-links</code> URLs</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/14387">#14387</a>
        opened by <a href="https://github.com/jtfmumm">@jtfmumm</a>
        on 2025-07-01 09:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/jtfmumm">@jtfmumm</a> on 2025-07-01 09:25</div>
            <div class="timeline-body"><p>As part of #14245 and #14346, uv was normalizing trailing slashes for find-links URLs by removing them. However, find-links URLs have different meanings depending on whether a trailing slash is present (as evidenced in 301 redirects from PyPI and #14367). This PR preserves trailing slashes if present in find-links URLs.</p>
<p>Fixes #14367</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @jtfmumm by @jtfmumm on 2025-07-01 09:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @jtfmumm by @jtfmumm on 2025-07-01 09:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @jtfmumm on 2025-07-01 09:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">do-not-merge</span> added by @jtfmumm on 2025-07-01 09:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-03 13:13</div>
            <div class="timeline-body"><p>I think relying on <code>url.given()</code> is dangerous, I don't think that persists through serialization / deserialization. I think we need to avoid stripping the trailing slash for <code>--find-links</code> URLs in the first place.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Add original trailing slash if missing before `find-links` request" to "Preserve original trailing slash if present on `find-links` URLs" by @jtfmumm on 2025-07-04 08:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-07-04 08:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-distribution-types/src/index_url.rs</code>:130 on 2025-07-04 08:54</div>
            <div class="timeline-body"><p>This logic was moved from the <code>From&lt;VerbatimUrl&gt;</code> implementation. It's unchanged except that the trailing slash is only removed if <code>TrailingSlashPolicy::Remove</code> is passed in.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on 2025-07-04 08:56</div>
            <div class="timeline-body"><blockquote>
<p>I think relying on <code>url.given()</code> is dangerous, I don't think that persists through serialization / deserialization. I think we need to avoid stripping the trailing slash for <code>--find-links</code> URLs in the first place.</p>
</blockquote>
<p>Updated. I've also updated the <code>VerbatimUrl</code> rustdocs in #14456 to make this behavior clearer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Preserve original trailing slash if present on `find-links` URLs" to "Preserve original trailing slash if present in `find-links` URLs" by @jtfmumm on 2025-07-04 09:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">do-not-merge</span> removed by @jtfmumm on 2025-07-04 09:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @jtfmumm on 2025-07-04 09:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-07-04 12:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-distribution-types/src/index_url.rs</code>:53 on 2025-07-04 12:46</div>
            <div class="timeline-body"><p>I don't really like this name. Originally I had it as <code>parse_without_slash_normalization</code>. Could be <code>parse_preserve_trailing_slash</code> but I think <code>parse_preserve_slash</code> isn't enough information?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-07-04 12:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-distribution-types/src/index_url.rs</code>:53 on 2025-07-04 12:47</div>
            <div class="timeline-body"><p>I avoided things like <code>parse_as_given</code> or <code>parse_exact</code> since there could have already been different kinds of normalization prior to this point?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-07-04 12:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-distribution-types/src/index_url.rs</code>:124 on 2025-07-04 12:47</div>
            <div class="timeline-body"><p>Same point as above about the function name</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-07-07 13:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-distribution-types/src/index_url.rs</code>:358 on 2025-07-07 13:40</div>
            <div class="timeline-body"><p>I think we should just get rid of this, since it seems like callers <em>must</em> be cognizant of whether they want to preserve or remove the trailing slash.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-07-07 13:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-distribution-types/src/index_url.rs</code>:53 on 2025-07-07 13:42</div>
            <div class="timeline-body"><p>What if we just use:</p>
<ul>
<li><code>parse_simple_api</code></li>
<li><code>parse_find_links</code></li>
</ul>
<p>And thus not require callers to pass in a trailing slash policy?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-07-07 14:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-distribution-types/src/index_url.rs</code>:53 on 2025-07-07 14:12</div>
            <div class="timeline-body"><p>Yeah that's better. I can follow a similar pattern with the verbatim URL cases: e.g., <code>simple_api_from_verbatim_url</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-07-07 14:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-distribution-types/src/index_url.rs</code>:53 on 2025-07-07 14:21</div>
            <div class="timeline-body"><p>Yeah or <code>from_simple_api_url</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-07-07 15:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-distribution-types/src/index_url.rs</code>:53 on 2025-07-07 15:54</div>
            <div class="timeline-body"><p>Updated</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2025-07-07 18:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2025-07-08 01:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-08 01:25</div>
            <div class="timeline-body"><p>Actually, hmm, there may be one bug here. We call <code>without_trailing_slash</code> in <code>satisfies</code> on all index URLs. But I think that will now be wrong for <code>--find-links</code> URLs? So we'll incorrectly think that the lockfile needs to be updated, since there will be an index URL in the lockfile that doesn't match the &quot;collection&quot; of index URLs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-08 01:27</div>
            <div class="timeline-body"><p>We should probably try to find a way to remove <code>without_trailing_slash</code> there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on 2025-07-08 09:49</div>
            <div class="timeline-body"><blockquote>
<p>Actually, hmm, there may be one bug here. We call <code>without_trailing_slash</code> in <code>satisfies</code> on all index URLs. But I think that will now be wrong for <code>--find-links</code> URLs? So we'll incorrectly think that the lockfile needs to be updated, since there will be an index URL in the lockfile that doesn't match the &quot;collection&quot; of index URLs.</p>
</blockquote>
<p>I think we still need a way to normalize the registry sources we read in from the lockfile, but at that point we no longer know whether it was a Simple API or find-links URL. This leads me to think we should only be normalizing at the point of lockfile validation. I've opened an <a href="https://github.com/astral-sh/uv/pull/14503">alternative PR</a> that takes that approach instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-08 11:20</div>
            <div class="timeline-body"><p>I think normalizing the Simple API URLs is still a good thing, to be honest, since it minimizes churn. Should we just do <em>both</em> things? Normalize, but also make the lockfile validation more lax? I had this in Discord:</p>
<pre><code class="language-diff">diff --git a/crates/uv-distribution-types/src/file.rs b/crates/uv-distribution-types/src/file.rs
index 948378c0c..c227b4266 100644
--- a/crates/uv-distribution-types/src/file.rs
+++ b/crates/uv-distribution-types/src/file.rs
@@ -169,15 +169,6 @@ impl UrlString {
             .map(|(path, _)| Cow::Owned(UrlString(SmallString::from(path))))
             .unwrap_or(Cow::Borrowed(self))
     }
-
-    /// Return the [`UrlString`] (as a [`Cow`]) with trailing slash removed.
-    #[must_use]
-    pub fn without_trailing_slash(&amp;self) -&gt; Cow&lt;'_, Self&gt; {
-        self.as_ref()
-            .strip_suffix('/')
-            .map(|path| Cow::Owned(UrlString(SmallString::from(path))))
-            .unwrap_or(Cow::Borrowed(self))
-    }
 }
 
 impl AsRef&lt;str&gt; for UrlString {
@@ -270,18 +261,4 @@ mod tests {
             Cow::Owned(UrlString(&quot;https://example.com/path?query&quot;.into()))
         );
     }
-
-    #[test]
-    fn without_trailing_slash() {
-        // Borrows a URL without a slash
-        let url = UrlString(&quot;https://example.com/path&quot;.into());
-        assert_eq!(url.without_trailing_slash(), Cow::Borrowed(&amp;url));
-
-        // Removes the trailing slash if present on the URL
-        let url = UrlString(&quot;https://example.com/path/&quot;.into());
-        assert_eq!(
-            url.without_trailing_slash(),
-            Cow::Owned(UrlString(&quot;https://example.com/path&quot;.into()))
-        );
-    }
 }
diff --git a/crates/uv-resolver/src/lock/mod.rs b/crates/uv-resolver/src/lock/mod.rs
index beeadc912..9ae3f0e99 100644
--- a/crates/uv-resolver/src/lock/mod.rs
+++ b/crates/uv-resolver/src/lock/mod.rs
@@ -1437,7 +1437,7 @@ impl Lock {
                     }
                     IndexUrl::Path(_) =&gt; None,
                 })
-                .collect::&lt;BTreeSet&lt;_&gt;&gt;()
+                .collect::&lt;Vec&lt;_&gt;&gt;()
         });
 
         let locals = indexes.map(|locations| {
@@ -1479,10 +1479,9 @@ impl Lock {
                 match index {
                     RegistrySource::Url(url) =&gt; {
                         // Normalize URL before validating.
-                        let url = url.without_trailing_slash();
                         if remotes
                             .as_ref()
-                            .is_some_and(|remotes| !remotes.contains(&amp;url))
+                            .is_some_and(|remotes| !remotes.iter().any(|remote| matches!(remote.as_ref().strip_prefix(url.as_ref()), '' | '/')))
                         {
                             let name = &amp;package.id.name;
                             let version = &amp;package
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-08 12:51</div>
            <div class="timeline-body"><p>If this change would invalidate the lockfile, we should add a test case covering that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-08 12:52</div>
            <div class="timeline-body"><blockquote>
<p>at that point we no longer know whether it was a Simple API or find-links URL</p>
</blockquote>
<p>This is separate, but... we should probably track this in the lockfile, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on 2025-07-08 12:58</div>
            <div class="timeline-body"><blockquote>
<p>I think normalizing the Simple API URLs is still a good thing, to be honest, since it minimizes churn. Should we just do both things? Normalize, but also make the lockfile validation more lax?</p>
</blockquote>
<p>I'm a little concerned that we'll find the trailing slash difference could end up being significant for some implementation of the Simple API down the line, but maybe it's not likely. I've updated this PR to follow the more lax approach, though we need to check if <code>remote</code> is a prefix of <code>url</code> (for the case that the lockfile contains a slash for a Simple API URL).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on 2025-07-08 13:00</div>
            <div class="timeline-body"><blockquote>
<p>If this change would invalidate the lockfile, we should add a test case covering that.</p>
</blockquote>
<p>Do you mean the more lax approach change? What scenario are you thinking of?</p>
<p>There are tests that check different combinations of trailing slashes in user-provided URLs vs. lockfile URLs to ensure validation still succeeds. Those still pass with this change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-08 13:22</div>
            <div class="timeline-body"><p>I'm referring to the scenario described in this comment: https://github.com/astral-sh/uv/pull/14387#issuecomment-3047046094</p>
<p>Is that not correct?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-08 13:23</div>
            <div class="timeline-body"><p>Regarding the &quot;lax&quot; approach, if a trailing slash on the find-links URL has semantic meaning, we should invalidate the lockfile if someone adds a trailing slash or removes it, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-08 13:25</div>
            <div class="timeline-body"><p>I considered that too, but I don't see how it would succeed in the first place if the trailing slash is required (or vice versa).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-08 13:34</div>
            <div class="timeline-body"><p>It could just change the result of the resolution, right? i.e., the find-links index returns no packages vs some packages?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-08 14:35</div>
            <div class="timeline-body"><p>I think that's possible in theory, it just seems really unlikely in practice. I agree that the right solution here is probably to track <code>--find-links</code> indexes with a different prefix in the lockfile. I don't know if we want to do that here, or in v0.8, or what. But we should <em>definitely</em> get a fix out for this ASAP even if imperfect since it's breaking real user workflows.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on 2025-07-09 09:49</div>
            <div class="timeline-body"><p>Closing in favor of #14511</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @jtfmumm on 2025-07-09 09:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:27 UTC
    </footer>
</body>
</html>
