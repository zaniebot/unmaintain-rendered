<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add missing git feature dep to preserve_executable_bit test - astral-sh/uv #12850</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add missing git feature dep to preserve_executable_bit test</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/12850">#12850</a>
        opened by <a href="https://github.com/mgorny">@mgorny</a>
        on 2025-04-12 11:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mgorny">@mgorny</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Without the <code>git</code> feature, it fails with:</p>
<pre><code>error: Failed to initialize Git repository at `/home/mgorny/.local/share/uv/tests/.tmp01wGGK/temp/preserve_executable_bit`
stdout:
stderr: error: `git` operations are not allowed â€” are you missing a cfg for the `git` feature?
</code></pre>
<h2>Test Plan</h2>
<pre><code>cargo test --features python --profile=fast-build --no-default-features</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-04-14 12:28</div>
            <div class="timeline-body"><p>@konstin -- Do you know why this test uses Git? I think <code>uv init</code> is meant to be robust to a missing <code>git</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2025-04-14 12:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-04-14 13:07</div>
            <div class="timeline-body"><p>We first check if we are in a git repository in <code>uv init</code>. If that fails, we fall back to assuming VCS defaults (init a git repo). We don't check the error condition, so both <code>fatal: not a git repository (or any of the parent directories): .git</code> and our git blocking shim cause this path. We then try to init a git repo, but in that case we only ignore a missing git installation, but fail at the git blocking shim.</p>
<p>Can we rely on errors such as <code>not a git repository</code> being stable? If so, we could differentiate between the two cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @konstin on 2025-04-14 13:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-04-14 13:11</div>
            <div class="timeline-body"><p>But doesn't &quot;init a Git repo&quot; return <code>VersionControlError::GitNotInstalled</code>, which we explicitly handle?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-04-14 14:27</div>
            <div class="timeline-body"><p>Our shims put a <code>git</code> in <code>PATH</code> so we're falling in a gap where git is installed (<code>which git</code> find the git-not-allowed shim), but invoking git errors with the error seen above:</p>
<p>First we take the <code>None</code>-branch, since detecting an existing git repo errors (through the shim):</p>
<p>https://github.com/astral-sh/uv/blob/0c801f8f4bd187a1555b029e6e1e9b7332b0971c/crates/uv-configuration/src/vcs.rs#L97</p>
<p>But that was a check for an existing git repo, so we ignore it:</p>
<p>https://github.com/astral-sh/uv/blob/42dcea0ee2a38d949e54e05a2ef1608f9f5fff73/crates/uv/src/commands/project/init.rs#L1203</p>
<p>When we finally initialize the repo, we can run the git shim, but it errors on execution:</p>
<p>https://github.com/astral-sh/uv/blob/0c801f8f4bd187a1555b029e6e1e9b7332b0971c/crates/uv-configuration/src/vcs.rs#L52</p>
<p>If we want to handle this better, we should find a way to better tell apart &quot;there is no git repo&quot; (this is fine) from &quot;git errored&quot; (don't use git at all) in the first check.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-04-15 10:52</div>
            <div class="timeline-body"><p>I tried to make this more resilient: #12895</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2025-05-18 21:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-05-18 21:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:42:47 UTC
    </footer>
</body>
</html>
