<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enable self-benchmarking for Puffin branches in bench.py - astral-sh/uv #804</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Enable self-benchmarking for Puffin branches in bench.py</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/804">#804</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-01-05 22:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>This PR enables the use of the <code>bench.py</code> script to benchmark Puffin itself. This is something I often do by via a process like:</p>
<ul>
<li>Checkout the <code>main</code> branch (or any other baseline branch)</li>
<li>Run: <code>cargo build --release</code></li>
<li>Run: <code>mv ./target/release/puffin ./target/release/baseline</code></li>
<li>Checkout a development branch</li>
<li>Run: <code>cargo build --release</code></li>
<li>(New) Run: <code>python bench.py --tool puffin --path ./target/release/puffin --tool puffin --path ./target/release/baseline requirements.in</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-01-05 22:15</div>
            <div class="timeline-body"><p>Cool!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-05 22:17</div>
            <div class="timeline-body"><p>Is this better or worse than an API wherein you can specify the Puffin binaries yourself? Like: <code>python scripts/bench.py requirements.in --binary puffin --binary baseline</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-01-05 22:28</div>
            <div class="timeline-body"><p>Specifying the binary paths manually seems a bit nicer, but I don&#x27;t quite see how it would work with your example? Don&#x27;t you need to specify both the enum member and the path?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-05 23:30</div>
            <div class="timeline-body"><p>Yeah, you do need to specify both, but Puffin is included by default as a member so it can be omitted.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-05 23:30</div>
            <div class="timeline-body"><p>I&#x27;ll make that change. Then I have another idea for making these composable so that we can get a single Hyperfine report, which will be much nicer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-01-05 23:31</div>
            <div class="timeline-body"><p>To clarify, in <code>--binary puffin --binary baseline</code> where am I specifying the path to the binary and where am I saying which tool the binary is for?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-05 23:32</div>
            <div class="timeline-body"><p>They&#x27;re both Puffin binaries, just compiled from different branches (by you, out-of-band). They <em>have</em> to be Puffin binaries.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-01-06 00:33</div>
            <div class="timeline-body"><p>Hm it&#x27;s not really clear which one is the baseline in that case. I guess I&#x27;d expect to be able to set the path to <em>any</em> of the tools. e.g. <code>--&lt;enum&gt; &lt;path&gt;</code> or <code>--&lt;enum&gt;-binary &lt;path&gt;</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-06 02:42</div>
            <div class="timeline-body"><p>Good idea, I will try to do something more general.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-06 03:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-06 03:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-06 03:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-01-06 03:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-01-06 05:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>scripts/bench/__main__.py</code>:724 on 2024-01-06 05:53</div>
            <div class="timeline-body"><p>This seems like an awkward API. If you want to provide a path for one tool you must provide a path for all tools? If you provide a path without specifying tools it&#x27;ll apply to the first default tool?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-06 11:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>scripts/bench/__main__.py</code>:724 on 2024-01-06 11:50</div>
            <div class="timeline-body"><p>They&#x27;re <code>None</code>-padded parallel arrays. I originally allowed <code>--tool puffin:./path/to/binary</code> but that felt even worse since you then don&#x27;t get argparse validation or help messages since the argument is custom. What do you prefer? Your original suggestion seemed to require that we have command-line arguments for every tool (like <code>--pip</code>) which strikes me as structurally wrong.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-06 13:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>scripts/bench/__main__.py</code>:724 on 2024-01-06 13:59</div>
            <div class="timeline-body"><p>I think I will just change back to <code>script --enum value1=/path/to/file1 --enum value2=/path/to/file2</code> or <code>script --enum value1:path/to/file1 --enum value2:path/to/file2</code> (where the path is optional and omitted) given that this seems confusing. The downside is that we can&#x27;t use <code>choices</code> (since we now parse arbitrary string values), and you also don&#x27;t get autocomplete on tab to the file when writing out the command on the CLI since it&#x27;s part of a composed string argument.</p>
<p>We can&#x27;t allow <code>script --enum value1 /path/to/file1 --enum value2 /path/to/file2</code> since we need to accept the requirements file as a positional argument so this would introduce ambiguity (is <code>/path/to/file1</code> the path to the binary, or the requirements file?).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-01-06 15:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>scripts/bench/__main__.py</code>:724 on 2024-01-06 15:44</div>
            <div class="timeline-body"><p>While having a command line argument for every tool feels structurally weird, it&#x27;s definitely the most usable as it should have all of the hints you&#x27;d expect. It&#x27;s pretty trivial to iterate over the choices to generate the options. I feel like since it&#x27;s an internal tool with a reasonably small upper bound on the number of choices I&#x27;d go with this.</p>
<p>The <code>:</code> split parsing seems hard to use. I wouldn&#x27;t go back to that :/</p>
<p>Anyway probably doesn&#x27;t matter to much! Easy enough to change latter. Do what you want :)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:43:05 UTC
    </footer>
</body>
</html>
