<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove unnecessary uses of `DashMap` and `Arc` - astral-sh/uv #3413</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Remove unnecessary uses of <code>DashMap</code> and <code>Arc</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/3413">#3413</a>
        opened by <a href="https://github.com/ibraheemdev">@ibraheemdev</a>
        on 2024-05-06 16:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-05-06 16:52</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>All of the resolver code is run on the main thread, so a lot of the <code>Send</code> bounds and uses of <code>DashMap</code> and <code>Arc</code> are unnecessary. We could also switch to using single-threaded versions of <code>Mutex</code> and <code>Notify</code> in some places, but there isn't really a crate that provides those I would be comfortable with using.</p>
<p>The <code>Arc</code> in <code>OnceMap</code> can't easily be removed because of the uv-auth code which uses the <a href="https://docs.rs/reqwest-middleware/latest/reqwest_middleware/trait.Middleware.html">reqwest-middleware</a> crate, that seems to adds unnecessary <code>Send</code> bounds because of <code>async-trait</code>. We could duplicate the code and create a <code>OnceMapLocal</code> variant, but I don't feel that's worth it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2024-05-06 16:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/uv-resolver/src/resolver/mod.rs</code>:144 on 2024-05-06 16:56</div>
            <div class="timeline-body"><p>:relieved:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-05-06 17:00</div>
            <div class="timeline-body"><blockquote>
<p>All of the resolver code is run on the main thread, so a lot of the <code>Send</code> bounds and uses of <code>DashMap</code> and <code>Arc</code> are unnecessary.</p>
</blockquote>
<p>Is the resolver running on just the main thread what we want? If we wanted it to make use of multiple threads in the future (even as an experiment to try?), then adding these <code>Send</code> bounds back could be pretty annoying. (I'm not sure our uses of <code>DashMap</code> and <code>Arc</code> are costing us much, but maybe I'm wrong about that. Of course, if we don't need them, then I agree with this PR.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @ibraheemdev on 2024-05-06 17:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-05-06 17:04</div>
            <div class="timeline-body"><p>@BurntSushi That's a good point. I'll mark this as a draft for now before we settle down on our async architecture. I agree we probably don't pay much of a cost for using <code>DashMap</code>/<code>Arc</code> on a single-thread.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/resolver/mod.rs</code>:144 on 2024-05-06 17:11</div>
            <div class="timeline-body"><p>Love that!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-06 17:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ibraheemdev on 2024-05-06 17:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-05-06 17:33</div>
            <div class="timeline-body"><p>Actually I'm going to take that back. Making any of the resolver or installer code multi-threaded would be very hard because of the <code>'a</code> lifetime that proliferates throughout the codebase. The changes required to do that would be significantly more than reverting this commit. I'd also be surprised to see any gain from making those changes that we couldn't get by optimizing our use of the single threaded scheduler, given our scale of I/O.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-05-06 17:49</div>
            <div class="timeline-body"><p>I'm supportive of the change, though good to get @BurntSushi sign-off too before merging since he chimed in with comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @charliermarsh on 2024-05-06 17:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2024-05-06 17:58</div>
            <div class="timeline-body"><p>This LGTM. I'm overall in favor of simplifying the code as it exists under current constraints, and if we find ourselves needing to add this (or something like it) back, then it doesn't seem that horrible to do.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-05-07 02:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-05-07 02:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 14:38:13 UTC
    </footer>
</body>
</html>
