<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build backend: Switch to custom glob-walkdir implementation - astral-sh/uv #9013</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Build backend: Switch to custom glob-walkdir implementation</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/9013">#9013</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2024-11-11 10:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/konstin">@konstin</a> on 2024-11-11 10:55</div>
            <div class="timeline-body"><p>When doing a directory traversal for source dist inclusion, we want to offer the user include and exclude options, and we want to avoid traversing irrelevant directories. The latter is important for performance, especially on network file systems, but also with large data directories, or (not-included) directories with other permissions. To support this, we introduce <code>GlobDirFilter</code>, which uses a DFA from regex_automata to determine whether any children of a directory can be included and skips the directory if not.</p>
<p>The globs are based on PEP 639. The syntax is more restricted than glob or globset, but it's standardized. I chose it over glob or globset because we're already using this syntax for <code>project.license-files</code> a required by PEP 639, so it makes sense to use the same globs for all includes (see e.g. https://github.com/google-deepmind/alphafold3/blob/4f52a3bb624fd7245fb1ad0bf62d752ffa46f0ce/pyproject.toml#L36-L48 for example with same semantics for include and exclude)</p>
<h3>Semantics</h3>
<p>Glob semantics are complex due to mixing directories and files, expectations around simplicity and our need to exclude most of the tree in the project from traversal. The current draft uses a syntax that optimizes for simple default use cases for the start.</p>
<h4>includes</h4>
<p>Glob expressions which files and directories to include in the source distribution.</p>
<p>Includes are anchored, which means that <code>pyproject.toml</code> includes only
<code>&lt;project root&gt;/pyproject.toml</code>. Use for example <code>assets/**/sample.csv</code> to include for all
<code>sample.csv</code> files in <code>&lt;project root&gt;/assets</code> or any child directory. To recursively include
all files under a directory, use a <code>/**</code> suffix, e.g. <code>src/**</code>. For performance and
reproducibility, avoid unanchored matches such as <code>**/sample.csv</code>.</p>
<p>The glob syntax is the reduced portable glob from
<a href="https://peps.python.org/pep-0639/#add-license-FILES-key">PEP 639</a>.</p>
<h4>excludes</h4>
<p>Glob expressions which files and directories to exclude from the previous source
distribution includes.</p>
<p>Excludes are not, which means that <code>__pycache__</code> excludes all directories named
<code>__pycache__</code> and it's children anywhere. To anchor a directory, use a <code>/</code> prefix, e.g.,
<code>/dist</code> will exclude only <code>&lt;project root&gt;/dist</code>.</p>
<p>The glob syntax is the reduced portable glob from
<a href="https://peps.python.org/pep-0639/#add-license-FILES-key">PEP 639</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-11-11 10:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>Cargo.lock</code>:1 on 2024-11-11 10:57</div>
            <div class="timeline-body"><p>We aren't actually adding any new dep.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-11-11 10:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-build-backend/src/pep639_glob.rs</code>:1 on 2024-11-11 10:59</div>
            <div class="timeline-body"><p>moved to the new crate and edited</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-11-11 10:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-build-backend/src/pep639_glob/tests.rs</code>:1 on 2024-11-11 10:59</div>
            <div class="timeline-body"><p>moved to the new crate and edited</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-11-11 11:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-globfilter/src/main.rs</code>:1 on 2024-11-11 11:03</div>
            <div class="timeline-body"><p>currently useful, we can drop it eventually</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @konstin on 2024-11-13 12:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @konstin on 2024-11-13 12:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-11-13 12:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-globfilter/src/glob_dir_filter.rs</code>:41 on 2024-11-13 12:18</div>
            <div class="timeline-body"><p>This is a different strategy than globset, it avoids normalizing the path itself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-globfilter/src/glob_dir_filter.rs</code>:8 on 2024-11-13 19:39</div>
            <div class="timeline-body"><p>This is probably fine. Or at least, as a whim, I don't see this being a huge issue, especially given the restricted glob syntax.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-globfilter/src/glob_dir_filter.rs</code>:41 on 2024-11-13 19:40</div>
            <div class="timeline-body"><p>Hmmm, what if the path has both a <code>/</code> and a <code>\</code> in it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-globfilter/src/glob_dir_filter.rs</code>:102 on 2024-11-13 19:48</div>
            <div class="timeline-body"><p>I believe this is one of the few places where <a href="https://doc.rust-lang.org/std/ffi/struct.OsStr.html#method.as_encoded_bytes"><code>OsStr::as_encoded_bytes</code></a> is appropriate! This is great because it will avoid an alloc and a UTF-8 validation scan.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-globfilter/src/glob_dir_filter.rs</code>:111 on 2024-11-13 19:50</div>
            <div class="timeline-body"><p>I think this makes sense to me. Nice edge cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2024-11-13 19:50</div>
            <div class="timeline-body"><p>Pretty sweet! Have a few comments but this overall LGTM!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-11-14 12:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-globfilter/src/glob_dir_filter.rs</code>:41 on 2024-11-14 12:51</div>
            <div class="timeline-body"><p>Good question, can we reasonably support this? Given that we want to (need to) be cross platform, should we error if we ever encounter any path with a <code>/</code> (windows) or a <code>\</code> (linux) inside a component?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-11-14 12:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-globfilter/src/glob_dir_filter.rs</code>:102 on 2024-11-14 12:53</div>
            <div class="timeline-body"><blockquote>
<p>1.74.0</p>
</blockquote>
<p>I've waited for this method for years :tada:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @konstin on 2024-11-14 13:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2024-11-14 13:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2024-11-14 13:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-14 13:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-11-14 13:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-globfilter/src/glob_dir_filter.rs</code>:102 on 2024-11-14 13:41</div>
            <div class="timeline-body"><p>Been about a decade for me hah.</p>
<p>(Although I've always been skeptical of stabilizing it too, because it makes it much easier to use WTF-8 as an interchange format, which is not supposed to happen.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-11-14 13:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-globfilter/src/glob_dir_filter.rs</code>:41 on 2024-11-14 13:43</div>
            <div class="timeline-body"><p>Oh hmmm, not within a component. What I mean is that I've seen Windows paths where <code>\</code> and <code>/</code> are inter-mingled. For example, <code>C:\Users\andrew\home/bin/whatever</code>. Or at least, I think I have... So in that circumstance, <code>\</code> and <code>/</code> would both be a separator.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:14 UTC
    </footer>
</body>
</html>
