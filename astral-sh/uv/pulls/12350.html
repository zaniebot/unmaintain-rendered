<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add dependents (&quot;via ...&quot; comments) in export command - astral-sh/uv #12350</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add dependents (&quot;via ...&quot; comments) in export command</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/12350">#12350</a>
        opened by <a href="https://github.com/zmeir">@zmeir</a>
        on 2025-03-20 22:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/zmeir">@zmeir</a> on 2025-03-20 22:25</div>
            <div class="timeline-body"><p>Adding dependency trace/parent comments (&quot;via ...&quot;) to the export command output.<br />
This is a similar behavior to the pip compile output.</p>
<h4>Note to the eager reviewer:</h4>
<p>First of all - thanks!<br />
Secondly, this is still a very rough draft. These are the first lines of code I've ever written in Rust. This is still mostly an educational/fun exercise for myself. If opening a Draft PR is creating too much noise - I apologize and I will close it until it is ready.</p>
<h2>Summary</h2>
<p>Resolves #7777</p>
<h2>Test Plan</h2>
<ul>
<li>[X] manual command execution</li>
<li>[x] update expected output in tests</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @zanieb on 2025-03-21 18:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Add dependency parents ("via" comments) in export command" to "Add dependents ("via ..." comments) in export command" by @zmeir on 2025-03-23 21:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-03-26 20:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/lock/requirements_txt.rs</code>:319 on 2025-03-26 20:17</div>
            <div class="timeline-body"><p>What is the purpose of this sort?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-03-26 20:18</div>
            <div class="timeline-body"><p>This looks pretty reasonable overall.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-03-27 12:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/lock/requirements_txt.rs</code>:319 on 2025-03-27 12:58</div>
            <div class="timeline-body"><p>I think I would've expected us to sort by name rather than degree.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zmeir">@zmeir</a> on <code>crates/uv-resolver/src/lock/requirements_txt.rs</code>:319 on 2025-03-27 20:53</div>
            <div class="timeline-body"><p>The purpose is to put on top any dependents that have the root as a direct dependent. This being the current project.</p>
<p>This is before sorting:
<img width="385" alt="image" src="https://github.com/user-attachments/assets/61cfa161-bfc8-4f5d-adb4-cccc6f3d7e6d" /></p>
<p>And this is after:
<img width="385" alt="image" src="https://github.com/user-attachments/assets/b4939efd-ee13-4fe0-a815-08f55005f6fa" /></p>
<p>I will add a secondary sort by name</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zmeir">@zmeir</a> reviewed on 2025-03-27 20:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2025-03-27 21:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @charliermarsh on 2025-03-27 21:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-03-27 21:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/lock/requirements_txt.rs</code>:319 on 2025-03-27 21:14</div>
            <div class="timeline-body"><p>Personally I think I'd prefer to sort by name -- it's a little easier to parse visually since it's predictable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zmeir">@zmeir</a> reviewed on 2025-03-27 21:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zmeir">@zmeir</a> on <code>crates/uv-resolver/src/lock/requirements_txt.rs</code>:319 on 2025-03-27 21:54</div>
            <div class="timeline-body"><p>Do you mean just by name or first the project and then the rest of the dependents by name?</p>
<p>I tried to be consistent with the output of <code>uv pip compile</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zmeir on 2025-03-27 21:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zmeir">@zmeir</a> on 2025-03-27 21:59</div>
            <div class="timeline-body"><p>Thanks for your review @charliermarsh, I think this is just about ready.</p>
<p>I've updated the sorting as discussed <a href="https://github.com/astral-sh/uv/pull/12350#discussion_r2017587628">here</a>. If you would like me to change it please let me know.</p>
<p>I've also added a CLI option: <code>--no-annotate</code>, similarly to <code>uv pip compile</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-03-28 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/lock/requirements_txt.rs</code>:319 on 2025-03-28 13:54</div>
            <div class="timeline-body"><p>I was proposing sorting <em>just</em> by the dependent name. Doesn't <code>uv pip compile</code> just sort by name?</p>
<pre><code class="language-rust">let mut dependents = graph
    .edges_directed(index, Direction::Incoming)
    .map(|edge| &amp;graph[edge.source()])
    .map(uv_distribution_types::Name::name)
    .collect::&lt;Vec&lt;_&gt;&gt;();
dependents.sort_unstable();
dependents.dedup();
dependents
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2025-03-28 14:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2025-03-28 14:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-03-28 14:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eliasecchig">@eliasecchig</a> on 2025-04-02 15:13</div>
            <div class="timeline-body"><p>can you consider changing the behavior so to no-annotate by default?</p>
<p>This is breaking many frameworks depending on uv</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-04-02 15:15</div>
            <div class="timeline-body"><p>Sorry, can you expand on that comment? What frameworks are depending on uv, and why are they breaking here? Comments are part of the output format.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eliasecchig">@eliasecchig</a> on 2025-04-02 15:24</div>
            <div class="timeline-body"><p>The default output of a <code>uv export</code> command changed between <code>uv &lt;= 0.6.10</code> and <code>uv &gt;= 0.6.11</code>, representing a <strong>backwards-incompatible change.</strong></p>
<p>I am using uv and the <code>export</code> command as part of a public project - see<a href="https://github.com/GoogleCloudPlatform/agent-starter-pack/blob/main/src/base_template/deployment/cd/staging.yaml#L121C1-L122C1"> this line</a></p>
<pre><code class="language-bash"> uv export --no-hashes --no-sources --no-header --no-emit-project --frozen &gt; .requirements.txt
</code></pre>
<p><strong>In short the same command:</strong></p>
<ul>
<li><code>uv &lt;= 0.6.10</code>: Produces <strong>Output X</strong></li>
<li><code>uv &gt;= 0.6.11</code>: Produces <strong>Output Y</strong></li>
</ul>
<p>Hence why my request is to ensure <code>--no-annotate</code> is the default option.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-04-02 15:28</div>
            <div class="timeline-body"><p>Right, but the output is still a valid <code>requirements.txt</code> file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-04-02 15:29</div>
            <div class="timeline-body"><p>Sorry, but a change in the output is not considered a breaking change if the <em>format</em> is unchanged. Here, we've just added comments that are compatible with the file format.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eliasecchig">@eliasecchig</a> on 2025-04-02 15:36</div>
            <div class="timeline-body"><p>Understood, I will deal with it on my side thanks!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:22 UTC
    </footer>
</body>
</html>
