<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add support for dynamic cache keys - astral-sh/uv #7136</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add support for dynamic cache keys</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/7136">#7136</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-09-06 21:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>This PR adds a more flexible cache invalidation abstraction for uv, and uses that new abstraction to improve support for dynamic metadata.</p>
<p>Specifically, instead of relying solely on a timestamp, we now pass around a <code>CacheInfo</code> struct which (as of now) contains <code>Option&lt;Timestamp&gt;</code> and <code>Option&lt;Commit&gt;</code>. The <code>CacheInfo</code> is saved in <code>dist-info</code> as <code>uv_cache.json</code>, so we can test already-installed distributions for cache validity (along with testing <em>cached</em> distributions for cache validity).</p>
<p>Beyond the defaults (<code>pyproject.toml</code>, <code>setup.py</code>, and <code>setup.cfg</code> changes), users can also specify additional cache keys, and it&#x27;s easy for us to extend support in the future. Right now, cache keys can either be instructions to include the current commit (for <code>setuptools_scm</code> and similar) or file paths (for <code>hatch-requirements-txt</code> and similar):</p>
<pre><code>[tool.uv]
cache-keys = [{ file = &quot;requirements.txt&quot; }, { git = true }]
</code></pre>
<p>This change should be fully backwards compatible.</p>
<p>Closes <a href="https://github.com/astral-sh/uv/issues/6964">astral-sh/uv#6964</a>.</p>
<p>Closes <a href="https://github.com/astral-sh/uv/issues/6255">astral-sh/uv#6255</a>.</p>
<p>Closes <a href="https://github.com/astral-sh/uv/issues/6860">astral-sh/uv#6860</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-06 21:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/BurntSushi">@BurntSushi</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-06 21:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-06 21:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-06 21:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-06 21:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cache</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-06 21:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-06 21:18</div>
            <div class="timeline-body"><p>Going to move the <a href="https://github.com/astral-sh/uv/issues/7028">astral-sh/uv#7028</a> part into its own commit, since it&#x27;s largely independent.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Add support for dynamic cache keys and build settings&quot; to &quot;Add support for dynamic cache keys&quot; by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-06 21:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>docs/reference/settings.md</code>:102 on 2024-09-09 14:37</div>
            <div class="timeline-body"><pre><code></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>docs/reference/settings.md</code>:91 on 2024-09-09 14:41</div>
            <div class="timeline-body"><p>Given that we always read the default three files, should this be called <code>extend-cache-keys</code>, mirroring ruff&#x27;s <code>extend-</code> settings?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-cache-info/src/cache_info.rs</code>:15 on 2024-09-09 14:43</div>
            <div class="timeline-body"><p>This struct needs a docstring what it represents, <code>timestamp</code> whose timestamp it covers</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-cache-info/src/cache_info.rs</code>:45 on 2024-09-09 14:47</div>
            <div class="timeline-body"><pre><code>    /// Compute the cache info from the root of a source tree.
    pub fn from_directory(directory: &amp;Path) -&gt; io::Result&lt;Self&gt; {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-cache-info/src/cache_info.rs</code>:101 on 2024-09-09 14:48</div>
            <div class="timeline-body"><pre><code>    /// Compute the cache info for an sdist or wheel archive.
    pub fn from_file(path: impl AsRef&lt;Path&gt;) -&gt; Result&lt;Self, io::Error&gt; {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-cache-info/src/cache_info.rs</code>:35 on 2024-09-09 14:49</div>
            <div class="timeline-body"><pre><code>    /// Compute the cache info for a path (including file) dependency. 
    pub fn from_path(path: &amp;Path) -&gt; io::Result&lt;Self&gt; {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-cache-info/src/cache_info.rs</code>:126 on 2024-09-09 14:50</div>
            <div class="timeline-body"><p>Is that for backwards compatibility?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-cache-info/src/cache_info.rs</code>:148 on 2024-09-09 14:50</div>
            <div class="timeline-body"><p>We&#x27;re developing quite a sprawl of pyproject.toml subsets that we&#x27;re re-reading</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/pip_install.rs</code>:3119 on 2024-09-09 15:01</div>
            <div class="timeline-body"><p>What&#x27;s the invalid part here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/install-wheel-rs/Readme.md</code>:3 on 2024-09-09 15:03</div>
            <div class="timeline-body"><p>I&#x27;d drop this file, it has changed a lot from just being a reimplementation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-cache-info/src/commit_info.rs</code>:3 on 2024-09-09 15:05</div>
            <div class="timeline-body"><p>It&#x27;s always the 40 char hex representation, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-09-09 15:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-09-09 17:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/pip_install.rs</code>:3119 on 2024-09-09 17:02</div>
            <div class="timeline-body"><p>I think it&#x27;s that the cache is invalidated, not that anything is invalid.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-09-09 17:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/pip_install.rs</code>:3162 on 2024-09-09 17:03</div>
            <div class="timeline-body"><p>Nit: Can we say like &quot;Installing again&quot;? Reinstall implies <code>--reinstall</code> to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-09-09 17:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>docs/reference/settings.md</code>:91 on 2024-09-09 17:05</div>
            <div class="timeline-body"><p>I don&#x27;t feel strongly about this, but we don&#x27;t use <code>extend-</code> at all in uv yet and you won&#x27;t be able to change the base cache keys so I don&#x27;t think it&#x27;s necessary here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-09-09 17:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-09-09 18:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/pip_install.rs</code>:3119 on 2024-09-09 18:04</div>
            <div class="timeline-body"><p>ah i misread invalidate as invalid</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-09-09 18:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>docs/reference/settings.md</code>:91 on 2024-09-09 18:32</div>
            <div class="timeline-body"><p>I&#x27;m not particular on the specific naming, but i think it&#x27;s an odd design that we expose a <code>cache-keys</code> setting that then doesn&#x27;t let you configure the cache keys, but add files/git to our immutable defaults.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-09-09 18:37</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/uv/branches/charlie/dynamic-cache">CodSpeed Performance Report</a>
Merging #7136 will <strong>not alter performance</strong>
<p>Comparing <code>charlie/dynamic-cache</code> (d366c7e) with <code>main</code> (9a7262c)</p>
Summary
<p><code>✅ 14</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-09-09 18:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>docs/reference/settings.md</code>:91 on 2024-09-09 18:38</div>
            <div class="timeline-body"><p>What if we make our current settings a default, and this overrides them?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-09-09 18:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>docs/reference/settings.md</code>:91 on 2024-09-09 18:44</div>
            <div class="timeline-body"><p>I&#x27;d find that more intuitive. It&#x27;s a bit annoying that you have to re-specify <code>pyproject.toml</code> and/or <code>setup.py</code>, which i assumed that&#x27;s what you wanted to avoid with that design; but personally i like just specifying all relevant files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-09-09 18:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>docs/reference/settings.md</code>:91 on 2024-09-09 18:45</div>
            <div class="timeline-body"><p>Certainly an option, but are there cases where you would actually want to ignore changes to those other files?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sbidoul">@sbidoul</a> on 2024-09-09 18:53</div>
            <div class="timeline-body"><p>Ooh, this is interesting. ❤️
Could file accept a glob pattern?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-09 18:56</div>
            <div class="timeline-body"><p>I don&#x27;t see why not, though it will get slower as you add more files hah.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-09 18:56</div>
            <div class="timeline-body"><p>Can you give an example of how you&#x27;d use it? Just curious.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sbidoul">@sbidoul</a> on 2024-09-09 19:08</div>
            <div class="timeline-body"><p>In Odoo projects (using the hatch-odoo build backend), we have dynamic dependencies computed from Odoo addons manifests. So I&#x27;d use <code>odoo/addons/*/__manifest__.py</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-09-09 19:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>docs/reference/settings.md</code>:91 on 2024-09-09 19:10</div>
            <div class="timeline-body"><p>I guess one upside is that we could document the default more clearly...? I&#x27;m torn here though, I guess I don&#x27;t feel strongly either way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-09 20:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-09 20:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-09-09 20:19</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:48:07 UTC
    </footer>
</body>
</html>
