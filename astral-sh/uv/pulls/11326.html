<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set `UV` to the uv executable path - astral-sh/uv #11326</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Set <code>UV</code> to the uv executable path</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/11326">#11326</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2025-02-07 18:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-07 18:40</div>
            <div class="timeline-body"><p>Closes https://github.com/astral-sh/uv/issues/8775</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @zanieb on 2025-02-07 18:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-02-07 18:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/lib.rs</code>:65 on 2025-02-07 18:47</div>
            <div class="timeline-body"><p>We do this eagerly / early so it's available in any child process we might spawn.</p>
<p>I think this is better than special-casing, e.g., <code>uv run</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zanieb on 2025-02-07 18:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @Gankra by @zanieb on 2025-02-07 18:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @zanieb on 2025-02-07 18:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @zanieb on 2025-02-07 18:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @BurntSushi removed by @zanieb on 2025-02-07 18:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-02-07 18:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv/src/lib.rs</code>:65 on 2025-02-07 18:54</div>
            <div class="timeline-body"><p>Note that in Rust 2024, this function will be <a href="https://doc.rust-lang.org/edition-guide/rust-2024/newly-unsafe-functions.html#stdenvset_var-remove_var">marked <code>unsafe</code></a>.</p>
<p>What does special-casing entail?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-02-07 18:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/lib.rs</code>:65 on 2025-02-07 18:58</div>
            <div class="timeline-body"><p>We'd need to implement passing this through to every subprocess call (or some subset of them).</p>
<p>I think it's safe here, since we're ~single threaded and we're the only one using this variable. We could move it before we start the tokio runtime for additional &quot;safety&quot;, but it's more obvious to put it here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-02-07 19:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/lib.rs</code>:65 on 2025-02-07 19:15</div>
            <div class="timeline-body"><p>I moved it earlier and into an unsafe block</p>
<p>https://github.com/astral-sh/uv/pull/11326/commits/17aab2f1f5302b416e9c869949bed4f1631af285</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-02-07 19:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/lib.rs</code>:65 on 2025-02-07 19:17</div>
            <div class="timeline-body"><p>I think marking this as unsafe and putting it there is just &quot;best practice&quot;. I have no practical concerns here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @zanieb on 2025-02-07 19:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-07 19:59</div>
            <div class="timeline-body"><p>Technically, this could be breaking as we'll now overwrite <code>UV</code> if set by a parent (e.g., if the user has this set to something).</p>
<p>We could avoid setting it in that case? But it also seems correct to set it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-02-07 20:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv/src/lib.rs</code>:1870 on 2025-02-07 20:01</div>
            <div class="timeline-body"><p>Nit: can move part of the comment above to a <code>SAFETY:</code> comment here right above <code>unsafe</code>? It's convention for discharging proof obligations when using <code>unsafe</code>. So basically:</p>
<pre><code class="language-rust">// SAFETY: This is safe because we are running it
// early in `main` before spawning any threads.
</code></pre>
<p>And actually, if you can, I'd move this to be literally as early as possible. e.g., Before arg parsing. Like, it would be surprising if Clap started spinning up threads and mutating env vars, but it's not the craziest thing I've ever heard of.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-02-07 20:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv/src/lib.rs</code>:1870 on 2025-02-07 20:02</div>
            <div class="timeline-body"><p>Even putting it in actual <code>main</code> if possible. Otherwise you need to mark this <code>main</code> function as <code>unsafe</code> too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-02-07 20:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/lib.rs</code>:1870 on 2025-02-07 20:03</div>
            <div class="timeline-body"><p>My thinking there was... if we have something that needs to respect the <code>UV</code> from the parent.. that'd be the opportunity to do it. I think that's fine to defer until we have a use-case though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-02-07 20:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv/src/lib.rs</code>:1870 on 2025-02-07 20:04</div>
            <div class="timeline-body"><p>See https://docs.rs/dtolnay/latest/dtolnay/macro._03__soundness_bugs.html for more about soundness. Basically, if this <code>main</code> function isn't marked as <code>unsafe</code> and it stays as-is, then one would call it &quot;unsound&quot; because this is a library routine that can't control where it's called.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-02-07 20:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/lib.rs</code>:1870 on 2025-02-07 20:07</div>
            <div class="timeline-body"><p>Addressed the first comment in https://github.com/astral-sh/uv/pull/11326/commits/ede000d221f912fec6b694732aa51b88ebe706b9 â€” accidentally amended out of habit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-02-07 20:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/lib.rs</code>:1870 on 2025-02-07 20:09</div>
            <div class="timeline-body"><p>We.. could do that.. but then it'd break this functionality for someone that did call uv via <code>main</code> and we already do have this big warning</p>
<pre><code>/// WARNING: This entry point is not recommended for external consumption, the
/// uv binary interface is the official public API. When using this entry
/// point, uv assumes it is running in a process it controls and that the
/// entire process lifetime is managed by uv. Unexpected behavior may be
/// encountered if this entry point is called multiple times in a single process.
</code></pre>
<p>Feeling hesitant to move it even further up.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-02-07 20:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv/src/lib.rs</code>:1870 on 2025-02-07 20:16</div>
            <div class="timeline-body"><p>That's fair, but we should still follow Rust's soundness rules IMO. Which means we mark this <code>main</code> as <code>unsafe</code>. Then you'll want to add this to the function docs on the library <code>main</code>:</p>
<pre><code class="language-rust">/// # Safety
///
/// It is only safe to call this routine when it is known that multiple
/// threads are not running.
</code></pre>
<p>And then when we call this in actual <code>main</code>, we can copy your <code>SAFETY</code> comment to actual <code>main</code>:</p>
<pre><code class="language-rust">// SAFETY: It is safe to call this routine here because
// we know only one thread is running.
</code></pre>
<p>And then your safety comment in the <em>library</em> <code>main</code> gets changed to:</p>
<pre><code class="language-rust">// SAFETY: The proof obligation must be satisfied by the caller.
</code></pre>
<p>That way, things stay sound.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2025-02-07 20:23</div>
            <div class="timeline-body"><p>Perfect. You made the soundness pedant inside of me happy. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-02-07 20:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/lib.rs</code>:1870 on 2025-02-07 20:27</div>
            <div class="timeline-body"><p>Thanks again &lt;3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">breaking</span> added by @zanieb on 2025-02-07 20:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-07 20:27</div>
            <div class="timeline-body"><p>Going to consider this breaking due to the overwrite possibility and the change of our <code>pub main</code> to unsafe.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v0.6.0" by @zanieb on 2025-02-07 20:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> approved on 2025-02-07 20:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2025-02-07 20:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-02-07 20:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-07 20:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:19 UTC
    </footer>
</body>
</html>
