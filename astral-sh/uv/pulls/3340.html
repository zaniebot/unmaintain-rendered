<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>add basic &quot;install from lock file&quot; operation - astral-sh/uv #3340</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>add basic &quot;install from lock file&quot; operation</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/3340">#3340</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2024-05-02 18:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>This PR principally adds a routine for converting a <code>Lock</code> to a
<code>Resolution</code>, where a <code>Resolution</code> is a map of package names pinned to
a specific version.</p>
<p>I'm not sure that a <code>Resolution</code> is ultimately what we want here (we
might need more stuff), but this was the quickest route I could find to
plug a <code>Lock</code> into our existing <code>uv pip install</code> infrastructure.</p>
<p>This commit also does a little refactoring of the <code>Lock</code> types. The
main thing is to permit extra state on some of the types (like a
<code>by_id</code> map on <code>Lock</code> for quick lookups of distributions) that aren't
included in the serialization format of a <code>Lock</code>. We achieve this
by defining separate <code>Wire</code> types that are automatically converted
to-and-from via <code>serde</code>.</p>
<p>Note that like with the lock file format types themselves, we leave a
few <code>todo!()</code> expressions around. The main idea is to get something
minimally working without spending too much effort here. (A fair bit
of refactoring will be required to generate a lock file, and it's
not clear how much this code will wind up needing to change anyway.)
In particular, we only handle the case of installing wheels from a
registry.</p>
<p>A demonstration of the full flow:</p>
<pre><code>$ requirements.in
anyio
$ cargo run -p uv -- pip compile -p3.10 requirements.in --unstable-uv-lock-file
$ uv venv
$ cargo run -p uv -- pip install --unstable-uv-lock-file anyio -r requirements.in
Installed 5 packages in 7ms
 + anyio==4.3.0
 + exceptiongroup==1.2.1
 + idna==3.7
 + sniffio==1.3.1
 + typing-extensions==4.11.0
</code></pre>
<p>In order to install from a lock file, we start from the root and do a
breadth first traversal over its dependencies. We aren't yet filtering
on marker expressions (since they aren't in the lock file yet), but we
should be able to add that in the future. In so doing, the traversal
should select only the subset of distributions relevant for the current
platform.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @BurntSushi on 2024-05-02 18:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @BurntSushi on 2024-05-02 18:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-03 00:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/lock.rs</code>:84 on 2024-05-03 00:18</div>
            <div class="timeline-body"><p>Should this use <code>LockError</code> rather than <code>String</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-03 00:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/cli.rs</code>:1334 on 2024-05-03 00:19</div>
            <div class="timeline-body"><p>Nit: can we call this <code>unstable_lock_file</code> (omitting <code>uv</code>)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-03 00:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/pip_install.rs</code>:359 on 2024-05-03 00:19</div>
            <div class="timeline-body"><p>So this assumes that it's in the current working directory?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-03 00:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/lock.rs</code>:57 on 2024-05-03 00:20</div>
            <div class="timeline-body"><p>Could / should this just be a special package named <code>root</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-05-03 00:23</div>
            <div class="timeline-body"><p>I'm a little confused about the root concept, and why we need to pass <code>anyio</code> as an <em>argument</em> to <code>--unstable-lock</code>. What's the eventual vision there?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-03 00:24</div>
            <div class="timeline-body"><p>Separately, what are the expected semantics for <code>pip install</code> with a lockfile? Does the lockfile get regenerated? Should we limit it to <code>pip sync</code> for now for simplicity?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-resolver/src/lock.rs</code>:74 on 2024-05-03 09:09</div>
            <div class="timeline-body"><p>Should we make <code>DistributionId.name</code> a <code>PackageName</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-05-03 09:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-05-03 11:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-resolver/src/lock.rs</code>:84 on 2024-05-03 11:33</div>
            <div class="timeline-body"><p>It's only an internal helper for right now, and its only use asserts that is succeeds. I don't know that this belongs in <code>LockError</code>, and right now, it's only used to find the &quot;root&quot; package. And I expect all of that to change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-05-03 11:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv/src/cli.rs</code>:1334 on 2024-05-03 11:34</div>
            <div class="timeline-body"><p>It matches the name I added in: https://github.com/astral-sh/uv/pull/3314/files#diff-ae55eef503096c43098e973865bd5ed612871dcd1d3d335631a8027deb3828d3R605</p>
<p>This flag is hidden, undocumented and intended to be temporary. Its only purpose is to expose &quot;install from <code>uv.lock</code>&quot; on the CLI so that we can interact with it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-05-03 11:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv/src/commands/pip_install.rs</code>:359 on 2024-05-03 11:35</div>
            <div class="timeline-body"><p>Yes. It's the simplest thing to do I think. I expect this code to be eventually deleted. (Like, I don't expect <code>uv pip install</code> should ever read a <code>uv.lock</code> file.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-05-03 11:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-resolver/src/lock.rs</code>:57 on 2024-05-03 11:39</div>
            <div class="timeline-body"><p>I'm not sure that privileging the notion of &quot;root&quot; in the lock file makes sense, particularly given that we want to have workspace support. Cargo went in the same direction:</p>
<ul>
<li>https://github.com/rust-lang/cargo/issues/3003</li>
<li>https://github.com/rust-lang/cargo/issues/4563</li>
<li>https://github.com/rust-lang/cargo/issues/3704</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-05-03 11:46</div>
            <div class="timeline-body"><p>@charliermarsh</p>
<blockquote>
<p>I'm a little confused about the root concept, and why we need to pass <code>anyio</code> as an <em>argument</em> to <code>--unstable-lock</code>. What's the eventual vision there?</p>
</blockquote>
<p>Hmm, so I added this as a TODO comment in the source:</p>
<pre><code class="language-rust">            // TODO: In the future, we should derive the root distribution
            // from the pyproject.toml, but I don't think the infrastructure
            // for that is in place yet. For now, we ask the caller to specify
            // the root package name explicitly, and we assume here that it is
            // correct.
</code></pre>
<p>The basic idea here is that the lock file should contain an entry for each package in the current <code>uv</code> workspace. That concept doesn't really exist yet as far as I know, so those packages do not yet get added to the lock file. So we need some other way to pick the root. Right now, we just ask for it. But this is the sort of thing we should be auto-detecting by reading the <code>pyproject.toml</code>.</p>
<blockquote>
<p>Separately, what are the expected semantics for <code>pip install</code> with a lockfile? Does the lockfile get regenerated? Should we limit it to <code>pip sync</code> for now for simplicity?</p>
</blockquote>
<p>I'm not sure there are any expected semantics for <code>pip install</code> with <code>uv.lock</code>. It's not an obviously well defined operation to me. It's only here now as a temporary way of exposing interaction with <code>uv.lock</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-05-03 11:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-resolver/src/lock.rs</code>:74 on 2024-05-03 11:56</div>
            <div class="timeline-body"><p>Ah yeah, nice idea. Done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2024-05-03 12:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2024-05-03 12:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-05-03 12:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @BurntSushi on 2024-05-03 13:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-03 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/cli.rs</code>:1334 on 2024-05-03 13:54</div>
            <div class="timeline-body"><p>I mostly just have a strong dislike for using <code>uv</code> in things (outside of crate names, since it's roughly a namespace), like structs or arguments. But not a big deal if it's temporary.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-03 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/pip_install.rs</code>:359 on 2024-05-03 13:54</div>
            <div class="timeline-body"><p>Ok agreed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-03 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/lock.rs</code>:57 on 2024-05-03 13:54</div>
            <div class="timeline-body"><p>Ok agreed. This makes more sense now that I see that this isn't ever intended to be part of <code>pip install</code>, but rather, something that stems from a known project root.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:36:51 UTC
    </footer>
</body>
</html>
