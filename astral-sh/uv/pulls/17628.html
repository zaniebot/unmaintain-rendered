<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix local wheel cache invalidation - astral-sh/uv #17628</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix local wheel cache invalidation</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/pull/17628">#17628</a>
        opened by <a href="https://github.com/danilohorta">@danilohorta</a>
        on 2026-01-20 15:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danilohorta">@danilohorta</a></div>
            <div class="timeline-body"><p>Fixes #16617</p>
Problem
<p>When using <code>uv run --with path/to/wheel.whl</code>, rebuilding the wheel file doesn&#x27;t invalidate the cached environment. Users must run <code>uv cache prune</code> to see changes from a rebuilt wheel.</p>
Root Cause
<p>The <code>CachedEnvironment</code> creates a cache key from only the resolution (distribution paths) and interpreter hash. It doesn&#x27;t account for file modification times of local wheels, so when a file at the same path is modified, the cache key remains unchanged.</p>
Solution
<p>Include file modification times (mtime) in the cache hash for local distributions:</p>
<ul>
<li>Added <code>local_distribution_timestamps()</code> helper to extract mtimes for local wheels and source archives</li>
<li>Combined resolution hash with timestamp hash for the final cache key</li>
<li>Excluded directory timestamps to avoid false cache invalidation (directories change frequently for unrelated reasons)</li>
<li>Added integration test <code>run_with_local_wheel_rebuild</code> to verify the fix</li>
</ul>
Changes
<p><strong>Modified files:</strong></p>
<ul>
<li><code>crates/uv/src/commands/project/environment.rs</code> - Core cache logic</li>
<li><code>crates/uv/tests/it/run.rs</code> - Integration test</li>
</ul>
Testing
<ul>
<li>✅ New integration test passes</li>
<li>✅ All run module tests pass</li>
<li>✅ No performance impact on registry-based dependencies</li>
<li>✅ Properly invalidates cache when local wheels are rebuilt</li>
</ul>
Performance Considerations
<ul>
<li>Minimal overhead: one <code>fs::metadata()</code> call per local file distribution</li>
<li>No impact on remote dependencies</li>
<li>OS metadata is heavily cached</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-20 18:05</div>
            <div class="timeline-body"><p>Was this authored by using an LLM? Could you disclose how you decided on this design and iterated on the fix?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danilohorta">@danilohorta</a> on 2026-01-21 10:46</div>
            <div class="timeline-body"><p>I did use LLM tools to iterate through the solution space and draft/validate alternative approaches, but the investigation, design choice, and code changes were mine. My first iteration was to disable venv caching whenever local files/projects were present, but that was too broad for my use case. As a middle ground, I now fold file timestamps for local wheel/source archive files into the env hash, so rebuilding a local wheel at the same path invalidates the cache while keeping caching on for the rest.</p>
<p>I’m intentionally not including local project directories yet because a directory’s mtime is a noisy proxy: it can change for incidental file churn (temp files, build outputs, IDE caches, etc.) and may not change for content-only edits. This change only tracks concrete files. If you think it’s worth covering local projects too, I’m happy to discuss other signals (e.g., a targeted file list like pyproject.toml/lockfiles, or content hashing).</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-21 11:04:11 UTC
    </footer>
</body>
</html>
