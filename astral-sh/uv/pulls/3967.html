<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avoid re-adding solutions to forked state - astral-sh/uv #3967</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Avoid re-adding solutions to forked state</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/3967">#3967</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-06-02 21:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Running a resolution that required forking was failing due to breaking an invariant in PubGrub. It looks like we were adding the same incompatibility multiple times, or something like that. The issue appears to be that when forking, we modify the current state, then clone it as the &quot;next state&quot;, then push to the &quot;forked states&quot; -- but that means we're cloning the <em>modified</em> state.</p>
<p>This PR changes the order of operations such that we clone, then modify. It shouldn't introduce any additional clones though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-06-02 21:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @charliermarsh on 2024-06-02 21:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2024-06-02 21:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @charliermarsh on 2024-06-02 21:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2024-06-02 21:41</div>
            <div class="timeline-body"><p>I bet I flubbed this when I fixed the perf regression in my initial PR. Namely, I had previously been cloning forked states eagerly. But this resulted in cloning the state for every call to <code>get_dependencies</code>, even when there was no forking.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-06-02 21:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-06-02 21:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-06-02 21:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-02 21:58</div>
            <div class="timeline-body"><p>No prob, you wouldâ€™ve noticed immediately next week when you wrote the universal tests anyway!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:37:17 UTC
    </footer>
</body>
</html>
