<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support using `--index` to refer to index names - astral-sh/uv #17455</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Support using <code>--index</code> to refer to index names</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/pull/17455">#17455</a>
        opened by <a href="https://github.com/EliteTK">@EliteTK</a>
        on 2026-01-13 23:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a></div>
            <div class="timeline-body">Summary
<p>Implement #13974.</p>
<p>Some of the code was inspired by existing code from <code>uv_distribution::metadata::lowering</code> which handles resolving index name references within <code>pyproject.toml</code>.</p>
<p>This PR adds a new <code>IndexArg</code> type to <code>uv_distribution_types</code> which holds information about an index as passed on the CLI. Specifically the current <code>Index</code> type has a non-optional <code>url</code> field. <code>IndexArg</code> solves this by including two variants, one for the <code>Index</code> type and one for an <code>UnresolvedIndex</code> which holds the <code>name</code> and whether the index was passed using <code>--default-index</code>. This means that all the CLI handling can use <code>IndexArg</code> and then the standard <code>resolve</code> functions can transform these <code>IndexArg</code>s into <code>Index</code>es. This allows you to reference indexes by name if they are already defined somewhere else.</p>
Error handling
<p>The initial code made use of <code>Result</code> to propagate errors regarding resolution (i.e. no index found for that name). But I added a commit which replaces this with an early <code>exit(2)</code> as that seems to be the style used by other <code>resolve</code> style code.</p>
The new <code>Resolve</code> trait
<p><code>PipOptions</code> required a bunch of changes as it was using the <code>From</code> trait initially but index resolution requires additional metadata for the names which could have been passed as a tuple except for the fact that it&#x27;s ugly and also breaks the orphan rule so it wasn&#x27;t actually an option. Another alternative would be to do the resolution earlier but that seemed like an excessive amount of boilerplate, so instead a new trait was used.</p>
Argument cross-references
<p>You can&#x27;t resolve an index which you passed on the CLI (e.g. <code>--index foo=bar --index foo</code>) as I felt that didn&#x27;t make sense as a feature even if it could have been supported. Maybe there is a use for it though? Not sure.</p>
Index writeback
<p>The code for handling writing the index definition back into the <code>pyproject.toml</code> has remained unchanged. This means that if you reference a workspace index in a package add command, it will get copied to the package. This behaviour matches what would happen if you pass the full index including a name. I wasn&#x27;t completely sure what to do here, but I feel as if it might be confusing to have them behave differently.</p>
<p>I think if this is undesirable, probably the best option here would be to make a decision on [Index priority] and then make the change in the writeback code itself, either to update the workspace index, or complain about modifications if the index is part of the workspace.</p>
Index priority
<p>One area of ambiguity is which indexes to prioritise when trying to resolve a name.</p>
<p>When resolving the name of an index within a <code>pyproject.toml</code>, the lowering code resolves it by looking at the current file first, and then the workspace file.</p>
<p>On the other hand, when resolving which index to use for a package which has no specified index, the resolution takes the workspace index first and then the package&#x27;s indexes next.</p>
<p>You can&#x27;t have conflicting index names in a <code>pyproject.toml</code>, maybe the simple solution here is to forbid this within a workspace?</p>
<p>But, for the time being, the code follows the second strategy. It would be a bit of a change to make it follow the lowering strategy, but it seems possible toI believe that o. Since I realised this problem after having already written all of the code to implement the current strategy, I decided to leave it be for now.</p>
<code>uv tool</code>
<p>Passing <code>--index</code> to <code>uv tool</code> even if it&#x27;s the only index doesn&#x27;t guarantee that it will use only that index for the tool. Moreover, due to the fact that <code>--index &lt;name&gt;</code> works identically to <code>--index &lt;name&gt;=...</code>, the side effect is that the index will appear twice in the <code>uv-receipt.toml</code>. I think that any changes in this area are probably outside of the scope of this change.</p>
Test Plan
<p>A suite of new tests specifically for <code>uv add</code> in various situations.</p>
<p>The tests also help demonstrate how the current design decisions affect the results.</p>
Outstanding
<p>A few things are outstanding because I am hoping to get some feedback on the design decisions before I go ahead and implement them (to avoid unnecessary churn).</p>
<ul>
<li>Additional tests for other parts of uv which can now take <code>--index &lt;name&gt;</code></li>
<li>Relevant documentation changes.</li>
<li>Additional tests for index definitions in <code>uv.toml</code> (I had tested this manually but simply forgot to add a test case yet).</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2026-01-15 19:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/tests/it/edit.rs</code>:11501 on 2026-01-15 19:38</div>
            <div class="timeline-body"><p>Need to investigate what happens if you don&#x27;t pass <code>--index</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2026-01-15 19:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/tests/it/edit.rs</code>:11283 on 2026-01-15 19:39</div>
            <div class="timeline-body"><p>I am not sure if we want this. But also, need to check what happens normally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2026-01-19 14:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/tests/it/edit.rs</code>:11501 on 2026-01-19 14:30</div>
            <div class="timeline-body"><p>So, I am going to leave this as is for now.</p>
<p>Although I think there&#x27;s an argument to be made that if you&#x27;re adding an index and it matches identically an index in the workspace (regardless of if you used the name, or spelled it out) that maybe we shouldn&#x27;t mirror it in the child.</p>
<p>But the way things like #17610 work seems like maybe justification for leaving it as is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2026-01-19 14:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/tests/it/edit.rs</code>:11283 on 2026-01-19 14:50</div>
            <div class="timeline-body"><p>Okay, so index name references in <code>[tool.uv.sources]</code> are resolved in &quot;project&quot; then &quot;workspace&quot; order.</p>
<p>But when it comes to picking an index to use for a package without a specified source, we pick &quot;workspace&quot; then &quot;project&quot;.</p>
<p>I&#x27;m not really sure what the correct answer is here. I&#x27;m going to leave it as is for now...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-19 15:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-19 15:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/edit.rs</code>:11283 on 2026-01-20 09:20</div>
            <div class="timeline-body"><p>I&#x27;d prefer workspace root only, to avoid the problem of workspace root and member declaration getting out of sync.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2026-01-20 09:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/edit.rs</code>:11456 on 2026-01-20 09:22</div>
            <div class="timeline-body"><p>nit: <code>regex::escape</code> the mock server URL - though that filter doesn&#x27;t seem to be used?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/edit.rs</code>:11501 on 2026-01-20 09:29</div>
            <div class="timeline-body"><p>Can you remove the commented out code, and/or leave a TODO comment?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2026-01-20 09:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/konstin">@konstin</a> on 2026-01-20 09:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">breaking</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-21 15:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;v0.10.0&quot; by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-21 15:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-21 16:25</div>
            <div class="timeline-body"><blockquote>
<p>Moreover, due to the fact that --index  works identically to --index =..., the side effect is that the index will appear twice in the uv-receipt.toml</p>
</blockquote>
<p>This seems problematic?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-21 16:25</div>
            <div class="timeline-body"><blockquote>
<p>This means that if you reference a workspace index in a package add command, it will get copied to the package. This behaviour matches what would happen if you pass the full index including a name. I wasn&#x27;t completely sure what to do here, but I feel as if it might be confusing to have them behave differently.</p>
</blockquote>
<p>Is it necessary for it to be copied into the child package? Or if you added it to the child package without doing so would the parent index still be used properly?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-21 16:27</div>
            <div class="timeline-body"><blockquote>
<p>When resolving the name of an index within a pyproject.toml, the lowering code resolves it by looking at the current file first, and then the workspace file.</p>
<p>On the other hand, when resolving which index to use for a package which has no specified index, the resolution takes the workspace index first and then the package&#x27;s indexes next.</p>
</blockquote>
<p>So <code>--name</code> resolves to an index in the opposite order in which index priority is applied during resolution?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-21 17:09</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>Moreover, due to the fact that --index  works identically to --index =..., the side effect is that the index will appear twice in the uv-receipt.toml</p>
</blockquote>
<p>This seems problematic?</p>
</blockquote>
<p>This doesn&#x27;t cause any issues at the moment but we could de-duplicate things such that only the first index for each unique URL is kept in the order they would have been kept before. I don&#x27;t think the name is itself used for anything? That being said, this seems like an issue with how <code>uv tool install</code> works as you can also replicate the same receipt (with a duplicate entry) in other ways.</p>
<p>I&#x27;m happy to fix it though, do you want me to do it as part of this PR?</p>
<blockquote>
<blockquote>
<p>This means that if you reference a workspace index in a package add command, it will get copied to the package. This behaviour matches what would happen if you pass the full index including a name. I wasn&#x27;t completely sure what to do here, but I feel as if it might be confusing to have them behave differently.</p>
</blockquote>
<p>Is it necessary for it to be copied into the child package? Or if you added it to the child package without doing so would the parent index still be used properly?</p>
</blockquote>
<p>It&#x27;s definitely an option not to add it to the child package. The right index will be picked up as the name resolution order is project then workspace, so if the project doesn&#x27;t have an index with that name, the workspace one will be picked.</p>
<p>But there is this issue: #17610, which is somewhat related.</p>
<p>I feel that if we were to fix this, we should fix this in a way which is agnostic to whether the index was mentioned by name, or fully written out with a conflicting name. Although we can also just mark the index as having originated by name and then not write it back in those situations. But we have to be careful as you can specify a <code>--default-index</code> by name but the original index may have been a non-default one, in which case it would be wrong to not write it back.</p>
<blockquote>
<blockquote>
<p>When resolving the name of an index within a pyproject.toml, the lowering code resolves it by looking at the current file first, and then the workspace file.
On the other hand, when resolving which index to use for a package which has no specified index, the resolution takes the workspace index first and then the package&#x27;s indexes next.</p>
</blockquote>
<p>So <code>--name</code> resolves to an index in the opposite order in which index priority is applied during resolution?</p>
</blockquote>
<p>No, <code>--index &lt;name&gt;</code> resolves in the order of index priority during resolution, which I felt made sense initially, but the approach used by the lowering code (still uses priority, but it puts package indexes in front of the workspace indexes, which is the reverse) also makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-21 17:39</div>
            <div class="timeline-body"><p>@EliteTK can we ship this under a preview flag so we don&#x27;t need to wait until 0.10 to merge?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-21 17:40</div>
            <div class="timeline-body"><blockquote>
<p>No, --index  resolves in the order of index priority during resolution, which I felt made sense initially, but the approach used by the lowering code (still uses priority, but it puts package indexes in front of the workspace indexes, which is the reverse) also makes sense.</p>
</blockquote>
<p>I don&#x27;t understand how to reconcile this comment with your original one?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-21 17:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-cli/src/options.rs</code>:189 on 2026-01-21 17:44</div>
            <div class="timeline-body"><p>I think this could be a bit less descriptive of the code and more of the intent? LIke</p>
<pre><code>/// Resolve index options into a prioritized list of [`Index`].
/// 
/// Index name references are resolved to index URLs using values from the file system.
///
/// The default index is placed after all other indexes.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-21 17:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-cli/src/options.rs</code>:208 on 2026-01-21 17:45</div>
            <div class="timeline-body"><p>Do you know <em>why</em> we do this in the other code? It&#x27;s pretty janky. It doesn&#x27;t respect our <code>Printer</code>, it doesn&#x27;t print the error chain, etc.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-21 17:54</div>
            <div class="timeline-body"><blockquote>
<p>@EliteTK can we ship this under a preview flag so we don&#x27;t need to wait until 0.10 to merge?</p>
</blockquote>
<p>Yeah, no objections here.</p>
<blockquote>
<blockquote>
<p>No, --index  resolves in the order of index priority during resolution, which I felt made sense initially, but the approach used by the lowering code (still uses priority, but it puts package indexes in front of the workspace indexes, which is the reverse) also makes sense.</p>
</blockquote>
<p>I don&#x27;t understand how to reconcile this comment with your original one?</p>
</blockquote>
<p>I will adjust it for clarity, but the section you referenced mentions that this PR uses the &quot;second strategy&quot; which refers to:</p>
<p>&quot;On the other hand, when resolving which index to use for a package which has no specified index, the resolution takes the workspace index first and then the package&#x27;s indexes next.&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-21 18:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-distribution-types/src/index.rs</code>:454 on 2026-01-21 18:15</div>
            <div class="timeline-body"><pre><code>    /// Parse an index passed on the command line
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-distribution-types/src/index.rs</code>:507 on 2026-01-21 18:16</div>
            <div class="timeline-body"><p>This could probably use a doc comment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-21 18:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-21 18:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-settings/src/settings.rs</code>:573 on 2026-01-21 18:17</div>
            <div class="timeline-body"><p>This should probably have a doc comment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-settings/src/settings.rs</code>:577 on 2026-01-21 18:17</div>
            <div class="timeline-body"><p>Do we need to clone? Can the caller clone?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-21 18:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-21 18:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/it/edit.rs</code>:11129 on 2026-01-21 18:18</div>
            <div class="timeline-body"><p>We might want a follow-up issue to enumerate searched source files here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-21 18:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/it/edit.rs</code>:11133 on 2026-01-21 18:19</div>
            <div class="timeline-body"><p>Have we considered continuing to support the current behavior if <code>./test-index</code> exists and / or if the name <code>test-index</code> doesn&#x27;t exist?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-21 18:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/it/edit.rs</code>:11283 on 2026-01-21 18:20</div>
            <div class="timeline-body"><p>@konstin you&#x27;d prefer workspace root only in what sense?</p>
<p>Isn&#x27;t @EliteTK describing an existing behavior?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-21 18:25</div>
            <div class="timeline-body"><p>This will need some documentation updates, which might help explain the behavior?</p>
<p>The code looks fine but I only sort of understand how behaves, tbh.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/tests/it/edit.rs</code>:11133 on 2026-01-21 20:52</div>
            <div class="timeline-body"><p>I hadn&#x27;t, but I would say it should be only if the directory exists <em>and</em> the index doesn&#x27;t. Otherwise you&#x27;re going to get a confusing error whenever you mis-type an index or mis-type a directory name.</p>
<p>But honestly I am mildly against this kind of special casing.</p>
<p>Rather simple to implement though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2026-01-21 20:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-21 20:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/it/edit.rs</code>:11133 on 2026-01-21 20:59</div>
            <div class="timeline-body"><p>I think such special casing generally makes transitioning easier because then the change is breaking for less people? I don&#x27;t think it&#x27;s an ideal end state, but the mistake was when we allowed <code>foo</code> to be treated as a relative path without <code>./foo</code> in the first place.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-21 21:00:50 UTC
    </footer>
</body>
</html>
