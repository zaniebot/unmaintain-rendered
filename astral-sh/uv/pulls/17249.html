<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Make `uv pip compile` attempt to download a specified `--python-version` if it can. - astral-sh/uv #17249</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Make <code>uv pip compile</code> attempt to download a specified <code>--python-version</code> if it can.</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/pull/17249">#17249</a>
        opened by <a href="https://github.com/EliteTK">@EliteTK</a>
        on 2025-12-29 12:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>I believe this mostly addresses #16709. Now specifying a simple version with <code>--python</code> or specifying a version using <code>--python-version</code> will result in the specified version getting downloaded with a fallback to the previous behaviour if the download fails for some transient reason or if downloads are disabled.</p>
<p>The behaviour of how <code>--python</code> gets treated as <code>--python-version</code> if a &quot;simple version&quot; is specified is kept. This means that <code>--python 3.7</code> turns into a soft requirement. This seems at odds with how other similar parts of UV work, but there seem to be quite a few tests which test for this specific behaviour and I think this is best saved for a separate issue.</p>
<h2>Test Plan</h2>
<p>I added a test case which would previously fall back to the default interpreter and warn about it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @EliteTK on 2025-12-29 12:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-29 13:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-python/src/discovery.rs</code>:1492 on 2025-12-29 13:03</div>
            <div class="timeline-body"><p>There's a question here regarding if we should instead just report these errors and continue instead of propagating them upstream, as this is kind of a breaking change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-29 13:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-python/src/discovery.rs</code>:1563 on 2025-12-29 13:04</div>
            <div class="timeline-body"><p>Should we use the same strategy when downloading?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @EliteTK on 2025-12-29 13:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-09 20:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:1492 on 2026-01-09 20:08</div>
            <div class="timeline-body"><p>I think it seems reasonable to fail on error as long as we don't fail on things like... offline mode being enabled?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-09 20:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:1563 on 2026-01-09 20:08</div>
            <div class="timeline-body"><p>That seems technically correct, though I can't say it's definitely worth it without seeing the code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2026-01-09 20:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-python/src/discovery.rs</code>:1492 on 2026-01-09 20:46</div>
            <div class="timeline-body"><p>In this specific context, <code>downloads_enabled</code> is passed the combined management preference, download preference, and offline state. So this block won't get ran in the offline case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2026-01-09 20:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-python/src/discovery.rs</code>:1563 on 2026-01-09 20:47</div>
            <div class="timeline-body"><p>I think it would just be a matter of shoving https://github.com/astral-sh/uv/pull/17249/changes/BASE..37d8cb6fd77ec752c265060db26b92c7584fa78c#diff-d02a01db770da7d68941d9e67624483d066f95310e5c1835dc0edc23f9af6e5cL1469 in a function and then calling it twice...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2026-01-09 20:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-python/src/discovery.rs</code>:1563 on 2026-01-09 20:48</div>
            <div class="timeline-body"><p>I don't know why github let me make a link and then produced whatever broken thing that was...</p>
<p>I mean the code above in the <code>if downloads_enabled</code> block.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-09 21:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:1492 on 2026-01-09 21:31</div>
            <div class="timeline-body"><p>I guess the concern is like... if you wifi is off?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:1563 on 2026-01-09 21:32</div>
            <div class="timeline-body"><p>Yeah, I think it's only the error handling that might be annoying? I think you should try it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-09 21:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2026-01-14 16:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-python/src/discovery.rs</code>:1492 on 2026-01-14 16:04</div>
            <div class="timeline-body"><p>I've made it so that any errors which come out of fill, find, or fetch are warned about (minimally) as opposed to being propagated, unless the request is for any version or a default version, in which case I feel like it's appropriate to reply with a download error if downloads were enabled.</p>
<p>Let me know what you think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2026-01-14 16:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-python/src/discovery.rs</code>:1563 on 2026-01-14 16:04</div>
            <div class="timeline-body"><p>All done, I think the error handling didn't turn out too bad.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-14 16:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:1553 on 2026-01-14 16:05</div>
            <div class="timeline-body"><p>What kind of error cases are you imagining here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:1553 on 2026-01-14 16:06</div>
            <div class="timeline-body"><p>In what case should we not just hard-fail?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-14 16:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2026-01-14 16:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-python/src/discovery.rs</code>:1553 on 2026-01-14 16:06</div>
            <div class="timeline-body"><p>Network errors specifically. See the test for an example.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2026-01-14 16:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-python/src/discovery.rs</code>:1553 on 2026-01-14 16:26</div>
            <div class="timeline-body"><p>To expand, various errors from <code>PythonInstallation::fetch</code> (which include network errors due to e.g. WiFi being out) and two kinds of errors from <code>PythonDownloadRequest::fill</code>:</p>
<ul>
<li>we can't figure out the libc variant</li>
<li>UV_PYTHON_<impl>_BUILD contains invalid UTF-8</li>
</ul>
<p>I considered if the fill errors should be hard-fail.</p>
<p>Mainly I was trying to avoid the situation you described here https://github.com/astral-sh/uv/pull/17249#discussion_r2677677267 which I specifically tested and is what lead to this path.</p>
<p>I think it's possibly an idea to narrow things down to specifically transient network errors and nothing else.</p>
<p>Or we can stick with the original approach of just failing hard - but it's kind of a breaking change in that sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-14 16:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:1553 on 2026-01-14 16:39</div>
            <div class="timeline-body"><p>I guess my thinking is that if we fail here we also won't succeed on the subsequent attempt with another Python version request</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:1553 on 2026-01-14 16:40</div>
            <div class="timeline-body"><p>I agree it's nice for it not to be breaking though, thanks for providing the additional context.</p>
<p>We might want to encode some of that in a comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-14 16:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2026-01-14 16:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-python/src/discovery.rs</code>:1553 on 2026-01-14 16:45</div>
            <div class="timeline-body"><p>Re failing twice: I would agree it would <em>probably</em> fail but I don't think we can assume it <em>will</em> fail. At least that was my thinking in that regard. But it's also kind of a remote possibility to be really trying to cater for it.</p>
<p>Would you like me to skip re-attempting a download on the without-patch-number path if the verbatim path fails (except if it fails with <code>NoDownloadFound</code> in which case it is worth re-trying)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-14 16:47</div>
            <div class="timeline-body"><p>Heh... I just realised, what about if there's no default python version? We should probably <em>also</em> attempt to download in that final case too...</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-14 17:42:14 UTC
    </footer>
</body>
</html>
