<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add packse scenario tests - astral-sh/uv #746</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add packse scenario tests</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/746">#746</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-01-02 22:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/zanieb">@zanieb</a> on 2024-01-02 22:58</div>
            <div class="timeline-body"><p>Adds tests using packse test scenarios! Uses <code>test.pypi.org</code> as a backing index.</p>
<p>Tests are generated by a simple Python script. Requires https://github.com/zanieb/packse/pull/49.</p>
<p>This opens us to a slight attack surface, as we cannot force use of <code>test.pypi.org</code> only and someone could register these package names on the real <code>pypi.org</code> index with malicious content. I could publish these packages there too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-01-02 23:06</div>
            <div class="timeline-body"><p>Right now, we just install the &quot;root&quot; package of each scenario. However, the scenarios are framed such that the user has requested the dependencies of the root package. We can adjust the tests to directly request those dependencies in the future, which gives us better test coverage i.e. we can have scenarios covering conflicts in direct dependencies rather than just indirect ones.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-01-02 23:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/puffin-cli/tests/pip_install_scenarios.rs</code>:125 on 2024-01-02 23:12</div>
            <div class="timeline-body"><p>This is a bug in the scenario, ref https://github.com/zanieb/packse/pull/50</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-01-03 00:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>scripts/scenarios/generate.py</code>:40 on 2024-01-03 10:49</div>
            <div class="timeline-body"><p>Could we replace this with:</p>
<pre><code class="language-rust">
    insta::with_settings!({
        filters =&gt; INSTA_FILTERS.to_vec()
    }, {
        assert_cmd_snapshot!(
            run_scenario(&quot;{{ prefix }}&quot;),
            @r###&quot;&lt;snapshot&gt;
        &quot;###);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-01-03 10:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-01-03 16:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>scripts/scenarios/generate.py</code>:40 on 2024-01-03 16:25</div>
            <div class="timeline-body"><p>Sure!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-01-03 16:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>scripts/scenarios/generate.py</code>:40 on 2024-01-03 16:37</div>
            <div class="timeline-body"><p>Actually... I don't really get it. We need all these scoped variables e.g. the cache, venv, temp dir and it seems silly to pass them all through to <code>run_scenario</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-01-03 17:30</div>
            <div class="timeline-body"><p>Failing due to panic in <code>requires_transitive_incompatible_with_transitive</code> introduced by #744</p>
<pre><code>stack backtrace:␊
   0: std::panicking::begin_panic␊
             at /rustc/82e1608dfa6e0b5569232559e3d385fea5a93112/library/std/src/panicking.rs:686:12␊
   1: waitmap::Ref&lt;K,V,S&gt;::value␊
             at /Users/mz/.cargo/registry/src/index.crates.io-6f17d22bba15001f/waitmap-1.1.0/src/lib.rs:132:32␊
   2: puffin_resolver::error::NoSolutionError::with_available_versions␊
             at /Users/mz/eng/src/astral-sh/puffin/crates/puffin-resolver/src/error.rs:186:51␊
   3: puffin_resolver::resolver::Resolver&lt;Provider&gt;::resolve::{{closure}}::{{closure}}␊
             at /Users/mz/eng/src/astral-sh/puffin/crates/puffin-resolver/src/resolver.rs:299:50␊
   4: core::result::Result&lt;T,E&gt;::map_err␊
             at /rustc/82e1608dfa6e0b5569232559e3d385fea5a93112/library/core/src/result.rs:829:27␊
   5: puffin_resolver::resolver::Resolver&lt;Provider&gt;::resolve::{{closure}}␊
             at /Users/mz/eng/src/astral-sh/puffin/crates/puffin-resolver/src/resolver.rs:296:17␊
   6: puffin::commands::pip_install::resolve::{{closure}}␊
             at /Users/mz/eng/src/astral-sh/puffin/crates/puffin-cli/src/commands/pip_install.rs:376:41␊
   7: puffin::commands::pip_install::pip_install::{{closure}}␊
             at /Users/mz/eng/src/astral-sh/puffin/crates/puffin-cli/src/commands/pip_install.rs:184:6␊
   8: puffin::inner::{{closure}}␊
             at /Users/mz/eng/src/astral-sh/puffin/crates/puffin-cli/src/main.rs:525:14␊
   9: puffin::main::{{closure}}␊
             at /Users/mz/eng/src/astral-sh/puffin/crates/puffin-cli/src/main.rs:547:19␊
  10: tokio::runtime::park::CachedParkThread::block_on::{{closure}}␊
             at /Users/mz/.cargo/registry/src/index.crates.io-6f17d22bba15001f/tokio-1.33.0/src/runtime/park.rs:282:63␊
  11: tokio::runtime::coop::with_budget␊
             at /Users/mz/.cargo/registry/src/index.crates.io-6f17d22bba15001f/tokio-1.33.0/src/runtime/coop.rs:107:5␊
  12: tokio::runtime::coop::budget␊
             at /Users/mz/.cargo/registry/src/index.crates.io-6f17d22bba15001f/tokio-1.33.0/src/runtime/coop.rs:73:5␊
  13: tokio::runtime::park::CachedParkThread::block_on␊
             at /Users/mz/.cargo/registry/src/index.crates.io-6f17d22bba15001f/tokio-1.33.0/src/runtime/park.rs:282:31␊
  14: tokio::runtime::context::blocking::BlockingRegionGuard::block_on␊
             at /Users/mz/.cargo/registry/src/index.crates.io-6f17d22bba15001f/tokio-1.33.0/src/runtime/context/blocking.rs:66:9␊
  15: tokio::runtime::scheduler::multi_thread::MultiThread::block_on::{{closure}}␊
             at /Users/mz/.cargo/registry/src/index.crates.io-6f17d22bba15001f/tokio-1.33.0/src/runtime/scheduler/multi_thread/mod.rs:87:13␊
  16: tokio::runtime::context::runtime::enter_runtime␊
             at /Users/mz/.cargo/registry/src/index.crates.io-6f17d22bba15001f/tokio-1.33.0/src/runtime/context/runtime.rs:65:16␊
  17: tokio::runtime::scheduler::multi_thread::MultiThread::block_on␊
             at /Users/mz/.cargo/registry/src/index.crates.io-6f17d22bba15001f/tokio-1.33.0/src/runtime/scheduler/multi_thread/mod.rs:86:9␊
  18: tokio::runtime::runtime::Runtime::block_on␊
             at /Users/mz/.cargo/registry/src/index.crates.io-6f17d22bba15001f/tokio-1.33.0/src/runtime/runtime.rs:350:45␊
  19: puffin::main␊
             at /Users/mz/eng/src/astral-sh/puffin/crates/puffin-cli/src/main.rs:547:5␊
  20: core::ops::function::FnOnce::call_once␊
             at /rustc/82e1608dfa6e0b5569232559e3d385fea5a93112/library/core/src/ops/function.rs:250:5␊
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2024-01-03 21:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-01-03 21:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-01-03 21:50</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 15:45:06 UTC
    </footer>
</body>
</html>
