<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>re-introduce cache healing when we see an invalid cache entry - astral-sh/uv #1707</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>re-introduce cache healing when we see an invalid cache entry</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/1707">#1707</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2024-02-19 16:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>This PR introduces more robust cache healing when <code>uv</code> fails to
deserialize an existing cache entry.</p>
<p>(&quot;Cache healing&quot; in this context means that if <code>uv</code> fails to
deserialize a cache entry, then it will automatically invalidate that
entry and re-generate the data. Typically by sending an HTTP request.)</p>
<p>Previous to some optimizations I made around deserialization, we were
already doing this. After those optimizations, deserializing a cache
policy and the payload were split into two steps. While deserializing
a cache policy retained its cache healing behavior, deserializing the
payload did not. This became an issue when #1556 landed, which changed
one of our <code>rkyv</code> data types. This in turn made our internal types
incompatible with existing cache entries. One could work-around this
by clearing <code>uv</code>'s cache with <code>uv clean</code>, but we should just do it
automatically on a cache entry by entry basis.</p>
<p>This does technically introduce a new cost by pessimistically cloning
the HTTP request so that we can re-send it if necessary (see the commit
messages for the knot pushing me toward this approach). So I re-ran my
favorite ad-hoc benchmark:</p>
<pre><code>$ hyperfine -w10 --runs 50 &quot;uv-main pip compile --cache-dir ~/astral/tmp/cache-main ~/astral/tmp/reqs/home-assistant-reduced.in -o /dev/null&quot; &quot;uv-test pip compile --cache-dir ~/astral/tmp/cache-test ~/astral/tmp/reqs/home-assistant-reduced.in -o /dev/null&quot; ; A bart
Benchmark 1: uv-main pip compile --cache-dir ~/astral/tmp/cache-main ~/astral/tmp/reqs/home-assistant-reduced.in -o /dev/null
  Time (mean ± σ):     114.4 ms ±   3.2 ms    [User: 149.4 ms, System: 221.5 ms]
  Range (min … max):   106.7 ms … 122.0 ms    50 runs

Benchmark 2: uv-test pip compile --cache-dir ~/astral/tmp/cache-test ~/astral/tmp/reqs/home-assistant-reduced.in -o /dev/null
  Time (mean ± σ):     114.0 ms ±   3.0 ms    [User: 146.0 ms, System: 223.3 ms]
  Range (min … max):   105.3 ms … 121.4 ms    50 runs

Summary
  uv-test pip compile --cache-dir ~/astral/tmp/cache-test ~/astral/tmp/reqs/home-assistant-reduced.in -o /dev/null ran
    1.00 ± 0.04 times faster than uv-main pip compile --cache-dir ~/astral/tmp/cache-main ~/astral/tmp/reqs/home-assistant-reduced.in -o /dev/null
</code></pre>
<p>Which is about what I expected.</p>
<p>We should endeavor to have a better testing strategy for these kinds of bugs, but I think it might be a little tricky to do. I created https://github.com/astral-sh/uv/issues/1699 to track that.</p>
<p>Fixes #1571</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @BurntSushi on 2024-02-19 16:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-02-19 16:59</div>
            <div class="timeline-body"><p>Looks good to me! Charlie might be a better reviewer though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2024-02-19 17:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2024-02-19 17:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-02-19 17:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @BurntSushi on 2024-02-23 12:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:35:38 UTC
    </footer>
</body>
</html>
