<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Include sys.path of ephemeral env in PYTHONPATH - astral-sh/uv #7699</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Include sys.path of ephemeral env in PYTHONPATH</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/7699">#7699</a>
        opened by <a href="https://github.com/tfsingh">@tfsingh</a>
        on 2024-09-26 08:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/tfsingh">@tfsingh</a> on 2024-09-26 08:35</div>
            <div class="timeline-body"><p>This PR ensures that the sys.path of an ephemeral environment is included in the PYTHONPATH of spawned processes (useful in the case of executing external commands). This addresses issue #7647.</p>
<p>I tested this with the repro in the issue, i.e.:</p>
<pre><code>uv init
uv add jupyter
uv run --with pydantic jupyter lab
</code></pre>
<p>An automated test is trickier — Jupyter doesn't have an interface for executing commands non-interactively (closest thing is <code>jupyter console</code>, which spawns a repl). Its runtime (ipython) does accept a <code>-c</code> flag, but the issue doesn't manifest when using ipython — as such,  a test wouldn't be effective. Open to thoughts on more rigorous test plans, I might be missing something!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Include sys.path of ephemeral env in PYTHONPATH of external command" to "Include sys.path of ephemeral env in PYTHONPATH" by @tfsingh on 2024-09-26 08:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @tfsingh on 2024-09-26 08:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-26 12:26</div>
            <div class="timeline-body"><p>You might just be able to do something like <code>python -c &quot;import sys; print(sys.path)&quot;</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-26 12:50</div>
            <div class="timeline-body"><p>A few issues with this that come to mind though I'm not certain on either:</p>
<ol>
<li>I <em>think</em> entries in <code>PYTHONPATH</code> have slightly different precedence / prioritization than they would if you run <code>uv run</code> here without a notebook. You can probably see the difference if you print out <code>sys.path</code> within the notebook and with <code>uv run --with pydantic python -c &quot;import sys; print(sys.path)&quot;</code>.</li>
<li>I <em>think</em> that using <code>PYTHONPATH</code> won't follow <code>.pth</code> files though @carljm would know -- in which case, we wouldn't be able to resolve any <code>--with-editable</code> dependencies added to the <code>uv run</code> command.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bluss">@bluss</a> on 2024-09-26 16:16</div>
            <div class="timeline-body"><p>I'm concerned that setting PYTHONPATH could have an impact on <code>uv run</code> inside <code>uv run</code> and so on (which becomes more common as uv gets more useful to run everything!). When setting PYTHONPATH there is risk that python environments bleed into each other and packages are imported between environments that should be separate.</p>
<p>This was issue #5459 in the past.</p>
<hr />
<p>You have two environments, Base and Layer.</p>
<p>The root cause of the problem is that <code>Base/bin/jupyter</code> is a python script that hard-codes that it runs using the <code>Base/bin/python</code> interpreter.</p>
<p>Could a solution be to execute <code>Layer/bin/python Base/bin/jupyter</code>? That would activate the correct environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-26 16:21</div>
            <div class="timeline-body"><p>I've tried <code>uv run --with pydantic python -m jupyter lab</code> and it doesn't work despite using the layered Python :/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bluss">@bluss</a> on 2024-09-26 16:22</div>
            <div class="timeline-body"><p>I just discovered that. :cry:  jupyter lab must be executing the jupyter-lab script stub?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-26 16:22</div>
            <div class="timeline-body"><p>Yeah there's something going on that I don't understand yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bluss">@bluss</a> on 2024-09-26 16:25</div>
            <div class="timeline-body"><p>And if I &quot;fix&quot; the jupyter-lab script stub to just use usr/bin/env python, a different error is produced. This is not going to play very well with environment layering, because jupyterlab is searching for its $prefix/share/jupyter/lab</p>
<pre><code>JupyterLab Error
JupyterLab application assets not found in &quot;/home/user/.cache/uv/archive-v0/5CUs8Rso39JXZO4nfVoDF/share/jupyter/lab&quot;
Please run `jupyter lab build` or use a different app directory
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tfsingh">@tfsingh</a> on 2024-09-26 16:46</div>
            <div class="timeline-body"><blockquote>
<p>Could a solution be to execute Layer/bin/python Base/bin/jupyter? That would activate the correct environment.</p>
</blockquote>
<p>This was the first thing I tried as well, using the ephemeral env's interpreter to execute <code>Base/bin/jupyter</code> — I'll need to dig deeper here to understand this.</p>
<blockquote>
<p>A few issues with this that come to mind though I'm not certain on either:</p>
</blockquote>
<p>Both of these points make sense as well (verified the first, looking into the second now)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @zanieb on 2024-10-01 19:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tfsingh">@tfsingh</a> on 2024-10-01 22:33</div>
            <div class="timeline-body"><p>Going to close this as I'm not actively working on it, will reopen if I figure out a better approach</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @tfsingh on 2024-10-01 22:33</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 13:01:43 UTC
    </footer>
</body>
</html>
