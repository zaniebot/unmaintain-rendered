```yaml
number: 2926
title: "Implement `--emit-index-annotation` to annotate source index for each package"
type: pull_request
state: merged
author: ChannyClaus
labels:
  - enhancement
assignees: []
merged: true
base: main
head: annotate-index
created_at: 2024-04-09T04:14:44Z
updated_at: 2024-04-10T16:05:59Z
url: https://github.com/astral-sh/uv/pull/2926
synced_at: 2026-01-10T14:43:31Z
```

# Implement `--emit-index-annotation` to annotate source index for each package

---

_Pull request opened by @ChannyClaus on 2024-04-09 04:14_

<!--
Thank you for contributing to uv! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary
resolves https://github.com/astral-sh/uv/issues/2852
<!-- What's the purpose of the change? What does it do, and why? -->

## Test Plan
add a couple of tests:
- one covering the simplest case with all packages pulled from a single index.
- another where packages are pull from two distinct indices.

tested manually as well:
```
$ (echo 'pandas'; echo 'torch') | UV_EXTRA_INDEX_URL='https://download.pytorch.org/whl/cpu' cargo run pip compile - --include-indices 
    Finished dev [unoptimized + debuginfo] target(s) in 0.60s
     Running `target/debug/uv pip compile - --include-indices`
Resolved 15 packages in 686ms
# This file was autogenerated by uv via the following command:
#    uv pip compile - --include-indices
filelock==3.9.0
    # via torch
    # from https://download.pytorch.org/whl/cpu
fsspec==2023.4.0
    # via torch
    # from https://download.pytorch.org/whl/cpu
jinja2==3.1.2
    # via torch
    # from https://download.pytorch.org/whl/cpu
markupsafe==2.1.3
    # via jinja2
    # from https://download.pytorch.org/whl/cpu
mpmath==1.3.0
    # via sympy
    # from https://download.pytorch.org/whl/cpu
networkx==3.2.1
    # via torch
    # from https://download.pytorch.org/whl/cpu
numpy==1.26.3
    # via pandas
    # from https://download.pytorch.org/whl/cpu
pandas==2.2.1
    # from https://pypi.org/simple
python-dateutil==2.9.0.post0
    # via pandas
    # from https://pypi.org/simple
pytz==2024.1
    # via pandas
    # from https://pypi.org/simple
six==1.16.0
    # via python-dateutil
    # from https://pypi.org/simple
sympy==1.12
    # via torch
    # from https://download.pytorch.org/whl/cpu
torch==2.2.2
    # from https://download.pytorch.org/whl/cpu
typing-extensions==4.8.0
    # via torch
    # from https://download.pytorch.org/whl/cpu
tzdata==2024.1
    # via pandas
    # from https://pypi.org/simple
```
<!-- How was it tested? -->


---

_Comment by @zanieb on 2024-04-09 04:34_

Nice start! Should we make this opt-in?

---

_Comment by @charliermarsh on 2024-04-09 13:27_

Yeah this should be opt-in.

---

_Assigned to @charliermarsh by @charliermarsh on 2024-04-10 02:42_

---

_Label `enhancement` added by @charliermarsh on 2024-04-10 02:42_

---

_Comment by @ChannyClaus on 2024-04-10 03:20_

any pointers on which index to use for the test case that uses multiple indices? `--exclude-newer 2024-03-25T00:00:00Z` with `https://download.pytorch.org/whl/cpu` would fail with the below ðŸ˜¢ .
```
warning: torch-0.1-cp35-cp35m-macosx_10_6_x86_64.whl is missing an upload date, but user provided: 2024-03-25 00:00:00 UTC
```


---

_Marked ready for review by @ChannyClaus on 2024-04-10 03:24_

---

_Comment by @charliermarsh on 2024-04-10 03:31_

Can you use `https://test.pypi.org/simple`?

---

_Comment by @ChannyClaus on 2024-04-10 12:08_

bahaha thanks for not uploading `uv` to the test index ðŸ˜† 

---

_@ChannyClaus reviewed on 2024-04-10 12:11_

---

_Review comment by @ChannyClaus on `crates/uv-resolver/src/resolution.rs`:732 on 2024-04-10 12:11_

should this conditional include `self.include_annotations`?

---

_Review requested from @charliermarsh by @charliermarsh on 2024-04-10 14:24_

---

_@charliermarsh reviewed on 2024-04-10 14:47_

---

_Review comment by @charliermarsh on `crates/uv-resolver/src/resolution.rs`:732 on 2024-04-10 14:47_

I think it's okay as-is.

---

_@charliermarsh reviewed on 2024-04-10 14:47_

---

_Review comment by @charliermarsh on `crates/uv-resolver/src/resolution.rs`:510 on 2024-04-10 14:47_

I know it's tedious but I'm going to change this to `indexes` to match the terminology that pip uses in its documentation.

---

_@ChannyClaus reviewed on 2024-04-10 14:57_

---

_Review comment by @ChannyClaus on `crates/uv-resolver/src/resolution.rs`:510 on 2024-04-10 14:57_

/shrug i can run through these real quick

---

_@charliermarsh reviewed on 2024-04-10 15:05_

---

_Review comment by @charliermarsh on `crates/uv-resolver/src/resolution.rs`:510 on 2024-04-10 15:05_

Thanks!

---

_Renamed from "add index in pip compile output" to "Implement `--emit-index-annotation` to annotate source index for each package" by @charliermarsh on 2024-04-10 15:57_

---

_@charliermarsh approved on 2024-04-10 15:57_

---

_Merged by @charliermarsh on 2024-04-10 16:05_

---

_Closed by @charliermarsh on 2024-04-10 16:05_

---
