<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treat less compatible tags as lower priority in resolver - astral-sh/uv #9339</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Treat less compatible tags as lower priority in resolver</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/9339">#9339</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-11-21 22:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>This is a second pass at <a href="https://github.com/astral-sh/uv/pull/7556">astral-sh/uv#7556</a>, which was reverted in <a href="https://github.com/astral-sh/uv/pull/7608">astral-sh/uv#7608</a> due to a regression in <a href="https://github.com/astral-sh/uv/issues/7606">astral-sh/uv#7606</a>. The behavior is actually correct, but a package (<code>nmslib</code>) publishes inconsistent metadata, and the change here happened to cause us to select a wheel with &quot;wrong&quot; metadata. It&#x27;s arbitrary, but it did cause a regression for folks.</p>
<p>Since we&#x27;re now seeing other issues caused by the wrongness here (and since the reporter in <a href="https://github.com/astral-sh/uv/issues/7606">astral-sh/uv#7606</a> has since removed the dependency), I&#x27;m inclined to ship this fix.</p>
<p>Closes <a href="https://github.com/astral-sh/uv/issues/7553">astral-sh/uv#7553</a>.
Closes <a href="https://github.com/astral-sh/uv/issues/9283">astral-sh/uv#9283</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-21 22:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-21 22:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-11-22 16:23</div>
            <div class="timeline-body"><p>I&#x27;m still sort of hesitant.</p>
<p>One of the linked issues comes from selecting Python 2 wheels? I feel like we should never read metadata from those?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-22 18:16</div>
            <div class="timeline-body"><p>We can change that, but why hesitant? The current behavior is legitimately incorrect — it treats less compatible wheels as more compatible.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-22 18:26</div>
            <div class="timeline-body"><p>Perhaps I&#x27;m not following. I&#x27;m going off the title:</p>
<blockquote>
<p>invalid platform as more compatible than invalid Python</p>
</blockquote>
<p>This sounds like we prefer an invalid platform over an invalid Python version — I don&#x27;t see one of those as more-correct?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-22 18:59</div>
            <div class="timeline-body"><p>I think the PR title is kind of bad (I copied it over from the previous PR). My understanding of what&#x27;s happening is that, at present, if we have two wheels with incompatible tags, we treat the wheel the wheel with &quot;less compatible&quot; tags as &quot;higher priority&quot; (which is wrong). Later, in error reporting, we say <code>no wheels with a matching Python implementation tag</code> if the &quot;highest priority&quot; tag is <code>IncompatibleTag::Python</code>, because we&#x27;re demonstrating that the best wheel we could find uses a different Python implementation. But that&#x27;s not true -- there <em>are</em> wheels with matching Python implementations, we just treated them as &quot;lower priority&quot; by accident.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-22 19:09</div>
            <div class="timeline-body"><p>Basically: I think everywhere else we actually <em>do</em> encode that mismatching platform tag is more compatible than mismatching Python implementation or ABI:</p>
<pre><code>#[derive(Debug, Eq, Ord, PartialEq, PartialOrd, Clone)]
pub enum IncompatibleTag {
    /// The tag is invalid and cannot be used.
    Invalid,
    /// The Python implementation tag is incompatible.
    Python,
    /// The ABI tag is incompatible.
    Abi,
    /// The Python version component of the ABI tag is incompatible with `requires-python`.
    AbiPythonVersion,
    /// The platform tag is incompatible.
    Platform,
}
</code></pre>
<p>So the system assumes that in various places. Right now, we would actually actively prioritize Python 2 wheels over Python 3 wheels.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-22 19:51</div>
            <div class="timeline-body"><p>Thanks for explaining! Makes sense to me then.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Treat invalid platform as more compatible than invalid Python&quot; to &quot;Treat less compatible tags as lower priority in resolver&quot; by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-26 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-26 14:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-26 14:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-26 14:51</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:49:30 UTC
    </footer>
</body>
</html>
