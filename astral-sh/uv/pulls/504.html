<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Move simple index queries to `CachedClient` - astral-sh/uv #504</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Move simple index queries to <code>CachedClient</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/504">#504</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-11-27 13:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>Replaces the usage of <code>http-cache-reqwest</code> for simple index queries with our custom cached client, removing <code>http-cache-reqwest</code> altogether.</p>
<p>The new cache paths are <code>&lt;cache&gt;/simple-v0/&lt;index&gt;/&lt;package_name&gt;.json</code>. I could not test with a non-pypi index since i&#x27;m not aware of any other json indices (jax and torch are both html indices).</p>
<p>In a future step, we can transform the response to be a <code>HashMap&lt;Version, {source_dists: Vec&lt;(SourceDistFilename, File)&gt;, wheels: Vec&lt;(WheeFilename, File)&gt;}</code> (independent of python version, this cache is used by all environments together). This should speed up cache deserialization a bit, since we don&#x27;t need to try source dist and wheel anymore and drop incompatible dists, and it should make building the <code>VersionMap</code> simpler. We can speed this up even further by splitting into a version lists and the info for each version. I&#x27;m mentioning this because deserialization was a major bottleneck in the rust part of the old python prototype.</p>
<p>Fixes #481</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-client/src/cached_client.rs</code>:179 on 2023-11-27 19:31</div>
            <div class="timeline-body"><p>Nit: can we expand this message to be more descriptive? I wouldn&#x27;t know what <code>Fresh {url}</code> means in the logs from this alone.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-client/src/cached_client.rs</code>:185 on 2023-11-27 19:31</div>
            <div class="timeline-body"><p>Nit: inline <code>{url}</code> here and elsewhere.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-client/src/cached_client.rs</code>:179 on 2023-11-27 19:31</div>
            <div class="timeline-body"><p>Maybe like: <code>Found fresh cache response for: {url}</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-11-27 19:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-27 19:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>scripts/benchmarks/requirements/jax.in</code>:1 on 2023-11-27 19:32</div>
            <div class="timeline-body"><p>Should we just omit this then? Why check it in if it&#x27;s broken?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-28 00:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-28 00:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-11-28 00:11</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:42:45 UTC
    </footer>
</body>
</html>
