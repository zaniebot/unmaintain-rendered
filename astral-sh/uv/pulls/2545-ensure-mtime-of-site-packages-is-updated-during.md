```yaml
number: 2545
title: Ensure mtime of site packages is updated during wheel installation
type: pull_request
state: merged
author: zanieb
labels:
  - bug
assignees: []
merged: true
base: main
head: zb/clone-mtime
created_at: 2024-03-19T17:50:08Z
updated_at: 2024-03-20T00:54:06Z
url: https://github.com/astral-sh/uv/pull/2545
synced_at: 2026-01-10T14:49:08Z
```

# Ensure mtime of site packages is updated during wheel installation

---

_Pull request opened by @zanieb on 2024-03-19 17:50_

Closes https://github.com/astral-sh/uv/issues/2530



---

_Label `bug` added by @zanieb on 2024-03-19 17:50_

---

_Review comment by @zanieb on `crates/install-wheel-rs/src/linker.rs`:275 on 2024-03-19 17:52_

Arguably we could avoid failing on these, but it seems nice to know if we're leaving them around due to some failure.

---

_@zanieb reviewed on 2024-03-19 17:52_

---

_Review comment by @zanieb on `crates/install-wheel-rs/src/linker.rs`:259 on 2024-03-19 17:54_

We should probably add a test that asserts the mtime changes on install

---

_@zanieb reviewed on 2024-03-19 17:54_

---

_@zanieb reviewed on 2024-03-19 17:54_

---

_Review comment by @zanieb on `crates/install-wheel-rs/src/linker.rs`:268 on 2024-03-19 17:54_

We could also use a `SmallRng` here, I don't have strong feelings.

---

_Review comment by @charliermarsh on `crates/install-wheel-rs/src/linker.rs`:275 on 2024-03-19 18:00_

Can we instead use `filetime::set_file_mtime` to do the appropriate syscalls and set the modification time directly?

---

_@charliermarsh reviewed on 2024-03-19 18:00_

---

_@zanieb reviewed on 2024-03-19 18:07_

---

_Review comment by @zanieb on `crates/install-wheel-rs/src/linker.rs`:275 on 2024-03-19 18:07_

I'm looking into that next yeah, https://doc.rust-lang.org/std/fs/struct.File.html#method.set_modified also

---

_@charliermarsh reviewed on 2024-03-19 18:08_

---

_Review comment by @charliermarsh on `crates/install-wheel-rs/src/linker.rs`:275 on 2024-03-19 18:08_

I thought that _may_ not work for directories but I didn't test it. I only tested `filetime` crate.

---

_@zanieb reviewed on 2024-03-19 18:22_

---

_Review comment by @zanieb on `crates/install-wheel-rs/src/linker.rs`:275 on 2024-03-19 18:22_

https://github.com/astral-sh/uv/pull/2545/commits/205b224ac5a475618520c1ea8aeeff9703eb677b

---

_@zanieb reviewed on 2024-03-19 18:28_

---

_Review comment by @zanieb on `crates/install-wheel-rs/src/linker.rs`:270 on 2024-03-19 18:28_

I'm a little unsure about this error handling but I'd prefer not to fail here?

---

_@zanieb reviewed on 2024-03-19 18:41_

---

_Review comment by @zanieb on `crates/install-wheel-rs/src/linker.rs`:277 on 2024-03-19 18:41_

https://github.com/andrewhickman/fs-err/issues/54

---

_@charliermarsh reviewed on 2024-03-19 18:41_

---

_Review comment by @charliermarsh on `crates/uv/tests/pip_install.rs`:10 on 2024-03-19 18:41_

You could also put this import within the test -- we tend to do that in a few other places.

---

_@charliermarsh approved on 2024-03-19 18:41_

---

_Comment by @charliermarsh on 2024-03-19 18:41_

Nice, thanks!

---

_Renamed from "Ensure mtime of site packages is updated during wheel installation on macOS" to "Ensure mtime of site packages is updated during wheel installation" by @zanieb on 2024-03-19 18:44_

---

_Comment by @zanieb on 2024-03-19 18:44_

Interestingly the test failed on Ubuntu so I removed the macOS gate and we'll do this whenever we clone

---

_Comment by @charliermarsh on 2024-03-19 18:44_

That's cool with me.

---

_Comment by @zanieb on 2024-03-19 18:48_

Hm it seems to be flaky...

---

_Comment by @charliermarsh on 2024-03-19 18:52_

The test, or the fix?

---

_Comment by @zanieb on 2024-03-19 18:56_

Well both I guess :) neither the initial reproduction or the test have ever failed for me locally though.

We might want to bump `now` by `1` to make this particularly robust... I'm hesitant though. Hopefully moving it to after the clone itself will ensure the time isn't the same as when it started â€” thinking the flake might be resolution related?

---

_Comment by @zanieb on 2024-03-19 19:14_

Hm seems like the test is still flaky.. will investigate further.

---

_Comment by @zanieb on 2024-03-20 00:40_

It was just the test, `mtime()` is second-resolution but we're faster than that sometimes so we need to compare `mtime_nsec()`

---

_Merged by @zanieb on 2024-03-20 00:54_

---

_Closed by @zanieb on 2024-03-20 00:54_

---

_Branch deleted on 2024-03-20 00:54_

---
