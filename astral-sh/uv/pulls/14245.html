<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Normalize index URLs to remove trailing slash - astral-sh/uv #14245</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Normalize index URLs to remove trailing slash</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/14245">#14245</a>
        opened by <a href="https://github.com/jtfmumm">@jtfmumm</a>
        on 2025-06-24 16:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a></div>
            <div class="timeline-body"><p>This PR updates <code>IndexUrl</code> parsing to normalize non-file URLs by removing trailing slashes. It also normalizes registry source URLs when using them to validate the lockfile.</p>
<p>Prior to this change, when writing an index URL to the lockfile, uv would use a trailing slash if present in the provided URL and no trailing slash otherwise. This can cause surprising behavior. For example, <code>uv lock --locked</code> will fail when a package is added with an <code>--index</code> value without a trailing slash and then <code>uv lock --locked</code> is run with a <code>pyproject.toml</code> version of the index URL that contains a trailing slash. This PR fixes this and adds a test for the scenario.</p>
<p>It might be safe to normalize file URLs in the same way, but since slashes have a well-defined meaning in the context of files and directories, I chose not to normalize them here.</p>
<p>Closes #13707.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/jtfmumm">@jtfmumm</a> on 2025-06-24 16:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-06-24 16:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv/tests/it/lock.rs</code>:28264 on 2025-06-24 16:20</div>
            <div class="timeline-body"><p>Here&#x27;s the new test</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/konstin">@konstin</a> on 2025-06-24 18:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2025-06-24 19:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-06-24 19:33</div>
            <div class="timeline-body"><p>In the &quot;Is this lockfile up-to-date check?&quot;, should we also strip trailing slashes?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on 2025-06-25 08:50</div>
            <div class="timeline-body"><blockquote>
<p>In the &quot;Is this lockfile up-to-date check?&quot;, should we also strip trailing slashes?</p>
</blockquote>
<p>Updated and added a test for a pre-existing lockfile with trailing slashes in registry sources.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-06-27 14:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-distribution-types/src/index_url.rs</code>:46 on 2025-06-27 14:28</div>
            <div class="timeline-body"><p>Could this be <code>Some(Scheme::file)</code>, instead of the nested <code>if</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2025-06-27 14:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-06-27 14:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-distribution-types/src/file.rs</code>:182 on 2025-06-27 14:31</div>
            <div class="timeline-body"><p>I think this and <code>without_fragment</code> could both return <code>Cow</code>? But that can be a separate PR if you want to try it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-06-27 14:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-distribution-types/src/file.rs</code>:182 on 2025-06-27 14:38</div>
            <div class="timeline-body"><p>Makes sense to me. I&#x27;ll open as a separate PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-06-27 15:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-distribution-types/src/index_url.rs</code>:46 on 2025-06-27 15:08</div>
            <div class="timeline-body"><p>That was what I initially wanted to do, but there numerous other <code>Scheme</code> variants for things like <code>bzr+file</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/jtfmumm">@jtfmumm</a> on 2025-06-27 15:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/jtfmumm">@jtfmumm</a> on 2025-06-27 15:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-27 15:11</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:52:50 UTC
    </footer>
</body>
</html>
