<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cache downloaded wheel when range requests aren't supported - astral-sh/uv #5089</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Cache downloaded wheel when range requests aren't supported</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/5089">#5089</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-07-16 01:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>When range requests aren't supported, we fall back to streaming the wheel, stopping as soon as we hit a <code>METADATA</code> file. This is a small optimization, but the downside is that we don't get to cache the resulting wheel...</p>
<p>We don't know whether <code>METADATA</code> will be at the beginning or end of the wheel, but it <em>seems</em> like a better tradeoff to download and cache the entire wheel?</p>
<p>Closes: https://github.com/astral-sh/uv/issues/5088.</p>
<p>Sort of a revert of: https://github.com/astral-sh/uv/pull/1792.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2024-07-16 02:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @charliermarsh on 2024-07-16 02:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @charliermarsh on 2024-07-16 02:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2024-07-16 02:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-16 02:24</div>
            <div class="timeline-body"><p>I'm sort of torn on this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-16 04:21</div>
            <div class="timeline-body"><p>Would it be a pain to use a heuristic like... only finish downloading if it's greater than some percentage into the file? If we find a metadata entry 10% into the file it seems excessive to unconditionally download the whole wheel when we're trying many versions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/morotti">@morotti</a> on 2024-07-16 09:27</div>
            <div class="timeline-body"><blockquote>
<p>We don't know whether <code>METADATA</code> will be at the beginning or end of the wheel, but it <em>seems</em> like a better tradeoff to download and cache the entire wheel?</p>
</blockquote>
<p>METADATA are at end of the wheel, as per PEP 407. https://peps.python.org/pep-0427/#recommended-archiver-features</p>
<p>I vaguely recall there was a similar discussion in pip to try to only download metadata (I can't find the thread anymore). They checked many packages and only found one exception to confirm the rule, some google packages had the metadata at the start (around tensorflow if I recall well), because google used their own build system that did its own thing. I think they fixed it a while back.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-07-16 10:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-16 13:07</div>
            <div class="timeline-body"><p>@zanieb - Perhaps... It would be harder to implement for sure. Given that this is not the happy path and PEP 407 recommends putting the archive at the end anyway, I'm inclined to just move forward with it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-07-16 13:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-07-16 13:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-16 13:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:38:09 UTC
    </footer>
</body>
</html>
