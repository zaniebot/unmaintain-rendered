<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cache tool environments in `uv tool run` - astral-sh/uv #4777</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Cache tool environments in <code>uv tool run</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/4777">#4777</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-07-03 15:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>The basic strategy:</p>
<ul>
<li>When the user does <code>uv tool run</code>, we resolve the <code>from</code> and <code>with</code> requirements (always).</li>
<li>After resolving, we generate a hash of the requirements. For now, I&#x27;m just converting to a lockfile and hashing <em>that</em>, but that&#x27;s an implementation detail.</li>
<li>Once we have a hash, we <em>also</em> hash the interpreter.</li>
<li>We then store environments in <code>${CACHE_DIR}/${INTERPRETER_HASH}/${RESOLUTION_HASH}</code>.</li>
</ul>
<p>Some consequences:</p>
<ul>
<li>We cache based on the interpreter, so if you request a different Python, we&#x27;ll create a new environment (even if they&#x27;re compatible). This has the nice side-effect of ensuring that we don&#x27;t use environments for interpreters that were later deleted.</li>
<li>We cache the <code>from</code> and <code>with</code> together. In practice, we may want to cache them separately, then layer them? But this is also an implementation detail that we could change later.</li>
<li>Because we use the lockfile as the cache key, we will invalidate the cache when the format changes. That seems ok, but we could improve it in the future by generating a stable hash from a lockfile that&#x27;s independent of the schema.</li>
</ul>
<p>There are a lot of TODOs, but it&#x27;d be nice to get alignment on the strategy before I spend time knocking them out.</p>
<p>Closes <a href="https://github.com/astral-sh/uv/issues/4752">astral-sh/uv#4752</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-03 15:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-03 17:16</div>
            <div class="timeline-body"><p>Gonna open a new PR when it&#x27;s ready to avoid notification spam.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-03 17:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:46:20 UTC
    </footer>
</body>
</html>
