<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fetch git trees on demand - astral-sh/uv #3950</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fetch git trees on demand</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/3950">#3950</a>
        opened by <a href="https://github.com/ibraheemdev">@ibraheemdev</a>
        on 2024-05-31 21:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-05-31 21:21</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Pass <code>--filter=tree:0</code> when fetching from a git repository. This allows us to load trees and blobs lazily on checkout, which can drastically reduce the amount of data transferred, especially for large/old repositories.</p>
<p>This seems to be supported <a href="https://github.com/git/git/commit/77d503757d6328703f9571a4432dd83800bc26bb">since Git 2.20</a>, released late 2018.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @ibraheemdev on 2024-05-31 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-05-31 21:58</div>
            <div class="timeline-body"><p>Relevant: https://github.com/pypa/pip/issues/11043</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-06-04 00:28</div>
            <div class="timeline-body"><p>I'm not really sure why this is failing in CI. The error messages suggest that the Git <em>server</em> does not support partial clones, which is surprising considering I have tests passing locally. It's possible that the error message is misleading and the version of Git on the runner does not fully support partial clones, which would also be surprising. I suspect that is also a red herring because pip doesn't seem to have any issues.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-04 13:43</div>
            <div class="timeline-body"><p>I can try to look at this too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-05 13:35</div>
            <div class="timeline-body"><p>I tried running tests locally and the suite hangs on <code>compile_git_mismatched_name</code> (which is eventually cancelled)</p>
<pre><code>â¯ git -v
git version 2.39.3 (Apple Git-146)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-05 14:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-git/src/git.rs</code>:368 on 2024-06-05 14:17</div>
            <div class="timeline-body"><p>If I comment this one out, the test suite doesn't hang ğŸ‰ but there are still a bunch of failures e.g.</p>
<pre><code>Snapshot: reinstall_git
Source: crates/uv/tests/pip_sync.rs:2010
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Expression: snapshot
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-old snapshot
+new results
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    0       â”‚-success: true
    1       â”‚-exit_code: 0
          0 â”‚+success: false
          1 â”‚+exit_code: 2
    2     2 â”‚ ----- stdout -----
    3     3 â”‚ 
    4     4 â”‚ ----- stderr -----
    5       â”‚-Resolved 1 package in [TIME]
    6       â”‚-Downloaded 1 package in [TIME]
    7       â”‚-Installed 1 package in [TIME]
    8       â”‚- + uv-public-pypackage==0.1.0 (from git+https://github.com/astral-test/uv-public-pypackage@b270df1a2fb5d012294e9aaf05e7e0bab1e6a389)
          5 â”‚+error: Failed to download and build `uv-public-pypackage @ git+https://github.com/astral-test/uv-public-pypackage@b270df1a2fb5d012294e9aaf05e7e0bab1e6a389`
          6 â”‚+  Caused by: Git operation failed
          7 â”‚+  Caused by: process didn't exit successfully: `git reset --hard b270df1a2fb5d012294e9aaf05e7e0bab1e6a389` (exit status: 128)
          8 â”‚+--- stderr
          9 â”‚+error: unable to read sha1 file of .gitignore (e69de29bb2d1d6434b8b29ae775ad8c2e48c5391)
         10 â”‚+error: unable to read sha1 file of README.md (0a50718e2c98ce585c9f06d68e853e06cc1c307f)
         11 â”‚+error: unable to read sha1 file of dist/uv_public_pypackage-0.1.0-py3-none-any.whl (30de426777a0e739ccadd993ea1313b95f6386b4)
         12 â”‚+error: unable to read sha1 file of dist/uv_public_pypackage-0.1.0.tar.gz (4d8eb8d9e7558239356266c836da3bfca3aca8f1)
         13 â”‚+error: unable to read sha1 file of pyproject.toml (f971ef95a81ef15fed29090cdbd46e779f78d8e3)
         14 â”‚+error: unable to read sha1 file of src/uv_public_pypackage/__init__.py (3dc1f76bc69e3f559bee6253b24fc93acee9e1f9)
         15 â”‚+fatal: Could not reset index file to revision 'b270df1a2fb5d012294e9aaf05e7e0bab1e6a389'.
</code></pre>
<p>I wonder if the CI failures are that the &quot;local&quot; server doesn't support filtering?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-05 14:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-git/src/git.rs</code>:368 on 2024-06-05 14:27</div>
            <div class="timeline-body"><p>In https://github.com/astral-sh/uv/pull/4047/commits/7140a27e38b5e5575c83cb02d3341ea14d4c3890, allowing filtering on the &quot;local&quot; server makes the warning &quot;filtering not recognized by server, ignoring&quot; go away.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-05 14:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-git/src/git.rs</code>:368 on 2024-06-05 14:27</div>
            <div class="timeline-body"><p>However, if I set that option locally the test suite still hangs on my machine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-05 14:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-git/src/git.rs</code>:368 on 2024-06-05 14:33</div>
            <div class="timeline-body"><p>If I revert https://github.com/astral-sh/uv/pull/3950/commits/29839a0a92c59c2546db134d14d73c2c12ee2c35 the test suite hangs on two tests my machine, but the rest of the tests pass. The other hanging test is <code>pip_entrypoints</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-05 14:45</div>
            <div class="timeline-body"><p>The Ubuntu CI git version is <code>2.45.1</code> fyi</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-05 14:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-git/src/git.rs</code>:368 on 2024-06-05 14:56</div>
            <div class="timeline-body"><p>Here's some very verbose git logs for the erroring command</p>
<pre><code>rror: Failed to download and build `uv-public-pypackage @ git+https://github.com/astral-test/uv-public-pypackage@b270df1a2fb5d012294e9aaf05e7e0bab1e6a389`
  Caused by: Git operation failed
  Caused by: process didn't exit successfully: `git reset --hard b270df1a2fb5d012294e9aaf05e7e0bab1e6a389` (exit status: 128)
--- stderr
    common-main.c:55                  version 2.45.1
    common-main.c:56                  start git reset --hard b270df1a2fb5d012294e9aaf05e7e0bab1e6a389
    compat/linux/procinfo.c:170       cmd_ancestry uv &lt;- pip_sync-faf22c &lt;- cargo-nextest &lt;- bash &lt;- Runner.Worker &lt;- Runner.Listener &lt;- node &lt;- runsvc.sh &lt;- systemd
    repository.c:158                  worktree /tmp/.tmpmBoxHO/git-v0/checkouts/8dab139913c4b566/b270df1
    git.c:465               trace: built-in: git reset --hard b270df1a2fb5d012294e9aaf05e7e0bab1e6a389
    git.c:466                         cmd_name reset (reset)
    builtin/reset.c:439               cmd_mode hard
    run-command.c:724                 child_start[0] git -c fetch.negotiationAlgorithm=noop fetch origin --no-tags --no-write-fetch-head --recurse-submodules=no --filter=blob:none --stdin
    run-command.c:657       trace: run_command: git -c fetch.negotiationAlgorithm=noop fetch origin --no-tags --no-write-fetch-head --recurse-submodules=no --filter=blob:none --stdin
    common-main.c:55                  version 2.45.1
    common-main.c:56                  start /usr/lib/git-core/git -c fetch.negotiationAlgorithm=noop fetch origin --no-tags --no-write-fetch-head --recurse-submodules=no --filter=blob:none --stdin
    compat/linux/procinfo.c:170       cmd_ancestry git &lt;- uv &lt;- pip_sync-faf22c &lt;- cargo-nextest &lt;- bash &lt;- Runner.Worker &lt;- Runner.Listener &lt;- node &lt;- runsvc.sh &lt;- systemd
    repository.c:158                  worktree /tmp/.tmpmBoxHO/git-v0/checkouts/8dab139913c4b566/b270df1
    git.c:465               trace: built-in: git fetch origin --no-tags --no-write-fetch-head --recurse-submodules=no --filter=blob:none --stdin
    git.c:466                         cmd_name fetch (reset/fetch)
    run-command.c:724                 child_start[0] 'git-upload-pack '\''/tmp/.tmpmBoxHO/git-v0/db/8dab139913c4b566'\'''
    run-command.c:657       trace: run_command: unset GIT_CONFIG_PARAMETERS GIT_PREFIX; GIT_PROTOCOL=version=2 'git-upload-pack '\''/tmp/.tmpmBoxHO/git-v0/db/8dab139913c4b566'\'''
    common-main.c:55                  version 2.45.1
    common-main.c:56                  start git-upload-pack /tmp/.tmpmBoxHO/git-v0/db/8dab139913c4b566
    compat/linux/procinfo.c:170       cmd_ancestry sh &lt;- git &lt;- git &lt;- uv &lt;- pip_sync-faf22c &lt;- cargo-nextest &lt;- bash &lt;- Runner.Worker &lt;- Runner.Listener &lt;- node &lt;- runsvc.sh &lt;- systemd
    git.c:465               trace: built-in: git upload-pack /tmp/.tmpmBoxHO/git-v0/db/8dab139913c4b566
    git.c:466                         cmd_name upload-pack (reset/fetch/upload-pack)
    usage.c:64                        error remote error: upload-pack: not our ref 732879a9c8f6a3df2d7f6c9b7c5a17896b9ec2fa
fatal: remote error: upload-pack: not our ref 732879a9c8f6a3df2d7f6c9b7c5a17896b9ec2fa
    usage.c:78                        exit elapsed:0.033049 code:128
    trace2/tr2_tgt_normal.c:128       atexit elapsed:0.033058 code:128
    usage.c:64                        error git upload-pack: not our ref 732879a9c8f6a3df2d7f6c9b7c5a17896b9ec2fa
    run-command.c:977                 child_exit[0] pid:33450 code:128 elapsed:0.039020
fatal: git upload-pack: not our ref 732879a9c8f6a3df2d7f6c9b7c5a17896b9ec2fa
    usage.c:78                        exit elapsed:0.012012 code:128
    trace2/tr2_tgt_normal.c:128       atexit elapsed:0.012018 code:128
    usage.c:64                        error could not fetch 732879a9c8f6a3df2d7f6c9b7c5a17896b9ec2fa from promisor remote
fatal: could not fetch 732879a9c8f6a3df2d7f6c9b7c5a17896b9ec2fa from promisor remote
    usage.c:78                        exit elapsed:0.041203 code:128
    trace2/tr2_tgt_normal.c:128       atexit elapsed:0.041236 code:128
</code></pre>
<p>https://github.com/astral-sh/uv/actions/runs/9386288785/job/25846511187?pr=4047</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-git/src/git.rs</code>:368 on 2024-06-05 16:37</div>
            <div class="timeline-body"><p>Continuing this commentary....</p>
<p>If I upgrade my local git client the tests fail</p>
<pre><code>â¯ git -v
git version 2.45.2
â¯ ct allowed_transitive_git_dependency
    Finished `test` profile [unoptimized + debuginfo] target(s) in 0.14s
    Starting 1 test across 52 binaries (1008 skipped; run ID: f9d63952-2ca1-4121-9989-2d78257fbdc3, nextest profile: default)
        FAIL [   1.171s] uv::pip_compile allowed_transitive_git_dependency
error: test run failed

â¯ export PATH=&quot;/usr/bin:$PATH&quot;
â¯ git -v
git version 2.39.3 (Apple Git-146)
â¯ ct allowed_transitive_git_dependency
    Finished `test` profile [unoptimized + debuginfo] target(s) in 0.14s
    Starting 1 test across 52 binaries (1008 skipped; run ID: f9d63952-2ca1-4121-9989-2d78257fbdc3, nextest profile: default)
        PASS [   6.603s] uv::pip_compile allowed_transitive_git_dependency
------------
     Summary [   6.603s] 1 test run: 1 passed, 1008 skipped
</code></pre>
<p>so it looks like it's actually a problem with <em>newer</em> git clients.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-05 16:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-15 19:07</div>
            <div class="timeline-body"><p>Gonna close this as stale / in-actionable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-01-15 19:07</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:12 UTC
    </footer>
</body>
</html>
