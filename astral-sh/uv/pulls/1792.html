<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream zip archive when fetching non-range-request metadata - astral-sh/uv #1792</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Stream zip archive when fetching non-range-request metadata</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/1792">#1792</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-02-21 03:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-21 03:01</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>If a registry doesn't support range requests, then today, we download the entire wheel to disk and then read the metadata from the downloaded archive. This PR instead modifies the registry client to stream the zipfile and stop as soon as it's seen the metadata, which should be more efficient.</p>
<p>Closes https://github.com/astral-sh/uv/issues/1596.</p>
<h2>Test Plan</h2>
<p>Made this the <em>only</em> path for downloading metadata; verified that the test suite passed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @charliermarsh on 2024-02-21 03:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-21 03:12</div>
            <div class="timeline-body"><p>Something like 10-20% faster:</p>
<pre><code>puffin on î‚  charlie/async-meta:main [$!â‡¡] is ğŸ“¦ v0.1.6 via ğŸ v3.12.1 (.venv) via ğŸ¦€ v1.75.0
â¯ python -m scripts.bench \
        --uv-path ./target/release/main \
        --uv-path ./target/release/uv \
        ./scripts/requirements/dtlssocket.in --benchmark resolve-cold --min-runs 50
Benchmark 1: ./target/release/main (resolve-cold)
  Time (mean Â± Ïƒ):     896.5 ms Â±  79.0 ms    [User: 404.9 ms, System: 202.6 ms]
  Range (min â€¦ max):   726.3 ms â€¦ 1075.0 ms    50 runs

Benchmark 2: ./target/release/uv (resolve-cold)
  Time (mean Â± Ïƒ):     802.7 ms Â±  58.6 ms    [User: 420.7 ms, System: 179.8 ms]
  Range (min â€¦ max):   722.5 ms â€¦ 953.8 ms    50 runs

Summary
  './target/release/uv (resolve-cold)' ran
    1.12 Â± 0.13 times faster than './target/release/main (resolve-cold)'
puffin on î‚  charlie/async-meta:main [$!â‡¡] is ğŸ“¦ v0.1.6 via ğŸ v3.12.1 (.venv) via ğŸ¦€ v1.75.0 took 1m34s
â¯ python -m scripts.bench \
        --uv-path ./target/release/main \
        --uv-path ./target/release/uv \
        ./scripts/requirements/black.in --benchmark resolve-cold --min-runs 50
Benchmark 1: ./target/release/main (resolve-cold)
  Time (mean Â± Ïƒ):     380.8 ms Â±  83.5 ms    [User: 102.9 ms, System: 39.9 ms]
  Range (min â€¦ max):   281.8 ms â€¦ 550.7 ms    50 runs

Benchmark 2: ./target/release/uv (resolve-cold)
  Time (mean Â± Ïƒ):     325.3 ms Â±  44.7 ms    [User: 113.8 ms, System: 26.9 ms]
  Range (min â€¦ max):   269.4 ms â€¦ 411.9 ms    50 runs

Summary
  './target/release/uv (resolve-cold)' ran
    1.17 Â± 0.30 times faster than './target/release/main (resolve-cold)'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-02-21 03:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-02-21 03:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-02-21 03:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 15:33:43 UTC
    </footer>
</body>
</html>
