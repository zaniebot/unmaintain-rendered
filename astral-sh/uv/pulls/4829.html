<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply extra to overrides and constraints - astral-sh/uv #4829</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Apply extra to overrides and constraints</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/4829">#4829</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2024-07-05 09:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>This is an attempt to solve https://github.com/astral-sh/uv/issues/ by applying the extra marker of the requirement to overrides and constraints.</p>
<p>Say in <code>a</code> we have a requirements</p>
<pre><code>b==1; python_version &lt; &quot;3.10&quot;
c==1; extra == &quot;feature&quot;
</code></pre>
<p>and overrides</p>
<pre><code>b==2; python_version &lt; &quot;3.10&quot;
b==3; python_version &gt;= &quot;3.10&quot;
c==2; python_version &lt; &quot;3.10&quot;
c==3; python_version &gt;= &quot;3.10&quot;
</code></pre>
<p>Our current strategy is to discard the markers in the original requirements. This means that on 3.12 for <code>a</code> we install <code>b==3</code>, but it also means that we add <code>c</code> to <code>a</code> without <code>a[feature]</code>, causing #4826. With this PR, the new requirement become,</p>
<pre><code>b==2; python_version &lt; &quot;3.10&quot;
b==3; python_version &gt;= &quot;3.10&quot;
c==2; python_version &lt; &quot;3.10&quot; and extra == &quot;feature&quot;
c==3; python_version &gt;= &quot;3.10&quot; and extra == &quot;feature&quot;
</code></pre>
<p>allowing to override markers while preserving optional dependencies as such.</p>
<p>Fixes #4826</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @konstin on 2024-07-05 09:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-05 11:58</div>
            <div class="timeline-body"><p>I think we do need to join extra markers specifically here...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-05 11:59</div>
            <div class="timeline-body"><p>Another reasonable option would be to ignore markers in the overrides file and just respect the original markers, but that means you can't replace dependencies on a per-platform basis.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Join requirement and override markers" to "Apply extra to overrides and " by @konstin on 2024-07-08 10:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Apply extra to overrides and " to "Apply extra to overrides and constraints" by @konstin on 2024-07-08 10:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @konstin on 2024-07-08 11:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-07-08 11:12</div>
            <div class="timeline-body"><p>Changed this to only apply extras, properly ready now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-07-08 13:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/resolver/mod.rs</code>:1469 on 2024-07-08 13:10</div>
            <div class="timeline-body"><p>Why clone here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-07-08 16:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-resolver/src/resolver/mod.rs</code>:1469 on 2024-07-08 16:26</div>
            <div class="timeline-body"><p>This is now a <code>Cow</code>, so we're generally cloning a ref still. Trying to avoid this clone cause the borrow checker to yell a lot because we're using a reference to the requirement for the chained iterator and it doesn't like the closures with a reference to a value we're also moving.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-07-09 17:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2024-07-09 18:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2024-07-09 18:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-09 18:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-01 00:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-configuration/src/constraints.rs</code>:70 on 2024-08-01 00:06</div>
            <div class="timeline-body"><p>@konstin -- This is really random, but is this necessary for constraints? By adding a constraint, we know that the base package was added as a dependency, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-01 00:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-configuration/src/constraints.rs</code>:70 on 2024-08-01 00:07</div>
            <div class="timeline-body"><p>Also, we already merge markers for constraints.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-08-01 07:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-configuration/src/constraints.rs</code>:70 on 2024-08-01 07:23</div>
            <div class="timeline-body"><p>Hmm not sure, i imagine something like:</p>
<p>constraint: <code>bar &lt;2</code></p>
<p>requirement: <code>root[foo] -&gt; bar</code></p>
<p>In that case, we should only add <code>bar&lt;2</code> for <code>root[foo]</code>, not for <code>root</code>.</p>
<p>But it could also be we only need this for overrides.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:37:57 UTC
    </footer>
</body>
</html>
