<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preserve end-of-line comment whitespace when editing `pyproject.toml` - astral-sh/uv #16734</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Preserve end-of-line comment whitespace when editing <code>pyproject.toml</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/16734">#16734</a>
        opened by <a href="https://github.com/terror">@terror</a>
        on 2025-11-14 08:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/terror">@terror</a> on 2025-11-14 08:47</div>
            <div class="timeline-body"><p>Resolves https://github.com/astral-sh/uv/issues/16719</p>
<p><code>uv add</code> collapses multiple spaces before inline comments in <code>[project.dependencies]</code>, causing unrelated diffs and moving comments onto the wrong columns.  This diff captures the exact whitespace padding that preceded each end-of-line comment when parsing the array and reuses it when formatting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-11-14 09:30</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/uv/branches/terror%3Acomment-formatting?utm_source=github&amp;utm_medium=comment&amp;utm_content=header">CodSpeed Performance Report</a></h2>
<h3>Merging #16734 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>terror:comment-formatting</code> (65818fe) with <code>main</code> (7d8634b)</sub></p>
<h3>Summary</h3>
<p><code>âœ… 6</code> untouched</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/terror">@terror</a> on 2025-11-15 03:05</div>
            <div class="timeline-body"><blockquote>
<h2><a href="https://codspeed.io/astral-sh/uv/branches/terror%3Acomment-formatting?utm_source=github&amp;utm_medium=comment&amp;utm_content=header">CodSpeed Performance Report</a></h2>
<h3>Merging #16734 will <strong>not alter performance</strong></h3>
<p>Comparing <code>terror:comment-formatting</code> (<a href="https://github.com/astral-sh/uv/commit/e868edbd7f186039ce8cd6c165b6e86204b34766">e868edb</a>) with <code>main</code> (<a href="https://github.com/astral-sh/uv/commit/f5ce5b47c816b371f68c91f4518474401157dd53">f5ce5b4</a>)</p>
<h3>Summary</h3>
<p><code>âœ… 6</code> untouched</p>
</blockquote>
<p>This is cool ðŸ‘€</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-workspace/src/pyproject_mut.rs</code>:1702 on 2025-11-19 11:15</div>
            <div class="timeline-body"><p>Does this mean we're inserting a whitespace when there was non before?</p>
<p>If we want to store padding specifically for end-of-line comments, we can store the data in the <code>CommentType::EndOfLine</code> variant and avoid the <code>Option&lt;T&gt;</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-11-19 11:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/terror">@terror</a> reviewed on 2025-11-19 17:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/terror">@terror</a> on <code>crates/uv-workspace/src/pyproject_mut.rs</code>:1702 on 2025-11-19 17:15</div>
            <div class="timeline-body"><p>Ah good catch, I've refactored this to carry padding on the variant instead (and thus, no longer default if there's no padding).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-workspace/src/pyproject_mut.rs</code>:1797 on 2025-11-20 16:17</div>
            <div class="timeline-body"><p>For these it doesn't matter, but anything more complex I recommend snapshots, they are easier to maintain if we ever want to change the style</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-workspace/src/pyproject_mut.rs</code>:1632 on 2025-11-20 17:24</div>
            <div class="timeline-body"><p>Sorry for coming up with this only now, but can we make those safer by using e.g. <code>split_once</code>? Indexing can panic, and it's easy to get logic such as this wrong, so we try to use non-indexing versions where they aren't too inconvenient or too slow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-11-20 17:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2025-11-20 19:14</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @konstin on 2025-11-20 19:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Preserve inline comment spacing when editing dependency arrays" to "Preserve end-of-line comment spacing when editing dependency arrays" by @konstin on 2025-11-20 19:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Preserve end-of-line comment spacing when editing dependency arrays" to "Preserve end-of-line comment whitespace when editing `pyproject.toml`" by @konstin on 2025-11-20 19:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2025-11-20 19:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-11-20 19:15</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:32 UTC
    </footer>
</body>
</html>
