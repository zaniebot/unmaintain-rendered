<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Load credentials for explicit members when lowering - astral-sh/uv #15844</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Load credentials for explicit members when lowering</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/15844">#15844</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2025-09-15 00:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>If the target for <code>uv pip compile</code> is a <code>pyproject.toml</code> in a subdirectory, we won't have loaded the credentials when we go to lower (since it won't be loaded as part of &quot;configuration discovery&quot;). We now add those indexes just-in-time.</p>
<p>Closes https://github.com/astral-sh/uv/issues/15362.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @charliermarsh on 2025-09-15 00:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2025-09-15 00:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2025-09-15 00:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2025-09-15 00:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-distribution/src/metadata/lowering.rs</code>:226 on 2025-09-15 07:40</div>
            <div class="timeline-body"><p>nit: We can move this outside the let-Some to avoid stateful action in the <code>inspect</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2025-09-15 07:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-09-15 13:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-distribution/src/metadata/lowering.rs</code>:226 on 2025-09-15 13:20</div>
            <div class="timeline-body"><p>It's kind of a pain because the thing we return in the <code>map</code> isn't the same as this <code>index</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-distribution/src/metadata/lowering.rs</code>:226 on 2025-09-15 13:23</div>
            <div class="timeline-body"><p>I thought like this:</p>
<pre><code class="language-rust">                            // Identify the named index from either the project indexes or the workspace indexes,
                            // in that order.
                            let Some(index) = locations
                                .indexes()
                                .filter(|index| matches!(index.origin, Some(Origin::Cli)))
                                .chain(project_indexes.iter())
                                .chain(workspace.indexes().iter())
                                .find(|Index { name, .. }| {
                                    name.as_ref().is_some_and(|name| *name == index)
                                })
                            else {
                                return Err(LoweringError::MissingIndex(
                                    requirement.name.clone(),
                                    index,
                                ));
                            };
                            if let Some(credentials) = index.credentials() {
                                let credentials = Arc::new(credentials);
                                uv_auth::store_credentials(index.raw_url(), credentials);
                            }
                            let Index {
                                url, format: kind, ..
                            } = index;
                            let index = IndexMetadata {
                                url: url.clone(),
                                format: *kind,
                            };
</code></pre>
<p>or directly with:</p>
<pre><code class="language-rust">let index = IndexMetadata {
    url: index.url.clone(),
    format: index.format,
};
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-09-15 13:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-09-15 13:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-distribution/src/metadata/lowering.rs</code>:226 on 2025-09-15 13:36</div>
            <div class="timeline-body"><p>Yeah I changed it (I just don't like it as much -- you're probably right though).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2025-09-15 13:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-09-15 13:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-09-15 13:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:44:43 UTC
    </footer>
</body>
</html>
