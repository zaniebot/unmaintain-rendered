<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix equals-star and tilde-equals with `python_version` and `python_full_version` - astral-sh/uv #14271</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix equals-star and tilde-equals with <code>python_version</code> and <code>python_full_version</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/14271">#14271</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2025-06-26 09:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/konstin">@konstin</a> on 2025-06-26 09:56</div>
            <div class="timeline-body"><p>The marker display code assumes that all versions are normalized, in that all trailing zeroes are stripped. This is not the case for tilde-equals and equals-star versions, where the trailing zeroes (before the <code>.*</code>) are semantically relevant. This would cause path dependent-behavior where we would get a different marker string depending on whether a version with or without a trailing zero was added to the cache first.</p>
<p>To handle both equals-star and tilde-equals when converting <code>python_version</code> to <code>python_full_version</code> markers, we have to merge the version normalization (i.e. trimming the trailing zeroes) and the conversion both to <code>python_full_version</code> and to <code>Ranges</code>, while special casing equals-star and tilde-equals.</p>
<p>To avoid churn in lockfiles, we only trim in the conversion to <code>Ranges</code> for markers, but keep using untrimmed versions for requires-python. (Note that this behavior is technically also path dependent, as versions with and without trailing zeroes have the same Hash and Eq. E.q., <code>requires-python == &quot;&gt;= 3.10.0&quot;</code> and  <code>requires-python == &quot;&gt;= 3.10&quot;</code> in the same workspace could lead to either value in <code>uv.lock</code>, and which one it is could change if we make unrelated (performance) changes. Always trimming however definitely changes lockfiles, a churn I wouldn't do outside another breaking or lockfile-changing change.) Nevertheless, there is a change for users who have <code>requires-python = &quot;~= 3.12.0&quot;</code> in their <code>pyproject.toml</code>, as this now hits the correct normalization path.</p>
<p>Fixes #14231
Fixes #14270</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ibraheemdev by @konstin on 2025-06-26 09:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @konstin on 2025-06-26 09:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/uv-pep508/src/marker/simplify.rs</code>:356 on 2025-06-26 20:11</div>
            <div class="timeline-body"><p>Could this logic be added to <code>VersionSpecifier::from_release_only_bounds</code> instead? This whole function is just a special case of <code>VersionSpecifiers::from_release_only_bounds</code> for the case where we have exactly two ranges that form a not-equals-star. Otherwise we call <code>from_release_only_bounds</code> for the individual range bounds.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-06-26 20:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Fix a case where marker formatting is dependent on operation order" to "Fix equals-star and tilde-equals with `python_version` and `python_full_version`" by @konstin on 2025-06-30 08:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-06-30 08:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-pep508/src/marker/tree.rs</code>:2276 on 2025-06-30 08:32</div>
            <div class="timeline-body"><p>Like I'm fine if we drop support for them in a future refactoring, they are dubious to begin with.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-pep508/src/marker/tree.rs</code>:2576 on 2025-06-30 08:34</div>
            <div class="timeline-body"><p>This does not yet include the <code>test_tilde_equal_inverted_normalization</code> test from #14259.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-06-30 08:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-pep508/src/marker/simplify.rs</code>:356 on 2025-06-30 09:04</div>
            <div class="timeline-body"><p>How'd we do that? Currently, we call <code>VersionSpecifier::from_release_only_bounds</code> in a loop, but only with a single bound.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-06-30 09:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ibraheemdev by @konstin on 2025-06-30 09:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-06-30 10:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-pep440/src/version_specifier.rs</code>:82 on 2025-06-30 10:00</div>
            <div class="timeline-body"><p>This function seems to have only integration test coverage, do we have good unit test cases?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/uv-pep508/src/marker/simplify.rs</code>:68 on 2025-06-30 23:52</div>
            <div class="timeline-body"><p>I wonder if we should just be using <code>VersionSpecifiers::from_release_only_bounds</code> here instead of specifying the case with two bounds. It could possibly lead to more simplifications for complex ranges (e.g. 3 ranges where 2 of them can be simplified to a star inequality)? It would also mean de-duplicating the code and getting better test coverage.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> approved on 2025-06-30 23:54</div>
            <div class="timeline-body"><p>This looks great and should be a lot more robust. Maybe we should open an issue for the <code>requires-python</code> change, because having both behaviors might lead to issues down the road.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-07-01 08:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-pep508/src/marker/simplify.rs</code>:68 on 2025-07-01 08:40</div>
            <div class="timeline-body"><p>I agree with merging those for being very similar, though I'm struggling to understand how <code>VersionSpecifiers::from_release_only_bounds</code> works, it seems that it drops some specifiers while <code>simplify.rs</code> doesn't?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-07-01 15:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-pep508/src/marker/simplify.rs</code>:68 on 2025-07-01 15:48</div>
            <div class="timeline-body"><p>I'll merge this for the release but I can follow up improving the code here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2025-07-01 15:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-07-01 15:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-01 15:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:26 UTC
    </footer>
</body>
</html>
