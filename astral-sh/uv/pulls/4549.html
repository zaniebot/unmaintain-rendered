<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fallback to interpreter discovery in `uv run` - astral-sh/uv #4549</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fallback to interpreter discovery in <code>uv run</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/4549">#4549</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-06-26 14:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR modifies <code>uv run</code> to fallback to discovering an interpreter (e.g., a local <code>.venv</code>) if the command is run outside of a workspace.</p>
<p><code>uv run --isolated</code> continues to completely skip workspace <em>and</em> interpreter discovering, only installing whatever's provided with <code>--with</code>.</p>
<p>The next step here is adding some ergonomic controls for enabling this behavior even if your project is technically in a workspace (i.e., you have a <code>pyproject.toml</code> but aren't using the Project APIs and don't want locking etc.). I could imagine a setting in <code>pyproject.toml</code> that's also exposed on the command-line. Something like: <code>managed = false</code> or <code>project = false</code>.</p>
<p>See: https://github.com/astral-sh/uv/issues/3836.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @charliermarsh on 2024-06-26 14:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-26 14:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:106 on 2024-06-26 14:27</div>
            <div class="timeline-body"><p>This is all just indented in <code>if let Some(project) = project</code> below.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:136 on 2024-06-26 14:27</div>
            <div class="timeline-body"><p>I figured <code>find_or_fetch</code> makes sense here...?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-26 14:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @charliermarsh on 2024-06-26 14:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-26 14:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:136 on 2024-06-26 14:47</div>
            <div class="timeline-body"><p>We <code>find_or_fetch</code> lower down too. We should only fetch a toolchain if we want to create an environment. I'll need to look at the file outside the diff to see what makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-26 14:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:136 on 2024-06-26 14:57</div>
            <div class="timeline-body"><p>We don't install anything into this environment so it may not matter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-26 15:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:136 on 2024-06-26 15:05</div>
            <div class="timeline-body"><p>If you're just looking for an environment to run a command in, <code>PythonEnvironment::find</code> is probably more appropriate? Later, if we need to install something, we need to create a new environment anyway? I'll check out the PR in a second though and read through.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-26 15:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:136 on 2024-06-26 15:47</div>
            <div class="timeline-body"><p>I took a look at this and made the following change. However, this comes with some downsides as we now run interpreter discovery twice when we need to fetch a toolchain — this probably isn't worth it. I think what you have is good, just sharing what I looked into for additional context. We should probably do some refactoring after this because the <code>find_or_fetch</code> in ephemeral environment construction is now <em>only</em> for the isolated case but that's not obvious.</p>
<pre><code class="language-diff">diff --git a/crates/uv/src/commands/project/run.rs b/crates/uv/src/commands/project/run.rs
index 368f7478..da0f9dde 100644
--- a/crates/uv/src/commands/project/run.rs
+++ b/crates/uv/src/commands/project/run.rs
@@ -14,7 +14,8 @@ use uv_distribution::{ProjectWorkspace, Workspace, WorkspaceError};
 use uv_normalize::PackageName;
 use uv_requirements::RequirementsSource;
 use uv_toolchain::{
-    EnvironmentPreference, PythonEnvironment, Toolchain, ToolchainPreference, ToolchainRequest,
+    EnvironmentPreference, Error as ToolchainError, PythonEnvironment, Toolchain,
+    ToolchainPreference, ToolchainRequest,
 };
 use uv_warnings::warn_user;
 
@@ -68,7 +69,7 @@ pub(crate) async fn run(
             }
         };
 
-        let venv = if let Some(project) = project {
+        if let Some(project) = project {
             debug!(
                 &quot;Discovered project `{}` at: {}&quot;,
                 project.project_name(),
@@ -117,27 +118,25 @@ pub(crate) async fn run(
             )
             .await?;
 
-            venv
+            Some(venv)
         } else {
             debug!(&quot;No project found; searching for Python interpreter&quot;);
 
-            let client_builder = BaseClientBuilder::new()
-                .connectivity(connectivity)
-                .native_tls(native_tls);
-
-            let toolchain = Toolchain::find_or_fetch(
-                python.as_deref().map(ToolchainRequest::parse),
+            match PythonEnvironment::find(
+                &amp;python
+                    .as_deref()
+                    .map(ToolchainRequest::parse)
+                    .unwrap_or_default(),
+                // No opt-in is required for system environments, since we are not mutating it
                 EnvironmentPreference::Any,
-                toolchain_preference,
-                client_builder,
                 cache,
-            )
-            .await?;
-
-            PythonEnvironment::from_toolchain(toolchain)
-        };
-
-        Some(venv)
+            ) {
+                Ok(env) =&gt; Some(env),
+                // If no environment is found, we'll create an environment later
+                Err(ToolchainError::NotFound(_)) =&gt; None,
+                Err(err) =&gt; return Err(err.into()),
+            }
+        }
     };
 
     if let Some(project_env) = &amp;project_env {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-26 15:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:131 on 2024-06-26 15:47</div>
            <div class="timeline-body"><pre><code class="language-suggestion">                // No opt-in is required for system environments, since we are not mutating it
                EnvironmentPreference::Any,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-26 15:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:143 on 2024-06-26 15:48</div>
            <div class="timeline-body"><p>It might make sense to rename <code>project_env</code> to something like <code>base_env</code> now that it can come from the system?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-26 15:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:136 on 2024-06-26 15:50</div>
            <div class="timeline-body"><p>Another note... technically it is a no-no to construct a <code>PythonEnvironment</code> from a <code>find_or_fetch</code> call because you might accidentally end up allowing mutation of a managed toolchain environment. Since we're not mutating, it's fine here — but suggests that something isn't quite right in the structure (but the problem could be in the toolchain APIs themselves).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-06-26 15:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-26 16:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:136 on 2024-06-26 16:09</div>
            <div class="timeline-body"><p>For reference, we use the <code>PythonEnvironment</code> for two things: (1) <code>interpreter.scripts()</code>, and (2) site-packages.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-06-26 16:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-06-26 16:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-06-26 16:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-26 16:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:136 on 2024-06-26 16:28</div>
            <div class="timeline-body"><p>These are both attributes of the <code>Interpreter</code> and don't require a <code>PythonEnvironment</code> type, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-26 17:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:136 on 2024-06-26 17:41</div>
            <div class="timeline-body"><p>Assuming <code>target</code> and <code>prefix</code> is disabled, yes...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-26 17:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:136 on 2024-06-26 17:47</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/uv/pull/4559</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:37:44 UTC
    </footer>
</body>
</html>
