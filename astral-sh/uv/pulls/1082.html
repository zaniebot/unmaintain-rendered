<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use a buffered reader for wheel metadata - astral-sh/uv #1082</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use a buffered reader for wheel metadata</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/1082">#1082</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-01-24 20:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>It turns out this is significantly faster when reading (e.g.) <em>just</em> the <code>METADATA</code> file from a zipped wheel.</p>
<p>I audited other <code>File::open</code> usages, and everything else seems to be using a buffered reader already (directly, or in whatever third-party crate it&#x27;s passed to) <em>or</em> is read immediately in full.</p>
<p>See the criterion benchmark:</p>
<pre><code>file_reader/numpy-1.26.3-pp39-pypy39_pp73-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
                        time:   [6.9618 ms 6.9664 ms 6.9713 ms]
Found 4 outliers among 100 measurements (4.00%)
  4 (4.00%) high mild
file_reader/flask-3.0.1-py3-none-any.whl
                        time:   [237.50 µs 238.25 µs 239.13 µs]
Found 7 outliers among 100 measurements (7.00%)
  3 (3.00%) high mild
  4 (4.00%) high severe

buffered_reader/numpy-1.26.3-pp39-pypy39_pp73-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
                        time:   [648.92 µs 653.85 µs 660.09 µs]
Found 4 outliers among 100 measurements (4.00%)
  3 (3.00%) high mild
  1 (1.00%) high severe
buffered_reader/flask-3.0.1-py3-none-any.whl
                        time:   [39.578 µs 39.712 µs 39.869 µs]
Found 8 outliers among 100 measurements (8.00%)
  3 (3.00%) high mild
  5 (5.00%) high severe
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/BurntSushi">@BurntSushi</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-24 20:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-24 20:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-distribution/src/download.rs</code>:139 on 2024-01-24 20:09</div>
            <div class="timeline-body"><p>It turns out this was unused. Sigh! Need multi-crate detection!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-01-24 20:18</div>
            <div class="timeline-body"><p>Astounding! I checked that the sync zip crates used buffered reader internally, and async zip <a href="https://github.com/Majored/rs-async-zip/blob/7ae5331e5de730cb87e02f6647bcaba278a8ddbf/src/base/read/seek.rs#L100">does too</a>, i&#x27;m surprised by this massive speedup</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-01-24 20:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-24 20:22</div>
            <div class="timeline-body"><p>It could just be an artifact of the benchmark, I guess, but it seems real?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-24 20:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-24 20:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-01-24 20:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/puffin-client/src/registry_client.rs</code>:249 on 2024-01-25 13:21</div>
            <div class="timeline-body"><p>The interesting thing here is that it seems like <code>async_zip</code> does eventually create a buffered reader: https://github.com/Majored/rs-async-zip/blob/7ae5331e5de730cb87e02f6647bcaba278a8ddbf/src/base/read/mod.rs#L83-L87</p>
<p>But it does do (by my count) several reads before that.</p>
<p>¯\_(ツ)_/¯</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-01-25 13:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-25 13:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-client/src/registry_client.rs</code>:249 on 2024-01-25 13:48</div>
            <div class="timeline-body"><p>The common case for reading metadata actually goes through the synchronous reader, not here. My benchmarks are for the synchronous reader. So I actually don’t know if it makes an impact here.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:43:22 UTC
    </footer>
</body>
</html>
