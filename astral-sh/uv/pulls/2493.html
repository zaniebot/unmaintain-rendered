<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>feat: add linehaul info to uv-client - astral-sh/uv #2493</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>feat: add linehaul info to uv-client</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/2493">#2493</a>
        opened by <a href="https://github.com/samypr100">@samypr100</a>
        on 2024-03-17 03:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/samypr100">@samypr100</a> on 2024-03-17 03:29</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Closes #1958</p>
<p>This adds linehaul metadata to uv's user-agent when pep 508 markers are provided to the RegistryClientBuilder. Thanks to #2381, we were able to leverage most information from markers and avoid inconsistency.</p>
<p>Linehaul is meant to be accompanying metadata pip sends in it's user agent when talking to registries. You can see this output by running something like <code>python -c 'from pip._internal.network.session import user_agent; print(user_agent())'</code>.
In PyPI, this metadata processed by the <a href="https://github.com/pypi/linehaul-cloud-function">linehaul-cloud-function</a>. More info about linehaul can be found in #1958.</p>
<p>Below are some examples from pip:</p>
<ul>
<li>Linux GHA: <code>pip/24.0 {&quot;ci&quot;:true,&quot;cpu&quot;:&quot;x86_64&quot;,&quot;distro&quot;:{&quot;id&quot;:&quot;jammy&quot;,&quot;libc&quot;:{&quot;lib&quot;:&quot;glibc&quot;,&quot;version&quot;:&quot;2.35&quot;},&quot;name&quot;:&quot;Ubuntu&quot;,&quot;version&quot;:&quot;22.04&quot;},&quot;implementation&quot;:{&quot;name&quot;:&quot;CPython&quot;,&quot;version&quot;:&quot;3.12.2&quot;},&quot;installer&quot;:{&quot;name&quot;:&quot;pip&quot;,&quot;version&quot;:&quot;24.0&quot;},&quot;openssl_version&quot;:&quot;OpenSSL 3.0.2 15 Mar 2022&quot;,&quot;python&quot;:&quot;3.12.2&quot;,&quot;rustc_version&quot;:&quot;1.76.0&quot;,&quot;system&quot;:{&quot;name&quot;:&quot;Linux&quot;,&quot;release&quot;:&quot;6.5.0-1016-azure&quot;}}</code></li>
<li>Windows GHA: <code>pip/24.0 {&quot;ci&quot;:true,&quot;cpu&quot;:&quot;AMD64&quot;,&quot;implementation&quot;:{&quot;name&quot;:&quot;CPython&quot;,&quot;version&quot;:&quot;3.12.2&quot;},&quot;installer&quot;:{&quot;name&quot;:&quot;pip&quot;,&quot;version&quot;:&quot;24.0&quot;},&quot;openssl_version&quot;:&quot;OpenSSL 3.0.13 30 Jan 2024&quot;,&quot;python&quot;:&quot;3.12.2&quot;,&quot;rustc_version&quot;:&quot;1.76.0&quot;,&quot;system&quot;:{&quot;name&quot;:&quot;Windows&quot;,&quot;release&quot;:&quot;2022Server&quot;}}</code></li>
<li>OSX GHA: <code>pip/24.0 {&quot;ci&quot;:true,&quot;cpu&quot;:&quot;arm64&quot;,&quot;distro&quot;:{&quot;name&quot;:&quot;macOS&quot;,&quot;version&quot;:&quot;14.2.1&quot;},&quot;implementation&quot;:{&quot;name&quot;:&quot;CPython&quot;,&quot;version&quot;:&quot;3.12.2&quot;},&quot;installer&quot;:{&quot;name&quot;:&quot;pip&quot;,&quot;version&quot;:&quot;24.0&quot;},&quot;openssl_version&quot;:&quot;OpenSSL 3.0.13 30 Jan 2024&quot;,&quot;python&quot;:&quot;3.12.2&quot;,&quot;rustc_version&quot;:&quot;1.76.0&quot;,&quot;system&quot;:{&quot;name&quot;:&quot;Darwin&quot;,&quot;release&quot;:&quot;23.2.0&quot;}}</code></li>
</ul>
<p>Here's how uv results look like (sorry for the keys not having the same order):</p>
<ul>
<li>Linux GHA: <code>uv/0.1.21 {&quot;installer&quot;:{&quot;name&quot;:&quot;uv&quot;,&quot;version&quot;:&quot;0.1.21&quot;},&quot;python&quot;:&quot;3.12.2&quot;,&quot;implementation&quot;:{&quot;name&quot;:&quot;CPython&quot;,&quot;version&quot;:&quot;3.12.2&quot;},&quot;distro&quot;:{&quot;name&quot;:&quot;Ubuntu&quot;,&quot;version&quot;:&quot;22.04&quot;,&quot;id&quot;:&quot;jammy&quot;,&quot;libc&quot;:null},&quot;system&quot;:{&quot;name&quot;:&quot;Linux&quot;,&quot;release&quot;:&quot;6.5.0-1016-azure&quot;},&quot;cpu&quot;:&quot;x86_64&quot;,&quot;openssl_version&quot;:null,&quot;setuptools_version&quot;:null,&quot;rustc_version&quot;:null,&quot;ci&quot;:true}</code></li>
<li>Windows GHA: <code>uv/0.1.21 {&quot;installer&quot;:{&quot;name&quot;:&quot;uv&quot;,&quot;version&quot;:&quot;0.1.21&quot;},&quot;python&quot;:&quot;3.12.2&quot;,&quot;implementation&quot;:{&quot;name&quot;:&quot;CPython&quot;,&quot;version&quot;:&quot;3.12.2&quot;},&quot;distro&quot;:null,&quot;system&quot;:{&quot;name&quot;:&quot;Windows&quot;,&quot;release&quot;:&quot;2022Server&quot;},&quot;cpu&quot;:&quot;AMD64&quot;,&quot;openssl_version&quot;:null,&quot;setuptools_version&quot;:null,&quot;rustc_version&quot;:null,&quot;ci&quot;:true}</code></li>
<li>OSX GHA: <code>uv/0.1.21 {&quot;installer&quot;:{&quot;name&quot;:&quot;uv&quot;,&quot;version&quot;:&quot;0.1.21&quot;},&quot;python&quot;:&quot;3.12.2&quot;,&quot;implementation&quot;:{&quot;name&quot;:&quot;CPython&quot;,&quot;version&quot;:&quot;3.12.2&quot;},&quot;distro&quot;:{&quot;name&quot;:&quot;macOS&quot;,&quot;version&quot;:&quot;14.2.1&quot;,&quot;id&quot;:null,&quot;libc&quot;:null},&quot;system&quot;:{&quot;name&quot;:&quot;Darwin&quot;,&quot;release&quot;:&quot;23.2.0&quot;},&quot;cpu&quot;:&quot;arm64&quot;,&quot;openssl_version&quot;:null,&quot;setuptools_version&quot;:null,&quot;rustc_version&quot;:null,&quot;ci&quot;:true}</code></li>
</ul>
<p>Distro information (such as the one pip uses <code>from pip._vendor import distro</code> to retrieve instead of <code>platform</code> module) was not retrieved from markers. Instead, the linux release codename/name/version uses <code>sys-info</code> crate, adding about 50us of extra overhead on linux. The distro osx version re-used the <a href="https://github.com/astral-sh/uv/blob/99c992e38b220fbcda09b0b43602b3db2321480b/crates/platform-host/src/mac_os.rs">mac_os version implementation</a> from #2381 which adds about 20us of overhead on osx. I tried to use other crates to avoid re-introducing <code>mac_os.rs</code> but most of them didn't yield satisfactory performance (40ms-60ms~) or had the wrong values needed (e.g. darwin version vs osx version).</p>
<p>I also didn't add rustc retrieval as those seem to add substantial overhead due to querying <code>rustc</code>. PyPy version detection was also not added to avoid adding extra overhead to <a href="https://github.com/pypa/pip/blob/24.0/src/pip/_internal/network/session.py#L123">support PyPy for linehaul</a>. All other behavior was kept 1-1 to match what pip's linehaul implementation does (as of 24.0). This also aligns with what was discussed in #1958.</p>
<h2>Test Plan</h2>
<p>Added new integration test to uv-client.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @samypr100 on 2024-03-17 03:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-03-18 10:36</div>
            <div class="timeline-body"><blockquote>
<p>I also didn't add libc retrieval or rustc retrieval as those seem to add substantial overhead due to querying ldd or rustc.</p>
</blockquote>
<p>We now have this information for the python interpreter itself, i added it.</p>
<blockquote>
<p>Distro information (such as the one pip uses from pip._vendor import distro to retrieve instead of platform module) was not retrieved from markers. Instead, the linux release codename/name/version uses sys-info crate, adding about 50us of extra overhead on linux. The distro osx version re-used the <a href="https://github.com/astral-sh/uv/blob/99c992e38b220fbcda09b0b43602b3db2321480b/crates/platform-host/src/mac_os.rs">mac_os version implementation</a> from https://github.com/astral-sh/uv/pull/2381 which adds about 20us of overhead on osx. I tried to use other crates to avoid re-introducing mac_os.rs but most of them didn't yield satisfactory performance (40ms-60ms~) or had the wrong values needed (e.g. darwin version vs osx version).</p>
</blockquote>
<p>Great performance work! On my machine (ubuntu) we're at 0.000s and even relative to the 2ms warm cache black resolve the linehaul instantiation is fast.</p>
<p><strong>Warm cache resolve black</strong>
<img src="https://github.com/astral-sh/uv/assets/6826232/7c626b78-a7ba-4bf5-a453-6b243ec2c6ce" alt="Warm cache resolve black" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2024-03-18 10:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2024-03-18 10:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2024-03-18 12:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv/src/commands/pip_install.rs</code>:195 on 2024-03-18 12:09</div>
            <div class="timeline-body"><p>Thanks for the edits @konstin</p>
<p>I think this is missing adding <code>.platform(venv.interpreter().platform())</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2024-03-18 12:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv/src/commands/pip_sync.rs</code>:129 on 2024-03-18 12:09</div>
            <div class="timeline-body"><p>This is also missing <code>.platform(venv.interpreter().platform())</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2024-03-18 12:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv/src/commands/venv.rs</code>:154 on 2024-03-18 12:09</div>
            <div class="timeline-body"><p>This also is missing <code>.platform(interpreter.platform())</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-03-18 12:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/src/commands/pip_install.rs</code>:195 on 2024-03-18 12:17</div>
            <div class="timeline-body"><p>Thank you! #2507</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @konstin on 2024-03-18 12:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-03-18 12:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-18 13:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-client/src/mac_version.rs</code>:5 on 2024-03-18 13:01</div>
            <div class="timeline-body"><p>Do we need this? I thought we got it from the interpreter now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-18 13:01</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/mac_version.rs</code>:5 on 2024-03-18 13:28</div>
            <div class="timeline-body"><p>Oh that's the same thing, thanks https://github.com/astral-sh/uv/pull/2509</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-03-18 13:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2024-03-18 13:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-client/src/mac_version.rs</code>:5 on 2024-03-18 13:45</div>
            <div class="timeline-body"><p>Note, it's not quite just major.minor, it should include the product version from the plist as-is based on my testing with pip.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-03-18 13:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/mac_version.rs</code>:5 on 2024-03-18 13:59</div>
            <div class="timeline-body"><p>Happy to hand this off to a mac user who can test this on an actual mac</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-03-20 17:03</div>
            <div class="timeline-body"><p>I tried to query the big-data table for <code>uv</code> downloads but there are no uv records yet (but the latest ingested data is from today). I think the reason for it is that we need to add a <code>uv</code> parser in here https://github.com/pypi/linehaul-cloud-function/blob/main/linehaul/ua/parser.py</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2024-03-20 17:41</div>
            <div class="timeline-body"><p>Yes, a parser can now be added since the data is being sent as of 0.1.22 ❤️</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 14:49:26 UTC
    </footer>
</body>
</html>
