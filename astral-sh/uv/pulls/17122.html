<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>fix: preserve absolute paths in lockfile when user specifies absolute find-links - astral-sh/uv #17122</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>fix: preserve absolute paths in lockfile when user specifies absolute find-links</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/17122">#17122</a>
        opened by <a href="https://github.com/majiayu000">@majiayu000</a>
        on 2025-12-13 10:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/majiayu000">@majiayu000</a></div>
            <div class="timeline-body">Summary
<p>When a user specifies an absolute path for <code>find-links</code> or path dependencies (e.g., <code>/shared_drive/wheels</code>), preserve the absolute path in <code>uv.lock</code> instead of converting it to a relative path like <code>../../shared_drive/...</code>.</p>
<p>The previous behavior could cause issues when the lockfile was used from different directory depths, as the relative path would resolve to the wrong location.</p>
Changes
<ul>
<li>Added a helper function <code>relative_to_or_absolute</code> in <code>crates/uv-resolver/src/lock/mod.rs</code></li>
<li>The function checks if the original user input was an absolute path</li>
<li>If the relative path would require traversing outside the project root (starting with <code>..</code>), the absolute path is preserved</li>
<li>Updated snapshot tests to reflect the new behavior</li>
</ul>
Test Plan
<ul>
<li>[x] <code>cargo test --package uv -- lock_find_links</code> - all 9 tests pass</li>
<li>[x] <code>cargo clippy --all</code> - no warnings</li>
<li>[x] <code>cargo fmt --check</code> - passes</li>
</ul>
<p>Fixes #16602</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-12-16 14:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-resolver/src/lock/mod.rs</code>:3919 on 2025-12-16 14:14</div>
            <div class="timeline-body"><p>I&#x27;m not following here, if the user input was absolute, why don&#x27;t we preserve it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-12-16 14:15</div>
            <div class="timeline-body"><p>The test aren&#x27;t passing, did you use an LLM to write this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/majiayu000">@majiayu000</a> on 2025-12-17 04:35</div>
            <div class="timeline-body"><blockquote>
<p>The test aren&#x27;t passing, did you use an LLM to write this?</p>
</blockquote>
<p>Thanks for the feedback! Yes, this was written with AI assistance, but the design approach was mine. Feel free to close this PR if you find it unsuitable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-12-17 10:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/lock.rs</code>:11785 on 2025-12-17 10:18</div>
            <div class="timeline-body"><p>This is a regression, this case needs to keep working.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-12-17 10:23</div>
            <div class="timeline-body"><p>We want something in the direction of this change, but we first need some sketch for it that&#x27;s consistent across inputs and file format (e.g. we want to treat regular indexes and find links the same, there&#x27;s <code>path = </code> dependencies and URLs/paths in PEP 508, as well as consistency between <code>pylock.toml</code> and <code>uv.lock</code>), basically a short table that says for each kind of input how it will be represented in a lockfile.</p>
<p>The code doesn&#x27;t follow uv&#x27;s style atm. Writing resilient and maintainable path handling code is hard, and LLMs are bad at it, they also ignore the style of the existing path handling code and tend to make up claims about their logic. The path handling code needs to be hand-written for now, using API docs as reference.</p>
<p>There&#x27;s some utils we should use, such as <code>to_file_path</code>, and we need to avoid methods that may panic, such as indexing (e.g. <code>foo[0]</code>) into strings (sometimes it&#x27;s unavoidable, but it&#x27;s usually possible to write code that does not call anything that can panic)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/majiayu000">@majiayu000</a> on 2025-12-17 11:01</div>
            <div class="timeline-body"><p>Thank you for the detailed feedback.  You&#x27;re right that this needs a more comprehensive design approach - I should have
started with a design sketch covering all input types and their lockfile representations before jumping into implementation.</p>
<p>I acknowledge the code quality concerns.  The path handling logic was largely AI-assisted, and as you noted, it doesn&#x27;t follow uv&#x27;s existing style and patterns.</p>
<p>Unfortunately, I don&#x27;t have access to a Windows machine at the moment to debug the CI failures, and given the feedback about needing a proper design first, I think it&#x27;s best to close this PR for now.</p>
<p>If I revisit this in the future, I&#x27;ll:</p>
<ol>
<li>Start with a design table covering all path/URL input types</li>
<li>Ensure consistency across regular indexes, find-links, path dependencies, and both lockfile formats</li>
<li>Write the path handling code manually following uv&#x27;s existing patterns</li>
</ol>
<p>Thanks for taking the time to review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/majiayu000">@majiayu000</a> on 2025-12-17 11:01</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:54:57 UTC
    </footer>
</body>
</html>
