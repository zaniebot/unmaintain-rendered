<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>feat: Add PEP 751 multi-use lock file support with extras and dependency groups markers - astral-sh/uv #14728</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>feat: Add PEP 751 multi-use lock file support with extras and dependency groups markers</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/pull/14728">#14728</a>
        opened by <a href="https://github.com/gaborbernat">@gaborbernat</a>
        on 2025-07-18 15:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gaborbernat">@gaborbernat</a></div>
            <div class="timeline-body"><p>This PR adds <a href="https://packaging.python.org/en/latest/specifications/pylock-toml/">PEP 751</a> multi-use lock file support when exporting to <code>pylock.toml</code> format.</p>
<h3>What is a Multi-Use Lock File?</h3>
<p>A multi-use lock file describes <strong>all possible packages</strong> that might be installed across different scenarios, rather than just the packages for one specific configuration. This enables:</p>
<ul>
<li><strong>Multiple environments from one file</strong>: Install for Python 3.8, 3.9, 3.10+ all from the same lock file</li>
<li><strong>Optional features</strong>: Choose which extras (like <code>dev</code>, <code>test</code>, <code>docs</code>) to install at install-time</li>
<li><strong>Dependency groups</strong>: Select which dependency groups to include (like PEP 735 groups)</li>
<li><strong>Platform-specific packages</strong>: Different wheels for Linux, macOS, Windows from one source</li>
</ul>
<p>The lock file uses <strong>markers</strong> to indicate when each package should be installed, allowing installers to select the appropriate subset.</p>
<h3>What This Implements</h3>
<h4>1. Root-Level PEP 751 Metadata Fields</h4>
<p>The <code>pylock.toml</code> output now includes the required PEP 751 metadata fields:</p>
<ul>
<li><code>extras</code>: All optional dependencies available in the project</li>
<li><code>dependency-groups</code>: All dependency groups defined in the project</li>
<li><code>default-groups</code>: Synthetic groups for default installation (currently empty per spec)</li>
</ul>
<h4>2. Dependency Markers for Extras and Groups</h4>
<p>Package dependencies include PEP 751 markers using the container membership syntax:</p>
<ul>
<li><code>'test' in extras</code> - indicates this dependency is only needed with the <code>test</code> extra</li>
<li><code>'dev' in dependency_groups</code> - indicates this dependency is only needed with the <code>dev</code> group</li>
</ul>
<p>Dependency markers are simplified relative to <code>requires-python</code>. Unconditional dependencies have no marker; conditional ones only include the additional constraints.</p>
<h4>3. Marker Conversion</h4>
<p>uv's internal lock format uses &quot;universal markers&quot; that encode extras and groups in a special format. PEP 751 specifies a different syntax:</p>
<p>| Internal Format                | PEP 751 Format               |
| ------------------------------ | ---------------------------- |
| <code>extra == 'extra-3-pkg-cpu'</code>   | <code>'cpu' in extras</code>            |
| <code>extra == 'group-5-myapp-dev'</code> | <code>'dev' in dependency_groups</code> |</p>
<h3>Example Output</h3>
<pre><code class="language-toml">lock-version = &quot;1.0&quot;
created-by = &quot;uv&quot;
requires-python = &quot;&gt;=3.12&quot;
extras = [&quot;docs&quot;, &quot;test&quot;]
dependency-groups = [&quot;dev&quot;]

[[packages]]
name = &quot;click&quot;
version = &quot;8.1.7&quot;
dependencies = [{ name = &quot;colorama&quot;, version = &quot;0.4.6&quot;, marker = &quot;sys_platform == 'win32'&quot; }]
index = &quot;https://pypi.org/simple&quot;
...

[[packages]]
name = &quot;flask&quot;
version = &quot;3.0.2&quot;
dependencies = [
    { name = &quot;blinker&quot;, version = &quot;1.7.0&quot; },
    { name = &quot;click&quot;, version = &quot;8.1.7&quot; },
    { name = &quot;itsdangerous&quot;, version = &quot;2.1.2&quot; },
    { name = &quot;jinja2&quot;, version = &quot;3.1.3&quot; },
    { name = &quot;python-dotenv&quot;, version = &quot;1.0.1&quot;, marker = &quot;'dotenv' in extras&quot; },
    { name = &quot;werkzeug&quot;, version = &quot;3.0.1&quot; },
]
index = &quot;https://pypi.org/simple&quot;
...

[[packages]]
name = &quot;project&quot;
dependencies = [
    { name = &quot;flask&quot;, version = &quot;3.0.2&quot; },
    { name = &quot;pytest&quot;, version = &quot;8.0.0&quot;, marker = &quot;'test' in extras&quot; },
    { name = &quot;sphinx&quot;, version = &quot;7.0.0&quot;, marker = &quot;'docs' in extras&quot; },
    { name = &quot;mypy&quot;, version = &quot;1.0.0&quot;, marker = &quot;'dev' in dependency_groups&quot; },
]
directory = { path = &quot;.&quot;, editable = true }
</code></pre>
<p>Note:</p>
<ul>
<li>Unconditional dependencies (blinker, click, etc.) have no marker</li>
<li>Platform-specific dependencies include only that condition (<code>sys_platform == 'win32'</code>)</li>
<li>Extra dependencies include the extras marker (<code>'dotenv' in extras</code>)</li>
<li>Dependency group dependencies include the groups marker (<code>'dev' in dependency_groups</code>)</li>
</ul>
<h3>Usage</h3>
<pre><code class="language-bash"># Export a project to pylock.toml format
uv export --format pylock.toml &gt; pylock.toml

# Install from the multi-use lock file (base dependencies only)
uv pip install -r pylock.toml

# Install with specific extras
uv pip install -r pylock.toml --extra test --extra docs

# Install with specific dependency groups
uv pip install -r pylock.toml --group dev
</code></pre>
<p>Resolves #13060</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-18 15:54</div>
            <div class="timeline-body"><p>I think this is more involved because we also need to preserve extra markers throughout the graph? Right now I believe they (intentionally) get resolved away <code>ExportableRequirements::from_lock</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on 2025-07-18 16:04</div>
            <div class="timeline-body"><blockquote>
<p>I think this is more involved because we also need to preserve extra markers throughout the graph? Right now I believe they (intentionally) get resolved away <code>ExportableRequirements::from_lock</code>.</p>
</blockquote>
<p>Yeah, ðŸ¤” this just computes for now the passed in extras/groups, but populating that into packages likely is more complicated. Looking at it, but feedback welcome.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Populate complete pylock.toml" to "Populate more information into pylock.toml" by @gaborbernat on 2025-07-18 16:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/paveldikov">@paveldikov</a> reviewed on 2025-07-18 18:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/paveldikov">@paveldikov</a> on <code>crates/uv-resolver/src/lock/export/pylock_toml.rs</code>:1 on 2025-07-18 18:31</div>
            <div class="timeline-body"><p>question: is the aim here to cover <code>uv export</code> only? Or <code>uv pip compile</code> to be covered as well?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gaborbernat">@gaborbernat</a> reviewed on 2025-07-19 15:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on <code>crates/uv-resolver/src/lock/export/pylock_toml.rs</code>:1 on 2025-07-19 15:10</div>
            <div class="timeline-body"><p>For now let's start with <code>uv export</code>, <code>pip compile</code> can come afterwards.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Populate more information into pylock.toml" to "feat: Add PEP 751 multi-use lock file support with extras and dependency groups markers" by @gaborbernat on 2026-01-08 19:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @gaborbernat on 2026-01-08 22:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/export.rs</code>:3652 on 2026-01-12 09:26</div>
            <div class="timeline-body"><p>Those dependencies aren't conditional - do we need a simplify/complexify, or is this a marker graph implication?</p>
<p>https://inspector.pypi.io/project/anyio/3.7.0/packages/68/fe/7ce1926952c8a403b35029e194555558514b365ad77d75125f521a2bec62/anyio-3.7.0-py3-none-any.whl/anyio-3.7.0.dist-info/METADATA#line.26</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-pep508/src/marker/lowering.rs</code>:174 on 2026-01-12 09:28</div>
            <div class="timeline-body"><p>The added docstrings don't add information here. We should either keep as-is, or add docstrings that explain e.g. what list</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-resolver/src/lock/export/marker_conversion.rs</code>:68 on 2026-01-12 09:31</div>
            <div class="timeline-body"><p>We should not parse this format, we know what conflicts there are from resolution input and resolution output.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-resolver/src/lock/export/marker_conversion.rs</code>:113 on 2026-01-12 09:34</div>
            <div class="timeline-body"><p>dead code</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2026-01-12 09:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gaborbernat">@gaborbernat</a> reviewed on 2026-01-12 15:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on <code>crates/uv/tests/it/export.rs</code>:3652 on 2026-01-12 15:35</div>
            <div class="timeline-body"><p>Ah, you're correct fixed it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @gaborbernat on 2026-01-12 15:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2026-01-12 18:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-resolver/src/lock/export/marker_conversion.rs</code>:7 on 2026-01-12 18:32</div>
            <div class="timeline-body"><p>These comments are now outdated</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2026-01-12 18:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/export.rs</code>:3881 on 2026-01-12 18:50</div>
            <div class="timeline-body"><p>Here, we need to use <code>extra ==</code>: That is not provided by the lockfile, but by flask.</p>
<p>Can you add a test case specifically for having conflicting dependencies and transitives extras?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 19:18:27 UTC
    </footer>
</body>
</html>
