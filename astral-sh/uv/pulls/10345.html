<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove `[u64; 4]` from small version to move `Arc` to full version - astral-sh/uv #10345</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Remove <code>[u64; 4]</code> from small version to move <code>Arc</code> to full version</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/10345">#10345</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2025-01-07 09:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>Ref #10344</p>
<p>Cloning and dropping the version arc took a significant fraction of the time in the resolver, which is a large overhead especially for the small variant that has only 9 bytes payload.</p>
<p>When moving the <code>Arc</code> to only apply to the full variant, the small variant is too large because it stores a <code>[u64; 4]</code> to have a release accessor a <code>&amp;[u64]</code> that&#x27;s shared with the <code>Vec&lt;u64&gt;</code> of the full variant. We proxy this by first extracting the compressed version digits of the small variant to a proxy type that stores up to 4 u64 on the stack and can be deref&#x27;ed to the existing <code>&amp;[u64]</code>, minimizing churn.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/BurntSushi">@BurntSushi</a> by <a href="https://github.com/konstin">@konstin</a> on 2025-01-07 09:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by <a href="https://github.com/konstin">@konstin</a> on 2025-01-07 09:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-01-07 09:38</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/uv/branches/konsti%2Fopt-small-version-arc">CodSpeed Performance Report</a>
Merging #10345 will <strong>improve performances by 29.06%</strong>
<p>Comparing <code>konsti/opt-small-version-arc</code> (c09adcf) with <code>main</code> (14a9008)</p>
Summary
<p><code>⚡ 3</code> improvements<br>
<code>✅ 11</code> untouched benchmarks</p>
Benchmarks breakdown
<p>|     | Benchmark | <code>main</code> | <code>konsti/opt-small-version-arc</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>resolve_warm_airflow</code> | 1,039.2 ms | 841.5 ms | +23.48% |
| ⚡ | <code>resolve_warm_jupyter</code> | 95 ms | 73.6 ms | +29.06% |
| ⚡ | <code>resolve_warm_jupyter_universal</code> | 232.7 ms | 209.6 ms | +11.02% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-pep440/src/version.rs</code>:1424 on 2025-01-07 13:17</div>
            <div class="timeline-body"><p>Since this is part of the public API, I&#x27;d suggest keeping the first sentence to one line, and then adding more (if necessary) in a paragraph below it. Otherwise, this will show up as an overlong summary in the type listing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-pep440/src/version.rs</code>:1439 on 2025-01-07 13:25</div>
            <div class="timeline-body"><p>I was wondering if there was a more compact representation than this, so I tried:</p>
<pre><code>enum ReleaseInner&lt;&#x27;a&gt; {
    Small { numbers: [u64; 4], len: u8 },
    Full(&amp;&#x27;a [u64]),
}
</code></pre>
<p>But indeed, it&#x27;s the same size (which makes sense).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-pep440/src/version.rs</code>:941 on 2025-01-07 13:27</div>
            <div class="timeline-body"><p>Oh man, if we could get rid of <code>len</code> here, this type would decrease in size by half I believe. IDK if that would make an actual difference perf-wise... And I think the only way to do it would be to take bits away from <code>repr</code>, which in turn means moving more cases to the <code>Full</code> representation. Which might be a net negative overall.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-pep440/src/version.rs</code>:379 on 2025-01-07 13:28</div>
            <div class="timeline-body"><p>Octal!?!?! -_- &gt;_&lt; o_0 Haha</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2025-01-07 13:29</div>
            <div class="timeline-body"><p>This is awesome! I love it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-01-07 13:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-pep440/src/version.rs</code>:941 on 2025-01-07 13:48</div>
            <div class="timeline-body"><p>We could get rid of len by counting the zeroes ourselves. The problem is that <code>Version</code> doesn&#x27;t become 64 byte since the <code>Arc</code> has only a single niche (<code>NonNull</code>) in rustc&#x27;s view, so both variants don&#x27;t fit into a 64-bit word.</p>
<p>We could try a tagged pointer library, or we could lean into it and make the small representation <code>[u8; 11]</code> or <code>[u8; 15]</code> to use the space we&#x27;re already allocating while leaving a bit (byte) for rustc for the enum discriminant.</p>
<p>This problem MRE:</p>
<pre><code>use std::sync::Arc;

enum A {
    Small(()),
    Large(Arc&lt;Vec&lt;u8&gt;&gt;),
}

enum B {
    Small(bool),
    Large(Arc&lt;Vec&lt;u8&gt;&gt;),
}

enum C {
    Small([u8; 7]),
    Large(Arc&lt;Vec&lt;u8&gt;&gt;),
}

fn main() {
    println!(&quot;{}&quot;, size_of::&lt;A&gt;()); // -&gt; 8
    println!(&quot;{}&quot;, size_of::&lt;B&gt;()); // -&gt; 16, but can it be 8 please?
    println!(&quot;{}&quot;, size_of::&lt;C&gt;()); // -&gt; 16, but can it be 8 please?
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-pep440/src/version.rs</code>:941 on 2025-01-07 14:08</div>
            <div class="timeline-body"><p>Another option would be stealing two bits somewhere else (fourth release number, or capping the first release number to 14 bits).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-01-07 14:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-01-07 14:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-pep440/src/version.rs</code>:941 on 2025-01-07 14:10</div>
            <div class="timeline-body"><blockquote>
<p>We could get rid of len by counting the zeroes ourselves.</p>
</blockquote>
<p>Hmmm, but then I think you might lose the current property that trailing zeros are preserved. See: #10362.</p>
<p>Otherwise yeah, I see. I agree that going further probably means a tagged pointer of some kind.</p>
<p>A less thought out idea is a global interner like we use in <code>uv-pep508</code> for markers. But whether that hits the right trade-offs is not at all clear to me. It could let you get a <code>Version</code> down to 32-bits pretty easily I think, but then pretty much every interaction with it would require consulting the global interner table. And that will probably destroy any benefits you might otherwise get.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/konstin">@konstin</a> on 2025-01-07 14:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/konstin">@konstin</a> on 2025-01-07 14:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-07 14:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:50:07 UTC
    </footer>
</body>
</html>
