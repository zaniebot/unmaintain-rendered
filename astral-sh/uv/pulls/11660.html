<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reduce overhead in converting resolutions - astral-sh/uv #11660</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Reduce overhead in converting resolutions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/11660">#11660</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2025-02-20 11:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/konstin">@konstin</a> on 2025-02-20 11:02</div>
            <div class="timeline-body"><p>Solving spent a chunk of its time just converting resolutions, the left two blocks:</p>
<p><img src="https://github.com/user-attachments/assets/6f266440-c6e2-447c-ad7f-f92244f9d09b" alt="image" /></p>
<p>These blocks are <code>ResolverOutput::from_state</code> with 1.3% and <code>ForkState::into_resolution</code> with 4.1% of resolver thread runtime for apache airflow universal.</p>
<p>We reduce the overhead spent in those functions, to now 1.1% and 2.1% of resolver time spend in those functions by:</p>
<p>Commit 1: Replace the hash set for the edges with a vec in <code>ForkState::into_resolution</code>. We deduplicate edges anyway when collecting them, and the hash-and-insert was slow.</p>
<p>Commit 2: Reduce the distribution clonign in <code>ResolverOutput::from_state</code> by using an <code>Arc</code>.</p>
<p>The same profile excerpt for the resolver with the branch (note that there is now an unrelated block between the two we optimized):</p>
<p><img src="https://github.com/user-attachments/assets/e36c205d-2cf8-4fe6-a2dd-3020c0515922" alt="image" /></p>
<p>Wall times are noisy, but the profiles show those changes as improvements.</p>
<pre><code>$ hyperfine --warmup 2 &quot;./uv-main pip compile --no-progress scripts/requirements/airflow.in --universal&quot; &quot;./uv-branch pip compile --no-progress scripts/requirements/airflow.in --universal&quot;
Benchmark 1: ./uv-main pip compile --no-progress scripts/requirements/airflow.in --universal
  Time (mean ± σ):      99.1 ms ±   3.8 ms    [User: 111.8 ms, System: 115.5 ms]
  Range (min … max):    93.6 ms … 110.4 ms    29 runs
 
Benchmark 2: ./uv-branch pip compile --no-progress scripts/requirements/airflow.in --universal
  Time (mean ± σ):      97.1 ms ±   4.3 ms    [User: 114.8 ms, System: 112.0 ms]
  Range (min … max):    90.9 ms … 112.4 ms    29 runs
 
Summary
  ./uv-branch pip compile --no-progress scripts/requirements/airflow.in --universal ran
    1.02 ± 0.06 times faster than ./uv-main pip compile --no-progress scripts/requirements/airflow.in --universal
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-02-20 11:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-resolver/src/resolver/mod.rs</code>:3080 on 2025-02-20 11:03</div>
            <div class="timeline-body"><p>That's the big perf improvement</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-02-20 11:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-installer/src/plan.rs</code>:397 on 2025-02-20 11:04</div>
            <div class="timeline-body"><p>This is isn't necessary but we avoid the clone as we already have <code>Arc</code>s here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @zanieb on 2025-02-20 14:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2025-02-20 14:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2025-02-20 20:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-02-20 20:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-20 20:13</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:20 UTC
    </footer>
</body>
</html>
