<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv-resolver: include conflict markers in fork markers - astral-sh/uv #10818</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv-resolver: include conflict markers in fork markers</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/10818">#10818</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2025-01-21 16:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-01-21 16:50</div>
            <div class="timeline-body"><p>When support for conflicting extras/groups was initially added, I
stopped short of including the conflict markers in uv's &quot;fork markers&quot;
in the lock file. That is, the fork markers are markers that indicate
the different splits uv took during resolution, which we record, I
believe, to avoid spurious updates to the lock file as a result of
using them as preferences.</p>
<p>One interesting result of omitting the conflict markers from the fork
markers is that sometimes this would result in duplicate markers. In
response, I wrote a function that stripped off the conflict markers and
deduplicated the remainder. My thinking at the time was that it wasn't
clear whether we needed to keep conflict markers around.</p>
<p>It looks like #10783 demonstrates a case where we do, seemingly, need
them. Namely, it's a case where after stripping conflict markers, you
don't end up with duplicate markers, but you do end up with overlapping
markers. Overlapping fork markers are bad juju for the same reason that
overlapping resolver forks are bad juju: you can end up with multiple
versions of the same package in the same environment.</p>
<p>I don't know how to fix overlapping markers without just including the
conflict markers. So that's what this PR does. Because of this, there
will be some churn in lock files, but this only applies to projects that
define conflicting extras.</p>
<p>This PR includes a regression test from #10783. I also manually tried
the original reproduction in #10772 (where adding <code>numpy&lt;2</code> caused <code>uv sync</code> to fail), and things worked.</p>
<p>Fixes #10772, Fixes #10783</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-21 17:28</div>
            <div class="timeline-body"><p>Could we possibly avoid this in some cases, even when conflicting extras are defined? Like, what if the markers aren't overlapping?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-01-21 17:33</div>
            <div class="timeline-body"><p>Yeah I maybe I could modify this to collect only the PEP 508 markers and then only include the conflict portions if <em>any</em> of the PEP 508 markers are not disjoint with one another.</p>
<p>There's definitely another aspect of this which is whether the conflict markers are necessary to avoid the problems that <code>resolution-markers</code> were created to mitigate in the first place. But I'm pretty unsure about that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-21 17:45</div>
            <div class="timeline-body"><p>I would be curious if that change reduces the churn at all!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-01-21 18:46</div>
            <div class="timeline-body"><p>Yeah it definitely reduces churn! It looks like we did have one existing test case that had overlapping markers (but was very easy to miss) that is also fixed too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @BurntSushi on 2025-01-21 19:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2025-01-21 19:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2025-01-21 19:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2025-01-21 19:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-21 19:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @BurntSushi on 2025-01-21 19:04</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:18 UTC
    </footer>
</body>
</html>
