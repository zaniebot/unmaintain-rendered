<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enable Registry Client Builder to be created from Base Client Builder - astral-sh/uv #4729</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Enable Registry Client Builder to be created from Base Client Builder</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/4729">#4729</a>
        opened by <a href="https://github.com/danielenricocahall">@danielenricocahall</a>
        on 2024-07-02 12:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danielenricocahall">@danielenricocahall</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to uv! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<!-- What's the purpose of the change? What does it do, and why? -->

<p>Addresses https://github.com/astral-sh/uv/issues/4330, to reduce duplication in the client creation logic.</p>
<h2>Test Plan</h2>
<!-- How was it tested? -->

<p>https://github.com/astral-sh/uv/pull/4729#issuecomment-2204681655</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @zanieb by @zanieb on 2024-07-02 14:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-07-02 23:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/add.rs</code>:102 on 2024-07-02 23:28</div>
            <div class="timeline-body"><p>Nice! Would you mind auditing for additional cases where this could be used? I think there should be more.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-07-02 23:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/registry_client.rs</code>:124 on 2024-07-02 23:30</div>
            <div class="timeline-body"><p>I was surprised this needed to be <code>mut</code> still. Should the client, markers, and platform be set on the base client builder too (e.g., the same as <code>native_tls</code>)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-02 23:30</div>
            <div class="timeline-body"><p>I don't think you'll need a specific test plan for this one, it should be well covered by our existing tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danielenricocahall">@danielenricocahall</a> reviewed on 2024-07-03 02:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/danielenricocahall">@danielenricocahall</a> on <code>crates/uv/src/commands/project/add.rs</code>:102 on 2024-07-03 02:13</div>
            <div class="timeline-body"><p>Good call! Found 5 more places actually!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danielenricocahall">@danielenricocahall</a> reviewed on 2024-07-03 02:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/danielenricocahall">@danielenricocahall</a> on <code>crates/uv-client/src/registry_client.rs</code>:124 on 2024-07-03 02:16</div>
            <div class="timeline-body"><p>Oh yeah we could definitely do that - would we want to change where each of these <code>RegistryClientBuilder</code>s are created to have the <code>BaseClientBuilder</code> set those fields?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-07-03 04:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/registry_client.rs</code>:124 on 2024-07-03 04:22</div>
            <div class="timeline-body"><p>I'm not sure I follow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danielenricocahall">@danielenricocahall</a> reviewed on 2024-07-03 12:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/danielenricocahall">@danielenricocahall</a> on <code>crates/uv-client/src/registry_client.rs</code>:124 on 2024-07-03 12:15</div>
            <div class="timeline-body"><p>Ah I'm probably not explaining myself well - what I mean is would we need to revise each place we're creating a <code>RegistryClientBuilder</code> to something like:</p>
<pre><code class="language-rust">    let client_builder = BaseClientBuilder::new()
        .connectivity(connectivity)
        .native_tls(native_tls)
        .keyring(settings.keyring_provider)
        .markers(markers) // &lt; - added
        .retries(retries); // &lt; - added

...

    let client = RegistryClientBuilder::from(client_builder)
            .index_urls(settings.index_locations.index_urls())
            .index_strategy(settings.index_strategy); // no longer have base client fields set
</code></pre>
<p>then, in the <code>build</code> function, we would omit the conditionals. Is that what you're thinking?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/registry_client.rs</code>:124 on 2024-07-03 12:47</div>
            <div class="timeline-body"><p>Ah I don't think we need to do that. The <code>RegistryClientBuilder</code> can still provide methods to mutate the <code>base_client_builder</code> it has internally â€” it just shouldn't be mutated during <code>build</code> instead it should happen each time an option is changed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-07-03 12:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danielenricocahall">@danielenricocahall</a> reviewed on 2024-07-04 15:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/danielenricocahall">@danielenricocahall</a> on <code>crates/uv-client/src/registry_client.rs</code>:124 on 2024-07-04 15:46</div>
            <div class="timeline-body"><p>Done!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @danielenricocahall on 2024-07-04 15:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-07-04 15:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @zanieb on 2024-07-04 15:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-04 15:52</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2024-07-04 15:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-07-04 15:53</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:37:52 UTC
    </footer>
</body>
</html>
