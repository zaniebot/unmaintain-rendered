<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>expand tilde in cache-dir - astral-sh/uv #17019</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>expand tilde in cache-dir</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/pull/17019">#17019</a>
        opened by <a href="https://github.com/Mobocop">@Mobocop</a>
        on 2025-12-07 21:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/Mobocop">@Mobocop</a> on 2025-12-07 21:56</div>
            <div class="timeline-body"><!--
Thank you for contributing to uv! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<!-- What's the purpose of the change? What does it do, and why? -->

<p>fixes https://github.com/astral-sh/uv/issues/16288 (I believe that this is a bug, and not an enhancement as stated on the ticket)</p>
<p>The special character <code>~</code> was not being expanded for <code>cache-dir</code> (both CLI and from pyproject.toml and uv.toml). This had different behaviour on Windows and Linux.</p>
<ul>
<li>On Windows it made a directory called <code>~</code> which was used as the cache dir</li>
<li>On Linux it made a directory called <code>~</code> which remained empty and the ~ was expanded to make the cache directory</li>
</ul>
<p>The issue is easily reproduced by installing running uv with a specified cache-dir containing a &quot;~&quot;, e.g.
<code>uv pip install uv --cache-dir=&quot;~/.cache/uv&quot;</code></p>
<p>This issue is not present in ruff, (<a href="https://github.com/astral-sh/ruff/blob/ef45c97dab2e1ab8268308a53e6dd452db40b0db/crates/ruff_server/src/logging.rs#L18-L29">implementation here</a>) who use the <a href="https://crates.io/crates/shellexpand">shellexpand</a> crate to expand the paths</p>
<p>In this PR I have implemented path expansion (as implemented in ruff) into uv for the cache-dir</p>
<h2>Test Plan</h2>
<!-- How was it tested? -->

<p>I have tested that this fix works on Linux (Ubuntu 24.04) and on Windows 10 (22H2)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @Mobocop on 2025-12-07 22:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Mobocop">@Mobocop</a> on 2025-12-07 22:02</div>
            <div class="timeline-body"><p>Apparently I failed the CI. I'll look into it before marking this ready.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @Mobocop on 2025-12-07 22:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-08 12:41</div>
            <div class="timeline-body"><p>If we're going to expand <code>~</code> in user-provided paths we'll need to do so everywhere consistently, not just for <code>cache-dir</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-08 12:41</div>
            <div class="timeline-body"><p>I'm not sure if there are any serious downsides / implications to doing so, we probably need consensus on that first.</p>
<p>Can you point to the commit in Ruff that added support for this?</p>
<p>cc @woodruffw / @konstin</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-12-08 14:26</div>
            <div class="timeline-body"><p>I agree that <code>~</code> sounds good, but we need to do it consistently - It's more complex than treating it as just a bugfix in one location I'm afraid. For example if we only changes the <code>cache-dir</code>, users would get confused why <code>cache-dir</code> works with the tilde but other path-based configuration doesn't.</p>
<p>I wouldn't expand env vars (<code>shellexpand::full</code>), just tildes. We already support env vars for changing the cache, and I'd like to keep the complexity from string interpolation to a minimum, and there exist real paths with a <code>$</code> in them. An open question is where exactly we support tildes, and how we handle tilde-created paths in lockfile if we support such options too: For example, would an index path be stored with <code>~/path/to/index</code> in the lockfile?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/16982.html">astral-sh/uv#16982</a> on 2025-12-08 15:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Mobocop">@Mobocop</a> on 2025-12-08 21:35</div>
            <div class="timeline-body"><blockquote>
<p>If we're going to expand <code>~</code> in user-provided paths we'll need to do so everywhere consistently, not just for <code>cache-dir</code>.</p>
</blockquote>
<p>I completely agree. If you (or someone) can point me at the variables to be expanded I don't mind giving it a go.</p>
<blockquote>
<p>Can you point to the commit in Ruff that added support for this?</p>
</blockquote>
<p>The cache_dir in ruff has always expanded paths fully: https://github.com/astral-sh/ruff/pull/1351</p>
<p>Digging back through the source, I think this is the first issue which raises shell expansion issue (and associated PR), where the issue was actually raised to support environment variables:
Issue - https://github.com/astral-sh/ruff/issues/1316
PR - https://github.com/astral-sh/ruff/pull/1323</p>
<blockquote>
<p>I wouldn't expand env vars (<code>shellexpand::full</code>), just tildes. We already support env vars for changing the cache, and I'd like to keep the complexity from string interpolation to a minimum, and there exist real paths with a <code>$</code> in them. An open question is where exactly we support tildes, and how we handle tilde-created paths in lockfile if we support such options too: For example, would an index path be stored with <code>~/path/to/index</code> in the lockfile?</p>
</blockquote>
<p>I don't mind what you want implemented. <code>shellexpand::full</code> would be consistent with ruff.</p>
<p>I've never seen a path with a &quot;$&quot; in it which was not a variable, but even if there is one I thought that a shell would require it to be escaped. Having said that, using this branch I have tested (Ubunutu 20.04) &quot;$&quot; in the cache directory name. Both
<code>uv pip install uv --cache-dir=&quot;$&quot;</code>
and
<code>uv pip install uv --cache-dir=&quot;./\$/&quot;</code>
worked by creating/using the folder named &quot;$&quot; as the cache-dir (not that I would ever recommend doing this).</p>
<p>I don't have an answer to the lockfile question, I would assume you would want an absolute/expanded path, so that your lockfile is more &quot;locked&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/woodruffw">@woodruffw</a> on 2025-12-08 23:45</div>
            <div class="timeline-body"><p>I might be an outlier here, but I think that behavior (expanding variables, not just tilde) is pretty astonishing and should arguably be limited/removed in ruff too ðŸ˜…</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:31 UTC
    </footer>
</body>
</html>
