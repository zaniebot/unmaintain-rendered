<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change the definition of `--locked` to require satisfaction check - astral-sh/uv #6102</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Change the definition of <code>--locked</code> to require satisfaction check</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/6102">#6102</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-08-15 01:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-15 01:24</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR changes the definition of <code>--locked</code> from:</p>
<blockquote>
<p>Produces the same <code>Lock</code></p>
</blockquote>
<p>To:</p>
<blockquote>
<p>Passes <code>Lock::satisfies</code></p>
</blockquote>
<p>This is a subtle but important difference. Previous, if <code>Lock::satisfies</code> failed, we would run a resolution, then do <code>existing_lock == lock</code>. If the two weren't equal, and <code>--locked</code> was specified, we'd throw an error.</p>
<p>The equality check is hard to get right. For example, it means that we can't ship #6076 without changing our marker representation, since the deserialized lockfile &quot;loses&quot; some of the internal marker state that gets accumulated during resolution.</p>
<p>The downside of this change is that there could be scenarios in which <code>uv lock --locked</code> fails even though the lockfile would actually work and the exact TOML would be unchanged. But... I think it's ok if <code>--locked</code> fails after the user modifies something?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2024-08-15 01:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @charliermarsh on 2024-08-15 01:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ibraheemdev by @charliermarsh on 2024-08-15 01:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> added by @charliermarsh on 2024-08-15 01:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @charliermarsh on 2024-08-15 01:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-15 01:26</div>
            <div class="timeline-body"><p>I'm now trying to think of a situation in which the user could change something (like a workspace requirement), and <code>Lock::satisfies</code> fails, but then the TOML is totally unchanged. Is that even possible anymore?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-15 01:26</div>
            <div class="timeline-body"><p>Anyway, I think this is another change that would reduce a lot of complexity for us while being basically the same for users.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-08-15 01:29</div>
            <div class="timeline-body"><blockquote>
<p>The downside of this change is that there could be scenarios in which uv lock --locked fails even though the lockfile would actually work and the exact TOML would be unchanged.</p>
</blockquote>
<p>I'm not sure I understand this, shouldn't this change allow strictly <em>more</em> lockfiles to satisfy <code>--locked</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-15 01:31</div>
            <div class="timeline-body"><blockquote>
<p>I'm not sure I understand this, shouldn't this change allow strictly more lockfiles to satisfy --locked?</p>
</blockquote>
<p>I don't think so, because before, if you failed <code>Lock::satisfies</code>, we'd still try to resolve, then compare the contents of the lockfiles. Now, if you fail <code>Lock::satisfies</code>, we'll error without trying to resolve. I think the new condition is stricter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-15 01:36</div>
            <div class="timeline-body"><p>Does that make sense?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-08-15 01:42</div>
            <div class="timeline-body"><p>I see, that makes sense. So now we're verifying against the requirements, not the new lockfile.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-15 01:45</div>
            <div class="timeline-body"><p>Yeah, that's a fair description</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-08-15 01:55</div>
            <div class="timeline-body"><p>I'm not sure how this compares to changing the markers to not store the range restriction state. Also trying to think of an example where the requirements change but a resolution would have resulted in the same lockfile (so <code>--locked</code> would now fail where it previously succeeded). I guess if you relaxed a version range for a package that is also depended on transitively, so the locked version does not change.. but with <code>requires-dist</code> now I guess that also changes the lockfile?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-15 01:56</div>
            <div class="timeline-body"><blockquote>
<p>I guess if you relaxed a version range for a package that is also depended on transitively, so the locked version does not change.. but with requires-dist now I guess that also changes the lockfile?</p>
</blockquote>
<p>Yeah this is where I'm ending up too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> approved on 2024-08-15 02:02</div>
            <div class="timeline-body"><p>I think the part about <code>requires-dist</code> making the lockfile change where it previously wouldn't is a little unfortunate, but if we decide to do that (separate from this PR) then this makes sense to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-15 03:06</div>
            <div class="timeline-body"><blockquote>
<p>I think the part about <code>requires-dist</code> making the lockfile change where it previously wouldn't is a little unfortunate, but if we decide to do that (separate from this PR) then this makes sense to me.</p>
</blockquote>
<p>I'm wondering if this is really that big of a problem. If we don't go through <code>Lock::satisfies</code>, we still use the lockfile as preferences and the user may even have a warm cache. It's probably still super fast ü§î</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-15 03:09</div>
            <div class="timeline-body"><p>Maybe just to show my hand a bit: I think this fast path is <em>critical</em> for <code>uv run</code>, where the vast majority of invocations won't have experienced any lockfile changes, and we want as little overhead as we can get there. Everywhere else, I view it as more of a nice-to-have...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-15 03:12</div>
            <div class="timeline-body"><p>Maybe one thing for me to think through tomorrow -- what happens when:</p>
<ul>
<li>User clones a repo, adds a dependency to the <code>pyproject.toml</code> and runs <code>uv lock</code>.</li>
<li>User clones a repo, runs <code>uv sync</code>, then later adds a dependency to the <code>pyproject.toml</code> and runs <code>uv lock</code>.</li>
</ul>
<p>What do we reuse? Where are we being inefficient?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-08-15 03:27</div>
            <div class="timeline-body"><p>The other thing we lost is user clones a repo and runs <code>uv lock</code> with a cold cache (again somewhat unrelated to this change).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-15 03:32</div>
            <div class="timeline-body"><p>I think that‚Äôs unchanged, no? What‚Äôs different there?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-08-15 03:42</div>
            <div class="timeline-body"><p>Sorry, you're right, that hasn't changed. Adding a dependency is where it changed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-15 03:45</div>
            <div class="timeline-body"><p>Yeah, adding a dependency (that was already in the lockfile, I think? But not explicit) changed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-08-15 04:10</div>
            <div class="timeline-body"><p>Any resolution that didn't require fetching versions of existing packages that were not in the lockfile changed. For example, adding a new dependency that did not affect the locked versions of any existing dependencies could use the prefilled index from the lockfile and only fetch the metadata for the new package.</p>
<p>Not sure how big of an impact that optimization had though, and I think we can still make it in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2024-08-15 12:13</div>
            <div class="timeline-body"><p>I think we should do this because it moves <code>uv</code> to a more conservative posture. But I do think we should improve on this in the future. Some specific thoughts:</p>
<blockquote>
<p>The equality check is hard to get right. For example, it means that we can't ship https://github.com/astral-sh/uv/pull/6076 without changing our marker representation, since the deserialized lockfile &quot;loses&quot; some of the internal marker state that gets accumulated during resolution.</p>
</blockquote>
<p>Is this something that could also be fixed by a custom equality comparison?</p>
<blockquote>
<p>The downside of this change is that there could be scenarios in which uv lock --locked fails even though the lockfile would actually work and the exact TOML would be unchanged. But... I think it's ok if --locked fails after the user modifies something?</p>
</blockquote>
<p>I agree. Or at least, I think this is the right decision to make right now.</p>
<blockquote>
<p>I'm now trying to think of a situation in which the user could change something (like a workspace requirement), and Lock::satisfies fails, but then the TOML is totally unchanged. Is that even possible anymore?</p>
</blockquote>
<p>One example is:</p>
<ul>
<li>In <code>pyproject.toml</code>, there is a dependency <code>foo&gt;=1.0</code>.</li>
<li>In <code>uv.lock</code>, <code>foo</code> is locked to <code>1.2</code>.</li>
<li>I make a change to <code>pyproject.toml</code> by updating the dependency on <code>foo</code> to <code>foo&gt;=1.1</code>.</li>
</ul>
<p>This is a somewhat strained example, but it's definitely something I've done a few times in the Rust world where I realized my minimum version constraint was wrong (because I was depending on features in <code>foo</code> released in <code>1.1</code>). So it's not like it never happens. But I think this is a case where <code>Lock::satisfies</code> will fail, but a re-resolve (assuming nothing in the world changed) should produce the same <em>semantic</em> <code>uv.lock</code>. (The actual TOML would be different because we write out the full requirements, and that changed, but the actual locked version that we install wouldn't change.)</p>
<p>But like, I don't necessarily think that is a major issue. Or at least, not a release blocking issue. Unless there are other more important use cases that I'm missing. That is, I think the worst thing that happens here is that folks might need to re-run <code>uv lock</code> in some cases where they might not otherwise have to.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-15 12:17</div>
            <div class="timeline-body"><p>üëç I agree with the above. (And yeah, the TOML <em>would</em> change in that format, but the locked dependencies would not.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-08-15 12:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-08-15 12:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-08-15 12:17</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 13:10:13 UTC
    </footer>
</body>
</html>
