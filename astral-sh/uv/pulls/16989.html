<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publish PyPI releases before crates.io artifacts - astral-sh/uv #16989</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Publish PyPI releases before crates.io artifacts</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/16989">#16989</a>
        opened by <a href="https://github.com/woodruffw">@woodruffw</a>
        on 2025-12-04 19:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Closes #16987.</p>
<h2>Test Plan</h2>
<p>We need a good way to dry-run this...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @woodruffw on 2025-12-04 19:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @woodruffw by @woodruffw on 2025-12-04 19:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @woodruffw on 2025-12-04 19:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/github-advanced-security[bot]">@github-advanced-security[bot]</a> reviewed on 2025-12-04 19:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/github-advanced-security[bot]">@github-advanced-security[bot]</a> on <code>.github/workflows/publish.yml</code>:22 on 2025-12-04 19:31</div>
            <div class="timeline-body"><p>secrets unconditionally inherited by called workflow</p>
<p><a href="https://github.com/astral-sh/uv/security/code-scanning/184">Show more details</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/github-advanced-security[bot]">@github-advanced-security[bot]</a> on <code>.github/workflows/publish.yml</code>:36 on 2025-12-04 19:31</div>
            <div class="timeline-body"><p>secrets unconditionally inherited by called workflow</p>
<p><a href="https://github.com/astral-sh/uv/security/code-scanning/185">Show more details</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/github-advanced-security[bot]">@github-advanced-security[bot]</a> on <code>.github/workflows/release.yml</code>:216 on 2025-12-04 19:31</div>
            <div class="timeline-body"><p>secrets unconditionally inherited by called workflow</p>
<p><a href="https://github.com/astral-sh/uv/security/code-scanning/186">Show more details</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-04 23:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.github/workflows/release.yml</code>:229 on 2025-12-04 23:07</div>
            <div class="timeline-body"><p>Can't we just insert a <code>needs: custom-publish-pypi</code> here instead of changing the composition?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-04 23:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.github/workflows/release.yml</code>:229 on 2025-12-04 23:08</div>
            <div class="timeline-body"><p>this would either require an upstream cargo-dist feature or a dirty manifest cc @Gankra</p>
<p>It might just be easier to conceptualize than nesting the workflows?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>.github/workflows/release.yml</code>:229 on 2025-12-05 00:56</div>
            <div class="timeline-body"><p>Yeah, that's the tradeoff here -- I figured this was a good initial fix, and I could send patches upstream for encoding the <code>needs:</code> (and for https://github.com/axodotdev/cargo-dist/issues/2216).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-12-05 00:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-05 00:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.github/workflows/release.yml</code>:229 on 2025-12-05 00:58</div>
            <div class="timeline-body"><p>I just know using <code>needs:</code> won't break anything but am really not sure if this setup will.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>.github/workflows/release.yml</code>:229 on 2025-12-05 20:45</div>
            <div class="timeline-body"><p>I traced this a bit, and I'm <em>pretty</em> sure it'll work as expected: our top-level <code>release.yml</code> is triggered by <code>pull_request</code> and <code>workflow_dispatch</code>, neither of which is reusable. <code>release.yml</code> then has <code>custom-publish</code>, which dispatches to our first reusable workflow level. That then dispatches to the next level, which means we have at most three levels of calls.</p>
<p>That in turn should put us comfortably under the limit of 10, which is documented here: https://docs.github.com/en/actions/how-tos/reuse-automations/reuse-workflows#nesting-reusable-workflows</p>
<p>With that said, I still find this not confidence inspiring ðŸ˜… -- I'd love to be able to propagate the <code>dry-run</code> input into these reusable workflows so that I could test them, but from what I can find it seems like the <code>plan</code> object doesn't include it. So I'd need to send another patch up to <code>dist</code> for that, which puts it in the same bucket as the other changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-12-05 20:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-05 20:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.github/workflows/release.yml</code>:229 on 2025-12-05 20:46</div>
            <div class="timeline-body"><p>I think I'd rather just have a dirty workflow file until we do the upstream work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2025-12-06 03:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>.github/workflows/release.yml</code>:229 on 2025-12-06 03:39</div>
            <div class="timeline-body"><p>You could &quot;dry-run&quot; it with a real release on a fork ðŸ˜…. I've done nested workflows like this at work, so in theory this should work as long as the permissions and secrets inherits is set correctly. The Dependency Graph UX is terrible though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-12-06 04:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>.github/workflows/release.yml</code>:229 on 2025-12-06 04:56</div>
            <div class="timeline-body"><p>Yeah, it'll just be a mess with all the release state. I agree with @zanieb that having a dirty change is probably the best short term fix here ðŸ˜…</p>
<p>(Long term I want to remove these reusable workflows entirely and replace them with actions, since they mess with the signing identity when publishing / attesting.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/woodruffw">@woodruffw</a> on 2025-12-09 16:58</div>
            <div class="timeline-body"><p>Okay, this is now a single-line change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @woodruffw on 2025-12-09 16:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2025-12-09 17:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-09 17:03</div>
            <div class="timeline-body"><p>@Gankra if you could confirm please :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Enforce release publishing order" to "Publish PyPI releases before crates.io artifacts" by @zanieb on 2025-12-09 17:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2025-12-09 21:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-12-09 21:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-09 21:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-12-11 15:27</div>
            <div class="timeline-body"><p>Oh yuck, ok yeah we'll do something upstream in cargo-dist for this. You can <em>almost</em> just move cargo-publish to a custom-host-job but it wouldn't respect dry-runs. Although, what was wrong with the &quot;single publish job that just does both sub-jobs in serial&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-11 15:33</div>
            <div class="timeline-body"><p>It sounded way more likely to break via some OIDC edge case and this is dead simple.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-12-11 15:58</div>
            <div class="timeline-body"><p>Hmm I'll have to take your word for it on OIDC.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-11 16:03</div>
            <div class="timeline-body"><p>I mean, it <em>should</em> work but there's ~no consequence to a dirty dist workflow right now.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:45:30 UTC
    </footer>
</body>
</html>
