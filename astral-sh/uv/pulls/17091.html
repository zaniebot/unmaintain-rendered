<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>16782 python update shell force - astral-sh/uv #17091</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>16782 python update shell force</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/pull/17091">#17091</a>
        opened by <a href="https://github.com/F4RAN">@F4RAN</a>
        on 2025-12-11 19:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/F4RAN">@F4RAN</a> on 2025-12-11 19:32</div>
            <div class="timeline-body"><!--
Thank you for contributing to uv! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Adds a <code>--force</code> flag to <code>uv python update-shell</code> and <code>uv tool update-shell</code> to allow prepending the executable directory to PATH even when it's already present. This fixes cases where binaries are shadowed by earlier PATH entries.</p>
<p>When <code>--force</code> is used, the command removes any existing entry and prepends it again, ensuring first priority. Works on both Unix/macOS (shell config files) and Windows (registry).</p>
<h2>Test Plan</h2>
<ul>
<li>Added integration tests for normal, skip, and force cases</li>
<li>Manually tested on macOS with both commands</li>
<li>All existing tests pass</li>
<li>Windows support will be tested automatically in CI</li>
</ul>
<p>Fixes #16782</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/chatgpt-codex-connector[bot]">@chatgpt-codex-connector[bot]</a> reviewed on 2025-12-11 19:35</div>
            <div class="timeline-body"><h3>üí° Codex Review</h3>
<p>Here are some automated review suggestions for this pull request.</p>
<details> <summary>‚ÑπÔ∏è About Codex in GitHub</summary>
<br/>

<p><a href="http://chatgpt.com/codex/settings/general">Your team has set up Codex to review pull requests in this repo</a>. Reviews are triggered when you</p>
<ul>
<li>Open a pull request for review</li>
<li>Mark a draft as ready</li>
<li>Comment &quot;@codex review&quot;.</li>
</ul>
<p>If Codex has suggestions, it will comment; otherwise it will react with üëç.</p>
<p>Codex can also answer questions or update the PR. Try commenting &quot;@codex address that feedback&quot;.</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/chatgpt-codex-connector[bot]">@chatgpt-codex-connector[bot]</a> on <code>crates/uv/src/commands/python/update_shell.rs</code>:47 on 2025-12-11 19:35</div>
            <div class="timeline-body"><p><strong><sub><sub><img src="https://img.shields.io/badge/P0-red?style=flat" alt="P0 Badge" /></sub></sub>  Stop calling private Windows PATH helpers across crates</strong></p>
<p>The Windows force branch calls <code>uv_shell::windows::get_windows_path_var</code> (and then <code>prepend_to_path</code>/<code>apply_windows_path_var</code>), but those helpers are not <code>pub</code> in <code>crates/uv-shell/src/windows.rs</code>. Because this module lives in a different crate, these references fail to compile (E0603), so <code>uv python update-shell</code> and the analogous tool command cannot build until the helpers are exported or this code is reworked.</p>
<p>Useful? React with üëç¬†/ üëé.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/chatgpt-codex-connector[bot]">@chatgpt-codex-connector[bot]</a> on <code>crates/uv/src/commands/python/update_shell.rs</code>:33 on 2025-12-11 19:35</div>
            <div class="timeline-body"><p><strong><sub><sub><img src="https://img.shields.io/badge/P1-orange?style=flat" alt="P1 Badge" /></sub></sub>  Avoid mutating PATH while checking for existing entry</strong></p>
<p>On Windows the presence check <code>let is_in_path = !uv_shell::windows::prepend_path(&amp;executable_directory)?;</code> invokes <code>prepend_path</code>, which actually writes to the registry when the entry is missing. As a result, when the executable directory was not yet on PATH, the first call already inserts it, and the later <code>!is_in_path</code> branch calls <code>prepend_path</code> again, which returns false and skips the ‚ÄúUpdated PATH‚Ä¶‚Äù messaging. Users on Windows now get a silent PATH modification when the directory was absent (same pattern in the tool command). The check should avoid mutating state or only prepend once so the user-facing output remains accurate.</p>
<p>Useful? React with üëç¬†/ üëé.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-shell/src/windows.rs</code>:105 on 2025-12-19 14:28</div>
            <div class="timeline-body"><p>I'm personally not sure it's worth removing the old entry unless windows doesn't like that for some reason.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/src/lib.rs</code>:1556 on 2025-12-19 16:48</div>
            <div class="timeline-body"><p>We don't normally pass the <code>*Args</code> to the function directly. Just pass <code>args.force</code> directly for consistency.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/src/lib.rs</code>:1750 on 2025-12-19 16:49</div>
            <div class="timeline-body"><p>Ditto</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/tests/it/python_update_shell.rs</code>:12 on 2025-12-19 16:57</div>
            <div class="timeline-body"><p>I think probably it would be a little bit cleaner to just have a conditional <code>#[test]</code> for windows and non-windows.</p>
<p>Or maybe even a module for windows and one for not windows, since this pattern repeats in the other tests. Although we don't do that elsewhere.</p>
<p>I see <code>export::reduce_ssh_key_file_permissions</code> does it like <em>this</em> though. I'll let someone else chip in an opinion here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/tests/it/python_update_shell.rs</code>:166 on 2025-12-19 17:17</div>
            <div class="timeline-body"><p>Since you need to restart cmd/powershell/windows terminal for this to take effect, wouldn't this still succeed without <code>--force</code>?</p>
<p>If we're just testing that the output on stderr indicates something happened, we probably don't need the initial call above in that case?</p>
<p>Maybe it is worth actually reading/writing the registry?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/tests/it/python_update_shell.rs</code>:166 on 2025-12-19 17:19</div>
            <div class="timeline-body"><p>Also, if these tests write to the registry, and we were to check the result, I imagine we would need to run the tests serially...?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/tests/it/main.rs</code>:105 on 2025-12-19 17:24</div>
            <div class="timeline-body"><p>This just tests <code>python_update_shell</code> which is only for managed pythons so should probably be &quot;python-managed&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/tests/it/main.rs</code>:137 on 2025-12-19 17:25</div>
            <div class="timeline-body"><p>Given we currently seem to have largely duplicate code for both <code>python update-shell</code> and <code>tool update-shell</code> we should probably still test it for whatever that's worth.</p>
<p>Although it seems a bit excessive to have that code duplicated at this point. But that can probably be address separately to this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/tests/it/python_update_shell.rs</code>:166 on 2026-01-06 15:44</div>
            <div class="timeline-body"><p>I think maybe an okay approach is to just use windows command line tools to set/check the registry in the tests...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2026-01-06 15:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @EliteTK by @EliteTK on 2026-01-06 15:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/F4RAN">@F4RAN</a> reviewed on 2026-01-07 04:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/F4RAN">@F4RAN</a> on <code>crates/uv-shell/src/windows.rs</code>:105 on 2026-01-07 04:45</div>
            <div class="timeline-body"><p>Hello @EliteTK,
Thanks for reviewing.</p>
<p>Removing the old entry is intentional. The purpose of <code>--force</code> is to move the path to the <strong>front</strong> of PATH (first priority), not to create duplicates. If we just prepend without removing, the path would appear twice (once in the middle, once at the front), which is redundant and doesn't solve the shadowing issue described in #16782.</p>
<p>This matches the Unix implementation, which also removes the old entry before re-adding it at the front.</p>
<p>I'm able to change it if you prefer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/F4RAN">@F4RAN</a> reviewed on 2026-01-07 04:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/F4RAN">@F4RAN</a> on <code>crates/uv/src/lib.rs</code>:1556 on 2026-01-07 04:55</div>
            <div class="timeline-body"><p>You're right üëç
Fixed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/F4RAN">@F4RAN</a> reviewed on 2026-01-07 04:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/F4RAN">@F4RAN</a> on <code>crates/uv/src/lib.rs</code>:1750 on 2026-01-07 04:56</div>
            <div class="timeline-body"><p>Done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/F4RAN">@F4RAN</a> reviewed on 2026-01-07 04:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/F4RAN">@F4RAN</a> on <code>crates/uv/tests/it/python_update_shell.rs</code>:12 on 2026-01-07 04:56</div>
            <div class="timeline-body"><p>Done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/F4RAN">@F4RAN</a> reviewed on 2026-01-07 04:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/F4RAN">@F4RAN</a> on <code>crates/uv/tests/it/python_update_shell.rs</code>:166 on 2026-01-07 04:56</div>
            <div class="timeline-body"><p>Done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/F4RAN">@F4RAN</a> reviewed on 2026-01-07 04:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/F4RAN">@F4RAN</a> on <code>crates/uv/tests/it/main.rs</code>:105 on 2026-01-07 04:56</div>
            <div class="timeline-body"><p>Done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/F4RAN">@F4RAN</a> reviewed on 2026-01-07 04:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/F4RAN">@F4RAN</a> on <code>crates/uv/tests/it/main.rs</code>:137 on 2026-01-07 04:56</div>
            <div class="timeline-body"><p>Done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2026-01-07 10:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-shell/src/windows.rs</code>:105 on 2026-01-07 10:01</div>
            <div class="timeline-body"><blockquote>
<p>The purpose of <code>--force</code> is to move the path to the front of PATH (first priority), not to create duplicates.</p>
</blockquote>
<p>I mean that duplicates won't matter. At least on *nix the paths are scanned sequentially and the first match wins. You won't get shadowing even if the same path appears a second time after another path which would shadow it.</p>
<p>With the approach we use on *nix we are already potentially creating duplicate entries by unconditionally pre-pending.</p>
<p>But, having given it a bit more time, I can sort of see it from the other perspective - someone using this tooling probably isn't interested in managing these variables themselves so minimising mess is probably a fair idea.</p>
<p>Leave it for now... Someone else will chip in if they have a better idea.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 05:43:35 UTC
    </footer>
</body>
</html>
