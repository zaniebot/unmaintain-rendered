<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>publish: don't infer check URLs for pyx uploads - astral-sh/uv #16234</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>publish: don't infer check URLs for pyx uploads</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/16234">#16234</a>
        opened by <a href="https://github.com/woodruffw">@woodruffw</a>
        on 2025-10-10 15:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a></div>
            <div class="timeline-body"><p>I think I've got this right, but could use a sanity check from @charliermarsh and @konstin ðŸ™‚</p>
<h2>Summary</h2>
<p>At the moment, <code>uv publish</code> obtains a check URL for pyx-based registries in one of two flows:</p>
<ol>
<li>Explicitly configured as an index URL in the index configuration</li>
<li>Implicitly discovered/inferred through <code>token_store.is_known_url</code></li>
</ol>
<p>The end result of either of these flows is that <code>uv publish</code> does a pre-upload check against the simple index before attempting to upload a distribution. However, this isn't needed in pyx's case, since pyx matches PyPI's behavior of idempotency on uploads -- pyx returns a 200 if the <code>(filename, digest)</code> pair has already been uploaded.</p>
<p>So, this PR just removes both of those flows. (2) is easy, (1) requires us to special-case the configuration lookup slightly to <em>ignore</em> the index URL if its publish URL is known as a pyx upload URL.</p>
<p>Notably, we <em>do</em> still honor a check URL for pyx if the user explicitly passes one in one the CLI. I think this is fine -- it <em>will</em> work in most publishing scenarios, just not ones that we're otherwise automating (i.e., Trusted Publishing).</p>
<h2>Test Plan</h2>
<p>I'm going to drive some e2e testing on pyx-auth-action using builds against these changes. That'll confirm that we don't secretly introduce the check URL anywhere else.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @woodruffw on 2025-10-10 15:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @woodruffw on 2025-10-10 15:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @woodruffw on 2025-10-10 15:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @woodruffw by @woodruffw on 2025-10-10 15:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @woodruffw on 2025-10-10 15:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2025-10-10 16:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/woodruffw">@woodruffw</a> on 2025-10-10 16:46</div>
            <div class="timeline-body"><p>Successful e2e test: https://github.com/astral-sh/pyx-auth-action/actions/runs/18412825129/job/52469333708?pr=14</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @woodruffw on 2025-10-10 16:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @woodruffw on 2025-10-10 16:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-10-10 16:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-10-13 10:15</div>
            <div class="timeline-body"><blockquote>
<p>The end result of either of these flows is that <code>uv publish</code> does a pre-upload check against the simple index before attempting to upload a distribution. However, this isn't needed in pyx's case, since pyx matches PyPI's behavior of idempotency on uploads -- pyx returns a 200 if the <code>(filename, digest)</code> pair has already been uploaded.</p>
</blockquote>
<p>FWIW another difference is that pre-check will skip the actual upload if the file already exists, i.e. a performance optimization.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:45:00 UTC
    </footer>
</body>
</html>
