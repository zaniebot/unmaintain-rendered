<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error on lockfiles with incoherent wheel versions - astral-sh/uv #12235</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Error on lockfiles with incoherent wheel versions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/12235">#12235</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2025-03-17 10:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>Reject lockfiles where the package version and the wheel versions are incoherent. This implicitly checks that all wheel files have the same version.</p>
<p>It does not check for the source dist version, since a source dist may not contain a version in the filename and attempting to deserialize source dist filenames we may not need is a performance overhead for something that&#x27;s already slow in <code>uv run</code>.</p>
<p>Fixes #12164
See also <a href="https://github.com/astral-sh/uv/issues/12254">astral-sh/uv#12254</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/konstin">@konstin</a> on 2025-03-17 10:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-resolver/src/lock/mod.rs</code>:2883 on 2025-03-17 10:20</div>
            <div class="timeline-body"><p>We should always have at least one wheel enabling us to catch the inconsistency?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv/tests/it/sync.rs</code>:8557 on 2025-03-17 10:25</div>
            <div class="timeline-body"><p>Would a user find this surprising? I think I&#x27;d assume uv will create a correct lockfile when running <code>uv lock</code>. And it might not be clear to a user what action they should take next if they see this error.</p>
<p>I guess it partially depends on what &quot;If a lockfile is present, its contents will be used as preferences for the resolution&quot; from the docs for <code>uv lock</code> means. Does that mean we try to use those preferences, but override them if necessary?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-03-17 10:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-03-17 10:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-resolver/src/lock/mod.rs</code>:2883 on 2025-03-17 10:42</div>
            <div class="timeline-body"><p>Not necessarily, for example:</p>
<pre><code>dependencies = [
    &quot;sniffio&quot;,
]

[tool.uv.sources]
sniffio = { path = &quot;sniffio.tar.gz&quot; }
</code></pre>
<p><code>uv.lock</code>:</p>
<pre><code>[[package]]
name = &quot;sniffio&quot;
version = &quot;1.3.1&quot;
source = { path = &quot;sniffio.tar.gz&quot; }
sdist = { hash = &quot;sha256:f4324edc670a0f49750a81b895f35c3adb843cca46f0530f79fc1babb23789dc&quot; }
</code></pre>
<p>In this case, it&#x27;s not possible to determine from the lockfile alone whether there is an inconsistency.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-03-17 10:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/sync.rs</code>:8557 on 2025-03-17 10:49</div>
            <div class="timeline-body"><p>Currently, we fail on all kinds of parsing errors with lockfile. For example, an empty <code>uv.lock</code> fails:</p>
<pre><code>$ uv lock
error: Failed to parse `uv.lock`
  Caused by: TOML parse error at line 1, column 1
  |
1 | 
  | ^
missing field `version`
</code></pre>
<p>As does a lockfile where I removed the source line:</p>
<pre><code>$ uv lock
error: Failed to parse `uv.lock`
  Caused by: TOML parse error at line 16, column 1
   |
16 | [[package]]
   | ^^^^^^^^^^^
missing field `source`
</code></pre>
<p>We can try to be better about recovering from a broken lockfile, but that&#x27;s outside of the scope of the PR (uv would never write such a lockfile, and with this change, uv will refuse to sync a broken dependabot PR, failing CI). For comparison, in cases where the lockfile is not invalid but doesn&#x27;t fully match in a non-version anymore, e.g., the environments changed, we for example only reuse the versions as preference but not the full lockfile (<code>ValidatedLock</code> enumerates the cases).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-resolver/src/lock/mod.rs</code>:2883 on 2025-03-17 11:30</div>
            <div class="timeline-body"><p>I&#x27;ve added another commit that catches all mismatches between locked source dist version and the built wheel versions at build time. This would enforce stricter guarantees than we require right now, CC @charliermarsh</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-03-17 11:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-03-17 11:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-resolver/src/lock/mod.rs</code>:2883 on 2025-03-17 11:32</div>
            <div class="timeline-body"><p>As an example:</p>
<pre><code>[[package]]
name = &quot;sniffio&quot;
version = &quot;2.3.4&quot;
source = { url = &quot;https://files.pythonhosted.org/packages/a2/87/a6771e1546d97e7e041b6ae58d80074f81b7d5121207425c964ddf5cfdbd/sniffio-1.3.1.tar.gz&quot; }
sdist = { hash = &quot;sha256:f4324edc670a0f49750a81b895f35c3adb843cca46f0530f79fc1babb23789dc&quot; }
</code></pre>
<p>With this last commit fails with:</p>
<pre><code>  × Failed to download and build `sniffio @
  │ https://files.pythonhosted.org/packages/a2/87/a6771e1546d97e7e041b6ae58d80074f81b7d5121207425c964ddf5cfdbd/sniffio-1.3.1.tar.gz`
  ╰─▶ Package metadata version `1.3.1` does not match given version `2.3.4`
  help: `sniffio` was included because `foo` (v0.1.0) depends on `sniffio`
</code></pre>
<p>The potential clash could be with git dependencies that use a version-from-git integration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-03-17 11:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-resolver/src/lock/mod.rs</code>:2883 on 2025-03-17 11:40</div>
            <div class="timeline-body"><p>Moved this to a separate PR: <a href="https://github.com/astral-sh/uv/pull/12237">astral-sh/uv#12237</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-17 13:17</div>
            <div class="timeline-body"><p>Does this mean that Dependabot updates will lead to hard uv errors? (I understand that, at least the linked issue, what they&#x27;re doing today may not be sound.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-03-17 13:20</div>
            <div class="timeline-body"><p>I think so, at least making PRs with this logic without updating source dist and wheels accordingly will lead to broken lockfiles: https://github.com/dependabot/dependabot-core/blob/1cd6fc59d7dae25d46255550528dd056c97c46d8/uv/lib/dependabot/uv/file_updater/lock_file_updater.rb#L111-L120. We currently accept those lockfile changes, but they don&#x27;t do semantically what the PR diff would suggest (they don&#x27;t actually upgrade the version).</p>
<p>Other commenters at <a href="https://github.com/dependabot/dependabot-core/issues/10478">dependabot/dependabot-core#10478</a> have noted that dependabot can produce lockfiles broken under <code>--locked</code> already (<a href="https://github.com/dependabot/dependabot-core/issues/10478">dependabot/dependabot-core#10478</a>#issuecomment-2722750493)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/shauneccles">@shauneccles</a> on 2025-03-17 21:29</div>
            <div class="timeline-body"><p>As a user and developer I want uv to explode if dependabot maims my lockfile so I know about it and so I can raise issues with dependabot.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/urschrei">@urschrei</a> on 2025-03-17 21:36</div>
            <div class="timeline-body"><blockquote>
<p>Other commenters at <a href="https://github.com/dependabot/dependabot-core/issues/10478">dependabot/dependabot-core#10478</a> have noted that dependabot can produce lockfiles broken under <code>--locked</code> already (<a href="https://github.com/dependabot/dependabot-core/issues/10478#issuecomment-2722750493">dependabot/dependabot-core#10478 (comment)</a>)</p>
</blockquote>
<p>Yep that&#x27;s my lockfile, and they certainly do currently break them (tysm for <code>--locked</code>: it does what it says on the tin)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-03-17 21:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-resolver/src/lock/mod.rs</code>:2880 on 2025-03-17 21:38</div>
            <div class="timeline-body"><p>Can we show the versions in the error here? Like &quot;packaged version {} does not match {} from wheel {}&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-03-17 22:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-resolver/src/lock/mod.rs</code>:2880 on 2025-03-17 22:02</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/uv/pull/12249</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2025-03-17 22:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-17 22:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Reject lockfiles with incoherent versions&quot; to &quot;Error on lockfiles with incoherent wheel versions&quot; by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-17 22:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-17 22:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-17 22:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-17 22:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kleinhenz">@kleinhenz</a> on 2025-03-18 13:19</div>
            <div class="timeline-body"><p>This seems to have caused some problems with the flash-attn wheels.</p>
<pre><code>#pyproject.toml
...

[tool.uv]
environments = [&quot;sys_platform == &#x27;darwin&#x27;&quot;, &quot;sys_platform == &#x27;linux&#x27;&quot;]
constraint-dependencies = [&quot;torch==2.5.1&quot;]

[tool.uv.sources]
flash_attn = [
  { url = &quot;https://github.com/Dao-AILab/flash-attention/releases/download/v2.7.3/flash_attn-2.7.3+cu12torch2.5cxx11abiFalse-cp310-cp310-linux_x86_64.whl&quot;, marker = &quot;sys_platform == &#x27;linux&#x27; and python_version == &#x27;3.10&#x27;&quot;},
  { url = &quot;https://github.com/Dao-AILab/flash-attention/releases/download/v2.7.3/flash_attn-2.7.3+cu12torch2.5cxx11abiFalse-cp311-cp311-linux_x86_64.whl&quot;, marker = &quot;sys_platform == &#x27;linux&#x27; and python_version == &#x27;3.11&#x27;&quot;},
  { url = &quot;https://github.com/Dao-AILab/flash-attention/releases/download/v2.7.3/flash_attn-2.7.3+cu12torch2.5cxx11abiFalse-cp312-cp312-linux_x86_64.whl&quot;, marker = &quot;sys_platform == &#x27;linux&#x27; and python_version == &#x27;3.12&#x27;&quot;},
  { url = &quot;https://github.com/Dao-AILab/flash-attention/releases/download/v2.7.3/flash_attn-2.7.3+cu12torch2.5cxx11abiFalse-cp313-cp313-linux_x86_64.whl&quot;, marker = &quot;sys_platform == &#x27;linux&#x27; and python_version == &#x27;3.13&#x27;&quot;}
]
</code></pre>
<p>Now causes <code>uv sync</code> to error with</p>
<pre><code>error: Failed to parse `uv.lock`
  Caused by: The entry for package `flash-attn` v2.7.3 has wheel `flash_attn-2.7.3+cu12torch2.5cxx11abifalse-cp310-cp310-linux_x86_64.whl` with inconsistent version: v2.7.3+cu12torch2.5cxx11abifalse
</code></pre>
<p>Not sure if there is a better way to configure usage of these wheels.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-18 13:21</div>
            <div class="timeline-body"><p>Ah thanks, we can fix that.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:51:23 UTC
    </footer>
</body>
</html>
