<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Communicate PEP 517 hook results via files - astral-sh/uv #2314</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Communicate PEP 517 hook results via files</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/2314">#2314</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-03-09 03:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to uv! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>In #1813, we were failing to install <code>scikit-image==0.19.3</code> from source in Python 3.11. Confusingly, though, the trace showed that the build command exited with status 0...</p>
<p>The issue is that we get results from the PEP 517 hooks by reading from <code>stdout</code> -- that is, we <code>print</code> at the end of the script, and parse the printed output on the other side.</p>
<p>It turns out that for <code>scikit-image</code>, in this case, there was output <em>after</em> the wheel filename:</p>
<pre><code>...
no previously-included directories found matching 'doc/gh-pages'
adding license file 'LICENSE.txt'
writing manifest file 'scikit_image.egg-info/SOURCES.txt'
Copying scikit_image.egg-info to build/bdist.macosx-12.6-arm64/wheel/scikit_image-0.19.3-py3.11.egg-info
running install_scripts
scikit_image-0.19.3-cp311-cp311-macosx_14_0_arm64.whl
INFO:
########### EXT COMPILER OPTIMIZATION ###########
INFO: Platform      :
  Architecture: aarch64
  Compiler    : clang

CPU baseline  :
  Requested   : 'min'
  Enabled     : NEON NEON_FP16 NEON_VFPV4 ASIMD
  Flags       : none
  Extra checks: none

CPU dispatch  :
  Requested   : 'max -xop -fma4'
  Enabled     : ASIMDHP ASIMDDP ASIMDFHM
  Generated   : none
INFO: CCompilerOpt.cache_flush[864] : write cache to path -&gt; /private/var/folders/nt/6gf2v7_s3k13zq_t3944rwz40000gn/T/.tmp5ZPIbv/built-wheels-v0/pypi/scikit-image/0.19.3/hLW_f7wWeGDOPRlSazQXw/scikit-image-0.19.3.tar.gz/build/temp.macosx-12.6-arm64-3.11/ccompiler_opt_cache_ext.py
</code></pre>
<p>We need the <code>scikit_image-0.19.3-cp311-cp311-macosx_14_0_arm64.whl</code> line, but we were failing to find it due to all the extra output at the end (presumedly, some kind of <code>atexit</code> logging).</p>
<p>This PR modifies the hooks to instead write their results to files that are passed in by the parent. On the other end, we then read the results back from disk. This makes it much more robust to &quot;other&quot; output in the script.</p>
<p>Closes https://github.com/astral-sh/uv/issues/1813.</p>
<h2>Test Plan</h2>
<p>Ran <code>cargo run pip install scikit-image==0.19.3 --reinstall --no-cache-dir</code> on Python 3.11.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-03-09 03:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-09 03:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-build/src/lib.rs</code>:736 on 2024-03-09 03:19</div>
            <div class="timeline-body"><p>These don't <em>need</em> deterministic names (we pass them into the script anyway) but I figured it would help debugging.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-03-09 03:22</div>
            <div class="timeline-body"><p>Makes sense!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-03-09 11:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-03-09 11:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-03-09 11:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:36:00 UTC
    </footer>
</body>
</html>
