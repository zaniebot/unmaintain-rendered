<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>avoid fetching an exact, cached commit, even if it isn't locked - astral-sh/uv #13748</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>avoid fetching an exact, cached commit, even if it isn't locked</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/13748">#13748</a>
        opened by <a href="https://github.com/oconnor663">@oconnor663</a>
        on 2025-05-31 03:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/oconnor663">@oconnor663</a></div>
            <div class="timeline-body"><p>This is ~a rough draft of~ one approach we might take to fixing https://github.com/astral-sh/uv/issues/13513</p>
<p>Here's a complete repro of the bug (arguably) in that ticket:</p>
<pre><code>$ cd `mktemp -d`
$ cat &lt;&lt; EOF &gt; requirements.txt                                                                           
feedparser @ git+https://github.com/kurtmckee/feedparser@6c2a412a1569303c6c02d82ef38c08e19f81315e
EOF
$ uv venv
...
$ uv pip install -r requirements.txt 2&gt;&amp;1 | cat
   Updating https://github.com/kurtmckee/feedparser (6c2a412a1569303c6c02d82ef38c08e19f81315e)
    Updated https://github.com/kurtmckee/feedparser (6c2a412a1569303c6c02d82ef38c08e19f81315e)
Resolved 7 packages in 12ms
Installed 7 packages in 7ms
...
$ uv pip install -r requirements.txt 2&gt;&amp;1 | cat
   Updating https://github.com/kurtmckee/feedparser (6c2a412a1569303c6c02d82ef38c08e19f81315e)
    Updated https://github.com/kurtmckee/feedparser (6c2a412a1569303c6c02d82ef38c08e19f81315e)
Resolved 7 packages in 18ms
Audited 7 packages in 0.02ms
</code></pre>
<p>The problem is that we keep fetching the repo every time, even though this commit is definitely in cache. With the changes in this PR, the extra fetch is gone:</p>
<pre><code>$ uv pip install -r requirements.txt 2&gt;&amp;1 | cat
Resolved 7 packages in 15ms
Audited 7 packages in 0.07ms
</code></pre>
<p>This ~draft~ PR notices that the ref we're trying to fetch looks exactly like a commit, and it checks (<code>rev-parse</code>) whether that commit is already present in the cached repo and interprets it as a locked (<code>precise</code>) ref if so. ~The implementation is kind of sloppy as is, and it should probably be factored into smaller functions out and also tested,~ but I need feedback on the overall approach.</p>
<p>Another approach we could take here could be to change our interpretation of these looks-like-a-commit refs such that we <em>always</em> assume they're commits at parse time. (In other words, mark the with <code>precise</code> OIDs as soon as we parse them.) If we did that, we'd probably want to add checks to make sure that we catch it if that assumption is ever violated. It looks like we used to behave more like this, but then we <a href="https://github.com/astral-sh/uv/pull/10803">replaced that with the current behavior</a>, and if we want to go this way I'll need to make sure I understand exactly why we did that.</p>
<p>@ibraheemdev would you have time to take a look at this? Also cc @charliermarsh and @zanieb.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ibraheemdev by @oconnor663 on 2025-05-31 03:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @oconnor663 on 2025-05-31 03:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-05-31 03:49</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_WALLTIME_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/uv/branches/jack%2Fgit_exact_commit">CodSpeed Walltime Performance Report</a></h2>
<h3>Merging #13748 will <strong>improve performances by 16.67%</strong></h3>
<p><sub>Comparing <code>jack/git_exact_commit</code> (41a6e9f) with <code>main</code> (f5382c0)</sub></p>
<h3>Summary</h3>
<p><code>⚡ 1</code> improvements<br />
<code>✅ 11</code> untouched benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>wheelname_parsing_failure[flyte-long-extension]</code> | 112 ns | 96 ns | +16.67% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @zanieb by @zanieb on 2025-06-02 15:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/uv-git/src/source.rs</code>:113 on 2025-06-02 16:34</div>
            <div class="timeline-body"><p>I don't think <code>contains</code> is enough because <code>rev-parse</code> will peel references by default. You can use <code>git rev-parse --symbolic-full-name</code> to check if the reference is a direct commit or not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-06-02 16:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/oconnor663">@oconnor663</a> reviewed on 2025-06-02 16:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/oconnor663">@oconnor663</a> on <code>crates/uv-git/src/source.rs</code>:113 on 2025-06-02 16:50</div>
            <div class="timeline-body"><p>I played with this by hand and convinced myself it was correct:</p>
<p>https://github.com/astral-sh/uv/blob/d65c146b2179abcbef62ff81ee24c24468800cad/crates/uv-git/src/git.rs#L342-L345</p>
<p>When I try to make something that looks like a commit, that <code>^0</code> suffix makes it fail (I think that's why you added it :smile:):</p>
<pre><code>$ cd `mktemp -d`
$ git init
Initialized empty Git repository in /tmp/tmp.fXWCZPpOwN/.git/
$ echo hi &gt; file.txt
$ git add -A
$ git commit -am &quot;first commit&quot;
[main (root-commit) b1ea66a] first commit
 1 file changed, 1 insertion(+)
 create mode 100644 file.txt
$ git checkout -b aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
Switched to a new branch 'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa'
$ git rev-parse aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa 2&gt;/dev/null &amp;&amp; echo success || echo fail
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
success
$ git rev-parse 'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa^0' 2&gt;/dev/null &amp;&amp; echo success || echo fail
aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa^0
fail
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-06-02 16:56</div>
            <div class="timeline-body"><p>Hmm, I'm seeing <a href="https://github.com/astral-sh/uv/actions/runs/15359720277/job/43225148460?pr=13748">this test failure in CI</a> (weirdly only on Ubuntu?):</p>
<pre><code>        FAIL [   2.359s] uv::it sync::sync_script
──── STDOUT:             uv::it sync::sync_script

running 1 test
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot: sync_script-5
Source: crates/uv/tests/it/sync.rs:8128
────────────────────────────────────────────────────────────────────────────────
Expression: snapshot
────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬───────────────────────────────────────────────────────────────────
    1     1 │ exit_code: 2
    2     2 │ ----- stdout -----
    3     3 │ 
    4     4 │ ----- stderr -----
    5       │-Using script environment at: [CACHE_DIR]/environments-v2/script-[HASH]
          5 │+Recreating script environment at: [CACHE_DIR]/environments-v2/script-[HASH]
    6     6 │ error: `uv sync --locked` requires a script lockfile; run `uv lock --script script.py` to lock the script
────────────┴───────────────────────────────────────────────────────────────────
Stopped on the first failure. Run `cargo insta test` to run all snapshots.
test sync::sync_script ... FAILED
</code></pre>
<p>But I'm not able to repro the failure locally with <code>cargo test sync_script</code>. Does this look like the kind of thing that could be a CI flake?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-06-02 17:04</div>
            <div class="timeline-body"><p>That's one the common CI flake unfortunately, one that we should invest into fixing: https://github.com/astral-sh/uv/issues/13745</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-06-02 17:07</div>
            <div class="timeline-body"><p>Indeed, I just reran it and got green :p</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-06-02 17:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/uv-git/src/source.rs</code>:113 on 2025-06-02 17:50</div>
            <div class="timeline-body"><p>Ah right, <code>^0</code> works as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-06-02 18:43</div>
            <div class="timeline-body"><p>I probably would label this as an enhancement rather than a bug, since there's not actually a correctness issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-06-02 18:46</div>
            <div class="timeline-body"><p>This seems reasonable to me. Are there any downsides?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @oconnor663 on 2025-06-03 13:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @oconnor663 on 2025-06-03 13:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-06-06 12:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-git/src/source.rs</code>:110 on 2025-06-06 12:45</div>
            <div class="timeline-body"><p>Do we need this check, or is the <code>let Ok</code> on <code>maybe_commit.parse::&lt;GitOid&gt;()</code> sufficient?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-06-06 12:45</div>
            <div class="timeline-body"><p>I think this is generally correct and what I was looking for.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/oconnor663">@oconnor663</a> reviewed on 2025-06-06 18:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/oconnor663">@oconnor663</a> on <code>crates/uv-git/src/source.rs</code>:110 on 2025-06-06 18:09</div>
            <div class="timeline-body"><p>Kind of surprising to me, but <code>parse</code> is not sufficient: https://github.com/astral-sh/uv/blob/0109af1aa510bd4f0759b0d53d842c3716e5cc3f/crates/uv-git-types/src/oid.rs#L8</p>
<p>I might experiment with making <code>GitOid</code> stricter. Like we discussed before how there's probably not actually a good reason to support OIDs less than 40 chars.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/oconnor663">@oconnor663</a> reviewed on 2025-06-06 23:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/oconnor663">@oconnor663</a> on <code>crates/uv-git-types/src/oid.rs</code>:54 on 2025-06-06 23:10</div>
            <div class="timeline-body"><p>I've added strict <code>GitOid</code> parsing to this PR, since it simplifies the new code in <code>sources.rs</code> and it doesn't seem to break anything.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/oconnor663">@oconnor663</a> reviewed on 2025-06-06 23:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/oconnor663">@oconnor663</a> on <code>crates/uv/tests/it/pip_install.rs</code>:2136 on 2025-06-06 23:14</div>
            <div class="timeline-body"><p>This test occasionally flakes for me, and I can't understand why. Sometimes, rarely, the <code>Resolved 1 package</code> line comes after the <code>Updating</code>/<code>Updated</code> lines. It doesn't look like that should be possible when I read the code, because this call to <code>operations::resolve</code>:</p>
<p>https://github.com/astral-sh/uv/blob/dc3fd464728fe0456c26e79beb56017d8d56a08d/crates/uv/src/commands/pip/install.rs#L466</p>
<p>...happens strictly before this call to <code>operations::install</code>...</p>
<p>https://github.com/astral-sh/uv/blob/dc3fd464728fe0456c26e79beb56017d8d56a08d/crates/uv/src/commands/pip/install.rs#L508</p>
<p>I'm clearly overlooking something, but I'm not sure what. Maybe the answer is to just filter out the &quot;Resolved...&quot; line, but I want to understand it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-06-06 23:26</div>
            <div class="timeline-body"><blockquote>
<p>Are there any downsides?</p>
</blockquote>
<p>The only downside I can think of (other than added code complexity) is the cost of shelling out to <code>git rev-parse</code> before we fetch. That's obviously worth it in the cached case where it lets us skip the rest of the fetch entirely, but it's an additional cost in the initial, uncached case that we weren't paying before. That said, the cost of the fetch that you're going to do in that case will dwarf the <code>rev-parse</code>, so I don't think it matters much?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @oconnor663 on 2025-06-06 23:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-06-06 23:49</div>
            <div class="timeline-body"><p>Still not sure about the flake I mentioned above, but still I'm moving this out of Draft Status :) I found it hard to get rid of that temporary closure I'm using, so that's still in from the draft, though the <code>GitOid</code> change makes it at bit better.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-git/src/source.rs</code>:95 on 2025-06-09 21:53</div>
            <div class="timeline-body"><p>Nit: we'd probably style as this</p>
<pre><code class="language-suggestion">            // If we have a locked revision, and we have a pre-existing database which has that
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-06-09 21:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-06-09 21:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-git/src/source.rs</code>:105 on 2025-06-09 21:54</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/uv/pull/13748/files#r2136565690</p>
<pre><code class="language-suggestion">            // and we do have a pre-existing database, then check whether it is, in fact, a commit
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-06-09 21:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-git/src/source.rs</code>:120 on 2025-06-09 21:54</div>
            <div class="timeline-body"><pre><code class="language-suggestion">            // ... otherwise, we use this state to update the Git database. Note that we still check
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-06-09 21:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-static/src/env_vars.rs</code>:731 on 2025-06-09 21:56</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// Disable GitHub-specific requests that allow uv to skip `git fetch` in some circumstances.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2025-06-09 21:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-06-09 22:43</div>
            <div class="timeline-body"><p>I finally tracked down the test flake. The common case would take this path (<code>-v</code> logs):</p>
<pre><code>DEBUG At least one requirement is not satisfied: git+https://github.com/astral-test/uv-public-pypackage@b270df1a2fb5d012294e9aaf05e7e0bab1e6a389
DEBUG Using request timeout of 30s
DEBUG Attempting GitHub fast path for: git+https://github.com/astral-test/uv-public-pypackage@b270df1a2fb5d012294e9aaf05e7e0bab1e6a389
DEBUG Querying GitHub for commit at: https://api.github.com/repos/astral-test/uv-public-pypackage/commits/b270df1a2fb5d012294e9aaf05e7e0bab1e6a389
DEBUG Attempting to fetch `pyproject.toml` from: https://raw.githubusercontent.com/astral-test/uv-public-pypackage/b270df1a2fb5d012294e9aaf05e7e0bab1e6a389/pyproject.toml
DEBUG Found static metadata via GitHub fast path for: git+https://github.com/astral-test/uv-public-pypackage@b270df1a2fb5d012294e9aaf05e7e0bab1e6a389
</code></pre>
<p>But the uncommon case (which happened to trigger here in CI, maybe for rate limit reasons) would take this path:</p>
<pre><code>DEBUG At least one requirement is not satisfied: git+https://github.com/astral-test/uv-public-pypackage@b270df1a2fb5d012294e9aaf05e7e0bab1e6a389
DEBUG Using request timeout of 30s
DEBUG Attempting GitHub fast path for: git+https://github.com/astral-test/uv-public-pypackage@b270df1a2fb5d012294e9aaf05e7e0bab1e6a389
DEBUG Querying GitHub for commit at: https://api.github.com/repos/astral-test/uv-public-pypackage/commits/b270df1a2fb5d012294e9aaf05e7e0bab1e6a389
DEBUG No netrc file found
DEBUG GitHub API request failed for: https://api.github.com/repos/astral-test/uv-public-pypackage/commits/b270df1a2fb5d012294e9aaf05e7e0bab1e6a389 (403 Forbidden)
DEBUG Fetching source distribution from Git: https://github.com/astral-test/uv-public-pypackage
</code></pre>
<p>This failure in the GitHub fast path would lead us to fetch the repo as part of resolution, instead of a part of building, which appeared as a reordering of the <code>Resolved</code> and <code>Updating</code>/<code>Updated</code> logs. Disabling the GitHub fast path entirely currently makes the test reliable.</p>
<p>@charliermarsh @ibraheemdev, this is ready for a re-review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-06-09 22:58</div>
            <div class="timeline-body"><p>I think you're fine to merge unless you think any reviewers have outstanding concerns or you feel uncertain about something in particular.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-06-09 23:37</div>
            <div class="timeline-body"><p>This should also fix https://github.com/astral-sh/uv/issues/12746.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @oconnor663 on 2025-06-09 23:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @oconnor663 on 2025-06-09 23:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-09 23:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-06-10 09:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/pip_install.rs</code>:2136 on 2025-06-10 09:22</div>
            <div class="timeline-body"><p>Is that the one resolved by <code>UV_NO_GITHUB_FAST_PATH</code>?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:43:22 UTC
    </footer>
</body>
</html>
