<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix tracing output in `cargo dev` commands - astral-sh/uv #4090</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix tracing output in <code>cargo dev</code> commands</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/4090">#4090</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-06-06 12:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-06 12:05</div>
            <div class="timeline-body"><p>There's probably a more succinct way to do this, but I figure we should have it be similar to <code>uv::main</code> so I copied most of the content from there.</p>
<p>Now <code>cargo dev fetch-python</code> output is shown again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @zanieb on 2024-06-06 12:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @zanieb on 2024-06-06 12:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-06-06 12:37</div>
            <div class="timeline-body"><p>Do you want the same logging infrastructure in uv-dev as in uv or do you just want basic logging in <code>cargo dev fetch-python</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-06 12:39</div>
            <div class="timeline-body"><p>I don't really care, I just want logging to work again. I spent like 20 minutes thinking the command wasn't working. I figure having to be similar to <code>uv</code> but a bit stripped down makes sense. If someone wants something else I'm fine with tha ttoo.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-06-06 12:46</div>
            <div class="timeline-body"><p>The change below does basic logging. I want to avoid duplicating this code because it means having to fix any logging bug twice. We can put the logging code into a function and call it from both main functions (<code>uv-dev</code> can depend on <code>uv</code>, i think), or we say basic logging is enough in uv-dev and do the below.</p>
<pre><code class="language-diff">diff --git a/crates/uv-dev/src/main.rs b/crates/uv-dev/src/main.rs
index d3a3b723..75b19dbc 100644
--- a/crates/uv-dev/src/main.rs
+++ b/crates/uv-dev/src/main.rs
@@ -1,6 +1,7 @@
 use std::env;
 use std::path::PathBuf;
 use std::process::ExitCode;
+use std::str::FromStr;
 use std::time::Instant;
 
 use anstream::{eprintln, println};
@@ -10,9 +11,10 @@ use owo_colors::OwoColorize;
 use tracing::{debug, instrument};
 use tracing_durations_export::plot::PlotConfig;
 use tracing_durations_export::DurationsLayerBuilder;
+use tracing_subscriber::filter::Directive;
 use tracing_subscriber::layer::SubscriberExt;
 use tracing_subscriber::util::SubscriberInitExt;
-use tracing_subscriber::EnvFilter;
+use tracing_subscriber::{EnvFilter, Layer};
 
 use crate::build::{build, BuildArgs};
 use crate::clear_compile::ClearCompileArgs;
@@ -117,15 +119,21 @@ async fn main() -&gt; ExitCode {
         (None, None)
     };
 
-    let filter_layer = EnvFilter::try_from_default_env().unwrap_or_else(|_| {
-        EnvFilter::builder()
-            // Show only the important spans
-            .parse(&quot;uv_dev=info,uv_dispatch=info&quot;)
-            .unwrap()
-    });
+    // Show `INFO` messages from the `uv` crate, but allow `RUST_LOG` to override.
+    let default_directive = Directive::from_str(&quot;uv=info&quot;).unwrap();
+
+    let filter = EnvFilter::builder()
+        .with_default_directive(default_directive)
+        .from_env()
+        .expect(&quot;Valid RUST_LOG directives&quot;);
+
     tracing_subscriber::registry()
         .with(duration_layer)
-        .with(filter_layer)
+        .with(
+            tracing_subscriber::fmt::layer()
+                .with_writer(std::io::stderr)
+                .with_filter(filter),
+        )
         .init();
 
     let start = Instant::now();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-06 12:56</div>
            <div class="timeline-body"><p>@konstin want to just open a PR for that then?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-06-06 12:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 13:54:20 UTC
    </footer>
</body>
</html>
