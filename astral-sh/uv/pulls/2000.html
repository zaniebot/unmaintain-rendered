<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add a `--python` flag to allow installation into arbitrary Python interpreters - astral-sh/uv #2000</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add a <code>--python</code> flag to allow installation into arbitrary Python interpreters</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/2000">#2000</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-02-27 01:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds a <code>--python</code> flag that allows users to provide a specific Python interpreter into which <code>uv</code> should install packages. This would replace the <code>VIRTUAL_ENV=</code> workaround that folks have been using to install into arbitrary, system environments, while <em>also</em> actually being correct for installing into non-virtual environments, where the bin and site-packages paths can differ.</p>
<p>The approach taken here is to use <code>sysconfig.get_paths()</code> to get the correct paths from the interpreter, and then use those for determining the <code>bin</code> and <code>site-packages</code> directories, rather than constructing them based on hard-coded expectations for each platform.</p>
<p>Closes https://github.com/astral-sh/uv/issues/1396.</p>
<p>Closes https://github.com/astral-sh/uv/issues/1779.</p>
<p>Closes https://github.com/astral-sh/uv/issues/1988.</p>
<h2>Test Plan</h2>
<ul>
<li>Verified that, on my Windows machine, I was able to install <code>requests</code> into a global environment with: <code>cargo run pip install requests --python 'C:\\Users\\crmarsh\\AppData\\Local\\Programs\\Python\\Python3.12\\python.exe</code>, then <code>python</code> and <code>import requests</code>.</li>
<li>Verified that, on macOS, I was able to install <code>requests</code> into a global environment installed via Homebrew with: <code>cargo run pip install requests --python $(which python3.8)</code>.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @charliermarsh on 2024-02-27 01:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-02-27 01:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @charliermarsh on 2024-02-27 01:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2024-02-27 01:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2024-02-27 01:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2024-02-27 01:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @charliermarsh on 2024-02-27 02:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-27 02:13</div>
            <div class="timeline-body"><p>Marking as draft, one important thing to fix here when creating environments for isolated builds (hence test failures). I see the problem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-27 03:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/main.rs</code>:442 on 2024-02-27 03:57</div>
            <div class="timeline-body"><p>It feels weird to consider installing packages into an interpreter. Perhaps we should rephrase?</p>
<p>Separately, &quot;into which to&quot; is really confusing</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/main.rs</code>:442 on 2024-02-27 04:25</div>
            <div class="timeline-body"><p>Focused on other things right now, I'll come back to this comment later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-27 04:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2024-02-27 05:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-27 05:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-interpreter/src/interpreter.rs</code>:104 on 2024-02-27 05:19</div>
            <div class="timeline-body"><p>\cc @konstin - I think <code>include</code> is the same in a venv as not...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-27 05:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-interpreter/src/interpreter.rs</code>:398 on 2024-02-27 05:20</div>
            <div class="timeline-body"><p>\cc @konstin - But when installing, there's custom logic. (We had this in <code>install-wheel-rs</code>, which prior to this PR assumed a virtualenv.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-interpreter/src/interpreter.rs</code>:82 on 2024-02-27 05:21</div>
            <div class="timeline-body"><p>@konstin - AFAICT, <code>base_prefix</code> doesn't change in a virtualenv...?</p>
<pre><code class="language-text">uv on ÓÇ† charlie/py:main [$‚á°] is üì¶ v0.1.11 via üêç v3.11.7 (uv) via ü¶Ä v1.76.0
‚ùØ python
Python 3.11.7 (main, Dec  4 2023, 18:10:11) [Clang 15.0.0 (clang-1500.1.0.2.5)] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import sys
&gt;&gt;&gt; sys.base_prefix
'/opt/homebrew/opt/python@3.11/Frameworks/Python.framework/Versions/3.11'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-27 05:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-27 05:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-interpreter/src/interpreter.rs</code>:398 on 2024-02-27 05:59</div>
            <div class="timeline-body"><p>If you look at the linked pip source, they also have this logic around <code>user</code> and <code>home</code>. Is that significant here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-27 06:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/install-wheel-rs/src/linker.rs</code>:34 on 2024-02-27 06:06</div>
            <div class="timeline-body"><p>The client now passes in a struct that contains all the paths we need to use here (rather than passing in a root, and expecting this crate to construct paths).</p>
<p>Previously, this crate was responsible for constructing those paths, and it <em>assumed</em> that it was installing into a virtual environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-27 07:22</div>
            <div class="timeline-body"><p><code>cargo run pip install requests --python 'C:\\Users\\crmarsh\\AppData\\Local\\Programs\\Python\\Python3.12\\python.exe</code> this is confusing. I thought for a moment that it should be <code>cargo run uv</code> and not pip :)</p>
<p>Can you extend the test plan with a package that has a launcher script and starting that:</p>
<pre><code>uv pip install --python &lt;path&gt; black
black -h
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/uv/src/main.rs</code>:688 on 2024-02-27 07:33</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// The Python interpreter into which packages should be uninstalled.
</code></pre>
<p>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/install-wheel-rs/src/wheel.rs</code>:236 on 2024-02-27 07:35</div>
            <div class="timeline-body"><p>Nit: I wasn't aware that this path must be relative. Should we add at least a <code>debug_assert</code> to <code>write_file_recorded</code> that asserts that <code>relative_path</code> is relative?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/install-wheel-rs/src/wheel.rs</code>:229 on 2024-02-27 07:37</div>
            <div class="timeline-body"><p>What are cases where this can happen? Is it when entrypoint and site packages aren't pointing to the same drive on windows? Is this a possible solution?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/install-wheel-rs/src/target.rs</code>:4 on 2024-02-27 07:38</div>
            <div class="timeline-body"><p>Nit: Maybe move to <code>lib.rs</code>?</p>
<p>Nit: Consider renaming to <code>TargetEnvironment</code>. It seems we have multiple existing <code>Target</code> types, giving it a unique name helps with searchability (e.g. VS Code only Find all references searches by the struct name and not the full qualified name)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/install-wheel-rs/src/wheel.rs</code>:199 on 2024-02-27 07:52</div>
            <div class="timeline-body"><p>Nit: This is not a very actionable comment so please feel free to disregard it (especially for this PR).</p>
<p>I feel like that there are a couple of concept in this file that aren't represented by explicit types and, instead, we pass different, somehow related arguments to many functions (which probably have to fulfill certain constraints but they aren't explicitly expressed). I find that this makes the functions hard to understand and use (so many arguments, uff, I don't know what they are ;)). Having more explicit construct might also allow to make some of these functions methods and, by doing so, reduce the number of arguments that need to be passed in each call. But I don't understand this code and concepts behind it well enough to make any suggestions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/install-wheel-rs/src/linker.rs</code>:92 on 2024-02-27 07:53</div>
            <div class="timeline-body"><p>Nit: maybe just pass in the <code>target</code> and let <code>write_script_entrypoints</code> figure out which paths are relevant</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-02-27 08:07</div>
            <div class="timeline-body"><p>The code looks good to me. I'm leaving it to someone else who understands packaging to approve the PR.</p>
<p>Even after reading the linked issues, I still don't fully understand its use case.  I struggle because what I read is mainly the ask to add a <code>pip</code> compatible interface, but not the problem that needs solving (what are they trying to do) and why creating and activating a venv is undesired.</p>
<p>I'm not saying that increasing <code>pip</code> compatibility is bad, but I worry that adding support hinders the ecosystem from adopting a better solution. E.g, most <code>uv</code> installs use <code>pip</code>, even though installing it with pip can be slower than running <code>uv venv</code> and <code>uv pip install</code>. Using the scripts would give them a better experience. Here I see the problem with us because we don't provide an easy way of using <code>uv</code> in github actions (CI) yet that abstracts all this away.</p>
<p>I'm bringing this up because I'm curious if it's related to the global install problem. Could a GitHub action that installs <code>uv</code>, activates the <code>venv</code> and installs the dependencies solve the CI part of the problem? If so, would alternative solutions work for the remaining non CI workflows that don't require supporting global installs (The fact that you can uninstall packages from a global directory seems crazy to me)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-27 11:13</div>
            <div class="timeline-body"><p>Testing: I'll migrate the workflow mentioned in https://github.com/astral-sh/uv/issues/1779 to using the new flag</p>
<p>It doesn't have to be part of this PR but should we warn or even error if we detect that <code>VIRTUAL_ENV</code> points to a directory that isn't a virtual env? We may need to warn in a first version to avoid breaking existing workflows, but I consider it an unsupported workflow that can break subtly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/install-wheel-rs/src/target.rs</code>:11 on 2024-02-27 11:24</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// The `include` directory, as returned by `sysconfig.get_paths()`.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/install-wheel-rs/src/target.rs</code>:4 on 2024-02-27 11:25</div>
            <div class="timeline-body"><p>Maybe <code>InstallationLayout</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/install-wheel-rs/src/wheel.rs</code>:219 on 2024-02-27 11:28</div>
            <div class="timeline-body"><p>How's that different from <code>Path::strip_prefix</code>?</p>
<p>If we need it, can we copy the function into <code>uv_fs</code> (https://github.com/Manishearth/pathdiff/blob/a78acde0955a556b2bdf11e6a9efae459c4bcf80/src/lib.rs#L34-L77)? The repo looks abandoned and there are no docs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-interpreter/src/interpreter.rs</code>:82 on 2024-02-27 11:32</div>
            <div class="timeline-body"><p>Yes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-interpreter/src/interpreter.rs</code>:104 on 2024-02-27 11:33</div>
            <div class="timeline-body"><p>Odd, the docs make it look as if should also change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-interpreter/src/interpreter.rs</code>:398 on 2024-02-27 11:35</div>
            <div class="timeline-body"><p>I don't think i ever had to deal with <code>include</code>, sorry, no idea</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-interpreter/src/interpreter.rs</code>:370 on 2024-02-27 11:36</div>
            <div class="timeline-body"><p>Shouldn't this be <code>!=</code>, if the next branch is for venvs?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-interpreter/src/interpreter.rs</code>:389 on 2024-02-27 11:37</div>
            <div class="timeline-body"><p>I'd go with <code>SysconfigInstallationPaths</code> or <code>SysconfigInstallationPaths</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-27 11:39</div>
            <div class="timeline-body"><p>I tested #1779 and using <code>--python</code> works (see https://github.com/MichaReiser/tox-uv/actions/runs/8064054107/job/22027134724?pr=1). However, I still don't consider this a good experience because the commands are not platform agnostic (<code>python.exe</code> vs <code>python</code>) and it requires a lot of fumbling. I think we should recommend using a venv instead. But that has it's own problem because the commands for activating a venv are platform specific too.</p>
<p>That's why I think we need to be careful about communicating this change. We shouldn't communicate it as <em>the solution</em> for CI. CI should use <code>uv venv</code>, <code>&lt;activate venv&gt;</code> and <code>uv install</code>. This is painful because it involves many platform agnostic steps (including the installation of <code>uv</code>) but leads to a better experience overall. Ultimately, we should build a setup action instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-interpreter/src/virtual_env.rs</code>:21 on 2024-02-27 11:44</div>
            <div class="timeline-body"><p>Is calling it <code>Virtualenv</code> still correct?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> requested changes on 2024-02-27 11:45</div>
            <div class="timeline-body"><p>This needs https://packaging.python.org/en/latest/specifications/externally-managed-environments/ or we will break environments</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-27 13:44</div>
            <div class="timeline-body"><p>@konstin - so we‚Äôre just supposed to raise an error if the installation is externally managed? That‚Äôs my read of the spec.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-27 13:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/install-wheel-rs/src/wheel.rs</code>:199 on 2024-02-27 13:45</div>
            <div class="timeline-body"><p>(For context, this was vendored in from an existing crate, so it‚Äôs evolved somewhat separately from the rest of the project.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-27 14:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-interpreter/src/interpreter.rs</code>:104 on 2024-02-27 14:33</div>
            <div class="timeline-body"><p>Which docs? Link please!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-02-27 14:33</div>
            <div class="timeline-body"><p>Yes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-27 14:34</div>
            <div class="timeline-body"><blockquote>
<p>Even after reading the linked issues, I still don't fully understand its use case. I struggle because what I read is mainly the ask to add a pip compatible interface, but not the problem that needs solving (what are they trying to do) and why creating and activating a venv is undesired.</p>
</blockquote>
<p>@MichaReiser - My read of the commentary in the issues is that this is primarily for CI and Docker environments. In both cases, I believe that creating and activating a virtual environment would work, but that doing so tends to be inconvenient and unusual. (E.g., there were some issues stemming from the fact that in GHA, you need to activate the environment in every step, rather than once.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-27 14:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-interpreter/src/interpreter.rs</code>:389 on 2024-02-27 14:34</div>
            <div class="timeline-body"><p>I will do <code>SysconfigPaths</code>, since that matches the name of the method.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-27 14:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-interpreter/src/interpreter.rs</code>:370 on 2024-02-27 14:51</div>
            <div class="timeline-body"><p>No, the first branch is for venvs, right? See the linked pip source.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-27 14:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/install-wheel-rs/src/wheel.rs</code>:219 on 2024-02-27 14:54</div>
            <div class="timeline-body"><p>Trying to understand, why would <code>strip_prefix</code> work here? The entrypoint is not a subdirectory of <code>site_packages</code> (if you look at <code>bin_rel()</code> previously, it started with <code>../..</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-interpreter/src/virtual_env.rs</code>:21 on 2024-02-27 14:54</div>
            <div class="timeline-body"><p>I'm open to other names. What would you suggest? <code>PythonEnvironment</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-27 14:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-27 14:56</div>
            <div class="timeline-body"><blockquote>
<p>That's why I think we need to be careful about communicating this change. We shouldn't communicate it as the solution for CI. CI should use uv venv, <activate venv> and uv install. This is painful because it involves many platform agnostic steps (including the installation of uv) but leads to a better experience overall. Ultimately, we should build a setup action instead.</p>
</blockquote>
<p>I'm not totally sold on this. If it were a better experience, wouldn't folks be doing it already? Why does <code>--python $(which python)</code> feel like a &quot;lot of fumbling&quot;?</p>
<p>Edit: is it more that you have to construct the Python path on Windows?'</p>
<p>Edit: if the latter, I want to add a separate <code>--system</code> flag that automates the lookup of the Python flag for this common case. So running in CI is just <code>--system</code>. (I think we're doing a good thing by defaulting to virtual environments and requiring dedicated opt-out for other workflows, even though it differs from pip and others.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-02-27 14:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/install-wheel-rs/src/wheel.rs</code>:219 on 2024-02-27 14:57</div>
            <div class="timeline-body"><p>I see, makes sense</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-27 15:01</div>
            <div class="timeline-body"><blockquote>
<p>I'm not totally sold on this. If it were a better experience, wouldn't folks be doing it already? Why does --python $(which python) feel like a &quot;lot of fumbling&quot;?</p>
</blockquote>
<p>I don't think that works on windows. You would probably need to use <code>where.exe</code>, meaning you end up with platform specific steps.</p>
<blockquote>
<p>My read of the commentary in the issues is that this is primarily for CI and Docker environments. In both cases, I believe that creating and activating a virtual environment would work, but that doing so tends to be inconvenient and unusual. (E.g., there were some issues stemming from the fact that in GHA, you need to activate the environment in every step, rather than once.)</p>
</blockquote>
<p>For me the question is why is it inconvenient in CI? I believe it is mainly so because we don't provide a better way of doing it. A <code>setup-uv</code> action could install <code>uv</code>, create the venv for you, set the <code>VIRTUAL_ENV</code> environment variable and all following steps would &quot;just work&quot; without the need for any platform specific code.</p>
<p>I don't know much about docker but a single <code>uv venv</code> doesn't seem that bad to me? But I suspect that there are use cases that I don't understand.</p>
<blockquote>
<p>(E.g., there were some issues stemming from the fact that in GHA, you need to activate the environment in every step, rather than once.)</p>
</blockquote>
<p>That's true, but an action could set the <code>VIRTUAL_ENV</code> environment variable, so that this isn't necessary. This is okay because we know it points to a venv created by <code>uv</code>.</p>
<p>Edit: Another way to phrase this is: We should document what the recommended way of using <code>uv</code> in docker and CI is. I don't think it is what's outlined above, but it would allow decoupling the decision from this PR (which I think we should)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-27 15:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-interpreter/src/interpreter.rs</code>:370 on 2024-02-27 15:08</div>
            <div class="timeline-body"><p>Oh I got the condition wrong! The condition is inverted. I see.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-02-27 15:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-interpreter/src/interpreter.rs</code>:104 on 2024-02-27 15:16</div>
            <div class="timeline-body"><p>https://docs.python.org/3/library/sysconfig.html#installation-paths</p>
<p>But i don't disagree, <code>include</code> is also an outlier for me:</p>
<pre><code>Paths: 
        data = &quot;/home/konsti/projects/uv/.venv&quot;
        include = &quot;/home/konsti/.pyenv/versions/3.10.13/include/python3.10&quot;
        platinclude = &quot;/home/konsti/.pyenv/versions/3.10.13/include/python3.10&quot;
        platlib = &quot;/home/konsti/projects/uv/.venv/lib/python3.10/site-packages&quot;
        platstdlib = &quot;/home/konsti/projects/uv/.venv/lib/python3.10&quot;
        purelib = &quot;/home/konsti/projects/uv/.venv/lib/python3.10/site-packages&quot;
        scripts = &quot;/home/konsti/projects/uv/.venv/bin&quot;
        stdlib = &quot;/home/konsti/.pyenv/versions/3.10.13/lib/python3.10&quot;
</code></pre>
<p>Same with the apt installed python as base:</p>
<pre><code>Paths: 
        data = &quot;/home/konsti/projects/uv/.venv&quot;
        include = &quot;/usr/include/python3.11&quot;
        platinclude = &quot;/usr/include/python3.11&quot;
        platlib = &quot;/home/konsti/projects/uv/.venv/lib/python3.11/site-packages&quot;
        platstdlib = &quot;/home/konsti/projects/uv/.venv/lib/python3.11&quot;
        purelib = &quot;/home/konsti/projects/uv/.venv/lib/python3.11/site-packages&quot;
        scripts = &quot;/home/konsti/projects/uv/.venv/bin&quot;
        stdlib = &quot;/usr/lib/python3.11&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-02-27 15:20</div>
            <div class="timeline-body"><p>I don't think telling people &quot;you have to use our GitHub Action to use <code>uv</code> in CI&quot; is a good solution:</p>
<ul>
<li>To me, GitHub Actions are things you use to simplify a bunch of otherwise-complex steps. Saying you have to use a GitHub Action here feels like an implicit admission that setting up uv to work well in CI is complex -- it shouldn't be!</li>
<li>I think it's easiest for users to understand if uv is as similar as possible to use in CI compared to how they use it locally. They obviously won't be using a GitHub Action locally ;)</li>
<li>Users never needed to use a GitHub Action for pip; it'll come as a surprise to them that they need to for uv</li>
</ul>
<p>I like the idea of a bare-bones GitHub Action to do <em>just the first step</em> (installation of <code>uv</code> itself), since the only platform-independent way of doing that currently is via pip, which is slow. But I'd really like for the rest of the <code>uv</code> experience to be simple enough that you can do it without using an Action. So while I absolutely agree that <code>uv</code>'s default of disallowing installation when a venv isn't activated is the better default, I still think a <code>--system</code> flag is the best option for CI, personally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2024-02-27 15:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-27 15:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/pip_sync.rs</code>:89 on 2024-02-27 15:59</div>
            <div class="timeline-body"><p>I will do this in a follow-up PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-27 16:12</div>
            <div class="timeline-body"><blockquote>
<p>I don't think telling people &quot;you have to use our GitHub Action to use uv in CI&quot; is a good solution:</p>
</blockquote>
<p>I agree on that. Ideally it works without</p>
<blockquote>
<p>I think it's easiest for users to understand if uv is as similar as possible to use in CI compared to how they use it locally.</p>
</blockquote>
<p>I agree, but people are using <code>venv</code> locally, so why not use them in CI? It means that what you run on CI is different than what you run locally</p>
<p>To not sidetrack this discussion further. I would like to see a follow-up where we document the recommended workflow of using <code>uv</code> in CI and docker, where we can point users to (and discuss the ideal workflow once).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-02-27 16:19</div>
            <div class="timeline-body"><blockquote>
<p>I agree, but people are using <code>venv</code> locally, so why not use them in CI?</p>
</blockquote>
<p>Sure, but locally creating the venv is typically a one-time thing you do when cloning the repo for the first time and setting up your dev environment for that project (at least, it is for me), whereas in CI it has to be done every time, as you're starting from scratch every time. And the steps you'd do locally to activate the environment (<code>source .venv/bin/activate</code> or <code>.venv\Scripts\activate</code>) are totally different to the steps you need in CI, where you have to <code>echo</code> the path to the venv and the path to the venv's Python into environment variables if you want the venv to remain activated between steps</p>
<blockquote>
<p>It means that what you run on CI is different than what you run locally</p>
</blockquote>
<p>But I don't think there <em>should</em> be a meaningful difference between installing into a venv locally and installing globally in CI, since the CI environment is just discarded at the end of the workflow.</p>
<blockquote>
<p>I would like to see a follow-up where we document the recommended workflow of using <code>uv</code> in CI and docker, where we can point users to (and discuss the ideal workflow once).</p>
</blockquote>
<p>Yes, fully agreed (and already tracked in #1386 / #1604 ;).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-interpreter/src/virtual_env.rs</code>:21 on 2024-02-27 20:23</div>
            <div class="timeline-body"><p><code>InterpreterRoot</code> maybe? Almost tempted to name it something related to site packages</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-02-27 20:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2024-02-27 23:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-interpreter/src/interpreter.rs</code>:104 on 2024-02-27 23:53</div>
            <div class="timeline-body"><p>Depends on the build headers I think? There was an issue a while ago with deadsnakes changing them to <code>/usr/local/include</code>  vs canonical <code>/usr/include</code> the headers had https://github.com/deadsnakes/issues/issues/237</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-28 02:09</div>
            <div class="timeline-body"><p>Gonna put up some follow-up PRs. Merging for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-02-28 02:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-02-28 02:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-02-28 02:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-28 02:10</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/uv/pull/2000/commits/518e74b7ee095c669735b60ab170cfadeb66b5d5 contains a test script and a GitHub Actions workflow to install on system python on macOS and Linux. (I tried to get it to work on Windows, but I wasted too much time trying to get GitHub Actions to work.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wimglenn">@wimglenn</a> on 2024-03-18 02:27</div>
            <div class="timeline-body"><p>Hi @charliermarsh , this is a very useful feature, thanks! I have a couple of questions on usage.</p>
<p>Q1: ~is it expected that using a relative path is not working (<em>edit</em>: on macOS - seems to work fine on Linux)?~</p>
<pre><code>$ uv pip install --dry-run --python .venv/bin/python six 
error: Failed to query Python interpreter at `.venv/bin/python`
  Caused by: No such file or directory (os error 2)
</code></pre>
<p>~An absolute path to the same python exe is working:~</p>
<pre><code>$ pwd
/Users/wim
$ uv pip install --dry-run --python /Users/wim/.venv/bin/python six
Audited 1 package in 1ms
Would make no changes
</code></pre>
<p><em><strong>edit</strong>: I can't reproduce this on 0.1.22. I checked again after downgrading back to 0.1.21 (where I originally saw the issue) and could no longer reproduce it there either... ü§∑</em></p>
<p>Q2: how do you actually use this feature with <code>uv pip compile</code>? I couldn't figure it out:</p>
<pre><code>$ cat reqs.in                                                            
psycopg2-binary; implementation_name == 'cpython'
psycopg2; implementation_name != 'cpython'
$ uv pip compile reqs.in --python-version /tmp/pypy/.venv/bin/python
error: invalid value '/tmp/pypy/.venv/bin/python' for '--python-version &lt;PYTHON_VERSION&gt;': expected version to start with a number, but no leading ASCII digits were found

For more information, try '--help'.
$ uv pip compile reqs.in --python /tmp/pypy/.venv/bin/python        
error: unexpected argument '--python' found

  tip: a similar argument exists: '--python-version'

Usage: uv pip compile --python-version &lt;PYTHON_VERSION&gt; &lt;SRC_FILE&gt;...

For more information, try '--help'.
</code></pre>
<p>It works with <code>uv pip install</code> as expected.</p>
<pre><code>$ uv pip install --dry-run --python /tmp/cpython/.venv/bin/python -r reqs.in
Resolved 1 package in 3ms
Would download 1 package
Would install 1 package
 + psycopg2-binary==2.9.9
$ uv pip install --dry-run --python /tmp/pypy/.venv/bin/python -r reqs.in   
Resolved 1 package in 3ms
Would download 1 package
Would install 1 package
 + psycopg2==2.9.9
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:35:49 UTC
    </footer>
</body>
</html>
