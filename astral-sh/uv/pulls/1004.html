<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reduce stack usage by boxing `File` in `Dist`, `CachePolicy` and large futures - astral-sh/uv #1004</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Reduce stack usage by boxing <code>File</code> in <code>Dist</code>, <code>CachePolicy</code> and large futures</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/1004">#1004</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2024-01-19 09:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>This is <a href="https://github.com/astral-sh/puffin/pull/947">astral-sh/puffin#947</a> again but this time merging into main instead of downstack, sorry for the noise.</p>
<hr>
<p>Windows has a default stack size of 1MB, which makes puffin often fail with stack overflows. The PR reduces stack size by three changes:</p>
<ul>
<li>Boxing <code>File</code> in <code>Dist</code>, reducing the size from 496 to 240.</li>
<li>Boxing the largest futures.</li>
<li>Boxing <code>CachePolicy</code></li>
</ul>
Method
<p>Debugging happened on linux using <a href="https://github.com/astral-sh/puffin/pull/941">astral-sh/puffin#941</a> to limit the stack size to 1MB. Used ran the command below.</p>
<pre><code>RUSTFLAGS=-Zprint-type-sizes cargo +nightly build -p puffin-cli -j 1 &gt; type-sizes.txt &amp;&amp; top-type-sizes -w -s -h 10 &lt; type-sizes.txt &gt; sizes.txt
</code></pre>
<p>The main drawback is top-type-sizes not saying what the <code>__awaitee</code> is, so it requires manually looking up with a future with matching size.</p>
<p>When the <code>brotli</code> features on <code>reqwest</code> is active, a lot of brotli types show up. Toggling this feature however seems to have no effect. I assume they are false positives since the <code>brotli</code> crate has elaborate control about allocation. The sizes are therefore shown with the feature off.</p>
Results
<p>The largest future goes from 12208B to 6416B, the largest type (<code>PrioritizedDistribution</code>, see also #948) from 17448B to 9264B. Full diff: https://gist.github.com/konstin/62635c0d12110a616a1b2bfcde21304f</p>
<p>For the second commit, i iteratively boxed the largest file until the tests passed, then with an 800KB stack limit looked through the backtrace of a failing test and added some more boxing.</p>
<p>Quick benchmarking showed no difference:</p>
<pre><code>$ hyperfine --warmup 2 &quot;target/profiling/main-dev resolve meine_stadt_transparent&quot; &quot;target/profiling/puffin-dev resolve meine_stadt_transparent&quot; 
Benchmark 1: target/profiling/main-dev resolve meine_stadt_transparent
  Time (mean ± σ):      49.2 ms ±   3.0 ms    [User: 39.8 ms, System: 24.0 ms]
  Range (min … max):    46.6 ms …  63.0 ms    55 runs
 
  Warning: Statistical outliers were detected. Consider re-running this benchmark on a quiet system without any interferences from other programs. It might help to use the &#x27;--warmup&#x27; or &#x27;--prepare&#x27; options.
 
Benchmark 2: target/profiling/puffin-dev resolve meine_stadt_transparent
  Time (mean ± σ):      47.4 ms ±   3.2 ms    [User: 41.3 ms, System: 20.6 ms]
  Range (min … max):    44.6 ms …  60.5 ms    62 runs
 
  Warning: Statistical outliers were detected. Consider re-running this benchmark on a quiet system without any interferences from other programs. It might help to use the &#x27;--warmup&#x27; or &#x27;--prepare&#x27; options.
 
Summary
  target/profiling/puffin-dev resolve meine_stadt_transparent ran
    1.04 ± 0.09 times faster than target/profiling/main-dev resolve meine_stadt_transparent
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">windows</span> added by <a href="https://github.com/konstin">@konstin</a> on 2024-01-19 09:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/konstin">@konstin</a> on 2024-01-19 09:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/konstin">@konstin</a> on 2024-01-19 09:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-01-19 09:38</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:43:17 UTC
    </footer>
</body>
</html>
