<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Added support for [tool.uv.preview-features] in TOML configs (#15767) - astral-sh/uv #16452</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Added support for [tool.uv.preview-features] in TOML configs (#15767)</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/pull/16452">#16452</a>
        opened by <a href="https://github.com/j-helland">@j-helland</a>
        on 2025-10-26 07:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/j-helland">@j-helland</a> on 2025-10-26 07:41</div>
            <div class="timeline-body"><!--
Thank you for contributing to uv! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<p>Relates to (#15767)</p>
<h2>Summary</h2>
<p>Before this PR, specific preview features could only be specified via a comma-separated list in CLI <code>--preview-features</code>. Now, preview features can be specified as a list of strings in <code>pyproject.toml</code> or <code>uv.toml</code>. For example,</p>
<pre><code class="language-toml"># pyproject.toml
[tool.uv]
preview-features = [&quot;format&quot;]
</code></pre>
<p><code>--preview</code> and <code>--no-preview</code> take precedence over <code>tool.uv.preview</code>, which matches the previous semantics.
<code>--preview-features</code> will generally combine with <code>tool.uv.preview-features</code> with a couple of nuances:</p>
<ul>
<li>When <code>tool.uv.preview = false</code>, only <code>--preview-features</code> will be used. This allows the CLI to have precedence over the config.</li>
<li>When <code>tool.uv.preview = true</code>, all features will be enabled (technically, <code>--preview-features</code> are combined with all features).</li>
</ul>
<h3>Alternatives Considered</h3>
<p>From https://github.com/astral-sh/uv/issues/15767#issue-3402381105:</p>
<blockquote>
<p>setting <code>tool.uv.preview-features.pylock = false</code> would disable it, taking precedence over the feature potentially being enabled at a user level. If tool.uv.preview were changed to false, all preview features would be disabled, regardless of the content of tool.uv.preview-features.</p>
</blockquote>
<p>I chose not to take this approach because it adds complexity and the semantics don't align with <code>uv</code> today. For example, <code>--no-preview</code> will currently take priority, even if <code>pyproject.toml</code> has <code>uv.tool.preview = true</code>. I think driving <code>uv</code> from the top-down like this is generally the right decision (and changing the semantics for a small feature like this would certainly not be).</p>
<h2>Test Plan</h2>
<ul>
<li><code>cargo nextest run</code></li>
<li><code>cargo build</code></li>
<li>New snapshot tests.</li>
</ul>
<p>In addition to the above, I also tried a small test project:</p>
<h3><code>pyproject.toml</code> test</h3>
<p>From the <code>uv/</code> project root:</p>
<pre><code class="language-shell">$ mkdir tmp &amp;&amp; cd tmp
$ cargo run -- init

# Warning
$ cargo run -- format 
warning: `uv format` is experimental and may change without warning. Pass `--preview-features format` to disable this warning.
1 file left unchanged

# No warning
$ echo &quot;\n[tool.uv]\npreview-features = [\&quot;format\&quot;]&quot; &gt;&gt; pyproject.toml
$ cargo run -- format
1 file left unchanged

# `uv.toml` takes priority over `pyproject.toml`
$ echo &quot;preview-features = []&quot; &gt;&gt; uv.toml
warning: Found both a `uv.toml` file and a `[tool.uv]` section in an adjacent `pyproject.toml`. The following fields from `[tool.uv]` will be ignored in favor of the `uv.toml` file:
- preview-features
warning: `uv format` is experimental and may change without warning. Pass `--preview-features format` to disable this warning.
1 file left unchanged
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/j-helland">@j-helland</a> on 2025-10-26 08:16</div>
            <div class="timeline-body"><p>Some docker CI jobs failing, all due to</p>
<pre><code>Error: missing API token, please run `depot login`
Error: failed with: Error: missing API token, please run `depot login`
</code></pre>
<p>I've checked other recent PRs and I'm seeing similar failures (<a href="https://github.com/astral-sh/uv/actions/runs/18797165291/job/53638969254">example</a>), so I suspect this is a transient issue not related to my changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @j-helland on 2025-10-26 08:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/j-helland">@j-helland</a> on 2025-10-26 08:17</div>
            <div class="timeline-body"><p>This being my first PR in <code>uv</code>, I'm especially open to any and all feedback / changes requested (not that I wouldn't be if it was my 500th ðŸ™‚). If there's anything I can do to make the review process easier, don't hesitate to let me know!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-10-26 15:55</div>
            <div class="timeline-body"><p>Cool thanks!</p>
<p>Some quick high-level thoughts (I haven't looked at the code yet)</p>
<blockquote>
<p>Passing --preview-features via CLI does NOT combine with uv.tool.preview-features, it overrides it completely. This behavior makes sense to me, otherwise there isn't a clear way to say &quot;No, don't use your config feature X, use Y and Z instead&quot;.</p>
</blockquote>
<p>I think we should actually combine them. If we get feedback that people need to be able to disable specific features, then the canonical way to do so in uv's interface would be to add a <code>--no-preview-features &lt;names&gt;</code> flag.</p>
<p>Don't worry about those Depot authentication failures â€” we're working with them to resolve those.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/j-helland">@j-helland</a> on 2025-10-26 16:05</div>
            <div class="timeline-body"><blockquote>
<p>I think we should actually combine them. If we get feedback that people need to be able to disable specific features, then the canonical way to do so in uv's interface would be to add a --no-preview-features <names> flag.</p>
</blockquote>
<p>Got it, thanks for explaining. That should be an easy fix, Iâ€™ll get to that later today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/j-helland">@j-helland</a> on 2025-10-27 02:46</div>
            <div class="timeline-body"><p>@zanieb I want to clarify one thing before submitting my revision. Suppose we pass <code>--preview-features pylock</code> with an underlying config like</p>
<pre><code class="language-toml">preview = false
preview-features = [&quot;format&quot;]
</code></pre>
<ol>
<li>Would the final set of features be <code>format | pylock</code> or would we prefer to take only <code>pylock</code> since <code>uv.tool.preview = false</code>?</li>
<li>Similarly, if <code>tool.uv.preview = true</code>, should any <code>--preview-features</code> merge into that de facto, resulting in all features being enabled?</li>
</ol>
<p>I would intuitively expect that</p>
<ol>
<li>We just take <code>pylock</code> when <code>tool.uv.preview = false</code>, ignoring the config features.</li>
<li>Extra <code>--preview-features</code> are swallowed by <code>uv.tool.preview = true</code>.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/j-helland">@j-helland</a> on 2025-10-29 02:04</div>
            <div class="timeline-body"><p>I pushed what made intuitive sense to me:</p>
<blockquote>
<ol>
<li>We just take pylock when tool.uv.preview = false, ignoring the config features.</li>
<li>Extra --preview-features are swallowed by uv.tool.preview = true.</li>
</ol>
</blockquote>
<p>Happy to change this if requested!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/j-helland">@j-helland</a> on 2025-11-27 20:50</div>
            <div class="timeline-body"><p>Nice, no more Depot auth failures.</p>
<p>I'm curious if anyone will get a chance to look at this PR? It would be nice to have this functionality at my current job. I'm sure it's very low-priority, though, so no worries.</p>
<p>If I made any mistakes in my approach that makes this work too time-consuming to review, I'd be happy to take that feedback so I can contribute more productively to <code>uv</code> in the future ðŸ™‚</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @konstin on 2025-11-28 08:19</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:33:16 UTC
    </footer>
</body>
</html>
