<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Added support for [tool.uv.preview-features] in TOML configs (#15767) - astral-sh/uv #16452</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Added support for [tool.uv.preview-features] in TOML configs (#15767)</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/pull/16452">#16452</a>
        opened by <a href="https://github.com/j-helland">@j-helland</a>
        on 2025-10-26 07:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/j-helland">@j-helland</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to uv! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<p>Relates to (#15767)</p>
<h2>Summary</h2>
<p>Before this PR, specific preview features could only be specified via a comma-separated list in CLI <code>--preview-features</code>. Now, preview features can be specified as a list of strings in <code>pyproject.toml</code> or <code>uv.toml</code>. For example,</p>
<pre><code class="language-toml"># pyproject.toml
[tool.uv]
preview-features = [&quot;format&quot;]
</code></pre>
<p>Commandline arguments (<code>--preview</code>, <code>--no-preview</code>, and <code>--preview-features</code>) take precedence over config settings (<code>tool.uv.preview</code>, <code>tool.uv.preview-features</code>), which matches the semantics of other settings in <code>uv</code>.</p>
<h3>Alternatives Considered</h3>
<p>From https://github.com/astral-sh/uv/issues/15767#issue-3402381105:</p>
<blockquote>
<p>setting <code>tool.uv.preview-features.pylock = false</code> would disable it, taking precedence over the feature potentially being enabled at a user level. If tool.uv.preview were changed to false, all preview features would be disabled, regardless of the content of tool.uv.preview-features.</p>
</blockquote>
<p>I chose not to take this approach because it adds complexity and the semantics don't align with <code>uv</code> today. For example, <code>--no-preview</code> will currently take priority, even if <code>pyproject.toml</code> has <code>uv.tool.preview = true</code>. I think driving <code>uv</code> from the top-down like this is generally the right decision (and changing the semantics for a small feature like this would certainly not be).</p>
<h2>Test Plan</h2>
<ul>
<li><code>cargo nextest run</code></li>
<li><code>cargo build</code></li>
<li>New snapshot tests.</li>
</ul>
<p>In addition to the above, I also tried a small test project:</p>
<h3><code>pyproject.toml</code> test</h3>
<p>From the <code>uv/</code> project root:</p>
<pre><code class="language-shell">$ mkdir tmp &amp;&amp; cd tmp
$ cargo run -- init

# Warning
$ cargo run -- format 
warning: `uv format` is experimental and may change without warning. Pass `--preview-features format` to disable this warning.
1 file left unchanged

# No warning
$ echo &quot;\n[tool.uv]\npreview-features = [\&quot;format\&quot;]&quot; &gt;&gt; pyproject.toml
$ cargo run -- format
1 file left unchanged

# `uv.toml` takes priority over `pyproject.toml`
$ echo &quot;preview-features = []&quot; &gt;&gt; uv.toml
warning: Found both a `uv.toml` file and a `[tool.uv]` section in an adjacent `pyproject.toml`. The following fields from `[tool.uv]` will be ignored in favor of the `uv.toml` file:
- preview-features
warning: `uv format` is experimental and may change without warning. Pass `--preview-features format` to disable this warning.
1 file left unchanged
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/j-helland">@j-helland</a> on 2025-10-26 08:16</div>
            <div class="timeline-body"><p>Some docker CI jobs failing, all due to</p>
<pre><code>Error: missing API token, please run `depot login`
Error: failed with: Error: missing API token, please run `depot login`
</code></pre>
<p>I've checked other recent PRs and I'm seeing similar failures (<a href="https://github.com/astral-sh/uv/actions/runs/18797165291/job/53638969254">example</a>), so I suspect this is a transient issue not related to my changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @j-helland on 2025-10-26 08:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/j-helland">@j-helland</a> on 2025-10-26 08:17</div>
            <div class="timeline-body"><p>This being my first PR in <code>uv</code>, I'm especially open to any and all feedback / changes requested (not that I wouldn't be if it was my 500th ğŸ™‚). If there's anything I can do to make the review process easier, don't hesitate to let me know!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-10-26 15:55</div>
            <div class="timeline-body"><p>Cool thanks!</p>
<p>Some quick high-level thoughts (I haven't looked at the code yet)</p>
<blockquote>
<p>Passing --preview-features via CLI does NOT combine with uv.tool.preview-features, it overrides it completely. This behavior makes sense to me, otherwise there isn't a clear way to say &quot;No, don't use your config feature X, use Y and Z instead&quot;.</p>
</blockquote>
<p>I think we should actually combine them. If we get feedback that people need to be able to disable specific features, then the canonical way to do so in uv's interface would be to add a <code>--no-preview-features &lt;names&gt;</code> flag.</p>
<p>Don't worry about those Depot authentication failures â€” we're working with them to resolve those.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/j-helland">@j-helland</a> on 2025-10-26 16:05</div>
            <div class="timeline-body"><blockquote>
<p>I think we should actually combine them. If we get feedback that people need to be able to disable specific features, then the canonical way to do so in uv's interface would be to add a --no-preview-features <names> flag.</p>
</blockquote>
<p>Got it, thanks for explaining. That should be an easy fix, Iâ€™ll get to that later today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/j-helland">@j-helland</a> on 2025-10-27 02:46</div>
            <div class="timeline-body"><p>@zanieb I want to clarify one thing before submitting my revision. Suppose we pass <code>--preview-features pylock</code> with an underlying config like</p>
<pre><code class="language-toml">preview = false
preview-features = [&quot;format&quot;]
</code></pre>
<ol>
<li>Would the final set of features be <code>format | pylock</code> or would we prefer to take only <code>pylock</code> since <code>uv.tool.preview = false</code>?</li>
<li>Similarly, if <code>tool.uv.preview = true</code>, should any <code>--preview-features</code> merge into that de facto, resulting in all features being enabled?</li>
</ol>
<p>I would intuitively expect that</p>
<ol>
<li>We just take <code>pylock</code> when <code>tool.uv.preview = false</code>, ignoring the config features.</li>
<li>Extra <code>--preview-features</code> are swallowed by <code>uv.tool.preview = true</code>.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/j-helland">@j-helland</a> on 2025-10-29 02:04</div>
            <div class="timeline-body"><p>I pushed what made intuitive sense to me:</p>
<blockquote>
<ol>
<li>We just take pylock when tool.uv.preview = false, ignoring the config features.</li>
<li>Extra --preview-features are swallowed by uv.tool.preview = true.</li>
</ol>
</blockquote>
<p>Happy to change this if requested!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/j-helland">@j-helland</a> on 2025-11-27 20:50</div>
            <div class="timeline-body"><p>Nice, no more Depot auth failures.</p>
<p>I'm curious if anyone will get a chance to look at this PR? It would be nice to have this functionality at my current job. I'm sure it's very low-priority, though, so no worries.</p>
<p>If I made any mistakes in my approach that makes this work too time-consuming to review, I'd be happy to take that feedback so I can contribute more productively to <code>uv</code> in the future ğŸ™‚</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @konstin on 2025-11-28 08:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/laundmo">@laundmo</a> approved on 2025-12-18 12:44</div>
            <div class="timeline-body"><p>I'm just a random python/rust dev who was looking for something like this, but to me the code looks reasonable and seems to match how other config options are written.</p>
<p>Would be nice to get this feature, I specifically want to enable <code>python-upgrade</code> globally</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-18 14:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-preview/src/lib.rs</code>:122 on 2025-12-18 14:06</div>
            <div class="timeline-body"><p>I think this serializer is wrong per https://github.com/astral-sh/uv/pull/16452/commits/9232ece843a60fd1eb97346f4744e88c314ee1b9</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-18 14:08</div>
            <div class="timeline-body"><blockquote>
<p>Suppose we pass --preview-features pylock with an underlying config like [...]</p>
</blockquote>
<p>I think if we see a config file like</p>
<pre><code class="language-toml">preview = false
preview-features = [&quot;format&quot;]
</code></pre>
<p>we should probably just fail?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-18 14:09</div>
            <div class="timeline-body"><blockquote>
<p>Similarly, if tool.uv.preview = true, should any --preview-features merge into that de facto, resulting in all features being enabled?</p>
</blockquote>
<p>I think I'd expect us just to activate the subset of preview features specified in the CLI since the CLI takes precedence over the configuration file, though I'm not entirely sure and don't feel strongly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-18 14:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-preview/src/lib.rs</code>:181 on 2025-12-18 14:11</div>
            <div class="timeline-body"><p>Can you briefly explain why we need this new type?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-18 14:12</div>
            <div class="timeline-body"><p>Sorry for the delayed review, we've just had a lot on our backlog â€” it's not anything you did wrong.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-18 14:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-preview/src/lib.rs</code>:181 on 2025-12-18 14:24</div>
            <div class="timeline-body"><p>I presume it's for merging purposes?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-18 15:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-preview/src/lib.rs</code>:122 on 2025-12-18 15:56</div>
            <div class="timeline-body"><p>which fails with</p>
<pre><code>        FAIL [   0.700s] uv-preview tests::test_serde_roundtrip
  stdout â”€â”€â”€

    running 1 test
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” Snapshot Summary â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    Snapshot: serde_roundtrip
    Source: crates/uv-preview/src/lib.rs:372
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Expression: serialized
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    -old snapshot
    +new results
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        1       â”‚-[&quot;python-upgrade&quot;,&quot;format&quot;]
              1 â”‚+[[&quot;python-upgrade&quot;],[&quot;format&quot;]]
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Stopped on the first failure. Run `cargo insta test` to run all snapshots.
    test tests::test_serde_roundtrip ... FAILED
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/j-helland">@j-helland</a> reviewed on 2025-12-20 02:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/j-helland">@j-helland</a> on <code>crates/uv-preview/src/lib.rs</code>:181 on 2025-12-20 02:31</div>
            <div class="timeline-body"><p>Yes, I introduced it for the merging behavior. On further reflection, it could probably be consolidated into the existing <code>Preview</code>.</p>
<blockquote>
<p>I think I'd expect us just to activate the subset of preview features specified in the CLI since the CLI takes precedence over the configuration file, though I'm not entirely sure and don't feel strongly.</p>
</blockquote>
<p>Your intuition makes sense to me and I think minimizes surprise for the user. I'll update the implementation to align and get rid of <code>PreviewFeaturesMode</code>.</p>
<p>We could go a little further here and emit some kind of warning if <code>--preview-features</code> overwrites an existing config file, but I'm not sure if that's copacetic?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/j-helland">@j-helland</a> reviewed on 2025-12-20 02:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/j-helland">@j-helland</a> on <code>crates/uv-preview/src/lib.rs</code>:122 on 2025-12-20 02:35</div>
            <div class="timeline-body"><p>Great catch, thanks. I'll fix that in my next push.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/j-helland">@j-helland</a> on 2025-12-20 02:42</div>
            <div class="timeline-body"><blockquote>
<p>I think if we see a config file like</p>
<pre><code class="language-toml">preview = false
preview-features = [&quot;format&quot;]
</code></pre>
<p>we should probably just fail?</p>
</blockquote>
<p>That makes intuitive sense to me, but doesn't match the current behavior of the commandline arguments, where you can pass <code>--no-preview --preview-features upgrade-python</code> without complaint.</p>
<p>Unless I'm missing something (very possible), it seems like implementing the validation you suggest is nontrivial. The closest thing I can find is <a href="https://github.com/astral-sh/uv/blob/main/crates/uv-settings/src/lib.rs#L133">validate_uv_toml</a>, seems like we'd have to add an entirely new validation flow. Does that sound right?</p>
<p>Does it make sense to add that validation in this PR or in a separate effort to keep the scope here limited? I'm open to either option.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-20 04:24</div>
            <div class="timeline-body"><p>I think we can be more strict in the configuration file than in the CLI.</p>
<blockquote>
<p>The closest thing I can find is <a href="https://github.com/astral-sh/uv/blob/main/crates/uv-settings/src/lib.rs#L133">validate_uv_toml</a>, seems like we'd have to add an entirely new validation flow.</p>
</blockquote>
<p>Ah, hm. That's a little unfortunate. It does seem useful long-term though.</p>
<blockquote>
<p>Does it make sense to add that validation in this PR or in a separate effort to keep the scope here limited? I'm open to either option.</p>
</blockquote>
<p>I think the only trouble with doing it in a separate pull request is that we don't want to release support for including both fields then &quot;break&quot; it in a subsequent release. Would you mind sketching it in a separate pull request and we can merge them together?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/j-helland">@j-helland</a> on 2025-12-20 05:14</div>
            <div class="timeline-body"><blockquote>
<p>Would you mind sketching it in a separate pull request and we can merge them together?</p>
</blockquote>
<p>Sure thing! I'll try to get to that this weekend.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-12-20 05:33</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/uv/branches/j-helland%3Ajwh%2Ftoml-config-preview-features?utm_source=github&amp;utm_medium=comment&amp;utm_content=header">CodSpeed Performance Report</a></h2>
<h3>Merging #16452 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>j-helland:jwh/toml-config-preview-features</code> (dbe5958) with <code>main</code> (7865672)</sub></p>
<h3>Summary</h3>
<p><code>âœ… 5</code> untouched</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/j-helland">@j-helland</a> on 2025-12-21 02:08</div>
            <div class="timeline-body"><p>@zanieb I sketched what you suggested in https://github.com/astral-sh/uv/pull/17202 let me know what you think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/j-helland">@j-helland</a> reviewed on 2025-12-23 19:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/j-helland">@j-helland</a> on <code>crates/uv-preview/src/lib.rs</code>:181 on 2025-12-23 19:33</div>
            <div class="timeline-body"><p>Marking this as resolved since I removed <code>PreviewFeaturesMode</code> while simplifying how CLI args and config settings interact.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:45:07 UTC
    </footer>
</body>
</html>
