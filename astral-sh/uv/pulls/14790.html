<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copy entry points and Jupyter data directories into ephemeral environments - astral-sh/uv #14790</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Copy entry points and Jupyter data directories into ephemeral environments</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/14790">#14790</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2025-07-21 14:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>This is an alternative to https://github.com/astral-sh/uv/pull/14788 which has the benefit that it addresses https://github.com/astral-sh/uv/issues/13327 which would be an issue even if we reverted #14447.</p>
<p>There are two changes here</p>
<ol>
<li>We copy entry points into the ephemeral environment, and rewrite their shebangs (or trampoline target) to ensure the ephemeral environment is not bypassed.</li>
<li>We link <code>etc/jupyter</code> and <code>share/jupyter</code> data directories into the ephemeral environment, this is in order to ensure the above doesn't break Jupyter which unfortunately cannot find the <code>share</code> directory otherwise. I'd love not to do this, as it seems brittle and we don't have a motivating use-case beyond Jupyter. I've opened https://github.com/jupyterlab/jupyterlab/issues/17716 upstream for discussion, as there is a viable patch that could be made upstream to resolve the problem. I've limited the fix to Jupyter directories so we can remove it without breakage.</li>
</ol>
<p>Closes https://github.com/astral-sh/uv/issues/14729
Closes https://github.com/astral-sh/uv/issues/13327
Closes https://github.com/astral-sh/uv/issues/14749</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zanieb on 2025-07-21 19:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-21 19:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-trampoline-builder/src/lib.rs</code>:44 on 2025-07-21 19:04</div>
            <div class="timeline-body"><p>In order to allow rewriting the launcher, we need to stash the payload. I think this is generally pretty small. If we are worried about the overhead, we could store the path to the original launcher and load it again when needed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-21 19:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:1100 on 2025-07-21 19:44</div>
            <div class="timeline-body"><p>Since this is just for Jupyter right now, we could narrow this to just apply to the <code>share/jupyter</code> directory if we wanted ðŸ¤”</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-07-21 22:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:1755 on 2025-07-21 22:03</div>
            <div class="timeline-body"><p>I think we also need to check for absolute shebangs, because we use these in the <code>--with</code> environment, but we use standard absolute shebangs in the base environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-21 22:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:1755 on 2025-07-21 22:42</div>
            <div class="timeline-body"><p>We do, that's what https://github.com/astral-sh/uv/blob/d477e368c9c6c7d0c59c1362c11be14846ce7ff1/crates/uv/src/commands/project/run.rs#L1760 does (and there's test coverage for both)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Copy entry points and common data directories into ephemeral environments" to "Copy entry points and Jupyter data directories into ephemeral environments" by @zanieb on 2025-07-21 22:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-21 22:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:1100 on 2025-07-21 22:55</div>
            <div class="timeline-body"><p>I narrowed this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-21 22:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:1755 on 2025-07-21 22:57</div>
            <div class="timeline-body"><p>I updated it to be clearer</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-07-21 23:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:1781 on 2025-07-21 23:14</div>
            <div class="timeline-body"><p>Is this included by mistake? There's another call just below.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:1785 on 2025-07-21 23:15</div>
            <div class="timeline-body"><p>I think this overwrites if the file already exists?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-07-21 23:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-07-21 23:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:1168 on 2025-07-21 23:15</div>
            <div class="timeline-body"><p>Is this intended to be merged? It seems like it's showing the path to the scripts, not the env.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:1103 on 2025-07-21 23:16</div>
            <div class="timeline-body"><p>Why a shallow merge, rather than linking the entire <code>etc/jupyter</code> or <code>share/jupyter</code> dir?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-07-21 23:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-21 23:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:1781 on 2025-07-21 23:23</div>
            <div class="timeline-body"><p>Uh yeah sorry totally missed that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-21 23:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:1785 on 2025-07-21 23:23</div>
            <div class="timeline-body"><p>True. I guess we can't do something atomic here? We need to just check existence?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-21 23:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:1168 on 2025-07-21 23:24</div>
            <div class="timeline-body"><p>Sorry this was from your commit and I didn't read it closely when changing it to a debug log, I guess I'll update it to print the root path?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-21 23:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:1103 on 2025-07-21 23:25</div>
            <div class="timeline-body"><p>That's a good question. I think we can remove the shallow merge now that I'm not doing <code>etc</code> and <code>share</code> â€” previously the shallow merge seemed pretty important.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-07-21 23:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:1168 on 2025-07-21 23:30</div>
            <div class="timeline-body"><p>Oh haha. I'd just remove it, I assume this is logged elsewhere.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-07-21 23:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:1785 on 2025-07-21 23:30</div>
            <div class="timeline-body"><p>I think you can do it with <code>fs_err::OpenOptions::new()</code>. There's an option to error if it already exists when you open the file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-21 23:34</div>
            <div class="timeline-body"><p>Thanks for the review, addressed in https://github.com/astral-sh/uv/pull/14790/commits/7883b0bb2ecf14c9efa5c8c725a7da62ce73796b</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-21 23:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:1785 on 2025-07-21 23:40</div>
            <div class="timeline-body"><p>Ah that's nice, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2025-07-22 00:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-07-22 01:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-fs/src/lib.rs</code>:167 on 2025-07-22 01:47</div>
            <div class="timeline-body"><p>I know this used to exist in some form, can you just double-check the Git history to make sure this matches anything we learned from our prior implementation?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-07-22 01:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-trampoline-builder/src/lib.rs</code>:44 on 2025-07-22 01:48</div>
            <div class="timeline-body"><p>If you want to get fancy you could probably store <code>Box&lt;[u8]&gt;</code> here. Seems totally not necessary though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-22 01:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-fs/src/lib.rs</code>:167 on 2025-07-22 01:49</div>
            <div class="timeline-body"><p>Yeah sorry this is a verbatim copy of <code>replace_symlink</code> without deletion of a junction. I'll add a comment saying so.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-22 01:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-fs/src/lib.rs</code>:167 on 2025-07-22 01:51</div>
            <div class="timeline-body"><p>Or are you asking something else?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-07-22 01:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:1771 on 2025-07-22 01:52</div>
            <div class="timeline-body"><p>This is really minor, but I think the relative shebang includes a trailing newline whereas this one does not. That might just mean that we're adding an extra newline in the absolute case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-07-22 01:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:1789 on 2025-07-22 01:56</div>
            <div class="timeline-body"><p>I can't remember why we have this in the wheel installer, I need to look:</p>
<pre><code class="language-rust">let permissions = fs::metadata(&amp;script_absolute)?.permissions();
if permissions.mode() &amp; 0o111 != 0o111 {
    fs::set_permissions(
        script_absolute,
        Permissions::from_mode(permissions.mode() | 0o111),
    )?;
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-22 01:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:1789 on 2025-07-22 01:58</div>
            <div class="timeline-body"><p>Oo spicy. That's interesting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:1771 on 2025-07-22 01:58</div>
            <div class="timeline-body"><p>I can just snapshot them and make sure they're consistent.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-22 01:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-07-22 01:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:1789 on 2025-07-22 01:59</div>
            <div class="timeline-body"><p>Oh, nevermind, I guess it's just because we might be able to skip setting permissions. Why <code>perms.set_mode(0o755);</code> though?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-07-22 02:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:1789 on 2025-07-22 02:00</div>
            <div class="timeline-body"><p>I think you maybe want to drop this. Doesn't this override the permissions entirely?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-07-22 02:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-fs/src/lib.rs</code>:167 on 2025-07-22 02:15</div>
            <div class="timeline-body"><p>Na that's fine, thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-22 02:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:1789 on 2025-07-22 02:16</div>
            <div class="timeline-body"><p>I copied this from your commit. It makes sense though, we're creating a new file, don't we need to make it executable?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-07-22 02:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:1789 on 2025-07-22 02:24</div>
            <div class="timeline-body"><p>I think you want to copy the permissions from the existing file though, like:</p>
<pre><code class="language-rust">let mode = fs_err::metadata(source)?.permissions().mode();
let mut file = fs_err::OpenOptions::new()
    .create_new(true)
    .write(true)
    .mode(mode)
    .open(target)?;
</code></pre>
<p>(That code from my branch was just a hack.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-22 03:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:1789 on 2025-07-22 03:09</div>
            <div class="timeline-body"><p>That seems quite reasonable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-22 03:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:1789 on 2025-07-22 03:10</div>
            <div class="timeline-body"><p>74ad1b5d9</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2025-07-22 11:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2025-07-22 12:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-07-22 12:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-22 12:11</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:44:06 UTC
    </footer>
</body>
</html>
