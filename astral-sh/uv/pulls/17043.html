<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explicitly set EntryType for file entries in tar - astral-sh/uv #17043</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Explicitly set EntryType for file entries in tar</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/17043">#17043</a>
        opened by <a href="https://github.com/e-nomem">@e-nomem</a>
        on 2025-12-09 08:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/e-nomem">@e-nomem</a> on 2025-12-09 08:17</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR explicitly sets the entry type for files in an sdist. This changes the entry type from <code>AREGTYPE</code> (the 'legacy' regular file type) to <code>REGTYPE</code> (the 'normal' regular file type) in the generated tar.</p>
<p>This change works around a bug in the python <code>tarfile</code> module that causes all entries after a certain point in the tar to be silently ignored if any entry matches some very specific conditions. In <code>maturin</code> this was very visible since the <code>PKG-INFO</code> was written at the very end so <code>twine check</code> would loudly complain that the <code>PKG-INFO</code> was missing and that the sdist was invalid. In <code>uv</code> the <code>PKG-INFO</code> is written at the beginning so this issue is unlikely to be caught.</p>
<p>Note that this change does mean that sdists created with newer versions of the uv build backend will not be byte-for-byte identical with sdists from an older version.</p>
<p>See https://github.com/PyO3/maturin/issues/2855#issuecomment-3546501132</p>
<h2>Test Plan</h2>
<p>This is the same as the change that was made in maturin to work around the same issue</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/woodruffw">@woodruffw</a> on 2025-12-09 16:48</div>
            <div class="timeline-body"><blockquote>
<p>This change works around a bug in the python <code>tarfile</code> module that causes all entries after a certain point in the tar to be silently ignored if any entry matches some very specific conditions.</p>
</blockquote>
<p>Out of curiosity, did you file a bug with CPython for this? I suspect it's the kind of thing they'd be interested in fixing in a patch release for each non-EOL version.</p>
<p>Edit: my bad, I see you filed it as https://github.com/python/cpython/issues/141707! Linking here so these get cross-referenced ðŸ™‚</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @zanieb on 2025-12-09 17:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/e-nomem">@e-nomem</a> on 2025-12-09 19:07</div>
            <div class="timeline-body"><p>There's also a related issue in <code>tar-rs</code> to initialize headers by default to <code>REGTYPE</code> instead of <code>AREGTYPE</code> because I suspect that most users are just not explicitly setting this flag rather than wanting to actually use the legacy type. It's not likely to get merged anytime soon though because it's a breaking change. https://github.com/alexcrichton/tar-rs/issues/422</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-12-10 10:24</div>
            <div class="timeline-body"><p>Do you have a reproducible example (ideally a standalone rust script) and a Python script that both use and CPython can use to check the problem and its fix?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/e-nomem">@e-nomem</a> on 2025-12-10 12:23</div>
            <div class="timeline-body"><p>Here's a rust script that will create two tar files in the local directory:</p>
<pre><code class="language-rust">#!/usr/bin/env -S cargo +nightly -Zscript
---cargo
[dependencies]
tar = &quot;0.4.44&quot;
---
use std::fs::File;
use std::io::Error as IoError;
use std::path::Path;

use tar::Builder;
use tar::EntryType;
use tar::Header;

fn create_tar(filename: impl AsRef&lt;Path&gt;, entry_type: Option&lt;EntryType&gt;) -&gt; Result&lt;(), IoError&gt; {
	let file = File::options().write(true).create(true).truncate(true).open(filename)?;
	let mut tarfile = Builder::new(file);

	let entries = [
		&quot;file1&quot;.into(),
		format!(&quot;{}/bbb&quot;, &quot;a&quot;.repeat(99)),
		&quot;file2&quot;.into(),
	];

	for entry in entries {
		let mut header = Header::new_gnu();
		header.set_mode(0o644);
		header.set_size(entry.len() as u64);
		if let Some(entry_type) = entry_type {
			header.set_entry_type(entry_type);
		}
		tarfile.append_data(&amp;mut header, &amp;entry, entry.as_bytes())?;
	}

	tarfile.finish()?;
	Ok(())
}

fn main() -&gt; Result&lt;(), IoError&gt; {
	create_tar(&quot;good.tar&quot;, Some(EntryType::Regular))?;
	create_tar(&quot;bad.tar&quot;, None)?;
	Ok(())
}
</code></pre>
<p>And here's a python script to test the two tar files:</p>
<pre><code class="language-python">#!/usr/bin/env -S uv run --script
# /// script
# requires-python = &quot;&gt;=3.9&quot;
# dependencies = [
#   &quot;pytest&quot;,
# ]
# ///
import tarfile
from io import BytesIO

import pytest


def get_members(filename):
	with tarfile.open(filename, 'r') as tar:
		return tar.getmembers()


def test_good_tar():
	assert len(get_members(&quot;good.tar&quot;)) == 3


@pytest.mark.xfail(strict=True)
def test_bad_tar():
	assert len(get_members(&quot;bad.tar&quot;)) == 3


@pytest.mark.parametrize('format', (
	pytest.param(tarfile.GNU_FORMAT, id=&quot;gnu&quot;),
	pytest.param(tarfile.PAX_FORMAT, id=&quot;pax&quot;),
))
@pytest.mark.xfail(strict=True)
def test_python_only(format):
	fp = BytesIO()
	with tarfile.open(mode='w', fileobj=fp, format=format) as tar:
		info = tarfile.TarInfo()
		info.type = tarfile.AREGTYPE
		info.name = (&quot;a&quot; * 99) + &quot;/bbb&quot;
		tar.addfile(info)

		expected = {t.name: t.type for t in tar.getmembers()}
	
	fp.seek(0)
	with tarfile.open(mode='r', fileobj=fp) as tar:
		actual = {t.name: t.type for t in tar.getmembers()}
	
	assert expected == actual


if __name__ == &quot;__main__&quot;:
	pytest.main([__file__])
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @konstin on 2025-12-11 10:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../../python/cpython/issues/141707.html">python/cpython#141707</a> on 2025-12-11 10:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2025-12-11 10:24</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-12-11 10:24</div>
            <div class="timeline-body"><p>I've added a comment explaining why we need to set that type.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2025-12-11 10:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-12-11 10:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:33:16 UTC
    </footer>
</body>
</html>
