<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retain authentication attached to URLs when making requests to the same host - astral-sh/uv #1874</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Retain authentication attached to URLs when making requests to the same host</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/1874">#1874</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-02-22 15:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/zanieb">@zanieb</a> on 2024-02-22 15:37</div>
            <div class="timeline-body"><p>Closes https://github.com/astral-sh/uv/issues/1860</p>
<p>In https://github.com/astral-sh/uv/pull/1816, we started using the URL attached to a response instead of the request URL for subsequent requests — this fixes various bugs but has the side-effect of dropping credentials from the URL. Here, we transfer credentials from the request URL to the response URL. We perform RFC compliant checks for safety.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-02-22 15:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @zanieb on 2024-02-22 15:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-02-22 15:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/uv-client/src/registry_client.rs</code>:254 on 2024-02-22 15:41</div>
            <div class="timeline-body"><p>We should check the protocol too, to avoid potential downgrades.</p>
<p>This seems uhm, dangerous</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-22 17:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/registry_client.rs</code>:254 on 2024-02-22 17:22</div>
            <div class="timeline-body"><p>Should be resolved by https://github.com/astral-sh/uv/pull/1874/commits/c57ef0b4fe3744965c7222a290bb49b775e11a60</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/uv-client/src/registry_client.rs</code>:530 on 2024-02-22 17:24</div>
            <div class="timeline-body"><p>Can we emit the error as part of the warning message log it with <code>debug</code> to ease debugging when copying fails for some reason?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/uv-client/src/registry_client.rs</code>:545 on 2024-02-22 17:24</div>
            <div class="timeline-body"><p>Thanks for linking to the relevant sections</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-22 17:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/registry_client.rs</code>:575 on 2024-02-22 17:24</div>
            <div class="timeline-body"><p>I found this confusing when written in the negative</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-22 17:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/registry_client.rs</code>:575 on 2024-02-22 17:25</div>
            <div class="timeline-body"><p>I guess I could wrap the whole thing with a <code>!</code> but for some reason this <em>feels</em> safer to me :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/uv-client/src/registry_client.rs</code>:571 on 2024-02-22 17:26</div>
            <div class="timeline-body"><p>I find the <code>check the port</code> comment not that useful. I can see that we check something with the port but I'm having difficulty understanding what's being checked. Maybe we can explain that instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/uv-client/src/registry_client.rs</code>:571 on 2024-02-22 17:28</div>
            <div class="timeline-body"><p>Not sure if that's the same</p>
<pre><code class="language-suggestion">            if !request_url.port().is_some_and(|port| port != default_port)
                &amp;&amp; !response_url.port().is_some_and(|port| != default_port) 
</code></pre>
<p>or you change the condition and do an early return instead</p>
<pre><code class="language-suggestion">            if request_url.port().is_some_and(|port| != default_port)
                || response_url.port().is_some_and(|port| != default_port) {
                return false
          } 
</code></pre>
<p>What case does this cover: Is it mainly to cover the case where the <code>request</code> has the port <code>None</code> but the response comes with e.g. port <code>80</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-02-22 17:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-02-22 17:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-22 17:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/registry_client.rs</code>:530 on 2024-02-22 17:32</div>
            <div class="timeline-body"><p>The error is empty, just <code>()</code> — annoying but yep.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-02-22 17:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/uv-client/src/registry_client.rs</code>:530 on 2024-02-22 17:34</div>
            <div class="timeline-body"><p>Oh, that's unfortunate</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/registry_client.rs</code>:571 on 2024-02-22 17:34</div>
            <div class="timeline-body"><p>This is slightly different... I can try to make it better again. But yeah if you look at the test cases and the specification we are only supposed to check the port if it differs from the default port.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-22 17:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-22 17:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/registry_client.rs</code>:571 on 2024-02-22 17:35</div>
            <div class="timeline-body"><p>This comment just matches all the previous ones saying which part we're checking, the inner comment is supposed to explain this. I can try to do better though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-22 17:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/registry_client.rs</code>:571 on 2024-02-22 17:43</div>
            <div class="timeline-body"><p>Okay https://github.com/astral-sh/uv/pull/1874/commits/477e18b88d9f825204dbcdb9f3a98a8f4803b159 should be a lot better</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-02-22 17:53</div>
            <div class="timeline-body"><p>Fyi I tested this against AWS CodeArtifact.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2024-02-22 17:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-02-22 17:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-02-22 17:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 14:55:03 UTC
    </footer>
</body>
</html>
