<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use exponential backoff for publish retries - astral-sh/uv #9276</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use exponential backoff for publish retries</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/9276">#9276</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-11-20 14:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>Just trying to unify the retry handling, as in <a href="https://github.com/astral-sh/uv/pull/9274">astral-sh/uv#9274</a> and elsewhere. Right now, the publish handler doesn&#x27;t use any backoff and always retries three times regardless of settings.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-20 14:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-20 14:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-11-20 14:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-publish/src/lib.rs</code>:389 on 2024-11-20 14:19</div>
            <div class="timeline-body"><p>This now uses <code>is_extended_transient_error</code> instead of <code>UvRetryableStrategy.handle(&amp;result) == Some(Retryable::Transient)</code>. Wouldn&#x27;t the latter already be called in the middle itself...?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-publish/src/lib.rs</code>:410 on 2024-11-20 14:21</div>
            <div class="timeline-body"><p>I think these should go on <code>upload_with_retry</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-11-20 14:21</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-11-20 14:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-publish/src/lib.rs</code>:389 on 2024-11-20 14:22</div>
            <div class="timeline-body"><p>@konstin -- just confirming, do you agree that this is ok?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-11-20 14:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-publish/src/lib.rs</code>:389 on 2024-11-20 14:23</div>
            <div class="timeline-body"><p>It will miss the &quot;default&quot; cases handled by the retry strategy, like other transient request errors.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-11-20 14:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-publish/src/lib.rs</code>:389 on 2024-11-20 14:31</div>
            <div class="timeline-body"><p>I think that&#x27;s okay... presuming that the default strategy doesn&#x27;t cover anything that would occur at response read time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-11-20 14:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-publish/src/lib.rs</code>:389 on 2024-11-20 14:43</div>
            <div class="timeline-body"><p>Thanks for the ping, i didn&#x27;t realize we were missing that layer now. I don&#x27;t have any reference upload intermittent errors, but I think we should preserve the <code>UvRetryableStrategy</code>, i can see things like timeouts and cancelled responses happening here too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-11-20 14:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-publish/src/lib.rs</code>:389 on 2024-11-20 14:45</div>
            <div class="timeline-body"><p>I&#x27;m a little way due to this comment: &quot;Implements a custom retry flow since the request isn&#x27;t cloneable&quot;. Does that mean the default middleware doesn&#x27;t work here or something?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-publish/src/lib.rs</code>:389 on 2024-11-20 14:46</div>
            <div class="timeline-body"><p>Ok.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-11-20 14:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-11-20 14:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-publish/src/lib.rs</code>:389 on 2024-11-20 14:53</div>
            <div class="timeline-body"><p>So that we&#x27;re on the same page: The retry middleware clones the request, and then resends it if it failed (https://github.com/TrueLayer/reqwest-middleware/blob/8a494c165734e24c62823714843e1c9347027e8a/reqwest-retry/src/middleware.rs#L150-L155). But a POST request with formdata and a streaming file isn&#x27;t cloneable (limitation of reqwest, <a href="https://github.com/seanmonstar/reqwest/issues/2416">seanmonstar/reqwest#2416</a>). That&#x27;s why the upload client is building a custom base client with <code>.retries(0)</code> that never internally tries to clone the request and instead has a loop that always rebuilds the request.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-11-20 14:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-publish/src/lib.rs</code>:389 on 2024-11-20 14:53</div>
            <div class="timeline-body"><p>Given that, it ended up being much simpler to leave it all in a single method.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-11-20 14:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-publish/src/lib.rs</code>:389 on 2024-11-20 14:58</div>
            <div class="timeline-body"><p>Ohh ok, I missed the <code>.retries(0)</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-20 15:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-20 15:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-20 15:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:49:28 UTC
    </footer>
</body>
</html>
