<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use windows registry to discover python - astral-sh/uv #6761</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use windows registry to discover python</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/6761">#6761</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2024-08-28 15:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>Our current strategy of parsing the output of <code>py --list-paths</code> to get the installed python versions on windows is brittle (#6524, missing <code>py</code>, etc.) and it&#x27;s slow (10ms last time i measured).</p>
<p>Instead, we should behave spec-compliant and read the python versions from the registry following PEP 514.</p>
<p>It&#x27;s not fully clear which errors we should ignore and which ones we need to raise.</p>
<p>We&#x27;re using the official rust-for-windows crates for accessing the registry.</p>
<p>Fixes #1521
Fixes #6524</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/konstin">@konstin</a> on 2024-08-28 15:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by <a href="https://github.com/konstin">@konstin</a> on 2024-08-28 15:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">windows</span> added by <a href="https://github.com/konstin">@konstin</a> on 2024-08-28 15:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-08-28 15:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:314 on 2024-08-28 15:54</div>
            <div class="timeline-body"><p>Comment needs to be updated.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-08-28 15:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/py_launcher.rs</code>:54 on 2024-08-28 15:55</div>
            <div class="timeline-body"><p>What&#x27;s a missing version? A registered Python without a version?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-08-28 15:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/py_launcher.rs</code>:78 on 2024-08-28 15:57</div>
            <div class="timeline-body"><p>Should we say like &quot;Python interpreter in the registry is not executable&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-08-28 15:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/py_launcher.rs</code>:84 on 2024-08-28 15:59</div>
            <div class="timeline-body"><p>We do have a print for this in the discovery code</p>
<p>https://github.com/astral-sh/uv/blob/7502a963e15ae40422f8386b64f8b6c72af22d82/crates/uv-python/src/discovery.rs#L534-L538</p>
<p>Is this different? Do we need it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-08-28 16:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/py_launcher.rs</code>:102 on 2024-08-28 16:01</div>
            <div class="timeline-body"><p>Similar to above, I&#x27;d say like &quot;Skipping Python interpreter ({}) with invalid registry version {s}: {err}&quot;</p>
<p>We have a message like this elsewhere:</p>
<p>https://github.com/astral-sh/uv/blob/7502a963e15ae40422f8386b64f8b6c72af22d82/crates/uv-python/src/discovery.rs#L621</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-28 16:03</div>
            <div class="timeline-body"><p>Awesome!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-08-28 16:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-python/src/py_launcher.rs</code>:54 on 2024-08-28 16:06</div>
            <div class="timeline-body"><p>A <code>None</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-08-28 16:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/py_launcher.rs</code>:54 on 2024-08-28 16:11</div>
            <div class="timeline-body"><p>Makes sense, can you make that clear in the comment though? I didn&#x27;t learn what we did with missing versions until further down.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zooba">@zooba</a> on <code>crates/uv-python/src/py_launcher.rs</code>:35 on 2024-08-28 18:18</div>
            <div class="timeline-body"><p>I think you mean <code>&quot;PyLauncher&quot;</code> here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zooba">@zooba</a> reviewed on 2024-08-28 18:23</div>
            <div class="timeline-body"><p>As PEP 514 author, I&#x27;m happy to see this!</p>
<p>Do note that Store installs don&#x27;t always show up properly in the registry due to how Windows handles its redirection (and it changes over time as Python chooses different redirection settings). For the <code>py.exe</code> launcher, we also do a <a href="https://github.com/python/cpython/blob/61bef6245c4a32bf430d684ede8603f423d63284/PC/launcher2.c#L1744">specific search</a> for <a href="https://github.com/python/cpython/blob/61bef6245c4a32bf430d684ede8603f423d63284/PC/launcher2.c#L1963">known package IDs</a> to locate Store installs. Not sure whether you want to copy that or not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-28 18:24</div>
            <div class="timeline-body"><p>Thank you for taking a look @zooba!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-08-29 12:32</div>
            <div class="timeline-body"><p>Thank you @zooba, I&#x27;ve added #6807 to also discover Microsoft Store Pythons.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-08-29 16:29</div>
            <div class="timeline-body"><p>Can you double check the documentation is updated? e.g., https://github.com/astral-sh/uv/blob/ae57d85dfb78ca53478bb503b937906dbf151ac3/docs/concepts/python-versions.md#L172</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-08-29 18:20</div>
            <div class="timeline-body"><p>Thanks for the reminder!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-08-29 18:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>docs/concepts/python-versions.md</code>:267 on 2024-08-29 18:29</div>
            <div class="timeline-body"><p>Looks wrong</p>
<pre><code>[`python-build-standalone` quirks](https://gregoryszorc.com/docs/python-build-standalone/main/quirks.html)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-08-29 18:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>docs/concepts/python-versions.md</code>:267 on 2024-08-29 18:34</div>
            <div class="timeline-body"><p>I ran prettier now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-08-29 20:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/konstin">@konstin</a> on 2024-08-29 20:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/konstin">@konstin</a> on 2024-08-29 20:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-08-29 20:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:47:53 UTC
    </footer>
</body>
</html>
