<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handle sigterm calls, fixes #6724 - astral-sh/uv #8933</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Handle sigterm calls, fixes #6724</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/8933">#8933</a>
        opened by <a href="https://github.com/shaneikennedy">@shaneikennedy</a>
        on 2024-11-08 11:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/shaneikennedy">@shaneikennedy</a> on 2024-11-08 11:45</div>
            <div class="timeline-body"><!--
Thank you for contributing to uv! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>This PR builds off of https://github.com/astral-sh/uv/pull/6738 to fix #6724 (sorry for the new PR @charliermarsh I didn't want to push to your branch, not even sure if I could). The reason the original PR doesn't fix the issue described in #6724 is because the fastapi is ran in the project context (as I assume a lot of use cases are). This PR adds an extra commit to handle the signals in the project/run.rs file</p>
<p>~It also addresses the comment <a href="https://github.com/astral-sh/uv/pull/6738/files#r1734757548">here</a> to not use the tokio ctrl-c method since we are now handling SIGINT ourselves~ update, tokio handles SIGINT in a platform agnostic way, intercepting this ouselves makes the logic more complicated with windows, decided to leave the tokio ctrl-c handler</p>
<p>~<a href="https://github.com/astral-sh/uv/pull/6738/files#r1743510140">This comment</a> remains unaddressed, however, the Child process does not have any other methods besides kill() so I don't see how we can &quot;preserve&quot; the interrupt call :/  I tried looking around but no luck.~ updated, this PR is reduced to only handling SIGTERM propagation on unix machines, and the sigterm call to the child is preserved by making use of the nix package, instead of relying on tokio which only allowed for <code>kill()</code> on a child process</p>
<h2>Test Plan</h2>
<p>I tested this by building the docker container locally with these changes and tagging it &quot;myuv&quot;, and then using that as the base image in uv-docker-example, (and ofc following the rest of the repro issues in #6724. In my tests I see that ctrl-c in the docker-compose up command exits the process almost immediately üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/shaneikennedy">@shaneikennedy</a> on 2024-11-08 11:49</div>
            <div class="timeline-body"><p>Also yeah, windows does not have SIGTERM, need some guidance here as I've never built for windows üò¨</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bluss">@bluss</a> on 2024-11-08 12:06</div>
            <div class="timeline-body"><p>Here's one issue, provided as a test case.</p>
<p>Run a regular python (no uv involved) and press ctrl-C twice (just to show that the prompt sticks around):</p>
<pre><code>python
Python 3.10.12 (main, Sep 11 2024, 15:47:36) [GCC 11.4.0] on linux
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; 
KeyboardInterrupt
&gt;&gt;&gt; 
KeyboardInterrupt
&gt;&gt;&gt;
</code></pre>
<p>With <code>uv 0.4.30</code> same effect (good):</p>
<pre><code>uv run -p 3.10 python
Python 3.10.14 (main, Jul 25 2024, 22:44:48) [Clang 18.1.8 ] on linux
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; 
KeyboardInterrupt
&gt;&gt;&gt; 
KeyboardInterrupt
&gt;&gt;&gt;
</code></pre>
<p>With this PR, in current state (uv run is killed by Ctrl-C, which is a change):</p>
<pre><code>./target/debug/uv run -p 3.10 python
Python 3.10.14 (main, Jul 25 2024, 22:44:48) [Clang 18.1.8 ] on linux
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt;
(Process exited with error) 
</code></pre>
<p>(Edit: Direct run of the binary, not cargo run, to avoid cargo being involved in the test case. Didn't change the result.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/shaneikennedy">@shaneikennedy</a> on 2024-11-08 12:17</div>
            <div class="timeline-body"><p>@bluss good catch, I think as @cr-klarna points out in the original PR a simple fix isn't likely since .kill() is not what we want here, we want to propagate the signals down and this solution which built off of @charliermarsh 's original basically overrides the signal</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/bluss">@bluss</a> on <code>crates/uv/src/commands/project/run.rs</code>:1016 on 2024-11-08 12:30</div>
            <div class="timeline-body"><p><code>uv run</code> should preferably preserve the exit code from the child, not assume this was an error exit. (I'm sorry for more comments if they are superfluous, but it's better to get the issues out in the sun.)</p>
<p>Example application for this use case: mkdocs serve exits gracefully/with success after Ctrl-C.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bluss">@bluss</a> reviewed on 2024-11-08 12:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/shaneikennedy">@shaneikennedy</a> on 2024-11-08 13:46</div>
            <div class="timeline-body"><p>@bluss WIP here but using cfg macros to react to sigterm based on platform, and also dropping handling of SIGINT and leaving that to tokio since that seems to be working fine</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/shaneikennedy">@shaneikennedy</a> on 2024-11-08 13:50</div>
            <div class="timeline-body"><p>Going to be honest I don't know windows, I might ask to punt the windows sigterm implementation so that people on unix systems can get unblocked here and let someone who actually knows windows to help out üòÇ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cr-klarna">@cr-klarna</a> on 2024-11-08 15:20</div>
            <div class="timeline-body"><p>Tested with a simple case of registering handlers and passing signals with <code>kill</code>. Confirmed that for SIGTERM the behavior seems expected and I tested with @shaneikennedy some cases we had. One thing stands out still that it seems that tokio really wants to have an interactive context before passing the SIGINT signals. This is a problem but I am not convinced it is uv's to solve, this seems more due to a bug/design decision in tokio.</p>
<p>@bluss I also tested the mkdocs serve and it exited gracefully after ^C was sent from the interactive context as indicated by the chance to print out the graceful shutdown message. Obvs good to check yourself ofc</p>
<pre><code class="language-INFO">INFO    -  Cleaning site directory
INFO    -  Documentation built in 1.97 seconds
INFO    -  [16:18:35] Watching paths for changes: 'docs', 'mkdocs.public.yml'
INFO    -  [16:18:35] Serving on http://127.0.0.1:8000/uv/
^CINFO    -  Shutting down...```
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/overfl0">@overfl0</a> on 2024-11-08 15:28</div>
            <div class="timeline-body"><blockquote>
<p>@bluss I also tested the mkdocs serve and it exited gracefully after ^C was sent from the interactive context as indicated by the chance to print out the graceful shutdown message. Obvs good to check yourself ofc</p>
</blockquote>
<p>@cr-klarna My understanding is that <code>echo $?</code> is supposed to return <code>0</code> for mkdocs, when pressing Ctrl+C, which will not happen when run through uv, as it returns with <code>ExitStatus::Failure</code> hardcoded.
(although I have NOT tested that - I'm just basing my opinion on what has been written above)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cr-klarna">@cr-klarna</a> on 2024-11-08 15:30</div>
            <div class="timeline-body"><p>@overfl0 no I get status 0 and this is because that error returned is not propagated through the parent (yet) it seems. This seems to be one of the other broad design decisions that was hinted at in the other PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-11-09 13:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-11-09 13:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:1021 on 2024-11-09 17:14</div>
            <div class="timeline-body"><p>Is it &quot;fine&quot; / necessary for us to be calling <code>.wait()</code> twice?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-11-09 17:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-11-09 17:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/shaneikennedy">@shaneikennedy</a> reviewed on 2024-11-09 17:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/shaneikennedy">@shaneikennedy</a> on <code>crates/uv/src/commands/project/run.rs</code>:1021 on 2024-11-09 17:23</div>
            <div class="timeline-body"><p>Not a rust expert would appreciate your guidance here, from what I see inside of <code>wait()</code> it's not expensive to call it twice and it makes the logic in the select! block easier to read. If I do something like let status = select! {...} each brand needs to return the same type, but <code>terminate_process</code> doesn't actually return anything, so I'd need to fake a return which also seems unnecessary. wdyt?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-11-09 17:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:1021 on 2024-11-09 17:24</div>
            <div class="timeline-body"><p>It looks like it <em>is</em> guaranteed to return the same result both times.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @zanieb on 2024-11-09 17:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-09 17:27</div>
            <div class="timeline-body"><p>I made some minor changes. @shaneikennedy -- do you want to re-test before I merge?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-11-09 17:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:1021 on 2024-11-09 17:28</div>
            <div class="timeline-body"><p>I went with returning the result directly on unix and only calling <code>let status = handle.wait().await?;</code> on other platforms, since it didn't seem too difficult and makes the control flow a bit clearer IMO.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/shaneikennedy">@shaneikennedy</a> on 2024-11-09 17:36</div>
            <div class="timeline-body"><blockquote>
<p>I made some minor changes. @shaneikennedy -- do you want to re-test before I merge?</p>
</blockquote>
<p>Since testing this initially I have somehow completely borked my local docker setup https://github.com/astral-sh/uv/issues/8974</p>
<p>I can't test this atm unfortunately, the changes don't look drastically different to me though</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/shaneikennedy">@shaneikennedy</a> reviewed on 2024-11-09 17:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/shaneikennedy">@shaneikennedy</a> on <code>crates/uv/src/commands/project/run.rs</code>:1021 on 2024-11-09 17:37</div>
            <div class="timeline-body"><p>Nice, agreed this looks better üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-09 17:44</div>
            <div class="timeline-body"><p>Sounds good. I think @zanieb wants to take a look so will wait for that review too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/shaneikennedy">@shaneikennedy</a> on 2024-11-09 19:08</div>
            <div class="timeline-body"><p>Alright docker is back in order on my machine, tested by building the docker image <code>docker build . -t myuv</code> and then using that image in the uv-docker-example Dockerfile as the base, and finally switching the uv-docker-example run command to run fastapi with uv (as described in the original issue), and it exits basically immediately üëç  @charliermarsh</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/shaneikennedy">@shaneikennedy</a> on 2024-11-11 19:54</div>
            <div class="timeline-body"><p>@zanieb lmk if there's anything else I can do here, happy to push any fixes/changes asap if need be üëÄ üôè</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-11-12 02:48</div>
            <div class="timeline-body"><p>Thanks! This seems like a reasonable incremental improvement. We'll need to follow up with more changes, like forwarding other signals and handling things properly on Windows.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2024-11-12 02:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-11-12 02:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:14 UTC
    </footer>
</body>
</html>
