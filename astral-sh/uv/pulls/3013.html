<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avoid calling `normalize_path` with relative paths that extend beyond the current directory - astral-sh/uv #3013</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Avoid calling <code>normalize_path</code> with relative paths that extend beyond the current directory</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/3013">#3013</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-04-12 14:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>It turns out that <code>normalize_path</code> (sourced from Cargo) has a subtle bug. If you pass it a relative path that traverses beyond the root, it silently drops components. So, e.g., passing <code>../foo/bar</code>, it will just drop the leading <code>..</code> and return <code>foo/bar</code>.</p>
<p>This PR encodes that behavior as a <code>Result</code> and avoids using it in such cases.</p>
<p>Closes https://github.com/astral-sh/uv/issues/3012.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2024-04-12 14:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @charliermarsh on 2024-04-12 14:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2024-04-12 14:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-04-12 14:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-12 14:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-interpreter/src/interpreter.rs</code>:497 on 2024-04-12 14:26</div>
            <div class="timeline-body"><p>@konstin - I think it's okay to cache under the canonical path here rather than the executable path... since we already use the canonical path for the timestamp. It could cause issues with executables that are symlinks (that's a common source of bugs here), but I think it's still fine since we're not using the canonical path to <em>query</em> the executable, which is what tends to cause issues.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-12 14:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-fs/src/path.rs</code>:86 on 2024-04-12 14:27</div>
            <div class="timeline-body"><p>Why would we want to remove those? Should we add a debug assertion that they're not present at the beginning of the path?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-12 14:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-interpreter/src/interpreter.rs</code>:491 on 2024-04-12 14:31</div>
            <div class="timeline-body"><p>\cc @BurntSushi - I changed this to just hash the path directly. Not sure if it's equivalent?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/pep508-rs/src/verbatim_url.rs</code>:40 on 2024-04-12 14:37</div>
            <div class="timeline-body"><p>Can we panic if it isn't?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-fs/src/path.rs</code>:88 on 2024-04-12 14:38</div>
            <div class="timeline-body"><p>Same here. Can we panic if it isn't absolute?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-interpreter/src/interpreter.rs</code>:491 on 2024-04-12 14:39</div>
            <div class="timeline-body"><p>It looks like it isn't: https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=df4e201815ac56439741d3646c18ad70</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-interpreter/src/interpreter.rs</code>:491 on 2024-04-12 14:40</div>
            <div class="timeline-body"><p>I'm trying to grok why you need the hashes to be the same here. I'm not understanding that park. Like, even if this generates a different hash, that seems okay, it just means you'll get a cache miss? Or is there something deeper here that I'm missing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-04-12 14:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-12 14:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-interpreter/src/interpreter.rs</code>:491 on 2024-04-12 14:52</div>
            <div class="timeline-body"><p>They don't need to be the same!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-12 14:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/pep508-rs/src/verbatim_url.rs</code>:40 on 2024-04-12 14:54</div>
            <div class="timeline-body"><p>Yeah.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-12 14:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-fs/src/path.rs</code>:88 on 2024-04-12 14:54</div>
            <div class="timeline-body"><p>Yeah.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-12 14:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-fs/src/path.rs</code>:86 on 2024-04-12 14:54</div>
            <div class="timeline-body"><p>Why would we want to remove <code>..</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-12 14:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-fs/src/path.rs</code>:86 on 2024-04-12 14:55</div>
            <div class="timeline-body"><p>Is that what you're asking?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-12 14:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-interpreter/src/interpreter.rs</code>:491 on 2024-04-12 14:58</div>
            <div class="timeline-body"><p>It was mostly a Chesterton's Fence of trying to understand why we did this in the first place.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-12 15:15</div>
            <div class="timeline-body"><p>I guess <code>normalize_path</code> doesn't actually <em>require</em> an absolute path. It's just an error case that you could have more <code>..</code> segments than you have parents. I'll change this to return <code>Result</code> if we try to pop in that case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @charliermarsh on 2024-04-12 16:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @charliermarsh on 2024-04-12 18:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @charliermarsh on 2024-04-12 18:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Avoid calling `normalize_path` on possibly-relative paths" to "Avoid calling `normalize_path` with relative paths that extend beyond the current directory" by @charliermarsh on 2024-04-12 18:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2024-04-12 18:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-12 18:31</div>
            <div class="timeline-body"><p>Okay, could use another review here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2024-04-12 18:40</div>
            <div class="timeline-body"><p>LGTM</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-04-12 18:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-04-12 18:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-12 18:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:36:34 UTC
    </footer>
</body>
</html>
