<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use base executable to set virtualenv Python path - astral-sh/uv #8481</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use base executable to set virtualenv Python path</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/8481">#8481</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-10-22 23:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-22 23:16</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>See extensive discussion in https://github.com/astral-sh/uv/pull/8433#issuecomment-2430472849.</p>
<p>This PR brings us into alignment with the standard library by using <code>sys._base_executable</code> rather than canonicalizing the executable path.</p>
<p>The benefits are primarily for Homebrew, where we'll now resolve to paths like <code>/opt/homebrew/opt/python@3.12/bin</code> instead of the undesirable <code>/opt/homebrew/Cellar/python@3.9/3.9.19_1/Frameworks/Python.framework/Versions/3.9/bin</code>.</p>
<p>Most other users should see no change, though in some cases, nested virtual environments now have slightly different behavior -- namely, they <em>sometimes</em> resolve to the virtual environment Python (at least for Homebrew; not for rtx or uv Pythons though). See <a href="https://docs.google.com/spreadsheets/d/1Vw5ClYEjgrBJJhQiwa3cCenIA1GbcRyudYN9NwQaEcM/edit?gid=0#gid=0">here</a> for a breakdown.</p>
<p>Closes https://github.com/astral-sh/uv/issues/1640.
Closes https://github.com/astral-sh/uv/issues/1795.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @charliermarsh on 2024-10-22 23:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2024-10-22 23:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @charliermarsh on 2024-10-22 23:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">breaking</span> added by @charliermarsh on 2024-10-22 23:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-22 23:22</div>
            <div class="timeline-body"><p>Oh, I did find one Python that does not define <code>sys._base_executable</code>: <code>/Library/Frameworks/Python.framework/Versions/3.7/bin/python3</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-10-22 23:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:63 on 2024-10-22 23:24</div>
            <div class="timeline-body"><p>CPython errors if <code>sys._base_executable</code> is undefined, at least on latest. But we have to support creating environments from <em>other</em> Pythons. I found that in 3.7 at least, they used this logic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-22 23:34</div>
            <div class="timeline-body"><p>Okay, it looks like we have the ~same problem with our test setup: we create symlinks to Pythons, but they lose the connection to the base interpreter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2024-10-22 23:45</div>
            <div class="timeline-body"><p>What do you think about flag(s) to modify behavior to account for situations that are broken by the default implementation?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-22 23:46</div>
            <div class="timeline-body"><p>What is an example of a real situation that is broken by this implementation?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:85 on 2024-10-22 23:54</div>
            <div class="timeline-body"><p>This is my attempt to solve the problem demonstrated by our test suite. We symlink from the installed Python directory to (e.g.) <code>/Users/crmarsh/.local/share/uv/tests/.tmpIl4Pjf/python/3.12/python3</code>. In <code>python-build-standalone</code>, <code>sys._base_executable</code> for that symlink just points to the current Python (i.e., it points to <code>/Users/crmarsh/.local/share/uv/tests/.tmpIl4Pjf/python/3.12/python3</code>). The trick I'm employing here is that we resolve symlinks as long as the binary is not in the <code>scripts</code> path.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-10-22 23:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-10-23 10:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:63 on 2024-10-23 10:06</div>
            <div class="timeline-body"><p>i checked and it's also set in pypy3.10 on linux</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-10-23 10:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:85 on 2024-10-23 10:14</div>
            <div class="timeline-body"><p>Does this only occur with python build standalone? In this case, we should patch this in pbs</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-10-23 11:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:85 on 2024-10-23 11:32</div>
            <div class="timeline-body"><p>Patch it to what?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-10-23 13:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:85 on 2024-10-23 13:20</div>
            <div class="timeline-body"><p>i think we have to fix https://github.com/indygreg/python-build-standalone/issues/380, or at least i expect it's closely related.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-10-24 02:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:85 on 2024-10-24 02:17</div>
            <div class="timeline-body"><p>What do you think of the solution itself? Alternatively, we could determine whether this is a uv-managed Python, and resolve the symlink if so. (But we might then fail if users install PBS builds through some other mechanism and symlink <em>those</em>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-10-24 09:51</div>
            <div class="timeline-body"><p>I can't test the homebrew situation, though unlike #8433, it doesn't solve my pyenv use case:</p>
<p>I have a <code>/home/konsti/.local/bin/python3.11</code> that is symlinked to a pyenv 3.11 in <code>/home/konsti/.pyenv/versions/3.11.7/bin</code> (pyenv tags folders with the patch version, you can install multiple patch releases at the same time). It would be nice if I could change the symlink when a new patch version of 3.11 is released, without breaking all existing venvs. With this branch, we resolve through the symlink:</p>
<pre><code class="language-console">$ uv-branch venv -p /home/konsti/.local/bin/python3.11 branch
$ uv-main venv -p /home/konsti/.local/bin/python3.11 main
$ ls -lah main/bin/python
lrwxrwxrwx 1 konsti konsti 50 Okt 24 11:45 main/bin/python -&gt; /home/konsti/.pyenv/versions/3.11.7/bin/python3.11
$ ls -lah branch/bin/python
lrwxrwxrwx 1 konsti konsti 46 Okt 24 11:45 branch/bin/python -&gt; /home/konsti/.pyenv/versions/3.11.7/bin/python
</code></pre>
<p>This is not a blocker if it solves the homebrew situation more similar to std than #8433, I just want to note this drawback here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-10-24 09:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:85 on 2024-10-24 09:52</div>
            <div class="timeline-body"><p>(replied in the main thread)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-10-24 09:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-24 12:48</div>
            <div class="timeline-body"><p>Similarly, this does not solve the version stability goals for our managed Python installations as mentioned in https://github.com/astral-sh/uv/pull/8433#issuecomment-2428037536 and as implemented in #8458. As @konstin concludes, I think this is okay since we're aligning with CPython, but it'd be nice to have some plan to address this. It's possible the solution is &quot;create something that looks like Homebrew instead&quot;, where you have a whole lib directory structure for minor Python versions. I'm not excited about the additional indirection, but it does seem roughly more correct. We may be able to encourage pyenv to move in the same direction? Perhaps we should see if they have something to say about this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-24 12:57</div>
            <div class="timeline-body"><p>I guess an open question for me is if we want to provide a setting for this, i.e., <code>UV_VENV_PYTHON_LINK = resolve | base | no-resolve</code> (don't focus on the names here), so people can recover the existing behavior if we break their setup (and pyenv users can get the behavior they need immediately)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-24 13:00</div>
            <div class="timeline-body"><p>Critically, though, it would be actively wrong to use <code>/home/konsti/.local/bin</code> as the virtual environment <code>home</code>. The same is true for the managed Python design, right? That's not a valid Python installation. It might work, but it also might not, and it could do things we don't expect or can't test (I just don't know how <code>home</code> is used precisely). Homebrew is actually doing something fairly different whereby it's setting <code>sys._base_executable</code> to a stable symlink to a valid Python installation. I think that problem needs to be solved in the Python distributions and layouts, and not in uv...</p>
<p>(I know you both know some of this, just repeating it for clarity.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-24 13:45</div>
            <div class="timeline-body"><blockquote>
<p>Critically, though, it would be actively wrong to use /home/konsti/.local/bin as the virtual environment home. The same is true for the managed Python design, right? That's not a valid Python installation.</p>
</blockquote>
<p>Totally agree. I wonder if we can just omit <code>home</code> entirely in that case? I mean, since it's not valid it basically has no affect and falls back to information present in the Python installation. I tried removing it from a Homebrew virtual environment's <code>pyvenv.cfg</code> and nothing broke.</p>
<p>Switching to a &quot;base executable&quot; strategy by default (and presuming <code>home</code> is always correct) but <em>not</em> writing <code>home</code> for an alternative strategy where we don't follow links might be reasonable? Of course, this doesn't work for our managed distributions (probably because of #8429) but I think that's a separate problem we can address.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-24 13:46</div>
            <div class="timeline-body"><p>Yeah agreed. I think we need to learn more about how <code>home</code> works and the intended design (and see if we can fix the managed distribution behavior upstream). At least this change here brings us into alignment with the standard library by default though, rather than further from it, which seems good.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-24 14:03</div>
            <div class="timeline-body"><p>Yeah all for changing the default. I'm also leaning further towards the idea that we should support configuring the strategy as an escape hatch for workflows this change breaks though; even if we only support this new mode (<code>base-executable</code>) and our existing behavior (<code>resolve</code>) to start.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-24 15:15</div>
            <div class="timeline-body"><p>I asked in https://github.com/indygreg/python-build-standalone/issues/382 if there's a way we can reliably detect relocatable Pythons.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-25 01:13</div>
            <div class="timeline-body"><p>Ok, to workaround the python-build-standalone bug, I'm now doing:</p>
<ol>
<li>For python-build-standalone (using the heuristic from the linked issue), resolve all symlinks.</li>
<li>Follow CPython for all other interpreters.</li>
</ol>
<p>The only risk here is that the heuristic could have false positives (interpreters with a legitimate prefix of <code>/install</code>), but I guess we just accept that. Even in that case, the strategy is still ~fine -- you just get the behavior we have today on <code>main</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2024-10-25 01:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-25 01:33</div>
            <div class="timeline-body"><p>(I'm sort of hesitant to add settings for the strategy without clear demand.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-25 04:09</div>
            <div class="timeline-body"><blockquote>
<p>(I'm sort of hesitant to add settings for the strategy without clear demand.)</p>
</blockquote>
<p>Fair, but we already have some clear cases where we need to resolve the link to avoid breaking everything (e.g., for our own Python distributions). I think making this breaking change without a way to recover the previous behavior is pretty risky. I think just an environment variable is fine, not looking for first-class configuration options.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-10-25 04:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-10-25 08:14</div>
            <div class="timeline-body"><p>Here's how <code>sys._base_executable</code> and <code>pyvenv.cfg</code>'s home look on my ubuntu 24.04 for a system interpreter, a pyenv interpreter and a python build standalone.</p>
<h3>Basic usage, no symlinks</h3>
<p>System interpreter</p>
<pre><code>$ /usr/bin/python3 -c &quot;import sys; print(sys._base_executable)&quot;
/usr/bin/python3
$ rm -rf venv &amp;&amp; /usr/bin/python3 -m venv venv &amp;&amp; cat venv/pyvenv.cfg | grep &quot;home &quot;
home = /usr/bin
</code></pre>
<p>Pyenv interpreter</p>
<pre><code>$ /home/konsti/.pyenv/versions/3.11.7/bin/python3.11 -c &quot;import sys; print(sys._base_executable)&quot;
/home/konsti/.pyenv/versions/3.11.7/bin/python3.11
$ rm -rf venv &amp;&amp; /home/konsti/.pyenv/versions/3.11.7/bin/python3.11 -m venv venv &amp;&amp; cat venv/pyvenv.cfg | grep &quot;home &quot;
home = /home/konsti/.pyenv/versions/3.11.7/bin
</code></pre>
<p>Python build standalone</p>
<pre><code>$ /home/konsti/.local/share/uv/python/cpython-3.11.10-linux-x86_64-gnu/bin/python3 -c &quot;import sys; print(sys._base_executable)&quot;
/home/konsti/.local/share/uv/python/cpython-3.11.10-linux-x86_64-gnu/bin/python3
$ rm -rf venv &amp;&amp; /home/konsti/.local/share/uv/python/cpython-3.11.10-linux-x86_64-gnu/bin/python3 -m venv venv &amp;&amp; cat venv/pyvenv.cfg | grep &quot;home &quot;
home = /home/konsti/.local/share/uv/python/cpython-3.11.10-linux-x86_64-gnu/bin
</code></pre>
<h3>Symlinked interpreters</h3>
<pre><code>ln -s /usr/bin/python3 python-system
ln -s /home/konsti/.pyenv/versions/3.11.7/bin/python3.11 python-pyenv
ln -s /home/konsti/.local/share/uv/python/cpython-3.11.10-linux-x86_64-gnu/bin/python3 python-pbs
</code></pre>
<pre><code>$ ./python-system -c &quot;import sys; print(sys._base_executable)&quot;
/home/konsti/projects/a/python-system
$ ./python-pyenv -c &quot;import sys; print(sys._base_executable)&quot;
/home/konsti/projects/a/python-pyenv
$ ./python-pbs -c &quot;import sys; print(sys._base_executable)&quot;
/home/konsti/projects/a/python-pbs
</code></pre>
<h3>venvs from symlinked interpreters</h3>
<pre><code>$ rm -rf venv &amp;&amp; ./python-system -m venv --without-pip venv &amp;&amp; cat venv/pyvenv.cfg | grep &quot;home &quot;
home = /home/konsti/projects/a
$ venv/bin/python -c &quot;import sys; print(sys._base_executable)&quot;
/usr/bin/python3.12
$ rm -rf venv &amp;&amp; ./python-pyenv -m venv --without-pip venv &amp;&amp; cat venv/pyvenv.cfg | grep &quot;home &quot;
home = /home/konsti/projects/a
$ venv/bin/python -c &quot;import sys; print(sys._base_executable)&quot;
/home/konsti/.pyenv/versions/3.11.7/bin/python3.11
$ rm -rf venv &amp;&amp; ./python-pbs -m venv --without-pip venv &amp;&amp; cat venv/pyvenv.cfg | grep &quot;home &quot;
home = /home/konsti/projects/a
$ venv/bin/python -c &quot;import sys; print(sys._base_executable)&quot;
[ERROR: ModuleNotFoundError: No module named 'encodings']
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-10-25 08:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-25 13:08</div>
            <div class="timeline-body"><p>I'm just concerned that users will use such a setting without understanding all the nuances and break their own setups or do things that are slightly and silently wrong. The tradeoffs are really complicated, and any bugs that emerge as a result of this change are in line with the standard library and bugs in those Python distributions. I understand the push though... I can add it as an environment variable, as an escape hatch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-10-28 16:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-10-28 16:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-10-28 16:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-10 20:42</div>
            <div class="timeline-body"><p>We refined the behavior a bit in https://github.com/astral-sh/uv/pull/9723.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:13 UTC
    </footer>
</body>
</html>
