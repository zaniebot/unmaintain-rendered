<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Normalize extras in lockfile  - astral-sh/uv #3958</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Normalize extras in lockfile</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/3958">#3958</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-06-01 18:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-01 18:13</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Previously, when we locked something like <code>flask[dotenv]</code>, we created two separate distributions in the lockfile: one for <code>flask</code>, which included the base dependencies, and one for <code>flask[dotenv]</code>, which included the base dependencies <em>and</em> the <code>dotenv</code> dependencies. This was easy to implement, but it meant that we were duplicating all of the distribution files for every extra, and duplicating all of the base dependencies for every extra.</p>
<p>This PR normalizes the data such that we now have one entry per distribution (i.e., <code>ExtraName</code> was removed from <code>DistributionId</code>), with an optional dependencies table with an entry per extra, like:</p>
<pre><code class="language-toml">[[distribution]]
name = &quot;project&quot;
version = &quot;0.1.0&quot;
source = &quot;editable+file://[TEMP_DIR]/&quot;
sdist = { url = &quot;file://[TEMP_DIR]/&quot; }

[[distribution.dependencies]]
name = &quot;anyio&quot;
version = &quot;3.7.0&quot;
source = &quot;registry+https://pypi.org/simple&quot;

[distribution.optional-dependencies]

[[distribution.optional-dependencies.test]]
name = &quot;iniconfig&quot;
version = &quot;2.0.0&quot;
source = &quot;registry+https://pypi.org/simple&quot;
</code></pre>
<p>This requires a bit more work upfront, because we now need to merge multiple packages from the <code>PetGraph</code> representation when creating the lockfile.</p>
<p>Closes https://github.com/astral-sh/uv/issues/3916.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @charliermarsh on 2024-06-01 18:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2024-06-01 18:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-01 18:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/lock.rs</code>:546 on 2024-06-01 18:17</div>
            <div class="timeline-body"><p>Not thrilled that I'm making so many things <code>pub(crate)</code> here. Should I change <code>ResolutionGraph::to_lock</code> into a <code>impl TryFrom&lt;ResolutionGraph</code> for <code>Lock</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-01 18:17</div>
            <div class="timeline-body"><p>@BurntSushi - Ignoring the code, curious if you prefer this representation?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-06-01 18:26</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/uv/branches/charlie/ex">CodSpeed Performance Report</a></h2>
<h3>Merging #3958 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>charlie/ex</code> (02f3ead) with <code>main</code> (362b00c)</sub></p>
<h3>Summary</h3>
<p><code>âœ… 13</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @charliermarsh on 2024-06-01 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ibraheemdev by @charliermarsh on 2024-06-01 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/uv-resolver/src/resolution/graph.rs</code>:461 on 2024-06-03 16:41</div>
            <div class="timeline-body"><p>Why could the previous code do an unconditional <code>push</code> here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> approved on 2024-06-03 16:46</div>
            <div class="timeline-body"><p>The new representation generally makes sense to me.</p>
<p>Would it make more sense to put optional dependencies under <code>distributions.extras.&quot;name&quot;.dependencies</code>? Could we ever want to put other information under <code>distributions.extras.&quot;name&quot;</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-resolver/src/lock.rs</code>:546 on 2024-06-03 17:16</div>
            <div class="timeline-body"><p>I kind of bias toward concrete and bespoke (but conventional) conversion routines like <code>ResolutionGraph::to_lock</code> unless there's a specific need for generic fallible conversions.</p>
<p>I think this is more of a stylistic choice, but I'd say it's just a specific manifestation of &quot;don't go generic unless there's a reason to.&quot; And with specific conversion routines, it's straight-forward to add more parameters if they ever become necessary.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-resolver/src/lock.rs</code>:546 on 2024-06-03 17:19</div>
            <div class="timeline-body"><p>Ooooooooo, I completely misunderstood your question. You were suggesting the <code>TryFrom</code> impl so that the conversion would be defined in this module, and that would in turn prevent exposing stuff.</p>
<p>Yeah I think I'd do that. Although, following from my previous comment, I'd probably just define <code>Lock::from_resolution_graph</code> or something. And that might in turn require exposing more stuff from the graph, but maybe that's okay.</p>
<p>(I don't think we've really settled on a great balance here. I wonder, for example, whether it really makes sense to have a <code>ResolutionGraph</code> at all. But this gets to the &quot;installation might want different types&quot; idea that's been floating around. It's a bigger refactor for sure.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2024-06-03 17:20</div>
            <div class="timeline-body"><p>I think I'd echo @ibraheemdev's question. Otherwise, this generally LGTM. If it's possible, I think I would prefer a way where we're not slapping <code>pub(crate)</code> on everything, but I don't feel too strongly at this point while we're still trying to figure out what the data types should be.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-03 18:38</div>
            <div class="timeline-body"><p>I think I will leave the representation as-is for now because it closely mirrors the <code>pyproject.toml</code> schema, where you have an <code>optional-dependencies</code> map that's keyed on extra name. That was intentional, because I'm hoping to make it possible to reify the distribution metadata from the lockfile in the future. It's a very good question though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-03 18:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/lock.rs</code>:546 on 2024-06-03 18:40</div>
            <div class="timeline-body"><p>Yeah I'm also not totally convinced that <code>ResolutionGraph</code> will be necessary in the long run.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-06-03 19:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-06-03 19:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-06-03 19:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 13:54:20 UTC
    </footer>
</body>
</html>
