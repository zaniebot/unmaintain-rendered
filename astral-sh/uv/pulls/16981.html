<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Summarize package changes in `uv sync` json format output - astral-sh/uv #16981</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Summarize package changes in `uv sync` json format output</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/16981">#16981</a>
        opened by <a href="https://github.com/EliteTK">@EliteTK</a>
        on 2025-12-04 15:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/EliteTK">@EliteTK</a> on 2025-12-04 15:39</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Implement #16653 by making <code>uv sync --output-format=json</code> output information about package changes.</p>
<h2>Test Plan</h2>
<p>Additional tests to test the cases where there is no known package version <em>may</em> be beneficial but as the information used is the same as the information used by the dry run logging now, I don't think that's strictly necessary as those cases are tested.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @EliteTK on 2025-12-04 15:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @EliteTK on 2025-12-04 15:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-04 15:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/src/commands/pip/loggers.rs</code>:164 on 2025-12-04 15:41</div>
            <div class="timeline-body"><p>This now allocates unfortunately. Let me know if there's a straightforward way to avoid this (I am aware of <code>either</code> being probably usable here, but I didn't want to add dependencies - although it is used elsewhere).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-04 15:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/src/commands/pip/loggers.rs</code>:157 on 2025-12-04 15:42</div>
            <div class="timeline-body"><p>Example of where installed_version is used for comparison when canonical_version is strictly more appropriate.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/src/commands/pip/operations.rs</code>:443 on 2025-12-04 15:45</div>
            <div class="timeline-body"><p>This is awful, it's a direct side effect of <code>ChangeEvent</code> requiring this type implements <code>InstalledMetadata</code>. I think that potentially, since <code>ChangeEvent</code> is only used (in this way - actually not sure anymore) in the logger and in uv-sync, it may make sense to use a different type and then this whole thing can be avoided.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-04 15:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-04 15:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/src/commands/pip/operations.rs</code>:506 on 2025-12-04 15:47</div>
            <div class="timeline-body"><p>Annoying duplication. I may investigate de-duplicating this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/src/commands/project/sync.rs</code>:1267 on 2025-12-04 15:49</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/uv/pull/16660#discussion_r2510856345</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-04 15:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @EliteTK on 2025-12-04 15:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-12-04 15:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/src/commands/pip/loggers.rs</code>:164 on 2025-12-04 15:58</div>
            <div class="timeline-body"><p>I'm not worried about this allocating, it's not in a hot loop, it's cheaper than a lot of the hidden allocations we do and the number of versions we print is very limited (and printing is usually very slow in comparison)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EliteTK">@EliteTK</a> on 2025-12-04 18:36</div>
            <div class="timeline-body"><p>So, to summarise a discussion from Discord, a suggestion was made to pull out the planning step from <code>pip::operations::install</code> into a separate <code>plan</code> function. Or, alternatively, just return the plan from <code>install</code>.</p>
<p>The goal being that a <code>PackageChangeReport::from_plan</code> can be added and used in the dry-run case, avoiding going through <code>Changelog</code> entirely, saving a bunch of code.</p>
<p>I've started to explore the idea of pulling out <code>plan</code>, but I don't think it's worth it. It adds a lot of boilerplate. I'll submit it as a separate PR and then I'll consider the alternative. Then whatever the result of that, this PR can be rebased on top and simplified.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EliteTK">@EliteTK</a> on 2025-12-05 15:01</div>
            <div class="timeline-body"><p>So, the idea behind <code>--dry-run</code> is to produce output which is similar to what is produced without it, but without actually performing any actions. So, for example, the outputs below are almost identical:</p>
<pre><code class="language-bash">$ uv sync
Resolved 6 packages in 2ms
Uninstalled 4 packages in 5ms
Installed 3 packages in 8ms
 - anyio==4.12.0
 + charset-normalizer==3.4.4
 - h11==0.16.0
 - httpcore==1.0.9
 - httpx==0.28.1
 + requests==2.32.5
 + urllib3==2.5.0
$ magically_revert_state # Trade secret
$ uv sync --dry-run
Would use project environment at: .venv
Resolved 6 packages in 1ms
Found up-to-date lockfile at: uv.lock
Would uninstall 4 packages
Would install 3 packages
 - anyio==4.12.0
 + charset-normalizer==3.4.4
 - h11==0.16.0
 - httpcore==1.0.9
 - httpx==0.28.1
 + requests==2.32.5
 + urllib3==2.5.0
</code></pre>
<p>And the goal of the json output is to present this information in JSON.</p>
<p>In the output above, the normal path uses <code>InstallLogger::on_complete</code>, but <code>report_dry_run</code> re-implements the code from <code>DefaultInstallLogger::on_complete</code> and kind of effectively produces the same information which would have been in <code>Changelog</code>. This[^1] <code>Changelog</code> is only ever used to implement <code>InstallLogger::on_complete</code> logging, I think it actually would make sense for <code>Changelog</code> be the type which uniformly stores the information (regardless of whether it was from an install, or a dry-run install).</p>
<p>I think the only real changes which would be required is to: Expand the kinds of dists that <code>Changelog</code> can contain, so it can contain remote dists, and then adjust the respective <code>ChangeEvent</code> type (which similarly is only used within <code>on_complete</code>) to be able to deal with things without versions (possibly just fall back to a URL like the current <code>report_dry_run</code> code does). This would have the knock-on effect of allowing <code>report_dry_run</code> to just use the <code>on_complete</code> logger, cutting it down further.</p>
<p>Finally, <code>report_dry_run</code> can just return this <code>Changelog</code> type.</p>
<p>I believe this can all be done while keeping things pretty clean. Definitely no <code>ZERO_VERSION</code> hack ;).</p>
<p>Let me know what you think.</p>
<p>[^1]: There are two <code>Changelog</code> types and two <code>ChangeEvent</code> types because of the slightly different requirements of where they are used. Both the logging functionality and the different changelogs could be unified, I think. But I don't think that it would necessarily benefit from being done now. I can kind of see it though, would be good to investigate one day, as there are two places where the <code>DefaultInstallLogger::on_complete</code> functionality is re-implemented verbatim. In fact, the changes suggested here would probably make such a change easier to implement.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-05 15:03</div>
            <div class="timeline-body"><p>Sounds fine to me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-12 12:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/src/commands/pip/loggers.rs</code>:157 on 2025-12-12 12:16</div>
            <div class="timeline-body"><p>Having thought about it further, maybe it doesn't matter much for this usecase.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EliteTK">@EliteTK</a> on 2025-12-12 12:17</div>
            <div class="timeline-body"><p>Okay, rebased on top of the new changelog stuff, fixed the package naming and attaching the wrong lifetime to a reference in <code>VersionOrUrlRef</code>. This is ready I think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @EliteTK on 2025-12-12 12:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-15 18:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/sync.rs</code>:1370 on 2025-12-15 18:03</div>
            <div class="timeline-body"><p>I think I'd expect &quot;Uninstalled&quot; and &quot;Installed&quot; here if we're using &quot;Reinstalled&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/sync.rs</code>:1378 on 2025-12-15 18:04</div>
            <div class="timeline-body"><p>I'm a little confused by the name of this struct. It also appears to be missing from the test coverage?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-15 18:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-15 18:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/sync.rs</code>:1325 on 2025-12-15 18:06</div>
            <div class="timeline-body"><p>It seems weird for <code>PackageChangeReport::from_changelog</code> to return <code>Vec&lt;Self&gt;</code>? I guess I'd expect a <code>PackageChangesReport(Vec&lt;PackageChangeReport&gt;)</code> new-type?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-15 18:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/sync.rs</code>:1339 on 2025-12-15 18:06</div>
            <div class="timeline-body"><p>Have you thought more about what other information we'll want to include here? I don't think we need to expand on it in this pull request but we should at least open an issue for discussion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-15 18:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/sync.rs</code>:1378 on 2025-12-15 18:07</div>
            <div class="timeline-body"><p>I think the name makes sense in the context of the parent, but I'm still a bit confused on the scope here. Isn't the source an enum? like &quot;registry&quot;, &quot;path&quot;, &quot;url&quot;, etc.?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-15 18:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/src/commands/project/sync.rs</code>:1325 on 2025-12-15 18:14</div>
            <div class="timeline-body"><p>Yes I thought this was weird too. I will adjust it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-15 18:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/src/commands/project/sync.rs</code>:1378 on 2025-12-15 18:22</div>
            <div class="timeline-body"><p>Yes I agree that this would make more sense as the definition of source.</p>
<p>But I don't think we should necessarily try to put that in yet, although it's not the worst idea for something to put in here. I think in this case the nesting is unnecessary and I would probably rather just see an <code>Option&lt;DisplaySafeUrl&gt;</code> one level up for now. Would that work?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-15 18:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/src/commands/project/sync.rs</code>:1339 on 2025-12-15 18:23</div>
            <div class="timeline-body"><p>Well part of changing the changelog to just store the dist was also in preparation for this. We can more or less put anything in here we want that can be found in a Dist/LocalDist at this point. But I will make an issue tomorrow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-15 18:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/src/commands/project/sync.rs</code>:1370 on 2025-12-15 18:28</div>
            <div class="timeline-body"><p>I imagine it's because of the <code>ChangeEventKind</code> wording, but that doesn't justify it, <code>DefaultInstallLogger</code> uses <code>Installed</code>, and <code>Uninstalled</code>. <code>UpgradeInstallLogger</code> uses <code>Added</code> and <code>Removed</code>. Maybe this sort of thing should be in a style guide?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-15 18:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/sync.rs</code>:1378 on 2025-12-15 18:53</div>
            <div class="timeline-body"><p>That could be okay or I'd just omit it entirely until we handle sources more comprehensively?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2025-12-15 18:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-15 19:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/src/commands/project/sync.rs</code>:1378 on 2025-12-15 19:58</div>
            <div class="timeline-body"><p>Hmm, but we do print it in the stderr change log in those cases. But I am somewhat indifferent.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-18 13:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/src/commands/project/sync.rs</code>:1339 on 2025-12-18 13:28</div>
            <div class="timeline-body"><p>Maybe the package details should be in their own specific sub-structure so that the top level is just &quot;what happened&quot; and &quot;to what&quot; instead of &quot;what happened&quot; and a bunch of metadata about what it happened to. I'll make this change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-18 13:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/sync.rs</code>:1339 on 2025-12-18 13:30</div>
            <div class="timeline-body"><p>Can you sketch what you're thinking of first? I don't want you to waste your time if we don't have consensus on the structure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/src/commands/project/sync.rs</code>:1339 on 2025-12-18 13:56</div>
            <div class="timeline-body"><p>I'll propose something in the issue I made. For now I've left it alone.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-18 13:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @EliteTK on 2025-12-18 19:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @EliteTK on 2025-12-18 19:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-18 19:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 05:52:36 UTC
    </footer>
</body>
</html>
