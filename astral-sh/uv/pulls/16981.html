<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Summarize package changes in `uv sync` json format output - astral-sh/uv #16981</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Summarize package changes in `uv sync` json format output</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/pull/16981">#16981</a>
        opened by <a href="https://github.com/EliteTK">@EliteTK</a>
        on 2025-12-04 15:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/EliteTK">@EliteTK</a> on 2025-12-04 15:39</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Implement #16653 by making <code>uv sync --output-format=json</code> output information about package changes.</p>
<h2>Test Plan</h2>
<p>So far there are integration tests but they don't quite cover everything that I think they maybe should. A bunch of manual testing was performed too. Test suite passes.</p>
<h2>Notes/Outstanding issues</h2>
<p>I am not certain about the whole approach. The crux of the issue is that <code>dry_run</code> doesn't &quot;prepare&quot; remote <code>Dist</code>s and <code>Changelog::new</code> expects <code>CachedDist</code>s. It's possible to make a <code>CachedDist</code> from a <code>Dist</code> using <code>CachedDist::from_remote</code>, <code>hashes</code> and <code>cache_info</code> can understandably be empty. <code>path</code> could maybe be something fake, but the problem comes from <code>filename</code> which is a wheel filename. The issue is that calculating a plausible wheel filename for most <code>Dist::Source</code> <code>Dist</code>s isn't possible without building the wheel.</p>
<p>So  the current approach involved changing <code>Changelog</code> to accept <code>Dist</code> and dealing with resolving the fallout. This could probably be simplified if <code>ChangedDist</code> was just a <code>PackageName</code> and <code>Option&lt;CanonicalVersion&gt;</code>. There are a lot of places which are using the full <code>InstalledVersion</code> for comparison which can contain a URL despite the fact that in other places (e.g. when it was used in hashsets) the <code>canonical_version</code> is used (which seems correct).</p>
<p>However, even then, <code>Changelog</code>'s contents are often smuggled through <code>ChangeEvent</code> which expects <code>dist</code> to implement <code>InstalledMetadata</code> a trait which exposes <code>installed_version</code>, but the problem is that <code>Changelog</code> can now contain packages without versions.</p>
<p>Putting in a fake version is an option, but that strictly presents wrong information to users. I guess one option is to extend <code>Version</code> to be able to hold an empty version (currently explicitly not allowed) or maybe just <code>CanonicalVersion</code> to have an <code>Unknown</code> variant.</p>
<p>There are some other issues/side effects of the current set of problems.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @EliteTK on 2025-12-04 15:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @EliteTK on 2025-12-04 15:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-04 15:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/src/commands/pip/loggers.rs</code>:164 on 2025-12-04 15:41</div>
            <div class="timeline-body"><p>This now allocates unfortunately. Let me know if there's a straightforward way to avoid this (I am aware of <code>either</code> being probably usable here, but I didn't want to add dependencies - although it is used elsewhere).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-04 15:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/src/commands/pip/loggers.rs</code>:157 on 2025-12-04 15:42</div>
            <div class="timeline-body"><p>Example of where installed_version is used for comparison when canonical_version is strictly more appropriate.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/src/commands/pip/operations.rs</code>:443 on 2025-12-04 15:45</div>
            <div class="timeline-body"><p>This is awful, it's a direct side effect of <code>ChangeEvent</code> requiring this type implements <code>InstalledMetadata</code>. I think that potentially, since <code>ChangeEvent</code> is only used (in this way - actually not sure anymore) in the logger and in uv-sync, it may make sense to use a different type and then this whole thing can be avoided.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-04 15:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-04 15:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/src/commands/pip/operations.rs</code>:506 on 2025-12-04 15:47</div>
            <div class="timeline-body"><p>Annoying duplication. I may investigate de-duplicating this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/src/commands/project/sync.rs</code>:1267 on 2025-12-04 15:49</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/uv/pull/16660#discussion_r2510856345</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-04 15:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @EliteTK on 2025-12-04 15:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-12-04 15:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/src/commands/pip/loggers.rs</code>:164 on 2025-12-04 15:58</div>
            <div class="timeline-body"><p>I'm not worried about this allocating, it's not in a hot loop, it's cheaper than a lot of the hidden allocations we do and the number of versions we print is very limited (and printing is usually very slow in comparison)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/16660.html">astral-sh/uv#16660</a> on 2025-12-04 16:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EliteTK">@EliteTK</a> on 2025-12-04 18:36</div>
            <div class="timeline-body"><p>So, to summarise a discussion from Discord, a suggestion was made to pull out the planning step from <code>pip::operations::install</code> into a separate <code>plan</code> function. Or, alternatively, just return the plan from <code>install</code>.</p>
<p>The goal being that a <code>PackageChangeReport::from_plan</code> can be added and used in the dry-run case, avoiding going through <code>Changelog</code> entirely, saving a bunch of code.</p>
<p>I've started to explore the idea of pulling out <code>plan</code>, but I don't think it's worth it. It adds a lot of boilerplate. I'll submit it as a separate PR and then I'll consider the alternative. Then whatever the result of that, this PR can be rebased on top and simplified.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/16985.html">astral-sh/uv#16985</a> on 2025-12-05 14:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EliteTK">@EliteTK</a> on 2025-12-05 15:01</div>
            <div class="timeline-body"><p>So, the idea behind <code>--dry-run</code> is to produce output which is similar to what is produced without it, but without actually performing any actions. So, for example, the outputs below are almost identical:</p>
<pre><code class="language-bash">$ uv sync
Resolved 6 packages in 2ms
Uninstalled 4 packages in 5ms
Installed 3 packages in 8ms
 - anyio==4.12.0
 + charset-normalizer==3.4.4
 - h11==0.16.0
 - httpcore==1.0.9
 - httpx==0.28.1
 + requests==2.32.5
 + urllib3==2.5.0
$ magically_revert_state # Trade secret
$ uv sync --dry-run
Would use project environment at: .venv
Resolved 6 packages in 1ms
Found up-to-date lockfile at: uv.lock
Would uninstall 4 packages
Would install 3 packages
 - anyio==4.12.0
 + charset-normalizer==3.4.4
 - h11==0.16.0
 - httpcore==1.0.9
 - httpx==0.28.1
 + requests==2.32.5
 + urllib3==2.5.0
</code></pre>
<p>And the goal of the json output is to present this information in JSON.</p>
<p>In the output above, the normal path uses <code>InstallLogger::on_complete</code>, but <code>report_dry_run</code> re-implements the code from <code>DefaultInstallLogger::on_complete</code> and kind of effectively produces the same information which would have been in <code>Changelog</code>. This[^1] <code>Changelog</code> is only ever used to implement <code>InstallLogger::on_complete</code> logging, I think it actually would make sense for <code>Changelog</code> be the type which uniformly stores the information (regardless of whether it was from an install, or a dry-run install).</p>
<p>I think the only real changes which would be required is to: Expand the kinds of dists that <code>Changelog</code> can contain, so it can contain remote dists, and then adjust the respective <code>ChangeEvent</code> type (which similarly is only used within <code>on_complete</code>) to be able to deal with things without versions (possibly just fall back to a URL like the current <code>report_dry_run</code> code does). This would have the knock-on effect of allowing <code>report_dry_run</code> to just use the <code>on_complete</code> logger, cutting it down further.</p>
<p>Finally, <code>report_dry_run</code> can just return this <code>Changelog</code> type.</p>
<p>I believe this can all be done while keeping things pretty clean. Definitely no <code>ZERO_VERSION</code> hack ;).</p>
<p>Let me know what you think.</p>
<p>[^1]: There are two <code>Changelog</code> types and two <code>ChangeEvent</code> types because of the slightly different requirements of where they are used. Both the logging functionality and the different changelogs could be unified, I think. But I don't think that it would necessarily benefit from being done now. I can kind of see it though, would be good to investigate one day, as there are two places where the <code>DefaultInstallLogger::on_complete</code> functionality is re-implemented verbatim. In fact, the changes suggested here would probably make such a change easier to implement.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-05 15:03</div>
            <div class="timeline-body"><p>Sounds fine to me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/17039.html">astral-sh/uv#17039</a> on 2025-12-08 22:11</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:33:16 UTC
    </footer>
</body>
</html>
