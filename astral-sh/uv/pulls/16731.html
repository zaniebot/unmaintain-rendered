<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collect and upload PEP 740 attestations during `uv publish` - astral-sh/uv #16731</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Collect and upload PEP 740 attestations during `uv publish`</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/16731">#16731</a>
        opened by <a href="https://github.com/woodruffw">@woodruffw</a>
        on 2025-11-13 21:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/woodruffw">@woodruffw</a> on 2025-11-13 21:34</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>~~Still working on this.~~</p>
<p>TL;DR: This makes <code>uv publish</code> behave like <code>twine upload</code>: when a user does <code>uv publish dist/*</code> and <code>dist/*</code> includes attestations, we now group those attestations with their matching distribution and include them in the upload. This changes the behavior from the previous behavior, which silently skipped these (since they don't match the distribution filename format).</p>
<p>This is a step towards #15618: we don't produce attestations <em>within</em> uv itself yet, but this allows uv to upload them if they're already present as part of the distribution paths.</p>
<h2>Test Plan</h2>
<p>I've broken the <code>uv-publish</code> crate's functionality for collecting upload inputs a part a bit to make testing of the grouping logic easier; <code>files_for_publishing</code> is now <code>group_files_for_publishing</code>, with an interior helper (<code>group_files</code>) that does no I/O or filesystem ops. I've added unit tests for that inner helper to confirm our matching/grouping works as expected and doesn't regress on other publishing tests.</p>
<p>Separately, it'd be nice to have some kind of integration test with an index that supports attestations, like PyPI or TestPyPI. I'll need to think a bit about how best to do that ðŸ™‚</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-publish/src/lib.rs</code>:248 on 2025-11-14 11:02</div>
            <div class="timeline-body"><p><code>UploadDistribution</code> or <code>UploadFile</code> maybe, &quot;group&quot; is also used for dependency groups.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-publish/src/lib.rs</code>:287 on 2025-11-14 11:04</div>
            <div class="timeline-body"><p>Can we avoid a validate/parse split, e.g. with <code>extension</code> and <code>file_stem</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-11-14 11:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-11-14 13:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-publish/src/lib.rs</code>:248 on 2025-11-14 13:18</div>
            <div class="timeline-body"><p>UploadDistribution sounds good, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/woodruffw">@woodruffw</a> on 2025-11-14 14:17</div>
            <div class="timeline-body"><p>Flagging one thing: unlike <code>twine upload</code> this currently sends attestations unconditionally if they're present, which may not play super well with various indices (they may reject the <code>attestations</code> form part rather than silently skipping it). I'll need to add this to our upload tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-11-18 19:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>scripts/publish/test_publish.py.lock</code>:1 on 2025-11-18 19:06</div>
            <div class="timeline-body"><p>Sorry for the big delta here...<code>pypi-attestations</code> and <code>sigstore</code> are not lightweight packages.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @woodruffw on 2025-11-18 19:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/messerli-wallace">@messerli-wallace</a> approved on 2025-11-18 19:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @woodruffw on 2025-11-18 19:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>scripts/publish/test_publish.py</code>:124 on 2025-11-19 09:01</div>
            <div class="timeline-body"><p>Is there a way for us to check that the attestation was actually uploaded? That's the end-to-end test coverage I'm most interested in.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-publish/src/lib.rs</code>:245 on 2025-11-19 09:02</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// Represents a single &quot;to-be-uploaded&quot; distribution, along with zero
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-publish/src/lib.rs</code>:262 on 2025-11-19 09:08</div>
            <div class="timeline-body"><p>This slipped through last time but we should box large error variants: https://gist.github.com/konstin/c54456482a14c7528829fdf4567040dd</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-publish/src/lib.rs</code>:297 on 2025-11-19 09:12</div>
            <div class="timeline-body"><p>nit: Move above the if</p>
<p>I've been trying to figure out that parser until i found the comment was below</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-publish/src/lib.rs</code>:1162 on 2025-11-19 09:33</div>
            <div class="timeline-body"><p>We can use fastrand, it's already in our dependencies</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-11-19 09:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-11-19 13:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>scripts/publish/test_publish.py</code>:124 on 2025-11-19 13:43</div>
            <div class="timeline-body"><p>We could check the simple index for it, yeah. I'll add that to the  test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-11-19 15:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-publish/src/lib.rs</code>:1162 on 2025-11-19 15:29</div>
            <div class="timeline-body"><p>Thanks! Didn't notice that because it wasn't a workspace dep, but I'll tweak that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-11-19 16:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>scripts/publish/test_publish.py</code>:124 on 2025-11-19 16:03</div>
            <div class="timeline-body"><p>Added a helper that'll poke the JSON index response for provenance. That deviates slightly from our ad hoc use of the HTML index for version listings, but IMO that's fine in this case (since attestations are currently only tested against indices that support the JSON index).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-publish/src/lib.rs</code>:64 on 2025-11-19 16:13</div>
            <div class="timeline-body"><p>Noting: I've boxed both of these fields: <code>DisplaySafeUrl</code> creeps over the member size on Windows, and <code>PublishSendError</code> is consistently over it on both Windows and Linux.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-11-19 16:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @woodruffw on 2025-11-19 16:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @woodruffw on 2025-11-19 16:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>scripts/publish/test_publish.py</code>:516 on 2025-11-20 13:16</div>
            <div class="timeline-body"><p>We need to move <code>wait_for_index</code> ahead of this, and ideally ensure that we use the same URL as <code>uv pip compile</code>: Indexes cache pages, an sometimes it takes a while until the new page is available, so we have to check in a loop for a while which <code>wait_for_index</code>.</p>
<p>I don't know the exact details of the caching involved, but I could see how different index pages are updated at different times.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-11-20 13:16</div>
            <div class="timeline-body"><p>We need to fix the index cache invalidation handling, otherwise r+.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-11-20 14:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>scripts/publish/test_publish.py</code>:516 on 2025-11-20 14:54</div>
            <div class="timeline-body"><blockquote>
<p>We need to move <code>wait_for_index</code> ahead of this</p>
</blockquote>
<p>Makes sense!</p>
<blockquote>
<p>ideally ensure that we use the same URL as <code>uv pip compile</code></p>
</blockquote>
<p>This is going to be moderately annoying, since we'd probably need to move to something more structured (<code>lxml</code>?) for parsing of the HTML index ðŸ˜… -- I <em>think</em> in practice using the JSON index here is fine, since we're only testing this against PyPI at the moment and (last I checked) PyPI's invalidation is simultaneous for the HTML and JSON views of the same simple index route.</p>
<p>If you feel strongly about it I'll make that change, but my first thought here would be to keep the JSON index usage for now, with a comment that it might need to be replaced/removed once we expand the attestation check to other indices. Thoughts?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-11-20 14:58</div>
            <div class="timeline-body"><p>We'll want documentation for this as well. Let me know if you need help finding a place for it. If you sketch the content I can help with making it fit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/woodruffw">@woodruffw</a> on 2025-11-20 15:08</div>
            <div class="timeline-body"><blockquote>
<p>We'll want documentation for this as well. Let me know if you need help finding a place for it.</p>
</blockquote>
<p>Thanks! I'm guessing maybe this belongs under <code>guides/package.md</code>, i.e. the building/publishing guide? Longer term it probably also makes sense to mention/describe in the GitHub integration guide, although maybe not until attestation generation happens in uv itself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/woodruffw">@woodruffw</a> on 2025-11-20 15:34</div>
            <div class="timeline-body"><p>I added a small section to the packaging guide, but I'm not sure how much detail to include. One thing that made me realize is that we don't really expose a knob for this at the moment -- maybe it makes sense to add <code>--no-attestations</code> / <code>UV_PUBLISH_NO_ATTESTATIONS</code> for non-supporting indices that misbehave and fail rather than ignoring attestations?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-11-20 15:34</div>
            <div class="timeline-body"><p>The knobs and their names sound good</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-11-20 15:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>scripts/publish/test_publish.py</code>:516 on 2025-11-20 15:36</div>
            <div class="timeline-body"><p>iirc <code>uv pip compile</code> prefer the JSON version, so that should be fine, and that PyPI uses simultaneous invalidation helps. I'd try this version and fine-tune if we see it failing too often.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @woodruffw on 2025-11-20 16:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @woodruffw on 2025-11-20 16:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @woodruffw by @woodruffw on 2025-11-20 16:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-11-20 18:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>docs/guides/package.md</code>:178 on 2025-11-20 18:35</div>
            <div class="timeline-body"><p>Should we link or suggest how they would be created?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-11-20 18:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>docs/guides/package.md</code>:178 on 2025-11-20 18:49</div>
            <div class="timeline-body"><p>The wrinkle here is that there's no <em>good</em> way to do this currently ðŸ˜… -- we could point users to <code>pypi-attestations</code> as a DIY approach, but that's a glue package that isn't really intended for direct usage.</p>
<p>(What <code>gh-action-pypi-publish</code> does is have a helper script that uses the <code>pypi-attestations</code> APIs.)</p>
<p>One option here would be to create <code>astral-sh/pypi-attest</code> as an action, which we'd then recommend at least until we have in-client attesting. That would only take me an hour or two to build.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-cli/src/lib.rs</code>:7156 on 2025-11-24 10:41</div>
            <div class="timeline-body"><p>We should update the description for <code>files</code> above to note that it now includes attestations when found by the glob.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2025-11-24 10:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-11-24 14:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-cli/src/lib.rs</code>:7156 on 2025-11-24 14:06</div>
            <div class="timeline-body"><p><a href="https://github.com/astral-sh/uv/pull/16731/commits/b6823e2cfa60698f39de0c8f2e5f73774f75b363"><code>b6823e2</code> (#16731)</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @woodruffw on 2025-11-24 21:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @woodruffw on 2025-11-24 21:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-11-24 21:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 05:52:31 UTC
    </footer>
</body>
</html>
