<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allow users to mark platforms as &quot;required&quot; for wheel coverage - astral-sh/uv #10067</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Allow users to mark platforms as &quot;required&quot; for wheel coverage</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/10067">#10067</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-12-20 22:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR revives https://github.com/astral-sh/uv/pull/10017, which might be viable now that we <em>don't</em> enforce any platforms by default.</p>
<p>The basic idea here is that users can mark certain platforms as required (empty, by default). When resolving, we ensure that the specified platforms have wheel coverage, backtracking if not.</p>
<p>For example, to require that we include a version of PyTorch that supports Intel macOS:</p>
<pre><code class="language-toml">[project]
name = &quot;project&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.11&quot;
dependencies = [&quot;torch&gt;1.13&quot;]

[tool.uv]
required-platforms = [
    &quot;sys_platform == 'darwin' and platform_machine == 'x86_64'&quot;
]
</code></pre>
<p>Other than that, the forking is identical to past iterations of this PR.</p>
<p>This would give users a way to resolve the tail of issues in #9711, but with manual opt-in to supporting specific platforms.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2024-12-21 04:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @charliermarsh on 2024-12-21 04:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @charliermarsh on 2024-12-21 04:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2024-12-21 04:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-distribution-types/src/prioritized_distribution.rs</code>:243 on 2024-12-21 13:04</div>
            <div class="timeline-body"><p>Nice</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>docs/reference/settings.md</code>:272 on 2024-12-21 13:22</div>
            <div class="timeline-body"><p>I think it might help if the docs specifically &quot;compared and contrasted&quot; <code>required-platforms</code> with <code>environments</code>. They do different things of course, but they take the same inputs and I could see end users being confused by them.</p>
<p>(What I tend to do in docs is to mention the other in the docs and contrast them. e.g., mention <code>environments</code> in this section and <code>required-platforms</code> in the <code>environments</code> section. That way, users see the contrasting doc regardless of where they look.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2024-12-21 13:22</div>
            <div class="timeline-body"><p>I like this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-21 23:59</div>
            <div class="timeline-body"><p>Another case that this could solve (but would require user intervention): https://github.com/astral-sh/uv/issues/10085. Ideally, I think we should be able to give users a hint when the sync fails -- like &quot;There are no available wheels for this platform, add <code>required-platforms</code>&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-workspace/src/pyproject.rs</code>:535 on 2025-01-10 13:17</div>
            <div class="timeline-body"><p>Should this be <code>required_environments</code> or <code>required_markers</code>? The other markers list is <code>environments</code>, <code>platforms</code> lacks symmetry</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-resolver/src/resolver/mod.rs</code>:3677 on 2025-01-10 13:25</div>
            <div class="timeline-body"><p>Don't we add additional incompatibilities that target <code>id</code> when we find a new package <code>foo</code> with <code>foo --[marker]--&gt; id</code>? Could that lead to packages missing platform support because we could have a case like the following:</p>
<p>Required platform linux</p>
<p>Choose A 2, with <code>A -&gt; B; windows</code>, <code>A -&gt; C</code>
Choose B 2. B 2 does have only a mac wheel but that's fine because it's only required on windows, so our required linux is coverd.
Choose C 2, with <code>C -&gt; B</code></p>
<p>Try to install on linux. We try to install A 2, C 2 and B 2, but B 2 fails since it has no wheel.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-01-10 13:27</div>
            <div class="timeline-body"><p>The feature is definitely needed and i like the approach, though the <code>find_environments</code> if i haven't missed something fails to uphold the required platforms in certain conditions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-01-10 14:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/resolver/mod.rs</code>:3677 on 2025-01-10 14:36</div>
            <div class="timeline-body"><p>@konstin -- I think this would actually work as-is, though for &quot;bad&quot; reasons. Basically, when we visit <code>B</code>, we won't know that it's &quot;only required for Windows&quot;, because we don't do &quot;aggressive forking&quot; today, so we'd still try to solve for Linux. It might get filtered out later? I can't quite remember.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-01-10 14:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-workspace/src/pyproject.rs</code>:535 on 2025-01-10 14:36</div>
            <div class="timeline-body"><p>It was somewhat intentional but I can change it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-01-10 17:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-workspace/src/pyproject.rs</code>:535 on 2025-01-10 17:47</div>
            <div class="timeline-body"><p>We might want to change the other one? I feel like <code>environments</code> is a bit overloaded in the longterm.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-10 17:50</div>
            <div class="timeline-body"><p>Since this is specific to <em>wheels</em> should we name this differently? Like, if I encounter a build failure why would it be obvious that setting a <code>required_platform</code> would solve that? Is this sort of <code>no_build_platforms</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-11 14:13</div>
            <div class="timeline-body"><p>@zanieb -- That's true, although I'd read that setting as &quot;platforms on which building should be disabled&quot;, which isn't quite the same. We're not enforcing that all packages have wheels on these platforms. We're enforcing that all packages have wheels <em>or</em> source distributions on these platforms (and so, building is considered ok).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-11 14:13</div>
            <div class="timeline-body"><p>I sort of prefer something that doesn't get into the source vs. binary distinction, and instead gets at the intent of the flag: to ensure that the lockfile supports the platforms you care about.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-11 19:53</div>
            <div class="timeline-body"><p>Oh I guess I'm getting confused by the pull request title and body which say...</p>
<blockquote>
<p>When resolving, we ensure that the specified platforms have wheel coverage</p>
</blockquote>
<p>This sounds like we require wheels for the platforms?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-11 19:54</div>
            <div class="timeline-body"><p>We require that there are compatible distributions for the platform. That could be a source distribution, or (for packages that lack source distributions) a wheel.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-11 20:26</div>
            <div class="timeline-body"><p>That makes sense, it'd help to change the way this is presented in the title / body then. With this context, <code>no_build_platforms</code> definitely does not make sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-01-11 20:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>docs/reference/settings.md</code>:272 on 2025-01-11 20:27</div>
            <div class="timeline-body"><p>I think doing this would be helpful for naming. (as well as very helpful for users)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-01-13 10:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-resolver/src/resolver/mod.rs</code>:3677 on 2025-01-13 10:17</div>
            <div class="timeline-body"><p>Could you add a test case covering this scenario? So it doesn't fail with future resolver changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-workspace/src/pyproject.rs</code>:525 on 2025-02-11 02:47</div>
            <div class="timeline-body"><p>I re-did the docs here. Is it any better, @zanieb @BurntSushi?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-02-11 02:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>docs/reference/settings.md</code>:283 on 2025-02-11 11:06</div>
            <div class="timeline-body"><p>I would add something about using older versions here, like &quot;If a version of a package does not contain the required source distribution or wheels, uv will try older versions until it finds a version with sufficient support&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>docs/reference/settings.md</code>:292 on 2025-02-11 11:06</div>
            <div class="timeline-body"><pre><code class="language-suggestion">order to be installable, while still including Linux and Windows wheels in the lockfile.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2025-02-11 11:07</div>
            <div class="timeline-body"><p>I like the updated documentation, i left some nits.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-02-11 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-workspace/src/pyproject.rs</code>:525 on 2025-02-11 13:54</div>
            <div class="timeline-body"><p>Beautiful. Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2025-02-11 13:55</div>
            <div class="timeline-body"><p>Docs are much improved!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2025-02-11 22:27</div>
            <div class="timeline-body"><p>The docs are great. Not sure if we want to consider another name. This seems fine for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2025-02-14 20:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-02-14 20:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-14 20:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/johnthagen">@johnthagen</a> on 2025-02-17 19:43</div>
            <div class="timeline-body"><p>I've wanted this for so long I almost can't believe my eyes that someone has implemented it. ❤️ ❤️ ❤️</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-17 19:43</div>
            <div class="timeline-body"><p>Please let me know what you use it for and if it works for you (or not)!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/johnthagen">@johnthagen</a> on 2025-02-17 19:50</div>
            <div class="timeline-body"><blockquote>
<p>Please let me know what you use it for and if it works for you (or not)!</p>
</blockquote>
<p>My use case is that I work with dependencies that will sometimes (suddenly) drop publishing wheels for certain platforms (often something like ARM64 Linux) and it can become very challenging to detect this. What happens is that we'll <code>poetry update</code> or similar on, say, macOS ARM and that will resolve to the latest version that is missing wheels for <em>other</em> platforms that we need.</p>
<p>A couple real-life examples;</p>
<ul>
<li>(Missing Linux ARM wheels): https://pypi.org/project/ai-edge-litert-nightly/1.1.2.dev20250211/#files</li>
<li>(Now they're back!): https://pypi.org/project/ai-edge-litert-nightly/1.1.2.dev20250216/#files</li>
</ul>
<p>We wouldn't want to accidentally lock to the version that is missing Linux ARM wheels while locking from macOS.</p>
<p>Another example:</p>
<ul>
<li>0.18 has Linux ARM wheels: https://pypi.org/project/open3d/0.18.0/</li>
<li>0.19 does not have Linux ARM wheels: https://pypi.org/project/open3d/0.19.0/#files</li>
</ul>
<p>Our current workaround is to pin versions in <code>pyproject.toml</code> after we either hit issues later (for trying to <code>poetry sync</code>  in a Linux ARM64 container on an ARM64 macOS host).</p>
<p>Being able to express our platform needs so that the resolver can make this work properly would be great.</p>
<p>I hope this feedback helps!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/uwu-420">@uwu-420</a> on 2025-02-18 09:18</div>
            <div class="timeline-body"><p>@charliermarsh Love to see this making it into the latest release, thank you ❤️
This also helps me massively at work because I can at least ensure that my team only adds packages that have wheels for <code>{x86_64, aarch64} x {linux, macos}</code>. The only thing that's missing for us is to ensure that there are wheels for macos 10.15 (for x86_64) and 11.0 (for aarch64) because these are the minimum macos versions we have to support. Related to my issue https://github.com/astral-sh/uv/issues/9837</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/trim21">@trim21</a> on 2025-02-18 13:44</div>
            <div class="timeline-body"><p>the option in PR description is not updated, it should be <code>required-environments</code> instead of <code>required-platforms</code> ...</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:41:08 UTC
    </footer>
</body>
</html>
