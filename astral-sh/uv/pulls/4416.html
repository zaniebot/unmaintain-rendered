<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add internal options for managing toolchain discovery preferences - astral-sh/uv #4416</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add internal options for managing toolchain discovery preferences</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/4416">#4416</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-06-19 16:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>Adds support for the toolchain discovery preferences outlined in <a href="https://github.com/astral-sh/uv/issues/4198">astral-sh/uv#4198</a> but we don&#x27;t expose this to users yet, I&#x27;ll do that next to make it easier to review.</p>
<p>I&#x27;ve made some refactors in the toolchain discovery implementation to enable this behavior and move us towards clearer abstractions. There&#x27;s still remaining work here, but I&#x27;d prefer tackle things in follow-ups instead of expanding this pull request. I plan on opening a couple before merging this.</p>
<p>I&#x27;d like to shift the public toolchain API to focus on discovering either an <strong>environment</strong> or a <strong>toolchain</strong>. The first would be used by commands that operate on an environment, while the latter would be used by commands that just need an interpreter to create environments. I haven&#x27;t changed this here, but some of the refactors are in preparation for supporting this idea.</p>
<p>In brief:</p>
<ul>
<li>We now allow different ordering of installed toolchain discovery based on a <code>ToolchainPreference</code> type. This is the type we will expose to users.</li>
<li><code>SystemPython</code> was changed into an <code>EnvironmentPreference</code> which is used to determine if we should prefer virtual or system Python environments.</li>
<li>We drop the whole <code>ToolchainSources</code> selection concept, it was confusing and the error messages from it were awkward. Most of the functionality is now captured by the preference enums, but you can&#x27;t do things like &quot;only find a toolchain from the parent interpreter&quot; as easily anymore.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-19 16:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Add setting for managing toolchain discovery preferences&quot; to &quot;Add internal options for managing toolchain discovery preferences&quot; by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-19 16:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-19 16:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-19 17:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/venv.rs</code>:277 on 2024-06-19 17:20</div>
            <div class="timeline-body"><p>This is less clear but will address separately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/pip_sync.rs</code>:120 on 2024-06-19 17:21</div>
            <div class="timeline-body"><p>Interesting regression... will investigate this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-19 17:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-toolchain/src/toolchain.rs</code>:49 on 2024-06-19 17:23</div>
            <div class="timeline-body"><p>This is a big plus. We don&#x27;t need to do multiple discovery attempts to get a different ordering. We just say what we want.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-19 17:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-19 17:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/pip_sync.rs</code>:120 on 2024-06-19 17:32</div>
            <div class="timeline-body"><p>These tests are not properly isolated from managed toolchains because they aren&#x27;t following our <code>TestContext</code> pattern :sigh:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-19 17:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/pip_sync.rs</code>:49 on 2024-06-19 17:34</div>
            <div class="timeline-body"><p>Addresses <a href="https://github.com/astral-sh/uv/pull/4416">astral-sh/uv#4416</a>#discussion_r1646535200</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-19 17:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-19 17:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/BurntSushi">@BurntSushi</a> by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-19 17:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-toolchain/src/toolchain.rs</code>:49 on 2024-06-20 12:40</div>
            <div class="timeline-body"><p>I like it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2024-06-20 12:41</div>
            <div class="timeline-body"><p>Nice!</p>
<p>Was this the refactor you were talking about in DMs? I know you mentioned it being exploratory, but one thing that I find can help here is to put things like type/function renames into one commit separate from the other changes. The renames can touch a lot of code and add a lot of noise to the diff. When split out, the &quot;more interesting&quot; changes can be seen in a different commit.</p>
<p>(I know this isn&#x27;t always feasible, especially in a more exploratory refactor. But I thought it might be valuable to throw it out there.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-20 13:17</div>
            <div class="timeline-body"><p>Yeah this is a part of what I was mentioning. A lot of the exploration is figuring out how to add this setting while moving the API towards something that&#x27;s easy to use correctly. I generally do try to split out renames, but yeah I didn&#x27;t do a great job of that here :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-20 13:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-20 13:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-06-20 13:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:46:01 UTC
    </footer>
</body>
</html>
