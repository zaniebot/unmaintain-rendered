<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Don't revalidate Python interpreter cache entry with `--upgrade` - astral-sh/uv #10361</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Don't revalidate Python interpreter cache entry with <code>--upgrade</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/10361">#10361</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2025-01-07 13:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/konstin">@konstin</a> on 2025-01-07 13:52</div>
            <div class="timeline-body"><p>We were always revalidating the Python interpreter cache entry when using <code>--upgrade</code>, since the cache timestamp is too recent. Instead, we ignore the usual caching semantics for packages and only compare the timestamp of the interpreter with the recorded timestamp. This avoids the cost for querying the Python interpreter, at the expense of being slightly inconsistent with <code>Cache</code> behaving different for python alone (which is imho acceptable since interpreter metadata is already different from package metadata).</p>
<p>Most of the diff is an indentation change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @konstin on 2025-01-07 13:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @konstin on 2025-01-07 13:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-python/src/interpreter.rs</code>:766 on 2025-01-07 13:54</div>
            <div class="timeline-body"><p>Don't we need to respect <code>--refresh</code> though?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-01-07 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-01-07 14:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-python/src/interpreter.rs</code>:766 on 2025-01-07 14:04</div>
            <div class="timeline-body"><p>Is <code>--refresh</code> intended to also revalidate the python interpreter querying? Querying Python is kinda costly, so I'd like to find a way to not do it unless we have, e.g. not query python with just <code>--upgrade</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-01-07 14:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-python/src/interpreter.rs</code>:766 on 2025-01-07 14:08</div>
            <div class="timeline-body"><p>Yeah. I think it's the <em>only</em> way to revalidate it, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-01-07 14:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-python/src/interpreter.rs</code>:766 on 2025-01-07 14:11</div>
            <div class="timeline-body"><p>We have the internal timestamp check, so when the file changes we revalidate. It's different from packages because python is local, so we're always performing the &quot;revalidation request&quot; by checking the timestamp on the file. Are there scenarios where the python interpreter metadata changes while the timestamp would indicate it's fresh?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-01-07 14:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-python/src/interpreter.rs</code>:766 on 2025-01-07 14:16</div>
            <div class="timeline-body"><p>I... guess not. I mean, for symlinks yes, but we already don't cache for symlinks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-01-08 08:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-python/src/interpreter.rs</code>:766 on 2025-01-08 08:34</div>
            <div class="timeline-body"><p>We could add an option to refresh python manually like <code>uv lock --upgrade --refresh-package python</code>, but i think not revalidating python by default and saving those extra 20ms is a better default.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-01-15 19:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/interpreter.rs</code>:766 on 2025-01-15 19:06</div>
            <div class="timeline-body"><p>To clarify: does this change also avoid revalidation when <code>--refresh</code> is used? Or just <code>--upgrade</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-01-15 19:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-python/src/interpreter.rs</code>:766 on 2025-01-15 19:20</div>
            <div class="timeline-body"><p>Both</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-01-15 19:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/interpreter.rs</code>:766 on 2025-01-15 19:34</div>
            <div class="timeline-body"><p>I agree that's surprising and we should continue to refresh this on <code>--refresh</code> since that's an explicit request to refresh the cache. On <code>--upgrade</code> it seems fine / better to avoid revalidation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-01-16 11:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-python/src/interpreter.rs</code>:766 on 2025-01-16 11:51</div>
            <div class="timeline-body"><p>This does not avoid revalidation with <code>--refresh</code>, since we're also revalidating the python interpreter by checking the timestamp. It does however not update if the python interpreter changes without the timestamp changing (i don't know how that would be possible except for the user manually changing timestamps, breaking our caching assumptions). This is mirroring the behavior for packages, where we're also trusting the remote with <code>If-Modified-Since</code> and only reload the full information with <code>--refresh</code> when either the revalidation request fails or the user clears the cache.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-01-16 14:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-python/src/interpreter.rs</code>:766 on 2025-01-16 14:59</div>
            <div class="timeline-body"><p>I'm confused. On main, <code>--refresh</code> will force us to re-query here always. On this branch, <code>--refresh</code> will no longer re-query here unless the timestamp has changed. So it does avoid refetching the interpreter data.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-01-16 15:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/interpreter.rs</code>:766 on 2025-01-16 15:49</div>
            <div class="timeline-body"><p>Couldn't the interpreter depend on something else that changes?</p>
<blockquote>
<p>This is mirroring the behavior for packages, where we're also trusting the remote with If-Modified-Since and only reload the full information with --refresh when either the revalidation request fails or the user clears the cache.</p>
</blockquote>
<p>I think this is a reasonable argument.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-01-16 16:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-python/src/interpreter.rs</code>:766 on 2025-01-16 16:11</div>
            <div class="timeline-body"><blockquote>
<p>Couldn't the interpreter depend on something else that changes?</p>
</blockquote>
<p>If something like that exists, it would break this PR and i'd change strategies to more aggressively invalidating the python interpreter cache instead. I'm not aware of any such cases, if you have any let me know.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-01-21 23:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/interpreter.rs</code>:766 on 2025-01-21 23:48</div>
            <div class="timeline-body"><p>Here's a great example https://github.com/astral-sh/uv/issues/10832</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-03-10 23:06</div>
            <div class="timeline-body"><p>We want an option to refresh Python interpreters when using <code>sys.path</code> or something similar for package discovery.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-03-10 23:06</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:17 UTC
    </footer>
</body>
</html>
