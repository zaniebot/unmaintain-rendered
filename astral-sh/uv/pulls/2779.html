<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exclude installed distributions with multiple versions from consideration in the resolver - astral-sh/uv #2779</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Exclude installed distributions with multiple versions from consideration in the resolver</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/2779">#2779</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-04-02 16:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-02 16:23</div>
            <div class="timeline-body"><p>Addresses panic introduced in #2596 and reported in https://github.com/astral-sh/uv/issues/2763#issuecomment-2030674936</p>
<p>When there are multiple versions of a package available, we remove the existing packages before installing the resolved version to &quot;fix&quot; the environment. We must remove all of the package versions and reinstall because removing <em>any</em> of the package versions could break the others. Since reinstalls require a pull from the remote, this broke a contract between the resolver and the planner which must always agree on which packages should come from the remote. This further demonstrates that we should be constructing the install plan with more concrete knowledge from the resolver (i.e. <code>ResolvedDist</code> instead of <code>Requirement</code>) to avoid having to manually ensure logic matches.</p>
<h2>Test plan</h2>
<p>Fails on <code>main</code> with panic succeeds on branch</p>
<pre><code>uv venv --seed
source .venv/bin/activate
pip install anyio==3.7.0 --ignore-installed
pip install anyio==4.0.0 --ignore-installed
cargo run -- pip install anyio black -v
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-04-02 16:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zanieb on 2024-04-02 16:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-02 16:30</div>
            <div class="timeline-body"><p>Investigating a unit test</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @zanieb on 2024-04-02 16:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-04-02 16:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-02 16:46</div>
            <div class="timeline-body"><p>Feel free to add a test + merge (or I can re-review if you'd like).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2024-04-02 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-04-02 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-02 17:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 14:49:26 UTC
    </footer>
</body>
</html>
