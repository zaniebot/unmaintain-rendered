<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add option pass environment variables for SDist building - astral-sh/uv #2039</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add option pass environment variables for SDist building</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/2039">#2039</a>
        opened by <a href="https://github.com/tdejager">@tdejager</a>
        on 2024-02-28 08:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tdejager">@tdejager</a></div>
            <div class="timeline-body">

Summary
<p>With this PR I&#x27;ve added the option environment variables to the wheel building process, through the <code>BuildDispatch</code>. When integrating uv with our project pixi (<a href="https://github.com/prefix-dev/pixi/pull/863">prefix-dev/pixi#863</a>). We ran into this missing requirement, I&#x27;ve made a rough version here, could maybe use some refinement.</p>
Why do we need this?
<p>Because pixi allow the user to use a conda activated prefix for wheel building, this comes with a number of environment variables, like <code>PATH</code> but also <code>CONDA_PREFIX</code> amongst others. This allows the user to use system dependencies from conda-forge to use during an sdist build. Because we use <code>uv</code> as a library we need to pass in the options programatically. Additionally, in general there is nothing holding a python sdist back from actually depending on an environment variable, see
e.g the test package: https://pypi.org/project/env-test-package/</p>
What about <code>ConfigSettings</code>
<p>I think <code>ConfigSettings</code> does not suffice because e.g. CMake could function differently when the <code>CONDA_PREFIX</code> is set. Also, we do not know if the user supplied backend actually support these settings.</p>
Path handling
<p>Because the user can now also supply a PATH in the environment map, the logic I had was the following, I format the path so that it has the following precedence</p>
<ol>
<li>venv scripts dir.</li>
<li>user supplied path.</li>
<li>system path.</li>
</ol>
Improvements
<p>There is some path modification and copying happening everytime we use the <code>run_python_script</code> function, I think we could improve this but would like some pointers where to best put the maybe split and cached version, we might also want to use some types to split these things up.</p>
Finally
<p>I did not add any of these options to the uv executables, I first would like to know if this is a direction we would want to go in. I&#x27;m happy to do this or make any changes that you feel would benefit this project.</p>
<p>Also tagging @wolfv to keep track of this as well.</p>
Test Plan


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-build/src/lib.rs</code>:874 on 2024-02-28 09:41</div>
            <div class="timeline-body"><p>Shouldn&#x27;t the caller determine the entire <code>PATH</code>? Then we also wouldn&#x27;t need to modify it and could pass it in as a reference.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-dispatch/Cargo.toml</code>:32 on 2024-02-28 09:42</div>
            <div class="timeline-body"><pre><code></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-dispatch/src/lib.rs</code>:40 on 2024-02-28 09:45</div>
            <div class="timeline-body"><p>This should be named something like <code>build_extra_env_vars</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-build/src/lib.rs</code>:920 on 2024-02-28 09:47</div>
            <div class="timeline-body"><p>Could we put the <code>.envs(environment_variables)</code> before the <code>.env(&quot;VIRTUAL_ENV&quot;, venv.root())</code> to ensure <code>VIRTUAL_ENV</code> never gets overridden?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-build/src/lib.rs</code>:336 on 2024-02-28 09:50</div>
            <div class="timeline-body"><p>Do we want the keys to be <code>String</code> or <code>OsString</code>? This kinda depends where you get them from, but if it&#x27;s from other os apis <code>OsString</code> would remove a potentially erroneous conversion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-02-28 09:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tdejager">@tdejager</a> on 2024-02-28 11:07</div>
            <div class="timeline-body"><p>Thanks @konstin I will look at the comments tomorrow, it&#x27;s my free day with the kids, they don&#x27;t allow for programming ;)</p>
<p>Thanks for the quick review!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tdejager">@tdejager</a> reviewed on 2024-02-28 11:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/tdejager">@tdejager</a> on <code>crates/uv-build/src/lib.rs</code>:874 on 2024-02-28 11:22</div>
            <div class="timeline-body"><p>Sure and you want to get the env var at the caller site as well?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tdejager">@tdejager</a> reviewed on 2024-02-28 11:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/tdejager">@tdejager</a> on <code>crates/uv-build/src/lib.rs</code>:336 on 2024-02-28 11:23</div>
            <div class="timeline-body"><p>Very good idea!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-02-28 12:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-build/src/lib.rs</code>:874 on 2024-02-28 12:19</div>
            <div class="timeline-body"><p>I hope i got this in the right order, but i&#x27;d try to get <code>PATH</code> from <code>environment_variables</code> first and then from the real env, prepend the build venv and then pass to the command so that our now computed <code>PATH</code> takes precedence over <code>.envs(environment_variables)</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rustlib</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-02-28 17:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tdejager">@tdejager</a> reviewed on 2024-02-29 10:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/tdejager">@tdejager</a> on <code>crates/uv-dispatch/src/lib.rs</code>:40 on 2024-02-29 10:22</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tdejager">@tdejager</a> reviewed on 2024-02-29 10:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/tdejager">@tdejager</a> on <code>crates/uv-build/src/lib.rs</code>:336 on 2024-02-29 10:22</div>
            <div class="timeline-body"><p>I changed this üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tdejager">@tdejager</a> reviewed on 2024-02-29 10:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/tdejager">@tdejager</a> on <code>crates/uv-build/src/lib.rs</code>:874 on 2024-02-29 10:23</div>
            <div class="timeline-body"><p>So I&#x27;ve now changed this to kreep track of the path seperately, so they are computed one and passed in by reference.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-build/src/lib.rs</code>:336 on 2024-02-29 10:24</div>
            <div class="timeline-body"><pre><code>    /// Modified PATH that contains the `venv_bin`, `user_path` and `system_path` variables in that order
</code></pre>
<p>Rust docstrings are markdown</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-02-29 10:24</div>
            <div class="timeline-body"><p>Clippy is failing, otherwise it&#x27;s ready to be merged!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tdejager">@tdejager</a> on 2024-02-29 10:27</div>
            <div class="timeline-body"><p>Last question I had @konstin is that the behavior is now that if NO path variable is set, that the venv bin is not added to the path of the python script that is run. I&#x27;m unsure if this is the correct behavior, wouldn&#x27;t you want the venv bin directory to always be added to the path?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-02-29 10:29</div>
            <div class="timeline-body"><p>The venv bin should always be added, i didn&#x27;t consider it because i never saw an environment where <code>PATH</code> was empty/unset</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tdejager">@tdejager</a> on 2024-02-29 10:29</div>
            <div class="timeline-body"><p>Okay let me change that, sure that should not happen a lot, but just to be sure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tdejager">@tdejager</a> on 2024-02-29 10:31</div>
            <div class="timeline-body"><blockquote>
<p>The venv bin should always be added, i didn&#x27;t consider it because i never saw an environment where <code>PATH</code> was empty/unset</p>
</blockquote>
<p>Should be done!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-build/src/lib.rs</code>:496 on 2024-02-29 10:50</div>
            <div class="timeline-body"><pre><code>                        .map_err(|err| {
                            Error::RequirementsInstall(&quot;setup.py build (resolve)&quot;, err)
                        })?;
</code></pre>
<p>We want to keep that message</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-02-29 10:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tdejager">@tdejager</a> reviewed on 2024-02-29 10:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/tdejager">@tdejager</a> on <code>crates/uv-build/src/lib.rs</code>:496 on 2024-02-29 10:51</div>
            <div class="timeline-body"><p>Wow, thanks, thats sloppy of me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/konstin">@konstin</a> on 2024-02-29 10:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/konstin">@konstin</a> on 2024-02-29 10:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-02-29 11:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:43:59 UTC
    </footer>
</body>
</html>
