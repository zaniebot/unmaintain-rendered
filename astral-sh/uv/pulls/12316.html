<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use `keyring --mode creds` when `authenticate = &quot;always&quot;` - astral-sh/uv #12316</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use <code>keyring --mode creds</code> when <code>authenticate = &quot;always&quot;</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/12316">#12316</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2025-03-19 16:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>Previously, we required a username to perform a fetch from the keyring because the <code>keyring</code> CLI only supported fetching password for a given service and username. Unfortunately, this is different from the keyring Python API which supported fetching a username <em>and</em> password for a given service. We can't (easily) use the Python API because we don't expect <code>keyring</code> to be installed in a specific environment during network requests. This means that we did not have parity with <code>pip</code>.</p>
<p>Way back in https://github.com/jaraco/keyring/pull/678 we got a <code>--mode creds</code> flag added to <code>keyring</code>'s CLI which supports parity with the Python API. Since <code>keyring</code> is expensive to invoke and we cannot be certain that users are on the latest version of keyring, we've not added support for invoking keyring with this flag. However, now that we have a mode that says authentication is <em>required</em> for an index (#11896), we might as well <em>try</em> to invoke keyring with <code>--mode creds</code> when there is no username. This will address use-cases where the username is non-constant and move us closer to <code>pip</code> parity.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @zanieb on 2025-03-19 16:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-19 17:00</div>
            <div class="timeline-body"><p>There's not a good place to put this in the documentation yet. I'll follow up with some changes?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-03-19 17:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:1046 on 2025-03-19 17:10</div>
            <div class="timeline-body"><p>This error added in https://github.com/astral-sh/uv/pull/12313</p>
<p>It'd be nice to match on a specific type here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @zanieb on 2025-03-19 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @jtfmumm by @zanieb on 2025-03-19 17:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-03-19 18:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-auth/src/middleware.rs</code>:1046 on 2025-03-19 18:57</div>
            <div class="timeline-body"><p>The problem is that this is in the context of the <code>reqwest_middleware::Middleware</code> trait. So <code>handle()</code> needs to return a <code>reqwest_middleware::Result&lt;Response&gt;</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-03-19 18:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:1046 on 2025-03-19 18:58</div>
            <div class="timeline-body"><p>Ah. It might not be worth it then. Thanks for looking anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-03-19 19:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-auth/src/keyring.rs</code>:143 on 2025-03-19 19:06</div>
            <div class="timeline-body"><p>You could also do:</p>
<pre><code>let username = lines.next()?;
let password = lines.next()?;
Some((username.to_string(), password.to_string()))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-03-19 19:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-auth/src/keyring.rs</code>:174 on 2025-03-19 19:11</div>
            <div class="timeline-body"><pre><code class="language-suggestion">            if service == service_name &amp;&amp; username.map_or(true, |username| username == *user)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-03-19 19:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/keyring.rs</code>:143 on 2025-03-19 19:14</div>
            <div class="timeline-body"><p>Ah that seems better ü§¶‚Äç‚ôÄÔ∏è</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-03-19 19:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/keyring.rs</code>:174 on 2025-03-19 19:15</div>
            <div class="timeline-body"><p>I don't really find <code>map_or</code> easier to reason about personally, but happy to change it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-03-19 19:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/keyring.rs</code>:143 on 2025-03-19 19:16</div>
            <div class="timeline-body"><p>A note on this section, we should probably log if we find a username but no password. This implementation makes that even easier.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-auth/src/keyring.rs</code>:143 on 2025-03-19 19:19</div>
            <div class="timeline-body"><p>Good point</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-03-19 19:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-03-19 19:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-auth/src/keyring.rs</code>:174 on 2025-03-19 19:23</div>
            <div class="timeline-body"><p>Up to you. In this case, it signals to me we're returning a <code>bool</code> with a default for <code>None</code> before reading the closure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-03-19 19:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-auth/src/keyring.rs</code>:174 on 2025-03-19 19:26</div>
            <div class="timeline-body"><p>I really just prefer it because it's shorter though</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> approved on 2025-03-19 19:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-03-19 19:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/keyring.rs</code>:174 on 2025-03-19 19:35</div>
            <div class="timeline-body"><p>Clippy actually wants <code>is_none_or</code> which is even better</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-03-19 20:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-auth/src/keyring.rs</code>:174 on 2025-03-19 20:20</div>
            <div class="timeline-body"><p>Definitely better</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2025-03-19 21:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-03-19 21:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-19 21:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:42:31 UTC
    </footer>
</body>
</html>
