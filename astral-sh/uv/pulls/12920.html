<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Properly handle authentication for 302 redirect URLs - astral-sh/uv #12920</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Properly handle authentication for 302 redirect URLs</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/12920">#12920</a>
        opened by <a href="https://github.com/jtfmumm">@jtfmumm</a>
        on 2025-04-16 15:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a></div>
            <div class="timeline-body"><p>uv was failing to authenticate on 302 redirects when credentials were available. This was because it was relying on <code>reqwest_middleware</code>'s default redirect behavior which bypasses the middleware pipeline when trying the redirect request (and hence bypasses our authentication middleware). This PR updates uv to retrigger the middleware pipeline when handling a 302 redirect, correctly using credentials from the URL, the keyring, or <code>.netrc</code>.</p>
<p>Closes #5595
Closes #11097</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @jtfmumm on 2025-04-16 15:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @jtfmumm on 2025-04-16 15:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-16 16:17</div>
            <div class="timeline-body"><p>Awesome that you added tests with a server! This makes sense to me, but we probably want another reviewer here? (@konstin) I'm not sure what the implications are.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/base_client.rs</code>:487 on 2025-04-16 21:43</div>
            <div class="timeline-body"><p>Is there a specific reason for making this a struct instead of a function call?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/base_client.rs</code>:536 on 2025-04-16 21:45</div>
            <div class="timeline-body"><p>Where does that number come from, can we import it from requests instead of defining it ourselves?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/base_client.rs</code>:534 on 2025-04-16 21:54</div>
            <div class="timeline-body"><p>A pattern I like to avoid panicking branches is a</p>
<pre><code class="language-rust">loop {
    ...
    if result.is_redirect() &amp;&amp; redirects &lt; max_redirects {
        redirects += 1;
        continue;
    } else {
        return Err(result);
    }
}
</code></pre>
<p>E.g.: https://github.com/astral-sh/uv/blob/c4fd34f0631d42d77e26667a496cc0651ba00328/crates/uv-publish/src/lib.rs#L388-L452</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/base_client.rs</code>:508 on 2025-04-16 21:57</div>
            <div class="timeline-body"><p>(*) We should avoid this unwrap with pattern matching (let-else or match)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/base_client.rs</code>:511 on 2025-04-16 22:01</div>
            <div class="timeline-body"><p>(*) Should this apply to other 30x redirect codes too, or only 302?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/base_client.rs</code>:454 on 2025-04-16 22:12</div>
            <div class="timeline-body"><p>(*) How did you decide which callers use <code>execute_with_redirect_handling</code> and which use <code>for_host</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2025-04-16 22:15</div>
            <div class="timeline-body"><p>Looks good!</p>
<p>I've added some personal taste style comments and some real review comment, i've put a star on the latter ones to differentiate.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-16 22:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/base_client.rs</code>:508 on 2025-04-16 22:22</div>
            <div class="timeline-body"><p>(generally we've very adverse to unwraps)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-04-17 06:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-client/src/base_client.rs</code>:536 on 2025-04-17 06:58</div>
            <div class="timeline-body"><p>This is the reqwest default, so I chose it because it is the number we have been implicitly using. We could make it configurable, but I thought that probably falls under YAGNI.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-04-17 07:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-client/src/base_client.rs</code>:511 on 2025-04-17 07:06</div>
            <div class="timeline-body"><p>I was trying to limit this to the proxy-redirecting case that motivated the change (in case there are other edge cases we'd have to handle). But I suppose it probably can't hurt to re-run the middleware pipeline on any redirect. Would that be your preference?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-04-17 09:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-client/src/base_client.rs</code>:454 on 2025-04-17 09:25</div>
            <div class="timeline-body"><p>I was trying to avoid covering too much of the <code>reqwest</code> surface area in this PR, but on reflection I think it is too easy to do the wrong thing when building requests (in particular, to accidentally circumvent the redirect policy). I've refactored to store <code>RedirectClientWithMiddleware</code> on <code>BaseClient</code> and to wrap <code>reqwest_middleware::RequestBuilder</code> to ensure that the configured redirect policy is applied consistently.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-04-17 09:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/base_client.rs</code>:511 on 2025-04-17 09:26</div>
            <div class="timeline-body"><p>I'd opportunistically handle all applicable redirect codes, it feels more coherent and helps users that encounter other redirect codes in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-04-17 09:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-client/src/base_client.rs</code>:487 on 2025-04-17 09:27</div>
            <div class="timeline-body"><p>See this <a href="https://github.com/astral-sh/uv/pull/12920#discussion_r2048583057">comment</a>. I had originally intended the more ambitious refactor, which is why this struct exists. I've now implemented it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @jtfmumm on 2025-04-17 13:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @jtfmumm on 2025-04-17 13:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-04-17 15:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/base_client.rs</code>:536 on 2025-04-17 15:16</div>
            <div class="timeline-body"><p>Can you add a comment that this number comes from reqwest?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-04-17 15:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-client/src/base_client.rs</code>:536 on 2025-04-17 15:33</div>
            <div class="timeline-body"><p>Added</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @jtfmumm on 2025-04-18 12:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @jtfmumm on 2025-04-18 12:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-18 12:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:42:49 UTC
    </footer>
</body>
</html>
