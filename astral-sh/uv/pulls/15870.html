<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preserve relative paths in lockfiles for flat indices - astral-sh/uv #15870</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Preserve relative paths in lockfiles for flat indices</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/pull/15870">#15870</a>
        opened by <a href="https://github.com/harshithvh">@harshithvh</a>
        on 2025-09-15 14:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harshithvh">@harshithvh</a></div>
            <div class="timeline-body">

Summary
<p>Modified <code>Source::from_index_url</code> to check the original user input and preserve relative paths when the user originally provided them.</p>
<ul>
<li>Preserves user intent for relative paths</li>
<li>Maintains backward compatibility for absolute paths</li>
</ul>
<p>fixes: #15055</p>
Test Plan
<p>added <code>lock_find_links_relative_path_preserved</code>, validates that flat indices preserve relative paths in lockfiles instead of converting them to absolute paths</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/lock.rs</code>:11275 on 2025-09-15 14:11</div>
            <div class="timeline-body"><p>We can skip this check, we already see it in the snapshot above</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-resolver/src/lock/mod.rs</code>:3576 on 2025-09-15 14:15</div>
            <div class="timeline-body"><p>I would call <code>uv_fs::normalize_path</code> here so the lockfile uses a normalized path</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2025-09-15 14:16</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/konstin">@konstin</a> on 2025-09-15 14:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harshithvh">@harshithvh</a> reviewed on 2025-09-15 17:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harshithvh">@harshithvh</a> on <code>crates/uv/tests/it/lock.rs</code>:11275 on 2025-09-15 17:23</div>
            <div class="timeline-body"><p>makes sense</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harshithvh">@harshithvh</a> on 2025-09-16 07:03</div>
            <div class="timeline-body"><p>hey @konstin
Can we close this if all looks good?
Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-09-16 07:39</div>
            <div class="timeline-body"><p>I want to give @charliermarsh a chance to look at this too, afterwards we can merge it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/konstin">@konstin</a> on 2025-09-16 07:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-09-16 13:29</div>
            <div class="timeline-body"><p>I will review today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/lock.rs</code>:11262 on 2025-09-16 14:03</div>
            <div class="timeline-body"><p>Sorry, I completely missed this: This is the part we actually want to have fixed, this is still capturing the absolute path. It seems that the change currently doesn&#x27;t actually change the test case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-09-16 14:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-09-16 14:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/tests/it/lock.rs</code>:11267 on 2025-09-16 14:03</div>
            <div class="timeline-body"><p>Notice that we already get this right (even on main). We need to apply similar logic to <code>[package.metadata]</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harshithvh">@harshithvh</a> reviewed on 2025-09-19 14:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harshithvh">@harshithvh</a> on <code>crates/uv/tests/it/lock.rs</code>:11262 on 2025-09-19 14:31</div>
            <div class="timeline-body"><p>thanks for pointing this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harshithvh">@harshithvh</a> on 2025-09-19 15:28</div>
            <div class="timeline-body"><p>@konstin, all looks good to me
mind giving a final review</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/lock.rs</code>:11239 on 2025-09-25 08:59</div>
            <div class="timeline-body"><pre><code>    let lock = fs_err::read_to_string(workspace.join(&quot;uv.lock&quot;))?;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-distribution-types/src/requirement.rs</code>:944 on 2025-09-25 08:59</div>
            <div class="timeline-body"><p>In which case does the code above fail but the logic below pass?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-distribution-types/src/requirement.rs</code>:946 on 2025-09-25 09:01</div>
            <div class="timeline-body"><p>We must not unwrap in deserialization code: Even though uv would never write something invalid, someone or something may edit the lockfile to something invalid, and we need to report an error instead of panicking.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-09-25 09:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harshithvh">@harshithvh</a> reviewed on 2025-10-31 10:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harshithvh">@harshithvh</a> on <code>crates/uv-distribution-types/src/requirement.rs</code>:944 on 2025-10-31 10:30</div>
            <div class="timeline-body"><p>Yes, itâ€™s redundant. <code>from_url_or_path</code> already accepts both valid URLs and paths; anything <code>DisplaySafeUrl::parse</code> would accept is already accepted by <code>from_url_or_path</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harshithvh">@harshithvh</a> on 2025-10-31 10:43</div>
            <div class="timeline-body"><p>hey @konstin, sorry for keeping this PR hanging. Please review the changes when you have some time</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-resolver/src/lock/mod.rs</code>:3588 on 2025-11-06 17:03</div>
            <div class="timeline-body"><p>Can you add some documentation around why we need both the <code>relative_to</code> and reading the relative path from given?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-11-06 17:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harshithvh">@harshithvh</a> reviewed on 2025-11-06 19:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harshithvh">@harshithvh</a> on <code>crates/uv-resolver/src/lock/mod.rs</code>:3588 on 2025-11-06 19:47</div>
            <div class="timeline-body"><p>added docs! Hope this helps future readers</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-11-11 14:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-resolver/src/lock/mod.rs</code>:3588 on 2025-11-11 14:39</div>
            <div class="timeline-body"><p>Sorry I still don&#x27;t follow. When they are on different drives (I assume you mean Windows drive letters, not Unix mounts?), how can the user config use a relative path?</p>
<p>Can you write a test case for this? The current test case passes with only the <code>requirement.rs</code> changes applied.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:54:00 UTC
    </footer>
</body>
</html>
