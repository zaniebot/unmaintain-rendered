<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add nextest partitioning to Windows tests - astral-sh/uv #17421</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add nextest partitioning to Windows tests</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/17421">#17421</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2026-01-12 19:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>Yet another attempt at #5714 to see if it improves CI times now that Windows test times have increased</p>
<p>I think this is worth it now</p>
<pre><code>main   (1 shard):  13m 46s
branch (2 shards): 10m 31s
branch (3 shards):  7m 34s
</code></pre>
<p>total time (a.k.a., cost increase)</p>
<pre><code>main   (1 shard):  13m 46s
branch (2 shards): 20m 18s
branch (3 shards): 21m 32s
</code></pre>
<p>As in #875, we could explore moving the build step before the sharded test runs. The build is 3m of the runtime, but I think artifact transfer and runner startup time was too expensive last time and I don't expect it to be faster. It might save a bit on CI cost, but I'm not super worried about that.</p>
<p>I chose three shards due to a reasonable reduction in per-shard runtime without a big increase in total runtime (compared to two shards). I think since half of the shard runtime is fixed build time (vs reducable test time), going up to more shards would be wasteful.</p>
<p>We use a hash-based strategy for test splitting, which means adding tests will never move tests across shards.</p>
<p>I moved <em>off</em> of the Depot runner because the &quot;checkout&quot; setup is taking <em>way</em> too long, about 120s more than the GitHub one which, once we split over multiple shards, overcomes the speed benefits of the Depot runners.</p>
<p>The downsides here are:</p>
<ol>
<li>Increased total CI time and therefore increased cost</li>
<li>GitHub runners are more expensive than Depot runners</li>
<li>Failing tests can be split across multiple shards, requiring more GitHub UI navigation</li>
</ol>
<p>(1) The runtime is unacceptably slow and I think the cost increase is fairly marginal
(2) We can move back to Depot runners once they resolve the specific performance issue
(3) Failing tests on Windows without failing tests on Linux are fairly rare and should often be isolated to a single shard</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @zanieb on 2026-01-12 19:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zanieb on 2026-01-13 14:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zsol">@zsol</a> approved on 2026-01-13 14:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>.github/workflows/test.yml</code>:143 on 2026-01-13 15:18</div>
            <div class="timeline-body"><p>Do we need to set our own cache key for windows?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2026-01-13 15:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2026-01-13 15:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2026-01-13 15:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-13 15:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.github/workflows/test.yml</code>:143 on 2026-01-13 15:22</div>
            <div class="timeline-body"><p>No, the host is included still. This just avoids the unique id from each shard being appended. (I verified this by looking at the generated cache key)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-13 15:33:32 UTC
    </footer>
</body>
</html>
