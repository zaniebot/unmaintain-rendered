<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filter out files with invalid requires python specifiers - astral-sh/uv #775</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Filter out files with invalid requires python specifiers</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/775">#775</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2024-01-04 13:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>Instead of trying to fixup <em>all</em> the invalid version specifiers on pypi and elsewhere, this filters out distributions with invalid <code>requires-python</code> version specifiers that even <code>LenientVersionSpecifiers</code> couldn't parse, as opposed to failing entirely, which we currently do.</p>
<p>I would be nicer to model through an invalid distribution pubgrub type, together with e.g. source dists with an unknown extension, so that the version itself still shows up in the error trace.</p>
<p>At the same time, we reduce the log level for fixups from warning to trace, as they are not actionable for the user.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-04 13:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-client/src/registry_client.rs</code>:477 on 2024-01-04 13:50</div>
            <div class="timeline-body"><p>Hmm, should we make this user-facing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-01-04 13:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/puffin-client/src/registry_client.rs</code>:477 on 2024-01-04 13:56</div>
            <div class="timeline-body"><p>I wouldn't because not only is there nothing the user can do (they don't control the package), but there's also nothing the package author can really do because this old metadata is immutable (unless deleting old versions, which i don't even know if it's possible). Yanking isn't an option either, the file will display as yanked but the invalid metadata will remain. Having a pubgrub tombstone would be nice though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-04 13:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-client/src/registry_client.rs</code>:477 on 2024-01-04 13:57</div>
            <div class="timeline-body"><p>My concern is that we'll now never see these (unlike today when we're being forced to fix them).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-04 13:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-client/src/registry_client.rs</code>:477 on 2024-01-04 13:57</div>
            <div class="timeline-body"><p>I'm actually not sure that we should filter them out at all, or perhaps we keep them in debug or something?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-01-04 14:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/puffin-client/src/registry_client.rs</code>:477 on 2024-01-04 14:04</div>
            <div class="timeline-body"><p>We could warn if the file is younger than let's say 6 months, so invalid requires python values are phased out.</p>
<blockquote>
<p>I'm actually not sure that we should filter them out at all, or perhaps we keep them in debug or something?</p>
</blockquote>
<p>What would you use of requires python value for those?</p>
<p>I'd like a pubgrub tombstone, it just felt like a disproportionate amount of work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-04 16:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-client/src/registry_client.rs</code>:477 on 2024-01-04 16:39</div>
            <div class="timeline-body"><p>I more mean: should we add debug assertions here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-01-04 17:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/puffin-client/src/registry_client.rs</code>:477 on 2024-01-04 17:01</div>
            <div class="timeline-body"><p>i don't think so</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-01-05 15:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/puffin-client/src/registry_client.rs</code>:477 on 2024-01-05 15:47</div>
            <div class="timeline-body"><p>I'd go even further and say we should silence the other warnings too:</p>
<pre><code>$ target/profiling/puffin pip-compile --no-cache scripts/requirements/boto3.in
warning:  Fixing invalid requirement by removing trailing comma, removing stray quotes (before: `botocore&gt;=1.3.0,&lt;1.4.0',`; after: `botocore&gt;=1.3.0,&lt;1.4.0`)
â ¼ boto3==1.2.0
</code></pre>
<p>This is not actionable on either side. I'd say it's only actionable if it's the latest version that has this kind of problem, because then releasing a new version is a fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-06 22:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-client/src/registry_client.rs</code>:477 on 2024-01-06 22:01</div>
            <div class="timeline-body"><p>I agree we should silence those</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-06 22:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-client/src/registry_client.rs</code>:477 on 2024-01-06 22:01</div>
            <div class="timeline-body"><p>But we need a way to detect these when developing. If we didn't have these errors, we never would've found any of the existing fixups.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-01-08 13:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/puffin-client/src/registry_client.rs</code>:477 on 2024-01-08 13:29</div>
            <div class="timeline-body"><p>I've set the level to <code>warn</code> for <code>cfg(debug_assertion)</code> and <code>trace</code> otherwise. I've reduced the log level for successful fixups to trace. I'll look into passing these to pubgrub later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/pypi-types/src/lenient_requirement.rs</code>:65 on 2024-01-08 18:00</div>
            <div class="timeline-body"><p>I really think this should be <code>warn</code>, even if it's not user-facing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-08 18:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-08 18:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-client/src/registry_client.rs</code>:478 on 2024-01-08 18:01</div>
            <div class="timeline-body"><p>I still feel like this should be a debug assertion, so that we fail in debug builds here. What's the downside?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-01-09 02:40</div>
            <div class="timeline-body"><p>I made them tracing warnings (not user-facing by default) just to keep this moving, let me know if you disagree.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @charliermarsh on 2024-01-09 02:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-01-09 02:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-01-09 02:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-01-09 02:46</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:35:02 UTC
    </footer>
</body>
</html>
