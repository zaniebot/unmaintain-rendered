<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deduplicate test command creation - astral-sh/uv #4512</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Deduplicate test command creation</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/4512">#4512</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2024-06-25 12:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/konstin">@konstin</a> on 2024-06-25 12:56</div>
            <div class="timeline-body"><p>This PR refactors the command creation in the test suite to remove the duplication.</p>
<p><strong>1)</strong> We add the same set of test stubbing args to almost any uv invocation in the tests:</p>
<pre><code class="language-rust">command
    .arg(&quot;--cache-dir&quot;)
    .arg(self.cache_dir.path())
    .env(&quot;VIRTUAL_ENV&quot;, self.venv.as_os_str())
    .env(&quot;UV_NO_WRAP&quot;, &quot;1&quot;)
    .env(&quot;HOME&quot;, self.home_dir.as_os_str())
    .env(&quot;UV_TOOLCHAIN_DIR&quot;, &quot;&quot;)
    .env(&quot;UV_TEST_PYTHON_PATH&quot;, &amp;self.python_path())
    .current_dir(self.temp_dir.path());

if cfg!(all(windows, debug_assertions)) {
    // TODO(konstin): Reduce stack usage in debug mode enough that the tests pass with the
    // default windows stack of 1MB
    command.env(&quot;UV_STACK_SIZE&quot;, (8 * 1024 * 1024).to_string());
}
</code></pre>
<p>Centralizing these into a <code>TestContext::add_shared_args</code> method removes them from everywhere.</p>
<p><strong>2)</strong> Prefix all <code>TextContext</code> methods of the pip interface with <code>pip_</code>. This is now necessary due to <code>uv sync</code> vs. <code>uv pip sync</code>.</p>
<p><strong>3)</strong> Move command creation in the various test files into dedicated functions or methods to avoid repeating the arguments. Except for error message tests, there should be at most one <code>Command::new(get_bin())</code> call per test file. <code>EXCLUDE_NEWER</code> is exclusively used in <code>TestContext</code>.</p>
<hr />
<p>I'm considering adding a <code>TestCommand</code> on top of these changes (in another PR) that holds a reference to the <code>TextContext</code>, has <code>add_shared_args</code> as a method and uses <code>Fn(Self) -&gt; Self</code> instead of <code>Fn(&amp;mut Self) -&gt; Self</code> for methods to improved chaining.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @konstin on 2024-06-25 12:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @konstin on 2024-06-25 12:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-25 13:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/pip_check.rs</code>:14 on 2024-06-25 13:11</div>
            <div class="timeline-body"><p>Shouldn't we just have these in the test context itself?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-25 13:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/common/mod.rs</code>:343 on 2024-06-25 13:13</div>
            <div class="timeline-body"><p>Honestly I don't think we need a dedicated method for this. People should just <code>unset_env(&quot;EXCLUDE_NEWER&quot;)</code> in the relevant tests?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-06-25 13:13</div>
            <div class="timeline-body"><p>Thank you! This was on my backlog :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-06-25 21:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/common/mod.rs</code>:343 on 2024-06-25 21:08</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/uv/issues/4531</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-06-25 21:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/pip_check.rs</code>:14 on 2024-06-25 21:10</div>
            <div class="timeline-body"><p>I feel they are fine, feel free to move them though</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2024-06-25 22:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2024-06-25 22:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-06-25 22:06</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 13:48:47 UTC
    </footer>
</body>
</html>
