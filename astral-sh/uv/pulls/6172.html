<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add support for `python_version in ...` markers - astral-sh/uv #6172</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add support for <code>python_version in ...</code> markers</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/6172">#6172</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-08-17 17:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>Closes #3683</p>
<p>Note our semantics do not exactly match the specification so we can perform algebra on the markers. See the caveats in the documentation (and in the discussion below).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @zanieb on 2024-08-17 17:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-08-17 17:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/snapshots/ecosystem__black-lock-file.snap</code>:551 on 2024-08-17 17:43</div>
            <div class="timeline-body"><p>Now that's interesting... ref #6168</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-17 17:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/tests/snapshots/ecosystem__black-lock-file.snap</code>:551 on 2024-08-17 17:45</div>
            <div class="timeline-body"><p>(My guess is that it needs to be <code>python_full_version</code> to simplify.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/snapshots/ecosystem__black-lock-file.snap</code>:551 on 2024-08-17 18:05</div>
            <div class="timeline-body"><p>Yep! Now it simplifies out entirely.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-08-17 18:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-17 19:52</div>
            <div class="timeline-body"><p>Generally looks good but will hold off on reviewing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-08-17 20:04</div>
            <div class="timeline-body"><p>Are we assuming that <code>python_full_version in &quot;3.11 3.12 3.13&quot;</code> only matches those 3 versions? Because that can technically match <code>3.1</code> as well. I think using <code>in</code> for this is pretty dubious in general, it's unfortunate that it's a pattern used by some packages. What about <code>python_full_version in &quot;3.11,3.12,3.13&quot;</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-17 20:07</div>
            <div class="timeline-body"><p>Yeah, it's tough. There's really just one package that uses this (<code>pathlib2</code>) that various people have run into. So I'd say it's ok to split on whitespace, and assume each is an exact version...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-17 21:02</div>
            <div class="timeline-body"><p>Hm yeah it gets pretty complicated if it's a true substring match. I think we should probably be relatively strict with what we support and see if more edge-cases arise?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-18 14:00</div>
            <div class="timeline-body"><p>Created https://github.com/pubgrub-rs/pubgrub/issues/249 to track better range union performance, which I left a couple TODOs about.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zanieb on 2024-08-18 14:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/pep508-rs/src/marker/tree.rs</code>:1897 on 2024-08-18 17:54</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        // Technically these is are valid substring comparison, but we do not allow them.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/pep508-rs/src/marker/tree.rs</code>:1902 on 2024-08-18 17:55</div>
            <div class="timeline-body"><p>Why is this always <code>true</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/pep508-rs/src/marker/algebra.rs</code>:613 on 2024-08-18 17:56</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// Only for use when the `key` is a `PythonVersion`. Normalizes to `PythonFullVersion`.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2024-08-18 17:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-08-18 18:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/pep508-rs/src/marker/tree.rs</code>:1902 on 2024-08-18 18:40</div>
            <div class="timeline-body"><p>Because <code>3.*</code> matches all known Python versions</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-18 18:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/pep508-rs/src/marker/tree.rs</code>:1902 on 2024-08-18 18:51</div>
            <div class="timeline-body"><p>It could be false in the future though right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2024-08-18 18:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/pep508-rs/src/marker/tree.rs</code>:1902 on 2024-08-18 18:51</div>
            <div class="timeline-body"><p>Does it? <code>python_version == '3.*'</code> simplifies to <code>python_full_version &gt;= '3' and python_full_version &lt; '4'</code> so I'm not sure why it would be different here. We aren't calling <code>simplify_python_versions</code> in this test case.</p>
<p>I suspect there is a parsing error causing it to return <code>None</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-08-18 20:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/pep508-rs/src/marker/tree.rs</code>:1902 on 2024-08-18 20:54</div>
            <div class="timeline-body"><p>Oh, I guess it's not actually a valid PEP 440 version (because it requires an operator to create the equal star).</p>
<p>Thanks — I'll update the comment accordingly. We might need to update the list to be <code>VersionSpecifier</code> instead of <code>Version</code> someday.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-18 22:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/pep508-rs/src/marker/tree.rs</code>:1902 on 2024-08-18 22:06</div>
            <div class="timeline-body"><p>Oh yeah sorry, I guess this would never be true since it's literally a string match.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> approved on 2024-08-18 23:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-08-19 02:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/pep508-rs/src/marker/tree.rs</code>:1902 on 2024-08-19 02:06</div>
            <div class="timeline-body"><p>Yeah.. we but someone could do <code>python_version in '3.10.*'</code> and that should be true sometimes since it's a substring match — anyway clearly some caveats around this implementation I'll try to make the tests clearer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-19 02:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/pep508-rs/src/marker/tree.rs</code>:1902 on 2024-08-19 02:16</div>
            <div class="timeline-body"><p>Lol true</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-08-19 10:11</div>
            <div class="timeline-body"><blockquote>
<p>Created https://github.com/pubgrub-rs/pubgrub/issues/249 to track better range union performance, which I left a couple TODOs about.</p>
</blockquote>
<p>Is this something we need for this PR (because shows up in profiles)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-19 14:04</div>
            <div class="timeline-body"><p>@konstin no, I didn't check if it has an affect on any profiles — Charlie was just concerned about the pattern (and I agree, it seems like it's probably quadratic).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2024-08-19 14:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-08-19 14:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-08-19 14:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:38:55 UTC
    </footer>
</body>
</html>
