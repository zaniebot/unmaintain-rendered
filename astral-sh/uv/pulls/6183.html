<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display the default value of `--link-mode` in help - astral-sh/uv #6183</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Display the default value of <code>--link-mode</code> in help</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/6183">#6183</a>
        opened by <a href="https://github.com/eth3lbert">@eth3lbert</a>
        on 2024-08-18 16:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/eth3lbert">@eth3lbert</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Part of #6173 .</p>
<h2>Test Plan</h2>
<p>Inspect the help output for the following commands.</p>
<p><code>cargo run pip install --help</code>
<img width="1512" alt="image" src="https://github.com/user-attachments/assets/3272ca28-ba07-4760-a33c-cc304b112050"></p>
<p><code>cargo run pip sync --help</code>
<img width="1504" alt="image" src="https://github.com/user-attachments/assets/ababcc9e-424e-459f-8855-ae10948a1b92"></p>
<p><code>cargo run pip venv --help</code>
<img width="1493" alt="image" src="https://github.com/user-attachments/assets/65042a5b-aaba-4584-9ff4-db9959fe6436"></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eth3lbert">@eth3lbert</a> on 2024-08-18 16:34</div>
            <div class="timeline-body"><p>Based on the <a href="https://github.com/astral-sh/uv/actions/runs/10442002933/job/28913829027#step:8:14394">CI failure</a></p>
<pre><code>
running 1 test
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ Snapshot Summary ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Snapshot: tool_install_version-3
Source: crates/uv/tests/tool_install.rs:306
────────────────────────────────────────────────────────────────────────────────
Expression: fs_err::read_to_string(tool_dir.join(&quot;black&quot;).join(&quot;uv-receipt.toml&quot;)).unwrap()
────────────────────────────────────────────────────────────────────────────────
-old snapshot
+new results
────────────┬───────────────────────────────────────────────────────────────────
    4     4 │     { name = &quot;blackd&quot;, install-path = &quot;[TEMP_DIR]/bin/blackd&quot; },
    5     5 │ ]
    6     6 │ 
    7     7 │ [tool.options]
    8       │-exclude-newer = &quot;2024-03-25T00:00:00Z&quot;
          8 │+exclude-newer = &quot;2024-03-25T00:00:00Z&quot;
          9 │+link-mode = &quot;hardlink&quot;
────────────┴───────────────────────────────────────────────────────────────────
</code></pre>
<p>It seems the tool receipt will record the given options. Therefore, we should only set the value when it differs from the default.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eth3lbert">@eth3lbert</a> on 2024-08-18 16:47</div>
            <div class="timeline-body"><p>Also note that the default value varies by platform. We might need some help text about this to prevent confusion when reading the cli reference on the site.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eth3lbert">@eth3lbert</a> on 2024-08-18 17:05</div>
            <div class="timeline-body"><p>I'm not sure how we should handle the snapshot of cli references, as the output depends on the platform it's generated on. :sweat_smile:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-19 14:22</div>
            <div class="timeline-body"><p>Lots of complications to consider here! I'm glad you just started with one option. We're going to be focused on 0.3.0 for a bit here — but after that I can try to help with the CLI reference guide and the snapshots. @charliermarsh is also going to need to take a look regarding the <code>.then_some</code> pattern, I'm not sure what implications this has for our tracking of settings in general.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eth3lbert">@eth3lbert</a> on 2024-08-19 14:57</div>
            <div class="timeline-body"><p>Or perhaps for this kind of platform-dependent default value, it would be better to display something similar to the CLI reference?  e.g.</p>
<pre><code class="language-shell-session">      --link-mode &lt;LINK_MODE&gt;                  The method to use when installing packages from the global cache. Defaults to `clone` (also known as Copy-on-Write) on macOS, and `hardlink` on Linux and
                                               Windows [env: UV_LINK_MODE=] [possible values: clone, copy, hardlink, symlink]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-19 15:48</div>
            <div class="timeline-body"><p>I think it's okay to show the default value per-platform in the CLI help menu, but yeah we'll want show both in the reference documentation — sounds complicated. Might be easier to always show them both for the sake of snapshots — but hopefully it's only a small amount of snapshots that actually include the help menu and we can just use filters...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eth3lbert">@eth3lbert</a> on 2024-08-20 01:26</div>
            <div class="timeline-body"><p>Based on the CI feedback, resetting only for <code>ToolOptions</code> seems more correct. Now, it only fails on cli references :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eth3lbert">@eth3lbert</a> on 2024-08-20 09:33</div>
            <div class="timeline-body"><p>I also noticed that we could implement the <code>Display</code> for <code>LinkMode</code> to allow setting the default value via <code>default_value = LinkMode::default().to_string()</code>. This way, we wouldn't need to change the type. Both approaches would set the value to the default if it's not provided.</p>
<blockquote>
<p>Might be easier to always show them both for the sake of snapshots — but hopefully it's only a small amount of snapshots that actually include the help menu and we can just use filters...</p>
</blockquote>
<p>Or we could add it (and other options whose doc already shows more descriptive information about the default value) to a group like <code>doc-hide-default</code>, which indicates that we don't want this to be displayed in the cli reference and allows us to omit this default value during generation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-28 01:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-cli/src/lib.rs</code>:2004 on 2024-08-28 01:38</div>
            <div class="timeline-body"><p>I think we can't do this because we need to know if the value is provided on the CLI <em>at all</em>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/eth3lbert">@eth3lbert</a> reviewed on 2024-08-29 08:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/eth3lbert">@eth3lbert</a> on <code>crates/uv-cli/src/lib.rs</code>:2004 on 2024-08-29 08:25</div>
            <div class="timeline-body"><p>Ok, I think the best approach is to use the <code>value_source</code> to determine where the value is being set. Then, if the source is not from the command line, we can simply reset it to <code>None</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/eth3lbert">@eth3lbert</a> on <code>crates/uv-cli/src/lib.rs</code>:2004 on 2024-08-30 09:45</div>
            <div class="timeline-body"><p>Another simpler but trickier approach would be to leverage non-printable characters.</p>
<p>Consider the following:</p>
<pre><code class="language-rust">#[derive(Clone, Debug)]
pub enum MaybeGiven&lt;T&gt; {
    Default(T),
    Given(T),
}

impl&lt;T: Default&gt; Default for MaybeGiven&lt;T&gt; {
    fn default() -&gt; Self {
        Self::Default(T::default())
    }
}

impl&lt;T&gt; MaybeGiven&lt;T&gt; {
    pub fn into_given(self) -&gt; Option&lt;T&gt; {
        match self {
            MaybeGiven::Default(_) =&gt; None,
            MaybeGiven::Given(x) =&gt; Some(x),
        }
    }

    pub fn into_inner(self) -&gt; T {
        match self {
            MaybeGiven::Default(x) =&gt; x,
            MaybeGiven::Given(x) =&gt; x,
        }
    }
}

impl&lt;T&gt; AsRef&lt;T&gt; for MaybeGiven&lt;T&gt; {
    fn as_ref(&amp;self) -&gt; &amp;T {
        match self {
            MaybeGiven::Default(x) =&gt; x,
            MaybeGiven::Given(x) =&gt; x,
        }
    }
}

impl&lt;T: Display&gt; Display for MaybeGiven&lt;T&gt; {
    fn fmt(&amp;self, f: &amp;mut std::fmt::Formatter&lt;'_&gt;) -&gt; std::fmt::Result {
        if matches!(self, MaybeGiven::Default(_)) {
            f.write_str(&quot;\0&quot;)?;
            self.as_ref().fmt(f)?;
            f.write_str(&quot;\0&quot;)
        } else {
            self.as_ref().fmt(f)
        }
    }
}

impl&lt;T: FromStr&gt; FromStr for MaybeGiven&lt;T&gt; {
    type Err = T::Err;

    fn from_str(s: &amp;str) -&gt; Result&lt;Self, Self::Err&gt; {
        let trimmed = s.trim_matches('\0');
        if trimmed != s {
            return Ok(Self::Default(T::from_str(trimmed)?));
        }
        Ok(Self::Given(T::from_str(s)?))
    }
}
</code></pre>
<p>It checks if the string is surrounded by '\0' to determine whether it is from the default value or given by the user. This is a more hacky but simpler implementation without modifying the existing codebase too much, IMO.</p>
<p>If this is considered too hacky, I could implement it by checking the <code>value_source</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/eth3lbert">@eth3lbert</a> reviewed on 2024-08-30 09:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-30 12:42</div>
            <div class="timeline-body"><p>As more reference, I had to undo the default value in https://github.com/astral-sh/uv/pull/6835</p>
<p>We don't have access to <code>ArgMatches</code>, though maybe we could refactor things so we do.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eth3lbert">@eth3lbert</a> on 2024-08-30 17:10</div>
            <div class="timeline-body"><blockquote>
<p>As more reference, I had to undo the default value in #6835</p>
<p>We don't have access to <code>ArgMatches</code>, though maybe we could refactor things so we do.</p>
</blockquote>
<p>I guess the following should work:</p>
<pre><code class="language-diff">diff --git a/crates/uv/src/lib.rs b/crates/uv/src/lib.rs
index 080ed988..c5426578 100644
--- a/crates/uv/src/lib.rs
+++ b/crates/uv/src/lib.rs
@@ -1265,0 +1267,15 @@ async fn run_project(
+fn get_given_args(matches: &amp;clap::ArgMatches) -&gt; std::collections::HashSet&lt;&amp;clap::Id&gt; {
+    let mut args = matches;
+    while let Some((_sub_cmd, sub_args)) = args.subcommand() {
+        args = sub_args;
+    }
+    args.ids()
+        .filter(|id| {
+            !matches!(
+                args.value_source(id.as_str()),
+                Some(clap::parser::ValueSource::DefaultValue)
+            )
+        })
+        .collect()
+}
+
@@ -1278,3 +1294,6 @@ where
-    // `std::env::args` is not `Send` so we parse before passing to our runtime
-    // https://github.com/rust-lang/rust/pull/48005
-    let cli = match Cli::try_parse_from(args) {
+    let cmd = Cli::command();
+    let matches = cmd.get_matches_from(args);
+    let cli = match clap::FromArgMatches::from_arg_matches(&amp;matches) {
+        // `std::env::args` is not `Send` so we parse before passing to our runtime
+        // https://github.com/rust-lang/rust/pull/48005
+        // let cli = match Cli::try_parse_from(args) {
</code></pre>
<p>This should not alter the way uv currently parses arguments but provide us with the ability to retrieve given arguments from <code>ArgMatches</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-09 22:35</div>
            <div class="timeline-body"><p>I think we may just need to keep this as documentation and not as a structured Clap default. As-is (in this PR) it's incorrect in the generated reference too, since it's dynamic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-10-09 22:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-09 22:35</div>
            <div class="timeline-body"><p>I'm going to close for now but let me know if you want to follow-up in some way. Thank you for your work here.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:38:56 UTC
    </footer>
</body>
</html>
