<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update virtual environment removal to delete `pyvenv.cfg` last - astral-sh/uv #14808</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Update virtual environment removal to delete <code>pyvenv.cfg</code> last</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/14808">#14808</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2025-07-22 11:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-22 11:21</div>
            <div class="timeline-body"><p>An alternative to https://github.com/astral-sh/uv/pull/14569</p>
<p>This isn't a complete solution to https://github.com/astral-sh/uv/issues/13986, in the sense that it's still &quot;fatal&quot; to <code>uv sync</code> if we fail to delete an environment, but I think that's okay â€” deferring deletion is much more complicated. This at least doesn't break users once the deletion fails. The downside is we'll generally treat this virtual environment is valid, even if we nuked a bunch of it.</p>
<p>Closes https://github.com/astral-sh/uv/issues/13986</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2025-07-22 11:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/geofft">@geofft</a> on 2025-07-22 13:07</div>
            <div class="timeline-body"><p>If the motivation here is failing to delete Scripts\python.exe, would it be better to try to delete that one first as opposed to deleting pyvenv.cfg last?</p>
<p>Mostly I worry that Scripts\python.exe + pyvenv.cfg is enough to make a valid virtual environment IIRC (as in Python will start up), but it's a broken one if we've deleted everything else, and <em>especially</em> if there's stuff running in the background that might get weird. If the first thing we do is delete Scripts\python.exe and it fails, then we've left the venv unmodified.</p>
<p>(But this PR still seems like an improvement over the status quo so this is not an objection.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-22 13:12</div>
            <div class="timeline-body"><blockquote>
<p>If the motivation here is failing to delete Scripts\python.exe, would it be better to try to delete that one first as opposed to deleting pyvenv.cfg last?</p>
</blockquote>
<p>I think that's reasonable too, I'd probably do both? The thing with deleting <code>python.exe</code> is we probably want to use a deferred deletion, like we do for the <code>uv.exe</code> so I think the approach is a little different.</p>
<p>Any of these executables could be locked, so we're sort of playing whackamole by deleting things first. I think <code>python.exe</code> is a good special-case though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2025-07-22 13:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2025-07-22 13:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-07-22 13:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-22 13:13</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:28 UTC
    </footer>
</body>
</html>
