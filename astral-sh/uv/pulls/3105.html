<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update the credentials cache to use an async mutex - astral-sh/uv #3105</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Update the credentials cache to use an async mutex</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/3105">#3105</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-04-17 19:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-17 19:12</div>
            <div class="timeline-body"><p>It seems wrong to use a sync mutex in an async context without strong justification. We're probably unnecessarily blocking the event loop.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @zanieb on 2024-04-17 19:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @zanieb on 2024-04-17 19:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-17 19:35</div>
            <div class="timeline-body"><p>I think this actually isn't recommended unless you need to hold the mutex across await points: https://docs.rs/tokio/latest/tokio/sync/struct.Mutex.html#which-kind-of-mutex-should-you-use</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-17 19:38</div>
            <div class="timeline-body"><p>(I was surprised to learn this.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-17 19:42</div>
            <div class="timeline-body"><p>Oh interesting... that... kind of makes sense but idk? It's hard to grok when you have a bunch of async requests going through the middleware at the same time. It's fine for one of the requests to block the entire async thread waiting for a mutex? Weird.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">do-not-merge</span> added by @zanieb on 2024-04-17 21:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-18 04:08</div>
            <div class="timeline-body"><p>@BurntSushi do you have more knowledge here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-04-18 13:01</div>
            <div class="timeline-body"><p>Not particularly. But the advice from tokio's docs makes sense. Maybe another way to conceptualize this is that I believe it's <em>always</em> correct to use an async mutex, but it's <em>not</em> always correct to use a std mutex. Maybe think of a std mutex as an optimization. You just really want to avoid holding it over an await boundary. And indeed, it could wind up blocking the whole thread if it's highly contended. But at that point, I'd classify it as a perf bug, async or not.</p>
<p>I also think the last bit of the tokio docs is crucially important:</p>
<blockquote>
<p>Additionally, when you do want shared access to an IO resource, it is often better to spawn a task to manage the IO resource, and to use message passing to communicate with that task.</p>
</blockquote>
<p>In other words, I'd treat the use of an async mutex as somewhat niche. I'd try to take a more CSP (Communicating Sequential Processes) approach to the problem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-04-18 13:03</div>
            <div class="timeline-body"><p>For this PR, it looks like the use of a std mutex is okay? The tip-off is that it looks like your routines aren't doing any I/O and weren't previously async (because you needed to add <code>async fn</code> in order to use an async mutex).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-04-19 21:04</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 14:43:51 UTC
    </footer>
</body>
</html>
