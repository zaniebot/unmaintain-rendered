<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redact credentials when displaying URLs - astral-sh/uv #13333</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Redact credentials when displaying URLs</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/13333">#13333</a>
        opened by <a href="https://github.com/jtfmumm">@jtfmumm</a>
        on 2025-05-07 16:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a></div>
            <div class="timeline-body"><p>This PR redacts credentials in displayed URLs.</p>
<p>It mostly relies on a <code>redacted_url</code> function (and where possible <code>IndexUrl::redacted</code>). This is a quick way to prevent leaked credentials but it&#x27;s prone to programmer error when adding new trace statements. A better follow-on would use a <code>RedactedUrl</code> type with the appropriate <code>Display</code> implementation. This would allow us to still extract credentials from the URL while displaying it securely. On the plus side, the sites where the <code>redacted_url</code> function are used serve as easy signposts for where to use the new type in a future PR.</p>
<p>Closes #1714.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-05-07 16:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/cache.rs</code>:97 on 2025-05-07 16:50</div>
            <div class="timeline-body"><p>I think this should all happen in the <code>trace!</code> macro, so that it doesn&#x27;t run at all unless <code>trace!</code> is enabled (extremely rare).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-05-07 16:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/lib.rs</code>:34 on 2025-05-07 16:51</div>
            <div class="timeline-body"><p>Same here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-05-07 16:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/reporters.rs</code>:304 on 2025-05-07 16:51</div>
            <div class="timeline-body"><p>Why not move this to the use site, like line 320/322?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-05-07 16:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv/src/commands/reporters.rs</code>:304 on 2025-05-07 16:53</div>
            <div class="timeline-body"><p>The idea is to make it more unlikely for future changes to use the <code>Url</code> with credentials. The places I didn&#x27;t do this were where we were also potentially using the credentials from the <code>Url</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-auth/src/cache.rs</code>:97 on 2025-05-07 17:00</div>
            <div class="timeline-body"><p>I can update to use the trace sites. The thinking was that this made it more unlikely a developer would accidentally leak credentials if adding a future trace.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-05-07 17:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/jtfmumm">@jtfmumm</a> on 2025-05-07 18:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by <a href="https://github.com/jtfmumm">@jtfmumm</a> on 2025-05-07 18:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/cache.rs</code>:97 on 2025-05-07 20:20</div>
            <div class="timeline-body"><p>But does this mean we also need to redact when we <em>insert</em>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-05-07 20:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-05-07 21:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-auth/src/cache.rs</code>:97 on 2025-05-07 21:51</div>
            <div class="timeline-body"><p>Yes, it looks like I was only handling the insert into <code>CREDENTIALS_CACHE</code> before. Updated. I&#x27;m going to add a test for this case since I would have expected it to break.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-05-07 22:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/credentials.rs</code>:329 on 2025-05-07 22:21</div>
            <div class="timeline-body"><p>I&#x27;m actually a little more worried about this as a footgun (versus the need to repeatedly call <code>redacted</code> in the <code>tracing</code> macros). I think we should either remove this gating (always redact), or move the <code>redacted_url</code> calls into the <code>tracing</code> macros.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-05-09 07:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-auth/src/credentials.rs</code>:329 on 2025-05-09 07:13</div>
            <div class="timeline-body"><p>Ok, I lean toward removing this and always redacting. I will be doing a follow-up using the type system where the redaction will only happen on <code>Display</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-auth/src/credentials.rs</code>:329 on 2025-05-09 07:22</div>
            <div class="timeline-body"><p>Removed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-05-09 07:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-05-09 21:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/credentials.rs</code>:329 on 2025-05-09 21:24</div>
            <div class="timeline-body"><p>It looks like this isn&#x27;t removed, did you need to push still?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-05-09 21:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-auth/src/credentials.rs</code>:329 on 2025-05-09 21:53</div>
            <div class="timeline-body"><p>Pushed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-git-types/src/lib.rs</code>:179 on 2025-05-10 14:43</div>
            <div class="timeline-body"><p>As a nit, I personally find this easier to read with early returns:</p>
<pre><code>/// Return a version of the URL with redacted credentials, allowing the generic `git` username (without a password)
/// in SSH URLs, as in, `ssh://git@github.com/...`.
pub fn redacted_url(url: &amp;Url) -&gt; Cow&lt;&#x27;_, Url&gt; {
    if url.username().is_empty() &amp;&amp; url.password().is_none() {
        return Cow::Borrowed(url);
    }
    if url.scheme() == &quot;ssh&quot; &amp;&amp; url.username() == &quot;git&quot; &amp;&amp; url.password().is_none() {
        return Cow::Borrowed(url);
    }

    let mut url = url.clone();
    if url.password().is_some() {
        let _ = url.set_password(Some(&quot;****&quot;));
    } else if url.username() != &quot;&quot; {
        // A username on its own might be a secret token.
        let _ = url.set_username(&quot;****&quot;);
    }
    Cow::Owned(url)
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-git-types/src/lib.rs</code>:177 on 2025-05-10 14:46</div>
            <div class="timeline-body"><p>It&#x27;s a little confusing that half of our redact methods remove the credentials entirely, and then half replace them with stars. It&#x27;s also a little strange (though may not matter in practice) that we&#x27;re using this version for the cache key, so like the cache key path now includes these stars?</p>
<p>It might be nice to use a different name for these methods that replace with stars vs. those that remove the credentials entirely (like <code>sensitive</code> vs. <code>redact</code> or <code>without_credentials</code> or something).</p>
<p>Or just drop the stars entirely and match the existing redact logic for consistency for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2025-05-10 14:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-05-11 12:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-git-types/src/lib.rs</code>:179 on 2025-05-11 12:24</div>
            <div class="timeline-body"><p>Changed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-05-11 12:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-git-types/src/lib.rs</code>:177 on 2025-05-11 12:49</div>
            <div class="timeline-body"><p>It can be helpful to have the stars when debugging but we can defer this decision until after this PR (on <code>main</code> we do it in some places and not others). The follow-up PR will put this decision in one place. To move this PR forward, I&#x27;ve removed the masking from <code>redacted_url</code> and dropped the stars there.</p>
<p>I&#x27;ve also removed all uses from <code>uv-auth</code> (including around the credentials cache). As a result, I&#x27;ve moved <code>redacted_url</code> out of <code>uv-auth</code> and into a new <code>uv-redacted</code> crate. This means we continue to rely on the existing mechanisms for redacting credentials there. This should help move the PR forward and is still a strict improvement.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-05-12 15:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-git-types/src/lib.rs</code>:177 on 2025-05-12 15:34</div>
            <div class="timeline-body"><p>Agreed! Can definitely be helpful, mostly just pointing out that there are two different behaviors using the same terminology and we probably need to be thoughtful about which we use at each site (e.g., <code>***</code> for anything in tracing; omitted entirely for anything persisted, like the lockfile).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-12 15:34</div>
            <div class="timeline-body"><p>(Seems fine to merge.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/jtfmumm">@jtfmumm</a> on 2025-05-12 16:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/jtfmumm">@jtfmumm</a> on 2025-05-12 16:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-05-12 16:58</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:52:07 UTC
    </footer>
</body>
</html>
