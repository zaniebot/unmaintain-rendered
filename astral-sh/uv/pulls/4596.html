<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improve toolchain and environment missing error messages - astral-sh/uv #4596</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Improve toolchain and environment missing error messages</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/4596">#4596</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-06-27 18:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>The journey here can be seen in:</p>
<ul>
<li>#4587</li>
<li>#4589</li>
<li>#4594</li>
</ul>
<p>I collapsed all the commits here because only the last one in the stack got us to a &quot;correct&quot; error message.</p>
<p>There are a few architectural changes:</p>
<ul>
<li>We have a dedicated <code>MissingEnvironment</code> and <code>EnvironmentNotFound</code> type for <code>PythonEnvironment::find</code> allowing different error messages when searching for environments</li>
<li><code>ToolchainNotFound</code> becomes a struct with the <code>ToolchainRequest</code> which greatly simplifies missing toolchain error formatting</li>
<li><code>ToolchainNotFound</code> tracks the <code>EnvironmentPreference</code> so it can accurately report the locations checked</li>
</ul>
<p>The messages look like this now, instead of the bland (and often incorrect): &quot;No Python interpreter found in system toolchains&quot;.</p>
<pre><code>‚ùØ cargo run -q -- pip sync requirements.txt
error: No virtual environment found
‚ùØ UV_TEST_PYTHON_PATH=&quot;&quot; cargo run -q -- pip sync requirements.txt --system
error: No system environment found
‚ùØ UV_TEST_PYTHON_PATH=&quot;&quot; cargo run -q -- pip sync requirements.txt --python 3.12
error: No virtual environment found for Python 3.12
‚ùØ UV_TEST_PYTHON_PATH=&quot;&quot; cargo run -q -- pip sync requirements.txt --python 3.12 --system
error: No system environment found for Python 3.12
‚ùØ UV_TEST_PYTHON_PATH=&quot;&quot; cargo run -q -- toolchain find 3.12 --preview
error: No toolchain found for Python 3.12 in system path
‚ùØ UV_TEST_PYTHON_PATH=&quot;&quot; cargo run -q -- pip compile requirements.in
error: No toolchain found in virtual environments or system path
</code></pre>
<p>I'd like to follow this with hints, suggesting creating an environment or using system in some cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">error messages</span> added by @zanieb on 2024-06-27 18:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-27 18:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-toolchain/src/discovery.rs</code>:120 on 2024-06-27 18:33</div>
            <div class="timeline-body"><p>The enum is now a struct which contains the <code>ToolchainRequest</code> instead of de-structuring the request here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-27 18:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-toolchain/src/discovery.rs</code>:136 on 2024-06-27 18:34</div>
            <div class="timeline-body"><p>We lose the ability to distinguish between these cases in error messages, but I don't think it's particularly critical.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zanieb on 2024-06-27 18:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @zanieb on 2024-06-27 19:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @zanieb on 2024-06-27 19:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-27 21:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/tests/venv.rs</code>:267 on 2024-06-27 21:32</div>
            <div class="timeline-body"><p>What are your thoughts on &quot;toolchain&quot; as user-facing copy vs. interpreter? I feel like interpreter is more familiar to folks but seeing that you proactively changed it here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-27 21:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-toolchain/src/discovery.rs</code>:136 on 2024-06-27 21:34</div>
            <div class="timeline-body"><p>By &quot;these cases&quot;, do you mean file vs. directory vs. executable?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-toolchain/src/discovery.rs</code>:136 on 2024-06-27 21:36</div>
            <div class="timeline-body"><p>Specifically whether its a missing directory or a missing executable in the directory. We'll always raise the latter now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-27 21:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-27 21:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-toolchain/src/discovery.rs</code>:1502 on 2024-06-27 21:36</div>
            <div class="timeline-body"><p>Would this be &quot;virtual environments or managed or system toolchains&quot;? I feel like it should be Oxford comma'd but I know that's tedious...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-27 21:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-toolchain/src/discovery.rs</code>:136 on 2024-06-27 21:36</div>
            <div class="timeline-body"><p>It would also be harder to encode things like &quot;this exists but is not an executable&quot; in the future. In practice, I don't think we were even using the variant right now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-06-27 21:37</div>
            <div class="timeline-body"><p>So the basic idea here is that rather than creating a <code>ToolchainNotFound</code> variant, we base the error message on the request itself? Makes sense to me.</p>
<p>What <code>ToolchainRequest</code> was being returned such that I saw that &quot;error: No Python interpreters found in system toolchains&quot; message in my <code>ruff-lsp</code> PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/venv.rs</code>:267 on 2024-06-27 21:38</div>
            <div class="timeline-body"><p>I'm not sure, but I'd like to be consistent. We're going to talk about managed toolchains a lot going forward so I think we might want to move in that direction.</p>
<p>A nuance is that we look for an interpreter in order to discover a toolchain. I guess that leans towards using &quot;interpreter&quot; here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-27 21:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-27 21:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-toolchain/src/discovery.rs</code>:1502 on 2024-06-27 21:39</div>
            <div class="timeline-body"><p>üò¨ I know right. I considered doing an extra match to fix this.... but I didn't have it in me. Think it's worth it? I might want to construct a test covering this so I know it matters if I do it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-27 21:43</div>
            <div class="timeline-body"><blockquote>
<p>So the basic idea here is that rather than creating a ToolchainNotFound variant, we base the error message on the request itself? Makes sense to me.</p>
</blockquote>
<p>Yep, though that kind of just fell out of me making some other changes to actually propagate the information for correct error messages.</p>
<blockquote>
<p>What ToolchainRequest was being returned such that I saw that &quot;error: No Python interpreters found in system toolchains&quot; message in my ruff-lsp PR?</p>
</blockquote>
<p>This was because the <code>ToolchainNotFound</code> didn't track <code>EnvironmentPreference</code> so when constructing the error message  we only had the <code>ToolchainPreference</code> and did something dumb. In your case, it was probably <code>ToolchainRequest::Any</code>, <code>EnvironmentPreference::ExplicitSystem</code>, and <code>ToolchainPreference::OnlySystem</code> (because we don't allow mutation of managed toolchains).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-06-28 11:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv/tests/venv.rs</code>:267 on 2024-06-28 12:08</div>
            <div class="timeline-body"><p>I weakly prefer interpreter I think. It seems likely to land better with Python users. But the inconsistency with using &quot;toolchain&quot; in written docs does seem unfortunate. How crazy would it be to switch to &quot;interpreter&quot; everywhere?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2024-06-28 12:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/venv.rs</code>:267 on 2024-06-28 14:57</div>
            <div class="timeline-body"><p>Well.. I talked about that in the initial design and @konstin did clarify that there's much more than the interpreter involved e.g. the managed toolchains include the standard library.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-28 14:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-28 14:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/venv.rs</code>:267 on 2024-06-28 14:57</div>
            <div class="timeline-body"><p>For this change, I'll use &quot;interpreter&quot; because I want to get these changes out asap.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-06-28 15:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv/tests/venv.rs</code>:267 on 2024-06-28 15:02</div>
            <div class="timeline-body"><p>Ah yeah I hear ya. If y'all already dug into the naming here then I defer to you. :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-28 15:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/venv.rs</code>:267 on 2024-06-28 15:09</div>
            <div class="timeline-body"><p>I have yet to be convinced that &quot;toolchain&quot; is the best user-facing concept :) we should all chat more.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2024-06-28 15:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-06-28 15:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-06-28 15:17</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:37:46 UTC
    </footer>
</body>
</html>
