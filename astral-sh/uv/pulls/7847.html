<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accept `git+` prefix in `tool.uv.sources` - astral-sh/uv #7847</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Accept <code>git+</code> prefix in <code>tool.uv.sources</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/7847">#7847</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-10-01 15:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>Right now, this fails, because we later try to do <code>git+git+https://...</code>. It seems nice to have this &quot;just work&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-01 15:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-01 15:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-01 16:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-01 16:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-10-01 16:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/salty-horse">@salty-horse</a> on 2024-10-06 11:17</div>
            <div class="timeline-body"><p>This change meant that uv 0.4.18 can&#x27;t <code>sync --frozen</code> from a lock file created with 0.4.17.</p>
<p>I don&#x27;t know if backwards compatibility is desired at this point, but mentioning it just in case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-06 15:38</div>
            <div class="timeline-body"><p>Do you mind sharing a brief reproduction?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-06 15:39</div>
            <div class="timeline-body"><p>(We use minor versions for breaking changes so this wasn’t intended to be breaking!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/salty-horse">@salty-horse</a> on 2024-10-06 16:26</div>
            <div class="timeline-body"><p>The important thing is to run <code>uv cache clean</code>. Otherwise, it won&#x27;t attempt to re-fetch the repository from the URL that&#x27;s in a format it no longer understands.</p>
<p>I used this on a random repository. It will work with anything you have git access to.</p>
<pre><code>$ cat pyproject.toml 
[project]
name = &quot;project&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = [
	&quot;apns2&quot;,
]

[tool.uv.sources]
apns2 = {git = &quot;git+ssh://git@github.com/salty-horse/PyAPNs2.git&quot;, rev = &quot;httpx_cert_auth&quot;}

$ curl -LsSf https://astral.sh/uv/0.4.17/install.sh | sh
$ uv --version
uv 0.4.17
$ rm -rf .venv
$ uv sync
# Worked successfully. Important bit:
#  + apns2==0.7.5 (from git+git+ssh://github.com/salty-horse/PyAPNs2.git@9ce3e36a8bbed52e5e48d66ce2fe80eee0b9f702)

$ curl -LsSf https://astral.sh/uv/0.4.18/install.sh | sh
$ uv --version
uv 0.4.18
$ rm -rf .venv
$ uv cache clean
$ uv sync --frozen
[...]
Creating virtual environment at: .venv
Updating git+ssh://github.com/salty-horse/PyAPNs2.git (httpx_cert_auth)                                                                                                                                                                       error: Failed to prepare distributions
  Caused by: Failed to fetch wheel: apns2 @ git+git+ssh://github.com/salty-horse/PyAPNs2.git@9ce3e36a8bbed52e5e48d66ce2fe80eee0b9f702
  Caused by: Git operation failed
  Caused by: failed to clone into: /home/ori/.cache/uv/git-v0/db/a4d58569fd76b658
  Caused by: failed to fetch commit `9ce3e36a8bbed52e5e48d66ce2fe80eee0b9f702`
  Caused by: process didn&#x27;t exit successfully: `git fetch --force --update-head-ok &#x27;git+ssh://github.com/salty-horse/PyAPNs2.git&#x27; &#x27;+9ce3e36a8bbed52e5e48d66ce2fe80eee0b9f702:refs/commit/9ce3e36a8bbed52e5e48d66ce2fe80eee0b9f702&#x27;` (exit status: 128)
--- stderr
ori@github.com: Permission denied (publickey).
fatal: Could not read from remote repository.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-06 16:46</div>
            <div class="timeline-body"><p>Thanks! I don’t understand why this worked in the 0.4.17 case — that was the whole point of the commit hah. I must’ve overlooked something. I’ll look into it when I’m back from vacation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/salty-horse">@salty-horse</a> on 2024-10-06 16:55</div>
            <div class="timeline-body"><p>I may be commenting on the wrong PR :flushed: - it seemed relevant.</p>
<p>The patch seems to handle the URLs in <code>pyproject.toml</code>, but the issue is with the URLs in <code>uv.lock</code>.</p>
<p>The old version recorded the URL with <code>git+</code> in <code>uv.lock</code>:</p>
<pre><code>source = { git = &quot;git+ssh://git@github.com/
</code></pre>
<p>The newer version records it without <code>git+</code>:</p>
<pre><code>source = { git = &quot;ssh://git@github.com/
</code></pre>
<p>So when it reads the file from the old version, it assumes <code>git+</code> isn&#x27;t there, and adds it, which causes problems down the line. It should check before adding the prefix.</p>
<p>Enjoy your vacation!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-09 08:44</div>
            <div class="timeline-body"><p>Ahh ok, I think I understand. Prior to that change, we allowed <code>source = { git = &quot;git+ssh://git@github.com/...&quot; }</code> but errored on <code>source = { git = &quot;https+ssh://git@github.com/...&quot; }</code>. So this likely was subtly breaking for <code>git+ssh</code> usages.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/salty-horse">@salty-horse</a> on 2024-10-14 09:13</div>
            <div class="timeline-body"><p>Should I open a new issue about the regression?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:48:34 UTC
    </footer>
</body>
</html>
