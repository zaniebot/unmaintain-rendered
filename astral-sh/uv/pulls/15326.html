<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document improvements to build-isolation setups - astral-sh/uv #15326</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Document improvements to build-isolation setups</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/15326">#15326</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2025-08-16 15:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-16 15:51</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>There's a lot here (maybe it should go somewhere else?), but this is a complex topic and I wanted to include a lot of copy-pasteable examples for common cases.</p>
<p>Closes https://github.com/astral-sh/uv/issues/10694.
Closes https://github.com/astral-sh/uv/issues/13959.
Closes https://github.com/astral-sh/uv/issues/15248.
Closes https://github.com/astral-sh/uv/issues/15316.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> added by @charliermarsh on 2025-08-16 15:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @charliermarsh on 2025-08-16 16:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2025-08-16 16:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/vwxyzjn">@vwxyzjn</a> on <code>docs/concepts/projects/config.md</code>:296 on 2025-08-16 17:50</div>
            <div class="timeline-body"><p>This doesn't work:</p>
<pre><code>ubuntu@costa-dev-worker-0:~/code/thirdparty/test_uv$ cat pyproject.toml
[project]
name = &quot;project&quot;
version = &quot;0.1.0&quot;
description = &quot;...&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = [&quot;flash-attn&quot;, &quot;torch&quot;]

[tool.uv.extra-build-dependencies]
flash-attn = [{ dependencies = [&quot;torch&quot;], match-runtime = true }]

[tool.uv.extra-build-variables]
flash-attn = { FLASH_ATTENTION_SKIP_CUDA_BUILD = &quot;TRUE&quot; }
ubuntu@costa-dev-worker-0:~/code/thirdparty/test_uv$ uv sync
warning: Failed to parse `pyproject.toml` during settings discovery:
  TOML parse error at line 10, column 14
     |
  10 | flash-attn = [{ dependencies = [&quot;torch&quot;], match-runtime = true }]
     |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  data did not match any variant of untagged enum ExtraBuildDependencyWire

error: Failed to parse: `pyproject.toml`
  Caused by: TOML parse error at line 10, column 14
   |
10 | flash-attn = [{ dependencies = [&quot;torch&quot;], match-runtime = true }]
   |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
data did not match any variant of untagged enum ExtraBuildDependencyWire
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/vwxyzjn">@vwxyzjn</a> reviewed on 2025-08-16 17:51</div>
            <div class="timeline-body"><p>Love the examples! The flash attention one doesn't work, but I tested deep_ep and deep_gemm which all works!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-08-16 21:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>docs/concepts/projects/config.md</code>:296 on 2025-08-16 21:40</div>
            <div class="timeline-body"><p>Oh thank you for trying this, thereâ€™s a typo ðŸ˜©</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vwxyzjn">@vwxyzjn</a> on 2025-08-16 22:40</div>
            <div class="timeline-body"><p>I have put a minimal repro here: https://github.com/vwxyzjn/minimal-uv-deep-ep-gemm-installation/tree/main</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2025-08-18 21:15</div>
            <div class="timeline-body"><p>I have some minor edits and, as you said, we probably want to find a better home for all this content, but let's just get this in and iterate from there since it's so important.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2025-08-18 21:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-08-18 21:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-18 21:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tobiasdiez">@tobiasdiez</a> on 2025-08-19 02:03</div>
            <div class="timeline-body"><p>These are very nice improvements. Thanks a lot for everyone that worked on this!</p>
<p>Another use case of &quot;no-build-isolation&quot; of the main project is that some build backends (like python-meson) allow to recompile files on the fly in editable installs. For this to work, naturally the build dependencies of the main project need to be available also at runtime. (More details at https://github.com/astral-sh/uv/issues/10694#issuecomment-2874835809)
It's not clear to me if those recent changes cover this use case as well. One still needs to create an &quot;extra&quot; for the build dependencies, duplicating what is already in <code>build-system.requires</code>, and then use <code>uv sync --extra build</code>, right? Or is there a way to sync the build requirements of the main project without duplicating them to an extra?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-19 09:25</div>
            <div class="timeline-body"><p>Thanks @tobiasdiez! I can take a look and add some documentation for that. Can you give me a minimal <code>pyproject.toml</code> + a set of commands to reproduce, for testing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zsol">@zsol</a> on <code>docs/concepts/projects/config.md</code>:326 on 2025-08-20 10:12</div>
            <div class="timeline-body"><p>This is a typo</p>
<pre><code class="language-suggestion">that changes to these settings will trigger a reinstall and rebuild of the affected packages.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zsol">@zsol</a> reviewed on 2025-08-20 10:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-08-20 10:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>docs/concepts/projects/config.md</code>:326 on 2025-08-20 10:36</div>
            <div class="timeline-body"><p>PR!!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zsol">@zsol</a> reviewed on 2025-08-20 11:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zsol">@zsol</a> on <code>docs/concepts/projects/config.md</code>:326 on 2025-08-20 11:07</div>
            <div class="timeline-body"><p>#15390</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tobiasdiez">@tobiasdiez</a> reviewed on 2025-09-13 00:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/tobiasdiez">@tobiasdiez</a> on <code>docs/concepts/projects/config.md</code>:259 on 2025-09-13 00:16</div>
            <div class="timeline-body"><p>Does this also ensure that the package annotated with <code>match-runtime = true</code> will only be built once? So in the example below (assuming that torch wouldn't ship wheels), would torch be built once as the build dependency of deepspeed and then another time to be installed in the main env? Or does uv cache the built of torch and reuses it?</p>
<p>I hope it is cached - in this case, <code>match-runtime</code> might be also a very useful option to set for packages that take a long time to build. I can open a PR to add this if wished.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tobiasdiez">@tobiasdiez</a> on 2025-09-13 01:14</div>
            <div class="timeline-body"><blockquote>
<p>Thanks @tobiasdiez! I can take a look and add some documentation for that. Can you give me a minimal <code>pyproject.toml</code> + a set of commands to reproduce, for testing?</p>
</blockquote>
<p>Sorry for taking so long to come back to you. Here is an example <code>pyproject.toml</code> that shows the problem:</p>
<pre><code>[project]
name = &quot;test&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = []
[build-system]
build-backend = 'mesonpy'
requires = [&quot;cython&gt;=3.1.3&quot;, &quot;meson-python&gt;=0.18.0&quot;]
</code></pre>
<p>This is just what you get with <code>uv init</code> plus adding the meson-python as a build backend. To run <code>uv sync</code> you also need a simple <code>meson.build</code>, say</p>
<pre><code>project(
  'test',
  ['c', 'cpp', 'cython'],
  meson_version: '&gt;=1.2',
)

py_module = import('python')
py = py_module.find_installation(pure: false)

py.install_sources(
  'main.py',
)
</code></pre>
<p>In a real application you would now actually use cython to compile an extension etc, but for the sake of having a simple example let's ignore that.</p>
<p>After <code>uv sync</code> the package is installed in editable mode, and in particular you have a file <code>.venv\Lib\site-packages\_test_editable_loader.py</code> which intercepts all imports and rebuilds the project if necessary. This means you need to have the build dependencies also installed at runtime. This is however not the case currently if you run <code>uv sync</code>.</p>
<p>Current workaround is:</p>
<pre><code>uv pip install meson-python cython
uv sync --no-build-isolation
</code></pre>
<p>So it's similar to the problems discussed in this PR, but the difference is that the <code>no-build-isolation</code> concerns the main project and not one of its dependencies.</p>
<p>Let me know if this is sufficient to understand the problem, or if you would prefer to have a full example that actually compiles something etc.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tobiasdiez">@tobiasdiez</a> on 2025-12-22 12:01</div>
            <div class="timeline-body"><p>@charliermarsh Do you have any update on how to use build isolation for the main project? We have migrated a few projects to meson recently, and every single one of them faces the problem that one has to manually install meson-python+cython using <code>uv pip</code>.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 05:52:27 UTC
    </footer>
</body>
</html>
