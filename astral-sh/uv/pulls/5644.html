<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use intersection rather than union for `requires-python` - astral-sh/uv #5644</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use intersection rather than union for `requires-python`</h1>

    <div class="meta">
        <span class="state state-closed">Closed</span>
        <a href="https://github.com/astral-sh/uv/pull/5644">#5644</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-07-31 00:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-31 00:10</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>As-is, if you have a workspace with mixed <code>requires-python</code> requirements, resolution will <em>never</em> succeed, since we'll use the union as the <code>requires-python</code> bound (i.e., take the lowest value), and fail when we see the package that only supports some more narrow range.</p>
<p>This PR modifies the behavior to take the intersection (i.e., the highest value), so if you have one package that supports Python 3.12 and later, and another that supports Python 3.8 and later, we lock for Python 3.12. If you try to sync or run with Python 3.8, we raise an error, since the lockfile will be incompatible with that request.</p>
<p>Konsti has a write-up in https://github.com/astral-sh/uv/issues/5594 that outlines what could be a longer-term strategy.</p>
<p>Closes https://github.com/astral-sh/uv/issues/5578.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-07-31 00:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @charliermarsh on 2024-07-31 00:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2024-07-31 00:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2024-07-31 00:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @charliermarsh on 2024-07-31 00:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-07-31 00:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/mod.rs</code>:104 on 2024-07-31 00:13</div>
            <div class="timeline-body"><p>We can warn here, if people feel strongly. I'm not sure that we should, though, since users will see it <em>every</em> time without any way to resolve it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-07-31 00:18</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/uv/branches/charlie/min-requires-python">CodSpeed Performance Report</a></h2>
<h3>Merging #5644 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>charlie/min-requires-python</code> (1566081) with <code>main</code> (8d14a4c)</sub></p>
<h3>Summary</h3>
<p><code>✅ 13</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-07-31 02:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/sync.rs</code>:358 on 2024-07-31 08:03</div>
            <div class="timeline-body"><p>We should add a specific error message for this case that tells you how to run something on 3.8 with only bird-feeder.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-07-31 08:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-07-31 08:04</div>
            <div class="timeline-body"><p>Those codspeed numbers are dubious</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-07-31 14:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/tests/sync.rs</code>:358 on 2024-07-31 14:33</div>
            <div class="timeline-body"><p>@konstin  -- What's the recommended workflow? Can we even support it right now?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-07-31 14:50</div>
            <div class="timeline-body"><p>I just tried the following project layout:</p>
<pre><code>.
├── packages
│   ├── bar
│   │   ├── pyproject.toml
│   │   └── src
│   │       └── bar
│   │           └── __init__.py
│   └── foo_lib
│       ├── pyproject.toml
│       └── src
│           └── foo_lib
│               └── __init__.py
├── pyproject.toml
├── README.md
└── uv.lock
</code></pre>
<p>bar:</p>
<pre><code class="language-toml">[project]
name = &quot;bar&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = []

[build-system]
requires = [&quot;hatchling&quot;]
build-backend = &quot;hatchling.build&quot;
</code></pre>
<p>foo_lib:</p>
<pre><code class="language-toml">[project]
name = &quot;foo-lib&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.8&quot;
dependencies = []

[build-system]
requires = [&quot;hatchling&quot;]
build-backend = &quot;hatchling.build&quot;
</code></pre>
<p>When trying to <code>uv lock</code>, i get:</p>
<pre><code>Using Python 3.12.1
  × No solution found when resolving dependencies:
  ╰─▶ Because the requested Python version (&gt;=3.8) does not satisfy Python&gt;=3.12 and bar==0.1.0
      depends on Python&gt;=3.12, we can conclude that bar==0.1.0 cannot be used.
      And because only bar==0.1.0 is available and you require bar, we can conclude that the
      requirements are unsatisfiable.

      hint: The `requires-python` value (&gt;=3.8) includes Python versions that are not supported by
      your dependencies (e.g., bar==0.1.0 only supports &gt;=3.12). Consider using a more restrictive
      `requires-python` value (like &gt;=3.12).
</code></pre>
<p>It seems that the PR currently forces the same requires-python across the workspace.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-07-31 14:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/sync.rs</code>:358 on 2024-07-31 14:51</div>
            <div class="timeline-body"><p>I'd say we check if the request version is in the union, but not in the intersection, and if so, recommend <code>uv pip install -p 3.8 -e . &lt;older-python-version-project&gt;</code>, which <em>should</em> work, i can test this after https://github.com/astral-sh/uv/pull/5644#issuecomment-2260706514</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-31 14:56</div>
            <div class="timeline-body"><p>You must be running from <code>main</code>? It works fine for me on this PR, I just replicated it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-31 14:57</div>
            <div class="timeline-body"><pre><code class="language-toml">version = 1
requires-python = &quot;&gt;=3.12&quot;

[[distribution]]
name = &quot;bar&quot;
version = &quot;0.1.0&quot;
source = { editable = &quot;packages/bar&quot; }

[[distribution]]
name = &quot;foo-lib&quot;
version = &quot;0.1.0&quot;
source = { editable = &quot;packages/foo_lib&quot; }

[[distribution]]
name = &quot;root&quot;
version = &quot;0.1.0&quot;
source = { editable = &quot;.&quot; }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-07-31 15:01</div>
            <div class="timeline-body"><p>Right branch but it was using <code>uv lock</code>, not <code>cargo run lock</code> :no_mouth: With this branch it actually works</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-07-31 15:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/tests/sync.rs</code>:358 on 2024-07-31 15:02</div>
            <div class="timeline-body"><p>Yes, works.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-31 15:02</div>
            <div class="timeline-body"><p>Haha yeah. That's the exact problem this was designed to fix :joy:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-07-31 15:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/sync.rs</code>:358 on 2024-07-31 15:02</div>
            <div class="timeline-body"><p>Now i checked the right way and <code>cargo run venv -p 3.8 &amp;&amp; cargo run pip install -e packages/foo_lib/</code> indeed works.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-07-31 15:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/tests/sync.rs</code>:358 on 2024-07-31 15:18</div>
            <div class="timeline-body"><p>Will do separately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-07-31 16:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-07-31 16:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-31 16:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/5662.html">astral-sh/uv#5662</a> on 2024-07-31 16:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kasramozafari9-collab">@kasramozafari9-collab</a> on 2025-12-09 14:16</div>
            <div class="timeline-body"><p>Kasra app</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kasramozafari9-collab">@kasramozafari9-collab</a> reviewed on 2025-12-09 14:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/kasramozafari9-collab">@kasramozafari9-collab</a> on <code>crates/uv/tests/sync.rs</code>:358 on 2025-12-09 14:17</div>
            <div class="timeline-body"><p>Kasra app</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kasramozafari9-collab">@kasramozafari9-collab</a> reviewed on 2025-12-09 14:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/kasramozafari9-collab">@kasramozafari9-collab</a> on <code>crates/uv/tests/sync.rs</code>:358 on 2025-12-09 14:17</div>
            <div class="timeline-body"><p>Kasra app</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:35:06 UTC
    </footer>
</body>
</html>
