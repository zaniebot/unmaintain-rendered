<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Isolate test environment from user configuration - astral-sh/uv #17456</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Isolate test environment from user configuration</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/pull/17456">#17456</a>
        opened by <a href="https://github.com/gaborbernat">@gaborbernat</a>
        on 2026-01-14 00:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gaborbernat">@gaborbernat</a></div>
            <div class="timeline-body"><p>Isolates the test environment from user-specific configuration that can cause test failures:</p>
<ul>
<li><p><strong>Internal package mirrors</strong>: Remove <code>UV_INDEX_URL</code>, <code>UV_EXTRA_INDEX_URL</code>, <code>UV_PYTHON_INSTALL_MIRROR</code>, and <code>UV_INSTALLER_GHE_BASE_URL</code> from test environment to ensure tests use public PyPI instead of internal mirrors that may lack upload date metadata</p>
</li>
<li><p><strong>User config files</strong>: Set <code>XDG_CONFIG_HOME</code> in <code>with_real_home()</code> to prevent tests from reading user configuration files (like <code>.python-version</code>) that could override test-specified Python versions</p>
</li>
<li><p><strong>Documentation</strong>: Add guidance to CONTRIBUTING.md for developers behind corporate firewalls that block access to external test services like <code>pypi-proxy.fly.dev</code></p>
</li>
</ul>
<p>These were the one that I noticed and were a blocker for me to work on https://github.com/astral-sh/uv/pull/14728</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-14 01:33</div>
            <div class="timeline-body"><p>Overlaps with #14080</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>CONTRIBUTING.md</code>:102 on 2026-01-14 11:05</div>
            <div class="timeline-body"><p>There are many other tests than just <code>native-auth</code> which can fail if there's no clear internet connection but this (along with the example directly following it) reads a bit like an implication that only <code>native-auth</code> tests are affected.</p>
<p>I would suggest:</p>
<p>Mention that many tests need network access, in some cases access is needed to services which are beyond pypi etc, e.g. <code>pypi-proxy.fly.dev</code> etc. And explain that if you have a network configuration which causes some of tests to fail, and you wish to skip those tests locally, you can run tests without certain features (e.g. <code>native-auth</code>), or use nextest <a href="https://nexte.st/docs/filtersets/">filtersets</a> to filter out specific tests.</p>
<p>I think that would be sufficient for this section.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>CONTRIBUTING.md</code>:122 on 2026-01-14 11:10</div>
            <div class="timeline-body"><p>I appreciate the effort to be helpful but it seems a little beyond the scope of this document to explain (in a potentially fragile - e.g. if the firewall/proxy is configured weird - way) how to check for firewall/proxy restrictions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>CONTRIBUTING.md</code>:96 on 2026-01-14 11:14</div>
            <div class="timeline-body"><p>I would just rename this to &quot;Tests which require the network&quot; (and ditto any referneces specifically to the scenario of a corporate firewall) as the problem is broader than just corporate firewalls and proxies. Some people may just want to run the tests in an offline environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/tests/it/common/mod.rs</code>:1044 on 2026-01-14 11:26</div>
            <div class="timeline-body"><p>I think for now let's drop this since, as mentioned already by @zanieb, #14080 will cover this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/tests/it/common/mod.rs</code>:1536 on 2026-01-14 11:28</div>
            <div class="timeline-body"><p>Would this be necessary with #14080? I think if <code>$HOME</code> is set and <code>$XDG_CONFIG_HOME</code> is unset then the whole problem will be avoided?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2026-01-14 11:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gaborbernat">@gaborbernat</a> reviewed on 2026-01-14 13:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on <code>CONTRIBUTING.md</code>:102 on 2026-01-14 13:03</div>
            <div class="timeline-body"><p>Fwiw fly.dev is especially sensitive as it allows hosting any code, so likely other corporate firewalls also ban it as opposed to other network requests (seems an easy place to host viruses and such ðŸ¤” so in practice I think worth calling it out specifically).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gaborbernat">@gaborbernat</a> reviewed on 2026-01-14 13:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on <code>CONTRIBUTING.md</code>:102 on 2026-01-14 13:03</div>
            <div class="timeline-body"><p>Fwiw fly.dev is especially sensitive as it allows hosting any code, so likely other corporate firewalls also ban it as opposed to other network requests (seems an easy place to host viruses and such ðŸ¤” so in practice I think worth calling it out specifically).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2026-01-14 13:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>CONTRIBUTING.md</code>:102 on 2026-01-14 13:06</div>
            <div class="timeline-body"><p>Yes I don't object to mentioning it, I just think the section shouldn't be entirely oriented around it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gaborbernat">@gaborbernat</a> reviewed on 2026-01-14 13:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on <code>crates/uv/tests/it/common/mod.rs</code>:1536 on 2026-01-14 13:10</div>
            <div class="timeline-body"><p>Didn't test it, so not sure as that pr is not merged yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-14 13:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>CONTRIBUTING.md</code>:102 on 2026-01-14 13:27</div>
            <div class="timeline-body"><p>We also hit fly.dev outside of native authentication tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>CONTRIBUTING.md</code>:102 on 2026-01-14 13:28</div>
            <div class="timeline-body"><p>We could add a <code>fly-proxy</code> feature like we have for other tests which interact with a remote service</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-14 13:28</div>
            <div class="timeline-body"></div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-14 13:34:49 UTC
    </footer>
</body>
</html>
