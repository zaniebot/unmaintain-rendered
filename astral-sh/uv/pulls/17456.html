<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Isolate test environment from user configuration and remove redundant env_remove calls - astral-sh/uv #17456</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Isolate test environment from user configuration and remove redundant env_remove calls</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/pull/17456">#17456</a>
        opened by <a href="https://github.com/gaborbernat">@gaborbernat</a>
        on 2026-01-14 00:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gaborbernat">@gaborbernat</a></div>
            <div class="timeline-body"><p>Isolates the test environment from user-specific configuration that can cause test failures:</p>
<h2>User config isolation in <code>with_real_home()</code></h2>
<p>The <code>with_real_home()</code> method sets <code>HOME</code> to the real home directory, which is required for tests that use the macOS keychain for authentication. However, this causes a problem: when <code>HOME</code> is set but <code>XDG_CONFIG_HOME</code> is not, uv resolves the config directory to <code>$HOME/.config/uv</code> per the XDG specification. This means tests would read the user's real configuration files (like <code>.python-version</code> or <code>uv.toml</code>), which can override test-specified settings and cause failures.</p>
<p>This PR sets <code>XDG_CONFIG_HOME</code> to the test's isolated config directory in <code>with_real_home()</code>, ensuring that even when the real HOME is needed for keychain access, configuration files are read from an isolated location.</p>
<h2>Removed redundant <code>env_remove</code> calls</h2>
<p>With #14080 merged, <code>TestContext::new_command_with()</code> now automatically clears all environment variables defined in <code>EnvVars::all_names()</code>. This makes the following explicit <code>env_remove</code> calls redundant:</p>
<ul>
<li><code>UV_CACHE_DIR</code> - test cache directory isolation</li>
<li><code>UV_TOOL_BIN_DIR</code> - tool binary directory isolation</li>
<li><code>XDG_CONFIG_HOME</code> - config directory isolation</li>
<li><code>UV_INDEX_URL</code> - package index override</li>
<li><code>UV_EXTRA_INDEX_URL</code> - extra package index override</li>
<li><code>UV_PYTHON_INSTALL_MIRROR</code> - Python installation mirror override</li>
<li><code>UV_INSTALLER_GHE_BASE_URL</code> - GitHub Enterprise installer URL override</li>
</ul>
<p>These were previously added to ensure tests use public PyPI and isolated directories, but are now handled automatically by #14080.</p>
<h2>Documentation for network-dependent tests</h2>
<p>Adds guidance to CONTRIBUTING.md for developers running tests in offline environments, behind corporate firewalls, or on VPNs that block access to external test services like <code>pypi-proxy.fly.dev</code>. Documents how to skip network-dependent tests locally using nextest filtersets or by disabling features like <code>native-auth</code>.</p>
<hr />
<p>These were blockers for me to work on https://github.com/astral-sh/uv/pull/14728</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-14 01:33</div>
            <div class="timeline-body"><p>Overlaps with #14080</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>CONTRIBUTING.md</code>:102 on 2026-01-14 11:05</div>
            <div class="timeline-body"><p>There are many other tests than just <code>native-auth</code> which can fail if there's no clear internet connection but this (along with the example directly following it) reads a bit like an implication that only <code>native-auth</code> tests are affected.</p>
<p>I would suggest:</p>
<p>Mention that many tests need network access, in some cases access is needed to services which are beyond pypi etc, e.g. <code>pypi-proxy.fly.dev</code> etc. And explain that if you have a network configuration which causes some of tests to fail, and you wish to skip those tests locally, you can run tests without certain features (e.g. <code>native-auth</code>), or use nextest <a href="https://nexte.st/docs/filtersets/">filtersets</a> to filter out specific tests.</p>
<p>I think that would be sufficient for this section.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>CONTRIBUTING.md</code>:122 on 2026-01-14 11:10</div>
            <div class="timeline-body"><p>I appreciate the effort to be helpful but it seems a little beyond the scope of this document to explain (in a potentially fragile - e.g. if the firewall/proxy is configured weird - way) how to check for firewall/proxy restrictions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>CONTRIBUTING.md</code>:96 on 2026-01-14 11:14</div>
            <div class="timeline-body"><p>I would just rename this to &quot;Tests which require the network&quot; (and ditto any referneces specifically to the scenario of a corporate firewall) as the problem is broader than just corporate firewalls and proxies. Some people may just want to run the tests in an offline environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/tests/it/common/mod.rs</code>:1044 on 2026-01-14 11:26</div>
            <div class="timeline-body"><p>I think for now let's drop this since, as mentioned already by @zanieb, #14080 will cover this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/tests/it/common/mod.rs</code>:1530 on 2026-01-14 11:28</div>
            <div class="timeline-body"><p>Would this be necessary with #14080? I think if <code>$HOME</code> is set and <code>$XDG_CONFIG_HOME</code> is unset then the whole problem will be avoided?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2026-01-14 11:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gaborbernat">@gaborbernat</a> reviewed on 2026-01-14 13:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on <code>CONTRIBUTING.md</code>:102 on 2026-01-14 13:03</div>
            <div class="timeline-body"><p>Fwiw fly.dev is especially sensitive as it allows hosting any code, so likely other corporate firewalls also ban it as opposed to other network requests (seems an easy place to host viruses and such ðŸ¤” so in practice I think worth calling it out specifically).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gaborbernat">@gaborbernat</a> reviewed on 2026-01-14 13:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on <code>CONTRIBUTING.md</code>:102 on 2026-01-14 13:03</div>
            <div class="timeline-body"><p>Fwiw fly.dev is especially sensitive as it allows hosting any code, so likely other corporate firewalls also ban it as opposed to other network requests (seems an easy place to host viruses and such ðŸ¤” so in practice I think worth calling it out specifically).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2026-01-14 13:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>CONTRIBUTING.md</code>:102 on 2026-01-14 13:06</div>
            <div class="timeline-body"><p>Yes I don't object to mentioning it, I just think the section shouldn't be entirely oriented around it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gaborbernat">@gaborbernat</a> reviewed on 2026-01-14 13:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on <code>crates/uv/tests/it/common/mod.rs</code>:1530 on 2026-01-14 13:10</div>
            <div class="timeline-body"><p>Didn't test it, so not sure as that pr is not merged yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-14 13:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>CONTRIBUTING.md</code>:102 on 2026-01-14 13:27</div>
            <div class="timeline-body"><p>We also hit fly.dev outside of native authentication tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>CONTRIBUTING.md</code>:102 on 2026-01-14 13:28</div>
            <div class="timeline-body"><p>We could add a <code>fly-proxy</code> feature like we have for other tests which interact with a remote service</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-14 13:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2026-01-16 10:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/common/mod.rs</code>:1044 on 2026-01-16 10:00</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/uv/pull/14080 is now merged.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Isolate test environment from user configuration" to "Isolate test environment from user configuration and remove redundant env_remove calls" by @gaborbernat on 2026-01-16 15:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gaborbernat">@gaborbernat</a> reviewed on 2026-01-16 15:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on <code>CONTRIBUTING.md</code>:102 on 2026-01-16 15:07</div>
            <div class="timeline-body"><p>Addressed ðŸ˜Š</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gaborbernat">@gaborbernat</a> reviewed on 2026-01-16 15:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on <code>CONTRIBUTING.md</code>:122 on 2026-01-16 15:07</div>
            <div class="timeline-body"><p>Addressed ðŸ˜Š</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gaborbernat">@gaborbernat</a> reviewed on 2026-01-16 15:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on <code>CONTRIBUTING.md</code>:96 on 2026-01-16 15:07</div>
            <div class="timeline-body"><p>Addressed ðŸ˜Š</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gaborbernat">@gaborbernat</a> reviewed on 2026-01-16 15:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on <code>crates/uv/tests/it/common/mod.rs</code>:1044 on 2026-01-16 15:07</div>
            <div class="timeline-body"><p>Addressed ðŸ˜Š</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gaborbernat">@gaborbernat</a> reviewed on 2026-01-16 15:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on <code>crates/uv/tests/it/common/mod.rs</code>:1530 on 2026-01-16 15:07</div>
            <div class="timeline-body"><p>Addressed ðŸ˜Š</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @gaborbernat on 2026-01-16 15:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @gaborbernat on 2026-01-16 15:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @EliteTK by @gaborbernat on 2026-01-16 15:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @konstin on 2026-01-19 10:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @konstin removed by @konstin on 2026-01-19 10:40</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-19 11:22:51 UTC
    </footer>
</body>
</html>
