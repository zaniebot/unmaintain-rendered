<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avoid storing absolute URLs for files - astral-sh/uv #944</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Avoid storing absolute URLs for files</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/944">#944</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-01-16 22:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-16 22:32</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>It turns out that storing an absolute URL for every file caused a significant performance regression. This PR attempts to address the regression with two changes.</p>
<p>The first is that we now store the raw string if the URL is an absolute URL. If the URL is relative, we store the base URL alongside the raw relative string. As such, we avoid serializing and deserializing URLs until we need them (later on), except for the base URL.</p>
<p>The second is that we now use the internal <code>Url</code> crate methods for serializing and deserializing. If you look inside <code>Url</code>, its standard serializer and deserialization actually convert it to a string, then parse the string. But the crate exposes some other methods for faster serialization and deserialization (with fewer guarantees). I think this is totally fine since the cache is entirely internal.</p>
<p>If we <em>just</em> change the <code>Url</code> serialization (and no other code -- so continue to store URLs for every file), then the regression goes down to about 5%:</p>
<pre><code class="language-shell">❯ python -m scripts.bench \
        --puffin-path ./target/release/main \
        --puffin-path ./target/release/relative --puffin-path ./target/release/puffin \
        scripts/requirements/home-assistant.in --benchmark resolve-warm
Benchmark 1: ./target/release/main (resolve-warm)
  Time (mean ± σ):     496.3 ms ±   4.3 ms    [User: 452.4 ms, System: 175.5 ms]
  Range (min … max):   487.3 ms … 502.4 ms    10 runs

Benchmark 2: ./target/release/relative (resolve-warm)
  Time (mean ± σ):     284.8 ms ±   2.1 ms    [User: 245.8 ms, System: 165.6 ms]
  Range (min … max):   280.3 ms … 288.0 ms    10 runs

Benchmark 3: ./target/release/puffin (resolve-warm)
  Time (mean ± σ):     300.4 ms ±   3.2 ms    [User: 255.5 ms, System: 178.1 ms]
  Range (min … max):   295.4 ms … 305.1 ms    10 runs

Summary
  './target/release/relative (resolve-warm)' ran
    1.05 ± 0.01 times faster than './target/release/puffin (resolve-warm)'
    1.74 ± 0.02 times faster than './target/release/main (resolve-warm)'
</code></pre>
<p>So I considered <em>just</em> making that change. But 5% is kind of borderline...</p>
<p>With both of these changes, the regression is down to 1-2%:</p>
<pre><code>Benchmark 1: ./target/release/relative (resolve-warm)
  Time (mean ± σ):     282.6 ms ±   7.4 ms    [User: 244.6 ms, System: 181.3 ms]
  Range (min … max):   275.1 ms … 318.5 ms    30 runs

Benchmark 2: ./target/release/puffin (resolve-warm)
  Time (mean ± σ):     286.8 ms ±   2.2 ms    [User: 247.0 ms, System: 169.1 ms]
  Range (min … max):   282.3 ms … 290.7 ms    30 runs

Summary
  './target/release/relative (resolve-warm)' ran
    1.01 ± 0.03 times faster than './target/release/puffin (resolve-warm)'
</code></pre>
<p>It's consistently ~2%-ish, but at this point it's unclear if that's due to the URL change or something other change between now and then.</p>
<p>Closes #943.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @charliermarsh on 2024-01-16 22:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2024-01-16 22:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @charliermarsh on 2024-01-16 22:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-16 22:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/distribution-types/src/lib.rs</code>:731 on 2024-01-16 22:33</div>
            <div class="timeline-body"><p>It's perhaps worth noting that these are called very infrequently... You have to have distributions without any hashes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-01-17 08:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2024-01-17 13:15</div>
            <div class="timeline-body"><p>I think this LGTM.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-01-17 14:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-01-17 14:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-01-17 14:15</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 15:39:25 UTC
    </footer>
</body>
</html>
