<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lock the credentials store when reading or writing - astral-sh/uv #15610</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Lock the credentials store when reading or writing</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/15610">#15610</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2025-08-31 17:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-31 17:05</div>
            <div class="timeline-body"><p>Adds locking of the credentials store for concurrency safety. It's important to hold the lock from read -&gt; write so credentials are not dropped during concurrent writes.</p>
<p>I opted not to attach the lock to the store itself. Instead, I return the lock on read and require it on write to encourage safe use. Maybe attaching the source path to the store struct and adding a <code>lock(&amp;self)</code> method would make sense? but then you can forget to take the lock at the right time. The main problem with the interface here is to write a <em>new</em> store you have to take the lock yourself, and you could make a mistake by taking a lock for the wrong path or something. The fix for that would be to introduce a new <code>CredentialStoreHandle</code> type or something, but that seems overzealous rn. We also don't eagerly drop the lock on token read, although we could.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @zanieb on 2025-08-31 17:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zanieb on 2025-08-31 20:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2025-09-02 12:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-09-02 12:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-09-02 12:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 06:38:45 UTC
    </footer>
</body>
</html>
