<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Gitlab CI/CD as a trusted publisher - astral-sh/uv #15583</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Support Gitlab CI/CD as a trusted publisher</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/15583">#15583</a>
        opened by <a href="https://github.com/harsh-ps-2003">@harsh-ps-2003</a>
        on 2025-08-29 17:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/harsh-ps-2003">@harsh-ps-2003</a> on 2025-08-29 17:08</div>
            <div class="timeline-body"><p><code>uv publish</code> now supports GitLab CI as a Trusted Publishing provider.</p>
<p>Closes #12754</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @konstin on 2025-08-29 17:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @woodruffw by @konstin on 2025-08-29 17:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @konstin on 2025-08-29 17:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @konstin by @konstin on 2025-08-29 17:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-static/src/env_vars.rs</code>:630 on 2025-08-29 18:02</div>
            <div class="timeline-body"><p>I don't believe this will work, unfortunately -- both <code>CI_JOB_JWT</code> and <code>CI_JOB_JWT_V2</code> are deprecated, and neither will work with Trusted Publishing on PyPI because they lack the appropriate <code>aud</code> claim (i.e. <code>pypi</code>).</p>
<p>Instead of using these, uv needs to check for <code>PYPI_ID_TOKEN</code>, which the user has to explicitly declare in their GitLab job definition under <code>id_tokens</code>.</p>
<p>There's an example of that here: https://docs.pypi.org/trusted-publishers/using-a-publisher/#gitlab-cicd</p>
<p>More details here: https://docs.gitlab.com/ci/yaml/#id_tokens</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-static/src/env_vars.rs</code>:637 on 2025-08-29 18:05</div>
            <div class="timeline-body"><p>0.02c: I think it'd be better to not add this variable, and instead access <code>PYPI_ID_TOKEN</code> directly when we infer that the environment is Gitlab CI/CD.</p>
<p>(My rationale: incorrect or invalid OIDC creds can be really annoying to debug, so I think we should stick to a &quot;discover&quot; rather than &quot;user-supplied&quot; flow as much as we can.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-08-29 18:09</div>
            <div class="timeline-body"><p>Thanks @harsh-ps-2003! I think there's some stuff we could remove here, but the overall approach looks good to me.</p>
<p>One larger thought that this PR doesn't need to/shouldn't address: at some point it will probably make sense to abstract the OIDC token discovery, similarly to how the <a href="https://pypi.org/project/id/">id package</a> does for PyPI, twine, etc. That'll give uv the ability to add support for new Trusted Publishing providers without needing to know the internal details of how each expects credentials to be discovered. But that's a larger project.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-08-29 18:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-static/src/env_vars.rs</code>:630 on 2025-08-29 18:17</div>
            <div class="timeline-body"><p>Specifically, my suggest here would be to add <code>PYPI_ID_TOKEN</code> and <code>TESTPYPI_ID_TOKEN</code>, since those are the conventional variables that <code>id</code> looks for. This technically generalizes to <code>{AUD}_ID_TOKEN</code>, but I don't think indices other than PyPI or TestPyPI support Trusted Publishing yet ðŸ™‚</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-publish/src/trusted_publishing.rs</code>:139 on 2025-08-29 18:20</div>
            <div class="timeline-body"><p>This will need to check <code>{AUD}_ID_TOKEN</code> instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-08-29 18:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-08-29 18:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-static/src/env_vars.rs</code>:630 on 2025-08-29 18:21</div>
            <div class="timeline-body"><p>Actually, thinking about it more, we probably just want to remove these entirely and just do <code>{AUD}_ID_TOKEN</code>, to save ourselves some future work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-publish/src/trusted_publishing.rs</code>:124 on 2025-08-29 19:01</div>
            <div class="timeline-body"><p>This probably needs to be normalized, i.e. so that <code>aud: foo-bar</code> doesn't become <code>FOO-BAR_ID_TOKEN</code>.</p>
<p>Here's the relevant transform from <code>id</code>:</p>
<p>https://github.com/di/id/blob/48252f62c5a3d7bf16432466ae6fa78d7923639f/id/_internal/oidc/ambient.py#L295</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-publish/src/trusted_publishing.rs</code>:144 on 2025-08-29 19:02</div>
            <div class="timeline-body"><p>For generality, this should be formatted as <code>{AUD}_ID_TOKEN</code>, after obtaining and normalizing the <code>audience</code> per above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-08-29 19:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harsh-ps-2003">@harsh-ps-2003</a> reviewed on 2025-08-29 19:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harsh-ps-2003">@harsh-ps-2003</a> on <code>crates/uv-publish/src/trusted_publishing.rs</code>:124 on 2025-08-29 19:17</div>
            <div class="timeline-body"><p>Should the normalisation method be in the <code>uv-normalize</code> crate, or should I keep it in <code>trusted_publishing</code> in the same <code>uv-publish</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-08-29 19:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-publish/src/trusted_publishing.rs</code>:124 on 2025-08-29 19:25</div>
            <div class="timeline-body"><p>Here's probably fine for now -- I believe <code>uv-normalize</code> is primarily for package metadata.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-08-29 19:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-publish/src/trusted_publishing.rs</code>:159 on 2025-08-29 19:29</div>
            <div class="timeline-body"><p>Can we switch this back to HTTPS only? I can't think of a good reason why we'd want to negotiate the OIDC audience or mint-token exchange over HTTP (or allow a registry to control that).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-08-29 19:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-publish/src/trusted_publishing.rs</code>:144 on 2025-08-29 19:31</div>
            <div class="timeline-body"><p>It feels a little weird to me to have these error checking cases in sequence to the bodies above, rather than directly adjacent to their respective cases. Is there some way we can reflow this function more generally to bring the error handling closer to the site where the error occurs?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harsh-ps-2003">@harsh-ps-2003</a> reviewed on 2025-08-29 19:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harsh-ps-2003">@harsh-ps-2003</a> on <code>crates/uv-publish/src/trusted_publishing.rs</code>:159 on 2025-08-29 19:49</div>
            <div class="timeline-body"><p>I did that because tests use a local mock server over HTTP, while real registries (PyPI/TestPyPI) are HTTPS. Hardcoding HTTPS would break the integration tests; hardcoding HTTP would be insecure. Using <code>registry.scheme()</code> makes both work, so I went ahead with that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-08-29 20:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-publish/src/trusted_publishing.rs</code>:159 on 2025-08-29 20:07</div>
            <div class="timeline-body"><p>Ah, hmm. One of the maintainers can override me, but my preference would be for us to not do something with HTTP if the only use case for it is tests.</p>
<p>Two alternatives come to mind:</p>
<ol>
<li>We could do a <code>cfg(test)</code> check here and allow HTTP in test-only.</li>
<li>We could maybe accept a fully online test here, against TestPyPI? I'm not sure if there's any precedent for that in the other uv tests.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/harsh-ps-2003">@harsh-ps-2003</a> reviewed on 2025-08-30 08:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/harsh-ps-2003">@harsh-ps-2003</a> on <code>crates/uv-publish/src/trusted_publishing.rs</code>:159 on 2025-08-30 08:26</div>
            <div class="timeline-body"><p>I thought the <code>cfg(test)</code> would be useful in this situation, but it's only set for the crate that defines the tests; itâ€™s not set for dependencies when running integration tests. Since <code>uv-publish</code> is a dependency of uvâ€™s integration tests, <code>cfg!(test)</code> evaluates to false there, so my HTTPS-only path is taken, breaking the HTTP server.</p>
<p>Maybe I can gate HTTP for OIDC endpoints on debug assertions <code>cfg!(debug_assertions)</code> instead of test. That flag is enabled for dependencies in dev/test builds, but disabled in release, so the Dev/test (including integration tests) will use the registryâ€™s scheme (HTTP for mock) and release for HTTPS only.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/woodruffw">@woodruffw</a> on 2025-09-08 15:47</div>
            <div class="timeline-body"><p>Thanks for your hard work here @harsh-ps-2003! I've thought about this a bit more, and I think the approach we want to go with here is a larger architectural one: I'm going to build a &quot;get an ambient OIDC credential&quot; crate that'll abstract GitHub and GitLab OIDC retrieval, similar to what the <a href="https://pypi.org/project/id/">id</a> package in Python does. That'll make testing and future extensions (for other Trusted Publishing providers) much easier.</p>
<p>If you're OK with it, I'll take over this PR to make those changes. But if not, I'll start from scratch (and attribute you as a co-committer in my new changes).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @konstin by @konstin on 2025-09-08 15:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @woodruffw by @konstin on 2025-09-08 15:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @konstin removed by @konstin on 2025-09-08 15:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/harsh-ps-2003">@harsh-ps-2003</a> on 2025-09-08 18:26</div>
            <div class="timeline-body"><p>Thanks and please feel free to take over this PR!  @woodruffw</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-09-09 20:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-publish/src/trusted_publishing.rs</code>:133 on 2025-09-09 20:56</div>
            <div class="timeline-body"><p>Flagging: this is my trick/hack for test behavior specialization -- this crate exposes a <code>test</code> feature that only the tests compile with.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-publish/src/trusted_publishing.rs</code>:157 on 2025-09-09 20:56</div>
            <div class="timeline-body"><p><code>ambient_id</code> now abstracts all of this ðŸ™‚</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-09-09 20:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-09-09 20:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-publish/src/lib.rs</code>:338 on 2025-09-09 20:59</div>
            <div class="timeline-body"><p>This now distinguishes between the two cases mentioned in the previous TODO, although both currently still produce errors:</p>
<ul>
<li><code>Ok(None)</code> means that we didn't discover any OIDC credentials, but also didn't encounter any internal failures</li>
<li><code>Err(_)</code> means that we encountered an internal failure during OIDC discovery or token exchange</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @woodruffw on 2025-09-09 21:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @woodruffw on 2025-09-09 21:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/woodruffw">@woodruffw</a> on 2025-09-09 21:08</div>
            <div class="timeline-body"><p>This is good for a look -- I've rewritten the TP flow to use <code>ambient_id</code> (our new crate) for the OIDC discovery phase, which is both a nice simplification <em>and</em> makes adding support for other Trusted Publishing providers much easier in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/publish.rs</code>:115 on 2025-09-10 07:32</div>
            <div class="timeline-body"><p>We should retain the hint for <code>id-token: write</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-publish/src/trusted_publishing.rs</code>:37 on 2025-09-10 07:41</div>
            <div class="timeline-body"><p>Can we add some specific suggestions about what's gone wrong? Does this only happen when running outside of CI or also when GitLab CI is misconfigured?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-publish/src/trusted_publishing.rs</code>:102 on 2025-09-10 07:42</div>
            <div class="timeline-body"><p>nit: We can pass an id token as argument and only reveal it for building the json payload.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-publish/src/trusted_publishing.rs</code>:133 on 2025-09-10 07:56</div>
            <div class="timeline-body"><p>We may need to use a feature flag, but feature flags are not the easiest to ensure that they are either turned off or turned on, they are globally additive not properly checkable e.g. in CI. So I want to go through two possible alternatives:</p>
<p>Can we know some way that real CI only passes us a https URL so we can read this from <code>registry</code>? Or can we control this through an env var?</p>
<p>Can we use https in tests through https://github.com/LukeMathWalker/wiremock-rs/pull/163 ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-09-10 07:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-09-10 14:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv/tests/it/publish.rs</code>:115 on 2025-09-10 14:03</div>
            <div class="timeline-body"><p>Yep, I need to specialize the error handling a bit for that case (since it won't be applicable to all <code>ambient_id</code> errors, just GitHub ones). I'll do that now ðŸ™‚</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-09-10 14:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-publish/src/trusted_publishing.rs</code>:37 on 2025-09-10 14:05</div>
            <div class="timeline-body"><p>Yeah, I'll add suggestions here. This specifically happens when <code>ambient_id</code>'s discovery returns <code>None</code>, which happens if none of the discovery methods match. That roughly corresponds to running outside of CI, since discovery will fail (instead of returning <code>None</code>) if the environment has <code>GITHUB_CI</code> or <code>GITLAB_CI</code> but none of the other required state.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-09-10 14:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-publish/src/trusted_publishing.rs</code>:133 on 2025-09-10 14:13</div>
            <div class="timeline-body"><blockquote>
<p>Can we know some way that real CI only passes us a https URL so we can read this from <code>registry</code>? Or can we control this through an env var?</p>
</blockquote>
<p>Hmm, I can't think of a straightforward test for this -- in the &quot;real&quot; (end-user) CI the environment will look a lot like our unit testing CI. I guess we could set a special environment variable in our own testing (<code>ASTRAL_UV_INTERNAL_PLEASE_DO_NOT_SET_THIS_EVER_UNLESS_UNIT_TESTING</code>?) but that doesn't seem super ideal/easy to ensure that end users don't misuse either.</p>
<blockquote>
<p>Can we use https in tests through <a href="https://github.com/LukeMathWalker/wiremock-rs/pull/163">LukeMathWalker/wiremock-rs#163</a> ?</p>
</blockquote>
<p>Yeah, I was looking at this but I don't think it's quite ready for use yet -- it's something I could look at finishing (and carrying on our own fork?) but I didn't want to sink a ton of time into it.</p>
<hr />
<p>To take a step back -- the only reason we need this testing accommodation is because of the GitLab-specific tests added in this PR. I think we <em>could</em> arguably do without those, since the main thing they test that <em>isn't</em> covered by <code>ambient_id</code>'s own tests is the PyPI token exchange. So we'd lose coverage on the PyPI token exchange, but that isn't the main subject of this PR anyways (and is already demonstrably functioning).</p>
<p>(Or TL;DR: I think we could defer the problem of these tests this to a separate issue/PR, since the problem here stems from an area of code not actually being changed in this PR.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @woodruffw on 2025-09-10 15:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/woodruffw">@woodruffw</a> on 2025-09-10 15:46</div>
            <div class="timeline-body"><p>(Current test failures look like flakes to me)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2025-09-10 18:07</div>
            <div class="timeline-body"><p>Can you update the PR description for the merge commit?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @woodruffw on 2025-09-11 14:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @woodruffw on 2025-09-11 14:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/woodruffw">@woodruffw</a> on 2025-09-11 14:43</div>
            <div class="timeline-body"><p>Thanks for your hard work here @harsh-ps-2003!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-09-12 16:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 06:38:44 UTC
    </footer>
</body>
</html>
