<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allow per dependency build isolation for setup.py projects as well - astral-sh/uv #6517</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Allow per dependency build isolation for setup.py projects as well</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/6517">#6517</a>
        opened by <a href="https://github.com/tdejager">@tdejager</a>
        on 2024-08-23 14:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tdejager">@tdejager</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to uv! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<!-- What's the purpose of the change? What does it do, and why? -->

<p>This changes the behavior a bit of the per-dependency build-isolation override. That, if the dist name is known, it is passed into the <code>SourceBuild::Setup</code> function. This allows for this override to work for projects without a <code>pyproject.toml</code>, like <code>detectron2</code>, using the specified requirement name. Previously only the <code>pyproject.toml</code> name could be used, which these projects are lacking. An example of a use-case is given in the <em>Test Plan</em> section.</p>
<p>Additionally, the <code>no_build_isolation_package</code> has been adding to <code>InstallerSettingsRef</code> and used in <code>sync</code> and other commands, as this was not done yet.</p>
<p>This is useful if you want to <strong>non</strong>-isolate a single package, even ones without a proper <code>pyproject.toml</code></p>
<h2>Test Plan</h2>
<!-- How was it tested? -->

<p>With the following pyproject.toml.</p>
<pre><code class="language-toml">[project]
name = &quot;detectron-uv&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = [
    &quot;detectron2&quot;,
    &quot;setuptools&quot;,
    &quot;torch&quot;,
]

[build-system]
requires = [&quot;hatchling&quot;]
build-backend = &quot;hatchling.build&quot;

[tool.uv.sources]
detectron2 = { git = &quot;https://github.com/facebookresearch/detectron2&quot;, rev = &quot;bcfd464d0c810f0442d91a349c0f6df945467143&quot; }

[tool.uv]
no-build-isolation-package = [&quot;detectron2&quot;]
</code></pre>
<p>The package <code>detectron2</code> is now correctly <strong>non</strong>-isolated. Before, because the logic depended on getting the name from the <code>pyproject.toml</code>, which is lacking in detectron2 you would get the message, that the source could not be built. This was because it would still be <em>isolated</em> in that case.</p>
<p>With these changes you can now install using (given that you are inside a workspace with a venv):</p>
<pre><code>uv pip install torch setuptools
uv sync
</code></pre>
<p>This would previously fail with something like:</p>
<pre><code>error: Failed to prepare distributions
  Caused by: Failed to fetch wheel: detectron2 @ git+https://github.com/facebookresearch/detectron2@bcfd464d0c810f0442d91a349c0f6df945467143
  Caused by: Build backend failed to determine extra requires with `build_wheel()` with exit status: 1
--- stdout:

--- stderr:
Traceback (most recent call last):
  File &quot;&lt;string&gt;&quot;, line 14, in &lt;module&gt;
  File &quot;/Users/tdejager/Library/Caches/uv/builds-v0/.tmptloDcZ/lib/python3.12/site-packages/setuptools/build_meta.py&quot;, line 332, in get_requires_for_build_wheel
    return self._get_build_requires(config_settings, requirements=[])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/Users/tdejager/Library/Caches/uv/builds-v0/.tmptloDcZ/lib/python3.12/site-packages/setuptools/build_meta.py&quot;, line 302, in _get_build_requires
    self.run_setup()
  File &quot;/Users/tdejager/Library/Caches/uv/builds-v0/.tmptloDcZ/lib/python3.12/site-packages/setuptools/build_meta.py&quot;, line 502, in run_setup
    super().run_setup(setup_script=setup_script)
  File &quot;/Users/tdejager/Library/Caches/uv/builds-v0/.tmptloDcZ/lib/python3.12/site-packages/setuptools/build_meta.py&quot;, line 318, in run_setup
    exec(code, locals())
  File &quot;&lt;string&gt;&quot;, line 10, in &lt;module&gt;
ModuleNotFoundError: No module named 'torch'
---
  Caused by: This error likely indicates that detectron2 @ git+https://github.com/facebookresearch/detectron2@bcfd464d0c810f0442d91a349c0f6df945467143 depends on torch, but doesn't declare it as a build dependency. If detectron2 @ git+https://github.com/facebookresearch/detectron2@bcfd464d0c810f0442d91a349c0f6df945467143 is a first-party package, consider adding torch to its `build-system.requires`. Otherwise, `uv pip install torch` into the environment and re-run with `--no-build-isolation`.
</code></pre>
<p><strong>Edit</strong>:</p>
<p>Some wording, used isolated where it should be <strong>non</strong>-isolated.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-23 14:08</div>
            <div class="timeline-body"><p>Hey!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-23 14:08</div>
            <div class="timeline-body"><p>@konstin could you review?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @konstin on 2024-08-26 08:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tdejager">@tdejager</a> on 2024-08-26 08:33</div>
            <div class="timeline-body"><p>Last changes I did is integrate code from: #6605, was esentially doing a bunch of the same changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-26 12:37</div>
            <div class="timeline-body"><p>Generally makes sense to me, thanks Tim.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-08-26 12:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @konstin on 2024-08-26 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "feat: allow per dependency build isolation for setup.py projects as well" to "Allow per dependency build isolation for setup.py projects as well" by @konstin on 2024-08-26 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2024-08-26 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2024-08-26 14:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:39:06 UTC
    </footer>
</body>
</html>
