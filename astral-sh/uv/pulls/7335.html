<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support pre-releases in Python version requests - `command --python &lt;major.minor.pre-release&gt;` - astral-sh/uv #7335</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Support pre-releases in Python version requests - <code>command --python &lt;major.minor.pre-release&gt;</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/7335">#7335</a>
        opened by <a href="https://github.com/mikeleppane">@mikeleppane</a>
        on 2024-09-12 16:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/mikeleppane">@mikeleppane</a> on 2024-09-12 16:06</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds support to include Python pre-releases when requesting versions.
Check out the docs for commands that support the <code>Python</code> option:</p>
<pre><code class="language-text">--python, -p python
The Python interpreter to use for the virtual environment.
</code></pre>
<p>At least the following scenarios are supported:</p>
<pre><code class="language-bash">3.13.0a1
3.13b2
3.13rc4
313rc1
</code></pre>
<h2>Test Plan</h2>
<p>I added a basic unit test to <code>uv/crates/uv-python/src/discovery.rs</code>. I could have added more, but I have not discovered any relevant places.</p>
<p>CI passes</p>
<p>Note: I was unable to execute the entire test set locally. There were at least some timeout issues (some tests took over 60 seconds).</p>
<p>========== output ===========
beta version</p>
<pre><code class="language-bash">cargo run -- venv --python 3.13.0b3                                                                                                           ░▒▓ 94% 󰁹
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.20s
     Running `target/debug/uv venv --python 3.13.0b3`
Using Python 3.13.0b3 interpreter at: /home/mikko/.pyenv/versions/3.13.0b3/bin/python3
Creating virtualenv at: .venv
Activate with: source .venv/bin/activate
</code></pre>
<p>release candidate</p>
<pre><code class="language-bash"> cargo run -- venv --python 3.13.0rc2                                                                                                          ░▒▓ 94% 󰁹
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.83s
     Running `target/debug/uv venv --python 3.13.0rc2`
Using Python 3.13.0rc2 interpreter at: /home/mikko/.pyenv/versions/3.13.0rc2/bin/python3
Creating virtualenv at: .venv
Activate with: source .venv/bin/activate
</code></pre>
<pre><code class="language-bash">cargo run -- venv --python 313rc2                                                                                                             ░▒▓ 94% 󰁹
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.31s
     Running `target/debug/uv venv --python 313rc2`
Using Python 3.13.0rc2 interpreter at: /home/mikko/.pyenv/versions/3.13.0rc2/bin/python3
Creating virtualenv at: .venv
Activate with: source .venv/bin/activate
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Support pre-releases in Python version requests" to "Draft: Support pre-releases in Python version requests" by @mikeleppane on 2024-09-12 16:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-09-12 16:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:1560 on 2024-09-12 16:49</div>
            <div class="timeline-body"><p>Should we show the pre-release as part of the &quot;was requested&quot; bit here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mikeleppane">@mikeleppane</a> reviewed on 2024-09-12 17:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mikeleppane">@mikeleppane</a> on <code>crates/uv-python/src/discovery.rs</code>:1560 on 2024-09-12 17:28</div>
            <div class="timeline-body"><p>Absolutely!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Draft: Support pre-releases in Python version requests" to "Support pre-releases in Python version requests - `command --python <major.minor.pre-release>`" by @mikeleppane on 2024-09-12 17:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/pep440-rs/src/version.rs</code>:1430 on 2024-09-12 19:22</div>
            <div class="timeline-body"><p>This feels a little weird. I don't think this function should support leading content. Maybe we should just implement this directly in the relevant version request parsing section instead of implementing <code>FromStr</code>? cc @BurntSushi</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-09-12 19:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-09-12 19:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:1747 on 2024-09-12 19:24</div>
            <div class="timeline-body"><p>If we're going to bother parsing the version as a <code>Version</code> above we might want to just use that result here?</p>
<p>I worry about pulling in the full <code>Version</code> parser but it seems okay. I think we'll want to avoid matching this case if extra sections, e.g.,<code>dev</code> and `post, are present?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mikeleppane">@mikeleppane</a> reviewed on 2024-09-13 06:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mikeleppane">@mikeleppane</a> on <code>crates/pep440-rs/src/version.rs</code>:1430 on 2024-09-13 06:17</div>
            <div class="timeline-body"><p>Yep, I now removed this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mikeleppane">@mikeleppane</a> reviewed on 2024-09-13 06:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mikeleppane">@mikeleppane</a> on <code>crates/uv-python/src/discovery.rs</code>:1747 on 2024-09-13 06:20</div>
            <div class="timeline-body"><p>I made some modifications to this, using <code>Version</code> directly. However, I don't know if it's any better because the <code>Version</code> type uses u64 and <code>VersionRequest</code> u8, so it requires some conversion logic.</p>
<p>Edit: Hmm...this starts to feel too hacky, and another ingredient is this <code>VersionSpecifiers</code>. The <code>Version</code> type is not able to handle versions with a specifier (at least to my knowledge).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mikeleppane">@mikeleppane</a> reviewed on 2024-09-13 06:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mikeleppane">@mikeleppane</a> on <code>crates/uv-python/src/discovery.rs</code>:1747 on 2024-09-13 06:56</div>
            <div class="timeline-body"><p>I think this whole <code>ìmpl FromStr for VersionRequest</code> implementation is starting to become too unwieldy. Somehow, I feel we are now lacking separation of concerns. Some of the logic here could be separated somewhere else. For example, the <code>Version</code> type could handle some of the stuff here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-python/src/discovery.rs</code>:1722 on 2024-09-16 13:34</div>
            <div class="timeline-body"><p>This seems pretty hacky to me, and I think isn't guaranteed to work. For example, <code>1.0b1+b1</code>. It's perhaps a contrived example, but it's a valid version string that will cause this code to choke. I think in general, the flow of parsing a full version to get the prerelease, throw away that version except for the pre-release and then try to re-parse the version is pretty tortured.</p>
<p>I don't know the original motivation for avoiding full <code>Version</code> parsing here, but how about this:</p>
<ol>
<li>In this <code>FromStr</code> impl, just try to parse a full <code>Version</code>.</li>
<li>Get rid of the ad hoc <code>.</code> splitting.</li>
<li>Inspect the <code>Version</code> directly to determine which request to return.</li>
<li>For <code>VersionSpecifiers</code>, it looks like you're specifically only trying to parse the part of the version without a prelease? Is that right? If so, you can use the mutating methods on the parsed <code>Version</code> to strip what you don't want, serialize it to a string and then re-parse.</li>
</ol>
<p>If <code>Version</code> fails to parse, then I think you can skip directly to trying to parse as a <code>VersionSpecifiers</code>.</p>
<p>Splitting some of this into helper functions might help.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> had review dismissed on 2024-09-16 13:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mikeleppane">@mikeleppane</a> reviewed on 2024-09-17 11:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mikeleppane">@mikeleppane</a> on <code>crates/uv-python/src/discovery.rs</code>:1722 on 2024-09-17 11:29</div>
            <div class="timeline-body"><p>@BurntSushi, thanks for the excellent comment! So that you know- I've made changes following your guidelines. Hopefully, it is now more concise and readable.
I don't know why it was avoided initially to construct the <code>Version</code> type. Perf?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @mikeleppane on 2024-09-17 12:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-17 14:39</div>
            <div class="timeline-body"><p>I did a pass on this, you can see my changes in https://github.com/astral-sh/uv/pull/7335/commits/15f6ba28ecb9b25b5211eb5e228efada75429f30</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-17 14:44</div>
            <div class="timeline-body"><p>I also tested this with a few <code>uv venv</code> invocations and it looks good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-09-17 14:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2024-09-17 14:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-09-17 14:46</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 13:01:31 UTC
    </footer>
</body>
</html>
