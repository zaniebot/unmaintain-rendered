<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tweak the order of index priority - astral-sh/uv #2083</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>tweak the order of index priority</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/2083">#2083</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2024-02-29 15:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>Previously, <code>uv</code> would always prioritize the index given by
<code>--index-url</code>. It would then try any indexes after that given by zero
or more <code>--extra-index-url</code> flags. This differed from <code>pip</code> in that any
priority was given at all, where <code>pip</code> doesn't guarantee any priority
ordering of indexes.</p>
<p>We could go in the direction of mimicing <code>pip</code>'s behavior here, but it
at present has issues with dependency confusion attacks where packages
may get installed from indexes you don't control. More specifically,
there is an issue of different trust levels. See discussion in #171 and
<a href="https://peps.python.org/pep-0708/">PEP-0708</a> for more on the security impact.</p>
<p>In contrast, <code>uv</code> will only select versions for a package from a single
index. That is, even if <code>foo</code> is in indexes <code>a</code> and <code>b</code>, it will
only consider the versions from the index that it checks first. This
probably helps with respect to dependency confusion attacks, but also
means that <code>uv</code> doesn't quite cover all of the same use cases as <code>pip</code>.</p>
<p>In this PR, we retain the notion of prioritizing indexes, but
tweak it so that PyPI is preferred last as opposed to first. Or
more precisely, the <code>--index-url</code> flag specifies a fallback index,
not the primary index, and is deprioritized beneath every index
specified by <code>--extra-index-url</code>. The ordering among indexes given by
<code>--extra-index-url</code> remains the same: earlier indexes are prioritized
over later indexes.</p>
<p>While this tweak likely won't hit all use cases, I believe it will
resolve some of the most common pain points without exacerbating
dependency confusion problems.</p>
<p>Ref #171, Fixes #1377, Fixes #1451, Fixes #1600</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @BurntSushi on 2024-02-29 15:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @BurntSushi on 2024-02-29 15:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv/tests/pip_install.rs</code>:833 on 2024-02-29 15:17</div>
            <div class="timeline-body"><p>I feel a little bad about doing this. I'm happy to try a different approach if folks have ideas.</p>
<p>It feels like maybe the better longer term solution is to add multi-index support to packse? (I briefly looked to see if it had it already, and it doesn't look like it does.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-02-29 15:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-29 15:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/tests/pip_install.rs</code>:833 on 2024-02-29 15:42</div>
            <div class="timeline-body"><p>Could we instead use <code>https://download.pytorch.org/whl</code>, since we already use that in other tests (so we avoid adding yet another point of failure)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-02-29 16:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv/tests/pip_install.rs</code>:833 on 2024-02-29 16:28</div>
            <div class="timeline-body"><p>Thanks for the nudge. I managed to find an example that worked with test.pypi.org.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2024-02-29 16:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2024-02-29 16:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-02-29 16:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-02-29 17:04</div>
            <div class="timeline-body"><p>I believe this helps with dependency confusion attacks. If I'm providing an extra index URL that's usually the index that <em>I</em> control. The attack would be that someone uploads a package with the same name to the primary index (i.e. PyPI) and suddenly we use that package instead of the one I intend to.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @zanieb on 2024-02-29 17:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jarshwah">@jarshwah</a> on 2024-03-01 11:46</div>
            <div class="timeline-body"><blockquote>
<p>If I'm providing an extra index URL that's usually the index that I control</p>
</blockquote>
<p>As a counter-point (not suggesting this is the most common) - we use extra-index-url to install a vendor library (we pay them for access), and the index is horribly slow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/adrienball">@adrienball</a> on 2024-03-01 15:08</div>
            <div class="timeline-body"><p>I just ran into an issue which is caused by this change.
My company uses a private index, and thus I have some script which is run with <code>UV_EXTRA_INDEX_URL=&lt;private-index-url&gt;</code>.
The following issue happened when <code>uv venv --seed</code> is run inside the aforementioned script:</p>
<pre><code class="language-console">#15 0.746 Creating virtualenv at: /app/.venv
#15 0.775 uv::venv::seed
#15 0.775 
#15 0.775   × Failed to install seed packages
#15 0.775   ├─▶ No solution found when resolving: pip, setuptools, wheel
#15 0.775   ├─▶ Failed to download and build: pip==20.2.4
#15 0.775   ╰─▶ Building source distributions is disabled
</code></pre>
<p>After digging a bit, and trying to understand why this old<code>pip==20.2.4</code> was getting installed, I found that someone uploaded an old version of <code>pip</code> into the private index.
I don't know if the error results from an invalid pip wheel on the private index, or some version incompatibilities, but it made me realize that as soon as someone publishes a version of a public package in our private index, then it will potentially break all libs or apps which depend on a different version of the package.</p>
<p>Is there any plan to mitigate this issue ?</p>
<p>Thanks !</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-01 15:25</div>
            <div class="timeline-body"><p>For clarity, you can always revert to the previous behavior by inverting the order:</p>
<pre><code>--index-url=&lt;private-index-url&gt; --extra-index-url=https://pypi.org/simple
</code></pre>
<p>This would tell uv to look in PyPI first, and then only fall back to your index if a package doesn't exist on PyPI.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/xnox">@xnox</a> on 2024-09-03 15:11</div>
            <div class="timeline-body"><p>How does this interact with --find-links?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:35:51 UTC
    </footer>
</body>
</html>
