<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use Astral-maintained `tokio-tar` fork - astral-sh/uv #11174</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use Astral-maintained <code>tokio-tar</code> fork</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/11174">#11174</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2025-02-03 01:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>I shipped one security fix here along with several significant performance improvements for large TAR files:</p>
<ul>
<li>https://github.com/astral-sh/tokio-tar/pull/2</li>
<li>https://github.com/astral-sh/tokio-tar/pull/4</li>
<li>https://github.com/astral-sh/tokio-tar/pull/5</li>
</ul>
<p>I also PR&#x27;d the security fix to <code>edera-dev</code> (<a href="https://github.com/edera-dev/tokio-tar/pull/4">edera-dev/tokio-tar#4</a>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-03 01:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">security</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-03 01:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/Gankra">@Gankra</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-03 01:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-03 01:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-03 01:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-03 01:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-03 01:34</div>
            <div class="timeline-body"><p>Converting to draft while I checkout failing debug assertions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-extract/src/stream.rs</code>:155 on 2025-02-03 01:48</div>
            <div class="timeline-body"><p>This is related to <a href="https://github.com/astral-sh/tokio-tar/pull/2">astral-sh/tokio-tar#2</a>. I forgot that we don&#x27;t actually use the crate&#x27;s <code>unpack</code> method, we unpack ourselves (since we need to set permissions in a different way).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-02-03 01:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-02-03 01:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-extract/src/stream.rs</code>:175 on 2025-02-03 01:48</div>
            <div class="timeline-body"><p>We can get rid of this whole vendored <code>unpacked_at</code> implementation. It turns out the crate now returns the target path. (That&#x27;s not a change I made, it must&#x27;ve been made in one of the forks.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-03 01:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-extract/src/stream.rs</code>:154 on 2025-02-03 12:38</div>
            <div class="timeline-body"><p>Is this a concern for us? We usually create directories from archives without preserving permissions (at least in the zip path we should).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2025-02-03 12:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-02-03 14:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/uv-extract/src/stream.rs</code>:154 on 2025-02-03 14:16</div>
            <div class="timeline-body"><p>Also maybe this is me being unfamiliar with the codebase but this is so... bizarre. How does this unpacking a file before the dir that contains it make sense? Is the idea that we create_dir_all any file path anyway, so the dir entries only create empty dirs and set perms on dirs that have files?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> approved on 2025-02-03 14:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-02-03 14:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-extract/src/stream.rs</code>:154 on 2025-02-03 14:21</div>
            <div class="timeline-body"><p>For zips we always create the parent of a file, as a zip can contain directory entries, but sometimes there are no directory entries, just files.</p>
<p>https://github.com/astral-sh/uv/blob/4d3809cc6b28d71f26a782929b994abfebd7973c/crates/uv-extract/src/stream.rs#L66-L76</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-02-03 15:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-extract/src/stream.rs</code>:154 on 2025-02-03 15:37</div>
            <div class="timeline-body"><blockquote>
<p>Is the idea that we create_dir_all any file path anyway, so the dir entries only create empty dirs and set perms on dirs that have files?</p>
</blockquote>
<p>Yes. When we create a file, we create the directories required for it. This happens within the <code>async-tar</code> crate. The reason we have to do it &quot;manually&quot; here is because we have our own <code>unpack</code> that replicates the <code>async-tar</code> logic but applies different permissions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-02-03 15:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-extract/src/stream.rs</code>:154 on 2025-02-03 15:40</div>
            <div class="timeline-body"><p>(I will look at why the <code>tar</code> crate introduced this before merging.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-02-03 15:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-extract/src/stream.rs</code>:154 on 2025-02-03 15:56</div>
            <div class="timeline-body"><p>It kind of seems like a bug that we aren&#x27;t preserving directory permissions in the zip case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-02-03 16:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-extract/src/stream.rs</code>:154 on 2025-02-03 16:10</div>
            <div class="timeline-body"><p>personally, i&#x27;d prefer only preserving the executable bit and otherwise using the default umask; i&#x27;d find it odd if the permissions on the build host should determine the permissions in the deployment target.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-extract/src/stream.rs</code>:154 on 2025-02-03 16:19</div>
            <div class="timeline-body"><p>Yeah. Probably requires more invasive changes to the <code>tar</code> crate though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-02-03 16:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-extract/src/stream.rs</code>:154 on 2025-02-03 16:36</div>
            <div class="timeline-body"><p>I&#x27;d like to review what pip does here before making other changes (since this is just preserving our status quo).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-02-03 16:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-02-03 17:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-extract/src/stream.rs</code>:154 on 2025-02-03 17:48</div>
            <div class="timeline-body"><p>Nevermind, pip explicitly only preserves the executable bit. I&#x27;ll make the same change for tar in a separate PR.</p>
<p>https://github.com/pypa/pip/blob/3898741e29b7279e7bffe044ecfbe20f6a438b1e/src/pip/_internal/utils/unpacking.py#L88-L100</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-03 17:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-03 17:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-03 17:51</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:50:40 UTC
    </footer>
</body>
</html>
