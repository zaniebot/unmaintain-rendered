<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add support for musl Python toolchain fetches - astral-sh/uv #4160</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add support for musl Python toolchain fetches</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/4160">#4160</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-06-08 14:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>Previously, we always assumed GNU.</p>
<p>I considered restoring some of the <code>platform-host</code> crate which was removed in #2381. I&#x27;m not sure we actually need to do the whole ELF inspection thing though since we don&#x27;t need version information and <code>target-lexicon</code> seems to have what we need. I presume since <code>target-lexicon::HOST</code> is a const, that the information is based on the uv&#x27;s target host not the runtime host. This seems okay for toolchain download assumptions? If not, we can go back to the ELF inspection technique but I&#x27;m not fully comfortable modifying that code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-08 14:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-08 14:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-08 20:47</div>
            <div class="timeline-body"><blockquote>
<p>This seems okay for toolchain download assumptions?</p>
</blockquote>
<p>I&#x27;m not sure... Wouldn&#x27;t this <em>always</em> download the musl Pythons on our Linux builds now, since we only ship musl? My guess is we <em>do</em> need to determine this dynamically.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-08 21:34</div>
            <div class="timeline-body"><p>Eek that might be true. Okay, back to the goblin elf approach. I&#x27;ll need to chat with Konsti about that code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-09 17:23</div>
            <div class="timeline-body"><p>I&#x27;m actually a bit worried about the use of <code>std::env::consts::ARCH</code> too -- is it granular enough to map to the set of Pythons that we ship? That&#x27;s what #3857 was about.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-09 21:47</div>
            <div class="timeline-body"><p>Oh interesting thanks for the link I didn&#x27;t see #3857 or <a href="https://github.com/astral-sh/uv/pull/3855">astral-sh/uv#3855</a>. I&#x27;ll need to look into that further. These were not intended to be fully &quot;production ready&quot; when written. I certainly wouldn&#x27;t be surprised if we need to do something more robust or restore more of the implementation we were using before we moved platform information queries to rely on a Python implementation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-06-10 09:37</div>
            <div class="timeline-body"><p>tl;dr: We need to go back to the libc detection from <a href="https://github.com/astral-sh/uv/pull/2381">astral-sh/uv#2381</a>.</p>
<p>There are three different libc configurations supported by rust: glibc dynamically linked (x86_64-unknown-linux-gnu), statically linked with musl (x86_64-unknown-linux-musl), musl dynamically linked (<code>-crt-static</code>, <a href="https://github.com/rust-lang/compiler-team/issues/422">rust-lang/compiler-team#422</a>). To load a dynamic library such as native python modules, the libc configuration of the loading binary must match the one of the loaded library. Python encodes this as <code>manylinux</code> and <code>musllinux</code> tags. Statically linked binaries can&#x27;t load dynamic libraries (by the mechanism we need).</p>
<p>The libc that uv itself uses doesn&#x27;t matter since we don&#x27;t load libraries ourself, but the python we download and start needs to match the libc the user expects. Finding the platform default is non-trivial since you can install glibc on alpine (https://wiki.alpinelinux.org/wiki/Running_glibc_programs) and musl on ubuntu (<code>apt install musl</code>). As proxy, we check <code>/bin/ls</code> or <code>/bin/sh</code> for its libc and use it platform default. Alternatively, we could switch to shipping dynamically linked glibc and musl builds of uv and enforce using the right one in the installer (removing the glibc-too-old to musl fallback).</p>
<p>On that note, python-build-standalone is currently statically linked for musl and fails to loads any compiled native module (<a href="https://github.com/astral-sh/uv/pull/2382">astral-sh/uv#2382</a>). This is a blocker for deploying python-build-standalone on alpine targets.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-10 14:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-10 14:12</div>
            <div class="timeline-body"><p>Moving this back to draft as it will require significant revisions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-11 16:26</div>
            <div class="timeline-body"><p>I&#x27;ll open an issue for proper musl detection.</p>
<p>This pull request is superseded by #4236</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-11 16:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:45:48 UTC
    </footer>
</body>
</html>
