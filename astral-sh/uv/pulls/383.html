<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improve handling of dependency conflicts resulting in empty version ranges - astral-sh/uv #383</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Improve handling of dependency conflicts resulting in empty version ranges</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/383">#383</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2023-11-09 21:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>Uses an experimental pubgrub branch (#370) that allows us to handle multiple version ranges for a single dependency to the solver which results in better error messages because the derivation tree contains all of the relevant versions. Previously, the version ranges were merged (by us) in the resolver before handing them to pubgrub since only one range could be provided per package. Since we don&#x27;t merge the versions anymore, we no longer give the solver an empty range for conflicting requirements; instead the solver comes to that conclusion from the provided versions. You can see the improved error message for direct dependencies in <a href="https://github.com/astral-sh/puffin/pull/383/files#diff-a0437f2c20cde5e2f15199a3bf81a102b92580063268417847ec9c793a115bd0">this snapshot</a>.</p>
<p>Since we are no longer merging packages, we do not raise an error on conflicting urls in dependencies anymore. Our previous solution was kind of a hack, so I&#x27;m exploring better solutions such as:</p>
<ul>
<li>Removing <code>Option&lt;Url&gt;</code> from <code>PubGrubPackage::Package</code> in favor of a separate <code>PubGrubPackage::UrlPackage</code> variant e.g. <a href="https://github.com/astral-sh/puffin/pull/383">astral-sh/puffin#383</a>/commits/a510a2f882875310f46fde707c9a99eb9f26b70c</li>
<li>Adding a new <code>PubGrubPackage::Url</code> variant that is added as a dummy dependency with fake conflicting version numbers for each package name and url combination e.g. 4343f66...08509a5</li>
</ul>
<p>The crux of the problem is that we must have pubgrub consider packages with the same name (specified with or without a url) as the same package with possibly compatible or incompatible versions. However, we do not have a good way to treat different urls as distinct versions while also allowing a url to satisfy versions ranges required by other dependencies relying on the package.</p>
<p>Supersedes #338
Requires <a href="https://github.com/astral-sh/puffin/pull/370">astral-sh/puffin#370</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-01-04 22:50</div>
            <div class="timeline-body"><p>Still need to investigate support for this in PubGrub...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-01-05 22:43</div>
            <div class="timeline-body"><p>As demonstrated by</p>
<p>https://github.com/astral-sh/puffin/blob/88adba83a01357dec22bc7e2a0d79ab53e589d5c/crates/puffin-cli/tests/pip_install_scenarios.rs#L1906</p>
<p>this appears to be resolved on <code>main</code>. The message in this pull request is comparable</p>
<p>https://github.com/astral-sh/puffin/blob/08509a5c02b190281ac97162b3b4cdc7cf86b919/crates/puffin-cli/tests/snapshots/pip_compile__compile_unsolvable_requirements.snap#L19-L20</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/zanieb">@zanieb</a> on 2024-01-05 22:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-21 05:31</div>
            <div class="timeline-body"><p>I&#x27;ve revived the original PubGrub change in https://github.com/zanieb/pubgrub/tree/charlie/into.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:42:39 UTC
    </footer>
</body>
</html>
