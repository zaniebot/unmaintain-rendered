<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backtrack when implied markers are disjoint with target platform - astral-sh/uv #11294</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Backtrack when implied markers are disjoint with target platform</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/11294">#11294</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2025-02-06 19:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-06 19:59</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>I'm a little surprised that we weren't doing this already, but if we look at a wheel-only distribution, and it doesn't have <em>any</em> wheels for the current fork environment, we shouldn't accept it.</p>
<p>For example, given:</p>
<pre><code class="language-toml">[project]
name = &quot;project&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.13.0&quot;
dependencies = [&quot;PyQt5-Qt5&quot;]

[tool.uv]
environments = [&quot;sys_platform == 'win32'&quot;]
</code></pre>
<p>We should be backtracking to <code>5.15.2</code>, which is the last version with Windows support.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-06 20:01</div>
            <div class="timeline-body"><p>Ugh, I guess this change is somewhat problematic since it looks like the <code>transformers</code> resolver now fails due to <code>jaxlib</code> lacking distributions for ARM Linux:</p>
<pre><code>  Ã— No solution found when resolving dependencies for split (python_full_version &gt;= '3.12' and platform_machine == 'aarch64' and sys_platform == 'linux'):
  â•°â”€â–¶ Because only the following versions of jaxlib are available:
          jaxlib==0.4.6
          jaxlib==0.4.7
          jaxlib==0.4.9
          jaxlib==0.4.10
          jaxlib==0.4.11
          jaxlib==0.4.12
          jaxlib&gt;=0.4.13
      and jaxlib&lt;=0.4.13 has no wheels with a matching platform tag, we can conclude that jaxlib&lt;=0.4.13 cannot be used.
      And because transformers[all] depends on jaxlib&lt;=0.4.13 and your project requires transformers[all], we can conclude that your project's requirements are unsatisfiable.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2025-02-28 19:36</div>
            <div class="timeline-body"><p>Just saw this and thought it related to #11841? :-)</p>
<blockquote>
<p>Ugh, I guess this change is somewhat problematic since it looks like the <code>transformers</code> resolver now fails due to <code>jaxlib</code> lacking distributions for ARM Linux</p>
</blockquote>
<p>And of course missing a source distribution (same as with <code>PyQt5</code> and friends). So, really, the <code>jaxlib</code> is not truly portable, therefore test failure is valid?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-28 19:39</div>
            <div class="timeline-body"><p>@paveldikov -- Yeah exactly. It's actually correct to fail. I'm just worried about passing that on to users as a default since in practice they may not care. It's tricky...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notatallshaw">@notatallshaw</a> on 2025-02-28 19:53</div>
            <div class="timeline-body"><p>What about in the error telling the user how to restrict to known good platforms when a required library has no source distribution? Does depend on users reading error messages ðŸ™ƒ.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2025-02-28 19:53</div>
            <div class="timeline-body"><p>Some options for handling this semi-gracefully:</p>
<ul>
<li>Allow user to exclude don't-care platforms from consideration (#11463?). Then a friendly error message can prompt the user to do so in case of partial unsatisfiability.</li>
<li>Fallback to emitting almost-universal lockfiles/constraints files, that are actively self-aware of their own unsatisfiability for given environments.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-05-04 17:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2025-05-07 13:22</div>
            <div class="timeline-body"><p>Was this closed purely because of the <code>transformers</code> library's pin to a really old version of <code>jaxlib</code>? I think it's a shame because this would really unblock a number of issues that we commonly face in our environment. Certainly <code>PyQt5</code> is one such problem-child package that currently requires kid-glove treatment :-(</p>
<p>To avoid the robbing-Peter-to-pay-Paul effect, perhaps this could have been gated behind a setting? Something along the lines of <code>universal-require-compatible-dist</code>, or something more succinctly worded?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-05-07 13:24</div>
            <div class="timeline-body"><p>Have you seen the required-environments feature we shipped (https://docs.astral.sh/uv/concepts/resolution/#required-environments)? If it doesn't work for you, could you describe what it's missing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2025-05-07 14:29</div>
            <div class="timeline-body"><p>That would almost work apart from two caveats:</p>
<ul>
<li><code>required-environments</code> applies as a post-hoc filter, and therefore applies too late if one of the platform wheels is being blocked by a security scanner. See #11463</li>
<li><code>PyQt5</code> legitimately supports Windows + Linux (and I do want my lockfiles to support both). It just happens that the latest several versions -- for some inscrutable reason :-( -- do not ship Windows wheels OR sdists. Therefore the latest versions (which the current algorithm will happily pick) result in lockfiles that are not usable on Windows i.e. are not actually universal.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-05-07 18:37</div>
            <div class="timeline-body"><p>I could get pyqt5 to work with <code>required-environment</code> with the following <code>pyproject.toml</code>. I see the problem with security scanners, uv currently expects access all files in an index (or at least the <code>data-dist-info-metadata</code> file, which doesn't require having access to the actual wheel).</p>
<pre><code class="language-toml">[project]
name = &quot;foo&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = [
    &quot;pyqt5&quot;,
]

[tool.uv]
required-environments = [
  &quot;sys_platform == 'win32'&quot;,
  &quot;sys_platform == 'linux'&quot;
]
</code></pre>
<p>This setup makes the lockfile dispatch between Windows and Linux:</p>
<pre><code class="language-toml">[[package]]
name = &quot;pyqt5-qt5&quot;
version = &quot;5.15.2&quot;
source = { registry = &quot;https://pypi.org/simple&quot; }
resolution-markers = [
    &quot;sys_platform == 'win32'&quot;,
]
wheels = [
    { url = &quot;https://files.pythonhosted.org/packages/1c/7e/ce7c66a541a105fa98b41d6405fe84940564695e29fc7dccf6d9e8c5f898/PyQt5_Qt5-5.15.2-py3-none-win32.whl&quot;, hash = &quot;sha256:9cc7a768b1921f4b982ebc00a318ccb38578e44e45316c7a4a850e953e1dd327&quot;, size = 43447358, upload-time = &quot;2021-03-10T14:01:17.827Z&quot; },
    { url = &quot;https://files.pythonhosted.org/packages/37/97/5d3b222b924fa2ed4c2488925155cd0b03fd5d09ee1cfcf7c553c11c9f66/PyQt5_Qt5-5.15.2-py3-none-win_amd64.whl&quot;, hash = &quot;sha256:750b78e4dba6bdf1607febedc08738e318ea09e9b10aea9ff0d73073f11f6962&quot;, size = 50075158, upload-time = &quot;2021-03-10T14:05:20.868Z&quot; },
]

[[package]]
name = &quot;pyqt5-qt5&quot;
version = &quot;5.15.16&quot;
source = { registry = &quot;https://pypi.org/simple&quot; }
resolution-markers = [
    &quot;sys_platform != 'win32'&quot;,
]
wheels = [
    { url = &quot;https://files.pythonhosted.org/packages/2f/97/ef77663fb5d61b65f2e93edc135cc0b86724c1fc610c10a6867ae0c0baff/PyQt5_Qt5-5.15.16-1-py3-none-manylinux2014_x86_64.whl&quot;, hash = &quot;sha256:2cfa8f50dd29618ef98f29355f83d8a5f3e41003be22128e9b5d94d214b6b468&quot;, size = 61080044, upload-time = &quot;2025-02-24T22:30:07.132Z&quot; },
    { url = &quot;https://files.pythonhosted.org/packages/ff/89/65a4b9c6bc89012182ff46bf8e503a8aa5e5570df7cb628211c93012beca/PyQt5_Qt5-5.15.16-py3-none-macosx_10_13_x86_64.whl&quot;, hash = &quot;sha256:18b6fec012de60921fcb131cf2a21368171dc29050d43e4b81a64be407a36105&quot;, size = 39957063, upload-time = &quot;2024-12-18T15:42:29.63Z&quot; },
    { url = &quot;https://files.pythonhosted.org/packages/0a/60/b6db285c87666b02aa11d0946d7bb381d8bdcc815cc5aa61fa91272b321b/PyQt5_Qt5-5.15.16-py3-none-macosx_11_0_arm64.whl&quot;, hash = &quot;sha256:e1a0e7ae35a7615c74a293705204579650930486a89af23082462f429dae504a&quot;, size = 37122434, upload-time = &quot;2024-12-18T15:42:53.006Z&quot; },
    { url = &quot;https://files.pythonhosted.org/packages/dc/1a/c4f861c4d7a9844a207b8bc3aa9dd84c51f823784d405469cde83d736cf1/PyQt5_Qt5-5.15.16-py3-none-manylinux2014_x86_64.whl&quot;, hash = &quot;sha256:5ee1754a6460849cba76c0f0c490c0ccc3b514abc780b141cf772db22b76b54b&quot;, size = 59854452, upload-time = &quot;2024-12-18T15:43:30.262Z&quot; },
]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2025-05-07 20:33</div>
            <div class="timeline-body"><blockquote>
<p>I could get pyqt5 to work with required-environment with the following pyproject.toml.</p>
</blockquote>
<p>I can confirm that this works with <code>uv.lock</code>, but not for <code>uv pip compile</code> (either txt or PEP 751 output format)</p>
<blockquote>
<p>uv currently expects access all files in an index (or at least the data-dist-info-metadata file, which doesn't require having access to the actual wheel).</p>
</blockquote>
<p>To add insult to injury, certain PyPI-like repo backends do not support range queries, so a full wheel download it must be. (besides, even if range requests were to be supported, I wouldn't be surprised if the gating logic were so coarse-grained so as to make it 403 anyway)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:19 UTC
    </footer>
</body>
</html>
