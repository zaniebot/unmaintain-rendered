<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dont retry connection on SSL certificate error - astral-sh/uv #16245</title>
    <link rel="stylesheet" href="../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../index.html">Back to index</a>
    </div>

    <h1>Dont retry connection on SSL certificate error</h1>

    <div class="meta">
        <span class="state state-open">Open</span>
        <a href="https://github.com/astral-sh/uv/pull/16245">#16245</a>
        opened by <a href="https://github.com/assadyousuf">@assadyousuf</a>
        on 2025-10-11 00:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/assadyousuf">@assadyousuf</a> on 2025-10-11 00:18</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>SSL errors should not be retryable from the cached on non cached client: https://github.com/astral-sh/uv/issues/16235</p>
<h2>Test Plan</h2>
<p>Unsure on if its possible/how to simulate an SSL certificate failure with the mock server so we can get a test going. Open to ideas on how to test this. See comment below</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @assadyousuf on 2025-10-15 00:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Fix: Dont retry connection on SSL errors" to "Dont retry connection on SSL errors" by @assadyousuf on 2025-10-15 00:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../issues/16235.html">astral-sh/uv#16235</a> on 2025-10-15 00:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/assadyousuf">@assadyousuf</a> reviewed on 2025-10-15 00:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/assadyousuf">@assadyousuf</a> on <code>crates/uv-client/src/base_client.rs</code>:998 on 2025-10-15 00:29</div>
            <div class="timeline-body"><p>Unsure on if its possible/how to simulate an SSL certificate failure with the mock server so we can get a test going. Open to ideas on how to test the new code path</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Dont retry connection on SSL errors" to "Dont retry connection on SSL certificate error" by @assadyousuf on 2025-10-15 00:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/base_client.rs</code>:998 on 2025-10-15 11:27</div>
            <div class="timeline-body"><p>I don't have a great idea either unfortunately, I'm using https://badssl.com/ for manual testing but we don't want to make CI depend on a third-party website. I tried building something with https://github.com/rustls/rcgen but it was clashing with the rustls features we were enabling, it would be great if we could fix that on the rcgen side and then use a self-signed cert in the test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/base_client.rs</code>:940 on 2025-10-15 11:29</div>
            <div class="timeline-body"><p>Why do we have this check both here and in <code>is_transient_network_error</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/base_client.rs</code>:1008 on 2025-10-15 11:29</div>
            <div class="timeline-body"><p>We should <code>return false</code> here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-10-15 11:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @konstin by @konstin on 2025-10-15 11:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2025-10-23 01:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-client/src/base_client.rs</code>:998 on 2025-10-23 01:54</div>
            <div class="timeline-body"><p>I would think setting SSL_CERT_FILE to a self signed cert chain in the test context may help, e.g. maybe with a self-signed cert for pypi.org and running typical uv project commands. I'd expect it to fail on hostname validation.</p>
<p>If we really need some other kind of testing requiring our own mocked server, we could use a similar approach  like we did <a href="https://github.com/astral-sh/uv/blob/0959763a828418410bdb7393696249b71e536969/crates/uv-client/tests/it/user_agent_version.rs#L29">here</a>, but would require some additional minor setup to get some dummy certs working.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2025-10-29 16:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-client/src/base_client.rs</code>:998 on 2025-10-29 16:23</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/uv/pull/16473 will unblock you on adding tests once its merged</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/michael-o">@michael-o</a> reviewed on 2025-10-30 09:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/michael-o">@michael-o</a> on <code>crates/uv-client/src/base_client.rs</code>:1104 on 2025-10-30 09:32</div>
            <div class="timeline-body"><p>Is there really not better way than analyzing a string which can change any time?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-10-30 13:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/base_client.rs</code>:1104 on 2025-10-30 13:24</div>
            <div class="timeline-body"><p>Feel free to ask this upstream, the error is currently not otherwise accessible, while I'd definitely prefer an enum-match here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-10-30 13:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/base_client.rs</code>:998 on 2025-10-30 13:55</div>
            <div class="timeline-body"><p>CI also already depends on pypi so I wouldn't be crushed if we hit badssl.com, I'd be less worried about the dependency than adding traffic to their site.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-10-30 14:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/base_client.rs</code>:998 on 2025-10-30 14:21</div>
            <div class="timeline-body"><p>The repo behind the site has been archived, so I'm worried about it disappearing: https://github.com/chromium/badssl.com. Inversely, I'm not worried about the traffic since it looks like a static nginx config. We could run a copy on a bare minimum server, but their image is <code>ubuntu:16.04</code> based, so I'd rather invest in some local solution (does someone want to put an nginx binary on pypi? :D)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-10-30 14:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/base_client.rs</code>:998 on 2025-10-30 14:27</div>
            <div class="timeline-body"><p>We could also host it ourselves like I do for the fly.io proxy for testing authentication</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2025-10-30 14:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-client/src/base_client.rs</code>:998 on 2025-10-30 14:29</div>
            <div class="timeline-body"><p>I'd think the approach from #16473 would also work for what needs to be tested from my perspective and no other background CI service dependencies would be needed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/base_client.rs</code>:998 on 2025-10-30 14:32</div>
            <div class="timeline-body"><p>Sgtm!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-10-30 14:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Referenced in <a href="../pulls/16473.html">astral-sh/uv#16473</a> on 2025-10-30 18:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2025-11-18 03:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-client/src/base_client.rs</code>:998 on 2025-11-18 03:19</div>
            <div class="timeline-body"><p>@assadyousuf here's a small <a href="https://github.com/user-attachments/files/23596368/0001-fix-add-tests-and-improve-detection.patch">patch file</a> you can apply with <code>git am &lt;patch-file&gt;</code> which includes a test and other small fixes and improvements. You'll need to rebase first as the patch depends on the changes from #16473.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2025-11-18 03:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-client/src/base_client.rs</code>:940 on 2025-11-18 03:23</div>
            <div class="timeline-body"><p>I briefly looked into this and <code>is_transient_network_error</code> is used more broadly throughout uv where as <code>handle</code> here is only in <code>uv-client</code>. DefaultRetryableStrategy.handle will actually not return fatal for TLS errors because it's always a connection error so the default handler (which returns transient) will kick in rather than <code>is_transient_network_error</code> being invoked in this code path.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2025-11-18 03:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-client/src/base_client.rs</code>:1008 on 2025-11-18 03:23</div>
            <div class="timeline-body"><p>This will be fixed with the suggestions from https://github.com/astral-sh/uv/pull/16245#discussion_r2536168502</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2025-11-18 03:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-client/src/base_client.rs</code>:1104 on 2025-11-18 03:31</div>
            <div class="timeline-body"><p>I proposed a tentative solution using an enum match to <code>rustls::Error</code> as part of https://github.com/astral-sh/uv/pull/16245#discussion_r2536168502 to this. Running manual checks across all cases in https://badssl.com/ and some others I could think of always resulted in a similar chain that luckily was able to be captured consistently at least from the testing that wad done (more testing may be needed).
This is a variant of the existing <code>find_source</code> implementation, but handles wrapped IO errors (where source was None) which was pervasive in TLS errors where the existing <code>find_source</code> failed to capture.</p>
<pre><code class="language-rust">fn find_source_with_io&lt;E: Error + 'static&gt;(orig: &amp;dyn Error) -&gt; Option&lt;&amp;E&gt; {
    let mut cause = orig.source();
    while let Some(err) = cause {
        if let Some(concrete_err) = err.downcast_ref() {
            return Some(concrete_err);
        }
        if let Some(io_err) = err.downcast_ref::&lt;io::Error&gt;() {
            if let Some(inner_err) = io_err.get_ref() {
                if let Some(concrete_err) = inner_err.downcast_ref() {
                    return Some(concrete_err);
                }
                cause = Some(inner_err);
                continue;
            }
        }
        cause = err.source();
    }
    None
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/messerli-wallace">@messerli-wallace</a> approved on 2025-11-18 19:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/assadyousuf">@assadyousuf</a> on 2025-11-18 21:52</div>
            <div class="timeline-body"><p>@messerli-wallace was that approval a mistake? I havent had time to read and resolve comments just yet</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-11-19 09:46</div>
            <div class="timeline-body"><p>This person is not associated with the project. You can see the different as grey checkmark vs the green checkmark of project members.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/assadyousuf">@assadyousuf</a> reviewed on 2025-11-30 05:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/assadyousuf">@assadyousuf</a> on <code>crates/uv-client/src/base_client.rs</code>:998 on 2025-11-30 05:26</div>
            <div class="timeline-body"><p>@samypr100 Thanks! Just applied your patch</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/assadyousuf">@assadyousuf</a> reviewed on 2025-11-30 06:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/assadyousuf">@assadyousuf</a> on <code>crates/uv-client/src/base_client.rs</code>:1104 on 2025-11-30 06:05</div>
            <div class="timeline-body"><p>@samypr100 Thanks for this, string matching was very janky</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/assadyousuf">@assadyousuf</a> reviewed on 2025-11-30 06:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/assadyousuf">@assadyousuf</a> on <code>crates/uv-client/src/base_client.rs</code>:1008 on 2025-11-30 06:05</div>
            <div class="timeline-body"><p>As mentioned, should be fixed in the above patch</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @assadyousuf on 2025-11-30 06:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @samypr100 by @assadyousuf on 2025-11-30 06:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @michael-o by @assadyousuf on 2025-11-30 06:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> approved on 2025-12-01 00:12</div>
            <div class="timeline-body"><p>looks good to me</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-12-02 12:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/base_client.rs</code>:940 on 2025-12-02 12:18</div>
            <div class="timeline-body"><p>Looking at the 4 places that have <code>Transient failure while handling</code>, only uv-publish uses the <code>UvRetryableStrategy</code>, which looks inconsistent. We should fix that to have a consistent handling across in another PR, ideally before duplicating this here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2025-12-06 04:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-client/src/base_client.rs</code>:940 on 2025-12-06 04:06</div>
            <div class="timeline-body"><p>Agreed, it does feel quite inconsistent currently.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-09 23:28:31 UTC
    </footer>
</body>
</html>
