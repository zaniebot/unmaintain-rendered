```yaml
number: 5644
title: "Use intersection rather than union for `requires-python`"
type: pull_request
state: closed
author: charliermarsh
labels:
  - bug
  - preview
assignees: []
base: main
head: charlie/min-requires-python
created_at: 2024-07-31T00:10:41Z
updated_at: 2025-12-09T14:19:34Z
url: https://github.com/astral-sh/uv/pull/5644
synced_at: 2026-01-10T01:57:38Z
```

# Use intersection rather than union for `requires-python`

---

_Pull request opened by @charliermarsh on 2024-07-31 00:10_

## Summary

As-is, if you have a workspace with mixed `requires-python` requirements, resolution will _never_ succeed, since we'll use the union as the `requires-python` bound (i.e., take the lowest value), and fail when we see the package that only supports some more narrow range.

This PR modifies the behavior to take the intersection (i.e., the highest value), so if you have one package that supports Python 3.12 and later, and another that supports Python 3.8 and later, we lock for Python 3.12. If you try to sync or run with Python 3.8, we raise an error, since the lockfile will be incompatible with that request.

Konsti has a write-up in https://github.com/astral-sh/uv/issues/5594 that outlines what could be a longer-term strategy.

Closes https://github.com/astral-sh/uv/issues/5578.


---

_Label `bug` added by @charliermarsh on 2024-07-31 00:10_

---

_Label `preview` added by @charliermarsh on 2024-07-31 00:10_

---

_Marked ready for review by @charliermarsh on 2024-07-31 00:10_

---

_Review requested from @konstin by @charliermarsh on 2024-07-31 00:12_

---

_Review requested from @zanieb by @charliermarsh on 2024-07-31 00:12_

---

_@charliermarsh reviewed on 2024-07-31 00:13_

---

_Review comment by @charliermarsh on `crates/uv/src/commands/project/mod.rs`:104 on 2024-07-31 00:13_

We can warn here, if people feel strongly. I'm not sure that we should, though, since users will see it _every_ time without any way to resolve it.

---

_Comment by @codspeed-hq[bot] on 2024-07-31 00:18_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/uv/branches/charlie/min-requires-python)

### Merging #5644 will **not alter performance**

<sub>Comparing <code>charlie/min-requires-python</code> (1566081) with <code>main</code> (8d14a4c)</sub>



### Summary

`✅ 13` untouched benchmarks






---

_@zanieb approved on 2024-07-31 02:04_

---

_Review comment by @konstin on `crates/uv/tests/sync.rs`:358 on 2024-07-31 08:03_

We should add a specific error message for this case that tells you how to run something on 3.8 with only bird-feeder.

---

_@konstin approved on 2024-07-31 08:03_

---

_Comment by @konstin on 2024-07-31 08:04_

Those codspeed numbers are dubious

---

_@charliermarsh reviewed on 2024-07-31 14:33_

---

_Review comment by @charliermarsh on `crates/uv/tests/sync.rs`:358 on 2024-07-31 14:33_

@konstin  -- What's the recommended workflow? Can we even support it right now?

---

_Comment by @konstin on 2024-07-31 14:50_

I just tried the following project layout:

```
.
├── packages
│   ├── bar
│   │   ├── pyproject.toml
│   │   └── src
│   │       └── bar
│   │           └── __init__.py
│   └── foo_lib
│       ├── pyproject.toml
│       └── src
│           └── foo_lib
│               └── __init__.py
├── pyproject.toml
├── README.md
└── uv.lock
```

bar:
```toml
[project]
name = "bar"
version = "0.1.0"
requires-python = ">=3.12"
dependencies = []

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"
```

foo_lib:
```toml
[project]
name = "foo-lib"
version = "0.1.0"
requires-python = ">=3.8"
dependencies = []

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"
```

When trying to `uv lock`, i get:

```
Using Python 3.12.1
  × No solution found when resolving dependencies:
  ╰─▶ Because the requested Python version (>=3.8) does not satisfy Python>=3.12 and bar==0.1.0
      depends on Python>=3.12, we can conclude that bar==0.1.0 cannot be used.
      And because only bar==0.1.0 is available and you require bar, we can conclude that the
      requirements are unsatisfiable.

      hint: The `requires-python` value (>=3.8) includes Python versions that are not supported by
      your dependencies (e.g., bar==0.1.0 only supports >=3.12). Consider using a more restrictive
      `requires-python` value (like >=3.12).
```

It seems that the PR currently forces the same requires-python across the workspace.

---

_@konstin reviewed on 2024-07-31 14:51_

---

_Review comment by @konstin on `crates/uv/tests/sync.rs`:358 on 2024-07-31 14:51_

I'd say we check if the request version is in the union, but not in the intersection, and if so, recommend `uv pip install -p 3.8 -e . <older-python-version-project>`, which _should_ work, i can test this after https://github.com/astral-sh/uv/pull/5644#issuecomment-2260706514

---

_Comment by @charliermarsh on 2024-07-31 14:56_

You must be running from `main`? It works fine for me on this PR, I just replicated it.

---

_Comment by @charliermarsh on 2024-07-31 14:57_

```toml
version = 1
requires-python = ">=3.12"

[[distribution]]
name = "bar"
version = "0.1.0"
source = { editable = "packages/bar" }

[[distribution]]
name = "foo-lib"
version = "0.1.0"
source = { editable = "packages/foo_lib" }

[[distribution]]
name = "root"
version = "0.1.0"
source = { editable = "." }
```

---

_Comment by @konstin on 2024-07-31 15:01_

Right branch but it was using `uv lock`, not `cargo run lock` :no_mouth: With this branch it actually works

---

_@charliermarsh reviewed on 2024-07-31 15:02_

---

_Review comment by @charliermarsh on `crates/uv/tests/sync.rs`:358 on 2024-07-31 15:02_

Yes, works.

---

_Comment by @charliermarsh on 2024-07-31 15:02_

Haha yeah. That's the exact problem this was designed to fix :joy:

---

_@konstin reviewed on 2024-07-31 15:02_

---

_Review comment by @konstin on `crates/uv/tests/sync.rs`:358 on 2024-07-31 15:02_

Now i checked the right way and `cargo run venv -p 3.8 && cargo run pip install -e packages/foo_lib/` indeed works.

---

_@charliermarsh reviewed on 2024-07-31 15:18_

---

_Review comment by @charliermarsh on `crates/uv/tests/sync.rs`:358 on 2024-07-31 15:18_

Will do separately.

---

_Merged by @charliermarsh on 2024-07-31 16:08_

---

_Closed by @charliermarsh on 2024-07-31 16:08_

---

_Branch deleted on 2024-07-31 16:08_

---

_Referenced in [astral-sh/uv#5662](../../astral-sh/uv/issues/5662.md) on 2024-07-31 16:09_

---

_Comment by @kasramozafari9-collab on 2025-12-09 14:16_

Kasra app

---

_@kasramozafari9-collab reviewed on 2025-12-09 14:17_

---

_Review comment by @kasramozafari9-collab on `crates/uv/tests/sync.rs`:358 on 2025-12-09 14:17_

Kasra app

---

_@kasramozafari9-collab reviewed on 2025-12-09 14:17_

---

_Review comment by @kasramozafari9-collab on `crates/uv/tests/sync.rs`:358 on 2025-12-09 14:17_

Kasra app

---
