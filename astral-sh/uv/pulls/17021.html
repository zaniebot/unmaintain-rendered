<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add free-threaded selector hint for requires-python - astral-sh/uv #17021</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add free-threaded selector hint for requires-python</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/pull/17021">#17021</a>
        opened by <a href="https://github.com/kxzk">@kxzk</a>
        on 2025-12-08 04:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kxzk">@kxzk</a></div>
            <div class="timeline-body">Summary
<p>When users specify a free-threaded Python version (e.g., <code>&gt;=3.14t</code>) in <code>requires-python</code>, the parse error doesn&#x27;t explain why the <code>t</code> suffix is invalid or what to do instead. This adds a hint to guide users toward the correct approach.</p>
<p><strong>Before:</strong></p>
<pre><code>error: Failed to parse: pyproject.toml
  Caused by: TOML parse error at line 4, column 19
  |
4 | requires-python = &quot;&gt;=3.14t&quot;
  |                   ^^^^^^^^^
Failed to parse version: after parsing 3.14, found t, which is not part of a valid version
</code></pre>
<p><strong>After:</strong></p>
<pre><code>error: Failed to parse: pyproject.toml
  Caused by: TOML parse error at line 4, column 19
  |
4 | requires-python = &quot;&gt;=3.14t&quot;
  |                   ^^^^^^^^^
Failed to parse version: after parsing 3.14, found t, which is not part of a valid version

hint: requires-python cannot include a free-threaded selector; use uv python pin 3.14t instead
</code></pre>
<p>Closes #16963</p>
Test Plan
<ul>
<li>Created a <code>pyproject.toml</code> with <code>requires-python = &quot;&gt;=3.14t&quot;</code> and verified the hint appears</li>
<li>Existing tests pass</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/kxzk">@kxzk</a> on <code>crates/uv-workspace/src/pyproject.rs</code>:247 on 2025-12-08 04:12</div>
            <div class="timeline-body"><p>Probably too naive. But where can I find a full list of free-threaded Python version variants so I know the correct logic to handle all cases?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kxzk">@kxzk</a> reviewed on 2025-12-08 04:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/kxzk">@kxzk</a> on 2025-12-08 04:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/Copilot">@Copilot</a> by <a href="https://github.com/kxzk">@kxzk</a> on 2025-12-08 04:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/copilot-pull-request-reviewer[bot]">@copilot-pull-request-reviewer[bot]</a> reviewed on 2025-12-08 05:00</div>
            <div class="timeline-body">Pull request overview
<p>This PR adds a helpful hint when users attempt to use free-threaded Python version selectors (e.g., <code>&gt;=3.14t</code>) in <code>requires-python</code> fields. Since free-threaded selectors are not valid in PEP 440 version specifiers, the hint guides users to use <code>uv python pin</code> instead.</p>
<ul>
<li>Introduces <code>RequiresPythonSpecifiers</code> wrapper type around <code>VersionSpecifiers</code> with custom deserialization</li>
<li>Detects the specific pattern of free-threaded selector errors (<code>t</code> suffix after a digit)</li>
<li>Updates <code>Project</code> and <code>DependencyGroupSettings</code> to use the new wrapper type</li>
</ul>
Reviewed changes
<p>Copilot reviewed 4 out of 4 changed files in this pull request and generated 1 comment.</p>
<p>| File | Description |
| ---- | ----------- |
| <code>crates/uv-workspace/src/pyproject.rs</code> | Adds <code>RequiresPythonSpecifiers</code> wrapper type with custom deserializer, updates <code>Project</code> and <code>DependencyGroupSettings</code> to use it, includes comprehensive tests |
| <code>crates/uv-workspace/src/workspace.rs</code> | Calls <code>.into_inner()</code> to extract <code>VersionSpecifiers</code> from <code>RequiresPythonSpecifiers</code> when needed, adds explanatory comments |
| <code>crates/uv-workspace/src/dependency_groups.rs</code> | Adds comment explaining why <code>FlatDependencyGroup</code> uses <code>VersionSpecifiers</code> directly |
| <code>uv.schema.json</code> | Adds <code>RequiresPythonSpecifiers</code> schema definition and references it in <code>DependencyGroupSettings</code> |</p>
<hr>
<p>ðŸ’¡ <a href="/astral-sh/uv/new/main/.github/instructions?filename=*.instructions.md">Add Copilot custom instructions</a> for smarter, more guided reviews. <a href="https://docs.github.com/en/copilot/customizing-copilot/adding-repository-custom-instructions-for-github-copilot">Learn how to get started</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Copilot">@Copilot</a> on <code>uv.schema.json</code>:1856 on 2025-12-08 05:00</div>
            <div class="timeline-body"><p>The <code>RequiresPythonSpecifiers</code> definition is missing a description. For consistency with other schema definitions like <code>RequiredVersion</code> and <code>Requirement</code>, consider adding a description explaining what this type represents.</p>
<p>Suggested addition:</p>
<pre><code>&quot;RequiresPythonSpecifiers&quot;: {
  &quot;description&quot;: &quot;A PEP 440 version specifier for Python compatibility, e.g., `&gt;=3.8` or `&gt;=3.8,&lt;3.13`.&quot;,
  &quot;type&quot;: &quot;string&quot;
}
</code></pre>
<pre><code>    &quot;RequiresPythonSpecifiers&quot;: {
      &quot;description&quot;: &quot;A PEP 440 version specifier for Python compatibility, e.g., `&gt;=3.8` or `&gt;=3.8,&lt;3.13`.&quot;,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kxzk">@kxzk</a> on 2025-12-08 19:23</div>
            <div class="timeline-body"><p>CI failures are transient - <code>python_install_emulated_windows_x86_on_x64</code> timed out at harness level despite completing successfully, and DNF hit a mirror outage (<code>No URLs in mirrorlist</code>). Unrelated to this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-09 21:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-workspace/src/pyproject.rs</code>:247 on 2025-12-09 21:03</div>
            <div class="timeline-body"><p>I think I&#x27;d expect to use <code>uv_python::VersionRequest::from_str</code> and check <code>request.variant().is_freethreaded()</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-09 21:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-workspace/src/pyproject.rs</code>:2000 on 2025-12-09 21:05</div>
            <div class="timeline-body"><p>I think I&#x27;d probably do an inline snapshot of the error instead of asserting</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-09 21:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-workspace/src/workspace.rs</code>:608 on 2025-12-09 21:06</div>
            <div class="timeline-body"><p>I don&#x27;t think we need to include this comment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-09 21:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-workspace/src/pyproject.rs</code>:771 on 2025-12-09 21:07</div>
            <div class="timeline-body"><p>Was this important?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-09 21:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-workspace/src/dependency_groups.rs</code>:26 on 2025-12-09 21:07</div>
            <div class="timeline-body"><p>I think it&#x27;d probably be okay to omit this comment, though I don&#x27;t feel strongly</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-workspace/src/pyproject.rs</code>:203 on 2025-12-09 21:08</div>
            <div class="timeline-body"><pre><code>/// A wrapper specializing [`VersionSpecifiers`] for `requires-python` fields.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-09 21:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-09 21:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-workspace/src/pyproject.rs</code>:247 on 2025-12-09 21:08</div>
            <div class="timeline-body"><p>(or pull out the variant parsing from there so we can re-use it?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kxzk">@kxzk</a> reviewed on 2025-12-15 02:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/kxzk">@kxzk</a> on <code>crates/uv-workspace/src/pyproject.rs</code>:247 on 2025-12-15 02:22</div>
            <div class="timeline-body"><p>First suggestion makes sense to me if you&#x27;re okay adding <code>uv-python</code> as a dep to <code>uv-workspace</code>. For the second <code>uv-pep440</code> seems plausible (both crates already depend on it). To keep a single source of truth, <code>uv-python</code> would also need to use it, which expands scope. Happy to go either route - what&#x27;s your preference?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kxzk">@kxzk</a> reviewed on 2025-12-15 02:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/kxzk">@kxzk</a> on <code>crates/uv-workspace/src/pyproject.rs</code>:2000 on 2025-12-15 02:22</div>
            <div class="timeline-body"><p>Got it, makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kxzk">@kxzk</a> reviewed on 2025-12-15 02:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/kxzk">@kxzk</a> on <code>crates/uv-workspace/src/pyproject.rs</code>:771 on 2025-12-15 02:31</div>
            <div class="timeline-body"><p>It was, but not anymore - <code>VersionSpecifiers</code> doesn&#x27;t implement <code>JsonSchema</code>, so the attribute was required. The new <code>RequiresPythonSpecifiers</code> wrapper implements it directly, making the override redundant. Obviously, this is subject to change based on the final impl.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:54:52 UTC
    </footer>
</body>
</html>
