<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Better detection for conflicting packages - astral-sh/uv #17623</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Better detection for conflicting packages</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/pull/17623">#17623</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2026-01-20 13:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>In the previous iteration, conflict detection was based on top level modules. This would work if all namespace packages correctly omitted the <code>__init__.py</code>, but e.g. the nvidia packages include an empty <code>nvida/__init__.py</code>.</p>
<p>Instead, we track overlapping top level modules during installation and perform conflict analysis after installation, recursing only as far as necessary.</p>
<p>See <a href="https://github.com/astral-sh/uv/pull/13437">astral-sh/uv#13437</a> for a list of reported conflicts.</p>
<p>Before:</p>
<pre><code>$ uv venv -c -q &amp;&amp; uv pip install --preview nvidia-nvjitlink-cu12==12.8.93 nvidia-nvtx-cu12==12.8.90
  Resolved 2 packages in 0.99ms
  ░░░░░░░░░░░░░░░░░░░░ [0/2] Installing wheels...                                                    warning: The module `nvidia` is provided by more than one package, which causes an install race condition and can result in a broken module. Consider removing your dependency on either `nvidia-nvtx-cu12` (v12.8.90) or `nvidia-nvjitlink-cu12` (v12.8.93).
  Installed 2 packages in 3ms
   + nvidia-nvjitlink-cu12==12.8.93
   + nvidia-nvtx-cu12==12.8.90
</code></pre>
<p>After:</p>
<pre><code>$ uv venv -c -q &amp;&amp; cargo run -q pip install --preview nvidia-nvjitlink-cu12==12.8.93 nvidia-nvtx-cu12==12.8.90
  Resolved 2 packages in 3ms
  Installed 2 packages in 4ms
   + nvidia-nvjitlink-cu12==12.8.93
   + nvidia-nvtx-cu12==12.8.90
</code></pre>
<p>Still detected true positive:</p>
<pre><code>$ uv venv -c -q &amp;&amp; cargo run -q pip install --no-progress opencv-python opencv-contrib-python --no-build --no-deps --preview
  Resolved 2 packages in 5ms
warning: The file `cv2/__init__.pyi` is provided by more than one package, which causes an install race condition and can result in a broken module. Packages containing the file:
* opencv-contrib-python (opencv_contrib_python-4.13.0.90-cp37-abi3-manylinux_2_28_x86_64.whl)
* opencv-python (opencv_python-4.13.0.90-cp37-abi3-manylinux_2_28_x86_64.whl)
Installed 2 packages in 6ms
 + opencv-contrib-python==4.13.0.90
 + opencv-python==4.13.0.90
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/EliteTK">@EliteTK</a> by <a href="https://github.com/konstin">@konstin</a> on 2026-01-20 13:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/konstin">@konstin</a> on 2026-01-20 13:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/tests/it/pip_install.rs</code>:13402 on 2026-01-20 13:59</div>
            <div class="timeline-body"><p>This comment seems to contradict the output now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/tests/it/pip_install.rs</code>:13362 on 2026-01-20 13:59</div>
            <div class="timeline-body"><pre><code>    // This file collides too, but we always show the first file.
</code></pre>
<p>Typo I think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv/tests/it/pip_install.rs</code>:13394 on 2026-01-20 13:59</div>
            <div class="timeline-body"><pre><code>    // This file collides too, but we always show the first file.
</code></pre>
<p>ditto</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-installer/src/installer.rs</code>:202 on 2026-01-20 14:04</div>
            <div class="timeline-body"><p>I think we should print the error chain here. Similarly to this:</p>
<p>https://github.com/astral-sh/uv/blob/f793b182edab2fea4a9d37fcef3cb4546de583b1/crates/uv-python/src/discovery.rs#L1565-L1574</p>
<p>I was going to say we could centralise the implementation... But there&#x27;s no direct way to do that.</p>
<p>Maybe for now just merge as is, or copy the code and adjust it, and then I will propose something as a PR later...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-install-wheel/src/linker.rs</code>:27 on 2026-01-20 18:54</div>
            <div class="timeline-body"><p>Maybe the <code>struct</code> should itself also be renamed to more closely reflect its use... Although I am not sure what that name should be.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-install-wheel/src/linker.rs</code>:62 on 2026-01-20 22:18</div>
            <div class="timeline-body"><p>Since this ends up being turned into a <code>Path</code> on the other side, I think it makes sense to make the key type here a <code>PathBuf</code> and avoid the noise.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-install-wheel/src/linker.rs</code>:156 on 2026-01-20 22:43</div>
            <div class="timeline-body"><p>We never pass <code>files</code> outside of this function so it can hold references.</p>
<pre><code>                        .insert((wheel, dir_entry.metadata()?.len()));
</code></pre>
<p>You&#x27;ll need to edit the type signature above too (although you can switch the key types to placeholders as they can be inferred).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-install-wheel/src/linker.rs</code>:161 on 2026-01-20 22:43</div>
            <div class="timeline-body"><pre><code>                        .insert((wheel.clone(), dir_entry.path()));
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-install-wheel/src/linker.rs</code>:161 on 2026-01-20 22:46</div>
            <div class="timeline-body"><p>Technically the wheel clone could be dropped here too if you feel like it. But it would require some reshuffling so not sure it&#x27;s totally worth it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-install-wheel/src/linker.rs</code>:148 on 2026-01-20 23:03</div>
            <div class="timeline-body"><p>It seems justifiable to compare contents lazily if the sizes match and aren&#x27;t zero.</p>
<p>It would only happen when there are overlapping files (rare) with identical sizes (rarer). But it would ensure that we&#x27;re not under-reporting in extremely rare cases which definitely <em>will</em> cause a problem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-install-wheel/src/linker.rs</code>:57 on 2026-01-20 23:16</div>
            <div class="timeline-body"><p>Given the doc comment, it&#x27;s kind of confusing for it to take &quot;relative&quot; (<code>&amp;Path</code>) at all.</p>
<p>I think one of these may be preferable:</p>
<ul>
<li>It could take an absolute path and a module name (i.e. <code>Component</code>) and the responsibility on passing just the module name should fall on the parent.</li>
<li>The function could just be renamed and the doc comment reworded?</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-install-wheel/src/linker.rs</code>:148 on 2026-01-20 23:23</div>
            <div class="timeline-body"><pre><code></code></pre>
<p>Sorting here doesn&#x27;t affect the iteration order for <code>BTreeMap</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> approved on 2026-01-20 23:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2026-01-21 08:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-install-wheel/src/linker.rs</code>:27 on 2026-01-21 08:29</div>
            <div class="timeline-body"><p>Stuck at the same question of naming :sweat_smile:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-install-wheel/src/linker.rs</code>:156 on 2026-01-21 09:03</div>
            <div class="timeline-body"><p>~~The problem is that when we recurse we need a <code>&amp;BTreeSet&lt;(WheelFilename, PathBuf)&gt;</code> instead of a <code>&amp;BTreeSet&lt;(&amp;WheelFilename, PathBuf)&gt;</code>, while the initial call has a <code>&amp;BTreeSet&lt;(WheelFilename, PathBuf)&gt;</code>, I took the easy way out and cloned (we could do some <code>IntoIterator</code> but it doesn&#x27;t seem worth it).~~ Oh that&#x27;s the other path</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2026-01-21 09:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2026-01-21 09:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-install-wheel/src/linker.rs</code>:148 on 2026-01-21 09:04</div>
            <div class="timeline-body"><p>Good catch - That is now redundant due to the <code>BTreeSet</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2026-01-21 09:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-install-wheel/src/linker.rs</code>:148 on 2026-01-21 09:13</div>
            <div class="timeline-body"><p>I can see some silly case where both wheels contain the exact same 50MB shared library or something, and we&#x27;d have to read both to check (where we currently only reflink/hardlink in the default case and don&#x27;t need to read files from disk at all). It seems very unlikely to have two package that use the same module name with different file contents but the same file sizes, so I opted for the less precise heuristic in this performance critical path.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2026-01-21 09:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-install-wheel/src/linker.rs</code>:57 on 2026-01-21 09:13</div>
            <div class="timeline-body"><p>I&#x27;ve renamed the function and made it about paths instead of modules, that matches much better what it&#x27;s about now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2026-01-21 09:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-installer/src/installer.rs</code>:202 on 2026-01-21 09:54</div>
            <div class="timeline-body"><p>Ideally we&#x27;d be resilient to errors and report as much as we can, but I&#x27;ll cut scope here due to the nature of this feature as a check for something that&#x27;s broken configuration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2026-01-21 10:03</div>
            <div class="timeline-body"><p>Thank you for the great review!</p>
<p>I added an explicit check for files directly in site-packages now too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2026-01-21 10:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-install-wheel/src/linker.rs</code>:148 on 2026-01-21 10:31</div>
            <div class="timeline-body"><p>Hmm... I guess we could get into the statistics of this and add a size cut off. (Files aren&#x27;t uniformly random, so it&#x27;s slightly more complicated than this but...) Larger files with identical sizes are less likely to have identical contents than smaller files with identical sizes. Or we could just limit how many initial bytes we compare.</p>
<p>But I think it may be a little bit much. I&#x27;d just leave it be for now. Just wanted to write down my thoughts.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2026-01-21 10:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-install-wheel/src/linker.rs</code>:148 on 2026-01-21 10:32</div>
            <div class="timeline-body"><p>I think this:</p>
<pre><code>/// It&#x27;s unlikely that two modules overlap with different contents but their files all have
/// the same length, so we use this heuristic in this performance critical path to avoid
/// reading potentially large files.
</code></pre>
<p>is the key insight here. That it&#x27;s unlikely that every single file will have the same size but there will be a difference.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-21 11:04:11 UTC
    </footer>
</body>
</html>
