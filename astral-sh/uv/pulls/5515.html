<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>feat(venv): add relocatable flag - astral-sh/uv #5515</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>feat(venv): add relocatable flag</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/5515">#5515</a>
        opened by <a href="https://github.com/paveldikov">@paveldikov</a>
        on 2024-07-28 14:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/paveldikov">@paveldikov</a> on 2024-07-28 14:19</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Adds a <code>--relocatable</code> CLI arg to <code>uv venv</code>. This flag does two things:</p>
<ul>
<li>ensures that the associated activation scripts do not rely on a hardcoded
absolute path to the virtual environment (to the extent possible; <code>.csh</code> and
<code>.nu</code> left as-is)</li>
<li>persists a <code>relocatable</code> flag in <code>pyvenv.cfg</code>.</li>
</ul>
<p>The flag in <code>pyvenv.cfg</code> in turn instructs the wheel <code>Installer</code> to create script
entrypoints in a relocatable way (use <code>exec</code> trick + <code>dirname $0</code> on POSIX;
use relative path to <code>python[w].exe</code> on Windows).</p>
<p>Fixes: #3863</p>
<!-- What's the purpose of the change? What does it do, and why? -->

<h2>Test Plan</h2>
<ul>
<li>Relocatable console scripts covered as additional scenarios in existing test cases.</li>
<li>Integration testing of boilerplate generation in <code>venv</code>.</li>
<li>Manual testing of <code>uv venv</code> with and without <code>--relocatable</code></li>
</ul>
<!-- How was it tested? -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2024-07-28 16:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-cli/src/lib.rs</code>:1760 on 2024-07-28 16:53</div>
            <div class="timeline-body"><p>Likely worth marking this as a preview/experimental flag</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/paveldikov">@paveldikov</a> reviewed on 2024-07-28 17:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/paveldikov">@paveldikov</a> on <code>crates/uv-cli/src/lib.rs</code>:1760 on 2024-07-28 17:00</div>
            <div class="timeline-body"><p>would that be a simple <code>hide = true</code>, or is there a special annotation for that? (couldn't find one)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-28 17:08</div>
            <div class="timeline-body"><p>This has a little bit of overlap with #5509 which just does the installer piece and isn't exposed to users.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-28 17:13</div>
            <div class="timeline-body"><p>One potential issue here is that users can't use <code>relocatable</code> with <code>--target</code> or <code>--prefix</code>, since those commands don't operate within a virtualenv ðŸ¤”</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2024-07-28 17:17</div>
            <div class="timeline-body"><blockquote>
<p>This has a little bit of overlap with #5509 which just does the installer piece and isn't exposed to users.</p>
</blockquote>
<p>Yes, I see that! Feel free to cherry-pick pieces out of this as you see fit (and vice versa -- let me know if I am straying too far away from the direction you had in mind)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2024-07-28 17:24</div>
            <div class="timeline-body"><blockquote>
<p>One potential issue here is that users can't use <code>relocatable</code> with <code>--target</code> or <code>--prefix</code>, since those commands don't operate within a virtualenv ðŸ¤”</p>
</blockquote>
<p>I thought <code>--python</code> was vastly more recommended for this very reason?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @paveldikov on 2024-07-28 17:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-07-28 17:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/install-wheel-rs/src/wheel.rs</code>:134 on 2024-07-28 17:28</div>
            <div class="timeline-body"><p>Does this assume that the relative path doesn't contain multiple segments? (That's true for virtual environments, but could be false in general, right?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-28 17:29</div>
            <div class="timeline-body"><blockquote>
<p>Yes, I see that! Feel free to cherry-pick pieces out of this as you see fit (and vice versa -- let me know if I am straying too far away from the direction you had in mind)</p>
</blockquote>
<p>Sounds good! Ultimately pretty similar, I'll likely merge yours first.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/paveldikov">@paveldikov</a> on <code>crates/install-wheel-rs/src/wheel.rs</code>:134 on 2024-07-28 17:30</div>
            <div class="timeline-body"><p>On second thought, this check is probably unnecessary and I might just pass the already-known <code>is_relocatable</code> as an argument, rather than trying to reverse-engineer it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/paveldikov">@paveldikov</a> reviewed on 2024-07-28 17:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-28 17:32</div>
            <div class="timeline-body"><p>We might want to add some tests by wiring this up through <code>TestContext</code> (perhaps with a new constructor to make it easiest).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2024-07-28 17:35</div>
            <div class="timeline-body"><blockquote>
<p>We might want to add some tests by wiring this up through <code>TestContext</code> (perhaps with a new constructor to make it easiest).</p>
</blockquote>
<p>I'll try to dig a little deeper tonight, but if you have examples of similar tests handy, that would be grand!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-28 17:37</div>
            <div class="timeline-body"><p>@paveldikov -- A basic test would be like <code>install_many</code> in <code>pip_sync.rs</code>. I think we just want light coverage for, like: installing and importing a package; installing and running a script; moving the virtualenv (even just renaming) and doing the same.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/paveldikov">@paveldikov</a> reviewed on 2024-07-28 17:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/paveldikov">@paveldikov</a> on <code>crates/install-wheel-rs/src/wheel.rs</code>:134 on 2024-07-28 17:37</div>
            <div class="timeline-body"><p>Refactored.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-28 17:37</div>
            <div class="timeline-body"><p>You can run <code>cargo test -p uv --test pip_sync install_many</code> to run an individual test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2024-07-28 17:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-cli/src/lib.rs</code>:1760 on 2024-07-28 17:55</div>
            <div class="timeline-body"><p>I was thinking using <code>PreviewMode</code> for this in <code>venv_impl</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/paveldikov">@paveldikov</a> reviewed on 2024-07-28 19:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/paveldikov">@paveldikov</a> on <code>crates/uv-cli/src/lib.rs</code>:1760 on 2024-07-28 19:01</div>
            <div class="timeline-body"><p>Added warning (assuming that's what you meant?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-07-28 19:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-cli/src/lib.rs</code>:1760 on 2024-07-28 19:04</div>
            <div class="timeline-body"><p>Yes, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2024-07-28 19:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2024-07-28 19:06</div>
            <div class="timeline-body"><p>Added a test case for the boilerplate on the <code>venv</code> side. Let me know if there are other areas in the critical path that you'd like to see covered -- I've mostly focussed on the two extremities (<code>venv</code> and <code>installer</code>) since this is where most of the action is happening.</p>
<p>edit: woops, saw that you'd asked for</p>
<ul>
<li>covering package install scenario</li>
<li>check if renaming venv base dir makes entrypoint still work</li>
</ul>
<p>Going to add those in. Does any of the already-existing stub packages in <code>scripts/</code> contain meaningful console_scripts?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2024-07-28 20:36</div>
            <div class="timeline-body"><p>Added coverage for <code>pip_install</code>.</p>
<blockquote>
<p>installing and importing a package; installing and running a script; moving the virtualenv (even just renaming) and doing the same.</p>
</blockquote>
<p>Unless I'm reading this wrong, running a console script also implies importing the package, so I didn't handle that separately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @paveldikov on 2024-07-28 20:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-28 20:46</div>
            <div class="timeline-body"><p>Thank you! Haven't reviewed yet but per your last question, I believe <code>black_editable</code> has an entrypoint at least.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2024-07-28 20:47</div>
            <div class="timeline-body"><blockquote>
<p>I believe black_editable has an entrypoint at least.</p>
</blockquote>
<p>Yep, I did find it and used it specifically for its Hello World :-P</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-28 23:24</div>
            <div class="timeline-body"><p>Cool, this generally looks good to me! I'm going to make a few small tweaks to make it a bit easier to rebase #5509, but not anticipating any major changes. Thank you for the tests too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/install-wheel-rs/src/wheel.rs</code>:146 on 2024-07-28 23:27</div>
            <div class="timeline-body"><p>What's the benefit of this over just <code>dirname $0</code> alone as in https://github.com/astral-sh/uv/pull/5509/files#diff-c1686969b46b2c133e184a8c25069ada51363d91354e35fac208bb67239fcf2cR183? (I have no idea!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-07-28 23:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-07-28 23:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @charliermarsh on 2024-07-29 00:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-07-29 00:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/install-wheel-rs/src/linker.rs</code>:40 on 2024-07-29 00:04</div>
            <div class="timeline-body"><p>I moved these next to each other because part of me wishes that it were on <code>Layout</code> (though I don't think creating <code>layout</code> should require querying the filesystem, so leaving them separate).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-07-29 00:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-07-29 00:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-29 00:11</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2024-07-29 03:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/install-wheel-rs/src/wheel.rs</code>:146 on 2024-07-29 03:07</div>
            <div class="timeline-body"><p>Seems like there's a check if the directory exists (avoiding readlink/realpath friends) before substituting it with PWD which makes this a bit more cross-posix-platform and handle a couple error scenarios. Interestingly enough, I'd expect the <code>/</code> to be inside the echo though if this was the intention? Unless it's expected if cd fails that the output is <code>&quot;/&quot;</code> instead of <code>&quot;&quot;</code>. Thoughts?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2024-07-29 03:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-virtualenv/src/activator/activate.bat</code>:22 on 2024-07-29 03:08</div>
            <div class="timeline-body"><p>This seems to be for expanding a relative path in command prompt since the previous command didn't, awesome!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/paveldikov">@paveldikov</a> reviewed on 2024-07-29 07:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/paveldikov">@paveldikov</a> on <code>crates/install-wheel-rs/src/wheel.rs</code>:146 on 2024-07-29 07:40</div>
            <div class="timeline-body"><blockquote>
<p>Seems like there's a check if the directory exists (avoiding readlink/realpath friends) before substituting it with PWD which makes this a bit more cross-posix-platform and handle a couple error scenarios.</p>
</blockquote>
<p>Yes, that's exactly it, <code>readlink -f</code> and <code>realpath</code> are a real POSIX-feature-availability-matrix nightmare, so that's what the <code>CDPATH= cd -- SOME_PATH &amp;&amp; echo &quot;$PWD&quot;</code> part is -- a cross-platform way of doing <code>realpath SOME_PATH</code>.</p>
<p>The <code>--</code> bits in the middle are there to ensure that <code>$0</code> is parsed as a <em>positional argument</em> (and never as an <em>option</em>), just in case decided to call their console script <code>-myscript</code> ;^)</p>
<blockquote>
<p>Interestingly enough, I'd expect the / to be inside the echo though if this was the intention? Unless it's expected if cd fails that the output is &quot;/&quot; instead of &quot;&quot;. Thoughts?</p>
</blockquote>
<p>There was no intention behind the slash's positioning, to be honest -- if the <code>echo</code> fails we are in undefined territory -- I think I really just placed it according to my aesthetic whims! Perhaps a <code>set -eo pipefail</code> could further harden this boilerplate to ensure that it fails fast? (need to check if this is portable, though)</p>
<p>I guess one might argue that resolving the path down to absolute is not needed in the first place! I guess that would strip much of the complexity off, leaving you with <code>r#&quot;&quot;$(dirname -- &quot;$0&quot;)/&quot;&quot;#</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/paveldikov">@paveldikov</a> reviewed on 2024-07-29 07:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/paveldikov">@paveldikov</a> on <code>crates/install-wheel-rs/src/linker.rs</code>:40 on 2024-07-29 07:46</div>
            <div class="timeline-body"><p>I did originally put this inside of <code>Layout</code>, but for some reason decided to back out of that.</p>
<blockquote>
<p>(though I don't think creating layout should require querying the filesystem, so leaving them separate).</p>
</blockquote>
<p>Could use the <code>layout.as_relocatable()</code> pattern? (only mark it as relocatable if specifically requested by the caller)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/chrisrodrigue">@chrisrodrigue</a> on 2024-07-30 09:47</div>
            <div class="timeline-body"><p>Please excuse my ignoranceâ€¦ does this mean that portable virtual environments are possible now?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/paveldikov">@paveldikov</a> on 2024-07-30 20:59</div>
            <div class="timeline-body"><blockquote>
<p>Please excuse my ignoranceâ€¦ does this mean that portable virtual environments are possible now?</p>
</blockquote>
<p>It depends -- a lot of people, myself included, would be wary of using the word 'portable'. (it could imply factors such as host OS or system architecture, in which case: no, these environments are defintely not portable.) But on a high level, yes, <em>assuming</em> a homogenised host environment, these virtual environments can be shipped around from one host to another with most (if not all) functionality being retained.</p>
<p>(also, this is a preview feature, so I imagine it is probably premature to talk of it as a done deal. Matter of fact, I just found a bug with the activate script on <code>ksh</code>, which I am now to fix!)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 13:37:39 UTC
    </footer>
</body>
</html>
