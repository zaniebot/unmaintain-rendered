<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Introduce `default-source` to slim lockfile - astral-sh/uv #5884</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Introduce <code>default-source</code> to slim lockfile</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/5884">#5884</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2024-08-07 18:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/konstin">@konstin</a> on 2024-08-07 18:18</div>
            <div class="timeline-body"><p>Currently, we're repeating the same <code>source</code> line for every package, so the lockfiles have a lot of:</p>
<pre><code class="language-toml">source = { registry = &quot;https://pypi.org/simple&quot; }
</code></pre>
<p>This PR introduces a top level <code>default-source</code> entry set to the default index URL, if any. When the source matches, we don't repeat the <code>source</code> entry. This reduces the number of lines in <code>uv.lock</code> noticeably across the board:</p>
<ul>
<li>A small data science project: 421 -&gt; 394</li>
<li>A small bot: 455 -&gt; 426</li>
<li>Transformers: 5683 -&gt; 5419</li>
<li>Warehouse: 4632 -&gt; 4306</li>
<li>Airflow: 2709 -&gt; 2576</li>
</ul>
<p>Caveat: We don't have good multi-index coverage (#5882).</p>
<p>3/3 for #4893, closes #4893</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-07 20:39</div>
            <div class="timeline-body"><p>What if the default source is never used? Does it still end up in the lockfile?</p>
<p>I wonder if we should only do this when there's exactly one source.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-07 20:49</div>
            <div class="timeline-body"><p>I'm not sure those line count changes justify the increased complexity?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-08-07 20:56</div>
            <div class="timeline-body"><blockquote>
<p>What if the default source is never used? Does it still end up in the lockfile?</p>
</blockquote>
<p>It would, do we have cases where that happens?</p>
<blockquote>
<p>I wonder if we should only do this when there's exactly one source.</p>
</blockquote>
<p>Happy to bikeshed the exact semantics, we're not having good coverage of multi-index scenarios right now.</p>
<blockquote>
<p>I'm not sure those line count changes justify the increased complexity?</p>
</blockquote>
<p>The complexity didn't significantly increase much imho. The one thing that does get worse is that it's harder to audit which package is from which source.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-07 22:27</div>
            <div class="timeline-body"><p>I think I'm in favor but I'd probably prefer: we just write it as <code>source</code> (not <code>default-source</code>), and we only do it if the source is the same for every package.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-07 23:43</div>
            <div class="timeline-body"><p>I'm fine with that though it's a big diff once you add a second source â€” I don't fully understand the motivation for this change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-07 23:44</div>
            <div class="timeline-body"><p>It makes the lockfile much more succinct by removing redundant information.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-08 02:22</div>
            <div class="timeline-body"><p>Is it much more succinct though? We're talking about 20 lines in a 400 line file.</p>
<p>(I think I see the argument for it being less noisy when there is a single source, but I'm not sure it's worth the added diff when another source is added)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-08 02:25</div>
            <div class="timeline-body"><p>For the larger lockfiles it's about a 4-7% saving. I dunno, it seems reasonable to me, but I can go either way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-09 01:40</div>
            <div class="timeline-body"><p>We decided (in our 1:1) to defer this for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-08-09 01:40</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 13:32:10 UTC
    </footer>
</body>
</html>
