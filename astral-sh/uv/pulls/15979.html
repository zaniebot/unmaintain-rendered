<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add X-Error-Message header for error context - astral-sh/uv #15979</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add X-Error-Message header for error context</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/15979">#15979</a>
        opened by <a href="https://github.com/doddi">@doddi</a>
        on 2025-09-22 13:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/doddi">@doddi</a></div>
            <div class="timeline-body">

Summary
<p>HTTP1.1 <a href="https://www.rfc-editor.org/rfc/rfc9112.html#name-status-line">RFC 9112 - HTTP/1.1</a> section 4 defines the response status code to optionally include a text description (human readable) of the reason for the status code.</p>
<p><a href="https://www.rfc-editor.org/rfc/rfc9113">RFC9113 - HTTP/2</a> is the HTTP2 protocol standard and the response status only considers the <a href="https://www.rfc-editor.org/rfc/rfc9113#name-response-pseudo-header-fiel">status code</a> and not the reason phrase, as such important information can be lost in helping the client determine a route cause of a failure.</p>


Purpose
<p>Allow error header in a HEAD response</p>
<p>Similar to <a href="https://github.com/huggingface/huggingface_hub/blob/e5c84bcc04ab32f2b2d2f5733cbd2b54f759876a/src/huggingface_hub/utils/_http.py#L411">huggingface</a> have a X-Error-Code and a X-Error-Message header.</p>
<p>X-Error-Code: defines a grouping of the error type
X-Error-Message: detailed message enhancing the reason for the failure</p>
<p>For this PR I opted to only consider the <code>X-Error-Message</code> header to avoid making the solution overly complicated for its need.</p>
<p>This will allow the following:</p>
<ul>
<li>Enhance the information displayed to the user when an error status is received. Both HEAD and GET requests will be able to provide context.</li>
<li>This solution will allow error information to be transmitted over any http version.</li>
</ul>
Test Plan
<p>Created a server that additionally add a <code>X-Error-Message</code> header response when an error occurs. Observe in the cli that the message is displayed verbatim.</p>


<p><img alt="image" src="https://github.com/user-attachments/assets/1b20f7a6-4021-4d90-a33b-f7c6acb45077"></p>
<p>Note: There are 2 entries for the error in the screenshot above because this test was over http1.1 which additionally sends the same message in the &#x27;traditional&#x27; errorPhrase section.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-resolver/src/pubgrub/report.rs</code>:1586 on 2025-09-22 13:42</div>
            <div class="timeline-body"><p>This is a bit drive-by, as I haven&#x27;t had time to look at the rest of the pull request in depth, but... it seems wrong to drop the rest of our messaging here. Can you explain the motivation for that? I&#x27;d expect the custom messaging to just be an addendum.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-09-22 13:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/doddi">@doddi</a> reviewed on 2025-09-22 13:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/doddi">@doddi</a> on <code>crates/uv-resolver/src/pubgrub/report.rs</code>:1586 on 2025-09-22 13:49</div>
            <div class="timeline-body"><p>I can update to include the existing messaging (not drop) üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/doddi">@doddi</a> reviewed on 2025-09-22 13:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/doddi">@doddi</a> on <code>crates/uv-resolver/src/pubgrub/report.rs</code>:1586 on 2025-09-22 13:58</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/uv/pull/15979/commits/f686147981142b710693b16c49af08a039db4ef7</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-09-25 09:05</div>
            <div class="timeline-body"><p>I see there&#x27;s an example in the screenshot, but can you say a bit more about which server uses this header and how, so we get a complete picture of the user experience?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/cached_client.rs</code>:595 on 2025-09-25 09:06</div>
            <div class="timeline-body"><p>Why only for those status codes?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/cached_client.rs</code>:597 on 2025-09-25 09:08</div>
            <div class="timeline-body"><p>nit: inline this function</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/error.rs</code>:475 on 2025-09-25 09:09</div>
            <div class="timeline-body"><p>We need to show that this is something coming from the server and not uv or the os, e.g. <code>Server says:</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-distribution-types/src/status_code_strategy.rs</code>:107 on 2025-09-25 09:14</div>
            <div class="timeline-body"><p>Do we need to recurse here or can we do an early return for <code>Self::IgnoreErrorCodes</code> and <code>status_codes.contains(&amp;status_code)</code> instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/cached_client.rs</code>:588 on 2025-09-25 09:19</div>
            <div class="timeline-body"><p>I would make this a <code>WrappedReqwestError</code> method - it seems useful to have this universally available.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/error.rs</code>:502 on 2025-09-25 09:20</div>
            <div class="timeline-body"><p>Can you add an integration test? There are some references with <code>MockServer</code> e.g. in <code>pip_install.rs</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-09-25 09:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/woodruffw">@woodruffw</a> on 2025-09-25 15:36</div>
            <div class="timeline-body"><blockquote>
<p>I see there&#x27;s an example in the screenshot, but can you say a bit more about which server uses this header and how, so we get a complete picture of the user experience?</p>
</blockquote>
<p>I agree with this -- a quick search online shows that there&#x27;s a <em>lot</em> of variance in third-party headers used for error messaging (<code>X-Error-Message</code>, <code>X-Error</code>, <code>X-Err-Msg</code>, etc.), and I think accepting one non-standard header would establish a precedent for accepting other non-standard headers (which presents a long term quality/maintenance risk IMO, since we can&#x27;t assert that these headers are plain text and not JSON or some other serialized form).</p>
<p>@doddi Out of curiosity, have you engaged with the Python packaging standards processes for this use case? I think there would be an immense amount of value in having Python package indices align on error response behavior/encoding in index API (PEP 503/691) responses, and would make the integration story a lot simpler and more uniform here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2025-09-25 15:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-client/src/cached_client.rs</code>:595 on 2025-09-25 15:37</div>
            <div class="timeline-body"><p>Yeah, if I understand correctly we should <em>probably</em> check for this on <code>400..=599</code>, i.e. all client- and server- originated error responses?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/doddi">@doddi</a> on 2025-09-26 13:18</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>I see there&#x27;s an example in the screenshot, but can you say a bit more about which server uses this header and how, so we get a complete picture of the user experience?</p>
</blockquote>
<p>I agree with this -- a quick search online shows that there&#x27;s a <em>lot</em> of variance in third-party headers used for error messaging (<code>X-Error-Message</code>, <code>X-Error</code>, <code>X-Err-Msg</code>, etc.), and I think accepting one non-standard header would establish a precedent for accepting other non-standard headers (which presents a long term quality/maintenance risk IMO, since we can&#x27;t assert that these headers are plain text and not JSON or some other serialized form).</p>
<p>@doddi Out of curiosity, have you engaged with the Python packaging standards processes for this use case? I think there would be an immense amount of value in having Python package indices align on error response behavior/encoding in index API (PEP 503/691) responses, and would make the integration story a lot simpler and more uniform here.</p>
</blockquote>
<p>@woodruffw I have not engaged with the Python packaging standards process, I was not aware of such a thing :). Would you recommend this as a first step? if so could you suggest what would be the best approach?</p>
<p>As for the screenshot this is from Sonatype Nexus Repository Manager, we are currently working through all our supported formats and determining how we can support such error types when communicating using http2. For our use case we generate a 403 response when we determine that a download of a component should be blocked due to violating a policy, such as being malicious or perhaps licensing. The response usually includes a url link to a report on why the download was blocked. Moving to http2 (no reasonPhrase option) the end user is simply presented with a 403 and no context as to why a download &#x27;failed&#x27;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/woodruffw">@woodruffw</a> on 2025-09-26 15:19</div>
            <div class="timeline-body"><blockquote>
<p>@woodruffw I have not engaged with the Python packaging standards process, I was not aware of such a thing :). Would you recommend this as a first step? if so could you suggest what would be the best approach?</p>
</blockquote>
<p>Yeah, I think this would be a good starting point -- changes to standard interfaces (like the index) are IMO a <em>lot</em> easier to justify if they can be substantiated through the standards process üôÇ</p>
<p>In terms of starting: I think a discussion thread on the <a href="https://discuss.python.org/c/packaging/14">packaging forum</a> is probably right starting point -- the community there is familiar with the rationale behind the original PEP 503/691 specifications, and will likely have useful feedback on whether making explicit accommodations for error states makes sense.</p>
<p>However, to take a step back, there <em>might</em> be an existing solution that works for you:</p>
<blockquote>
<p>For our use case we generate a 403 response when we determine that a download of a component should be blocked due to violating a policy, such as being malicious or perhaps licensing. The response usually includes a url link to a report on why the download was blocked. Moving to http2 (no reasonPhrase option) the end user is simply presented with a 403 and no context as to why a download &#x27;failed&#x27;.</p>
</blockquote>
<p>Hmm, have you looked at implementing <a href="https://peps.python.org/pep-0792/">PEP 792</a> for this? That&#x27;s a pre-existing standard mechanism that allows the index to communicate to clients whether a project has been quarantined (among other states).</p>
<p>The main restriction with PEP 792 is that it operates at the <em>project</em> level, not the per-file level: you set the status marker in the index response itself. I&#x27;m not sure if that makes sense for your use case, but if it does you&#x27;ll get compatibility with uv and other installers for &quot;free&quot; without having to make any kind of changes or standards efforts üôÇ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/doddi">@doddi</a> on 2025-09-26 16:21</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>@woodruffw I have not engaged with the Python packaging standards process, I was not aware of such a thing :). Would you recommend this as a first step? if so could you suggest what would be the best approach?</p>
</blockquote>
<p>Yeah, I think this would be a good starting point -- changes to standard interfaces (like the index) are IMO a <em>lot</em> easier to justify if they can be substantiated through the standards process üôÇ</p>
<p>In terms of starting: I think a discussion thread on the <a href="https://discuss.python.org/c/packaging/14">packaging forum</a> is probably right starting point -- the community there is familiar with the rationale behind the original PEP 503/691 specifications, and will likely have useful feedback on whether making explicit accommodations for error states makes sense.</p>
<p>However, to take a step back, there <em>might</em> be an existing solution that works for you:</p>
<blockquote>
<p>For our use case we generate a 403 response when we determine that a download of a component should be blocked due to violating a policy, such as being malicious or perhaps licensing. The response usually includes a url link to a report on why the download was blocked. Moving to http2 (no reasonPhrase option) the end user is simply presented with a 403 and no context as to why a download &#x27;failed&#x27;.</p>
</blockquote>
<p>Hmm, have you looked at implementing <a href="https://peps.python.org/pep-0792/">PEP 792</a> for this? That&#x27;s a pre-existing standard mechanism that allows the index to communicate to clients whether a project has been quarantined (among other states).</p>
<p>The main restriction with PEP 792 is that it operates at the <em>project</em> level, not the per-file level: you set the status marker in the index response itself. I&#x27;m not sure if that makes sense for your use case, but if it does you&#x27;ll get compatibility with uv and other installers for &quot;free&quot; without having to make any kind of changes or standards efforts üôÇ</p>
</blockquote>
<p>That is really useful information re PEP792 but sadly we need to communicate policy violations on a per version basis. Thanks again for the information, I will reach out to the PEP standards üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/doddi">@doddi</a> on 2025-09-30 11:00</div>
            <div class="timeline-body"><p>I have opened up a thread for discussion https://discuss.python.org/t/block-download-of-components-when-violating-policy/104021. Probably best I close this PR for now and see what traction I get over there üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/konstin">@konstin</a> on 2025-09-30 12:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/doddi">@doddi</a> on 2025-10-27 11:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:54:05 UTC
    </footer>
</body>
</html>
