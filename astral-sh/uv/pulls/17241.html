<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>fix: handle Windows special filenames in cache clean - astral-sh/uv #17241</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>fix: handle Windows special filenames in cache clean</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/pull/17241">#17241</a>
        opened by <a href="https://github.com/blueberrycongee">@blueberrycongee</a>
        on 2025-12-26 18:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/blueberrycongee">@blueberrycongee</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fix <code>uv cache clean</code> failing on Windows when cached sdist contains files with Windows-incompatible filenames (e.g., files ending with a period like <code>logging.</code>).</p>
<p><strong>Problem:</strong>
On Windows, when running <code>uv add uwsgi</code>, the build fails (expected, as uwsgi doesn't support Windows). However, when subsequently running <code>uv cache clean</code>, the command fails with:</p>
<pre><code>error: Failed to clear cache at: AppData\Local\uv\cache
  Caused by: failed to remove file `...\logging.`: The system cannot find the file specified. (os error 2)
</code></pre>
<p>This happens because Windows' standard Win32 API automatically normalizes paths, stripping trailing dots from filenames. When trying to delete such files, the normalized path doesn't match the actual filename on disk.</p>
<p><strong>Solution:</strong>
Use the extended-length path prefix (<code>\\?\</code>) to bypass Win32 path normalization when deletion fails with <code>NotFound</code> or <code>InvalidInput</code> errors. This is the standard Windows approach for handling:</p>
<ul>
<li>Filenames with special characters (trailing dots, spaces)</li>
<li>Paths exceeding MAX_PATH limit</li>
</ul>
<p>The fix is applied to <code>remove_file</code>, <code>remove_dir</code>, and <code>remove_dir_all</code> functions in <code>crates/uv-cache/src/removal.rs</code>.</p>
<p>Fixes #16586</p>
<h2>Test Plan</h2>
<ul>
<li><p>Added unit tests for <code>to_extended_path()</code> function covering:</p>
<ul>
<li>Absolute paths → extended path conversion</li>
<li>Already extended paths → returned as-is</li>
<li>UNC paths → extended UNC format conversion</li>
<li>Non-Windows platforms → no-op behavior</li>
</ul>
</li>
<li><p>Added unit tests for file/directory removal:</p>
<ul>
<li>Normal file removal</li>
<li>Readonly file removal (verifies <code>set_not_readonly</code> logic)</li>
<li>Empty directory removal</li>
<li>Directory with contents removal (<code>remove_dir_all</code>)</li>
</ul>
</li>
<li><p>Added tests for <code>rm_rf()</code> function:</p>
<ul>
<li>Single file removal with statistics verification</li>
<li>Directory tree removal with statistics verification</li>
<li>Nonexistent path handling (should succeed with zero counts)</li>
</ul>
</li>
<li><p>Added test for <code>Removal</code> struct's <code>AddAssign</code> implementation</p>
</li>
<li><p>Manual verification: Reproduced the original issue with <code>uwsgi</code> package and confirmed <code>uv cache clean</code> now succeeds after the fix.</p>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-cache/src/removal.rs</code>:230 on 2025-12-29 03:25</div>
            <div class="timeline-body"><p>I think an explicit match to Prefix::Verbatim, Prefix::VerbatimDisk, Prefix::VerbatimUNC would be better here. I assume <code>\\?</code> is a typo and you meant <code>\\?\</code>? Nonetheless, the std::path::Prefix enum would help with this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-cache/src/removal.rs</code>:223 on 2025-12-29 03:27</div>
            <div class="timeline-body"><p><code>to_verbatim_path</code> would be more appropriate naming wise</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-cache/src/removal.rs</code>:240 on 2025-12-29 03:29</div>
            <div class="timeline-body"><p>I'm not convinced we should try to guess what the absolute path should be here as it depends on the context.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-cache/src/removal.rs</code>:250 on 2025-12-29 03:31</div>
            <div class="timeline-body"><p>I'd rather check Prefix::UNC first before handling <code>\\</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-cache/src/removal.rs</code>:259 on 2025-12-29 03:32</div>
            <div class="timeline-body"><p>Is this needed? All the changed code I see is behind <code>#[cfg(windows)]</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-cache/src/removal.rs</code>:309 on 2025-12-29 03:46</div>
            <div class="timeline-body"><p>I'd add a test in <code>crates/uv/tests/it/cache_clean.rs</code> for the OP scenario instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2025-12-29 03:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blueberrycongee">@blueberrycongee</a> on 2025-12-29 09:04</div>
            <div class="timeline-body"><p>The CI failure is unrelated to this PR - it's a GitHub LFS service timeout:</p>
<blockquote>
<p>batch response: Fatal error: We couldn't respond to your request in time.</p>
</blockquote>
<p>The failing tests (<code>tool_install_git_lfs</code>, <code>tool_run_git_lfs</code>) are flaky due to external service issues. Could you please re-run the failed jobs?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blueberrycongee">@blueberrycongee</a> on 2025-12-29 09:04</div>
            <div class="timeline-body"><p>@samypr100</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">windows</span> added by @samypr100 on 2025-12-31 18:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2025-12-31 21:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-cache/src/removal.rs</code>:261 on 2025-12-31 21:34</div>
            <div class="timeline-body"><p>Thanks for the applying the changes.</p>
<p>I'm thinking this fits in uv-fs, but I'd like to hear from others first.</p>
<p>CC @konstin</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2025-12-31 23:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-cache/src/removal.rs</code>:225 on 2025-12-31 23:50</div>
            <div class="timeline-body"><p>nit: you can return the match directly, and avoid all the other inner returns</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2025-12-31 23:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-cache/src/removal.rs</code>:270 on 2025-12-31 23:56</div>
            <div class="timeline-body"><p>We should avoid the <code>#cfg(windows)</code> here by adding <code>if cfg!(windows)</code>. That will help with the possible dead code warnings and make sure we always exercise the compiler on this for all platforms (since there should be no issues)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-cache/src/removal.rs</code>:289 on 2026-01-02 02:54</div>
            <div class="timeline-body"><p>I'm also thinking calling remove_file (recurse once) with a good exit condition here would be better than repeating all the code twice. Same for remove_dir/remove_dir_all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2026-01-02 02:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blueberrycongee">@blueberrycongee</a> on 2026-01-05 12:09</div>
            <div class="timeline-body"><p>@samypr100</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2026-01-05 12:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-cache/src/removal.rs</code>:261 on 2026-01-05 12:19</div>
            <div class="timeline-body"><p>Yes this should be a generic util in uv-fs</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2026-01-05 12:32</div>
            <div class="timeline-body"><p>I'm not sure about the general approach here, can we do a directory traversal with UNC paths directly instead, to avoid an error occurring in the first place?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2026-01-05 14:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>crates/uv-cache/src/removal.rs</code>:240 on 2026-01-05 14:01</div>
            <div class="timeline-body"><p>We'll want to avoid lossy conversion here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blueberrycongee">@blueberrycongee</a> on 2026-01-07 09:06</div>
            <div class="timeline-body"><p>@samypr100 - Fixed! The UNC path handling now uses PathBuf::push() directly with the &amp;OsStr values instead of to_string_lossy().</p>
<p>@konstin - The current approach falls back to verbatim paths only when needed (on NotFound/InvalidInput errors). This avoids the overhead of always using verbatim paths for directory traversal while still handling edge cases with special characters like trailing dots.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2026-01-07 09:09</div>
            <div class="timeline-body"><blockquote>
<p>This avoids the overhead of always using verbatim paths for directory traversal</p>
</blockquote>
<p>What is the overhead for doing that?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blueberrycongee">@blueberrycongee</a> on 2026-01-07 12:23</div>
            <div class="timeline-body"><p>@konstin Looking at the code, the overhead would be:</p>
<p>Memory allocation: to_verbatim_path() creates new PathBuf/OsString for paths that need conversion (UNC and Disk paths), while already-verbatim paths return Cow::Borrowed with no allocation.</p>
<p>Path component processing: For UNC paths, it does path.components().skip(1).collect() which iterates through the remaining path components after the UNC prefix.</p>
<p>Directory traversal: The current code uses walkdir::WalkDir::new(path) which wouldn't automatically benefit from verbatim paths anyway - we'd need to convert every path during traversal.</p>
<p>The current approach only pays this cost when we hit specific errors (NotFound/InvalidInput), rather than for every path operation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2026-01-07 12:29</div>
            <div class="timeline-body"><p>Did you use an LLM for that or did you check the options doing a walkdir with verbatim paths yourself?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blueberrycongee">@blueberrycongee</a> on 2026-01-07 13:04</div>
            <div class="timeline-body"><p>@konstin You're right, I didn't actually test the verbatim-path-first approach before answering.</p>
<p>I just tested it now:</p>
<p>WalkDir::new(&quot;\?\C:...&quot;) works correctly
entry.path() automatically inherits the \?\ prefix
Deletion with entry.path() succeeds without any fallback logic
So converting to verbatim path once at the rm_rf entry point is cleaner. I can refactor to that approach if you'd prefer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2026-01-07 17:02</div>
            <div class="timeline-body"><blockquote>
<p>@konstin You're right, I didn't actually test the verbatim-path-first approach before answering.</p>
<p>I just tested it now:</p>
<p>WalkDir::new(&quot;?\C:...&quot;) works correctly entry.path() automatically inherits the ?\ prefix Deletion with entry.path() succeeds without any fallback logic So converting to verbatim path once at the rm_rf entry point is cleaner. I can refactor to that approach if you'd prefer.</p>
</blockquote>
<p>Yes, please do so</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @samypr100 by @zanieb on 2026-01-13 21:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @konstin by @zanieb on 2026-01-13 21:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-13 22:28:32 UTC
    </footer>
</body>
</html>
