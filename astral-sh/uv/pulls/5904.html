<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enable LTO optimizations in release builds to reduce binary size - astral-sh/uv #5904</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Enable LTO optimizations in release builds to reduce binary size</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/5904">#5904</a>
        opened by <a href="https://github.com/davfsa">@davfsa</a>
        on 2024-08-08 11:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/davfsa">@davfsa</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>In the same spirit as #5745, release builds could be a bit slightly more size efficient by enabling LTO, which removes dead code (either in uv through fully inlined functions or the libraries it depends on). Also has the side-effect (more what LTO was created for) of slighly speeding up uv.</p>
<p>In this case, I have measured a 5MB size decrease!.</p>
<p>Unfortunately, this change also comes with the disadvantage of more than doubling the build time of a clean build on my machine (see &quot;Test Plan&quot;). I have opened this pull request to show my findings and suggest this as an option.</p>
<p><em>I have also started looking into what effects optimizing for size rather than speed could have, but that calls for another pr</em></p>
<h2>Test Plan</h2>
<p>Comparing the binary size before and after (starting off in just a simple clone of the repository)</p>
<p>System info:</p>
<pre><code>CPU: AMD Ryzen 7 3700X (16) @ 3.600GHz
Memory: 32GB @ 3200 MT/s
Uname: Linux galaxy 6.6.44-1-MANJARO #1 SMP PREEMPT_DYNAMIC Sat Aug  3 10:09:33 UTC 2024 x86_64 GNU/Linux
</code></pre>
<p>Before:</p>
<pre><code>$ cargo build --release
&lt;snip&gt;
Finished `release` profile [optimized] target(s) in 1m 29s

$ du target/release/uv -h
30M	target/release/uv
</code></pre>
<p>After:</p>
<pre><code>$ cargo build --release
&lt;snip&gt;
Finished `release` profile [optimized] target(s) in 3m 43s

$ du target/release/uv -h
25M	target/release/uv
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Enable LTO optimizations to decrease binary size" to "Enable LTO optimizations in release builds to reduce binary size" by @davfsa on 2024-08-08 11:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-08-08 11:36</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/uv/branches/davfsa:task/enable-lto">CodSpeed Performance Report</a></h2>
<h3>Merging #5904 will <strong>improve performances by 14.9%</strong></h3>
<p><sub>Comparing <code>davfsa:task/enable-lto</code> (537ecf6) with <code>main</code> (acbd367)</sub></p>
<h3>Summary</h3>
<p><code>⚡ 6</code> improvements
<code>✅ 7</code> untouched benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>main</code> | <code>davfsa:task/enable-lto</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>build_platform_tags[burntsushi-archlinux]</code> | 1.3 ms | 1.1 ms | +13.69% |
| ⚡ | <code>wheelname_parsing[flyte-long-compatible]</code> | 10 µs | 8.8 µs | +12.91% |
| ⚡ | <code>wheelname_parsing[flyte-short-compatible]</code> | 6.3 µs | 5.5 µs | +14.54% |
| ⚡ | <code>wheelname_parsing[flyte-short-incompatible]</code> | 6.3 µs | 5.5 µs | +14.28% |
| ⚡ | <code>wheelname_parsing_failure[flyte-long-extension]</code> | 1.9 µs | 1.6 µs | +14.9% |
| ⚡ | <code>wheelname_parsing_failure[flyte-short-extension]</code> | 1.9 µs | 1.7 µs | +14.64% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-08-08 11:41</div>
            <div class="timeline-body"><p>I'm seeing a small speedup, too:</p>
<pre><code>hyperfine --prepare &quot;rm -f uv.lock&quot; --warmup 3 --runs 30 &quot;~/projects/uv-main/uv-main lock&quot; &quot;~/projects/uv-main/uv-lto lock&quot;
Benchmark 1: ~/projects/uv-main/uv-main lock
  Time (mean ± σ):     218.1 ms ±   3.6 ms    [User: 217.5 ms, System: 129.5 ms]
  Range (min … max):   212.5 ms … 227.1 ms    30 runs
 
Benchmark 2: ~/projects/uv-main/uv-lto lock
  Time (mean ± σ):     208.5 ms ±   4.3 ms    [User: 204.8 ms, System: 128.0 ms]
  Range (min … max):   201.7 ms … 222.1 ms    30 runs
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-08-08 11:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @konstin on 2024-08-08 11:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/T-256">@T-256</a> on 2024-08-08 11:47</div>
            <div class="timeline-body"><ul>
<li>related discussion: https://github.com/astral-sh/ruff/issues/9224</li>
</ul>
<blockquote>
<p>Comparing the binary size before and after (starting off in just a simple clone of the repository)</p>
</blockquote>
<p>Can you also share final released wheels size (compressed)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davfsa">@davfsa</a> on 2024-08-08 11:59</div>
            <div class="timeline-body"><blockquote>
<p>Can you also share final released wheels size (compressed)?</p>
</blockquote>
<p>Absolutely! Currently struggling to find how to build those (can't find any job where that is done and the <a href="https://github.com/astral-sh/uv/blob/main/.github/workflows/publish-pypi.yml">release-pypi ci</a> eludes to <code>cargo-dist</code> being what I need, but I have found no documentation on how to generate only the wheels</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-08-08 11:59</div>
            <div class="timeline-body"><p>You can use <code>maturin build --release</code> (or even <code>uvx maturin build --release</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davfsa">@davfsa</a> on 2024-08-08 12:09</div>
            <div class="timeline-body"><p>Thanks @konstin!</p>
<p>@T-256 Here are your results (a bit underwhelming actually):</p>
<p>Before:</p>
<pre><code>$ du targets/wheels/uv-0.2.34-py3-none-linux_x86_64.whl -h
12M	uv-0.2.34-py3-none-linux_x86_64.whl
</code></pre>
<p>After:</p>
<pre><code>$ du target/wheels/uv-0.2.34-py3-none-linux_x86_64.whl -h
11M	target/wheels/uv-0.2.34-py3-none-linux_x86_64.whl
</code></pre>
<p>Btw, thanks for sharing the discussion about this in the ruff repository! If necessary, I can spend some time playing around a bit with build optimizations to make it take less time to compile release builds. Build times did take a massive hit (at least on my machine, from ~1m to ~3m on a fresh build).</p>
<p>Just through a quick read of discussion you linked and the other ones linked by other people, it seems like there is a lot more to consider here than I initially thought.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-08-08 12:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-08-08 12:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-08 12:24</div>
            <div class="timeline-body"><p>I'm supportive of this. Saving on binary size is a win for the registry, CDN, and users. We can always revisit in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-08-08 13:25</div>
            <div class="timeline-body"><p>I would say I'm somewhat mildly negative on this change, largely for the same reasons I discussed here for <code>ruff</code>: https://github.com/astral-sh/ruff/pull/9031</p>
<p>Building <code>uv</code> already takes a very long time, and doubling its build time for small improvements to binary size and runtime speed doesn't seem like the best trade off to me. Although the improvement to binary size does look pretty good here. Compounded over lots of downloads, that could really add up.</p>
<p>With that said, I'm already using <code>--profile profiling</code> locally when building <code>uv</code> for benchmarking, which is different from the <code>release</code> configuration (but only insomuch as debug symbols aren't stripped). With this change, the configurations differ even more now, with optimizations potentially being different between the builds. This means that when we're doing benchmarking locally, we'll be measuring the thing we aren't actually shipping. It is very difficult for me to estimate just how big of a deal that is. It's probably <em>not</em> a huge deal in the vast majority of circumstances. But it's a concern I have.</p>
<p>I'm not <em>strongly</em> opposed to this change though. So I fine with keeping it for now and evaluating just how much the longer build times annoy us.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davfsa">@davfsa</a> on 2024-08-08 14:14</div>
            <div class="timeline-body"><p>First of all, thanks for joining into the conversation @BurntSushi. Your comments on https://github.com/astral-sh/ruff/issues/9224 and similar were insanely insightful!</p>
<blockquote>
<p>With that said, I'm already using --profile profiling locally when building uv for benchmarking, which is different from the release configuration (but only insomuch as debug symbols aren't stripped). With this change, the configurations differ even more now, with optimizations potentially being different between the builds. This means that when we're doing benchmarking locally, we'll be measuring the thing we aren't actually shipping.</p>
</blockquote>
<p>The <code>profiling</code> profile inherits from the <code>release</code> one, so I believe it should have <code>lto</code> enabled too (not a cargo expert). Then the only differences would be those that are specifically marked (being not stripping the binary and enabling debug at the time of writing)</p>
<p>I have also opened #5909 to try to further optimize binary size without giving up too much performance nor build times :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-08-08 14:28</div>
            <div class="timeline-body"><blockquote>
<p>The profiling profile inherits from the release one, so I believe it should have lto enabled too (not a cargo expert).</p>
</blockquote>
<p>Oof. Right. That needs to be undone. It is not tenable to wait minutes between benchmarking runs IMO. (The compile times are already too long.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/davfsa">@davfsa</a> on 2024-08-08 14:33</div>
            <div class="timeline-body"><blockquote>
<p>Oof. Right. That needs to be undone. It is not tenable to wait minutes between benchmarking runs IMO. (The compile times are already too long.)</p>
</blockquote>
<p>I'm sorry for the build slowdowns! Didn't initially think they were done for anything else than a release, where I thought it would be fine to give up some build time to reduce the final binary.</p>
<p>If #5909 is not good enough (from a clean build, it now only takes about 30s more than before and 1m 45s less than with LTO only, at a slight performance cost that is), I would understand this PR being reverted</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-08-08 14:42</div>
            <div class="timeline-body"><p>I don't think we need to revert the PR. I think we just need to make the <code>profiling</code> profile not inherit from <code>release</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-09 23:12</div>
            <div class="timeline-body"><p>This change was not tested for all of our release builds unfortunately, it's failing in #5984 — considering reverting to unblock the release and revisiting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/polarathene">@polarathene</a> on 2025-04-30 12:55</div>
            <div class="timeline-body"><p>FWIW, on a resource constrained budget VPS (<em>Fedora 42, 2GB RAM with extra zram swap + 1 vCPU</em>) builds took notably longer, with a 9MB difference (~20% smaller) between <a href="https://doc.rust-lang.org/cargo/reference/profiles.html#lto"><code>fat</code> and <code>thin</code> LTO</a> builds.</p>
<p>Final image (<code>uv</code> + <code>uvx</code>):</p>
<ul>
<li><strong>40.6MB</strong> - <code>lto=&quot;fat&quot;</code> =&gt; 8,706s (<em>2 hours 25 minutes</em>)</li>
<li><strong>49.5MB</strong> - <code>lto=&quot;thin&quot;</code> =&gt; 2,598s (<em>43 minutes</em>)</li>
</ul>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:38:44 UTC
    </footer>
</body>
</html>
