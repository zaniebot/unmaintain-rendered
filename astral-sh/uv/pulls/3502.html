<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>feat: add custom middleware - astral-sh/uv #3502</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>feat: add custom middleware</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/3502">#3502</a>
        opened by <a href="https://github.com/tdejager">@tdejager</a>
        on 2024-05-10 08:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/tdejager">@tdejager</a> on 2024-05-10 08:49</div>
            <div class="timeline-body"><h2>Summary</h2>
<!-- What's the purpose of the change? What does it do, and why? -->

<p>This adds the ability to the <code>RegistryClient</code> and <code>BaseClient</code> for the consumer of the library to add custom middleware. The problem is that we have different authentication methods/requirements for pypi registries and would like to use the middleware provided by https://github.com/mamba-org/rattler</p>
<p>I've decided that if you do this, it overrides the normal middleware. This makes the <code>retries</code> option, and maybe some others, not really do anything anymore. Which is a bit weird, but couldn't directly think of a better way to do it, as you might end up with 'duplicated' middleware maybe.</p>
<p>This should close the issue/question I made: https://github.com/astral-sh/uv/issues/3400</p>
<p>I'll make it a draft for now because I do not know how you feel about such a change and maybe there is a different design you have in mid.</p>
<h2>Test Plan</h2>
<p>Once, I can update to the latest uv version, I'll try and test things out directly in: https://github.com/prefix-dev/pixi. I'm happy to add rust test here if you know a good place for it.</p>
<!-- How was it tested? -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rustlib</span> added by @zanieb on 2024-05-10 12:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-05-13 17:35</div>
            <div class="timeline-body"><p>Sorry for not replying to the initial issue! Yes we can support. What do you think about the branch in https://github.com/astral-sh/uv/compare/konsti/custom-middleware ? It's similar to yours but encapsulates the stack selection into <code>MiddlewareStack</code>.</p>
<p>Am i correct to assume you don't care about middleware for the offline case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tdejager">@tdejager</a> on 2024-05-14 06:57</div>
            <div class="timeline-body"><p>Hi Konsti, that looks a lot better actually! Good question about the offline, our middleware does not account for it yet, but if you feel it's better to add it to the offline case as well, that seems totally valid!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @konstin on 2024-05-14 09:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-05-14 09:47</div>
            <div class="timeline-body"><p>(force-pushing because i had to rebase on main, your initial commit should be preserved)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-05-14 09:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/src/commands/pip/compile.rs</code>:120 on 2024-05-14 09:49</div>
            <div class="timeline-body"><p>Not sure about where to put the retries constant</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-22 02:14</div>
            <div class="timeline-body"><p>@zanieb - do you want to review this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @zanieb by @zanieb on 2024-05-22 02:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-05-22 02:48</div>
            <div class="timeline-body"><p>Sure</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-05-23 14:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/pip/compile.rs</code>:294 on 2024-05-23 14:57</div>
            <div class="timeline-body"><p>Hey @tdejager sorry I've been slow to get to this.</p>
<p>I don't love this new API. Could we instead:</p>
<ul>
<li>Only create the retry middleware if retries is non-zero</li>
<li>Replace the <code>Keyring</code> option with <code>Option&lt;AuthMiddleware&gt;</code></li>
<li>Add a <code>extra_middleware: Vec&lt;Arc&lt;dyn Middleware&gt;&gt;</code> option</li>
</ul>
<p>I think this should get you the same functionality, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tdejager">@tdejager</a> reviewed on 2024-05-23 16:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/tdejager">@tdejager</a> on <code>crates/uv/src/commands/pip/compile.rs</code>:294 on 2024-05-23 16:17</div>
            <div class="timeline-body"><p>Sounds like a good improvement to me, I can also make the changes early next week if you are busy @konstin :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tdejager">@tdejager</a> reviewed on 2024-05-23 16:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/tdejager">@tdejager</a> on <code>crates/uv/src/commands/pip/compile.rs</code>:294 on 2024-05-23 16:17</div>
            <div class="timeline-body"><p>Also @zanieb and @konstin thanks again for taking a look ðŸ™‚</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/pip/compile.rs</code>:294 on 2024-05-23 16:27</div>
            <div class="timeline-body"><p>I'll be out next week fyi.</p>
<p>I missed that @konstin introduced the <code>MiddlewareStack</code> â€” let's make sure he's onboard with my proposal :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-05-23 16:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tdejager">@tdejager</a> reviewed on 2024-05-23 18:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/tdejager">@tdejager</a> on <code>crates/uv/src/commands/pip/compile.rs</code>:294 on 2024-05-23 18:07</div>
            <div class="timeline-body"><p>Yeah maybe having the AuthMiddleware in the stack is enough. I thought you might want to be more explicit about enabling/disabling the auth middleware. Let see what konsti thinks :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-05-23 18:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/pip/compile.rs</code>:294 on 2024-05-23 18:18</div>
            <div class="timeline-body"><p>I think we can just have the <code>AuthMiddleware</code> populated by default and ya'll can pass <code>None</code> to explicitly remove it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-06-03 11:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/src/commands/pip/compile.rs</code>:294 on 2024-06-03 11:01</div>
            <div class="timeline-body"><p>I changed the API so it's now <code>.with</code> methods and checks for &gt; 0 retries, but if we don't take a keyring it becomes even more verbose because we have a number of callsites, and also <code>KeyringProviderType</code> lives in <code>uv-configuration</code> so it can't be <code>Into&lt;AuthMiddleware&gt;</code>.</p>
<p><img src="https://github.com/astral-sh/uv/assets/6826232/b88c3a77-3245-4a72-b5d8-00cb42f0f837" alt="image" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/olivier-lacroix">@olivier-lacroix</a> on 2024-07-09 05:46</div>
            <div class="timeline-body"><p>Hi all, just wondering if you guys are happy with the current design, and if rebasing is the only requirement for this PR to be merged?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @konstin on 2024-07-10 07:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-19 17:02</div>
            <div class="timeline-body"><p>Sorry, I need to review the latest implementation but am prioritizing things that impact more users right now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/olivier-lacroix">@olivier-lacroix</a> on 2024-07-20 00:15</div>
            <div class="timeline-body"><p>No worries. Thanks @zanieb !</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-16 22:12</div>
            <div class="timeline-body"><p>Is this still needed?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tdejager">@tdejager</a> on 2024-09-17 08:16</div>
            <div class="timeline-body"><p>Would still be very useful for us, however, as reqwest-middleware is now a forked version, I'm unsure regarding the compatibilities with the open-source version. However, we could re-vendor the middleware if needed :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-01 17:10</div>
            <div class="timeline-body"><p>It looks like @konstin added <code>AuthIntegration::NoAuthMiddleware</code> allowing the auth middleware to be disabled so maybe we just need the ability to attach extra middleware now?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tdejager">@tdejager</a> on 2024-10-01 18:39</div>
            <div class="timeline-body"><p>Sounds good, is there something you like me to change other than a rebase?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-01 18:41</div>
            <div class="timeline-body"><p>Can we drop all the <code>MiddlewareStack</code> stuff and just add a <code>extra_middleware: Vec&lt;Arc&lt;dyn Middleware&gt;&gt;</code> option? Or is there more that you need?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tdejager">@tdejager</a> on 2024-10-01 18:59</div>
            <div class="timeline-body"><p>Not at all computer currently but sounds good to me, let me give it a go at the end of the week!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @tdejager on 2024-11-04 08:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-04 08:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tdejager">@tdejager</a> on 2024-11-04 09:17</div>
            <div class="timeline-body"><p>Closing this as there were so many changes it make sense to make a different PR. Will reference this when I get to it :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch restored on 2024-11-04 09:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 05:43:34 UTC
    </footer>
</body>
</html>
