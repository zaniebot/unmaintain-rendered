```yaml
number: 11670
title: Consider system site packages if activated
type: pull_request
state: open
author: konstin
labels:
  - enhancement
assignees: []
draft: true
base: main
head: konsti/sys-path-discovery
created_at: 2025-02-20T15:39:37Z
updated_at: 2025-04-14T08:00:31Z
url: https://github.com/astral-sh/uv/pull/11670
synced_at: 2026-01-10T11:10:38Z
```

# Consider system site packages if activated

---

_Pull request opened by @konstin on 2025-02-20 15:39_

# Summary

We use `site.getsitepackages()` for discovering system packages for venvs created with `--system-site-packages`, while trying to avoid breaking exiting workflows.

# Details

We currently only check in ~1 directory for install packages when looking a system or venv interpreter, usually the venv site packages. But in reality, Python (and `importlib.metadata`) look in all `sys.path` entries for packages.

This can lead to a difference between the runtime behavior and `uv pip list` as well as other uv operation. Notably, we miss system site packages when used (`--system-site-packages` on venv installation) and PyPy's std vendored packages (such as `cffi`).

Using the full `sys.path` for discovery means that we're using a variable that has many sources (including `.pth` files) and that can change at runtime. It easily clashes with our caching as we need to either figure all the places that influence `sys.path` or re-query the Python interpreter on each operation.

Besides the usual venv or system Python operation mode, `uv pip` also has `target` and `prefix` options that install into a directory (structure). We keep `target` and `prefix` installation as they were, so that they only consider and modify packages in their directory prefix.

Packages may be uninstallable or not un-uninstallable, where the latter category are system packages, e.g., those installed into std for PyPy. Currently, a PyPy venv will for example shadow the system cffi version with its own version. With the current change, we still don't consider the PyPy std installed packages (they are not reported by `site.getsitepackages()`), preserving the current behavior. If we add support in the future, we need to consider what happens when let's say a lockfile requires cffi 1.71.1 but PyPy has a vendored, non-removable cffi 1.80.0.

TODO `--exact` with `--system-site-packages`.

An open question is how to handle system packages during: `uv sync` and `uv pip install`. For `uv sync`, do we error or try to upgrade (and potentially fail) when the versions mismatch? For `uv pip install` should we set them as constraint, and if so, do we need to add a new incompatibility kind for system packages (currently, system packages are preferences).

Best reviewed commit-by-commit.

Closes #9849
Resolves #2500
TODO #4466


---

_Label `enhancement` added by @konstin on 2025-02-20 15:39_

---

_Renamed from "Run CI" to "Consider system site packages for `uv pip list`" by @konstin on 2025-03-05 17:04_

---

_Renamed from "Consider system site packages for `uv pip list`" to "Consider system site packages if activated" by @konstin on 2025-03-05 17:05_

---
