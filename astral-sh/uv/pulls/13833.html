<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build backend: Support namespace packages - astral-sh/uv #13833</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Build backend: Support namespace packages</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/13833">#13833</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2025-06-04 13:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>Unlike regular packages, specifying all <code>__init__.py</code> directories for a namespace package would be very verbose There is e.g. https://github.com/python-poetry/poetry/tree/main/src/poetry, which has 18 modules, or https://github.com/googleapis/api-common-protos which is inconsistently nested. For both the Google Cloud SDK, there are both packages with a single module and those with complex structures, with many having multiple modules due to versioning through <code>&lt;module&gt;_v1</code> versioning. The Azure SDK seems to use one module per package (it's not explicitly documented but seems to follow from the process in https://azure.github.io/azure-sdk/python_design.html#azure-sdk-distribution-packages and https://github.com/Azure/azure-sdk-for-python/blob/ccb0e03a3de748f3aabf44be94776ba37e55791f/doc/dev/packaging.md).</p>
<p>For simplicity with complex projects, we add a <code>namespace = true</code> switch which disabled checking for an <code>__init__.py</code>. We only check that there's no <code>&lt;module_root&gt;/&lt;module_name&gt;/__init__.py</code> and otherwise add the whole <code>&lt;module_root&gt;/&lt;module_name&gt;</code> folder. This comes at the cost of <code>namespace = true</code> effectively creating an opt-out from our usual checks that allows creating an almost entirely arbitrary package.</p>
<p>For simple projects with only a single module, the module name can be dotted to point to the target module, so the build still gets checked:</p>
<pre><code class="language-toml">[tool.uv.build-backend]
module-name = &quot;poetry.core&quot;
</code></pre>
<h2>Alternatives</h2>
<h3>Declare all packages</h3>
<p>We could make <code>module-name</code> a list and allow or require declaring all packages:</p>
<pre><code class="language-toml">[tool.uv.build-backend]
module-name = [&quot;cloud_sdk.service.storage&quot;, &quot;cloud_sdk.service.storage_v1&quot;, &quot;cloud_sdk.billing.storage&quot;]
</code></pre>
<p>Or for Poetry:</p>
<pre><code class="language-toml">[tool.uv.build-backend]
module-name = [
    &quot;poetry.config&quot;,
    &quot;poetry.console&quot;,
    &quot;poetry.inspection&quot;,
    &quot;poetry.installation&quot;,
    &quot;poetry.json&quot;,
    &quot;poetry.layouts&quot;,
    &quot;poetry.masonry&quot;,
    &quot;poetry.mixology&quot;,
    &quot;poetry.packages&quot;,
    &quot;poetry.plugins&quot;,
    &quot;poetry.publishing&quot;,
    &quot;poetry.puzzle&quot;,
    &quot;poetry.pyproject&quot;,
    &quot;poetry.repositories&quot;,
    &quot;poetry.toml&quot;,
    &quot;poetry.utils&quot;,
    &quot;poetry.vcs&quot;,
    &quot;poetry.version&quot;
]
</code></pre>
<h3>Support multiple namespaces</h3>
<p>We could also allow namespace packages with multiple root level module:</p>
<pre><code class="language-toml">[tool.uv.build-backend]
module-name = [&quot;cloud_sdk.my_ext&quot;, &quot;local_sdk.my_ext&quot;]
</code></pre>
<p>For lack of use cases, we delegate this to creating a workspace with one package per module.</p>
<h2>Implementation</h2>
<p>Due to the more complex options for the module name, I'm moving verification on deserialization later, dropping the source span we'd get from serde. We also don't show similarly named directories anymore.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @konstin on 2025-06-04 13:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @konstin on 2025-06-04 13:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-06-04 14:15</div>
            <div class="timeline-body"><p>I sort of like the idea of allowing people to enumerate all the expected members if <code>namespace = true</code> can be dangerous. I wonder if we should require it to start? I don't feel strongly though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-06-05 18:35</div>
            <div class="timeline-body"><p>From checking projects that use namespaces, no other build backend requires enumerating your modules, they allow pointing to the root and include whatever directory you've given, and I don't want to make the migration harder. I'm fine doing this more lenient approach for namespace packages particularly since you already opt-in to less coherence by using a namespace. I haven't done exhaustive testing, but with the validation we're performing for <code>tool.uv.build-backend.module-name</code> with a dotted path, I think we're already stricter and catch more problems than the other popular build backends.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @konstin on 2025-06-05 18:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @konstin on 2025-06-05 18:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-build-backend/src/settings.rs</code>:93 on 2025-06-06 16:17</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// Use this option when the namespace package contains multiple root `__init__.py`, for namespace
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-build-backend/src/settings.rs</code>:136 on 2025-06-06 16:20</div>
            <div class="timeline-body"><p>So, this makes sense to me:</p>
<blockquote>
<p>I'm fine doing this more lenient approach for namespace packages particularly since you already opt-in to less coherence by using a namespace.</p>
</blockquote>
<p>But one thing I'm a little iffy on here is coupling the notion of &quot;this is a namespace package&quot; and &quot;we will disable most coherence checks.&quot; What if someone doesn't want to disable those coherent checks and list out the modules explicitly? I'm not necessarily asking for that to be available in this PR, but rather, is there a plausible path to that?</p>
<p>Maybe we'd keep this setup as-is, and you'd need to opt into a <code>coherent-checks = false</code> option to list out the modules? Or if a list is provided, then the coherent checks are automatically re-enabled?</p>
<p>So I think maybe this is all fine, but I just wanted to poke about this to check if this path was considered.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>docs/concepts/build-backend.md</code>:66 on 2025-06-06 16:21</div>
            <div class="timeline-body"><p>Is it feasible to give an example of something that will be accepted here that normally wouldn't be? Reading this with my beginner eyes on (as if I didn't just read this PR), I become immediately curious what kinds of checks have been disabled on me. :-) Should I be concerned? What if I want those checks enabled?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2025-06-06 16:25</div>
            <div class="timeline-body"><p>LGTM. I have some concerns mostly around the UX here. Specifically, I think the docs could be beefed up. And I'm unsure of the implications of coupling &quot;declaration of this package as a namespace package&quot; and &quot;coherence checks are disabled.&quot;</p>
<p>My initial reaction matched @zanieb's here, but I'm swayed by your follow-up in terms of being more lenient (to make migration less painful and since this is what other build backends already do).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-06-11 18:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-build-backend/src/settings.rs</code>:136 on 2025-06-11 18:38</div>
            <div class="timeline-body"><p>I've improved the framing. The coherence checks I'm mentioning here are really just two things: Validating that the <code>module-name</code> matches our expectations for either either stubs or regular package, and checking that <code>__init__.py[i]</code> are absent above and present inside the root module. Both of those aren't super elaborate, but also something that other build backends usually don't do. With <code>namespace = true</code>, we turn those two checks off, so you can have arbitrary namespace structures. Setuptools, hatchling and poetry all support these kind of packages by default by having <code>include</code> declarations, we make this opt-in with <code>namespace = true</code>, and support a smaller, better checked subset suitable for many cases without it instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-06-11 18:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>docs/concepts/build-backend.md</code>:66 on 2025-06-11 18:55</div>
            <div class="timeline-body"><p>I've put a comparison into the reference docs. I don't want to go deep on <code>namespace = true</code> in the concept docs since I don't want to encourage complex namespaces.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2025-06-12 17:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-06-12 17:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-12 17:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/alanthian">@alanthian</a> reviewed on 2025-06-19 03:25</div>
            <div class="timeline-body"><p>ok</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:43:26 UTC
    </footer>
</body>
</html>
