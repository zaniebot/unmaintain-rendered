<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add support for `--prefix` and `--with` installations in `find_uv_bin` - astral-sh/uv #14184</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add support for <code>--prefix</code> and <code>--with</code> installations in <code>find_uv_bin</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/14184">#14184</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2025-06-21 12:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>Follows #14182</p>
<p>Adds support for the case described at https://github.com/astral-sh/uv/issues/10194#issuecomment-2993544346</p>
<p>This also happens to fix both <code>--with</code> requirement test cases, which should close https://github.com/tox-dev/pre-commit-uv/issues/70</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @zanieb on 2025-06-21 12:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Flamefire">@Flamefire</a> reviewed on 2025-06-21 17:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Flamefire">@Flamefire</a> on <code>python/uv/_find_uv.py</code>:25 on 2025-06-21 17:53</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        _join(_parents(_module_path(), 4), &quot;bin&quot;),
</code></pre>
<p>or you'll get <code>prefix/lib/bin</code></p>
<p>And I think this should go first before checking the default script paths in case there are multiple uv versions installed in different locations/levels. The one next to the current module should always take precedence, doesn't it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-06-21 18:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>python/uv/_find_uv.py</code>:25 on 2025-06-21 18:34</div>
            <div class="timeline-body"><p>Thanks!</p>
<p>On the ordering, I agree â€” but since it's a departure from the existing ordering I think we should do that in a separate pull request.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-06-21 18:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>python/uv/_find_uv.py</code>:25 on 2025-06-21 18:41</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/uv/pull/14191</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zanieb on 2025-06-26 12:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @zanieb on 2025-06-27 17:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @konstin by @zanieb on 2025-06-27 17:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>python/uv/_find_uv.py</code>:25 on 2025-06-30 12:58</div>
            <div class="timeline-body"><p>Can we check that this looks like <code>lib</code> <code>[pP]ython.*</code> <code>site-packages</code> <code>uv</code> to avoid reading a different bin dir?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>python/uv/_find_uv.py</code>:22 on 2025-06-30 12:59</div>
            <div class="timeline-body"><p>Should we do this last? This could easily pick up a different, global uv installation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>python/uv/_find_uv.py</code>:22 on 2025-06-30 13:05</div>
            <div class="timeline-body"><p>This actually happens for me:</p>
<pre><code>$ uv pip install --prefix foo_prefix --find-links target/wheels/ --no-index uv
$ PYTHONPATH=&quot;foo_prefix/lib/python3.12/site-packages/&quot; python -S -c &quot;import sys; print(sys.path); from uv import find_uv_bin; print(find_uv_bin())&quot;
['', '/home/konsti/projects/uv/bar', '/usr/lib/python312.zip', '/usr/lib/python3.12', '/usr/lib/python3.12/lib-dynload']
/home/konsti/.local/bin/uv
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>python/uv/_find_uv.py</code>:28 on 2025-06-30 13:16</div>
            <div class="timeline-body"><p>Can you add tests for the prefix and the target case? We have to emulate this by copying our python files and the built test binary manually, but it catches cases such as https://github.com/astral-sh/uv/pull/14184#discussion_r2160101023 and the user scheme preference.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-06-30 13:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-06-30 13:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>python/uv/_find_uv.py</code>:22 on 2025-06-30 13:20</div>
            <div class="timeline-body"><p>Yeah that's what we're discussing at https://github.com/astral-sh/uv/pull/14184#discussion_r2160115413</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-06-30 13:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>python/uv/_find_uv.py</code>:25 on 2025-06-30 13:22</div>
            <div class="timeline-body"><p>I considered that (see also https://github.com/astral-sh/uv/pull/14191#issuecomment-3008756208) and actually started implementing it but I'm hesitant since the matching isn't just literals. I can add something again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-06-30 13:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>python/uv/_find_uv.py</code>:28 on 2025-06-30 13:23</div>
            <div class="timeline-body"><p>I'm wary of adding a new test suite for this file, it's a big increase in scope for this task.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-06-30 13:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>python/uv/_find_uv.py</code>:28 on 2025-06-30 13:35</div>
            <div class="timeline-body"><p>(I'll see how painful it is though, especially with https://github.com/astral-sh/uv/pull/14184#discussion_r2175069753 this gets complicated to trust without tests)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Flamefire">@Flamefire</a> reviewed on 2025-07-01 07:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Flamefire">@Flamefire</a> on <code>python/uv/_find_uv.py</code>:28 on 2025-07-01 07:40</div>
            <div class="timeline-body"><p>I think <code>fnmatch.fnmatch('/opt/prefix/lib/python3.13/site-packages/uv', '**/lib/python*/site-packages/uv')</code> should be easy and reliable enough to match against <code>_module_path()</code> before adding the prefix case</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-07-01 08:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>python/uv/_find_uv.py</code>:28 on 2025-07-01 08:24</div>
            <div class="timeline-body"><p>We need this to work on Windows, so we need to be lenient in the matching</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Add support for `--prefix` installations in `find_uv_bin`" to "Add support for `--prefix` and `--with` installations in `find_uv_bin`" by @zanieb on 2025-08-07 20:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-07 20:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>python/uv/_find_uv.py</code>:22 on 2025-08-07 20:21</div>
            <div class="timeline-body"><p>I consider this a distinct change, will be addressed by #14191</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> approved on 2025-08-07 20:41</div>
            <div class="timeline-body"><p>LGTM -- confirming my understanding that this is intentionally overly permissive in what it'll discover, and #14191 will ratchet it down?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-07 20:44</div>
            <div class="timeline-body"><p>It depends on what you mean by overly permissive. https://github.com/astral-sh/uv/pull/14191 just changes the <em>ordering</em> so we don't search in the user script directory before checking everywhere else that could be associated with the actual module.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2025-08-07 21:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-08-07 21:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-07 21:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/henryiii">@henryiii</a> reviewed on 2025-08-08 22:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/henryiii">@henryiii</a> on <code>python/uv/_find_uv.py</code>:80 on 2025-08-08 22:50</div>
            <div class="timeline-body"><p>This doesn't support Python 3.8 and 3.9. <code>strict=</code> was introduced in 3.10.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:43:40 UTC
    </footer>
</body>
</html>
