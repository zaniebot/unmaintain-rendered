<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use aws-lc-rs instead of ring for TLS - astral-sh/uv #4734</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use aws-lc-rs instead of ring for TLS</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/4734">#4734</a>
        opened by <a href="https://github.com/kcon-stackav">@kcon-stackav</a>
        on 2024-07-02 18:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/kcon-stackav">@kcon-stackav</a> on 2024-07-02 18:39</div>
            <div class="timeline-body"><!--
Thank you for contributing to uv! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<!-- What's the purpose of the change? What does it do, and why? -->

<p>This PR switches the TLS backend used by <code>reqwest</code> from <code>ring</code> to <code>aws-lc</code> to support more SSL certificate signature algorithms (especially P521 algorithms which aren't yet supported by <code>ring</code>: https://github.com/briansmith/ring/pull/1631).</p>
<p>Fixes #4534</p>
<h2>Test Plan</h2>
<p>I used <code>uv pip install</code> to try installing a package from a private PyPI server whose SSL certificate was signed using the ECDSA SHA-512 certificate signature algorithm and, using the Rust debugger, observed that <code>uv</code> did not fail to install the package due to not supporting the ECDSA SHA-512 certificate signature algorithm.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Explore using aws-lc-rs instead of ring for TLS" to "Use aws-lc-rs instead of ring for TLS" by @kcon-stackav on 2024-07-02 18:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @zanieb by @zanieb on 2024-07-02 18:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">network</span> added by @zanieb on 2024-07-02 18:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-07-02 20:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/base_client.rs</code>:141 on 2024-07-02 20:20</div>
            <div class="timeline-body"><p>Can we avoid panicking here? How can this fail? Can we get away with just warning if it fails?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-02 20:20</div>
            <div class="timeline-body"><p>Thanks for the pull request!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-02 20:36</div>
            <div class="timeline-body"><p>This <a href="https://github.com/astral-sh/uv/actions/runs/9766298659/job/26958922044?pr=4734">Windows failure</a> also looks somewhat problematic (see https://github.com/aws/aws-lc/issues/1477 and <a href="https://github.com/rustls/rustls/blob/75edb20a1e6a894089516053348b6137a425b9b4/.github/workflows/build.yml#L42-L44">example fix</a>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/kcon-stackav">@kcon-stackav</a> on <code>.github/workflows/ci.yml</code>:86 on 2024-07-02 22:32</div>
            <div class="timeline-body"><p>@zanieb I'm not very familiar with maturin, do you think installing NASM is needed for the <code>build-binaries</code> Windows job too?</p>
<p>https://github.com/astral-sh/uv/blob/66a4b8e6b7737b6dca78f6b60720488d0bc0889f/.github/workflows/build-binaries.yml#L153-L162</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/kcon-stackav">@kcon-stackav</a> on <code>.github/workflows/ci.yml</code>:420 on 2024-07-02 22:37</div>
            <div class="timeline-body"><p>I tweaked this to match the size used in the <code>build binary | windows</code> job to try to help resolve this failure: https://github.com/actions/runner/issues/2491</p>
<p>Now we're hitting this other error which I'm not sure how to resolve: https://github.com/astral-sh/uv/actions/runs/9768734370/job/26966858668?pr=4734</p>
<pre><code>  = note:    Creating library E:\uv\target\debug\deps\uv.lib and object E:\uv\target\debug\deps\uv.exp

          LINK : fatal error LNK1318: Unexpected PDB error; LIMIT (12) 'E:\uv\target\debug\deps\uv.pdb'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kcon-stackav">@kcon-stackav</a> reviewed on 2024-07-02 22:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @kcon-stackav on 2024-07-02 22:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-07-02 22:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.github/workflows/ci.yml</code>:420 on 2024-07-02 22:41</div>
            <div class="timeline-body"><p>That insane error is also an indication that the disk is full afaik, you can make it even bigger.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-07-02 22:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.github/workflows/ci.yml</code>:86 on 2024-07-02 22:41</div>
            <div class="timeline-body"><p>cc @konstin</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-07-02 22:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.github/workflows/ci.yml</code>:222 on 2024-07-02 22:42</div>
            <div class="timeline-body"><p>Note to self we should audit this action and consider just implementing it ourself if the install is straightforward</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-07-02 22:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/base_client.rs</code>:144 on 2024-07-02 22:44</div>
            <div class="timeline-body"><p>Is this always safe due to the above <code>if</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kcon-stackav">@kcon-stackav</a> reviewed on 2024-07-02 22:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/kcon-stackav">@kcon-stackav</a> on <code>crates/uv-client/src/base_client.rs</code>:144 on 2024-07-02 22:48</div>
            <div class="timeline-body"><p>Yes I think so, but when I tested removing this <code>expect()</code> I saw that if <code>install_default()</code> did fail then no error would be reported and the TLS would fall back to <code>ring</code> which I wasn't sure was desired. Is there a different mechanism than <code>expect()</code> we should use here to avoid that?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-07-02 22:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/base_client.rs</code>:144 on 2024-07-02 22:54</div>
            <div class="timeline-body"><p>There are a couple options, like ignoring the result:</p>
<pre><code class="language-rust">let _ = aws_lc_rs::default_provider().install_default();`
</code></pre>
<p>or warning the user on failure:</p>
<pre><code class="language-rust">if let Err(err) = aws_lc_rs::default_provider().install_default() {
    warn_user_once!(...)
}
</code></pre>
<p><code>expect</code> is okay if it should <em>never</em> fail like... an assertion of an invariant. I don't understand when this would fail though, I'd need to poke around its implementation / documentation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-07-02 23:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/base_client.rs</code>:144 on 2024-07-02 23:25</div>
            <div class="timeline-body"><p>It looks like the error attached to the result is just <code>Self</code> and has no information, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kcon-stackav">@kcon-stackav</a> reviewed on 2024-07-02 23:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/kcon-stackav">@kcon-stackav</a> on <code>crates/uv-client/src/base_client.rs</code>:144 on 2024-07-02 23:28</div>
            <div class="timeline-body"><p>Yes I understand the error holds the <code>CryptoProvider</code> that was previously installed as the default in that case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-07-02 23:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/base_client.rs</code>:144 on 2024-07-02 23:31</div>
            <div class="timeline-body"><p>I guess we could capture it to say what we're using instead but it doesn't seem critical.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/kcon-stackav">@kcon-stackav</a> on <code>crates/uv-client/src/base_client.rs</code>:144 on 2024-07-02 23:52</div>
            <div class="timeline-body"><p>Ah yeah I thought about doing that but I wasn't sure the <code>CryptoProvider</code> had a nice human-readable name field we could use: https://docs.rs/rustls/latest/rustls/crypto/struct.CryptoProvider.html</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kcon-stackav">@kcon-stackav</a> reviewed on 2024-07-02 23:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2024-07-02 23:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>.github/workflows/ci.yml</code>:222 on 2024-07-02 23:57</div>
            <div class="timeline-body"><p>ilammy also known for https://github.com/ilammy/msvc-dev-cmd</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-10 14:59</div>
            <div class="timeline-body"><p>Sorry this is lingering, I'm just not sure of the trade-offs here since it changes our release pipeline and hasn't been requested by many people.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-07-10 15:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>.github/workflows/ci.yml</code>:86 on 2024-07-10 15:02</div>
            <div class="timeline-body"><p>maturin calls <code>cargo build</code>, so they same rules should apply whether it's maturin or not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kcon-stackav">@kcon-stackav</a> on 2024-07-15 17:47</div>
            <div class="timeline-body"><blockquote>
<p>Sorry this is lingering, I'm just not sure of the trade-offs here since it changes our release pipeline and hasn't been requested by many people.</p>
</blockquote>
<p>No worries, and feel free to close this PR if not enough people are wanting it since I learned that switching from <code>ring</code> to <code>aws-lc-rs</code> doesn't solve my particular problem after all (https://github.com/astral-sh/uv/issues/4534#issuecomment-2204597948), but I believe https://github.com/astral-sh/uv/issues/1339 should once it becomes available.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @zanieb on 2024-07-15 20:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-19 17:03</div>
            <div class="timeline-body"><p>I think I'll close for now since this changes our build dependencies and there isn't a compelling reason to switch over at this time. Happy to reconsider in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-07-19 17:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rami3l">@rami3l</a> on 2024-08-01 10:55</div>
            <div class="timeline-body"><p>@zanieb As a part of Rustup's plan for the v1.28.0 release cycle, I've migrated Rustup to <code>aws-lc-rs</code> in https://github.com/rust-lang/rustup/pull/3898 for the very same reason (https://github.com/rust-lang/rustup/issues/3820), and I've been contacting <code>aws-lc</code>'s side, providing useful information to help address various issues regarding the cross compilation of this library. I'd love to share more experience with you when we're able to actually ship the build, if you're interested.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-01 12:24</div>
            <div class="timeline-body"><p>Thanks @rami3l, I appreciate the heads up and am definitely interested.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cyberksh">@cyberksh</a> on 2026-01-02 14:54</div>
            <div class="timeline-body"><p>Hello are we planning to add support for this?
If this could be an optional feature for Linux only or we could use the prebuilt NASM modules that are provided by aws-lc-rs</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/rami3l">@rami3l</a> on 2026-01-02 15:05</div>
            <div class="timeline-body"><blockquote>
<p>Thanks @rami3l, I appreciate the heads up and am definitely interested.</p>
</blockquote>
<p>@zanieb Sorry for the long wait, but as you might have noticed, we've been using <code>aws-lc-rs</code> in production for about a year now. The team has been quite responsive in terms of aligning our supported targets so it might be worth it to make the move.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 05:52:26 UTC
    </footer>
</body>
</html>
