<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>fix: ensure temporary caches remain until process completion - astral-sh/uv #15977</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>fix: ensure temporary caches remain until process completion</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/pull/15977">#15977</a>
        opened by <a href="https://github.com/monosans">@monosans</a>
        on 2025-09-22 05:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/monosans">@monosans</a></div>
            <div class="timeline-body"><p>Fixes #15967</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/src/commands/tool/run.rs</code>:395 on 2025-09-22 12:37</div>
            <div class="timeline-body"><p>In this case, we still to drop (or more specifically, unlock) the locked file, while keeping the temp directory around</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-09-22 12:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @monosans on 2025-09-22 14:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-09-22 14:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/tool/run.rs</code>:395 on 2025-09-22 14:17</div>
            <div class="timeline-body"><p>Why do we need to unlock it if we're the only one operating on it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-09-22 16:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/src/commands/tool/run.rs</code>:395 on 2025-09-22 16:49</div>
            <div class="timeline-body"><p>If we keep it locked, it means that every <code>uv run</code> blocks any <code>uv cache</code> operation until it's done, this would be the strictest setting but we have talked in another thread about that we don't actually want to block parallel operations on the cache where possible.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-09-22 16:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/src/commands/tool/run.rs</code>:395 on 2025-09-22 16:57</div>
            <div class="timeline-body"><p>At least with <code>--link-mode reflink|hardlink</code>, I see no risk for the spawned process being affected by cache cleaning</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/tool/run.rs</code>:395 on 2025-09-22 17:00</div>
            <div class="timeline-body"><p>This is specifically with <code>--no-cache</code> in which a temporary dedicated cache is being used?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-09-22 17:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-09-22 17:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/tool/run.rs</code>:395 on 2025-09-22 17:01</div>
            <div class="timeline-body"><p>So I don't think that keeping the (temporary) cache locked would block any other operations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-09-22 19:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/tool/run.rs</code>:389 on 2025-09-22 19:03</div>
            <div class="timeline-body"><p>We'll need this same change in the project run command per https://github.com/astral-sh/uv/issues/15989</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-09-22 19:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/tool/run.rs</code>:395 on 2025-09-22 19:07</div>
            <div class="timeline-body"><p>If this is specifically for <code>--no-cache</code>, then I don't see why it's a problem to leave it locked.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-09-22 23:49</div>
            <div class="timeline-body"><p>I just removed these <code>drop</code> statements entirely in https://github.com/astral-sh/uv/pull/15990 but we can consider releasing the lock for cases where the cache is not used in <code>uv run</code>. We can't just handle temporary caches though, e.g., <code>uv cache clean</code> during a concurrent <code>uv run --script</code> would delete the script environment. I'm not sure what's best.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-09-23 11:35</div>
            <div class="timeline-body"><p>We should add the test case either way, the cache logic we can tune based on how much we care about <code>uv cache</code> commands not being blocked.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-10-06 14:55</div>
            <div class="timeline-body"><blockquote>
<p>I just removed these <code>drop</code> statements entirely in #15990 but we can consider releasing the lock for cases where the cache is not used in <code>uv run</code>. We can't just handle temporary caches though, e.g., <code>uv cache clean</code> during a concurrent <code>uv run --script</code> would delete the script environment. I'm not sure what's best.</p>
</blockquote>
<p>Are there any cases we don't want to release the locks with <code>uv run</code>, given the problems in https://github.com/astral-sh/setup-uv/issues/588?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-10-06 15:50</div>
            <div class="timeline-body"><p>Yeah I already gave an example there: <code>uv run --script</code> is not concurrency-safe with <code>uv cache clean</code> if you release the lock.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:44:50 UTC
    </footer>
</body>
</html>
