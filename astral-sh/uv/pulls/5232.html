<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Respect local versions for all user requirements - astral-sh/uv #5232</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Respect local versions for all user requirements</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/5232">#5232</a>
        opened by <a href="https://github.com/ibraheemdev">@ibraheemdev</a>
        on 2024-07-19 20:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-07-19 20:49</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This fixes a few bugs introduced by https://github.com/astral-sh/uv/pull/5104. I previously thought we could track conflicting locals the same way we track conflicting URLs in forks, but it turns out that ends up being very tricky. URL forks work because we prioritize directly URL requirements. We can't prioritize locals in the same way without conflicting with the URL prioritization (this may be possible but it's not trivial), so we run into issues where a correct resolution depends on the order in which dependencies are traversed.</p>
<p>Instead, we track local versions across all forks in <code>Locals</code>. When applying a local version, we apply all locals with markers that intersect with the current fork. This way we end up applying some local versions without creating a fork. For example, given:</p>
<pre><code>// pyproject.toml
dependencies = [
    &quot;torch==2.0.0+cu118 ; platform_machine == 'x86_64'&quot;,
]

// requirements.in
torch==2.0.0
.
</code></pre>
<p>We choose <code>2.0.0+cu118</code> in all cases. However, if a disjoint fork is created based on local versions, the resolver will choose the most compatible local when it narrows to a specific fork. Thus we correctly respect local versions when forking:</p>
<pre><code>// pyproject.toml
dependencies = [
    &quot;torch==2.0.0+cu118 ; platform_machine == 'x86_64'&quot;,
    &quot;torch==2.0.0+cpu ; platform_machine != 'x86_64'&quot;
]

// requirements.in
torch==2.0.0
.
</code></pre>
<p>We should also be able to use a similar strategy for https://github.com/astral-sh/uv/pull/5150.</p>
<h2>Test Plan</h2>
<p>This fixes https://github.com/astral-sh/uv/issues/5220 locally for me, as well as a few other bugs that were not reported yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">lock</span> added by @ibraheemdev on 2024-07-19 20:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @ibraheemdev on 2024-07-19 20:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @ibraheemdev on 2024-07-19 20:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-07-19 21:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/resolver/mod.rs</code>:2077 on 2024-07-19 21:07</div>
            <div class="timeline-body"><p>I guess this will just... fail? Since it has to be the union of multiple different <code>==</code> requirements, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-07-19 21:07</div>
            <div class="timeline-body"><p>Nice. I find this easier to reason about too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2024-07-19 21:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/uv-resolver/src/resolver/mod.rs</code>:2077 on 2024-07-19 21:47</div>
            <div class="timeline-body"><p>This should work fine, we want to allow any compatible local versions before narrowing to a fork.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2024-07-19 21:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-07-19 21:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-19 21:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 13:43:11 UTC
    </footer>
</body>
</html>
