<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deduplicate source dist unpack code - astral-sh/uv #7224</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Deduplicate source dist unpack code</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/7224">#7224</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2024-09-09 16:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/konstin">@konstin</a> on 2024-09-09 16:33</div>
            <div class="timeline-body"><p>Use a generic instead of having the same code again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-09 16:34</div>
            <div class="timeline-body"><p>Can you check the llvm-lines before and after just to be safe?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-09-09 16:44</div>
            <div class="timeline-body"><p>Before: 1569748
After: 1570933</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-09-09 16:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-extract/src/stream.rs</code>:165 on 2024-09-09 16:46</div>
            <div class="timeline-body"><p>Can you just make this fn take the <code>BufReader</code>? And move the first few lines out to the caller?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-09-09 18:38</div>
            <div class="timeline-body"><p>With main, this branch and the branch plus the batch below i get the following numbers for release. @BurntSushi do you know why we get more llvm lines by removing duplicates for a generic?</p>
<p>patch:   5905096                117569                (TOTAL)
branch:  5904673                117543                (TOTAL)
main:    5904053                117523                (TOTAL)</p>
<pre><code class="language-diff">diff --git a/crates/uv-extract/src/stream.rs b/crates/uv-extract/src/stream.rs
index c23f20755..79f3ac26d 100644
--- a/crates/uv-extract/src/stream.rs
+++ b/crates/uv-extract/src/stream.rs
@@ -104,8 +104,8 @@ pub async fn unzip&lt;R: tokio::io::AsyncRead + Unpin&gt;(
 /// Unpack the given tar archive into the destination directory.
 ///
 /// This is equivalent to `archive.unpack_in(dst)`, but it also preserves the executable bit.
-async fn untar_in&lt;'a&gt;(
-    mut archive: tokio_tar::Archive&lt;&amp;'a mut (dyn tokio::io::AsyncRead + Unpin)&gt;,
+async fn untar_in&lt;'a, T: tokio::io::AsyncRead + Unpin&gt;(
+    mut archive: tokio_tar::Archive&lt;&amp;'a mut T&gt;,
     dst: &amp;Path,
 ) -&gt; std::io::Result&lt;()&gt; {
     let mut entries = archive.entries()?;
@@ -157,22 +157,17 @@ async fn untar_in&lt;'a&gt;(
 /// Unzip a `.tar.*` archive into the target directory, without requiring `Seek`.
 ///
 /// This is useful for unpacking files as they're being downloaded.
-pub(crate) async fn untar_compression&lt;
-    R: tokio::io::AsyncRead + Unpin,
-    Decoder: tokio::io::AsyncRead + Unpin,
-&gt;(
+async fn untar_compression&lt;'a, R: tokio::io::AsyncRead + Unpin + 'a&gt;(
     reader: R,
-    decoder: impl Fn(tokio::io::BufReader&lt;R&gt;) -&gt; Decoder,
+    decoder: impl Fn(tokio::io::BufReader&lt;R&gt;) -&gt; Box&lt;dyn tokio::io::AsyncRead + Unpin + 'a&gt;,
     target: impl AsRef&lt;Path&gt;,
 ) -&gt; Result&lt;(), Error&gt; {
     let reader = tokio::io::BufReader::with_capacity(DEFAULT_BUF_SIZE, reader);
     let mut decompressed_bytes = decoder(reader);

-    let archive = tokio_tar::ArchiveBuilder::new(
-        &amp;mut decompressed_bytes as &amp;mut (dyn tokio::io::AsyncRead + Unpin),
-    )
-    .set_preserve_mtime(false)
-    .build();
+    let archive = tokio_tar::ArchiveBuilder::new(&amp;mut decompressed_bytes)
+        .set_preserve_mtime(false)
+        .build();
     Ok(untar_in(archive, target.as_ref()).await?)
 }

@@ -190,7 +185,7 @@ pub async fn archive&lt;R: tokio::io::AsyncRead + Unpin&gt;(
         SourceDistExtension::TarGz =&gt; {
             untar_compression(
                 reader,
-                async_compression::tokio::bufread::GzipDecoder::new,
+                |x| Box::new(async_compression::tokio::bufread::GzipDecoder::new(x)),
                 target,
             )
             .await?;
@@ -198,7 +193,7 @@ pub async fn archive&lt;R: tokio::io::AsyncRead + Unpin&gt;(
         SourceDistExtension::TarBz2 =&gt; {
             untar_compression(
                 reader,
-                async_compression::tokio::bufread::BzDecoder::new,
+                |x| Box::new(async_compression::tokio::bufread::BzDecoder::new(x)),
                 target,
             )
             .await?;
@@ -206,7 +201,7 @@ pub async fn archive&lt;R: tokio::io::AsyncRead + Unpin&gt;(
         SourceDistExtension::TarXz =&gt; {
             untar_compression(
                 reader,
-                async_compression::tokio::bufread::XzDecoder::new,
+                |x| Box::new(async_compression::tokio::bufread::XzDecoder::new(x)),
                 target,
             )
             .await?;
@@ -214,7 +209,7 @@ pub async fn archive&lt;R: tokio::io::AsyncRead + Unpin&gt;(
         SourceDistExtension::TarZst =&gt; {
             untar_compression(
                 reader,
-                async_compression::tokio::bufread::ZstdDecoder::new,
+                |x| Box::new(async_compression::tokio::bufread::ZstdDecoder::new(x)),
                 target,
             )
             .await?;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2024-09-24 10:33</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 13:01:28 UTC
    </footer>
</body>
</html>
