<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filter discovered Python executables by source before querying - astral-sh/uv #11143</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Filter discovered Python executables by source before querying</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/11143">#11143</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2025-01-31 19:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-31 19:45</div>
            <div class="timeline-body"><p>Closes https://github.com/astral-sh/uv/issues/11138</p>
<p>Though I think we could still have a better error message there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @zanieb on 2025-01-31 19:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">error messages</span> added by @zanieb on 2025-01-31 19:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @Gankra by @zanieb on 2025-01-31 19:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @zanieb on 2025-01-31 19:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:437 on 2025-01-31 20:44</div>
            <div class="timeline-body"><p>This is a <code>filter_ok</code> in #11145</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-01-31 20:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-01-31 21:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-python/src/discovery.rs</code>:632 on 2025-01-31 21:02</div>
            <div class="timeline-body"><p>&quot;definitively&quot;, I think</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-01-31 21:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-python/src/discovery.rs</code>:437 on 2025-01-31 21:03</div>
            <div class="timeline-body"><p>Is this doing more work than before, since we're returning all the iterators here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-01-31 21:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:632 on 2025-01-31 21:07</div>
            <div class="timeline-body"><p>indeed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-01-31 21:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:632 on 2025-01-31 21:07</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// preference as a pre-filtering step. We cannot definitively know if a Python interpreter is in
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-01-31 21:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:437 on 2025-01-31 21:13</div>
            <div class="timeline-body"><p>Uhh maybe. I'd have to squint at it a bit.</p>
<p>Generally, it's much less work. This is pre-query (and querying is the slow part) and <code>EnvironmentPreference::ExplicitSystem</code> is the common case so more aggressive filtering here should be better.</p>
<p>It seems possible with <code>EnvironmentPreference::OnlyVirtual</code> we now traverse the <code>PATH</code> directories whereas previously we did not? I'll check on that — because I agree that's not ideal. I'd be sad about doing <em>both</em> this filtering and the previous <code>match</code> statement though, they overlap significantly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2025-01-31 21:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-01-31 21:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:437 on 2025-01-31 21:21</div>
            <div class="timeline-body"><p>Yes you're correct, this now scans more in the <code>OnlyVirtual</code> case. However... we only construct that case in <code>uv-dev</code> (and tests)</p>
<p>https://github.com/astral-sh/uv/blob/41cd4bee5861cdda4d826c29cd413b97638186cb/crates/uv-dev/src/compile.rs#L26</p>
<p>which was surprising to me. We basically always use this constructor</p>
<p>https://github.com/astral-sh/uv/blob/e26affd27cd76b37f1fa868687a7b324fbf63ba2/crates/uv-python/src/discovery.rs#L1616-L1627</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-01-31 21:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:437 on 2025-01-31 21:23</div>
            <div class="timeline-body"><p>The other case is that we'll now also perform the scanning for executables from virtual environments if you provide <code>--system</code>, though we'll toss those out. Might be worth changing still.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-01-31 21:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:437 on 2025-01-31 21:25</div>
            <div class="timeline-body"><p>e.g.</p>
<p>main</p>
<pre><code>❯ uv python find -v --system
DEBUG uv 0.5.26+6 (ca5b84027 2025-01-31)
DEBUG Found project root: `/Users/zb/workspace/uv`
DEBUG Project `uv` is marked as unmanaged
DEBUG Reading Python requests from version file at `/Users/zb/workspace/uv/.python-version`
DEBUG Using Python request `3.12` from version file at `.python-version`
DEBUG Searching for Python 3.12 in managed installations or search path
DEBUG Searching for managed installations at `/Users/zb/.local/share/uv/python`
DEBUG Skipping incompatible managed installation `cpython-3.14.0a4-macos-aarch64-none`
DEBUG Skipping incompatible managed installation `cpython-3.10.16-macos-aarch64-none`
DEBUG Skipping incompatible managed installation `cpython-3.10.5-macos-aarch64-none`
DEBUG Found `cpython-3.12.8-macos-aarch64-none` at `/opt/homebrew/bin/python3.12` (search path)
/opt/homebrew/opt/python@3.12/bin/python3.12
</code></pre>
<p>vs branch</p>
<pre><code>❯ uv python find -v --system
DEBUG uv 0.5.26+7 (9aefd76b4 2025-01-31)
DEBUG Found project root: `/Users/zb/workspace/uv`
DEBUG Project `uv` is marked as unmanaged
DEBUG Reading Python requests from version file at `/Users/zb/workspace/uv/.python-version`
DEBUG Using Python request `3.12` from version file at `.python-version`
DEBUG Searching for Python 3.12 in managed installations or search path
DEBUG Ignoring Python interpreter at `/Users/zb/workspace/uv/.venv/bin/python3`: system interpreter required
DEBUG Searching for managed installations at `/Users/zb/.local/share/uv/python`
DEBUG Skipping incompatible managed installation `cpython-3.14.0a4-macos-aarch64-none`
DEBUG Skipping incompatible managed installation `cpython-3.10.16-macos-aarch64-none`
DEBUG Skipping incompatible managed installation `cpython-3.10.5-macos-aarch64-none`
DEBUG Found `cpython-3.12.8-macos-aarch64-none` at `/opt/homebrew/bin/python3.12` (search path)
/opt/homebrew/opt/python@3.12/bin/python3.12
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-01-31 21:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:437 on 2025-01-31 21:38</div>
            <div class="timeline-body"><p>Thanks for flagging https://github.com/astral-sh/uv/pull/11143/commits/02e72be6661b4a0211ad5ec6feb21dc27871de0f</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2025-01-31 21:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-01-31 21:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-31 21:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:19 UTC
    </footer>
</body>
</html>
