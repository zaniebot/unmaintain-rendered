<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parse `SimpleJson` into categorized data in the client - astral-sh/uv #522</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Parse <code>SimpleJson</code> into categorized data in the client</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/522">#522</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2023-11-30 20:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/zanieb">@zanieb</a> on 2023-11-30 20:20</div>
            <div class="timeline-body"><p>Extends #517 with a suggestion from @konstin to parse the <code>SimpleJson</code> into an intermediate type <code>SimpleMetadata(BTreeMap&lt;Version, VersionFiles&gt;)</code> before converting to a <code>VersionMap</code>. This reduces the number of times we need to parse the response. Additionally, we cache the parsed response now instead of <code>SimpleJson</code>.</p>
<p><code>VersionFiles</code> stores two vectors with <code>WheelFilename</code>/<code>SourceDistFilename</code> and <code>File</code> tuples. These can be iterated over together or separately. A new enum <code>DistFilename</code> was added to capture the <code>SourceDistFilename</code> and <code>WheelFilename</code> variants allowing iteration over both vectors.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-11-30 20:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/puffin-resolver/src/finder.rs</code>:150 on 2023-11-30 20:39</div>
            <div class="timeline-body"><p>I would recommend viewing <a href="https://github.com/astral-sh/puffin/pull/522/files?diff=unified&amp;w=1">with whitespace ignored</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @zanieb on 2023-11-30 21:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-12-01 11:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/puffin-client/src/registry_client.rs</code>:394 on 2023-12-01 11:46</div>
            <div class="timeline-body"><p>Could we split wheels and source dists?</p>
<pre><code class="language-rust">pub struct VersionFiles {
    wheels: Vec&lt;(WheelFilename, File)&gt;,
    source_dists: Vec&lt;(SourceDistFilename, File)&gt;,
}

pub struct SimpleMetadata(BTreeMap&lt;Version, VersionFiles&gt;);
</code></pre>
<p>This will improve deserialization, we don't have to try both parsers, and make the file selection logic clear (go through all wheels to find the best, if none, find any source dist with matching requires python).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-12-01 11:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/puffin-client/src/registry_client.rs</code>:394 on 2023-12-01 11:47</div>
            <div class="timeline-body"><p>My motivation is to put the <code>SimpleMetadata</code> into the cache instead of the <code>SimpleJson</code>, for both html index and perf reason.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-12-04 15:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/puffin-client/src/registry_client.rs</code>:394 on 2023-12-04 15:11</div>
            <div class="timeline-body"><p>Hm I tried this first but it made some other code pretty duplicative. I can look into it again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zanieb on 2023-12-06 20:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-12-06 20:30</div>
            <div class="timeline-body"><p>Konsti mentioned wanting to use this type in the cache as well, impl in https://github.com/astral-sh/puffin/pull/522/commits/46577048aab828e51439ad715bd9acb83f1743d3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-12-06 20:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/puffin-client/src/registry_client.rs</code>:394 on 2023-12-06 20:41</div>
            <div class="timeline-body"><p>impl in https://github.com/astral-sh/puffin/pull/522/commits/00e63fcc8f71f4aeeb8aeda318543a3a17c8d29e</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-12-06 21:40</div>
            <div class="timeline-body"><p>A very rough benchmark with <code>resolve-many</code> shows no improvement</p>
<pre><code>time cargo run --bin puffin-dev --release -- resolve-many --cache-dir cache-docker-no-build --no-build ./pypi_top_8k_flat.txt

main cold cache

    102.47s user 13.76s system 433% cpu 26.840 total

main hot cache

    104.07s user 9.73s system 746% cpu 15.245 total

branch cold cache

    120.44s user 14.73s system 495% cpu 27.292 total

branch hot cache

    124.87s user 10.65s system 793% cpu 17.070 total
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-12-06 21:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-12-06 21:46</div>
            <div class="timeline-body"><p>I think this is the right change independent of benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/distribution-filename/src/lib.rs</code>:16 on 2023-12-07 00:49</div>
            <div class="timeline-body"><p>Nit: I'd say <code>try_from_filename</code> is a fine name.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/distribution-filename/src/source_dist.rs</code>:5 on 2023-12-07 00:51</div>
            <div class="timeline-body"><p>I believe this is an optional dependency, so it needs to be added optionally here. Like:</p>
<pre><code class="language-rust">#[derive(Debug, PartialEq, Eq, Clone)]
#[cfg_attr(feature = &quot;serde&quot;, derive(Serialize, Deserialize))]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-resolver/src/finder.rs</code>:188 on 2023-12-07 00:54</div>
            <div class="timeline-body"><p>Is this necessary given that we're using <code>into_iter</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-client/src/registry_client.rs</code>:419 on 2023-12-07 00:56</div>
            <div class="timeline-body"><p>Why do we need to index by version? Don't we end up iterating over all of the entires anyway? And <code>WheelFilename</code> and <code>SourceDistFilename</code> both contain <code>Version</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-12-07 01:02</div>
            <div class="timeline-body"><p>The change looks nice, though I'm slightly torn on this because I suspect it should actually be slower in the installer, since we now have to iterate over the entire <code>SimpleJson</code> to build the <code>SimpleMetadata</code>, whereas today in the installer, we reverse-iterate over the list of files and break as soon as we pass the highest-compatible version.</p>
<p>In the worst case (imagine a distribution with a ton of versions, and we're using the latest), that means we're iterating over a huge number of files and versions to parse, allocate, etc. in a way that won't ultimately be necessary. I wish we could produce some benchmarks to decide one way or another.</p>
<p>(We <em>do</em> iterate over all files and versions in the <em>resolver</em> today, but not in the installer.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-12-07 04:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/puffin-client/src/registry_client.rs</code>:419 on 2023-12-07 04:35</div>
            <div class="timeline-body"><p>I defer to @konstin but it does let us do things like..</p>
<pre><code class="language-rust">        for (version, files) in metadata.into_iter().rev() {
            // If we iterated past the first-compatible version, break.
            if best_version
                .as_ref()
                .is_some_and(|best_version| *best_version != version)
            {
                break;
            }

            // If the version does not satisfy the requirement, continue.
            if !requirement.is_satisfied_by(&amp;version) {
                continue;
            }

            // Find the most-compatible wheel
            for (wheel, file) in files.wheels { ... }

             // Find the most-compatible sdist, if no wheel was found.
            if best_wheel.is_none() {
                for (sdist, file) in files.source_dists { ... }
            }
</code></pre>
<p>Perhaps for sorting?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-12-07 13:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/puffin-client/src/registry_client.rs</code>:419 on 2023-12-07 13:19</div>
            <div class="timeline-body"><p>We don't strongly need to; I thought it was useful because it gives us a list of versions upfront and makes it possible to split by versions if we want later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-07 14:44</div>
            <div class="timeline-body"><p>I will do some basic benchmarking of this in the installer to understand whether the concern I brought up matters at all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-12-07 16:47</div>
            <div class="timeline-body"><p>I did some benchmarking and couldn't see any noticeable changes so this looks good to me. I'll write up a separate comment outlining my benchmarking approach.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-07 16:50</div>
            <div class="timeline-body"><p>To benchmark...</p>
<ul>
<li>I first built a release build on main: <code>git co main &amp;&amp; cargo build --release &amp;&amp; mv ./target/release/puffin ./target/release/main</code></li>
<li>I then built a a release build on this branch with <code>cargo build --release</code>.</li>
<li>I then modified <code>./scripts/benchmarks/sync.sh</code> to compare the two release builds:</li>
</ul>
<pre><code class="language-sh">#!/usr/bin/env bash

###
# Benchmark the installer against `pip`.
#
# Example usage:
#
#   ./scripts/benchmarks/sync.sh ./scripts/benchmarks/requirements.txt
###

set -euxo pipefail

TARGET=${1}

###
# Installation with a cold cache.
###
hyperfine --runs 50 --warmup 10 \
    --prepare &quot;virtualenv --clear .venv&quot; \
    &quot;./target/release/main pip-sync ${TARGET} --no-cache&quot; \
    --prepare &quot;virtualenv --clear .venv&quot; \
    &quot;./target/release/puffin pip-sync ${TARGET} --no-cache&quot;

###
# Installation with a warm cache, similar to blowing away and re-creating a virtual environment.
###
hyperfine --runs 50 --warmup 10 \
    --prepare &quot;virtualenv --clear .venv&quot; \
    &quot;./target/release/main pip-sync ${TARGET}&quot; \
    --prepare &quot;virtualenv --clear .venv&quot; \
    &quot;./target/release/puffin pip-sync ${TARGET}&quot;

###
# Installation with all dependencies already installed (no-op).
###
hyperfine --runs 50 --warmup 10 \
    --setup &quot;virtualenv --clear .venv &amp;&amp; source .venv/bin/activate&quot; \
    &quot;./target/release/main pip-sync ${TARGET}&quot; \
    &quot;./target/release/puffin pip-sync ${TARGET}&quot;
</code></pre>
<ul>
<li>I then ran <code>./scripts/benchmarks/sync.sh ./scripts/benchmarks/requirements.txt</code>.</li>
</ul>
<p>I tweaked <code>requirements.txt</code> to include different packages (e.g., <code>boto3</code> which has a ton of versions). In general, I didn't see any noticeable effect. The cached install (second benchmark) was <em>maybe</em> a bit faster, and the uncached install (first benchmark) was <em>maybe</em> a bit slower (but if so, within 1%).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2023-12-07 17:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2023-12-07 17:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-12-07 17:04</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 15:45:06 UTC
    </footer>
</body>
</html>
