```yaml
number: 2254
title: "Add support for retrieving credentials from `keyring`"
type: pull_request
state: merged
author: BakerNet
labels: []
assignees: []
merged: true
base: main
head: feature/basic-use-keyring
created_at: 2024-03-06T23:29:53Z
updated_at: 2024-03-13T20:02:19Z
url: https://github.com/astral-sh/uv/pull/2254
synced_at: 2026-01-10T14:49:08Z
```

# Add support for retrieving credentials from `keyring`

---

_Pull request opened by @BakerNet on 2024-03-06 23:29_

<!--
Thank you for contributing to uv! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

<!-- What's the purpose of the change? What does it do, and why? -->

Adds basic keyring auth support for `uv` commands.  Adds clone of `pip`'s `--keyring-provider subprocess` argument (using CLI `keyring` tool).

See issue: https://github.com/astral-sh/uv/issues/1520

## Test Plan

<!-- How was it tested? -->

Hard to write full-suite unit tests due to reliance on `process::Command` for `keyring` cli

Manually tested end-to-end in a project with GCP artifact registry using keyring password:
```bash
‚ûú  uv pip uninstall watchdog
Uninstalled 1 package in 46ms
 - watchdog==4.0.0

‚ûú  cargo run -- pip install --index-url https://<redacted>/python/simple/ --extra-index-url https://<redacted>/pypi-mirror/simple/ watchdog
    Finished dev [unoptimized + debuginfo] target(s) in 0.18s
     Running `target/debug/uv pip install --index-url 'https://<redacted>/python/simple/' --extra-index-url 'https://<redacted>/pypi-mirror/simple/' watchdog`
error: HTTP status client error (401 Unauthorized) for url (https://<redacted>/pypi-mirror/simple/watchdog/)

‚ûú  cargo run -- pip install --keyring-provider subprocess --index-url https://<redacted>/python/simple/ --extra-index-url https://<redacted>/pypi-mirror/simple/ watchdog
    Finished dev [unoptimized + debuginfo] target(s) in 0.17s
     Running `target/debug/uv pip install --keyring-provider subprocess --index-url 'https://<redacted>/python/simple/' --extra-index-url 'https://<redacted>/pypi-mirror/simple/' watchdog`
Resolved 1 package in 2.34s
Installed 1 package in 27ms
 + watchdog==4.0.0
```

`requirements.txt`
```
#
# This file is autogenerated by pip-compile with Python 3.10
# by the following command:
#
#    .bin/generate-requirements
#
--index-url https://<redacted>/python/simple/
--extra-index-url https://<redacted>/pypi-mirror/simple/

...
```

```bash
‚ûú  cargo run -- pip install --keyring-provider subprocess -r requirements.txt
    Finished dev [unoptimized + debuginfo] target(s) in 0.19s
     Running `target/debug/uv pip install --keyring-provider subprocess -r requirements.txt`
Resolved 205 packages in 23.52s
   Built <redacted>
   ...
Downloaded 47 packages in 19.32s
Installed 195 packages in 276ms
 + <redacted>
  ...
```

---

_Converted to draft by @BakerNet on 2024-03-06 23:30_

---

_Assigned to @zanieb by @zanieb on 2024-03-06 23:40_

---

_Comment by @BakerNet on 2024-03-06 23:58_

~~Note:  Refactoring to use Middleware instead~~
Done

---

_Comment by @BakerNet on 2024-03-07 04:56_

~~Not in working state~~
Fixed

---

_Marked ready for review by @BakerNet on 2024-03-07 05:45_

---

_Review comment by @zanieb on `crates/uv/src/main.rs`:351 on 2024-03-07 23:45_

Will the keyring be used for `--find-links` URLs? I believe those work fine with `--no-index`.

---

_Review comment by @zanieb on `crates/uv-keyring/src/lib.rs`:11 on 2024-03-07 23:46_

My plan was to have an `AuthenticationStore` type over in `uv-auth` that contained all of this.

I'm not sure if that's worth doing in this pull request or if I should explore it afterwards.

---

_Review comment by @zanieb on `crates/uv-keyring/src/lib.rs`:11 on 2024-03-07 23:47_

At the very least, it seems safe to move `uv-keyring/lib.rs` to `uv-auth/keyring.rs`

---

_Review comment by @zanieb on `crates/uv-client/src/middleware.rs`:52 on 2024-03-07 23:50_

I think we should probably just have a single `AuthMiddleware` type that uses `uv_auth.AuthenticationStore`. I think we'd probably want to re-implement the netrc middleware in `uv-auth` so we have full control over it. Then we can document a clear priority of authentication methods.

---

_Review comment by @zanieb on `crates/uv-keyring/src/lib.rs`:23 on 2024-03-07 23:52_

I think we're preferring `thiserror` for application-internal error handling.

---

_Review comment by @zanieb on `crates/uv-keyring/src/lib.rs`:35 on 2024-03-07 23:55_

We generally try to write expressions to avoid calling `unwrap()`

---

_Review comment by @zanieb on `crates/uv-keyring/src/lib.rs`:48 on 2024-03-07 23:57_

Here you give keyring the full URL but above we're only using the host to cache passwords. We'll want to be more robust about the caching as described in

https://github.com/astral-sh/uv/blob/8d721830db8ad75b8b7ef38edc0e346696c52e3d/crates/uv-auth/src/lib.rs#L39-L44

---

_Review comment by @zanieb on `crates/uv-keyring/src/lib.rs`:53 on 2024-03-07 23:58_

We'll want to use an error case for this to avoid panicking if someone has a bad keyring executable

---

_Review comment by @zanieb on `crates/uv/src/main.rs`:349 on 2024-03-07 23:59_

Why not match `pip`'s interface exactly here? This interface seems more limited.

---

_@zanieb had review dismissed on 2024-03-08 00:02_

Hi! Thank you so much for contributing and welcome to the project :)

This change overlaps with some work I've been considering, so I've left some notes about future plans ‚Äî let me know how interested you are in pursuing some of the broader strokes I've outlined.


---

_@BakerNet reviewed on 2024-03-08 01:07_

---

_Review comment by @BakerNet on `crates/uv/src/main.rs`:349 on 2024-03-08 01:07_

I implemented it more limited on purpose - because we only have access to the CLI version of keyring, the other option (python import) isn't available.  
Also, I can't say I'm a fan of pip default ("auto").  The way "auto" works in `pip`:
Try endpoint. If `401` on first request, try python import `keyring.get_credential` method.  If python import method fails, try CLI.

You could implement the keyring retry on `401` via middleware as default I guess, but... do you want to?

---

_@BakerNet reviewed on 2024-03-08 01:31_

---

_Review comment by @BakerNet on `crates/uv-client/src/middleware.rs`:52 on 2024-03-08 01:31_

Makes sense, and I'd be happy to re-implement/combine the netrc middleware for this - but do you have an idea on what the interface with `uv_auth.AuthenticationStore` will look like?

One thing to be aware of here is that we do not have access to `&mut self` in the `RequestInitialiser` trait so can't call mutable methods on a struct field.  I originally planned to have store in the `KeyringMiddleware` but ran into this issue which is why it's a static ref in `get_keyring_auth`

---

_@zanieb reviewed on 2024-03-08 02:56_

---

_Review comment by @zanieb on `crates/uv/src/main.rs`:349 on 2024-03-08 02:56_

Oh I see they support `--keyring-provider subprocess` or `--keyring-provider auto` ‚Äî I read this as `--keyring-provider <name>` where you could specify what command to spawn for keyring information. I'm more okay with this then.

Does `pip` use the `--keyring-provider auto` by default? i.e. does it always do keyring lookups?

Do you have more context on how the `keyring` Python library differs from the `keyring` command line tool? Happy to look into this myself some too.

---

_@zanieb reviewed on 2024-03-08 03:01_

---

_Review comment by @zanieb on `crates/uv-client/src/middleware.rs`:52 on 2024-03-08 03:01_

I hadn't figured that out yet :)

I was going to study [pip's implementation](https://github.com/pypa/pip/blob/9824a426d466680d132aa027add88ec0dda9116f/src/pip/_internal/network/auth.py). I imagine the authentication store would just need something like `get(url: Url) -> Option<Credentials>`, `set(url: Url, credentials: Credentials)`, `with_auth(url: Url) -> Url`, `save_from_url(url: Url)`?

Definitely felt like a bigger design that would need some consideration. It'd be good to include our current authentication transfer from response -> request URLs in its API somehow.

---

_@BakerNet reviewed on 2024-03-08 04:07_

---

_Review comment by @BakerNet on `crates/uv/src/main.rs`:349 on 2024-03-08 04:07_

> Does¬†pip¬†use the¬†--keyring-provider auto¬†by default? i.e. does it always do keyring lookups?

It does use `auto` by default - but it will only do keyring lookups if the first request fails with a `401` status code when in `auto` mode.

As for how CLI vs package differ:
The CLI tool uses the keyring python package under the hood.  The only difference is that the python package doesn't require you to supply a username to `keyring.get_credentials`,  but the CLI tool does for `keyring get`.  The username passed to the CLI tool can be anything for the GCP plugin (because it's not actually checked).  I don't know for sure about other cloud providers' plugins because I have not used them, but I would guess it's the same.

---

_@BakerNet reviewed on 2024-03-08 06:25_

---

_Review comment by @BakerNet on `crates/uv/src/main.rs`:351 on 2024-03-08 06:25_

I think you're right - I don't know why it wouldn't be used for `--find-links` urls.

---

_@BakerNet reviewed on 2024-03-08 06:25_

---

_Review comment by @BakerNet on `crates/uv-keyring/src/lib.rs`:23 on 2024-03-08 06:25_

Done

---

_@BakerNet reviewed on 2024-03-08 06:25_

---

_Review comment by @BakerNet on `crates/uv-keyring/src/lib.rs`:35 on 2024-03-08 06:25_

Done

---

_@BakerNet reviewed on 2024-03-08 06:26_

---

_Review comment by @BakerNet on `crates/uv/src/main.rs`:351 on 2024-03-08 06:26_

Removed `conflicts_with`

---

_@BakerNet reviewed on 2024-03-08 06:27_

---

_Review comment by @BakerNet on `crates/uv-keyring/src/lib.rs`:11 on 2024-03-08 06:27_

Basic move done - haven't started to tackle AuthenticationStore yet

---

_@BakerNet reviewed on 2024-03-08 06:28_

---

_Review comment by @BakerNet on `crates/uv-keyring/src/lib.rs`:53 on 2024-03-08 06:28_

Done

---

_Comment by @BakerNet on 2024-03-08 06:29_

While changes are WIP, do you guys like the PR converted to Draft, or kept Open?

---

_Comment by @zanieb on 2024-03-08 15:10_

@BakerNet if you don't want my feedback for a period of time you could mark it as a draft, otherwise I'll read through it periodically.

---

_@zanieb reviewed on 2024-03-09 01:27_

---

_Review comment by @zanieb on `crates/uv/src/main.rs`:349 on 2024-03-09 01:27_

Just wondering, why don't you like the `auto` behavior? It seems like it _could_ be sensible to avoid sending credentials to URLs that do not require it. I don't have a preference at this point but every difference from `pip` can cause confusion so I want to make an informed decision.

---

_@BakerNet reviewed on 2024-03-09 01:34_

---

_Review comment by @BakerNet on `crates/uv-client/src/middleware.rs`:52 on 2024-03-09 01:34_

Done - implemented pretty much as you laid out, but used a slightly more verbose method name `with_url_encoded_auth`

---

_@BakerNet reviewed on 2024-03-09 01:35_

---

_Review comment by @BakerNet on `crates/uv-keyring/src/lib.rs`:48 on 2024-03-09 01:35_

Moved specification into type `NetLoc` with equality checking which also matches `pip`'s naming (`netloc`) for their password memo dict

---

_@BakerNet reviewed on 2024-03-09 01:54_

---

_Review comment by @BakerNet on `crates/uv/src/main.rs`:349 on 2024-03-09 01:54_

I guess it's just a personal distaste - but totally understand that differences from `pip` are problematic and can understand the point about sending credentials unnecessarily.

Implementing the retry on `401` seems non-trivial, but I'm sure it's doable.

Steps:
Create policy to retry on first `401` status (using `reqwest-retry` probably)
Before retry, delete stored auth state for URL so it will not short-circuit auth middleware
Somehow inform auth middleware to use keyring for future requests to this URL

To test:
Make sure auth middleware still runs on retry (I haven't tested this with `reqwest-retry` so don't know)

---

_@zanieb reviewed on 2024-03-09 03:24_

---

_Review comment by @zanieb on `crates/uv/src/main.rs`:349 on 2024-03-09 03:24_

I agree that feels convoluted. I'll see if there are other opinions.

---

_Comment by @zanieb on 2024-03-10 15:10_

Heads up that we had to change the netrc implementation to use middleware in #2325 because it caused a regression.

Let me know if you have any problems resolving the conflicts.

---

_Comment by @vlad-ivanov-name on 2024-03-10 15:44_

hey folks, happy to see this being implemented -- I'm using uv with artifact registry. Couple of questions:

1) Do you think in future there could be an option to use a built-in credential access routine for specific hosts instead of calling a subprocess? I would really like to avoid python being involved in the process for reliability and convenience reasons. Having `keyring` tool available means there's already a python environment where it's available, meaning we would need to pin requirements for that environment because it's not just a single package but rather keyring + backends, and this creates sort of a chicken-egg problem. On top of that it's a bit of a deviation from the tool written in rust into the shaky untyped python ecosystem -- things just break randomly way more often there. Having this in uv would therefore avoid _a lot_ of dependencies and variability.

    For example deriving a token from environment for GCP is relatively easily and such native credential helper could be much more robust, and avoid the chicken-egg thing. The only thing I'm not sure is the UX -- but I would be happy with just an arg like `--auth-helper=us-west1-python.pkg.dev=gcloud` or something like that

2) I haven't tried to integrate this anywhere yet but I hope the interface is flexible enough so that code that consumes uv as a dependency can plug its own auth helpers or easily reuse internal ones

---

_@BakerNet reviewed on 2024-03-10 21:24_

---

_Review comment by @BakerNet on `crates/uv/src/main.rs`:349 on 2024-03-10 21:24_

Changed to use same interface as `pip` - and I have a good idea of how to implement the retry, but think it would be better to do in a follow-up PR

---

_Comment by @BakerNet on 2024-03-11 16:56_

> hey folks, happy to see this being implemented -- I'm using uv with artifact registry. Couple of questions:
> 
> 1. Do you think in future there could be an option to use a built-in credential access routine for specific hosts instead of calling a subprocess? I would really like to avoid python being involved in the process for reliability and convenience reasons. Having `keyring` tool available means there's already a python environment where it's available, meaning we would need to pin requirements for that environment because it's not just a single package but rather keyring + backends, and this creates sort of a chicken-egg problem. On top of that it's a bit of a deviation from the tool written in rust into the shaky untyped python ecosystem -- things just break randomly way more often there. Having this in uv would therefore avoid _a lot_ of dependencies and variability.
>    For example deriving a token from environment for GCP is relatively easily and such native credential helper could be much more robust, and avoid the chicken-egg thing. The only thing I'm not sure is the UX -- but I would be happy with just an arg like `--auth-helper=us-west1-python.pkg.dev=gcloud` or something like that
> 2. I haven't tried to integrate this anywhere yet but I hope the interface is flexible enough so that code that consumes uv as a dependency can plug its own auth helpers or easily reuse internal ones

Not really my place to answer, as I'm not a part of the astral team (I'm a first time contributor), but my two cents:

It seems like having to support different cloud platforms directly would be a lot of overhead to support.  I think it would make more sense to just have users figure out a way to supply their own credentials for the platform they use rather than build in GCP & Azure & AWS etc. support into `uv` itself.
I totally understand the disliking of using a python dependency to your project that needs to exist before using `uv pip install` - but adding this support helps projects migrate to `uv` more easily.  I work on a project where we are currently relying on GCP's keyring backend, and I wanted to make it easy for other people on my team to use `uv` without changing much in the rest of our environment.

---

_Review requested from @zanieb by @BakerNet on 2024-03-11 16:57_

---

_Comment by @vlad-ivanov-name on 2024-03-11 17:08_

While I disagree with regards to the amount of effort needed to support GCP auth in uv itself -- it would be quite simple -- I think your point still stands in general as other platforms might have much more complex auth routines.

What about making the interface for auth helpers open for users to plug into? Let's say now I wanted to not use python keyring but instead replace with a tool in rust that supports a few specific auth flows. I could of course try to override `keyring` executable on PATH but it's a bit hacky -- perhaps there can be a way to override the name of the binary that UV uses for keyring access? That would allow users to write their own auth helpers and maybe there would be a collection of them somewhere as independent projects.

Optionally there could even be a JSON interface: auth helper outputs something like `{ "auth_type": "basic", "username": "oauth2accesstoken", "password": "...", "expires_in": 12345 }`. But even just a simple string would do -- all that's missing now is being able to override keyring binary name with an environment variable or a command line arg. 

---

_Comment by @BakerNet on 2024-03-11 17:55_

> While I disagree with regards to the amount of effort needed to support GCP auth in uv itself -- it would be quite simple -- I think your point still stands in general as other platforms might have much more complex auth routines.
> 
> What about making the interface for auth helpers open for users to plug into? Let's say now I wanted to not use python keyring but instead replace with a tool in rust that supports a few specific auth flows. I could of course try to override `keyring` executable on PATH but it's a bit hacky -- perhaps there can be a way to override the name of the binary that UV uses for keyring access? That would allow users to write their own auth helpers and maybe there would be a collection of them somewhere as independent projects.
> 
> Optionally there could even be a JSON interface: auth helper outputs something like `{ "auth_type": "basic", "username": "oauth2accesstoken", "password": "...", "expires_in": 12345 }`. But even just a simple string would do -- all that's missing now is being able to override keyring binary name with an environment variable or a command line arg.

I could probably easily add something like `--keyring-provider custom=<your-script-name>` - assuming it takes the same arguments (url & username) and returns a string password on success

---

_Comment by @vlad-ivanov-name on 2024-03-11 20:48_

That would be really good! I'm even less involved than you -- just a user -- so let's hear from astral team perhaps -- @zanieb what do you think?

---

_Comment by @zanieb on 2024-03-12 19:30_

@vlad-ivanov-name it sounds nice to bypass `keyring` but I think we should discuss it in a new issue as long as this interface does not preclude us from doing it in the future.

---

_Comment by @thomasgilgenast on 2024-03-12 19:30_

Just wanted to say (as only a user) thank you for the contribution and to mention that I have test-driven 177bdee and

```
UV_EXTRA_INDEX_URL=https://<location>-python.pkg.dev/<project>/<gar_name>/simple uv pip install --keyring-provider subprocess <package>
```

works perfectly with `keyrings.google_artifactregistry_auth`. I recognize that there are a lot of possible solutions to #1520 , but this one solves my use case perfectly.

The only (extremely minor) quirk I encountered is that if I include the username in the index URL

```
UV_EXTRA_INDEX_URL=https://oauth2accesstoken@<location>-python.pkg.dev/<project>/<gar_name>/simple 
```

then the command above errors with

```
error: HTTP status client error (401 Unauthorized) for url (https://<location>-python.pkg.dev/<project>/<gar_name>/simple/<package>/)
```

But when using non-uv `pip`, I do need to provide the username in `PIP_EXTRA_INDEX_URL` or else I get prompted for a username and password

```
User for <location>-python.pkg.dev: 
```

But to be clear this is not a problem for me at all, just something that could be a useful piece of info for users trying to convert from pip to uv who stumble upon this PR. (If anything it was inconvenient to me that pip required the username - maybe it is actually a bug specific to `keyrings.google_artifactregistry_auth` when combined with `--keyring-provider subprocess`?)

And possibly totally unrelated to this PR, if there might be a `UV_KEYRING_PROVIDER` env var parallel to `PIP_KEYRING_PROVIDER`, in analogy to `UV_EXTRA_INDEX_URL`::`PIP_EXTRA_INDEX_URL` that would be very convenient for me. But it may be something for a separate PR or to discuss before implementing (cost of additional env vars versus ability to consistently control `uv` behavior with env vars). I have opened a minimal PR https://github.com/BakerNet/uv/pull/1 against your branch @BakerNet just for my own experimentation. Please feel free to close if you feel that I'm sneaking something in there that doesn't belong with this PR or deserves a separate discussion.

---

_Review comment by @zanieb on `crates/uv-auth/src/keyring.rs`:70 on 2024-03-12 19:34_

It looks like instead of returning `Result<Credential, Error>` this should return `Result<Option<Credential>, Error>` so we can return `None` in this case to distinguish from cases where something actually went wrong.

---

_Review comment by @zanieb on `crates/uv-auth/src/lib.rs`:163 on 2024-03-12 19:36_

Did you drop this inverse case on purpose?

---

_Review comment by @zanieb on `crates/uv-auth/src/lib.rs`:163 on 2024-03-12 19:36_

I guess they make less sense with the `NetLoc` implementation?

---

_Comment by @BakerNet on 2024-03-12 19:37_

> I have opened a minimal PR [BakerNet#1](https://github.com/BakerNet/uv/pull/1) against your branch @BakerNet just for my own experimentation. Please feel free to close if you feel that I'm sneaking something in there that doesn't belong with this PR or deserves a separate discussion.

Seems like a totally uncontroversial QoL improvement to me, so I merged it in.  Thanks for testing this out, @thomasgilgenast  btw!

---

_Review comment by @zanieb on `crates/uv-auth/src/store.rs`:13 on 2024-03-12 19:38_

I'd like @charliermarsh or @BurntSushi to review this part

---

_Review comment by @zanieb on `crates/uv-auth/src/store.rs`:13 on 2024-03-12 19:40_

Why do we store `None` credentials in here?

---

_Review comment by @zanieb on `crates/uv-auth/src/store.rs`:101 on 2024-03-12 19:40_

```suggestion
            // No credentials to save
```

---

_Review comment by @zanieb on `crates/uv-auth/src/keyring.rs`:22 on 2024-03-12 19:43_

Do you think that it's worth using something like https://docs.rs/keyring/latest/keyring/ instead of a subprocess? It looks like it overlaps a bit with the abstractions you introduce and it might make more sense if it can provide the same functionality.

---

_Review comment by @zanieb on `crates/uv/src/main.rs`:367 on 2024-03-12 19:47_

I'm a little hesitant on this interface. We might want to consider what our ideal interface for this then just include a dedicated interoperability flag for pip's interface.

I think in part this depends on our future plans around keyring support (which I know there was some discussion about already). In particular, if we use something like the Rust `keyring` crate do we need to provide any options other than a boolean toggle? Perhaps we do still want to allow the user to select a specific provider?

---

_Review comment by @zanieb on `crates/uv/src/main.rs`:349 on 2024-03-12 19:50_

I'd be curious to hear @charliermarsh's opinion regarding only searching for authentication on 401s.

It does seem brittle to me, we've seen all sorts of quirky behavior from package indexes when unauthorized.

---

_@zanieb reviewed on 2024-03-12 19:51_

This looks great! Thanks you!

I have some specific questions as well as a more general one regarding keyring lookups in Rust.

---

_@BakerNet reviewed on 2024-03-12 20:32_

---

_Review comment by @BakerNet on `crates/uv-auth/src/lib.rs`:163 on 2024-03-12 20:32_

Yeah, because it's now an equality comparison, order doesn't matter.  One of the `NetLoc` is the trusted url, one is the new url, but which side of the equality operation it's on is logically irrelevant.

---

_@BakerNet reviewed on 2024-03-12 20:33_

---

_Review comment by @BakerNet on `crates/uv-auth/src/store.rs`:13 on 2024-03-12 20:33_

> Why do we store `None` credentials in here?

Just so we don't re-check netrc or keyring when they already failed to find credentials for the url's net location

---

_@zanieb reviewed on 2024-03-12 20:35_

---

_Review comment by @zanieb on `crates/uv-auth/src/lib.rs`:163 on 2024-03-12 20:35_

Great thanks!

---

_@zanieb reviewed on 2024-03-12 20:35_

---

_Review comment by @zanieb on `crates/uv-auth/src/store.rs`:13 on 2024-03-12 20:35_

That makes sense, thanks!

---

_@BakerNet reviewed on 2024-03-12 20:48_

---

_Review comment by @BakerNet on `crates/uv-auth/src/keyring.rs`:22 on 2024-03-12 20:48_

> Do you think that it's worth using something like [docs.rs/keyring/latest/keyring](https://docs.rs/keyring/latest/keyring/) instead of a subprocess?

Instead?  No.  In addition?  Yes.

As mentioned in issue https://github.com/astral-sh/uv/issues/1520 - the cloud providers provide backend plugins for the python keyring tool.
Using something like https://docs.rs/keyring/latest/keyring/ would be fine for the `Import` case, but supporting a command-line `keyring` should still exist regardless (especially if you're trying to keep parity with pip) and if someone makes a CLI keyring with cloud provider support based on `keyring-rs` in the future, cool.  If it has the same CLI interface, it should just work.  If it has a different name, add to the `KeyringProvider`s or implement the custom version like discussed with @vlad-ivanov-name above.

---

_Review comment by @BakerNet on `crates/uv/src/main.rs`:367 on 2024-03-12 20:54_

I feel like a value enum is a pretty flexible interface - you can just add additional options to the enum and change logic based on the variant.  If there are additional items needed for an option, you can just add another argument that relies on a specific `KeyringProvider` value like `--keyring-provider custom --custom-keyring-command keyring-rs` as a possible example (I'm certain `clap` supports this)

---

_@BakerNet reviewed on 2024-03-12 20:54_

---

_@BakerNet reviewed on 2024-03-12 21:02_

---

_Review comment by @BakerNet on `crates/uv-auth/src/keyring.rs`:70 on 2024-03-12 21:02_

Fair point - that would be more accurate

---

_@zanieb reviewed on 2024-03-12 21:13_

---

_Review comment by @zanieb on `crates/uv-auth/src/keyring.rs`:22 on 2024-03-12 21:13_

üëç makes sense

---

_@zanieb reviewed on 2024-03-12 21:13_

---

_Review comment by @zanieb on `crates/uv/src/main.rs`:367 on 2024-03-12 21:13_

Okay, sold. Thanks.

---

_@BakerNet reviewed on 2024-03-12 21:15_

---

_Review comment by @BakerNet on `crates/uv-auth/src/keyring.rs`:70 on 2024-03-12 21:15_

Done

---

_@zanieb reviewed on 2024-03-12 21:16_

---

_Review comment by @zanieb on `crates/uv-auth/src/middleware.rs`:89 on 2024-03-12 21:16_

If you do the refactor to separate `None` from the `Error` case we should be able to log failures here.

---

_@BakerNet reviewed on 2024-03-12 21:19_

---

_Review comment by @BakerNet on `crates/uv-auth/src/middleware.rs`:89 on 2024-03-12 21:19_

What is the correct way to log errors in `uv` codebase, btw?  `warn!` or `warn_user!` maybe?

---

_@zanieb reviewed on 2024-03-12 21:24_

---

_Review comment by @zanieb on `crates/uv-auth/src/middleware.rs`:89 on 2024-03-12 21:24_

Hm that's tough.

Ideally we'd attach this as a hint to request failures so when we _error_ we'd be able to suggest why. In the meantime, I think a tracing message is the way to go unless it's very actionable for the user to fix the problem. I believe the difference is a tracing message will only show up with `-v` but `warn_user!` will always display.

---

_Review requested from @charliermarsh by @zanieb on 2024-03-12 21:24_

---

_Comment by @zanieb on 2024-03-12 21:30_

Thanks for addressing all the feedback so promptly.

I've added @charliermarsh as a reviewer ‚Äî once he's happy we'll be good to go.

---

_@BakerNet reviewed on 2024-03-12 21:37_

---

_Review comment by @BakerNet on `crates/uv-auth/src/middleware.rs`:89 on 2024-03-12 21:37_

Done

---

_Review comment by @thomasgilgenast on `crates/uv-auth/src/keyring.rs`:22 on 2024-03-12 22:02_

~I am only commenting as an observer, but commenters on https://github.com/astral-sh/uv/issues/1520 appeared to be in favor of at least reproducing pip's subprocess behavior first as the simplest way to automatically ensure compatibility with existing python-based keyring implementations for authenticating with python package indices (which may not have rust keyring counterparts at the current time).~

~But maybe I am misunderstanding how plugging in the rust keyring here would work, for example if uv would call out via a subprocess to python-based keyring implementations, then stash the result in rust keyring? Or if rust keyring has already implemented a standard way to call out to other keyrings via a subprocess and uv can somehow reuse that instead of re-implementing it? From a naive point of view, I don't see a simple/obvious way to avoid a subprocess entirely.~

~All that being said, I think that users who don't need any specific/"customized" keyring implementation and instead simply need a basic mechanism to store their password to avoid typing it out every time could be served with rust keyring (without a subprocess). But I think that the "customized" python keyring implementations like `keyrings.google_artifactregistry_auth` are "common enough" (subjective) that it could be worth considering how those could also be supported. (The subprocess-based path taken by the current state of this PR does support both "simple" and "customized" keyring use cases.)~

Edit: sorry, totally redundant with the discussion above.

---

_@thomasgilgenast reviewed on 2024-03-12 22:02_

---

_Review comment by @charliermarsh on `crates/uv/src/main.rs`:1247 on 2024-03-13 03:34_

We should add this to the list of supported environment variables in the README.

---

_Review comment by @charliermarsh on `crates/uv-auth/src/middleware.rs`:57 on 2024-03-13 03:41_

For my own clarification... this will propagate the credentials based purely on `host` etc., right? In other words, the URLs do not need to be identical, is that correct? Just the same "realm" and so on?

Is this generally a safe and accepted thing to do? (That is: propagate the credentials here.) It's a little different than what we do on `main` which is more limited: when we make a request, we propagate credentials to the URLs that are found on the page returned by the request (like `with_url_encoded_auth`, I think).

---

_Review comment by @charliermarsh on `crates/uv-auth/src/store.rs`:56 on 2024-03-13 03:43_

When can these fail? (These will be effectively silent for the user.)

---

_Review comment by @charliermarsh on `crates/uv-auth/src/middleware.rs`:67 on 2024-03-13 03:44_

Can you expand on the comment here? Should this be `unreachable!`?

---

_Review comment by @charliermarsh on `crates/uv-auth/src/middleware.rs`:162 on 2024-03-13 03:46_

Should these unwraps just be `?` given that we already return `Result` here?

---

_Review comment by @charliermarsh on `crates/uv-auth/src/store.rs`:32 on 2024-03-13 03:46_

I think it's a bit inflexible for these to clone. Callers can always clone if they need owned data, but callers that _don't_ need owned data are now _forced_ to clone. I think these should return references.

---

_Review comment by @charliermarsh on `crates/uv-auth/src/store.rs`:43 on 2024-03-13 03:47_

This is kind of a hidden allocation, because we're taking a reference and then cloning inside the `From`. I think it would be clearer as `From<Authenticator>`, personally.

---

_Review comment by @charliermarsh on `crates/uv-auth/src/store.rs`:71 on 2024-03-13 03:52_

I'm not a huge fan of the singleton struct here but I don't need to block the PR on it. It's just not something we've really done anywhere else that I can remember. Maybe @BurntSushi would have a better opinion on it.

---

_Review comment by @charliermarsh on `crates/uv-auth/src/middleware.rs`:92 on 2024-03-13 03:53_

Nit: can you inline these please? `debug!("No keyring credentials found for: {url}");`

---

_Review comment by @charliermarsh on `crates/uv/src/main.rs`:349 on 2024-03-13 03:55_

I haven't thought about it deeply but I have a negative reaction to only sending credentials after seeing a 401.

---

_Review comment by @charliermarsh on `crates/distribution-types/src/file.rs`:58 on 2024-03-13 03:57_

So the assumption here is that we've already hit the base URL on a previous invocation of the middleware, and so its credentials are already stored in the `AuthenticationStore`, and will be propagated here if needed?

---

_@charliermarsh reviewed on 2024-03-13 03:57_

Thanks for this! I think I need to better understand some of the credential flows before merging.

---

_@zanieb reviewed on 2024-03-13 04:01_

---

_Review comment by @zanieb on `crates/uv-auth/src/middleware.rs`:57 on 2024-03-13 04:01_

Yeah we're using the "net loc" which is the same "realm". This is compliant with the relevant web standard RFC and AFAIK exactly what pip does. It seems totally fine to me but I appreciate the extra scrutiny.

---

_@zanieb reviewed on 2024-03-13 04:02_

---

_Review comment by @zanieb on `crates/uv-auth/src/store.rs`:71 on 2024-03-13 04:02_

I imagined the passwords would live on it but I think that's infeasible for some reason?

---

_@charliermarsh reviewed on 2024-03-13 04:03_

---

_Review comment by @charliermarsh on `crates/uv-auth/src/middleware.rs`:57 on 2024-03-13 04:03_

Do you know why we _also_ need to call `with_url_encoded_auth` before the middleware then?

---

_@zanieb reviewed on 2024-03-13 04:06_

---

_Review comment by @zanieb on `crates/uv/src/main.rs`:1247 on 2024-03-13 04:06_

We'll also want to document support and precedence in a registry authentication section following https://github.com/astral-sh/uv?tab=readme-ov-file#git-authentication but I can do that in a follow-up (just posting so I don't forget).

---

_@BakerNet reviewed on 2024-03-13 04:18_

---

_Review comment by @BakerNet on `crates/uv-auth/src/middleware.rs`:57 on 2024-03-13 04:18_

I didn't follow the full flow after the `url` is copied - I saw it was being used in `File` structs and didn't want to potentially introduce regression by assuming theses `urls` having the auth copied to were going to be used in the same run of `uv`

My other comment on the URLEncodedAuth being insecure, but relying on this copying from trusted urls instead was also a factor in my keeping the copy functionality.

---

_@BakerNet reviewed on 2024-03-13 04:25_

---

_Review comment by @BakerNet on `crates/uv-auth/src/middleware.rs`:67 on 2024-03-13 04:25_

The idea here is, if the url does not come to the middleware with URL-encoded auth, we shouldn't introduce URL-encoded auth because it's an inherently unsafe way to send auth data.  On main, there was already code copying the auth from trusted urls onto response/body urls so this line shouldn't be hit under normal circumstances anyways.

---

_@BakerNet reviewed on 2024-03-13 04:30_

---

_Review comment by @BakerNet on `crates/uv-auth/src/store.rs`:56 on 2024-03-13 04:30_

I didn't look into this - it's just copied over from main (migrated from `lib.rs` function)

---

_@charliermarsh reviewed on 2024-03-13 04:31_

---

_Review comment by @charliermarsh on `crates/uv-auth/src/store.rs`:56 on 2024-03-13 04:31_

Okay thanks, that's a perfectly fine answer :)

---

_@BakerNet reviewed on 2024-03-13 04:42_

---

_Review comment by @BakerNet on `crates/uv-auth/src/store.rs`:71 on 2024-03-13 04:42_

My initial plan was for a store instance to be a field of the `AuthMiddleware` struct and the store to hold an instance of the password table - but you do not have access to mutable self in the `Middleware` trait, so that was the limitation I ran into.  Combine that with keeping the copying from trusted URL that wouldn't have access to the same instance - I went with this approach.

---

_@BakerNet reviewed on 2024-03-13 04:55_

---

_Review comment by @BakerNet on `crates/distribution-types/src/file.rs`:58 on 2024-03-13 04:55_

Yes, that was my assumption.  That if `base` has auth, it received it from a copy from a previous request (in `FlatIndexClient.read_from_url` or `RegistryClient.simple_single_index`).

---

_@BakerNet reviewed on 2024-03-13 05:18_

---

_Review comment by @BakerNet on `crates/uv-auth/src/middleware.rs`:92 on 2024-03-13 05:18_

Done

---

_@BakerNet reviewed on 2024-03-13 05:19_

---

_Review comment by @BakerNet on `crates/uv-auth/src/store.rs`:43 on 2024-03-13 05:19_

Done

---

_@BakerNet reviewed on 2024-03-13 05:19_

---

_Review comment by @BakerNet on `crates/uv-auth/src/store.rs`:32 on 2024-03-13 05:19_

Done

---

_@BakerNet reviewed on 2024-03-13 05:20_

---

_Review comment by @BakerNet on `crates/uv-auth/src/middleware.rs`:162 on 2024-03-13 05:20_

Done

---

_@zanieb reviewed on 2024-03-13 17:30_

---

_Review comment by @zanieb on `crates/uv-auth/src/store.rs`:71 on 2024-03-13 17:30_

Can you just use interior mutability to get around this? e.g. `RefCell<T>`?

---

_@charliermarsh reviewed on 2024-03-13 17:43_

---

_Review comment by @charliermarsh on `crates/uv-auth/src/store.rs`:71 on 2024-03-13 17:43_

I believe you could just do it with the Mutex within the struct. But we can change this later if desired.

---

_@charliermarsh approved on 2024-03-13 17:45_

I'm cool with this, thanks for the nice PR! I defer to @zanieb to merge.

---

_Renamed from "Basic implementation of Keyring auth support" to "Add support for retrieving credentials from `keyring`" by @zanieb on 2024-03-13 17:50_

---

_Merged by @zanieb on 2024-03-13 20:02_

---

_Closed by @zanieb on 2024-03-13 20:02_

---
