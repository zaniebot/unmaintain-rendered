<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add support for `package`-level conflicts in workspaces - astral-sh/uv #14906</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add support for `package`-level conflicts in workspaces</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/14906">#14906</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2025-07-25 20:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-25 20:03</div>
            <div class="timeline-body"><p>Revives https://github.com/astral-sh/uv/pull/9130</p>
<p>Previously, we allowed scoping conflicting extras or groups to specific packages, e.g. ,<code>{ package = &quot;foo&quot;, extra = &quot;bar&quot; }</code> for a conflict in <code>foo[bar]</code>. Now, we allow dropping the <code>extra</code> or <code>group</code> bit and using <code>{ package = &quot;foo&quot; }</code> directly which declares a conflict with <code>foo</code>'s production dependencies.</p>
<p>This means you can declare conflicts between workspace members, e.g.:</p>
<pre><code>[tool.uv]
conflicts = [[{ package = &quot;foo&quot; }, { package = &quot;bar&quot; }]]
</code></pre>
<p>would not allow <code>foo</code> and <code>bar</code> to be installed at the same time.</p>
<p>Similarly, a conflict can be declared between a package and a group:</p>
<pre><code>[tool.uv]
conflicts = [[{ package = &quot;foo&quot; }, { group = &quot;lint&quot; }]]
</code></pre>
<p>which would mean, e.g., that <code>--only-group lint</code> would be required for the invocation.</p>
<p>As with our existing support for conflicting extras, there are edge-cases here where the resolver will <em>not</em> fail even if there are conflicts that render a particular install target unusable. There's test coverage for some of these. We'll still error at install-time when the conflicting groups are selected. Due to the likelihood of bugs in this feature, I've marked it as a preview feature.</p>
<p>I would not recommend reading the commits as there's some slop from not wanting to rebase Andrew's branch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @zanieb on 2025-07-29 17:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @zanieb on 2025-07-29 17:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-resolver/src/pubgrub/dependencies.rs</code>:35 on 2025-07-29 18:10</div>
            <div class="timeline-body"><p>IIRC, this is the thing I was most uncertain about @charliermarsh</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv/tests/it/lock.rs</code>:3063 on 2025-07-29 18:15</div>
            <div class="timeline-body"><p>@zanieb These locks LGTM I think. What did you do to make this case work?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv/tests/it/lock.rs</code>:3165 on 2025-07-29 18:17</div>
            <div class="timeline-body"><p>Oh interesting. Could this be added outside of the resolver automatically? Hmm, no, I don't think so. It could only be done in the &quot;direct&quot; case I think? Is there a test for the indirect/transitive case? I looked below but I don't think I see this work-around used anywhere else.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2025-07-29 18:20</div>
            <div class="timeline-body"><p>Nice, I think this LGTM. I think it would still be good to get @charliermarsh's review on the parent package stuff I added (I left a comment noting where).</p>
<p>I was curious what else you did here to make the remaining cases work?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-29 18:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/it/lock.rs</code>:3165 on 2025-07-29 18:28</div>
            <div class="timeline-body"><p>I looked into that a bit but decided to cut scope. It seems quite plausible to update the resolver to handle this case when forking.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-29 18:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/it/lock.rs</code>:3063 on 2025-07-29 18:31</div>
            <div class="timeline-body"><p>To get <code>detect_conflicts</code> to pass, I needed to add</p>
<p>https://github.com/astral-sh/uv/blob/1dc78400bc4c08f32c8110c29cb515dc656d2108/crates/uv/src/commands/project/mod.rs#L2513-L2516</p>
<p>which required, more broadly, understanding the subset of package we were reasoning about during conflict detection.</p>
<p>Then there were some minor problems in the forking logic. The main thing was</p>
<p>https://github.com/astral-sh/uv/blob/1dc78400bc4c08f32c8110c29cb515dc656d2108/crates/uv-resolver/src/resolver/mod.rs#L3792-L3798</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-29 18:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/it/lock.rs</code>:3165 on 2025-07-29 18:35</div>
            <div class="timeline-body"><p>There is <code>lock_conflicting_workspace_members_depends_transitive_extra</code> but in that case there's a conflict that should not be resolved. I didn't add a transitive case like this one â€” I felt like I was going to end up playing whackamole with a bunch of complicated test cases. I think if it wasn't in preview, I wouldn't be comfortable without doing a lot more testing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-configuration/src/preview.rs</code>:17 on 2025-08-01 02:02</div>
            <div class="timeline-body"><p>What's the thinking behind releasing this under a flag?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/pubgrub/dependencies.rs</code>:30 on 2025-08-01 02:03</div>
            <div class="timeline-body"><p>&quot;with deal with project level conflicts&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/resolver/mod.rs</code>:3800 on 2025-08-01 02:05</div>
            <div class="timeline-body"><p>Nit: use a <code>matches!</code> since there's only one active branch here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/install_target.rs</code>:381 on 2025-08-01 02:06</div>
            <div class="timeline-body"><p>I didn't look at the usage thoroughly, but this could probably be <code>BTreeSet&lt;&amp;PackageName&gt;</code>, with the same lifetime as <code>&amp;self</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/pubgrub/dependencies.rs</code>:35 on 2025-08-01 02:15</div>
            <div class="timeline-body"><p>I'm also not 100% sure on the implications here...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/pubgrub/dependencies.rs</code>:177 on 2025-08-01 02:16</div>
            <div class="timeline-body"><p>How would this branch ever get hit? Doesn't <code>self.package.conflicting_item()</code> return <code>Some</code> in all branches now (and <code>unreachable!</code>) in the last branch?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-08-01 02:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-02 12:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-resolver/src/resolver/mod.rs</code>:3800 on 2025-08-02 12:23</div>
            <div class="timeline-body"><p>I wanted it to be exhaustive so it needs to be revisited if we add another kind, but I don't feel strongly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-02 12:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-configuration/src/preview.rs</code>:17 on 2025-08-02 12:24</div>
            <div class="timeline-body"><p>It's in the summary</p>
<blockquote>
<p>As with our existing support for conflicting extras, there are edge-cases here where the resolver will not fail even if there are conflicts that render a particular install target unusable. There's test coverage for some of these. We'll still error at install-time when the conflicting groups are selected. Due to the likelihood of bugs in this feature, I've marked it as a preview feature.</p>
</blockquote>
<p>I'm just not sure we'll be able to meet our bar for correctness here in the first iteration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-02 12:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-resolver/src/pubgrub/dependencies.rs</code>:177 on 2025-08-02 12:52</div>
            <div class="timeline-body"><p>It <em>can</em> return <code>None</code></p>
<p>https://github.com/astral-sh/uv/blob/8afbd86f03b21cd8a77663da166b66aa0be62acf/crates/uv-resolver/src/pubgrub/package.rs#L222</p>
<p>I'm not sure if it's needed. I'll poke around.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-04 15:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-resolver/src/pubgrub/dependencies.rs</code>:177 on 2025-08-04 15:54</div>
            <div class="timeline-body"><p>I decided to remove it, since it has no effect and I don't see a reason for it. It does seem reachable though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2025-08-04 17:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @zanieb on 2025-08-07 13:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Add support for `package`-level conflicts" to "Add support for `package`-level conflicts in workspaces" by @zanieb on 2025-08-07 13:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2025-08-08 12:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-08-08 12:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-08 12:45</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 06:47:16 UTC
    </footer>
</body>
</html>
