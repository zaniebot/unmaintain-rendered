<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add option to prefer locked versions of packages in build environments - astral-sh/uv #14944</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add option to prefer locked versions of packages in build environments</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/14944">#14944</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2025-07-28 19:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>Adds a new <code>build-dependency-strategy = latest | prefer-locked</code> setting. <code>latest</code> is the current behavior. <code>prefer-locked</code> will prefer to use locked versions of runtime dependencies for build dependencies when they match. This is intended to work with #14735 to allow adding <code>torch</code> as an extra build dependency for <code>flash-attn</code> and prefer using the same version as you would at runtime (that's what <code>flash-attn</code> requires, but it's usually achieved by disabling build isolation).</p>
<p>The name is <code>prefer-locked</code> because I want to add a future option... like <code>require-locked</code> which will <em>error</em> if the versions matching the runtime versions cannot be used. The naming here is actually a little awkward, because it'll be confusing when we introduce locking of build dependencies <em>separately</em> from runtime requirements (which is on the roadmap). We might want to do... <code>latest | try-match-runtime | match-runtime</code>? I'm not sure. I also expect that we'll want a package-level variant of this setting, as <code>match-runtime</code> might be too aggressive for most packages. I also find this setting a little awkward alongside #14735, I wonder if we want a dedicated build dependencies section?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Prefer locked versions of packages in build environments" to "Add option to prefer locked versions of packages in build environments" by @zanieb on 2025-07-28 21:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @zanieb on 2025-07-28 21:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @zanieb on 2025-07-28 21:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @zanieb on 2025-07-29 02:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @zanieb on 2025-07-29 02:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/sync.rs</code>:11557 on 2025-07-29 09:38</div>
            <div class="timeline-body"><p>Can you add a case where the build requires conflict with the lockfile version, so we ignore the preference?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-settings/src/settings.rs</code>:521 on 2025-07-29 09:46</div>
            <div class="timeline-body"><p>We can make this stronger by saying that the locked version will be used, if a single locked version exists in the lockfile, and if it doesn't cause any conflicts during resolution. (Though the latter isn't about the version being unfulfillable, but about whether it conflicts with higher priority packages in the resolution, which I hope is a detail users won't run into with build deps, and for which <code>require-locked</code> will help)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2025-07-29 09:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-07-29 09:46</div>
            <div class="timeline-body"><p>I like the <code>prefer-locked</code> name, it captures what it does concisely.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-29 16:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/it/sync.rs</code>:11557 on 2025-07-29 16:26</div>
            <div class="timeline-body"><p>Yes great idea</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zanieb on 2025-07-29 18:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-29 18:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-settings/src/settings.rs</code>:521 on 2025-07-29 18:13</div>
            <div class="timeline-body"><p>I tried to capture this a little in https://github.com/astral-sh/uv/pull/14944/commits/9a91e91f78590e7d58bf4cf3da7b54c4734dc191</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-29 18:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/it/sync.rs</code>:11557 on 2025-07-29 18:13</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/uv/pull/14944/commits/adfbe02e85bef5091a8d6772a9c8064d0d7846a3</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-29 21:33</div>
            <div class="timeline-body"><p>@geofft has pointed out an important concern, that since these preferences are not taken into account in the wheel cache key, you won't automatically get a rebuild of a package when your locked version of a build dependency changes; or, worse, if you have another project with a different locked version, they'll share the same cached wheel :/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @zanieb on 2025-07-29 23:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-29 23:27</div>
            <div class="timeline-body"><p>This is still &quot;preferring&quot; the locked version, but it sounds problematic. I'm not sure what the workaround is yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-07-30 08:49</div>
            <div class="timeline-body"><blockquote>
<p>@geofft has pointed out an important concern, that since these preferences are not taken into account in the wheel cache key, you won't automatically get a rebuild of a package when your locked version of a build dependency changes; or, worse, if you have another project with a different locked version, they'll share the same cached wheel :/</p>
</blockquote>
<p>This is the same logic we apply today without preferences: We build wheels once, and then cache them forever, even if the resolution of the package's build deps changes. For supporting caching with different version ranges, we need to support multiple builds with the same tag for a package in the cache, attach the build deps versions to it and select only fitting ones installation. A criteria could be whether the versions fit <code>tool.uv.extra-build-dependencies</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-02 15:38</div>
            <div class="timeline-body"><blockquote>
<p>This is the same logic we apply today without preferences: We build wheels once, and then cache them forever, even if the resolution of the package's build deps changes. For supporting caching with different version ranges, we need to support multiple builds with the same tag for a package in the cache, attach the build deps versions to it and select only fitting ones installation.</p>
</blockquote>
<p>Yeah, I guess it doesn't seem that much worse than what we have today. Is it worth? We could look at caching separate builds based on build dependencies as a second step, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-07 13:50</div>
            <div class="timeline-body"><p>Preferring https://github.com/astral-sh/uv/pull/15036</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-08-07 13:50</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:44:11 UTC
    </footer>
</body>
</html>
