<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allow `uv` crate to be used as a library - astral-sh/uv #4642</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Allow <code>uv</code> crate to be used as a library</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/4642">#4642</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-06-29 03:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>This is pulled out of #4632 â€” a user noted that it would be useful to use the <code>uv</code> crate from Rust. This makes it way easier to invoke <code>uv</code> from Rust with arbitrary arguments as well as use various functionality in the <code>uv</code> crate.</p>
<p>Note this is no longer needed for #4632 and is not particularly urgent.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rustlib</span> added by @zanieb on 2024-06-29 03:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-29 04:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/lib.rs</code>:987 on 2024-06-29 04:31</div>
            <div class="timeline-body"><p>This moved without change from <code>run</code> above because it's not safe to send <code>std::env</code> values across threads depending on the platform.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zanieb on 2024-06-29 04:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @zanieb on 2024-07-02 02:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @zanieb on 2024-07-02 02:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-07-08 16:56</div>
            <div class="timeline-body"><p>I am a little unsure of this personally. Maybe it's fine, but I think it would warrant a docstring somewhere saying that this is not officially supported and to Use At Your Own Risk.</p>
<p>My main specific worry is that this will enable calling the entire <code>uv</code> application more than once in the same process. I can't think of anything off the top of my head that will definitely break as a result of this, but if we're leaving state around that gets reused, it could be an issue.</p>
<p>My more vague worry is that we didn't really design <code>uv</code> to be invoked as a library. So there may be other things that can go wrong here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sgammon">@sgammon</a> on 2024-07-08 17:18</div>
            <div class="timeline-body"><p>Hey <code>uv</code> team,</p>
<p>We wanted to share our use case for <code>uv</code> as a library; we are building a polyglot runtime, <a href="https://github.com/elide-dev/elide">Elide</a>, which runs Python as part of its supported language engines.</p>
<p>We want to embed a toolchain to obtain dependencies and manage <code>.venv</code>. <code>uv</code> is perfect for this and architected quite well, so it pops out at us as a good option.</p>
<p>Our dispatch style is a bit weird: we are calling <code>uv</code> over a JNI border from the JVM. Other than this, our effective usage of <code>uv</code> should end up being pretty close to what the binary experiences standalone: (1) we intend to only run one <code>uv</code> execution per process, with <code>uv</code> taking over when the user invokes it; (2) we are calling <code>uv</code> over the JNI border with an array of string args, alleviating any need for type sharing or serialization.</p>
<p>We are happy to continue using <code>uv</code> this way even if there is no official API surface yet. It would be cool eventually to surface structured args, but we're happy with strings as long as we must use them.</p>
<p>It is possible, of course, to ship <code>uv</code> as a standalone binary, and invoke it regularly as a subprocess. I considered this route but there are drawbacks:</p>
<ul>
<li>We are in Rust too, and could leverage all the optimization and protection of dispatching over Rust</li>
<li>We end up embedding many of the same crate dependencies anyway, so this would actually increase duplication</li>
</ul>
<p>All in all if you guys strongly feel like <code>uv</code> should be dispatched over a process border instead, we are happy to consider it.</p>
<p>Of course thank you for all your hard work on <code>uv</code> and everything else Astral ðŸ˜„</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-07-08 21:26</div>
            <div class="timeline-body"><p>I like this because it's helpful for some testing improvements i want to try. There are some differences between using uv through the main function from rust and calling it as a subprocess (we have some global and thread local state), so i'd keep our officially supported and stable interface to calling binary with cli arguments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-07-08 21:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-10 15:48</div>
            <div class="timeline-body"><p>I added a warning</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @zanieb on 2024-07-10 15:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2024-07-10 16:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2024-07-10 17:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-07-10 17:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-10 17:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dsully">@dsully</a> on 2024-07-11 03:34</div>
            <div class="timeline-body"><p>I have a use for this as well. Are you planning on publishing <code>uv</code> to crates.io for consumption?</p>
<p>There is an existing 'uv' &quot;universal getter&quot; that has the name currently, but looks abandoned.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-11 03:56</div>
            <div class="timeline-body"><p>We aren't prioritizing it â€” we're far from a stable Rust API and we move very quickly which sometimes requires a <code>git</code> patch for a dependency. We are interested in doing so eventually though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-11 03:56</div>
            <div class="timeline-body"><p>What's your use case? :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dsully">@dsully</a> on 2024-07-11 03:59</div>
            <div class="timeline-body"><p>We have an internal tool that sets up Python environments for developers: The venv, tox, dependencies, etc.</p>
<p>I also have need for calling <code>uv tool install ...</code> for certain tools that are venv-independent.</p>
<p>Unfortunately I can't use <code>git+https://...</code> for dependencies.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:37:49 UTC
    </footer>
</body>
</html>
