<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support conflict markers in `uv export` - astral-sh/uv #11643</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Support conflict markers in <code>uv export</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/11643">#11643</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2025-02-19 22:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Today, if you have a lockfile that includes conflict markers, we write those markers out to <code>requirements.txt</code> in <code>uv export</code>. This is problematic, since no tool will ever evaluate those markers correctly downstream.</p>
<p>This PR adds handling for the conflict markers, though it's quite involved. Specifically, we have a new reachability algorithm that tracks, for each node, the reachable marker for that node <em>and</em> the marker conditions under which each conflict item is <code>true</code> (at that node).</p>
<p>I'm slightly worried that this algorithm could be wrong for graphs with cycles, but we only use this logic for lockfiles with conflicts anyway, so I think it's a strict improvement over the status quo.</p>
<p>Closes https://github.com/astral-sh/uv/issues/11559.</p>
<p>Closes https://github.com/astral-sh/uv/issues/11548.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2025-02-19 22:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @charliermarsh on 2025-02-19 22:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-resolver/src/lock/requirements_txt.rs</code>:55 on 2025-02-20 15:19</div>
            <div class="timeline-body"><p>It looks like <code>MarkerTree::TRUE</code> is the only thing that's ever stored as a value in this particular map? Or am I wrong about that? If so, I think you could use a <code>FxHashSet</code> here instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2025-02-20 15:26</div>
            <div class="timeline-body"><p>This LGTM. The comments in the code (especially the examples) were actually incredibly helpful for being able to follow what was going on.</p>
<p>One question I had here that I'm a little fuzzy on is: why is it okay to completely remove conflict markers from the output of <code>uv export</code>, but we can't do the same for <code>uv.lock</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-20 20:19</div>
            <div class="timeline-body"><blockquote>
<p>One question I had here that I'm a little fuzzy on is: why is it okay to completely remove conflict markers from the output of uv export, but we can't do the same for uv.lock?</p>
</blockquote>
<p>I think the difference is: for <code>uv export</code>, we know the set of user-enabled extras and groups (whereas we don't for the lockfile). Like, <code>uv export</code> is invoked via <code>uv export --extra cpu</code>. The output isn't intended to work for arbitrary extras and groups; the set of enabled extras and groups is encoded at the time the user runs the command, unlike with the lockfile.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-02-20 20:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/lock/requirements_txt.rs</code>:55 on 2025-02-20 20:19</div>
            <div class="timeline-body"><p>We end up cloning it when doing the <code>conflict_marker_reachability</code> thing, and then the markers can later vary, so this felt a bit easier.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2025-02-20 20:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-02-20 20:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-20 20:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-02-21 12:10</div>
            <div class="timeline-body"><blockquote>
<p>The output isn't intended to work for arbitrary extras and groups</p>
</blockquote>
<p>Ah! That's what I was missing. Thanks for explaining!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:42:06 UTC
    </footer>
</body>
</html>
