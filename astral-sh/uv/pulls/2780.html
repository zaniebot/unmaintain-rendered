<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resolve non-determistic behavior in preferences due to site-packages ordering - astral-sh/uv #2780</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Resolve non-determistic behavior in preferences due to site-packages ordering</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/2780">#2780</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-04-02 16:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>Originally a regression test for #2779 but we found out that there&#x27;s some weird behavior where different <code>anyio</code> versions were preferred based on the platform.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-02 16:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/pip_install.rs</code>:3566 on 2024-04-02 16:50</div>
            <div class="timeline-body"><p>If I do not request 4.0.0, 3.7.0 is reinstalled without panic on my machine ðŸ¤¯</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-02 16:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-02 16:57</div>
            <div class="timeline-body"><p>Cherry-picked over to <a href="https://github.com/astral-sh/uv/pull/2779">astral-sh/uv#2779</a> â€” we can discuss the weirdness of this test here if necessary but I&#x27;ll merge the clear fix anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Add regression test for #2779&quot; to &quot;Resolve non-determistic behavior in preferences due to site-packages ordering&quot; by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-02 18:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-02 18:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-installer/src/site_packages.rs</code>:53 on 2024-04-02 18:05</div>
            <div class="timeline-body"><p>I can&#x27;t figure out how to write this as a single iterator operation because it&#x27;s weird working with nested results.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-02 18:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-installer/src/site_packages.rs</code>:69 on 2024-04-02 18:06</div>
            <div class="timeline-body"><p>This is the call we&#x27;d move into the iterator chain above</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/pip_install.rs</code>:3571 on 2024-04-02 18:06</div>
            <div class="timeline-body"><p>Before sorting the site-packages, this preferred <code>anyio==3.7.0</code> on macOS and <code>anyio==4.0.0</code> on Ubuntu</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-02 18:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-02 18:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> removed by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-02 18:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-02 18:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-04-02 18:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-02 18:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-installer/src/site_packages.rs</code>:53 on 2024-04-02 18:10</div>
            <div class="timeline-body"><p>Do you mean, not collecting the <code>entries</code> here at all?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-02 18:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-02 18:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-installer/src/site_packages.rs</code>:53 on 2024-04-02 18:17</div>
            <div class="timeline-body"><p>We must collect them to sort them afaik. I just couldn&#x27;t filter to directories here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-02 18:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-installer/src/site_packages.rs</code>:53 on 2024-04-02 18:35</div>
            <div class="timeline-body"><p>Yeah. You would need to filter prior to the <code>collect</code> above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-02 18:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-installer/src/site_packages.rs</code>:53 on 2024-04-02 18:48</div>
            <div class="timeline-body"><p>Yeah I tried that haha it&#x27;s awkward because of the nested <code>Result</code> types, it&#x27;s beyond my understanding of iterators in Rust.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-02 18:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-02 18:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-02 18:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-02 18:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-installer/src/site_packages.rs</code>:53 on 2024-04-02 18:48</div>
            <div class="timeline-body"><p>cc @snowsignal maybe you have a suggestion</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-04-02 19:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/uv-installer/src/site_packages.rs</code>:53 on 2024-04-02 19:34</div>
            <div class="timeline-body"><p>@zanieb Here&#x27;s one way you could do it:</p>
<pre><code>let mut entries: Vec&lt;_&gt; = site_packages
                        .filter(|read_dir| match read_dir {
                            Ok(entry) =&gt; entry
                                .file_type()
                                .map(|file_type| file_type.is_dir())
                                .unwrap_or_default(),
                            Err(_) =&gt; true,
                        })
                        .collect::&lt;std::io::Result&lt;_&gt;&gt;()?;
</code></pre>
<p>Also, if you tweak the code to collect into a <code>BTreeSet&lt;PathBuf&gt;</code>, the sorting will happen as part of <code>collect()</code> and you don&#x27;t have to call <code>sort_by_key</code> afterwards.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-04-02 19:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/uv-installer/src/site_packages.rs</code>:53 on 2024-04-02 19:44</div>
            <div class="timeline-body"><p>Here&#x27;s how you could do that:</p>
<pre><code>                    let paths: BTreeSet&lt;_&gt; = site_packages
                        .filter_map(|read_dir| match read_dir {
                            Ok(entry) =&gt; {
                                entry.file_type().ok()?.is_dir().then_some(Ok(entry.path()))
                            }
                            Err(err) =&gt; Some(Err(err)),
                        })
                        .collect::&lt;Result&lt;_&gt;&gt;()?;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-02 20:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-installer/src/site_packages.rs</code>:53 on 2024-04-02 20:14</div>
            <div class="timeline-body"><p>Cool thank you!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:44:35 UTC
    </footer>
</body>
</html>
