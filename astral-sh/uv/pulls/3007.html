<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add `uv-workspace` crate with settings discovery and deserialization - astral-sh/uv #3007</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add <code>uv-workspace</code> crate with settings discovery and deserialization</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/3007">#3007</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-04-12 04:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds basic struct definitions along with a &quot;workspace&quot; concept for discovering settings. (The &quot;workspace&quot; terminology is used to match Ruff; I did not invent it.)</p>
<p>A few notes:</p>
<ul>
<li>We discover any <code>pyproject.toml</code> or <code>uv.toml</code> file in any parent directory of the current working directory. (We could adjust this to look at the directories of the input files.)</li>
<li>We don't actually do anything with the configuration yet; but those PRs are large and I want this to be reviewed in isolation.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @charliermarsh on 2024-04-15 21:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2024-04-15 21:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by @charliermarsh on 2024-04-15 21:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2024-04-15 21:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-15 21:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-workspace/src/settings.rs</code>:35 on 2024-04-15 21:07</div>
            <div class="timeline-body"><p>These should arguably be under <code>pip</code>. I'm not totally sure though to be honest.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-16 02:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/main.rs</code>:108 on 2024-04-16 02:35</div>
            <div class="timeline-body"><p>If we don't have read permissions for the current directory should we error or just not attempt to read a workspace there?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-16 02:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-workspace/src/workspace.rs</code>:26 on 2024-04-16 02:39</div>
            <div class="timeline-body"><p>Does this mean that we'll fail on <em>any</em> uv invocation if there's an unparsable <code>pyproject.toml</code> file in an ancestor directory?</p>
<p>This behavior kind of drives me crazy in Ruff.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-16 02:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-workspace/src/workspace.rs</code>:26 on 2024-04-16 02:39</div>
            <div class="timeline-body"><p>I'd rather log a warning and return <code>None</code>. I think failing on an unparsable <code>uv.toml</code> makes more sense to me though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-16 02:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-workspace/src/settings.rs</code>:69 on 2024-04-16 02:40</div>
            <div class="timeline-body"><p>Aren't a bunch of these very pip-compile output specific? I find it weird to consider these resolver options.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-16 02:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-workspace/src/settings.rs</code>:35 on 2024-04-16 02:41</div>
            <div class="timeline-body"><p>Do we currently have the same <code>ResolverOptions</code> and <code>InstallerOptions</code> at the top-level <em>and</em> in <code>pip</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-16 02:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-workspace/src/settings.rs</code>:83 on 2024-04-16 02:41</div>
            <div class="timeline-body"><p>I wonder if we should choose a clearer name for this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-16 02:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-workspace/src/settings.rs</code>:69 on 2024-04-16 02:51</div>
            <div class="timeline-body"><p>Yes, absolutely. Hence: https://github.com/astral-sh/uv/pull/3007#discussion_r1566441095</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-16 02:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-workspace/src/workspace.rs</code>:26 on 2024-04-16 02:51</div>
            <div class="timeline-body"><p>Yes it does.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-16 02:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-workspace/src/settings.rs</code>:35 on 2024-04-16 02:52</div>
            <div class="timeline-body"><p>No, they're <em>only</em> present at the top-level. Arguably, everything should be put under <code>pip</code>. The downside is that it creates a lot of nesting, and we may have options here that <em>are</em> applicable to the non-<code>pip</code> interface.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-16 02:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-workspace/src/settings.rs</code>:35 on 2024-04-16 02:56</div>
            <div class="timeline-body"><p>Hm but I see</p>
<pre><code>pub struct PipOptions {
    ...
    pub resolver: Option&lt;ResolverOptions&gt;,
    pub installer: Option&lt;InstallerOptions&gt;,
</code></pre>
<p>Anyway... I'd rather put them in <code>pip</code> and pull them into the top-level as we know we need them? I think there are only a couple that would make sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-16 03:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-workspace/src/settings.rs</code>:35 on 2024-04-16 03:59</div>
            <div class="timeline-body"><p>Maybe I messed that up? Will put them in <code>pip</code> and keep them there for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-workspace/src/settings.rs</code>:22 on 2024-04-16 08:10</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// `[tool]`
pub(crate) struct Tools {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-workspace/src/settings.rs</code>:31 on 2024-04-16 08:11</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// `[tool.uv]`
pub struct Options {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-workspace/src/settings.rs</code>:15 on 2024-04-16 08:14</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// A pyproject.toml with an (optional) `[tool.uv]` section
pub(crate) struct PyProjectToml {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/src/main.rs</code>:108 on 2024-04-16 08:36</div>
            <div class="timeline-body"><p>I'm for erroring, i'm assuming we have read and write permissions for the entire repo/project and read permissions for dirs above</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-workspace/src/workspace.rs</code>:22 on 2024-04-16 09:42</div>
            <div class="timeline-body"><p>Does this mean we only pick the closest file?</p>
<p>The scenario i'm thinking about is one where the work dir is <code>/home/ferris/foo/bar/</code> and we have:</p>
<ul>
<li><code>/home/ferris/uv.toml</code> or <code>/home/ferris/.config/uv.toml</code>: Has some general user-level settings</li>
<li><code>/home/ferris/foo/pyproject.toml</code>: Defines a workspace of python projects and has some project level settings</li>
<li><code>/home/ferris/foo/bar/pyproject.toml</code>: A member of that workspace. Does not contain settings (i think?)</li>
</ul>
<p>In this case, i want to first load user-level setting, then override them with the project level settings (implicitly), then resolve <code>bar</code> as part of the <code>foo</code> workspace</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-workspace/src/workspace.rs</code>:16 on 2024-04-16 09:46</div>
            <div class="timeline-body"><p>I'm not sure if i'd call that workspace, i'm thinking about having settings, things that are defined e.g. on the user-level, the project level or the cli level which e.g. define indexes, plus having a workspace, an abstraction over a set of packages that are part of single project. That's the main divergence from ruff, in uv (similar to cargo) you're always in a single workspace and/or a single package; i still have to flesh out how to integrate this into uv.</p>
<p>In cargo, you're technically always in a rust workspace, even if you only define a single crate, that's a single crate workspace. Then there's the concept of <a href="https://doc.rust-lang.org/cargo/reference/config.html">configuration</a> with hierarchical structure and cli overrides.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-04-16 09:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-16 13:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-workspace/src/workspace.rs</code>:22 on 2024-04-16 13:26</div>
            <div class="timeline-body"><p>Yeah we only pick the closest file. What if we do the same as Ruff, and skip a <code>pyproject.toml</code> that lacks a <code>tool.uv</code> entry?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-16 13:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-workspace/src/workspace.rs</code>:16 on 2024-04-16 13:26</div>
            <div class="timeline-body"><p>I can call this <code>configuration</code> instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-16 13:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-workspace/src/workspace.rs</code>:22 on 2024-04-16 13:35</div>
            <div class="timeline-body"><p>That'd make sense to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-16 13:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-workspace/src/workspace.rs</code>:16 on 2024-04-16 13:37</div>
            <div class="timeline-body"><p>I've been intending to call it a &quot;workspace&quot; whether there's one package or many in your project. I don't know if we need to introduce a separate term?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-04-16 13:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-workspace/src/workspace.rs</code>:22 on 2024-04-16 13:42</div>
            <div class="timeline-body"><p>What do you think about https://doc.rust-lang.org/cargo/reference/config.html#hierarchical-structure ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-04-16 13:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-workspace/src/workspace.rs</code>:16 on 2024-04-16 13:55</div>
            <div class="timeline-body"><p>I like <code>configuration</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-16 16:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-workspace/src/settings.rs</code>:83 on 2024-04-16 16:40</div>
            <div class="timeline-body"><p><code>compile_bytecode</code>? We could change the CLI flag too (and add an alias).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-workspace/src/settings.rs</code>:83 on 2024-04-16 16:45</div>
            <div class="timeline-body"><p>That makes sense to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-16 16:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-16 16:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-workspace/src/workspace.rs</code>:26 on 2024-04-16 16:53</div>
            <div class="timeline-body"><p>Fixed this. We show a user-facing warning on <code>pyproject.toml</code> but error on <code>uv.toml</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @charliermarsh on 2024-04-16 16:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-16 17:02</div>
            <div class="timeline-body"><p>I'm just gonna leave it as &quot;workspace&quot; for now. Let's revisit when we add <em>actual</em> workspace, that's all internal terminology and abstractions anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-04-16 17:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-04-16 17:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-16 17:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:36:34 UTC
    </footer>
</body>
</html>
