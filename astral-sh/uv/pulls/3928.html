<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove installed packages from preferences - astral-sh/uv #3928</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Remove installed packages from preferences</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/3928">#3928</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-05-30 19:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>I believe that this is not necessary, as the installer packages are already considered in <code>CandidateSelector::get_preferred</code>.</p>
<p>Firstly, note that we never pass both non-empty installed packages <em>and</em> non-empty preferences (the installer routines pass site packages and no preferences; the resolver routines pass no site packages but lockfile preferences).</p>
<p>However, in general, if you look at <code>CandidateSelector::get_preferred</code>, and consider what&#x27;s changing, we now skip the <code>if let Some(version) = preferences.version(package_name)</code> case for installed packages. But we then check installed packages within that <code>if</code>, and in the <code>else</code>. So it seems like we&#x27;ll still return them in either case?</p>
<p>The only behavior change is in the case that you have multiple versions of a package installed. Previously, we&#x27;d respect one of them, because <code>Preferences</code> takes the last winner (it&#x27;s a hash map, so we just replace the package key with the last version we see); but in installed packages, we always ignore distributions with multiple versions, since it&#x27;s indicative of a broken environment. That&#x27;s a fine change IMO. We could change <code>CandidateSelector::get_preferred</code> to support this if we wanted to.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-30 19:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-30 19:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-05-30 19:55</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/uv/branches/charlie/pref">CodSpeed Performance Report</a>
Merging #3928 will <strong>degrade performances by 6.08%</strong>
<p>Comparing <code>charlie/pref</code> (0eb7e8b) with <code>main</code> (261aa2c)</p>
Summary
<p><code>⚡ 1</code> improvements
<code>❌ 1</code> regressions
<code>✅ 11</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/uv/branches/charlie/pref">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
Benchmarks breakdown
<p>|     | Benchmark | <code>main</code> | <code>charlie/pref</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>wheelname_tag_compatibility[flyte-short-incompatible]</code> | 955.8 ns | 897.5 ns | +6.5% |
| ❌ | <code>resolve_warm_jupyter</code> | 85.3 ms | 90.9 ms | -6.08% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-30 20:06</div>
            <div class="timeline-body"><p>If this regresses I&#x27;m very sorry.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-30 20:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-30 20:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-05-30 20:09</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:45:37 UTC
    </footer>
</body>
</html>
