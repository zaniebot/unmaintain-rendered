<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>auth-helper: only refresh pyx tokens expiring in 30 minutes - astral-sh/uv #17482</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>auth-helper: only refresh pyx tokens expiring in 30 minutes</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/pull/17482">#17482</a>
        opened by <a href="https://github.com/zsol">@zsol</a>
        on 2026-01-15 10:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zsol">@zsol</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p><code>uv auth helper</code> currently passes in a tolerance of zero seconds to <code>pyx_store.access_token()</code> which forces a refresh every time. That is excessive.</p>
<p>This PR changes that behavior to allow for a tolerance of 30 minutes. This is more than the default for <code>uv auth token</code> (5 minutes), because bazel builds might run for a long time, so it might take a while for the bazel-native downloader to get to actually fetching the file (although currently bazel seems to call the auth helper directly before attempting a fetch).</p>
<p>We might want to expose this as a CLI parameter in the future.</p>
<h2>Test Plan</h2>
<p>The following script exercises the credential helper concurrently:</p>
<pre><code class="language-python">#!/usr/bin/env python3
&quot;&quot;&quot;Request pyx auth tokens from uv in concurrent attempts.&quot;&quot;&quot;

import argparse
import asyncio


async def get_auth_token(
    index: int, uv_binary: str
) -&gt; tuple[int, str | None, str | None]:
    &quot;&quot;&quot;Request an auth token from uv.&quot;&quot;&quot;
    proc = await asyncio.create_subprocess_exec(
        uv_binary,
        &quot;auth&quot;,
        &quot;helper&quot;,
        &quot;--preview-features&quot;,
        &quot;auth-helper&quot;,
        &quot;--protocol&quot;,
        &quot;bazel&quot;,
        &quot;get&quot;,
        stdin=asyncio.subprocess.PIPE,
        stdout=asyncio.subprocess.PIPE,
        stderr=asyncio.subprocess.PIPE,
    )
    input_json = b'{&quot;uri&quot;: &quot;https://api.pyx.dev/&quot;}'
    stdout, stderr = await proc.communicate(input=input_json)

    if proc.returncode == 0:
        return (index, stdout.decode().strip(), None)
    else:
        return (index, None, stderr.decode().strip())


async def main(invocations: int, uv_binary: str) -&gt; None:
    &quot;&quot;&quot;Run n concurrent auth token requests.&quot;&quot;&quot;
    print(f&quot;Starting {invocations} concurrent auth token requests...&quot;)

    tasks = [get_auth_token(i, uv_binary) for i in range(invocations)]
    results = await asyncio.gather(*tasks)

    successes = 0
    failures = 0

    for index, token, error in results:
        if token:
            successes += 1
            # Only print first few characters of token for privacy.
            print(f&quot;[{index:3d}] Success: {token[:5]}...&quot;)
        else:
            failures += 1
            print(f&quot;[{index:3d}] Failed: {error}&quot;)

    print(f&quot;\nResults: {successes} successes, {failures} failures&quot;)


if __name__ == &quot;__main__&quot;:
    parser = argparse.ArgumentParser(
        description=&quot;Request PyX auth tokens from uv in concurrent attempts&quot;
    )
    parser.add_argument(
        &quot;-n&quot;,
        &quot;--invocations&quot;,
        type=int,
        default=100,
        help=&quot;Number of concurrent requests (default: 100)&quot;,
    )
    parser.add_argument(
        &quot;--uv&quot;,
        default=&quot;uv&quot;,
        help=&quot;Path to uv binary (default: uv)&quot;,
    )
    args = parser.parse_args()
    asyncio.run(main(args.invocations, args.uv))
</code></pre>
<p>Running this script with <code>-n 1000</code> takes about five minutes on my machine before this PR, and about two seconds after this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @zsol on 2026-01-15 10:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "auth-helper: don't force refresh the token" to "auth-helper: don't force refresh the pyx token" by @zsol on 2026-01-15 10:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "auth-helper: don't force refresh the pyx token" to "auth-helper: don't force refresh the pyx token unless it's about to expire in 30 minutes" by @zsol on 2026-01-15 10:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "auth-helper: don't force refresh the pyx token unless it's about to expire in 30 minutes" to "auth-helper: only refresh pyx tokens expiring in 30 minutes" by @zsol on 2026-01-15 10:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zsol on 2026-01-15 10:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-15 10:48:31 UTC
    </footer>
</body>
</html>
