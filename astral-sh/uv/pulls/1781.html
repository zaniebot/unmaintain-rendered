<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use `git` command to fetch repositories instead of `libgit2` for robust SSH support - astral-sh/uv #1781</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use <code>git</code> command to fetch repositories instead of <code>libgit2</code> for robust SSH support</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/1781">#1781</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-02-20 20:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/zanieb">@zanieb</a> on 2024-02-20 20:06</div>
            <div class="timeline-body"><p>Closes https://github.com/astral-sh/uv/issues/1775
Closes https://github.com/astral-sh/uv/issues/1452
Closes https://github.com/astral-sh/uv/issues/1514
Follows https://github.com/astral-sh/uv/pull/1717</p>
<p>libgit2 does not support host names with extra identifiers during SSH lookup (e.g. <a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/managing-deploy-keys#using-multiple-repositories-on-one-server"><code>github.com-some_identifier</code></a>) so we use the <code>git</code> command instead for fetching. This is required for <code>pip</code> parity.</p>
<p>See the <a href="https://doc.rust-lang.org/nightly/cargo/reference/config.html#netgit-fetch-with-cli">Cargo documentation</a> for more details on using the <code>git</code> CLI instead of libgit2. We may want to try to use libgit2 first in the future, as it is more performant (#1786).</p>
<p>We now support authentication with:</p>
<pre><code>git+ssh://git@&lt;hostname&gt;/...
git+ssh://git@&lt;hostname&gt;-&lt;identifier&gt;/...
</code></pre>
<p>Tested with a deploy key e.g.</p>
<pre><code>cargo run -- \
    pip install uv-private-pypackage@git+ssh://git@github.com-test-uv-private-pypackage/astral-test/uv-private-pypackage.git \
    --reinstall --no-cache -v
</code></pre>
<p>and</p>
<pre><code>cargo run -- \
    pip install uv-private-pypackage@git+ssh://git@github.com/astral-test/uv-private-pypackage.git \
    --reinstall --no-cache -v     
</code></pre>
<p>with a ssh config like</p>
<pre><code>Host github.com
        Hostname github.com
        IdentityFile=/Users/mz/.ssh/id_ed25519

Host github.com-test-uv-private-pypackage
        Hostname github.com
        IdentityFile=/Users/mz/.ssh/id_ed25519
</code></pre>
<p>It seems quite hard to add test coverage for this to the test suite, as we'd need to add the SSH key and I don't know how to isolate that from affecting other developer's machines.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-20 23:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-git/src/git.rs</code>:1014 on 2024-02-20 23:44</div>
            <div class="timeline-body"><p>I think the approach at https://github.com/astral-sh/uv/pull/1786/commits/51b38f9a871c42ac6638328718c04630b216e56f#diff-e0d9d19e8dbea69ecd5354dcbec7d87e259e801687037360fac463c3143c16c8R1004-R1011 is probably a better way to handle the &quot;branch or tag&quot; refspecs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-20 23:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-git/src/git.rs</code>:1014 on 2024-02-20 23:54</div>
            <div class="timeline-body"><p>Picked this out of https://github.com/astral-sh/uv/pull/1786 in https://github.com/astral-sh/uv/pull/1781/commits/afafb66b34c604c3ba274ee402083973a953d77a</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-git/src/git.rs</code>:1013 on 2024-02-20 23:55</div>
            <div class="timeline-body"><p>Is there a better way to combine these?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-20 23:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-20 23:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-git/src/git.rs</code>:977 on 2024-02-20 23:57</div>
            <div class="timeline-body"><p>This could hide errors. It's unclear to me what happens inside libgit2 but it definitely succeeds with missing refspecs.</p>
<p>Alternatively, we could special case the <code>BranchOrTag</code> case and take the first matching refspec in that case but continue passing them all in at once for other cases?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zanieb on 2024-02-21 00:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @zanieb on 2024-02-21 00:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @snowsignal by @zanieb on 2024-02-21 00:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-02-21 00:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-21 00:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-git/src/git.rs</code>:977 on 2024-02-21 00:20</div>
            <div class="timeline-body"><p>Do we &quot;typically&quot; have multiple refspecs here? Like would we expect this to cause a noticeable slowdown, doing them by-one-one?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-21 00:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-git/src/git.rs</code>:977 on 2024-02-21 00:23</div>
            <div class="timeline-body"><p>It's just two cases afaik</p>
<ul>
<li>We have a short commit and fetch <em>everything</em> via two refspecs</li>
<li>We have a branch or tag and fetch each of those (we only want the first one that is present though)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-git/src/git.rs</code>:1013 on 2024-02-21 00:31</div>
            <div class="timeline-body"><p>Does the repeated <code>.context</code> lead them to be rendered one-by-one, in a vertical list?</p>
<p>I think this is reasonable...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-21 00:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-02-21 00:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-git/src/git.rs</code>:1013 on 2024-02-21 00:32</div>
            <div class="timeline-body"><p>@BurntSushi would have good intuition here (but doesn't need to block the PR).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-21 00:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/uv-git/src/git.rs</code>:981 on 2024-02-21 00:54</div>
            <div class="timeline-body"><p>Small performance nit: <code>if !results.iter().any(Result::is_ok)</code> would be slightly faster as a check since it would return early.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> approved on 2024-02-21 00:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-21 01:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-git/src/git.rs</code>:1013 on 2024-02-21 01:13</div>
            <div class="timeline-body"><p>per https://github.com/astral-sh/uv/pull/1786/commits/acc4ff3b7f8abf5ca26a1944deb831fc3fa07612 I don't know if these are surfaced <em>at all</em>?</p>
<pre><code class="language-bash">$ cargo run -- pip install &quot;uv-public-pypackage @ git+https://github.com/astral-test/uv-public-pypackage@2.0.0&quot; -v --reinstall --no-cache
...
    0.373747s DEBUG uv_git::source Updating git source `Url { scheme: &quot;https&quot;, cannot_be_a_base: false, username: &quot;&quot;, password: None, host: Some(Domain(&quot;github.com&quot;)), port: None, path: &quot;/astral-test/uv-public-pypackage&quot;, query: None, fragment: None }`
    0.377127s DEBUG uv_git::git Attempting GitHub fast path for: https://api.github.com/repos/astral-test/uv-public-pypackage/commits/2.0.0
    0.624614s DEBUG uv_git::git failed to check github HTTP status client error (422 Unprocessable Entity) for url (https://api.github.com/repos/astral-test/uv-public-pypackage/commits/2.0.0)
    0.625373s DEBUG uv_git::git skipping gc as there's only 0 pack files
    0.626108s DEBUG uv_git::git Performing a Git fetch for: https://github.com/astral-test/uv-public-pypackage
    0.627057s DEBUG uv_git::git initiating fetch of [&quot;+refs/heads/2.0.0:refs/remotes/origin/2.0.0&quot;, &quot;+refs/tags/2.0.0:refs/remotes/origin/tags/2.0.0&quot;] from https://github.com/astral-test/uv-public-pypackage
error: Failed to download and build: uv-public-pypackage @ git+https://github.com/astral-test/uv-public-pypackage@2.0.0
  Caused by: Git operation failed
  Caused by: failed to find branch or tag `2.0.0`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-git/src/git.rs</code>:981 on 2024-02-21 01:17</div>
            <div class="timeline-body"><p>Won't <code>all</code> exit early on the first <code>Result::Ok</code> too?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-21 01:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-02-21 04:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/uv-git/src/git.rs</code>:981 on 2024-02-21 04:10</div>
            <div class="timeline-body"><p>Right, sorry. My bad ü§¶‚Äç‚ôÄÔ∏è</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-02-21 12:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-git/src/git.rs</code>:1013 on 2024-02-21 12:24</div>
            <div class="timeline-body"><p>Yeah this <em>should</em> create a causal chain with each link being an error in <code>results</code>. For example:</p>
<pre><code class="language-rust">fn main() -&gt; anyhow::Result&lt;()&gt; {
    let mut err = anyhow::anyhow!(&quot;error #1&quot;);
    for i in 2..=10 {
        err = err.context(format!(&quot;error #{i}&quot;));
    }
    Err(err)
}
</code></pre>
<p>Has this output:</p>
<pre><code>[andrew@duff anyhow-err-combine]$ cargo run -q
Error: error #10

Caused by:
    0: error #9
    1: error #8
    2: error #7
    3: error #6
    4: error #5
    5: error #4
    6: error #3
    7: error #2
    8: error #1
</code></pre>
<p>I'm not sure if this is the right presentation though. Because these are more like sibling errors than errors in a causal chain. Perhaps if we &quot;picked&quot; on error and added a <code>tracing::warn!</code> for the others? Or alternatively, smushed all of the errors into one, without creating a new link in the causal chain for each one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-21 15:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-git/src/git.rs</code>:1013 on 2024-02-21 15:26</div>
            <div class="timeline-body"><p>I don't think these are actually displayed right now so I'd like to do the simplest thing. I'll log the errors and raise a new one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-21 16:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/common/mod.rs</code>:135 on 2024-02-21 16:12</div>
            <div class="timeline-body"><p>I want to return <code>Vec&lt;(&amp;str, &amp;str)&gt;</code> here where the lifetime is of the <code>TestContext</code> but can't because <code>cache_dir.canonicalize()</code> is owned by the function. Suggestions?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-21 16:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/common/mod.rs</code>:135 on 2024-02-21 16:14</div>
            <div class="timeline-body"><p>Do I need to store the canonicalized path on the struct too?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/common/mod.rs</code>:135 on 2024-02-21 16:15</div>
            <div class="timeline-body"><p>The reason this is a problem is e.g.</p>
<p>https://github.com/astral-sh/uv/pull/1781/files#diff-10e2684d108814c5407ca429afe35ac9916b5577d17b45afc4e800f6582f9ce7R949-R954</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-21 16:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-02-21 16:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv/tests/common/mod.rs</code>:135 on 2024-02-21 16:16</div>
            <div class="timeline-body"><p>If you can store the canonicalized path on <code>TestContext</code>, then that would do the trick I think?</p>
<p>But also, <code>Vec&lt;(String, String)&gt;</code> seems fine to me unless there's a reason not to do that?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-02-21 16:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv/tests/common/mod.rs</code>:135 on 2024-02-21 16:18</div>
            <div class="timeline-body"><p>OK, so the reason why you want this is that <code>uv_snapshot!</code> wants a <code>Vec&lt;(&amp;str, &amp;str)&gt;</code>, is that right? I'm not familiar with <code>uv_snapshot!</code>, but if you can change it to accept <code>Vec&lt;(impl AsRef&lt;str&gt;, impl AsRef&lt;str&gt;)&gt;</code>, then that should make it work for both <code>Vec&lt;(&amp;str, &amp;str)&gt;</code> and <code>Vec&lt;(String, String)&gt;</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-02-21 16:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/common/mod.rs</code>:135 on 2024-02-21 16:21</div>
            <div class="timeline-body"><p>Just going to add it to the struct</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-02-21 16:32</div>
            <div class="timeline-body"><p>Do we have any benchmarks that use git dependencies? Does it change the performance in significant ways?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-02-21 16:53</div>
            <div class="timeline-body"><blockquote>
<p>Do we have any benchmarks that use git dependencies? Does it change the performance in significant ways?</p>
</blockquote>
<p>I don't think we do. Honestly I'm not sure it makes sense to take the time to measure right now because we <em>need</em> to support authentication. I think benchmarking should be done when considering #1786 instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2024-02-21 18:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-02-21 18:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-02-21 18:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 14:55:03 UTC
    </footer>
</body>
</html>
