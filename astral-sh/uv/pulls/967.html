<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove RFC2047 decoder - astral-sh/uv #967</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Remove RFC2047 decoder</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/967">#967</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-01-18 19:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<ul>
<li>This was inherited from https://github.com/PyO3/python-pkginfo-rs/blob/d719988323a0cfea86d4737116d7917f30e819e2/src/metadata.rs#LL78C2-L91C26</li>
<li>...which introduced this code here: https://github.com/PyO3/python-pkginfo-rs/commit/9cd1d43f7c2306695f53375f50717b4f7fc0b63c</li>
<li>...with the originating issue here: <a href="https://github.com/PyO3/maturin/issues/612">PyO3/maturin#612</a></li>
<li>...and the upstream issue here: <a href="https://github.com/staktrace/mailparse/issues/50">staktrace/mailparse#50</a></li>
</ul>
<p>It seems like the goal was to support Unicode in certain header fields, but I don&#x27;t think this is necessary for us. We only use <code>get_first_value</code> for <code>Requires-Python</code>, which has to be ASCII, doesn&#x27;t it?</p>
<p>In my testing, it seems like the <code>charset</code> hack can also be removed. The tests I copied over actually work without it, which makes me a bit skeptical.</p>
<p>The main benefit here is that we get to a remove a <em>big</em> dependency stack, including Chumsky and Stacker and psm which have limited cross-platform support.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/BurntSushi">@BurntSushi</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-18 19:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-18 19:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-18 19:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-18 19:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/pypi-types/src/metadata.rs</code>:78 on 2024-01-18 19:16</div>
            <div class="timeline-body"><p>This piece I am slightly less confident in...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-18 19:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/pypi-types/src/metadata.rs</code>:78 on 2024-01-18 19:21</div>
            <div class="timeline-body"><p>Although this change works fine when resolving <code>defity==0.1.3</code>, which was the originating issue for PyO3.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-18 19:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/pypi-types/src/metadata.rs</code>:78 on 2024-01-18 19:24</div>
            <div class="timeline-body"><p>Even the author name is resolved correctly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/pypi-types/src/metadata.rs</code>:175 on 2024-01-18 19:27</div>
            <div class="timeline-body"><p>What about a test with a non-ASCII package name?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/pypi-types/src/metadata.rs</code>:175 on 2024-01-18 19:32</div>
            <div class="timeline-body"><p>It looks like maybe RFC 2047 is for reading UTF-8 encoded data in a format like <code>=E2=82=AC</code>? So maybe a test needs to include that?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/pypi-types/src/metadata.rs</code>:78 on 2024-01-18 19:33</div>
            <div class="timeline-body"><p>Hmm it looks like this was lifted from PyO3? https://github.com/PyO3/python-pkginfo-rs/blob/d719988323a0cfea86d4737116d7917f30e819e2/src/metadata.rs#L89</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-01-18 19:38</div>
            <div class="timeline-body"><p>It looks like it is theory possible to remove <code>stacker</code>, but <a href="https://github.com/TornaxO7/rfc2047-decoder/blob/e0ea2817e939047af36edafa6baf37ec12aa4618/Cargo.toml#L21"><code>rfc2047-decoder</code> does not re-export <code>chumsky</code> features</a> and <a href="https://github.com/zesterer/chumsky/blob/8b8cf0a04b157df30799d4f385ddedc1dca85014/Cargo.toml#L18"><code>chumsky</code> enables the <code>stacker</code> dependency by default</a>. So to get <code>stacker</code> out while keeping <code>rfc2047-decoder</code> in, you&#x27;d need to patch <code>rfc2047-decoder</code> to re-export the <code>spill-stack</code> feature from <code>chumsky</code>.</p>
<blockquote>
<p>It seems like the goal was to support Unicode in certain header fields, but I don&#x27;t think this is necessary for us. We only use get_first_value for Requires-Python, which has to be ASCII, doesn&#x27;t it?</p>
</blockquote>
<p>This part confuses me. <code>get_first_value</code> is used for several things. And indeed, without RFC 2047 support, it seems like it might get stuff wrong? But I&#x27;m not an RFC 2047 expert. Does it only apply to the <em>body</em>? Or also to the header values? If it&#x27;s the former, then assuming you don&#x27;t care about the body here, you should be fine without RFC 2047 decoding. But if things like <code>=E2=82=AC</code> can appear in header values, then you probably need RFC 2047 decoding.</p>
<p>My intuition here is that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-18 19:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/pypi-types/src/metadata.rs</code>:78 on 2024-01-18 19:51</div>
            <div class="timeline-body"><p>It&#x27;s linked in the PR summary :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-18 19:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/pypi-types/src/metadata.rs</code>:175 on 2024-01-18 19:59</div>
            <div class="timeline-body"><p>It works correctly as-is -- if I use <code>Author: =?utf-8?q?=C3=A4_space?= &lt;x@y.org&gt;</code>, it gets parsed as <code>author: Ã¤ space &lt;x@y.org&gt;</code>.</p>
<p>The thing that the author pointed out in the linked mailparse issue is that this decoding happens via <code>mailparse::parse_mail</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-18 20:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/pypi-types/src/metadata.rs</code>:175 on 2024-01-18 20:02</div>
            <div class="timeline-body"><p>Added!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2024-01-18 20:05</div>
            <div class="timeline-body"><p>Ah okay, so <code>mailparse</code> is already doing RFC 2047 decoding? If so, then yeah, this change LGTM.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-18 20:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/pypi-types/src/metadata.rs</code>:175 on 2024-01-18 20:06</div>
            <div class="timeline-body"><p>FWIW, name <em>has</em> to be ASCII: https://packaging.python.org/en/latest/specifications/core-metadata/#name</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-18 20:07</div>
            <div class="timeline-body"><p>Yeah, that&#x27;s why I&#x27;m slightly confused as to why this was applied upstream.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-18 20:08</div>
            <div class="timeline-body"><p>The <code>mailparse</code> author does say here: <a href="https://github.com/staktrace/mailparse/issues/50">staktrace/mailparse#50</a>#issuecomment-939314410</p>
<blockquote>
<p>It kind of looks like you&#x27;re passing in utf-8 or other non-ascii data into mailparse (from <a href="https://github.com/PyO3/python-pkginfo-rs/blob/17523fac9af6c50080f9e087b9fd271c49bd2ec8/src/metadata.rs#L170">here</a>) and then expecting that to not get mangled. But really you&#x27;re using mailparse in a way that it&#x27;s not meant to be used.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-18 20:09</div>
            <div class="timeline-body"><p>Honestly, I think this might&#x27;ve been fixed in mailparse later: <a href="https://github.com/staktrace/mailparse/pull/104">staktrace/mailparse#104</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-18 20:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-18 20:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-01-18 20:09</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:43:15 UTC
    </footer>
</body>
</html>
