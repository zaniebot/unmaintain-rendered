<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix priority of platform tags for manylinux - astral-sh/uv #2483</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix priority of platform tags for manylinux</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/2483">#2483</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-03-15 20:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-15 20:51</div>
            <div class="timeline-body"><p>Closes https://github.com/astral-sh/uv/issues/2477</p>
<p>See also:</p>
<ul>
<li>#2489</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-03-15 20:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @zanieb on 2024-03-15 20:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @zanieb on 2024-03-15 20:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bdice">@bdice</a> reviewed on 2024-03-15 21:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/bdice">@bdice</a> on <code>crates/platform-tags/src/tags.rs</code>:553 on 2024-03-15 21:43</div>
            <div class="timeline-body"><p>Thanks so much for the quick fix.</p>
<p>Just to make sure I understand this -- does this ordering mean that legacy tags <code>manylinux1</code>, <code>manylinux2014</code>, and <code>manylinux2010</code> would be preferred over <code>manylinux_2_28</code>? That's not quite what I would expect.</p>
<p>Note that the &quot;legacy&quot; manylinux tags <code>manylinux1</code>, <code>manylinux2010</code>, and <code>manylinux2014</code> have corresponding glibc versions and should be prioritized like their corresponding &quot;new glibc-style&quot; tags.</p>
<p>https://peps.python.org/pep-0600/#legacy-manylinux-tags</p>
<blockquote>
<p>The existing manylinux tags are redefined as aliases for new-style tags:</p>
<p>manylinux1_x86_64 is now an alias for manylinux_2_5_x86_64
manylinux1_i686 is now an alias for manylinux_2_5_i686
manylinux2010_x86_64 is now an alias for manylinux_2_12_x86_64
manylinux2010_i686 is now an alias for manylinux_2_12_i686
manylinux2014_x86_64 is now an alias for manylinux_2_17_x86_64
manylinux2014_i686 is now an alias for manylinux_2_17_i686
manylinux2014_aarch64 is now an alias for manylinux_2_17_aarch64
manylinux2014_armv7l is now an alias for manylinux_2_17_armv7l
manylinux2014_ppc64 is now an alias for manylinux_2_17_ppc64
manylinux2014_ppc64le is now an alias for manylinux_2_17_ppc64le
manylinux2014_s390x is now an alias for manylinux_2_17_s390x</p>
</blockquote>
<p>Concretely, we should expect this priority order:</p>
<p><code>manylinux_2_28</code> &gt; ... &gt; <code>manylinux_2_17</code> == <code>manylinux2014</code> &gt; <code>manylinux_2_16</code> &gt; ... &gt; <code>manylinux_2_12</code> == <code>manylinux2010</code> &gt; <code>manylinux_2_11</code> &gt; ... &gt; <code>manylinux_2_5</code> == <code>manylinux1</code></p>
<p>With the aliasing, I <em>think</em> you want to prefer new-style over old style (which resolves any ambiguity in the <code>==</code> portions above). Typically wheels are tagged like <code>pyarrow-15.0.1-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl</code> and include both new-style and old-style tags if applicable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bdice">@bdice</a> reviewed on 2024-03-15 21:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/bdice">@bdice</a> on <code>crates/platform-tags/src/tags.rs</code>:553 on 2024-03-15 21:47</div>
            <div class="timeline-body"><p>Please correct me if I'm reading this wrong, I'm basing this on my recollection of <code>pip</code> behavior and a quick skim of https://peps.python.org/pep-0600/#package-installers. Also I'm assuming this must be the desired behavior or else we'd be getting <code>pyarrow-15.0.1-cp312-cp312-manylinux_2_17_x86_64.manylinux2014_x86_64.whl</code> over <code>pyarrow-15.0.1-cp312-cp312-manylinux_2_28_x86_64.whl</code> due to the presence of the <code>manylinux2014</code> tag, <em>if</em> that was supposed to take precedence.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/platform-tags/src/tags.rs</code>:492 on 2024-03-15 22:27</div>
            <div class="timeline-body"><p>I need to read up on it, but I don't think this is quite what we want. We need to change the ordering of the <code>manylinux2010_</code> and friends statements too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-15 22:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-03-15 22:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/platform-tags/src/tags.rs</code>:553 on 2024-03-15 22:37</div>
            <div class="timeline-body"><p>Thanks for the details! I can futz with the ordering as you've described and I'll double check that we're matching the expected ordering.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Fix platform tag ordering" to "Fix priority of platform tags for manylinux" by @zanieb on 2024-03-16 00:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-16 00:18</div>
            <div class="timeline-body"><p>I fixed the ordering of the abi tags, but I'm not sure where it's documented that <code>linux_x86_64</code> should take priority over <code>manylinux_&lt;abi&gt;_x86_64</code>. If someone has a link for that part of the specification I'd appreciate it — I can add it to the code.</p>
<p>Looks correct per https://github.com/pypa/packaging/blob/fd4f11139d1c884a637be8aa26bb60a31fbc9411/packaging/tags.py#L434-L444</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-16 14:04</div>
            <div class="timeline-body"><p>I think it might be the other way around, I think higher priority tags come first in that code, so <code>linux_x86_64</code> would be last? That's at least my read of the code, but I didn't test it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-16 14:05</div>
            <div class="timeline-body"><p>You can test by comparing to:</p>
<pre><code class="language-python">from packaging import tags

for tag in tags.sys_tags(): print(tag)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-16 14:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/platform-tags/src/tags.rs</code>:368 on 2024-03-16 14:06</div>
            <div class="timeline-body"><p>Doesn't <code>manylinux2014</code> need to be greater than <code>manylinux2010</code>, and also greater than <code>manylinux_2_12</code>? I think these legacy tags need to be interspersed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-03-16 15:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/platform-tags/src/tags.rs</code>:368 on 2024-03-16 15:59</div>
            <div class="timeline-body"><p>Eek okay this was more wrong than I thought to start..</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-16 16:13</div>
            <div class="timeline-body"><p>Apologies for all the back and forth apparently this needed a more rigorous look :)</p>
<p>I've addressed the last round of comments. I might look into a better way to test we match Python's behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-16 16:25</div>
            <div class="timeline-body"><p>It looks like our ordering of ABI tags is wrong, i.e. Python does</p>
<pre><code>cp311-cp311-manylinux_2_28_x86_64
...
cp311-cp311-manylinux_2_17_x86_64
cp311-cp311-manylinux2014_x86_64
cp311-cp311-manylinux_2_16_x86_64
...
cp311-cp311-manylinux_2_12_x86_64
cp311-cp311-manylinux2010_x86_64
cp311-cp311-manylinux_2_11_x86_64
...
cp311-cp311-manylinux_2_5_x86_64
cp311-cp311-manylinux1_x86_64
cp311-cp311-linux_x86_64
cp311-abi3-manylinux_2_28_x86_64
...
cp311-abi3-manylinux_2_17_x86_64
cp311-abi3-manylinux2014_x86_64
cp311-abi3-manylinux_2_16_x86_64
...
cp311-abi3-manylinux_2_12_x86_64
cp311-abi3-manylinux2010_x86_64
cp311-abi3-manylinux_2_11_x86_64
...
cp311-abi3-manylinux_2_5_x86_64
cp311-abi3-manylinux1_x86_64
cp311-abi3-linux_x86_64
cp311-none-manylinux_2_28_x86_64
...
cp311-none-manylinux_2_17_x86_64
cp311-none-manylinux2014_x86_64
cp311-none-manylinux_2_16_x86_64
...
cp311-none-manylinux_2_12_x86_64
cp311-none-manylinux2010_x86_64
cp311-none-manylinux_2_11_x86_64
...
cp311-none-manylinux_2_5_x86_64
cp311-none-manylinux1_x86_64
cp311-none-linux_x86_64
cp310-abi3-manylinux_2_28_x86_64
...
</code></pre>
<p>but we do</p>
<pre><code>cp311_cp311_manylinux_2_28_x86_64
cp311_none_manylinux_2_28_x86_64
...
cp311_cp311_manylinux_2_17_x86_64
cp311_none_manylinux_2_17_x86_64
cp311_cp311_manylinux2014_x86_64
cp311_none_manylinux2014_x86_64
cp311_cp311_manylinux_2_16_x86_64
cp311_none_manylinux_2_16_x86_64
...
cp311_cp311_manylinux_2_12_x86_64
cp311_none_manylinux_2_12_x86_64
cp311_cp311_manylinux2010_x86_64
cp311_none_manylinux2010_x86_64
cp311_cp311_manylinux_2_11_x86_64
cp311_none_manylinux_2_11_x86_64
...
cp311_cp311_manylinux_2_5_x86_64
cp311_none_manylinux_2_5_x86_64
cp311_cp311_manylinux1_x86_64
cp311_none_manylinux1_x86_64
cp311_cp311_linux_x86_64
cp311_none_linux_x86_64
cp311_abi3_manylinux_2_28_x86_64
...
cp311_abi3_manylinux_2_17_x86_64
cp311_abi3_manylinux2014_x86_64
cp311_abi3_manylinux_2_16_x86_64
...
cp311_abi3_manylinux_2_12_x86_64
cp311_abi3_manylinux2010_x86_64
cp311_abi3_manylinux_2_11_x86_64
...
cp311_abi3_manylinux_2_5_x86_64
cp311_abi3_manylinux1_x86_64
cp311_abi3_linux_x86_64
cp310_abi3_manylinux_2_28_x86_64
...
</code></pre>
<p>This is a different part of the code though, I'll address in a second pull request.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-16 16:32</div>
            <div class="timeline-body"><p>Oh interesting… they might be mutually exclusive such that it hasn’t mattered? Hard to reason about from my phone :D Thank you for digging into this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-16 17:36</div>
            <div class="timeline-body"><p>I'm no expert, just mindlessly matching Python's behavior at this point. See #2489 for the ABI changes.</p>
<p>I'll wait for @konstin to review both of these.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-03-16 18:05</div>
            <div class="timeline-body"><p>Great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-03-16 18:06</div>
            <div class="timeline-body"><p>I’m comfortable signing off on this if you want to merge.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bdice">@bdice</a> approved on 2024-03-16 18:49</div>
            <div class="timeline-body"><p>Thanks, this looks right to me too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2024-03-16 22:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-03-16 22:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-03-16 22:33</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 14:49:26 UTC
    </footer>
</body>
</html>
