<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>feat: more rust in trampoline - astral-sh/uv #5751</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>feat: more rust in trampoline</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/5751">#5751</a>
        opened by <a href="https://github.com/samypr100">@samypr100</a>
        on 2024-08-03 14:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/samypr100">@samypr100</a> on 2024-08-03 14:43</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This is an experimental PR to replace more unsafe calls with more rust while still trying to keep the binary size small enough. These changes roughly increase the size of the trampolines to about 80kb~ due to usage of <code>Command</code> which brings a large chunk of <code>core::fmt</code>. This was a alternate PR to #5750.</p>
<p>The primary changes here include changes from #5750 (post merge)</p>
<ul>
<li>Switch to use rust path components for ease of path management</li>
<li>Leverage <code>std::process::exit</code> for process exit and cleanup</li>
<li>Use <code>std::io::Error::last_os_error</code> for IO Errors to remove <code>FormatMessage</code> complexity</li>
<li>Use <code>std::env::current_exe</code> to get the current executable instead of <code>GetModuleFileNameA</code></li>
</ul>
<p>In addition, this PR also includes</p>
<ul>
<li>Switching to using <code>Command</code> instead of <code>CreateProcessA</code> and remove the need for CLI argument parsing</li>
<li>Switching to use <code>std::env::args_os</code> instead of <code>GetCommandLineA</code></li>
</ul>
<h2>Test Plan</h2>
<p>Existings tests / local tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2024-08-03 14:48</div>
            <div class="timeline-body"><p>CC @konstin since you already pre-reviewed some of the changes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2024-08-08 02:00</div>
            <div class="timeline-body"><p>Closing as #5750 was merged. We can revisit the removal of <code>CreateProcessA</code>, <code>GetCommandLineA</code> and <code>Win32_System_Environment</code> in the future and this can serve as an example if we want a working example.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @samypr100 on 2024-08-08 02:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 13:32:10 UTC
    </footer>
</body>
</html>
