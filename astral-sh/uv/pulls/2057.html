<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prioritize `PATH` over `py --list-paths` in Windows selection - astral-sh/uv #2057</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Prioritize <code>PATH</code> over <code>py --list-paths</code> in Windows selection</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/2057">#2057</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-02-28 22:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-28 22:02</div>
            <div class="timeline-body"><p><code>uv --system</code> is failing in GitHub Actions, because <code>py --list-paths</code> returns all the pre-cached Pythons:</p>
<pre><code>-V:3.12 *        C:\hostedtoolcache\windows\Python\3.12.2\x64\python.exe
-V:3.12-32       C:\hostedtoolcache\windows\Python\3.12.2\x86\python.exe
-V:3.11          C:\hostedtoolcache\windows\Python\3.11.8\x64\python.exe
-V:3.11-32       C:\hostedtoolcache\windows\Python\3.11.8\x86\python.exe
-V:3.10          C:\hostedtoolcache\windows\Python\3.10.11\x64\python.exe
-V:3.10-32       C:\hostedtoolcache\windows\Python\3.10.11\x86\python.exe
-V:3.9           C:\hostedtoolcache\windows\Python\3.9.13\x64\python.exe
-V:3.9-32        C:\hostedtoolcache\windows\Python\3.9.13\x86\python.exe
-V:3.8           C:\hostedtoolcache\windows\Python\3.8.10\x64\python.exe
-V:3.8-32        C:\hostedtoolcache\windows\Python\3.8.10\x86\python.exe
-V:3.7           C:\hostedtoolcache\windows\Python\3.7.9\x64\python.exe
-V:3.7-32        C:\hostedtoolcache\windows\Python\3.7.9\x86\python.exe
</code></pre>
<p>So, our default selector returns the first entry here. But none of these are actually in <code>PATH</code> except the one that the user installed via <code>actions/setup-python@v5</code> -- that's the point of the action, that it puts the correct versions in <code>PATH</code>.</p>
<p>It seems to me like we should prioritize <code>PATH</code> over <code>py --list-paths</code>. Is there a good reason not to do this?</p>
<p>Closes: https://github.com/astral-sh/uv/issues/2056</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @charliermarsh on 2024-02-28 22:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-28 22:02</div>
            <div class="timeline-body"><p>\cc @AlexWaygood</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Debug GitHub Actions failures for Python 3.10 on Windows" to "Prioritize `PATH` over `py --list-paths` in Windows selection" by @charliermarsh on 2024-02-29 01:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2024-02-29 01:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @charliermarsh on 2024-02-29 01:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2024-02-29 01:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-02-29 01:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2024-02-29 01:37</div>
            <div class="timeline-body"><p>This seems like a good idea to me and what users would expect to happen.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-02-29 02:10</div>
            <div class="timeline-body"><p>I thought we did this already, maybe it's gone back and forth a bit during development. Makes sense to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-29 02:12</div>
            <div class="timeline-body"><p>(Continuing from the issue...) I'm surprised because virtualenv does seem to do registry-based lookups before PATH. But I suppose for virtualenv it matters less, since the priority is getting the right <em>version</em>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-29 02:15</div>
            <div class="timeline-body"><p>I see Micha's change that added the fallback to <code>PATH</code>: https://github.com/astral-sh/uv/pull/1711.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2024-02-29 02:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2024-02-29 02:28</div>
            <div class="timeline-body"><p>Also great because the overhead of a separate process is eliminated in most cases! I'm very excited for this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>.github/workflows/system-install.yml</code>:71 on 2024-02-29 07:21</div>
            <div class="timeline-body"><p>Remove?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-02-29 07:30</div>
            <div class="timeline-body"><blockquote>
<p>This seems like a good idea to me and what users would expect to happen.</p>
</blockquote>
<p>I think this is a bit more nuanced and depends on your workflow and how you installed python. Users using <code>py</code> (over <code>python</code>) may have an additional installation on their <code>PATH</code>.  For them, picking <code>PATH</code> over the default used by <code>py</code> can be surprising.</p>
<p>The reason <code>virtual</code> doesn't run into this problem is that it always tries to use the current Interpreter (in which it is running) first. It then doesn't matter whether a user uses <code>python</code> or <code>py</code> or a shim to run python.</p>
<p>The challenge we face is that we can't rely on the &quot;current python&quot; instance, so we have to approximate it as best as we can and using <code>PATH</code> first probably does the right thing in more cases than using <code>py</code> first, with the exception for users using <code>py</code> with another python installation on <code>PATH</code>.</p>
<blockquote>
<p>Also great because the overhead of a separate process is eliminated in most cases! I'm very excited for this.</p>
</blockquote>
<p>We planned to re-implement the registry lookup in Rust, in which case the PATH traversal is most likely slower, especially when we can't find a python installation on PATH and need to fall-back to <code>py</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-02-29 07:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/uv-interpreter/src/python_query.rs</code>:189 on 2024-02-29 07:32</div>
            <div class="timeline-body"><p>This comment is outdated. We should remove this branch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/uv-interpreter/src/python_query.rs</code>:191 on 2024-02-29 07:33</div>
            <div class="timeline-body"><p>This message is outdated. We already tried searching the PATh. We should keep the graceful recovery</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-02-29 07:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-02-29 08:45</div>
            <div class="timeline-body"><p>A minor feature we're losing is that <code>py</code> is intended to be the main tool on windows and has a friendly UX (<code>py -0</code>) that avoids dealing with <code>PATH</code> on windows (which is hidden in a GUI behind another GUI, it's nothing like adding a line in your <code>.bashrc</code> on linux).</p>
<p>From <a href="https://peps.python.org/pep-0514/">PEP 514</a>:</p>
<blockquote>
<p>This PEP defines a schema for the Python registry key to allow third-party installers to register their installation, and to allow tools and applications to detect and correctly display all Python environments on a userâ€™s machine. No implementation changes to Python are proposed with this PEP.</p>
</blockquote>
<blockquote>
<p>Python environments are not required to be registered unless they want to be automatically discoverable by external tools.</p>
</blockquote>
<p>In this sense github actions is at odds with the PEP, the versions shouldn't be in the registry if not selected by the setup python action (or setup python should at least ensure that <code>py</code> has the right default).</p>
<p>I think either choice of precedence between <code>PATH</code> and <code>py</code> is fine for us to make, both are standards, one of posix-and-windows ubiquity, the other of PEP 514, and if the user wants a specific python version they can pass it explictly. In this case i agree that we can't break github actions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>.github/workflows/system-install.yml</code>:4 on 2024-02-29 08:47</div>
            <div class="timeline-body"><pre><code class="language-suggestion"></code></pre>
<p>(Am i understanding correctly that this should only be running manually?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-02-29 08:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-02-29 10:38</div>
            <div class="timeline-body"><p>I agree that this is the right way to go.</p>
<p>FWIW, I always tick the &quot;add to PATH&quot; box when installing Python on Windows. I have a vague memory of things going wrong (or, not working the way I expected to) the one time I didn't do that. But that was a very long time ago, and it might very well be that I've just been cargo-culting from old tutorials that predated PEP-514 this whole time <code>Â¯\_(ãƒ„)_/Â¯</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2024-02-29 14:08</div>
            <div class="timeline-body"><p>FYI I wrote a bit here https://github.com/astral-sh/uv/issues/2056#issuecomment-1971209233 the relevant part is:</p>
<blockquote>
<p>I have been exclusively a Windows user my entire life. I cannot express enough how few people use the <code>py</code> launcher and how often the registry stuff is unused.</p>
</blockquote>
<p>ðŸ™‚</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>.github/workflows/system-install.yml</code>:4 on 2024-02-29 14:50</div>
            <div class="timeline-body"><p>Yup! This is just set so I can test it during development of this PR. It will be removed prior to landing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-29 14:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">windows</span> added by @charliermarsh on 2024-02-29 15:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-02-29 15:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-02-29 15:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-02-29 15:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-29 15:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>.github/workflows/system-install.yml</code>:71 on 2024-02-29 15:10</div>
            <div class="timeline-body"><p>(Intentionally kept this change.)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 14:55:03 UTC
    </footer>
</body>
</html>
