<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enable extra build dependencies to 'match runtime' versions - astral-sh/uv #15036</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Enable extra build dependencies to 'match runtime' versions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/15036">#15036</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2025-08-03 00:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This is an alternative to https://github.com/astral-sh/uv/pull/14944 that functions a little differently. Rather than adding separate strategies, you can instead say:</p>
<pre><code class="language-toml">[tool.uv.extra-build-dependencies]
child = [{ requirement = &quot;anyio&quot;, match-runtime = true }]
</code></pre>
<p>Which will then enforce that <code>anyio</code> uses the same version as in the lockfile.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">no-build</span> added by @charliermarsh on 2025-08-03 00:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">no-test</span> added by @charliermarsh on 2025-08-03 00:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @charliermarsh on 2025-08-03 00:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-08-03 00:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/sync.rs</code>:742 on 2025-08-03 00:51</div>
            <div class="timeline-body"><p>These are blockers but conceptually doable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-08-03 02:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/sync.rs</code>:742 on 2025-08-03 02:17</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/uv/pull/15038 should help.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-04 23:40</div>
            <div class="timeline-body"><p>(Need to rebase this, then fix the TODO I commented-on above.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2025-08-05 10:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">no-test</span> removed by @charliermarsh on 2025-08-05 10:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @charliermarsh on 2025-08-05 10:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-05 10:18</div>
            <div class="timeline-body"><p>I addressed the remaining TODOs, should be ready for review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @geofft by @charliermarsh on 2025-08-05 12:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2025-08-05 12:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/sync.rs</code>:12596 on 2025-08-05 14:37</div>
            <div class="timeline-body"><p>We should call this <code>requires</code> instead of <code>requirement</code> to by consistent with PEP 517 (It's still a str here and a list in PEP 517, but it's the same key)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/sync.rs</code>:12631 on 2025-08-05 14:42</div>
            <div class="timeline-body"><p>Can you add a test where we change the requirement in a compatible way (say <code>anyio&gt;3.1</code> to <code>anyio&gt;3.2</code>) to track whether we rebuild?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-distribution-types/src/resolved.rs</code>:107 on 2025-08-05 14:47</div>
            <div class="timeline-body"><p>This should be deduplicated, with <code>impl From&lt;&amp;ResolvedDist&gt; for RequirementSource</code>. (There's currently a difference with <code>location.set_fragment(None)</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-08-05 14:59</div>
            <div class="timeline-body"><p>Is it intentional that extra build dependencies work in <code>uv pip</code> too, but <code>match-runtime = true</code> is limited to project mode, while being ignore in <code>uv pip</code> mode? (I can make an MRE if helpful)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-05 15:01</div>
            <div class="timeline-body"><p>We could make it work in <code>uv pip</code>, probably.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-05 15:06</div>
            <div class="timeline-body"><p>It seems fine to defer that to start.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-05 15:07</div>
            <div class="timeline-body"><p>It could help inform the name though... If we intend for that to work, then it's another point against things like <code>locked</code> or <code>match-lockfile</code> etc.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-05 15:16</div>
            <div class="timeline-body"><p>This name has sort of grown on me, fwiw. The entire field is in preview too, so we have some leeway here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-08-05 15:20</div>
            <div class="timeline-body"><p>I'm always in favor of smaller PRs and adding this another PR :) I do see the current behavior (<code>match-runtime</code> is ignored in <code>uv pip</code> without warning) as a blocker to stabilization, we should interpret the extra build deps table the same between project mode and <code>uv pip</code> for extra build dependencies.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-distribution-types/src/build_requires.rs</code>:52 on 2025-08-05 15:23</div>
            <div class="timeline-body"><p>What about only having <code>AnnotatedBuildRequirement</code> with <code>match_runtime: Option&lt;bool&gt;</code>, to having to match on the two cases? This would allow us to <code>Either</code> too. The only place where we'd still need the enum is in the deserialize impl.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-08-05 15:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-05 16:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/it/sync.rs</code>:12596 on 2025-08-05 16:11</div>
            <div class="timeline-body"><p>I don't think I agree — I don't think that's particularly clearer and matching <code>build-requires</code> isn't really a goal here, i.e., it's not called <code>extra-build-requires</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-08-05 16:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-distribution-types/src/build_requires.rs</code>:52 on 2025-08-05 16:42</div>
            <div class="timeline-body"><p>That sounds reasonable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-08-05 16:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-distribution-types/src/resolved.rs</code>:107 on 2025-08-05 16:43</div>
            <div class="timeline-body"><p>Oh perfect, thank you. I was looking for that...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-05 16:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/sync.rs</code>:821 on 2025-08-05 16:48</div>
            <div class="timeline-body"><p>It feels a little weird that this isn't a method on <code>ExtraBuildRequires</code> are you avoiding some circular dependency?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-05 16:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/sync.rs</code>:821 on 2025-08-05 16:49</div>
            <div class="timeline-body"><p>Should it be must use?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-05 16:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/sync.rs</code>:852 on 2025-08-05 16:52</div>
            <div class="timeline-body"><p>I'm a little confused here. Why do we toggle it to <code>false</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/sync.rs</code>:829 on 2025-08-05 16:53</div>
            <div class="timeline-body"><p>What happens if the requirement has a pin or constraint that's incompatible with the runtime dist version? We should error, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-05 16:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-08-05 16:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/sync.rs</code>:852 on 2025-08-05 16:54</div>
            <div class="timeline-body"><p>That's an oversight, sorry. I think this value doesn't matter from here on out. We could probably use a different type post-transform but seems like a lot of work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-08-05 16:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/sync.rs</code>:829 on 2025-08-05 16:55</div>
            <div class="timeline-body"><p>I was considering erroring entirely if a version specifier or constraint is provided with <code>match-runtime = true</code>. What do you think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-08-05 16:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/sync.rs</code>:821 on 2025-08-05 16:56</div>
            <div class="timeline-body"><p>I'm just matching the style of the rest of the file, but I suspect it could be a method on <code>ExtraBuildRequires</code> yeah.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-08-05 17:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/sync.rs</code>:829 on 2025-08-05 17:00</div>
            <div class="timeline-body"><p>It would be relatively easy to support preserving <em>both</em> though. We'd just add a new requirement here rather than overwriting, and let the resolver do the rest.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/sync.rs</code>:829 on 2025-08-05 17:07</div>
            <div class="timeline-body"><p>It seems okay to eagerly fail if any constraint is provided. It's plausible someone will have a use-case for it? but I can't think of one right now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-05 17:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-05 17:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/sync.rs</code>:829 on 2025-08-05 17:08</div>
            <div class="timeline-body"><p>I think letting the resolver handle it sounds cool, but we'd probably need to add a hint to the error for it to be a good experience and that sounds like more work we don't want to tackle rn.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-05 17:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/sync.rs</code>:852 on 2025-08-05 17:09</div>
            <div class="timeline-body"><p>Okay cool, that makes sense — I thought maybe we were trying to toggle it to <code>false</code> to indicate it. I think a different type seems overkill. I'd probably retain <code>true</code> though in case we need to do some debugging or hinting based on that information later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2025-08-05 17:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-08-05 17:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/sync.rs</code>:829 on 2025-08-05 17:39</div>
            <div class="timeline-body"><p>Okay, made it reject for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2025-08-05 18:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-08-05 18:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-05 18:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:44:13 UTC
    </footer>
</body>
</html>
