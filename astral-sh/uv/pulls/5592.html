<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detect python version from python project by default in `uv venv` - astral-sh/uv #5592</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Detect python version from python project by default in <code>uv venv</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/5592">#5592</a>
        opened by <a href="https://github.com/Vigilans">@Vigilans</a>
        on 2024-07-30 09:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/Vigilans">@Vigilans</a> on 2024-07-30 09:39</div>
            <div class="timeline-body"><!--
Thank you for contributing to uv! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<!-- What's the purpose of the change? What does it do, and why? -->

<p><code>uv venv</code> should support adopting python version specified in <code>requires-python</code> from <code>pyproject.toml</code>. This allows customization on the venv setup when syncing from python project.</p>
<p>Closes https://github.com/astral-sh/uv/issues/5552.</p>
<p>It also serves as a workaround to close https://github.com/astral-sh/uv/issues/5258.</p>
<h2>Test Plan</h2>
<!-- How was it tested? -->

<ol>
<li>Run <code>uv venv</code> in folder with <code>pyroject.toml</code> specifying <code>requries-python = &quot;&lt;3.10&quot;</code>. Python 3.9 is selected for venv.</li>
<li>Change to <code>requries-python = &quot;&lt;3.11&quot;</code> and run <code>uv venv</code> again. Python 3.10 is selected now.</li>
<li>Switch to a folder without <code>pyproject.toml</code> then run <code>uv venv</code>. Python 3.12 is selected now.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Vigilans">@Vigilans</a> on <code>crates/uv/src/commands/venv.rs</code>:168 on 2024-07-30 09:42</div>
            <div class="timeline-body"><p>Code here is adopted from <code>run.rs</code>:
https://github.com/astral-sh/uv/blob/c0d3da8b6ae134036b3ed024762b08c4fb9f967b/crates/uv/src/commands/project/run.rs#L176-L182
and <code>FoundInterpreter</code> in <code>mod.rs</code>:
https://github.com/astral-sh/uv/blob/c0d3da8b6ae134036b3ed024762b08c4fb9f967b/crates/uv/src/commands/project/mod.rs#L158-L172</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Vigilans">@Vigilans</a> reviewed on 2024-07-30 09:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-07-30 12:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-07-30 12:32</div>
            <div class="timeline-body"><p>Can you add a test for this in <code>tests/venv.rs</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by @charliermarsh on 2024-07-30 12:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @charliermarsh on 2024-07-30 12:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/T-256">@T-256</a> on 2024-07-30 13:39</div>
            <div class="timeline-body"><p>When initializing python project, it is common to specify minimum version in pyproject.toml (e.g. <code>requires-python = &quot;&gt;=3.8&quot;</code>). Within development of project, we need to have minimum supported environment to avoid using newest features that is unavailable in minimum required python version.</p>
<p>Is it make sense to have an option to change resolution strategy for python discovery? just like <code>--resolution</code> for dependencies resolver.</p>
<h3>Example</h3>
<p><code>pyproject.toml</code></p>
<pre><code class="language-toml">[project]
requires-python = &quot;&gt;=3.8&quot;
</code></pre>
<p>By using <code>uv venv --python-resolution=lowest-minor</code> it will select <code>3.8.19</code>. (IIRC, this is default behavior of Rye?!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-30 14:17</div>
            <div class="timeline-body"><p>Note this interacts with some work-in-progress at https://github.com/astral-sh/uv/pull/5035; specifically the <a href="https://github.com/astral-sh/uv/compare/zb/pin-find#diff-008a5d315b289d3a263e6f01768b573a21e6958fffeb19af6ae3140c84a53fe0R143-R155">merged lines on my branch</a>. I don't think that should block this change though.</p>
<p>We'll also need to consider the following in the future (no changes needed here):</p>
<ul>
<li>https://github.com/astral-sh/uv/issues/4971</li>
<li>https://github.com/astral-sh/uv/issues/4970</li>
<li>https://github.com/astral-sh/uv/issues/5228</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-30 14:20</div>
            <div class="timeline-body"><p>I am tempted to agree that we should be selecting the lowest compatible version by default? This is tough to balance, as it's nice to get the performance and error handling improvements of a newer release. It may make sense to just expose a way to use the lowest compatible version instead (as suggested by @T-256) so it's easy to do in CI? However, I think in that case you'd want to actually guarantee you're getting the lowest version not the one nearest to your lower bound?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/T-256">@T-256</a> on 2024-07-30 15:54</div>
            <div class="timeline-body"><blockquote>
<p>I am tempted to agree that we should be selecting the lowest compatible version by default?</p>
</blockquote>
<p>Another case for inconsistency: today if you specify <code>requires-python = &quot;&gt;=3.10&quot;</code> and <code>uv venv</code> it will create 3.12 environment, but in next year when a contributor wants init an environment, it would be 3.13 which brings different development environments.
IMO, this is not a big concern since it could be solved by <code>.python-version</code> file. then I think we should be stricter on python version resolving and tip users to use (and also commit) <code>.python-version</code> file.</p>
<blockquote>
<p>However, I think in that case you'd want to actually guarantee you're getting the lowest version not the one nearest to your lower bound?</p>
</blockquote>
<p>Yes, it is makes sense to be strict on there. for example, with <code>requires-python = &quot;&gt;=3.10&quot;</code> and installed python 3.12, it should download and use 3.10. in cases which download is unavailable it should fail with error.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/T-256">@T-256</a> on 2024-07-30 16:00</div>
            <div class="timeline-body"><blockquote>
<p>It may make sense to just expose a way to use the lowest compatible version instead (as suggested by @T-256) so it's easy to do in CI?</p>
</blockquote>
<p>@zanieb what if minimum version is not provided and only used lower-bound? for example <code>requires-python = &quot;&lt;3.12&quot;</code> should select which python version when used with that shipped option (assume <code>--python-resolution=lowest-minor</code>)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Vigilans">@Vigilans</a> on 2024-07-30 16:06</div>
            <div class="timeline-body"><p>I prefer to use the newest version.</p>
<p>Pros:</p>
<ul>
<li>For users who want to stick to specific python version, they will use <code>== 3.8.*</code> or <code>&gt;=3.8,&lt;3.9</code>.</li>
<li>For users who specify only lower bound, using newest python version that breaks their project, is a hint to users that they should set upper bound to their <code>pyproject.toml</code>. This helps make their specification more robust.</li>
</ul>
<p>Cons:</p>
<ul>
<li>For non-author users cloning the project, they may fail to run the project because the selected version is too new. Even users add the newer version to upper bound, it may be hard to sync the change to upstream.</li>
</ul>
<p>A flag altering this behavior to use lowest possible version should be introduced indeed to ensure stable build in CI like docker image building, or for build script/devcontainer to ensure end users can run on happy path after their cloning.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-30 16:27</div>
            <div class="timeline-body"><p>Note we basically never recommend adding an upper bound to Python version constraints and actively ignore it in some contexts.</p>
<blockquote>
<p>in next year when a contributor wants init an environment, it would be 3.13 which brings different development environments.</p>
</blockquote>
<p>Yeah this problem is solved by encouraging pin of the version (see also #4970)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Vigilans">@Vigilans</a> on <code>crates/uv/tests/venv.rs</code>:335 on 2024-07-30 16:28</div>
            <div class="timeline-body"><p>I found that the default behavior for <code>&gt;=3.x</code> is not <strong>select newest version</strong>, but <strong>select first possible version</strong> in the list. For a python list <code>[3.11, 3.10, 3.12]</code>:</p>
<ul>
<li><code>&gt;=3.10</code> will select <code>3.11</code>.</li>
<li><code>&gt;=3.11</code> will select <code>3.11</code>.</li>
<li><code>&gt;3.11</code> will select <code>3.11</code> (becuase <code>3.11.x</code> &gt; <code>3.11</code>).</li>
<li><code>&gt;=3.12</code> will select <code>3.12</code>.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Vigilans">@Vigilans</a> reviewed on 2024-07-30 16:29</div>
            <div class="timeline-body"><p>Test added. Found some more behaviors that should be reviewed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/T-256">@T-256</a> on 2024-07-30 16:36</div>
            <div class="timeline-body"><blockquote>
<p>I prefer to use the newest version.</p>
</blockquote>
<p>@Vigilans I Agree, And I think it could be opt-in to that behavior.</p>
<p>created https://github.com/astral-sh/uv/issues/5609 to track it separately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-07-30 19:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/tests/venv.rs</code>:295 on 2024-07-30 19:50</div>
            <div class="timeline-body"><p>Should this be 3.11?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-07-30 19:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/tests/venv.rs</code>:319 on 2024-07-30 19:50</div>
            <div class="timeline-body"><p>Should this be 3.12?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Vigilans">@Vigilans</a> on <code>crates/uv/tests/venv.rs</code>:319 on 2024-07-31 00:03</div>
            <div class="timeline-body"><p>Wow, I got these tests code totally wrong! Since the commit is pushed near my bed time I did not check them carefully after pasting. Good news that tests still pass after correction. Apology for my carelessness.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Vigilans">@Vigilans</a> reviewed on 2024-07-31 00:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-07-31 13:32</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2024-07-31 13:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-07-31 13:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 13:37:39 UTC
    </footer>
</body>
</html>
