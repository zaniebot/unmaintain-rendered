<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lenient handling of relative path dependencies - astral-sh/uv #3949</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Lenient handling of relative path dependencies</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/3949">#3949</a>
        opened by <a href="https://github.com/idlsoft">@idlsoft</a>
        on 2024-05-31 21:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/idlsoft">@idlsoft</a> on 2024-05-31 21:11</div>
            <div class="timeline-body"><!--
Thank you for contributing to uv! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p><code>uv</code> doesn't handle relative paths in dependencies very well.</p>
<p>This  came to my attention while using <code>rye</code>.
In my <code>pyproject.toml</code> files I would have dependencies like</p>
<pre><code>&quot;mylib @ ./../mylib&quot;
</code></pre>
<p>But <code>uv</code> would complain about the path not being absolute.</p>
<p>I wrote a unittest to demostrate the problem.</p>
<p>I believe the reason for it failing is in couple of places, deserializing <code>LenientRequirement</code> either from a <code>pyproject.toml</code> or from wheel metadata. In both cases it ends up calling <code>Requirement::from_str()</code> and fails.</p>
<p>I'll try to see if I can write a fix, would welcome any feedback.</p>
<h2>Test Plan</h2>
<p>The test currently fails, should turn green when a fix is implemented</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-05-31 21:17</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/uv/branches/idlsoft:relpath-dependencies">CodSpeed Performance Report</a></h2>
<h3>Merging #3949 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>idlsoft:relpath-dependencies</code> (5ed28ad) with <code>main</code> (ef43bcb)</sub></p>
<h3>Summary</h3>
<p><code>âœ… 13</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-31 21:41</div>
            <div class="timeline-body"><p>This is intentional though -- relative paths are not allowed under PEP 508, and requirements in <code>pyproject.toml</code> have to follow PEP 508. Allowing relative paths here would be a spec violation unfortunately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/idlsoft">@idlsoft</a> on 2024-05-31 21:56</div>
            <div class="timeline-body"><blockquote>
<p>This is intentional though -- relative paths are not allowed under PEP 508, and requirements in <code>pyproject.toml</code> have to follow PEP 508. Allowing relative paths here would be a spec violation unfortunately.</p>
</blockquote>
<p>Yes I did notice comments on that subject, but also a bunch of <code>#[cfg(feature = &quot;non-pep508-extensions&quot;)]</code> code.
This would ultimately defer to that code, just give it more context.</p>
<p>Are there any other recommended ways to support a monorepo-like project tree?
FWIW hatchling is perfectly happy with it. It also has its own <code>{root:uri}</code> and the like, but have <code>uv</code> understand all these variations seems hackier.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-01 00:34</div>
            <div class="timeline-body"><p>Can you say more about what you mean by &quot;FWIW hatchling is perfectly happy with it&quot;? I don't think you can <code>pip install</code> a package that uses Hatchling as a backend if that package has a relative path in its <code>project.dependencies</code>. Do you mean that Hatchling lets you <em>build</em> a package with a relative path?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/idlsoft">@idlsoft</a> on 2024-06-01 01:57</div>
            <div class="timeline-body"><p>Sorry, I guess that didn't make a lot of sense. Yes, it can build it. Which is kinda irrelevant in this context.
The reason I brought it up, is I'm trying to solve a problem that kinda involves both <code>hatchling</code> and <code>uv</code>.</p>
<p>I have a source tree with python projects, some are libraries, some are deployable apps.
Every python project has its own <code>pyproject.toml</code> managed by <code>rye</code> with dependencies, both binary and direct to other projects.</p>
<p>I want to be able to:</p>
<ul>
<li>create a venv for any project with all its transitive dependencies, preferably pointing directly to sources whenever possible.
This would help coding, unittesting etc.</li>
<li>build a publishable wheel/sourcedist for libraries.
Publishable means that direct dependencies are automatically normalized from <code>mylib @ ../mylib</code> to something like <code>mylib == 1.0.9</code>.  I already have a hatchling build hook for this, which is probably why I mentioned it.</li>
<li>collect all dependencies as wheel files sort of like <code>pip download</code> for packaging/dockerbuild etc</li>
</ul>
<p>Ideally I'd like to have something closer to cargo's <code>mylib { workspace = true }</code> but then some other tool will complain. Leniency on relative paths seems like a fairly practical solution.</p>
<p>Btw I may be close to turning that unit-test green, hope you'll consider it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Unittest for relative path dependencies" to "Lenient handling of relative path dependencies" by @idlsoft on 2024-06-01 04:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @idlsoft on 2024-06-01 04:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-01 12:30</div>
            <div class="timeline-body"><p>I'm undecided on supporting relative paths in <code>pyproject.toml</code> -- we plan to support the workflow you're describing with <code>tool.uv.sources</code> which allows you to enrich your dependencies in the way you've described above. It already exists today and supports Cargo-like workspaces but it's still in preview and not yet advertised or intended for public use. There are some basic docs around it in <code>docs/specifying_dependencies.md</code> but, again, it's under active development.</p>
<p>In the meantime, we <em>do</em> respect <code>${PROJECT_ROOT}</code> which is currently an alias for <code>${PWD}</code>:</p>
<pre><code>&quot;mylib @ file://${PROJECT_ROOT}/../mylib&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/idlsoft">@idlsoft</a> on 2024-06-01 15:35</div>
            <div class="timeline-body"><blockquote>
<p>I'm undecided on supporting relative paths in pyproject.toml</p>
</blockquote>
<p>I would not suggest supporting it officially, more like letting it slide. There are still pitfalls there, especially if the structure is anything but sibling directories.</p>
<blockquote>
<p>It already exists today and supports Cargo-like workspaces but it's still in preview</p>
</blockquote>
<p>I actually stumbled upon this later, saw all the <code>= { workspace = true }</code> mentions.
This looks great, and obviously a much, much better way of handling it.
There is a lot of potential here.
It would be cool to allow some workspace-related functionality like iterating over dependencies and dependents, for example.
Do you plan to have your own build backend eventually?
You may have to, if you wanted to write fully resolved workspace dependency versions into <code>METADATA</code>.
Or if you wanted to have shared default dependency versions in the workspace, shared default constraints, overrides.</p>
<blockquote>
<p>In the meantime, we <em>do</em> respect <code>${PROJECT_ROOT}</code> which is currently an alias for <code>${PWD}</code>:</p>
</blockquote>
<p>I tried that, but this gets <code>hatchling</code> upset. I tries to dereference everything that looks like<code>{...}</code> according to its own rules. There is also a potential issue of <code>rye lock</code> generating non portable lock files.</p>
<p>Btw it turns out my PR breaks <code>${PROJECT_ROOT}</code>, probably because there is a relative-&gt;absolute path conversion somewhere before it gets dereferenced.
I'll look into it.
... I used it without <code>file://</code>, maybe that's not meant to work, but it was still happier before my changes.
... looked into it, turns out <code>rye</code> removes the leading <code>/</code> to make <code>file:///${PROJECT_ROOT}</code> work, so no breakages.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/noamraph">@noamraph</a> on 2024-06-09 08:19</div>
            <div class="timeline-body"><p>@charliermarsh @idlsoft sorry for jumping into the PR, but perhaps it will be relevant. I'm looking for a solution for the exact same issue. I have a question: it seems to me that using relative paths is already supported when using <code>requirements.in</code> files, when using <code>-r ../path/to/other/requirements.in</code>. Am I correct? Does it mean that a reasonable way to achieve a Cargo-like
workspace using what's stable right now is to use <code>requirements.in</code> and <code>uv pip compile</code>?</p>
<p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/idlsoft">@idlsoft</a> on 2024-07-18 20:50</div>
            <div class="timeline-body"><p>The use-case is supported using</p>
<pre><code class="language-toml">[tool.uv.sources]
shared_lib = { path = &quot;../mylib&quot;, editable = true}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @idlsoft on 2024-07-18 20:50</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 13:43:10 UTC
    </footer>
</body>
</html>
