<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add a `uv self update` command - astral-sh/uv #2228</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add a <code>uv self update</code> command</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/2228">#2228</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-03-06 05:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Powered by Axo: https://github.com/axodotdev/axoupdater.</p>
<p>Closes https://github.com/astral-sh/uv/issues/1591.</p>
<h2>Test Plan</h2>
<p>To test locally:</p>
<ul>
<li><code>rm -f ~/.config/uv/uv-receipt.json /Users/crmarsh/.cargo/bin/uv</code></li>
<li><code>curl --proto '=https' --tlsv1.2 -LsSf https://github.com/astral-sh/uv/releases/download/0.1.14/uv-installer.sh | sh</code></li>
<li><code>cargo run self update</code></li>
</ul>
<p>Up-to-date:</p>
<p><img src="https://github.com/astral-sh/uv/assets/1309177/04bb7a11-6557-4317-8e86-18288fbc13c6" alt="Screenshot 2024-03-06 at 12 13 36 AM" /></p>
<p>Updated:</p>
<p><img src="https://github.com/astral-sh/uv/assets/1309177/c08ad739-5a2b-47cf-bf13-018a8d708330" alt="Screenshot 2024-03-06 at 12 13 54 AM" /></p>
<p>No receipt:</p>
<p><img src="https://github.com/astral-sh/uv/assets/1309177/317bbfaf-a787-4cbf-9f93-a4ce8ca7a988" alt="Screenshot 2024-03-06 at 12 14 13 AM" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2024-03-06 05:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @charliermarsh on 2024-03-06 05:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2024-03-06 05:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/self_update.rs</code>:40 on 2024-03-06 06:00</div>
            <div class="timeline-body"><p>This is actually wrong, because it'll be the release of the version that's being replaced IIUC. I've filed a request to get <code>receipt.run()</code> to return the <em>new</em> version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-06 06:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/src/commands/self_update.rs</code>:21 on 2024-03-06 09:01</div>
            <div class="timeline-body"><p>nit: long line</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/src/main.rs</code>:125 on 2024-03-06 09:03</div>
            <div class="timeline-body"><p>Why is it hidden?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-03-06 09:29</div>
            <div class="timeline-body"><p>Found an upstream bug: https://github.com/axodotdev/axoupdater/issues/34</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/src/commands/self_update.rs</code>:29 on 2024-03-06 09:57</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    let was_updated = receipt.run().await.map_err(|err| {
        if let AxoupdateError::Reqwest(err) = err {
            anyhow::Error::new(BetterReqwestError::from(err))
        } else {
            anyhow::Error::new(err)
        }
    })?;
    if was_updated {
</code></pre>
<p><strong>before</strong></p>
<pre><code>error: error sending request for url (https://api.github.com/repos/astral-sh/uv/releases): error trying to connect: dns error: failed to lookup address information: Temporary failure in name resolution
  Caused by: error trying to connect: dns error: failed to lookup address information: Temporary failure in name resolution
  Caused by: dns error: failed to lookup address information: Temporary failure in name resolution
  Caused by: failed to lookup address information: Temporary failure in name resolution
</code></pre>
<p><strong>after</strong></p>
<pre><code>error: Could not connect, are you offline?
  Caused by: error sending request for url (https://api.github.com/repos/astral-sh/uv/releases): error trying to connect: dns error: failed to lookup address information: Temporary failure in name resolution
  Caused by: error trying to connect: dns error: failed to lookup address information: Temporary failure in name resolution
  Caused by: dns error: failed to lookup address information: Temporary failure in name resolution
  Caused by: failed to lookup address information: Temporary failure in name resolution
</code></pre>
<p>Still too verbose but clearer as to what went wrong.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-03-06 09:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/bluetech">@bluetech</a> on <code>crates/uv/src/commands/self_update.rs</code>:14 on 2024-03-06 13:20</div>
            <div class="timeline-body"><p>If I understand correctly...</p>
<pre><code class="language-suggestion">    // Load the &quot;install receipt&quot; for the current binary. If the receipt is not found, then
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bluetech">@bluetech</a> reviewed on 2024-03-06 13:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-06 13:44</div>
            <div class="timeline-body"><p>We may want to consider waiting for https://github.com/axodotdev/axoupdater/issues/34, and we definitely need to wait for axoupdater to give us the updated version back (since the current messages are incorrect).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-03-07 10:06</div>
            <div class="timeline-body"><p>Thinking about https://github.com/axodotdev/axoupdater/issues/34 again, should we feature gate the installer, so that pip/conda/distros can turn it off entirely? Seem safer than relying on recipe.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">do-not-merge</span> added by @zanieb on 2024-03-07 18:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mistydemeo">@mistydemeo</a> on 2024-03-08 03:52</div>
            <div class="timeline-body"><p>I've shipped a new version of axoupdater with a fix for axodotdev/axoupdater#34, but providing a way to turn off the <code>self update</code> feature entirely for certain distributions isn't a bad idea either.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-08 03:54</div>
            <div class="timeline-body"><p>One challenge we'd have there is that we build the standalone binaries as a side-effect of the PyPI wheels. So we'd need to do separate builds (which is doable).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/self_update.rs</code>:14 on 2024-03-08 05:02</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-08 05:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mistydemeo">@mistydemeo</a> on <code>crates/uv/src/commands/self_update.rs</code>:68 on 2024-03-08 05:08</div>
            <div class="timeline-body"><p>The actual tag is available too, in case it differs from the version number.</p>
<pre><code class="language-suggestion">                        result.new_version_tag
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mistydemeo">@mistydemeo</a> reviewed on 2024-03-08 05:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mistydemeo">@mistydemeo</a> on <code>crates/uv/src/commands/self_update.rs</code>:17 on 2024-03-08 05:13</div>
            <div class="timeline-body"><p>The return value here isn't actually the receipt - it's <code>self</code>. (This was written for chaining, eg <code>AxoUpdater::new_for(&quot;uv&quot;).load_receipt().run()</code>.) The actual install receipt's contents are members of the struct.</p>
<p>Doesn't matter much, just wanted to clarify in case this was confusing - I can update the naming in axoupdater in case that's helpful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mistydemeo">@mistydemeo</a> reviewed on 2024-03-08 05:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-08 05:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/self_update.rs</code>:17 on 2024-03-08 05:15</div>
            <div class="timeline-body"><p>Ahh right thank you! Also explains why <code>check_receipt_is_for_this_executable</code> can return an error if not loaded.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JacobCoffee">@JacobCoffee</a> on <code>crates/uv/src/commands/self_update.rs</code>:80 on 2024-03-10 02:57</div>
            <div class="timeline-body"><pre><code class="language-suggestion">                    &quot;{}{} Upgraded `uv` to {}! {}&quot;,
</code></pre>
<p>everywhere else besides these two places you wrap <code>uv</code> as `uv`</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/JacobCoffee">@JacobCoffee</a> on <code>crates/uv/src/commands/self_update.rs</code>:97 on 2024-03-10 02:57</div>
            <div class="timeline-body"><pre><code class="language-suggestion">                    &quot;{}{} You're on the latest version of `uv` ({}).&quot;,
</code></pre>
<p>also here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/JacobCoffee">@JacobCoffee</a> reviewed on 2024-03-10 02:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-03-19 09:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-03-19 20:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-03-19 20:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-03-19 20:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">do-not-merge</span> removed by @charliermarsh on 2024-03-19 20:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> added by @charliermarsh on 2024-03-19 20:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:35:57 UTC
    </footer>
</body>
</html>
