<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sort dependencies in `pyproject.toml` - astral-sh/uv #6388</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>sort dependencies in <code>pyproject.toml</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/6388">#6388</a>
        opened by <a href="https://github.com/ChannyClaus">@ChannyClaus</a>
        on 2024-08-21 23:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ChannyClaus">@ChannyClaus</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>resolves https://github.com/astral-sh/uv/issues/6203</p>
<h2>Test Plan</h2>
<p>added a test fixing the bug described in the issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Sort dependency" to "sort dependencies after `uv add`" by @ChannyClaus on 2024-08-21 23:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ChannyClaus">@ChannyClaus</a> on <code>crates/uv-workspace/src/pyproject_mut.rs</code>:524 on 2024-08-21 23:14</div>
            <div class="timeline-body"><p>seemed like this was going to be the cleanest way to get this done. while it can be wasteful (we may end up sorting every time we add a package if <code>uv add</code> invocation adds multiple packages?), i imagine most invocations of <code>uv add</code> will:</p>
<ol>
<li>add only a few dependencies manually</li>
<li>sorting is not expensive with the number of dependencies being sorted here
(probably?)</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ChannyClaus">@ChannyClaus</a> reviewed on 2024-08-21 23:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @ChannyClaus on 2024-08-21 23:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ChannyClaus">@ChannyClaus</a> on 2024-08-21 23:17</div>
            <div class="timeline-body"><p>fixing CI</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ChannyClaus">@ChannyClaus</a> reviewed on 2024-08-22 01:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ChannyClaus">@ChannyClaus</a> on <code>crates/uv-workspace/src/pyproject_mut.rs</code>:524 on 2024-08-22 01:49</div>
            <div class="timeline-body"><p>actually realized this probably isn't the correct fix since we probably should preserve the sorted order on removal as well.</p>
<p>will fix (maybe this weekend)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "sort dependencies after `uv add`" to "sort dependencies in `pyproject.toml`" by @ChannyClaus on 2024-08-22 02:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-08-22 09:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-workspace/src/pyproject_mut.rs</code>:524 on 2024-08-22 09:35</div>
            <div class="timeline-body"><p>We should only do this when the dependencies are already sorted, if the user has a custom sorting we shouldn't change that and just add at the end. So the idea would be that we first check if the list is sorted, and if it is, scan for the insertion point.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ChannyClaus">@ChannyClaus</a> reviewed on 2024-08-22 14:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ChannyClaus">@ChannyClaus</a> on <code>crates/uv-workspace/src/pyproject_mut.rs</code>:524 on 2024-08-22 14:47</div>
            <div class="timeline-body"><p>ahh good call.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ChannyClaus">@ChannyClaus</a> reviewed on 2024-08-25 22:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ChannyClaus">@ChannyClaus</a> on <code>crates/uv/tests/edit.rs</code>:4513 on 2024-08-25 22:44</div>
            <div class="timeline-body"><p>wanted to test the case where there's an empty line between dependencies (and it being preserved after <code>uv add</code>) but <code>uv add</code> seems to remove it currently - should probably be done as a separate PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ChannyClaus on 2024-08-26 03:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ChannyClaus">@ChannyClaus</a> reviewed on 2024-08-26 03:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ChannyClaus">@ChannyClaus</a> on <code>crates/uv-workspace/src/pyproject_mut.rs</code>:535 on 2024-08-26 03:30</div>
            <div class="timeline-body"><p>not 100% sure if it is correct to omit the comparison for <code>marker</code> here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @ChannyClaus on 2024-08-26 03:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-workspace/src/pyproject_mut.rs</code>:519 on 2024-08-26 09:23</div>
            <div class="timeline-body"><p>This should only pass when all values are strings. If they aren't the table is invalid; We could error, but for simplicity here it makes more sense to treat invalid files as unsorted, add our requirement to the end of the list and let it fail later when we try to use the pyproject.toml</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-workspace/src/pyproject_mut.rs</code>:524 on 2024-08-26 09:24</div>
            <div class="timeline-body"><p>For the sorted case: Since we don't parse change already requirements, we shouldn't deserialize and then <code>to_string()</code> them. Instead, we should convert the new requirement to a string and use this as comparison, finding the index with <code>partition_point</code> .</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-workspace/src/pyproject_mut.rs</code>:535 on 2024-08-26 09:26</div>
            <div class="timeline-body"><p>If the deps aren't sorted, we should just insert at the end</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-workspace/src/pyproject_mut.rs</code>:550 on 2024-08-26 09:27</div>
            <div class="timeline-body"><p>We don't need to assign this to a temporary variable (i think there's a clippy lint against this?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-08-26 09:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-08-26 12:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/edit.rs</code>:4037 on 2024-08-26 12:49</div>
            <div class="timeline-body"><p>We should avoid syncing here, otherwise the test will be slow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ChannyClaus">@ChannyClaus</a> reviewed on 2024-08-26 14:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ChannyClaus">@ChannyClaus</a> on <code>crates/uv-workspace/src/pyproject_mut.rs</code>:550 on 2024-08-26 14:27</div>
            <div class="timeline-body"><blockquote>
<p>If the deps aren't sorted, we should just insert at the end</p>
</blockquote>
<p>i believe the <code>index</code> points to the last position if the deps aren't sorted (one of the tests also covers this case)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ChannyClaus">@ChannyClaus</a> reviewed on 2024-08-26 15:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ChannyClaus">@ChannyClaus</a> on <code>crates/uv-workspace/src/pyproject_mut.rs</code>:524 on 2024-08-26 15:37</div>
            <div class="timeline-body"><p>let me look into this, it's slightly tricky since <code>.to_string()</code> on each of the dependencies yields strings of the form <code>\n    \&quot;CacheControl[filecache]&gt;=0.14,&lt;0.15\&quot;</code>; there may be a way to strip those relatively easily.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-08-26 15:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-workspace/src/pyproject_mut.rs</code>:524 on 2024-08-26 15:58</div>
            <div class="timeline-body"><p>There is a method in the <code>toml</code> crate that allows you to get the contained string value, instead of the string representation of the parsed field with decoration that <code>.to_string()</code> seems to use.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @konstin by @zanieb on 2024-08-26 18:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ChannyClaus">@ChannyClaus</a> reviewed on 2024-08-27 02:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ChannyClaus">@ChannyClaus</a> on <code>crates/uv-workspace/src/pyproject_mut.rs</code>:524 on 2024-08-27 02:21</div>
            <div class="timeline-body"><p>trimming the empty space + <code>\n</code> turned out to be pretty straight-forward but the formatting part is turning out to be trickier...</p>
<pre><code>        Value(
            String(
                Formatted {
                    value: &quot;sentry-sdk&quot;,
                    repr: &quot;\&quot;sentry-sdk\&quot;&quot;,
                    decor: Decor {
                        prefix: &quot;\n    &quot;,
                        suffix: empty,
                    },
                },
            ),
        ),
        Value(
            String(
                Formatted {
                    value: &quot;pydantic&quot;,
                    repr: &quot;default&quot;,
                    decor: Decor {
                        prefix: &quot; &quot;,
                        suffix: empty,
                    },
                },
            ),
        ),
</code></pre>
<p>where <code>reformat_array_multiline</code> seems to be operating under the assumption that only the last value of <code>deps</code> has an empty prefix.</p>
<pre><code>            deps.get_mut(deps.len() - 1)
                .unwrap()
                .decor_mut()
                .set_prefix(&quot;\n    &quot;);
</code></pre>
<p>it's possible to go with the partition solution still if we set the prefix manually for the inserted value and the last value, but it may be cleaner to just keep the current implementation?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-08-27 08:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-workspace/src/pyproject_mut.rs</code>:524 on 2024-08-27 08:16</div>
            <div class="timeline-body"><p>In this case we should update <code>reformat_array_multiline</code>. I'm confident that we should sort just by <code>d.as_str()</code> (without parsing and serializing), since this is the value that the user sees in the file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ChannyClaus">@ChannyClaus</a> reviewed on 2024-08-27 14:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ChannyClaus">@ChannyClaus</a> on <code>crates/uv-workspace/src/pyproject_mut.rs</code>:524 on 2024-08-27 14:37</div>
            <div class="timeline-body"><p>sounds good, i'll take a look again sometime.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ChannyClaus">@ChannyClaus</a> on 2024-08-27 22:20</div>
            <div class="timeline-body"><p>alright i think it's ready for another look @konstin</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ChannyClaus">@ChannyClaus</a> reviewed on 2024-08-27 22:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ChannyClaus">@ChannyClaus</a> on <code>crates/uv/tests/edit.rs</code>:4513 on 2024-08-27 22:53</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/uv/issues/6727? not sure if it's worth it, though, since it's strictly just a formatting nit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/edit.rs</code>:4513 on 2024-08-29 14:19</div>
            <div class="timeline-body"><p>Yeah #6727 sounds like a good candidate for a separate PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-08-29 14:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-08-29 14:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2024-08-29 14:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2024-08-29 14:55</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:39:03 UTC
    </footer>
</body>
</html>
