<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restore Docker image annotations and fix attestations - astral-sh/uv #14165</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Restore Docker image annotations and fix attestations</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/14165">#14165</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2025-06-20 17:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>More follow-up to #13459</p>
<ul>
<li>Depot doesn't support annotations, so we push those manually</li>
<li>Docker push for the re-tag was breaking the manifest, since we need to annotate manually, we just do that instead</li>
<li>We attest after the annotation</li>
</ul>
<p>A bit of an aside</p>
<ul>
<li>We test building the extra images, it's very fast and I don't see why it's better to gate it</li>
</ul>
<p>I tested this on my fork then cleaned it up a bit for a commit here. You can see the images at</p>
<ul>
<li>https://github.com/zanieb/uv/pkgs/container/uv</li>
<li>https://hub.docker.com/r/astral/uv/tags</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @zanieb on 2025-06-20 17:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zanieb on 2025-06-20 18:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-06-20 18:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.github/workflows/build-docker.yml</code>:307 on 2025-06-20 18:05</div>
            <div class="timeline-body"><p>This feels clunky, I presume there's a cleaner way to do this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-06-20 18:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.github/workflows/build-docker.yml</code>:326 on 2025-06-20 18:06</div>
            <div class="timeline-body"><p>These are just copied from the pre-Depot workflow</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-06-20 18:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.github/workflows/build-docker.yml</code>:416 on 2025-06-20 18:06</div>
            <div class="timeline-body"><p>See https://github.com/astral-sh/uv/pull/14165/files#r2159466956</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-06-20 18:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.github/workflows/build-docker.yml</code>:275 on 2025-06-20 18:10</div>
            <div class="timeline-body"><p>Hoping this is a brief problem https://github.com/depot/build-push-action/pull/38</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-06-20 18:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.github/workflows/build-docker.yml</code>:282 on 2025-06-20 18:11</div>
            <div class="timeline-body"><p>I'm not sure if this early attestation is needed or not</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @samypr100 by @samypr100 on 2025-06-21 02:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>.github/workflows/build-docker.yml</code>:306 on 2025-06-21 04:05</div>
            <div class="timeline-body"><pre><code class="language-suggestion">            readarray -t lines &lt; &lt;(grep &quot;^${image}:&quot; &lt;&lt;&lt; &quot;$TAGS&quot;); tags=(); for line in &quot;${lines[@]}&quot;; do tags+=(-t &quot;$line&quot;); done
            docker buildx imagetools create \
              &quot;${annotations[@]}&quot; \
              &quot;${tags[@]}&quot; \
              &quot;${image}@${DIGEST}&quot;
</code></pre>
<p>Similar to the readarray, but we filter by image. This makes it a single command per registry making sure we don't do multiple writes. We could've also used the previous jq command, but we don't have $DOCKER_METADATA_OUTPUT_JSON in the last job so we use readarray to make it the same on both.</p>
<p>e.g.</p>
<pre><code class="language-bash">          for image in $IMAGES; do
            docker buildx imagetools create \
            $(jq -cr --arg img &quot;${image}&quot; '.tags | map(select(startswith($img)) | &quot;-t &quot; + .) | join(&quot; &quot;)' &lt;&lt;&lt; &quot;$DOCKER_METADATA_OUTPUT_JSON&quot;) \
            &quot;${image}@${DIGEST}&quot;
          done
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>.github/workflows/build-docker.yml</code>:354 on 2025-06-21 04:07</div>
            <div class="timeline-body"><p>nit: For consistency with the rest of this file/jobs (we login to dockerhub first, then ghcr), I think its worth moving this above <code>docker/login-action</code> for ghcr in this job.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>.github/workflows/build-docker.yml</code>:352 on 2025-06-21 04:08</div>
            <div class="timeline-body"><pre><code class="language-suggestion">      - uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        if: ${{ github.event.pull_request.head.repo.full_name == 'astral-sh/uv' }}
        with:
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>.github/workflows/build-docker.yml</code>:384 on 2025-06-21 04:09</div>
            <div class="timeline-body"><pre><code class="language-suggestion">            readarray -t lines &lt; &lt;(grep &quot;^${image}:&quot; &lt;&lt;&lt; &quot;$TAGS&quot;); tags=(); for line in &quot;${lines[@]}&quot;; do tags+=(-t &quot;$line&quot;); done
            docker buildx imagetools create \
              &quot;${annotations[@]}&quot; \
              &quot;${tags[@]}&quot; \
              &quot;${image}@${DIGEST}&quot;
</code></pre>
<p>Same as https://github.com/astral-sh/uv/pull/14165#discussion_r2159855379</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>.github/workflows/build-docker.yml</code>:416 on 2025-06-21 04:09</div>
            <div class="timeline-body"><pre><code class="language-suggestion"></code></pre>
<p>Old doc from old workflow</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>.github/workflows/build-docker.yml</code>:369 on 2025-06-21 04:10</div>
            <div class="timeline-body"><pre><code class="language-suggestion"></code></pre>
<p>Old doc from old workflow</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>.github/workflows/build-docker.yml</code>:370 on 2025-06-21 04:12</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        # The final command becomes `docker buildx imagetools create --annotation 'index:foo=1' --annotation 'index:bar=2' ... -t tag1 -t tag2 ... &lt;IMG&gt;@sha256:&lt;sha256&gt;`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2025-06-21 04:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-06-21 12:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.github/workflows/build-docker.yml</code>:306 on 2025-06-21 12:41</div>
            <div class="timeline-body"><p>We could grab the JSON output, I think â€” but the <code>readarray</code> reads clearer to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-06-21 12:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.github/workflows/build-docker.yml</code>:352 on 2025-06-21 12:42</div>
            <div class="timeline-body"><p>Does this make sense? Won't we fail to push downstream anyway?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2025-06-21 13:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>.github/workflows/build-docker.yml</code>:352 on 2025-06-21 13:24</div>
            <div class="timeline-body"><p>I only suggested for consistency with others and because it helped with running it on my fork. I agree though, you'd still need to set docker hub en var to empty string or remove it from the fork.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2025-06-21 13:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>.github/workflows/build-docker.yml</code>:282 on 2025-06-21 13:58</div>
            <div class="timeline-body"><p>It doesn't hurt as we're now pushing <code>tagged</code> images very early on. The previous workflow didn't push the tags until the last job.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> approved on 2025-06-21 13:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2025-06-21 14:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-06-21 14:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-21 14:01</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:43:39 UTC
    </footer>
</body>
</html>
