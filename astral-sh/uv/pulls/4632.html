<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add `uvx` alias for `uv tool run` - astral-sh/uv #4632</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add <code>uvx</code> alias for <code>uv tool run</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/4632">#4632</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-06-28 17:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>Closes https://github.com/astral-sh/uv/issues/4476</p>
<p>Originally, this used the changes in #4642 to invoke <code>main()</code> from a <code>uvx</code> binary. This had the benefit of <code>uvx</code> being entirely standalone at the cost of doubling our artifact size. We think that's the incorrect trade-off.</p>
<p>Instead, we assume <code>uvx</code> is always next to <code>uv</code> and create a tiny binary (&lt;1MB) that invokes <code>uv</code> in a child process. This seems preferable to a <code>cargo-dist</code> alias because we have more control over it. This binary should &quot;just work&quot; for all of our cargo-dist distributions and installers, but we'll need to add a new entry point for our PyPI distribution. I'll probably tackle support there separately?</p>
<pre><code>❯ ls -lah target/release/uv target/release/uvx
-rwxr-xr-x  1 zb  staff    31M Jun 28 23:23 target/release/uv
-rwxr-xr-x  1 zb  staff   452K Jun 28 23:22 target/release/uvx
</code></pre>
<p>This includes some small overhead:</p>
<pre><code>❯ hyperfine --shell=none --warmup=100 './target/release/uv tool run --help' './target/release/uvx --help' --min-runs 2000
Benchmark 1: ./target/release/uv tool run --help
  Time (mean ± σ):       2.2 ms ±   0.1 ms    [User: 1.3 ms, System: 0.5 ms]
  Range (min … max):     2.0 ms …   4.0 ms    2000 runs
 
  Warning: Statistical outliers were detected. Consider re-running this benchmark on a quiet system without any interferences from other programs. It might help to use the '--warmup' or '--prepare' options.
 
Benchmark 2: ./target/release/uvx --help
  Time (mean ± σ):       2.9 ms ±   0.1 ms    [User: 1.7 ms, System: 0.9 ms]
  Range (min … max):     2.8 ms …   4.2 ms    2000 runs
 
  Warning: Statistical outliers were detected. Consider re-running this benchmark on a quiet system without any interferences from other programs. It might help to use the '--warmup' or '--prepare' options.
 
Summary
  ./target/release/uv tool run --help ran
    1.35 ± 0.09 times faster than ./target/release/uvx --help
</code></pre>
<p>I presume there may be some other downsides to a child process? The wrapper is a little awkward. We could consider <code>execv</code> but this is complicated across platforms. An example implementation of that over in <a href="https://github.com/konstin/poc-monotrail/blob/433af5aed90921e2c3f4b426b3ffffd83f04d3ff/crates/monotrail/src/monotrail.rs#L764-L799">monotrail</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> added by @zanieb on 2024-06-28 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @zanieb on 2024-06-28 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-28 18:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/lib.rs</code>:853 on 2024-06-28 18:02</div>
            <div class="timeline-body"><p>This moved without change from <code>run</code> above because it's not safe to send <code>std::env</code> values across threads depending on the platform.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-28 18:44</div>
            <div class="timeline-body"><p>It turns out cargo-dist <a href="https://opensource.axo.dev/cargo-dist/book/reference/config.html?highlight=alias#bin-aliases">supports aliases</a>! but I don't think that's actually what we want here, we have more control this way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-28 19:09</div>
            <div class="timeline-body"><p>I think we'd follow this with some special-casing to the help menu to display <code>uvx</code> instead of <code>uv tool run</code> when used.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @zanieb on 2024-06-28 20:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zanieb on 2024-06-28 20:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-28 21:03</div>
            <div class="timeline-body"><p>This is great, but one early concern: will this double the size of the wheel, by shipping two separate binaries that are mostly identical?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-28 21:14</div>
            <div class="timeline-body"><p>@charliermarsh great question — ideally we'd make this binary teeeenie tiny. I'll investigate that but it sounds like I'll need to duplicate a lot more code?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-28 21:55</div>
            <div class="timeline-body"><p>Mm yeah each of these is going to be large...</p>
<pre><code>❯ ls -lah target/debug/uv target/debug/uvx
-rwxr-xr-x  1 zb  staff    80M Jun 28 16:53 target/debug/uv
-rwxr-xr-x  1 zb  staff    80M Jun 28 16:53 target/debug/uvx
</code></pre>
<p>Maybe a cargo-dist alias <em>is</em> the way to go.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @zanieb on 2024-06-28 22:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sgammon">@sgammon</a> on 2024-06-28 23:10</div>
            <div class="timeline-body"><p>@zanieb can't <code>uvx</code> assume it is always alongside <code>uv</code>, and dispatch through the main binary? Thus it would just be an alias for a longer <code>uv</code> command, and much smaller as a result?</p>
<p><em>Edit:</em> Or, potentially, an alias, and simply detect <code>uvx</code> as the first argument in <code>argv</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-29 03:45</div>
            <div class="timeline-body"><p>Yeah I think we're going to need to do something like that. I think the binary size increase in unacceptable for us and there's no reason for <code>uvx</code> to be standalone today. I think we have options like...</p>
<ul>
<li>A <code>cargo-dist</code> alias<ul>
<li>We could need to roll our own alias in our PyPI distributions</li>
<li>The way the alias works differs across platforms and distribution methods</li>
<li>The sys args are not reliable and differ across platforms, can we use them to know <code>uvx</code> was invoked reliably?</li>
</ul>
</li>
<li>A bespoke alias<ul>
<li>We would need to figure out how to distribute this across platforms</li>
</ul>
</li>
<li>A new binary in the <code>uv</code> binary which just dispatches to a child process<ul>
<li>Does this come have acceptable overhead?</li>
<li>Can it assume that it is always next to <code>uv</code> or do we need to support some discovery?</li>
</ul>
</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-29 04:17</div>
            <div class="timeline-body"><p>Alright, this is nice and spicy.</p>
<pre><code>❯ ls -lah target/debug/uv target/debug/uvx
-rwxr-xr-x  1 zb  staff    81M Jun 28 23:16 target/debug/uv
-rwxr-xr-x  1 zb  staff   723K Jun 28 23:16 target/debug/uvx
❯ ./target/debug/uvx
Run a tool

Usage: uv tool run [OPTIONS] &lt;COMMAND&gt;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-29 04:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/bin/uvx.rs</code>:29 on 2024-06-29 04:32</div>
            <div class="timeline-body"><p>This feels a little dubious, but is probably fine in practice. The documentation suggests the status code is just truncated to a u8 on Unix anyway? Definitely open to alternative approaches here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-29 04:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/bin/uvx.rs</code>:14 on 2024-06-29 04:33</div>
            <div class="timeline-body"><p>In the future, this might invoke a hidden <code>uv x</code> so we can special case the help menu and such?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zanieb on 2024-06-29 04:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-06-30 23:47</div>
            <div class="timeline-body"><p>How did you think about the tradeoffs between this approach and using a symlink?</p>
<p>I'm actually shocked that this is 456 KB, so big! I wonder if we can strip it? https://github.com/johnthagen/min-sized-rust?tab=readme-ov-file#strip-symbols-from-binary</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-07-01 07:56</div>
            <div class="timeline-body"><blockquote>
<p>The sys args are not reliable and differ across platforms, can we use them to know uvx was invoked reliably?</p>
</blockquote>
<p>On unix definitely, a lot of binaries rely on moonlighting as different binaries, and i found it to also work on windows. Given that cargo-dist supports them, can we build on their experience?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-01 17:34</div>
            <div class="timeline-body"><p>cargo-dist uses various methods depending on the distribution target, not just a symbolic link. I worry about having a different implementation across platforms, the complexity of handling this as a distribution special-case, and the loss of control. Here we have a single consistent implementation that we can invoke via <code>cargo run</code> and tested in our standard suite. We have explicit control over the entry point (rather than inferring that it's been used based on the sys arguments).</p>
<p>I think that we can and probably should explore alternative approaches, but this seems like the lower-risk approach to start with.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-01 21:14</div>
            <div class="timeline-body"><p>I can't find an obvious way to strip just one of the binaries.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2024-07-02 01:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-07-02 01:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-02 01:42</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:37:48 UTC
    </footer>
</body>
</html>
