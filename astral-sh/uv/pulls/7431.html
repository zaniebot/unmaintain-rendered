<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allow creating venv with free-threaded python builds - astral-sh/uv #7431</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Allow creating venv with free-threaded python builds</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/7431">#7431</a>
        opened by <a href="https://github.com/bschoenmaeckers">@bschoenmaeckers</a>
        on 2024-09-16 15:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bschoenmaeckers">@bschoenmaeckers</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to uv! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>closes #4828</p>
<p>First iteration for an implementation. I need to add more tests but wanted your opinion on the implementation first.</p>
<!-- What's the purpose of the change? What does it do, and why? -->

<h2>Test Plan</h2>
<p>Currently tested using the following command but will add tests shortly:</p>
<pre><code class="language-console">D:\repo\uv&gt; cargo run venv -p 3.13t &amp;&amp; .venv\Scripts\python.exe
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.52s
     Running `target\debug\uv.exe venv -p 3.13t`
Using Python 3.13.0rc1 interpreter at: C:\Users\bschoen\AppData\Local\Programs\Python\Python313\python3.13t.exe
Creating virtualenv at: .venv
Activate with: .venv\Scripts\activate
Python 3.13.0rc1 experimental free-threading build (tags/v3.13.0rc1:e4a3e78, Jul 31 2024, 21:06:58) [MSC v.1940 64 bit (AMD64)] on win32
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; 
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bschoenmaeckers">@bschoenmaeckers</a> on 2024-09-16 18:08</div>
            <div class="timeline-body"><p>Working on the unix implementation now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @zanieb by @zanieb on 2024-09-16 18:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bschoenmaeckers">@bschoenmaeckers</a> on 2024-09-16 19:27</div>
            <div class="timeline-body"><blockquote>
<p>Working on the unix implementation now.</p>
</blockquote>
<p>Tested it on linux using the <code>quay.io/pypa/manylinux2014_x86_64</code> docker image and I seems to work correctly already. Going to write some tests next.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bschoenmaeckers">@bschoenmaeckers</a> on 2024-09-16 20:06</div>
            <div class="timeline-body"><p>I find it quiet hard to add a test without a free-threaded build available in the CI. So maybe we should add a full integration test later when the downloadable build is available.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bschoenmaeckers">@bschoenmaeckers</a> on 2024-09-17 08:26</div>
            <div class="timeline-body"><p>Should version requests like <code>&gt;=3.13t</code>, <code>&gt;=3.13t,&lt;3.14t</code> or <code>&gt;=3.12,&lt;3.14t</code> be valid?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-17 13:33</div>
            <div class="timeline-body"><blockquote>
<p>Should version requests like <code>&gt;=3.13t</code>, <code>&gt;=3.13t,&lt;3.14t</code> or <code>&gt;=3.12,&lt;3.14t</code> be valid?</p>
</blockquote>
<p>Maybeee. It seems safe to add support for that later if people need it.</p>
<blockquote>
<p>I find it quiet hard to add a test without a free-threaded build available in the CI. So maybe we should add a full integration test later when the downloadable build is available.</p>
</blockquote>
<p>You can probably add test coverage in <code>crates/uv-python/src/lib.rs</code>, we support creating mock interpreters there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-17 13:49</div>
            <div class="timeline-body"><p>Oh also regarding an integration test, is there a Docker image with a free-threaded build? or a system that has it packaged? You can create a new <code>integration-test</code> CI job that does whatever so we get some real-world coverage.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bschoenmaeckers">@bschoenmaeckers</a> on 2024-09-18 14:07</div>
            <div class="timeline-body"><p>I've added a smoke test in the ci using a pre-compiled python 3.13 <a href="https://launchpad.net/%7Edeadsnakes/+archive/ubuntu/ppa/+packages">package</a> installed using apt-get on a bare ubuntu instance. Furthermore I added a mocked interpreter test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-09-18 14:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.github/workflows/ci.yml</code>:608 on 2024-09-18 14:08</div>
            <div class="timeline-body"><p>We could probably set a more aggressive timeout here.</p>
<pre><code class="language-suggestion">    timeout-minutes: 5
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-09-18 14:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:140 on 2024-09-18 14:18</div>
            <div class="timeline-body"><p>Doing some internal debate about this right now — this is sort of the &quot;easiest&quot; way to add support but it might be better to added a <code>freethreaded: bool</code> to each relevant variant instead? Like <code>FreeThreaded(Any)</code> shouldn't be allowed nor <code>FreeThreaded(FreeThreaded(...))</code> right? Want to share some more about why you went with this pattern?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-09-18 14:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:1482 on 2024-09-18 14:21</div>
            <div class="timeline-body"><p>e.g., if you didn't use a recursive enum we could just generate the names properly in <code>VersionRequest::default_names</code> instead of mutating the names here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/python_find.rs</code>:460 on 2024-09-18 14:22</div>
            <div class="timeline-body"><p>Nit: We should probably use <code>3.12</code> here so it doesn't collide with our error message for unsupported Python versions if we change where that's enforced.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-09-18 14:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/bschoenmaeckers">@bschoenmaeckers</a> on <code>crates/uv-python/src/discovery.rs</code>:140 on 2024-09-18 14:26</div>
            <div class="timeline-body"><p>It was at the time of implementing the easiest option to wrap every variant with a FreeThreaded version because it didn't felt right to clutter every variant with yet another flag. You are right that that <code>FreeThreaded(Any)</code> does not make sense but the <code>FreeThreaded(FreeThreaded(...))</code> should not be possible for the parser to generate, even though it would not be a very big problem because it would behave like a regular FreeThreaded(...) variant. But I understand the debate and would happily switch to a extra flag on every variant if you want me to.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bschoenmaeckers">@bschoenmaeckers</a> reviewed on 2024-09-18 14:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bschoenmaeckers">@bschoenmaeckers</a> reviewed on 2024-09-18 14:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/bschoenmaeckers">@bschoenmaeckers</a> on <code>crates/uv/tests/python_find.rs</code>:460 on 2024-09-18 14:37</div>
            <div class="timeline-body"><p>Oops you're right, this should be 3.12t.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-09-18 14:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:140 on 2024-09-18 14:51</div>
            <div class="timeline-body"><p>The parser can't generate it but this is a &quot;public&quot; enum so someone could construct that variant — which is a bit awkward. I think I have a preference for adding a boolean to the variants, it looks like it would make some of the downstream logic simpler. It is a bit sad that we'll need to add it everywhere we construct a <code>VersionRequest</code> manually but I'm not sure what else to do there. As a small note, it may need to be <code>Option&lt;bool&gt;</code> for cases in which the free-threaded build is fine, e.g., and can be used if it's first on the <code>PATH</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bschoenmaeckers">@bschoenmaeckers</a> reviewed on 2024-09-18 14:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/bschoenmaeckers">@bschoenmaeckers</a> on <code>crates/uv-python/src/discovery.rs</code>:140 on 2024-09-18 14:57</div>
            <div class="timeline-body"><p>Fine by me. How would you parse a <code>3.13</code> request? Does the user allow a free-threaded build or not?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-09-18 15:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:140 on 2024-09-18 15:00</div>
            <div class="timeline-body"><p>I'm not sure.</p>
<p>cc @henryiii / @carljm who may have helpful opinions on that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-09-18 15:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:140 on 2024-09-18 15:26</div>
            <div class="timeline-body"><p>I think generally no, unless it's the only one available — like we do for pre-releases #7300</p>
<p>We might want to be more strict than that but I'm not sure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/henryiii">@henryiii</a> reviewed on 2024-09-18 18:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/henryiii">@henryiii</a> on <code>crates/uv-python/src/discovery.rs</code>:140 on 2024-09-18 18:40</div>
            <div class="timeline-body"><p>I think you want to make sure this can change for a future Python version, but yes, I think currently you want free-threaded to be opt-in. In the future, if it works well, it might be opt-out instead, maybe as soon as 3.15 (which may be called 3.27).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-09-18 18:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:140 on 2024-09-18 18:41</div>
            <div class="timeline-body"><p>What if you have a <code>python</code> executable at the front of your path and it's free-threaded?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/henryiii">@henryiii</a> reviewed on 2024-09-18 18:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/henryiii">@henryiii</a> on <code>crates/uv-python/src/discovery.rs</code>:140 on 2024-09-18 18:43</div>
            <div class="timeline-body"><p>If it's called <code>python</code> or <code>python3.13</code>, then yes, but usually it's only called <code>python3.13t</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/henryiii">@henryiii</a> reviewed on 2024-09-18 18:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/henryiii">@henryiii</a> on <code>crates/uv-python/src/discovery.rs</code>:140 on 2024-09-18 18:45</div>
            <div class="timeline-body"><p>Same as pypy. If there's a <code>python</code> that's actually pointing at <code>pypy</code>, then that should be picked up, otherwise pypy should only be opt-in?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-09-18 18:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:140 on 2024-09-18 18:45</div>
            <div class="timeline-body"><p>Unfortunately people do weird things and we have to think about these edge-cases</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-20 20:39</div>
            <div class="timeline-body"><p>I think this is failing because it's not searching for the executable name properly. I'm going to tweak the <code>possible_names</code> and <code>default_names</code> code — it' really unwieldy (not from this pull request).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bschoenmaeckers">@bschoenmaeckers</a> on 2024-09-20 21:24</div>
            <div class="timeline-body"><blockquote>
<p>I think this is failing because it's not searching for the executable name properly. I'm going to tweak the <code>possible_names</code> and <code>default_names</code> code — it' really unwieldy (not from this pull request).</p>
</blockquote>
<p>I was thinking so as well, I did not had time to debug this properly. The only thing I knew was that it is working properly on windows.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/bschoenmaeckers">@bschoenmaeckers</a> on 2024-09-21 11:02</div>
            <div class="timeline-body"><p>@zanieb, I fixed the tests. So it is ready for review again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-09-23 22:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-23 22:36</div>
            <div class="timeline-body"><p>Thanks! I resolved the conflicts with #7649</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2024-09-23 22:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-09-23 22:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/basnijholt">@basnijholt</a> on 2024-09-23 22:42</div>
            <div class="timeline-body"><p>Awesome! Does this mean that there will be a 3.13t version available at the next release of <code>uv</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-23 23:50</div>
            <div class="timeline-body"><p>Unfortunately not, that's much harder and can be tracked at https://github.com/indygreg/python-build-standalone/pull/326</p>
<p>With this, we'll just let you ask uv to use a free-threaded build you already have installed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2024-09-24 04:28</div>
            <div class="timeline-body"><p>FYI, this means you can say &quot;3.13t&quot; and get it; you can already use uv with python3.13t as long as you give it via path. (At least I hope so, for example cibuildwheel does that)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:39:36 UTC
    </footer>
</body>
</html>
