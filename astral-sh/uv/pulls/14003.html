<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>When validating lockfile, take account of indexes defined as sources in path dependencies - astral-sh/uv #14003</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>When validating lockfile, take account of indexes defined as sources in path dependencies</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/14003">#14003</a>
        opened by <a href="https://github.com/jtfmumm">@jtfmumm</a>
        on 2025-06-12 18:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a></div>
            <div class="timeline-body"><p>As described in #11419, when an index was defined as a source in a path dependency (and that index ended up in the lockfile), it would cause lockfile validation to incorrectly determine that the file had changed. This PR adds those indexes to the list uv uses to validate.</p>
<p>This adds those path dependency source indexes as a new field on <code>Workspace</code> (including from transitive path dependencies). It includes cycle detection to handle the case of circular path dependencies.</p>
<p>This includes test for explicit indexes in a path dependency, a combination of explicit and non-explicit, path dependencies without indexes defined, nested (transitive) path dependencies, and circular path dependencies. The circular path dependency test does not hang (indicating successful cycle detection) but lockfile validation still indicates the file has changed. This is not a change from <code>main</code> so I have marked this as a <code>TODO</code>.</p>
<p>Closes #11419</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @jtfmumm on 2025-06-12 18:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-06-12 18:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-workspace/src/workspace.rs</code>:1619 on 2025-06-12 18:26</div>
            <div class="timeline-body"><p>I've taken a permissive approach here since we are checking for <code>pyproject.toml</code> files defined in path dependencies, and only for the purposes of validation. That's why I've chosen to log problems canonicalizing and parsing them and then to continue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-06-12 18:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-workspace/src/workspace.rs</code>:1653 on 2025-06-12 18:27</div>
            <div class="timeline-body"><p>See comment above</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-06-12 18:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv/src/commands/project/lock.rs</code>:1086 on 2025-06-12 18:28</div>
            <div class="timeline-body"><p>I'm using a <code>Cow</code> here because the common case will probably be to have no path dependencies. This avoids cloning in that common case</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @jtfmumm on 2025-06-12 19:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @konstin by @zanieb on 2025-06-13 11:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @zanieb on 2025-06-13 11:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-workspace/src/workspace.rs</code>:1610 on 2025-06-13 12:11</div>
            <div class="timeline-body"><p>I'm currently only handling the <code>Path</code> case from the issue. We could also fetch <code>Source::Git</code> and <code>Source::Url</code> <code>pyproject</code>s but I wasn't sure if we wanted to do that here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-06-13 12:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/lock.rs</code>:27562 on 2025-06-17 10:53</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// &lt;https://github.com/astral-sh/uv/issues/11419&gt;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-workspace/src/workspace.rs</code>:1643 on 2025-06-17 12:01</div>
            <div class="timeline-body"><p>We should avoid reparsing <code>pyproject.toml</code>, this is an expensive operation when it runs as part of a noop <code>uv run</code>. See https://github.com/astral-sh/uv/pull/12096 for context and benchmarking instructions.</p>
<p>Can we reuse the parsed file through using the workspace cache around <code>collect_members_only</code>, or alternatively collect this information after workspace discovery so we can read from a warm cache of workspace members?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-resolver/src/lock/mod.rs</code>:1415 on 2025-06-17 12:58</div>
            <div class="timeline-body"><p>I can't comment down there, but can you add a comment near the <code>while let Some(package) = queue.pop_front() {</code> below that says something like:</p>
<blockquote>
<p>Unlike path dependencies, Git dependencies are immutable, their sources cannot change without the hashes changing, so we know their indexes are still present.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-06-17 13:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-06-22 23:56</div>
            <div class="timeline-body"><p>Could we instead solve this by adding any explicit index assignments to the lockfile? We already write the normalized requirements (<code>requires-dev</code>), so this would just be an extension of that behavior. Taking the indexes into account in the way it's outlined here seems like an abstraction leak.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @jtfmumm on 2025-07-25 05:06</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:43:32 UTC
    </footer>
</body>
</html>
