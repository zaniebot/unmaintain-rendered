<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add note on private classifier - astral-sh/uv #8783</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add note on private classifier</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/8783">#8783</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2024-11-03 20:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>Users are concerned that they might accidentally publish their private package to PyPI, thereby exposing company internals and their private source code.</p>
<p>However, for this to happen, the user needs to call <code>uv publish</code> without an index option, while having credentials for PyPI set either in environment variables (and the private index credentials not set to those env vars) or in the keyring (without scoping to a package), and that token having the project in scope.</p>
<p>As easiest protection, we recommend <strong>never generating a PyPI token scoped to all projects</strong>, only generating one that is matched to the specific, public project: Without a matching token, no accidental publishing can happen.</p>
<hr />
<p>The <code>Private :: Do Not Upload</code> prevent packages from being uploaded to PyPI (https://pypi.org/classifiers/). This is unergonomic: The classifiers are a system for metadata, not for configuration, they are not part of uv's docs and it doesn't have the discoverability of regular settings.</p>
<p>The most evident idea for solving this is <code>tool.uv.publish</code>:</p>
<pre><code>[tool.uv]
private = true
</code></pre>
<p>Unfortunately, this doesn't actually offer reliable protection: It only works when the pyproject.toml is present (we currently don't require checkouts for <code>uv publish</code>) and it doesn't work with twine or any other publishing tool.</p>
<p>The second idea is translating this to <code>classifiers = [&quot;Private :: Do Not Upload&quot;]</code>. Unfortunately, PEP 621 forbids this, it requires that we must not append to static parts of <code>[project]</code> when building the wheel and source dists. This is needed for the ability to read <code>pyproject.toml</code> without a build. There is an escape hatch that requires explicitly declaring specifiers as dynamic, we set the actual classifier on build depending on the value of <code>tool.uv.private</code>, i.e., if we see <code>tool.uv.private = true</code> we transform the metadata on build as if we had <code>classifiers = [&quot;Private :: Do Not Upload&quot;]</code>:</p>
<pre><code class="language-toml">[project]
name = &quot;foo-internal&quot;
version = &quot;0.1.0&quot;
dynamic = [&quot;classifier&quot;]

[tool.uv]
private = true
</code></pre>
<p>Through <code>dynamic</code>, we are allowed to emit the following as METADATA:</p>
<pre><code class="language-text">Metadata-Version: 2.3
Name: foo-internal
Version: 0.1.0
Version: Private :: Do Not Upload
</code></pre>
<p>Just setting <code>classifiers = [&quot;Private :: Do Not Upload&quot;]</code> is, unlike the above, self-documenting and more concise.</p>
<hr />
<p>Given all that we document that you shouldn't create unscoped tokens and that you can use <code>classifiers = [&quot;Private :: Do Not Upload&quot;]</code>.</p>
<p>Note that we cannot handle e.g. a GitLab repository that is set to public accidentally. It falls into the domain of registry vendors to have guardrails (e.g. private-by-default registries when the status of the source is unknown)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> added by @konstin on 2024-11-03 20:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/johnthagen">@johnthagen</a> on 2024-11-04 00:56</div>
            <div class="timeline-body"><p>As OP of #8214, this isn't what I was hoping for but I can understand your rationale and the constraints on <code>[project]</code> metadata mandated outside the scope of uv.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2024-11-04 01:12</div>
            <div class="timeline-body"><blockquote>
<p>As OP of #8214, this isn't what I was hoping for but I can understand your rationale and the constraints on <code>[project]</code> metadata mandated outside the scope of uv.</p>
</blockquote>
<p>It might be worth leaving #8214 open to explore the possibility of adding support for <code>[tool.uv] private = true</code>. While PEP 621 forbids appending to static parts of <code>[project]</code>, I wonder if <code>uv</code> can make an exception only in this situation for better alignment with user's expectations and other package managers (e.g. cargo).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-11-06 15:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>docs/guides/publish.md</code>:50 on 2024-11-06 15:01</div>
            <div class="timeline-body"><p>I think this should just be at the bottom of this section, and not as a note. (Is it really the most important content?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-11-06 15:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>docs/guides/publish.md</code>:50 on 2024-11-06 15:21</div>
            <div class="timeline-body"><p>The trouble with placing this section is that it's a negative advice, it's about not doing something rather than doing something. Users with private packages that don't get published at all aren't likely to read through the publish guide, but I haven't found a place they would come through either.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-11-06 15:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>docs/guides/publish.md</code>:65 on 2024-11-06 15:29</div>
            <div class="timeline-body"><p>This doesn't quite make sense in the publishing guide, which is explicitly about how to publish your package. I guess I'll move towards having a publish concept document, but in the meantime, it can live here. It's a little awkward in the middle of this workflow, maybe it should be in <code>Preparing your project for packaging</code> as a <code>!!! tip</code>?</p>
<p>Could you add a sentence at the top of this section which explains what a private package is and why you'd want one?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-11-06 15:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>docs/guides/publish.md</code>:65 on 2024-11-06 15:55</div>
            <div class="timeline-body"><p>i moved it up again and changed word to &quot;internal&quot;, that's self-explanatory.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-11-06 15:59</div>
            <div class="timeline-body"><blockquote>
<p>It might be worth leaving https://github.com/astral-sh/uv/issues/8214 open to explore the possibility of adding support for [tool.uv] private = true. While PEP 621 forbids appending to static parts of [project], I wonder if uv can make an exception only in this situation for better alignment with user's expectations and other package managers (e.g. cargo).</p>
</blockquote>
<p>I think it's obvious but I'll spell it out explicitly: If <code>[project] private = true</code> or something similar gets added to https://packaging.python.org/en/latest/specifications/pyproject-toml/ and/or https://packaging.python.org/en/latest/specifications/core-metadata/, I'm in favor such a PEP getting accepted and we'll support that uv (and the less ergonomic <code>Private :: Do Not Upload</code> docs). Until that however, I think we've done as much as we can on uv's side, and I consider #8214 &quot;finished&quot; in the sense that we gave solid guidance for users (this PR) and it's not blocking stabilization anymore (https://github.com/astral-sh/uv/issues/7839). If there's other things you want to see discussed around publishing and avoiding that accidents that were not covered by #8214, please feel free to open a new issue!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-11-06 16:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>docs/guides/publish.md</code>:18 on 2024-11-06 16:01</div>
            <div class="timeline-body"><p>Sorry but I think this still needs an explanatory sentence to start since we're currently in the middle of telling someone how to setup their project <em>to</em> be published. For example:</p>
<blockquote>
<p>If you have internal packages that you do not want to be published, you can mark them as private with a classifier:</p>
<p>...</p>
<p>uv will still attempt to publish packages with the classifier, but PyPI will reject them.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-11-06 16:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>docs/guides/publish.md</code>:19 on 2024-11-06 16:01</div>
            <div class="timeline-body"><p>What happens with other package indexes?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-11-06 16:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>docs/guides/publish.md</code>:19 on 2024-11-06 16:09</div>
            <div class="timeline-body"><p>They should allow the upload, but in general this is undefined, as in the OP:</p>
<blockquote>
<p>Note that we cannot handle e.g. a GitLab repository that is set to public accidentally. It falls into the domain of registry vendors to have guardrails (e.g. private-by-default registries when the status of the source is unknown)</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-11-06 16:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>docs/guides/publish.md</code>:19 on 2024-11-06 16:10</div>
            <div class="timeline-body"><p>We should probably say that too then.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-11-06 16:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>docs/guides/publish.md</code>:18 on 2024-11-06 16:20</div>
            <div class="timeline-body"><p>I don't think that level of phrasing matters here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-06 16:22</div>
            <div class="timeline-body"><p>I defer to @zanieb entirely on the docs. Feel free to ignore my comments on that front.</p>
<p>IMO it's okay to leave https://github.com/astral-sh/uv/issues/8214 open. I <em>can</em> imagine other ways for us to solve this problem that don't require standards. For example, we <em>could</em> error when <code>private = false</code> is set in a <code>pyproject.toml</code> and require publishing to take place in the context of a project by default or something like that. Or, if we have our own build backend, we can write this into the distribution somewhere, and check it on <code>uv publish</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-11-06 16:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>docs/guides/publish.md</code>:18 on 2024-11-06 16:23</div>
            <div class="timeline-body"><p>Which part?</p>
<p>Is it not a significant security concern in the issue that we attempt to publish the package?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-11-06 16:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>docs/guides/publish.md</code>:18 on 2024-11-06 16:29</div>
            <div class="timeline-body"><p>Why would a guaranteed-to-fail misconfigured publish attempt be a security concern? If you're really that scared about external sites, then you need to block pypi on a network level as some orgs do, and before that users already shouldn't run <code>uv publish</code> locally if you care about such aspects.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-11-06 16:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>docs/guides/publish.md</code>:19 on 2024-11-06 16:40</div>
            <div class="timeline-body"><p>I mean, sure, but isn't saying that you need to read the manual to your registry to operate it securely both evident and outside of the scope of uv? I don't think anyone reads the section as keeping the package private when you switch your GitLab registry setting to public. (And the registry I checked start with private by default at least for private repos and have extra steps before switching it to public).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-11-06 17:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>docs/guides/publish.md</code>:19 on 2024-11-06 17:34</div>
            <div class="timeline-body"><p>I don't think we need to talk about other indexes in depth here, but if we're going to recommend something we need to be clear about the caveats Just asking for something like &quot;When not publishing to PyPI, the classifier may or may not be respected.&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>docs/guides/publish.md</code>:18 on 2024-11-06 17:37</div>
            <div class="timeline-body"><p>I mean, the package is still being sent to the host which is contrary to the expectation of a &quot;do not upload&quot; declaration. Their are users in the issue that have brought this up repeatedly. I don't quite understand the pushback on documenting this behavior. If the behavior was more obviously aligned with the expectations, I'd feel differently.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-11-06 17:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-11-06 18:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>docs/guides/publish.md</code>:18 on 2024-11-06 18:01</div>
            <div class="timeline-body"><p>Because the code being revealed by some SSL proxy(?) is a fairly hypothetical concern, and I value concise documentation, not documentation that hints users towards problems that do not exist.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-11-06 18:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>docs/guides/publish.md</code>:28 on 2024-11-06 18:29</div>
            <div class="timeline-body"><p>I'm sorry to continue picking at this, but I'm earnestly confused by the language here. &quot;is used against PyPI&quot; doesn't quite make sense, the classifier is sent to all indexes and only PyPI is expected to act on it right? What does it mean to configure access to the uploaded packages on an alternative registry? I thought the goal here was to avoid upload and publish entirely â€” I'm confused that we're talking about access controls now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>docs/guides/publish.md</code>:18 on 2024-11-06 18:32</div>
            <div class="timeline-body"><p>Aren't MITM attacks a valid concern? Another concern that comes to mind for me is that you accidentally upload the package to some other index. I just want to be clear about the behavior here since this is basically a &quot;security feature&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-11-06 18:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-11-06 20:05</div>
            <div class="timeline-body"><p>Summary of the latest changes: I've shortened the explanation of <code>classifiers = [&quot;Private :: Do Not Upload&quot;]</code>: I see this option as a defense-in-depth, not something that you can rely on for specific behavior. There's also a note that this only affects pypi: Security and privacy of the overall source code and package handling in an organization are outside of what uv can do unfortunately (we're only a client, and we for example can't even tell if the page from a registry we're uploading to is private or public), so we try not to give a wrong impression how far this classifier goes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-11-06 20:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/johnthagen">@johnthagen</a> on 2024-11-06 20:30</div>
            <div class="timeline-body"><p>@zanieb @konstin Any chance to leave #8214 open as @charliermarsh mentioned for future exploration of a nicer UX around this?</p>
<ul>
<li>https://github.com/astral-sh/uv/pull/8783#issuecomment-2460224991</li>
</ul>
<p>As of now &quot;Fixes #8214&quot; will close the issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-06 21:04</div>
            <div class="timeline-body"><p>I am fine with further discussion on #8214, though I think we're in agreement that the clearest path forward is an improvement at the Python standards-level.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2024-11-07 08:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2024-11-07 08:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-07 08:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:40:26 UTC
    </footer>
</body>
</html>
