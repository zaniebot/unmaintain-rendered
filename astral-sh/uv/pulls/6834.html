<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allow customizing the project environment path with `UV_PROJECT_ENVIRONMENT` - astral-sh/uv #6834</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Allow customizing the project environment path with <code>UV_PROJECT_ENVIRONMENT</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/6834">#6834</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-08-29 22:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>Allows configuration of the (currently hard-coded) path to the virtual environment in projects using the <code>UV_PROJECT_ENVIRONMENT</code> environment variable.</p>
<p>If empty, we'll ignore it. If a relative path, it will be resolved relative to the workspace root. If an absolute path, we'll use that.</p>
<p>This feature targets use in Docker images and CI. The variable is intended to be set once in an isolated system and used for all uv operations.</p>
<p>We do not expose a CLI option or configuration file setting — we may pursue those later but I see them as lower priority. I think a system-level environment variable addresses the most pressing use-cases here.</p>
<p>This doesn't special-case the system environment. Which means that you can use this to write to the system Python environment. I would generally strongly recommend against doing so. The insightful comment from @edmorley at https://github.com/astral-sh/uv/issues/5229#issuecomment-2312702902 provides some context on why. More generally, <code>uv sync</code> will remove packages from the environment by default. This means that if the system environment contains any packages relevant to the operation of the system (that are not dependencies of your project), <code>uv sync</code> will break it. I'd only use this in Docker or CI, if anywhere. Virtual environments have lots of benefits, and it's only <a href="https://docs.astral.sh/uv/guides/integration/docker/#using-the-environment">one line to &quot;activate&quot; them</a>.</p>
<p>If you are considering using this feature to use Docker bind mounts for developing in containers, I would highly recommend reading our <a href="https://docs.astral.sh/uv/guides/integration/docker/#developing-in-a-container">Docker container development documentation</a> first. If the solutions there do not work for you, please open an issue describing your use-case and why.</p>
<p>We do not read <code>VIRTUAL_ENV</code> and do not have plans to at this time. Reading <code>VIRTUAL_ENV</code> is high-risk, because users can easily leave an environment active and use the uv project interface today. Reading <code>VIRTUAL_ENV</code> would be a breaking change. Additionally, uv is intentionally moving away from the concept of &quot;active environments&quot; and I don't think syncing to an &quot;active&quot; environment is the right behavior while managing projects. I plan to add a warning if <code>VIRTUAL_ENV</code> is set, to avoid confusion in this area (see https://github.com/astral-sh/uv/pull/6864).</p>
<p>This does not directly enable centrally managed virtual environments. If you set <code>UV_PROJECT_ENVIRONMENT</code> to an absolute path and use it across multiple projects, they will clobber each other's environments. However, you could use this with something like <code>direnv</code> to achieve &quot;centrally managed&quot; environments. I intend to build a prototype of this eventually. See #1495 for more details on this use-case.</p>
<p>Lots of discussion about this feature in:</p>
<ul>
<li>https://github.com/astral-sh/rye/issues/371</li>
<li>https://github.com/astral-sh/rye/pull/1222</li>
<li>https://github.com/astral-sh/rye/issues/1211</li>
<li>https://github.com/astral-sh/uv/issues/5229</li>
<li>https://github.com/astral-sh/uv/issues/6669</li>
<li>https://github.com/astral-sh/uv/issues/6612</li>
</ul>
<p>Follow-ups:</p>
<ul>
<li>#6835</li>
<li>https://github.com/astral-sh/uv/pull/6864</li>
<li>Document this in the project concept documentation (can probably re-use some of this post)</li>
</ul>
<p>Closes https://github.com/astral-sh/uv/issues/6669
Closes https://github.com/astral-sh/uv/issues/5229
Closes https://github.com/astral-sh/uv/issues/6612</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by @zanieb on 2024-08-29 22:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-08-29 22:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/venv.rs</code>:81 on 2024-08-29 22:26</div>
            <div class="timeline-body"><p>This will change in #6835</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-29 22:58</div>
            <div class="timeline-body"><p>I tested installation into a system environment with:</p>
<pre><code class="language-dockerfile">FROM python:3.11.9-slim-bookworm

# Add my locally built binary
ADD uv /bin/uv
RUN chmod +x /bin/uv

# Create a project
RUN uv init example
WORKDIR example

# Use the system Python environment
ENV UV_PROJECT_ENVIRONMENT=&quot;/usr/local/&quot;

# Add httpx to the project
RUN uv add httpx

# Import it using the system Python
RUN python -c &quot;import httpx&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-29 23:09</div>
            <div class="timeline-body"><p>@edmorley please let me know if this will work for CNBs — I find that use-case particularly compelling.</p>
<p>I also plan to validate this approach works well for multi-stage Docker builds.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-08-29 23:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zanieb on 2024-08-30 03:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hynek">@hynek</a> on 2024-08-30 05:38</div>
            <div class="timeline-body"><p>To clarify, since my Rust is not quite up there: given that <code>uv pip install</code> is not part of the greater &quot;project&quot; topic, it will ignore the variable? To me it's not too bad to run it as <code>uv pip install --python=$UV_PROJECT_ENVIRONMENT</code> but it will 100% confuse people so it maybe should be called out?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-30 12:07</div>
            <div class="timeline-body"><p>Yes <code>uv pip install</code> will ignore this. It's not a part of the &quot;project&quot; interface. <em>Maybe</em> it should support it in a project root (as I did for venv), but I'm hesitant.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/inoa-jboliveira">@inoa-jboliveira</a> on 2024-08-30 12:31</div>
            <div class="timeline-body"><p>Hello! Since it is called UV_PROJECT_ENVIRONMENT (emphasis on project), would it be too much of a stretch to have it be also set in pyproject.toml or uv.toml?</p>
<p>I understand you are focusing on docker where it is standard to set environment variables, but there are much more wide use cases for this.</p>
<p>Thank you for providing this. It is better than the VIRTUAL_ENV variable, but the reason that is an env variable is because of the activation script. Otherwise a config file might be extremely useful</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hynek">@hynek</a> on 2024-08-30 12:40</div>
            <div class="timeline-body"><blockquote>
<p>Since it is called UV_PROJECT_ENVIRONMENT (emphasis on project), would it be too much of a stretch to have it be also set in pyproject.toml or uv.toml?</p>
<p>I understand you are focusing on docker where it is standard to set environment variables, but there are much more wide use cases for this.</p>
</blockquote>
<p>I'm not sure this makes semantically: if you're cooperating with others on a project, you're dictating on them where to put their venv. If you're working on it yourself, it would be very repetitive and a better solution would be a global config that allows to set some template or something.</p>
<p>Env variables aren't just a Docker thing; people use them locally for exactly these kinds customizations using <code>.env</code> files or, even better, <a href="https://direnv.net">Direnv</a>.</p>
<blockquote>
<p>Yes <code>uv pip install</code> will ignore this. It's not a part of the &quot;project&quot; interface.</p>
</blockquote>
<p>Yeah I figured, and I'm not arguing for the contrary. I just think it's a potential footgun to keep in mind.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-30 12:46</div>
            <div class="timeline-body"><p>I think it would make sense to respect <code>UV_PROJECT_ENVIRONMNET</code> when using <code>uv pip install</code> from a project root as in https://github.com/astral-sh/uv/pull/6835 — but there's a bunch places we'd need to add inference (e.g., in every <code>pip</code> command) and we'd also need <code>--no-project</code> support. I can't do it right now — but I think it's the right behavior. cc @charliermarsh</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/inoa-jboliveira">@inoa-jboliveira</a> on 2024-08-30 13:14</div>
            <div class="timeline-body"><blockquote>
<p>if you're cooperating with others on a project, you're dictating on them where to put their venv.</p>
</blockquote>
<p>Unfortunately this is a reality in some projects (think about python has been around for 25 years). This prevents uv add/sync from being the norm by not providing a way to migrating while being compatible.</p>
<p>Then it might be finally possible for projects just forget about this need when uv is the norm.</p>
<p>Being in a transition stage we need features that might not make sense if you are just trying to be purist about what is right and wrong.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ramarnat">@ramarnat</a> on 2024-08-30 13:24</div>
            <div class="timeline-body"><p>This solution works for me. Thanks for the responsive turnaround and the docs on the docker dev environment too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-30 13:28</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>if you're cooperating with others on a project, you're dictating on them where to put their venv.</p>
</blockquote>
<p>Unfortunately this is a reality in some projects (think about python has been around for 25 years). This prevents uv add/sync from being the norm by not providing a way to migrating while being compatible.</p>
</blockquote>
<p>I think the suggestion here is to use <code>.env</code> or similar if this is important to your project. We'll consider config-level options, but not with the urgency in which we pursued this change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ramarnat">@ramarnat</a> on 2024-08-30 13:37</div>
            <div class="timeline-body"><p>This won't change <code>uv tool</code> behavior of using its own place for deployment, will it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-30 13:39</div>
            <div class="timeline-body"><blockquote>
<p>This won't change uv tool behavior of using its own place for deployment, will it?</p>
</blockquote>
<p>No, it won't have any effect on <code>uv tool</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/inoa-jboliveira">@inoa-jboliveira</a> on 2024-08-30 14:57</div>
            <div class="timeline-body"><blockquote>
<p>if you're cooperating with others on a project, you're dictating on them where to put their venv.</p>
</blockquote>
<p>I've been thinking more and more about this statement. UV does dictate where the venv is located. As if it prevents a &quot;project maintainer&quot; from deciding it because it was already decided and enforced for all users. Seems contradictory.</p>
<blockquote>
<p>We'll consider config-level options, but not with the urgency in which we pursued this change.</p>
</blockquote>
<p>Sure, thank you! I'm in favor of any command line option or env variable being configurable in .toml files because it allows me to give users a project ready to use where they just need to learn the minimal commands and not care about extra steps.</p>
<p>I used to work only in mac/linux environments, but for the past 2 years I moved to windows and there are way more challenges than in a unix based system to make things simply work</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/FBen3">@FBen3</a> on 2024-08-31 23:46</div>
            <div class="timeline-body"><p>First off, thank you for putting so much effort into this project, and keeping up with all the requests &amp; issues. <code>uv</code> is awesome.</p>
<p>Couple of stupid questions:</p>
<ol>
<li></li>
</ol>
<blockquote>
<p>This does not directly enable centrally managed virtual environments. If you set UV_PROJECT_ENVIRONMENT to an absolute path and use it across multiple projects, they will clobber each other's environments.</p>
</blockquote>
<p>~~So does this mean I can't do something like <code>UV_PROJECT_ENVIRONMENT=VIRTUAL_ENV</code> in my <code>.zshrc</code> file, and whenever I activate a <code>venv</code> it would resolve to my active virtual environment (and, e.g. <code>uv add requests</code>, would not re-create <code>.venv</code> in the project)?~~</p>
<p>I guess I can do something like <code>alias activate='source venv/bin/activate &amp;&amp; export UV_PROJECT_ENVIRONMENT=$VIRTUAL_ENV'</code> to my <code>.zshrc</code> file so every time I activate / switch to a new virtual environment <code>UV_PROJECT_ENVIRONMENT</code> is updated.</p>
<ol start="2">
<li></li>
</ol>
<blockquote>
<p>We do not expose a CLI option or configuration file setting — we may pursue those later but I see them as lower priority.</p>
</blockquote>
<p>Would it be easy / How does the dev team feel about having a <code>--sync</code> CLI option (that's like the opposite of <code>--no-sync</code>), which updates the active virtual environment? So users who run into issues like #6849 could just do <code>uv add ruff --sync</code>)</p>
<ol start="3">
<li></li>
</ol>
<blockquote>
<p>Additionally, uv is intentionally moving away from the concept of &quot;active environments&quot; and I don't think syncing to an &quot;active&quot; environment is the right behavior while managing projects</p>
</blockquote>
<p>What is the reason behind this? Isn't it advantageous to explicitly define which environment a user is using? Otherwise how can I feel safe I'm not modifying my global environment?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-03 17:52</div>
            <div class="timeline-body"><p>Responding to the above</p>
<ol>
<li>Yes, you could do that. I wouldn't recommend it, but it seems okay to use this to match your active environment.</li>
<li>I don't think we'll add a CLI option to sync the active environment. Yes, it'd be easy to implement but it comes with a lot of complexity.</li>
<li>The problem of &quot;global environments&quot; is something we're trying to avoid — uv's project interface doesn't ever modify a global environment so you just don't need to worry about that. You easily <em>could</em> mutate an environment outside your current project if we just synced the active environment — this is the kind of problem we're trying to avoid. Generally speaking, activating environments shouldn't be necessary when using uv. Instead, use <code>uvx</code> and <code>uv run</code> and you'll always have the correct environment for your current context.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2024-09-03 17:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-09-03 17:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-09-03 17:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/edmorley">@edmorley</a> on 2024-09-03 21:26</div>
            <div class="timeline-body"><p>@zanieb Sorry for the delayed reply. This new env var will work well for our use-case (https://github.com/astral-sh/uv/issues/5229#issuecomment-2312702902) - thank you! We'll likely also set <code>VIRTUAL_ENV</code> too (to the same location) for parity with how we set up pip/Poetry venvs, in case some other tooling checks for it (rather than checking for <code>sys.prefix != sys.base_prefix</code>), but this will be no different to pip, where we set both <code>PIP_PYTHON</code> and <code>VIRTUAL_ENV</code> already.</p>
<blockquote>
<p>Instead, use uvx and uv run and you'll always have the correct environment for your current context.</p>
</blockquote>
<p>So this probably something you've already considered/are aware of (and were instead talking mainly about the host-machine development use-case), but in a container context, it will be reasonably common to exclude <code>uv</code> from the final app image (in the case of <code>Dockerfile</code> via multi-stage builds, or in the case of CNBs via build-only layers), in which case the final app image can't wrap commands with <code>uv run</code> in eg <code>CMD</code> / <code>ENTRYPOINT</code>, and instead containers that are using venvs (for the reasons in https://github.com/astral-sh/uv/issues/5229#issuecomment-2312702902) will need to have &quot;activated&quot; the venv by adding it to <code>PATH</code> etc instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-03 21:32</div>
            <div class="timeline-body"><p>Yeah totally agree — but that use-case doesn't require uv to read and mutate an &quot;active&quot; virtual environment.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:39:18 UTC
    </footer>
</body>
</html>
