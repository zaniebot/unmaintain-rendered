<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use junctions instead of symlinks on Windows - astral-sh/uv #1087</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use junctions instead of symlinks on Windows</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/1087">#1087</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-01-25 01:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-25 01:26</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>When we unzip wheels in the cache, we write the directories out to an <code>archive-v0</code> bucket, and then symlink into that bucket from the <code>wheels-v0</code> and <code>built-wheels-v0</code> buckets.</p>
<p>On Windows, symlinks are not well supported. Specifically, they need to be explicitly enabled by the user. So, instead of symlinks, we now use junctions, which are well-supported on Windows, and allow you to (effectively) symlink a directory to another directory. This PR implements said junction support, which gets the core installer working on Windows.</p>
<p>In the past, we also used symlinks to implement another primitive: we wanted to be able to replace a directory &quot;atomically&quot; (I put &quot;atomically&quot; in quotes because I don't know if it's actually a guaranteed atomic operation), in case someone was trying to use the directory while we were replacing it (as opposed to deleting the directory, then moving it into place).</p>
<p>On Windows, it doesn't appear to be possible to atomically replace a junction. So instead, I'm using a new design, whereby the cache always returns canonicalized paths. We know these canonicalized paths are unique and won't be replaced, so they're safe for writers to rely on. In general, when we write new data to the cache, we now return the canonicalized path. When we read from the cache, and try to identify (e.g.) the set of wheels available to us, we canonicalize the links immediately and consider them non-existent if that operation fails.</p>
<p>Closes #1085.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2024-01-25 01:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-01-25 01:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">windows</span> added by @charliermarsh on 2024-01-25 01:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2024-01-25 01:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/puffin-fs/src/lib.rs</code>:18 on 2024-01-25 08:55</div>
            <div class="timeline-body"><p>Why do have to delete again here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-01-25 08:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-01-25 09:06</div>
            <div class="timeline-body"><p>Merging since this unblocks me</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2024-01-25 09:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2024-01-25 09:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-01-25 09:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-25 13:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-fs/src/lib.rs</code>:18 on 2024-01-25 13:43</div>
            <div class="timeline-body"><p>Deleting the reparse point does not delete the file or directly (this is in the docs).</p>
<p>In my testing, deleting the directory without deleting the reparse point gave me an error. And so did deleting the reparse point without deleting the directory.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 15:39:26 UTC
    </footer>
</body>
</html>
