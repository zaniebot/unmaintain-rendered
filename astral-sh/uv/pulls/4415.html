<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv-resolver: filter out sibling dependencies in a fork - astral-sh/uv #4415</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv-resolver: filter out sibling dependencies in a fork</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/4415">#4415</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2024-06-19 15:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>When a fork is created from a list of dependencies, we were previously
adding all other sibling dependencies to every fork created. But this
isn't actually quite right, since the fork created is always created by
some marker expression. And while it is definitively disjoint from any
directly conflicting dependency specification, it is also possibly
disjoint with other dependencies. For example, as reported in #4414:</p>
<pre><code class="language-toml">dependencies = [
  &quot;anyio==4.4.0 ; python_version &gt;= '3.12'&quot;,
  &quot;anyio==4.3.0 ; python_version &lt; '3.12'&quot;,
  &quot;b1 ; python_version &gt;= '3.12'&quot;,
  &quot;b2 ; python_version &lt; '3.12'&quot;,
]
</code></pre>
<p>The first two <code>anyio</code> requirements are conflicting with non-overlapping
marker expressions, and so a fork is created. Prior to this commit,
<em>both</em> <code>b1</code> and <code>b2</code> would be added to each fork. But of course, <code>b2</code> is
impossible in the <code>anyio==4.4.0</code> fork because of disjoint marker
expressions.</p>
<p>So in this commit, we specifically filter out any sibling dependencies
that could find their way into a fork that have disjoint markers with
that fork. We are careful to do this both when a new fork is created
from an existing set of dependencies, and when adding new dependencies
to a fork.</p>
<p>Fixes #4414</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-06-19 15:38</div>
            <div class="timeline-body"><p>I added a packse test here: https://github.com/astral-sh/packse/pull/197</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @BurntSushi on 2024-06-19 15:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/lock_scenarios.rs</code>:824 on 2024-06-20 11:07</div>
            <div class="timeline-body"><p>Should we start censoring the packse version so an upgrade isn't a huge diff each time?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-06-20 11:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv/tests/lock_scenarios.rs</code>:824 on 2024-06-20 11:21</div>
            <div class="timeline-body"><p>cc @zanieb</p>
<p>I don't think I'm opposed to that. I do try to update the tests in a separate commit so that it's a little easier to review. But I agree there is a fair bit of noise in the diff.</p>
<p>Another possible mitigation here would be a way to update the existing tests without adding any new ones, commit that, and then do an update with the new tests. But I think that'd be a little annoying to do in practice.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-06-20 11:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2024-06-20 11:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2024-06-20 11:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-06-20 11:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:37:37 UTC
    </footer>
</body>
</html>
