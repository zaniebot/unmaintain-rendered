<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Always spawn a main2 thread to normalize main stack size issues - astral-sh/uv #10479</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Always spawn a main2 thread to normalize main stack size issues</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/10479">#10479</a>
        opened by <a href="https://github.com/Gankra">@Gankra</a>
        on 2025-01-10 20:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/Gankra">@Gankra</a> on 2025-01-10 20:11</div>
            <div class="timeline-body"><p>Also removes UV_STACK_SIZE and uses RUST_MIN_STACK instead, tweaking docs to reflect the differences.</p>
<p>Fixes #10367</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-01-10 20:11</div>
            <div class="timeline-body"><p>I'll do a followup PR that just removes RUST_MIN_STACK from our CI to see if it's actually doing anything anymore.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-10 20:15</div>
            <div class="timeline-body"><p>Oh excellent</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-10 20:23</div>
            <div class="timeline-body"><p>Is there any way for us to set this &quot;automatically&quot; like in <code>config.toml</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-01-10 20:32</div>
            <div class="timeline-body"><blockquote>
<p>Is there any way for us to set this &quot;automatically&quot; like in config.toml?</p>
</blockquote>
<p>Not to my knowledge, no. There's no build-time var, only this runtime var (read once in life-before-main aiui).</p>
<p>Our CI and tests set this aggressively on windows, and past comments suggest it &quot;doesn't happen&quot; on release builds (and would therefore be a memory waster to set?).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-01-10 21:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/src/lib.rs</code>:1834 on 2025-01-10 21:15</div>
            <div class="timeline-body"><p>How much does this change the overhead of something like <code>uv run echo &quot;hi&quot;</code> or <code>uv run python -c &quot;print(\&quot;hello world\&quot;)&quot;</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-01-10 21:15</div>
            <div class="timeline-body"><p>I am glad I finally understand why windows main thread stack size kept coming up even though our var can't change it (setting it also undocumentedly-forced us to make main2).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-01-10 21:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/uv/src/lib.rs</code>:1834 on 2025-01-10 21:22</div>
            <div class="timeline-body"><p>looking now on windows, but it'll be platform-specific to say the least (could test linux in WSL2?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-01-10 22:02</div>
            <div class="timeline-body"><p>Windows testing has this in the noise even for trivial ops where this can dominate:</p>
<p><img src="https://github.com/user-attachments/assets/d48c9e30-3b90-402b-ae91-b5d96665ce8a" alt="image" />
<img src="https://github.com/user-attachments/assets/0bb4a4fd-c35a-4f7e-a6bb-528871a28592" alt="image" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-01-14 16:42</div>
            <div class="timeline-body"><p>macos is similar
<img width="608" alt="Screenshot 2025-01-14 at 11 41 06 AM" src="https://github.com/user-attachments/assets/f105f7c8-9d3a-400a-aef0-f68f20686721" />
<img width="613" alt="Screenshot 2025-01-14 at 11 41 44 AM" src="https://github.com/user-attachments/assets/9731b680-252b-468a-a3aa-091d21de5e48" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-01-14 16:44</div>
            <div class="timeline-body"><p>linux doesn't differ much either:</p>
<pre><code>$ hyperfine --runs 200 './uv-main run python -c &quot;print(\&quot;hello world\&quot;)&quot;' './uv-stacked run python -c &quot;print(\&quot;hello world\&quot;)&quot;'
Benchmark 1: ./uv-main run python -c &quot;print(\&quot;hello world\&quot;)&quot;
  Time (mean ± σ):      14.8 ms ±   1.4 ms    [User: 8.8 ms, System: 6.0 ms]
  Range (min … max):    11.1 ms …  17.7 ms    200 runs
 
Benchmark 2: ./uv-stacked run python -c &quot;print(\&quot;hello world\&quot;)&quot;
  Time (mean ± σ):      15.2 ms ±   1.3 ms    [User: 8.8 ms, System: 6.3 ms]
  Range (min … max):    11.9 ms …  17.8 ms    200 runs
 
Summary
  ./uv-main run python -c &quot;print(\&quot;hello world\&quot;)&quot; ran
    1.02 ± 0.13 times faster than ./uv-stacked run python -c &quot;print(\&quot;hello world\&quot;)&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2025-01-14 16:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-01-14 16:51</div>
            <div class="timeline-body"><p>Outstanding: the current impl actually &quot;regresses&quot; configurability by unconditionally setting a 4mb main2 thread, ignoring RUST_MIN_STACK. I should tweak the code to check if it's set and prefer that when it is (or maybe take the max so people don't accidentally break uv by making stack too small?).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-01-14 20:04</div>
            <div class="timeline-body"><blockquote>
<p>I'll do a followup PR that just removes RUST_MIN_STACK from our CI to see if it's actually doing anything anymore.</p>
</blockquote>
<p>Decided to add this to this PR now that I have a better understanding of the constraints and ensure normalized size between OSes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "remove UV_STACK_SIZE and use RUST_MIN_STACK instead" to "Always spawn a main2 thread to normalize main stack size issues" by @Gankra on 2025-01-14 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @Gankra on 2025-01-14 20:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Gankra on 2025-01-15 03:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @Gankra on 2025-01-15 03:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Gankra on 2025-01-15 03:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @Gankra on 2025-01-15 03:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @Gankra on 2025-01-15 03:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Gankra on 2025-01-15 03:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-15 03:35</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:17 UTC
    </footer>
</body>
</html>
