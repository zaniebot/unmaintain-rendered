<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add hash-checking support to `install` and `sync` - astral-sh/uv #2945</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add hash-checking support to <code>install</code> and <code>sync</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/2945">#2945</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-04-09 20:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-09 20:15</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds support for hash-checking mode in <code>pip install</code> and <code>pip sync</code>. It's a large change, both in terms of the size of the diff and the modifications in behavior, but it's also one that's hard to merge in pieces (at least, with any test coverage) since it needs to work end-to-end to be useful and testable.</p>
<p>Here are some of the most important highlights:</p>
<ul>
<li>We store hashes in the cache. Where we previously stored pointers to unzipped wheels in the <code>archives</code> directory, we now store pointers with a set of known hashes. So every pointer to an unzipped wheel also includes its known hashes.</li>
<li>By default, we don't compute any hashes. If the user runs with <code>--require-hashes</code>, and the cache doesn't contain those hashes, we invalidate the cache, redownload the wheel, and compute the hashes as we go. For users that don't run with <code>--require-hashes</code>, there will be no change in performance. For users that <em>do</em>, the only change will be if they don't run with <code>--generate-hashes</code> -- then they may see some repeated work between resolution and installation, if they use <code>pip compile</code> then <code>pip sync</code>.</li>
<li>Many of the distribution types now include a <code>hashes</code> field, like <code>CachedDist</code> and <code>LocalWheel</code>.</li>
<li>Our behavior is similar to pip, in that we enforce hashes when pulling any remote distributions, and when pulling from our own cache. Like pip, though, we <em>don't</em> enforce hashes if a distribution is <em>already</em> installed.</li>
<li>Hash validity is enforced in a few different places:<ol>
<li>During resolution, we enforce hash validity based on the hashes reported by the registry. If we need to access a source distribution, though, we then enforce hash validity at that point too, prior to running any untrusted code. (This is enforced in the distribution database.)</li>
<li>In the install plan, we <em>only</em> add cached distributions that have matching hashes. If a cached distribution is missing any hashes, or the hashes don't match, we don't return them from the install plan.</li>
<li>In the downloader, we <em>only</em> return distributions with matching hashes.</li>
<li>The final combination of &quot;things we install&quot; are: (1) the wheels from the cache, and (2) the downloaded wheels. So this ensures that we never install any mismatching distributions.</li>
</ol>
</li>
<li>Like pip, if <code>--require-hashes</code> is provided, we require that <em>all</em> distributions are pinned with either <code>==</code> or a direct URL. We also require that <em>all</em> distributions have hashes.</li>
</ul>
<p>There are a few notable TODOs:</p>
<ul>
<li>We don't support hash-checking mode for unnamed requirements. These should be <em>somewhat</em> rare, though? Since <code>pip compile</code> never outputs unnamed requirements. I can fix this, it's just some additional work.</li>
<li>We don't automatically enable <code>--require-hashes</code> with a hash exists in the requirements file. We require <code>--require-hashes</code>.</li>
</ul>
<p>Closes #474.</p>
<h2>Test Plan</h2>
<p>I'd like to add some tests for registries that report incorrect hashes, but otherwise: <code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @charliermarsh on 2024-04-09 20:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2024-04-09 20:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @charliermarsh on 2024-04-09 20:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-09 20:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/distribution-types/src/prioritized_distribution.rs</code>:459 on 2024-04-09 20:28</div>
            <div class="timeline-body"><p>@zanieb - I could use your help with this part. I'm not sure if I did the comparisons correctly here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-09 20:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-extract/src/hash.rs</code>:146 on 2024-04-09 20:29</div>
            <div class="timeline-body"><p>@BurntSushi - Do you mind reviewing this component? The basic idea is a wrapper around any reader that can compute a set of hashes as we go. It's then used to wrap the async streams as we unzip.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2024-04-09 21:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-09 21:27</div>
            <div class="timeline-body"><p>Open to advice on how best to test that if a registry tells us the <em>wrong</em> hashes, we still validate them at install time. I need a registry or <code>--find-links</code> entry that reports the wrong hashes for a given distribution.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @charliermarsh on 2024-04-09 21:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @charliermarsh on 2024-04-09 21:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2024-04-09 21:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @BurntSushi removed by @charliermarsh on 2024-04-09 21:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-09 21:47</div>
            <div class="timeline-body"><p>A few TODOs:</p>
<ul>
<li>[x] Add some tests for invalid indexes.</li>
<li>[x] Run a basic benchmark (especially, to ensure that there's no regression for non-<code>--require-hashes</code>).</li>
</ul>
<p>I'd also like to refactor the dataflow from requirements file to <code>RequireHashes</code>, but this isn't required to merge.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-09 22:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/tests/pip_sync.rs</code>:4226 on 2024-04-09 22:03</div>
            <div class="timeline-body"><p>This is a TODO. We reject distributions without hashes when <code>--require-hashes</code> is provided, whereas in reality we should compute them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-09 22:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/distribution-types/src/prioritized_distribution.rs</code>:459 on 2024-04-09 22:29</div>
            <div class="timeline-body"><p>I think this is actually wrong, although I'm not sure if it matters. You're supposed to be enforcing an ordering but here you're saying that <code>MissingHash</code> and <code>MismatchedHash</code> are <em>never</em> more compatible than the other value. This means that if we see both <code>MissingHash</code> and <code>MismatchedHash</code> we would arbitrarily display the first one we saw instead of preferring to present one of them to the user.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-09 23:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/distribution-types/src/prioritized_distribution.rs</code>:459 on 2024-04-09 23:12</div>
            <div class="timeline-body"><p>I decided to change up the strategy in https://github.com/astral-sh/uv/pull/2949, such that we treat distributions without hashes as compatible (but lower-priority). I can merge that into this PR if you agree with the change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-09 23:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/tests/pip_sync.rs</code>:4226 on 2024-04-09 23:25</div>
            <div class="timeline-body"><p>I solved this in #2949.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>Cargo.toml</code>:97 on 2024-04-10 12:03</div>
            <div class="timeline-body"><p>Do we want to support md5? It's cryptographically broken</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/cached_client.rs</code>:303 on 2024-04-10 12:14</div>
            <div class="timeline-body"><p>I don't think we need to instrument function</p>
<pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-distribution/src/archive.rs</code>:12 on 2024-04-10 12:17</div>
            <div class="timeline-body"><p>nit: we have a constructor and getters</p>
<pre><code class="language-suggestion">    /// The path to the archive entry in the wheel's archive bucket.
    path: PathBuf,
    /// The computed hashes of the archive.
    hashes: Vec&lt;HashDigest&gt;,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-distribution/src/distribution_database.rs</code>:545 on 2024-04-10 12:23</div>
            <div class="timeline-body"><p>Why don't we spawn blocking here too?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-distribution/src/error.rs</code>:87 on 2024-04-10 12:24</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    #[error(&quot;Failed to finish hashing file&quot;)]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-04-10 12:28</div>
            <div class="timeline-body"><p>Not exactly this PR (more #2909), but do we have an explanation for .http/.rev files in the docstrings?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-extract/src/hash.rs</code>:35 on 2024-04-10 12:34</div>
            <div class="timeline-body"><p>Just to double check, these are all run with buffered readers so we don't do those context switches too often, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-04-10 12:45</div>
            <div class="timeline-body"><p>Nice work!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-10 13:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-extract/src/hash.rs</code>:35 on 2024-04-10 13:53</div>
            <div class="timeline-body"><p>Yes!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-10 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-distribution/src/distribution_database.rs</code>:545 on 2024-04-10 13:54</div>
            <div class="timeline-body"><p>Because it's async whereas the other version is sync. Does that make sense?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-extract/src/hash.rs</code>:120 on 2024-04-10 15:09</div>
            <div class="timeline-body"><p>This is potentially putting 8KB on the stack. Maybe not an issue, but it's big enough to stand out to me.</p>
<p>I think I'd probably just use <code>vec![0; 8192]</code> here instead. You could put it in a <code>thread_local!</code> to amortize the alloc if you're concerned about perf.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-extract/src/hash.rs</code>:146 on 2024-04-10 15:10</div>
            <div class="timeline-body"><p>Aye. I think I have just one concern but otherwise this looks pretty reasonable to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-04-10 15:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-extract/src/hash.rs</code>:146 on 2024-04-10 15:11</div>
            <div class="timeline-body"><p>Tyvm!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-10 15:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-04-10 17:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-distribution/src/distribution_database.rs</code>:545 on 2024-04-10 17:31</div>
            <div class="timeline-body"><p>yeah</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-04-10 19:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-04-10 19:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-10 19:09</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 14:43:51 UTC
    </footer>
</body>
</html>
