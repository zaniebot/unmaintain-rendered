<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handle cycles when propagating markers - astral-sh/uv #4595</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Handle cycles when propagating markers</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/4595">#4595</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-06-27 18:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>It turns out that <code>Topo</code> only works on graphs without cycles. If a graph has a cycle, it seems to bail early. So we were losing markers for trees that contain cycles (like Poetry, which depends on <code>poetry-plugin-export</code>, which depends on Poetry).</p>
<p>Now, we remove cycles beforehand and re-add those edges afterwards.</p>
<p>It&#x27;s a bit hard for me to reason about the implications of this. The way that marker propagation works is that we do visit the nodes in-order and propagate the markers from any incoming to any outgoing edges. We only do this at a single depth (rather than recursively) because we visit the nodes in-order anyway. But if you have a cycle... then in theory you might need to propagate the markers recursively? Or maybe not?</p>
<p>As an example:</p>
<p><code>A -&gt; B -&gt; C -&gt; D -&gt; B</code></p>
<p>If <code>A -&gt; B</code> has <code>sys_platform == &#x27;darwin&#x27;</code>, and then <code>D -&gt; B</code> has <code>python_version &gt;= &#x27;3.7</code>... then we don&#x27;t need to propagate <code>python_version &gt;= &#x27;3.7&#x27;</code> back to <code>B</code> or any of its dependencies, because the condition would be <code>(sys_platform == &#x27;darwin&#x27; or python_version &gt;= &#x27;3.7) or sys_platform == &#x27;darwin&#x27;</code>, which is equivalent to <code>sys_platform == &#x27;darwin&#x27;</code>.</p>
<p>Closes #4584.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-27 18:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/BurntSushi">@BurntSushi</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-27 18:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-27 18:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-27 19:34</div>
            <div class="timeline-body"><p>The trio resolution changed; need to check if it was incorrect before or is incorrect now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-27 20:56</div>
            <div class="timeline-body"><p>Ok, this is a clear improvement, but I&#x27;m going to look into doing something more rigorous.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-06-27 21:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-27 21:14</div>
            <div class="timeline-body"><p>This looks like a pretty reasonable start.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-27 21:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-27 21:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-06-27 21:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-06-28 13:14</div>
            <div class="timeline-body"><p>LGTM!</p>
<p>I can&#x27;t immediately see where your approach would fail. Maybe something to do with optional dependencies? But I can&#x27;t think of a way that can go wrong.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-28 13:37</div>
            <div class="timeline-body"><p>I really wish there was a way to do this without modifying the graph structure... I&#x27;ve thought a lot about it and I can&#x27;t find a way to do it with a traditional BFS or DFS.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/bluss">@bluss</a> on <code>crates/uv-resolver/src/resolution/display.rs</code>:369 on 2024-06-28 20:58</div>
            <div class="timeline-body"><p>Hm is this maybe not a a StableGraph so not safe to remove edge ids like this probably, unless you sort the edge ids?</p>
<p>This is a drive by comment, but petgraph caught my attention (even though it doesn&#x27;t do that much anymore, sorry about that :slightly_frowning_face: )</p>
<p>About your general questions in this PR - the back of my mind says reverse postorder to do something similar to Topo but accomodating cycles to some extent. Petgraph has DfsPostOrder among other things. (To reverse it, its output must be collected and then reversed.)</p>
<p>An algorithm like scc https://docs.rs/petgraph/latest/petgraph/algo/fn.kosaraju_scc.html  finds both the sccs (they are the cyclic parts) as well as a topological order between each component too, which is not cyclic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bluss">@bluss</a> reviewed on 2024-06-28 20:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-28 23:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/resolution/display.rs</code>:369 on 2024-06-28 23:51</div>
            <div class="timeline-body"><p>Oh that’s a very smart comment — the edge IDs could change, right!</p>
<p>I would love help with this problem BTW…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bluss">@bluss</a> reviewed on 2024-06-29 09:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/bluss">@bluss</a> on <code>crates/uv-resolver/src/resolution/display.rs</code>:369 on 2024-06-29 09:25</div>
            <div class="timeline-body"><p>Well, I am acutely aware of petgraph&#x27;s shortcomings but I&#x27;m happy that it&#x27;s still useful. You managed to snipe me, so I&#x27;ve made a try :slightly_smiling_face:</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:46:10 UTC
    </footer>
</body>
</html>
