<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In pylock.toml export, include dependencies (name, marker and version) - astral-sh/uv #14783</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>In pylock.toml export, include dependencies (name, marker and version)</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/pull/14783">#14783</a>
        opened by <a href="https://github.com/pimdh">@pimdh</a>
        on 2025-07-21 09:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/pimdh">@pimdh</a></div>
            <div class="timeline-body">Summary
<p>In the code for export a lock file to <code>pylock.toml</code>, I added the <code>[[packages.dependencies]]</code> field (https://packaging.python.org/en/latest/specifications/pylock-toml/#packages-dependencies). The goal of this change is to utilize <code>uv</code> to generate lockfiles for use with Pants and PEX (see <a href="https://github.com/pantsbuild/pants/issues/22201">pantsbuild/pants#22201</a>).</p>
<p>Fixes #13032.</p>
<p>Details:</p>
<ul>
<li>Because this dependency field is not fully specified, I only include the package&#x27;s name and version (EDIT: and marker), which seems sufficient for integrating the resulting files with Pants and Pex.</li>
<li>I didn&#x27;t add the dependencies to <code>from_resolution</code>, because I don&#x27;t need it, and because it wasn&#x27;t immediately clear to me how the edges and nodes in the resolution graph would have to be filtered.</li>
<li>I filter the dependencies based on those selected by <code>ExportableRequirements::from_lock</code> for inclusion in the lockfile.</li>
</ul>
Test Plan
<p>I&#x27;ve updated the tests to include the dependencies.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/konstin">@konstin</a> on 2025-07-21 09:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pimdh">@pimdh</a> on 2025-07-21 10:02</div>
            <div class="timeline-body"><p>I see where the tests are now. Fixing them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pimdh">@pimdh</a> on 2025-07-21 12:10</div>
            <div class="timeline-body"><p>I&#x27;ve added the dependencies to the tests, and fixed the linting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-07-22 19:12</div>
            <div class="timeline-body"><p>Thanks @pimdh. We technically might be required to add (e.g.) the VCS annotations and such here... I need to review the spec.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jsirois">@jsirois</a> on 2025-07-23 21:03</div>
            <div class="timeline-body"><p>FWIW, I think name and version is not enough to cover all uv.locks. My analysis here: <a href="https://github.com/astral-sh/uv/issues/13032">astral-sh/uv#13032</a>#issuecomment-3110161811</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pimdh">@pimdh</a> on 2025-08-20 21:50</div>
            <div class="timeline-body"><p>Hi! Is there anything I can do to help get this PR merged?</p>
<p>I&#x27;m happy to do any of the following:</p>
<ul>
<li>keep the PR as is, so that dependencies are listed as (name, version)</li>
<li>add any of the other <code>PylockTomlPackage</code> fields to the dependencies</li>
<li>programmatically find a minimum subset of fields of <code>PylockTomlPackage</code> so that the dependency uniquely selects one of the packages. For example by picking some order in the fields, then iteratively decide to include it if it different among the candidates, and terminating when it uniquely picks a package.</li>
</ul>
<p>Please let me know which solution you prefer.</p>
<p>For the use-case I am interested in - generating lockfiles for the Pants build system with UV for my monorepo - the first option seems to currently suffice. Although I do understand, as @jsirois states, that this doesn&#x27;t lead to unique identification in all cases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;In pylock.toml export, include dependencies (name and version)&quot; to &quot;In pylock.toml export, include dependencies (name, marker and version)&quot; by <a href="https://github.com/pimdh">@pimdh</a> on 2025-08-25 14:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pimdh">@pimdh</a> on 2025-08-25 14:52</div>
            <div class="timeline-body"><p>Following the point by @jsirois, and my own experience that (name, version) does not guarantee that each dependency uniquely identifies a package, I&#x27;ve added the <code>marker</code> to the each dependency. This seems to successfully allow matching of dependencies with packages. The resulting <code>pylock.toml</code> files appear compatible with PEX.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dannytodd">@dannytodd</a> on 2025-12-09 17:40</div>
            <div class="timeline-body"><p>+1 for this. This would allow much easier integration of uv&#x27;s locking mechanism into existing tooling.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:53:15 UTC
    </footer>
</body>
</html>
