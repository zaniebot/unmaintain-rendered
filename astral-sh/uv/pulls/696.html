<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>improve tests for version parser - astral-sh/uv #696</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>improve tests for version parser</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/696">#696</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2023-12-18 22:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-12-18 22:36</div>
            <div class="timeline-body"><p>The high level goal here is to improve the tests for the version parser. Namely, we now check not just that version strings parse successfully, but that they parse to the expected result.</p>
<p>We also do a few other cleanups. Most notably, <code>Version</code> is now an opaque type so that we can more easily change its representation going forward.</p>
<p>Reviewing commit-by-commit is suggested. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @BurntSushi on 2023-12-18 22:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @BurntSushi on 2023-12-18 22:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @BurntSushi on 2023-12-18 22:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-12-18 23:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/pep440-rs/src/lib.rs</code>:52 on 2023-12-18 23:13</div>
            <div class="timeline-body"><p>üëç We used to do this via using <code>rustfmt</code> nightly... Now I occasionally run IntelliJ's &quot;Organize Imports&quot; command which leads to some of the organization we have.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-12-18 23:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-resolver/src/pubgrub/specifier.rs</code>:75 on 2023-12-18 23:13</div>
            <div class="timeline-body"><p>Did this disappear by accident?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-12-18 23:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-12-18 23:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-resolver/src/pubgrub/specifier.rs</code>:75 on 2023-12-18 23:16</div>
            <div class="timeline-body"><p>Only &quot;blocking&quot; feedback -- double-checking that this was intentional.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-12-18 23:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/puffin-resolver/src/pubgrub/specifier.rs</code>:75 on 2023-12-18 23:34</div>
            <div class="timeline-body"><p>No actually! I had re-written it to use the public accessors on <code>Version</code>, and that triggered an unused code warning. I guess the way it is written today (since <code>low</code> is assigned to in place) doesn't trigger it. In any case, <code>low</code> isn't used after this point. It <em>looks</em> like it should, but if you do, the tests fail due to a version resolution being impossible.</p>
<p>Since this code was a no-op today, and &quot;fixing&quot; it in the obvious way resulted in test failures and because I didn't quite understand what the right path was, I just decided to remove it. I meant to flag it in the commit message, but clearly forgot.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-12-18 23:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/pep440-rs/src/lib.rs</code>:52 on 2023-12-18 23:37</div>
            <div class="timeline-body"><p>Yeah I'm still doing it by hand like a nincompoop. I should just figure out a flow to make <code>rustfmt</code> do it in an opt-in fashion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/pep440-rs/src/version.rs</code>:356 on 2023-12-19 08:14</div>
            <div class="timeline-body"><p>Doesn't the compiler inline trivial methods by itself?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/pep440-rs/src/version.rs</code>:644 on 2023-12-19 08:16</div>
            <div class="timeline-body"><p>TIL :bulb:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/pep440-rs/src/version.rs</code>:1271 on 2023-12-19 08:20</div>
            <div class="timeline-body"><p>Can this be <code>assert_eq!</code>? I'm surprised clippy doesn't complain.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-12-19 08:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-12-19 08:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/pep440-rs/src/version.rs</code>:356 on 2023-12-19 08:37</div>
            <div class="timeline-body"><p>Inside a crate, I think yes. Across crates: Depends on the enabled LTO optimisations. But I agree, I don't think it's necessary to mark all these functions as <code>#[inline]</code> except we have evidence that inlining some of them in hot-paths is beneficial</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-12-19 16:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/pep440-rs/src/version.rs</code>:356 on 2023-12-19 16:07</div>
            <div class="timeline-body"><p>Right. Across crates, unless a function would otherwise be monomorphized because of generics (not the case here), a function needs an <code>#[inline]</code> or <code>#[inline(always)]</code> annotation in order to get inlined. As @MichaReiser mentions though, the exception is LTO. When LTO is enabled, cross crate inlining becomes available.</p>
<p>The <code>#[inline]</code> annotations here are warranted IMO for the following reasons:</p>
<ul>
<li>It reduces our reliance on LTO for inlining trivial functions. We control our own destiny. If we were always using fat LTO, you could make an argument that we don't need this. But we use thin LTO (currently, and I think we should probably continue to do so).</li>
<li>These are trivial non-generic functions and this is an <code>#[inline]</code> annotation and not an <code>#[inline(always)]</code> annotation. The former is a hint, true, but not just a hint. Here it's more used as &quot;I'm telling the compiler to make these <em>available</em> for inlining.&quot;</li>
</ul>
<p>I'm personally somewhat relaxed about <code>#[inline]</code>. It's the <code>#[inline(always)]</code> annotations that I try to reserve for &quot;we have a good reason to do this.&quot;</p>
<p>This is good reading: https://matklad.github.io/2021/07/09/inline-in-rust.html</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-12-19 16:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/pep440-rs/src/version.rs</code>:644 on 2023-12-19 16:19</div>
            <div class="timeline-body"><p>So when I did this I thought I was very clever. But it turns out that Insta uses <code>{:#?}</code> in its output, so this makes all the snapshots uses this bloated alternate formatting.</p>
<p>I think you were the one that made this terser right? Did you do that for the snapshots or for something else? Because I do really want to keep the terser formatting. I only really wanted the more verbose output for tests inside this crate because it's useful to see when test failures occur.</p>
<p>If you're not fond of the snapshots getting bloated again, I can find another way to go about this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/pep440-rs/src/version.rs</code>:1271 on 2023-12-19 16:20</div>
            <div class="timeline-body"><p>It can be, but the error message isn't as good because it uses <code>{:?}</code> and not <code>{:#?}</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-12-19 16:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-12-19 17:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/pep440-rs/src/version.rs</code>:644 on 2023-12-19 17:03</div>
            <div class="timeline-body"><p>Okay, I've worked around this with a new test-only type that gives me the verbose debug representation and left the <code>Debug</code> impl that was there alone.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2023-12-19 17:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2023-12-19 17:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-12-19 17:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 15:45:06 UTC
    </footer>
</body>
</html>
