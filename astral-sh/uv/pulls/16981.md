```yaml
number: 16981
title: "Summarize package changes in `uv sync` json format output"
type: pull_request
state: open
author: EliteTK
labels:
  - preview
assignees: []
draft: true
base: main
head: tk/sync-summary
created_at: 2025-12-04T15:39:33Z
updated_at: 2025-12-08T22:50:42Z
url: https://github.com/astral-sh/uv/pull/16981
synced_at: 2026-01-10T01:57:38Z
```

# Summarize package changes in `uv sync` json format output

---

_Pull request opened by @EliteTK on 2025-12-04 15:39_

## Summary

Implement #16653 by making `uv sync --output-format=json` output information about package changes. 

## Test Plan

So far there are integration tests but they don't quite cover everything that I think they maybe should. A bunch of manual testing was performed too. Test suite passes.

## Notes/Outstanding issues

I am not certain about the whole approach. The crux of the issue is that `dry_run` doesn't "prepare" remote `Dist`s and `Changelog::new` expects `CachedDist`s. It's possible to make a `CachedDist` from a `Dist` using `CachedDist::from_remote`, `hashes` and `cache_info` can understandably be empty. `path` could maybe be something fake, but the problem comes from `filename` which is a wheel filename. The issue is that calculating a plausible wheel filename for most `Dist::Source` `Dist`s isn't possible without building the wheel.

So  the current approach involved changing `Changelog` to accept `Dist` and dealing with resolving the fallout. This could probably be simplified if `ChangedDist` was just a `PackageName` and `Option<CanonicalVersion>`. There are a lot of places which are using the full `InstalledVersion` for comparison which can contain a URL despite the fact that in other places (e.g. when it was used in hashsets) the `canonical_version` is used (which seems correct).

However, even then, `Changelog`'s contents are often smuggled through `ChangeEvent` which expects `dist` to implement `InstalledMetadata` a trait which exposes `installed_version`, but the problem is that `Changelog` can now contain packages without versions.

Putting in a fake version is an option, but that strictly presents wrong information to users. I guess one option is to extend `Version` to be able to hold an empty version (currently explicitly not allowed) or maybe just `CanonicalVersion` to have an `Unknown` variant.

There are some other issues/side effects of the current set of problems.

---

_Label `preview` added by @EliteTK on 2025-12-04 15:39_

---

_Converted to draft by @EliteTK on 2025-12-04 15:39_

---

_@EliteTK reviewed on 2025-12-04 15:41_

---

_Review comment by @EliteTK on `crates/uv/src/commands/pip/loggers.rs`:164 on 2025-12-04 15:41_

This now allocates unfortunately. Let me know if there's a straightforward way to avoid this (I am aware of `either` being probably usable here, but I didn't want to add dependencies - although it is used elsewhere).

---

_@EliteTK reviewed on 2025-12-04 15:42_

---

_Review comment by @EliteTK on `crates/uv/src/commands/pip/loggers.rs`:157 on 2025-12-04 15:42_

Example of where installed_version is used for comparison when canonical_version is strictly more appropriate.

---

_Review comment by @EliteTK on `crates/uv/src/commands/pip/operations.rs`:443 on 2025-12-04 15:45_

This is awful, it's a direct side effect of `ChangeEvent` requiring this type implements `InstalledMetadata`. I think that potentially, since `ChangeEvent` is only used (in this way - actually not sure anymore) in the logger and in uv-sync, it may make sense to use a different type and then this whole thing can be avoided.

---

_@EliteTK reviewed on 2025-12-04 15:45_

---

_@EliteTK reviewed on 2025-12-04 15:47_

---

_Review comment by @EliteTK on `crates/uv/src/commands/pip/operations.rs`:506 on 2025-12-04 15:47_

Annoying duplication. I may investigate de-duplicating this.

---

_Review comment by @EliteTK on `crates/uv/src/commands/project/sync.rs`:1267 on 2025-12-04 15:49_

https://github.com/astral-sh/uv/pull/16660#discussion_r2510856345

---

_@EliteTK reviewed on 2025-12-04 15:49_

---

_Review requested from @zanieb by @EliteTK on 2025-12-04 15:50_

---

_@konstin reviewed on 2025-12-04 15:58_

---

_Review comment by @konstin on `crates/uv/src/commands/pip/loggers.rs`:164 on 2025-12-04 15:58_

I'm not worried about this allocating, it's not in a hot loop, it's cheaper than a lot of the hidden allocations we do and the number of versions we print is very limited (and printing is usually very slow in comparison)

---

_Referenced in [astral-sh/uv#16660](../../astral-sh/uv/pulls/16660.md) on 2025-12-04 16:16_

---

_Comment by @EliteTK on 2025-12-04 18:36_

So, to summarise a discussion from Discord, a suggestion was made to pull out the planning step from `pip::operations::install` into a separate `plan` function. Or, alternatively, just return the plan from `install`.

The goal being that a `PackageChangeReport::from_plan` can be added and used in the dry-run case, avoiding going through `Changelog` entirely, saving a bunch of code.

I've started to explore the idea of pulling out `plan`, but I don't think it's worth it. It adds a lot of boilerplate. I'll submit it as a separate PR and then I'll consider the alternative. Then whatever the result of that, this PR can be rebased on top and simplified.

---

_Referenced in [astral-sh/uv#16985](../../astral-sh/uv/pulls/16985.md) on 2025-12-05 14:30_

---

_Comment by @EliteTK on 2025-12-05 15:01_

So, the idea behind `--dry-run` is to produce output which is similar to what is produced without it, but without actually performing any actions. So, for example, the outputs below are almost identical:

~~~bash session
$ uv sync
Resolved 6 packages in 2ms
Uninstalled 4 packages in 5ms
Installed 3 packages in 8ms
 - anyio==4.12.0
 + charset-normalizer==3.4.4
 - h11==0.16.0
 - httpcore==1.0.9
 - httpx==0.28.1
 + requests==2.32.5
 + urllib3==2.5.0
$ magically_revert_state # Trade secret
$ uv sync --dry-run
Would use project environment at: .venv
Resolved 6 packages in 1ms
Found up-to-date lockfile at: uv.lock
Would uninstall 4 packages
Would install 3 packages
 - anyio==4.12.0
 + charset-normalizer==3.4.4
 - h11==0.16.0
 - httpcore==1.0.9
 - httpx==0.28.1
 + requests==2.32.5
 + urllib3==2.5.0
~~~

And the goal of the json output is to present this information in JSON.

In the output above, the normal path uses `InstallLogger::on_complete`, but `report_dry_run` re-implements the code from `DefaultInstallLogger::on_complete` and kind of effectively produces the same information which would have been in `Changelog`. This[^1] `Changelog` is only ever used to implement `InstallLogger::on_complete` logging, I think it actually would make sense for `Changelog` be the type which uniformly stores the information (regardless of whether it was from an install, or a dry-run install).

I think the only real changes which would be required is to: Expand the kinds of dists that `Changelog` can contain, so it can contain remote dists, and then adjust the respective `ChangeEvent` type (which similarly is only used within `on_complete`) to be able to deal with things without versions (possibly just fall back to a URL like the current `report_dry_run` code does). This would have the knock-on effect of allowing `report_dry_run` to just use the `on_complete` logger, cutting it down further.

Finally, `report_dry_run` can just return this `Changelog` type.

I believe this can all be done while keeping things pretty clean. Definitely no `ZERO_VERSION` hack ;).

Let me know what you think.

[^1]: There are two `Changelog` types and two `ChangeEvent` types because of the slightly different requirements of where they are used. Both the logging functionality and the different changelogs could be unified, I think. But I don't think that it would necessarily benefit from being done now. I can kind of see it though, would be good to investigate one day, as there are two places where the `DefaultInstallLogger::on_complete` functionality is re-implemented verbatim. In fact, the changes suggested here would probably make such a change easier to implement.

---

_Comment by @zanieb on 2025-12-05 15:03_

Sounds fine to me!

---

_Referenced in [astral-sh/uv#17039](../../astral-sh/uv/pulls/17039.md) on 2025-12-08 22:11_

---
