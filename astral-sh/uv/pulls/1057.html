<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add `--refresh` behavior to the cache - astral-sh/uv #1057</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add <code>--refresh</code> behavior to the cache</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/1057">#1057</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-01-23 05:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>This PR is an alternative approach to #949 which should be much safer. As in #949, we add a <code>Refresh</code> policy to the cache. However, instead of deleting entries from the cache the first time we read them, we now check if the entry is sufficiently new (created after the start of the command) if the refresh policy applies. If the entry is stale, then we avoid reading it and continue onward, relying on the cache to appropriately overwrite based on &quot;new&quot; data. (This relies on the preceding PRs, which ensure the cache is append-only, and ensure that we can atomically overwrite.)</p>
<p>Unfortunately, there are just a lot of paths through the cache, and didn&#x27;t data is handled with different policies, so I really had to go through and consider the &quot;right&quot; behavior for each case. For example, the HTTP requests can use <code>max-age=0, must-revalidate</code>. But for the routes that are based on filesystem modification, we need to do something slightly different.</p>
<p>Closes #945.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-23 05:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-23 05:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-distribution/src/source/mod.rs</code>:973 on 2024-01-23 05:34</div>
            <div class="timeline-body"><p>If you&#x27;re installing from an archive, like <code>flask @ ./flask.tar.gz</code>, then we trust the modification timestamp and ignore freshness requirements. (If you&#x27;re installing from a directory, and so we&#x27;re using the timestamp of the <code>pyproject.toml</code>, we <em>don&#x27;t</em> trust the timestamp, and respect freshness requirements.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-23 05:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-distribution/src/distribution_database.rs</code>:123 on 2024-01-23 05:51</div>
            <div class="timeline-body"><p>I plan to do at least the first part of this in a follow-up PR. (It&#x27;s easy and covers the vast majority of common cases, since we almost always have hashes.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-23 05:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-distribution/src/distribution_database.rs</code>:196 on 2024-01-23 05:51</div>
            <div class="timeline-body"><p>I think this requires that we write the caching data <em>somewhere</em>, e.g., we&#x27;d need to have a file like <code>foo.whl.cache</code> next to the <code>foo.whl</code> directory.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-23 05:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-23 05:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-23 05:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-01-23 15:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-01-23 23:04</div>
            <div class="timeline-body"><p>LGTM :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-23 23:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-23 23:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-01-23 23:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:43:20 UTC
    </footer>
</body>
</html>
