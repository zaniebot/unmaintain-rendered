```yaml
number: 2094
title: "virtualenv: determine 'site-packages' based on implementation name"
type: pull_request
state: merged
author: BurntSushi
labels: []
assignees: []
merged: true
base: main
head: ag/tweak-site-packages-path
created_at: 2024-02-29T20:37:25Z
updated_at: 2024-02-29T20:58:38Z
url: https://github.com/astral-sh/uv/pull/2094
synced_at: 2026-01-10T14:54:43Z
```

# virtualenv: determine 'site-packages' based on implementation name

---

_Pull request opened by @BurntSushi on 2024-02-29 20:37_

I'm not at all sure whether this is a correct fix or not, but it does
seem to make `pypy` work in at least some cases with `uv`. Previously,
I couldn't get it to work at all. Namely the virtualenv was created
with a `lib/python3.10/site-packages`, but whenever I did a `uv
pip install` in that virtualenv, it was looking for a non-existent
`lib/pypy3.10/site-packages` directory.

With this PR, the workflow reported as not working in #1488 now works
for me:

```
$ pypy3 --version
Python 3.10.13 (fc59e61cfbff, Jan 17 2024, 05:35:45)
[PyPy 7.3.15 with GCC 13.2.1 20230801]

$ uv venv --python $(which pypy3) --seed
Using Python 3.10.13 interpreter at: /usr/bin/pypy3
Creating virtualenv at: .venv
 + pip==24.0
 + setuptools==69.1.1
 + wheel==0.42.0
Activate with: source .venv/bin/activate

$ uv pip install 'alembic==1.0.11'
Resolved 9 packages in 8ms
Installed 9 packages in 14ms
 + alembic==1.0.11
 + greenlet==3.0.3
 + mako==1.3.2
 + markupsafe==2.1.5
 + python-dateutil==2.8.2
 + python-editor==1.0.4
 + six==1.16.0
 + sqlalchemy==2.0.27
 + typing-extensions==4.10.0
```

Where as previously (current `main`), I was hitting this error:

```
$ uv venv --python $(which pypy3) --seed
Using Python 3.10.13 interpreter at: /usr/bin/pypy3
Creating virtualenv at: .venv
 + pip==24.0
 + setuptools==69.1.1
 + wheel==0.42.0
Activate with: source .venv/bin/activate

$ uv pip install 'alembic==1.0.11'
error: Failed to list installed packages
  Caused by: failed to read directory `/home/andrew/astral/issues/uv/i1488/.venv/lib/pypy3.10/site-packages`
  Caused by: No such file or directory (os error 2)
```

Notice though that neither outcome above matches the error reported in #1488,
so this is likely not a complete fix. There are perhaps other lurking
issues.

Ref #1488


---

_Review requested from @konstin by @BurntSushi on 2024-02-29 20:37_

---

_Review requested from @charliermarsh by @BurntSushi on 2024-02-29 20:37_

---

_Review comment by @charliermarsh on `crates/uv-interpreter/src/interpreter.rs`:438 on 2024-02-29 20:46_

I'd probably cut this part, it can exist in Git if we need it later!

---

_@charliermarsh approved on 2024-02-29 20:46_

---

_Comment by @charliermarsh on 2024-02-29 20:47_

I filed https://github.com/astral-sh/uv/issues/2095 with some more info on what I think a "proper" fix would look like.

---

_Merged by @BurntSushi on 2024-02-29 20:57_

---

_Closed by @BurntSushi on 2024-02-29 20:57_

---

_Branch deleted on 2024-02-29 20:57_

---

_Review comment by @BurntSushi on `crates/uv-interpreter/src/interpreter.rs`:438 on 2024-02-29 20:58_

I deleted it in a separate commit so that it's actually preserved in history (and did a rebase & merge). Otherwise this would have only been preserved on GitHub maybe?

---

_@BurntSushi reviewed on 2024-02-29 20:58_

---
