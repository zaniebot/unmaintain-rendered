<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix race condition while refreshing pyx tokens - astral-sh/uv #17479</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix race condition while refreshing pyx tokens</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/pull/17479">#17479</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2026-01-14 23:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>Prevent concurrent processes from all refreshing the token simultaneously by using a file lock. When a refresh is needed:</p>
<ol>
<li>Acquire an exclusive file lock (which will block if another process is refreshing)</li>
<li>Re-read the tokens from disk and check if they are fresh enough, instead of making another request</li>
<li>Otherwise, perform the refresh and update the cached tokens</li>
</ol>
<p>This prevents thundering herd issues when multiple concurrent processes are invoking <code>uv auth token</code> or <code>uv auth helper</code> at the same time.</p>
<p>Also, set the tolerance for <code>uv auth helper</code> to the same as <code>uv auth token</code> (5 minutes).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-15 00:12</div>
            <div class="timeline-body"><p>cc @charliermarsh I think this is probably sound even if it's not causing the Bazel issue @zsol is going to look into?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2026-01-15 05:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zsol">@zsol</a> on <code>crates/uv-auth/src/pyx.rs</code>:414 on 2026-01-15 09:54</div>
            <div class="timeline-body"><p>I would version the contents of this lockfile, just in case we need to change its contents in future releases. It could be as simple as the first 2 bytes containing a version marker, followed by content</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zsol">@zsol</a> reviewed on 2026-01-15 09:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zsol">@zsol</a> on 2026-01-15 09:58</div>
            <div class="timeline-body"><p>This seems to resolve the issue I'm seeing, verified with the following simple script:</p>
<pre><code class="language-python">#!/usr/bin/env python3
&quot;&quot;&quot;Request pyx auth tokens from uv in concurrent attempts.&quot;&quot;&quot;

import argparse
import asyncio


async def get_auth_token(
    index: int, uv_binary: str
) -&gt; tuple[int, str | None, str | None]:
    &quot;&quot;&quot;Request an auth token from uv.&quot;&quot;&quot;
    proc = await asyncio.create_subprocess_exec(
        uv_binary,
        &quot;auth&quot;,
        &quot;helper&quot;,
        &quot;--preview-features&quot;,
        &quot;auth-helper&quot;,
        &quot;--protocol&quot;,
        &quot;bazel&quot;,
        &quot;get&quot;,
        stdin=asyncio.subprocess.PIPE,
        stdout=asyncio.subprocess.PIPE,
        stderr=asyncio.subprocess.PIPE,
    )
    input_json = b'{&quot;uri&quot;: &quot;https://api.pyx.dev/&quot;}'
    stdout, stderr = await proc.communicate(input=input_json)

    if proc.returncode == 0:
        return (index, stdout.decode().strip(), None)
    else:
        return (index, None, stderr.decode().strip())


async def main(invocations: int, uv_binary: str) -&gt; None:
    &quot;&quot;&quot;Run n concurrent auth token requests.&quot;&quot;&quot;
    print(f&quot;Starting {invocations} concurrent auth token requests...&quot;)

    tasks = [get_auth_token(i, uv_binary) for i in range(invocations)]
    results = await asyncio.gather(*tasks)

    successes = 0
    failures = 0

    for index, token, error in results:
        if token:
            successes += 1
            # Only print first few characters of token for privacy.
            print(f&quot;[{index:3d}] Success: {token[:5]}...&quot;)
        else:
            failures += 1
            print(f&quot;[{index:3d}] Failed: {error}&quot;)

    print(f&quot;\nResults: {successes} successes, {failures} failures&quot;)


if __name__ == &quot;__main__&quot;:
    parser = argparse.ArgumentParser(
        description=&quot;Request PyX auth tokens from uv in concurrent attempts&quot;
    )
    parser.add_argument(
        &quot;-n&quot;,
        &quot;--invocations&quot;,
        type=int,
        default=100,
        help=&quot;Number of concurrent requests (default: 100)&quot;,
    )
    parser.add_argument(
        &quot;--uv&quot;,
        default=&quot;uv&quot;,
        help=&quot;Path to uv binary (default: uv)&quot;,
    )
    args = parser.parse_args()
    asyncio.run(main(args.invocations, args.uv))
</code></pre>
<p>On my machine, calling this with <code>uv run $script -n 300</code> would consistently fail on uv 0.9.25, but never with this PR applied.</p>
<p>However, with <code>-n 1000</code> I'm now running into the default <code>UV_LOCK_TIMEOUT</code> of five minutes</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zsol">@zsol</a> on <code>crates/uv/src/commands/auth/helper.rs</code>:95 on 2026-01-15 15:21</div>
            <div class="timeline-body"><p>let's set this to <code>false</code> and ship :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zsol">@zsol</a> approved on 2026-01-15 15:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Add debounce to pyx token refresh" to "Fix race condition while refreshing pyx tokens" by @zsol on 2026-01-15 15:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zsol on 2026-01-15 15:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-15 15:54:51 UTC
    </footer>
</body>
</html>
