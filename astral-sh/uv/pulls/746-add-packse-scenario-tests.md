```yaml
number: 746
title: Add packse scenario tests
type: pull_request
state: merged
author: zanieb
labels: []
assignees: []
merged: true
base: main
head: zb/packse-test-scenarios
created_at: 2024-01-02T22:58:19Z
updated_at: 2024-01-03T21:50:07Z
url: https://github.com/astral-sh/uv/pull/746
synced_at: 2026-01-12T16:04:09Z
```

# Add packse scenario tests

---

_@zanieb_

Adds tests using packse test scenarios! Uses `test.pypi.org` as a backing index.

Tests are generated by a simple Python script. Requires https://github.com/zanieb/packse/pull/49.

This opens us to a slight attack surface, as we cannot force use of `test.pypi.org` only and someone could register these package names on the real `pypi.org` index with malicious content. I could publish these packages there too.

---

_Comment by @zanieb on 2024-01-02 23:06_

Right now, we just install the "root" package of each scenario. However, the scenarios are framed such that the user has requested the dependencies of the root package. We can adjust the tests to directly request those dependencies in the future, which gives us better test coverage i.e. we can have scenarios covering conflicts in direct dependencies rather than just indirect ones.

---

_@zanieb reviewed on 2024-01-02 23:12_

---

_Review comment by @zanieb on `crates/puffin-cli/tests/pip_install_scenarios.rs`:125 on 2024-01-02 23:12_

This is a bug in the scenario, ref https://github.com/zanieb/packse/pull/50

---

_@charliermarsh approved on 2024-01-03 00:08_

---

_Review comment by @konstin on `scripts/scenarios/generate.py`:40 on 2024-01-03 10:49_

Could we replace this with:
```rust

    insta::with_settings!({
        filters => INSTA_FILTERS.to_vec()
    }, {
        assert_cmd_snapshot!(
            run_scenario("{{ prefix }}"),
            @r###"<snapshot>
        "###);
```

---

_@konstin reviewed on 2024-01-03 10:49_

---

_@zanieb reviewed on 2024-01-03 16:25_

---

_Review comment by @zanieb on `scripts/scenarios/generate.py`:40 on 2024-01-03 16:25_

Sure! 

---

_@zanieb reviewed on 2024-01-03 16:37_

---

_Review comment by @zanieb on `scripts/scenarios/generate.py`:40 on 2024-01-03 16:37_

Actually... I don't really get it. We need all these scoped variables e.g. the cache, venv, temp dir and it seems silly to pass them all through to `run_scenario`?

---

_Comment by @zanieb on 2024-01-03 17:30_

Failing due to panic in `requires_transitive_incompatible_with_transitive` introduced by #744 

```
stack backtrace:␊
   0: std::panicking::begin_panic␊
             at /rustc/82e1608dfa6e0b5569232559e3d385fea5a93112/library/std/src/panicking.rs:686:12␊
   1: waitmap::Ref<K,V,S>::value␊
             at /Users/mz/.cargo/registry/src/index.crates.io-6f17d22bba15001f/waitmap-1.1.0/src/lib.rs:132:32␊
   2: puffin_resolver::error::NoSolutionError::with_available_versions␊
             at /Users/mz/eng/src/astral-sh/puffin/crates/puffin-resolver/src/error.rs:186:51␊
   3: puffin_resolver::resolver::Resolver<Provider>::resolve::{{closure}}::{{closure}}␊
             at /Users/mz/eng/src/astral-sh/puffin/crates/puffin-resolver/src/resolver.rs:299:50␊
   4: core::result::Result<T,E>::map_err␊
             at /rustc/82e1608dfa6e0b5569232559e3d385fea5a93112/library/core/src/result.rs:829:27␊
   5: puffin_resolver::resolver::Resolver<Provider>::resolve::{{closure}}␊
             at /Users/mz/eng/src/astral-sh/puffin/crates/puffin-resolver/src/resolver.rs:296:17␊
   6: puffin::commands::pip_install::resolve::{{closure}}␊
             at /Users/mz/eng/src/astral-sh/puffin/crates/puffin-cli/src/commands/pip_install.rs:376:41␊
   7: puffin::commands::pip_install::pip_install::{{closure}}␊
             at /Users/mz/eng/src/astral-sh/puffin/crates/puffin-cli/src/commands/pip_install.rs:184:6␊
   8: puffin::inner::{{closure}}␊
             at /Users/mz/eng/src/astral-sh/puffin/crates/puffin-cli/src/main.rs:525:14␊
   9: puffin::main::{{closure}}␊
             at /Users/mz/eng/src/astral-sh/puffin/crates/puffin-cli/src/main.rs:547:19␊
  10: tokio::runtime::park::CachedParkThread::block_on::{{closure}}␊
             at /Users/mz/.cargo/registry/src/index.crates.io-6f17d22bba15001f/tokio-1.33.0/src/runtime/park.rs:282:63␊
  11: tokio::runtime::coop::with_budget␊
             at /Users/mz/.cargo/registry/src/index.crates.io-6f17d22bba15001f/tokio-1.33.0/src/runtime/coop.rs:107:5␊
  12: tokio::runtime::coop::budget␊
             at /Users/mz/.cargo/registry/src/index.crates.io-6f17d22bba15001f/tokio-1.33.0/src/runtime/coop.rs:73:5␊
  13: tokio::runtime::park::CachedParkThread::block_on␊
             at /Users/mz/.cargo/registry/src/index.crates.io-6f17d22bba15001f/tokio-1.33.0/src/runtime/park.rs:282:31␊
  14: tokio::runtime::context::blocking::BlockingRegionGuard::block_on␊
             at /Users/mz/.cargo/registry/src/index.crates.io-6f17d22bba15001f/tokio-1.33.0/src/runtime/context/blocking.rs:66:9␊
  15: tokio::runtime::scheduler::multi_thread::MultiThread::block_on::{{closure}}␊
             at /Users/mz/.cargo/registry/src/index.crates.io-6f17d22bba15001f/tokio-1.33.0/src/runtime/scheduler/multi_thread/mod.rs:87:13␊
  16: tokio::runtime::context::runtime::enter_runtime␊
             at /Users/mz/.cargo/registry/src/index.crates.io-6f17d22bba15001f/tokio-1.33.0/src/runtime/context/runtime.rs:65:16␊
  17: tokio::runtime::scheduler::multi_thread::MultiThread::block_on␊
             at /Users/mz/.cargo/registry/src/index.crates.io-6f17d22bba15001f/tokio-1.33.0/src/runtime/scheduler/multi_thread/mod.rs:86:9␊
  18: tokio::runtime::runtime::Runtime::block_on␊
             at /Users/mz/.cargo/registry/src/index.crates.io-6f17d22bba15001f/tokio-1.33.0/src/runtime/runtime.rs:350:45␊
  19: puffin::main␊
             at /Users/mz/eng/src/astral-sh/puffin/crates/puffin-cli/src/main.rs:547:5␊
  20: core::ops::function::FnOnce::call_once␊
             at /rustc/82e1608dfa6e0b5569232559e3d385fea5a93112/library/core/src/ops/function.rs:250:5␊
```

---

_Merged by @zanieb on 2024-01-03 21:50_

---

_Closed by @zanieb on 2024-01-03 21:50_

---

_Branch deleted on 2024-01-03 21:50_

---
