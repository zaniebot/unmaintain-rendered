<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use environment layering for `uv run --with` - astral-sh/uv #3447</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use environment layering for <code>uv run --with</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/3447">#3447</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-05-08 02:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>This PR takes a different approach to <code>--with</code> for <code>uv run</code>. Now, instead of merging the requirements and re-resolving, we have two phases: (1) sync the workspace requirements to the workspace environment; then (2) sync the ephemeral <code>--with</code> requirements to an ephemeral environment. The two environments are then layered by setting the <code>PATH</code> and <code>PYTHONPATH</code> variables appropriately.</p>
<p>I think this approach simplifies a few things:</p>
<ol>
<li>Once we have a lockfile, the semantics are much clearer, and we can actually reuse it for the workspace. If we had to add arbitrary dependencies via <code>--with</code>, then it&#x27;s not really clear how the lockfile would/should behave.</li>
<li>Caching becomes simpler, because we can just cache the ephemeral environment based on the requirements.</li>
</ol>
<p>The current version of this PR loses a few behaviors though that I need to restore:</p>
<ul>
<li><code>--python</code> support -- but I&#x27;m not yet sure how this is supposed to behave within projects? It&#x27;s also left unclear in <code>uv sync</code> and <code>uv lock</code>.</li>
<li>The &quot;reuse the workspace environment if it already satisfies the ephemeral requirements&quot; behavior.</li>
</ul>
<p>Closes #3411.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-08 02:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-08 02:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-08 02:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/workspace/run.rs</code>:74 on 2024-05-08 02:08</div>
            <div class="timeline-body"><p>Just throwing this out here to think about... wouldn&#x27;t it be annoying if we exposed a default environment at <code>.venv</code> and every time you used <code>uv run</code> any manual changes you had made were undone?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-05-08 02:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-08 02:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/workspace/run.rs</code>:74 on 2024-05-08 02:12</div>
            <div class="timeline-body"><p>Yeah, though this doesn&#x27;t uninstall anything, it just makes sure it&#x27;s in-sync with the (in-the-future) lockfile. Does that seem right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/src/commands/workspace/run.rs</code>:78 on 2024-05-08 09:24</div>
            <div class="timeline-body"><p>That&#x27;s curious, how is that implemented in rust, does this insert a conditional drop?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-05-08 09:29</div>
            <div class="timeline-body"><p>Do we know how resource discovery interacts with <code>PYTHONPATH</code>, e.g. for finding jupyter kernels?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-05-08 13:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/workspace/run.rs</code>:74 on 2024-05-08 13:35</div>
            <div class="timeline-body"><p>Ah we&#x27;ll need to be careful with &quot;in sync&quot; because sync implies an exact match (no extra packages) to me. Seems ideal not to remove packages unless requested? Like.. <code>uv sync --strict</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-08 13:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/workspace/run.rs</code>:74 on 2024-05-08 13:37</div>
            <div class="timeline-body"><p>This is in uv run, not uv sync. For now, neither one is removing packages, but I donâ€™t feel strongly about the behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-05-08 13:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/workspace/run.rs</code>:74 on 2024-05-08 13:39</div>
            <div class="timeline-body"><p>I understand that, I&#x27;m talking more generally.</p>
<p><code>uv run</code> should not probably not remove extraneous packages (and I understand that is the current behavior).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-05-08 20:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-08 21:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-08 21:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-05-08 21:24</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:45:14 UTC
    </footer>
</body>
</html>
