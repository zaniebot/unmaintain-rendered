<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Switch to msgpack in the cached client - astral-sh/uv #662</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Switch to msgpack in the cached client</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/662">#662</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2023-12-15 13:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>This gives a 1.23 speedup on transformers-extras. We could change to msgpack for the entire cache if we want. I only tried this format and postcard so far, where postcard was much slower (like 1.6s).</p>
<p>I don&#x27;t actually want to merge it like this, i wanted to figure out the ballpark of improvement for switching away from json.</p>
<pre><code>hyperfine --warmup 3 --runs 10 &quot;target/profiling/puffin pip-compile --cache-dir cache-msgpack scripts/requirements/transformers-extras.in&quot; &quot;target/profiling/branch pip-compile scripts/requirements/transformers-extras.in&quot;
Benchmark 1: target/profiling/puffin pip-compile --cache-dir cache-msgpack scripts/requirements/transformers-extras.in
  Time (mean ± σ):     179.1 ms ±   4.8 ms    [User: 157.5 ms, System: 48.1 ms]
  Range (min … max):   174.9 ms … 188.1 ms    10 runs

Benchmark 2: target/profiling/branch pip-compile scripts/requirements/transformers-extras.in
  Time (mean ± σ):     221.1 ms ±   6.7 ms    [User: 208.1 ms, System: 46.5 ms]
  Range (min … max):   213.5 ms … 235.5 ms    10 runs

Summary
  target/profiling/puffin pip-compile --cache-dir cache-msgpack scripts/requirements/transformers-extras.in ran
    1.23 ± 0.05 times faster than target/profiling/branch pip-compile scripts/requirements/transformers-extras.in
</code></pre>
<p>Disadvantage: We can&#x27;t manually look into the cache anymore to debug things</p>
<ul>
<li>[ ] Check more formats, i currently only tested json, msgpack and postcard, there should be other formats, too</li>
<li>[x] Switch over <code>CachedByTimestamp</code> serialization (for the interpreter caching)</li>
<li>[x] Switch over error handling and make sure puffin is still resilient to cache failure</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-12-15 14:12</div>
            <div class="timeline-body"><p>Other than dropping the <code>unwrap()</code>, it seems like we ought to merge this given the win? Or is there some other downside I&#x27;m missing here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-12-15 14:30</div>
            <div class="timeline-body"><ul>
<li>Check more formats, i currently only tested json, msgpack and postcard, there should be other formats, too</li>
<li>Switch over <code>CachedByTimestamp</code> serialization (for the interpreter caching)</li>
<li>Switch over error handling and make sure puffin is still resilient to cache failure</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-12-15 14:32</div>
            <div class="timeline-body"><p>With respect to other formats, I just figured that could be done as future work. If msgpack gives a nice speed-up for this small of a change, I&#x27;d say merge it. Assuming cache failure resiliency is still okay. (How is that tested?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-15 16:48</div>
            <div class="timeline-body"><p>I think it&#x27;s fine to merge/change this without testing other formats, it seems purely beneficial. But yeah, we should probably move over other opaque cache structures to it too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-16 20:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-16 20:29</div>
            <div class="timeline-body"><p>Let&#x27;s give this a shot for now -- easy to change in the future, and worth playing with on <code>main</code>. I added to the appropriate places and removed the unwraps.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-16 20:37</div>
            <div class="timeline-body"><p>I also did some testing to validate that msgpack is robust to bad cache entries by running on main, then running against on this branch without changing the cache extensions to <code>.msgpack</code>:</p>
<pre><code>0.001927s  WARN puffin_interpreter::interpreter Ignoring invalid cached markers for: /Users/crmarsh/workspace/guffin/.venv/bin/python
...
0.658065s  WARN puffin_client::cached_client Broken cache entry at /Users/crmarsh/workspace/guffin/foo/simple-v0/pypi/aiosignal.json, removing: invalid type: integer `123`, expected struct DataWithCachePolicy
...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-16 21:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-16 21:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-12-16 21:01</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:42:56 UTC
    </footer>
</body>
</html>
