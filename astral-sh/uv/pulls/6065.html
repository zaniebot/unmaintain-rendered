<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Propagate fork markers to extras - astral-sh/uv #6065</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Propagate fork markers to extras</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/6065">#6065</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-08-13 18:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>When constructing the <code>Resolution</code>, we only propagated the fork markers to the package node, but not the extras node. This led to cases in which an extra could be included unconditionally or otherwise diverge from the base package version.</p>
<p>Closes https://github.com/astral-sh/uv/issues/6062.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-08-13 18:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">resolver</span> added by @charliermarsh on 2024-08-13 18:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @charliermarsh on 2024-08-13 18:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-13 18:05</div>
            <div class="timeline-body"><p>This isn't quite doing the right thing in <code>lock_python_version_marker_complement</code>. I'm getting an instability there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @charliermarsh on 2024-08-13 18:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-13 18:07</div>
            <div class="timeline-body"><p>I think my change is correct but now hitting the aforementioned instability.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-13 18:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/resolver/mod.rs</code>:2356 on 2024-08-13 18:07</div>
            <div class="timeline-body"><p>I moved this into graph construction, since we're now AND-ing the fork markers with <em>every</em> edge.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-13 18:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/tests/lock_scenarios.rs</code>:1417 on 2024-08-13 18:11</div>
            <div class="timeline-body"><p>These may not be strictly necessary... Because you can only reach this node on <code>sys_platform == 'darwin'</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2024-08-13 18:15</div>
            <div class="timeline-body"><p>I think this looks right to me.</p>
<p>In terms of moving this PR forward, maybe I cherry pick this PR into my branch that will (hopefully) fix the instability issue? So it won't get merged right away, but it will be in an active branch somewhere.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-13 18:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/tests/lock_scenarios.rs</code>:1417 on 2024-08-13 18:15</div>
            <div class="timeline-body"><p>(Yeah confirmed. Is it wrong to include then?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/tests/snapshots/ecosystem__transformers-lock-file.snap</code>:1905 on 2024-08-13 18:15</div>
            <div class="timeline-body"><p>Ouch, not good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-13 18:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-13 18:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/tests/snapshots/ecosystem__transformers-lock-file.snap</code>:1901 on 2024-08-13 18:15</div>
            <div class="timeline-body"><p>So that's a bugfix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-08-13 18:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv/tests/snapshots/ecosystem__transformers-lock-file.snap</code>:1901 on 2024-08-13 18:17</div>
            <div class="timeline-body"><p>Yup! ANd there's no extra here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-13 18:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/tests/snapshots/ecosystem__warehouse-lock-file.snap</code>:3147 on 2024-08-13 18:18</div>
            <div class="timeline-body"><p>This looks wrong. I don't know where it's coming from.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-08-13 18:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv/tests/lock_scenarios.rs</code>:1417 on 2024-08-13 18:19</div>
            <div class="timeline-body"><p>I don't think it's <em>wrong</em>, but it does seem superfluous. But I'm okay to run with it for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/tests/snapshots/ecosystem__warehouse-lock-file.snap</code>:3147 on 2024-08-13 18:24</div>
            <div class="timeline-body"><p>Debugging this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-13 18:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/tests/snapshots/ecosystem__warehouse-lock-file.snap</code>:3147 on 2024-08-13 18:38</div>
            <div class="timeline-body"><p>I haven’t figured this out yet, I think I should understand why this is happening before we merge @BurntSushi though you’re welcome to cherry-pick.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-13 18:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-13 20:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/tests/snapshots/ecosystem__warehouse-lock-file.snap</code>:3147 on 2024-08-13 20:51</div>
            <div class="timeline-body"><p>Oh... I guess this is actually fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-13 20:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/tests/snapshots/ecosystem__warehouse-lock-file.snap</code>:3147 on 2024-08-13 20:51</div>
            <div class="timeline-body"><p>It's just redundant.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-13 20:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/tests/snapshots/ecosystem__warehouse-lock-file.snap</code>:3147 on 2024-08-13 20:52</div>
            <div class="timeline-body"><p>I needed to see it with fresh eyes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-13 22:19</div>
            <div class="timeline-body"><p>Very hard to explain but regarding the instability: it has to do with the fact that when we resolve without a lockfile, we create the fork <em>on the dependencies</em> of the <code>project</code>. So we iterate over all dependencies, then create forks.</p>
<p>When we resolve <em>with</em> a lockfile, we fork on the project itself... So when we go to solve for that project's dependencies, we already have a <code>requires-python</code> marker which we then apply to filter out certain dependencies.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-13 22:23</div>
            <div class="timeline-body"><p>That might need to be solved holistically, though fixing the normalization to detect disjointness for these would also help.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-13 22:23</div>
            <div class="timeline-body"><p>Basically, we end up with this bad fork due to the confusion:</p>
<pre><code>DEBUG skipping iniconfig ; python_version &gt;= '3.10' because of context resolver markers python_full_version &gt; '3.10' and python_version &lt; '3.10'
DEBUG skipping iniconfig ; python_version &lt; '3.10' because of Requires-Python python_full_version &gt; '3.10' and python_version &gt; '3.10'
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-14 01:13</div>
            <div class="timeline-body"><p>Rebasing on https://github.com/astral-sh/uv/pull/6076 does fix one of the instabilities, but <code>github_wikidata_bot</code> is still unstable...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-08-14 13:37</div>
            <div class="timeline-body"><blockquote>
<p>but <code>github_wikidata_bot</code> is still unstable</p>
</blockquote>
<p>Is this the only issue? If so, I'd say flip this test to non-deterministic (like <code>transformers</code>) via <code>lock_ecosystem_package_non_deterministic</code> and merge it. That way we're working from a common base and because this PR fixes bugs where there are multiple versions of the same package for the same marker environment in the lock file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-14 13:40</div>
            <div class="timeline-body"><p>Yeah will do. <code>lock_python_version_marker_complement</code> and <code>lock_conditional_dependency_extra</code> also became non-deterministic, but some of those are fixed upstream I think. I'm gonna document and merge.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-08-14 13:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-08-14 13:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-08-14 13:55</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:38:52 UTC
    </footer>
</body>
</html>
