<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Respect `NO_COLOR` env var in `uv help` output - astral-sh/uv #7223</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Respect <code>NO_COLOR</code> env var in <code>uv help</code> output</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/pull/7223">#7223</a>
        opened by <a href="https://github.com/blueraft">@blueraft</a>
        on 2024-09-09 16:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/blueraft">@blueraft</a> on 2024-09-09 16:33</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Resolves #7219</p>
<h2>Test Plan</h2>
<img width="1194" alt="Screenshot 2024-09-09 at 18 32 37" src="https://github.com/user-attachments/assets/23fd1506-5dab-4897-8b87-2cc65fe56baf">

<img width="813" alt="Screenshot 2024-09-10 at 09 40 56" src="https://github.com/user-attachments/assets/0610c0a5-e5d9-49db-8544-5165dba981b5">

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-09 20:54</div>
            <div class="timeline-body"><p>Yeah it seems hard. Does Clap stop parsing options when it encounters <code>--help</code>? Do we need to invoke the short-help callback ourselves?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/eth3lbert">@eth3lbert</a> on 2024-09-10 00:12</div>
            <div class="timeline-body"><p>We have already disabled the default help flag and replaced it with our own but with <code>action = clap::ArgAction::HelpShort</code>.</p>
<p>It's uncertain if it's worthwhile, but I believe you could achieve this by first mutating the <code>help</code> argument and changing its action to <code>clap::ArgAction::SetTrue</code>, then attempting to get matches with errors disabled.</p>
<p>Something like the following should work:</p>
<pre><code class="language-diff">diff --git a/crates/uv/src/lib.rs b/crates/uv/src/lib.rs
index df4780c0..d3bbb56e 100644
--- a/crates/uv/src/lib.rs
+++ b/crates/uv/src/lib.rs
@@ -1359,9 +1359,22 @@ where
 {
     // `std::env::args` is not `Send` so we parse before passing to our runtime
     // https://github.com/rust-lang/rust/pull/48005
+    let args = args.into_iter().collect::&lt;Vec&lt;_&gt;&gt;();
+    let matches = Cli::command()
+        .mut_arg(&quot;help&quot;, |arg| arg.action(clap::ArgAction::SetTrue))
+        .ignore_errors(true)
+        .try_get_matches_from(args.clone());
+    let no_color = matches.is_ok_and(|arg| {
+        matches!(
+            arg.try_get_one::&lt;uv_cli::ColorChoice&gt;(&quot;color&quot;),
+            Ok(Some(uv_cli::ColorChoice::Never))
+        )
+    });
     let cli = match Cli::try_parse_from(args) {
         Ok(cli) =&gt; cli,
         Err(mut err) =&gt; {
+            let cmd = Cli::command().disable_colored_help(no_color);
+            err = err.with_cmd(&amp;cmd);
             if let Some(ContextValue::String(subcommand)) = err.get(ContextKind::InvalidSubcommand)
             {
                 match subcommand.as_str() {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blueraft">@blueraft</a> on 2024-09-10 07:40</div>
            <div class="timeline-body"><p>Awesome, thank you @eth3lbert.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-04-28 12:43</div>
            <div class="timeline-body"><p>I've rebased and comfirmed the change still works, anything missing here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blueraft">@blueraft</a> on 2025-04-28 12:59</div>
            <div class="timeline-body"><p>I don't think so, just waiting for review</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @konstin on 2025-04-28 12:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:13 UTC
    </footer>
</body>
</html>
