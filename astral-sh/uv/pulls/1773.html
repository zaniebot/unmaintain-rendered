<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linker copies files as a fallback when ref-linking fails - astral-sh/uv #1773</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Linker copies files as a fallback when ref-linking fails</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/1773">#1773</a>
        opened by <a href="https://github.com/snowsignal">@snowsignal</a>
        on 2024-02-20 18:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes #1444.</p>
<p>In situations where the installer fails to perform a reflink, a regular file copy is also attempted, as a fallback. This circumvents issues with linking files across filesystems or volumes.</p>
<h2>Test Plan</h2>
<p>N/A</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @snowsignal on 2024-02-20 18:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">installer</span> added by @snowsignal on 2024-02-20 18:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @snowsignal on 2024-02-20 18:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @snowsignal on 2024-02-20 18:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-02-20 18:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> removed by @konstin on 2024-02-20 18:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @konstin on 2024-02-20 18:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-20 18:36</div>
            <div class="timeline-body"><p>Oh nice, I didn't know this existed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-20 18:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/install-wheel-rs/src/linker.rs</code>:305 on 2024-02-20 18:37</div>
            <div class="timeline-body"><p>I think we need our own version of this that behaves differently when the error is <code>std::io::ErrorKind::AlreadyExists</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-20 18:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/install-wheel-rs/src/linker.rs</code>:305 on 2024-02-20 18:37</div>
            <div class="timeline-body"><p>In that case, copying isn't the right fallback, I think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-20 18:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/install-wheel-rs/src/linker.rs</code>:305 on 2024-02-20 18:38</div>
            <div class="timeline-body"><p>Hence the test failure. Notice that we have a branch for <code>AlreadyExists</code> below, where we recurse.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-20 18:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/install-wheel-rs/src/linker.rs</code>:305 on 2024-02-20 18:38</div>
            <div class="timeline-body"><p>Oh, it looks like <code>reflink_or_copy</code> also doesn't fallback when the target is a directory, per the docs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-02-20 18:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/install-wheel-rs/src/linker.rs</code>:305 on 2024-02-20 18:43</div>
            <div class="timeline-body"><p>We need a <code>reflink_or_copy_all</code>, but if we need to handle <code>AlreadyExists</code> with a no-fallback path we probably can't do it upstream in the <code>reflink_copy</code> crate.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-20 18:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/install-wheel-rs/src/linker.rs</code>:305 on 2024-02-20 18:59</div>
            <div class="timeline-body"><p>Yeah, we should just write our own here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2024-02-20 19:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @snowsignal on 2024-02-20 19:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-20 23:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/install-wheel-rs/src/linker.rs</code>:305 on 2024-02-20 23:19</div>
            <div class="timeline-body"><p>Can we try this without using <code>reflink_or_copy</code>? The workaround here feels like it's not quite the right tradeoff. <code>reflink_or_copy</code> just calls reflink and then, if it fails, it calls copy. Can we just mimic that here? We should be able to tell from the error directly without having to do the additional <code>reflink</code> call.</p>
<p>The other problem with the current approach is that we're going to try and <code>reflink</code> for every file, even though we <em>know</em> it won't work. (If the first reflink fails for any reason other than <code>AlreadyExists</code>, then all of the subsequent reflinks will fail too.) In <code>hardlink_wheel_files</code>, we avoid this by <em>just</em> copying once we know we can't hardlink.</p>
<p>For example, can you try something like: still using <code>reflink_copy::reflink</code> here, then adding another branch below, where if the error is anything other than <code>AlreadyExists</code>, we fall back to recursively copying the directory.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-02-20 23:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/install-wheel-rs/src/linker.rs</code>:305 on 2024-02-20 23:47</div>
            <div class="timeline-body"><p>You're right, this could probably be a lot simpler. Technically, <code>reflink_copy::reflink_or_copy</code> works a bit differently than separate <code>reflink_copy::reflink</code> + <code>std::fs::copy</code> calls, but it's not that important of a difference.</p>
<p>And yes, we should definitely try to avoid doing extra work here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/install-wheel-rs/src/linker.rs</code>:368 on 2024-02-21 03:06</div>
            <div class="timeline-body"><p>Does this need to recursively copy? Does it work if <code>from</code> is a directory? (I notice that in <code>copy_wheel_files</code>, we use <code>walkdir</code>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-21 03:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/install-wheel-rs/src/linker.rs</code>:303 on 2024-02-21 13:53</div>
            <div class="timeline-body"><p>Could we share this type with <code>Attempt</code> below?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/install-wheel-rs/src/linker.rs</code>:337 on 2024-02-21 13:56</div>
            <div class="timeline-body"><p>Does this not need a fallback because reflink-not-supported errors take precedence over already-exists error? If so, could you add a comment?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-02-21 14:06</div>
            <div class="timeline-body"><p>I wonder what the right strategy to test this is, can we create a ram disk or a virtual filesystem as non-root?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-21 14:10</div>
            <div class="timeline-body"><p>I would suggest just stubbing out <code>reflink</code> with a method that always errors.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-02-21 14:16</div>
            <div class="timeline-body"><p>How you implement this rust-wise, without <code>unittest.mock</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-21 14:16</div>
            <div class="timeline-body"><p>@konstin - Oh sorry, I meant for manual testing (while implementing).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-02-21 22:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/install-wheel-rs/src/linker.rs</code>:368 on 2024-02-21 22:06</div>
            <div class="timeline-body"><p>This does need to recursively copy, my mistake.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @snowsignal on 2024-02-21 23:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @snowsignal on 2024-02-21 23:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-02-22 02:57</div>
            <div class="timeline-body"><p>Nice, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-02-22 02:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-02-22 02:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-02-22 02:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-02-22 02:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/install-wheel-rs/src/linker.rs</code>:395 on 2024-02-22 02:57</div>
            <div class="timeline-body"><p>Is this different than including it as an <code>else</code> in the <code>Attempt::Initial</code> arm?</p>
<p>E.g.:</p>
<pre><code class="language-diff">diff --git a/crates/install-wheel-rs/src/linker.rs b/crates/install-wheel-rs/src/linker.rs
index 6275994f..69eff653 100644
--- a/crates/install-wheel-rs/src/linker.rs
+++ b/crates/install-wheel-rs/src/linker.rs
@@ -356,6 +356,9 @@ fn clone_recursive(
                     *attempt = Attempt::UseCopyFallback;
                     clone_recursive(site_packages, wheel, entry, attempt)?;
                 }
+            } else {
+                // If the first reflink succeeded, we'll use reflink for the rest of the install.
+                *attempt = Attempt::Subsequent;
             }
         }
         Attempt::Subsequent =&gt; {
@@ -390,9 +393,6 @@ fn clone_recursive(
         }
     }

-    if *attempt == Attempt::Initial {
-        *attempt = Attempt::Subsequent;
-    }
     Ok(())
 }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a> reviewed on 2024-02-22 04:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/snowsignal">@snowsignal</a> on <code>crates/install-wheel-rs/src/linker.rs</code>:395 on 2024-02-22 04:13</div>
            <div class="timeline-body"><p>It would be, because we also want to update the attempt value in the case of an <code>AlreadyExists</code> error that we handle. For example, if we have to overwrite a file, but don't need to fall-back to copying, this <code>else</code> branch would not be hit.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:35:41 UTC
    </footer>
</body>
</html>
