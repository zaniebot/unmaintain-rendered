<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tests: cache managed Python installs - astral-sh/uv #16723</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>tests: cache managed Python installs</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/pull/16723">#16723</a>
        opened by <a href="https://github.com/nooscraft">@nooscraft</a>
        on 2025-11-13 15:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/nooscraft">@nooscraft</a> on 2025-11-13 15:06</div>
            <div class="timeline-body"><p>Cache managed Python downloads (#16721)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/python_install.rs</code>:2687 on 2025-11-13 15:34</div>
            <div class="timeline-body"><p>Why are we using the cache dir in the offline test?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/python_install.rs</code>:2713 on 2025-11-13 15:34</div>
            <div class="timeline-body"><p>Why this change?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-11-13 15:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-11-13 15:34</div>
            <div class="timeline-body"><p>How fast are the tests before and after, does the cache work?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/nooscraft">@nooscraft</a> reviewed on 2025-11-13 15:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/nooscraft">@nooscraft</a> on <code>crates/uv/tests/it/python_install.rs</code>:2687 on 2025-11-13 15:44</div>
            <div class="timeline-body"><p><code>with_managed_python_dirs()</code> now calls <code>with_python_download_cache()</code>, so without an override the offline test inherits the warm cache and starts passing when earlier tests download that version. Pointing it at a dedicated temp cache keeps the test deterministic, the offline install still fails because the cache is empty, which is what the test asserts.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/nooscraft">@nooscraft</a> reviewed on 2025-11-13 15:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/nooscraft">@nooscraft</a> on <code>crates/uv/tests/it/python_install.rs</code>:2713 on 2025-11-13 15:44</div>
            <div class="timeline-body"><p>Same reason as above,once the helper enables the shared cache by default we need an explicit optout. The new <code>without_python_download_cache()</code> clears the shared value and replaces it with an empty per test cache so no cache scenaris keep utilizing the intended code path.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nooscraft">@nooscraft</a> on 2025-11-13 15:47</div>
            <div class="timeline-body"><blockquote>
<p>How fast are the tests before and after, does the cache work?</p>
</blockquote>
<p>I ran <code>cargo test --package uv --test it python_install -- --nocapture</code> before and after. The very first one still takes about 42 s because we start with an empty cache, but every run after that drops into the 38–39 s range, managed downloads get reused and we stop pulling over the network each time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/it/common/mod.rs</code>:489 on 2025-11-13 15:58</div>
            <div class="timeline-body"><p>I think I'd expect this to no longer be <code>pub</code> and all the redundant calls to be dropped</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-11-13 15:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-11-13 15:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/it/common/mod.rs</code>:509 on 2025-11-13 15:58</div>
            <div class="timeline-body"><p>I don't think this can be an empty directory, we need to exercise the code path where the variable is unset</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nooscraft">@nooscraft</a> on 2025-11-13 16:56</div>
            <div class="timeline-body"><p>Thanks for the feedback, @zanieb! I want to make sure I understand correctly before pushing the changes</p>
<p>I've made with_python_download_cache() non-public and removed all explicit calls from test files (python_install.rs, python_find.rs, python_upgrade.rs, and pip_install.rs).</p>
<p>Since with_managed_python_dirs() now calls it internally, tests using .with_managed_python_dirs() will automatically get the cache enabled. Is this the intended behavior you were looking for?</p>
<p>You mentioned we need to exercise the code path where the variable is unset. I've changed it to:</p>
<pre><code>pub fn without_python_download_cache(mut self) -&gt; Self {
    let key: OsString = EnvVars::UV_PYTHON_CACHE_DIR.into();
    self.extra_env.retain(|(existing, _)| existing != &amp;key);
    self
}
</code></pre>
<p>This removes the variable from extra_env entirely, rather than setting it to an empty directory. Is this what you meant by unsetting the variable, or did you mean something else?</p>
<p>(I want to confirm this correctly tests the &quot;cache disabled&quot; scenario vs just testing &quot;empty cache directory&quot;.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nooscraft">@nooscraft</a> on 2025-11-14 02:55</div>
            <div class="timeline-body"><p>@konstin @zanieb I’ve pushed the changes so it’s easier for you to review what has actually changed, instead of going in circles. If this isn’t the expected outcome, it’s possible I misunderstood the intent behind the original change request. If that’s the case, I’m happy to hand this over to someone with a better understanding of the test and cache logic.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 05:52:31 UTC
    </footer>
</body>
</html>
