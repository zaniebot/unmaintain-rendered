<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optional managed Python archive download cache - astral-sh/uv #12175</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Optional managed Python archive download cache</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/12175">#12175</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2025-03-14 19:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>Part of #11834</p>
<p>Currently, all Python installation are a streaming download-and-extract. With this PR, we add the <code>UV_PYTHON_CACHE_DIR</code> variable. When set, the installation is split into downloading the interpreter into <code>UV_PYTHON_CACHE_DIR</code> and extracting it there from a second step. If the archive is already present in <code>UV_PYTHON_CACHE_DIR</code>, we skip the download.</p>
<p>The feature can be used to speed up tests and CI. Locally for me, <code>cargo test -p uv -- python_install</code> goes from 43s to 7s (1,7s in release mode) when setting <code>UV_PYTHON_CACHE_DIR</code>. It can also be used for offline installation of Python interpreter, by copying the archives to a directory in the offline machine, while the path rewriting is still performed on the target machine on installation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @konstin on 2025-03-14 19:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @konstin on 2025-03-19 14:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @konstin on 2025-03-19 14:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-03-19 18:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-cache/src/lib.rs</code>:997 on 2025-03-19 18:19</div>
            <div class="timeline-body"><p>I find it a bit surprising to call it <code>PythonBuilds</code> since we're not performing a build there? I'd prefer <code>Python</code> or <code>PythonVersions</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-03-19 18:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/downloads.rs</code>:635 on 2025-03-19 18:21</div>
            <div class="timeline-body"><p>As in, compatibility with file systems? If so, can you add that for clarity? I wasn't sure what we were trying to be compatible with here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/downloads.rs</code>:790 on 2025-03-19 18:24</div>
            <div class="timeline-body"><p>Isn't this into any target directory? Why temporary here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-03-19 18:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-19 18:30</div>
            <div class="timeline-body"><p>@Gankra could you give this a look too? I'm curious if you have thoughts on the streaming question.</p>
<p>@konstin I'm still not sure of the benefits of storing the compressed archives instead of an unpacked one and tweaking the install logic. Immediately unpacking would solve the streaming problem as well as the delayed hash check (which feels awkward here). It'd also help with the automatic install user experience (ref https://github.com/astral-sh/uv/issues/12122#issuecomment-2718673044) â€” I think writing a marker file isn't unreasonable but it's harder to reason about when viewing the directories and may be annoying when we start bundling Python distributions into &quot;virtual&quot; environments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> approved on 2025-03-19 19:23</div>
            <div class="timeline-body"><p>re: stream teeing -- hard to imagine what exactly is up with the borrowchecks without using it in anger but my experiences here are similarly dire frustration so I wouldn't dwell too hard on it, especially since the wins will be marginal compared to how big of a win you've got already.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-03-26 21:30</div>
            <div class="timeline-body"><p>Could we only have one unpacked tree instead of two unpacked trees, e.g. with (out of band) tracking whether a Python interpreter as installed? I was targeting fixing the test running with this change, so tackling our Python installation behavior in general would change the scope quite a bit. Moving more features such as decompression out of the test path would take test coverage of an important path in the test setup (vs. just the download, which is already a well-tested logic), so I'd prefer to not cache too much outside the case. We could also go the other way and decrease the scope of this PR by only acting on the environment variable that we only use in testing and only then use the two-step split download first, decompress-and-installer later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-26 21:39</div>
            <div class="timeline-body"><blockquote>
<p>Could we only have one unpacked tree instead of two unpacked trees,</p>
</blockquote>
<p>Are you considering one unpacked cache tree and another hard or soft linked tree as two unpacked trees?</p>
<blockquote>
<p>Moving more features such as decompression out of the test path would take test coverage of an important path in the test setup (vs. just the download, which is already a well-tested logic)</p>
</blockquote>
<p>I think we'll want at least one test case that does not use this new cache.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-03-27 19:46</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>Could we only have one unpacked tree instead of two unpacked trees,</p>
</blockquote>
<p>Are you considering one unpacked cache tree and another hard or soft linked tree as two unpacked trees?</p>
</blockquote>
<p>Sounds great, but is that this change or a different PR, i.e. would that behavior change fix the download behavior?</p>
<blockquote>
<blockquote>
<p>Moving more features such as decompression out of the test path would take test coverage of an important path in the test setup (vs. just the download, which is already a well-tested logic)</p>
</blockquote>
<p>I think we'll want at least one test case that does not use this new cache.</p>
</blockquote>
<p>Sounds good.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-04-16 16:41</div>
            <div class="timeline-body"><p>I don't recall where we landed on this during the in-person discussion. Do you? :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Cache managed Python archive downloads" to "Optional managed Python archive download cache" by @konstin on 2025-04-25 09:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-04-25 10:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-python/src/downloads.rs</code>:635 on 2025-04-25 10:21</div>
            <div class="timeline-body"><p>Yes, clarified</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-04-25 10:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-python/src/downloads.rs</code>:790 on 2025-04-25 10:26</div>
            <div class="timeline-body"><p>We use a temporary directory first, then do an atomic rename.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-04-25 10:40</div>
            <div class="timeline-body"><p>We decided to change this change to be only about cases where <code>UV_PYTHON_CACHE_DIR</code> is set. This allows both speeding up the cache and makes it easier to install managed Python on offline machines. Handling whether a Python interpreter was explicitly (<code>uv python install</code>) or implicitly (<code>uv run -p 3.x</code> with a missing python version) installed is separated from this change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2025-04-25 18:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2025-04-28 10:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-04-28 10:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-28 10:09</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:42:24 UTC
    </footer>
</body>
</html>
