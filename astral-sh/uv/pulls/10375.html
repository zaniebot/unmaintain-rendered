<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upgrade zlib-ng - astral-sh/uv #10375</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Upgrade zlib-ng</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/10375">#10375</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2025-01-07 18:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>If we remove this static linking, we can upgrade <code>zlib-ng</code>, which in turn lets us enable it on PowerPC.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-07 18:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-07 18:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-01-07 18:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>.cargo/config.toml</code>:9 on 2025-01-07 18:50</div>
            <div class="timeline-body"><p>We did add this for a reason (<a href="https://github.com/astral-sh/ruff/issues/11503">astral-sh/ruff#11503</a>) so we need to decide if it&#x27;s important to retain.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/T-256">@T-256</a> reviewed on 2025-01-07 20:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/T-256">@T-256</a> on <code>.cargo/config.toml</code>:9 on 2025-01-07 20:14</div>
            <div class="timeline-body"><p>Do you mean root cause of that issue was in <code>zlib-ng</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/Gankra">@Gankra</a> by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-09 00:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-09 00:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/musicinmybrain">@musicinmybrain</a> on 2025-01-09 00:43</div>
            <div class="timeline-body"><p>If you don’t end up merging this for some reason, please consider at least making the version bound <code>libz-ng-sys = { version = &quot;&lt;1.1.20&quot; }</code> Windows-specific. (The comment above it references a Windows-specific issue, <a href="https://github.com/rust-lang/libz-sys/issues/225">rust-lang/libz-sys#225</a>.) Otherwise, I have to patch out the version bound in Fedora in order to use the system <code>rust-libz-ng-sys-1.1.20</code> package, which is a minor but unnecessary inconvenience.</p>
<p>For now, I’ll just watch this PR, since it would remove the <code>libz-ng-sys</code> version bound altogether.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-09 00:57</div>
            <div class="timeline-body"><p>I tried that, but you actually can&#x27;t make it Windows-specific. Cargo doesn&#x27;t let you use multiple dependencies when linking a native library, apparently:</p>
<pre><code>error: failed to select a version for `libz-ng-sys`.
    ... required by package `uv-performance-flate2-backend v0.1.0 (/Users/crmarsh/workspace/puffin/crates/uv-performance-flate2-backend)`
versions that meet the requirements `&lt;1.1.20` are: 1.1.16, 1.1.15, 1.1.14, 1.1.13, 1.1.12, 1.1.11, 1.1.10, 1.1.9, 1.1.8, 1.1.7

the package `libz-ng-sys` links to the native library `z-ng`, but it conflicts with a previous package which links to `z-ng` as well:
package `libz-ng-sys v1.1.20`
    ... which satisfies dependency `libz-ng-sys = &quot;&gt;=1.1.20&quot;` of package `uv-performance-flate2-backend v0.1.0 (/Users/crmarsh/workspace/puffin/crates/uv-performance-flate2-backend)`
Only one package in the dependency graph may specify the same links value. This helps ensure that only one copy of a native library is linked in the final binary. Try to adjust your dependencies so that only one package uses the `links = &quot;z-ng&quot;` value. For more information, see https://doc.rust-lang.org/cargo/reference/resolver.html#links.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/musicinmybrain">@musicinmybrain</a> on 2025-01-09 11:39</div>
            <div class="timeline-body"><blockquote>
<p>I tried that, but you actually can&#x27;t make it Windows-specific. Cargo doesn&#x27;t let you use multiple dependencies when linking a native library, apparently:</p>
</blockquote>
<p>That kind of almost makes sense – mostly – in retrospect… I think… possibly. Anyway, thanks for attempting it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>.cargo/config.toml</code>:9 on 2025-01-09 14:14</div>
            <div class="timeline-body"><p>No the issue is fundamental to windows and how it deals with ~system libraries. At least one thing we would regard as equivalent to &quot;glibc&quot; on linux is not shipped by default on windows (VCRUNTIME). When you ship a Windows application you are either expected to include an installer (&quot;redistributable&quot;) for the version of VCRUNTIME that you need and invoke it to tell windows to add it to the system, <em>or</em>, you&#x27;re expected to statically link it.</p>
<p>The above config chooses the latter, making us more statically linked in the same way that statically linking musl does. This is good for installing our binaries on any random Windows machine without additional installation stuff.</p>
<p>However it has a similar side-effect that musl does: if you need to dynamically link <em>any</em> other libraries you will likely get errors, because (<em>handwaving</em>) the other libraries dynamically link to VCRUNTIME-et-al and treat the contents of VCRUNTIME as protocol you need to interoperate with.</p>
<p>zlib-ng failing to link properly when we have this setting enabled is indicative of <em>it</em> wanting to dynamically link extra things, and running into the fact that we&#x27;ve essentially opted into &quot;no you don&#x27;t&quot;. (I haven&#x27;t verified this but it&#x27;s the only thing that makes sense to me).</p>
<p>By deleting this config (and doing nothing else), we are essentially opting into a lottery where we <em>really</em> hope all our users happened to have installed an appropriate version of VCRUNTIME before they install uv. This was the original issue ruff ran into. So we shouldn&#x27;t remove it without a solution for redistributables (or research indicating this is just guaranteed to be on all supported systems now).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> requested changes on 2025-01-09 14:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-09 14:26</div>
            <div class="timeline-body"><p>Closing based on @Gankra&#x27;s great diagnosis.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-09 14:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:50:09 UTC
    </footer>
</body>
</html>
