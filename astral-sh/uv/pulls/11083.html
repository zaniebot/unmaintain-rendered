<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avoid resolving symbolic links when querying Python interpreters - astral-sh/uv #11083</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Avoid resolving symbolic links when querying Python interpreters</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/11083">#11083</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2025-01-29 20:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>Closes <a href="https://github.com/astral-sh/uv/issues/11048">astral-sh/uv#11048</a></p>
<p>This brings the <code>PythonEnvironment::from_root</code> behavior in-line with the rest of uv Python discovery behavior (and in-line with pip). It&#x27;s not clear why we were canonicalizing the path in the first place here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-29 20:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-29 20:50</div>
            <div class="timeline-body"><p>!!!</p>
<pre><code>running 1 test
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” Snapshot Summary â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Snapshot: run_linked_environment_path-2
Source: crates/uv/tests/it/run.rs:3395
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Expression: snapshot
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
-old snapshot
+new results
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    0     0 â”‚ success: true
    1     1 â”‚ exit_code: 0
    2     2 â”‚ ----- stdout -----
    3       â”‚-[VENV]/
    4       â”‚-[VENV]/[BIN]/python
          3 â”‚+[TEMP_DIR]/target
          4 â”‚+[TEMP_DIR]/target/[BIN]/python
    5     5 â”‚ 
    6     6 â”‚ ----- stderr -----
    7     7 â”‚ Resolved 8 packages in [TIME]
    8     8 â”‚ Audited 6 packages in [TIME]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Stopped on the first failure. Run `cargo insta test` to run all snapshots.
test run::run_linked_environment_path ... FAILED
</code></pre>
<p>So.. the behavior is different on Linux than macOS?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-29 21:42</div>
            <div class="timeline-body"><p>Okay... so the test fails on Linux <em>and</em> macOS in CI so the behavior is different in CI than on my machine... that&#x27;s annoying.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-29 21:46</div>
            <div class="timeline-body"><p>Another development â€” if I use Python provided by Homebrew, the link is resolved (e.g., VENV not TARGET) but if I use a uv-managed Python, it is not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-29 21:51</div>
            <div class="timeline-body"><p>We do have non-snapshot tests for HomeBrew Python and the existing behavior is <em>fine</em> just not ideal, so I&#x27;m not too worried about shipping this regardless. It could be nice to understand <em>why</em> this does not change anything in that case, and if any downstream packagers will be affected by this change â€” but I think the worst-case scenario is that they need to skip the test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-29 21:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/edmorley">@edmorley</a> on 2025-01-29 22:25</div>
            <div class="timeline-body"><p>Thank you for looking into this!</p>
<blockquote>
<p>Another development â€” if I use Python provided by Homebrew, the link is resolved (e.g., VENV not TARGET) but if I use a uv-managed Python, it is not.</p>
</blockquote>
<p>Reading the CPython implementation comments for executable/prefix/... calculation (since it&#x27;s not covered in detail in the user-facing docs):
https://github.com/python/cpython/blob/a1a4e9f39ad86359e148fd193089b3b2a354f71d/Modules/getpath.py#L93-L153</p>
<p>...I see:</p>
<blockquote>
<p>Before any searches are done, the location of the executable is determined.  If Py_SetPath() was called, or if we are running on Windows, the &#x27;real_executable&#x27; path is used (if known).  Otherwise, we use the config-specified program name or default to argv[0].</p>
</blockquote>
<p>I&#x27;m not sure what &quot;config-specified&quot; means - could that be <code>_sysconfigdata__*</code> - and thus depend on whether the install has been relocated/whether that metadata references a real path and otherwise will be ignored? The CPython implementation after the comments linked above also has quite a few darwin-specific conditionals. (I only skimmed that file in a browser and it&#x27;s 800 lines long so these are mostly only lazy guesses while I&#x27;m watching TV - sorry! ğŸ˜† )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2025-01-30 01:04</div>
            <div class="timeline-body"><p>There&#x27;s no need to absolutize this, right? It doesn&#x27;t get returned to the user in any way -- just the <code>sys.executable</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-30 01:37</div>
            <div class="timeline-body"><p>I don&#x27;t think so. The only change would be in logs, I think. I can do an audit though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-30 16:10</div>
            <div class="timeline-body"><p>Oh, we return <code>root: interpreter.sys_prefix().to_path_buf(),</code> so.. yeah there&#x27;s no need to absolutize the path.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-30 16:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/zanieb">@zanieb</a> on 2025-01-30 16:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-30 16:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:50:36 UTC
    </footer>
</body>
</html>
