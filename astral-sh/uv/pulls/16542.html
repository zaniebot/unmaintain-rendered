<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support http/https URLs in `uv python --python-downloads-json-url` - astral-sh/uv #16542</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Support http/https URLs in <code>uv python --python-downloads-json-url</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/16542">#16542</a>
        opened by <a href="https://github.com/MeitarR">@MeitarR</a>
        on 2025-10-31 21:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MeitarR">@MeitarR</a></div>
            <div class="timeline-body"><p>continuation PR based on #14687</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MeitarR">@MeitarR</a> on 2025-10-31 23:17</div>
            <div class="timeline-body"><p>I successfully rebased the old PR on the updated main. Later, I will also try to fix the CR comments from there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MeitarR on 2025-11-07 19:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MeitarR">@MeitarR</a> on 2025-11-07 19:30</div>
            <div class="timeline-body"><p>@konstin, I added a WireMock test and fixed the confusing comment. It should be ready for review.</p>
<p>Tell me if the test is what you expected</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @Gankra by @Gankra on 2025-11-10 20:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>docs/reference/environment.md</code>:540 on 2025-11-10 22:11</div>
            <div class="timeline-body"><pre><code class="language-suggestion">This variable can be set to a local path or URL pointing to
</code></pre>
<p>(I don't think the specificity is needed -- also there's an extra <code>/</code> here if you want to preserve this text)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/uv-static/src/env_vars.rs</code>:403 on 2025-11-10 22:14</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// This variable can be set to a local path or URL pointing to
</code></pre>
<p>(oh right this is the actual canonical text, the other one was generated)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/uv-python/src/installation.rs</code>:134 on 2025-11-10 22:16</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        // default retries to avoid the middleware performing uncontrolled retries.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/uv-python/src/downloads.rs</code>:1024 on 2025-11-10 22:22</div>
            <div class="timeline-body"><p>Should we be adding context to these errors..?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/uv-python/src/downloads.rs</code>:1020 on 2025-11-10 22:23</div>
            <div class="timeline-body"><p>Preallocating a 1MB buffer seems a bit aggressive? Is that a pattern copied from somewhere else?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/uv-python/src/downloads.rs</code>:1033 on 2025-11-10 22:24</div>
            <div class="timeline-body"><p>Interesting nod to future-compat, sure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/uv-python/src/downloads.rs</code>:1036 on 2025-11-10 22:25</div>
            <div class="timeline-body"><p>lol</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> approved on 2025-11-10 22:26</div>
            <div class="timeline-body"><p>Wow this is great! I have a few nits but this seems solid.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MeitarR">@MeitarR</a> reviewed on 2025-11-11 20:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MeitarR">@MeitarR</a> on <code>crates/uv-python/src/downloads.rs</code>:1024 on 2025-11-11 20:42</div>
            <div class="timeline-body"><p>How would we do that?</p>
<p>I see that <code>read_url</code> already has different error types.</p>
<p>(BTW, I see that there is another usage of <code>read_url</code> later in the file that does the same)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MeitarR">@MeitarR</a> on <code>crates/uv-python/src/downloads.rs</code>:1020 on 2025-11-11 20:48</div>
            <div class="timeline-body"><p>From reading the code (which @geofft wrote), I see that the 1MB is only relevant when we can't get the size of the buffer, and the only real case (if I understand correctly) is when in the HTTP response there where no <code>content-length</code> header.</p>
<p>Maybe it is somehow related to https://github.com/astral-sh/uv/pull/14687#issuecomment-3085800753</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MeitarR">@MeitarR</a> reviewed on 2025-11-11 20:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-11-12 13:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-python/src/downloads.rs</code>:1020 on 2025-11-12 13:14</div>
            <div class="timeline-body"><p><code>.bytes()</code>, the non-streaming version, has a better collector for this, but it doesn't really fit with the current <code>read_url</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-11-12 13:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/uv-python/src/downloads.rs</code>:1024 on 2025-11-12 13:53</div>
            <div class="timeline-body"><p>It's probably fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> approved on 2025-11-12 13:56</div>
            <div class="timeline-body"><p>Should be mergeable, but this has a non-trivial rebase to do :(</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-11-13 10:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-python/src/downloads.rs</code>:1024 on 2025-11-13 10:43</div>
            <div class="timeline-body"><p>You can test this by running with an arbitrary large file (so you can abort before it finished), and turning the network off mid-download:</p>
<pre><code>$ UV_HTTP_TIMEOUT=1 cargo run python install 3.14 --python-downloads-json-url https://files.pythonhosted.org/packages/a9/8c/3da60787bcf70add986c4ad485993026ac0ca74f2fc21410bc4eb1bb7695/torch-2.9.1-cp314-cp314t-manylinux_2_28_x86_64.whl
error: error decoding response body
  Caused by: request or response body error
  Caused by: operation timed out
</code></pre>
<p>We should make sure that we show at least the URL in the error message.</p>
<p>For example, this is the error message when network isn't available when starting the download:</p>
<pre><code>$ UV_HTTP_TIMEOUT=1 cargo run python install 3.14 --python-downloads-json-url https://files.pythonhosted.org/packages/a9/8c/3da60787bcf70add986c4ad485993026ac0ca74f2fc21410bc4eb1bb7695/torch-2.9.1-cp314-cp314t-manylinux_2_28_x86_64.whl
error: Failed to download https://files.pythonhosted.org/packages/a9/8c/3da60787bcf70add986c4ad485993026ac0ca74f2fc21410bc4eb1bb7695/torch-2.9.1-cp314-cp314t-manylinux_2_28_x86_64.whl
  Caused by: error sending request for url (https://files.pythonhosted.org/packages/a9/8c/3da60787bcf70add986c4ad485993026ac0ca74f2fc21410bc4eb1bb7695/torch-2.9.1-cp314-cp314t-manylinux_2_28_x86_64.whl)
  Caused by: client error (Connect)
  Caused by: dns error
  Caused by: failed to lookup address information: Name or service not known
</code></pre>
<p>We're also not retrying network failures as we do else, because we're using the python download client that has automatic retries deactivated, but don't implement our own retry loop, and don't do any caching. <code>read_url</code> fits badly here, <code>CachedClient</code> has the features we want: Retries, serde integration and caching.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-11-13 11:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-python/src/downloads.rs</code>:1024 on 2025-11-13 11:52</div>
            <div class="timeline-body"><p>Regarding the retrying, can you add a test to <code>network.rs</code> for <code>--python-downloads-json-url</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MeitarR">@MeitarR</a> reviewed on 2025-11-14 22:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MeitarR">@MeitarR</a> on <code>crates/uv-python/src/downloads.rs</code>:1024 on 2025-11-14 22:04</div>
            <div class="timeline-body"><p>Added context for the errors there</p>
<pre><code>
$ UV_HTTP_TIMEOUT=1 cargo run python install 3.14 --python-downloads-json-url https://files.pythonhosted.org/packages/a9/8c/3da60787bcf70add986c4ad485993026ac0ca74f2fc21410bc4eb1bb7695/torch-2.9.1-cp314-cp314t-manylinux_2_28_x86_64.whl
error: Error while fetching remote python downloads json from 'https://files.pythonhosted.org/packages/a9/8c/3da60787bcf70add986c4ad485993026ac0ca74f2fc21410bc4eb1bb7695/torch-2.9.1-cp314-cp314t-manylinux_2_28_x86_64.whl'
  Caused by: error decoding response body
  Caused by: request or response body error
  Caused by: operation timed out
</code></pre>
<p>About the other comments, I will address them in a later PR, as this PR is very conflict-prone</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @Gankra on 2025-11-14 22:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Gankra on 2025-11-14 22:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-11-14 22:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/uv-python/src/downloads.rs</code>:1024 on 2025-11-14 22:51</div>
            <div class="timeline-body"><p>(Agreed to have this as a followup)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:45:11 UTC
    </footer>
</body>
</html>
