<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Implement PEP 440-compliant local version semantics - astral-sh/uv #8797</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Implement PEP 440-compliant local version semantics</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/8797">#8797</a>
        opened by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a>
        on 2024-11-04 06:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ericmarkmartin">@ericmarkmartin</a></div>
            <div class="timeline-body">

Summary


<p>Implement a full working version of local version semantics. The (AFAIA) major move towards this was implemented in #2430. This added support such that the version specifier <code>torch==2.1.0+cpu</code> would install <code>torch@2.1.0+cpu</code> and consider <code>torch@2.1.0+cpu</code> a valid way to satisfy the requirement <code>torch==2.1.0</code> in further dependency resolution.</p>
<p>In this feature, we more fully support local version semantics. Namely, we now allow <code>torch==2.1.0</code> to install <code>torch@2.1.0+cpu</code> regardless of whether <code>torch@2.1.0</code> (no local tag) actually exists.</p>
<p>We do this by adding an internal-only <code>Max</code> value to local versions that compare greater to all other local versions. Then we can translate <code>torch==2.1.0</code> into bounds: greater than 2.1.0 with no local tag and less than 2.1.0 with the <code>Max</code> local tag.</p>
Test Plan
<p>Depends on <a href="https://github.com/astral-sh/packse/pull/227">astral-sh/packse#227</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2024-11-04 06:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2024-11-04 06:11</div>
            <div class="timeline-body"><p>@charliermarsh I took a stab at this. I didn&#x27;t spend a ton of time testing but I think it&#x27;s maybe right? If it is, the main issue here might be performance---after this change, <code>==</code> bounds get translated into a bounded range rather than a singleton, and the upper bound of the range has a local version (the <code>Max</code> sentinel value) so it has to be a <code>VersionFull</code>. This is maybe a bit sad for the number of slow comparisons it introduces. Maybe there&#x27;s a way to encode the local version sentinel in <code>VersionSmall</code> such that we don&#x27;t have to suffer this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-04 13:43</div>
            <div class="timeline-body"><p>On first glance I think this approach makes a lot of sense? Clever! I need to review it more closely though, and we should indeed add something to <code>VersionSmall</code> to capture the sentinel, I think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-04 13:48</div>
            <div class="timeline-body"><p>I will poke around at this, if that&#x27;s cool -- see if I can get it passing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-04 13:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2024-11-04 14:33</div>
            <div class="timeline-body"><p>Poke away! I took a whirl at trying to detect the weird synthesized bounds with the local version max and rewriting it back to a normal-looking equality in report.rs but didn&#x27;t have much luck</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-04 15:00</div>
            <div class="timeline-body"><p>üëç I think I know how to solve it, or at least have some ideas.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2024-11-04 15:06</div>
            <div class="timeline-body"><p>Another thing to think about--do we still want the #2430 mechanism? I don&#x27;t think we need it after this change, but it&#x27;s also clearly not hurting us. I could imagine it&#x27;s still a good perf optimization but I&#x27;m not familiar enough with the resolver to make a claim either way</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-04 15:09</div>
            <div class="timeline-body"><p>Did you link to the wrong PR? Heh</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-04 15:11</div>
            <div class="timeline-body"><p>Maybe you&#x27;re thinking of the version selection mechanism where we check if we&#x27;re requesting an exact-equals version?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2024-11-04 15:21</div>
            <div class="timeline-body"><blockquote>
<p>Did you link to the wrong PR? Heh</p>
</blockquote>
<p>Indeed! I mixed up #2340 and #2430--whoops! I edited it in the comment above</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-04 20:31</div>
            <div class="timeline-body"><p>I almost have tests passing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2024-11-04 20:42</div>
            <div class="timeline-body"><p>Nice! I realize that I used <code>LocalVersion::Max</code> but <code>LocalVersionSlice::Sentinel</code>---do you have a preference?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-04 21:07</div>
            <div class="timeline-body"><p>Probably a minor preference for <code>Max</code> because it&#x27;s similar to the &quot;max&quot; we use elsewhere in <code>Version</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-04 21:13</div>
            <div class="timeline-body"><p>Next I will try tearing out all the special-casing around local versions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-04 21:23</div>
            <div class="timeline-body"><p>(I&#x27;ll stop force-pushing to this branch and merge from now on so we can collab.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-04 21:33</div>
            <div class="timeline-body"><p>I need to update Packse to change some of the auto-generated scenario expectations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-04 23:11</div>
            <div class="timeline-body"><p>I think the main thing missing here is a few more Packse tests (I can write) plus a solution to the <code>VersionFull</code> thing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-04 23:14</div>
            <div class="timeline-body"><p>@ericmarkmartin -- Do you think it&#x27;s possible for us to somehow reuse the <code>max</code> / <code>SUFFIX_MAX</code> concept that already exists on <code>VersionSmall</code>? It&#x27;s already &quot;the version after all local versions&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-04 23:36</div>
            <div class="timeline-body"><blockquote>
<p>Do you think it&#x27;s possible for us to somehow reuse the <code>max</code> / <code>SUFFIX_MAX</code> concept that already exists on <code>VersionSmall</code>? It&#x27;s already &quot;the version after all local versions&quot;.</p>
</blockquote>
<p>I think <em>not</em>, because we don&#x27;t want <code>foo==1.0.0</code> to match <code>1.0.0.post1</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-05 01:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;WIP: local version semantics&quot; to &quot;Implement PEP 440-compliant local version semantics&quot; by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-05 01:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-05 01:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">compatibility</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-05 01:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-05 01:55</div>
            <div class="timeline-body"><p>We can probably just ship this without changes to <code>VersionSmall</code>, and handle those later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;v0.5.0&quot; by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-05 01:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2024-11-05 02:39</div>
            <div class="timeline-body"><p>Are we sure there&#x27;s no serious perf regressions?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2024-11-05 02:41</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>Do you think it&#x27;s possible for us to somehow reuse the <code>max</code> / <code>SUFFIX_MAX</code> concept that already exists on <code>VersionSmall</code>? It&#x27;s already &quot;the version after all local versions&quot;.</p>
</blockquote>
<p>I think <em>not</em>, because we don&#x27;t want <code>foo==1.0.0</code> to match <code>1.0.0.post1</code>.</p>
</blockquote>
<p>Can we do <code>[1.0.0, 1.0.0.post1)</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2024-11-05 02:42</div>
            <div class="timeline-body"><blockquote>
<p>Another thing to think about--do we still want the #2430 mechanism? I don&#x27;t think we need it after this change, but it&#x27;s also clearly not hurting us. I could imagine it&#x27;s still a good perf optimization but I&#x27;m not familiar enough with the resolver to make a claim either way</p>
</blockquote>
<p>Also did we settle on something here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-05 02:42</div>
            <div class="timeline-body"><p>We roughly want to do this (it&#x27;s a little trickier than past changes, e.g., the change to add <code>min</code> or <code>max</code>, because we&#x27;re out of &quot;space&quot; going from 3 bits to 4 bits):</p>
<pre><code>diff --git a/crates/uv-pep440/src/version.rs b/crates/uv-pep440/src/version.rs
index 26b3831ec..f7448137f 100644
--- a/crates/uv-pep440/src/version.rs
+++ b/crates/uv-pep440/src/version.rs
@@ -835,16 +835,16 @@ impl FromStr for Version {
 /// * Bytes 5, 4 and 3 correspond to the second, third and fourth release
 ///   segments, respectively.
 /// * Bytes 2, 1 and 0 represent *one* of the following:
-///   `min, .devN, aN, bN, rcN, &lt;no suffix&gt;, .postN, max`.
+///   `min, .devN, aN, bN, rcN, &lt;no suffix&gt;, local, .postN, max`.
 ///   Its representation is thus:
-///   * The most significant 3 bits of Byte 2 corresponds to a value in
-///     the range 0-6 inclusive, corresponding to min, dev, pre-a, pre-b, pre-rc,
+///   * The most significant 4 bits of Byte 2 corresponds to a value in
+///     the range 0-8 inclusive, corresponding to min, dev, pre-a, pre-b, pre-rc,
 ///     no-suffix or post releases, respectively. `min` is a special version that
 ///     does not exist in PEP 440, but is used here to represent the smallest
 ///     possible version, preceding any `dev`, `pre`, `post` or releases. `max` is
 ///     an analogous concept for the largest possible version, following any `post`
 ///     or local releases.
-///   * The low 5 bits combined with the bits in bytes 1 and 0 correspond
+///   * The low 4 bits combined with the bits in bytes 1 and 0 correspond
 ///     to the release number of the suffix, if one exists. If there is no
 ///     suffix, then these bits are always 0.
 ///
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-05 02:42</div>
            <div class="timeline-body"><blockquote>
<p>Also did we settle on something here?</p>
</blockquote>
<p>Yeah I did it here: <a href="https://github.com/astral-sh/uv/pull/8818">astral-sh/uv#8818</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-05 02:43</div>
            <div class="timeline-body"><blockquote>
<p>Can we do <code>[1.0.0, 1.0.0.post1)</code>?</p>
</blockquote>
<p>Hmm... I think that <em>could</em> work? We can give it a shot. It might be a little more tedious to detect and remove those versions in the error reporter though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-05 02:45</div>
            <div class="timeline-body"><p>(I think changing <code>VersionSmall</code> isn&#x27;t too hard, I just either need time to focus on re-learning the representation / constants or @BurntSushi help.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2024-11-05 04:02</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>Can we do <code>[1.0.0, 1.0.0.post1)</code>?</p>
</blockquote>
<p>Hmm... I think that <em>could</em> work? We can give it a shot. It might be a little more tedious to detect and remove those versions in the error reporter though.</p>
</blockquote>
<p>If making the <code>SmallVersion</code> work is possible, than is it worth trying the above? I&#x27;d assume the only advantage is saving you some room in the <code>SmallVersion</code> if that&#x27;s particularly valuable</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-05 04:10</div>
            <div class="timeline-body"><p>Yeah I think we should just try to modify SmallVersion ‚Äî seems like the best path forward.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2024-11-05 04:35</div>
            <div class="timeline-body"><p>I guess there&#x27;s also a possibility some actual local versions can be encoded in <code>VersionSmall</code>, though I suppose it&#x27;s pretty unlikely anything useful could be? Maybe we can come up with special case representations for <code>+cpu</code> and <code>gpu</code> ü§£. I was genuinely concerned about the perf impact of releasing this without a <code>VersionSmall</code> representation due to introducing slow comparisons for any <code>==</code> specifier, but if you don&#x27;t think that&#x27;s an issue I&#x27;m happy to pick up the <code>VersionSmall</code> changes in another PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-11-05 12:27</div>
            <div class="timeline-body"><p>For context on <code>VersionSmall</code>, its <em>purpose</em> is to compactly represent <code>Version</code> values that are the most frequently occurring. Versions with local segments are specifically infrequent relative to the universe of all versions used (on PyPI at least), and so using <code>VersionSmall</code> to represent them is probably not that impactful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2024-11-05 14:28</div>
            <div class="timeline-body"><blockquote>
<p>For context on <code>VersionSmall</code>, its <em>purpose</em> is to compactly represent <code>Version</code> values that are the most frequently occurring.</p>
</blockquote>
<p>Right, but if you change <code>VersionSmall</code> like Charlie describes above, then you have 2.5 bytes to encode a local version tag, so you may as well use it for something right? I guess there&#x27;s some way you could make a specific encoding for <code>LocalVersion::Max</code> without following the existing scheme?</p>
<blockquote>
<p>Versions with local segments are specifically infrequent relative to the universe of all versions used (on PyPI at least)</p>
</blockquote>
<p>Yeah, the spec even says</p>
<blockquote>
<p>Local version identifiers SHOULD NOT be used when publishing upstream projects to a public index server</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-05 14:31</div>
            <div class="timeline-body"><p>Yeah I messaged Andrew about this -- I think we&#x27;re all aligned on reclaiming some of the &quot;version suffix&quot; bits so that we can encode this special-case local tag.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-11-05 14:59</div>
            <div class="timeline-body"><p>@ericmarkmartin I think we need just one bit that we can pull from the version suffix. We definitely don&#x27;t want to take more than that because the version suffix is where things like <code>10</code> in <code>.dev10</code> get stored. If we devoted all of the suffix to local segments, we&#x27;d be giving up a &quot;small&quot; representation for something that is much more common than things with a local segment.</p>
<p>I&#x27;m going to put up a PR with a slight refactor that I think should make this change easier.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-05 21:24</div>
            <div class="timeline-body"><p>Doing the <code>VersionSmall</code> changes now but it&#x27;ll be a separate PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2024-11-05 23:24</div>
            <div class="timeline-body"><p>@BurntSushi I was mistakenly thinking we were reclaiming the extra bit so we could have a 4 bit discriminant. Then we&#x27;d have &quot;local&quot; as a possible value for said discriminant, hence my thinking we had 2.5 bytes to work with for the local segment in that case.</p>
<p>I now realize we&#x27;re talking about just stealing the bit as an orthogonal indicator of the local sentinel, which makes way more sense. Sorry for my confusion</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-06 03:04</div>
            <div class="timeline-body"><p>(Starting the process of merging these into the v0.5 branch.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-06 03:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-06 03:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-08 04:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/pradyunsg">@pradyunsg</a> on 2024-11-10 08:27</div>
            <div class="timeline-body"><p>Coming here from the 0.5.0 changelog entry: this is quite smart!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:49:10 UTC
    </footer>
</body>
</html>
