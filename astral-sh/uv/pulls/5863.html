<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avoid panic when re-locking with precise commit - astral-sh/uv #5863</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Avoid panic when re-locking with precise commit</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/5863">#5863</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-08-07 14:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Very subtle bug. The scenario is as follows:</p>
<ul>
<li><p>We resolve: <code>elmer-circuitbuilder = { git = &quot;https://github.com/ElmerCSC/elmer_circuitbuilder.git&quot; }</code></p>
</li>
<li><p>The user then changes the request to: <code>elmer-circuitbuilder = { git = &quot;https://github.com/ElmerCSC/elmer_circuitbuilder.git&quot;, rev = &quot;44d2f4b19d6837ea990c16f494bdf7543d57483d&quot; }</code></p>
</li>
<li><p>When we go to re-lock, we note two facts:</p>
<ol>
<li>The &quot;default branch&quot; resolves to <code>44d2f4b19d6837ea990c16f494bdf7543d57483d</code>.</li>
<li>The metadata for <code>44d2f4b19d6837ea990c16f494bdf7543d57483d</code> is (whatever we grab from the lockfile).</li>
</ol>
</li>
<li><p>In the resolver, we then ask for the metadata for <code>44d2f4b19d6837ea990c16f494bdf7543d57483d</code>. It's already in the cache, so we return it; thus, we never add the <code>44d2f4b19d6837ea990c16f494bdf7543d57483d</code> -&gt; <code>44d2f4b19d6837ea990c16f494bdf7543d57483d</code> mapping to the Git resolver, because we never have to resolve it.</p>
</li>
</ul>
<p>This would apply for any case in which a requested tag or branch was replaced by its precise SHA. Replacing with a different commit is fine.</p>
<p>It only applied to <code>tool.uv.sources</code>, and not PEP 508 URLs, because the underlying issue is that we aren't consistent about &quot;automatically&quot; extracting the precise commit from a Git reference.</p>
<p>Closes https://github.com/astral-sh/uv/issues/5860.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-git/src/lib.rs</code>:30 on 2024-08-07 14:39</div>
            <div class="timeline-body"><p>Main change: we now always extract precise if it's a Git reference.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-07 14:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-08-07 14:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @charliermarsh on 2024-08-07 14:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-08-07 14:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-08-07 14:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-08-07 14:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:38:42 UTC
    </footer>
</body>
</html>
