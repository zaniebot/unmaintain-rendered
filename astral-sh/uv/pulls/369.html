<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refactor distribution types to adhere to a clear hierarchy - astral-sh/uv #369</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Refactor distribution types to adhere to a clear hierarchy</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/369">#369</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-11-08 21:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>This PR refactors our <code>RemoteDistribution</code> type such that it now follows a clear hierarchy that matches the actual variants, and encodes the differences between source and built distributions:</p>
<pre><code>pub enum Distribution {
    Built(BuiltDistribution),
    Source(SourceDistribution),
}

pub enum BuiltDistribution {
    Registry(RegistryBuiltDistribution),
    DirectUrl(DirectUrlBuiltDistribution),
}

pub enum SourceDistribution {
    Registry(RegistrySourceDistribution),
    DirectUrl(DirectUrlSourceDistribution),
    Git(GitSourceDistribution),
}

/// A built distribution (wheel) that exists in a registry, like `PyPI`.
pub struct RegistryBuiltDistribution {
    pub name: PackageName,
    pub version: Version,
    pub file: File,
}

/// A built distribution (wheel) that exists at an arbitrary URL.
pub struct DirectUrlBuiltDistribution {
    pub name: PackageName,
    pub url: Url,
}

/// A source distribution that exists in a registry, like `PyPI`.
pub struct RegistrySourceDistribution {
    pub name: PackageName,
    pub version: Version,
    pub file: File,
}

/// A source distribution that exists at an arbitrary URL.
pub struct DirectUrlSourceDistribution {
    pub name: PackageName,
    pub url: Url,
}

/// A source distribution that exists in a Git repository.
pub struct GitSourceDistribution {
    pub name: PackageName,
    pub url: Url,
}
</code></pre>
<p>Most of the PR just stems downstream from this change. There are no behavioral changes, so I&#x27;m largely relying on lint, tests, and the compiler for correctness.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-08 21:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-resolver/src/file.rs</code>:11 on 2023-11-08 21:39</div>
            <div class="timeline-body"><p>We should consider making this part of the <code>Distribution</code> API.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-08 21:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-08 21:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-08 21:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-installer/src/registry_index.rs</code>:14 on 2023-11-08 21:42</div>
            <div class="timeline-body"><p>As an example of the kind of thing we can now enforce: the <code>RegistryIndex</code> only contains distributions that were derived from a registry (rather than a direct URL).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-08 21:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-resolver/src/distribution/built_distribution.rs</code>:31 on 2023-11-08 21:43</div>
            <div class="timeline-body"><p>As an example of the kind of thing we can now enforce: this no longer accepts an arbitrary remote distribution (like an sdist), it <em>has</em> to be a wheel. Same for the <code>SourceDistributionFetcher</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-08 21:44</div>
            <div class="timeline-body"><p>If no one wants to review this that&#x27;s fine, it&#x27;s a slog. If anything, it would be most helpful just to get feedback on the type hierarchy in the summary (which I posted earlier on Discord).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/puffin-distribution/src/any.rs</code>:8 on 2023-11-08 22:18</div>
            <div class="timeline-body"><p>Is this correct? Should it be <code>AnyBuiltDistribution</code> if so?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-11-08 22:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/puffin-distribution/src/cached.rs</code>:147 on 2023-11-09 09:29</div>
            <div class="timeline-body"><pre><code>        let Some((name, version)) = file_name.rsplit_once(&#x27;-&#x27;) else {
</code></pre>
<p>Our cache should have correct normalization but this is what we&#x27;re using elsewhere already</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/puffin-distribution/src/direct_url.rs</code>:69 on 2023-11-09 09:32</div>
            <div class="timeline-body"><p>We should check and raise an explicit unsupported error if there is a <code>+</code> in the scheme that isn&#x27;t <code>git+</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/puffin-distribution/src/direct_url.rs</code>:82 on 2023-11-09 09:33</div>
            <div class="timeline-body"><p>It&#x27;s a bit strange (but not blocking) that <code>DirectUrl</code> lives in <code>pypi_types</code> when it&#x27;s distinctly not a pypi type. Maybe <code>pypackaging_types</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/puffin-distribution/src/direct_url.rs</code>:101 on 2023-11-09 09:35</div>
            <div class="timeline-body"><p>I plan looking into these</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/puffin-distribution/src/installed.rs</code>:34 on 2023-11-09 09:41</div>
            <div class="timeline-body"><p>I&#x27;d put <code>name</code>, <code>version</code>, <code>path</code> into a shared <code>InstalledDistribution</code> struct and call the enum <code>InstalledDistributionSource</code>. Depending on whether we have methods that only take a <code>InstalledRegistryDistribution</code> or a <code>InstalledDirectUrlDistribution</code>m, <code>InstalledDistribution</code> could get a <code>source: InstalledDistributionSource</code> field, otherwise this just abstracts away the three fields</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/puffin-distribution/src/traits.rs</code>:11 on 2023-11-09 09:43</div>
            <div class="timeline-body"><p>This is a good indication we actually want to use <code>Dist</code> instead of <code>Distribution</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/puffin-resolver/src/resolver.rs</code>:829 on 2023-11-09 09:49</div>
            <div class="timeline-body"><p>Shouldn&#x27;t this be symmetric, where one request kind always produces on response kind?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-11-09 09:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-11-09 20:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-distribution/src/traits.rs</code>:11 on 2023-11-09 20:45</div>
            <div class="timeline-body"><p>I&#x27;ll do this in a separate PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-10 02:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-11-10 02:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-11-10 02:45</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:42:39 UTC
    </footer>
</body>
</html>
