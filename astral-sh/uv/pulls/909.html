<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adjust markers to match target Python version - astral-sh/uv #909</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Adjust markers to match target Python version</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/909">#909</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-01-13 23:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>This PR ensures that when the user passes in <code>--python-version</code>, we adjust the <em>markers</em> to match the target version, thus forcing us to select compatible wheels for the <code>--python-version</code>, rather than the installed version.</p>
Context
<p>Let&#x27;s call Python 3.10 the &quot;installed&quot; environment and Python 3.12 the &quot;target&quot; environment. For each version, we have <em>both</em> a Python version (to match against <code>Requires-Python</code>) and a set of tags (to match against wheels).</p>
<p>The rules for resolution are as follows...</p>
<ul>
<li>For each package, for each version, we try to find the &quot;best candidate&quot; for resolution and installation.</li>
<li>We first look for a wheel that&#x27;s compatible with the <em>target</em> environment. This requires testing against both the <code>Requires-Python</code> and the markers. (We won&#x27;t have to build or run this code, so the <em>installed</em> version is irrelevant.) <strong>(This PR corrects <em>this</em> bullet -- previously, we validated against the <em>installed</em> markers, rather than the target markers.)</strong></li>
<li>If we can&#x27;t find a compatible wheel, we accept any <em>incompatible</em> wheel as long as there&#x27;s a source distribution. The source distribution <em>must</em> be compatible with the target environment. (We won&#x27;t have to build or run this code, so the <em>installed</em> version is irrelevant.)</li>
<li>If there are no wheels, then the source distribution must be compatible with <em>both</em> the installed and target environments, since we need to build it.</li>
</ul>
<p>This is all true for the top-level resolution. When we perform a sub-resolution (when resolving the build dependencies of a source distribution), we should <em>only</em> use the installed environment, and ignore the target environment, since we assume that the dependencies will be the same in both environments once built -- so our goal is &quot;just&quot; to build the distribution, without concern for which build dependencies it uses.</p>
<p>Closes <a href="https://github.com/astral-sh/puffin/issues/883">astral-sh/puffin#883</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-13 23:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-13 23:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-13 23:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-resolver/src/candidate_selector.rs</code>:287 on 2024-01-13 23:15</div>
            <div class="timeline-body"><p>This isn&#x27;t strictly necessary, since if <code>self.resolve()</code> is a source distribution, it will be the same file as <code>self.install()</code> which is validated above. But, that&#x27;s kind of a detail that this method shouldn&#x27;t need to know about, so I just added this case to make it clearer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-13 23:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-13 23:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-cli/src/commands/pip_compile.rs</code>:139 on 2024-01-13 23:17</div>
            <div class="timeline-body"><p>FYI: we pass <code>interpreter</code> to <code>BuildDispatch</code> which is what&#x27;s used for all source distribution builds, and <code>BuildDispatch</code> then grabs the markers and tags from <code>interpreter</code> -- so it&#x27;s guaranteed to only use the <em>installed</em> environment when resolving, which is what we want.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/puffin-interpreter/src/interpreter.rs</code>:179 on 2024-01-14 09:52</div>
            <div class="timeline-body"><pre><code>        u8::try_from(minor).expect(&quot;invalid minor version&quot;)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/puffin-interpreter/src/python_version.rs</code>:93 on 2024-01-14 09:53</div>
            <div class="timeline-body"><pre><code>        u8::try_from(self.0.release()[1]).expect(&quot;invalid minor version&quot;)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/puffin-resolver/src/candidate_selector.rs</code>:287 on 2024-01-14 10:00</div>
            <div class="timeline-body"><p>Could you add that as a code comment? Otherwise i&#x27;ll be really confused coming back to that code in a couple of weeks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-01-14 10:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-01-14 10:00</div>
            <div class="timeline-body"><blockquote>
<p>If there are no wheels, then the source distribution must be compatible with both the installed and target environments, since we need to build it.</p>
</blockquote>
<p>Does the user get any indication in this case that their resolution to target failed because they have to switch their installed version?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-14 15:33</div>
            <div class="timeline-body"><blockquote>
<p>Does the user get any indication in this case that their resolution to target failed because they have to switch their installed version?</p>
</blockquote>
<p>Yes, because we add the installed version as a dependency, but we should add a packse test for it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-14 15:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-14 15:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-01-14 15:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:43:11 UTC
    </footer>
</body>
</html>
