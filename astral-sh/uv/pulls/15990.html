<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retain the cache lock and temporary caches during `uv run` and `uvx` - astral-sh/uv #15990</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Retain the cache lock and temporary caches during <code>uv run</code> and <code>uvx</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/15990">#15990</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2025-09-22 20:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>We're seeing reports of a regression from https://github.com/astral-sh/uv/pull/15888 where <code>--no-cache</code> causes <code>uv run</code> and <code>uvx</code> to fail to spawn a command.</p>
<p>The intent of this code was to allow destructive cache operations <em>after</em> we'd finished setting up the environment. However, it's unclear to me that it's safe to run <code>uv cache clean</code> during a <code>uv run</code> operation (e.g., <code>uv run --script</code> uses an environment in the cache) and, more importantly, we cannot drop non-persistent caches (e.g., from <code>--no-cache</code>) as they include the environment we're spawning the command in.</p>
<p>Alternative to #15977 which retains release of the lock â€” we may want to consider that approach still but this regression needs to be resolved quickly.</p>
<p>Closes https://github.com/astral-sh/uv/issues/15989
Closes https://github.com/astral-sh/uv/issues/15987
Closes https://github.com/astral-sh/uv/issues/15967</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2025-09-22 20:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2025-09-22 20:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/geofft">@geofft</a> approved on 2025-09-22 20:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> approved on 2025-09-22 20:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-09-22 20:16</div>
            <div class="timeline-body"><p>The downside to this approach is that if uv run runs forever, e.g., a server, uv cache clean will block forever too. I'm not sure what to do about that, other than some derivative of the implementation in https://github.com/astral-sh/uv/pull/15977 which accounts for cases like <code>uv run --script</code>. Or, we could add a way to bypass the lock, e.g., <code>uv cache clean --force</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2025-09-22 20:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-09-22 20:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-09-22 20:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:44:50 UTC
    </footer>
</body>
</html>
