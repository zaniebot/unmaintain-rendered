<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Replace `sys-info` with `sysinfo` for Android support; use mimalloc instead of jemalloc on Android - astral-sh/uv #16736</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Replace `sys-info` with `sysinfo` for Android support; use mimalloc instead of jemalloc on Android</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/16736">#16736</a>
        opened by <a href="https://github.com/LIghtJUNction">@LIghtJUNction</a>
        on 2025-11-14 11:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/LIghtJUNction">@LIghtJUNction</a> on 2025-11-14 11:16</div>
            <div class="timeline-body"><p>sys-info: https://crates.io/crates/sys-info
sysinfo: https://crates.io/crates/sysinfo</p>
<h2>Summary</h2>
<p>Replace <code>sys-info</code> with <a href="https://crates.io/crates/sysinfo">sysinfo</a> library for better compatibility and Android support, and exclude Android from jemalloc to fix Termux compilation issues.</p>
<h2>Problem</h2>
<p>The <code>sys-info</code> library is outdated with incomplete documentation and lacks Android support. This causes compatibility issues in modern environments, including Termux on Android.</p>
<p>Additionally, the <code>tikv-jemalloc-sys</code> crate fails to compile in Android environments (such as Termux), causing build failures when targeting Android platforms. This is similar to issues previously encountered on FreeBSD, where jemalloc was also excluded.</p>
<h2>Solution</h2>
<p>Replaced <code>sys-info</code> with the more comprehensive <code>sysinfo</code> library, which provides better documentation, active maintenance, and native Android support. This improves cross-platform compatibility while maintaining the same functionality for system information retrieval.</p>
<p>Modified the target condition in Cargo.toml to add <code>not(target_os = &quot;android&quot;)</code>, ensuring Android falls back to the system default allocator instead of jemalloc. This maintains compatibility while preserving performance optimizations on supported platforms.</p>
<h2>Changes</h2>
<ul>
<li>Replaced <code>sys-info</code> dependency with <code>sysinfo</code> across relevant crates (<code>uv-python</code>, <code>uv-client</code>)</li>
<li>Updated jemalloc dependency condition to exclude Android</li>
<li>Follows the same pattern used for FreeBSD exclusion</li>
<li>Additionally, updated dependency versions and performed build tests. Based on the test feedback, fixed some errors</li>
</ul>
<h2>Test Plan</h2>
<ol>
<li><p><strong>Cross-platform compilation</strong>: Verified builds on Windows, Linux, and macOS with the new <code>sysinfo</code> library.</p>
</li>
<li><p><strong>Android support testing</strong>:</p>
<ul>
<li>Tested Android platform using cross-compilation:<pre><code class="language-bash">cross build --target aarch64-linux-android
</code></pre>
</li>
<li>Confirmed <code>sysinfo</code> library works correctly on Android</li>
<li>Termux still has some compilation issues with jemalloc (excluded as fallback)</li>
</ul>
</li>
<li><p><strong>Linux targets</strong>:</p>
<pre><code class="language-bash"># x86_64 Linux
cross build --target x86_64-unknown-linux-gnu


</code></pre>
</li>
<li><p><strong>Functionality verification</strong>: Ensured system information retrieval (OS name, version) works identically with the new library.</p>
</li>
<li><p><strong>Regression testing</strong>: Verified that existing functionality in <code>uv-python</code> and <code>uv-client</code> crates remains intact.</p>
</li>
<li><p><strong>Dependency update testing</strong>: Validated that updated dependency versions compile correctly and resolve any compatibility issues identified during testing.</p>
</li>
<li><p><strong>Local build verification</strong>: Confirmed successful builds on Windows and local environment.</p>
</li>
</ol>
<h1>WINDOWS(host)</h1>
<p>X86:
OK
<img width="731" height="400" alt="图片" src="https://github.com/user-attachments/assets/227755de-8cd3-4f97-9777-03cba227da5e" /></p>
<h1>LINUX(cross)</h1>
<p>OK
x86:
<img width="1274" height="802" alt="图片" src="https://github.com/user-attachments/assets/1c550844-0f53-4eef-b64a-f80f6ced67e7" /></p>
<h1>Android(cross)</h1>
<p>Ok
aarch64:
<img width="1146" height="1473" alt="图片" src="https://github.com/user-attachments/assets/ddb62609-f2fc-42e2-8a4b-6142a1be0fbf" /></p>
<h1>Android-Termux(host)</h1>
<p>Error
Trying to fix...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-11-14 13:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>Cargo.toml</code>:83 on 2025-11-14 13:52</div>
            <div class="timeline-body"><p>We shouldn't be bumping the versions of all of our other dependencies here too?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-11-14 13:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/linehaul.rs</code>:93 on 2025-11-14 13:53</div>
            <div class="timeline-body"><p>This shouldn't be included in the code</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-11-14 13:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/linehaul.rs</code>:100 on 2025-11-14 13:53</div>
            <div class="timeline-body"><p>Why are we unwrapping here if <code>Distro</code> takes <code>Option</code>s?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/linehaul.rs</code>:104 on 2025-11-14 13:54</div>
            <div class="timeline-body"><p>Does the crate not provide an API for this? Should we ask for it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-11-14 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-11-14 13:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/tests/it/user_agent_version.rs</code>:275 on 2025-11-14 13:54</div>
            <div class="timeline-body"><p>If we need to do transformations like this, we should not repeat it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-11-14 13:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-performance-memory-allocator/src/lib.rs</code>:12 on 2025-11-14 13:55</div>
            <div class="timeline-body"><p>This change to jemalloc should be a different pull request.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-11-14 13:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/windows_registry.rs</code>:32 on 2025-11-14 13:56</div>
            <div class="timeline-body"><p>Why is this Windows code changing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Replace `sys-info` with [sysinfo](https://crates.io/crates/sysinfo) library for better compatibility and Android support, and exclude Android from jemalloc to fix Termux compilation issues（is trying）." to "Replace `sys-info` with `sysinfo` for Android support; use mimalloc instead of jemalloc on Android" by @zanieb on 2025-11-14 13:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/LIghtJUNction">@LIghtJUNction</a> reviewed on 2025-11-14 15:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/LIghtJUNction">@LIghtJUNction</a> on <code>crates/uv-performance-memory-allocator/src/lib.rs</code>:12 on 2025-11-14 15:14</div>
            <div class="timeline-body"><p>I think so, too. I will reissue a new pr.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/LIghtJUNction">@LIghtJUNction</a> reviewed on 2025-11-14 15:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/LIghtJUNction">@LIghtJUNction</a> on <code>crates/uv-client/src/linehaul.rs</code>:104 on 2025-11-14 15:18</div>
            <div class="timeline-body"><p>https://docs.rs/sysinfo/latest/sysinfo/
I'm worried about destroying the existing compatibility. If not, how should I write it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/LIghtJUNction">@LIghtJUNction</a> reviewed on 2025-11-14 15:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/LIghtJUNction">@LIghtJUNction</a> on <code>crates/uv-client/tests/it/user_agent_version.rs</code>:275 on 2025-11-14 15:20</div>
            <div class="timeline-body"><p>You are quite right. If I pass the test, I will change it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/LIghtJUNction">@LIghtJUNction</a> reviewed on 2025-11-14 15:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/LIghtJUNction">@LIghtJUNction</a> on <code>Cargo.toml</code>:83 on 2025-11-14 15:26</div>
            <div class="timeline-body"><p>Here I use a vscode plugin: Dependi, for dependency upgrades.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-11-14 15:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>Cargo.toml</code>:83 on 2025-11-14 15:44</div>
            <div class="timeline-body"><p>Regardless, we shouldn't change the versions a bunch of dependencies like this. You'll need to reduce it to the relevant changes for <code>sysinfo</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-11-14 15:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>Cargo.toml</code>:83 on 2025-11-14 15:48</div>
            <div class="timeline-body"><p>A PR should have a small change and avoid making unrelated changes. That's important in a project as large as uv this is important for reviews (here specifically, we audit each dependency update separately), to keep the discussion in one PR focussed on a single things, and also for identifying and rolling back regressions if they happen. If the PR is about a dependency change, it should only change that dependency and make the necessary code changes, but not change other dependencies too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LIghtJUNction">@LIghtJUNction</a> on 2025-11-14 16:12</div>
            <div class="timeline-body"><p>Hello uv developers,</p>
<p>Greetings to all of you! Based on the principle of single responsibility, this pull request (PR) is essentially a test for issue identification. Through this test, we have identified two key issues that require your attention:</p>
<p>First, the dependency library &quot;sys-info&quot; needs to be uniformly updated to &quot;sysinfo&quot; for consistency across the codebase.</p>
<p>Second, version upgrades may trigger compatibility errors—among these, the error types specific to the Windows platform deserve special consideration. This issue has already emerged during the compilation process and carries a risk of recurrence in subsequent usage scenarios. We recommend that you proactively account for this in your relevant development work to avoid potential disruptions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @LIghtJUNction on 2025-11-16 05:16</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 05:52:31 UTC
    </footer>
</body>
</html>
