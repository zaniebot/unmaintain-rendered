<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>feat: detect venv relocation  - astral-sh/uv #11168</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>feat: detect venv relocation </h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/11168">#11168</a>
        opened by <a href="https://github.com/jonaslb">@jonaslb</a>
        on 2025-02-02 17:31
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/jonaslb">@jonaslb</a> on 2025-02-02 17:31</div>
            <div class="timeline-body"><!--
Thank you for contributing to uv! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Virtual environments are not relocatable (by default) in particular due to hardcoded paths in shebangs of scripts. While it is perhaps not very common to move a virtual environment by itself, it is not unthinkable that a user might reorganize his projects and hence effectively also the virtual environments. This can lead to weird errors, for example if a call to pytest &quot;falls through&quot; to the system installation instead of the (broken) entrypoint in the virtual environment.</p>
<p>This change adds a field <code>uv-venv-path</code> to <code>pyvenv.cfg</code>. The field is only added when the venv is not relocatable. When <code>uv</code> looks for usable venvs when e.g. syncing, it verifies that this path matches the actual path of the venv. If it does not match, the venv will be deleted and recreated.</p>
<p>Fixes #10895</p>
<!-- What's the purpose of the change? What does it do, and why? -->

<h2>Test Plan</h2>
<ul>
<li>There are a few simple tests to verify the contents of a written <code>pyvenv.cfg</code> for non-relocatable (default, <code>uv-venv-path</code> present) and relocatable venvs (<code>uv-venv-path</code> absent).</li>
<li>Added an assert to <code>sync_invalid_environment</code> to check that the venv is recreated when <code>uv-venv-path</code> does not match the actual path.</li>
<li>Also added an assert in the case that the <code>uv-venv-path</code> is absent from <code>pyvenv.cfg</code> (this will recreate the venv).</li>
</ul>
<!-- How was it tested? -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @jonaslb on 2025-02-02 17:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jonaslb">@jonaslb</a> on 2025-02-02 17:50</div>
            <div class="timeline-body"><p>It appears that I've missed a few other test cases that have also been affected by the changes. I will review and update.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jonaslb">@jonaslb</a> on 2025-02-02 18:43</div>
            <div class="timeline-body"><p>There were some tests that were failing due to having hardcoded pyvenv.cfg line numbers that I've fixed. There is a remaining failure related to symlink venvs introduced in #11083 that I need to look a little bit more into.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-03 21:35</div>
            <div class="timeline-body"><p>I think we were also considering making the <code>--relocatable</code> flag the default?</p>
<p>See</p>
<ul>
<li>https://github.com/astral-sh/uv/issues/6755</li>
</ul>
<p>@charliermarsh / @konstin thoughts?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jonaslb">@jonaslb</a> on 2025-02-03 22:13</div>
            <div class="timeline-body"><p>Ah, you already saw this :) Was just about to ask for feedback. The remaining CI failure (in benchmarks) is due to not fully resolving relative paths &quot;that go up&quot;. I think this is fixable by using <code>std::fs::canonicalize</code> (edit: or something like <a href="https://github.com/rust-lang/cargo/blob/990c7f41e05f2ee463f586e0c9d543e1216998f2/crates/cargo-util/src/paths.rs#L84">Cargo's <code>normalize_path</code></a>) (instead of <code>std::path::absolute</code>) in a few places, but I don't have more time right now, so it'll have to be later, unless this turns out not to have interest :)</p>
<p>I also wonder what you think (@zanieb) of the change I made to the symlink test. I think the behaviour (with my changes) is correct, but it might not be &quot;in the spirit of the test&quot; now. Perhaps it would be more correct to change it to use a relocatable venv.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @jonaslb on 2025-08-07 16:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 06:47:11 UTC
    </footer>
</body>
</html>
