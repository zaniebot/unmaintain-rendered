<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use a flock to avoid concurrent initialization of project environments - astral-sh/uv #11259</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use a flock to avoid concurrent initialization of project environments</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/11259">#11259</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2025-02-05 19:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>If you <code>uv run</code> from the same directory via multiple processes at the same time, some of them will fail as they'll see an &quot;incomplete&quot; virtual environment.</p>
<p>Closes https://github.com/astral-sh/uv/issues/11219.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2025-02-05 19:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @Gankra by @charliermarsh on 2025-02-05 19:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @charliermarsh on 2025-02-05 19:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2025-02-05 19:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-02-05 19:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/mod.rs</code>:751 on 2025-02-05 19:56</div>
            <div class="timeline-body"><p>Isn't this naughty? Aren't you supposed to grab some uv-specific tmp dir location?</p>
<p>(I thought we removed these intentionally in the past, the only remaining reference is in the trampolines)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-02-05 19:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/mod.rs</code>:751 on 2025-02-05 19:57</div>
            <div class="timeline-body"><p>Oh and https://github.com/astral-sh/uv/blob/d281f49103a08a6b77b20009d69e481a19221347/crates/uv-python/src/environment.rs#L311</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2025-02-05 19:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-02-05 20:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/mod.rs</code>:751 on 2025-02-05 20:14</div>
            <div class="timeline-body"><p>Yeah, we do this elsewhere. I guess we could create a directory within <code>env::temp_dir</code> called <code>uv</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/mod.rs</code>:751 on 2025-02-05 20:15</div>
            <div class="timeline-body"><p>Honestly I kind of think we should do this everywhere rather than creating <code>.lock</code> files in virtualenvs, etc.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-02-05 20:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2025-02-05 20:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-02-05 20:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-05 20:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/mod.rs</code>:751 on 2025-02-05 20:28</div>
            <div class="timeline-body"><p>I thought there was a very intentional reason we used co-located temporary files or the cache instead of <code>/tmp</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-02-05 20:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-02-05 20:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/uv/src/commands/project/mod.rs</code>:751 on 2025-02-05 20:48</div>
            <div class="timeline-body"><p>I don't know if it's relevant here but OS tempdirs are popular sources of Different Filesystem, and moving a file across filesystems does not benefit from the same atomicity guarantees (it's like <code>cp</code> instead of <code>mv</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-02-05 20:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/uv/src/commands/project/mod.rs</code>:751 on 2025-02-05 20:49</div>
            <div class="timeline-body"><p>(This is broadly possible with basically any random Other Directory, hence &quot;do atomic moves/renames only in the ~same directory&quot; is often advisable)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-02-05 21:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/mod.rs</code>:751 on 2025-02-05 21:00</div>
            <div class="timeline-body"><p>Yeah I think this is where we landed in Discord â€” co-location is critical for any atomic rename operations.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:41:52 UTC
    </footer>
</body>
</html>
