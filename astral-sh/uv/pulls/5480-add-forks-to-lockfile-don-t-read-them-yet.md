```yaml
number: 5480
title: "Add forks to lockfile, don't read them yet"
type: pull_request
state: merged
author: konstin
labels:
  - bug
  - preview
assignees: []
merged: true
base: main
head: konsti/add-forks-to-lockfile
created_at: 2024-07-26T13:15:03Z
updated_at: 2024-07-30T11:11:19Z
url: https://github.com/astral-sh/uv/pull/5480
synced_at: 2026-01-10T13:37:23Z
```

# Add forks to lockfile, don't read them yet

---

_Pull request opened by @konstin on 2024-07-26 13:15_

Add the forks to the lockfile, without using them yet, which we'll add in the next PR.

Please review commit-by-commit

Part of https://github.com/astral-sh/uv/issues/5180#issuecomment-2247696198

---

_Label `preview` added by @konstin on 2024-07-26 13:18_

---

_Marked ready for review by @konstin on 2024-07-29 13:51_

---

_Review requested from @BurntSushi by @konstin on 2024-07-29 13:51_

---

_Label `bug` added by @konstin on 2024-07-29 14:00_

---

_@BurntSushi approved on 2024-07-29 18:06_

This all LGTM. I'll mourn the lock file's simplicity. Markers are everywhere!

---

_Comment by @BurntSushi on 2024-07-30 01:34_

Thinking about this a bit more, how does this interact with `uv pip compile --universal`? We don't write the fork markers to `requirements.txt`, so does that mean `uv pip compile --universal` is unstable?

---

_Comment by @konstin on 2024-07-30 09:54_

Yes, `--universal` is unstable, and i don't have a good solution for fixing that:

Example: Packse scenario "preferences-dependent-forking":

First pass of `uv pip compile --universal forking.in -o forking.txt`:

```
# This file was autogenerated by uv via the following command:
#    uv pip compile --universal forking.in -o forking.txt
preferences-dependent-forking==0.0.0
    # via -r forking.in
preferences-dependent-forking-bar==1.0.0
    # via
    #   preferences-dependent-forking
    #   preferences-dependent-forking-cleaver
preferences-dependent-forking-cleaver==1.0.0
    # via preferences-dependent-forking
preferences-dependent-forking-foo==1.0.0
    # via
    #   preferences-dependent-forking
    #   preferences-dependent-forking-cleaver
preferences-dependent-forking-foo==2.0.0
    # via preferences-dependent-forking
```

Second pass of `uv pip compile --universal forking.in -o forking.txt`:

```
# This file was autogenerated by uv via the following command:
#    uv pip compile --universal forking.in -o forking.txt
preferences-dependent-forking==0.0.0
    # via -r forking.in
preferences-dependent-forking-bar==1.0.0
    # via
    #   preferences-dependent-forking
    #   preferences-dependent-forking-cleaver
preferences-dependent-forking-cleaver==1.0.0
    # via preferences-dependent-forking
preferences-dependent-forking-foo==1.0.0
    # via
    #   preferences-dependent-forking
    #   preferences-dependent-forking-cleaver
```

---

_Merged by @konstin on 2024-07-30 11:11_

---

_Closed by @konstin on 2024-07-30 11:11_

---

_Branch deleted on 2024-07-30 11:11_

---
