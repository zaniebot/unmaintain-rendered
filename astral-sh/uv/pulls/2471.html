<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Make &gt; operator exclude post and local releases - astral-sh/uv #2471</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Make &gt; operator exclude post and local releases</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/2471">#2471</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-03-15 02:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-15 02:20</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR attempts to use a similar trick to that we added in https://github.com/astral-sh/uv/pull/1878, but for post-releases.</p>
<p>In https://github.com/astral-sh/uv/pull/1878, we added a fake &quot;minimum&quot; version to enable us to treat <code>&lt; 1.0.0</code> as <em>excluding</em> pre-releases of 1.0.0.</p>
<p>Today, on <code>main</code>, we accept post-releases and local versions in <code>&gt; 1.0.0</code>. But per PEP 440, that should <em>exclude</em> post-releases and local versions, unless the specifier is itself a pre-release, in which case, pre-releases are allowed (e.g., <code>&gt; 1.0.0.post0</code> should allow <code>&gt; 1.0.0.post1</code>).</p>
<p>To support this, we add a fake &quot;maximum&quot; version that's greater than all the post and local releases for a given version. This leverages our last remaining free bit in the compact representation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-03-15 02:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/pep440-rs/src/version.rs</code>:2419 on 2024-03-15 02:23</div>
            <div class="timeline-body"><p>Mildly concerned with how all of this intersects with post-releases, but I did add tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-15 02:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-15 02:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>scripts/scenarios/generate.py</code>:207 on 2024-03-15 02:25</div>
            <div class="timeline-body"><p>This is the payoff, we can remove a bunch of incorrectly-succeeding scenarios.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @charliermarsh on 2024-03-15 02:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-15 02:27</div>
            <div class="timeline-body"><p>This is related to https://github.com/astral-sh/uv/pull/2430, but not really relevant for the core use-case of local versions (PyTorch) -- it's just a correctness thing.</p>
<p>I <em>do</em> think we would've received a bug report that <code>&gt; 1.0.0</code> should not match <code>&gt; 1.0.0.post0</code> at some point though. I'm actually surprised that hasn't come up yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-15 02:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/pep440-rs/src/version.rs</code>:2419 on 2024-03-15 02:39</div>
            <div class="timeline-body"><p>I ended up removing <code>dev</code> support, we never create a version with both <code>max</code> and <code>dev</code> so not sure it's worth accommodating it here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-15 02:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/pep440-rs/src/version.rs</code>:2421 on 2024-03-15 02:40</div>
            <div class="timeline-body"><p>We could also consider incorporating <code>max</code> into the <code>match</code> below... This felt easier to get right.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-03-15 03:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/pip_install_scenarios.rs</code>:1517 on 2024-03-15 03:52</div>
            <div class="timeline-body"><p>Not for here, but I wonder if we should add a &quot;hint&quot; explaining why <code>package-b==2.0.0+foo</code> does not satisfy <code>package-b&gt;2.0.0</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/pip_install_scenarios.rs</code>:2125 on 2024-03-15 03:54</div>
            <div class="timeline-body"><p>Similarly, I wonder if we should add a hint that <code>1.2.3.post1</code> is available. I think it's probably unnecessary here since <code>post</code> releases feel equivalent to the version they follow and are generally transparent to users?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-03-15 03:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-03-15 03:58</div>
            <div class="timeline-body"><p>Makes sense to me!</p>
<p>It might be nice to have scenarios for:</p>
<ul>
<li>The user requests a post version but there are no post versions available</li>
<li>The user requests a greater than post version the excludes all available post versions</li>
</ul>
<p>To ensure we display these correctly in our unsat messages</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-03-15 03:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/pep440-rs/src/version.rs</code>:2419 on 2024-03-15 03:59</div>
            <div class="timeline-body"><p>Is this caveat documented?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-03-15 12:57</div>
            <div class="timeline-body"><p>This LGTM, but I think you might want to bump the cache version because of the representational change to <code>Version</code>. Actually, I kind of wonder if you maybe don't need to do it for this change, since I don't believe any existing versions have their meaning changed or become invalidated. Unlike the <code>min</code> change, this change doesn't impact the existing suffix tags. Unless we're 100% sure, we should bump it, because if we're wrong it can cause subtle and implicit bugs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/pep440-rs/src/version.rs</code>:2419 on 2024-03-15 13:49</div>
            <div class="timeline-body"><p>I added debug asserts to the constructors for <code>min</code> and <code>max</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-15 13:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-15 13:49</div>
            <div class="timeline-body"><p>Bumped cache!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2024-03-15 13:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-03-15 14:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-03-15 14:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-03-15 14:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 14:49:26 UTC
    </footer>
</body>
</html>
