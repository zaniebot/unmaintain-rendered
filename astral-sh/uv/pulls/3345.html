<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>require serde and rkyv everywhere; remove optional serde and rkyv features - astral-sh/uv #3345</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>require serde and rkyv everywhere; remove optional serde and rkyv features</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/3345">#3345</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2024-05-03 13:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-05-03 13:26</div>
            <div class="timeline-body"><p>In <em>some</em> places in our crates, <code>serde</code> (and <code>rkyv</code>) are optional
dependencies. I believe this was done out of reasons of &quot;good sense,&quot;
that is, it follows a Rust ecosystem pattern where serde integration
tends to be an opt-in crate feature. (And similarly for <code>rkyv</code>.)</p>
<p>However, ultimately, <code>uv</code> itself requires <code>serde</code> and <code>rkyv</code> to
function. Since our crates are strictly internal, there are limited
consumers for our crates without <code>serde</code> (and <code>rkyv</code>) enabled. I think
one possibility is that optional <code>serde</code> (and <code>rkyv</code>) integration means
that someone can do this:</p>
<pre><code>cargo test -p pep440_rs</code></pre>
<p>And this will run tests <em>without</em> <code>serde</code> or <code>rkyv</code> enabled. That in
turn could lead to faster iteration time by reducing compile times. But,
I'm not sure this is worth supporting. The iterative compilation times of
individual crates are probably fast enough in debug mode, even with
<code>serde</code> and <code>rkyv</code> enabled. Namely, <code>serde</code> and <code>rkyv</code> themselves
shouldn't need to be re-compiled in most cases. On <code>main</code>:</p>
<pre><code>from-scratch: `cargo test -p pep440_rs --lib` 0.685
incremental: `cargo test -p pep440_rs --lib` 0.278s
from-scratch: `cargo test -p pep440_rs --features serde,rkyv --lib` 3.948s
incremental: `cargo test -p pep440_rs --features serde,rkyv --lib` 0.321s
</code></pre>
<p>So while a from-scratch build does take significantly longer, an
incremental build is about the same.</p>
<p>The benefit of doing this change is two-fold:</p>
<ol>
<li>It brings out crates into alignment with &quot;reality.&quot; In particular,
some crates were <em>implicitly</em> relying on <code>serde</code> being enabled
without explicitly declaring it. This technically means that our
<code>Cargo.toml</code>s were wrong in some cases, but it is hard to observe it
because of feature unification in a Cargo workspace.</li>
<li>We no longer need to deal with the cognitive burden of writing
<code>#[cfg_attr(feature = &quot;serde&quot;, ...)]</code> everywhere.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @BurntSushi on 2024-05-03 13:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @BurntSushi on 2024-05-03 13:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @BurntSushi on 2024-05-03 13:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-05-03 13:31</div>
            <div class="timeline-body"><p>Yeah, this seems like the correct trade-off for us.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-05-03 13:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rustlib</span> added by @zanieb on 2024-05-03 13:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-05-03 13:40</div>
            <div class="timeline-body"><p>This may affect people using our crates (like pixi) right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-05-03 13:42</div>
            <div class="timeline-body"><blockquote>
<p>This may affect people using our crates (like pixi) right?</p>
</blockquote>
<p>It could. But this doesn't remove anything. In the worst case, they will wind up compiling <code>serde</code> even if they don't need it. But I don't have a ton of insight there...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-05-03 13:44</div>
            <div class="timeline-body"><p>@BurntSushi won't they get an error that there is no feature &quot;serde&quot;? I've seen this when removing the optional in the past.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-05-03 13:48</div>
            <div class="timeline-body"><blockquote>
<p>@BurntSushi won't they get an error that there is no feature &quot;serde&quot;? I've seen this when removing the optional in the past.</p>
</blockquote>
<p>Oh sure, if they are opting into serde, yes. But we aren't doing semver on these crates. And their fix is simple: just remove the opt-in.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-05-03 13:52</div>
            <div class="timeline-body"><p>I think if it were <em>just</em> me I would leave it as-is -- it doesn't cause me much trouble, it's well-principled, and we may have to undo this in the future. But I understand the desire to remove, and &quot;we may have to undo this in the future&quot; is always a YAGNI red flag.</p>
<p>But please only merge if it's net-helpful for you, and not because I mentioned it in Discord :joy:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2024-05-03 14:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2024-05-03 14:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-05-03 14:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-05-03 14:22</div>
            <div class="timeline-body"><blockquote>
<p>But please only merge if it's net-helpful for you, and not because I mentioned it in Discord ðŸ˜‚</p>
</blockquote>
<p>Hah, yeah, it has been bothering me for a while.</p>
<p>I agree that it's possible we might have to undo this. But I think that will be part of publishing crates, right? (Maybe there's another use case I'm missing.) If so, I think there will be a fair bit of other work to do anyway in that case. An ecosystem crate and an internal crate are two different beasts.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-03 14:23</div>
            <div class="timeline-body"><p>Yup all good, I support it!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 14:38:12 UTC
    </footer>
</body>
</html>
