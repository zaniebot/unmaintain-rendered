<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treat `--upgrade-package` on the command-line as overriding `upgrade = false` in configuration - astral-sh/uv #15395</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Treat <code>--upgrade-package</code> on the command-line as overriding <code>upgrade = false</code> in configuration</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/15395">#15395</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2025-08-20 16:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-20 16:58</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Right now, if you put <code>upgrade = false</code> in a <code>uv.toml</code>, then pass <code>--upgrade-package numpy</code> on the CLI, we won't upgrade NumPy. This PR fixes that interaction by ensuring that when we &quot;combine&quot;, we look at those arguments holistically (i.e., we bundle <code>upgrade</code> and <code>upgrade-package</code> into a single struct, which then goes through the <code>.combine</code> logic), rather than combining <code>upgrade</code> and <code>upgrade-package</code> independently.</p>
<p>If approved, I then need to add the same thing for <code>no-build-isolation</code>, <code>reinstall</code>, <code>no-build</code>, and <code>no-binary</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2025-08-20 16:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2025-08-20 16:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2025-08-20 18:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @charliermarsh on 2025-08-20 18:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-08-21 08:48</div>
            <div class="timeline-body"><p>The new behavior makes sense to me!</p>
<hr />
<p>One thing that I found unexpected is that <code>--no-upgrade</code> causes <code>--upgrade-package</code> to be silently ignored:</p>
<pre><code>$ uv venv -c -p 3.12 &amp;&amp; uv-debug pip install numpy==2 &amp;&amp; uv-debug pip install --no-upgrade --upgrade-package numpy pandas
Using CPython 3.12.11
Creating virtual environment at: .venv
Activate with: source .venv/bin/activate
Resolved 1 package in 8ms
Installed 1 package in 18ms
 + numpy==2.0.0
Resolved 6 packages in 25ms
Installed 5 packages in 17ms
 + pandas==2.3.1
 + python-dateutil==2.9.0.post0
 + pytz==2025.2
 + six==1.17.0
 + tzdata==2025.2
</code></pre>
<p>This is different from <code>--no-build</code> and <code>--no-binary</code>:</p>
<pre><code>$ uv venv -c -p 3.12 &amp;&amp; uv-debug pip install numpy==2 &amp;&amp; uv-debug pip install --no-build --no-binary numpy pandas
Using CPython 3.12.11
Creating virtual environment at: .venv
Activate with: source .venv/bin/activate
Resolved 1 package in 8ms
Installed 1 package in 15ms
 + numpy==2.0.0
error: the argument '--no-build' cannot be used with '--no-binary &lt;NO_BINARY&gt;'

Usage: uv-debug pip install --no-build &lt;PACKAGE|--requirements &lt;REQUIREMENTS&gt;|--editable &lt;EDITABLE&gt;|--group &lt;GROUP&gt;&gt;

For more information, try '--help'.
</code></pre>
<p>When reading the code, my main confusion was that the struct isn't fully usable, the upgrade package list is only consider if neither <code>--upgrade</code> nor <code>--no-upgrade</code> are passed and the upgrade value is <code>None</code>. I was struggling to verify that the merge logic is correct, if we had two <code>Option&lt;UpgradeSelection&gt;</code>, only <code>Some</code> if any upgrade option was passed, the merging logic could be written as:</p>
<pre><code class="language-rust">#[derive(Debug, Clone)]
pub enum UpgradeSelection {
    All,
    None,
    // Packages are relevant, otherwise `Option&lt;UpgradeSelection&gt;` would be `None`.
    Packages(Vec&lt;Requirement&gt;),
}

impl UpgradeSelection {
    #[must_use]
    pub fn combine(self, other: Self) -&gt; Self {
        match self {
            // Setting `--upgrade` or `--no-upgrade` clear previous `--upgrade-package` selections.
            Self::All | Self::None =&gt; self,
            Self::Packages(self_packages) =&gt; match other {
                // With `--upgrade` previously, `--upgrade-package` is subsumed by upgrading all packages.
                Self::All =&gt; other,
                // With `--no-upgrade` previously, and now `--upgrade-package`, upgrade the explicit package list.
                Self::None =&gt; Self::Packages(self_packages),
                // If both had `--upgrade-package`, upgrade the combined package list.
                Self::Packages(other_packages) =&gt; {
                    let mut combined = self_packages;
                    combined.extend(other_packages);
                    Self::Packages(combined)
                }
            },
        }
    }
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-21 11:39</div>
            <div class="timeline-body"><p>I agree with</p>
<blockquote>
<p>One thing that I found unexpected is that --no-upgrade causes --upgrade-package to be silently ignored</p>
</blockquote>
<p>I'd expect <code>--upgrade-package</code> to take precedence.</p>
<p>Otherwise, I'm a +1 on the behavior. It sounds actually doesn't require encoding a relationship between the persistent configuration and the CLI like we were discussing? Or does <code>upgrade-package = [&quot;foo&quot;]</code> with <code>--no-upgrade</code> perform no upgrades?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-21 11:44</div>
            <div class="timeline-body"><p>I thought we had discussed the the no-upgrade / upgrade-package behavior and decided we wanted to change it but that it was breaking? That’s why I left a TODO. It’s easy to change now either way.</p>
<blockquote>
<p>Or does upgrade-package = [&quot;foo&quot;] with --no-upgrade perform no upgrades?</p>
</blockquote>
<p>Yeah, that doesn’t perform any upgrades (which I think is correct).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-08-21 11:48</div>
            <div class="timeline-body"><p>I didn't see a TODO item for that, but delaying the breaking change to 0.9 makes sense, should we add a warning now that <code>--no-upgrade</code> with <code>--upgrade-package</code> doesn't work as expected that becomes an error in 0.9?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-21 11:48</div>
            <div class="timeline-body"><blockquote>
<p>I thought we had discussed the the no-upgrade / upgrade-package behavior and decided we wanted to change it but that it was breaking?</p>
</blockquote>
<p>Oh I see, I didn't realize you were separating it out into a bug fix and a breaking change. Sorry. I don't mind doing it that way as long as we're aligned on the end behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-21 11:49</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>Or does upgrade-package = [&quot;foo&quot;] with --no-upgrade perform no upgrades?</p>
</blockquote>
<p>Yeah, that doesn’t perform any upgrades (which I think is correct).</p>
</blockquote>
<p>Yeah that sounds correct to me. It does introduce that complexity of different semantics depending on the origin layer, but it sounds worth it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-21 12:48</div>
            <div class="timeline-body"><p>Ah sorry, I guess the TODO is in the test suite (specifically, above the test with the undesirable result) and was introduced in the PR that added the tests, so doesn't appear here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-21 12:49</div>
            <div class="timeline-body"><blockquote>
<p>I didn't see a TODO item for that, but delaying the breaking change to 0.9 makes sense, should we add a warning now that --no-upgrade with --upgrade-package doesn't work as expected that becomes an error in 0.9?</p>
</blockquote>
<p>I think I'd rather <em>not</em> do this because I don't want them to be an error in 0.9, I want <code>--upgrade-package</code> to override <code>--no-upgrade</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-21 12:49</div>
            <div class="timeline-body"><blockquote>
<p>I think I'd rather not do this because I don't want them to be an error in 0.9, I want --upgrade-package to override --no-upgrade.</p>
</blockquote>
<p>I agree.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-08-21 12:50</div>
            <div class="timeline-body"><p>That's even better!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-21 12:52</div>
            <div class="timeline-body"><p>(I'll take a look at @konstin's suggested refactor, might make things simpler.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-08-21 13:36</div>
            <div class="timeline-body"><p>Okay, we now use an <code>Option</code> around the outer struct, etc.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-configuration/src/package_options.rs</code>:138 on 2025-08-21 14:05</div>
            <div class="timeline-body"><p>Should this type be (de)serialize?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2025-08-21 14:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-08-21 15:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-configuration/src/package_options.rs</code>:138 on 2025-08-21 15:11</div>
            <div class="timeline-body"><p>No, thanks :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2025-08-21 15:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-08-21 15:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-21 15:20</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:29 UTC
    </footer>
</body>
</html>
