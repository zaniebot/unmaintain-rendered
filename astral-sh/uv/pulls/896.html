<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avoid some additional clones for `PackageName` - astral-sh/uv #896</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Avoid some additional clones for <code>PackageName</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/896">#896</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-01-12 04:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><p><em>No description provided.</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-normalize/src/package_name.rs</code>:50 on 2024-01-12 04:54</div>
            <div class="timeline-body"><p>We can avoid allocating if it doesn't contain <code>-</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-12 04:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-12 04:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/distribution-types/src/traits.rs</code>:38 on 2024-01-12 04:55</div>
            <div class="timeline-body"><p>I think we can use <em>any</em> separator here that doesn't appear in versions? As in, I assume the reason for using <code>as_dist_info_name</code> is that we want to avoid ambiguity because otherwise dashes can appear in versions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2024-01-12 04:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @charliermarsh on 2024-01-12 04:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-01-12 09:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/distribution-types/src/traits.rs</code>:38 on 2024-01-12 09:10</div>
            <div class="timeline-body"><p>Dashes can't appear in normalized versions; i picked that format because it's the same normalization as in wheel filenames.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-01-12 09:14</div>
            <div class="timeline-body"><p>Did you see <code>PackageName</code> in the profiles? I never bothered because in the cases i looked at <code>Version</code> was so dominant.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/puffin-normalize/src/package_name.rs</code>:50 on 2024-01-12 09:22</div>
            <div class="timeline-body"><p>Nit: Slightly fewer branching</p>
<pre><code class="language-suggestion">        if let Some(dash_position) = self.0.find('-') {
            // Initialize `replaced` with the start of the string up to the current character.
            let mut owned_string = String::with_capacity(self.0.len());
            owned_string.push_str(&amp;self.0[..dash_position]);
            owned_string.push('_');

            // Iterate over the rest of the string.
            owned_string.extend(self.0[dash_position + 1..].chars().map(|character| {
                if character == '-' {
                    '_'
                } else {
                    character
                }
            }));
            

            Cow::Owned(owned_string)
        } else {
            Cow::Borrowed(self.0.as_str())
        }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-01-12 09:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-01-12 09:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/puffin-normalize/src/package_name.rs</code>:50 on 2024-01-12 09:28</div>
            <div class="timeline-body"><p>I thought about suggesting the <code>if memchr { Owned(str.replace) } else { Borrowed(original) }</code> version but then i thought it was intentionally avoided to not parse the string twice.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-12 14:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/distribution-types/src/traits.rs</code>:38 on 2024-01-12 14:39</div>
            <div class="timeline-body"><p>Oh I got confused because of pre-releases, but I guess those are stripped from the normalized version?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-01-12 16:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/distribution-types/src/traits.rs</code>:38 on 2024-01-12 16:19</div>
            <div class="timeline-body"><p>The are normalized to <code>1.1a1</code>, <code>1.1b2</code>, and <code>1.1rc3</code> (https://peps.python.org/pep-0440/#pre-release-spelling)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-01-12 17:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-01-12 17:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-01-12 17:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:35:09 UTC
    </footer>
</body>
</html>
