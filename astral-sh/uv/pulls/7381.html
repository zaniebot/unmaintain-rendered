<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prefer compatible wheels in universal resolver - astral-sh/uv #7381</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Prefer compatible wheels in universal resolver</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/7381">#7381</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-09-14 00:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>I need input on whether this is a good change. In the universal resolver, we currently choose an arbitrary wheel when extracting package metadata. A downside here is that if we need to download the entire wheel, we might end up downloading a <em>second</em> (compatible) wheel when we go to install. So, e.g., you could end up downloading two PyTorch wheels, one during resolution, and one during installation (if your registry doesn't support range requests -- otherwise, we don't download during resolution anyway).</p>
<p>The idea here is to respect platform tags when deciding which wheel to use (but <em>not</em> error if we can't find a compatible wheel).</p>
<p>The major downside here is that resolution could actually vary depending on the platform you're on, if a package has inconsistent metadata across wheels, since we'll look at different wheels for metadata on Windows vs. on Linux, for example.</p>
<p>I'm inclined <em>not</em> to do this, since it breaks the nice property that resolution is entirely machine-independent. But it's weird to download two wheels like that.</p>
<p>Closes https://github.com/astral-sh/uv/issues/5921.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @charliermarsh on 2024-09-14 00:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2024-09-14 00:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-14 00:18</div>
            <div class="timeline-body"><p>(Ignore the code for now. Mostly want input on whether we should even do this.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-14 03:11</div>
            <div class="timeline-body"><p>I'm roughly in favor of this, since we already strongly encourage metadata to be consistent across wheels. Downloading two different wheels seems problematic.</p>
<p>What happens if you have varied wheel metadata and lock on one platform then another? Will the lockfile change? Can we mitigate the bad experience there somehow?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-14 03:20</div>
            <div class="timeline-body"><p>I think we would let you keep the current lockfile (i.e., we'd consider it &quot;up-to-date&quot;), since we assume that registry metadata is immutable anyway in that check.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-09-14 03:47</div>
            <div class="timeline-body"><p>But if you ran <code>lock --upgrade</code> it would do a new resolution and choose the new wheel for this package and more things would change? Or would preferences save us there? Just trying to understand the &quot;failure&quot; mode.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-09-14 12:33</div>
            <div class="timeline-body"><blockquote>
<p>But if you ran lock --upgrade it would do a new resolution and choose the new wheel for this package and more things would change? Or would preferences save us there? Just trying to understand the &quot;failure&quot; mode.</p>
</blockquote>
<p>Yeah, if the lock was generated on macOS, and you're on Windows, then I <em>think</em> running <code>lock --upgrade</code> could lead to changes in metadata even if the versions didn't change (e.g., maybe you get a different TensorFlow wheel due to your platform).</p>
<p>So that wouldn't be great. It's possible we could fix that though by using the lockfile to populate the cache.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-09-16 09:39</div>
            <div class="timeline-body"><blockquote>
<p>What happens if you have varied wheel metadata and lock on one platform then another? Will the lockfile change? Can we mitigate the bad experience there somehow?</p>
</blockquote>
<p>Currently, we silently do the wrong thing. We could mitigate this by always showing diagnostics (<code>SitePackages::diagnostics</code>) after sync. For example, if I delete asgiref from a django lockfile I get:</p>
<pre><code>Resolved 4 packages in 4ms
Prepared 2 packages in 0.28ms
Installed 2 packages in 35ms
 + django==5.1.1
 + sqlparse==0.5.1
warning: The package `django` requires `asgiref&gt;=3.8.1,&lt;4`, but it's not installed
</code></pre>
<p>In transformers, this already happens on main:</p>
<pre><code>warning: The package `torch` requires `setuptools`, but it's not installed
</code></pre>
<p>We should consider checking at install time that the metadata is consistent. On a quick test, adding this adds 2ms to the existing 88ms on transformers, but we could e.g. reuse the METADATA reading in the installer threadpool instead of doing duplicate work after installation. To me, handling inconsistent metadata correctly means that we can use any wheel picking strategy without risk.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-09-16 14:31</div>
            <div class="timeline-body"><p>I think if this only leads to problems where metadata varies across wheels, then I'd be in favor of it personally. Like, we already make the assumption that the metadata is consistent across wheels in various places right? If it doesn't hold, then won't more things break?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-02-11 02:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-11 02:36</div>
            <div class="timeline-body"><p>I worry we'll end up regretting this change, because suddenly issues etc. will become harder to reproduce in that we can no longer rely on resolution being consistent across platforms...</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:39:34 UTC
    </footer>
</body>
</html>
