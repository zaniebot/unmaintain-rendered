<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add a trampoline variant that just executes `python` - astral-sh/uv #8637</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add a trampoline variant that just executes <code>python</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/8637">#8637</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-10-28 15:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-28 15:57</div>
            <div class="timeline-body"><p>Currently, our trampoline is used to convert <code>&lt;command&gt; [args]</code> to <code>python &lt;command&gt; [args]</code> for script entrypoints installed into virtual environments. For #8458, it'd be nice to convert a shim <code>python3.12 [args]</code> to <code>python [args]</code>. Here, we modify the trampolines to support this use-case.</p>
<p>The only change we really need here is to avoid injecting <code>&lt;command&gt;</code> into the child process. We change the &quot;magic number&quot; at the end of the trampoline executables from <code>UVUV</code> to <code>UVSC</code> and <code>UVPY</code> which define &quot;script&quot; and &quot;python&quot; variants to the trampoline. We then omit the <code>&lt;command&gt;</code> injection in the latter case. We also omit writing the zip script payload when constructing the trampoline.</p>
<p>To support construction of the new variant, a new <code>uv-trampoline-builder</code> crate is introduced â€” this avoids requirements on <code>uv-install-wheel</code> in future work. I also use <code>uv-trampoline-builder</code> to consolidate some of the test setup for <code>uv-trampoline</code>.</p>
<p>There should be no backwards compatibility concerns, since trampolines are fully self-referential.</p>
<p>I rebased to fix the commits at the end, as this took many iterations to get working via CI. This should roughly be reviewable by commit if you prefer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-10-28 16:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-trampoline/src/bounce.rs</code>:56 on 2024-10-28 16:05</div>
            <div class="timeline-body"><p>we need to add <code>UVUV</code> here to preserve compatibility with environments created pre-0.5.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-10-28 16:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-trampoline/src/bounce.rs</code>:56 on 2024-10-28 16:08</div>
            <div class="timeline-body"><p>Why's that? Isn't the trampoline always self-contained?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-10-28 16:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-trampoline/src/bounce.rs</code>:56 on 2024-10-28 16:09</div>
            <div class="timeline-body"><p>oh right, because we won't actually be cross reading newer entrypoints</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @zanieb on 2024-10-28 19:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @zanieb on 2024-10-28 19:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @zanieb on 2024-10-28 19:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-10-28 19:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-install-wheel/src/wheel.rs</code>:166 on 2024-10-28 19:56</div>
            <div class="timeline-body"><p>This moved ~unchanged into <code>uv-trampoline-builder</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-10-28 19:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-install-wheel/src/wheel.rs</code>:1080 on 2024-10-28 19:56</div>
            <div class="timeline-body"><p>This moved into <code>uv-trampoline-builder</code>, size limit bumped</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-10-28 19:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-trampoline-builder/src/lib.rs</code>:183 on 2024-10-28 19:56</div>
            <div class="timeline-body"><p>These tests pulled from <code>uv-trampoline::tests::harness</code> and <code>uv-install-wheel</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-10-28 19:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-trampoline-builder/src/lib.rs</code>:153 on 2024-10-28 19:57</div>
            <div class="timeline-body"><p>This is new</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-10-28 19:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-trampoline-builder/src/lib.rs</code>:104 on 2024-10-28 19:57</div>
            <div class="timeline-body"><p>This was copied ~unchanged</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-10-28 19:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-trampoline/tests/harness.rs</code>:1 on 2024-10-28 19:57</div>
            <div class="timeline-body"><p>This moved ~unchanged into <code>uv-trampoline-builder</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Add a trampoline variant that executes `python`" to "Add a trampoline variant that just executes `python`" by @zanieb on 2024-10-28 21:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2024-10-28 23:21</div>
            <div class="timeline-body"><blockquote>
<p>The trampolines increased from ~45kb to ~80kb</p>
</blockquote>
<p>Weird, I noticed none of the code added should've increased it this much</p>
<p>Decided to build it locally (release) it's still in the ~45kb. We should probably update the sizes test to keep using the release build size, not the dev size ðŸ˜…</p>
<img width="485" alt="bounce_build" src="https://github.com/user-attachments/assets/015e26b3-1b0b-41dc-b7e7-f8f1a20183d6">

<p>Dev Sizes were about ~80kb</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-28 23:40</div>
            <div class="timeline-body"><p>Ohhh I see what's happening here. I was also surprised they increased in size. Thanks for pointing that out. That's... annoying to fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-10-29 08:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-install-wheel/src/wheel.rs</code>:38 on 2024-10-29 11:41</div>
            <div class="timeline-body"><p>I believe you can just write <code>b&quot;UVSC&quot;</code> and <code>b&quot;UVPY&quot;</code> here. (Fun fact, byte string literals have type <code>&amp;'static [u8; N]</code> where as string literals have type <code>&amp;'static str</code>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-trampoline/src/bounce.rs</code>:51 on 2024-10-29 11:46</div>
            <div class="timeline-body"><p>Byte string literals should work here too (as above).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-trampoline/src/bounce.rs</code>:51 on 2024-10-29 11:52</div>
            <div class="timeline-body"><p>Ah whoops, you already did this. :P</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-trampoline-builder/src/lib.rs</code>:202 on 2024-10-29 11:54</div>
            <div class="timeline-body"><p>Would using <code>cfg(not(debug_assertions))</code> as a proxy for &quot;compiling with optimizations&quot; help here? Otherwise, you can't <code>cfg</code> on <code>opt-level</code> at present. So probably the only alternative is a Cargo feature. (Assuming I'm understanding the problem correctly.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2024-10-29 11:54</div>
            <div class="timeline-body"><p>LGTM. How did you resolve the test failures from yesterday?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-10-29 13:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-install-wheel/src/wheel.rs</code>:38 on 2024-10-29 13:45</div>
            <div class="timeline-body"><p>Yeah I was following the existing format but Clippy put me on the right path here :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-10-29 13:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-trampoline-builder/src/lib.rs</code>:202 on 2024-10-29 13:46</div>
            <div class="timeline-body"><p>That'd be interesting. I can also just.. run these tests separately from the ones we run to test changes to the trampolines. In CI, we replace the production trampolines with a debug build.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-10-29 13:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-trampoline-builder/src/lib.rs</code>:202 on 2024-10-29 13:52</div>
            <div class="timeline-body"><p>Is the threshold bump still relevant? In the git diff it looks like the binaries even shrank a little</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-10-29 13:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-trampoline-builder/src/lib.rs</code>:202 on 2024-10-29 13:55</div>
            <div class="timeline-body"><p>Since I moved the tests, they run against the debug builds we create for testing.</p>
<p>I can fix that somehow, or we can just assert on the size of the debug builds (80kb is still very reasonable).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-29 13:59</div>
            <div class="timeline-body"><p>@BurntSushi I resolved the test failures by moving the tests from <code>uv-trampoline/src/lib.rs</code> into <code>uv-trampoline-builder/src/lib.rs</code>. Still no idea what was going on there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-10-29 14:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-trampoline/src/bounce.rs</code>:51 on 2024-10-29 14:00</div>
            <div class="timeline-body"><p>Sorry; this is one of those things that wasn't worth moving in the rebase since it was a mess</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-29 14:20</div>
            <div class="timeline-body"><p>Now we test both explicitly</p>
<img width="1373" alt="Screenshot 2024-10-29 at 9 19 54â€¯AM" src="https://github.com/user-attachments/assets/b7471a62-0d93-4934-ab2f-6d4f8898c795">

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-10-29 14:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-trampoline-builder/src/lib.rs</code>:202 on 2024-10-29 14:20</div>
            <div class="timeline-body"><p>See https://github.com/astral-sh/uv/pull/8637#issuecomment-2444412153 https://github.com/astral-sh/uv/pull/8637/commits/cbb90bad697c04aa68be259fa36e34fe847c208a</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-29 14:21</div>
            <div class="timeline-body"><p>Thanks for the reviews!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2024-10-29 14:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-10-29 14:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-10-29 14:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @zanieb on 2024-10-29 14:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 13:02:13 UTC
    </footer>
</body>
</html>
