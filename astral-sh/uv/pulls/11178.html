<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add note about tmpfsen for Docker builds - astral-sh/uv #11178</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add note about tmpfsen for Docker builds</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/11178">#11178</a>
        opened by <a href="https://github.com/akx">@akx</a>
        on 2025-02-03 09:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/akx">@akx</a></div>
            <div class="timeline-body">Summary
<p>Documents <code>--mount=type=tmpfs,target=/tmp</code> as a workaround/fix for stray lockfiles, etc., as discussed in #10773.</p>
Test Plan
<p>A crack team of highly trained marmots equipped with adorable pince-nez glasses took multiple critical looks at this text and found nothing alarming about it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-03 14:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-10 22:07</div>
            <div class="timeline-body"><p>We&#x27;re looking at avoiding writing these to <code>/tmp</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akx">@akx</a> on 2025-02-11 08:17</div>
            <div class="timeline-body"><blockquote>
<p>We&#x27;re looking at avoiding writing these to <code>/tmp</code></p>
</blockquote>
<p>Are you planning to write them into e.g. somewhere under the <code>venv</code> directory..? That&#x27;d be worse, since if, as discussed in #10773, there&#x27;s no reliable way to delete them after use, the Dockerfile author would have to clean them up with a <code>find</code> incantation or similar afterwards...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-11 15:16</div>
            <div class="timeline-body"><p>We&#x27;re considering both co-located (i.e., in the virtual environment) or in a dedicated alternative directory. Can you explain <em>why</em> this file needs to be deleted? I don&#x27;t see any problem with this file being present in the virtual environment â€” and it seems dubious that one more file there is going to cause measurable overhead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/akx">@akx</a> on 2025-02-11 19:41</div>
            <div class="timeline-body"><blockquote>
<p>Can you explain why this file needs to be deleted?</p>
</blockquote>
<p>Because it shouldn&#x27;t be there when it&#x27;s not needed. ðŸ˜…</p>
<blockquote>
<p>and it seems dubious that one more file there is going to cause measurable overhead?</p>
</blockquote>
<p>Believe it or not, every file in a Docker image has measurable impact, since the extraction of an image layer into the filesystem is serialized.</p>
<p>From an experiment I did last year while investigating <a href="https://github.com/moby/moby/issues/48601">moby/moby#48601</a>; two images, the exact same size, with 2 layers, from a local registry (so bandwidth doesn&#x27;t matter):</p>
<pre><code>localhost:5000/x-small         latest      008ff0304c6d   528MB
localhost:5000/x-large         latest      2b9b389c20e1   528MB
</code></pre>
<p>The output of <code>hyperfine</code> comparing <code>docker pull</code> speed:</p>
<pre><code>  docker rmi -f localhost:5000/x-large &amp;&amp; docker pull localhost:5000/x-large ran
    1.10 Â± 0.09 times faster than docker rmi -f localhost:5000/x-small &amp;&amp; docker pull localhost:5000/x-small
</code></pre>
<p>The only difference between the images is that one has 1000 small files, the other has 5 large files.</p>
<p>Given enough files (e.g. .pyc files, see #7696) this sort of thing does compound, especially in the cloud, where what might seem like a local disk really is not.</p>
<p><strong>EDIT:</strong> Another place where extra files really do hurt is e.g. distributed filesystems like Lustre. <a href="https://docs.lumi-supercomputer.eu/software/installing/python/#discouraged-installation-methods">LUMI, the fastest computer in Europe, advises against Python virtualenvs due to large-number-of-small-files.</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-02-11 22:31</div>
            <div class="timeline-body"><blockquote>
<p>The only difference between the images is that one has 1000 small files, the other has 5 large files.</p>
</blockquote>
<p>We&#x27;re not talking about a thousand small files here though, we&#x27;re talking about one lockfile per mutated Python environment â€” which as you note already have <em>many</em> small files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-04-16 15:23</div>
            <div class="timeline-body"><p>I think I&#x27;m going to bias towards keeping the guide simple for now unless we see more people that have problems here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/zanieb">@zanieb</a> on 2025-04-16 15:23</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:50:40 UTC
    </footer>
</body>
</html>
