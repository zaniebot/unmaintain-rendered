<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Don't destructure global network settings - astral-sh/uv #15105</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Don&#x27;t destructure global network settings</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/15105">#15105</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2025-08-06 11:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>From reviewing #14687, I was reminded that every base client construction requires manually destructuring the <code>NetworkSettings</code>. We can avoid that by passing the global network settings directly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/konstin">@konstin</a> on 2025-08-06 11:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-06 13:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/base_client.rs</code>:192 on 2025-08-06 13:11</div>
            <div class="timeline-body"><p>I feel like these might be used by downstream consumers, these client APIs are a pretty common touch point.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-06 13:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-requirements/src/upgrade.rs</code>:40 on 2025-08-06 13:11</div>
            <div class="timeline-body"><p>What does this mean?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-06 13:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/settings.rs</code>:161 on 2025-08-06 13:12</div>
            <div class="timeline-body"><p>Why does this go from being a method to a function?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-06 13:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/settings.rs</code>:161 on 2025-08-06 13:13</div>
            <div class="timeline-body"><p>Ah I see, because of the types. Hm..</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-06 13:14</div>
            <div class="timeline-body"><p>I&#x27;m not a huge fan of this honestly. I think it breaks the usual structure of our abstractions around settings, which is why it&#x27;s this way in the first place?</p>
<p>I think I&#x27;d rather just reduce the amount of times we construct a client builder? We should be able to do that ~once, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-08-06 14:54</div>
            <div class="timeline-body"><p>We construct three different kinds of base clients: Without keyring, with keyring and for the registry client. With the exception of the keyring, all builder methods are either network settings, or only used by the registry client (of which there are only two calls, that we could remove by moving from <code>RegistryClientBuilder::new</code> to <code>RegistryClientBuilder::try_from</code>) [^1].</p>
<p>The <code>NetworkSettings</code> struct is effectively the part that we can construct once and share across the codebase. We can construct a single <code>BaseClientBuilder</code> with it once and pass it around, but we do need to modify depending on whether we&#x27;re in a location that has and uses a keyring (which would be the PR two after this one). We can&#x27;t pass around a single instance of an (immutable) <code>BaseClient</code> alone without an option to control the keyring behavior.</p>
<p>[^1]: Ignoring <code>uv publish</code> here, which builds a custom client that has to ignore our common patterns already, due to being the only POST client, two reqwest bugs and having different auth.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/base_client.rs</code>:192 on 2025-08-06 14:55</div>
            <div class="timeline-body"><p>These are still accessible, the API moved to passing a <code>NetworkSettings</code> instance.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-08-06 14:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-08-06 14:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-requirements/src/upgrade.rs</code>:40 on 2025-08-06 14:58</div>
            <div class="timeline-body"><p>This is the one location that breaks our pattern because we&#x27;re actually reading from a file, not doing a network request so having a network client is odd, but I didn&#x27;t want to change <code>RequirementsTxt::parse</code> too</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-06 15:09</div>
            <div class="timeline-body"><p>I think it seems reasonable to have a single construction of <code>BaseClientBuilder</code> (minus some of the special cases above) that includes keyring then <em>remove</em> keyring in the places that shouldn&#x27;t use it for authentication? I don&#x27;t actually know why we wouldn&#x27;t use the keyring in some places, what&#x27;s the use-case for that?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-08-06 15:21</div>
            <div class="timeline-body"><p>I&#x27;m not sure about the keyring usage, I would return the question since your more familiar with the <code>KeyringProvider</code>.</p>
<p>One difference is that <code>NetworkSettings</code> (plus retries) are global CLI settings, while the keyring isn&#x27;t, so e.g. <code>uv python install</code> uses a client but no keyring. Being a global setting, we have the <code>NetworkSettings</code> for the single construction of <code>BaseClientBuilder</code>, but at that point we don&#x27;t have the keyring setting yet, we need to match over the CLI subcommand branches for that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/zanieb">@zanieb</a> on 2025-08-29 18:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:53:28 UTC
    </footer>
</body>
</html>
