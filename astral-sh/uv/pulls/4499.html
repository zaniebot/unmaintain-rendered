<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allow workspace members from sibling directories - astral-sh/uv #4499</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Allow workspace members from sibling directories</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/4499">#4499</a>
        opened by <a href="https://github.com/idlsoft">@idlsoft</a>
        on 2024-06-25 00:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/idlsoft">@idlsoft</a></div>
            <div class="timeline-body">

Summary
<p>Shared libraries for independent projects.</p>
<p>Let&#x27;s say I have the following layout:</p>
<pre><code>src_root
├── app1
├── app2
├── shared_lib
└── shared_corelib
</code></pre>
<p><code>app1</code> and <code>app2</code> never have to coexist in the same virtualenv, their dependencies are independent
and allowed to conflict with each other. <code>shared_lib</code> and <code>shared_corelib</code>, being libraries, have to play nice with both of them.</p>
<p>I want to use worskpaces to define the following direct dependencies:</p>
<ul>
<li><code>app1-&gt;shared_lib</code></li>
<li><code>app2-&gt;shared_lib</code></li>
<li><code>shared_lib-&gt;shared_corelib</code></li>
</ul>
<p>But if I simply create a workspace in <code>src_root</code> it&#x27;ll try to create a shared lock and shared virtualenv for all four projects.
And if I create a workspace in either <code>app1</code> or <code>app2</code>, they won&#x27;t let me include <code>shared_lib</code> because it&#x27;s in a sibling directory, and workspaces require a single root.</p>
<p>At my previous job I&#x27;ve implemented a build, that assumed this kind of scenario, and the workspace part was only responsible for locating members, and storing shared settings like default dependency versions, constraints, etc. This has the downside of having many virtualenvs so may not be for everyone, but I think it&#x27;s a valid case.</p>
<p>I don&#x27;t know if there are any future plans to support this in <code>uv</code>, perhaps by introducing the notion of a &quot;leaf&quot; member?</p>
<p>In the meantime, the scenario could be supported if workspaces were allowed to include sibling directories.
This is what this PR does.</p>
Test Plan


<p>Unit test</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-25 01:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/idlsoft">@idlsoft</a> on 2024-06-25 03:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/idlsoft">@idlsoft</a> on 2024-06-25 04:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/idlsoft">@idlsoft</a> on 2024-06-25 16:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-06-25 18:26</div>
            <div class="timeline-body"><p>The reason we&#x27;ve been enforcing that package need to be below the workspace root is for dependencies into other workspace. Say we have a workspace:</p>
<pre><code>A
|- B
|- C
</code></pre>
<p>and another</p>
<pre><code>D
|- E
|- F
</code></pre>
<p>and dependencies B -&gt; E and E -&gt; F. With our current design, E can say <code>F = { workspace = true }</code> and we can figure out the correct paths for B -&gt; E -&gt; F by walking up the tree. This feature is also supported by cargo.</p>
<p>For your use case, can you use a regular editable path dependency instead of a workspace?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/idlsoft">@idlsoft</a> on 2024-06-25 19:54</div>
            <div class="timeline-body"><blockquote>
<p>and dependencies B -&gt; E and E -&gt; F. With our current design, E can say <code>F = { workspace = true }</code> and we can figure out the correct paths for B -&gt; E -&gt; F by walking up the tree. This feature is also supported by cargo.</p>
</blockquote>
<p>In this example <code>B</code> would have to make sure that both <code>E</code> and <code>F</code> are included in its workspace definition.
cargo is a bit different, because it doesn&#x27;t have to create a shared virtualenv, and independent crates are allowed to have conflicting dependencies. You also can&#x27;t reference a library you don&#x27;t depend on, just because it happens to be in the same workspace.</p>
<p>I know this is not the most elegant solution.
Here is, I think, a nicer one:</p>
<p>There is a method in <a href="https://github.com/astral-sh/uv/blob/af1f1369e51191692ccace224393ad6fd20685aa/crates/uv-distribution/src/workspace.rs#L147"><code>workspace.rs</code></a>:</p>
<pre><code>pub fn with_current_project(self, package_name: PackageName) -&gt; Option&lt;ProjectWorkspace&gt; 
</code></pre>
<p>It could read the <code>pyproject.toml</code> of <code>package_name</code> and look for something like</p>
<pre><code>[tool.uv]
top-level = true
</code></pre>
<p>If that&#x27;s set it would filter out members that aren&#x27;t a direct or transitive dependency of <code>package_name</code>, and make <code>package_name</code> the workspace root, thus driving the location of <code>uv.lock</code>, <code>.venv</code>, overrides etc.</p>
<blockquote>
<p>For your use case, can you use a regular editable path dependency instead of a workspace?</p>
</blockquote>
<p>I tried that a while ago, but <code>uv</code> and <code>hatch</code> were fighting each other, and the only way I got it to work was with <a href="https://github.com/astral-sh/uv/pull/3949">this</a>, another bandaid.</p>
<p>I&#x27;m not a big fan of either of these PRs, ideally I&#x27;d like to see workspaces support independent members natively.
If what I described above doesn&#x27;t conflict with any ongoing work or future plans, I can try implementing it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/idlsoft">@idlsoft</a> on 2024-06-26 21:48</div>
            <div class="timeline-body"><blockquote>
<p>In this example <code>B</code> would have to make sure that both <code>E</code> and <code>F</code> are included in its workspace definition.</p>
</blockquote>
<p>After looking at the source a bit more I realize this isn&#x27;t quite right.
Projects need to be able to lookup for their workspaces.</p>
<p>I updated the sample workspace to allow dependencies between libraries.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-06-27 08:05</div>
            <div class="timeline-body"><p>I am aware of the current problems when trying to combine relative paths, PEP 621/pyproject.toml and a build backend, but i don&#x27;t think workspaces are the right tool to solve. Workspaces are intended for cases where there&#x27;s a single project consisting of multiple package, to give each package an individual dependency specification and - if wanted - configuration in pyproject.toml. They don&#x27;t work well as a tool for sharing a library between two applications.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/idlsoft">@idlsoft</a> on 2024-06-27 10:25</div>
            <div class="timeline-body"><blockquote>
<p>They don&#x27;t work well as a tool for sharing a library between two applications.</p>
</blockquote>
<p>That&#x27;s true, but I think with a few tweaks they could provide a clean solution for both.</p>
<p>This particular change is a few lines only, doesn&#x27;t break any existing code, and already makes the scenario possible.</p>
<p>I also opened  #4574, proposing a friendlier solution. It&#x27;ll require a bit more coding, but I don&#x27;t think it&#x27;s going to be too intrusive either.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/idlsoft">@idlsoft</a> on 2024-06-28 13:51</div>
            <div class="timeline-body"><p>The <a href="https://github.com/astral-sh/uv/pull/4610">new PR</a> provides explicit support for the use-case.
It&#x27;s a lot more straightforward from an end-user perspective, and interestingly didn&#x27;t require the change from <code>.strip_prefix</code> to <code>relative_to</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-06-28 14:30</div>
            <div class="timeline-body"><p>Currently it doesn&#x27;t break any existing code, but with <a href="https://github.com/astral-sh/uv/issues/3943">astral-sh/uv#3943</a> in place and people starting to have e.g. git dependencies into a package in a workspace, i&#x27;m afraid this change would cause some breakage.</p>
<p>If you could write-up an issue about your problems using hatch and uv together with relative path dependencies, i can have look and we can figure out a way to make this work. Starting off with a specific problem and discussing possible solutions and existing constraints we can much better solve your use case and avoid rejecting PRs that you&#x27;ve put effort into.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/idlsoft">@idlsoft</a> on 2024-06-28 15:40</div>
            <div class="timeline-body"><blockquote>
<p>with #3943 in place and people starting to have e.g. git dependencies into a package in a workspace, i&#x27;m afraid this change would cause some breakage.</p>
</blockquote>
<p>I believe this PR kinda close the 1st bullet point from #3943, while <a href="https://github.com/astral-sh/uv/pull/4610">astral-sh/uv#4610</a> addresses the same underlying issue differently, within a single workspace, with no extra toml to write.</p>
<blockquote>
<p>If you could write-up an issue about your problems using hatch and uv together with relative path dependencies, i can have look and we can figure out a way to make this work.</p>
</blockquote>
<p>I&#x27;ll try to come up with an example. But from what I remember, it was something like</p>
<ul>
<li><code>uv</code> doesn&#x27;t allow <code>lib @ ../lib</code> and didn&#x27;t like <code>{root:uri}</code>, but supports <code>${PROJECT_ROOT}</code></li>
<li><code>hatch</code> doesn&#x27;t like <code>${PROJECT_ROOT}</code> but is happy with <code>lib @ ../lib</code> and its own <code>{root:uri}</code></li>
</ul>
<blockquote>
<p>Starting off with a specific problem and discussing possible solutions and existing constraints we can much better solve your use case and avoid rejecting PRs that you&#x27;ve put effort into.</p>
</blockquote>
<p>I don&#x27;t mean to overwhelm you with PRs, but figuring out a solution is fun regardless of whether it gets merged or not.</p>
<p>The problem I&#x27;m trying to solve is described in <a href="https://github.com/astral-sh/uv/issues/4574">astral-sh/uv#4574</a>.
Multiple apps, using multiple libraries directly, as editable dependencies, coexisting even if their dependencies aren&#x27;t compatible.
I believe workspaces can provide an elegant way of solving it, and it&#x27;ll look familiar to anyone who&#x27;s ever used cargo, or gradle.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/idlsoft">@idlsoft</a> on 2024-07-18 20:49</div>
            <div class="timeline-body"><p>The use-case is supported using</p>
<pre><code>[tool.uv.sources]
shared_lib = { path = &quot;../shared_lib&quot;, editable = true}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/idlsoft">@idlsoft</a> on 2024-07-18 20:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:46:06 UTC
    </footer>
</body>
</html>
