<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Require `uv venv --clear` before removing an existing directory - astral-sh/uv #14309</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Require <code>uv venv --clear</code> before removing an existing directory</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/14309">#14309</a>
        opened by <a href="https://github.com/jtfmumm">@jtfmumm</a>
        on 2025-06-27 10:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a></div>
            <div class="timeline-body"><p>By default, <code>uv venv &lt;venv-name&gt;</code> currently removes the <code>&lt;venv-name</code>&gt; directory if it exists. This can be surprising behavior: not everyone expects an existing environment to be overwritten. This PR updates the default to fail if a non-empty <code>&lt;venv-name&gt;</code> directory already exists and neither <code>--allow-existing</code> nor the new <code>-c/--clear</code> option is provided (if a TTY is detected, it prompts first). If it's not a TTY, then uv will only warn and not fail for now â€” we'll make this an error in the future. I've also added a corresponding <code>UV_VENV_CLEAR</code> env var.</p>
<p>I've chosen to use <code>--clear</code> instead of <code>--force</code> for this option because it is used by the <code>venv</code> module and <code>virtualenv</code> and will be familiar to users. I also think its meaning is clearer in this context than <code>--force</code> (which could plausibly mean force overwrite just the virtual environment files, which is what our current <code>--allow-existing</code> option does).</p>
<p>Closes #1472.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">virtualenv</span> added by @jtfmumm on 2025-06-27 10:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">breaking</span> added by @jtfmumm on 2025-06-27 10:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">do-not-merge</span> added by @jtfmumm on 2025-06-27 10:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v0.8.0" by @jtfmumm on 2025-07-03 06:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">do-not-merge</span> removed by @jtfmumm on 2025-07-03 06:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-03 17:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.github/workflows/ci.yml</code>:1045 on 2025-07-03 17:34</div>
            <div class="timeline-body"><p>This is a good example of the breakage we'd cause with this change. I wonder if we can craft a GitHub search that captures if a second <code>uv venv</code> is common?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-14 14:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-cli/src/lib.rs</code>:2614 on 2025-07-14 14:28</div>
            <div class="timeline-body"><p>Why does this conflict with <code>allow_existing</code> rather than override?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-14 14:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-static/src/env_vars.rs</code>:295 on 2025-07-14 14:28</div>
            <div class="timeline-body"><p>This seems a bit off for the top-level line in this context?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-14 14:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-static/src/env_vars.rs</code>:295 on 2025-07-14 14:29</div>
            <div class="timeline-body"><p>For reference, other flag variables have documentation like</p>
<pre><code>    /// Equivalent to the `--no-verify-hashes` argument. Disables hash verification for
    /// `requirements.txt` files.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:96 on 2025-07-14 14:30</div>
            <div class="timeline-body"><p>Can we use a <code>match</code> here instead so we have to handle new variants if they're added?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-14 14:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-14 14:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:122 on 2025-07-14 14:32</div>
            <div class="timeline-body"><p>We use <code>stdin().is_terminal()</code> elsewhere, is there a reason you preferred this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-14 14:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:122 on 2025-07-14 14:33</div>
            <div class="timeline-body"><p>Interesting, I did a search here and we use <code>stderr().is_term()</code> in quite a few places. I don't know which is correct, but we should have a consistent approach. We can discuss that separately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-14 14:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:122 on 2025-07-14 14:34</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/uv/issues/14607</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-cli/src/lib.rs</code>:2614 on 2025-07-14 14:34</div>
            <div class="timeline-body"><p>I was being conservative. I think we'd want <code>--allow-existing</code> to override if we took that approach? The presence of the flag might indicate they expect those files to be retained</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-07-14 14:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:123 on 2025-07-14 14:36</div>
            <div class="timeline-body"><p>It's a little weird that this is separated from the confirmation prompt, it makes it hard to tell what the logic is. Could it be restructured to be clearer?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-14 14:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:122 on 2025-07-14 14:36</div>
            <div class="timeline-body"><p>I think this way is actually more common in the codebase. I was imitating the way it was done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-07-14 14:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-14 14:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:141 on 2025-07-14 14:37</div>
            <div class="timeline-body"><p>I probably wouldn't mention <code>--allow-existing</code>, it's kind of a niche use-case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-14 14:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:138 on 2025-07-14 14:37</div>
            <div class="timeline-body"><p>At this point, do we know that the directory is a virtual environment?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-07-14 14:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:122 on 2025-07-14 14:37</div>
            <div class="timeline-body"><p>But I don't have a reason to prefer one or the other</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-14 14:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/lib.rs</code>:1036 on 2025-07-14 14:38</div>
            <div class="timeline-body"><p>Could this be a <code>VenvCreationPolicy::from_args</code> method to match other constructors?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-14 14:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/it/venv.rs</code>:34 on 2025-07-14 14:38</div>
            <div class="timeline-body"><p>This comment is stale</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-14 14:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-cli/src/lib.rs</code>:2614 on 2025-07-14 14:39</div>
            <div class="timeline-body"><p>I think you'd probably just have them both override each other?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-07-14 14:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:138 on 2025-07-14 14:43</div>
            <div class="timeline-body"><p>We should be able to check it by this point</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-14 14:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:138 on 2025-07-14 14:46</div>
            <div class="timeline-body"><p>In that case, I think we can craft a bit more specific of a message. e.g., I'd say</p>
<blockquote>
<p>A virtual environment already exists at <code>{}</code>. In the future, ...</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-07-14 14:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-static/src/env_vars.rs</code>:295 on 2025-07-14 14:49</div>
            <div class="timeline-body"><p>I was attempting to parallel the <code>--allow-existing</code> top line, which is</p>
<pre><code>/// Preserve any existing files or directories at the target path.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-14 14:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-static/src/env_vars.rs</code>:295 on 2025-07-14 14:50</div>
            <div class="timeline-body"><p>This is a comment on the environment variable reference.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-static/src/env_vars.rs</code>:295 on 2025-07-14 14:51</div>
            <div class="timeline-body"><p>(It's fine as-is for the <code>--clear</code> flag)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-14 14:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-static/src/env_vars.rs</code>:295 on 2025-07-14 14:52</div>
            <div class="timeline-body"><p>Ah, on that one I was paralleling <code>UV_VENV_SEED</code>:</p>
<pre><code>/// Install seed packages (one or more of: `pip`, `setuptools`, and `wheel`) into the virtual environment
/// created by `uv venv`.
</code></pre>
<p>I'll update</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-07-14 14:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-14 14:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-static/src/env_vars.rs</code>:295 on 2025-07-14 14:54</div>
            <div class="timeline-body"><p>I don't mind that style either.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-07-14 14:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-cli/src/lib.rs</code>:2614 on 2025-07-14 14:58</div>
            <div class="timeline-body"><p>Given that the motivation for this is to avoid surprising people when removing the directory, I'm a little hesitant to have <code>--clear</code> override in the last position. But on the other hand, you did mark it with <code>--clear</code>. If you still think it's ok, I can update</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-14 15:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-cli/src/lib.rs</code>:2614 on 2025-07-14 15:09</div>
            <div class="timeline-body"><p>Yeah I think since it's opt-in that should be fine. It's valuable for something like <code>UV_VENV_CLEAR=1 uv venv --allow-existing</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:138 on 2025-07-14 15:29</div>
            <div class="timeline-body"><p>Updated</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-07-14 15:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-14 15:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:96 on 2025-07-14 15:34</div>
            <div class="timeline-body"><p>I mean in this area overall. It may require a bit more restructuring?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:96 on 2025-07-14 16:02</div>
            <div class="timeline-body"><p>I think I've figured it out. Pushing soon</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-07-14 16:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-07-14 16:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:96 on 2025-07-14 16:11</div>
            <div class="timeline-body"><p>I've restructured it into a match, which also addresses your concern below</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-07-14 16:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-virtualenv/src/virtualenv.rs</code>:123 on 2025-07-14 16:11</div>
            <div class="timeline-body"><p>Addressed by restructuring</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-07-14 16:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-cli/src/lib.rs</code>:2614 on 2025-07-14 16:11</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Require `uv venv --clear` before clearing an existing directory" to "Require `uv venv --clear` before removing an existing directory" by @zanieb on 2025-07-16 19:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2025-07-16 19:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-07-16 19:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-16 19:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:43:46 UTC
    </footer>
</body>
</html>
