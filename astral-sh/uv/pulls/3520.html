<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parse marker tree before evaluation - astral-sh/uv #3520</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Parse marker tree before evaluation</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/3520">#3520</a>
        opened by <a href="https://github.com/ibraheemdev">@ibraheemdev</a>
        on 2024-05-10 22:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Parse <code>MarkerTree</code> expressions upfront, instead of lazily during evaluation.</p>
<p>This makes implementing https://github.com/astral-sh/uv/issues/3355 a lot easier.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "parse marker tree before evaluation" to "Parse marker tree before evaluation" by @ibraheemdev on 2024-05-13 19:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ibraheemdev on 2024-05-13 19:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @ibraheemdev on 2024-05-13 19:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @ibraheemdev on 2024-05-13 19:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-05-13 19:36</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/uv/branches/ibraheemdev:marker-tree-parsing">CodSpeed Performance Report</a></h2>
<h3>Merging #3520 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>ibraheemdev:marker-tree-parsing</code> (00c900e) with <code>main</code> (732410f)</sub></p>
<h3>Summary</h3>
<p><code>âœ… 12</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/pep508-rs/src/marker.rs</code>:912 on 2024-05-13 19:36</div>
            <div class="timeline-body"><p>Can anyone think of a better way to represent these inverted variants?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/pep508-rs/src/marker.rs</code>:931 on 2024-05-13 19:38</div>
            <div class="timeline-body"><p>Do we need an inverted variant here? Without it the parser becomes lossy and won't preserve the ordering after parsing (which might be useful for reconstructing the input using <code>Display</code>), but for our use case it's unnecessary.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2024-05-13 19:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-13 23:32</div>
            <div class="timeline-body"><p>@ibraheemdev - do you need help debugging the regression?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-05-14 01:08</div>
            <div class="timeline-body"><p>@charliermarsh I think it's that the <code>Display</code> implementation was accidentally changed to not have quotes around some marker values, so the items are not being found in cache. I'll fix that and add tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-14 01:16</div>
            <div class="timeline-body"><p>I don't think markers should affect caching, but maybe the evaluation is changing and so we're including more deps?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/pep508-rs/src/marker.rs</code>:931 on 2024-05-14 10:45</div>
            <div class="timeline-body"><p>Fine by me</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-05-14 10:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/pep508-rs/src/marker.rs</code>:937 on 2024-05-14 10:46</div>
            <div class="timeline-body"><p>Aren't they always false?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/pep508-rs/src/marker.rs</code>:1168 on 2024-05-14 10:58</div>
            <div class="timeline-body"><p>Needs manual indent (rustfmt gave up because the string is too long)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/pep508-rs/src/marker.rs</code>:1220 on 2024-05-14 10:59</div>
            <div class="timeline-body"><p>Needs manual indent</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/pep508-rs/src/marker.rs</code>:1295 on 2024-05-14 11:04</div>
            <div class="timeline-body"><p>The option thing feels odd (why are we evaluating markers against an environment when there is no environment?), can you do a <code>let Some(env) = env else { return false; }</code> or something like it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-05-14 11:12</div>
            <div class="timeline-body"><p>I like this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/pep508-rs/src/marker.rs</code>:912 on 2024-05-14 11:55</div>
            <div class="timeline-body"><p>I like this personally. There's a fundamental asymmetry here, so this representation makes sense to me I think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/pep508-rs/src/marker.rs</code>:1168 on 2024-05-14 11:57</div>
            <div class="timeline-body"><p>I would split the string across multiple lines. It's a win-win: rustfmt will format it and you won't have a long line that is harder to read when your editor auto-wraps it. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/pep508-rs/src/marker.rs</code>:1295 on 2024-05-14 12:01</div>
            <div class="timeline-body"><p>I added the <code>Option</code> in an older PR. If there's no environment, we specifically want all environment marker expressions to evaluate to <code>true</code>. But we still evaluate marker expressions involving extras.</p>
<p>This has the effect of evaluating a marker expression in an environment independent way. But since you still need to evaluate extras, you can't just do <code>return true</code> when <code>env</code> is <code>None</code> at the top here. But maybe it could be put at the top of some of the branches to simplify things a little.</p>
<p>It's an odd thing about PEP 508. Everything about marker expressions is tied to the environment <em>except</em> for extras.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2024-05-14 12:04</div>
            <div class="timeline-body"><p>LGTM assuming we track down the regression. Nice refactor.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-05-14 14:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/pep508-rs/src/marker.rs</code>:1295 on 2024-05-14 14:37</div>
            <div class="timeline-body"><p>This is a discussion beyond this PR, but i've been thinking about turning <code>MarkerEnvironment</code> from a dataclass into something more general, e.g. a trait where you can query a value or an expression in and the env can decides which fraction of the fields to evaluate. This would unify the cases for python version, markers and full environment behind a shared interface.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2024-05-14 14:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/pep508-rs/src/marker.rs</code>:937 on 2024-05-14 14:38</div>
            <div class="timeline-body"><p>Yeah, updated the docs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-05-14 15:02</div>
            <div class="timeline-body"><p>Looks like fixing the <code>Display</code> implementation fixed the regression, not exactly sure why.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ibraheemdev on 2024-05-14 15:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ibraheemdev on 2024-05-14 15:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-05-14 15:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/pep508-rs/src/marker.rs</code>:1295 on 2024-05-14 15:02</div>
            <div class="timeline-body"><p>I was thinking about something like that too, but the full shape of what it should look like wasn't totally clear to me. What was driving that thought is that I'm not a fan of spreading <code>Option&lt;&amp;MarkerEnvironment&gt;</code> everywhere, and I would rather encapsulate that case analysis instead of pushing it out to everyone else.</p>
<p>So... yeah I'm on board with your idea. :-)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:36:59 UTC
    </footer>
</body>
</html>
