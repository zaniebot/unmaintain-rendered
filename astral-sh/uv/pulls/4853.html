<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refactor `fetch-download-metadata.py` script - astral-sh/uv #4853</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Refactor <code>fetch-download-metadata.py</code> script</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/4853">#4853</a>
        opened by <a href="https://github.com/j178">@j178</a>
        on 2024-07-07 07:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/j178">@j178</a> on 2024-07-07 07:10</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Similiar to https://github.com/astral-sh/rye/pull/680, I have made a major refactor to the <code>fetch-download-metadata.py</code> script.</p>
<p>Some notable changes:</p>
<ul>
<li>Use PEP 723 inline scripts</li>
<li>Fully type annotated the script</li>
<li>Implemented async HTTP fetching</li>
<li>Introduced a <code>Finder</code> base class and move finder logic under <code>CPythonFinder</code> subclass, which will make it easier to add a <code>PyPyFinder</code> later.</li>
<li>Instead of fetching <code>xxx.sha256</code> for each file, the script now fetches a single <code>SHA256SUMS</code> file containing checksums for all files in the release.</li>
</ul>
<p>As a result, the script now takes around 10 seconds instead of 10+ minutes.</p>
<h2>Plan for Future PRs</h2>
<ul>
<li>[ ] Implement the <code>PyPyFinder</code></li>
<li>[ ] Add an GitHub Action to run <code>fetch-download-metadata.py</code> daily and create PR automatically</li>
</ul>
<h2>Test Plan</h2>
<pre><code class="language-sh">cargo run -- run --isolated -- ./crates/uv-python/fetch-download-metadata.py
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/j178">@j178</a> on <code>crates/uv-python/template-download-metadata.py</code>:73 on 2024-07-07 07:11</div>
            <div class="timeline-body"><p>Use <code>as_posix()</code> to make separator consistent across platforms.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/j178">@j178</a> on <code>crates/uv-python/fetch-download-metadata.py</code>:114 on 2024-07-07 07:14</div>
            <div class="timeline-body"><p>Our current metadata includes <code>debug</code> flavors actually. I need to move it from <code>HIDDEN_FLAVORS</code> to keep the <code>download-metadata.json</code> file unchanged.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/j178">@j178</a> reviewed on 2024-07-07 07:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @j178 on 2024-07-07 07:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @konstin on 2024-07-07 09:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-07-07 16:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/fetch-download-metadata.py</code>:365 on 2024-07-07 16:38</div>
            <div class="timeline-body"><p>We did not previously require a token and it is not required to make the number of requests we need, can we just warn here instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/fetch-download-metadata.py</code>:73 on 2024-07-07 16:40</div>
            <div class="timeline-body"><p>This feels a little weird. Is this actually the easiest way to reverse the versions?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-07-07 16:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-07 16:45</div>
            <div class="timeline-body"><p>Thanks for taking this on! I appreciate the PEP 723 changes and the improved speed.</p>
<p>I'm a little hesitant, there are a lot of changes here and not all of them are clearly motivated, e.g., we're not operating at a scale asyncio is superior to threads, we've previously gone out of our way to only use the standard library, and I'm not sure why a single file is preferable for the checksums. Do you have some thoughts on those?</p>
<p>If we're going to aim for full type coverage, we should probably follow this by adding type checking in CI too otherwise it seems too easy for it to become out of date.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @zanieb on 2024-07-07 16:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/j178">@j178</a> on 2024-07-13 05:32</div>
            <div class="timeline-body"><p>Thanks for your input! Sorry for the late reply (I had a really busy week, and haven't got time to write a full reply)</p>
<p><code>asyncio</code> and <code>httpx</code> are used to make writing concurrent code easier. I don't see any major drawbacks to using them for a helper script. <code>httpx</code> is commonly used for HTTP requests, almost like a standard library, and it's lightweight. Additionally, <code>template-download-metadata.py</code> also depends on <code>chevron_blue</code>. If you really don't like them, I can consider rewriting it using only the standard library.</p>
<blockquote>
<p>why a single file is preferable for the checksums</p>
</blockquote>
<p>Consider <a href="https://github.com/indygreg/python-build-standalone/releases/tag/20240415">the latest indygreg/python-build-standalone release</a>. Previously, we had to fetch 51 separate checksum files for 51 installations. Now, all checksums are combined into one file, reducing it to a single request. This is where the major speed improvement comes from.</p>
<blockquote>
<p>we should probably follow this by adding type checking in CI</p>
</blockquote>
<p>That's a great suggestion. I'll explore how to add type checking for this single file. Would it be possible to incorporate it in a subsequent PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-13 15:26</div>
            <div class="timeline-body"><blockquote>
<p>If you really don't like them, I can consider rewriting it using only the standard library.</p>
</blockquote>
<p>It's not about liking them really ‚Äî I am a httpx maintainer and a big user of async Python ‚Äî it just feels like unnecessary complexity for this task. I'm just trying to avoid maintaining additional complexity.  It doesn't necessarily feel worth tearing out now, but in the future it'd be nice to separate such changes so we can weigh them on their merits i.e. is there a meaningful performance improvement from async here or is it all from sending way less requests to retrieve checksums.</p>
<blockquote>
<p>Now, all checksums are combined into one file, reducing it to a single request. This is where the major speed improvement comes from.</p>
</blockquote>
<p>Ah I see, I misunderstood you comment. This makes a lot of sense to me.</p>
<blockquote>
<p>Would it be possible to incorporate it in a subsequent PR?</p>
</blockquote>
<p>Yes definitely.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-13 15:27</div>
            <div class="timeline-body"><p>I'll read through the code more closely soon.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/j178">@j178</a> on 2024-07-16 16:17</div>
            <div class="timeline-body"><p>Just a gentle reminder, could you please take a look at this and let me know if we can proceed? @zanieb</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-22 14:29</div>
            <div class="timeline-body"><p>Yes I'll give this a look and merge today. It's really hard to review pull requests that make so many changes at once like this. In the future, please separate things into separate pull requests e.g. one that adds types but doesn't change the requests being made so we can review things incrementally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/j178">@j178</a> on 2024-07-22 15:20</div>
            <div class="timeline-body"><p>Truely sorry for the inconvenience and thank you for your patience ‚ù§Ô∏è</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/eth3lbert">@eth3lbert</a> on <code>crates/uv-python/fetch-download-metadata.py</code>:170 on 2024-07-22 23:32</div>
            <div class="timeline-body"><p>I would consider <code>pages</code> as the page size. However, if <code>pages</code> equals 1, this would actually result in a size of 0 (since <code>range(1, 1)</code>), which seems odd to me.</p>
<pre><code class="language-suggestion">        for page in range(1, pages + 1):
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/eth3lbert">@eth3lbert</a> on <code>crates/uv-python/fetch-download-metadata.py</code>:190 on 2024-07-23 00:00</div>
            <div class="timeline-body"><p>I understand that this PR doesn't modify the code block, but since it's a refactoring PR, I've included some comments for review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/eth3lbert">@eth3lbert</a> on <code>crates/uv-python/fetch-download-metadata.py</code>:190 on 2024-07-23 00:01</div>
            <div class="timeline-body"><p>There's a diagnostic error:</p>
<pre><code>1. Pylance: Argument of type &quot;str | None&quot; cannot be assigned to parameter &quot;flavor&quot; of type &quot;str&quot; in function &quot;_get_flavor_priority&quot;
   ¬†¬†Type &quot;str | None&quot; cannot be assigned to type &quot;str&quot;
   ¬†¬†¬†¬†&quot;None&quot; is incompatible with &quot;str&quot; [reportArgumentType] [reportArgumentType]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/eth3lbert">@eth3lbert</a> on <code>crates/uv-python/fetch-download-metadata.py</code>:197 on 2024-07-23 00:16</div>
            <div class="timeline-body"><p>If I understand correctly, based on the comparison <code>if priority &gt;= existing_priority</code> and the variable names, it seems more likely to be the opposite of the comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/eth3lbert">@eth3lbert</a> on <code>crates/uv-python/fetch-download-metadata.py</code>:197 on 2024-07-23 00:17</div>
            <div class="timeline-body"><p>Since we're already leveraging <code>NamedTuple</code> extensively in this PR, we might consider refactoring this out</p>
<pre><code class="language-python">if existing and priority &gt;= existing.priority:
</code></pre>
<p>or simply using:</p>
<pre><code class="language-python">if existing and priority &gt;= existing[1]:
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/eth3lbert">@eth3lbert</a> on <code>crates/uv-python/fetch-download-metadata.py</code>:253 on 2024-07-23 00:34</div>
            <div class="timeline-body"><p>Is there a specific reason for checking the <code>.sha256</code> extension after constructing the <code>filename</code>, rather than simply checking the <code>url</code> before construction? Is it a matter of readability?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/eth3lbert">@eth3lbert</a> on <code>crates/uv-python/fetch-download-metadata.py</code>:332 on 2024-07-23 02:08</div>
            <div class="timeline-body"><p>Is there a specific reason why we use <code>index</code> to maintain the order here, instead of relying solely on the lexical order of the <code>download.implementation</code> (<code>cpython</code> followed by <code>pypy</code>) which is our expected order?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/eth3lbert">@eth3lbert</a> reviewed on 2024-07-23 02:18</div>
            <div class="timeline-body"><p>None of my comments are blockers üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-07-23 02:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/fetch-download-metadata.py</code>:332 on 2024-07-23 02:30</div>
            <div class="timeline-body"><p>I do think we want CPython to come before PyPy regardless of lexical ordering.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/j178">@j178</a> on <code>crates/uv-python/fetch-download-metadata.py</code>:197 on 2024-07-23 02:46</div>
            <div class="timeline-body"><blockquote>
<p>If I understand correctly, based on the comparison if priority &gt;= existing_priority and the variable names, it seems more likely to be the opposite of the comment.</p>
</blockquote>
<p>I think a smaller value indicates a higher priority.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/j178">@j178</a> reviewed on 2024-07-23 02:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-07-23 03:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-07-23 03:00</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/eth3lbert">@eth3lbert</a> reviewed on 2024-07-23 03:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/eth3lbert">@eth3lbert</a> on <code>crates/uv-python/fetch-download-metadata.py</code>:197 on 2024-07-23 03:04</div>
            <div class="timeline-body"><p>Indeed, I overlooked the doc in <code>_get_flavor_priority</code> for no reason üòÖ .</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2024-07-23 03:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-07-23 03:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-23 12:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 13:37:38 UTC
    </footer>
</body>
</html>
