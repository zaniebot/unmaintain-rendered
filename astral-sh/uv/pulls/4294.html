<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add persistent configuration for non-`pip` APIs - astral-sh/uv #4294</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add persistent configuration for non-<code>pip</code> APIs</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/4294">#4294</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-06-13 01:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>This PR introduces top-level configuration for uv, such that you can do:</p>
<pre><code>[tool.uv]
index-url = &quot;https://test.pypi.org/simple&quot;
</code></pre>
<p>And <code>uv pip compile</code>, <code>uv run</code>, <code>uv tool run</code>, etc., will all respect that configuration.</p>
<p>The settings that were escalated to the top-level remain on <code>tool.uv.pip</code> too, but they&#x27;re only respected in <code>uv pip</code> commands. If they&#x27;re specified in both places, then the <code>pip</code> settings win out.</p>
<p>While making this change, I also wired up some of the global options, like <code>connectivity</code> and <code>native_tls</code>, through to all the relevant places.</p>
<p>Closes #4250.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-13 01:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-13 01:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-13 01:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-13 01:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-workspace/src/settings.rs</code>:68 on 2024-06-13 01:17</div>
            <div class="timeline-body"><p>I used the following terminology:</p>
<ul>
<li>&quot;Compile&quot; or &quot;Compiler&quot; for something that <em>just</em> does resolution.</li>
<li>&quot;Sync&quot; or &quot;Syncer&quot; for something that <em>just</em> does installation (from an existing resolution).</li>
<li>&quot;Install&quot; or &quot;Installer&quot; for something that does both resolution and installer.</li>
</ul>
<p>In <code>cli.r</code>, the <code>CompilerArgs</code> are used for (e.g.) <code>uv pip compile</code> and <code>uv lock</code>. The <code>SyncerArgs</code> are used for (e.g.) <code>uv pip sync</code> and <code>uv sync</code>. The <code>InstallerArgs</code> are used for <code>uv pip install</code> and <code>uv run</code> and <code>uv tool run</code>.</p>
<p>Internally, the Project and Tool APIs just take <code>InstallerSettings</code>, so the commands get some settings they don&#x27;t need. But it was a bit easier that way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-13 01:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/tests/pip_compile.rs</code>:9471 on 2024-06-13 01:26</div>
            <div class="timeline-body"><p>Not really ideal, I think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-13 13:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-workspace/src/settings.rs</code>:68 on 2024-06-13 13:58</div>
            <div class="timeline-body"><p>I find it really weird that &quot;Installer&quot; isn&#x27;t the thing that does <em>just</em> installation. What about:</p>
<ul>
<li>&quot;Resolver&quot;: <em>just</em> does resolution</li>
<li>&quot;Installer&quot;: <em>just</em> does installation</li>
<li>&quot;Complete&quot;: for both</li>
</ul>
<p>Really not sure about the third name but the other two are way more obvious?</p>
<p>As mentioned offline I also kind of like &quot;Resolution&quot; and &quot;Installation&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-13 13:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-workspace/src/settings.rs</code>:68 on 2024-06-13 13:59</div>
            <div class="timeline-body"><p>I see the benefit of matching the command names, but I&#x27;m not sure it&#x27;s quite worth it i.e. it falls apart with <code>uv run</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-13 14:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-workspace/src/settings.rs</code>:68 on 2024-06-13 14:00</div>
            <div class="timeline-body"><p>I don&#x27;t disagree but that&#x27;s inconsistent with the <code>pip</code> API... The third name is what makes things really hard. I also considered <code>Operation</code> or something.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-13 14:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/mod.rs</code>:287 on 2024-06-13 14:03</div>
            <div class="timeline-body"><p>Separate, but I wonder if we should have a <code>Settings::as_client_builder</code> or <code>BaseClientBuilder::from_settings</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-13 14:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/mod.rs</code>:333 on 2024-06-13 14:04</div>
            <div class="timeline-body"><p>Just so it&#x27;s on your mind as well as mine, I feel like <code>RegistryClientBuilder</code> should take a <code>BaseClientBuilder</code> instead of duplicating the global options? I found this awkward in some places where I needed to construct both types.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-13 14:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:124 on 2024-06-13 14:05</div>
            <div class="timeline-body"><p>Are we going to use some of these in the future?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-13 14:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/settings.rs</code>:1424 on 2024-06-13 14:08</div>
            <div class="timeline-body"><p>It feels a little weird that we do this conversion. Like... what if the method consuming <code>InstallerOptions</code> intends to respect what the user specified for a non-syncer option?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-13 14:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:124 on 2024-06-13 14:09</div>
            <div class="timeline-body"><p>No, but I think we should be forced to think about it if we add new settings.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-13 14:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/settings.rs</code>:1424 on 2024-06-13 14:09</div>
            <div class="timeline-body"><p>This is fixable but will require a few hundred more lines of boilerplate, probably.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-13 14:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/pip_compile.rs</code>:9471 on 2024-06-13 14:10</div>
            <div class="timeline-body"><p>It&#x27;s a little awkward but at least it&#x27;s consistent, maybe we should warn in that case? Are we going to have more complex merging rules for the pip namespace from the user-level config?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-13 14:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-workspace/src/settings.rs</code>:68 on 2024-06-13 14:11</div>
            <div class="timeline-body"><p>I&#x27;d rather focus on internal consistency than consistency with the <code>pip</code> command names, I think.</p>
<p>Aren&#x27;t you often taking the resolution and installation options and constructing the third &quot;full&quot; options from them anyway?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-13 14:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/settings.rs</code>:1424 on 2024-06-13 14:12</div>
            <div class="timeline-body"><p>I will fix it. It requires that we change (e.g.) <code>pip sync</code> to take a new <code>SyncerSettings</code> instead of <code>InstallerSettings</code>, so we need corresponding structs for <code>Syncer</code> and <code>Compiler</code> (I know, we&#x27;ll rename those). And then we need conversion methods.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:124 on 2024-06-13 14:12</div>
            <div class="timeline-body"><p>I feel like a lot of these actually apply though? Like don&#x27;t we care about the index locations and strategy here? e.g. if we need to install a requested package</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-13 14:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-13 14:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/settings.rs</code>:1424 on 2024-06-13 14:14</div>
            <div class="timeline-body"><p>Okay. I&#x27;m not saying it <em>has</em> to change but it does seem like a possible footgun.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-13 14:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:124 on 2024-06-13 14:14</div>
            <div class="timeline-body"><p>Where? This is just for <code>Toolchain::find_or_fetch</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-13 14:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:124 on 2024-06-13 14:15</div>
            <div class="timeline-body"><p>We could omit <code>keyring_provider</code> entirely if you want, since we know the URLs that will be fetched here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-13 14:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-workspace/src/settings.rs</code>:68 on 2024-06-13 14:16</div>
            <div class="timeline-body"><blockquote>
<p>Aren&#x27;t you often taking the resolution and installation options and constructing the third &quot;full&quot; options from them anyway?</p>
</blockquote>
<p>I think that&#x27;s going to disappear though based on <a href="https://github.com/astral-sh/uv/pull/4294">astral-sh/uv#4294</a>#discussion_r1638293555.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-13 14:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:124 on 2024-06-13 14:16</div>
            <div class="timeline-body"><p>Oh sorry I didn&#x27;t realize that was the context. I wouldn&#x27;t use the keyring for <code>find_or_fetch</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-13 14:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:124 on 2024-06-13 14:17</div>
            <div class="timeline-body"><p>Thanks for clarifying.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-13 14:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-workspace/src/settings.rs</code>:68 on 2024-06-13 14:17</div>
            <div class="timeline-body"><p>I&#x27;ll do whatever. I can just run with &quot;Complete&quot; for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-13 14:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/run.rs</code>:124 on 2024-06-13 14:18</div>
            <div class="timeline-body"><p>Kk will remove!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-13 14:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/settings.rs</code>:1424 on 2024-06-13 14:18</div>
            <div class="timeline-body"><p>I think it&#x27;s &quot;correct&quot; to split them out into dedicated types, it&#x27;s just so much boilerplate. But it is correct.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-13 14:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-workspace/src/settings.rs</code>:68 on 2024-06-13 14:18</div>
            <div class="timeline-body"><p>I&#x27;m guessing there&#x27;s a lot of overlap between installation and resolution and we shouldn&#x27;t just do <code>Third(InstallationOptions, ResolutionOptions)</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-06-13 14:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-workspace/src/settings.rs</code>:68 on 2024-06-13 14:19</div>
            <div class="timeline-body"><p>If only there was an obvious third name.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-13 14:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-workspace/src/settings.rs</code>:68 on 2024-06-13 14:22</div>
            <div class="timeline-body"><p>Yeah they mostly overlap but critically there are a few options that don&#x27;t make sense for one vs. the other and I think exposing them on the CLI would be bad (like <code>uv lock</code> shouldn&#x27;t have <code>--compile-bytecode</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-13 14:59</div>
            <div class="timeline-body"><p>@zanieb - Are you cool with this modulo (1) renaming, and (2) removing the <code>From&lt;SyncerArgs&gt; for InstallerOptions</code> impls?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-13 15:25</div>
            <div class="timeline-body"><blockquote>
<p>@zanieb - Are you cool with this modulo (1) renaming, and (2) removing the <code>From&lt;SyncerArgs&gt; for InstallerOptions</code> impls?</p>
</blockquote>
<p>I think so! It seems pretty reasonable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-13 18:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-workspace/src/settings.rs</code>:68 on 2024-06-13 18:51</div>
            <div class="timeline-body"><p>Ok, I changed it to <code>Installer</code>, <code>Resolver</code>, and <code>Complete</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-13 18:58</div>
            <div class="timeline-body"><p>Okay, I believe I addressed the biggest feedback. I&#x27;m saddened by how much boilerplate will be required to add a new setting in the future. Perhaps we can DRY a lot of this up with macros in the future, but it&#x27;s not my strength.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-06-13 22:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/mod.rs</code>:333 on 2024-06-13 22:56</div>
            <div class="timeline-body"><p>Makes sense, I can look at it at some point.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-06-14 00:31</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-14 00:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-14 00:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-06-14 00:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:45:54 UTC
    </footer>
</body>
</html>
