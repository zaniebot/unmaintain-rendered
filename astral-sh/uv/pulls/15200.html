<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add incompatibility from proxy to base package - astral-sh/uv #15200</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add incompatibility from proxy to base package</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/15200">#15200</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2025-08-10 11:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>Add an incompatibility that lets pubgrub skip of marker packages when the base package already has an incompatible version to improve the error messages (<a href="https://github.com/astral-sh/uv/issues/15199">astral-sh/uv#15199</a>).</p>
<p>The change is also a small perf improvement. Overall this should be able to improve performance in slow cases by avoiding trying proxy package versions that are impossible anyway, for a (ideally very small cost) for tracking the additional incompatibility and tracking the base package for each proxy package.</p>
<pre><code>$ hhyperfine --warmup 2 &quot;uv pip compile --universal scripts/requirements/airflow.in&quot; &quot;target/release/uv pip compile --universal scripts/requirements/airflow.in&quot;
Benchmark 1: uv pip compile --universal scripts/requirements/airflow.in
  Time (mean ± σ):     145.5 ms ±   3.9 ms    [User: 154.7 ms, System: 140.7 ms]
  Range (min … max):   139.2 ms … 153.4 ms    20 runs
 
Benchmark 2: target/release/uv pip compile --universal scripts/requirements/airflow.in
  Time (mean ± σ):     128.7 ms ±   5.5 ms    [User: 141.9 ms, System: 137.3 ms]
  Range (min … max):   121.8 ms … 142.0 ms    23 runs
 
Summary
  target/release/uv pip compile --universal scripts/requirements/airflow.in ran
    1.13 ± 0.06 times faster than uv pip compile --universal scripts/requirements/airflow.in
</code></pre>
<p>This implementation is the basic version: When we see a proxy <code>foo{...}&gt;=x,&lt;y</code> we add a dependency edge <code>foo{...}&gt;=x,&lt;y</code> -&gt; <code>foo&gt;=x,&lt;y</code>. There are several way to extend this, which likely help more with performance than with error messages.</p>
<p>One idea is that if we see <code>foo{...}&gt;=x,&lt;y</code> but we already made a selection for <code>foo==z</code> outside that range, we can insert a dependency <code>foo{...}!=z</code> -&gt; <code>foo!=z</code>. This avoids trying any version of the proxy package except the version that matches our previous selection.</p>
<p>Another is that if we see a dependency <code>foo&gt;=x,&lt;y</code>, we also add <code>foo{...}&gt;=x,y</code> -&gt; <code>foo&gt;=x,&lt;y</code>. This allows backtracking beyond <code>foo</code> immediately if all version of <code>foo{...}&gt;=x,&lt;y</code> are incompatible, since <code>foo{...}&gt;=x,&lt;y</code> incompatible -&gt; <code>foo&gt;=x,&lt;y</code> incompatible -&gt; the package that depended of <code>foo&gt;=x,&lt;y</code> is incompatible.</p>
<p>The cost for each of these operations is tracking an additional incompatibility per virtual package. An alternative approach is to only add the incompatibility lazily, only when we&#x27;ve tried several version of the virtual package already. This needs to be weighed of with the better error messages that the incompatibility gives, we unfortunately have only few large reference examples.</p>
<p>Requires <a href="https://github.com/astral-sh/pubgrub/pull/45">astral-sh/pubgrub#45</a></p>
<p>Closes <a href="https://github.com/astral-sh/uv/issues/15199">astral-sh/uv#15199</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">error messages</span> added by <a href="https://github.com/konstin">@konstin</a> on 2025-08-10 11:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/BurntSushi">@BurntSushi</a> by <a href="https://github.com/konstin">@konstin</a> on 2025-08-27 19:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/BurntSushi">@BurntSushi</a> removed by <a href="https://github.com/konstin">@konstin</a> on 2025-08-27 19:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/konstin">@konstin</a> on 2025-08-27 19:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by <a href="https://github.com/konstin">@konstin</a> on 2025-08-27 19:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/BurntSushi">@BurntSushi</a> by <a href="https://github.com/konstin">@konstin</a> on 2025-08-27 19:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-08-27 19:01</div>
            <div class="timeline-body"><p>Tagging both zanie and andrew because in an older version I broke a conflict test by accidentally including dependency groups, we should ensure that there are no other gotchas with dependency groups and/or conflicts.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/konstin">@konstin</a> on 2025-08-27 19:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2025-08-28 13:30</div>
            <div class="timeline-body"><p>Cool. I do not have a deep understanding of the implications here — it makes sense to have another reviewer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv/tests/it/lock.rs</code>:13093 on 2025-08-28 16:47</div>
            <div class="timeline-body"><p>Oh nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv/tests/it/lock.rs</code>:29861 on 2025-08-28 16:48</div>
            <div class="timeline-body"><p>Much better!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2025-08-28 16:48</div>
            <div class="timeline-body"><p>I think this makes sense to me! This is a nice improvement. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-09-22 11:26</div>
            <div class="timeline-body"><p>No changes in any tested package.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/konstin">@konstin</a> on 2025-09-22 11:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/konstin">@konstin</a> on 2025-09-22 11:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-09-22 11:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:53:31 UTC
    </footer>
</body>
</html>
