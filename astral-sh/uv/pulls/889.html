<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use a larger runner for tests - astral-sh/uv #889</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use a larger runner for tests</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/889">#889</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-01-11 19:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>Alternative to #875. Instead of partitioning tests across multiple runners via nextest, we use a larger GitHub Actions runner. Additionally, we explore using nextest to take advantage of the increased number of cores.</p>
<p>On the 8-core machine, nextest is 22% faster than insta. In combination with the vastly more readable output, I think this means we should switch over. As noted in #875 we lose the ability to detect unreferenced snapshot files but since we inline all of our snapshots this shouldn&#x27;t matter.</p>
Benchmarks
<p>The following are the runtime of <em>just</em> the test portion of the test job in GitHub Actions except the partitioned case from #875 which requires a separate build step making runner overhead relevant.</p>
<p>The compile times are noted as a reference as a possible lower bound of test times. The compile time <strong>is included</strong> in all of the test times shown.</p>
<p>Where the nextest thread count is not noted, it is inferred from the CPU count.</p>
<pre><code>test                                  time        diff
------------------------------------------------------
2-core (main)                         4m 53s
2-core-nextest-partioned (#875)       3m 56s      -19%
4-core-compilation                       32s      
4-core-insta                          1m 47s      -63%
4-core-nextest                        1m 40s      -66%
8-core-compilation                       18s      
8-core-insta                          1m  9s      -76%
8-core-nextest                        1m  5s      -78%
8-core-nextest-12-threads                54s      -82%
8-core-nextest-16-threads                55s      -82%
</code></pre>
Cost
<p>We must pay per-minute costs for these runners:</p>
<blockquote>
<p>Larger runners are not eligible for the use of included minutes on private repositories. For both private and public repositories, when larger runners are in use, they will always be billed at the per-minute rate.</p>
<p>Compared to standard GitHub-hosted runners, larger runners are billed differently. Larger runners are only billed at the per-minute rate for the amount of time workflows are executed on them.</p>
</blockquote>
<p><a href="https://docs.github.com/en/actions/using-github-hosted-runners/about-larger-runners/about-larger-runners#understanding-billing">[source]</a></p>
<p>The per-minute rates are as follows:</p>
<blockquote>
<p>Linux	2	$0.008  (main)
Linux	4	$0.016
Linux	8	$0.032  (pull request)</p>
</blockquote>
<p><a href="https://docs.github.com/en/billing/managing-billing-for-github-actions/about-billing-for-github-actions#per-minute-rates">[source]</a></p>
<p>The per-minute cost increases by 4x but the workflow is 5.2x faster since we are making use of the extra compute. We will not get any free minutes executing these runners once the repository is public. Additionally, we will not make use of our <a href="https://docs.github.com/en/billing/managing-billing-for-github-actions/about-billing-for-github-actions#included-storage-and-minutes">3,000 minutes / month</a> of included minutes. Using the 8-core machines, the included 3,000 minutes should account for approximately ~$100.</p>
<p>Here&#x27;s a brief analysis of costs from the last few</p>
<pre><code>
Minutes used
------------
November 1090 + 3000 = 4090
December 1357 + 3000 = 4357
January  2655 in 7 days
         ~3x more expected
                     = 11000 estimated

Costs
-----
November  1090 * 0.008   = $ 8.72
December  1357 * 0.008   = $10.86
January   8000 * 0.008   = $64 projected using 3000 included minutes and 2-core machines
          (11000 - (0.82 * 11000)) * 0.032
                         = $63 projected without included minutes and 4-core machines with perf improvement
          (11000 - (0.70 * 11000)) * 0.032
                         = $100 projected with a more conservative 70% reduction in total runtime

</code></pre>
<p>We can reduce costs (once public) by disabling larger runners for non-organization users e.g. <a href="https://github.com/PrefectHQ/prefect/pull/9519">PrefectHQ/prefect#9519</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Use a 4-core larger runner for tests&quot; to &quot;Use a larger runner for tests&quot; by <a href="https://github.com/zanieb">@zanieb</a> on 2024-01-11 19:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-01-11 20:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.github/workflows/ci.yaml</code>:53 on 2024-01-11 20:08</div>
            <div class="timeline-body"><p>Before merge, an organization admin (@charliermarsh) needs to change the name of this runner to <code>ubuntu-latest-large-8</code> or similar.</p>
<p>The <a href="https://docs.github.com/en/actions/using-github-hosted-runners/about-larger-runners/about-larger-runners">macOS runners</a> are named &quot;macos-latest-large&quot; and &quot;macos-latest-xlarge&quot;. We could consider just using &quot;ubuntu-latest-large&quot; for consistency in our workflow and change the number of cores in the admin panel as needed. A consistent name would make it really easy for us to have just the OS in the matrix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/zanieb">@zanieb</a> on 2024-01-11 20:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-11 21:03</div>
            <div class="timeline-body"><p>Since this only includes the test runtime, and not the compile time, we wouldn&#x27;t expect an 82% speed <em>overall</em> right? Just looking at the cost analysis, which seems to assume one. (I still think it&#x27;s fine.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-01-11 21:03</div>
            <div class="timeline-body"><p>What would you like the name change to be precisely</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-01-11 21:09</div>
            <div class="timeline-body"><p>@charliermarsh sorry that&#x27;s not clear. All of the test run numbers <em>include</em> the compile time. I only listed the compile time separately to help see how much of the change was related to that. We should expect about an 82% improvement for compilation and testing. If we look at the total runtime of the job it&#x27;s probably actually more like 70% overall runtime  improvement (since setup isn&#x27;t significantly faster) which comes out to ~$100 projected for January.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-01-11 21:11</div>
            <div class="timeline-body"><p><code>ubuntu-latest-large</code> please. Then I can match it to the macOS runner if we add tests for macOS.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-01-11 22:06</div>
            <div class="timeline-body"><p>I renamed <code>astral-8-core</code> to <code>ubuntu-latest-large</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-01-11 22:14</div>
            <div class="timeline-body"><p>Omg it&#x27;s so fast. Note for posterity, there are larger runners e.g. 16, 32, and 64 core machines that I didn&#x27;t bother testing. 1m seems good enough.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/zanieb">@zanieb</a> on 2024-01-11 22:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/zanieb">@zanieb</a> on 2024-01-11 22:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-01-11 22:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-01-12 09:17</div>
            <div class="timeline-body"><p>:heart_eyes:</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:43:09 UTC
    </footer>
</body>
</html>
