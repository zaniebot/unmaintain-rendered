<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add docs for disabling build isolation with `uv sync` - astral-sh/uv #6607</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add docs for disabling build isolation with <code>uv sync</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/6607">#6607</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-08-25 14:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>This requires some care, so worth documenting the intended workflows.</p>
<p>Closes <a href="https://github.com/astral-sh/uv/issues/6437">astral-sh/uv#6437</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">documentation</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-25 14:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-25 14:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kabouzeid">@kabouzeid</a> on 2024-08-25 16:31</div>
            <div class="timeline-body"><p>Maybe hold off on merging this; there are a couple of problems. Give me an hour or so, and I will provide you with an example.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kabouzeid">@kabouzeid</a> on 2024-08-25 17:10</div>
            <div class="timeline-body"><p>First of all, the <code>--no-build-isolation-package</code> option doesn&#x27;t work for me <em>at all</em> with any package, whether in <code>uv pip install</code>, <code>uv add</code>, or in <code>pyproject.toml</code>. However, this is a separate issue, so here I will just use <code>--no-build-isolation</code> instead.</p>
<p>I see the following issues with the provided example:</p>
<ol>
<li>It only works if <code>uv.lock</code> already exists and/or <code>flash-attn</code> is already cached. Otherwise, for some reason, <code>uv</code> always tries to build <code>flash-attn</code> during <code>sync</code>, even though it was not requested.</li>
</ol>
<pre><code>➜ uv sync --extra build
⠴ flash-attn==2.6.3
error: Failed to download and build `flash-attn==2.6.3`
  Caused by: Build backend failed to determine extra requires with `build_wheel()` with exit status: 1
--- stdout:

--- stderr:
Traceback (most recent call last):
  File &quot;&lt;string&gt;&quot;, line 14, in &lt;module&gt;
  File &quot;/home/abou_zeid/.cache/uv/builds-v0/.tmpJtZIFU/lib/python3.12/site-packages/setuptools/build_meta.py&quot;, line 332, in get_requires_for_build_wheel
    return self._get_build_requires(config_settings, requirements=[])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/home/abou_zeid/.cache/uv/builds-v0/.tmpJtZIFU/lib/python3.12/site-packages/setuptools/build_meta.py&quot;, line 302, in _get_build_requires
    self.run_setup()
  File &quot;/home/abou_zeid/.cache/uv/builds-v0/.tmpJtZIFU/lib/python3.12/site-packages/setuptools/build_meta.py&quot;, line 502, in run_setup
    super().run_setup(setup_script=setup_script)
  File &quot;/home/abou_zeid/.cache/uv/builds-v0/.tmpJtZIFU/lib/python3.12/site-packages/setuptools/build_meta.py&quot;, line 318, in run_setup
    exec(code, locals())
  File &quot;&lt;string&gt;&quot;, line 21, in &lt;module&gt;
ModuleNotFoundError: No module named &#x27;torch&#x27;
---
  Caused by: This error likely indicates that flash-attn==2.6.3 depends on torch, but doesn&#x27;t declare it as a build dependency. If flash-attn==2.6.3 is a first-party package, consider adding torch to its `build-system.requires`. Otherwise, `uv pip install torch` into the environment and re-run with `--no-build-isolation`.
</code></pre>
<ol>
<li><p><code>--no-build-isolation</code> doesn&#x27;t install any declared build dependencies. These dependencies also need to be installed to compile <code>flash-attn</code>. For <code>flash-attn</code>, this is just <code>psutil</code>. If the default <code>hatchling</code> build system is used, then <code>hatchling</code> and <code>editables</code> are also needed for building. Those are the dependencies that should go into the <code>build</code> group, as they are only required for building and can be removed afterwards.</p>
</li>
<li><p><code>torch</code> will almost always be a main dependency, which makes the example a bit confusing. To clarify: <code>torch</code> is <em>also</em> needed for building extensions, but you wouldn&#x27;t want to remove <code>torch</code> after building the extension.</p>
</li>
</ol>
<hr>
<p>Putting all of this together, it should look more like this</p>
<pre><code>[project]
name = &quot;project&quot;
version = &quot;0.1.0&quot;
description = &quot;...&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.12&quot;
dependencies = [&quot;torch&quot;]  # torch is almost always a main dependency

[project.optional-dependencies]
build = [
    &quot;psutil&quot;,
    # &quot;editables&quot;,  # only needed if build system is hatchling
    # &quot;hatchling&quot;,  # only needed if build system is hatchling
]
compile = [&quot;flash-attn&quot;]

[tool.uv]
no-build-isolation-package = [&quot;flash-attn&quot;]  # currently doesn&#x27;t work. must be a bug.
</code></pre>
<pre><code>$ uv sync --extra build  # installs torch + flash-attn build deps
$ uv sync --extra compile  # compiles flash-attn, removes build deps (but keeps torch)
</code></pre>
<p>Again, this doesn&#x27;t actually work right now if <code>uv.lock</code> is not present, because in that case, <code>uv</code> tries to build (but not install) all extras, regardless. Also, since <code>--no-build-isolation-package</code> doesn&#x27;t seem to be working currently, you would still need to pass <code>--no-build-isolation</code> for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-25 17:21</div>
            <div class="timeline-body"><p>That first issue is already fixed on main (#6605).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-25 17:23</div>
            <div class="timeline-body"><blockquote>
<p>It only works if uv.lock already exists and/or flash-attn is already cached. Otherwise, for some reason, uv always tries to build flash-attn during sync, even though it was not requested.</p>
</blockquote>
<p>This is expected <em>and</em> required. <code>flash-attn</code> ships as a source distribution, and only at <code>Metadata-Version: 2.1</code>, so you <em>must</em> ask the build backend for its dependencies per the spec -- which in turn requires that its build dependencies are already installed. There&#x27;s really nothing we can do about this -- it&#x27;s a problem with the package. They need to upgrade to <code>Metadata-Version: 2.2</code>.</p>
<p>The only way to get things working in this case would be to use the <code>uv pip install</code> hack to pre-populate the virtual environment.</p>
<p>I&#x27;ll have to use a different example here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-25 17:24</div>
            <div class="timeline-body"><blockquote>
<p>--no-build-isolation doesn&#x27;t install any declared build dependencies.</p>
</blockquote>
<p>Correct, all sounds right to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kabouzeid">@kabouzeid</a> on 2024-08-25 19:12</div>
            <div class="timeline-body"><blockquote>
<p>This is expected <em>and</em> required. <code>flash-attn</code> ships as a source distribution, and only at <code>Metadata-Version: 2.1</code>, so you <em>must</em> ask the build backend for its dependencies per the spec -- which in turn requires that its build dependencies are already installed. There&#x27;s really nothing we can do about this -- it&#x27;s a problem with the package. They need to upgrade to <code>Metadata-Version: 2.2</code>.</p>
</blockquote>
<p>Thank you for the explanation, TIL! It seems the lock file has to be compiled with respect to all extras at once, even if they aren&#x27;t explicitly requested. This is because the extras can introduce additional constraints on the other dependencies, correct?</p>
<hr>
<p>Somehow all torch extensions I looked at are <code>Metadata-Version: 2.1</code>, not sure why. Perhaps we should just use the steps to build the environment in the example then?</p>
<pre><code>uv add torch
uv add --optional build psutil  # possibly also others such as editables, hatchling
uv add --optional compile flash-attn
</code></pre>
<p>Now that the lock file exists and is commited to the repo, the end user can just sync:</p>
<pre><code>uv sync --extra build
uv sync --extra compile
</code></pre>
<p>Actually, it seems that in the first example above the lock file doesn&#x27;t match the pyproject.toml without another <code>lock</code> or <code>sync</code> call after adding the packages (see <a href="https://github.com/astral-sh/uv/issues/6614">astral-sh/uv#6614</a>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-25 20:03</div>
            <div class="timeline-body"><blockquote>
<p>It seems the lock file has to be compiled with respect to all extras at once, even if they aren&#x27;t explicitly requested. This is because the extras can introduce additional constraints on the other dependencies, correct?</p>
</blockquote>
<p>Yeah that&#x27;s right -- we have to make sure that the entire environment can be installed (including any extras) after locking, so we generate a single lock that tracks all extras, etc.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-25 20:09</div>
            <div class="timeline-body"><p>I&#x27;m sorry that you&#x27;ve been a test subject for all the build isolation stuff -- we only added it at the very end (to <code>uv sync</code> -- <code>uv pip</code> has had it for a long time) to unblock folks, but we always want (and still want) to come up with a totally different solution to the underlying problems. E.g., I&#x27;d prefer an API where you can define the build dependencies yourself, or similar, and then we install in order as a graph.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-08-26 17:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>docs/concepts/projects.md</code>:324 on 2024-08-26 17:00</div>
            <div class="timeline-body"><p>Should we repeat the <code>no-build-isolation-package = [&quot;flash-attn&quot;]</code> bit here? I was surprised it was omitted.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2024-08-26 17:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-26 18:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-26 18:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-08-26 18:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kabouzeid">@kabouzeid</a> on 2024-08-27 09:33</div>
            <div class="timeline-body"><blockquote>
<p>I&#x27;m sorry that you&#x27;ve been a test subject for all the build isolation stuff -- we only added it at the very end (to <code>uv sync</code> -- <code>uv pip</code> has had it for a long time) to unblock folks, but we always want (and still want) to come up with a totally different solution to the underlying problems. E.g., I&#x27;d prefer an API where you can define the build dependencies yourself, or similar, and then we install in order as a graph.</p>
</blockquote>
<p>No worries! I&#x27;m actually pretty happy that it&#x27;s working at all with these kinds of dependencies. I&#x27;ve never gotten it to properly work with any tool other than pip.</p>
<p>I totally agree that to really solve this, we need to tackle the actual underlying problems. It&#x27;s super exciting that this is on the roadmap! I&#x27;m keeping a close eye on the project and will provide feedback on how these future APIs handle tricky cases like PyTorch and CUDA extensions. Thanks for all the great work you&#x27;re doing!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tmm1">@tmm1</a> on 2025-01-24 00:42</div>
            <div class="timeline-body"><blockquote>
<p>This is expected <em>and</em> required. <code>flash-attn</code> ships as a source distribution, and only at <code>Metadata-Version: 2.1</code>, so you <em>must</em> ask the build backend for its dependencies per the spec -- which in turn requires that its build dependencies are already installed. There&#x27;s really nothing we can do about this -- it&#x27;s a problem with the package. They need to upgrade to <code>Metadata-Version: 2.2</code>.</p>
</blockquote>
<p>Has this been surfaced to them? How is this version generally set by a python package? Do they need to bump some build tooling deps?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-24 00:50</div>
            <div class="timeline-body"><p>It&#x27;s determined by the build backend. It looks like they&#x27;re using the version of setuptools that comes on the GitHub Runner: https://github.com/Dao-AILab/flash-attention/actions/runs/12215254337/job/34085814635#step:4:18. If they upgrade setuptools, I would expect it to write Metadata 2.2.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-24 00:51</div>
            <div class="timeline-body"><p>It might be as simple as changing the <code>pip install</code> in that CI step to <code>pip install -U</code> or similar.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tmm1">@tmm1</a> on 2025-01-24 02:08</div>
            <div class="timeline-body"><p>Thanks. I will work with upstream to fix this. I see they&#x27;re using setuptools==65.5.0 for the source package, and setuptools==68.0.0 for the cuda binary wheels. What is the minimum required version for Metadata 2.2?</p>
<p>EDIT: <a href="https://github.com/pypa/setuptools/releases/tag/v75.8.0">v75.8.0</a> contains https://github.com/pypa/setuptools/commit/f285d01e2661b01e4947a4dca7704790b65f2967 which was merged two weeks ago</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-01-24 02:13</div>
            <div class="timeline-body"><p>(Posting anyway even though you beat me to it) I don&#x27;t know off-hand but it looks like it was bumped <a href="https://github.com/pypa/setuptools/pull/4698">here</a> so it honestly might only be the latest version (<code>75.8.0</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-02-01 02:30</div>
            <div class="timeline-body"><p>It looks like this is out now with the latest <code>flash-attn</code>!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:47:47 UTC
    </footer>
</body>
</html>
