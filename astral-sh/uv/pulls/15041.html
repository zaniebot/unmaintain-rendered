<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Avoid invalid simplification with conflict markers  - astral-sh/uv #15041</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Avoid invalid simplification with conflict markers</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/15041">#15041</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2025-08-03 11:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/konstin">@konstin</a> on 2025-08-03 11:26</div>
            <div class="timeline-body"><p>Previously, <code>simplify_conflict_markers</code> assumed that it can remove all conflict set together, when we need to look at each conflict set individually. Specifically, <code>(platform_machine == 'x86_64' and extra == 'extra-5-foo-b') or extra == 'extra-5-foo-a'</code> can't be reduced <code>platform_machine == 'x86_64'</code> only because it reduces to true when both conflict extras are activated.</p>
<p>This case applied in https://github.com/astral-sh/uv/issues/14805, where a jax 0.5.3 version was used for <code>platform_machine != 'aarch64' or sys_platform != 'linux'</code> and the conflict extra <code>cu128</code>, but jax 0.7.0 for the conflict extra <code>cpu</code>.</p>
<p>Only removing the faulty inference regresses lockfiles to much more verbose markers. To balance the much more conservative inference, I added <code>unify_inference_sets</code> to simplify cases where all conflict branches reduce to the same marker.</p>
<p>This still regresses some markers. For example <code>sys_platform == 'win32'</code> regresses to <code>sys_platform == 'win32' or (extra == 'extra-3-pkg-x1' and extra == 'extra-3-pkg-x2')</code> in <code>extra_inferences</code>, even through x1 and x2 conflict and the second conjunction could be simplified away.</p>
<p>Fixes https://github.com/astral-sh/uv/issues/14805</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @konstin on 2025-08-03 11:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @konstin on 2025-08-03 11:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-resolver/src/universal_marker.rs</code>:144 on 2025-08-03 11:28</div>
            <div class="timeline-body"><p>@BurntSushi Is it correct to assume that if we have inferences, we must be in one of them, i.e. there can't be a missing &quot;empty&quot; inference set?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-08-03 11:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-resolver/src/resolver/environment.rs</code>:403 on 2025-08-03 11:29</div>
            <div class="timeline-body"><p>We were previously treating forks with a true marker as non-distinct, even if they were conflict forks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-08-03 11:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-08-03 11:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/lock_conflict.rs</code>:15251 on 2025-08-03 11:35</div>
            <div class="timeline-body"><p>The marker is exactly the reachability of python-dateutil 2.8.0, we should be able to elide it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-pep508/src/marker/tree.rs</code>:1165 on 2025-08-04 13:57</div>
            <div class="timeline-body"><p>Is it correct that this is calling <code>Self::evaluate_extras</code> recursively instead of itself? If so, it's surprising enough (to me anyway) that it might deserve a special comment saying why.</p>
<p>Also, is it worth adding some unit tests for this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-resolver/src/resolver/environment.rs</code>:403 on 2025-08-04 14:43</div>
            <div class="timeline-body"><p>Ah right because <code>markers</code> isn't a &quot;universal&quot; marker yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-resolver/src/resolver/mod.rs</code>:721 on 2025-08-04 14:53</div>
            <div class="timeline-body"><p>Should <code>let packages: ...</code> be dropped and this reverted back to <code>resolution.nodes.len()</code>? (I'm guessing you debug printed <code>packages</code> at one point..?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-resolver/src/universal_marker.rs</code>:144 on 2025-08-04 14:59</div>
            <div class="timeline-body"><p>Can you say more? What do you mean by a missing empty inference set?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-resolver/src/universal_marker.rs</code>:450 on 2025-08-04 15:04</div>
            <div class="timeline-body"><p>Nice to be able to get rid of this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2025-08-04 15:05</div>
            <div class="timeline-body"><p>Thanks for working on this! I think this all LGTM.</p>
<p>Some of the markers getting a little more complex is a bummer, but it doesn't seem too bad (at least on our existing tests).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-resolver/src/resolver/mod.rs</code>:721 on 2025-08-04 18:18</div>
            <div class="timeline-body"><p>The <code>nodes</code> length counts extra packages and such separately, so it prints a number that's not actually packages as you would expect. I considered this a drive-by fix, if it's controversial I'll split out a PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-08-04 18:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-08-04 18:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-pep508/src/marker/tree.rs</code>:1165 on 2025-08-04 18:28</div>
            <div class="timeline-body"><p>nope, good catch!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-08-04 18:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-resolver/src/universal_marker.rs</code>:144 on 2025-08-04 18:31</div>
            <div class="timeline-body"><p>I.e. we can't reach this node without having either conflict extra(/group/etc.) activated, so we know that at least on of the sets applies. If that assumption is not true, we have to compute another marker where we set all conflict markers to true, and that also has to match the <code>previous_marker</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-04 21:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/it/lock_conflict.rs</code>:555 on 2025-08-04 21:45</div>
            <div class="timeline-body"><p>This sort of seems like noise to a user?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-08-05 12:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-resolver/src/resolver/mod.rs</code>:721 on 2025-08-05 12:19</div>
            <div class="timeline-body"><p>Ah I see. No, I'm fine with it. Makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-08-05 12:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-resolver/src/universal_marker.rs</code>:144 on 2025-08-05 12:25</div>
            <div class="timeline-body"><p>Hmmm okay. I believe (80% confidence) this is safe to assume. If it weren't, wouldn't the <code>all_paths_satisfied</code> check be flawed?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-08-05 13:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/lock_conflict.rs</code>:555 on 2025-08-05 13:57</div>
            <div class="timeline-body"><p>Without this information, it's not possible to follow along with the error message. If there is a general conflict, that is not dependent on the conflict fork we're in, this information is redundant, but we don't have that information (we'd need to run the other branch too to check). That is similar to showing the markers in the error message, where in many cases the fork is irrelevant (non of the forks is solvable), but we show it anyway because we need it explain why specific dependencies were in- or excluded.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-08-05 13:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-resolver/src/universal_marker.rs</code>:144 on 2025-08-05 13:59</div>
            <div class="timeline-body"><p>Good point</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-08-05 19:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/it/lock_conflict.rs</code>:555 on 2025-08-05 19:57</div>
            <div class="timeline-body"><p>I don't think this context makes the following error message any easier to understand? I think it makes it more confusing, even. I think showing the splits for the markers are confusing too though... so I guess we can track improving this as a larger goal.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-08-06 07:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/lock_conflict.rs</code>:555 on 2025-08-06 07:54</div>
            <div class="timeline-body"><p>Following up in https://github.com/astral-sh/uv/issues/15092</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-08-06 09:07</div>
            <div class="timeline-body"><p>Added some notes on a better solution in https://github.com/astral-sh/uv/issues/15101</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2025-08-06 09:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2025-08-06 09:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-06 09:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:28 UTC
    </footer>
</body>
</html>
