<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Trusted Publishing with pyx - astral-sh/uv #17438</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Support Trusted Publishing with pyx</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/17438">#17438</a>
        opened by <a href="https://github.com/woodruffw">@woodruffw</a>
        on 2026-01-13 15:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a></div>
            <div class="timeline-body">Summary
<p>~~WIP.~~ This follows #17418 and adds a <code>PyxPublishingService</code> that speaks the pyx-specific APIs for Trusted Publishing.</p>
<p>TODOs:</p>
<ul>
<li>[x] Needs publishing integration tests (see below).</li>
<li>[x] Needs changes to <code>OidcTokenClaims</code> (these are currently GitHub-specific, they need to become an enum over various supported platforms).</li>
</ul>
Test Plan
<p>I&#x27;ll add new publishing integration tests for the following scenarios:</p>
<ul>
<li>[x] Trusted Publishing between GitLab CI/CD &lt;-&gt; PyPI: #17443</li>
<li>[x] Trusted Publishing between GitHub Actions &lt;-&gt; pyx</li>
<li>[x] Trusted Publishing between GitLab CI/CD &lt;-&gt; pyx</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/woodruffw">@woodruffw</a> by <a href="https://github.com/woodruffw">@woodruffw</a> on 2026-01-13 15:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2026-01-13 22:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-publish/src/trusted_publishing.rs</code>:88 on 2026-01-13 22:45</div>
            <div class="timeline-body"><p>Flagging: normally I&#x27;d consider this an anti-pattern (in terms of untagged enums taking longer to match/producing suboptimal errors on failure), but the context here <em>might</em> make it acceptable:</p>
<ol>
<li>We&#x27;re in an error path on an already &quot;cold&quot; flow (uploading)</li>
<li>The overwhelming majority of users are probably using GitHub publishers, so serde won&#x27;t need to backtrack for them</li>
</ol>
<p>OTOH, I could make this explicitly tagged by adding a custom <code>Deserialize</code> that peeks the <code>iss</code> and dispatches based on that. That wouldn&#x27;t be hard, AFAIK there&#x27;s just no way to do it with serde&#x27;s derive APIs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2026-01-15 22:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>scripts/publish/test_publish.py</code>:434 on 2026-01-15 22:38</div>
            <div class="timeline-body"><p>NOTE: I&#x27;ve removed the previous strategy of polling the index for a &quot;fresh&quot; version to test publishing with, in favor of this &quot;timestamp&quot; strategy where we pick a monotonically increasing (but not contiguous) version.</p>
<p>The main advantage of this is that we don&#x27;t need to block/retry on the index to get a fresh version, i.e. we spend less time doing something unrelated to the main test functionality itself. The downside is that the versions are a little less nice.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2026-01-15 22:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>scripts/publish/test_publish.py</code>:788 on 2026-01-15 22:38</div>
            <div class="timeline-body"><p>The log volume was a bit extreme (and not helpful), so I&#x27;ve dropped it back down to <code>INFO</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/woodruffw">@woodruffw</a> on 2026-01-16 03:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/woodruffw">@woodruffw</a> on 2026-01-16 03:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/woodruffw">@woodruffw</a> on 2026-01-16 03:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">registry</span> added by <a href="https://github.com/woodruffw">@woodruffw</a> on 2026-01-16 03:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>scripts/publish/test_publish.py</code>:434 on 2026-01-19 11:05</div>
            <div class="timeline-body"><p>Do we still need the <code>fresh_version_strategy</code> flag? It&#x27;s not used anymore</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2026-01-19 11:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-publish/src/trusted_publishing/pyx.rs</code>:89 on 2026-01-19 11:19</div>
            <div class="timeline-body"><p>Note that <code>path_segments</code> is sensitive to trailing slashes:</p>
<pre><code>use std::str::FromStr;
use url::Url;

fn main() -&gt; Result&lt;(), ()&gt; {
    dbg!(
        Url::from_str(&quot;https://pyx.dev/v1/upload/workspace_name/registry_name&quot;)
            .unwrap()
            .path_segments()
            .map_or(Vec::new(), Iterator::collect)
    );
    dbg!(
        Url::from_str(&quot;https://pyx.dev/v1/upload/workspace_name/registry_name/&quot;)
            .unwrap()
            .path_segments()
            .map_or(Vec::new(), Iterator::collect)
    );
    Ok(())
}
</code></pre>
<pre><code>[src/main.rs:5:5] Url::from_str(&quot;https://pyx.dev/v1/upload/workspace_name/registry_name&quot;).unwrap().path_segments().map_or(Vec::new(),
Iterator::collect) = [
    &quot;v1&quot;,
    &quot;upload&quot;,
    &quot;workspace_name&quot;,
    &quot;registry_name&quot;,
]
[src/main.rs:11:5] Url::from_str(&quot;https://pyx.dev/v1/upload/workspace_name/registry_name/&quot;).unwrap().path_segments().map_or(Vec::new(),
Iterator::collect) = [
    &quot;v1&quot;,
    &quot;upload&quot;,
    &quot;workspace_name&quot;,
    &quot;registry_name&quot;,
    &quot;&quot;,
]
</code></pre>
<p>If pyx doesn&#x27;t allow trailing slashes, the URL is invalid, though maybe we want a separate error for this, it sounds easy to get wrong? We had those cases with trailing slashes for PyPI too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-publish/src/lib.rs</code>:467 on 2026-01-19 11:43</div>
            <div class="timeline-body"><p>nit: If we make <code>get_token</code> as method on the trait with default implementation, we can skip the async-traint-in-box and do:</p>
<pre><code>                PyxPublishingService::new(registry, client)
                    .get_token()
                    .await
                    .map_err(Box::new)?
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-publish/src/trusted_publishing.rs</code>:88 on 2026-01-19 11:47</div>
            <div class="timeline-body"><p>This sounds totally fine to me in the error path, it might even help in some fringe token mixup scenarios.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2026-01-19 11:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by <a href="https://github.com/konstin">@konstin</a> on 2026-01-19 11:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2026-01-20 15:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>scripts/publish/test_publish.py</code>:434 on 2026-01-20 15:16</div>
            <div class="timeline-body"><p>Nope, it&#x27;s safe to remove. Will do!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2026-01-20 15:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-publish/src/trusted_publishing/pyx.rs</code>:89 on 2026-01-20 15:17</div>
            <div class="timeline-body"><p>Thanks for catching this! We do allow trailing slashes on pyx&#x27;s upload endpoint, so I&#x27;ll accommodate here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/woodruffw">@woodruffw</a> reviewed on 2026-01-20 17:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/woodruffw">@woodruffw</a> on <code>crates/uv-publish/src/lib.rs</code>:467 on 2026-01-20 17:22</div>
            <div class="timeline-body"><p>Oh yeah, that&#x27;s way clearer. I&#x27;ll refactor!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/woodruffw">@woodruffw</a> on 2026-01-20 22:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/woodruffw">@woodruffw</a> on 2026-01-20 22:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2026-01-20 22:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 22:57:05 UTC
    </footer>
</body>
</html>
