<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build backend: Add fast path  - astral-sh/uv #9556</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Build backend: Add fast path</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/9556">#9556</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2024-12-01 20:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/konstin">@konstin</a> on 2024-12-01 20:39</div>
            <div class="timeline-body"><p>Going through PEP 517 to build a package is slow, so when building a package with the uv build backend, we can call into the uv build backend directly. This is the basis for the <code>uv build --list</code>.</p>
<p>This does not enable the fast path for general source dependencies.</p>
<p>There is a possible difference in execution if the latest uv version is newer than the one currently running: The PEP 517 path would use the latest version, while the fast path uses the current version.</p>
<p>Please review commit-by-commit</p>
<h3>Benchmark</h3>
<p><code>built_with_uv</code>, using the fast path:</p>
<pre><code>$ hyperfine &quot;~/projects/uv/target/profiling/uv build&quot;
Time (mean ± σ):       9.2 ms ±   1.1 ms    [User: 4.6 ms, System: 4.6 ms]
Range (min … max):     6.4 ms …  12.7 ms    290 runs
</code></pre>
<p><code>hatcling_editable</code>, with hatchling being optimized for fast startup times:</p>
<pre><code>$ hyperfine &quot;~/projects/uv/target/profiling/uv build&quot;
Time (mean ± σ):     270.5 ms ±  18.4 ms    [User: 230.8 ms, System: 44.5 ms]
Range (min … max):   250.7 ms … 298.4 ms    10 runs
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @konstin on 2024-12-01 20:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @konstin on 2024-12-01 20:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @konstin on 2024-12-01 20:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-01 21:09</div>
            <div class="timeline-body"><p>This is sick!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-12-01 22:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-cli/src/lib.rs</code>:2187 on 2024-12-01 22:24</div>
            <div class="timeline-body"><p>I think we should give this a more descriptive name, like <code>--use-external-uv</code> or something. Since we might add other &quot;fast paths&quot; in the future. What do you think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-12-01 22:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/build_frontend.rs</code>:742 on 2024-12-01 22:26</div>
            <div class="timeline-body"><p>I might structure these as just two entirely separate methods? That's always my instinct when I have a method that takes a bool and entirely forks behavior on that bool. Sort of a matter of preference, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-12-01 22:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-12-01 22:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-cli/src/lib.rs</code>:2187 on 2024-12-01 22:37</div>
            <div class="timeline-body"><p>Good idea. I thought about something like <code>--pep517</code>, maybe <code>--force-pep517</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-12-01 22:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/src/commands/build_frontend.rs</code>:742 on 2024-12-01 22:38</div>
            <div class="timeline-body"><p>I like those, in this case i already know that I'll add more forks (listing vs. building) here later :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-12-01 23:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-cli/src/lib.rs</code>:2187 on 2024-12-01 23:03</div>
            <div class="timeline-body"><p><code>--force-pep517</code> seems reasonable...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @konstin on 2024-12-02 15:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @konstin on 2024-12-02 15:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-12-02 15:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-cli/src/lib.rs</code>:2187 on 2024-12-03 14:24</div>
            <div class="timeline-body"><p>Ref #9600</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2024-12-03 14:25</div>
            <div class="timeline-body"><p>Nice! The benchmark shows a rather large perf difference. Do you have a sense of where this is coming from?</p>
<p>And that also makes me curious about the perf difference between the fast path and <code>--force-pep517</code>. That seems like a more apples-to-apples comparison? (Unless I'm misunderstanding the benchmark in the PR description.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-12-03 16:25</div>
            <div class="timeline-body"><p>For all the python build backends, we pay a cost for each import (see also https://peps.python.org/pep-0690/). A build backend is using a lot of features, so it gets slowed down by a lot of imports, even something manually optimized to have lazy imports such as hatchling.</p>
<p>For uv-against-uv, we paying the cost for setting up the build env, syncing it, spawning python, the spawning uv from python. We do this for each hook we call (should be <code>build_sdist</code> and <code>build_wheel</code> here).</p>
<p>Here's a uv-against-uv benchmark:</p>
<pre><code>UV_PREVIEW=1 hyperfine &quot;../../../target/profiling/uv build --find-links ../../../target/wheels/ --preview&quot; &quot;UV_PREVIEW=1 ../../../target/profiling/uv build --find-links ../../../target/wheels/ --preview --force-pep517&quot;
Benchmark 1: ../../../target/profiling/uv build --find-links ../../../target/wheels/ --preview
  Time (mean ± σ):       9.7 ms ±   1.7 ms    [User: 4.7 ms, System: 4.9 ms]
  Range (min … max):     6.5 ms …  21.7 ms    265 runs
 
Benchmark 2: UV_PREVIEW=1 ../../../target/profiling/uv build --find-links ../../../target/wheels/ --preview --force-pep517
  Time (mean ± σ):      87.7 ms ±   4.2 ms    [User: 61.0 ms, System: 28.4 ms]
  Range (min … max):    79.6 ms …  98.5 ms    33 runs
 
Summary
  ../../../target/profiling/uv build --find-links ../../../target/wheels/ --preview ran
    9.08 ± 1.61 times faster than UV_PREVIEW=1 ../../../target/profiling/uv build --find-links ../../../target/wheels/ --preview --force-pep517
</code></pre>
<p>To illustrate the overhead from calling python, this is the cost for some std modules you'll want for building distributions:</p>
<pre><code>$ hyperfine &quot;python -c ''&quot;
Benchmark 1: python -c ''
  Time (mean ± σ):       7.9 ms ±   1.2 ms    [User: 5.9 ms, System: 2.0 ms]
  Range (min … max):     6.2 ms …  10.4 ms    383 runs
$ hyperfine &quot;python -c 'import sys'&quot;
Benchmark 1: python -c 'import sys'
  Time (mean ± σ):       8.1 ms ±   1.2 ms    [User: 5.9 ms, System: 2.1 ms]
  Range (min … max):     6.3 ms …  10.7 ms    342 runs
$ hyperfine &quot;python -c 'import sys, os, subprocess, pathlib, zipfile'&quot;
Benchmark 1: python -c 'import sys, os, subprocess, pathlib, zipfile'
  Time (mean ± σ):      17.5 ms ±   2.1 ms    [User: 14.3 ms, System: 3.1 ms]
  Range (min … max):    15.1 ms …  24.6 ms    170 runs
</code></pre>
<p>The uv build backend imports <code>sys</code> and <code>subprocess</code> lazily, and has to spawn uv, so we can look at their isolated overhead:</p>
<pre><code>$ UV_PREVIEW=1 hyperfine &quot;python -c 'import sys, subprocess; from uv import build_wheel'&quot;
Benchmark 1: python -c 'import sys, subprocess; from uv import build_wheel'
  Time (mean ± σ):      14.7 ms ±   1.8 ms    [User: 11.8 ms, System: 2.9 ms]
  Range (min … max):    12.4 ms …  20.2 ms    219 runs
$ hyperfine -N &quot;uv build-backend --version&quot;
Benchmark 1: uv build-backend --version
  Time (mean ± σ):       2.4 ms ±   0.3 ms    [User: 0.9 ms, System: 1.5 ms]
  Range (min … max):     1.6 ms …   3.1 ms    968 runs
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-12-03 16:50</div>
            <div class="timeline-body"><p>Wow. So cool.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:15 UTC
    </footer>
</body>
</html>
