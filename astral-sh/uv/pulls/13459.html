<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refactor Docker image builds to use Depot - astral-sh/uv #13459</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Refactor Docker image builds to use Depot</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/13459">#13459</a>
        opened by <a href="https://github.com/kylegalbraith">@kylegalbraith</a>
        on 2025-05-14 18:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/kylegalbraith">@kylegalbraith</a> on 2025-05-14 18:21</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Simplify the Docker image build process to leverage Depot container builders for faster layer caching and native multi-platform image builds. The combo of the two removes the need to save cache to registries and do complex merge operations across GHA runners to get a multi-platform image.</p>
<h2>Test Plan</h2>
<p>UV team will need to add a trust relationship in Depot so that the container builds can authenticate and run. This can be done following these docs: https://depot.dev/docs/cli/authentication#adding-a-trust-relationship-for-github-actions.</p>
<p>Once that is done, this should just work as before, but without all of the extra work around manifests. We should double that all of the tagging still makes sense for you all, as some bits of that were unclear.</p>
<p>Additional context in this draft PR: https://github.com/astral-sh/uv/pull/9156</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @konstin on 2025-05-14 19:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @zanieb by @konstin on 2025-05-14 19:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-05-14 20:29</div>
            <div class="timeline-body"><p>Thank you! I'll give this a look (probably not in depth until after PyCon)</p>
<p>We have a trust relationship setup but it didn't allow public pull requests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-05-14 20:32</div>
            <div class="timeline-body"><p>I changed that, but it still fails — not sure what's up with that. I didn't have that problem in https://github.com/astral-sh/uv/pull/9156</p>
<p>edit: needed a project id because we don't have a <code>depot.json</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-05-15 00:35</div>
            <div class="timeline-body"><p>There is some context on the prior implementation (especially the complexity around tags) in:</p>
<ul>
<li>https://github.com/astral-sh/uv/pull/6556</li>
<li>https://github.com/astral-sh/uv/pull/6053</li>
<li>https://github.com/astral-sh/uv/pull/7568</li>
<li>https://github.com/astral-sh/uv/pull/8685</li>
</ul>
<p>We'll probably need to test the release process in a fork before going live.</p>
<p>cc @samypr100 as you have a lot of context on the Docker workflow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2025-05-15 02:50</div>
            <div class="timeline-body"><p>I'm not really sure how depot works. The native multi-platform building as a single job seems really nice, although from what I'm seeing this may not result in the desired outcome in tag ordering like @zanieb said unless there's a way to make depot publish all tags at once at the end somehow in a certain order. I believe testing in a fork is the right thing here. I'm unsure how to do so myself on my own fork as I don't have a depot account (which may be a small downside here as it makes it harder for forked contributors to test a release workflow like this one themselves).</p>
<p>If it helps, here's what I adjust for testing on my fork https://github.com/astral-sh/uv/commit/64a69b882a6e79c9321e5554f884047640f59634 currently</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2025-06-16 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-06-16 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-06-17 01:27</div>
            <div class="timeline-body"><p>I prioritized pushing this over the line to simplify the workflow so we could do https://github.com/astral-sh/uv/pull/14088</p>
<p>I fixed the tag ordering by simply pushing the base image again, at the end.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2025-06-17 02:17</div>
            <div class="timeline-body"><blockquote>
<p>I fixed the tag ordering by simply pushing the base image again, at the end.</p>
</blockquote>
<p>iirc when I tried this it changed the manifest and digest so it would effectively be as if you're pushing new images. Does depot help with keeping the same buildkit builder across jobs? I can see that helping</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/polarathene">@polarathene</a> on 2025-06-17 03:05</div>
            <div class="timeline-body"><p>If you have the digest for each image platform already pushed, you can add additional tags afterwards.</p>
<p>For example with <a href="https://oras.land/docs/commands/oras_tag"><code>oras tag</code></a> (<em>updates tag at the registry, rather than <a href="https://docs.docker.com/reference/cli/docker/image/tag/"><code>docker image tag</code></a> which updates locally</em>):</p>
<pre><code class="language-bash"># Login to Docker/GHCR via token, then use tag command:
# https://oras.land/docs/commands/oras_login
# https://oras.land/docs/commands/oras_tag

for tag in $TAGS; do
  oras tag &quot;${IMAGE}@${DIGEST}&quot; &quot;${tag}&quot;
done
</code></pre>
<p>There's a <a href="https://oras.land/docs/installation#github-actions"><code>oras</code> GH Action</a> too, and for white-space delimited list of tags you should be able to avoid the shell loop and just use:</p>
<pre><code class="language-bash">oras tag &quot;${IMAGE}@${DIGEST}&quot; ${TAGS[@]}
</code></pre>
<p>Another option is to keep your GHCR publishing workflow if that's simpler and then support additional image registries via copy/sync of the published image from GHCR to those registries. <a href="https://github.com/containers/skopeo#copying-images"><code>skopeo</code> supports this</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-06-17 03:35</div>
            <div class="timeline-body"><blockquote>
<p>iirc when I tried this it changed the manifest and digest so it would effectively be as if you're pushing new images.</p>
</blockquote>
<p>Hm, why would that be? We're downloading the image, then tagging, and pushing again. I think the digest is <em>must</em> be identical? I didn't explicitly check for this case though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-06-17 03:37</div>
            <div class="timeline-body"><p><code>oras</code> looks cool, thanks for the references!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2025-06-18 03:44</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>iirc when I tried this it changed the manifest and digest so it would effectively be as if you're pushing new images.</p>
</blockquote>
<p>Hm, why would that be? We're downloading the image, then tagging, and pushing again. I think the digest is <em>must</em> be identical? I didn't explicitly check for this case though.</p>
</blockquote>
<p>I'd have to look at the final manifest to confirm. Do you have some builds with this working where we can compare before and after manifests or is it best to wait until next uv release? Possibly how many digest are pushed per release would also help.</p>
<p>Historically, unless all the platforms are covered correctly its possible to lose multi-platform support which is why I've used <code>docker buildx imagetools</code> historically (e.g. see <a href="https://github.com/docker/buildx/issues/1744">ref</a>).
I've also seen issues where the media type gets changes erroneusly from OCI to Docker V2 when using the docker client directly to push rather than delegating to buildkit which is what <code>push</code> does in <code>build-push-action</code> which then can cause SHA256 to change due to the layout repackaging, although this may be fixed in newer docker versions.
Since you're pulling the digests directly it might work on recent docker versions but may be worth confirming.</p>
<p>At a glance, <code>oras tag</code> seems to be a suitable replacement for <code>docker buildx imagetools</code> approach at it works directly with the OCI registry layer, so it may be worth exploring that path. At least a year ago, to get ghcr.io to recognize a tag as the latest required adding an additional annotation to the existing digest, or pushing a new image. Adding a tag to an untagged digest didn't used to work either as it was based on the order of the pushes, regardless of tagged vs untagged.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-06-18 11:59</div>
            <div class="timeline-body"><blockquote>
<p>Do you have some builds with this working where we can compare before and after manifests or is it best to wait until next uv release?</p>
</blockquote>
<p>See https://github.com/zanieb/uv/pkgs/container/uv</p>
<pre><code>❯ oras manifest fetch ghcr.io/zanieb/uv:latest
{
  &quot;schemaVersion&quot;: 2,
  &quot;mediaType&quot;: &quot;application/vnd.oci.image.index.v1+json&quot;,
  &quot;manifests&quot;: [
    {
      &quot;mediaType&quot;: &quot;application/vnd.oci.image.manifest.v1+json&quot;,
      &quot;digest&quot;: &quot;sha256:050c6b92b16010632724f1d969de17072b53f1d37fa7c7ab8d9ab9b1dcc87afa&quot;,
      &quot;size&quot;: 669,
      &quot;platform&quot;: {
        &quot;architecture&quot;: &quot;amd64&quot;,
        &quot;os&quot;: &quot;linux&quot;
      }
    },
    {
      &quot;mediaType&quot;: &quot;application/vnd.oci.image.manifest.v1+json&quot;,
      &quot;digest&quot;: &quot;sha256:986204f5ba87892179768e355f83b1e72257685d50242300007af15222ea921a&quot;,
      &quot;size&quot;: 567,
      &quot;annotations&quot;: {
        &quot;vnd.docker.reference.digest&quot;: &quot;sha256:050c6b92b16010632724f1d969de17072b53f1d37fa7c7ab8d9ab9b1dcc87afa&quot;,
        &quot;vnd.docker.reference.type&quot;: &quot;attestation-manifest&quot;
      },
      &quot;platform&quot;: {
        &quot;architecture&quot;: &quot;unknown&quot;,
        &quot;os&quot;: &quot;unknown&quot;
      }
    },
    {
      &quot;mediaType&quot;: &quot;application/vnd.oci.image.manifest.v1+json&quot;,
      &quot;digest&quot;: &quot;sha256:15c366c1a43e732e27d07be9ea930dcf9a68f5ef4600c307311ca468a22d00e6&quot;,
      &quot;size&quot;: 669,
      &quot;platform&quot;: {
        &quot;architecture&quot;: &quot;arm64&quot;,
        &quot;os&quot;: &quot;linux&quot;
      }
    },
    {
      &quot;mediaType&quot;: &quot;application/vnd.oci.image.manifest.v1+json&quot;,
      &quot;digest&quot;: &quot;sha256:1f0b6b18ba6f9d4e30993382cfb829bb8e8b669194cb98d91bef28b3799449af&quot;,
      &quot;size&quot;: 567,
      &quot;annotations&quot;: {
        &quot;vnd.docker.reference.digest&quot;: &quot;sha256:15c366c1a43e732e27d07be9ea930dcf9a68f5ef4600c307311ca468a22d00e6&quot;,
        &quot;vnd.docker.reference.type&quot;: &quot;attestation-manifest&quot;
      },
      &quot;platform&quot;: {
        &quot;architecture&quot;: &quot;unknown&quot;,
        &quot;os&quot;: &quot;unknown&quot;
      }
    }
  ]
}%                                                                                                                                                                                                                                                                             
</code></pre>
<p>It looks like the only thing that is missing is</p>
<pre><code>  &quot;annotations&quot;: {
    &quot;org.opencontainers.image.created&quot;: &quot;2025-06-12T20:57:02.807Z&quot;,
    &quot;org.opencontainers.image.description&quot;: &quot;An extremely fast Python package and project manager, written in Rust.&quot;,
    &quot;org.opencontainers.image.licenses&quot;: &quot;Apache-2.0&quot;,
    &quot;org.opencontainers.image.revision&quot;: &quot;62ed17b2301874ea231cef78d1b25cd6a81a2a9c&quot;,
    &quot;org.opencontainers.image.source&quot;: &quot;https://github.com/astral-sh/uv&quot;,
    &quot;org.opencontainers.image.title&quot;: &quot;uv&quot;,
    &quot;org.opencontainers.image.url&quot;: &quot;https://github.com/astral-sh/uv&quot;,
    &quot;org.opencontainers.image.version&quot;: &quot;0.7.13&quot;
  }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-06-18 12:00</div>
            <div class="timeline-body"><p>(Appreciate your expertise &amp; scrutiny here!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2025-06-19 18:14</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>Do you have some builds with this working where we can compare before and after manifests or is it best to wait until next uv release?</p>
</blockquote>
<p>See https://github.com/zanieb/uv/pkgs/container/uv</p>
</blockquote>
<p>Awesome, thanks.</p>
<p>Looking published tags and I do see some initial issues at a glance</p>
<ol>
<li>OCI annotations missing like you indicated which can cause some issues with tools that expect them.</li>
<li>I see the manifest got converted to Docker V2 instead of OCI. This seems different from what you showed, likely part of ongoing changes?</li>
</ol>
<p>I tried to verify your previous output with attestations to see if the integrity was kept but didn't find any that matched to verify if they still work.</p>
<pre><code class="language-console">&gt; docker buildx imagetools inspect ghcr.io/zanieb/uv:0.7.13
Name:      ghcr.io/zanieb/uv:0.7.13
MediaType: application/vnd.docker.distribution.manifest.v2+json
Digest:    sha256:90769ad80b2a86b5b138d70c6b58241db7ff2e557d5e8b04f93a54ca1b4c24ce

&gt; docker buildx imagetools inspect --raw ghcr.io/zanieb/uv:0.7.13
{
   &quot;schemaVersion&quot;: 2,
   &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,
   &quot;config&quot;: {
      &quot;mediaType&quot;: &quot;application/vnd.docker.container.image.v1+json&quot;,
      &quot;size&quot;: 1296,
      &quot;digest&quot;: &quot;sha256:728b679871ed8f88dc13138bc05f5fada44b456dc76fadb39fc4ed76df5575f8&quot;
   },
   &quot;layers&quot;: [
      {
         &quot;mediaType&quot;: &quot;application/vnd.docker.image.rootfs.diff.tar.gzip&quot;,
         &quot;size&quot;: 18317040,
         &quot;digest&quot;: &quot;sha256:d60e9968cff63c563c831f6bddaf331c2fc2884c62ade8406aee2a74dfb4e954&quot;
      },
      {
         &quot;mediaType&quot;: &quot;application/vnd.docker.image.rootfs.diff.tar.gzip&quot;,
         &quot;size&quot;: 98,
         &quot;digest&quot;: &quot;sha256:387ec3a9a3567e89c8d9822592a92c88d418c4a04ffc1bc0e1f49288282578ac&quot;
      }
   ]
}
</code></pre>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:24 UTC
    </footer>
</body>
</html>
