<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix stream did not contain valid UTF-8 - astral-sh/uv #8120</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix stream did not contain valid UTF-8</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/8120">#8120</a>
        opened by <a href="https://github.com/kahojyun">@kahojyun</a>
        on 2024-10-11 04:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kahojyun">@kahojyun</a></div>
            <div class="timeline-body">Summary
<p>Related issues: #8009 #7549</p>
<p>Although <code>PYTHONIOENCODING=utf-8</code> forces python to use UTF-8 for <code>stdout</code>/<code>stderr</code>, it can&#x27;t prevent code like <code>sys.stdout.buffer.write()</code> or <code>subprocess.call([&quot;cl.exe&quot;, ...])</code> to bypass the encoder. This PR uses lossy UTF-8 conversion to avoid decoding error.</p>
Alternative
<p>Using <code>bstr</code> crate might be better since it can preserve original information. Or we should follow the Windows convention, unset <code>PYTHONIOENCODING</code> and decode with system default encoding.</p>
Test Plan
<p>Running locally with non-ASCII character in <code>UV_CACHE_DIR</code> works fine, but I have no unit test plan. Testing locale problem is hard :(</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-10-11 08:32</div>
            <div class="timeline-body"><p>\cc @BurntSushi</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-build-frontend/src/lib.rs</code>:962 on 2024-10-11 12:40</div>
            <div class="timeline-body"><p>First thought upon seeing this was thinking, &quot;but what about <code>\r</code>?&quot; But it looks like you handled that above. Nice. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-build-frontend/src/lib.rs</code>:932 on 2024-10-11 13:07</div>
            <div class="timeline-body"><p>I do think <code>bstr</code> would be better for this, and would suggest using it (since we already depend on it, albeit transitively, in uv), but my memory here is that we need to write valid UTF-8. So while <code>bstr</code> wouldn&#x27;t require this &quot;lossy&quot; step, I believe <a href="https://github.com/rust-lang/rust/blob/ce697f919d88b143d70312c0e7f3952fcb9869db/library/std/src/sys/pal/windows/stdio.rs#L102-L138">writing to the underlying stderr would still require valid UTF-8 anyway</a>. So <code>bstr</code> would just absolve you of needing to handle line iteration, but I think this is fine as-is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2024-10-11 13:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-10-11 13:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2024-10-11 13:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Super1Windcloud">@Super1Windcloud</a> on 2024-10-12 02:50</div>
            <div class="timeline-body"><p>@charliermarsh</p>
please provide next fixed version  as  soon as  possible
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:48:44 UTC
    </footer>
</body>
</html>
