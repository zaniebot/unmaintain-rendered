<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omit wheels from lockfile based on `--exclude-newer` - astral-sh/uv #12299</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Omit wheels from lockfile based on <code>--exclude-newer</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/12299">#12299</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2025-03-18 19:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>We respect <code>--exclude-newer</code> during resolution, but we weren't applying it to individual <em>files</em> when writing the lockfile. As a result, if wheels were added to a distribution after its initial release, we'd end up including them in the lockfile, even if they were uploaded after the <code>--exclude-newer</code> date.</p>
<p>Closes https://github.com/astral-sh/uv/issues/12296.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2025-03-18 19:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2025-03-18 19:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @Gankra by @charliermarsh on 2025-03-18 19:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @charliermarsh on 2025-03-18 19:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2025-03-18 19:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-18 19:30</div>
            <div class="timeline-body"><p>Is there going to be a user-facing consequence here for people with <code>--locked</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-18 19:37</div>
            <div class="timeline-body"><p>No.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-18 20:13</div>
            <div class="timeline-body"><p>There's a panic in the benchmark script setup that looks real.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-03-18 20:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-distribution-types/src/prioritized_distribution.rs</code>:519 on 2025-03-18 20:21</div>
            <div class="timeline-body"><p>This isn't valid because we need to adjust <code>best_wheel_index</code> above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-03-18 20:30</div>
            <div class="timeline-body"><p>As a reminder (partly for myself), I think the reason we don't filter these out entirely (which would be way simpler) is because we want to be able to show them in error messages (i.e., we want to be able to say &quot;There were wheels, but they were too new&quot;).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-bench/benches/uv.rs</code>:148 on 2025-03-18 20:45</div>
            <div class="timeline-body"><p>This depends on https://pypi.org/project/methodtools/0.4.7/#files, which added a wheel on August 23, 2024. So we can bump this to avoid building it from source.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-03-18 20:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-03-18 20:52</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_INSTRUMENTATION_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/uv/branches/charlie%2Fexc">CodSpeed Performance Report</a></h2>
<h3>Merging #12299 will <strong>improve performances by 20.51%</strong></h3>
<p><sub>Comparing <code>charlie/exc</code> (0964b22) with <code>main</code> (a95f4cf)</sub></p>
<h3>Summary</h3>
<p><code>⚡ 1</code> improvements<br />
<code>✅ 13</code> untouched benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>resolve_warm_airflow</code> | 702.2 ms | 582.7 ms | +20.51% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-19 00:17</div>
            <div class="timeline-body"><p>The benchmark change is pretty funny. I'll review this tomorrow, thanks for the quick turnaround.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-03-19 00:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @zanieb on 2025-03-19 00:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-19 00:17</div>
            <div class="timeline-body"><p>(oops)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-03-19 11:21</div>
            <div class="timeline-body"><p>I can reproduce a speedup in the right range by bumping the cutoff date:</p>
<pre><code>Benchmark 1: uv pip compile --exclude-newer 2024-08-08 a.txt
  Time (mean ± σ):      92.2 ms ±   2.2 ms    [User: 100.6 ms, System: 108.0 ms]
  Range (min … max):    87.9 ms …  96.7 ms    32 runs
 
Benchmark 2: uv pip compile --exclude-newer 2024-09-01 a.txt
  Time (mean ± σ):      80.5 ms ±   4.5 ms    [User: 83.2 ms, System: 102.8 ms]
  Range (min … max):    74.2 ms …  97.3 ms    39 runs
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2025-03-19 11:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/uv-distribution-types/src/prioritized_distribution.rs</code>:652 on 2025-03-19 12:39</div>
            <div class="timeline-body"><p>Is there a reason to not consider all <code>Incompatible()</code> instances &quot;excluded&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> approved on 2025-03-19 12:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2025-03-22 15:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-distribution-types/src/prioritized_distribution.rs</code>:652 on 2025-03-22 15:58</div>
            <div class="timeline-body"><p>Yeah...<code>ExcludeNewer</code> is kind of the odd one out here. &quot;Incompatible&quot; can also include things like &quot;not compatible with the current platform&quot;. But for the <code>ExcludeNewer</code> distributions, we basically want to act like they don't exist at all. It would be easier if we could filter them out in the first place, but the problem is, we <em>do</em> want to show dedicated error messages for them, so we have to propagate them throughout the system.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2025-03-22 16:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-03-22 16:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-22 16:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:42:31 UTC
    </footer>
</body>
</html>
