```yaml
number: 138
title: Build source distributions in the resolver
type: pull_request
state: merged
author: konstin
labels: []
assignees: []
merged: true
base: main
head: resolve-sdist
created_at: 2023-10-19T15:04:35Z
updated_at: 2023-10-25T20:05:15Z
url: https://github.com/astral-sh/uv/pull/138
synced_at: 2026-01-12T16:03:46Z
```

# Build source distributions in the resolver

---

_@konstin_

This is isn't ready, but it can resolve `meine_stadt_transparent==0.2.14`.

The source distributions are currently being built serially one after the other, i don't know if that is incidentally due to the resolution order, because sdist building is blocking or because of something in the resolver that could be improved.

It's a bit annoying that the thing that was supposed to do http requests now suddenly also has to a whole download/unpack/resolve/install/build routine, it messes up the type hierarchy. The much bigger problem though is avoid recursive crate dependencies, it's the reason for the callback and for splitting the builder into two crates (badly named atm)

---

_Comment by @charliermarsh on 2023-10-19 15:06_

Thanks, for this one let's do a proper review cycle (I'll try to read it today).

---

_Comment by @konstin on 2023-10-19 15:07_

Please wait with proper reviewing, it's very much not ready yet

---

_Comment by @charliermarsh on 2023-10-19 15:09_

Sounds good, mark it as ready when you think it's time.

I'm guessing the serial building is just due to the resolution order? But not sure.


---

_Comment by @konstin on 2023-10-20 12:54_

Current dependencies on/for this PR:
* main
  * **PR #154** <a href="https://app.graphite.dev/github/pr/astral-sh/puffin/154" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #138** <a href="https://app.graphite.dev/github/pr/astral-sh/puffin/138" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
      * **PR #178** <a href="https://app.graphite.dev/github/pr/astral-sh/puffin/178" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/puffin/138?utm_source=stack-comment).

---

_Marked ready for review by @konstin on 2023-10-22 16:13_

---

_Comment by @konstin on 2023-10-22 16:14_

I tested this with `meine_stadt_transparent` as requirement, which has 4 sdist dependencies

---

_@charliermarsh reviewed on 2023-10-23 15:48_

---

_Review comment by @charliermarsh on `crates/puffin-build-cli/src/sdist.rs`:49 on 2023-10-23 15:48_

Does this not need to use the actual resolver? Can't build dependencies have their own dependencies?

---

_Review comment by @konstin on `crates/puffin-build-cli/src/sdist.rs`:49 on 2023-10-24 15:35_

yes absolutely i'm surprised this worked at all

---

_@konstin reviewed on 2023-10-24 15:35_

---

_Review comment by @charliermarsh on `crates/puffin-build/src/lib.rs`:288 on 2023-10-25 03:23_

Why change the return type here? It seems strictly less flexible.

---

_Review comment by @charliermarsh on `crates/puffin-cli/src/commands/pip_compile.rs`:56 on 2023-10-25 03:25_

Is this clone necessary?

---

_Review comment by @charliermarsh on `crates/puffin-dispatch/src/lib.rs`:1 on 2023-10-25 03:26_

What is this? Why is it necessary?

---

_Review comment by @charliermarsh on `crates/puffin-resolver/src/resolver.rs`:279 on 2023-10-25 03:28_

Nit: please write TODOs as `TODO(konsti): Group files by version...`.

---

_Review comment by @charliermarsh on `crates/puffin-resolver/src/resolver.rs`:398 on 2023-10-25 03:29_

Can you go through `self.selector.iter_candidates`? As-is, I think this will be wrong when we use non-latest resolutions.

---

_Review comment by @charliermarsh on `crates/puffin-resolver/src/resolver.rs`:599 on 2023-10-25 03:31_

Can we improve the naming here? Right now, there's `WheelVersion`, which returns a `Version`, then `SdistVersion`, which returns an `Sdist`.

I would suggest just renaming to `Request::Wheel`, `Response::Wheel`, `Request::Sdist`, and `Response::Sdist`.

---

_Review comment by @charliermarsh on `crates/puffin-resolver/src/resolver.rs`:626 on 2023-10-25 03:31_

Can this not be `cache?` since the method returns `None`?

---

_Review comment by @charliermarsh on `scripts/pypi_top8k/download.sh`:5 on 2023-10-25 03:32_

Can you remove this and put it in a separate PR?

---

_Review comment by @charliermarsh on `vendor/pubgrub/src/internal/partial_solution.rs`:150 on 2023-10-25 03:33_

I'm a little hesitant to make passing changes to the vendored PubGrub code.

---

_Review comment by @charliermarsh on `crates/puffin-traits/src/lib.rs`:9 on 2023-10-25 03:37_

I'd suggest avoiding encoding these crate names in struct names. E.g., we'll definitely rename Puffin, so it's odd for it to appear in struct names.

I think we should also avoid abbreviations like `Ctx`, also for consistency in Ruff, where we'd spell out `Context` for the struct name and all variables

Perhaps `BuildContext`?

---

_Review comment by @charliermarsh on `crates/puffin-resolver/tests/resolver.rs`:27 on 2023-10-25 03:38_

Should we add a helpful error message to these? If they're called, what does that indicate?

---

_Review comment by @charliermarsh on `crates/puffin-dispatch/src/lib.rs`:12 on 2023-10-25 03:39_

Why use log for this one crate when all others using tracing?

---

_Review comment by @charliermarsh on `crates/puffin-dispatch/src/lib.rs`:117 on 2023-10-25 03:41_

Can this not use `PartitionedRequirements` from pip-sync? I get that there's some duplicate necessary for now but still seems like it should be useable here?

I guess more generally, why is this logic here different from the pip-sync command? That command does the resolution, then the downloads, then the unzips, , then the uninstalls, then the installs. Here it seems like we're doing the uninstalls, then the rest.

---

_Review comment by @charliermarsh on `crates/puffin-dispatch/src/lib.rs`:117 on 2023-10-25 03:42_

Over time, do you envision that pip-sync actually uses this command? So the dispatch becomes the central implementer of these operations?

---

_Review comment by @charliermarsh on `crates/puffin-build-cli/.gitignore`:2 on 2023-10-25 03:43_

If we retain these, can we document where they're used? 

---

_Review comment by @charliermarsh on `crates/puffin-build-cli/test.sh`:14 on 2023-10-25 03:43_

Can we give this file a more descriptive name, and documentation at the top around what it does?

---

_Review comment by @charliermarsh on `crates/puffin-dispatch/src/lib.rs`:26 on 2023-10-25 03:45_

Can we please add documentation for this struct? On first glance, it's not clear what it's for, or even what the crate itself is for.

---

_Review comment by @charliermarsh on `crates/puffin-installer/src/unzipper.rs`:70 on 2023-10-25 03:45_

(Could be its own PR.)

---

_Review comment by @charliermarsh on `crates/puffin-interpreter/src/lib.rs`:54 on 2023-10-25 03:46_

This to me would be more natural as `with_venv(self, venv: &Path) -> Self`.

---

_Review comment by @charliermarsh on `crates/puffin-resolver/src/source_distribution.rs`:43 on 2023-10-25 03:46_

Here and elsewhere, can we use the direct `Result` type without the `anyhow::`, for consistency with the other crates?

---

_Review comment by @charliermarsh on `crates/puffin-resolver/src/source_distribution.rs`:62 on 2023-10-25 03:51_

I find this struct strange because it doesn't actually do any cache operations, i.e., it's not itself a cache. Hmm... Could we instead just put a method like `id` on `SourceDistributionFilename`?

---

_Review comment by @charliermarsh on `crates/pep440-rs/src/version_specifier.rs`:356 on 2023-10-25 03:52_

Tempted to say we should just inline this since it's only used in one place.

---

_Review comment by @charliermarsh on `crates/puffin-dispatch/src/lib.rs`:67 on 2023-10-25 03:55_

I don't quite understand this one. What is the limitation? What does it have to do with passing `self` here?

---

_Review comment by @charliermarsh on `crates/puffin-resolver/src/resolution.rs`:172 on 2023-10-25 03:57_

Feels like this should be a `From` implementation but maybe that's strange when we don't have a wrapper type for `Vec<Requirement>`.

---

_@charliermarsh reviewed on 2023-10-25 03:58_

Nice, this looks like good progress. I have comments but not requesting any major refactoring -- mostly small things. I think we can move forward with this general structure and refine it from here.

---

_@konstin reviewed on 2023-10-25 09:03_

---

_Review comment by @konstin on `crates/puffin-build/src/lib.rs`:288 on 2023-10-25 09:03_

We need to parse the `WheelFilename`, this avoids two unwraps later

---

_@konstin reviewed on 2023-10-25 09:06_

---

_Review comment by @konstin on `crates/puffin-cli/src/commands/pip_compile.rs`:56 on 2023-10-25 09:06_

We need to clone either the `python` or the `markers` as the build context needs an owned `PythonExecutable` (it's not worth the trait async lifetime problems we get otherwise).

---

_@konstin reviewed on 2023-10-25 09:10_

---

_Review comment by @konstin on `crates/puffin-dispatch/src/lib.rs`:1 on 2023-10-25 09:10_

clippy complains that's there's an unstable `Iterator::intersperse` that would shadow `Itertools::intersperse` if stabilized, but there's no activity of that happening and also it would be nice because it would just move the itertools features to std. (extended the comment.)

---

_@konstin reviewed on 2023-10-25 09:24_

---

_Review comment by @konstin on `scripts/pypi_top8k/download.sh`:5 on 2023-10-25 09:24_

yes that shouldn't have been in there

---

_@konstin reviewed on 2023-10-25 09:31_

---

_Review comment by @konstin on `vendor/pubgrub/src/internal/partial_solution.rs`:150 on 2023-10-25 09:31_

https://github.com/pubgrub-rs/pubgrub/pull/137

---

_@konstin reviewed on 2023-10-25 09:35_

---

_Review comment by @konstin on `crates/puffin-dispatch/src/lib.rs`:12 on 2023-10-25 09:35_

Oh it's only pubgrub using log and everywhere else is tracing, much better!

---

_Review comment by @konstin on `crates/puffin-dispatch/src/lib.rs`:117 on 2023-10-25 10:10_

I've been thinking about this a bunch and i want to merge code, the main question is: How do we want to handle reporting/logging in nested builds? I'd expect that we only want to show something like `sdist_only_package(build)` in the progress bar by default, but show each step (unpacking, installing requirements, building, etc.) in verbose mode. To avoid increasing scope even further, i went with the easy solution here, but i'm happy to refactor this.

On that note, we also need a more general in flight type to avoid parallel wheel downloads, unpacks or sdist builds which currently happen (e.g. setuptools gets downloaded and unpacked in parallel into the cache even though one instance would be enough)

---

_@konstin reviewed on 2023-10-25 10:10_

---

_@konstin reviewed on 2023-10-25 10:16_

---

_Review comment by @konstin on `crates/puffin-build-cli/.gitignore`:2 on 2023-10-25 10:16_

Move it around a bit, i expect this to be replaced by a proper test harness anyway

---

_@konstin reviewed on 2023-10-25 11:04_

---

_Review comment by @konstin on `crates/puffin-dispatch/src/lib.rs`:26 on 2023-10-25 11:04_

Went for item level documentation over module/crate level because they are easier to discover from your IDE and easier to link

![image](https://github.com/astral-sh/puffin/assets/6826232/01b1a5fd-2551-4b79-ac12-a1b891b91917)

![image](https://github.com/astral-sh/puffin/assets/6826232/4d5b4d0e-3f23-4889-b6f5-e19f92ee37d7)



---

_@konstin reviewed on 2023-10-25 11:06_

---

_Review comment by @konstin on `crates/puffin-installer/src/unzipper.rs`:70 on 2023-10-25 11:06_

Fair; mostly doing it here because we hit that because with the build requires (we lack an in flight abstraction for downloads atm as far as i can see)

---

_@konstin reviewed on 2023-10-25 11:18_

---

_Review comment by @konstin on `crates/puffin-resolver/src/source_distribution.rs`:62 on 2023-10-25 11:18_

I wanted a central abstraction that know the structure of the built wheel cache. It's half baked because i want to move towards a more centralized cache abstraction in the future anyway, for know i put the `find_wheel` part on it also so it at least acts as a cache abstraction.

---

_@konstin reviewed on 2023-10-25 11:19_

---

_Review comment by @konstin on `crates/pep440-rs/src/version_specifier.rs`:356 on 2023-10-25 11:19_

We can't allow construction arbitrary `VersionSpecifier` instances because e.g. `foo!=1.2.*` is banned, this avoids unwrapping from `VersionSpecifier::new`.

---

_@konstin reviewed on 2023-10-25 11:22_

---

_Review comment by @konstin on `crates/puffin-resolver/src/resolution.rs`:172 on 2023-10-25 11:22_

Yeah, i hope this will become more clearly a graph query vs. a conversion once get more complex e.g. with root extras.

---

_@konstin reviewed on 2023-10-25 11:26_

---

_Review comment by @konstin on `crates/puffin-dispatch/src/lib.rs`:67 on 2023-10-25 11:26_

it's done, i forgot to remove the comment

---

_Comment by @konstin on 2023-10-25 11:31_

I think i've addressed all comments

---

_Comment by @charliermarsh on 2023-10-25 13:43_

Cool, thanks! I'll give this another read later today and will merge it if you're offline at that point.

---

_Merged by @charliermarsh on 2023-10-25 20:05_

---

_Closed by @charliermarsh on 2023-10-25 20:05_

---

_Branch deleted on 2023-10-25 20:05_

---
