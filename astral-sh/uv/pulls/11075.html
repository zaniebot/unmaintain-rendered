<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uv-resolver: fix conflicting extra bug during `uv sync` - astral-sh/uv #11075</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>uv-resolver: fix conflicting extra bug during <code>uv sync</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/11075">#11075</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2025-01-29 18:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>In #10875, I relaxed the error checking during resolution to permit
dependencies like <code>foo[x1]</code>, where <code>x1</code> was defined to be conflicting.
In exchange, the error was, roughly speaking, moved to installation
time. This was achieved by looking at the full set of enabled extras
and checking whether any conflicts occurred. If so, an error was
reported. This ends up being more expressive and permits more valid
configurations.</p>
<p>However, in so doing, there was a bug in how the accumulated extras
were being passed to conflict marker evaluation. Namely, we weren&#x27;t
accounting for the fact that if <code>foo[x1]</code> was enabled, then that fact
should be carried through to all conflict marker evaluations. This is
because some of those will use things like <code>extra != &#x27;x1&#x27;</code> to indicate
that it should only be included if an extra <em>isn&#x27;t</em> enabled.</p>
<p>In #10985, this manifested with PyTorch where <code>torch==2.4.1</code> and
<code>torch==2.4.1+cpu</code> were being installed simultaneously. Namely, the
choice to install <code>torch==2.4.1</code> was not taking into account that
the <code>cpu</code> extra has been enabled. If it did, then it&#x27;s conflict
marker would evaluate to <code>false</code>. Since it didn&#x27;t, and since
<code>torch==2.4.1+cpu</code> was also being included, we ended up installing both
versions.</p>
<p>The approach I took in this PR was to add a second breadth first
traversal (which comes first) over the dependency tree to accumulate all
of the activated extras. Then, only in the second traversal do we
actually build up the resolution graph.</p>
<p>Unfortunately, I have no automatic regression test to include here. The
regression test we <em>ought</em> to include involves <code>torch</code>. And while we are
generally find to use those in tests that only generate a lock file, the
regression test here actually requires running installation. And
downloading and installing <code>torch</code> in tests is bad juju. So adding a
regression test for this is blocked on better infrastructure for PyTorch
tests. With that said, I did manually verify that the test case in #10985
no longer installs multiple versions of <code>torch</code>.</p>
<p>Fixes #10985</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-01-29 18:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-01-29 18:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2025-01-29 20:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-01-29 22:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-01-29 22:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-29 22:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:50:35 UTC
    </footer>
</body>
</html>
