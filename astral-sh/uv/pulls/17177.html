<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improve reliability of certain managed python tests on Windows CI - astral-sh/uv #17177</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Improve reliability of certain managed python tests on Windows CI</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/17177">#17177</a>
        opened by <a href="https://github.com/EliteTK">@EliteTK</a>
        on 2025-12-18 15:44
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/EliteTK">@EliteTK</a> on 2025-12-18 15:44</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Results:</p>
<p>| Test                                                         | Time before | Time after |       Change |
| ------------------------------------------------------------ | -----------:| ----------:| ------------:|
| install_lower_patch_automatically                            | 79.317s     | 20.093s    | <strong>-59.200s</strong> |
| install_multiple_patches                                     | 70.086s     | 20.126s    | <strong>-50.000s</strong> |
| install_no_transparent_upgrade_with_venv_patch_specification | 47.971s     |  9.607s    | <strong>-38.400s</strong> |
| install_transparent_patch_upgrade_uv_venv                    | 74.886s     | 12.600s    | <strong>-62.300s</strong> |
| install_transparent_patch_upgrade_venv_module                | 57.888s     | 10.854s    | <strong>-47.000s</strong> |
| python_find_prerelease                                       | 78.424s     | 18.302s    | <strong>-60.100s</strong> |
| python_install                                               | 47.827s     |  4.229s    | <strong>-43.600s</strong> |
| python_install_automatic                                     | 71.138s     | 11.836s    | <strong>-59.300s</strong> |
| python_install_build_version                                 | 35.983s     |  3.214s    | <strong>-32.800s</strong> |
| python_install_build_version_pypy                            | 80.750s     | 17.774s    | <strong>-63.000s</strong> |
| python_install_cached                                        |  6.752s     |  2.247s    |   -04.500s   |
| python_install_default                                       |  3.748s     |  4.202s    |   +00.454s   |
| python_install_default_from_env                              |  2.829s     |  2.190s    |   -00.639s   |
| python_install_default_prerelease                            |  1.136s     |  0.911s    |   -00.225s   |
| python_install_default_preview                               |  5.709s     |  3.601s    |   -02.110s   |
| python_install_emulated_windows_x86_on_x64                   | 90.025s     | 35.652s    | <strong>-54.400s</strong> |
| python_install_force                                         |  1.523s     |  1.365s    |   -00.158s   |
| python_install_freethreaded                                  | 36.136s     |  4.793s    | <strong>-31.300s</strong> |
| python_install_invalid_request                               |  0.299s     |  0.269s    |   -00.030s   |
| python_install_minor                                         |  1.496s     |  1.309s    |   -00.187s   |
| python_install_multiple_patch                                |  3.033s     |  1.415s    |   -01.620s   |
| python_install_no_cache                                      |  2.853s     |  2.311s    |   -00.542s   |
| python_install_prerelease                                    |  2.018s     |  2.006s    |   -00.012s   |
| python_install_preview                                       | 40.594s     |  6.870s    | <strong>-33.700s</strong> |
| python_install_preview_no_bin                                |  1.080s     |  1.177s    |   +00.097s   |
| python_install_preview_upgrade                               |  6.609s     |  6.295s    |   -00.314s   |
| python_install_unknown                                       |  0.211s     |  0.206s    |   -00.005s   |
| python_install_upgrade                                       |  9.153s     | 10.648s    |   +01.490s   |
| python_install_upgrade_version_file                          | 55.920s     | 12.943s    | <strong>-43.000s</strong> |
| python_reinstall                                             |  4.939s     |  6.225s    |   +01.290s   |
| python_reinstall_patch                                       |  2.716s     |  2.899s    |   +00.183s   |
| python_upgrade_not_allowed                                   |  0.215s     |  0.215s    |   +00.000s   |
| regression_cpython                                           | 30.779s     |  4.403s    | <strong>-26.400s</strong> |
| uninstall_highest_patch                                      | 40.716s     |  3.790s    | <strong>-36.900s</strong> |
| uninstall_last_patch                                         | 19.093s     |  2.965s    | <strong>-16.100s</strong> |</p>
<p>Comparing https://github.com/astral-sh/uv/actions/runs/20342580132/job/58446553156?pr=17177 against https://github.com/astral-sh/uv/actions/runs/20338690535/job/58431797575.</p>
<p>Overall test time went down from 279.163s to 258.427s - presumably not related though as this should be marginally slower. Here are some local tests (on linux):</p>
<ul>
<li>just python_install:<ul>
<li>current config:<br />
<code>Summary [  34.452s] 45 tests run: 44 passed (12 slow), 1 failed, 3314 skipped</code></li>
<li><code>threads-required = &quot;num-test-threads&quot;</code>:<br />
<code>Summary [ 117.991s] 45 tests run: 44 passed (1 slow), 1 failed, 3314 skipped</code></li>
<li><code>threads-required = 4</code>:<br />
<code>Summary [  48.793s] 45 tests run: 44 passed (4 slow), 1 failed, 3314 skipped</code></li>
</ul>
</li>
<li>all tests:<ul>
<li>current config:<br />
<code>Summary [ 371.911s] 3357 tests run: 3356 passed (49 slow), 1 failed, 2 skipped</code></li>
<li><code>threads-required = &quot;num-test-threads&quot;</code>:<br />
<code>Summary [ 451.323s] 3357 tests run: 3356 passed (26 slow), 1 failed, 2 skipped</code></li>
<li><code>threads-required = 4</code>:<br />
<code>Summary [ 386.213s] 3357 tests run: 3356 passed (31 slow), 1 failed, 2 skipped</code></li>
</ul>
</li>
</ul>
<p>(Failed test is not related)</p>
<h3>Conclusion</h3>
<p>I think this is a good way to gain more reliability for these tests on all platforms, but I am not certain that we should be setting this override in the config. I think realistically you want something more like <code>num-test-threads / 3</code> rather than just <code>4</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">no-build</span> added by @EliteTK on 2025-12-18 15:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Attempt to improve reliability of python_install tests" to "Improve `python_install` test reliability on Windows" by @EliteTK on 2025-12-18 17:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @EliteTK on 2025-12-18 17:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">no-build</span> removed by @EliteTK on 2025-12-18 17:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @EliteTK on 2025-12-18 17:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @EliteTK on 2025-12-18 17:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-18 17:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.config/nextest.toml</code>:22 on 2025-12-18 17:31</div>
            <div class="timeline-body"><p>There are also python upgrade and python find tests that use managed versions. Can we tie this to the <code>managed-python</code> feature instead somehow?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>.config/nextest.toml</code>:22 on 2025-12-18 17:34</div>
            <div class="timeline-body"><p>I can't see a way to do it per-feature <code>https://nexte.st/docs/filtersets/reference/</code>.</p>
<p>We could just select more tests manually.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-18 17:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EliteTK">@EliteTK</a> on 2025-12-18 17:36</div>
            <div class="timeline-body"><p>Looks like it's only half working now...?</p>
<p>(after the change to using <code>max-threads</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-18 17:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.config/nextest.toml</code>:22 on 2025-12-18 17:39</div>
            <div class="timeline-body"><p>I think we'd need to move the tests to a specific package or something. I just worry this is brittle long-term.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-18 17:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.config/nextest.toml</code>:22 on 2025-12-18 17:39</div>
            <div class="timeline-body"><p>(the <code>native_auth</code> filter is also bothersome and janky)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EliteTK">@EliteTK</a> on 2025-12-18 18:17</div>
            <div class="timeline-body"><p>Okay, it looks like <code>max-threads = N</code> will limit the number of concurrent runs of that group of tests. But that limit only applies to that group. So if you're currently executing <code>N</code> threads worth of work from a group, nextest will fill <code>num-test-threads - N</code> worth of slots with other work, which isn't exactly what we want here...</p>
<p><img width="2764" height="466" alt="image" src="https://github.com/user-attachments/assets/f907831b-b5e6-45ce-a0f6-9aa51cdfe52d" /></p>
<p>Whereas, if you have a bunch of tests with <code>threads-required = num-test-threads / N</code>, they will prevent anything else from running until nextest reaches almost the end of that block of tests. (which is actually not exactly what we want either, but it's closer)</p>
<p>It would be good if nextest had a way of running these completely separately... I think for now maybe we can just use <code>threads-required = 4</code>...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @EliteTK on 2025-12-18 18:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EliteTK">@EliteTK</a> on 2025-12-18 19:05</div>
            <div class="timeline-body"><p>Original results with an extra columns for max-threads and for serialising all the python_install tests:</p>
<p>| Test                                         | Current |  Heavy | Change | max-threads | Change | Serial | Change |
| -------------------------------------------- | -------:| ------:| ------:| -----------:| ------:| ------:| ------:|
| <code>install_lower_patch_automatically</code>          | 79.317s | 20.093 | -74.7% |      37.393 | -52.9% | 40.937 | -48.4% |
| <code>install_multiple_patches</code>                   | 70.086s | 20.126 | -71.3% |      61.599 | -12.1% | 12.926 | -81.6% |
| <code>install_no_transparent_...</code>                 | 47.971s |  9.607 | -80.0% |      53.257 |  11.0% |  5.193 | -89.2% |
| <code>install_transparent_..._uv_venv</code>            | 74.886s | 12.600 | -83.2% |      20.155 | -73.1% |  8.228 | -89.0% |
| <code>install_transparent_..._venv_module</code>        | 57.888s | 10.854 | -81.2% |      16.659 | -71.2% | 18.331 | -68.3% |
| <code>python_find_prerelease</code>                     | 78.424s | 18.302 | -76.7% |      21.267 | -72.9% | 14.981 | -80.9% |
| <code>python_install</code>                             | 47.827s |  4.229 | -91.2% |       6.091 | -87.3% |  3.238 | -93.2% |
| <code>python_install_automatic</code>                   | 71.138s | 11.836 | -83.4% |      19.308 | -72.9% |  4.717 | -93.4% |
| <code>python_install_build_version</code>               | 35.983s |  3.214 | -91.1% |       6.757 | -81.2% |  1.910 | -94.7% |
| <code>python_install_build_version_pypy</code>          | 80.750s | 17.774 | -78.0% |      22.177 | -72.5% |  1.736 | -97.9% |
| <code>python_install_cached</code>                      |  6.752s |  2.247 | -66.7% |       3.543 | -47.5% |  1.960 | -71.0% |
| <code>python_install_default</code>                     |  3.748s |  4.202 |  12.1% |       3.846 |   2.6% |  2.599 | -30.7% |
| <code>python_install_default_from_env</code>            |  2.829s |  2.190 | -22.6% |       3.402 |  20.3% |  1.860 | -34.3% |
| <code>python_install_default_prerelease</code>          |  1.136s |  0.911 | -19.8% |       1.799 |  58.4% |  0.840 | -26.1% |
| <code>python_install_default_preview</code>             |  5.709s |  3.601 | -36.9% |       5.788 |   1.4% |  3.421 | -40.1% |
| <code>python_install_emulated_windows_x86_on_x64</code> | 90.025s | 35.652 | -60.4% |      48.517 | -46.1% |  3.824 | -95.8% |
| <code>python_install_force</code>                       |  1.523s |  1.365 | -10.4% |       2.037 |  33.7% |  1.041 | -31.6% |
| <code>python_install_freethreaded</code>                | 36.136s |  4.793 | -86.7% |      10.325 | -71.4% |  2.656 | -92.6% |
| <code>python_install_invalid_request</code>             |  0.299s |  0.269 | -10.0% |       0.802 | 168.2% |  0.253 | -15.4% |
| <code>python_install_minor</code>                       |  1.496s |  1.309 | -12.5% |       2.391 |  59.8% |  1.255 | -16.1% |
| <code>python_install_multiple_patch</code>              |  3.033s |  1.415 | -53.3% |       3.268 |   7.7% |  1.421 | -53.1% |
| <code>python_install_no_cache</code>                    |  2.853s |  2.311 | -19.0% |       3.893 |  36.5% |  1.865 | -34.6% |
| <code>python_install_prerelease</code>                  |  2.018s |  2.006 |  -0.6% |       3.546 |  75.7% |  1.657 | -17.9% |
| <code>python_install_preview</code>                     | 40.594s |  6.870 | -83.1% |      32.439 | -20.1% |  4.958 | -87.8% |
| <code>python_install_preview_no_bin</code>              |  1.080s |  1.177 |   9.0% |       1.479 |  36.9% |  0.881 | -18.4% |
| <code>python_install_preview_upgrade</code>             |  6.609s |  6.295 |  -4.8% |       7.962 |  20.5% |  3.882 | -41.3% |
| <code>python_install_unknown</code>                     |  0.211s |  0.206 |  -2.4% |       0.285 |  35.1% |  0.197 |  -6.6% |
| <code>python_install_upgrade</code>                     |  9.153s | 10.648 |  16.3% |      13.040 |  42.5% |  7.188 | -21.5% |
| <code>python_install_upgrade_version_file</code>        | 55.920s | 12.943 | -76.9% |      33.699 | -39.7% |  2.494 | -95.5% |
| <code>python_reinstall</code>                           |  4.939s |  6.225 |  26.0% |       7.859 |  59.1% |  3.988 | -19.3% |
| <code>python_reinstall_patch</code>                     |  2.716s |  2.899 |   6.7% |       4.737 |  74.4% |  2.568 |  -5.4% |
| <code>python_upgrade_not_allowed</code>                 |  0.215s |  0.215 |   0.0% |       0.281 |  30.7% |  0.198 |  -7.9% |
| <code>regression_cpython</code>                         | 30.779s |  4.403 | -85.7% |      14.943 | -51.5% |  1.106 | -96.4% |
| <code>uninstall_highest_patch</code>                    | 40.716s |  3.790 | -90.7% |      17.303 | -57.5% |  2.263 | -94.4% |
| <code>uninstall_last_patch</code>                       | 19.093s |  2.965 | -84.5% |       4.293 | -77.5% |  1.674 | -91.2% |</p>
<p>Some of this could be noise, but some tests seem to be slow running when ran with a bunch of other tests, and some seem to be very slow only with other python_install tests. But most seem to fall into the latter group.</p>
<p>As a bonus, however, in a full run with no filters, there seems to be almost no overhead to running these all as serialised.</p>
<p>(Updated with change %)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-18 19:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>.config/nextest.toml</code>:22 on 2025-12-18 19:12</div>
            <div class="timeline-body"><p>Yeah putting them in a specific package would let us filter on them. Maybe something for an issue and a separate PR though?</p>
<p>I will add <code>python_upgrade</code>. But for <code>python_find</code>, there are only 8 tests in there which seem to install python. Seems kind of heavy handed to add the whole module. There are also a bunch of other places in the tests where <code>python_install</code> or <code>python_upgrade</code> are called.</p>
<p>One option I guess we could consider is tagging the tests via their name. E.g. by putting any such tests within a <code>py_install</code> sub module and then matching on &quot;::py_install::&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">windows</span> added by @EliteTK on 2025-12-18 19:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-22 21:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>.config/nextest.toml</code>:22 on 2025-12-22 21:00</div>
            <div class="timeline-body"><p>For now I've just added python_upgrade and python_find and made the test more specific but I think adding markers to the test module paths wouldn't be a terrible idea.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Improve `python_install` test reliability on Windows" to "Improve reliability of certain managed python tests on Windows CI" by @EliteTK on 2025-12-22 21:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @EliteTK on 2025-12-22 21:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @EliteTK on 2025-12-22 21:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2025-12-22 21:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-22 21:41</div>
            <div class="timeline-body"><p>Unfortunately this will miss, e.g., your new test case in https://github.com/astral-sh/uv/pull/17218</p>
<p>We should think about how we can do better in the future. Maybe we should even just write a tool that generates the nextest config from feature flagged tests, if we can?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @EliteTK on 2025-12-29 13:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @EliteTK on 2025-12-29 13:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-29 13:24</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 05:52:40 UTC
    </footer>
</body>
</html>
