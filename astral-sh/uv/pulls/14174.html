<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lock the source tree when running setuptools, to protect concurrent builds - astral-sh/uv #14174</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Lock the source tree when running setuptools, to protect concurrent builds</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/14174">#14174</a>
        opened by <a href="https://github.com/oconnor663">@oconnor663</a>
        on 2025-06-20 23:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/oconnor663">@oconnor663</a></div>
            <div class="timeline-body"><p>Fixes <a href="https://github.com/astral-sh/uv/issues/13703">astral-sh/uv#13703</a>.</p>
<p>If I repeat the repro steps from <a href="https://github.com/astral-sh/uv/issues/13703#issuecomment-2993000368">my comment on that issue</a> with this PR, the errors are gone:</p>
<pre><code>$ cat &gt;setup.py &lt;&lt;EOF
import setuptools
setuptools.setup(name=&quot;scratch&quot;, version=&quot;4&quot;)
EOF
$ for i in `seq 10` ; do
    ~/uv/target/fast-build/uv build --wheel &amp;
done
[...lots of build output, no errors...]
</code></pre>
<p>There&#x27;s also no performance impact:</p>
<pre><code>$ hyperfine &quot;/tmp/before build --wheel&quot; &quot;/tmp/after build --wheel&quot;
Benchmark 1: /tmp/before build --wheel
  Time (mean ± σ):     255.8 ms ±   3.0 ms    [User: 225.7 ms, System: 41.5 ms]
  Range (min … max):   251.4 ms … 260.5 ms    11 runs

Benchmark 2: /tmp/after build --wheel
  Time (mean ± σ):     255.3 ms ±   2.6 ms    [User: 219.7 ms, System: 47.3 ms]
  Range (min … max):   252.8 ms … 262.0 ms    11 runs

Summary
  /tmp/after build --wheel ran
    1.00 ± 0.02 times faster than /tmp/before build --wheel
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-06-20 23:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-06-20 23:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-06-21 00:18</div>
            <div class="timeline-body"><p>I don&#x27;t think locking the <em>output</em> directory is actually sufficient because IIRC setuptools uses a build directory in the <em>source</em> directory? So, like, concurrent builds to different output directories would still fail?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-06-21 00:41</div>
            <div class="timeline-body"><p>Ah true, I still get failures with something like this:</p>
<pre><code>$ for i in `seq 10` ; do
    ~/uv/target/fast-build/uv build --wheel --out-dir /tmp/mybuild$i &amp;
done
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-06-23 21:50</div>
            <div class="timeline-body"><p>I&#x27;ve switched to locking (the hash of) the source dir. The following now succeeds with no errors, and the builds run in series:</p>
<pre><code>$ cat &gt;setup.py &lt;&lt;EOF
import setuptools
setuptools.setup(name=&quot;scratch&quot;, version=&quot;4&quot;)
EOF
$ for i in `seq 10` ; do
    ~/uv/target/fast-build/uv build --wheel --out-dir `mktemp -d` &amp;
done
</code></pre>
<p>I&#x27;m considering refactoring this a bit to stop putting so many file locks directly in /tmp. Going to put another PR on top of this one, which we can take or not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Make `uv build` lock its output dir, to prevent concurrent builds from interfering&quot; to &quot;Make `uv build` lock its source dir, to prevent concurrent builds from interfering&quot; by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-06-23 22:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-06-23 22:08</div>
            <div class="timeline-body"><p>@zanieb suggested that special-casing <code>setuptools</code> might make more sense than taking a lock under <code>/tmp</code>. I&#x27;m going to look into that. (In that case we could still choose to take <a href="https://github.com/astral-sh/uv/pull/14225">astral-sh/uv#14225</a>, but it would no longer be related to this RP.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Make `uv build` lock its source dir, to prevent concurrent builds from interfering&quot; to &quot;Lock the source tree when running setuptools, to protect concurrent builds&quot; by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-06-25 18:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-06-25 18:43</div>
            <div class="timeline-body"><p>Just put up a new iteration. I&#x27;ve kept the same locking strategy (a <code>cache_digest</code>-named file under <code>temp_dir()</code>), but I&#x27;ve made it specific to setuptools, and we take the lock before we invoke any setuptools commands, including <code>get_requires_for...</code>. I noticed that even that read-only-sounding command creates <code>*.egg-info</code>, and even though I haven&#x27;t seen that lead to failures when multiple processes do it at once, it seems safer to protect it. @konstin do you have time to take a look?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/oconnor663">@oconnor663</a> reviewed on 2025-06-25 18:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/oconnor663">@oconnor663</a> on <code>crates/uv-build-frontend/src/lib.rs</code>:763 on 2025-06-25 18:45</div>
            <div class="timeline-body"><p>These are drive-by cleanup.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2025-06-26 13:06</div>
            <div class="timeline-body"><p>This makes sense to me</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2025-06-26 14:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-06-26 14:18</div>
            <div class="timeline-body"><p>I&#x27;m not a huge fan of special-casing setuptools but I don&#x27;t feel strongly enough to advocate for a change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-06-26 14:18</div>
            <div class="timeline-body"><p>(Actually just ignore my comment, it&#x27;s alright.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-06-26 17:03</div>
            <div class="timeline-body"><p>(rebasing to pick up test fixes from main)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-06-26 19:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-06-26 19:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-26 19:28</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:52:46 UTC
    </footer>
</body>
</html>
