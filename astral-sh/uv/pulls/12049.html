<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Respect `--project` during virtual environment discovery - astral-sh/uv #12049</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Respect <code>--project</code> during virtual environment discovery</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/12049">#12049</a>
        opened by <a href="https://github.com/thejchap">@thejchap</a>
        on 2025-03-07 15:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/thejchap">@thejchap</a> on 2025-03-07 15:48</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Resolves #11990</p>
<ul>
<li>Updates a couple discovery-related functions to accept a directory argument, used as the root directory when searching for a virtual environment</li>
<li>Updates <code>uv python find</code> to pass the <code>--project</code> flag through to start the search for a python executable from that project, regardless of current directory</li>
</ul>
<h2>Test Plan</h2>
<ul>
<li>Snapshot tests</li>
<li>E2E (below)</li>
</ul>
<h3>Before</h3>
<pre><code class="language-sh">$ cargo run python find --directory ~/src --project example
/Users/justinchapman/.local/share/uv/python/cpython-3.13.0-macos-aarch64-none/bin/python3.13
</code></pre>
<h3>After</h3>
<pre><code class="language-sh">$ cargo run python find --directory ~/src --project example
/Users/justinchapman/src/example/.venv/bin/python3
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "respect --project during uv python find (#11990)" to "[WIP] Respect --project during `uv python find` (#11990)" by @thejchap on 2025-03-07 15:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[WIP] Respect --project during `uv python find` (#11990)" to "Respect --project during `uv python find` (#11990)" by @thejchap on 2025-03-13 04:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @thejchap on 2025-03-13 04:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @konstin on 2025-03-14 20:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @zanieb by @zanieb on 2025-03-18 23:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-03-26 19:44</div>
            <div class="timeline-body"><p>(Sorry for the delay, I'm traveling a lot this month)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thejchap">@thejchap</a> on 2025-04-04 06:45</div>
            <div class="timeline-body"><p>@zanieb anything i can do to help on this one?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-04 13:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/it/python_find.rs</code>:537 on 2025-04-04 13:46</div>
            <div class="timeline-body"><p>Why is this unix only?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-04 13:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/it/python_find.rs</code>:537 on 2025-04-04 13:47</div>
            <div class="timeline-body"><p>If it's for the snapshot path, you can do</p>
<pre><code>    context
        .with_filtered_python_names()
        .with_filtered_virtualenv_bin()
        .with_filtered_exe_suffix();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-04 13:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/it/python_find.rs</code>:636 on 2025-04-04 13:49</div>
            <div class="timeline-body"><p>You can use <code>.assert().success();</code> instead to avoid an empty snapshot.</p>
<p>We should test <code>python find --project</code> <em>before</em> creating the virtual environment. In that case, we should ensure we're respecting the <code>requires-python</code> range from the child <code>pyproject.toml</code>.</p>
<p>Then, we should test with a virtual environment.</p>
<p>Then, we should also test we respect the <code>--project</code> root for <code>.python-version</code> file discovery too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:1192 on 2025-04-04 13:53</div>
            <div class="timeline-body"><p>Should these be updated to respect <code>--project</code> / <code>--directory</code> too? Is there a good reason to do that separately?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-04 13:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/thejchap">@thejchap</a> reviewed on 2025-04-08 23:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/thejchap">@thejchap</a> on <code>crates/uv-python/src/discovery.rs</code>:1192 on 2025-04-08 23:51</div>
            <div class="timeline-body"><p>~@zanieb was wondering the same thing (in <a href="https://github.com/astral-sh/uv/issues/11990#issuecomment-2719956384">this comment</a> :) - just started to feel like blast radius was snowballing a bit - i'll dig a little more~ i misread this and got it conflated with something else</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/thejchap">@thejchap</a> on <code>crates/uv/tests/it/python_find.rs</code>:636 on 2025-04-09 02:44</div>
            <div class="timeline-body"><p>@zanieb i think i covered all the test cases - lmk if i misinterpreted something. also was getting a diff between windows and unix on <a href="https://github.com/astral-sh/uv/actions/runs/14347400247/job/40219696086?pr=12049#step:10:2515">this assertion</a> which i mitigated with <code>.with_filtered_python_sources()</code> as i don't think that particular diff matters for this test - but lmk if thats incorrect</p>
<p><img width="874" alt="Screenshot 2025-04-08 at 22 41 10" src="https://github.com/user-attachments/assets/41568fde-27c1-4166-aa61-72a4f98df7bf" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/thejchap">@thejchap</a> reviewed on 2025-04-09 02:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/thejchap">@thejchap</a> reviewed on 2025-04-16 03:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/thejchap">@thejchap</a> on <code>crates/uv-python/src/discovery.rs</code>:1192 on 2025-04-16 03:16</div>
            <div class="timeline-body"><p>@zanieb i am thinking it might be good to refactor that particular callsite separately (if for no other reason than to prevent this pr from getting too unwieldy) - i believe the only caller of <code>PythonInstallation::find_best</code> is <code>pip_compile</code> (<a href="https://github.com/thejchap/uv/blob/bug/python-find-project/crates/uv/src/commands/pip/compile.rs#L267-L267">pointer</a>) - i can add a separate issue for that if it would be helpful</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-16 15:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/installation.rs</code>:96 on 2025-04-16 15:29</div>
            <div class="timeline-body"><p>I'm surprised this uses <code>current_dir()</code> still, <code>find_or_download</code> is used in a lot of places.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:1192 on 2025-04-16 15:32</div>
            <div class="timeline-body"><p>I think https://github.com/astral-sh/uv/pull/12049/files#r2047193355 is more concerning to me</p>
<p>I do worry that if we change the behavior everywhere but <code>pip compile</code> that would be really confusing to users? I don't think we can merge this incrementally.</p>
<p>It might be worth writing up the difference here between:</p>
<ul>
<li>Respect <code>--project</code> during <code>uv python find</code></li>
</ul>
<p>and the more broad change:</p>
<ul>
<li>Use <code>--project</code> and <code>--directory</code> as the root for virtual environment discovery</li>
</ul>
<p>Is this pull request trying to do one or the other? I'm not sure it makes sense to do the first without the second. That we don't do the second one seems like a bug.</p>
<p>I do understand the concern about the increase in scope. I could probably take it over if you prefer? If we do the latter change we probably want to land it in 0.7.0 (#12843)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-16 15:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/thejchap">@thejchap</a> reviewed on 2025-04-17 04:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/thejchap">@thejchap</a> on <code>crates/uv-python/src/discovery.rs</code>:1192 on 2025-04-17 04:04</div>
            <div class="timeline-body"><p>@zanieb this is helpful thanks - just to make sure im following the potential problem with changing behavior incrementally, it would look something like:</p>
<ul>
<li>user runs <code>uv python find --project sub-project</code> to debug which python is being used to run a script in a project, it tells them <code>sub-project/.venv/bin/python3</code></li>
<li>user runs <code>uv run my-script --project sub-project</code>, and it actually gets run via another interpreter, like <code>~/.local/share/uv/python/cpython-3.13.0</code></li>
</ul>
<p>also, with the <code>--directory</code> flag, is it a known issue that venv discovery isn't happening correctly already with that? it looks to me like that just <a href="https://github.com/thejchap/uv/blob/bug/python-find-project/crates/uv/src/lib.rs#L62">changes the working directory</a> - so even though right now discovery is just looking at cwd that should work already? or are you saying that this, combined with the <code>--project</code> flag not getting propagated through to discovery results in weird behavior because <code>--project</code> isn't overriding <code>--directory</code> when it should be</p>
<p>i'll think a little on scope change if i think i'll have bandwidth to finish out by Tues</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/thejchap">@thejchap</a> reviewed on 2025-04-19 04:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/thejchap">@thejchap</a> on <code>crates/uv-python/src/discovery.rs</code>:1192 on 2025-04-19 04:45</div>
            <div class="timeline-body"><p>@zanieb <code>find_or_download</code> now takes a path argument and callsites have been updated to pass <code>--project</code> through where relevant</p>
<p>don't think ill have any more bandwidth before tuesday (ie to add tests) - but if this doesn't make it into <code>0.7.0</code> i'm happy to continue working on it later next week and the following</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/thejchap">@thejchap</a> on <code>crates/uv-python/src/discovery.rs</code>:1192 on 2025-04-25 13:53</div>
            <div class="timeline-body"><p>going to get back to this in the next day or two and will add some tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/thejchap">@thejchap</a> reviewed on 2025-04-25 13:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-25 14:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-python/src/discovery.rs</code>:1192 on 2025-04-25 14:15</div>
            <div class="timeline-body"><blockquote>
<p>it looks to me like that just <a href="https://github.com/thejchap/uv/blob/bug/python-find-project/crates/uv/src/lib.rs#L62">changes the working directory</a> - so even though right now discovery is just looking at cwd that should work already?</p>
</blockquote>
<p>That makes sense to me — I would believe that's already working as expected.</p>
<blockquote>
<p>user runs uv run my-script --project sub-project, and it actually gets run via another interpreter, like ~/.local/share/uv/python/cpython-3.13.0</p>
</blockquote>
<p>Yeah, this is what I'm worried about. <code>uv python find --project ...</code> should return the same interpreter that would be used in <code>uv run --project ...</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thejchap">@thejchap</a> on 2025-05-11 18:30</div>
            <div class="timeline-body"><p>@zanieb sorry for the delay on this one - decided to work on <code>ty</code> a bit</p>
<p>what would you recommend as a reliable way to test which python interpreter was used during <code>pip compile</code>? i looked in a couple test suites and wasn't able to find any obvious examples - unless i'm thinking about testing wrong here</p>
<p>what i did initially was set the test <code>.pip_compile()</code> to verbose via <code>.arg(&quot;-v&quot;)</code> then checked for a debug message, but that seems like it could be brittle - also appears the test context filters don't get applied to debug messages so was also running into issues with the windows tests</p>
<p>any code pointers/examples/advice here would be helpful, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-05-17 01:54</div>
            <div class="timeline-body"><blockquote>
<p>sorry for the delay on this one - decided to work on ty a bit</p>
</blockquote>
<p>No problem! I've been slow to reply anyway :)</p>
<blockquote>
<p>what would you recommend as a reliable way to test which python interpreter was used during pip compile? i looked in a couple test suites and wasn't able to find any obvious examples - unless i'm thinking about testing wrong here</p>
</blockquote>
<p>I would do like</p>
<pre><code>anyio==3.0.0; python_version &gt;= &quot;3.12&quot;
anyio==4.0.0; python_version &lt; &quot;3.12&quot;
</code></pre>
<p>Then the test should toggle the compiled version</p>
<pre><code>❯ echo 'anyio==3.0.0; python_version &gt;= &quot;3.12&quot;\nanyio==4.0.0; python_version &lt; &quot;3.12&quot;' | uv pip compile - -p 3.12
Resolved 3 packages in 5ms
# This file was autogenerated by uv via the following command:
#    uv pip compile - -p 3.12
anyio==3.0.0
idna==3.10
    # via anyio
sniffio==1.3.1
    # via anyio
❯ echo 'anyio==3.0.0; python_version &gt;= &quot;3.12&quot;\nanyio==4.0.0; python_version &lt; &quot;3.12&quot;' | uv pip compile - -p 3.11
Resolved 3 packages in 6ms
# This file was autogenerated by uv via the following command:
#    uv pip compile - -p 3.11
anyio==4.0.0
idna==3.10
    # via anyio
sniffio==1.3.1
    # via anyio
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-05-17 01:54</div>
            <div class="timeline-body"><p>(I'd maybe swap so the &quot;newer&quot; anyio matches the &quot;newer&quot; Python)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Respect --project during `uv python find` (#11990)" to "Respect `--project` during virtual environment discovery" by @zanieb on 2025-05-27 17:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-05-27 17:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/pip/compile.rs</code>:278 on 2025-05-27 17:16</div>
            <div class="timeline-body"><p>Why not use <code>project_dir</code> here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-05-27 17:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/run.rs</code>:238 on 2025-05-27 17:17</div>
            <div class="timeline-body"><p>We should probably move this so it comes before the printer. Stylistically, that's always been the last argument? I don't know how much it matters.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-05-27 17:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/python/list.rs</code>:128 on 2025-05-27 17:17</div>
            <div class="timeline-body"><p>This command does support the <code>--project</code> flag, I guess we should respect it? I'm not sure it matters here but it could bite someone later?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thejchap">@thejchap</a> on 2025-05-27 20:19</div>
            <div class="timeline-body"><p>@zanieb still working my way through all the commands- sorry should have moved this back to draft</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @thejchap on 2025-05-27 20:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-05-31 15:24</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_WALLTIME_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/uv/branches/thejchap%3Abug%2Fpython-find-project">CodSpeed Walltime Performance Report</a></h2>
<h3>Merging #12049 will <strong>improve performances by 15.79%</strong></h3>
<p><sub>Comparing <code>thejchap:bug/python-find-project</code> (5e5207c) with <code>main</code> (13a86a2)</sub></p>
<h3>Summary</h3>
<p><code>⚡ 1</code> improvements<br />
<code>✅ 11</code> untouched benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>wheelname_parsing_failure[flyte-long-extension]</code> | 110 ns | 95 ns | +15.79% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thejchap">@thejchap</a> on 2025-05-31 15:35</div>
            <div class="timeline-body"><p>@zanieb i should probably hand this one off - i don't think the scope increase is a good match for my availability anymore (each time i've picked it up i've spend most of the time i had available resolving merge conflicts :)</p>
<p>i've been going through command by command and passing <code>project_dir</code> through and adding tests, if i had to guess i'd say i'm probably halfway through?</p>
<p>one thing i noticed that i probably would have done next is updated <a href="https://github.com/thejchap/uv/blob/5e5207c09fb1a71c7481a08af137fddf1e3ba41d/crates/uv/tests/it/common/mod.rs#L220">TestContext::with_filtered_virtualenv_bin</a> to also work for filtering out venvs in a different project directory (or added a new helper) - didn't yet have a nice way to test this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @thejchap on 2025-05-31 15:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-06-02 15:59</div>
            <div class="timeline-body"><p>Thanks for the update!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thejchap">@thejchap</a> on 2025-06-14 21:12</div>
            <div class="timeline-body"><p>@zanieb was thinking about this a little more - could it make sense to pass project dir to the remaining few commands and merge this, then add an issue to continue improving test coverage when passing in an explicit project arg?</p>
<p>Test coverage is the main thing that's been slow going because of the # of commands the change is touching, but seems like there could still be some value in the additional coverage and the behavior change as it is currently?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @thejchap on 2025-08-04 11:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:21 UTC
    </footer>
</body>
</html>
