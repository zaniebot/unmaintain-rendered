<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add hashes and versions to all distributions - astral-sh/uv #3589</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add hashes and versions to all distributions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/3589">#3589</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-05-14 19:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>In <code>ResolutionGraph::from_state</code>, we have mechanisms to grab the hashes and metadata for all distributions -- but we then throw that information away. This PR preserves it on a new <code>AnnotatedDist</code> (yikes, open to suggestions) that wraps <code>ResolvedDist</code> and includes (1) the hashes (computed or from the registry) and (2) the <code>Metadata23</code>, which lets us extract the version.</p>
<p>Closes <a href="https://github.com/astral-sh/uv/issues/3356">astral-sh/uv#3356</a>.</p>
<p>Closes <a href="https://github.com/astral-sh/uv/issues/3357">astral-sh/uv#3357</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/BurntSushi">@BurntSushi</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-14 19:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ibraheemdev">@ibraheemdev</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-14 19:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-14 19:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-14 19:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-14 19:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/lock.rs</code>:619 on 2024-05-14 19:27</div>
            <div class="timeline-body"><p>Don&#x27;t love making <code>hashes</code> an argument everywhere but seemed like the most straightforward option (since it only exists on <code>AnnotatedDist</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> approved on 2024-05-14 20:15</div>
            <div class="timeline-body"><p>Looks good, don&#x27;t have strong opinions about the naming. Does <code>LockedDist</code> make sense because it&#x27;s locked to a specific version..?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-14 20:29</div>
            <div class="timeline-body"><p>üëç I&#x27;m gonna defer to @BurntSushi on the names since he has the bigger picture in his head w/r/t the other structs in <code>lock.rs</code> etc.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-resolver/src/lock.rs</code>:619 on 2024-05-14 22:26</div>
            <div class="timeline-body"><p>Yeah hmmm, I don&#x27;t like it either.</p>
<p>I think when I was writing this, I was assuming the hashes would be added to types like <code>PathSourceDist</code> directly. Out of curiosity, why didn&#x27;t you take that approach? AIUI, hashes are on <em>some</em> of the distribution types but not all of them. I was thinking we would make that a bit more consistent.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-resolver/src/lock.rs</code>:647 on 2024-05-14 22:26</div>
            <div class="timeline-body"><p>Is there a difference between the hash on the annotated dist versus the hash that&#x27;s already on the <code>RegistrySourceDist</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-resolver/src/resolution.rs</code>:277 on 2024-05-14 22:29</div>
            <div class="timeline-body"><p>I don&#x27;t love these panics. (I think some like this were already in this code though.) I think this circles back to my idea of putting this data on the distribution types. Maybe that would lead to increased memory usage though? Not sure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/uv-resolver/src/resolution.rs</code>:335 on 2024-05-14 22:30</div>
            <div class="timeline-body"><p>Not necessarily asking for any changes here, but just a &quot;shout out loud&quot;: I feel like I&#x27;ve seen this pattern a lot where the code for processing distributions repeats itself. This looks almost identical to the metadata extraction above for example. (I don&#x27;t yet have opinions on how to resolve this or even if it&#x27;s worth resolving.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2024-05-14 22:32</div>
            <div class="timeline-body"><p>I&#x27;m okay with this coming in as-is. I don&#x27;t think I see anything wrong, although I don&#x27;t love the code structure/organization. I elaborated a bit in the comments. It is possible that I might have some gaps in my understanding though, so I could have misguided opinions here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-14 22:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/lock.rs</code>:655 on 2024-05-14 22:51</div>
            <div class="timeline-body"><p>So... IIUC, <code>hashes</code> can be two different things. If the distribution comes from a registry, it&#x27;s the list of hashes served by the registry. If the distribution comes from elsewhere, it&#x27;s the hashes we <em>computed</em>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-14 22:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/resolution.rs</code>:335 on 2024-05-14 22:54</div>
            <div class="timeline-body"><p>Yeah it&#x27;s nearly identical. I&#x27;m gonna look at DRYing it up.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-14 22:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/lock.rs</code>:619 on 2024-05-14 22:55</div>
            <div class="timeline-body"><p>They&#x27;re not quite the same. The hash on the registry distribution is just the hash reported by the registry, <em>not</em> the hash we compute locally. And the distribution exists well before we compute its hashes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/lock.rs</code>:647 on 2024-05-14 22:59</div>
            <div class="timeline-body"><p>In this case I think we should just ignore the hashes from the annotated dist here actually.</p>
<p>The hash on the <code>RegistrySourceDist</code> is the hash reported by the registry for that specific distribution (file). The hashes on the annotated dist will be the collection of all hashes for all distributions in the registry.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-14 22:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-14 23:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/resolution.rs</code>:277 on 2024-05-14 23:01</div>
            <div class="timeline-body"><p>We can <em>maybe</em> put it on <code>ResolvedDist</code>? I&#x27;d have to look, but it&#x27;d be responsible to do so separately IMO since this pattern already exists here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-14 23:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/resolution.rs</code>:335 on 2024-05-14 23:01</div>
            <div class="timeline-body"><p>Sorry, to be clear: it&#x27;s exactly the same. They&#x27;re different arms in a match.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-14 23:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/lock.rs</code>:619 on 2024-05-14 23:03</div>
            <div class="timeline-body"><p>We don&#x27;t compute hashes for registry distributions during resolution. We only <em>validate</em> them during installation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-14 23:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-14 23:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-14 23:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-resolver/src/resolution.rs</code>:277 on 2024-05-14 23:07</div>
            <div class="timeline-body"><p>Hmm, no, because we need to be able to go from compatible dist to resolved dist... At some point we need to merge the metadata with the distribution, and I guess that&#x27;s here (for now, at least).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-05-14 23:07</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:45:20 UTC
    </footer>
</body>
</html>
