<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>feat: move to cargo-xwin for clippy - astral-sh/uv #3600</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>feat: move to cargo-xwin for clippy</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/3600">#3600</a>
        opened by <a href="https://github.com/samypr100">@samypr100</a>
        on 2024-05-15 03:19
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a></div>
            <div class="timeline-body">Summary
<p>Move to cargo-xwin for clippy</p>
<p>Closes #3507</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/messense">@messense</a> on 2024-05-15 03:45</div>
            <div class="timeline-body"><p>FYI, consider install <code>cargo-xwin</code> from pypi or github releases to avoid compiling it. And you should try to cache Windows SDK download by explicitly setting <code>XWIN_CACHE_DIR</code> and cache it via the cache action.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-15 03:47</div>
            <div class="timeline-body"><p>Would cargo-binstall work or no?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/messense">@messense</a> on 2024-05-15 03:48</div>
            <div class="timeline-body"><p>probably works, I never tried.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/messense">@messense</a> on 2024-05-15 03:49</div>
            <div class="timeline-body"><p>BTW, I think you forgot to use a Linux runner? otherwise using <code>cargo-xwin</code> on Windows isn&#x27;t beneficial?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2024-05-15 04:07</div>
            <div class="timeline-body"><p>Indeed, was trying to gather some baseline data on windows first ðŸ˜…; numbers don&#x27;t look too promising thus far.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-05-15 04:09</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/uv/branches/samypr100:cargo-xwin-clippy">CodSpeed Performance Report</a>
Merging #3600 will <strong>not alter performance</strong>
<p>Comparing <code>samypr100:cargo-xwin-clippy</code> (aa61db7) with <code>main</code> (ed91b1d)</p>
Summary
<p><code>âœ… 12</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-05-15 12:59</div>
            <div class="timeline-body"><p>The clippy step is 12:30min while clippy itself takes 30s, do you know where the other 12min are? The xwin download and unpack are &lt;2min on my machine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/samypr100">@samypr100</a> on 2024-05-15 13:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/messense">@messense</a> on 2024-05-15 13:30</div>
            <div class="timeline-body"><blockquote>
<p>do you know where the other 12min are?</p>
</blockquote>
<p>Probably because the network connection from GH action to Windows SDK download isn&#x27;t very good,  cached version is much better.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/konstin">@konstin</a> on 2024-05-15 13:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-05-15 13:33</div>
            <div class="timeline-body"><p>Clippy itself takes 30s, the whole job 1:30min, great work!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2024-05-15 13:40</div>
            <div class="timeline-body"><p>ðŸ˜… need to add up the totals numbers and make a table, will do later today to get better comparison.</p>
<p>At a glance on an unchached run it&#x27;s marginally worse by a quite the factor (2m-3m before vs 15 min now) ~ .
On cached runs job totals are actually about the same on both windows and linux.</p>
<p>TL;DR Seems when cache is busted the impact is much worse than it is now and we&#x27;re not gaining on job total speeds.</p>
<p>(will also explore some other fine tuning later like separating the windows sdk cache out)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-05-15 13:42</div>
            <div class="timeline-body"><p>Would moving the xwin cache into a separate cache step only keyed on <code>rust-toolchain.toml</code> help? This way the cache would only ever be invalidated when we upgrade rust</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2024-05-15 13:43</div>
            <div class="timeline-body"><blockquote>
<p>Would moving the xwin cache into a separate cache step only keyed on rust-toolchain.toml help? This way the cache would only ever be invalidated when we upgrade rust</p>
</blockquote>
<p>You read my mind ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-05-15 15:22</div>
            <div class="timeline-body"><p>We do frequently fill our cache, we&#x27;ll want to be careful that it&#x27;s not evicted often due to space limitations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2024-05-16 02:16</div>
            <div class="timeline-body"><p>Here&#x27;s some of the initial numbers to compare I&#x27;ve grabbing from all the past runs.</p>
<p>|  Current Main     | Before Cache (Step, Job)  | After Cache (Step, Job) |
|-------------------|---------------------------|-------------------------|
| Clippy on Windows | 2m~, 3m~                  | 30s~, 1.25m~            |</p>
<p>|  New Clippy Runs                         | After (Step, Job)
|-----------------------------------|------------------|
| xwin on windows                   | 2m 45s~, 5m~     |
| xwin on linux (no cache)          | 14m~, 15m~       |
| xwin on linux (rust cache)        | 12m~, 13m~       |
| xwin on linux (xwin cache)        | 2m~, 3m~         |
| xwin on linux (rust + xwin cache) | 30s~, 1.25m~     |</p>
<p>It seems clippy xwin runs about the same speed as windows currently (post the ReFS move). The job totals are aligned on best scenarios.</p>
<p>The xwin cache made the biggest difference for cargo xwin, making it run consistently with current windows runner, but it introduces a bigger risk when that cache gets busted.</p>
<p>The 15 minute hit will be most noticeable on downstream forks (where there is no cache often) or when cache is lost in main after rust toolchain upgrades or cache eviction.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-05-16 07:43</div>
            <div class="timeline-body"><p>Personally, i think this still is a noticeable improvement, it means we skip the virtual disk setup and have a windows runner less; the 15min cache priming about every 6 weeks are acceptable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/messense">@messense</a> reviewed on 2024-05-16 08:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/messense">@messense</a> on <code>.github/workflows/ci.yml</code>:86 on 2024-05-16 08:10</div>
            <div class="timeline-body"><p>I don&#x27;t think xwin cache needs to be keyed by Rust version, it&#x27;s just an unpacked Windows SDK, no Rust involved.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;feat: explore cargo-xwin for clippy&quot; to &quot;feat: move to cargo-xwin for clippy&quot; by <a href="https://github.com/samypr100">@samypr100</a> on 2024-05-17 01:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/samypr100">@samypr100</a> on 2024-05-17 01:45</div>
            <div class="timeline-body"><blockquote>
<p>Personally, i think this still is a noticeable improvement, it means we skip the virtual disk setup and have a windows runner less; the 15min cache priming about every 6 weeks are acceptable.</p>
</blockquote>
<p>Sounds good, PR is good to go now. Apologies, I thought I had this PR was in draft all this time ðŸ˜…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/samypr100">@samypr100</a> reviewed on 2024-05-17 01:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/samypr100">@samypr100</a> on <code>.github/workflows/ci.yml</code>:86 on 2024-05-17 01:46</div>
            <div class="timeline-body"><p>Thanks, moved cache key to be just <code>cargo-xwin</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/zanieb">@zanieb</a> on 2024-05-17 02:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/zanieb">@zanieb</a> on 2024-05-17 02:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-05-17 02:32</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:45:21 UTC
    </footer>
</body>
</html>
