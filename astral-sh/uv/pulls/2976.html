<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rewrite `uv-auth` - astral-sh/uv #2976</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Rewrite <code>uv-auth</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/2976">#2976</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-04-10 19:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>Closes</p>
<ul>
<li>#2822</li>
<li>https://github.com/astral-sh/uv/issues/2563 (via #2984)</li>
</ul>
<p>Partially address:</p>
<ul>
<li>https://github.com/astral-sh/uv/issues/2465</li>
<li>https://github.com/astral-sh/uv/issues/2464</li>
</ul>
<p>Supersedes:</p>
<ul>
<li>https://github.com/astral-sh/uv/pull/2947</li>
<li>https://github.com/astral-sh/uv/pull/2570 (via #2984)</li>
</ul>
<p>Some significant refactors to the whole <code>uv-auth</code> crate:</p>
<ul>
<li>Improving the API</li>
<li>Adding test coverage</li>
<li>Fixing handling of URL-encoded passwords</li>
<li>Fixing keyring authentication</li>
<li>Updated middleware (see #2984 for more)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "zb/refactor auth store" to "Refactor `uv-auth`" by @zanieb on 2024-04-10 19:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-10 19:59</div>
            <div class="timeline-body"><p>Lookee this demonstrates the fix to passwords with percent-encoded characters</p>
<pre><code class="language-diff">diff --git a/crates/uv-auth/src/credentials.rs b/crates/uv-auth/src/credentials.rs
index 9c222cff..dd1c8af8 100644
--- a/crates/uv-auth/src/credentials.rs
+++ b/crates/uv-auth/src/credentials.rs
@@ -37,11 +37,7 @@ impl Credentials {
             username: urlencoding::decode(url.username())
                 .expect(&quot;An encoded username should always decode&quot;)
                 .into_owned(),
-            password: url.password().map(|password| {
-                urlencoding::decode(password)
-                    .expect(&quot;An encoded password should always decode&quot;)
-                    .into_owned()
-            }),
+            password: url.password().map(|password| password.to_string()),
         })
     }
 }
@@ -191,7 +187,7 @@ mod test {
             .clone();
         header.set_sensitive(false);
 
-        assert_debug_snapshot!(header, @r###&quot;&quot;Basic dXNlcjpwYXNzd29yZD09&quot;&quot;###);
-        assert_snapshot!(decode_basic_auth(header), @&quot;Basic: user:password==&quot;);
+        assert_debug_snapshot!(header, @r###&quot;&quot;Basic dXNlcjpwYXNzd29yZCUzRCUzRA==&quot;&quot;###);
+        assert_snapshot!(decode_basic_auth(header), @&quot;Basic: user:password%3D%3D&quot;);
     }
 }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @zanieb on 2024-04-10 20:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-10 20:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/store.rs</code>:13 on 2024-04-10 20:00</div>
            <div class="timeline-body"><p>Moved to <code>credentials.rs</code>, no longer an enum.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-10 20:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/store.rs</code>:39 on 2024-04-10 20:01</div>
            <div class="timeline-body"><p>Instead of using <code>set</code> for indicating attempted fetches we introduce a separate API for that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-10 20:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/store.rs</code>:28 on 2024-04-10 20:01</div>
            <div class="timeline-body"><p>Adds borrowing of credentials instead of cloning.</p>
<p>Avoids the nested <code>Option&lt;Option&lt;...&gt;&gt;</code> use <code>should_attempt_fetch</code> instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-10 20:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/venv.rs</code>:148 on 2024-04-10 20:02</div>
            <div class="timeline-body"><p>Bothered me that this crept out of the crate</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-10 20:06</div>
            <div class="timeline-body"><p>Intentionally leaving this unlabeled because we need a changelog entry for the user-facing fix</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-10 20:14</div>
            <div class="timeline-body"><pre><code>❯ packse index build scenarios/example.json --no-hash
❯ npx http-server --username user --password foo== ./index
❯ cargo run -q -- pip install --extra-index-url http://user:foo==@127.0.0.1:8080/simple-html example-a --reinstall --no-cache
Resolved 2 packages in 60ms
Downloaded 2 packages in 4ms
Installed 2 packages in 3ms
 - example-a==1.0.0
 + example-a==1.0.0
 - example-b==2.0.0
 + example-b==2.0.0
❯ gcm
Switched to branch 'main'
Your branch is up to date with 'origin/main'.
❯ cargo run -q -- pip install --extra-index-url http://user:foo==@127.0.0.1:8080/simple-html example-a --reinstall --no-cache
error: Failed to download: example-a==1.0.0
  Caused by: HTTP status client error (401 Unauthorized) for url (http://127.0.0.1:8080/files/example_a-1.0.0-py3-none-any.whl#sha256=05f52f5cb7b5a677b4810004ec487f6420fbee6a368038cf8cf8384de5be1939)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-04-10 21:55</div>
            <div class="timeline-body"><p>Sweet, I will review tonight.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-10 21:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/credentials.rs</code>:159 on 2024-04-10 21:59</div>
            <div class="timeline-body"><p>I thought that request headers was a multi-map, but it looks like the docs say this <em>will</em> override (which we <em>need</em>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/credentials.rs</code>:159 on 2024-04-10 22:00</div>
            <div class="timeline-body"><p>Ah okay, <code>append</code> would append, but <code>insert</code> replaces, good.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-10 22:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-10 22:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/store.rs</code>:31 on 2024-04-10 22:02</div>
            <div class="timeline-body"><p>Can you use <code>let fetched = store.get(&amp;netloc)?</code> here instead of manual <code>if</code>-<code>else</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/store.rs</code>:76 on 2024-04-10 22:03</div>
            <div class="timeline-body"><p>I'm having trouble following this. If <code>get</code> returns <code>None</code>, we insert <code>None</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-10 22:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-10 22:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/store.rs</code>:76 on 2024-04-10 22:04</div>
            <div class="timeline-body"><p>Is that because missing credentials would return <code>Some(None)</code>?</p>
<p>I'm wondering if we should use a custom enum here for missing credentials, instead of <code>Option&lt;Credentials&gt;</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-10 22:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/middleware.rs</code>:66 on 2024-04-10 22:06</div>
            <div class="timeline-body"><p>This logging is gone, though perhaps that's ok.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-10 22:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/middleware.rs</code>:56 on 2024-04-10 22:06</div>
            <div class="timeline-body"><p>Kind of wonder if these should all be <code>trace</code> at some point.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-10 22:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/middleware.rs</code>:58 on 2024-04-10 22:08</div>
            <div class="timeline-body"><p>I think one minor downside here is we now do two hash lookups per unauthenticated request. I wonder if returning an enum from <code>.get</code> would make this simpler? Like three cases: we have credentials, the credentials are unset, there are no credetials.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-10 23:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/credentials.rs</code>:159 on 2024-04-10 23:49</div>
            <div class="timeline-body"><p>We actually skip if there's an AUTHORIZATION header (in the middleware) so this isn't critical, but yeah.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-10 23:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/store.rs</code>:31 on 2024-04-10 23:50</div>
            <div class="timeline-body"><p>Yeah TIL you can <code>?</code> on <code>Option</code> lmao</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-10 23:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/store.rs</code>:76 on 2024-04-10 23:51</div>
            <div class="timeline-body"><p>Yes the latter <code>Some(None)</code>. An enum sounds nice although I might want to tackle that separately. I've already moved all the nested option logic <em>inside</em> this struct in this pull request rather than having it be a part of its public API.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-10 23:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:66 on 2024-04-10 23:52</div>
            <div class="timeline-body"><p>Intentional, I found it too noisy. I'll be improving logging further in subsequent pull requests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-10 23:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:56 on 2024-04-10 23:52</div>
            <div class="timeline-body"><p>Yeah that's a fair point.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-10 23:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:58 on 2024-04-10 23:53</div>
            <div class="timeline-body"><p>Yeah I considered this — an enum does seem helpful for that. Are we really concerned about that being a performance bottleneck though? I guess the mutex makes it even slower?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-10 23:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/store.rs</code>:31 on 2024-04-10 23:57</div>
            <div class="timeline-body"><p>Welcome to the <code>Option</code> <strong>monad</strong></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-10 23:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/store.rs</code>:76 on 2024-04-10 23:57</div>
            <div class="timeline-body"><p>I can stack it on top of this before merging though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-11 00:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/middleware.rs</code>:58 on 2024-04-11 00:04</div>
            <div class="timeline-body"><p>I don't know if the perf matters, probably not, but I do find myself thinking that if we're querying the data source twice for the same information, something is not quite right in the data model.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-11 00:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:58 on 2024-04-11 00:25</div>
            <div class="timeline-body"><p>I'll switch to an enum it makes sense to me</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-04-11 00:28</div>
            <div class="timeline-body"><p>The overall ideas make sense to me, I defer to you on which feedback to address specifically prior to merging.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/keyring.rs</code>:49 on 2024-04-13 22:58</div>
            <div class="timeline-body"><p>Nit: <code>URL</code> for consistency (sorry, I know annoying, but this could be user-facing)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/keyring.rs</code>:59 on 2024-04-13 22:59</div>
            <div class="timeline-body"><p>This can be <code>debug!(&quot;Checking keyring for credentials for </code>{url}<code>&quot;);</code> (no need for <code>.to_string()</code> since <code>Url</code> implements <code>Display</code>; can inline directly into the <code>debug!</code> format).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/middleware.rs</code>:58 on 2024-04-13 23:15</div>
            <div class="timeline-body"><p>I still think the double fetch here represents a deficiency in the data model but perhaps it's addressed in the next PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-04-13 23:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-14 15:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/keyring.rs</code>:59 on 2024-04-14 15:47</div>
            <div class="timeline-body"><p>The display for <code>Url</code> is not in the same format as the string, the string is better for a user-facing message.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/keyring.rs</code>:49 on 2024-04-14 15:48</div>
            <div class="timeline-body"><p>Np that's fine will fix</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-14 15:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-14 15:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/keyring.rs</code>:59 on 2024-04-14 15:51</div>
            <div class="timeline-body"><p>Sorry, what’s the difference?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-14 15:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/keyring.rs</code>:59 on 2024-04-14 15:54</div>
            <div class="timeline-body"><p><code>to_string</code> is just a wrapper around <code>Display</code>:</p>
<pre><code class="language-rust">impl&lt;T: fmt::Display + ?Sized&gt; ToString for T {
    // A common guideline is to not inline generic functions. However,
    // removing `#[inline]` from this method causes non-negligible regressions.
    // See &lt;https://github.com/rust-lang/rust/pull/74852&gt;, the last attempt
    // to try to remove it.
    #[inline]
    default fn to_string(&amp;self) -&gt; String {
        let mut buf = String::new();
        let mut formatter = core::fmt::Formatter::new(&amp;mut buf);
        // Bypass format_args!() to avoid write_str with zero-length strs
        fmt::Display::fmt(self, &amp;mut formatter)
            .expect(&quot;a Display implementation returned an error unexpectedly&quot;);
        buf
    }
}
</code></pre>
<p>Could you be confusing <code>Display</code> and <code>Debug</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/keyring.rs</code>:59 on 2024-04-14 16:09</div>
            <div class="timeline-body"><p>Um... weird. I swear I was getting different output. Let me check back on that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-14 16:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-14 16:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/keyring.rs</code>:59 on 2024-04-14 16:15</div>
            <div class="timeline-body"><p>(It's possible that types can override this behavior and maybe it <em>is</em> different for URL, I just assumed it wasn't.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-04-15 08:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-auth/src/keyring.rs</code>:74 on 2024-04-15 08:49</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    #[instrument]
    fn fetch_subprocess(&amp;self, url: &amp;Url) -&gt; Result&lt;Option&lt;String&gt;, Error&gt; {
</code></pre>
<p>To track where we're losing 80ms</p>
<pre><code>$ hyperfine -i &quot;keyring get https://pypi.org konstin&quot;
Benchmark 1: keyring get https://pypi.org konstin
  Time (mean ± σ):      80.8 ms ±   5.7 ms    [User: 66.2 ms, System: 11.7 ms]
  Range (min … max):    73.8 ms …  96.2 ms    30 runs
 
  Warning: Ignoring non-zero exit code.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/vlad-ivanov-name">@vlad-ivanov-name</a> reviewed on 2024-04-15 10:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/vlad-ivanov-name">@vlad-ivanov-name</a> on <code>crates/uv-auth/src/keyring.rs</code>:75 on 2024-04-15 10:56</div>
            <div class="timeline-body"><p>since this is being refactored now anyway -- would it be possible to make this adjustable?</p>
<pre><code class="language-suggestion">        let keyring_command = std::env::var(&quot;UV_KEYRING_COMMAND&quot;).unwrap_or(&quot;keyring&quot;);
        let output = match Command::new(keyring_command)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-15 16:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/keyring.rs</code>:59 on 2024-04-15 16:18</div>
            <div class="timeline-body"><p>I think I just got confused by some of the reqwest internal logs which look like <code>(&quot;http&quot;, 127.0.0.1:53514)</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-15 21:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/keyring.rs</code>:75 on 2024-04-15 21:11</div>
            <div class="timeline-body"><p>I'd rather consider this separately, sorry. This pull request is already huge.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-04-15 22:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-auth/src/middleware.rs</code>:147 on 2024-04-15 22:58</div>
            <div class="timeline-body"><p>This is technically a breaking change - since before, it would attempt keyring with a placeholder username for keyring backends which don't need a username (notably <a href="https://pypi.org/project/keyrings.google-artifactregistry-auth/">Google Artifact Registry</a> which my company uses).</p>
<p>In the initial/current implementation, it would use the same placeholder username that Google Artifact Registry uses internally (<code>oauth2accesstoken</code> see <a href="https://github.com/GoogleCloudPlatform/artifact-registry-python-tools/blob/1589e75c0879fb63d376f566971b82635717fc33/keyrings/gauth.py#L69">here</a>).  Annoyingly, the keyring CLI command requires a username is provided, even though some backends don't even check the username at all (in linked Google code, you can see username is never read).</p>
<p><a href="https://github.com/pypa/pip/blob/ae5fff36b0aad6e5e0037884927eaa29163c0611/src/pip/_internal/network/auth.py#L86">Here</a>, you can see pip attempting keyring even when username is <code>None</code> when trying import strategy - which is first attempt by default for pip.</p>
<p>This change would be an annoyance for our use case, as we'd have to add usernames to all  of our index urls in all of our projects.  We could deal with it, of course, but would be nice not to</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-15 23:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:147 on 2024-04-15 23:26</div>
            <div class="timeline-body"><p>Thanks for giving the pull request a look!</p>
<p>I'm pretty uncomfortable using a hard-coded default username for all queries. It doesn't make sense to me to default to a specific username. I'd be willing to consider adding a workaround like passing <code>null</code> to keyring but not using it in the credentials or perhaps providing the Google placeholder if we detect a Google Artifact Registry (via <a href="https://github.com/GoogleCloudPlatform/artifact-registry-python-tools/blob/1589e75c0879fb63d376f566971b82635717fc33/keyrings/gauth.py#L39-L40">this logic</a>).</p>
<p>pip reading the keyring with a <code>None</code> username there is valid (and seems like a separate use case) because the <code>get_credentials</code> API is designed to return both a username and password. I don't know why this API is not available via the CLI. cc @jaraco ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-16 00:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:147 on 2024-04-16 00:07</div>
            <div class="timeline-body"><p>Here's a change where we send an arbitrary username but don't populate the URL with it... https://github.com/astral-sh/uv/pull/3048 — this seems more correct than <code>main</code> but does not match pip's subprocess keyring provider afaict</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-auth/src/middleware.rs</code>:147 on 2024-04-16 01:16</div>
            <div class="timeline-body"><blockquote>
<p>I'm pretty uncomfortable using a hard-coded default username for all queries.</p>
</blockquote>
<p>Yeah, totally fair</p>
<blockquote>
<p>perhaps providing the Google placeholder if we detect a Google Artifact Registry (via <a href="https://github.com/GoogleCloudPlatform/artifact-registry-python-tools/blob/1589e75c0879fb63d376f566971b82635717fc33/keyrings/gauth.py#L39-L40">this logic</a>).</p>
</blockquote>
<p>Selfishly, I'd like this but also understand if not</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-04-16 01:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-16 02:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:147 on 2024-04-16 02:24</div>
            <div class="timeline-body"><p>Does #3048 work for you though? Or do they require that username to be in the request?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jenshnielsen">@jenshnielsen</a> on 2024-04-16 12:07</div>
            <div class="timeline-body"><p>@zanieb Did a quick test and can confirm that this works against Azure artifacts</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Refactor `uv-auth`" to "Rewrite `uv-auth`" by @zanieb on 2024-04-16 13:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jaraco">@jaraco</a> reviewed on 2024-04-16 13:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jaraco">@jaraco</a> on <code>crates/uv-auth/src/middleware.rs</code>:147 on 2024-04-16 13:59</div>
            <div class="timeline-body"><blockquote>
<p>pip reading the keyring with a <code>None</code> username there is valid (and seems like a separate use case) because the <code>get_credentials</code> API is designed to return both a username and password. I don't know why this API is not available via the CLI. cc @jaraco ?</p>
</blockquote>
<p>The use case that demanded <code>get_credential</code> (https://github.com/jaraco/keyring/issues/350) was API-only and it wasn't obvious if there should be a CLI interface to it, especially because <code>get_credential</code> was returning something requiring more structure than the other calls, something for which there was no obvious right answer. It quite possible I decided to defer the possibility of a CLI option until someone requested it. Reading up on that issue, it's sparse on details, in part because we had a lot of the discussion in person and didn't capture it, so my recollection is probably the best you'll get. We're always open to suggestions and pull requests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-16 14:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:147 on 2024-04-16 14:02</div>
            <div class="timeline-body"><p>Thanks for the link and context!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-04-16 16:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-auth/src/middleware.rs</code>:147 on 2024-04-16 16:32</div>
            <div class="timeline-body"><blockquote>
<p>Does #3048 work for you though? Or do they require that username to be in the request?</p>
</blockquote>
<p>It does not - it appears that Google Artifact Registry does in fact expect to receive <code>oauth2accesstoken</code> as the username in the basic auth (not documented anywhere, unfortunately)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-16 16:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:147 on 2024-04-16 16:39</div>
            <div class="timeline-body"><p>I think you will need to update your URLs then, unfortunately. We can suggest exposing this API in the keyring CLI though so we can support retrieval of credentials without an explicit username.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">breaking</span> added by @zanieb on 2024-04-16 16:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-16 16:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:147 on 2024-04-16 16:43</div>
            <div class="timeline-body"><p>Or we can peek at the URL but I'm hesitant to add logic for specific providers.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2024-04-16 16:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-04-16 16:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-16 16:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-04-16 17:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-auth/src/middleware.rs</code>:147 on 2024-04-16 17:46</div>
            <div class="timeline-body"><p>@jaraco Made a quick and dirty PoC PR for exposing <code>get_credential</code> via cli:  https://github.com/jaraco/keyring/pull/678</p>
<blockquote>
<p>The use case that demanded get_credential (jaraco/keyring#350) was API-only and it wasn't obvious if there should be a CLI interface to it, especially because get_credential was returning something requiring more structure than the other calls, something for which there was no obvious right answer.</p>
</blockquote>
<p>Agreed with this - it would be nice to have it exposed via optional argument to <code>keyring get</code> but then the output is not consistent when providing username vs not.  Which is why in my PoC PR it's a different operation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-04-16 17:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-auth/src/middleware.rs</code>:147 on 2024-04-16 17:56</div>
            <div class="timeline-body"><p>@zanieb would be good to mention in release notes that anyone using keyring subprocess with Google Artifact Registry should update index-urls with <code>oauth2accesstoken@</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-04-16 18:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:147 on 2024-04-16 18:58</div>
            <div class="timeline-body"><p>Yep I'll note this as a breaking change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/alelavml3">@alelavml3</a> on 2024-04-18 12:13</div>
            <div class="timeline-body"><p>Hi, I'm writing this comment because with this new release we are facing an authentication problems. We use a private <code>Sonatype Nexus</code> repository server which uses a private PyPi Repo to store our company private Python packages.
The command for compiling and install are the following:</p>
<pre><code class="language-bash">export PYPI_INDEX_URL=https://$(NEXUS_USER):$(NEXUS_PWD)@$(NEXUS_SERVER_URL)
uv pip compile pyproject.toml -o requirements.txt --index-url $(PYPI_INDEX_URL)
uv pip sync requirements.txt --index-url $(PYPI_INDEX_URL)
</code></pre>
<p>The error we get is during <code>uv pip sync</code>:</p>
<pre><code>error: Failed to download distributions
  Caused by: Failed to fetch wheel: google-cloud-pubsub==2.21.0
  Caused by: HTTP status client error (401 Unauthorized) for url (&lt;NEXUS_SERVER_URL&gt;/packages/google-cloud-pubsub/2.21.0/google_cloud_pubsub-2.21.0-py2.py3-none-any.whl#sha256=fabd19e08faa1f70081b0e5ea003a3c031a1d2c1b798cf1be5ded2dbf1d1dbef)
</code></pre>
<p>here the package is <code>google-cloud-pubsub</code> but it happens with any random package.</p>
<p>How can we fix this issue with this new version? For now, we are using v0.1.32 and everything works.</p>
<p>Thank you in advance for your answers!</p>
<p>@zanieb @jenshnielsen</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jenshnielsen">@jenshnielsen</a> on 2024-04-18 13:33</div>
            <div class="timeline-body"><p>@alelavml3 I think you should probably create a new issue to track this. That being said I have observed when fetching from Azure  Artifacts that I get a 401 on the first attempt to install a package but retrying to install the same package works as expected. Perhaps your issue is the same? I have not had a chance to create an issue for this just yet</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-04-18 14:29</div>
            <div class="timeline-body"><p>@alelavml3 Thanks for the report, a new issue would be greatly appreciated with <code>RUST_LOG=trace uv pip sync -v ...</code> logs. Be sure to redact your password.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:36:32 UTC
    </footer>
</body>
</html>
