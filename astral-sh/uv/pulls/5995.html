<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support PEP 723 scripts in `uv add` and `uv remove` - astral-sh/uv #5995</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Support PEP 723 scripts in <code>uv add</code> and <code>uv remove</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/5995">#5995</a>
        opened by <a href="https://github.com/blueraft">@blueraft</a>
        on 2024-08-10 14:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/blueraft">@blueraft</a></div>
            <div class="timeline-body">Summary
<p>Resolves <a href="https://github.com/astral-sh/uv/issues/4667">astral-sh/uv#4667</a></p>
Test Plan
<p><code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-10 14:48</div>
            <div class="timeline-body"><p>Thanks, look forward to reviewing, this feature is gonna be amazing.</p>
<p>If you haven’t already (sorry, on phone), can you ensure there’s test coverage for:</p>
<ul>
<li>Adding a dep with an existing script tag</li>
<li>Adding a dep without an existing script tag (with a shebang present, with a docstring present, etc.)</li>
<li>Removing the last dep in an existing script tag (I think it’s fine to leave the script tag rather than removing it entirely, even if the dep list is empty).</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blueraft">@blueraft</a> on 2024-08-10 15:09</div>
            <div class="timeline-body"><ul>
<li>[x] Adding a dep with an existing script tag</li>
<li>[ ] Adding a dep without an existing script tag (this is not supported yet, but I can take a look tomorrow)</li>
<li>[x] Removing the last dep in an existing script tag</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-10 16:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-scripts/src/lib.rs</code>:77 on 2024-08-10 16:12</div>
            <div class="timeline-body"><p>Nit: this should be <code>from_str</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-10 16:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-scripts/src/lib.rs</code>:22 on 2024-08-10 16:12</div>
            <div class="timeline-body"><p>Lets call this <code>raw</code> for consistency?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/add.rs</code>:264 on 2024-08-10 16:13</div>
            <div class="timeline-body"><p>These actually do support sources now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-10 16:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-10 16:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-scripts/src/lib.rs</code>:161 on 2024-08-10 16:15</div>
            <div class="timeline-body"><p>Since we break, doesn&#x27;t the <code>python_script</code> get truncated?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-10 16:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-scripts/src/lib.rs</code>:110 on 2024-08-10 16:15</div>
            <div class="timeline-body"><p>What is the &quot;python script&quot;? Can you show an example in the docstring here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-10 16:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/lib.rs</code>:1144 on 2024-08-10 16:20</div>
            <div class="timeline-body"><p>I think we should consider moving this up to where we parse the script for <code>uv run</code>, nearer to the top of the file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-10 16:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-cli/src/lib.rs</code>:2526 on 2024-08-10 16:21</div>
            <div class="timeline-body"><p>I think <code>--script</code> should be marked as conflicting with a bunch of other options, like: <code>--locked</code>, <code>--frozen</code>, <code>--dev</code>, etc. Or, we can warn in <code>add</code> and <code>remove</code> if those are set, to indicate that they&#x27;re ignored, like in <a href="https://github.com/astral-sh/uv/pull/5977">astral-sh/uv#5977</a>. Fine to just follow that pattern.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-10 16:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-10 16:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-10 16:21</div>
            <div class="timeline-body"><p>Pumped for this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-08-10 16:25</div>
            <div class="timeline-body"><p>Wow so exciting!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/blueraft">@blueraft</a> reviewed on 2024-08-10 18:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/blueraft">@blueraft</a> on <code>crates/uv-cli/src/lib.rs</code>:2526 on 2024-08-10 18:35</div>
            <div class="timeline-body"><p>I&#x27;ve added a warning for the other options, let me know if I missed something</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/blueraft">@blueraft</a> reviewed on 2024-08-10 18:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/blueraft">@blueraft</a> on <code>crates/uv/src/lib.rs</code>:1144 on 2024-08-10 18:35</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/blueraft">@blueraft</a> reviewed on 2024-08-10 18:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/blueraft">@blueraft</a> on <code>crates/uv-scripts/src/lib.rs</code>:110 on 2024-08-10 18:35</div>
            <div class="timeline-body"><p>By this I meant the python code in the rest of the script, I&#x27;ve added an example and some further explanation for this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/blueraft">@blueraft</a> reviewed on 2024-08-10 18:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/blueraft">@blueraft</a> on <code>crates/uv-scripts/src/lib.rs</code>:161 on 2024-08-10 18:35</div>
            <div class="timeline-body"><p><code>python_script</code> gets all of the remaining lines for the files before we break so it should contain the rest of the script file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/blueraft">@blueraft</a> reviewed on 2024-08-10 18:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/blueraft">@blueraft</a> on <code>crates/uv/src/commands/project/add.rs</code>:264 on 2024-08-10 18:35</div>
            <div class="timeline-body"><p>Added support for sources and a test for this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/blueraft">@blueraft</a> reviewed on 2024-08-10 18:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/blueraft">@blueraft</a> on <code>crates/uv-scripts/src/lib.rs</code>:77 on 2024-08-10 18:35</div>
            <div class="timeline-body"><p>Clippy is not happy with <code>from_str</code></p>
<pre><code>warning: method `from_str` can be confused for the standard trait method `std::str::FromStr::from_str`
```j
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-10 18:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-scripts/src/lib.rs</code>:77 on 2024-08-10 18:51</div>
            <div class="timeline-body"><p>I think it&#x27;s ok to implement the trait instead of as an associated method here. But I can also do it before merging and show you as an example, either is fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/blueraft">@blueraft</a> reviewed on 2024-08-10 19:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/blueraft">@blueraft</a> on <code>crates/uv-scripts/src/lib.rs</code>:77 on 2024-08-10 19:04</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blueraft">@blueraft</a> on 2024-08-10 19:16</div>
            <div class="timeline-body"><blockquote>
<p>Adding a dep without an existing script tag</p>
</blockquote>
<p>Can you expand on this a little about what we want to support here?</p>
<p>Just to clarify, do we want to support the following use case with uv add?</p>
<p>Suppose the script file contains this code:</p>
<pre><code>
import requests
from rich.pretty import pprint

resp = requests.get(&quot;https://peps.python.org/api/peps.json&quot;)
data = resp.json()
pprint([(k, v[&quot;title&quot;]) for k, v in data.items()][:10])
</code></pre>
<p>If the user runs:</p>
<pre><code>uv add rich requests --script example.py
</code></pre>
<p>Do we intend for uv add to transform the script by adding a metadata block like this at the top?</p>
<pre><code>
# /// script
# requires-python = &quot;&gt;=3.11&quot;
# dependencies = [
#   &quot;requests&quot;,
#   &quot;rich&quot;,
# ]
# ///

import requests
from rich.pretty import pprint

resp = requests.get(&quot;https://peps.python.org/api/peps.json&quot;)
data = resp.json()
pprint([(k, v[&quot;title&quot;]) for k, v in data.items()][:10])
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-10 19:18</div>
            <div class="timeline-body"><p>Yeah that’s what I was thinking.</p>
<p>My guess is it needs to appear after any shebang though (but maybe before any docstrings?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blueraft">@blueraft</a> on 2024-08-10 20:33</div>
            <div class="timeline-body"><p>Thank you, that makes sense. I&#x27;ll look into adding that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/blueraft">@blueraft</a> on 2024-08-10 20:53</div>
            <div class="timeline-body"><blockquote>
<p>Adding a dep without an existing script tag</p>
</blockquote>
<p>This should now support adding a dependency even when there is no existing script tag in the file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-11 00:27</div>
            <div class="timeline-body"><p>Great! I assume that means ready to review, I&#x27;ll go through it now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-08-11 01:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-11 01:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-cli/src/lib.rs</code>:2526 on 2024-08-11 01:16</div>
            <div class="timeline-body"><p>Looks good. I marked <code>--dev</code> and <code>--optional</code> as conflicting, since those should truly error. The rest are more &quot;redundant&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-11 01:19</div>
            <div class="timeline-body"><p>Great, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-11 01:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-11 01:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-08-11 08:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:47:18 UTC
    </footer>
</body>
</html>
