<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retry on spurious failures when caching built wheels - astral-sh/uv #4605</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Retry on spurious failures when caching built wheels</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/4605">#4605</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-06-27 23:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>https://github.com/astral-sh/uv/pull/2419 appears to have only applied this retry to wheels that were already downloaded (though I would have to look more carefully to be certain). In <a href="https://github.com/astral-sh/uv/issues/1491">astral-sh/uv#1491</a>, we&#x27;ve gotten continued reports of spurious failures on Windows and tracing reveals that we are not applying our retry logic during the rename. I believe we&#x27;re in this code path â€” switching to our backoff retry should resolve the failures.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-27 23:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-27 23:13</div>
            <div class="timeline-body"><p>There are various other <code>rename</code> calls that we may want to audit as well. I&#x27;ve changed the remaining async ones in #4606, I don&#x27;t see reason to change the synchronous ones unless we see problems?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-27 23:19</div>
            <div class="timeline-body"><p>I believe this is only called at https://github.com/astral-sh/uv/blob/f01aebe6dd2b284f40fe96bb72f35cd019d2975f/crates/uv-distribution/src/source/mod.rs#L1430 when performing <code>build_distribution</code> i.e. placing a built wheel in the cache</p>
<p>The other pull request includes <code>persist_archive</code> which is called at https://github.com/astral-sh/uv/blob/f01aebe6dd2b284f40fe96bb72f35cd019d2975f/crates/uv-distribution/src/source/mod.rs#L863
i.e. extracting a source distribution to the cache</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-27 23:21</div>
            <div class="timeline-body"><p>Here&#x27;s the <a href="https://github.com/astral-sh/uv/issues/1491#issuecomment-2195778958">error</a> we&#x27;re attempting to address</p>
<blockquote>
<p>Caused by: Failed to write to the distribution cache
Caused by: failed to rename file from \?\C:\Users\gitlabwinrunner\AppData\Local\Temp.tmpanLS7H\built-wheels-v3.tmpc3E2Z7\pywinusb-0.4.2 to \?\C:\Users\gitlabwinrunner\AppData\Local\Temp.tmpanLS7H\built-wheels-v3\index\70e6dbc41e17fe7c\pywinusb\0.4.2\or1SrhePMDCdKnzdyzMki\pywinusb-0.4.2.zip</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-27 23:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/axel-kah">@axel-kah</a> on 2024-06-27 23:23</div>
            <div class="timeline-body"><p>I took a guess and pulled the binary from this PRs build binary | windows job:
https://github.com/astral-sh/uv/actions/runs/9704735622/job/26785531647?pr=4605
https://github.com/astral-sh/uv/actions/runs/9704735622/artifacts/1646714270</p>
<p>When I use that in conjunction with hatch, then all I get is this ðŸ˜¬</p>
<pre><code>$ hatch version
Setting up build environment for missing dependencies
Installing Python distribution: 3.11
thread &#x27;main&#x27; has overflowed its stack
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-27 23:27</div>
            <div class="timeline-body"><p>@axel-kah The debug builds have a weirdly small stack size on Windows â€” not a problem in releases but we have to work around it during testing.</p>
<pre><code>$Env:UV_STACK_SIZE = &#x27;2000000&#x27;
</code></pre>
<p>More details in our <a href="https://github.com/astral-sh/uv/blob/631994c485560fa950bc576bc15c99a761c6b932/CONTRIBUTING.md#testing-on-windows">contributing guide</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/axel-kah">@axel-kah</a> on 2024-06-27 23:47</div>
            <div class="timeline-body"><p>After setting the stack size the debug build works - but run&#x27;s into the same error. I&#x27;ll give #4606 a shot as well.</p>
<p>EDIT: and no instance of retrying in the verbose log.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/axel-kah">@axel-kah</a> on 2024-06-28 00:09</div>
            <div class="timeline-body"><p>Hm, neither this nor #4606 seem to eliminate this problem so far.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-06-28 11:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-28 14:23</div>
            <div class="timeline-body"><p>That&#x27;s surprising :(</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-28 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/zanieb">@zanieb</a> on 2024-06-28 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-06-28 14:23</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:46:11 UTC
    </footer>
</body>
</html>
