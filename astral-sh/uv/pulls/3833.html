<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Port all git functionality to use git CLI - astral-sh/uv #3833</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Port all git functionality to use git CLI</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/3833">#3833</a>
        opened by <a href="https://github.com/ibraheemdev">@ibraheemdev</a>
        on 2024-05-24 21:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>We currently rely on libgit2 for most git-related functionality. However, libgit2 has long-standing performance issues, as well as lags significantly behind git in terms of new features. For these reasons we now use the git CLI by default for fetching repositories (https://github.com/astral-sh/uv/pull/1781). This PR completely drops libgit2 in favor of the git CLI for all git-related functionality, which should allow us to use features such as partial clones and sparse checkouts in the future for performance.</p>
<p>There is also a lot of technical debt in the current git code as it's mostly taken from Cargo. Switching to the git CLI <em>vastly</em> simplifies the <code>uv-git</code> codebase.</p>
<p>Eventually we might want to look into switching to <a href="https://github.com/Byron/gitoxide"><code>gitoxide</code></a>, but it's currently too immature for our use case.</p>
<h2>Test Plan</h2>
<!-- How was it tested? -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-05-24 23:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-git/src/git.rs</code>:161 on 2024-05-24 23:15</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// Initializes a Git repository
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-05-25 10:05</div>
            <div class="timeline-body"><p>Do we introduce a specific git cli minimum version requirement this way? I remember graphite breaking because my linux distro git was to old for their wrapper.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-05-28 01:08</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/uv/branches/ibraheemdev:git-cli">CodSpeed Performance Report</a></h2>
<h3>Merging #3833 will <strong>degrade performances by 9.61%</strong></h3>
<p><sub>Comparing <code>ibraheemdev:git-cli</code> (915d8d8) with <code>main</code> (502e042)</sub></p>
<h3>Summary</h3>
<p><code>⚡ 1</code> improvements
<code>❌ 1</code> regressions
<code>✅ 11</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/uv/branches/ibraheemdev:git-cli">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>main</code> | <code>ibraheemdev:git-cli</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>resolve_warm_airflow</code> | 1.5 s | 1.4 s | +6.39% |
| ❌ | <code>resolve_warm_jupyter</code> | 80.2 ms | 88.8 ms | -9.61% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ibraheemdev on 2024-05-28 16:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @ibraheemdev on 2024-05-28 17:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @ibraheemdev on 2024-05-28 17:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-05-28 17:10</div>
            <div class="timeline-body"><p>@konstin I don't think this relies on anything even relatively new, but I can audit the commands and see the minimum version we require.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-05-28 17:39</div>
            <div class="timeline-body"><p>Benchmarks are pretty inconsistent but it seems like overall this change introduces a ~5% regression, which is expected because we have to shell out to Git quite a bit. We may be able to improve this somewhat taking into account the new cost (e.g. some of the <code>rev-parse</code> calls). However, the features that this enables us to use have a lot more potential for performance improvements, so, along with the reduced maintenance burden, it seems worth it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/uv-git/src/sha.rs</code>:49 on 2024-05-28 17:42</div>
            <div class="timeline-body"><p><code>libgit2</code> hex encodes object IDs to reduce their size (by half). However we can't use the <code>hex</code> crate directly because we would need to support odd-length strings, so I left it out for now. We could also just store the IDs as <code>String</code>s and do a bit of extra cloning.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2024-05-28 17:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2024-05-28 17:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/uv-git/src/git.rs</code>:165 on 2024-05-28 17:43</div>
            <div class="timeline-body"><p>I can't seem to find a way to do this with the CLI...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2024-05-28 17:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/uv-git/src/git.rs</code>:409 on 2024-05-28 17:45</div>
            <div class="timeline-body"><p>Also unsure if we need to do this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-30 01:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-git/src/sha.rs</code>:80 on 2024-05-30 01:17</div>
            <div class="timeline-body"><p>Do we need to validate that this a valid hex?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-30 01:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-git/src/git.rs</code>:161 on 2024-05-30 01:22</div>
            <div class="timeline-body"><p>Nit: can you write out your TODOs as <code>TODO(ibraheem): ...</code> or <code>TODO(ibraheemdev): ...</code> or whatever you prefer? I like having an author annotation on TODOs -- it doesn't necessarily mean that you're responsible for <em>solving</em> it, but it makes it immediately clear who has context on it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-30 01:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-git/src/git.rs</code>:367 on 2024-05-30 01:25</div>
            <div class="timeline-body"><p>I don't know if we should use <code>portable_display</code> here -- it will use a relative path in some cases. Should we use <code>simplified_display</code>, to get an absolute path?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-git/src/git.rs</code>:409 on 2024-05-30 01:26</div>
            <div class="timeline-body"><p>I think we can just remove this. We don't support vendoring right? Unless I'm misunderstanding.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-30 01:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-git/src/git.rs</code>:975 on 2024-05-30 01:27</div>
            <div class="timeline-body"><p>Why remove these two?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-30 01:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-30 01:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-git/src/git.rs</code>:314 on 2024-05-30 01:28</div>
            <div class="timeline-body"><p>What does the <code>^0</code> signify here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-30 01:29</div>
            <div class="timeline-body"><p>So just confirming -- the overall scheme here is the same, right? We have one checkout for Git repo, and then we fetch individual commits and clone them into separate directories to build?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-git/src/git.rs</code>:171 on 2024-05-30 01:32</div>
            <div class="timeline-body"><p>Is there any risk of dropping important output here? (What did we do with Git CLI output before, when fetching?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-05-30 01:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2024-05-30 15:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/uv-git/src/sha.rs</code>:80 on 2024-05-30 15:20</div>
            <div class="timeline-body"><p>I don't think so, git will end up failing if we try to identify a commit using a malformed/broken hash anyways. I guess we could for better error messages, but it seems unlikely anyways?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2024-05-30 15:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/uv-git/src/git.rs</code>:975 on 2024-05-30 15:26</div>
            <div class="timeline-body"><p>Both of those were linked to libgit2 issues. The git cli runs garbage collection automatically on <code>git fetch</code>, <code>git commit</code>, and other commands, so it shouldn't be a problem now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2024-05-30 15:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/uv-git/src/git.rs</code>:314 on 2024-05-30 15:28</div>
            <div class="timeline-body"><p><code>^0</code> is short for <code>^{commit}</code>, which recursively &quot;peels&quot; to the underlying commit object. e.g. if the tag points to another tag, which then points to a commit. I'm not 100% sure if we need to do this, but the previous code had calls to <code>peel(ObjectType::Commit)</code>, so this retains the original behavior. I'll add a more detailed comment explaining this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2024-05-30 15:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/uv-git/src/git.rs</code>:171 on 2024-05-30 15:31</div>
            <div class="timeline-body"><p>This is the same thing we've always done in <code>fetch_with_cli</code>. The <code>true</code> means that stderr output will still be captured in the error message if the command fails, the <code>silent</code> callbacks just make sure that the stdout/stderr output is not piped to the user's terminal (<code>Command::{stdout,stderr}</code> are overridden).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2024-05-30 15:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/uv-git/src/git.rs</code>:409 on 2024-05-30 15:32</div>
            <div class="timeline-body"><p>What sort of vendoring are you thinking of? <code>core.autocrlf</code> configures whether git automatically converts line endings (CRLF to LF) for checked out files. I think this can still affect us, but I'm not sure whether it matters (or why it matters for Cargo)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2024-05-30 15:33</div>
            <div class="timeline-body"><blockquote>
<p>So just confirming -- the overall scheme here is the same, right? We have one checkout for Git repo, and then we fetch individual commits and clone them into separate directories to build?</p>
</blockquote>
<p>Yes, there should be no change in behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2024-05-30 15:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/uv-git/src/git.rs</code>:409 on 2024-05-30 15:38</div>
            <div class="timeline-body"><p>Ah you mean cargo vendoring. Yeah that looks to be why they needed this, it shouldn't affect us. I'll remove it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2024-05-30 16:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/uv-git/src/git.rs</code>:171 on 2024-05-30 16:26</div>
            <div class="timeline-body"><p>Turns out we can use <code>exec_with_output</code> here instead, which is a bit clearer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-05-30 17:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ibraheemdev on 2024-05-30 19:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ibraheemdev on 2024-05-30 19:28</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:37:11 UTC
    </footer>
</body>
</html>
