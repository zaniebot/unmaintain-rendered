<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use index URL instead of package URL for keyring credential lookups - astral-sh/uv #12651</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use index URL instead of package URL for keyring credential lookups</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/12651">#12651</a>
        opened by <a href="https://github.com/jtfmumm">@jtfmumm</a>
        on 2025-04-03 14:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/jtfmumm">@jtfmumm</a> on 2025-04-03 14:05</div>
            <div class="timeline-body"><p>Some registries (like Azure Artifact) can require you to authenticate separately for every package URL if you do not authenticate for the /simple endpoint. These changes make the auth middleware aware of index URL endpoints and attempts to fetch keyring credentials for such an index URL when making a request to any URL it's a prefix of.</p>
<p>The current uv behavior is to cache credentials either at the request URL or realm level. But with these changes, we also need to cache credentials at the index level. Note that when uv does not detect an index URL for a request URL, it will continue to apply the old behavior.</p>
<p>Addresses part of #4056
Closes #4583
Closes #11236
Closes #11391
Closes #11507</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">network</span> added by @jtfmumm on 2025-04-03 14:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @jtfmumm on 2025-04-03 14:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on 2025-04-03 15:09</div>
            <div class="timeline-body"><p>In this version, when an index URL prefix is found, we will use that instead of the full package URL to look up credentials. This is probably the expected behavior, but is it possible some users now rely on the old behavior? If this is a concern, another option is to first check one and then the other, though keyring lookup can be slow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-03 17:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/lib.rs</code>:13 on 2025-04-03 17:17</div>
            <div class="timeline-body"><p>I'd probably call this <code>indexes</code> to match the existing naming scheme</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-03 17:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:61 on 2025-04-03 17:18</div>
            <div class="timeline-body"><p>Nit: Similar to https://github.com/astral-sh/uv/pull/12651/files#r2027441564, it seems fine to drop the <code>auth_</code> prefix here since these are the only indexes which exist in this context.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:61 on 2025-04-03 17:18</div>
            <div class="timeline-body"><p>(I think this applies broadly)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-03 17:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-03 17:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:492 on 2025-04-03 17:20</div>
            <div class="timeline-body"><p>This drops the check for the full URL match, should we do that? Are you worried about breakage? What if a credential provider changes its behavior based on the accessed resource?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-03 17:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-distribution-types/src/index_url.rs</code>:420 on 2025-04-03 17:22</div>
            <div class="timeline-body"><p>if we need more information anyway, can we just store the <code>Index</code> or <code>IndexUrl</code> type directly? Why do we decompose to <code>index_url</code> and <code>policy_url</code> eagerly?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-03 17:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:492 on 2025-04-03 17:26</div>
            <div class="timeline-body"><p>I missed your comment at https://github.com/astral-sh/uv/pull/12651#issuecomment-2776117709</p>
<blockquote>
<p>In this version, when an index URL prefix is found, we will use that instead of the full package URL to look up credentials. This is probably the expected behavior, but is it possible some users now rely on the old behavior? If this is a concern, another option is to first check one and then the other, though keyring lookup can be slow.</p>
</blockquote>
<p>Thanks for highlighting this change.</p>
<p>I'm not sure what's best here. If it was fast, I'd expect to check the exact URL first then a child URL (e.g., for the index). I'd be <em>surprised</em> if this change broke someone's setup but it does seem plausible. ðŸ¤”</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:480 on 2025-04-03 17:29</div>
            <div class="timeline-body"><p>I think there's more that needs to change for the authentication middleware to become index-aware. We calculate the cache key above</p>
<pre><code class="language-rust">        // Fetches can be expensive, so we will only run them _once_ per realm and username combination
        // All other requests for the same realm will wait until the first one completes
        let key = (
            Realm::from(url),
            Username::from(
                credentials
                    .map(|credentials| credentials.username().unwrap_or_default().to_string()),
            ),
        );
</code></pre>
<p>but we should cache at the index level instead of the realm level.</p>
<p>It may be plausible to ship that separately? But it's part of the objective of #4583</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-03 17:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/base_client.rs</code>:360 on 2025-04-03 22:47</div>
            <div class="timeline-body"><p>This looks a little awkward, can't the <code>client.with(auth_middleware);</code> bit be outside the <code>else</code> and
<code>auth_middleware = auth_middleware.with_auth_indexes(auth_indexes.clone())</code> be in the <code>if</code>? (I presume if the borrow checker doesn't get in the way it could also be done with a <code>.map</code> instead?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-03 22:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-03 22:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-distribution-types/src/index_url.rs</code>:420 on 2025-04-03 22:48</div>
            <div class="timeline-body"><p>Then we could avoid having to re-explain the meaning of the <code>root()</code> URL up in the <code>AuthIndex</code> docs too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-04-03 22:49</div>
            <div class="timeline-body"><p>Excited that you tackled this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-04-04 07:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-distribution-types/src/index_url.rs</code>:420 on 2025-04-04 07:18</div>
            <div class="timeline-body"><p>The first reason is that using <code>Index</code> or <code>IndexUrl</code> would cause a crate dependency cycle. But because we only use a small subset of that data here, it didn't seem like a good idea to refactor our dependency graph to allow this.</p>
<p>But it also made sense to me to pay the small memory cost of storing both URLs to avoid recalculating the URLs every time. And I think there's value in making it clear in the docs in this crate what the root URL means in this context (namely that it is the point at which we apply the auth policy).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-04-04 07:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-auth/src/middleware.rs</code>:492 on 2025-04-04 07:24</div>
            <div class="timeline-body"><p>I guess one rationale for doing both checks is that the performance cost is only paid in the failure case. That is, if the credentials exist for the index URL we only do one check. If not, then either there are credentials for the child URL (which the user would want us to check) or there are no credentials. So I'll update it and we can always revisit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-04-04 07:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-client/src/base_client.rs</code>:360 on 2025-04-04 07:54</div>
            <div class="timeline-body"><p>I was trying to keep <code>auth_middleware</code> immutable while also not repeating the <code>.with_keyring</code> and <code>.with_only_authenticated</code> code within the if/else.</p>
<p>This new version configures <code>auth_middleware</code> first and then applies it to the client.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-04-04 08:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-auth/src/lib.rs</code>:13 on 2025-04-04 08:10</div>
            <div class="timeline-body"><p>Yeah this naming isn't ideal, but since we can't depend on <code>IndexLocations</code> here without a circular crate dependency, the <code>AuthIndex</code> is used in the context of <code>IndexLocations</code> to construct an <code>AuthIndexes</code>.</p>
<p>A solution is to use the fully qualified name <code>uv_auth::Index</code> in the context of <code>IndexLocations</code>. So I'll do that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-auth/src/middleware.rs</code>:480 on 2025-04-04 08:29</div>
            <div class="timeline-body"><p>Yeah, I agree this needs to be done. The main question is whether we still need to support realm-level caching for URLs not tied to an index. I think so, given that the <code>BaseClient</code> can be used for multiple purposes. If not, this work would entail reworking our credential cache to operate at the index URL level instead of the realm level. If so, we'll need to support both.</p>
<p>I'm ok with adding that to the scope of this PR, but I also think this PR could be merged independently without causing surprising behavior (and would strictly be an improvement). My inclination is to merge separately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-04-04 08:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-04 16:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:480 on 2025-04-04 16:08</div>
            <div class="timeline-body"><blockquote>
<p>The main question is whether we still need to support realm-level caching for URLs not tied to an index. I think so, given that the BaseClient can be used for multiple purposes.</p>
</blockquote>
<p>Yeah I think so too.</p>
<blockquote>
<p>[...] I also think this PR could be merged independently without causing surprising behavior (and would strictly be an improvement). My inclination is to merge separately.</p>
</blockquote>
<p>Works for me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-04 16:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/base_client.rs</code>:360 on 2025-04-04 16:14</div>
            <div class="timeline-body"><p>I think I'd prefer just making <code>auth_middleware</code> mutable to make it clearer that we're unconditionally applying the auth middleware. We could also not make it mutable and unconditionally do (pseudocode) <code>auth_middleware.with_auth_indexes(self.auth_indexes.unwrap_or_default())</code>? Stepping up a level, why are we storing <code>Option&lt;Indexes&gt;</code> in the parent type and <code>Indexes</code> in the child type? If those were consistent, there wouldn't be a need to resolve the <code>Option</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-04 16:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:492 on 2025-04-04 16:19</div>
            <div class="timeline-body"><p>The only problem there is we usually go from more specific -&gt; less specific so...</p>
<p>Exact URL -&gt; Index -&gt; Realm</p>
<p>but Index is the most likely match here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-04 16:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-distribution-types/src/index_url.rs</code>:420 on 2025-04-04 16:24</div>
            <div class="timeline-body"><p>Ah, the cycle is unfortunate.</p>
<p>I looked around a bit... but I don't see an obvious path forward. What would the refactor look like? e.g., would a <code>uv-index</code> crate resolve the problem? Generally our bar for refactoring the crate dependencies is not high.</p>
<blockquote>
<p>But it also made sense to me to pay the small memory cost of storing both URLs to avoid recalculating the URLs every time.</p>
</blockquote>
<p>I have no qualms about the memory cost. It's the indirection that worries me (from a maintenance / understanding perspective). I think we might want to explore a different strategy for comparing the URLs so we don't need to depend on storing a mutated version â€” but that can happen separately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-04-04 16:33</div>
            <div class="timeline-body"><p>I'd retitle to be more relevant to users (otherwise, I just have to do it on release) e.g.:</p>
<blockquote>
<p>Use index URL instead of package URL for keyring credential lookups</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-04-04 16:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-auth/src/middleware.rs</code>:492 on 2025-04-04 16:55</div>
            <div class="timeline-body"><p>If we know there's a corresponding index URL, I think we should prefer it since that's the expected behavior. I'm not sure there's an advantage to starting from the most specific URL in that case. Really the only reason to check the package URL if credentials aren't found for the index URL is in case any users are depending on the previous behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-client/src/base_client.rs</code>:360 on 2025-04-04 17:01</div>
            <div class="timeline-body"><p>Are you commenting on the latest version of this?</p>
<pre><code>                        let auth_middleware = if let Some(auth_indexes) = &amp;self.auth_indexes {
                            AuthMiddleware::new().with_auth_indexes(auth_indexes.clone())
                        } else {
                            AuthMiddleware::new()
                        }
                        .with_keyring(self.keyring.to_provider())
                        .with_only_authenticated(true);

                        client = client.with(auth_middleware);
       
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-04-04 17:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-04-04 17:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-client/src/base_client.rs</code>:360 on 2025-04-04 17:05</div>
            <div class="timeline-body"><p>The <code>BaseClientBuilder</code> has an <code>Option</code> because there might be no auth indexes for that <code>BaseClient</code>, which seemed like useful information. But <code>AuthMiddleware</code>, which is constructed later, does at least have an empty one. We could have <code>AuthMiddleware.with_auth_indexes</code> take an <code>Option</code>, simplifying the above code, but that's not standard.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Fetch keyring credentials from index URL in auth middleware" to "Use index URL instead of package URL for keyring credential lookups" by @jtfmumm on 2025-04-04 17:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-04 17:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/base_client.rs</code>:360 on 2025-04-04 17:06</div>
            <div class="timeline-body"><p>Sorry, no. I hadn't reviewed the code again â€” I was just commenting on the discussion (and I misread &quot;This new version configures auth_middleware first and then applies it to the client.&quot;).</p>
<p>This seems like an improvement, but I still wonder about the need for the <code>Option</code> type at all? (edit: we commented concurrently here)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-04-04 17:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-distribution-types/src/index_url.rs</code>:420 on 2025-04-04 17:08</div>
            <div class="timeline-body"><p>If we copy the root() logic in the <code>uv_auth</code> crate then we can just pass (url, policy) pairs into the <code>uv_auth::Indexes</code> constructor. Then we will manage the URLs close to where they're used.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-04 17:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/base_client.rs</code>:360 on 2025-04-04 17:08</div>
            <div class="timeline-body"><blockquote>
<p>The BaseClientBuilder has an Option because there might be no auth indexes for that BaseClient, which seemed like useful information. But AuthMiddleware, which is constructed later, does at least have an empty one. We could have AuthMiddleware.with_auth_indexes take an Option, simplifying the above code, but that's not standard.</p>
</blockquote>
<p>Why is it useful information though? It seems surprising that we care about representing the <code>Option</code> in one place but not the other (i.e., in <code>AuthMiddleware</code> we just initialize an empty set of URLs). There are a few other <code>AuthMiddleware</code> methods that take an <code>Option</code>, it just depends on the type it's storing internally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-04 17:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-distribution-types/src/index_url.rs</code>:420 on 2025-04-04 17:11</div>
            <div class="timeline-body"><p>I'm hesitant to copy the <code>root()</code> logic. My goal is to keep the meaning of <code>Index::root</code> in a single place, which is why I prefer to refer to <code>Index</code> directly within the authentication logic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-04 17:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/base_client.rs</code>:360 on 2025-04-04 17:13</div>
            <div class="timeline-body"><p>Concretely, since <code>AuthMiddleware</code> is always constructed here, then there shouldn't be a case where a <code>None</code> for <code>AuthIndexes</code> avoids overwriting some pre-inserted value in <code>AuthMiddleware</code>, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-04-04 18:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-distribution-types/src/index_url.rs</code>:420 on 2025-04-04 18:47</div>
            <div class="timeline-body"><p>This will require some significant crate changes. <code>Index</code> depends on both <code>uv_auth::AuthPolicy</code> and <code>uv_auth::Credentials</code>. We might need to move <code>AuthMiddleware</code> into <code>uv_client</code> and have it depend on both <code>uv_auth</code> and <code>uv_distribution_types</code>. But the credentials cache code doesn't expose everything as <code>pub</code>, so we'll need to think about where that belongs. Possibly we'll need to divide up <code>uv_auth</code>.</p>
<p>Do you consider this a blocking issue for this PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-client/src/base_client.rs</code>:360 on 2025-04-04 18:57</div>
            <div class="timeline-body"><p>I've updated so that <code>BasicClientBuilder</code> no longer uses an <code>Option</code> and then simplified this code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-04-04 18:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-04 18:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-distribution-types/src/index_url.rs</code>:420 on 2025-04-04 18:59</div>
            <div class="timeline-body"><p>No, not blocking. I'm just trying to build a better understanding of the problem now. I would feel differently if it required less refactoring but I think it's an okay trade-off to leave it as is. Maybe leave a TODO in there?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-04 19:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/base_client.rs</code>:360 on 2025-04-04 19:05</div>
            <div class="timeline-body"><p>Thank you, appreciate it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-04-04 19:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-distribution-types/src/index_url.rs</code>:420 on 2025-04-04 19:07</div>
            <div class="timeline-body"><p>Added</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-04 19:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:492 on 2025-04-04 19:09</div>
            <div class="timeline-body"><blockquote>
<p>I'm not sure there's an advantage to starting from the most specific URL in that case.</p>
</blockquote>
<p>The primary advantages are that:</p>
<ol>
<li>It's consistent with our general authentication strategy</li>
<li>It's definitely backwards compatible â€” if a keyring provider has different handling for child resources in an index, this is a breaking change as-is</li>
</ol>
<p>I actually think there's probably no benefit to falling back to checking for the full URL if there aren't credentials at the index level, that seems even more unlikely than the case in (2).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-04 19:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:492 on 2025-04-04 19:10</div>
            <div class="timeline-body"><p>I'm tempted to say we should just &quot;do the breaking change&quot; here? We could release the behavior change under preview then stabilize in 0.7.0? or just hold off until 0.7.0?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">breaking</span> added by @jtfmumm on 2025-04-04 19:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v0.7.0" by @jtfmumm on 2025-04-04 19:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-04-04 19:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-auth/src/middleware.rs</code>:492 on 2025-04-04 19:14</div>
            <div class="timeline-body"><p>That's fine by me. I've updated the code, added a <code>breaking</code> label, and added this to the milestone.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-04-07 14:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv-auth/src/middleware.rs</code>:480 on 2025-04-07 14:35</div>
            <div class="timeline-body"><p>I've implemented this in #12717. We could either merge that into this PR if approved or merge it after this one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2025-04-07 23:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-09 15:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/it/pip_install.rs</code>:5435 on 2025-04-09 15:21</div>
            <div class="timeline-body"><p>Sorry if I'm just missing this, but... is there a test case here where the keyring has credentials for the index level and we <em>don't</em> fallback to the realm request?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/it/pip_install.rs</code>:5435 on 2025-04-09 15:22</div>
            <div class="timeline-body"><p>Similarly, is there a test case where the keyring has credentials for the full URL but not at the index or realm level?</p>
<p>(These would be achieved by tweaking <code>EnvVars::KEYRING_TEST_CREDENTIALS, r#&quot;{&quot;pypi-proxy.fly.dev&quot;: {&quot;other&quot;: &quot;heron&quot;}}&quot;</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-04-09 15:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-04-09 17:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv/tests/it/pip_install.rs</code>:5435 on 2025-04-09 17:34</div>
            <div class="timeline-body"><blockquote>
<p>Sorry if I'm just missing this, but... is there a test case here where the keyring has credentials for the index level and we <em>don't</em> fallback to the realm request?</p>
</blockquote>
<p>That test is in the follow-on PR #12717 (which we can merge into this one).</p>
<blockquote>
<p>Similarly, is there a test case where the keyring has credentials for the full URL but not at the index or realm level?</p>
<p>(These would be achieved by tweaking <code>EnvVars::KEYRING_TEST_CREDENTIALS, r#&quot;{&quot;pypi-proxy.fly.dev&quot;: {&quot;other&quot;: &quot;heron&quot;}}&quot;</code>)</p>
</blockquote>
<p>I don't have this test, so I can add it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jtfmumm">@jtfmumm</a> reviewed on 2025-04-10 15:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on <code>crates/uv/tests/it/edit.rs</code>:10270 on 2025-04-10 15:41</div>
            <div class="timeline-body"><p>@zanieb Here is the full URL test. As discussed in another thread, we don't actually check the full URL in the keyring now for indexes, which is reflected here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-04-18 21:27</div>
            <div class="timeline-body"><p>Is this waiting on anything?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on 2025-04-18 21:38</div>
            <div class="timeline-body"><blockquote>
<p>Is this waiting on anything?</p>
</blockquote>
<p>No itâ€™s ready</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-04-18 21:40</div>
            <div class="timeline-body"><p>I think it needs to be based on release/070 instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jtfmumm">@jtfmumm</a> on 2025-04-18 21:43</div>
            <div class="timeline-body"><p>Yeah I can do that this weekend</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @jtfmumm on 2025-04-19 07:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @jtfmumm on 2025-04-19 07:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-19 07:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:22 UTC
    </footer>
</body>
</html>
