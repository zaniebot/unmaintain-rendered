<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support remote `https://` requirements files (#1332) - astral-sh/uv #2081</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Support remote <code>https://</code> requirements files (#1332)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/2081">#2081</a>
        opened by <a href="https://github.com/jannisko">@jannisko</a>
        on 2024-02-29 14:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/jannisko">@jannisko</a> on 2024-02-29 14:32</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Allow using http(s) urls for constraints and requirements files handed to the CLI, by handling paths starting with <code>http://</code> or <code>https://</code> differently. This allows commands for such as: <code>uv pip install -c https://raw.githubusercontent.com/apache/airflow/constraints-2.8.1/constraints-3.8.txt requests</code>.</p>
<p>closes #1332</p>
<h2>Test Plan</h2>
<p>Testing install using a <code>constraints.txt</code> file hosted on github in the airflow repository:
https://github.com/jannisko/uv/blob/fbdc2eba8e5e8fb4160baae495daff8fb48df13f/crates/uv/tests/pip_install.rs#L1440-L1484</p>
<h2>Advice Needed</h2>
<ul>
<li>filesystem/http dispatch is implemented at a relatively low level (at <code>crates/uv-fs/src/lib.rs#read_to_string</code>). Should I change some naming here so it is obvious that the function is able to dispatch?</li>
<li>I kept the CLI argument for -c and -r as a PathBuf, even though now it is technically either a path or a url. We could either keep this as is for now, or implement a new enum for this case? The enum could then handle dispatch to files/http.</li>
<li>Using another abstraction layer like https://docs.rs/object_store/latest/object_store/ for the files/urls/[s3] could work as well, though I ran into a bug during testing which I couldn't debug</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @charliermarsh on 2024-02-29 14:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-02-29 14:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by @charliermarsh on 2024-02-29 14:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-02-29 14:59</div>
            <div class="timeline-body"><p>Thanks! I've been conflicted on whether to support this but ultimately it does seem reasonable.</p>
<blockquote>
<p>For now, only manually tested. I need advice on how to test this feature. Is a test using a permalink to a GitHub repo considered stable enough for this case or do we need a temp http server for tests?</p>
</blockquote>
<p>Using a permalink to a GitHub repo is totally fine and consistent with some of our other tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jannisko">@jannisko</a> on 2024-03-01 16:33</div>
            <div class="timeline-body"><p>Ready for review now in my eyes. I tried replacing the <code>PathBuf</code> with something more expressive, like a <code>LocalOrHttpPath</code> enum, but this turned into a mess. Paths really are a good way of handling this use case IMO. Even nested requirements/constraints files work out of the box via https, as long as they are also located in the same relative position on the server.</p>
<p>e.g.
/inner/requirements.txt:</p>
<pre><code>requests
-r ../requirements.txt
</code></pre>
<p>/requirements.txt</p>
<pre><code>ruff
</code></pre>
<pre><code>$ cargo run -- pip install -r http://localhost:8000/inner/requirements.txt
    Finished dev [unoptimized + debuginfo] target(s) in 0.19s
     Running `target/debug/uv pip install -r 'http://localhost:8000/inner/requirements.txt'`
Resolved 6 packages in 614ms
Downloaded 1 package in 2.56s
Installed 6 packages in 30ms
 + certifi==2024.2.2
 + charset-normalizer==3.3.2
 + idna==3.6
 + requests==2.31.0
 + ruff==0.3.0
 + urllib3==2.2.1
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "support remote http[s] constraint.txt files (#1332)" to "support remote http[s] constraints/requirements/overrides.txt files (#1332)" by @jannisko on 2024-03-01 16:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-01 18:13</div>
            <div class="timeline-body"><p>Okay cool, thank you! Acknowledging that it's now blocked on me reviewing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/potiuk">@potiuk</a> on 2024-03-02 08:35</div>
            <div class="timeline-body"><p>Just to add to the weight here: This is also <a href="https://airflow.apache.org/docs/apache-airflow/stable/installation/installing-from-pypi.html">Highly used feature in apache-airflow</a> - if users of airflow would like to use the recommended installation option - they cannot use it directly now with uv - they need to download the constraints first.</p>
<p>This caused a small hicc-up in our CI images in Airflow (as I did not notice that remove constraints installation was not working with uv. I fix it in https://github.com/apache/airflow/pull/37845 (and generally downloading constraints to CI image is a good idea) - but users trying to do reproducible installation of Airlfow should be able to use the URL, so big cheering on that one :).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-02 22:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-fs/src/lib.rs</code>:76 on 2024-03-02 22:20</div>
            <div class="timeline-body"><p>I think I would prefer to add dedicated methods for this in <code>requirements-txt</code>, for two reasons:</p>
<ol>
<li>I don't think we want to allow users to provide <code>pyproject.toml</code> files as URLs for now. I'd just prefer to limit it to requirements files since no tool supports remote <code>pyproject.toml</code> (and, in practice, we're actually supposed to <em>build the project</em> when we're given a <code>pyproject.toml</code>, so this wouldn't work correctly in all cases).</li>
<li>Adding <code>reqwest</code> as a dep to <code>uv-fs</code> feels heavy since this crate is supposed to be lightweight.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-02 22:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/requirements-txt/src/lib.rs</code>:392 on 2024-03-02 22:20</div>
            <div class="timeline-body"><p>So the join here is fine even if <code>filename</code> is a URL?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-02 22:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/requirements-txt/src/lib.rs</code>:327 on 2024-03-02 22:23</div>
            <div class="timeline-body"><p>On the question of using <code>Path</code>: Part of me feels like we should be using <code>VerbatimUrl</code> for this (used elsewhere in this crate). <code>VerbatimUrl</code> can represent both URLs and paths, but it preserves the user-provided representation, which we leverage to ensure that we <em>don't</em> expand environment variables (like secrets) when we write results back out to <code>requirements.txt</code>. I think we would need a <code>join</code> method on it, which would perhaps be somewhat awkward... But would you mind giving it a try, and seeing if it fits? Alternatively, we can punt it to another PR -- I would be open to merging without it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-02 22:23</div>
            <div class="timeline-body"><p>This looks good, thanks! Some comments below, only one blocking.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-02 22:31</div>
            <div class="timeline-body"><p>Oh, one other critical point: how does this work with authentication? Does pip support reading from URLs that require authentication?</p>
<p>We probably need to pass through our <code>RegistryClient</code> or something similarly-constructed. That would also ensure that this behavior respects the <code>--offline</code> flag.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jannisko">@jannisko</a> on <code>crates/uv-fs/src/lib.rs</code>:76 on 2024-03-04 12:09</div>
            <div class="timeline-body"><p>Very fair point. Didn't even realize <code>read_to_string</code> is only called in <code>RequirementsTxt::parse</code> and for parsing <code>RequirementsSource::PyprojectToml</code>. So this change should be easy to isolate to <code>RequirementsTxt</code> üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jannisko">@jannisko</a> reviewed on 2024-03-04 12:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jannisko">@jannisko</a> reviewed on 2024-03-04 12:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jannisko">@jannisko</a> on <code>crates/requirements-txt/src/lib.rs</code>:392 on 2024-03-04 12:23</div>
            <div class="timeline-body"><p>Yup works really well from my testing. It is basically handled like a relative path starting with the <code>http:</code> directory. The only sketchy thing I could find for now is that it doesn't survive a round trip through <code>.components()</code>:
<code>PathBuf::from_iter(PathBuf::from_str(&quot;http://test/abc.txt&quot;).unwrap().components())</code> = <code>http:/test/abc.txt</code> (one <code>/</code> missing).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jannisko">@jannisko</a> reviewed on 2024-03-04 12:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jannisko">@jannisko</a> on <code>crates/requirements-txt/src/lib.rs</code>:327 on 2024-03-04 12:26</div>
            <div class="timeline-body"><p>I'd like to give it a try in a separate PR!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jannisko">@jannisko</a> on 2024-03-04 14:54</div>
            <div class="timeline-body"><blockquote>
<p>Oh, one other critical point: how does this work with authentication? Does pip support reading from URLs that require authentication?</p>
</blockquote>
<p>Pip seems to ask for interactive input when the url requires auth:</p>
<pre><code>$ pip install -r http://localhost:8000/requirements.txt
User for localhost:8000: jannis
Password: 
Requirement already satisfied: ruff in /Users/jannis_kowalick/.pyenv/versions/3.10.9/lib/python3.10/site-packages (from -r http://localhost:8000/requirements.txt (line 1)) (0.2.1)
</code></pre>
<p>With my current implementation, uv would interpret the &quot;no auth header&quot; message as a package name, which seems dangeous:</p>
<pre><code>$ uv pip install -r http://localhost:8000/requirements.txt
error: Unsupported requirement in http://localhost:8000/requirements.txt at position 0
  Caused by: URL requirement must be preceded by a package name. Add the name of the package before the URL (e.g., `package_name @ https://...`).
no auth header received
^^
</code></pre>
<p>I'll try to figure out how to mirror pips behavior, and take a look at the <code>RegistryClient</code> as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jannisko">@jannisko</a> reviewed on 2024-03-05 13:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jannisko">@jannisko</a> on <code>crates/uv-fs/src/lib.rs</code>:76 on 2024-03-05 13:05</div>
            <div class="timeline-body"><p>implemented in <a href="https://github.com/astral-sh/uv/pull/2081/commits/1ef5aacfb0064022b9273a0248448d232bbbb946">1ef5aac</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jannisko">@jannisko</a> on 2024-03-05 13:08</div>
            <div class="timeline-body"><p>@charliermarsh I moved the http handling into <code>requirements-txt</code> and I'm handing the <code>RegistryClient</code> over in there now too. Let me know what you think!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @charliermarsh on 2024-03-05 23:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-03-06 03:58</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-03-06 04:00</div>
            <div class="timeline-body"><p>@jannisko -- I mostly made cosmetic changes, but I did make one behavioral change, which is that I removed <code>dialoguer</code>. I'd like to see if this comes up in practice for users before adding support for interactively prompting credentials -- it adds complexity, and it's also yet another dependency in our tree. If we need to restore, we'll always have it here in the Git history.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "support remote http[s] constraints/requirements/overrides.txt files (#1332)" to "Support remote `https://` requirements files (#1332)" by @charliermarsh on 2024-03-06 04:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-03-06 04:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-03-06 04:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jannisko">@jannisko</a> on 2024-03-06 06:47</div>
            <div class="timeline-body"><p>Thanks a lot @charliermarsh for all the feedback!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 14:55:03 UTC
    </footer>
</body>
</html>
