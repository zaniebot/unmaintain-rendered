<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>feat: add environment variable to disable writing installer metadata files - astral-sh/uv #8877</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>feat: add environment variable to disable writing installer metadata files</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/8877">#8877</a>
        opened by <a href="https://github.com/adisbladis">@adisbladis</a>
        on 2024-11-07 04:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/adisbladis">@adisbladis</a> on 2024-11-07 04:48</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This change introduces the <code>UV_NO_INSTALLER_METADATA</code> environment variable
as a way to opt out of the extra installer metadata files that <code>uv</code> is creating.</p>
<p>This is important to achieve reproducible builds in distribution
packaging, allowing to replace usage of
<a href="https://pypi.org/project/installer">installer</a> with <code>uv pip install</code>.</p>
<p>At the time of writing these files are:</p>
<ul>
<li><p><code>uv_cache.json</code>
Contains timestamps which are non-reproducible.
These hashes also leak in to the <code>RECORD</code> file.</p>
</li>
<li><p><code>direct_url.json</code>
Contains the path to the installed wheel.
While not non-reproducible it's not required for distribution packaging.</p>
</li>
<li><p><code>INSTALLER</code>
Again, not non-reproducible, but of no value in distribution packaging.</p>
</li>
</ul>
<h2>Test Plan</h2>
<p>Automated test added.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-11-07 05:16</div>
            <div class="timeline-body"><p>Thanks for putting up the PR!</p>
<p>Note to other reviewers, we briefly discussed using an environment variable for this in <a href="https://discord.com/channels/1039017663004942429/1207998321562619954/1303899841994424330">Discord</a>.</p>
<p>I don't have strong opinions on the name, but we might want to use <code>UV_NO_EXTRA_DIST_INFO=1</code> rather than <code>UV_EXTRA_DIST_INFO=0</code>?</p>
<p>Otherwise, I'm not well suited to be the primary reviewer for this. Perhaps @konstin or @charliermarsh would be interested.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/j178">@j178</a> reviewed on 2024-11-07 05:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/j178">@j178</a> on <code>crates/uv-static/src/env_vars.rs</code>:555 on 2024-11-07 05:20</div>
            <div class="timeline-body"><p>&quot;Set to false to skip writing <code>uv</code> cache &amp; installer files to site-packages dist-info.&quot; ?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/adisbladis">@adisbladis</a> on <code>crates/uv-static/src/env_vars.rs</code>:555 on 2024-11-07 05:34</div>
            <div class="timeline-body"><p>There are no other env vars written in that style, and I believe the wording makes more sense since the name was swapped from <code>UV_EXTRA_DIST_INFO</code> to <code>UV_NO_EXTRA_DIST_INFO</code>, with the logic inverted from previously.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/adisbladis">@adisbladis</a> reviewed on 2024-11-07 05:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/adisbladis">@adisbladis</a> on 2024-11-07 05:34</div>
            <div class="timeline-body"><blockquote>
<p>I don't have strong opinions on the name, but we might want to use UV_NO_EXTRA_DIST_INFO=1 rather than UV_EXTRA_DIST_INFO=0?</p>
</blockquote>
<p>It made more sense to me when writing this to think about it the other way around, but it's indeed seems more consistent with other options to use <code>UV_NO_EXTRA_DIST_INFO=1</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-11-07 08:52</div>
            <div class="timeline-body"><p>What's the motivation for going through wheel installation for repackaging over re-zipping the wheel into the target format you are interested in?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/adisbladis">@adisbladis</a> on 2024-11-07 09:41</div>
            <div class="timeline-body"><blockquote>
<p>What's the motivation for going through wheel installation for repackaging over re-zipping the wheel into the target format you are interested in?</p>
</blockquote>
<p>Sorry, I don't understand the question? I'll explain my use case in more detail, hopefully we'll find some understanding.</p>
<p>The use case for this PR is to replace usage of <code>installer</code> with <code>uv</code> in distribution packaging scripts.
These scripts need to:</p>
<ul>
<li>Invoke a Python build system, such as <code>pypa/build</code> which takes a source tree and outputs a wheel<ul>
<li>Or download a pre-built wheel</li>
</ul>
</li>
<li>Invoke an installer that can install said wheel into a prefix</li>
</ul>
<p>In <a href="https://github.com/nixos/nixpkgs/">nixpkgs</a> we use:</p>
<ul>
<li><a href="https://github.com/NixOS/nixpkgs/blob/57c2e56/pkgs/development/interpreters/python/hooks/pypa-install-hook.sh#L11"><code>pypa/installer</code></a> to install Python wheels.</li>
<li><a href="https://github.com/NixOS/nixpkgs/blob/57c2e5683de7cd80ce44702b56fb22c614407a7e/pkgs/development/interpreters/python/hooks/pypa-build-hook.sh#L9"><code>pypa/build</code></a> to build Python packages from source</li>
<li>In some rare cases download pre-built wheels</li>
</ul>
<p>For distribution packaging we want <a href="https://reproducible-builds.org/">reproducible builds</a>, meaning that the outputs produced by a packaging script should be bit-for-bit identical.
Nix comes with tooling to perform these checks: <code>nix-build ./. -A somePackage --check</code>.</p>
<p>I have implemented an alternative Python build infrastructure for Nix <a href="https://github.com/nix-community/pyproject.nix/blob/eba6cb2/build/hooks/pyproject-install-hook.sh#L11">where I use uv</a>.
These builds end up failing reproducibility checks because of extra dist info files.</p>
<p>At some point in the future I'd like to replace the nixpkgs install hook with a uv implementation too. A requisite for that is that outputs are reproducible.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @konstin on 2024-11-07 12:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/adisbladis">@adisbladis</a> on 2024-11-12 00:39</div>
            <div class="timeline-body"><p>Ping @charliermarsh</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-11-12 02:30</div>
            <div class="timeline-body"><p>I'm not super excited to maintain this but I see the value. I think we should call this &quot;installer metadata&quot; rather than &quot;extra dist-info&quot;, since the latter is just a term we made up within the wheel installer crate. How's that sound?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-11-12 02:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-install-wheel/src/linker.rs</code>:48 on 2024-11-12 02:31</div>
            <div class="timeline-body"><p>I think this should be after <code>installer</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/project/sync.rs</code>:246 on 2024-11-12 02:32</div>
            <div class="timeline-body"><p>I'm not gonna make the case that anything here is well-ordered but we do consistently end with cache and then printer. And generally, we try to put the global arguments at the bottom. I think this should be after logger maybe?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-11-12 02:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/adisbladis">@adisbladis</a> reviewed on 2024-11-22 05:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/adisbladis">@adisbladis</a> on <code>crates/uv/src/commands/project/sync.rs</code>:246 on 2024-11-22 05:22</div>
            <div class="timeline-body"><p>I didn't know what the right call was, so I just put it last.
I've now realigned this with your comments as best as I could.</p>
<p>It's indeed not perfectly consistent, but I think it makes more organisational sense now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/adisbladis">@adisbladis</a> on 2024-11-22 05:39</div>
            <div class="timeline-body"><blockquote>
<p>I'm not super excited to maintain this but I see the value.</p>
</blockquote>
<p>Thank you. I understand that the use case is a bit niche from a Python perspective.</p>
<blockquote>
<p>I think we should call this &quot;installer metadata&quot; rather than &quot;extra dist-info&quot;, since the latter is just a term we made up within the wheel installer crate. How's that sound?</p>
</blockquote>
<p>Yep, that sounds much better!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "feat: add environment variable to disable writing extra dist-info files" to "feat: add environment variable to disable writing installer metadata files" by @adisbladis on 2024-11-22 05:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/adisbladis">@adisbladis</a> on 2024-12-03 22:50</div>
            <div class="timeline-body"><p>Ping again @charliermarsh</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @zanieb on 2024-12-03 22:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-12-04 00:47</div>
            <div class="timeline-body"><p>Ack, will review (and hopefully merge) soon.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-12-04 01:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-12-04 01:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-12-04 01:29</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 12:31:14 UTC
    </footer>
</body>
</html>
