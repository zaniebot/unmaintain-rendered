<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix nested retry loops for transient network errors - astral-sh/uv #17267</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix nested retry loops for transient network errors</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/uv/pull/17267">#17267</a>
        opened by <a href="https://github.com/shayonj">@shayonj</a>
        on 2025-12-30 14:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/shayonj">@shayonj</a></div>
            <div class="timeline-body">Summary
<p>Fixes a regression where transient network errors (like DNS failures) cause nested retry loops,
resulting in ~16 retry attempts instead of 4 and significantly longer failure times (~17-19s vs ~4s).</p>
Problem
<p>After #17104, both the middleware (<code>RetryTransientMiddleware</code>) and the cached client layer
(<code>RetryState::should_retry</code>) independently retry transient network errors. When the middleware
exhausts its retry budget and returns an error, <code>should_retry</code> starts a fresh retry loop,
causing nested retries.</p>
Fix
<p><code>RetryState::should_retry</code> now only tracks middleware retries for error reporting instead of
initiating additional retries for transient errors. The middleware already handles transient
retry logic, so duplicating it here causes the nested loops.</p>
Test Plan
<ul>
<li>All existing network tests pass</li>
<li>Manual test with invalid DNS shows ~4s failure time (was ~17-19s) using the replication script in <a href="https://github.com/astral-sh/uv/issues/17266">astral-sh/uv#17266</a></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-30 15:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/base_client.rs</code>:1149 on 2025-12-30 15:25</div>
            <div class="timeline-body"><p>It&#x27;s fine to break API compatibility here, every release is considered breaking at this time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-30 15:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/shayonj">@shayonj</a> on 2025-12-30 18:13</div>
            <div class="timeline-body"><p>looks like there is a fix proposed in <a href="https://github.com/astral-sh/uv/pull/17274">astral-sh/uv#17274</a>. Closing on behalf</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/shayonj">@shayonj</a> on 2025-12-30 18:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-30 18:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EliteTK">@EliteTK</a> on 2025-12-30 18:35</div>
            <div class="timeline-body"><p>@shayonj ah, my apologies, I had missed that you were already working on a fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/shayonj">@shayonj</a> on 2025-12-30 18:45</div>
            <div class="timeline-body"><p>no probs at all! thank you for the fast fix</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:55:02 UTC
    </footer>
</body>
</html>
