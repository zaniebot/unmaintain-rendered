<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use the same retry logic across uv - astral-sh/uv #17105</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use the same retry logic across uv</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/17105">#17105</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2025-12-12 17:44
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>We were using slightly different retry code in multiple places, this PR unifies it.</p>
<p>Also fixes retry undercounting in publish if the retry middleware was involved.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/konstin">@konstin</a> on 2025-12-15 14:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/EliteTK">@EliteTK</a> by <a href="https://github.com/konstin">@konstin</a> on 2025-12-15 17:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/konstin">@konstin</a> on 2025-12-16 09:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-client/src/base_client.rs</code>:1142 on 2025-12-16 10:35</div>
            <div class="timeline-body"><p>nitpick: The type itself isn&#x27;t deciding.</p>
<pre><code>/// Per-request retry state and policy.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-client/src/base_client.rs</code>:1159 on 2025-12-16 11:52</div>
            <div class="timeline-body"><p>Maybe it would be good to add a comment mentioning that new starts a timer? Otherwise someone might initialise this too early by accident.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-client/src/base_client.rs</code>:1192 on 2025-12-16 13:23</div>
            <div class="timeline-body"><p>I think it looks odd for a function named <code>should_retry</code> to be async and to sleep.</p>
<p>Maybe the alternative is to return e.g. the metadata for how long the function expects to sleep for, and handling that externally? the debug! and URL could also then be done externally...</p>
<p>Not sure, I think I have a better overall idea for how this may be approached later but maybe this is fine for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-client/src/base_client.rs</code>:1176 on 2025-12-16 14:04</div>
            <div class="timeline-body"><p>I still think this comment is confusing as the point at which we are &quot;considering&quot; the upstream retries is when we add them. I would just drop it.</p>
<pre><code></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-bin-install/src/lib.rs</code>:262 on 2025-12-16 14:11</div>
            <div class="timeline-body"><p>You modified <code>attempts</code> in another place to be <code>retries</code> and removed the +1. Is this use of <code>attempts</code> still accurate? In the original code, <code>1</code> is subtracted from this value.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> approved on 2025-12-16 15:04</div>
            <div class="timeline-body"><p>I spent a bit more time on this because I wanted to understand the code better.</p>
<p>I think the approach of hiding the timing/debug stuff may be confusing. I think maybe this would be better served as a <code>get_retry_delay&lt;E, P&gt;(err: E, policy: &amp;P, time, retries) -&gt; Result&lt;Duration, (E, u32)&gt;</code> function or something, with the time tracking, waiting, and <code>debug!</code> being explicitly outside.</p>
<p>To demonstrate the above idea, and to understand if it would help, I tried having a function like:</p>
<pre><code>pub async fn retry_with_policy&lt;P, T, E, F&gt;(
    retry_policy: &amp;P,
    url: &amp;Url,
    mut make_request: F,
) -&gt; Result&lt;T, (E, u32)&gt;
where
    P: RetryPolicy,
    E: TriedRequestError,
    F: AsyncFnMut() -&gt; Result&lt;T, E&gt;,
{
    let start_time = SystemTime::now();
    let mut total_retries = 0;

    loop {
        match make_request().await {
            Ok(ok) =&gt; return Ok(ok),
            Err(err) =&gt; {
                let delay = get_retry_delay(err, retry_policy, start_time, total_retries)?;
                debug!(
                    &quot;Transient failure while handling response from {}; retrying after {:.1}s...&quot;,
                    DisplaySafeUrl::ref_cast(url),
                    delay.as_secs_f32(),
                );
                tokio::time::sleep(delay).await;
                total_retries += 1;
            }
        }
    }
}
</code></pre>
<p>Which you would use like (in <code>CachedClient::get_cacheable_with_retry</code>):</p>
<pre><code>retry_with_policy(&amp;self.uncached().retry_policy(), &amp;req.url(), async || {
    let fresh_req = req.try_clone().expect(&quot;HTTP request must be cloneable&quot;);
    self.get_cacheable(fresh_req, cache_entry, cache_control, &amp;response_callback)
        .await
})
.await
.map_err(|(err, retries)| err.with_retries(retries))
</code></pre>
<p>But I couldn&#x27;t come up with a good approach which would work for <code>uv_publish::upload</code>. It does work for all the other cases though.</p>
<p>I guess one option would then be to just use the function in the plases where it works and use <code>get_retry_delay</code> maybe with some helper for waiting and <code>debug!</code>.</p>
<p>This would reduce the boilerplate even further, railroad users (developers) towards the happy path more, and avoid the possibility of starting the timer too early.</p>
<p>Just an idea though, may not be appropriate for this PR in particular.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-12-16 16:15</div>
            <div class="timeline-body"><blockquote>
<p>I think the approach of hiding the timing/debug stuff may be confusing. I think maybe this would be better served as a <code>get_retry_delay&lt;E, P&gt;(err: E, policy: &amp;P, time, retries) -&gt; Result&lt;Duration, (E, u32)&gt;</code> function or something, with the time tracking, waiting, and <code>debug!</code> being explicitly outside.</p>
</blockquote>
<p>The motivation for this change is that the implementations for this diverged slightly between the different code locations so I wanted to move them into a single location, otherwise I&#x27;d kept the logging and the waiting in the <code>loop</code> where it was before</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-bin-install/src/lib.rs</code>:262 on 2025-12-16 16:17</div>
            <div class="timeline-body"><p>Missed that this one does that too, fixed!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-12-16 16:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-12-16 16:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/base_client.rs</code>:1159 on 2025-12-16 16:25</div>
            <div class="timeline-body"><p>Good idea, renamed to <code>start</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/base_client.rs</code>:1192 on 2025-12-16 16:27</div>
            <div class="timeline-body"><p>I&#x27;ve renamed the function, the motivation is that I want to avoid the implementation from diverging. A secondary motivation that we have this boilerplate for each streaming request, and I&#x27;d like to keep that concise; Ideally it would be a part of the client, that doesn&#x27;t work with e.g. our streaming hashing and unpacking:</p>
<pre><code>loop {
    let result = fetch(...).await;
    match result {
        Ok(download_result) =&gt; return Ok(download_result),
        Err(err) =&gt; {
            if retry_state
                .handle_retry_and_backoff(&amp;err, err.retries())
                .await
            {
                continue;
            }
            return if retry_state.total_retries() &gt; 0 {
                Err(Error::NetworkErrorWithRetries {
                    err: Box::new(err),
                    retries: retry_state.total_retries(),
                })
            } else {
                Err(err)
            };
        }
    };
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-12-16 16:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2025-12-16 16:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>crates/uv-client/src/base_client.rs</code>:1192 on 2025-12-16 16:35</div>
            <div class="timeline-body"><p>Yeah I understand the motivation, the previous situation wasn&#x27;t great, but that&#x27;s why I suggested this potential boilerplate (which would work for most of the cases here):</p>
<pre><code>return retry_with_policy(retry_policy, url, async || fetch(...).await)
    .await
    .map_err(|(err, retries)| {
        if retries &gt; 0 {
            Error::NetworkErrorWithRetries { err: Box::new(err), retries }
        } else {
            err
        }
    })
</code></pre>
<p>But I agree that this code is better than the previous situation, it was just something to consider for the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-12-17 11:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-client/src/base_client.rs</code>:1159 on 2025-12-17 11:34</div>
            <div class="timeline-body"><p>FWIW the timer is currently unused in our strategy, which only looks at the count altogether.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> approved on 2025-12-18 10:08</div>
            <div class="timeline-body"><p>I prefer this split up &quot;should_retry&quot; and &quot;sleep_backoff&quot; approach more than the previous combined function.</p>
<p>The names much better represent what the functions are doing.</p>
<p>There are a few things I would do differently but at this point they&#x27;re just stylistic nitpicks/different opinions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/konstin">@konstin</a> on 2025-12-18 12:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/konstin">@konstin</a> on 2025-12-18 12:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-18 12:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:54:56 UTC
    </footer>
</body>
</html>
