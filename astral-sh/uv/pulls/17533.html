<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change chocolatey system test to ensure uv uses the right python - astral-sh/uv #17533</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Change chocolatey system test to ensure uv uses the right python</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/17533">#17533</a>
        opened by <a href="https://github.com/EliteTK">@EliteTK</a>
        on 2026-01-16 17:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a></div>
            <div class="timeline-body">Summary
<p>Fix #17524.</p>
Test Plan
<p>N/A</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-16 17:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">test:system</span> added by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-16 17:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-16 17:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-16 17:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-16 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-16 17:49</div>
            <div class="timeline-body"><p>Seems like the python path printing is borked now...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-16 17:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-16 18:17</div>
            <div class="timeline-body"><p>I think using <code>UV_TEST_PYTHON_PATH</code> isn&#x27;t okay in the context of the system tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-16 18:18</div>
            <div class="timeline-body"><p>I think the interpreter that invokes the system test script is the one that should be used, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-16 18:54</div>
            <div class="timeline-body"><p>The test script interpreter is the one whose parent directory I am putting in <code>UV_TEST_PYTHON_PATH</code>. Although I agree it&#x27;s kind of jank in retrospect. It could hide a bug in our path parsing.</p>
<p>As an alternative we could prepend to <code>$env:PATH</code> [^gh-path] before running the script.</p>
<p>I think the real weird thing here is that there&#x27;s no actual guarantee that <code>py -3.9</code> would pick the chocolatey version if some other 3.9 was installed, but I couldn&#x27;t find any good way to verify this invariant.</p>
<p>But at least I feel that setting <code>$env:PATH</code> prior to running the verification script would at least ensure that the script and uv both use the same python version.</p>
<p>Lastly, I could try to investigate why chocolatey&#x27;s path changes aren&#x27;t being picked up although I have a feeling that the answer is going to be either: &quot;the registry changes can&#x27;t be propagated to the runner without restarting the runner&quot; or &quot;github runners explicitly sanitize that somehow so the environment change doesn&#x27;t persist&quot;.</p>
<p>[^gh-path]: GITHUB_PATH seems to be for appending only, which isn&#x27;t helpful here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-16 19:04</div>
            <div class="timeline-body"><blockquote>
<p>I think the real weird thing here is that there&#x27;s no actual guarantee that py -3.9 would pick the chocolatey version if some other 3.9 was installed, but I couldn&#x27;t find any good way to verify this invariant.</p>
</blockquote>
<p>Can&#x27;t we just use the path that chocolatey is at instead of <code>py -3.9</code>? Maybe I&#x27;m missing something?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-16 19:05</div>
            <div class="timeline-body"><p>But yeah I think a point of these tests is uv&#x27;s discovery of system Python versions, so overriding that with our custom test path seems janky. That variable shouldn&#x27;t really be used in more places, it&#x27;s quite the blemish already imo (I added it, alas)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-16 19:26</div>
            <div class="timeline-body"><blockquote>
<p>Can&#x27;t we just use the path that chocolatey is at instead of <code>py -3.9</code>? Maybe I&#x27;m missing something?</p>
</blockquote>
<p>Yeah, sorry, I just realised there was a key bit of context I forgot:</p>
<p>It seems you can tell chocolatey where you&#x27;d like to put the installation, but it won&#x27;t listen if that version is already installed (it will overwrite at the existing location). There also doesn&#x27;t seem to be any good way of asking chocolatey where it did install it either.</p>
<p>This means using <code>C:\Python39\</code> (the default path) could break if we revert the runner image or a future image starts shipping python 3.9 again.</p>
<p>But, having thought about it, prepending <code>C:\Python39\</code> and then using <code>C:\Python39\python.exe .\script</code> is probably the safest option: it will fail if anything weird happens to the image which could cause us to e.g. start testing a non-chocolatey python version.</p>
<p>What might also work: We could try to set <code>$env:PATH</code> from the registry and invoke <code>python</code> instead of <code>py -3.9</code>. But we&#x27;d have to verify the version matches what we expect.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Set `UV_TEST_PYTHON_PATH` for the chocolatey system test to ensure uv uses the right python&quot; to &quot;Change chocolatey system test to ensure uv uses the right python&quot; by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-19 15:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-20 12:32</div>
            <div class="timeline-body"><p>@zanieb I went with the approach of refreshing the path from the registry. Although this means that <code>GITHUB_PATH</code> won&#x27;t work properly...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-20 14:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.github/workflows/test-system.yml</code>:549 on 2026-01-20 14:25</div>
            <div class="timeline-body"><p>Should we just put this into <code>check_system_python.py</code> with a <code>--python-version</code> flag?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.github/workflows/test-system.yml</code>:546 on 2026-01-20 14:25</div>
            <div class="timeline-body"><p>Can we add a comment explaining why this is needed?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-20 14:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-20 14:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.github/workflows/test-system.yml</code>:527 on 2026-01-20 14:26</div>
            <div class="timeline-body"><p>Does it make sense to include the patch version here? Doesn&#x27;t that mean when new security releases are out our test will break?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/EliteTK">@EliteTK</a> on <code>.github/workflows/test-system.yml</code>:527 on 2026-01-20 14:30</div>
            <div class="timeline-body"><p>Including the patch hasn&#x27;t broken so far for this specific test (as in, this isn&#x27;t a new addition), and 3.9 doesn&#x27;t receive security patches any more. I think the bigger risk is that chocolatey just entirely drops it. But that could be the case with any version we pick.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a> reviewed on 2026-01-20 14:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2026-01-20 14:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>.github/workflows/test-system.yml</code>:527 on 2026-01-20 14:55</div>
            <div class="timeline-body"><p>Oh, I see we were requesting this specific patch version. Thats fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> approved on 2026-01-20 15:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-20 16:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-20 16:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2026-01-20 16:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-20 16:07</div>
            <div class="timeline-body"><p>Dang it... It merges automatically even if system tests fail?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2026-01-20 16:15</div>
            <div class="timeline-body"><p>GitHub auto-merge can unfortunately only be configured on the required checks.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:55:17 UTC
    </footer>
</body>
</html>
