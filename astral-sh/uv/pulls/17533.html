<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change chocolatey system test to ensure uv uses the right python - astral-sh/uv #17533</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Change chocolatey system test to ensure uv uses the right python</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/uv/pull/17533">#17533</a>
        opened by <a href="https://github.com/EliteTK">@EliteTK</a>
        on 2026-01-16 17:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/EliteTK">@EliteTK</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fix #17524.</p>
<h2>Test Plan</h2>
<p>N/A</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @EliteTK on 2026-01-16 17:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">test:system</span> added by @EliteTK on 2026-01-16 17:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @EliteTK on 2026-01-16 17:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @EliteTK on 2026-01-16 17:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @EliteTK on 2026-01-16 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-16 17:49</div>
            <div class="timeline-body"><p>Seems like the python path printing is borked now...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @EliteTK on 2026-01-16 17:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-16 18:17</div>
            <div class="timeline-body"><p>I think using <code>UV_TEST_PYTHON_PATH</code> isn't okay in the context of the system tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-16 18:18</div>
            <div class="timeline-body"><p>I think the interpreter that invokes the system test script is the one that should be used, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-16 18:54</div>
            <div class="timeline-body"><p>The test script interpreter is the one whose parent directory I am putting in <code>UV_TEST_PYTHON_PATH</code>. Although I agree it's kind of jank in retrospect. It could hide a bug in our path parsing.</p>
<p>As an alternative we could prepend to <code>$env:PATH</code> [^gh-path] before running the script.</p>
<p>I think the real weird thing here is that there's no actual guarantee that <code>py -3.9</code> would pick the chocolatey version if some other 3.9 was installed, but I couldn't find any good way to verify this invariant.</p>
<p>But at least I feel that setting <code>$env:PATH</code> prior to running the verification script would at least ensure that the script and uv both use the same python version.</p>
<p>Lastly, I could try to investigate why chocolatey's path changes aren't being picked up although I have a feeling that the answer is going to be either: &quot;the registry changes can't be propagated to the runner without restarting the runner&quot; or &quot;github runners explicitly sanitize that somehow so the environment change doesn't persist&quot;.</p>
<p>[^gh-path]: GITHUB_PATH seems to be for appending only, which isn't helpful here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-16 19:04</div>
            <div class="timeline-body"><blockquote>
<p>I think the real weird thing here is that there's no actual guarantee that py -3.9 would pick the chocolatey version if some other 3.9 was installed, but I couldn't find any good way to verify this invariant.</p>
</blockquote>
<p>Can't we just use the path that chocolatey is at instead of <code>py -3.9</code>? Maybe I'm missing something?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-16 19:05</div>
            <div class="timeline-body"><p>But yeah I think a point of these tests is uv's discovery of system Python versions, so overriding that with our custom test path seems janky. That variable shouldn't really be used in more places, it's quite the blemish already imo (I added it, alas)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-16 19:26</div>
            <div class="timeline-body"><blockquote>
<p>Can't we just use the path that chocolatey is at instead of <code>py -3.9</code>? Maybe I'm missing something?</p>
</blockquote>
<p>Yeah, sorry, I just realised there was a key bit of context I forgot:</p>
<p>It seems you can tell chocolatey where you'd like to put the installation, but it won't listen if that version is already installed (it will overwrite at the existing location). There also doesn't seem to be any good way of asking chocolatey where it did install it either.</p>
<p>This means using <code>C:\Python39\</code> (the default path) could break if we revert the runner image or a future image starts shipping python 3.9 again.</p>
<p>But, having thought about it, prepending <code>C:\Python39\</code> and then using <code>C:\Python39\python.exe .\script</code> is probably the safest option: it will fail if anything weird happens to the image which could cause us to e.g. start testing a non-chocolatey python version.</p>
<p>What might also work: We could try to set <code>$env:PATH</code> from the registry and invoke <code>python</code> instead of <code>py -3.9</code>. But we'd have to verify the version matches what we expect.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Set `UV_TEST_PYTHON_PATH` for the chocolatey system test to ensure uv uses the right python" to "Change chocolatey system test to ensure uv uses the right python" by @EliteTK on 2026-01-19 15:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/EliteTK">@EliteTK</a> on 2026-01-20 12:32</div>
            <div class="timeline-body"><p>@zanieb I went with the approach of refreshing the path from the registry. Although this means that <code>GITHUB_PATH</code> won't work properly...</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 12:40:46 UTC
    </footer>
</body>
</html>
