<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validate that discovered interpreters meet the Python preference - astral-sh/uv #7934</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Validate that discovered interpreters meet the Python preference</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/7934">#7934</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-10-04 21:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-04 21:11</div>
            <div class="timeline-body"><p>Closes https://github.com/astral-sh/uv/issues/5144</p>
<p>e.g.</p>
<pre><code>❯ cargo run -q -- sync --python-preference only-system
Using CPython 3.12.6 interpreter at: /opt/homebrew/opt/python@3.12/bin/python3.12
Removed virtual environment at: .venv
Creating virtual environment at: .venv
Resolved 9 packages in 14ms
Installed 8 packages in 9ms
 + anyio==4.6.0
 + certifi==2024.8.30
 + h11==0.14.0
 + httpcore==1.0.5
 + httpx==0.27.2
 + idna==3.10
 + ruff==0.6.7
 + sniffio==1.3.1
 
❯ cargo run -q -- sync --python-preference only-managed
Using CPython 3.12.1
Removed virtual environment at: .venv
Creating virtual environment at: .venv
Resolved 9 packages in 14ms
Installed 8 packages in 11ms
 + anyio==4.6.0
 + certifi==2024.8.30
 + h11==0.14.0
 + httpcore==1.0.5
 + httpx==0.27.2
 + idna==3.10
 + ruff==0.6.7
 + sniffio==1.3.1
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2024-10-04 21:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-10-04 21:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/pip_tree.rs</code>:333 on 2024-10-04 21:37</div>
            <div class="timeline-body"><p>These tests broke for some reason — I don't really understand why but they're written incorrectly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-10-04 21:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/commands/project/mod.rs</code>:672 on 2024-10-04 21:38</div>
            <div class="timeline-body"><p>This split into the function above for readability.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @zanieb on 2024-10-07 21:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-10-07 21:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/pip_tree.rs</code>:333 on 2024-10-07 21:39</div>
            <div class="timeline-body"><p>(This was a bug that I fixed in a subsequent commit)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v0.5.0" by @zanieb on 2024-10-08 14:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-08 15:32</div>
            <div class="timeline-body"><p>We should probably opt active virtual environments out of this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-10-08 15:36</div>
            <div class="timeline-body"><blockquote>
<p>We should probably opt active virtual environments out of this?</p>
</blockquote>
<p>If i specifically pass <code>--python-preference only-system</code> i'd expect uv to invalidate the current venv and recreate, i sees this mismatch like requesting a different Python version than the currently active one. (Admittedly, this is a somewhat fringe problem)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-python/src/interpreter.rs</code>:296 on 2024-10-08 15:48</div>
            <div class="timeline-body"><p>Should we cache this? It's still faster than it needs to be, but it's still an io operation, so if we optimize this for speed, I'd cache this <code>read_dir</code> first.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-python/src/discovery.rs</code>:605 on 2024-10-08 15:50</div>
            <div class="timeline-body"><p>nit: <code>filter_ok</code> to remove the indirection with the <code>result_</code> methods</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-python/src/discovery.rs</code>:700 on 2024-10-08 15:53</div>
            <div class="timeline-body"><p>Docstring from different function.</p>
<p>Could you add another sentence as to why this function exists, i.e., which case it prevents?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2024-10-08 15:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-10-08 15:57</div>
            <div class="timeline-body"><blockquote>
<p>If i specifically pass --python-preference only-system i'd expect uv to invalidate the current venv and recreate,</p>
</blockquote>
<p>But.. <code>uv run</code> outside a project and <code>uv pip install</code> can't just invalidate and recreate an environment — should they fail?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-10-08 15:59</div>
            <div class="timeline-body"><p>I think so</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "v0.5.0" by @zanieb on 2024-11-25 20:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v0.6.0" by @zanieb on 2024-11-25 20:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "v0.6.0" by @zanieb on 2025-02-15 02:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v0.7.0" by @zanieb on 2025-02-15 02:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-04-30 17:37</div>
            <div class="timeline-body"><p>This just needs test coverage, which is in WIP locally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "v0.7.0" by @zanieb on 2025-04-30 17:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "v0.8.0" by @zanieb on 2025-04-30 17:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv-python/src/discovery.rs</code>:883 on 2025-07-16 18:42</div>
            <div class="timeline-body"><p>nit: This can be a method on <code>PythonSource</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/run.rs</code>:5529 on 2025-07-16 19:03</div>
            <div class="timeline-body"><p>How is <code>VIRTUAL_ENV</code> different here, doesn't that imply that I get different behavior depending on whether I activate the venv first and then <code>uv run</code> or whether I only use <code>uv run</code>, which is usually the same?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-07-16 19:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-16 19:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/it/run.rs</code>:5529 on 2025-07-16 19:09</div>
            <div class="timeline-body"><p><code>VIRTUAL_ENV</code> is set to the default virtual environment path (just by the test context)</p>
<p>This does imply you get different behavior based on whether the environment is active. I think that's correct though? With an active environment, it would be incorrect to ignore it (at most, we should warn), but when performing environment discovery, it makes sense to bypass environments that do not meet the preference.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-07-16 19:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/run.rs</code>:5529 on 2025-07-16 19:36</div>
            <div class="timeline-body"><p>If you have a project with <code>requires-python = &quot;&gt;=3.11&quot;</code> and try a too old venv with</p>
<pre><code>uv venv -p 3.9
uv run python --version
</code></pre>
<p>then uv will recreate the venv in a compatible version and you'll get e.g. <code>Python 3.13.5</code>. This is independent of whether the venv is activated or not. I'd be surprised if there was different behavior between the Python version and the Python source wrt to the when we invalidate.</p>
<p>More concretely, I'd expect both blocks to share the invalidation behavior:</p>
<pre><code>uv run --python-preference only-system -p 3.10 python --version
uv run --python-preference only-system -p 3.11 python --version
</code></pre>
<pre><code>uv run --python-preference only-system -p 3.10 python --version
uv run --python-preference managed -p 3.10 python --version
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2025-07-16 19:42</div>
            <div class="timeline-body"><p>This branch seems to have a bad interaction with the minor version links for Python upgrades (CC @jtfmumm). Rerunning the last command recreates the venv in a loop on my machine</p>
<pre><code>uv python uninstall --all --preview
uv init -p 3.10 foo
cd foo
uv run --preview --python-preference only-managed -p 3.10 python --version
</code></pre>
<p>Logs: https://gist.github.com/konstin/709fb6c4467fc607cfbea985f5ee8822</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-16 19:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/it/run.rs</code>:5529 on 2025-07-16 19:53</div>
            <div class="timeline-body"><p>Yeah this behavior differs outside of projects because:</p>
<ol>
<li>Outside of a project, we can't &quot;invalidate&quot; and recreate a virtual environment.</li>
<li>Projects don't consider <code>VIRTUAL_ENV</code> at all by default</li>
</ol>
<p>This is intended to avoid making the breaking change too disruptive. While I might agree with you that it's better to have a consistent behavior, I think it's too risky to change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-16 20:01</div>
            <div class="timeline-body"><p>That should be fixed by https://github.com/astral-sh/uv/pull/7934/commits/fbebb7ad603d743391c4fce3ee242bf9a49ef266</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-07-16 20:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/tests/it/run.rs</code>:5529 on 2025-07-16 20:03</div>
            <div class="timeline-body"><p>To be clear, you're commenting on a test that is covering the behavior of <code>uv run</code> outside of a project. For project environments, we have the behavior you're looking for.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2025-07-16 20:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/uv/tests/it/run.rs</code>:5529 on 2025-07-16 20:11</div>
            <div class="timeline-body"><p>Oh, I see!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2025-07-16 20:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2025-07-16 20:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-07-16 20:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-16 20:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 06:55:35 UTC
    </footer>
</body>
</html>
