<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add support for retrieving credentials from `keyring` - astral-sh/uv #2254</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add support for retrieving credentials from <code>keyring</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/2254">#2254</a>
        opened by <a href="https://github.com/BakerNet">@BakerNet</a>
        on 2024-03-06 23:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a></div>
            <div class="timeline-body">

Summary


<p>Adds basic keyring auth support for <code>uv</code> commands.  Adds clone of <code>pip</code>&#x27;s <code>--keyring-provider subprocess</code> argument (using CLI <code>keyring</code> tool).</p>
<p>See issue: <a href="https://github.com/astral-sh/uv/issues/1520">astral-sh/uv#1520</a></p>
Test Plan


<p>Hard to write full-suite unit tests due to reliance on <code>process::Command</code> for <code>keyring</code> cli</p>
<p>Manually tested end-to-end in a project with GCP artifact registry using keyring password:</p>
<pre><code>‚ûú  uv pip uninstall watchdog
Uninstalled 1 package in 46ms
 - watchdog==4.0.0

‚ûú  cargo run -- pip install --index-url https://&lt;redacted&gt;/python/simple/ --extra-index-url https://&lt;redacted&gt;/pypi-mirror/simple/ watchdog
    Finished dev [unoptimized + debuginfo] target(s) in 0.18s
     Running `target/debug/uv pip install --index-url &#x27;https://&lt;redacted&gt;/python/simple/&#x27; --extra-index-url &#x27;https://&lt;redacted&gt;/pypi-mirror/simple/&#x27; watchdog`
error: HTTP status client error (401 Unauthorized) for url (https://&lt;redacted&gt;/pypi-mirror/simple/watchdog/)

‚ûú  cargo run -- pip install --keyring-provider subprocess --index-url https://&lt;redacted&gt;/python/simple/ --extra-index-url https://&lt;redacted&gt;/pypi-mirror/simple/ watchdog
    Finished dev [unoptimized + debuginfo] target(s) in 0.17s
     Running `target/debug/uv pip install --keyring-provider subprocess --index-url &#x27;https://&lt;redacted&gt;/python/simple/&#x27; --extra-index-url &#x27;https://&lt;redacted&gt;/pypi-mirror/simple/&#x27; watchdog`
Resolved 1 package in 2.34s
Installed 1 package in 27ms
 + watchdog==4.0.0
</code></pre>
<p><code>requirements.txt</code></p>
<pre><code>#
# This file is autogenerated by pip-compile with Python 3.10
# by the following command:
#
#    .bin/generate-requirements
#
--index-url https://&lt;redacted&gt;/python/simple/
--extra-index-url https://&lt;redacted&gt;/pypi-mirror/simple/

...
</code></pre>
<pre><code>‚ûú  cargo run -- pip install --keyring-provider subprocess -r requirements.txt
    Finished dev [unoptimized + debuginfo] target(s) in 0.19s
     Running `target/debug/uv pip install --keyring-provider subprocess -r requirements.txt`
Resolved 205 packages in 23.52s
   Built &lt;redacted&gt;
   ...
Downloaded 47 packages in 19.32s
Installed 195 packages in 276ms
 + &lt;redacted&gt;
  ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/BakerNet">@BakerNet</a> on 2024-03-06 23:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-06 23:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BakerNet">@BakerNet</a> on 2024-03-06 23:58</div>
            <div class="timeline-body"><p>~~Note:  Refactoring to use Middleware instead~~
Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BakerNet">@BakerNet</a> on 2024-03-07 04:56</div>
            <div class="timeline-body"><p>~~Not in working state~~
Fixed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/BakerNet">@BakerNet</a> on 2024-03-07 05:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/main.rs</code>:351 on 2024-03-07 23:45</div>
            <div class="timeline-body"><p>Will the keyring be used for <code>--find-links</code> URLs? I believe those work fine with <code>--no-index</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-keyring/src/lib.rs</code>:11 on 2024-03-07 23:46</div>
            <div class="timeline-body"><p>My plan was to have an <code>AuthenticationStore</code> type over in <code>uv-auth</code> that contained all of this.</p>
<p>I&#x27;m not sure if that&#x27;s worth doing in this pull request or if I should explore it afterwards.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-keyring/src/lib.rs</code>:11 on 2024-03-07 23:47</div>
            <div class="timeline-body"><p>At the very least, it seems safe to move <code>uv-keyring/lib.rs</code> to <code>uv-auth/keyring.rs</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/middleware.rs</code>:52 on 2024-03-07 23:50</div>
            <div class="timeline-body"><p>I think we should probably just have a single <code>AuthMiddleware</code> type that uses <code>uv_auth.AuthenticationStore</code>. I think we&#x27;d probably want to re-implement the netrc middleware in <code>uv-auth</code> so we have full control over it. Then we can document a clear priority of authentication methods.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-keyring/src/lib.rs</code>:23 on 2024-03-07 23:52</div>
            <div class="timeline-body"><p>I think we&#x27;re preferring <code>thiserror</code> for application-internal error handling.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-keyring/src/lib.rs</code>:35 on 2024-03-07 23:55</div>
            <div class="timeline-body"><p>We generally try to write expressions to avoid calling <code>unwrap()</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-keyring/src/lib.rs</code>:48 on 2024-03-07 23:57</div>
            <div class="timeline-body"><p>Here you give keyring the full URL but above we&#x27;re only using the host to cache passwords. We&#x27;ll want to be more robust about the caching as described in</p>
<p>https://github.com/astral-sh/uv/blob/8d721830db8ad75b8b7ef38edc0e346696c52e3d/crates/uv-auth/src/lib.rs#L39-L44</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-keyring/src/lib.rs</code>:53 on 2024-03-07 23:58</div>
            <div class="timeline-body"><p>We&#x27;ll want to use an error case for this to avoid panicking if someone has a bad keyring executable</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/main.rs</code>:349 on 2024-03-07 23:59</div>
            <div class="timeline-body"><p>Why not match <code>pip</code>&#x27;s interface exactly here? This interface seems more limited.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> had review dismissed on 2024-03-08 00:02</div>
            <div class="timeline-body"><p>Hi! Thank you so much for contributing and welcome to the project :)</p>
<p>This change overlaps with some work I&#x27;ve been considering, so I&#x27;ve left some notes about future plans ‚Äî let me know how interested you are in pursuing some of the broader strokes I&#x27;ve outlined.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-08 01:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv/src/main.rs</code>:349 on 2024-03-08 01:07</div>
            <div class="timeline-body"><p>I implemented it more limited on purpose - because we only have access to the CLI version of keyring, the other option (python import) isn&#x27;t available.<br>
Also, I can&#x27;t say I&#x27;m a fan of pip default (&quot;auto&quot;).  The way &quot;auto&quot; works in <code>pip</code>:
Try endpoint. If <code>401</code> on first request, try python import <code>keyring.get_credential</code> method.  If python import method fails, try CLI.</p>
<p>You could implement the keyring retry on <code>401</code> via middleware as default I guess, but... do you want to?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-08 01:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-client/src/middleware.rs</code>:52 on 2024-03-08 01:31</div>
            <div class="timeline-body"><p>Makes sense, and I&#x27;d be happy to re-implement/combine the netrc middleware for this - but do you have an idea on what the interface with <code>uv_auth.AuthenticationStore</code> will look like?</p>
<p>One thing to be aware of here is that we do not have access to <code>&amp;mut self</code> in the <code>RequestInitialiser</code> trait so can&#x27;t call mutable methods on a struct field.  I originally planned to have store in the <code>KeyringMiddleware</code> but ran into this issue which is why it&#x27;s a static ref in <code>get_keyring_auth</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-03-08 02:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/main.rs</code>:349 on 2024-03-08 02:56</div>
            <div class="timeline-body"><p>Oh I see they support <code>--keyring-provider subprocess</code> or <code>--keyring-provider auto</code> ‚Äî I read this as <code>--keyring-provider &lt;name&gt;</code> where you could specify what command to spawn for keyring information. I&#x27;m more okay with this then.</p>
<p>Does <code>pip</code> use the <code>--keyring-provider auto</code> by default? i.e. does it always do keyring lookups?</p>
<p>Do you have more context on how the <code>keyring</code> Python library differs from the <code>keyring</code> command line tool? Happy to look into this myself some too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-03-08 03:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-client/src/middleware.rs</code>:52 on 2024-03-08 03:01</div>
            <div class="timeline-body"><p>I hadn&#x27;t figured that out yet :)</p>
<p>I was going to study <a href="https://github.com/pypa/pip/blob/9824a426d466680d132aa027add88ec0dda9116f/src/pip/_internal/network/auth.py">pip&#x27;s implementation</a>. I imagine the authentication store would just need something like <code>get(url: Url) -&gt; Option&lt;Credentials&gt;</code>, <code>set(url: Url, credentials: Credentials)</code>, <code>with_auth(url: Url) -&gt; Url</code>, <code>save_from_url(url: Url)</code>?</p>
<p>Definitely felt like a bigger design that would need some consideration. It&#x27;d be good to include our current authentication transfer from response -&gt; request URLs in its API somehow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-08 04:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv/src/main.rs</code>:349 on 2024-03-08 04:07</div>
            <div class="timeline-body"><blockquote>
<p>Does¬†pip¬†use the¬†--keyring-provider auto¬†by default? i.e. does it always do keyring lookups?</p>
</blockquote>
<p>It does use <code>auto</code> by default - but it will only do keyring lookups if the first request fails with a <code>401</code> status code when in <code>auto</code> mode.</p>
<p>As for how CLI vs package differ:
The CLI tool uses the keyring python package under the hood.  The only difference is that the python package doesn&#x27;t require you to supply a username to <code>keyring.get_credentials</code>,  but the CLI tool does for <code>keyring get</code>.  The username passed to the CLI tool can be anything for the GCP plugin (because it&#x27;s not actually checked).  I don&#x27;t know for sure about other cloud providers&#x27; plugins because I have not used them, but I would guess it&#x27;s the same.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-08 06:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv/src/main.rs</code>:351 on 2024-03-08 06:25</div>
            <div class="timeline-body"><p>I think you&#x27;re right - I don&#x27;t know why it wouldn&#x27;t be used for <code>--find-links</code> urls.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-08 06:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-keyring/src/lib.rs</code>:23 on 2024-03-08 06:25</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-08 06:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-keyring/src/lib.rs</code>:35 on 2024-03-08 06:25</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-08 06:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv/src/main.rs</code>:351 on 2024-03-08 06:26</div>
            <div class="timeline-body"><p>Removed <code>conflicts_with</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-08 06:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-keyring/src/lib.rs</code>:11 on 2024-03-08 06:27</div>
            <div class="timeline-body"><p>Basic move done - haven&#x27;t started to tackle AuthenticationStore yet</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-08 06:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-keyring/src/lib.rs</code>:53 on 2024-03-08 06:28</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BakerNet">@BakerNet</a> on 2024-03-08 06:29</div>
            <div class="timeline-body"><p>While changes are WIP, do you guys like the PR converted to Draft, or kept Open?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-08 15:10</div>
            <div class="timeline-body"><p>@BakerNet if you don&#x27;t want my feedback for a period of time you could mark it as a draft, otherwise I&#x27;ll read through it periodically.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-03-09 01:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/main.rs</code>:349 on 2024-03-09 01:27</div>
            <div class="timeline-body"><p>Just wondering, why don&#x27;t you like the <code>auto</code> behavior? It seems like it <em>could</em> be sensible to avoid sending credentials to URLs that do not require it. I don&#x27;t have a preference at this point but every difference from <code>pip</code> can cause confusion so I want to make an informed decision.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-09 01:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-client/src/middleware.rs</code>:52 on 2024-03-09 01:34</div>
            <div class="timeline-body"><p>Done - implemented pretty much as you laid out, but used a slightly more verbose method name <code>with_url_encoded_auth</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-09 01:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-keyring/src/lib.rs</code>:48 on 2024-03-09 01:35</div>
            <div class="timeline-body"><p>Moved specification into type <code>NetLoc</code> with equality checking which also matches <code>pip</code>&#x27;s naming (<code>netloc</code>) for their password memo dict</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-09 01:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv/src/main.rs</code>:349 on 2024-03-09 01:54</div>
            <div class="timeline-body"><p>I guess it&#x27;s just a personal distaste - but totally understand that differences from <code>pip</code> are problematic and can understand the point about sending credentials unnecessarily.</p>
<p>Implementing the retry on <code>401</code> seems non-trivial, but I&#x27;m sure it&#x27;s doable.</p>
<p>Steps:
Create policy to retry on first <code>401</code> status (using <code>reqwest-retry</code> probably)
Before retry, delete stored auth state for URL so it will not short-circuit auth middleware
Somehow inform auth middleware to use keyring for future requests to this URL</p>
<p>To test:
Make sure auth middleware still runs on retry (I haven&#x27;t tested this with <code>reqwest-retry</code> so don&#x27;t know)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-03-09 03:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/main.rs</code>:349 on 2024-03-09 03:24</div>
            <div class="timeline-body"><p>I agree that feels convoluted. I&#x27;ll see if there are other opinions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-10 15:10</div>
            <div class="timeline-body"><p>Heads up that we had to change the netrc implementation to use middleware in #2325 because it caused a regression.</p>
<p>Let me know if you have any problems resolving the conflicts.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vlad-ivanov-name">@vlad-ivanov-name</a> on 2024-03-10 15:44</div>
            <div class="timeline-body"><p>hey folks, happy to see this being implemented -- I&#x27;m using uv with artifact registry. Couple of questions:</p>
<ol>
<li><p>Do you think in future there could be an option to use a built-in credential access routine for specific hosts instead of calling a subprocess? I would really like to avoid python being involved in the process for reliability and convenience reasons. Having <code>keyring</code> tool available means there&#x27;s already a python environment where it&#x27;s available, meaning we would need to pin requirements for that environment because it&#x27;s not just a single package but rather keyring + backends, and this creates sort of a chicken-egg problem. On top of that it&#x27;s a bit of a deviation from the tool written in rust into the shaky untyped python ecosystem -- things just break randomly way more often there. Having this in uv would therefore avoid <em>a lot</em> of dependencies and variability.</p>
<p>For example deriving a token from environment for GCP is relatively easily and such native credential helper could be much more robust, and avoid the chicken-egg thing. The only thing I&#x27;m not sure is the UX -- but I would be happy with just an arg like <code>--auth-helper=us-west1-python.pkg.dev=gcloud</code> or something like that</p>
</li>
<li><p>I haven&#x27;t tried to integrate this anywhere yet but I hope the interface is flexible enough so that code that consumes uv as a dependency can plug its own auth helpers or easily reuse internal ones</p>
</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-10 21:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv/src/main.rs</code>:349 on 2024-03-10 21:24</div>
            <div class="timeline-body"><p>Changed to use same interface as <code>pip</code> - and I have a good idea of how to implement the retry, but think it would be better to do in a follow-up PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BakerNet">@BakerNet</a> on 2024-03-11 16:56</div>
            <div class="timeline-body"><blockquote>
<p>hey folks, happy to see this being implemented -- I&#x27;m using uv with artifact registry. Couple of questions:</p>
<ol>
<li>Do you think in future there could be an option to use a built-in credential access routine for specific hosts instead of calling a subprocess? I would really like to avoid python being involved in the process for reliability and convenience reasons. Having <code>keyring</code> tool available means there&#x27;s already a python environment where it&#x27;s available, meaning we would need to pin requirements for that environment because it&#x27;s not just a single package but rather keyring + backends, and this creates sort of a chicken-egg problem. On top of that it&#x27;s a bit of a deviation from the tool written in rust into the shaky untyped python ecosystem -- things just break randomly way more often there. Having this in uv would therefore avoid <em>a lot</em> of dependencies and variability.
For example deriving a token from environment for GCP is relatively easily and such native credential helper could be much more robust, and avoid the chicken-egg thing. The only thing I&#x27;m not sure is the UX -- but I would be happy with just an arg like <code>--auth-helper=us-west1-python.pkg.dev=gcloud</code> or something like that</li>
<li>I haven&#x27;t tried to integrate this anywhere yet but I hope the interface is flexible enough so that code that consumes uv as a dependency can plug its own auth helpers or easily reuse internal ones</li>
</ol>
</blockquote>
<p>Not really my place to answer, as I&#x27;m not a part of the astral team (I&#x27;m a first time contributor), but my two cents:</p>
<p>It seems like having to support different cloud platforms directly would be a lot of overhead to support.  I think it would make more sense to just have users figure out a way to supply their own credentials for the platform they use rather than build in GCP &amp; Azure &amp; AWS etc. support into <code>uv</code> itself.
I totally understand the disliking of using a python dependency to your project that needs to exist before using <code>uv pip install</code> - but adding this support helps projects migrate to <code>uv</code> more easily.  I work on a project where we are currently relying on GCP&#x27;s keyring backend, and I wanted to make it easy for other people on my team to use <code>uv</code> without changing much in the rest of our environment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/zanieb">@zanieb</a> by <a href="https://github.com/BakerNet">@BakerNet</a> on 2024-03-11 16:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vlad-ivanov-name">@vlad-ivanov-name</a> on 2024-03-11 17:08</div>
            <div class="timeline-body"><p>While I disagree with regards to the amount of effort needed to support GCP auth in uv itself -- it would be quite simple -- I think your point still stands in general as other platforms might have much more complex auth routines.</p>
<p>What about making the interface for auth helpers open for users to plug into? Let&#x27;s say now I wanted to not use python keyring but instead replace with a tool in rust that supports a few specific auth flows. I could of course try to override <code>keyring</code> executable on PATH but it&#x27;s a bit hacky -- perhaps there can be a way to override the name of the binary that UV uses for keyring access? That would allow users to write their own auth helpers and maybe there would be a collection of them somewhere as independent projects.</p>
<p>Optionally there could even be a JSON interface: auth helper outputs something like <code>{ &quot;auth_type&quot;: &quot;basic&quot;, &quot;username&quot;: &quot;oauth2accesstoken&quot;, &quot;password&quot;: &quot;...&quot;, &quot;expires_in&quot;: 12345 }</code>. But even just a simple string would do -- all that&#x27;s missing now is being able to override keyring binary name with an environment variable or a command line arg.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BakerNet">@BakerNet</a> on 2024-03-11 17:55</div>
            <div class="timeline-body"><blockquote>
<p>While I disagree with regards to the amount of effort needed to support GCP auth in uv itself -- it would be quite simple -- I think your point still stands in general as other platforms might have much more complex auth routines.</p>
<p>What about making the interface for auth helpers open for users to plug into? Let&#x27;s say now I wanted to not use python keyring but instead replace with a tool in rust that supports a few specific auth flows. I could of course try to override <code>keyring</code> executable on PATH but it&#x27;s a bit hacky -- perhaps there can be a way to override the name of the binary that UV uses for keyring access? That would allow users to write their own auth helpers and maybe there would be a collection of them somewhere as independent projects.</p>
<p>Optionally there could even be a JSON interface: auth helper outputs something like <code>{ &quot;auth_type&quot;: &quot;basic&quot;, &quot;username&quot;: &quot;oauth2accesstoken&quot;, &quot;password&quot;: &quot;...&quot;, &quot;expires_in&quot;: 12345 }</code>. But even just a simple string would do -- all that&#x27;s missing now is being able to override keyring binary name with an environment variable or a command line arg.</p>
</blockquote>
<p>I could probably easily add something like <code>--keyring-provider custom=&lt;your-script-name&gt;</code> - assuming it takes the same arguments (url &amp; username) and returns a string password on success</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vlad-ivanov-name">@vlad-ivanov-name</a> on 2024-03-11 20:48</div>
            <div class="timeline-body"><p>That would be really good! I&#x27;m even less involved than you -- just a user -- so let&#x27;s hear from astral team perhaps -- @zanieb what do you think?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-12 19:30</div>
            <div class="timeline-body"><p>@vlad-ivanov-name it sounds nice to bypass <code>keyring</code> but I think we should discuss it in a new issue as long as this interface does not preclude us from doing it in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thomasgilgenast">@thomasgilgenast</a> on 2024-03-12 19:30</div>
            <div class="timeline-body"><p>Just wanted to say (as only a user) thank you for the contribution and to mention that I have test-driven 177bdee and</p>
<pre><code>UV_EXTRA_INDEX_URL=https://&lt;location&gt;-python.pkg.dev/&lt;project&gt;/&lt;gar_name&gt;/simple uv pip install --keyring-provider subprocess &lt;package&gt;
</code></pre>
<p>works perfectly with <code>keyrings.google_artifactregistry_auth</code>. I recognize that there are a lot of possible solutions to #1520 , but this one solves my use case perfectly.</p>
<p>The only (extremely minor) quirk I encountered is that if I include the username in the index URL</p>
<pre><code>UV_EXTRA_INDEX_URL=https://oauth2accesstoken@&lt;location&gt;-python.pkg.dev/&lt;project&gt;/&lt;gar_name&gt;/simple 
</code></pre>
<p>then the command above errors with</p>
<pre><code>error: HTTP status client error (401 Unauthorized) for url (https://&lt;location&gt;-python.pkg.dev/&lt;project&gt;/&lt;gar_name&gt;/simple/&lt;package&gt;/)
</code></pre>
<p>But when using non-uv <code>pip</code>, I do need to provide the username in <code>PIP_EXTRA_INDEX_URL</code> or else I get prompted for a username and password</p>
<pre><code>User for &lt;location&gt;-python.pkg.dev: 
</code></pre>
<p>But to be clear this is not a problem for me at all, just something that could be a useful piece of info for users trying to convert from pip to uv who stumble upon this PR. (If anything it was inconvenient to me that pip required the username - maybe it is actually a bug specific to <code>keyrings.google_artifactregistry_auth</code> when combined with <code>--keyring-provider subprocess</code>?)</p>
<p>And possibly totally unrelated to this PR, if there might be a <code>UV_KEYRING_PROVIDER</code> env var parallel to <code>PIP_KEYRING_PROVIDER</code>, in analogy to <code>UV_EXTRA_INDEX_URL</code>::<code>PIP_EXTRA_INDEX_URL</code> that would be very convenient for me. But it may be something for a separate PR or to discuss before implementing (cost of additional env vars versus ability to consistently control <code>uv</code> behavior with env vars). I have opened a minimal PR <a href="https://github.com/BakerNet/uv/pull/1">BakerNet/uv#1</a> against your branch @BakerNet just for my own experimentation. Please feel free to close if you feel that I&#x27;m sneaking something in there that doesn&#x27;t belong with this PR or deserves a separate discussion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/keyring.rs</code>:70 on 2024-03-12 19:34</div>
            <div class="timeline-body"><p>It looks like instead of returning <code>Result&lt;Credential, Error&gt;</code> this should return <code>Result&lt;Option&lt;Credential&gt;, Error&gt;</code> so we can return <code>None</code> in this case to distinguish from cases where something actually went wrong.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/lib.rs</code>:163 on 2024-03-12 19:36</div>
            <div class="timeline-body"><p>Did you drop this inverse case on purpose?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/lib.rs</code>:163 on 2024-03-12 19:36</div>
            <div class="timeline-body"><p>I guess they make less sense with the <code>NetLoc</code> implementation?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BakerNet">@BakerNet</a> on 2024-03-12 19:37</div>
            <div class="timeline-body"><blockquote>
<p>I have opened a minimal PR <a href="https://github.com/BakerNet/uv/pull/1">BakerNet#1</a> against your branch @BakerNet just for my own experimentation. Please feel free to close if you feel that I&#x27;m sneaking something in there that doesn&#x27;t belong with this PR or deserves a separate discussion.</p>
</blockquote>
<p>Seems like a totally uncontroversial QoL improvement to me, so I merged it in.  Thanks for testing this out, @thomasgilgenast  btw!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/store.rs</code>:13 on 2024-03-12 19:38</div>
            <div class="timeline-body"><p>I&#x27;d like @charliermarsh or @BurntSushi to review this part</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/store.rs</code>:13 on 2024-03-12 19:40</div>
            <div class="timeline-body"><p>Why do we store <code>None</code> credentials in here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/store.rs</code>:101 on 2024-03-12 19:40</div>
            <div class="timeline-body"><pre><code>            // No credentials to save
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/keyring.rs</code>:22 on 2024-03-12 19:43</div>
            <div class="timeline-body"><p>Do you think that it&#x27;s worth using something like https://docs.rs/keyring/latest/keyring/ instead of a subprocess? It looks like it overlaps a bit with the abstractions you introduce and it might make more sense if it can provide the same functionality.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/main.rs</code>:367 on 2024-03-12 19:47</div>
            <div class="timeline-body"><p>I&#x27;m a little hesitant on this interface. We might want to consider what our ideal interface for this then just include a dedicated interoperability flag for pip&#x27;s interface.</p>
<p>I think in part this depends on our future plans around keyring support (which I know there was some discussion about already). In particular, if we use something like the Rust <code>keyring</code> crate do we need to provide any options other than a boolean toggle? Perhaps we do still want to allow the user to select a specific provider?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/main.rs</code>:349 on 2024-03-12 19:50</div>
            <div class="timeline-body"><p>I&#x27;d be curious to hear @charliermarsh&#x27;s opinion regarding only searching for authentication on 401s.</p>
<p>It does seem brittle to me, we&#x27;ve seen all sorts of quirky behavior from package indexes when unauthorized.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-03-12 19:51</div>
            <div class="timeline-body"><p>This looks great! Thanks you!</p>
<p>I have some specific questions as well as a more general one regarding keyring lookups in Rust.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-12 20:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-auth/src/lib.rs</code>:163 on 2024-03-12 20:32</div>
            <div class="timeline-body"><p>Yeah, because it&#x27;s now an equality comparison, order doesn&#x27;t matter.  One of the <code>NetLoc</code> is the trusted url, one is the new url, but which side of the equality operation it&#x27;s on is logically irrelevant.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-12 20:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-auth/src/store.rs</code>:13 on 2024-03-12 20:33</div>
            <div class="timeline-body"><blockquote>
<p>Why do we store <code>None</code> credentials in here?</p>
</blockquote>
<p>Just so we don&#x27;t re-check netrc or keyring when they already failed to find credentials for the url&#x27;s net location</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-03-12 20:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/lib.rs</code>:163 on 2024-03-12 20:35</div>
            <div class="timeline-body"><p>Great thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-03-12 20:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/store.rs</code>:13 on 2024-03-12 20:35</div>
            <div class="timeline-body"><p>That makes sense, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-12 20:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-auth/src/keyring.rs</code>:22 on 2024-03-12 20:48</div>
            <div class="timeline-body"><blockquote>
<p>Do you think that it&#x27;s worth using something like <a href="https://docs.rs/keyring/latest/keyring/">docs.rs/keyring/latest/keyring</a> instead of a subprocess?</p>
</blockquote>
<p>Instead?  No.  In addition?  Yes.</p>
<p>As mentioned in issue <a href="https://github.com/astral-sh/uv/issues/1520">astral-sh/uv#1520</a> - the cloud providers provide backend plugins for the python keyring tool.
Using something like https://docs.rs/keyring/latest/keyring/ would be fine for the <code>Import</code> case, but supporting a command-line <code>keyring</code> should still exist regardless (especially if you&#x27;re trying to keep parity with pip) and if someone makes a CLI keyring with cloud provider support based on <code>keyring-rs</code> in the future, cool.  If it has the same CLI interface, it should just work.  If it has a different name, add to the <code>KeyringProvider</code>s or implement the custom version like discussed with @vlad-ivanov-name above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv/src/main.rs</code>:367 on 2024-03-12 20:54</div>
            <div class="timeline-body"><p>I feel like a value enum is a pretty flexible interface - you can just add additional options to the enum and change logic based on the variant.  If there are additional items needed for an option, you can just add another argument that relies on a specific <code>KeyringProvider</code> value like <code>--keyring-provider custom --custom-keyring-command keyring-rs</code> as a possible example (I&#x27;m certain <code>clap</code> supports this)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-12 20:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-12 21:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-auth/src/keyring.rs</code>:70 on 2024-03-12 21:02</div>
            <div class="timeline-body"><p>Fair point - that would be more accurate</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-03-12 21:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/keyring.rs</code>:22 on 2024-03-12 21:13</div>
            <div class="timeline-body"><p>üëç makes sense</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-03-12 21:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/main.rs</code>:367 on 2024-03-12 21:13</div>
            <div class="timeline-body"><p>Okay, sold. Thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-12 21:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-auth/src/keyring.rs</code>:70 on 2024-03-12 21:15</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-03-12 21:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:89 on 2024-03-12 21:16</div>
            <div class="timeline-body"><p>If you do the refactor to separate <code>None</code> from the <code>Error</code> case we should be able to log failures here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-12 21:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-auth/src/middleware.rs</code>:89 on 2024-03-12 21:19</div>
            <div class="timeline-body"><p>What is the correct way to log errors in <code>uv</code> codebase, btw?  <code>warn!</code> or <code>warn_user!</code> maybe?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-03-12 21:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:89 on 2024-03-12 21:24</div>
            <div class="timeline-body"><p>Hm that&#x27;s tough.</p>
<p>Ideally we&#x27;d attach this as a hint to request failures so when we <em>error</em> we&#x27;d be able to suggest why. In the meantime, I think a tracing message is the way to go unless it&#x27;s very actionable for the user to fix the problem. I believe the difference is a tracing message will only show up with <code>-v</code> but <code>warn_user!</code> will always display.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-12 21:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-12 21:30</div>
            <div class="timeline-body"><p>Thanks for addressing all the feedback so promptly.</p>
<p>I&#x27;ve added @charliermarsh as a reviewer ‚Äî once he&#x27;s happy we&#x27;ll be good to go.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-12 21:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-auth/src/middleware.rs</code>:89 on 2024-03-12 21:37</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/thomasgilgenast">@thomasgilgenast</a> on <code>crates/uv-auth/src/keyring.rs</code>:22 on 2024-03-12 22:02</div>
            <div class="timeline-body"><p>~I am only commenting as an observer, but commenters on <a href="https://github.com/astral-sh/uv/issues/1520">astral-sh/uv#1520</a> appeared to be in favor of at least reproducing pip&#x27;s subprocess behavior first as the simplest way to automatically ensure compatibility with existing python-based keyring implementations for authenticating with python package indices (which may not have rust keyring counterparts at the current time).~</p>
<p>~But maybe I am misunderstanding how plugging in the rust keyring here would work, for example if uv would call out via a subprocess to python-based keyring implementations, then stash the result in rust keyring? Or if rust keyring has already implemented a standard way to call out to other keyrings via a subprocess and uv can somehow reuse that instead of re-implementing it? From a naive point of view, I don&#x27;t see a simple/obvious way to avoid a subprocess entirely.~</p>
<p>~All that being said, I think that users who don&#x27;t need any specific/&quot;customized&quot; keyring implementation and instead simply need a basic mechanism to store their password to avoid typing it out every time could be served with rust keyring (without a subprocess). But I think that the &quot;customized&quot; python keyring implementations like <code>keyrings.google_artifactregistry_auth</code> are &quot;common enough&quot; (subjective) that it could be worth considering how those could also be supported. (The subprocess-based path taken by the current state of this PR does support both &quot;simple&quot; and &quot;customized&quot; keyring use cases.)~</p>
<p>Edit: sorry, totally redundant with the discussion above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/thomasgilgenast">@thomasgilgenast</a> reviewed on 2024-03-12 22:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/main.rs</code>:1247 on 2024-03-13 03:34</div>
            <div class="timeline-body"><p>We should add this to the list of supported environment variables in the README.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/middleware.rs</code>:57 on 2024-03-13 03:41</div>
            <div class="timeline-body"><p>For my own clarification... this will propagate the credentials based purely on <code>host</code> etc., right? In other words, the URLs do not need to be identical, is that correct? Just the same &quot;realm&quot; and so on?</p>
<p>Is this generally a safe and accepted thing to do? (That is: propagate the credentials here.) It&#x27;s a little different than what we do on <code>main</code> which is more limited: when we make a request, we propagate credentials to the URLs that are found on the page returned by the request (like <code>with_url_encoded_auth</code>, I think).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/store.rs</code>:56 on 2024-03-13 03:43</div>
            <div class="timeline-body"><p>When can these fail? (These will be effectively silent for the user.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/middleware.rs</code>:67 on 2024-03-13 03:44</div>
            <div class="timeline-body"><p>Can you expand on the comment here? Should this be <code>unreachable!</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/middleware.rs</code>:162 on 2024-03-13 03:46</div>
            <div class="timeline-body"><p>Should these unwraps just be <code>?</code> given that we already return <code>Result</code> here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/store.rs</code>:32 on 2024-03-13 03:46</div>
            <div class="timeline-body"><p>I think it&#x27;s a bit inflexible for these to clone. Callers can always clone if they need owned data, but callers that <em>don&#x27;t</em> need owned data are now <em>forced</em> to clone. I think these should return references.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/store.rs</code>:43 on 2024-03-13 03:47</div>
            <div class="timeline-body"><p>This is kind of a hidden allocation, because we&#x27;re taking a reference and then cloning inside the <code>From</code>. I think it would be clearer as <code>From&lt;Authenticator&gt;</code>, personally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/store.rs</code>:71 on 2024-03-13 03:52</div>
            <div class="timeline-body"><p>I&#x27;m not a huge fan of the singleton struct here but I don&#x27;t need to block the PR on it. It&#x27;s just not something we&#x27;ve really done anywhere else that I can remember. Maybe @BurntSushi would have a better opinion on it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/middleware.rs</code>:92 on 2024-03-13 03:53</div>
            <div class="timeline-body"><p>Nit: can you inline these please? <code>debug!(&quot;No keyring credentials found for: {url}&quot;);</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/main.rs</code>:349 on 2024-03-13 03:55</div>
            <div class="timeline-body"><p>I haven&#x27;t thought about it deeply but I have a negative reaction to only sending credentials after seeing a 401.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/distribution-types/src/file.rs</code>:58 on 2024-03-13 03:57</div>
            <div class="timeline-body"><p>So the assumption here is that we&#x27;ve already hit the base URL on a previous invocation of the middleware, and so its credentials are already stored in the <code>AuthenticationStore</code>, and will be propagated here if needed?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-13 03:57</div>
            <div class="timeline-body"><p>Thanks for this! I think I need to better understand some of the credential flows before merging.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-03-13 04:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/middleware.rs</code>:57 on 2024-03-13 04:01</div>
            <div class="timeline-body"><p>Yeah we&#x27;re using the &quot;net loc&quot; which is the same &quot;realm&quot;. This is compliant with the relevant web standard RFC and AFAIK exactly what pip does. It seems totally fine to me but I appreciate the extra scrutiny.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-03-13 04:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/store.rs</code>:71 on 2024-03-13 04:02</div>
            <div class="timeline-body"><p>I imagined the passwords would live on it but I think that&#x27;s infeasible for some reason?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-13 04:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/middleware.rs</code>:57 on 2024-03-13 04:03</div>
            <div class="timeline-body"><p>Do you know why we <em>also</em> need to call <code>with_url_encoded_auth</code> before the middleware then?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-03-13 04:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv/src/main.rs</code>:1247 on 2024-03-13 04:06</div>
            <div class="timeline-body"><p>We&#x27;ll also want to document support and precedence in a registry authentication section following https://github.com/astral-sh/uv?tab=readme-ov-file#git-authentication but I can do that in a follow-up (just posting so I don&#x27;t forget).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-13 04:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-auth/src/middleware.rs</code>:57 on 2024-03-13 04:18</div>
            <div class="timeline-body"><p>I didn&#x27;t follow the full flow after the <code>url</code> is copied - I saw it was being used in <code>File</code> structs and didn&#x27;t want to potentially introduce regression by assuming theses <code>urls</code> having the auth copied to were going to be used in the same run of <code>uv</code></p>
<p>My other comment on the URLEncodedAuth being insecure, but relying on this copying from trusted urls instead was also a factor in my keeping the copy functionality.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-13 04:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-auth/src/middleware.rs</code>:67 on 2024-03-13 04:25</div>
            <div class="timeline-body"><p>The idea here is, if the url does not come to the middleware with URL-encoded auth, we shouldn&#x27;t introduce URL-encoded auth because it&#x27;s an inherently unsafe way to send auth data.  On main, there was already code copying the auth from trusted urls onto response/body urls so this line shouldn&#x27;t be hit under normal circumstances anyways.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-13 04:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-auth/src/store.rs</code>:56 on 2024-03-13 04:30</div>
            <div class="timeline-body"><p>I didn&#x27;t look into this - it&#x27;s just copied over from main (migrated from <code>lib.rs</code> function)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-13 04:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/store.rs</code>:56 on 2024-03-13 04:31</div>
            <div class="timeline-body"><p>Okay thanks, that&#x27;s a perfectly fine answer :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-13 04:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-auth/src/store.rs</code>:71 on 2024-03-13 04:42</div>
            <div class="timeline-body"><p>My initial plan was for a store instance to be a field of the <code>AuthMiddleware</code> struct and the store to hold an instance of the password table - but you do not have access to mutable self in the <code>Middleware</code> trait, so that was the limitation I ran into.  Combine that with keeping the copying from trusted URL that wouldn&#x27;t have access to the same instance - I went with this approach.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-13 04:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/distribution-types/src/file.rs</code>:58 on 2024-03-13 04:55</div>
            <div class="timeline-body"><p>Yes, that was my assumption.  That if <code>base</code> has auth, it received it from a copy from a previous request (in <code>FlatIndexClient.read_from_url</code> or <code>RegistryClient.simple_single_index</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-13 05:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-auth/src/middleware.rs</code>:92 on 2024-03-13 05:18</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-13 05:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-auth/src/store.rs</code>:43 on 2024-03-13 05:19</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-13 05:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-auth/src/store.rs</code>:32 on 2024-03-13 05:19</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BakerNet">@BakerNet</a> reviewed on 2024-03-13 05:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BakerNet">@BakerNet</a> on <code>crates/uv-auth/src/middleware.rs</code>:162 on 2024-03-13 05:20</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-03-13 17:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/uv-auth/src/store.rs</code>:71 on 2024-03-13 17:30</div>
            <div class="timeline-body"><p>Can you just use interior mutability to get around this? e.g. <code>RefCell&lt;T&gt;</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-03-13 17:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-auth/src/store.rs</code>:71 on 2024-03-13 17:43</div>
            <div class="timeline-body"><p>I believe you could just do it with the Mutex within the struct. But we can change this later if desired.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-03-13 17:45</div>
            <div class="timeline-body"><p>I&#x27;m cool with this, thanks for the nice PR! I defer to @zanieb to merge.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Basic implementation of Keyring auth support&quot; to &quot;Add support for retrieving credentials from `keyring`&quot; by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-13 17:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-13 20:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/zanieb">@zanieb</a> on 2024-03-13 20:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:44:09 UTC
    </footer>
</body>
</html>
