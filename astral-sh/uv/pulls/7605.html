<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add support for upgrading build env for tools - astral-sh/uv #7605</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add support for upgrading build env for tools</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/7605">#7605</a>
        opened by <a href="https://github.com/tfsingh">@tfsingh</a>
        on 2024-09-20 22:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tfsingh">@tfsingh</a></div>
            <div class="timeline-body"><p>This PR adds support for upgrading the build environment of tools with the addition of a <code>--python</code> argument to <code>uv upgrade</code>, as specified in #7471.</p>
<p>Some things to note:</p>
<ul>
<li>I added support for individual packages — I didn't think there was a good reason for <code>--python</code> to only apply to all packages</li>
<li>Upgrading with <code>--python</code> also upgrades the package itself — I think this is fair as if a user wants to <em>strictly</em> switch the version of Python being used to build a tool's environment they can use <code>uv install</code>.  This behavior can of course be modified if others don't agree!</li>
</ul>
<p>Closes https://github.com/astral-sh/uv/issues/6297.</p>
<p>Closes https://github.com/astral-sh/uv/issues/7471.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @tfsingh on 2024-09-20 23:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2024-09-23 23:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/tool/upgrade.rs</code>:214 on 2024-09-24 00:45</div>
            <div class="timeline-body"><p>We may want to do this in two steps. Check out <code>tool/install.rs</code>, where it says:</p>
<pre><code class="language-rust">// If we're creating a new environment, ensure that we can resolve the requirements prior
// to removing any existing tools.
</code></pre>
<p>We perform the resolution before removing and syncing the environment, to avoid removing an environment and then <em>failing</em> to update.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-09-24 00:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-09-24 00:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/tool/upgrade.rs</code>:211 on 2024-09-24 00:46</div>
            <div class="timeline-body"><p>Lets make this stricter. Check out the logic we added to <code>tool/install.rs</code> recently (grep for <code>let same_interpreter = if cfg!(windows) { ... }</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-09-24 00:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/tool/upgrade.rs</code>:158 on 2024-09-24 00:47</div>
            <div class="timeline-body"><p>In general, prefer <code>Option&lt;&amp;T&gt;</code> over <code>&amp;Option&lt;T&gt;</code>. The latter can always be converted to the former, but the opposite isn't true. I.e., if you have <code>&amp;Option&lt;PythonRequest&gt;</code>, you can cast to <code>Option&lt;&amp;PythonRequest&gt;</code> via <code>as_ref()</code>. But if you have <code>Option&lt;&amp;PythonRequest&gt;</code>, you can't get an <code>&amp;Option&lt;PythonRequest&gt;</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-09-24 00:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/tool/upgrade.rs</code>:143 on 2024-09-24 00:47</div>
            <div class="timeline-body"><p>I would use <code>if let [name] = names.as_slice()</code> here so that you can avoid the <code>unwrap</code> below.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-09-24 00:47</div>
            <div class="timeline-body"><p>Generally looks good! Nice job figuring this out. A few comments to address before merging.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @charliermarsh on 2024-09-24 00:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enhancement</span> added by @charliermarsh on 2024-09-24 00:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> added by @charliermarsh on 2024-09-24 00:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tfsingh">@tfsingh</a> reviewed on 2024-09-24 23:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/tfsingh">@tfsingh</a> on <code>crates/uv/src/commands/tool/upgrade.rs</code>:143 on 2024-09-24 23:09</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tfsingh">@tfsingh</a> reviewed on 2024-09-24 23:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/tfsingh">@tfsingh</a> on <code>crates/uv/src/commands/tool/upgrade.rs</code>:211 on 2024-09-24 23:12</div>
            <div class="timeline-body"><p>Awesome, done — I also factored this check into a method on <code>Interpreter</code> in line with one of Zanie's todos (went ahead and removed it, hope that's okay).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tfsingh">@tfsingh</a> reviewed on 2024-09-24 23:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/tfsingh">@tfsingh</a> on <code>crates/uv/src/commands/tool/upgrade.rs</code>:214 on 2024-09-24 23:26</div>
            <div class="timeline-body"><p>Okay, this makes sense — I made some updates, primarily dividing up the two flows (environment/tool) into separate codepaths (sans the entrypoint management, which applies to both).</p>
<p>It didn't make sense to me to rely on <code>update_environment</code> for the environment upgrade as I was doing before — we'd either be repeating work (as we also resolve the environment in <code>update_environment</code>) or adding extra parameters/functionality (which would make the API more confusing).</p>
<p>Let me know if anything seems off/obtuse and I'll fix it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tfsingh">@tfsingh</a> on 2024-09-24 23:26</div>
            <div class="timeline-body"><p>Thanks for the review! Should be ready for another pass</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-09-25 17:28</div>
            <div class="timeline-body"><p>Thanks, nice work! I made a few changes to the overall structure, but I'll leave a few comments to point them out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-09-25 17:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-python/src/environment.rs</code>:305 on 2024-09-25 17:31</div>
            <div class="timeline-body"><p>I think this makes more sense on <code>PythonEnvironment</code> since that already depends on <code>Interpreter</code> as a field, rather than the other way around.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-09-25 17:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/Cargo.toml</code>:75 on 2024-09-25 17:31</div>
            <div class="timeline-body"><p>This is genuinely unused in the crate now, so better to remove than ignore <code>cargo-shear</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-09-25 17:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv/src/commands/tool/upgrade.rs</code>:316 on 2024-09-25 17:32</div>
            <div class="timeline-body"><p>I generally tried to structure this such that we avoid all <code>mut</code>, and have two branches that return the values we care about.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/tfsingh">@tfsingh</a> reviewed on 2024-09-25 17:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/tfsingh">@tfsingh</a> on <code>crates/uv/Cargo.toml</code>:75 on 2024-09-25 17:36</div>
            <div class="timeline-body"><p>Completely missed that this was factored into a separate crate, thanks for catching!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-09-25 17:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-09-25 17:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-09-26 02:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch restored on 2024-09-26 02:33</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:39:43 UTC
    </footer>
</body>
</html>
