<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avoid narrowing `requires-python` marker with disjunctions - astral-sh/uv #10704</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Avoid narrowing <code>requires-python</code> marker with disjunctions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/10704">#10704</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2025-01-17 04:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>A bug in <code>requires_python</code> (which infers the Python requirement from a marker) was leading us to break an invariant around the relationship between the marker environment and the Python requirement. This, in turn, was leading us to drop parts of the environment space when solving.</p>
<p>Specifically, in the linked example, we generated a fork for <code>python_full_version &lt; '3.10' or platform_python_implementation != 'CPython'</code>, which was later split into <code>python_full_version == '3.8.*'</code> and <code>python_full_version == '3.9.*'</code>, losing the <code>platform_python_implementation != 'CPython'</code> portion.</p>
<p>Closes https://github.com/astral-sh/uv/issues/10669.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2025-01-17 04:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @charliermarsh on 2025-01-17 04:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @charliermarsh on 2025-01-17 04:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @ibraheemdev by @charliermarsh on 2025-01-17 04:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @charliermarsh on 2025-01-17 04:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/uv-resolver/src/marker.rs</code>:16 on 2025-01-17 05:17</div>
            <div class="timeline-body"><p>The search here only cares about a single type of node (<code>CanonicalMarkerValueVersion::PythonFullVersion</code>), and importantly that node can only show up once on a given solution path in the decision diagram. I believe this means that you shouldn't need an inner <code>Vec</code> here, and you can default to <code>Ranges::full()</code> for a solution that does not have an explicit python version requirement. That should simplify this a little bit â€” there is no list of versions to take the intersection of for a given solution.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> approved on 2025-01-17 05:17</div>
            <div class="timeline-body"><p>Other than the potential simplification I pointed out this looks good to me! A little surprised that we didn't notice this bug sooner.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2025-01-17 09:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2025-01-17 12:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2025-01-17 16:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2025-01-17 16:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-17 16:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:41:32 UTC
    </footer>
</body>
</html>
