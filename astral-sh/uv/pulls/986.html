<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use current and requested Python versions in `requires-python` incompatibility errors - astral-sh/uv #986</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use current and requested Python versions in <code>requires-python</code> incompatibility errors</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/986">#986</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2024-01-19 00:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/zanieb">@zanieb</a> on 2024-01-19 00:33</div>
            <div class="timeline-body"><p>Closes https://github.com/astral-sh/puffin/issues/806</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">error messages</span> added by @zanieb on 2024-01-19 00:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-01-19 00:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/puffin/tests/pip_install_scenarios.rs</code>:2890 on 2024-01-19 00:35</div>
            <div class="timeline-body"><p>Well this message didn't get worse but what the heck is it saying? TODO create an issue tracking this bug</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-01-19 00:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/puffin-resolver/src/pubgrub/report.rs</code>:42 on 2024-01-19 00:40</div>
            <div class="timeline-body"><p>Open to suggestions here, I tried quite a few things e.g.</p>
<p>&quot;the current Python version (3.9) does not satisfy&quot;
&quot;the current Python==3.9 does not satisfy&quot;
&quot;the resolution uses Python 3.9 which does not satisfy&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-19 03:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-resolver/src/pubgrub/report.rs</code>:38 on 2024-01-19 03:49</div>
            <div class="timeline-body"><p>I think this actually <em>isn't</em> true because if you use <code>--python-version</code>, we'll have both the installed and the target version in the tree, and either one could be incompatible (or both). So we might want to make it explicit that this only works if <code>--python-version</code> isn't provided (and remove the debug assert), or find a way to accommodate that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-01-19 04:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/puffin-resolver/src/pubgrub/report.rs</code>:38 on 2024-01-19 04:52</div>
            <div class="timeline-body"><p>Ah gee... we should accommodate that somehow thanks for catching it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-01-19 20:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/puffin-resolver/src/pubgrub/report.rs</code>:38 on 2024-01-19 20:26</div>
            <div class="timeline-body"><p>Addressed by https://github.com/astral-sh/puffin/pull/986/commits/eeadecdedef42e899ccfd41bbe79c829456727e8</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Use current Python version in `requires-python` incompatibility errors" to "Use current and requested Python versions in `requires-python` incompatibility errors" by @zanieb on 2024-01-19 21:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @zanieb on 2024-01-19 22:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-resolver/src/error.rs</code>:136 on 2024-01-20 12:31</div>
            <div class="timeline-body"><p>Oh yeah, that's tedious (that <code>PythonRequirement</code> uses unowned data). Perhaps we should just change it to use owned data, it's just two versions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-20 12:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-20 12:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-resolver/src/pubgrub/report.rs</code>:48 on 2024-01-20 12:36</div>
            <div class="timeline-body"><p>Are they not <em>exactly</em> the same when not provided? I think I would've expected <code>--python-version 3.10</code> to be treated as <code>--python-version 3.10.0</code>. I'm just wondering if this will be correct if the user uses a different patch version in the resolution.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-20 12:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-resolver/src/error.rs</code>:136 on 2024-01-20 12:36</div>
            <div class="timeline-body"><p>I would be fine making it owned.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-01-20 12:37</div>
            <div class="timeline-body"><p>Looks good to me though one question about the <code>.take(2)</code> that I'd like to understand better before merging.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-01-21 17:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/puffin-resolver/src/pubgrub/report.rs</code>:48 on 2024-01-21 17:19</div>
            <div class="timeline-body"><p>If  a target Python version is provided e.g. <code>--python-version 3.11</code></p>
<blockquote>
<p>DEBUG puffin_resolver::resolver Solving with target Python 3.11.6 and installed Python 3.12.0</p>
</blockquote>
<p>If the target Python version is inferred from the current version</p>
<blockquote>
<p>DEBUG puffin_resolver::resolver Solving with target Python 3.12 and installed Python 3.12.0</p>
</blockquote>
<p>If a target Python version is provided with patch version e.g. <code>--python-version 3.11.3</code></p>
<blockquote>
<p>DEBUG puffin_resolver::resolver Solving with target Python 3.11.3 and installed Python 3.12.0</p>
</blockquote>
<p>If a target Python version is provided but not installed e.g. <code>--python-version 3.13</code></p>
<blockquote>
<p>DEBUG puffin_resolver::resolver Solving with target Python 3.13 and installed Python 3.12.0</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-01-21 17:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/puffin-resolver/src/pubgrub/report.rs</code>:48 on 2024-01-21 17:22</div>
            <div class="timeline-body"><p>We compare the <em>full</em> target to the first two numbers of the <em>installed</em> so we should only have equality here when <code>--python-version</code> is not provided.</p>
<p>Let me know if I can make the this clearer in my comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-resolver/src/pubgrub/report.rs</code>:48 on 2024-01-21 18:01</div>
            <div class="timeline-body"><p>These are helpful...</p>
<p>(So first, I am assuming that <code>3.12</code> and <code>3.12.0</code> are considered equal when you use <code>==</code> with <code>Version</code>. I'm pretty sure this is true and per spec. In that case, we shouldn't need to do the <code>.take(2)</code> thing.)</p>
<blockquote>
<p>If a target Python version is provided e.g. <code>--python-version 3.11</code></p>
</blockquote>
<p>I initially thought this one was a bug, because 3.11 should've resolved to 3.11.0. But then I realized we do a thing whereby we assume the <em>highest</em> known minor. That behavior kind of feels wrong in hindsight... I think it exists because <code>--python-version 3.7</code> would otherwise use <code>3.7.0</code>, and a lot of things aren't compatible with the first few patch releases in <code>3.7</code>, and that was a confusing user experience in my testing. But it might be wrong...</p>
<blockquote>
<p>If the target Python version is inferred from the current version</p>
</blockquote>
<p>So these should match based on <code>Version</code> equality, I think.</p>
<blockquote>
<p>If a target Python version is provided with patch version e.g. <code>--python-version 3.11.3</code></p>
</blockquote>
<p>These should be considered unequal based on <code>Version</code> equality.</p>
<blockquote>
<p>If a target Python version is provided but not installed e.g. <code>--python-version 3.13</code></p>
</blockquote>
<p>This seems right to me, they'd be considered unequal based on version equality. But it shouldn't have to do with whether the target is installed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-21 18:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-21 18:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-resolver/src/pubgrub/report.rs</code>:48 on 2024-01-21 18:06</div>
            <div class="timeline-body"><p>Which case specifically would be wrong if we used <code>==</code> instead of <code>take(2)</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-01-21 23:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/puffin-resolver/src/pubgrub/report.rs</code>:48 on 2024-01-21 23:27</div>
            <div class="timeline-body"><p>Uhh so there's a lot here but... it's only 3.12.0 in those examples because that happens to be the patch version of Python 3.12 I have installed. So... if I had 3.12.1 installed and did <em>not</em> specify a <code>--python-version</code> for resolution we'd see <code>3.12.1 != 3.12</code> and would incorrectly assume the user had specified a different version and display the wrong message. For example, take a look at this commit that uses the equality comparison you are suggesting: https://github.com/astral-sh/puffin/commit/044c354647607d8dbb379b8be27f546afc664a9a</p>
<blockquote>
<p>If a target Python version is provided with patch version e.g. --python-version 3.11.3</p>
</blockquote>
<p>This <em>is</em> being handled correctly even with <code>take(2)</code> because we <em>only</em> trim the <em>installed</em> Python version so if the user has provided a resolution version with a patch version they will be considered inequal.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-resolver/src/pubgrub/report.rs</code>:48 on 2024-01-22 00:14</div>
            <div class="timeline-body"><p>Why would we see <code>3.12.1 != 3.12</code> though? Why is one of the versions not inclusive of the patch, when you <em>don't</em> provide a <code>--python-version</code>? Isn't that wrong?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-22 00:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-01-22 01:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/puffin-resolver/src/pubgrub/report.rs</code>:48 on 2024-01-22 01:45</div>
            <div class="timeline-body"><p>I have no idea why it's implemented that way, but yes as noted above if the target version is inferred from the current Python version it will not include the patch version. I'm all for changing that behavior if it was not intentional, but it doesn't seem like we should do it here.</p>
<p>Here's another commit showing the installed version alongside the target one: https://github.com/astral-sh/puffin/commit/43910a8e</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-22 01:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-resolver/src/pubgrub/report.rs</code>:48 on 2024-01-22 01:58</div>
            <div class="timeline-body"><p>Personally, I think the right order of operations is to fix the missing patch version (in a separate PR) and then rebase this on top of that. Otherwise, we're adding a workaround for a bug that we need to fix immediately. But feel free to merge, I see the issue and can fix now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-01-22 02:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/puffin-resolver/src/pubgrub/report.rs</code>:48 on 2024-01-22 02:02</div>
            <div class="timeline-body"><p>Tossed something up here ðŸ¤ž https://github.com/astral-sh/puffin/pull/1033</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-01-22 06:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/puffin-resolver/src/pubgrub/report.rs</code>:48 on 2024-01-22 06:31</div>
            <div class="timeline-body"><p>Thanks for fixing it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2024-01-22 06:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2024-01-22 06:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-01-22 06:32</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 15:39:25 UTC
    </footer>
</body>
</html>
