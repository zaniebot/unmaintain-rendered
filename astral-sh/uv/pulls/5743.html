<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avoid monomorphization of `untar` - astral-sh/uv #5743</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Avoid monomorphization of <code>untar</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/uv/pull/5743">#5743</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2024-08-03 01:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>This reduces the LLVM lines of the entire project by about 15%.</p>
<p>Before:</p>
<pre><code>  Lines                  Copies               Function name
  -----                  ------               -------------
  1742332                42054                (TOTAL)
    22384 (1.3%,  1.3%)     16 (0.0%,  0.0%)  tokio_tar::entry::EntryFields&lt;R&gt;::unpack::{{closure}}
    19113 (1.1%,  2.4%)     69 (0.2%,  0.2%)  alloc::raw_vec::RawVec&lt;T,A&gt;::grow_amortized
    18352 (1.1%,  3.4%)     80 (0.2%,  0.4%)  tokio_tar::entry::EntryFields&lt;R&gt;::unpack::{{closure}}::{{closure}}
    16871 (1.0%,  4.4%)    613 (1.5%,  1.9%)  core::result::Result&lt;T,E&gt;::map_err
    14747 (0.8%,  5.2%)    594 (1.4%,  3.3%)  &lt;core::result::Result&lt;T,E&gt; as core::ops::try_trait::Try&gt;::branch
    12576 (0.7%,  6.0%)     16 (0.0%,  3.3%)  &lt;tokio_tar::archive::Entries&lt;R&gt; as futures_core::stream::Stream&gt;::poll_next
    12314 (0.7%,  6.7%)    226 (0.5%,  3.8%)  &lt;alloc::boxed::Box&lt;T,A&gt; as core::ops::drop::Drop&gt;::drop
    11895 (0.7%,  7.4%)    296 (0.7%,  4.5%)  std::panicking::try
    11718 (0.7%,  8.0%)     63 (0.1%,  4.7%)  alloc::raw_vec::RawVec&lt;T,A&gt;::try_allocate_in
    11152 (0.6%,  8.7%)     16 (0.0%,  4.7%)  uv_extract::stream::untar_in::{{closure}}
    10977 (0.6%,  9.3%)      1 (0.0%,  4.7%)  uv::run::{{closure}}::{{closure}}
    10859 (0.6%,  9.9%)     77 (0.2%,  4.9%)  &lt;alloc::vec::Vec&lt;T&gt; as alloc::vec::spec_from_iter_nested::SpecFromIterNested&lt;T,I&gt;&gt;::from_iter
    10508 (0.6%, 10.5%)     18 (0.0%,  5.0%)  &lt;core::iter::adapters::flatten::FlattenCompat&lt;I,U&gt; as core::iter::traits::iterator::Iterator&gt;::size_hint
    10260 (0.6%, 11.1%)    138 (0.3%,  5.3%)  core::iter::traits::iterator::Iterator::try_fold
    10196 (0.6%, 11.7%)      8 (0.0%,  5.3%)  uv_extract::stream::unzip::{{closure}}
    10178 (0.6%, 12.3%)      7 (0.0%,  5.3%)  uv_client::cached_client::CachedClient::get_cacheable::{{closure}}::{{closure}}
     9698 (0.6%, 12.8%)    293 (0.7%,  6.0%)  tokio::loom::std::unsafe_cell::UnsafeCell&lt;T&gt;::with_mut
</code></pre>
<p>After:</p>
<pre><code>  Lines                  Copies               Function name
  -----                  ------               -------------
  1496463                37891                (TOTAL)
    14958 (1.0%,  1.0%)     54 (0.1%,  0.1%)  alloc::raw_vec::RawVec&lt;T,A&gt;::grow_amortized
    13997 (0.9%,  1.9%)    564 (1.5%,  1.6%)  &lt;core::result::Result&lt;T,E&gt; as core::ops::try_trait::Try&gt;::branch
    12776 (0.9%,  2.8%)    463 (1.2%,  2.9%)  core::result::Result&lt;T,E&gt;::map_err
    12381 (0.8%,  3.6%)    227 (0.6%,  3.5%)  &lt;alloc::boxed::Box&lt;T,A&gt; as core::ops::drop::Drop&gt;::drop
    11895 (0.8%,  4.4%)    296 (0.8%,  4.2%)  std::panicking::try
    10977 (0.7%,  5.1%)      1 (0.0%,  4.2%)  uv::run::{{closure}}::{{closure}}
    10859 (0.7%,  5.9%)     77 (0.2%,  4.4%)  &lt;alloc::vec::Vec&lt;T&gt; as alloc::vec::spec_from_iter_nested::SpecFromIterNested&lt;T,I&gt;&gt;::from_iter
    10508 (0.7%,  6.6%)     18 (0.0%,  4.5%)  &lt;core::iter::adapters::flatten::FlattenCompat&lt;I,U&gt; as core::iter::traits::iterator::Iterator&gt;::size_hint
    10196 (0.7%,  7.3%)      8 (0.0%,  4.5%)  uv_extract::stream::unzip::{{closure}}
    10178 (0.7%,  7.9%)      7 (0.0%,  4.5%)  uv_client::cached_client::CachedClient::get_cacheable::{{closure}}::{{closure}}
     9698 (0.6%,  8.6%)    293 (0.8%,  5.3%)  tokio::loom::std::unsafe_cell::UnsafeCell&lt;T&gt;::with_mut
     9078 (0.6%,  9.2%)      9 (0.0%,  5.3%)  core::slice::sort::partition_in_blocks
     8928 (0.6%,  9.8%)     48 (0.1%,  5.4%)  alloc::raw_vec::RawVec&lt;T,A&gt;::try_allocate_in
     8288 (0.6%, 10.3%)    296 (0.8%,  6.2%)  std::panicking::try::do_catch
     8190 (0.5%, 10.9%)    108 (0.3%,  6.5%)  core::iter::traits::iterator::Iterator::try_fold
     7540 (0.5%, 11.4%)    466 (1.2%,  7.7%)  core::ops::function::FnOnce::call_once
     6612 (0.4%, 11.8%)    296 (0.8%,  8.5%)  std::panicking::try::do_call
     6513 (0.4%, 12.3%)     56 (0.1%,  8.7%)  tokio::runtime::task::core::Cell&lt;T,S&gt;::new
     6438 (0.4%, 12.7%)    269 (0.7%,  9.4%)  alloc::boxed::Box&lt;T&gt;::new
     6360 (0.4%, 13.1%)     20 (0.1%,  9.4%)  &lt;toml_edit::de::value::ValueDeserializer as serde::de::Deserializer&gt;::deserialize_any
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/BurntSushi">@BurntSushi</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-03 01:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-03 01:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-03 01:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/ibraheemdev">@ibraheemdev</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-03 01:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-03 01:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-extract/src/stream.rs</code>:108 on 2024-08-03 01:29</div>
            <div class="timeline-body"><p>@BurntSushi @ibraheemdev -- How significant would you expect the penalty to be here for using dynamic dispatch?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2024-08-03 02:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/uv-extract/src/stream.rs</code>:108 on 2024-08-03 02:02</div>
            <div class="timeline-body"><p>I suspect the cost of I/O greatly outweights the extra indirection here, though the massive line reduction suggests the calls to <code>poll_read</code> were being inlined, so there likely will be some penalty. I&#x27;m not sure how hot of a path <code>untar</code> is that it would be noticeable.</p>
<p>Do we need the <code>Box</code> here? <code>&amp;mut dyn AsyncRead</code> should work, I think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-extract/src/stream.rs</code>:108 on 2024-08-03 17:38</div>
            <div class="timeline-body"><p>I can&#x27;t quite get <code>&amp;mut dyn AsyncRead</code> to work:</p>
<pre><code>error[E0308]: mismatched types
   --&gt; crates/uv-extract/src/stream.rs:170:17
    |
170 |     Ok(untar_in(archive, target.as_ref()).await?)
    |        -------- ^^^^^^^ expected `Archive&lt;&amp;mut ...&gt;`, found `Archive&lt;&amp;mut GzipDecoder&lt;...&gt;&gt;`
    |        |
    |        arguments to this function are incorrect
    |
    = note: expected struct `tokio_tar::Archive&lt;&amp;mut dyn tokio::io::AsyncRead + Unpin&gt;`
               found struct `tokio_tar::Archive&lt;&amp;mut async_compression::tokio::bufread::GzipDecoder&lt;tokio::io::BufReader&lt;R&gt;&gt;&gt;`
    = help: `async_compression::tokio::bufread::GzipDecoder&lt;tokio::io::BufReader&lt;R&gt;&gt;` implements `AsyncRead` so you could box the found value and coerce it to the trait object `Box&lt;dyn AsyncRead&gt;`, you will have to change the expected type as well
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-03 17:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2024-08-03 19:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/uv-extract/src/stream.rs</code>:108 on 2024-08-03 19:14</div>
            <div class="timeline-body"><p>You might have to do <code>(&amp;mut reader as &amp;mut dyn ...)</code> before wrapping it in <code>Archive</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-08-03 23:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/uv-extract/src/stream.rs</code>:108 on 2024-08-03 23:06</div>
            <div class="timeline-body"><p>Success, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-03 23:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-08-03 23:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-08-03 23:29</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:47:06 UTC
    </footer>
</body>
</html>
