```yaml
number: 1835
title: Hide index URLs from header if not emitted
type: pull_request
state: merged
author: drjackild
labels:
  - compatibility
assignees: []
merged: true
base: main
head: feat/hide-index-urls-if-not-emited
created_at: 2024-02-21T21:40:46Z
updated_at: 2024-02-23T10:17:13Z
url: https://github.com/astral-sh/uv/pull/1835
synced_at: 2026-01-10T14:54:43Z
```

# Hide index URLs from header if not emitted

---

_Pull request opened by @drjackild on 2024-02-21 21:40_

<!--
Thank you for contributing to uv! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

Hey guys! The motivation described in #1834

## Test Plan

Changed snapshot of the existing tests. `--index-url` and `--extra-index-url` occur pretty often, so no extra testing is required, imo.


---

_@zanieb reviewed on 2024-02-21 21:44_

---

_Review comment by @zanieb on `crates/uv/tests/pip_compile_scenarios.rs`:86 on 2024-02-21 21:44_

Should `--find-links` be included?

---

_Review comment by @zanieb on `crates/uv/src/commands/pip_compile.rs`:361 on 2024-02-21 21:44_

Does it make sense to use a regex here? Shouldn't we just do this filtering above when we construct the arguments to display?

---

_@zanieb reviewed on 2024-02-21 21:44_

---

_Comment by @zanieb on 2024-02-21 21:45_

Thanks for contributing again! I have a couple questions.

---

_@drjackild reviewed on 2024-02-21 21:45_

---

_Review comment by @drjackild on `crates/uv/tests/pip_compile_scenarios.rs`:86 on 2024-02-21 21:45_

Yeah, good point!

---

_@drjackild reviewed on 2024-02-21 21:50_

---

_Review comment by @drjackild on `crates/uv/src/commands/pip_compile.rs`:361 on 2024-02-21 21:50_

I started with this approach, but it looks hard for me to work with `env::args_os()` to do filtering - arguments could come both together (`--index-url=url`) and separately (`--index-url url`). But if you know the way to do this without regex here - I'll be more than happy to change my approach! I hate regexps üòÖ

---

_@drjackild reviewed on 2024-02-21 21:57_

---

_Review comment by @drjackild on `crates/uv/tests/pip_compile_scenarios.rs`:86 on 2024-02-21 21:57_

Ah, actually in `pip-tools` that's a separate option `--emit-find-links / --no-emit-find-links`, now I'm thinking maybe that makes sense ü§î Me personally never used them so I don't know use cases

---

_@zanieb reviewed on 2024-02-21 22:57_

---

_Review comment by @zanieb on `crates/uv/src/commands/pip_compile.rs`:361 on 2024-02-21 22:57_

I guess when we see `--index-url` we'd omit it and any subsequent arguments until we see another that starts with `-`, I think that should be safe? I admit I'm not entirely certain which approach is better.

---

_@zanieb reviewed on 2024-02-21 22:57_

---

_Review comment by @zanieb on `crates/uv/tests/pip_compile_scenarios.rs`:86 on 2024-02-21 22:57_

Oh interesting haha uhh let's keep them separate for now to match them.

---

_Review comment by @drjackild on `crates/uv/src/commands/pip_compile.rs`:361 on 2024-02-21 23:52_

Unfortunately, we can't omit any subsequent arguments till "-" because it could be situation with `uv pip compile --index-url https://pypi.org/simple requirements.in --some-other-arg`, but maybe it's safe to exclude the next one after index command itself...

---

_@drjackild reviewed on 2024-02-21 23:52_

---

_Review comment by @drjackild on `crates/uv/src/commands/pip_compile.rs`:361 on 2024-02-22 10:34_

So, I came up with this solution if we want to exclude regular expression. I personally don't like it, but it's doing it's job :) In the future, if we also want to exclude `--find-links` through other conditions, that could also be done this way

```rust
if include_header {
    writeln!(
        writer,
        "{}",
        "# This file was autogenerated by uv via the following command:".green()
    )?;
    let mut arguments = String::new();
    let mut skip_next = false;
    for arg in env::args_os().skip(1) {
        let arg = arg.normalized_display().to_string();
        if skip_next {
            skip_next = false;
            continue;
        }

        if !include_index_url {
            if arg == "--extra-index-url" || arg == "--index-url" {
                skip_next = true;
                continue;
            } else if arg.starts_with("--extra-index-url=") || arg.starts_with("--index-url=") {
                continue;
            }
        }
        arguments.push_str(&arg.normalized_display().to_string());
        arguments.push(' ');
    }
    writeln!(
        writer,
        "{}",
        format!("#    uv {}", arguments.trim()).green()
    )?;
}
```

---

_@drjackild reviewed on 2024-02-22 10:34_

---

_Review comment by @drjackild on `crates/uv/src/commands/pip_compile.rs`:361 on 2024-02-22 14:02_

Actually, during the discussion with my friend, we came up with some rustic way of filtering arguments. Regex removed and replaced with conditional filteringüëç 

---

_@drjackild reviewed on 2024-02-22 14:02_

---

_@charliermarsh reviewed on 2024-02-22 23:11_

---

_Review comment by @charliermarsh on `crates/uv/src/commands/pip_compile.rs`:360 on 2024-02-22 23:11_

This looks good to me, though I may pull it out to its own function.

---

_@drjackild reviewed on 2024-02-23 00:45_

---

_Review comment by @drjackild on `crates/uv/src/commands/pip_compile.rs`:360 on 2024-02-23 00:45_

Sure, no problem, extracted to a separate functionüëç

---

_@charliermarsh approved on 2024-02-23 01:38_

---

_Renamed from "Hide index urls from header if not emmited" to "Hide index URLs from header if not emitted" by @charliermarsh on 2024-02-23 01:38_

---

_Label `compatibility` added by @charliermarsh on 2024-02-23 01:38_

---

_Merged by @charliermarsh on 2024-02-23 01:48_

---

_Closed by @charliermarsh on 2024-02-23 01:48_

---

_Comment by @charliermarsh on 2024-02-23 02:40_

Thank you!

---

_Branch deleted on 2024-02-23 10:17_

---
