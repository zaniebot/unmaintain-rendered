<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>(mostly) stop unioning in `Unknown` type where there is no type annotation - astral-sh/ty #1240</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>(mostly) stop unioning in <code>Unknown</code> type where there is no type annotation</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1240">#1240</a>
        opened by <a href="https://github.com/DetachHead">@DetachHead</a>
        on 2025-09-23 02:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/DetachHead">@DetachHead</a> on 2025-09-23 02:28</div>
            <div class="timeline-body"><p>the current default behavior is unsafe, see https://play.ty.dev/b92b01eb-09da-48ea-8e4b-02812d27a803</p>
<pre><code class="language-py">a = [1] # inferred as list[Unknown | int]
a.append(&quot;i'm not an int&quot;) # no error
a.pop() + 1 # runtime crash
</code></pre>
<p>as mentioned in https://github.com/astral-sh/ty/issues/1211#issuecomment-3322024482:</p>
<blockquote>
<p>I do think we will likely add an option to, or even default to, inferring the type of un-annotated generic container literals without the union with <code>Unknown</code>.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KotlinIsland">@KotlinIsland</a> on 2025-09-23 02:50</div>
            <div class="timeline-body"><p>i believe this case is essential:</p>
<pre><code class="language-py">class A:
    length = 100  # inferred as Unknown | Literal[100]

def get_length() -&gt; int | None:
    return None

def f(a: A):
    a.length + 1

a = A()
a.length = get_length()  # oops!
f(a)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">type-inference</span> added by @sharkdp on 2025-09-23 09:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wish</span> added by @sharkdp on 2025-09-23 09:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-23 09:24</div>
            <div class="timeline-body"><p>As a note for readers who are not aware about the full context: our current behavior is very much intentional and documented <a href="https://github.com/astral-sh/ruff/blob/main/crates/ty_python_semantic/resources/mdtest/doc/public_type_undeclared_symbols.md">here</a> (with an example similar to the one in the second post). This does not mean that we are opposed to future changes or opt-ins to stricter behavior. I just want to emphasize that this is not a bug.</p>
<p>There is a tradeoff between &quot;fewer false positives on <em>correct</em> untyped code&quot;, and &quot;fewer false negatives on <em>incorrect</em> untyped code&quot;. And ty currently chooses to lean more towards the former behavior (more so than mypy and pyright).</p>
<p>Also, please note that both issues above <em>can</em> be caught by adding a single type annotation (<code>a: list[int]</code> and <code>length: int</code> / <code>length: int | None</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DetachHead">@DetachHead</a> on 2025-09-23 13:30</div>
            <div class="timeline-body"><blockquote>
<p>Also, please note that both issues above <em>can</em> be caught by adding a single type annotation (<code>a: list[int]</code> and <code>length: int</code> / <code>length: int | None</code>).</p>
</blockquote>
<p>as i said in https://github.com/astral-sh/ty/issues/1211#issuecomment-3321964618, i don't think this is an optimal solution:</p>
<blockquote>
<p>But doesn’t that mean users who want full strictness will have to annotate <em>everything</em> to opt out of this behavior, and therefore can’t rely on type inference at all?</p>
</blockquote>
<blockquote>
<p>I realize that people like us who want the type checker to be as strict as possible are in the minority, but this sounds like ty will be a downgrade for us, which is a shame because everything else astral has made has been a massive improvement over the existing solutions.</p>
<p>If gradual adoption of type safety is the goal, what does that mean for people who complete the “gradual” journey and end up at the same place as us? Their experience will be degraded by being forced to annotate everything, which is a major reason why people don’t like the idea of type checkers in the first place.</p>
</blockquote>
<p>i'm glad you guys are open to adding an option to change this behavior, i just figured it was worth re-iterating my stance from the other issue for those that didn't see that converation</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KotlinIsland">@KotlinIsland</a> on 2025-09-25 00:18</div>
            <div class="timeline-body"><p>this case is essential</p>
<p>as this is not <code>@Todo</code>, i am assuming that it is intentional, and not incomplete functionality</p>
<pre><code class="language-py">class C:
    def f(self):
        self  # Unknown
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-09-25 00:31</div>
            <div class="timeline-body"><blockquote>
<p>i am assuming that it is intentional, and not incomplete functionality</p>
</blockquote>
<p>It is just incomplete functionality and unrelated to this issue. It doesn't use <code>@Todo</code> simply because it dates back to before the existence of that type. There's ongoing work in progress to fix this, it just uncovers some other issues that needed resolution first.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-11-04 20:51</div>
            <div class="timeline-body"><p>The plan outlined in https://github.com/astral-sh/ty/issues/1473 would mean that we don't need to union in <code>Unknown</code>, and instead extend bidirectional inference to ensure type-safety at all uses of the collection (or any generic class). However, we may still want a strict option to opt out of that behaviour and error more eagerly.</p>
<p>Also note that our current behavior is somewhat inconsistent in that we only add <code>Unknown</code> to collection literals, and not generic class constructors in general. It's not clear we want to change that right now, as it tends to work well in practice, and will eventually be solved by https://github.com/astral-sh/ty/issues/1473 .</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bidirectional inference</span> added by @ibraheemdev on 2025-11-04 20:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Stable" by @carljm on 2025-11-13 00:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wish</span> removed by @carljm on 2025-11-13 00:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Stable" by @carljm on 2025-12-26 17:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Pre-stable 1" by @carljm on 2025-12-26 17:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bidirectional inference</span> removed by @carljm on 2026-01-08 18:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @carljm by @carljm on 2026-01-09 15:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2026-01-09 17:44</div>
            <div class="timeline-body"><p>Even prior to implementing #1473, we now plan to remove the union-with-Unknown behavior in almost all cases (and not even keep an option to enable it broadly). For now we will still have <code>list[Unknown]</code> for <code>mylist = []</code>, but that will be fixed by #1473. But <code>mylist = [1, 2, 3]</code> will be inferred as <code>list[int]</code> (not <code>list[Unknown | int]</code>) and an <code>x = 1</code> attribute will be inferred as an attribute of type <code>int</code> (not <code>Unknown | int</code>).</p>
<p>The one case where we plan to keep the union-with-Unknown is for singleton types (most notably <code>None</code>). In effect this will be another form of literal-promotion, where we &quot;promote&quot; <code>None</code> to <code>Unknown | None</code>, because it's very unlikely that you want an instance attribute whose value can only ever be <code>None</code>, or a list that can only ever contain <code>None</code>. (If you do want that, of course it is still possible via explicit annotation.) We will have an opt-in diagnostic to warn in the cases where this promotion occurs, for those users who want to ensure they don't ever get this <code>Unknown</code> inserted.</p>
<p>If there are users reading this who are concerned about this change, or feel that you have use cases that will be negatively affected, please reach out so we can discuss your use case!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "add an option to disable `Unknown` type from from being added where there is no type annotation" to "(mostly) stop unioning in `Unknown` type where there is no type annotation" by @carljm on 2026-01-09 17:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KotlinIsland">@KotlinIsland</a> on 2026-01-10 05:04</div>
            <div class="timeline-body"><p>@carljm this sounds really perfect. I'm really glad to see that the decision makers here have the right direction</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AndBoyS">@AndBoyS</a> on 2026-01-10 09:04</div>
            <div class="timeline-body"><blockquote>
<p>Even prior to implementing <a href="https://github.com/astral-sh/ty/issues/1473">#1473</a>, we now plan to remove the union-with-Unknown behavior in almost all cases (and not even keep an option to enable it broadly). For now we will still have <code>list[Unknown]</code> for <code>mylist = []</code>, but that will be fixed by <a href="https://github.com/astral-sh/ty/issues/1473">#1473</a>. But <code>mylist = [1, 2, 3]</code> will be inferred as <code>list[int]</code> (not <code>list[Unknown | int]</code>) and an <code>x = 1</code> attribute will be inferred as an attribute of type <code>int</code> (not <code>Unknown | int</code>).</p>
<p>The one case where we plan to keep the union-with-Unknown is for singleton types (most notably <code>None</code>). In effect this will be another form of literal-promotion, where we &quot;promote&quot; <code>None</code> to <code>Unknown | None</code>, because it's very unlikely that you want an instance attribute whose value can only ever be <code>None</code>, or a list that can only ever contain <code>None</code>. (If you do want that, of course it is still possible via explicit annotation.) We will have an opt-in diagnostic to warn in the cases where this promotion occurs, for those users who want to ensure they don't ever get this <code>Unknown</code> inserted.</p>
<p>If there are users reading this who are concerned about this change, or feel that you have use cases that will be negatively affected, please reach out so we can discuss your use case!</p>
</blockquote>
<p>It will still be nice to have as an opt-in option for untyped code, since it will be a source of some false positives (from my experience, it will usually come from list of custom objects, like [CustomClass1(), CustomClass2(), ...])</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:40:39 UTC
    </footer>
</body>
</html>
