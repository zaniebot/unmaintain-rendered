<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discovery of local venv - astral-sh/ty #171</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Discovery of local venv</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/171">#171</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-03-14 10:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-14 10:42</div>
            <div class="timeline-body"><p>Red Knot currently requires users to configure the path to their venv explicitly. Red Knot should try to detect the presence of a venv by following community best practices (<code>$VIRTUAL_ENV</code>, <code>.venv</code>, <code>venv</code>).</p>
<p>Related: <a href="https://github.com/astral-sh/uv/blob/6cc7a560f72a9e34907df5309d61980dac52a044/crates/uv-python/src/discovery.rs#L181-L202">uv's supported python sources</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-14 19:21</div>
            <div class="timeline-body"><blockquote>
<p>Red Knot should try to detect the precense of a venv by following community best practices (<code>$VIRTUAL_ENV</code>, <code>.venv</code>, <code>venv</code>).</p>
</blockquote>
<p>The last two of these are sort-of heuristics: virtual environments are also often called <code>.env</code>, <code>env</code>, or something else altogether. I'm okay with <code>.venv</code>, as there have been effors (supported by uv and several other tools) to make <code>.venv</code> a standard name that should be used by all Python virtual environments. But I'd vote for keeping the special-casing to just <code>.venv</code>, and not applying the special-casing to <code>venv</code>. It's a much less common name for the virtual environment, and there's no attempt to make a standard around it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Disocvery of local venv" to "[red-knot] Discovery of local venv" by @AlexWaygood on 2025-03-14 20:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-03-20 13:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-03-20 13:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @MichaReiser on 2025-03-20 13:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-20 13:56</div>
            <div class="timeline-body"><p>Let's keep this open because we may want to support picking up <code>.venv</code> even if <code>VIRTUAL_ENV</code> isn't set.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-20 13:57</div>
            <div class="timeline-body"><blockquote>
<p>Let's keep this open because we may want to support picking up <code>.venv</code> even if <code>VIRTUAL_ENV</code> isn't set.</p>
</blockquote>
<p>If we do this, do we want to also support a <code>--no-site-packages</code> flag to allow users to avoid this implicit fallback? It might not be welcome in all cases; there are some cases where you want to ensure isolation and don't want the type checker to use any types from the virtual environment, even if there is one</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-21 12:46</div>
            <div class="timeline-body"><p>One more thing we should consider here is the LSP integration where <code>VIRTUAL_ENV</code> is unlikely to be set.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-21 12:50</div>
            <div class="timeline-body"><p>Huh, I always have the project's virtual environment activated when I'm working on a Python project in my IDE (and if the virtual environment is activated, the <code>VIRTUAL_ENV</code> variable is certain to be set). It's impossible to e.g. run tests from a terminal in my IDE if the correct virtual environment isn't activated.</p>
<p>But even if the virtual environment isn't activated, pylance always forces me to explicitly tell it which system installation or virtual environment it should use for the project (from a drop-down menu) before I can start working on a project</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-21 13:25</div>
            <div class="timeline-body"><p>Yes, this is a functionality that pylance (the python extension) provides. We should either integrate with the python extension (the downside here is that the python extension comes with its own LSP) or implement our own Python/venv discovery.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-03-28 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-03-28 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @MichaReiser on 2025-03-28 18:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Discovery of local venv" to "Discovery of local venv" by @MichaReiser on 2025-05-07 15:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/collinanderson">@collinanderson</a> on 2025-05-11 02:30</div>
            <div class="timeline-body"><p>Not sure if this is related or not, but <code>uv run --with=ty ty check</code> fails to pick up the rest of my <code>.venv</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">imports</span> added by @AlexWaygood on 2025-05-11 08:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-05-11 15:52</div>
            <div class="timeline-body"><p>We might not support nested virtual environments like uv uses for <code>--with</code> in ty yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-11 15:54</div>
            <div class="timeline-body"><blockquote>
<p>We might not support nested virtual environments like uv uses for <code>--with</code> in ty yet.</p>
</blockquote>
<p>What does uv set the <code>VIRTUAL_ENV</code> variable to if it's running a command with one of these nested virtual environments?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-05-11 15:57</div>
            <div class="timeline-body"><p>It would have to be the nested one, so those packages are available.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-05-11 15:59</div>
            <div class="timeline-body"><p>See https://github.com/astral-sh/uv/blob/f557ea382378dba716471b3021611abe8b0a3bbe/crates/uv/src/commands/project/run.rs#L980-L1006</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-11 16:01</div>
            <div class="timeline-body"><p>Huh, we should support these nested venvs in ty already then.</p>
<p>At a guess: maybe some of the packages @collinanderson is importing in his repo are only listed as dev-dependencies, and he hasn't passed <code>--dev</code>, so uv hasn't included them in the environment? Hard to tell without more specifics, though</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/collinanderson">@collinanderson</a> on 2025-05-11 16:52</div>
            <div class="timeline-body"><p>Steps to reproduce (CPython 3.13.2, uv 0.7.3, ty 0.0.0-alpha.8):</p>
<pre><code>uv init tmp
cd tmp
uv add httpx
echo 'import httpx' &gt;&gt; main.py
uv run --with ty ty check
</code></pre>
<p>ty says:</p>
<pre><code>error[unresolved-import]: Cannot resolve imported module `httpx`
</code></pre>
<p>it works fine if you <code>uv add ty</code>, but doesn't work when you <code>uv run --with ty ty check</code>. <code>uv run --with mypy mypy .</code> works fine and finds the import.</p>
<details>
<summary>uv run --with ty ty check --verbose --verbose</summary>

<pre><code>2025-05-11 12:51:51.281544701 WARN ty is pre-release software and not ready for production use. Expect to encounter bugs, missing features, and fatal errors.
2025-05-11 12:51:51.281577281 DEBUG Version: 0.0.0-alpha.8
2025-05-11 12:51:51.281602471 DEBUG Architecture: x86_64, OS: linux, case-sensitive: case-sensitive
2025-05-11 12:51:51.281703641 DEBUG Searching for a project in '/home/collin/tmp'
2025-05-11 12:51:51.281806121 DEBUG Resolving requires-python constraint: `&gt;=3.13`
2025-05-11 12:51:51.281832661 DEBUG Resolved requires-python constraint to: 3.13
2025-05-11 12:51:51.281854762 DEBUG Project without `tool.ty` section: '/home/collin/tmp'
2025-05-11 12:51:51.281868452 DEBUG Searching for a user-level configuration at `/home/collin/.config/ty/ty.toml`
2025-05-11 12:51:51.281893422 INFO Defaulting to python-platform `linux`
2025-05-11 12:51:51.281917742 INFO Python version: Python 3.13, platform: linux
2025-05-11 12:51:51.281930492 DEBUG Adding first-party search path '/home/collin/tmp'
2025-05-11 12:51:51.281947742 DEBUG Using vendored stdlib
2025-05-11 12:51:51.282668282 DEBUG Discovering site-packages paths from sys-prefix `/home/collin/.cache/uv/archive-v0/aA7ze3NeJgM8fooLQjSvY` (`VIRTUAL_ENV` environment variable')
2025-05-11 12:51:51.282701342 DEBUG Attempting to parse virtual environment metadata at '/home/collin/.cache/uv/archive-v0/aA7ze3NeJgM8fooLQjSvY/pyvenv.cfg'
2025-05-11 12:51:51.282745112 DEBUG Searching for site-packages directory in `sys.prefix` path `/home/collin/.cache/uv/archive-v0/aA7ze3NeJgM8fooLQjSvY`
2025-05-11 12:51:51.282753712 DEBUG Resolved site-packages directories for this virtual environment are: [&quot;/home/collin/.cache/uv/archive-v0/aA7ze3NeJgM8fooLQjSvY/lib/python3.13/site-packages&quot;]
2025-05-11 12:51:51.282758592 DEBUG Adding site-packages search path '/home/collin/.cache/uv/archive-v0/aA7ze3NeJgM8fooLQjSvY/lib/python3.13/site-packages'
2025-05-11 12:51:51.282942792 DEBUG Starting main loop
Checking ------------------------------------------------------------ 0/0 files                                                                                                    2025-05-11 12:51:51.283013262 DEBUG Waiting for next main loop message.
2025-05-11 12:51:51.283144902 DEBUG Checking project 'tmp'
2025-05-11 12:51:51.285666824 INFO Indexed 1 file(s)
Checking ------------------------------------------------------------ 0/1 files                                                                                                    2025-05-11 12:51:51.286172246 DEBUG Checking file '/home/collin/tmp/main.py'
2025-05-11 12:51:51.316921754 DEBUG Resolving dynamic module resolution paths
2025-05-11 12:51:51.317122364 DEBUG Module `httpx` not found in search paths
error[unresolved-import]: Cannot resolve imported module `httpx`
</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-05-11 17:00</div>
            <div class="timeline-body"><p>Let's track this separately from here â€” https://github.com/astral-sh/ty/issues/320</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-12 20:37</div>
            <div class="timeline-body"><p>I'm not sure there's anything left to do here. Everything in the issue's original writeup has been implemented, and so has https://github.com/astral-sh/ty/issues/171#issuecomment-2859026083. If there's anything more to be done in this area, I think it would be easier to track if we opened specific issues for the followups</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-05-12 20:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 02:10:54 UTC
    </footer>
</body>
</html>
