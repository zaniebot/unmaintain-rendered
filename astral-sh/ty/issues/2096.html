<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>special-case try/except ImportError if all imports resolve - astral-sh/ty #2096</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>special-case try/except ImportError if all imports resolve</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/2096">#2096</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-12-19 01:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><blockquote>
<p>I encountered a case of this with library <code>mypy_boto3_s3</code> (<a href="https://pypi.org/project/mypy-boto3-s3/">pypi</a>, <a href="https://github.com/youtype/mypy_boto3_builder">github generator code</a>). It uses a <code>try / except ImportError</code> pattern, I think for Python backwards compatibility?</p>
<pre><code># mypy_boto3_s3/__init__.py
try:
    from .service_resource import S3ServiceResource
except ImportError:
    from builtins import object as S3ServiceResource  # type: ignore[assignment]
</code></pre>
<p>Unfortunately, ty doesn&#x27;t handle this as gracefully as mypy. Mypy seems to recognize my <code>var: mypy_boto3_s3.S3ServiceResource</code> as an instance of <code>mypy_boto3_s3.service_resource.S3ServiceResource</code>, but ty instead widens it to <code>object</code>, and then it doesn&#x27;t type check my code correctly.</p>
<p>I have no suggestion on how to handle this correctly, I am simply reporting that I encountered this issue in the wild.</p>
<p>Here&#x27;s a basic reproduction case:</p>
<pre><code># mypy_boto3_s3_test.py
from mypy_boto3_s3 import S3ServiceResource

def f() -&gt; S3ServiceResource:
    &quot;&quot;&quot;Fake making an S3ServiceResource&quot;&quot;&quot;
    return None  # type: ignore

s = f()
s.get_available_subresources()  # ty thinks this is an error

</code></pre>
<pre><code>$ uvx ty version
ty 0.0.2

$ uvx ty check mypy_boto3_s3_test.py 
error[unresolved-attribute]: Object of type `object` has no attribute `get_available_subresources`
 --&gt; mypy_boto3_s3_test.py:9:1
  |
8 | s = f()
9 | s.get_available_subresources()  # ty thinks this is an error
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  |
info: rule `unresolved-attribute` is enabled by default

Found 1 diagnostic
</code></pre>
</blockquote>
<p><em>Originally posted by @leon-sony in <a href="https://github.com/astral-sh/ty/issues/1585#issuecomment-3667714012">#1585</a></em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-19 01:12</div>
            <div class="timeline-body"><p>I think ty is more capable than mypy in this case, not less -- but since this package was designed around mypy&#x27;s behavior, the results with this package are worse.</p>
<p>Mypy simply doesn&#x27;t allow the double definition of <code>S3ServiceResource</code>, which is why the <code>type: ignore</code> on the second definition is required. And in this error case, mypy simply ignores the second definition and prefers the first. This is a bit arbitrary, but it happens to be the mypy behavior, so it&#x27;s the behavior that the authors of this code generator rely on.</p>
<p>ty supports multiple definitions of the same name, and infers a union type, which is correct: according to the code, at runtime, the name could be either a real <code>S3ServiceResource</code>, or it could be the fallback of <code>object</code>. This union type simplifies to <code>object</code> (because all types are subtypes of <code>object</code>), and thus the behavior you see.</p>
<p>The only thing I could really see us doing here is adding some special handling for <code>try/except</code> when the <code>try</code> block consists entirely of import statements and the <code>except</code> is an <code>except ImportError</code>, and all the imports resolve successfully under the current module resolution settings. In this case, we could consider the <code>except</code> block to be unreachable code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">control flow</span> added by <a href="https://github.com/carljm">@carljm</a> on 2025-12-19 01:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">imports</span> added by <a href="https://github.com/carljm">@carljm</a> on 2025-12-19 01:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-19 01:14</div>
            <div class="timeline-body"><p>This issue is sort of just the reincarnation of #309, except this is an example of a case where disabling <code>possibly-missing-import</code> rule doesn&#x27;t help.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;mypy_boto_s3 relies on ignoring second import of a name&quot; to &quot;special-case try/except ImportError if all imports resolve&quot; by <a href="https://github.com/carljm">@carljm</a> on 2025-12-19 01:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-29 09:05</div>
            <div class="timeline-body"><p>Related case where we run into this on the server side <a href="https://github.com/astral-sh/ty/issues/2249">astral-sh/ty#2249</a>#issuecomment-3695877740</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-31 15:20</div>
            <div class="timeline-body"><p>I&#x27;ll move this to stable as it also impacts the LSP</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Stable&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-31 15:20</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:26:38 UTC
    </footer>
</body>
</html>
