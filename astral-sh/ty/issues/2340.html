<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Many keystrokes are required before a `Literal` auto-import completion suggestion is offered - astral-sh/ty #2340</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Many keystrokes are required before a `Literal` auto-import completion suggestion is offered</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/2340">#2340</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2026-01-05 11:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-05 11:48</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Take a look at this video. The <code>Literal</code> auto-import suggestion is only provided after I have typed <code>Liter</code>, despite there being only one suggestion offered after typing <code>Lite</code>:</p>
<p>https://github.com/user-attachments/assets/4aafddf2-4a27-4b0a-b1fd-56f49e0ed4cc</p>
<p>@RasmusNygren and @MichaReiser observe:</p>
<blockquote>
<p>We seem to lose that suggestions when we truncate to the top 1000 completions: https://github.com/astral-sh/ruff/blob/8464aca795bc3580ca15fcb52b21616939cea9a9/crates/ty_ide/src/completion.rs#L122. Revert that and the behaviour is as expected, which suggests that the suggestion has very low ranking.</p>
<p>There's probably some improvements that can be made to the ranking heuristics, I think everything that's not yet imported is being ranked lower.
I'm a bit surprised that's not in the top 1000 either way, though.</p>
<p>The name is used last when ranking autocompletion suggestions. Maybe it's something we should give a higher weight to.</p>
<p>It seems like we might need a slightly more sophisticated ranking heuristic when we limit the completions to some top <code>N</code> completions. You can't rely on fallbacks quite as much in that situation</p>
</blockquote>
<h3>Version</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2026-01-05 11:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @AlexWaygood on 2026-01-05 11:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">completions</span> added by @AlexWaygood on 2026-01-05 11:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-05 12:03</div>
            <div class="timeline-body"><p>In general, I think we should make our fuzzing matching more strict. E.g. only add a <code>.*</code> pattern after uppercase letters to match <code>TypeInferenceBuilder</code> when writing <code>TIBuilder</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-05 12:33</div>
            <div class="timeline-body"><p>I'm guessing there's the same root cause for why an auto-import suggestion for <code>ty_extensions.TypeOf</code> is not provided here:</p>
<p><img width="2012" height="528" alt="Image" src="https://github.com/user-attachments/assets/6c3c3ee3-c8fa-41e9-8c65-f071bd7f370e" /></p>
<p>This seems to be quite a big usability regression for completions</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Pre-stable 1" by @AlexWaygood on 2026-01-05 12:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-05 12:44</div>
            <div class="timeline-body"><p>Would you mind adding a playground :) So that I don't need to copy paste your code?</p>
<p>I'm a bit surprised that we run into this in the playground because the truncation only happens if there are more than 1000 suggestions. I would expect this to mainly be an issue when working with many third-party dependencies (or a system python with many packages installed)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-05 12:59</div>
            <div class="timeline-body"><blockquote>
<p>Would you mind adding a playground :) So that I don't need to copy paste your code?</p>
</blockquote>
<p>oops, sorry ðŸ˜¶ here you go: https://play.ty.dev/48e66663-66d3-4ba5-ba83-cd46f2ca38a3</p>
<p>I would expect <code>ty_extensions.TypeOf</code> to be the top autoimport suggestion for this situation, but only <code>ty_extensions.CallableTypeOf</code> is provided as a suggestion:</p>
<pre><code class="language-py">from ty_extensions import is_subtype_of
from typing import reveal_type

reveal_type(bool(is_subtype_of(type[type], TypeO&lt;CURSOR&gt;)))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-06 13:20</div>
            <div class="timeline-body"><p>Another example: <code>Enum</code> is not offered as an auto-import autocomplete suggestion at all here:</p>
<p><img width="1496" height="1054" alt="Image" src="https://github.com/user-attachments/assets/8aa69f67-e5ac-496b-9c77-441af03eb5fb" /></p>
<p>https://play.ty.dev/ebb3aa40-b1e6-4381-ac33-105fcd2f381e</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @BurntSushi by @BurntSushi on 2026-01-06 19:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2026-01-07 17:14</div>
            <div class="timeline-body"><p>OK, so the actual root cause here is indeed the limiting to 1,000 completions (as already said above), but the reason is more subtle. In particular, the problems identified here do not occur in VS Code. Indeed, it looks like this might be a playground specific problem. More to the point, the problem (using the <code>Literal</code> example in the OP) disappears when you re-request completions. You can see it in the video here:</p>
<p>https://github.com/user-attachments/assets/7524fc38-15c1-462b-bb4d-4718beb0a592</p>
<p>What I believe is happening here is that the playground isn't respecting <a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#completionList"><code>CompletionList::isIncomplete</code></a>, which we set here unconditionally:</p>
<p>https://github.com/astral-sh/ruff/blob/60038709927aa5d133b8428de2deda4667fbe812/crates/ty_server/src/server/api/requests/completion.rs#L134-L137</p>
<p>Basically, <code>isIncomplete</code> is <em>supposed</em> to tell LSP clients to re-request completions on each keystroke. When it's <code>false</code> (or not respected), then subsequent keystrokes after the initial completion request specifically <em>won't</em> re-request completions. This lets the LSP client do the entirety of the filtering on the client side without involving the server. The obvious downside here is that if you start with a very broad query like <code>L</code>, then the LSP client is fundamentally limited to whatever suggestions are returned in that initial request.</p>
<p>Before the limiting was put in place, we'd just return everything. So the LSP client filtering would still work. But with the limit put in place, anything beyond that cut-off will never have a chance of being shown as the user refines their query.</p>
<p>But wait... where we set <code>isIncomplete</code> isn't used by the playground. So my claim is perhaps not true. Checking if Monaco has <a href="https://microsoft.github.io/monaco-editor/typedoc/interfaces/languages.CompletionList.html"><code>isIncomplete</code></a> reveals that it does. And indeed, we do not set it.</p>
<p>So, the fix is simple: https://github.com/astral-sh/ruff/pull/22442</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2026-01-07 17:17</div>
            <div class="timeline-body"><p>I've confirmed that https://github.com/astral-sh/ruff/pull/22442 fixed all three of the issues identified by @AlexWaygood</p>
<p>(You can tell because if you re-request completions after typing, the expected completions show up.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2026-01-07 17:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:51:35 UTC
    </footer>
</body>
</html>
