<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annotated Self changes variance of class - astral-sh/ty #2074</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Annotated Self changes variance of class</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/2074">#2074</a>
        opened by <a href="https://github.com/Matt-Ord">@Matt-Ord</a>
        on 2025-12-18 14:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Matt-Ord">@Matt-Ord</a> on 2025-12-18 14:42</div>
            <div class="timeline-body"><h3>Summary</h3>
<pre><code class="language-python">class A[M: BasisMetadata = BasisMetadata]:
    def __init__(self, metadata: M) -&gt; None:
        self._metadata = metadata

    def makes_it_covariant(self) -&gt; M:
        &quot;&quot;&quot;An example method that makes the object covariant.&quot;&quot;&quot;
        return self._metadata

    def makes_it_invariant(self: A[Any]) -&gt; None:
        &quot;&quot;&quot;This (incorrectly?) makes the object invariant.&quot;&quot;&quot;
</code></pre>
<p>I've use this along with a similar pattern like</p>
<pre><code class="language-py">    def makes_it_invariant[M1: BasisMetadata = BasisMetadata](
        self: A[M1], other: M1
    ) -&gt; Never:
        &quot;&quot;&quot;This (incorrectly?) makes the object invariant.&quot;&quot;&quot;
</code></pre>
<h3>Version</h3>
<p>0.0.2</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-18 14:50</div>
            <div class="timeline-body"><p>Here's a <a href="https://pyright-play.net/?pyrightVersion=1.1.405&amp;pythonVersion=3.13&amp;reportUnreachable=true&amp;code=GYJw9gtgBA%2BjwFcAuCQFM5QJYQA5hCSgEMA7UsJYpLMUgZwChRIokBPXLUgc2zwJEAgqXaNGAYwA2xevSgAhWVnoBZNFQAm1YgC4oAOiOSZcqAGUEAI3VadACiX0Vt4tqoBKfUYPjps%2BSEAbVV9JxcNNx0AXV1GKASoTTRgWBhuLCQ4e3o0KWAAGigISPc9KFUPKABaAD4oADk6NDjEtqhc-IMYErsqKABeYtKdcTbk1IhiAGs0enSsiTAAN2IQLDIkHLzgKrqK1vaEgCJTkSg0AA9iPCk0YaQACzBNNkfqYpm5t-uwKwArNASIhLVbrTYGU7HeJHKDoFAgUgdHbdXpRKhjRITT6zeaZdKkMEbUhbTrAfTBETsaJ7epNUgtGFHKEAFUeKig9m4SxA6GBUnYAH4qlNcT8oH9AcDsIS1sSkJDTuJscB7JcKUFwmoRlQad5jIxsTw1RrLDYdcQ9UyoKrLh5GEA">pyright playground</a> showing that pyright infers this class as covariant, whereas we <a href="https://play.ty.dev/283289c4-acee-4763-8f30-e81c3d650de3">do not</a>. I wondered if pyright's behaviour might be because the <code>self</code> parameter is annotated with <code>self: A[Any]</code> rather than <code>self: A[M]</code>, but pyright has the same behaviour if you change the parameter annotation to <code>self: A[M]</code>. It looks like it is applying special handling due to the fact that it is the <code>self</code> parameter specifically.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">typing semantics</span> added by @AlexWaygood on 2025-12-18 14:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-23 00:31</div>
            <div class="timeline-body"><p>I think there are actually two bugs here:</p>
<ol>
<li>It seems like we wrongly consider typevars that are in the generic context of an annotation but specialized away, as &quot;used&quot; in the annotation for purposes of variance inference. If this were fixed, then <code>A[Any]</code> (or <code>A[WhateverConcreteType]</code>) in any method parameter annotation should not cause invariance of <code>M</code>, but <code>A[M]</code> should.</li>
<li><code>self</code> is different; type checkers ignore it for variance purposes because it is not provided explicitly. (Well, there's some subtlety here around use of unbound methods on <code>type[...]</code> types, but <code>type[...]</code> types are pretty unsound anyway...) It looks like maybe we don't do that, either, since <code>self: A[M]</code> doesn't make <code>A</code> invariant in <code>M</code> for other type checkers, but does for us.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Stable" by @carljm on 2025-12-23 00:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">generics</span> added by @carljm on 2025-12-23 00:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2026-01-08 19:20</div>
            <div class="timeline-body"><p>Point 1 is #1459</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:48:55 UTC
    </footer>
</body>
</html>
