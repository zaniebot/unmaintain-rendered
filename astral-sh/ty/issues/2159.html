<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Type narrowing does not happen when covered by multiple branches - astral-sh/ty #2159</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Type narrowing does not happen when covered by multiple branches</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/2159">#2159</a>
        opened by <a href="https://github.com/omerhadari">@omerhadari</a>
        on 2025-12-22 13:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/omerhadari">@omerhadari</a> on 2025-12-22 13:57</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Hi! Wasn't sure how to word the name of this issue.</p>
<p>The following code:</p>
<pre><code class="language-Python">from typing import reveal_type


def check(a: str | None) -&gt; None:
    if a:
        print(&quot;hey&quot;)
    elif a:
        print(&quot;ya&quot;)
    else:
        a = &quot;a&quot;
    reveal_type(a)
</code></pre>
<p>produces the following output in <code>ty</code>:</p>
<pre><code>info[revealed-type]: Revealed type
 --&gt; bla.py:9:17
  |
7 |     else:
8 |         a = &quot;a&quot;
9 |     reveal_type(a)
  |                 ^ `str | None`
  |

Found 1 diagnostic
</code></pre>
<p>and in <code>mypy</code>:</p>
<pre><code>bla.py:9: note: Revealed type is &quot;builtins.str&quot;
</code></pre>
<p>The specific example is a bit weird I realize, but there are real use cases in the code base where I found this for example:</p>
<pre><code class="language-Python">def check(conf: dict[str, str] | None, flag: bool) -&gt; None:
    if conf and flag:
        print(&quot;hey&quot;)
    elif conf and not flag:
        print(&quot;ya&quot;)
    else:
        return
    print(conf.get(&quot;key&quot;))
</code></pre>
<h3>Version</h3>
<p>ty 0.0.5 (d37b7dbd9 2025-12-20)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">narrowing</span> added by @AlexWaygood on 2025-12-22 14:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-22 14:31</div>
            <div class="timeline-body"><p>I think this may be https://github.com/astral-sh/ty/issues/690</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/omerhadari">@omerhadari</a> on 2025-12-22 14:38</div>
            <div class="timeline-body"><blockquote>
<p>I think this may be <a href="https://github.com/astral-sh/ty/issues/690">#690</a></p>
</blockquote>
<p>I think it is actually, I searched but missed it. You can close this one (or I can) :)</p>
<p>Thank you!</p>
<p>edit: I do think it should be a single issue, but maybe the following quote from the original issue doesn't cover the specific case I encountered:</p>
<blockquote>
<p>we just discard any narrowing constraint that is present on only one path.</p>
</blockquote>
<p>It's not just when the narrowing constraint is present on only one path, but also when it is present on all paths (but there is more than one boolean expression, e.g. with <code>elif</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-12-22 16:43</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:53:03 UTC
    </footer>
</body>
</html>
