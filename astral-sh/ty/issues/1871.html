<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix iteration over intersection types - astral-sh/ty #1871</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix iteration over intersection types</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1871">#1871</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-12-12 23:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><p>Something is wrong with our handling of iteration for intersection types:</p>
<pre><code class="language-py">from typing import Sequence

def _(x: Sequence[int], y: object):
    reveal_type(x)  # `Sequence[int]`
    for item in x:
        reveal_type(item)  # we reveal `int`, which is correct

    if isinstance(y, list):
        reveal_type(y)  # `Top[list[Unknown]]`
        for item in y:
            reveal_type(item)  # we reveal `object`, which is correct

    if isinstance(x, list):
        reveal_type(x)  # `Sequence[int] &amp; Top[list[Unknown]]`
        for item in x:
            reveal_type(item)  # should be `int &amp; object`, which is `int` -- but we say `Never`?
</code></pre>
<p>https://play.ty.dev/53155022-21ea-4a14-bcb3-df544c07e541</p>
<p>I haven't explored the exact root cause here, but I suspect the proper fix should be simple. We should map over intersections at the top level of iteration handling, so we separately iterate each component type, and intersect the results. That should make the above bug impossible, because it should reduce to doing the first two cases (which we already do correctly) and then intersecting them to get <code>int &amp; object</code> -&gt; <code>int</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Stable" by @carljm on 2025-12-12 23:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @carljm on 2025-12-12 23:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">set-theoretic types</span> added by @carljm on 2025-12-12 23:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @carljm on 2025-12-12 23:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2025-12-13 17:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mattgiles">@mattgiles</a> on 2025-12-13 18:33</div>
            <div class="timeline-body"><p>I sometimes see not-iterable complaints like:</p>
<pre><code>Object of type `list[Thing | ~str | Unknown]` is not iterable (not-iterable)
</code></pre>
<p>As in this <a href="https://play.ty.dev/f8cf1369-0e71-4034-bfde-8c718941d6eb">example</a>.</p>
<p>Is my issue related to this issue? If not I'll open a new one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @charliermarsh by @charliermarsh on 2025-12-13 19:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2025-12-13 19:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-13 21:31</div>
            <div class="timeline-body"><p>@mattgiles that looks like a separate issue from this one -- but definitely looks like a bug</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2026-01-08 18:57</div>
            <div class="timeline-body"><p>This is fixed!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2026-01-08 18:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:21:17 UTC
    </footer>
</body>
</html>
