<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>False positive with closures where variable is not reassigned (or del'd) - astral-sh/ty #559</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>False positive with closures where variable is not reassigned (or del'd)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/559">#559</a>
        opened by <a href="https://github.com/hauntsaninja">@hauntsaninja</a>
        on 2025-06-01 02:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/hauntsaninja">@hauntsaninja</a></div>
            <div class="timeline-body"><pre><code>def foo(x: str | None):
    if x is None:
        x = &quot;asdf&quot;

    def inner():
        return x + &quot;foo&quot;
</code></pre>
<p>pyright looks for reassignments following the closure definition in the flow graph. mypy does something similar (but its implementation is a little sketchier). This heuristic seems to work fairly well in practice. Was a very common cause of user confusion and duplicate reports before mypy added support for this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/hauntsaninja">@hauntsaninja</a> on 2025-06-01 02:27</div>
            <div class="timeline-body"><p>Hmm actually the unresolved reference one repros even when it's a parameter, so maybe this is a separate bug:</p>
<pre><code>def foo(n_activations=0):
    def inner():
        nonlocal n_activations
        n_activations += 1
    inner()
    print(n_activations)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-01 14:25</div>
            <div class="timeline-body"><p>Thanks! I think this may be a duplicate of (or at least overlap with) https://github.com/astral-sh/ty/issues/210?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">control flow</span> added by @AlexWaygood on 2025-06-01 15:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-06-02 15:52</div>
            <div class="timeline-body"><p>The second example is https://github.com/astral-sh/ty/issues/220</p>
<p>I think we should keep this open for the first example, though. It's related to #210 but I think the first version of #210 probably won't address this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "GA" by @carljm on 2025-07-23 23:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-07-23 23:09</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/19321 improves this for some cases, but still not for the case in the OP here, because it doesn't use a flow-sensitive approach related to where in the outer scope the nested scope is defined (cc @mtshiba)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-09-08 21:08</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:20:03 UTC
    </footer>
</body>
</html>
