<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>understand implicit generic context of a `Callable` annotation - astral-sh/ty #1136</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>understand implicit generic context of a <code>Callable</code> annotation</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1136">#1136</a>
        opened by <a href="https://github.com/RubenVanEldik">@RubenVanEldik</a>
        on 2025-09-05 17:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/RubenVanEldik">@RubenVanEldik</a> on 2025-09-05 17:18</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I am not completely sure if this is an issue with ty or Streamlit, but <a href="https://github.com/streamlit/streamlit/issues/12442">the maintainers of Streamlit think</a> that this might be an issue with ty.</p>
<p>ty raises an error for <code>st.stop()</code> as it does not understand that <code>st.stop()</code> will never return. Even though <code>st.stop()</code> has <code>NoReturn</code> as return type.</p>
<p>As far as I understand the issue, this is not related to https://github.com/astral-sh/ty/issues/180.</p>
<pre><code class="language-py">import typing

import streamlit as st

def my_func() -&gt; typing.NoReturn:
    st.write(&quot;Hello world&quot;)
    st.stop()

my_func()
</code></pre>
<pre><code>error[invalid-return-type]: Function always implicitly returns `None`, which is not assignable to return type `Never`
 --&gt; main.py:5:18
  |
3 | import streamlit as st
4 |
5 | def my_func() -&gt; typing.NoReturn:
  |                  ^^^^^^^^^^^^^^^
6 |     st.write(&quot;Hello world&quot;)
7 |     st.stop()
  |
info: Consider changing the return annotation to `-&gt; None` or adding a `return` statement
info: rule `invalid-return-type` is enabled by default

Found 1 diagnostic
</code></pre>
<p>I used <code>ty 0.0.1-alpha.20</code> here</p>
<h3>Version</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "ty does not understand `NoReturn` in Streamlit correctly" to "ty does not understand `gather_metrics` decorator in Streamlit correctly" by @carljm on 2025-09-05 17:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">generics</span> added by @carljm on 2025-09-05 17:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "ty does not understand `gather_metrics` decorator in Streamlit correctly" to "understand implicit generic context of a `Callable` annotation" by @carljm on 2025-09-05 17:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-09-05 17:39</div>
            <div class="timeline-body"><p>Thanks for the report! This is a bug/limitation in ty, but not with our <code>NoReturn</code> support; we are considering the type of <code>st.stop</code> (and <code>st.write</code>) to be <code>Unknown</code>. The reason is <a href="https://github.com/streamlit/streamlit/blob/develop/lib/streamlit/runtime/metrics_util.py#L359">streamlit's <code>gather_metrics</code> decorator</a>, which <a href="https://github.com/streamlit/streamlit/blob/develop/lib/streamlit/commands/execution_control.py#L34">is applied to its <code>stop</code> function</a>.</p>
<p>The <a href="https://github.com/streamlit/streamlit/blob/develop/lib/streamlit/runtime/metrics_util.py#L352-L356">relevant overload of <code>gather_metrics</code></a> returns the type <code>Callable[[F], F]</code>. We currently interpret this <code>F</code> typevar as being in the context of the <code>gather_metrics</code> function itself, and since it doesn't appear in the arguments of <code>gather_metrics</code>, we are unable to solve it, and thus solve it to <code>Unknown</code>.</p>
<p>But there is an implicit (I think unwritten?) rule in the Python type system that if a legacy typevar appears in a <code>Callable</code> type, but not elsewhere in the surrounding function context, it should be scoped to that <code>Callable</code> type, making it a generic callable. We don't yet implement this rule.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "GA" by @carljm on 2025-09-05 17:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/RubenVanEldik">@RubenVanEldik</a> on 2025-09-05 17:45</div>
            <div class="timeline-body"><p>That's an interesting limitation!</p>
<p>I have no experience with type systems on this level. Is this complicated to solve? Is this something that's on ty's roadmap?</p>
<p>We use Streamlit extensively, and this limitation is holding us back from migrating from mypy to ty for the moment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-09-05 17:49</div>
            <div class="timeline-body"><p>I don't think it's super hard. Definitely on the roadmap, I just can't commit to exactly when we'll get to it -- lots of high priority things on our roadmap!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/RubenVanEldik">@RubenVanEldik</a> on 2025-09-05 18:11</div>
            <div class="timeline-body"><p>Makes sense! I’ll keep an eye out on future releases!</p>
<p>I’m not sure if you could comment on this, but do you expect this to be a part of Ty before the general availability release?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-09-05 18:52</div>
            <div class="timeline-body"><p>Yes, definitely should happen before GA.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lukasmasuch">@lukasmasuch</a> on 2025-09-06 00:47</div>
            <div class="timeline-body"><p>@carljm Thanks for looking into this. Would you recommend that we (Streamlit) migrate away from the legacy typevar pattern used for the decorator? I haven't looked into this more, but I guess something with <code>ParamSpec</code> would be an alternative way to solve this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-09-06 01:07</div>
            <div class="timeline-body"><p>@lukasmasuch In principle, a generic PEP 695 type alias can do the same thing with more explicit scoping of the typevar. Something like</p>
<pre><code class="language-py">type IdentityCallable[T] = Callable[[T], T]
</code></pre>
<p>And then using <code>IdentityCallable</code> in place of the current <code>Callable[[F], F]</code> as the return value from the <code>gather_metrics</code> overload.</p>
<p>But this is Python 3.12+ only syntax, so I suspect you can't migrate to it yet.</p>
<p>The existing annotation you have is fine. We should handle it, and we will.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-18 15:44</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ty/issues/1971#issuecomment-3667906736 raises a case demonstrating that this rule needs to apply even with PEP 695 typevars, which is unfortunate, because it contradicts the nice explicit scoping of the PEP 695 typevars:</p>
<pre><code class="language-py">from collections.abc import Callable

def deco_factory[**P, R]() -&gt; Callable[[Callable[P, R]], Callable[P, R]]:
    def deco(func: Callable[P, R]) -&gt; Callable[P, R]:
        return func
    return inner

reveal_type(deco_factory())
</code></pre>
<p>The plain meaning of this code is that <code>P</code> and <code>R</code> are scoped to <code>deco_factory</code>, and should be solved (or, in this case, given the lack of arguments typed as <code>P</code> or <code>R</code>, fail to be solved) in the call to <code>deco_factory()</code>, making the return type of <code>deco_factory()</code> the callable type <code>(...) -&gt; Unknown</code>. But this is not how type checkers treat it; they apply the rule described in this issue, and consider the return type of <code>deco_factory()</code> to be a generic callable with signature <code>(P) -&gt; R</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-18 15:45</div>
            <div class="timeline-body"><blockquote>
<p>In principle, a generic PEP 695 type alias can do the same thing with more explicit scoping of the typevar.</p>
</blockquote>
<p>I was wrong here; using an <code>IdentityCallable</code> type alias like I described doesn't help work around this -- the type variable <code>T</code> is still wrongly scoped to the type alias instead of the callable type. Really the only workaround here is a full callable protocol.</p>
<p>We really need to get this in.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-18 15:56</div>
            <div class="timeline-body"><p>@AlexWaygood provided a full example of the callable protocol version, which works in ty today, without the special heuristics for Callable annotations:</p>
<pre><code class="language-py">from typing import Callable, Protocol

class Identity(Protocol):
    def __call__[**P, R](self, fn: Callable[P, R], /) -&gt; Callable[P, R]: ...

def deco_factory() -&gt; Identity:
    def deco[**P, R](func: Callable[P, R]) -&gt; Callable[P, R]:
        return func
    return deco

reveal_type(deco_factory())
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Stable" by @carljm on 2025-12-30 01:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Pre-stable 1" by @carljm on 2025-12-30 01:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sunny-zuo">@sunny-zuo</a> on 2026-01-02 19:47</div>
            <div class="timeline-body"><p>I believe this issue is also impacting some SQLAlchemy Query typing, since <a href="https://github.com/sqlalchemy/sqlalchemy/blob/2c0d3ace97c8ee1c12321329284000ff9e40e000/lib/sqlalchemy/orm/query.py#L1896-L1897">several functions for query</a> are decorated with the decorator factory <code>_assertions</code>.</p>
<p>Perhaps something like this could be a worthwhile addition to the <a href="https://github.com/astral-sh/ruff/blob/main/crates/ty_python_semantic/resources/mdtest/external/sqlalchemy.md">SQLAlchemy markdown test</a>:</p>
<pre><code class="language-py">query = session.query(User).filter(User.id == 1)  # revealed: Unknown, expected: Query[User]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-03 17:45</div>
            <div class="timeline-body"><p>@sunny-zuo there are existing <a href="https://github.com/astral-sh/ruff/blob/main/crates/ty_python_semantic/resources/mdtest/external/sqlalchemy.md#basic-query-example">mdtests</a> for sqlalchemy. It's hard to tell from your very minimal code snippet why ty would infer <code>Unknown</code>. I suggest taking a look at the tests and/or opening a new issue</p>
<p>Edit: @AlexWaygood told me that you commented on the right issue :) I'm a complete SQLAlchemy noob but we have tests demonstrating that <code>where</code> works and <code>filter</code> seems to be an alias for <code>where</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dcreager by @dcreager on 2026-01-09 13:43</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:40:31 UTC
    </footer>
</body>
</html>
