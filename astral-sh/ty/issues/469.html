<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server panic: &quot;ref count should be 1 because `zalsa_mut` drops all other DB references&quot; - astral-sh/ty #469</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Server panic: &quot;ref count should be 1 because <code>zalsa_mut</code> drops all other DB references&quot;</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/469">#469</a>
        opened by <a href="https://github.com/nistath">@nistath</a>
        on 2025-05-21 04:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/nistath">@nistath</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Using ty-vscode 2025.11.11402026.</p>
<p><code>ty check</code> manages to index the files. However, the server panics.</p>
<pre><code> 8.126400250s  WARN     ty:main ty_server::server::api: Received notification $/cancelRequest which does not have a handler.
  25.024617416s  INFO ty:worker:0 check_file{file=file(Id(1000))}:Project::index_files{project=openai}: ty_project: Indexed 100961 file(s)
  25.170448708s ERROR     ty:main ty_server::server: panicked at crates/ty_project/src/db.rs:100:14:
ref count should be 1 because `zalsa_mut` drops all other DB references.
   0: __mh_execute_header
   1: __mh_execute_header
   2: __mh_execute_header
   3: __mh_execute_header
   4: __mh_execute_header
   5: __mh_execute_header
   6: __mh_execute_header
   7: __mh_execute_header
   8: __mh_execute_header
   9: __mh_execute_header
  10: __mh_execute_header
  11: __mh_execute_header
  12: __mh_execute_header
  13: __mh_execute_header
  14: __mh_execute_header
  15: __pthread_cond_wait

panicked at crates/ty_project/src/db.rs:100:14:
ref count should be 1 because `zalsa_mut` drops all other DB references.
   0: __mh_execute_header
   1: __mh_execute_header
   2: __mh_execute_header
   3: __mh_execute_header
   4: __mh_execute_header
   5: __mh_execute_header
   6: __mh_execute_header
   7: __mh_execute_header
   8: __mh_execute_header
   9: __mh_execute_header
  10: __mh_execute_header
  11: __mh_execute_header
  12: __mh_execute_header
  13: __mh_execute_header
  14: __mh_execute_header
  15: __pthread_cond_wait

  25.212083333s ERROR        main ty_server::server: panicked at /Users/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/jod-thread-1.0.0/src/lib.rs:33:22:
called `Result::unwrap()` on an `Err` value: Any { .. }
   0: __mh_execute_header
   1: __mh_execute_header
   2: __mh_execute_header
   3: __mh_execute_header
   4: __mh_execute_header
   5: __mh_execute_header
   6: __mh_execute_header
   7: __mh_execute_header
   8: __mh_execute_header
   9: __mh_execute_header
  10: __mh_execute_header
  11: __mh_execute_header
  12: __mh_execute_header
  13: __mh_execute_header
  14: __mh_execute_header
  15: __mh_execute_header
  16: __mh_execute_header

panicked at /Users/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/jod-thread-1.0.0/src/lib.rs:33:22:
called `Result::unwrap()` on an `Err` value: Any { .. }
   0: __mh_execute_header
   1: __mh_execute_header
   2: __mh_execute_header
   3: __mh_execute_header
   4: __mh_execute_header
   5: __mh_execute_header
   6: __mh_execute_header
   7: __mh_execute_header
   8: __mh_execute_header
   9: __mh_execute_header
  10: __mh_execute_header
  11: __mh_execute_header
  12: __mh_execute_header
  13: __mh_execute_header
  14: __mh_execute_header
  15: __mh_execute_header
  16: __mh_execute_header
</code></pre>
<h3>Version</h3>
<p>ty 0.0.1-alpha.6 (f11c6012d 2025-05-20)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2025-05-21 06:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2025-05-21 06:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-21 06:06</div>
            <div class="timeline-body"><p>Thanks. I've seen this too this week and plan to have a closer look (if it isn't already fixed by some recent changes that I made)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fatal</span> added by @AlexWaygood on 2025-05-21 11:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "ty_server panics" to "Server panic: "ref count should be 1 because `zalsa_mut` drops all other DB references"" by @dhruvmanila on 2025-05-21 15:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-05-22 14:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:19:57 UTC
    </footer>
</body>
</html>
