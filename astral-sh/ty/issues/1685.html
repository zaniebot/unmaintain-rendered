<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investigate `invalid-type-arguments` diagnostics on scipy-stubs - astral-sh/ty #1685</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Investigate `invalid-type-arguments` diagnostics on scipy-stubs</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1685">#1685</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-11-29 22:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-29 22:25</div>
            <div class="timeline-body"><blockquote>
<p>Currently, if I run <code>uvx ty check scipy-stubs</code> in the root of <a href="https://github.com/scipy/scipy-stubs/">scipy-stubs</a> (just the current master branch), there are 674 diagnostics. At first glance, most of them appear to be false positives related to generic type aliases and type parameter bounds (<code>invalid-type-arguments</code>).</p>
</blockquote>
<p><em>Originally posted by @jorenham in <a href="https://github.com/astral-sh/ty/issues/394#issuecomment-3591963961">#394</a></em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/aidandj">@aidandj</a> on 2025-11-30 05:00</div>
            <div class="timeline-body"><p><em>unrelated</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-12-01 08:15</div>
            <div class="timeline-body"><p>I looked at one example and I believe the reason is that the <code>type[T]</code> specialization doesn't account for this tuple hack that exists for class specialization:</p>
<p>https://github.com/astral-sh/ruff/blob/a6cbc138d273b86a70ed36e13623d079bd368236/crates/ty_python_semantic/src/types/infer/builder.rs#L10930-L10943</p>
<p>This means that <code>tuple[int, ...]</code> works but <code>type[tuple[int, ...]]</code> doesn't (https://play.ty.dev/5c58d89d-2254-4465-8a5e-76382c19583b):</p>
<pre><code class="language-py"># No diagnostics here
x: tuple[int, ...]

# Too many type arguments to class `tuple`: expected 1, got 2 (invalid-type-arguments)
y: type[tuple[int, ...]]
</code></pre>
<p>cc @ibraheemdev</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-01 08:19</div>
            <div class="timeline-body"><blockquote>
<p>I looked at one example and I believe the reason is that the <code>type[T]</code> specialization doesn't account for this tuple hack that exists for class specialization:</p>
</blockquote>
<p>These might be fixed by https://github.com/astral-sh/ruff/pull/21652?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-12-01 09:52</div>
            <div class="timeline-body"><p>I think https://github.com/astral-sh/ruff/pull/21652 fixes exactly one diagnostic on scipy-stubs. That made me think: why didn't we see these new diagnostics somewhere, given that scipy-stubs is part of mypy_primer? Turns out we missed this in <code>good.txt</code> for some reason. I'll open a PR to fix this =&gt; https://github.com/astral-sh/ruff/pull/21721</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-12-01 10:36</div>
            <div class="timeline-body"><p>Thank you for reporting this! I missed this regression in https://github.com/astral-sh/ruff/pull/21553 because we weren't running our ecosystem checks across <code>scipy-stubs</code>, which was just an oversight.</p>
<p>One of the problems that I identified here is summarized by this snippet. Pretend <code>unknown_module</code> is something that we didn't install as a dependency:</p>
<pre><code class="language-py">from typing import TypeVar, TypeAlias

from unknown_module import UnknownClass  # type: ignore

T = TypeVar(&quot;T&quot;)

MyAlias: TypeAlias = UnknownClass[T] | None

a: MyAlias[int]
</code></pre>
<p>(https://play.ty.dev/b13da612-3348-4fba-9bc4-fc4d7bfe3cfc)</p>
<p>Since we don't know what <code>UnknownClass</code> is, we don't know that it's a generic class. We infer <code>UnknownClass</code> as <code>Unknown</code>, and then we currently fail to find the legacy typevar <code>T</code> in <code>MyAlias</code>, thinking it would be a non-generic alias.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @sharkdp on 2025-12-01 10:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">generics</span> added by @sharkdp on 2025-12-01 10:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @sharkdp by @sharkdp on 2025-12-01 10:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/patrick91">@patrick91</a> on 2025-12-01 10:46</div>
            <div class="timeline-body"><p>I was trying to migrate our codebase to ty and I think I got a similar issue, repro:</p>
<pre><code class="language-python">from typing import Literal
from collections.abc import AsyncGenerator, Callable


def decorator[Item](
    message: Item,
) -&gt; Callable[[Callable[[], AsyncGenerator[Item]]], Callable[[], AsyncGenerator[Item]]]:
    def inner(fn: Callable[[], AsyncGenerator[Item]]) -&gt; Callable[[], AsyncGenerator[Item]]:
        return fn
    return inner


@decorator(message=&quot;hello&quot;)
async def my_generator() -&gt; AsyncGenerator[Literal[&quot;hello&quot;]]:
    yield &quot;hello&quot;

# this one fails with:
# Argument is incorrect: Expected `() -&gt; AsyncGenerator[Literal[&quot;hello&quot;], None]`, found `def my_generator2() -&gt; AsyncGenerator[str, None]` (invalid-argument-type) [Ln 18, Col 1]
@decorator(message=&quot;hello&quot;)
async def my_generator2() -&gt; AsyncGenerator[str]:
    yield &quot;world&quot;
</code></pre>
<p>https://play.ty.dev/67bbea2d-a7d1-40a9-bce6-fa6787129244</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-12-01 10:47</div>
            <div class="timeline-body"><p>@patrick91 I don't think this is related. Can you please report this as a new issue?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-01 12:36</div>
            <div class="timeline-body"><p>One issue here is that scipy-stubs seems to have several type variables that use generic type aliases as their upper bounds. This is pretty questionable, because you're not allowed to use a generic type as the upper bound of a type variable: it must be specialized. For example, mypy/pyright/pyrefly all complain about this:</p>
<pre><code class="language-py">from typing import TypeVar

T = TypeVar(&quot;T&quot;)
U = TypeVar(&quot;U&quot;, bound=list[T])
</code></pre>
<p>but it seems like none of them complain about this -- I think they view the generic type alias as having been implicitly default-specialized when it's used as the upper bound of a type variable:</p>
<pre><code class="language-py">from typing import TypeVar, TypeAlias

_NT = TypeVar(&quot;_NT&quot;)
_ND: TypeAlias = tuple[_NT, ...]
_ShapeT = TypeVar(&quot;_ShapeT&quot;, bound=_ND)
</code></pre>
<p>And I guess that's fair enough, because it seems correct to view <code>bound=list</code> as implicitly signifying <code>bound=list[Any]</code>, etc. -- viewing the type alias as having been implicitly default-specialized in the <code>TypeVar</code> bound is consistent with that principle. We should probably do similarly, if we don't already. If I make this change to my local clone of <code>scipy-stubs</code> (substituting generic type aliases in typevar upper bounds with the default-specialized versions of those type aliases), then the number of diagnostics we emit on scipy-stubs drops to 535:</p>
<pre><code class="language-diff">diff --git a/scipy-stubs/stats/_distribution_infrastructure.pyi b/scipy-stubs/stats/_distribution_infrastructure.pyi
index 0339d96..bead332 100644
--- a/scipy-stubs/stats/_distribution_infrastructure.pyi
+++ b/scipy-stubs/stats/_distribution_infrastructure.pyi
@@ -41,9 +41,9 @@ _IntT_co = TypeVar(&quot;_IntT_co&quot;, bound=_Int, default=_Int, covariant=True)
 _RealT = TypeVar(&quot;_RealT&quot;, bound=_Float | _Int, default=_Float | _Int)
 _RealT_co = TypeVar(&quot;_RealT_co&quot;, bound=_Float | _Int, default=_Float | _Int, covariant=True)
 
-_ShapeT = TypeVar(&quot;_ShapeT&quot;, bound=_ND, default=_ND)
+_ShapeT = TypeVar(&quot;_ShapeT&quot;, bound=tuple[Any, ...], default=_ND)
 _ShapeT1 = TypeVar(&quot;_ShapeT1&quot;, bound=onp.AtLeast1D, default=onp.AtLeast0D[Any])
-_ShapeT_co = TypeVar(&quot;_ShapeT_co&quot;, bound=_ND, default=_ND, covariant=True)
+_ShapeT_co = TypeVar(&quot;_ShapeT_co&quot;, bound=tuple[Any, ...], default=_ND, covariant=True)
 
 _DistT0 = TypeVar(&quot;_DistT0&quot;, bound=_Dist[_0D])
 _DistT1 = TypeVar(&quot;_DistT1&quot;, bound=_Dist[_1D])
@@ -52,8 +52,8 @@ _DistT2 = TypeVar(&quot;_DistT2&quot;, bound=_Dist[_2D])
 _DistT_2 = TypeVar(&quot;_DistT_2&quot;, bound=_Dist[onp.AtMost2D])
 _DistT3 = TypeVar(&quot;_DistT3&quot;, bound=_Dist[_3D])
 _DistT_3 = TypeVar(&quot;_DistT_3&quot;, bound=_Dist[onp.AtMost3D])
-_DistT = TypeVar(&quot;_DistT&quot;, bound=_Dist)
-_DistT_co = TypeVar(&quot;_DistT_co&quot;, bound=_Dist, default=UnivariateDistribution, covariant=True)
+_DistT = TypeVar(&quot;_DistT&quot;, bound=_Dist[Any])
+_DistT_co = TypeVar(&quot;_DistT_co&quot;, bound=_Dist[Any], default=UnivariateDistribution, covariant=True)
 
 _AxesT = TypeVar(&quot;_AxesT&quot;, bound=_Axes, default=Any)
 
@@ -273,7 +273,7 @@ _Tuple2: TypeAlias = tuple[_T, _T]
 
 _XT = TypeVar(&quot;_XT&quot;, bound=npc.number, default=npc.number)
 _XT_co = TypeVar(&quot;_XT_co&quot;, bound=npc.number, default=np.float64, covariant=True)
-_ShapeT0_co = TypeVar(&quot;_ShapeT0_co&quot;, bound=_ND, default=_ND, covariant=True)
+_ShapeT0_co = TypeVar(&quot;_ShapeT0_co&quot;, bound=tuple[Any, ...], default=_ND, covariant=True)
 
 _BaseDist0: TypeAlias = _BaseDistribution[_XT, tuple[()]]
 _BaseDist1: TypeAlias = _BaseDistribution[_XT, tuple[int]]
diff --git a/scipy-stubs/stats/_new_distributions.pyi b/scipy-stubs/stats/_new_distributions.pyi
index c985ef3..79eeb3f 100644
--- a/scipy-stubs/stats/_new_distributions.pyi
+++ b/scipy-stubs/stats/_new_distributions.pyi
@@ -40,8 +40,8 @@ _FloatT_co = TypeVar(&quot;_FloatT_co&quot;, bound=_Float, default=_Float, covariant=True)
 _IntT = TypeVar(&quot;_IntT&quot;, bound=_Int, default=_Int)
 _IntT_co = TypeVar(&quot;_IntT_co&quot;, bound=_Int, default=_Int, covariant=True)
 
-_ShapeT = TypeVar(&quot;_ShapeT&quot;, bound=_ND, default=_ND)
-_ShapeT_co = TypeVar(&quot;_ShapeT_co&quot;, bound=_ND, default=_ND, covariant=True)
+_ShapeT = TypeVar(&quot;_ShapeT&quot;, bound=tuple[Any, ...], default=_ND)
+_ShapeT_co = TypeVar(&quot;_ShapeT_co&quot;, bound=tuple[Any, ...], default=_ND, covariant=True)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jorenham">@jorenham</a> on 2025-12-01 13:28</div>
            <div class="timeline-body"><p>The type parameter of the generic <code>_ND</code> type has a default (<code>int</code> in both cases), so that's why I thought it was ok to use it as upper bound:</p>
<p>https://github.com/scipy/scipy-stubs/blob/27ae8dccd60b0387477a9c1ba763fc79a532f9d1/scipy-stubs/stats/_distribution_infrastructure.pyi#L100-L105
https://github.com/scipy/scipy-stubs/blob/27ae8dccd60b0387477a9c1ba763fc79a532f9d1/scipy-stubs/stats/_new_distributions.pyi#L24-L29</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-01 13:33</div>
            <div class="timeline-body"><p>yes, to be clear, I do think there's a ty bug here :-)</p>
<p>We should be default-specializing <code>_ND</code> (turning it from <code>tuple[_NT, ...]</code> to <code>tuple[int, ...]</code>) when we see it appearing as the upper bound of a type variable, the same as mypy/pyright do.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jorenham">@jorenham</a> on 2025-12-01 13:37</div>
            <div class="timeline-body"><p>I think I'll just change it either way and apply your patch, since it's somewhat sketchy (typing-spec-wise) and could be misinterpreted because of that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Beta" by @carljm on 2025-12-01 21:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-12-03 09:11</div>
            <div class="timeline-body"><p>Since this ticket was opened, we have merged:</p>
<ul>
<li><a href="https://github.com/astral-sh/ruff/pull/21652">#21652</a>, which fixed 1 <code>invalid-type-arguments</code> diagnostic in <code>scipy-stubs</code> (see <a href="https://cjm-typetuple.ecosystem-663.pages.dev/diff">here</a>)</li>
<li><a href="https://github.com/astral-sh/ruff/pull/21730">#21730</a>, which fixed 235 <code>invalid-type-arguments</code> diagnostics in <code>scipy-stubs</code> (see <a href="https://david-fix-specialized-unknow.ecosystem-663.pages.dev/diff">here</a>)</li>
<li><a href="https://github.com/astral-sh/ruff/pull/21765">#21765</a>, which fixed 232 other type-alias related diagnostics in <code>scipy-stubs</code> (see <a href="https://david-default-specialize-1.ecosystem-663.pages.dev/diff">here</a>)</li>
</ul>
<p>There are certainly still problems remaining (e.g. due to missing <code>TypeVarTuple</code> support, <code>ParamSpec</code> support, <code>Concatenate</code> support), but I think it would be best if we addressed those in dedicated tickets. I'm closing this for now, but feel free to open new issues or comment here if someone thinks this should be reopened.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-12-03 09:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jorenham">@jorenham</a> on 2025-12-03 09:13</div>
            <div class="timeline-body"><p>That's so awesome; thanks a lot all!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jorenham">@jorenham</a> on 2025-12-03 16:35</div>
            <div class="timeline-body"><p>It's 0 errors now ðŸ˜„:
https://github.com/scipy/scipy-stubs/pull/1020</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 02:11:46 UTC
    </footer>
</body>
</html>
