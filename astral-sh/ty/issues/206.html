<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic for conflicting declared attribute types - astral-sh/ty #206</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Diagnostic for conflicting declared attribute types</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/206">#206</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-02-05 11:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body"><p>We should emit a diagnostic when we see conflicting declared types of attributes, either between the declaration in the class body and declarations in a method, or between annotated assignments in different methods. We have existing tests for this scenario (see <code>TODO</code> comments):</p>
<p>https://github.com/astral-sh/ruff/blob/eb08345fd5434ed3db243233df6dd91757a6af3b/crates/red_knot_python_semantic/resources/mdtest/attributes.md?plain=1#L212-L226</p>
<p>part of: https://github.com/astral-sh/ruff/issues/14164</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Emit a diagnostic when we see conflicting declared types between class body and `__init__` (see TODO in `own_instance_member`)" to "[red-knot] Diagnostic for conflicting declared attribute types" by @sharkdp on 2025-02-05 12:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @sharkdp on 2025-02-05 12:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/smokyabdulrahman">@smokyabdulrahman</a> on 2025-02-10 17:52</div>
            <div class="timeline-body"><p>I am not sure if this is helpful, but here is what <code>pyright</code> reports for the mentioned test case:</p>
<pre><code class="language-python">class C:
    &quot;&quot;&quot;
    Diagnostics:
    Declaration &quot;z&quot; is obscured by a declaration of the same name [reportRedeclaration]
    &quot;&quot;&quot;

    z: int

    def __init__(self) -&gt; None:
        self.x = get_int()
        &quot;&quot;&quot;
        Diagnostics:
        Declaration &quot;y&quot; is obscured by a declaration of the same name [reportRedeclaration]
        &quot;&quot;&quot;
        self.y: int = 1

    def other_method(self):
        self.x = get_str()

        self.y: str = &quot;a&quot;

        self.z: str = &quot;a&quot;
</code></pre>
<p>I am trying to learn/understand the technical stuff behind parsers by reading (books, blogs) and contributing to tools I love that has things to do with parsers (ruff ❤).</p>
<p>is this issue about adding a new rule? or just fixing/refactoring <code>red-knot</code> tests mentioned (modify the markdown file and mention the correct error/reveal messages)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-02-10 20:37</div>
            <div class="timeline-body"><blockquote>
<p>is this issue about adding a new rule?</p>
</blockquote>
<p>Yes, this is about emitting a new diagnostic (we can probably reuse <a href="https://github.com/astral-sh/ruff/blob/f30fac632685c1edd200005d110cf407992bd69a/crates/red_knot_python_semantic/src/types/diagnostic.rs#L103-L109">conflicting-declarations</a>) when we see something like this.</p>
<p>We do want to report them in the same places where pyright reports <em>&quot;declaration … is obscured by …&quot;</em>, but I think we want to use a slightly different wording, as we generally allow re-declarations of symbols:</p>
<pre><code class="language-py">x: int = 1
x: str = &quot;foo&quot;
</code></pre>
<p>What's not allowed though, is to have multiple visible conflicting declarations:</p>
<pre><code class="language-py">def _(flag: bool):
    if flag:
        x: str
    else:
        x: int

    x = 1  # error: [conflicting-declarations]
</code></pre>
<p>For the case mentioned in this issue, we want something similar, but for declarations of <em>attributes</em>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-02-10 21:16</div>
            <div class="timeline-body"><p>(To be clear, though, this issue is <em>not</em> about adding a new <em>ruff</em> rule, it's about a new red-knot diagnostic. Although they are in the same codebase, red-knot is separate from ruff and shares only the parser/AST with it.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/smokyabdulrahman">@smokyabdulrahman</a> on 2025-02-11 17:30</div>
            <div class="timeline-body"><p>Thank you all for the information. All clear.</p>
<p>I will give this issue a shot.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/smokyabdulrahman">@smokyabdulrahman</a> on 2025-02-13 21:39</div>
            <div class="timeline-body"><p>While trying to dive deep into the code, I've found the following comments where I think the <code>report_lint</code> should happen.</p>
<p>https://github.com/astral-sh/ruff/blob/cb8b23d60915206d9ad74fd351a36dd0d4ed1231/crates/red_knot_python_semantic/src/types.rs#L4323-L4329</p>
<p>Also, I've found this TODO:
https://github.com/astral-sh/ruff/blob/cb8b23d60915206d9ad74fd351a36dd0d4ed1231/crates/red_knot_python_semantic/src/types.rs#L4224-L4237</p>
<p>However, I believe that <code>type.rs</code> doesn't have the context to report the diagnostic for a reason.</p>
<p>Could you please point me to a similar example where a similar rule had been tackled?</p>
<p>My thought process is to implement some logic in:
https://github.com/astral-sh/ruff/blob/cb8b23d60915206d9ad74fd351a36dd0d4ed1231/crates/red_knot_python_semantic/src/types/infer.rs#L899-L904</p>
<p>and:
https://github.com/astral-sh/ruff/blob/cb8b23d60915206d9ad74fd351a36dd0d4ed1231/crates/red_knot_python_semantic/src/types/infer.rs#L929-L934</p>
<p>or to check here if the target is an instance member of class, and check all the symbol declarations in the scope of the class body, by calling <code>symbol_from_declarations</code> and report the conflicting declarations if any.
https://github.com/astral-sh/ruff/blob/cb8b23d60915206d9ad74fd351a36dd0d4ed1231/crates/red_knot_python_semantic/src/types/infer.rs#L2121-L2125</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-02-14 15:23</div>
            <div class="timeline-body"><blockquote>
<p>While trying to dive deep into the code, I've found the following comments where I think the <code>report_lint</code> should happen.</p>
</blockquote>
<p>This is the place where we would end up if there would be conflicting declarations <em>in the class body</em>. This is just one possible source for declarations of an attribute.</p>
<blockquote>
<p>Also, I've found this TODO:</p>
</blockquote>
<p>This is the other place, correct. Here, we loop over declarations of attributes in methods. We currently return early, but we probably need to change the loop logic to collect all declared types, and then emit a diagnostic in case there are more than one.</p>
<p>Finally, we also need to consider the option that there is a declaration on the class body, and a conflicting declaration in a method.</p>
<p>--</p>
<blockquote>
<p>However, I believe that <code>type.rs</code> doesn't have the context to report the diagnostic for a reason.</p>
</blockquote>
<p>We are currently in the process of changing some infrastructure to make this easier. Maybe it would be good to  split this task into two parts: (1) <em>collect</em> all conflicting declared types so we would in principle be able to emit a diagnostic — assuming we could do it from anywhere, and (2) actually create a new diagnostic and make the required changes to be able to emit it.</p>
<p>I think you could already start with part 1, and for part 2, it might make sense to wait for those changes to the diagnostics infrastructure.</p>
<p>Let me know if I failed to answer any of the questions that would be required for part 1.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/smokyabdulrahman">@smokyabdulrahman</a> on 2025-02-15 22:21</div>
            <div class="timeline-body"><p>Thank you so much, this made it clearer.
I will try and approach part 1.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @MichaReiser on 2025-05-07 15:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Diagnostic for conflicting declared attribute types" to "Diagnostic for conflicting declared attribute types" by @MichaReiser on 2025-05-07 15:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">typing semantics</span> added by @AlexWaygood on 2025-05-11 07:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">attribute access</span> added by @AlexWaygood on 2025-05-11 08:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lipefree">@lipefree</a> on 2025-06-04 16:05</div>
            <div class="timeline-body"><p>I can try to do this one since the last PR was closed. I guess there is enough information in this issue and the closed PR for me to start investigating !</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:19:42 UTC
    </footer>
</body>
</html>
