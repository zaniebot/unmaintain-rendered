<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>make it easier to avoid accidental cross-module direct AST usage - astral-sh/ty #208</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>make it easier to avoid accidental cross-module direct AST usage</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/208">#208</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-02-04 20:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/carljm">@carljm</a> on 2025-02-04 20:55</div>
            <div class="timeline-body"><h3>Description</h3>
<p>As a general principle, we should never have type inference in one module depend directly on the AST of another module, without going through a cached Salsa query that abstracts the contents of the other module to the <code>Type</code> level. Otherwise, a changed AST in one module will have too much blast radius invalidating types in other modules.</p>
<p>Today, we have to enforce this manually (mostly via @MichaReiser code review). It would be ideal if we could use types/visibility/modules to provide better enforcement of this rule, or failing that, at least easier human review, assisted by some clear guidelines about what kind of code should be expected where.</p>
<p>This is an open-ended issue to explore how we could do that, and implement something in this direction.</p>
<p>A related existing guideline we have is that methods on <code>Type</code> should operate on types, and not on ASTs, and methods on <code>TypeInferenceBuilder</code> should operate on the AST (but always of only one module). Types can cross module boundaries; ASTs should not.</p>
<p>Some types (e.g. class and function literals) maintain internal reference to ASTs, so that information (e.g. attributes) can be resolved lazily. In this case, we need to ensure that that lazy resolution is fully protected by Salsa queries, so users of the type in another module don't adopt a direct cross-module AST dependency.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-02-05 16:01</div>
            <div class="timeline-body"><blockquote>
<p>Some types (e.g. class and function literals) maintain internal reference to ASTs, so that information (e.g. attributes) can be resolved lazily. In this case, we need to ensure that that lazy resolution is fully protected by Salsa queries, so users of the type in another module don't adopt a direct cross-module AST dependency.</p>
</blockquote>
<p>One of the benefits of the proposal to use some kind of arena storage for ASTs (#15657) is that it would be easier to enforce this: Types would contain AST <em>ids</em>, but that wouldn't be enough to dereference to the AST data itself. You'd also have to have an <code>&amp;Ast</code>, which would be stored in the type, and where we'd be able to limit which functions have access to one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-05 16:06</div>
            <div class="timeline-body"><p>We might already be able to do this by either using a newtype wrapper around <code>AstNodeRef</code> and making the <code>node</code> method for private (e.g. implement in <code>infer</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] make it easier to avoid accidental cross-module direct AST usage" to "make it easier to avoid accidental cross-module direct AST usage" by @MichaReiser on 2025-05-07 15:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @AlexWaygood on 2025-05-11 08:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @AlexWaygood on 2025-05-11 08:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @AlexWaygood on 2025-05-11 08:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> removed by @MichaReiser on 2025-05-19 07:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> removed by @MichaReiser on 2025-05-19 07:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @MichaReiser on 2025-05-19 07:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 02:10:56 UTC
    </footer>
</body>
</html>
