<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>alpha.24 regression: Non-dataclass inheriting from a dataclass breaks generic inference - astral-sh/ty #1427</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>alpha.24 regression: Non-dataclass inheriting from a dataclass breaks generic inference</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1427">#1427</a>
        opened by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a>
        on 2025-10-24 00:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>This is a MRE of some code that stopped working when I tried <code>ty 0.0.1-alpha.24</code> <a href="https://play.ty.dev/d62bf40e-aa4a-432e-9e9a-2c4ab01d9c3c">playground</a>. If you add <code>@dataclass</code> to <code>ChildOfParentDataclass</code> the error goes away.</p>
<p>Edit: On playing around more, this looks to be an issue with/regression in the generics inference. Making the generic explicit with <code>return ChildOfParentDataclass[T](x)</code> also makes the error go away.</p>
<pre><code class="language-py"># Gives incorrect error when using a dataclass parent:

from dataclasses import dataclass

@dataclass
class ParentDataclass[T]:
    value: T

# @dataclass  # Uncommenting this makes the error go away
class ChildOfParentDataclass[T](ParentDataclass[T]): ...

def uses_dataclass[T](x: T) -&gt; ChildOfParentDataclass[T]:
    # Argument is incorrect: Expected `T@ChildOfParentDataclass`, found `T@uses_dataclass`
    return ChildOfParentDataclass(x)

# Works fine if the parent is a normal class

class Parent[T]:
    def __init__(self, value: T):
        self.value = value

class ChildOfParent[T](Parent[T]): ...

def uses_init[T](x: T) -&gt; ChildOfParent[T]:
    return ChildOfParent(x)
</code></pre>
<p>Comparing alpha.23 to alpha.24:</p>
<pre><code class="language-powershell">PS ~&gt;uvx ty@0.0.1-alpha.23 check issue.py
Checking ------------------------------------------------------------ 1/1 files
All checks passed!
PS ~&gt;uvx ty@0.0.1-alpha.24 check issue.py
Checking ------------------------------------------------------------ 1/1 files
error[invalid-argument-type]: Argument is incorrect
  --&gt; issue.py:14:35
   |
12 | def uses_dataclass[T](x: T) -&gt; ChildOfParentDataclass[T]:
13 |     # Argument is incorrect: Expected T@ChildOfParentDataclass, found T@uses_dataclass
14 |     return ChildOfParentDataclass(x)
   |                                   ^ Expected `T@ChildOfParentDataclass`, found `T@uses_dataclass`
15 |
16 | # Works fine if the parent is a normal class
   |
info: rule `invalid-argument-type` is enabled by default

Found 1 diagnostic
</code></pre>
<h3>Version</h3>
<p>ty 0.0.1-alpha.24 (1fee7da8b 2025-10-23)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "alpha.24 regression: Non-dataclass inheriting from a dataclass breaks generics" to "alpha.24 regression: Non-dataclass inheriting from a dataclass breaks generic inference" by @MeGaGiGaGon on 2025-10-24 03:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-10-24 09:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">generics</span> added by @AlexWaygood on 2025-10-24 09:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">dataclasses</span> added by @AlexWaygood on 2025-10-24 09:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-27 12:31</div>
            <div class="timeline-body"><p>Thank you for reporting this. Something seems broken with the <code>__init__</code> methods of generic dataclasses:</p>
<pre><code class="language-py">from dataclasses import dataclass

@dataclass
class ParentDataclass[T]:
    value: T

class ChildOfParentDataclass[T](ParentDataclass[T]): ...

# (self: ParentDataclass[Unknown], value: Unknown) -&gt; None
reveal_type(ParentDataclass.__init__)

# (self: ParentDataclass[T@ChildOfParentDataclass], value: T@ChildOfParentDataclass) -&gt; None
reveal_type(ChildOfParentDataclass.__init__)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Beta" by @carljm on 2025-10-30 16:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/saada">@saada</a> on 2025-10-31 03:26</div>
            <div class="timeline-body"><p>I've submitted a PR to fix this issue: https://github.com/astral-sh/ruff/pull/21159</p>
<p>The fix threads the child class's generic context through to the parent's synthesized <code>__init__</code> method, restoring the behavior from alpha.23. All tests passing and verified against mypy and pyright.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-10-31 12:55</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:20:51 UTC
    </footer>
</body>
</html>
