<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>index-out-of-bounds error after numpy reshape - astral-sh/ty #2501</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>index-out-of-bounds error after numpy reshape</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/2501">#2501</a>
        opened by <a href="https://github.com/ntjohnson1">@ntjohnson1</a>
        on 2026-01-14 21:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntjohnson1">@ntjohnson1</a></div>
            <div class="timeline-body">Summary
<p>I didn&#x27;t see discussion on numpy specific support or other index related edge cases.</p>
<pre><code>def example(data: int | Sequence[int | float]) -&gt; None:
    if isinstance(data, Sequence):
        np_data = np.array(data).reshape((1, -1))
        if np_data.shape[1] not in (3, 4): # &lt;---
            raise ValueError(f&quot;expected sequence of length of 3 or 4, received {np_data.shape[1]}&quot;)
    return None
</code></pre>
<p><code>error[index-out-of-bounds]: Index 0 is out of bounds for tuple </code>tuple[()]<code> with length 0</code></p>
<p>A simpler version does seem to infer the shape correctly.</p>
<pre><code>  a = [1]
  b = np.array(a).reshape((1, -1))
  c = b.shape[1]
</code></pre>
<p>This triggers an index-out-of-bounds error (it thinks shape is an empty tuple so shape[0] also doesn&#x27;t work). Mypy appears to infer the output shape from the reshape call.</p>
<p>Version <code>ty 0.0.11</code></p>
Version
<p>ty 0.0.11 (830cb9cc6 2026-01-09)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2026-01-15 00:03</div>
            <div class="timeline-body"><p>Thanks for the report! I&#x27;m having trouble reproducing your results. With numpy 2.3.0 or 2.4.1, the snippet you provided works correctly for me (we infer <code>tuple[int, int]</code> for the shape). Can you clarify the version of numpy you are using, and verify you are checking exactly the code snippet provided?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> added by <a href="https://github.com/carljm">@carljm</a> on 2026-01-15 00:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntjohnson1">@ntjohnson1</a> on 2026-01-15 00:17</div>
            <div class="timeline-body"><p>Background context:</p>
<p>In my PR I linked above I added a minimal ty setup for us to start checking it out. Running <code>uv run ty check</code> from the root without the index-out-of-bounds ignore triggers on https://github.com/rerun-io/rerun/blob/42f2479854d591c21eea1eccb2c47a4a9b7ae39d/rerun_py/rerun_sdk/rerun/datatypes/rgba32_ext.py#L56 however I pasted the snippet above in that same file and it also triggered.</p>
<p>Minimal standalone repro:</p>
<pre><code>#example.py
import numpy as np
from typing import Sequence

def example(data: int | Sequence[int | float]) -&gt; None:
    if isinstance(data, Sequence):
        np_data = np.array(data).reshape((1, -1))
        if np_data.shape[1] not in (3, 4): # &lt;---
            raise ValueError(f&quot;expected sequence of length of 3 or 4, received {np_data.shape[1]}&quot;)
    return None
</code></pre>
<pre><code>uv venv --python=3.11
source .venv/bin/activate
uv pip install ty==0.0.11 numpy==2.3.5
ty check example.py
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2026-01-15 00:36</div>
            <div class="timeline-body"><p>Thanks for the additional info! There still seems to be some mysterious additional factor in play, because when I follow your exact instructions, the issue still doesn&#x27;t reproduce for me:</p>
<pre><code>➜ mkdir issue2501 &amp;&amp; cd issue2501

➜ uv venv --python=3.11
Using CPython 3.11.7
Creating virtual environment at: .venv
Activate with: source .venv/bin/activate

➜ source .venv/bin/activate

➜ uv pip install ty==0.0.11 numpy==2.3.5
Resolved 2 packages in 110ms
Prepared 1 package in 611ms
Installed 2 packages in 12ms
 + numpy==2.3.5
 + ty==0.0.11

➜ cat &gt;example.py
import numpy as np
from typing import Sequence

def example(data: int | Sequence[int | float]) -&gt; None:
    if isinstance(data, Sequence):
        np_data = np.array(data).reshape((1, -1))
        if np_data.shape[1] not in (3, 4): # &lt;---
            raise ValueError(f&quot;expected sequence of length of 3 or 4, received {np_data.shape[1]}&quot;)
    return None

➜ ty check .
All checks passed!
</code></pre>
<p>(ty actually doesn&#x27;t care about the Python version in the virtualenv, but explicitly passing <code>--python-version 3.11</code> to ty doesn&#x27;t make any difference, either.)</p>
<p>Is there any chance <code>ty</code> in your environment is resolving to some older ty elsewhere, rather than the 0.0.11 just installed in the venv?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntjohnson1">@ntjohnson1</a> on 2026-01-15 00:57</div>
            <div class="timeline-body"><p>WEIRD restarting my shell and the standalone example stopped failing.</p>
<p>It still fails running <code>uv run ty check</code> from root on my branch off rerun though (if I don&#x27;t ignore the index-out-of-bounds rule). I&#x27;ll probably have time to dig into this a bit more tomorrow to figure out what the disconnect is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntjohnson1">@ntjohnson1</a> on 2026-01-16 21:26</div>
            <div class="timeline-body"><p>Ok I put together a small repo (not much more code from above but couldn&#x27;t get it to trigger in a single file) that I am able to reproduce the problem in. I confirmed I saw the error on both my laptops.
https://github.com/ntjohnson1/ty-2501
clone then</p>
<pre><code>uv sync
uv run ty check
</code></pre>
<p>My guess is that its related to the circular dependency.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2026-01-17 01:39</div>
            <div class="timeline-body"><p>Thanks for the reproducer!</p>
<p>It&#x27;s not related to the circular dependency. It is in fact the Python version -- now that I see the <code>pyproject.toml</code> in your reproducer, I see that ty will actually choose Python 3.10 (the lowest supported Python version). And in fact the issue repros consistently under Python 3.10, but not on 3.11+, with this simple reproducer:</p>
<pre><code>import numpy as np

def reshape_test(data: np.ndarray[tuple[int, int], np.dtype[np.uint8]]):
    out = data.reshape((1, -1))
    reveal_type(out)

</code></pre>
<p>Both mypy and pyright reveal the type of <code>out</code> correctly here as <code>np.ndarray[tuple[int, int], np.dtype[np.uint8]]</code>, but ty reveals it wrongly as <code>np.ndarray[tuple[()], np.dtype[np.uint8]]</code>. (Same is true no matter the shape of the input array, and all type checkers correctly match the output dtype to the input dtype.)</p>
<p>So the problem is that under Python 3.10, ty is picking this first overload here: https://github.com/numpy/numpy/blob/maintenance/2.3.x/numpy/<strong>init</strong>.pyi#L2429</p>
<p>And the root cause is both simple and silly: numpy does <a href="https://github.com/numpy/numpy/blob/maintenance/2.3.x/numpy/__init__.pyi#L174"><code>from typing import Never</code></a>, and we correctly model that <code>typing.Never</code> does not exist on Python 3.10. So that overload becomes an overload on <code>Sequence[Unknown]</code> (which matches) instead of <code>Sequence[Never]</code>.</p>
<p>And in fact mypy does exactly the same thing as ty, if you give it <code>--python-version 3.10</code>!</p>
<p>So the only difference between mypy and ty here is the Python version they use to check by default: ty chooses the lowest version supported in your <code>pyproject.toml</code>.</p>
<p>It seems like numpy 2.3.5 doesn&#x27;t really support Python 3.10 (or if it intends to, its stubs are subtly broken on 3.10). So if you can, it seems like the best fix would be for you to bump your minimum supported Python version to 3.11 in your <code>pyproject.toml</code>. Or failing that, explicitly configure ty to check against Python 3.11.</p>
<p>Closing, since it doesn&#x27;t look like there&#x27;s a bug in ty here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2026-01-17 01:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:27:08 UTC
    </footer>
</body>
</html>
