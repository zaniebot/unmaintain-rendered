<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>cyclic control flow for loops - astral-sh/ty #232</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>cyclic control flow for loops</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/232">#232</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2024-11-07 15:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/carljm">@carljm</a> on 2024-11-07 15:27</div>
            <div class="timeline-body"><p>Currently we don't even model control flow back edges in loops (because they will often lead to inference cycles). Once we have fixpoint iteration support in Salsa, we need to add these back edges and tests for them, including cases where we have to fallback to avoid runaway fixpoint iteration, e.g.:</p>
<pre><code class="language-py">x = 0
for _ in range(y):
    x += 1
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @carljm by @carljm on 2024-11-07 15:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] fixpoint iteration and cyclic control flow for loops" to "[red-knot] cyclic control flow for loops" by @carljm on 2025-03-12 12:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @carljm by @carljm on 2025-03-27 18:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] cyclic control flow for loops" to "cyclic control flow for loops" by @MichaReiser on 2025-05-07 15:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">control flow</span> added by @AlexWaygood on 2025-05-10 21:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">runtime semantics</span> added by @AlexWaygood on 2025-05-11 07:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Beta" by @carljm on 2025-06-11 00:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "GA" by @carljm on 2025-06-11 00:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-04 07:52</div>
            <div class="timeline-body"><p>I've seen multiple real world examples where missing support for loop control flow leads to an incorrect reachability analysis for large blocks of code within loops, because we observe a type that is too narrow. For example:</p>
<pre><code class="language-py">first_iteration = True

for x in xs:
    if not first_iteration:
        # this whole block is considered unreachable

    # more code

    first_iteration = False
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @oconnor663 by @oconnor663 on 2025-11-14 15:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-12-07 18:56</div>
            <div class="timeline-body"><p>I just encountered the exact same problem as David:</p>
<p>https://play.ty.dev/9214d74c-f4de-46df-80d0-44b3262d1ff4</p>
<pre><code class="language-py">some_list: list[int] = [0, 1]

first_part = True
for j in range(0, 10):
    if first_part:
        first_part = False
        continue
    # ty infers `val: Never` here!?
    # (many other results now infer to Unknown)
    val = some_list[0]
</code></pre>
<p>And because we don't respect <code>first_part: bool</code> there's no (non-tedious) way to tell ty to chill.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-12-07 19:00</div>
            <div class="timeline-body"><blockquote>
<p>And because we don't respect <code>first_part: bool</code> there's no (non-tedious) way to tell ty to chill.</p>
</blockquote>
<p>Obviously not ideal, but a <code>cast</code> always helps as a workaround in these situations (<code>first_part = cast(bool, True)</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Stable" by @carljm on 2025-12-19 23:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "M1" by @carljm on 2025-12-19 23:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/anstadnik">@anstadnik</a> on 2025-12-23 15:15</div>
            <div class="timeline-body"><pre><code class="language-python">    i = 0
    while i &lt; 1: # Here i is Literal[0]
        i += 1 # Here i is Literal[1]
        
    reveal_type(i) # Never
</code></pre>
<p><code>ty</code> thinks that it's an endless loop</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:53:03 UTC
    </footer>
</body>
</html>
