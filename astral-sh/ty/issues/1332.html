<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issues with kwarg splats inside dictionary literals - astral-sh/ty #1332</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Issues with kwarg splats inside dictionary literals</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1332">#1332</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-10-10 10:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-10 10:51</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>At runtime, any object can be <code>**</code>-unpacked if that object has a <code>.keys()</code> method and a <code>__getitem__</code> method:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; from typing import KeysView
&gt;&gt;&gt; class HasKeysAndGetItem:
...     def keys(self) -&gt; KeysView[str]:
...         return {&quot;foo&quot;: 42}.keys()
...     
...     def __getitem__(self, arg: str) -&gt; int:
...         return 42
...         
&gt;&gt;&gt; {**HasKeysAndGetItem()}
{'foo': 42}
</code></pre>
<p>Functions that have <code>**kwargs</code> parameters have the additional requirement that the keys of the mapping must be strings:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; def f(**kwargs): ...
... 
&gt;&gt;&gt; f(**HasKeysAndGetItem())
&gt;&gt;&gt; f(**{42: 42})
Traceback (most recent call last):
  File &quot;&lt;python-input-7&gt;&quot;, line 1, in &lt;module&gt;
    f(**{42: 42})
    ~^^^^^^^^^^^^
TypeError: keywords must be strings
</code></pre>
<p>Ty should attempt to emulate this exactly:</p>
<ul>
<li>All mappings used with <code>**</code> splats should be treated the same way, assuming they have a <code>keys</code> method and a <code>__getitem__</code> method</li>
<li>Invalid <code>**</code> splats should be detected and should cause us to emit diagnostics</li>
</ul>
<p>We currently get this right for the <code>**kwargs</code> function-call case, but not for <code>**</code> splats inside dictionary literals, where it appears we treat <code>dict</code>s different to other mappings and we do not emit diagnostics for invalid <code>**</code> splats:</p>
<pre><code class="language-py">from typing import Mapping, KeysView

class HasKeysAndGetItem:
    def keys(self) -&gt; KeysView[str]:
        return {}.keys()
    
    def __getitem__(self, arg: str) -&gt; int:
        return 42

def h(**kwargs): ...

def f(
    a: dict[str, int],
    b: Mapping[str, int],
    c: HasKeysAndGetItem,
    d: object
):
    reveal_type({**a})  # dict[Unknown | str, Unknown | int] (good!)
    reveal_type({**b})  # dict[Unknown, Unknown]             (bad!)
    reveal_type({**c})  # dict[Unknown, Unknown]             (bad!)
    reveal_type({**d})  # dict[Unknown, Unknown]             (good, but no diagnostic emitted!)
    
    h(**a)
    h(**b)
    h(**c)
    h(**d)              # error: [invalid-argument-type] &quot;Argument expression after ** must be a mapping type: Found `object`&quot;
</code></pre>
<p>The logic for <code>**</code> splats passed to function calls looks correct to me -- I think we probably want to do exactly the same thing inside dictionary literals, <em>except</em> that we don't need to check whether the type of the keys is assignable to <code>str</code>. So we may want to extract that logic out into a helper function somewhere: https://github.com/astral-sh/ruff/blob/69f918203359f834e0ca76764a502f3421b2c2c7/crates/ty_python_semantic/src/types/call/bind.rs#L2691-L2742</p>
<p>Cc. @ibraheemdev -- this looks related to https://github.com/astral-sh/ruff/pull/20523</p>
<h3>Version</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-10-10 10:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">runtime semantics</span> added by @AlexWaygood on 2025-10-10 10:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "GA" by @carljm on 2025-10-10 16:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-10-10 21:45</div>
            <div class="timeline-body"><p>Dictionary unpacking expressions <a href="https://github.com/astral-sh/ruff/blob/main/crates/ty_python_semantic/src/types/infer/builder.rs#L5941">are special-cased here</a>, it shouldn't be too hard to generalize if we already have the infrastructure for function calls.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @ibraheemdev by @ibraheemdev on 2025-11-14 08:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Stable" by @carljm on 2026-01-08 18:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Pre-stable 1" by @carljm on 2026-01-08 18:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:48:55 UTC
    </footer>
</body>
</html>
