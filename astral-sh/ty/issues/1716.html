<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[panic] dependency graph cycle - astral-sh/ty #1716</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[panic] dependency graph cycle</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1716">#1716</a>
        opened by <a href="https://github.com/Matt-Ord">@Matt-Ord</a>
        on 2025-12-02 09:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Matt-Ord">@Matt-Ord</a></div>
            <div class="timeline-body"><p>Not sure if you expect to have fixed all of these issues yet - but thought I would submit a ticket</p>
<p>when type checking
https://github.com/Matt-Ord/slate</p>
<pre><code>ty check ./slate_core/array/_misc.py
</code></pre>
<p>panics with</p>
<pre><code>$ ty check ./slate_core/array/_misc.py
error[panic]: Panicked at /root/.cargo/git/checkouts/salsa-e6f3bb7c2a062968/17bc55d/src/function/fetch.rs:227:21 when checking `/workspaces/slate/slate_core/array/_misc.py`: `dependency graph cycle when querying GenericAlias &lt; &#x27;db &gt;::variance_of_(Id(d806)), set cycle_fn/cycle_initial to fixpoint iterate.
Query stack:
[
    check_file_impl(Id(c00)),
    infer_scope_types(Id(1001)),
    PEP695TypeAliasType &lt; &#x27;db &gt;::raw_value_type_(Id(8002)),
    infer_scope_types(Id(7cb4)),
    Type &lt; &#x27;db &gt;::member_lookup_with_policy_(Id(2c41)),
    Type &lt; &#x27;db &gt;::try_call_dunder_get_(Id(10000)),
    ClassLiteral &lt; &#x27;db &gt;::variance_of_(Id(c804)),
    GenericAlias &lt; &#x27;db &gt;::variance_of_(Id(d806)),
    ClassLiteral &lt; &#x27;db &gt;::variance_of_(Id(c806)),
    infer_expression_types_impl(Id(1a67)),
    infer_definition_types(Id(843d)),
    FunctionType &lt; &#x27;db &gt;::signature_(Id(403a)),
    FunctionType &lt; &#x27;db &gt;::signature_(Id(403b)),
    infer_scope_types(Id(7cdf)),
    TypeVarInstance &lt; &#x27;db &gt;::lazy_bound_(Id(8c22)),
    infer_deferred_types(Id(8436)),
    infer_definition_types(Id(842d)),
    place_by_id(Id(3465)),
    infer_definition_types(Id(1717)),
    Type &lt; &#x27;db &gt;::member_lookup_with_policy_(Id(2c37)),
    place_by_id(Id(345f)),
    infer_definition_types(Id(15c8)),
    infer_definition_types(Id(bd46)),
    infer_definition_types(Id(bd44)),
    Type &lt; &#x27;db &gt;::member_lookup_with_policy_(Id(2c32)),
    place_by_id(Id(3459)),
    infer_definition_types(Id(4d24)),
    Type &lt; &#x27;db &gt;::member_lookup_with_policy_(Id(2c33)),
    place_by_id(Id(345a)),
    infer_definition_types(Id(bdc8)),
    file_to_module(Id(c86)),
    Type &lt; &#x27;db &gt;::member_lookup_with_policy_(Id(2c34)),
    imported_modules(Id(c86)),
]`
info: This indicates a bug in ty.
info: If you could open an issue at https://github.com/astral-sh/ty/issues/new?title=%5Bpanic%5D, we&#x27;d be very appreciative!
info: Platform: linux x86_64
info: Version: 0.0.1-alpha.29
info: Args: [&quot;ty&quot;, &quot;check&quot;, &quot;./slate_core/array/_misc.py&quot;]
info: run with `RUST_BACKTRACE=1` environment variable to show the full backtrace information
info: query stacktrace:
   0: GenericAlias &lt; &#x27;db &gt;::variance_of_(Id(d806))
             at crates/ty_python_semantic/src/types/class.rs:344
   1: ClassLiteral &lt; &#x27;db &gt;::variance_of_(Id(c804))
             at crates/ty_python_semantic/src/types/class.rs:3782
   2: Type &lt; &#x27;db &gt;::try_call_dunder_get_(Id(10000))
             at crates/ty_python_semantic/src/types.rs:873
   3: Type &lt; &#x27;db &gt;::member_lookup_with_policy_(Id(2c41))
             at crates/ty_python_semantic/src/types.rs:873
   4: infer_scope_types(Id(7cb4))
             at crates/ty_python_semantic/src/types/infer.rs:68
   5: PEP695TypeAliasType &lt; &#x27;db &gt;::raw_value_type_(Id(8002))
             at crates/ty_python_semantic/src/types.rs:12712
   6: infer_scope_types(Id(1001))
             at crates/ty_python_semantic/src/types/infer.rs:68
   7: check_file_impl(Id(c00))
             at crates/ty_project/src/lib.rs:535


Found 1 diagnostic
WARN A fatal error occurred while checking some files. Not all project files were analyzed. See the diagnostics list above for details.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fatal</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-02 09:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Beta&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-02 09:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-03 00:02</div>
            <div class="timeline-body"><p>This fixes the panic and passes all existing tests, but I haven&#x27;t tried to find a minimal repro for a regression test yet:</p>
<pre><code>diff --git a/crates/ty_python_semantic/src/types/class.rs b/crates/ty_python_semantic/src/types/class.rs
index 1285fb0093..712bb8806a 100644
--- a/crates/ty_python_semantic/src/types/class.rs
+++ b/crates/ty_python_semantic/src/types/class.rs
@@ -340,9 +340,18 @@ impl&lt;&#x27;db&gt; From&lt;GenericAlias&lt;&#x27;db&gt;&gt; for Type&lt;&#x27;db&gt; {
     }
 }
 
+fn variance_of_cycle_initial&lt;&#x27;db&gt;(
+    _db: &amp;&#x27;db dyn Db,
+    _id: salsa::Id,
+    _self: GenericAlias&lt;&#x27;db&gt;,
+    _typevar: BoundTypeVarInstance&lt;&#x27;db&gt;,
+) -&gt; TypeVarVariance {
+    TypeVarVariance::Bivariant
+}
+
 #[salsa::tracked]
 impl&lt;&#x27;db&gt; VarianceInferable&lt;&#x27;db&gt; for GenericAlias&lt;&#x27;db&gt; {
-    #[salsa::tracked(heap_size=ruff_memory_usage::heap_size)]
+    #[salsa::tracked(heap_size=ruff_memory_usage::heap_size, cycle_initial=variance_of_cycle_initial)]
     fn variance_of(self, db: &amp;&#x27;db dyn Db, typevar: BoundTypeVarInstance&lt;&#x27;db&gt;) -&gt; TypeVarVariance {
         let origin = self.origin(db);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-03 00:04</div>
            <div class="timeline-body"><p>Yeah that looks like the right fix here, I expected we just needed a cycle handler for that query.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-03 17:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-03 18:24</div>
            <div class="timeline-body"><p>Okay, here&#x27;s a self-contained repro:</p>
<pre><code>from typing import Protocol

class A(Protocol):
    @property
    def f(self): ...

type Recursive = int | tuple[Recursive, ...]

class B[T: A]: ...

class C[T: A](A):
    x: tuple[Recursive, ...]

class D(B[C]): ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-03 19:01</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:26:12 UTC
    </footer>
</body>
</html>
