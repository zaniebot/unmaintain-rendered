<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Third-party dataclass-like libraries (pydantic, attrs) will sometimes treat unannotated assignments as dataclass fields - astral-sh/ty #1425</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Third-party dataclass-like libraries (pydantic, attrs) will sometimes treat unannotated assignments as dataclass fields</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1425">#1425</a>
        opened by <a href="https://github.com/franzkurt">@franzkurt</a>
        on 2025-10-23 17:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/franzkurt">@franzkurt</a> on 2025-10-23 17:22</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>For example if my class is a validator like</p>
<pre><code class="language-python">from pydantic import BaseModel

class ResponseOk(BaseModel):
    status_code = Field(..., alias='$status')
</code></pre>
<p><code>ty</code> provide the error even enabling the config <code>allow_population_by_field_name</code></p>
<pre><code class="language-bash">Checking ------------------------------------------------------------ 1/1 files                                                                                                                                                                            error[unknown-argument]: Argument `status_code` does not match any known parameter
 --&gt; /Users/jusbrasil/Desktop/issue.py.py:6:12
  |
4 |     status_code = Field(..., alias='$status')
5 |
6 | ResponseOk(status_code=200)
  |            ^^^^^^^^^^^^^^^
  |
info: rule `unknown-argument` is enabled by default
Found 1 diagnostic
</code></pre>
<h3>Version</h3>
<p>ty 0.0.1a24</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">dataclasses</span> added by @AlexWaygood on 2025-10-23 17:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Beta" by @carljm on 2025-10-23 18:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-10-23 18:36</div>
            <div class="timeline-body"><p>As far as I can see, the <code>alias</code> option isn't relevant here; we don't seem to be recognizing <code>status_code</code> as a field at all, even if the <code>alias</code> option is not used. I'm not sure why, since we support <code>field_specifiers</code>; this case doesn't appear to fall under any of the missing features in https://github.com/astral-sh/ty/issues/1327</p>
<pre><code class="language-py">from pydantic import BaseModel, Field

class ResponseOk(BaseModel):
    status_code = Field()

ex = ResponseOk(status_code=200)  # I get `unknown-argument` here
</code></pre>
<p>Tentatively putting this in beta milestone pending further clarification/investigation, since it seems important that we support pydantic model fields.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Ty not recognize `pydantic alias` when validating rule `unknown-argument`" to "Not recognizing pydantic model fields" by @carljm on 2025-10-23 18:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-23 18:53</div>
            <div class="timeline-body"><p>I think we probably just treat <em>annotated</em> attributes as fields.</p>
<p>I started to write a Pydantic-compatibility test suite, so hopefully we can soon get a clearer picture of what is missing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-24 10:52</div>
            <div class="timeline-body"><p>I agree that it would be great if we could do better here, but I think doing so will require pydantic-specific special casing that goes above and beyond the <code>dataclass_transform</code> spec. Both mypy and pyright also fail to recognise the unannotated field as a dataclass field here:</p>
<pre><code class="language-sh">~/dev % uvx --with=pydantic pyright foo.py                                                                          
Installed 7 packages in 143ms
/Users/alexw/dev/foo.py
  /Users/alexw/dev/foo.py:4:19 - error: Dataclass field without type annotation will cause runtime exception (reportGeneralTypeIssues)
  /Users/alexw/dev/foo.py:6:12 - error: No parameter named &quot;status_code&quot; (reportCallIssue)
2 errors, 0 warnings, 0 informations
~/dev [1] % uvx --with=pydantic mypy foo.py   
Installed 8 packages in 27ms
foo.py:6: error: Unexpected keyword argument &quot;status_code&quot; for &quot;ResponseOk&quot;  [call-arg]
Found 1 error in 1 file (checked 1 source file)
</code></pre>
<p>This makes sense if all you've implemented is the <code>dataclass_transform</code> spec, since unannotated assignments do not constitute fields in the stdlib <code>dataclasses</code> module, and <code>dataclass_transform</code> implementations are basically assumed by type checkers to work mostly the same way as the stdlib <code>dataclasses</code> module:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; from dataclasses import dataclass, field
&gt;&gt;&gt; @dataclass
... class A:
...     x = field(default=0)
...     
Traceback (most recent call last):
  File &quot;&lt;python-input-3&gt;&quot;, line 1, in &lt;module&gt;
    @dataclass
     ^^^^^^^^^
  File &quot;/Users/alexw/.pyenv/versions/3.13.1/lib/python3.13/dataclasses.py&quot;, line 1305, in dataclass
    return wrap(cls)
  File &quot;/Users/alexw/.pyenv/versions/3.13.1/lib/python3.13/dataclasses.py&quot;, line 1295, in wrap
    return _process_class(cls, init, repr, eq, order, unsafe_hash,
                          frozen, match_args, kw_only, slots,
                          weakref_slot)
  File &quot;/Users/alexw/.pyenv/versions/3.13.1/lib/python3.13/dataclasses.py&quot;, line 1032, in _process_class
    raise TypeError(f'{name!r} is a field but has no type annotation')
TypeError: 'x' is a field but has no type annotation
&gt;&gt;&gt; @dataclass
... class B:
...     x = 42
...     
&gt;&gt;&gt; B(X=56)
Traceback (most recent call last):
  File &quot;&lt;python-input-5&gt;&quot;, line 1, in &lt;module&gt;
    B(X=56)
    ~^^^^^^
TypeError: B.__init__() got an unexpected keyword argument 'X'
</code></pre>
<p>Pyrefly does not emit the same error as mypy/pyright/ty on this snippet, but from chatting with them at PyCon UK I believe they've been working quite hard on implementing custom support for pydantic/django/similar libraries, so this doesn't surprise me too much.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">dataclasses</span> removed by @AlexWaygood on 2025-10-24 10:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">library</span> added by @AlexWaygood on 2025-10-24 10:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-24 10:56</div>
            <div class="timeline-body"><p><a href="https://pyrefly.org/en/docs/pydantic/">Docs about Pyrefly's pydantic support</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Not recognizing pydantic model fields" to "Not recognizing unannotated pydantic model fields" by @AlexWaygood on 2025-10-24 11:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-10-24 15:57</div>
            <div class="timeline-body"><p>Thanks for the analysis! Totally missed the missing annotation. Moving this back out of beta milestone for now; it seems like what we are doing follows the spec. We may want to add further dedicated pydantic support, but we should discuss this, and it doesn't seem like a blocker for beta.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Beta" by @carljm on 2025-10-24 15:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">dataclasses</span> added by @sharkdp on 2025-10-27 12:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhermes">@dhermes</a> on 2025-10-27 17:21</div>
            <div class="timeline-body"><p>This appears to be a regression in <code>0.0.1a24</code>. I was using <code>0.0.1a21</code> and had no issue and now on <code>0.0.1a24</code> this issue appears. I just checked <code>0.0.1a23</code> and the issue didn't occur there either. E.g. for</p>
<pre><code class="language-python">class FirebaseClaims(pydantic.BaseModel):
    model_config = pydantic.ConfigDict(extra=&quot;ignore&quot;, populate_by_name=True)

    subject: str = pydantic.Field(alias=&quot;sub&quot;)
    audience: str = pydantic.Field(alias=&quot;aud&quot;)
    exp: int
    iat: int
    name: str | None = pydantic.Field(default=None)
    email: str | None = pydantic.Field(default=None)
    email_verified: bool | None = pydantic.Field(default=None)

    @property
    def issued_at(self) -&gt; datetime.datetime:
        return datetime.datetime.fromtimestamp(self.iat, datetime.UTC)

    @property
    def expires_at(self) -&gt; datetime.datetime:
        return datetime.datetime.fromtimestamp(self.exp, datetime.UTC)
</code></pre>
<p>the following code</p>
<pre><code class="language-python">    expected = middleware.FirebaseClaims(
        subject=&quot;7vH1VaTSXC2tTM67LooOkYmS78qc&quot;,
        audience=&quot;manticore-474331&quot;,
        exp=now + 1800,
        iat=now - 1800,
        name=&quot;Terry Crews 833&quot;,
        email=&quot;terry.crews833@mail.invalid&quot;,
        email_verified=True,
    )
</code></pre>
<p>now fails with:</p>
<pre><code>error[missing-argument]: No arguments provided for required parameters `sub`, `aud`
   --&gt; tests/unit/api/test_middleware.py:312:16
    |
310 |       middleware._require_firebase_claims(request, verify_firebase_token)
311 |       claims = middleware.get_firebase_claims(request)
312 |       expected = middleware.FirebaseClaims(
    |  ________________^
313 | |         subject=&quot;7vH1VaTSXC2tTM67LooOkYmS78qc&quot;,
314 | |         audience=&quot;manticore-474331&quot;,
315 | |         exp=now + 1800,
316 | |         iat=now - 1800,
317 | |         name=&quot;Terry Crews 833&quot;,
318 | |         email=&quot;terry.crews833@mail.invalid&quot;,
319 | |         email_verified=True,
320 | |     )
    | |_____^
321 |       assert claims == expected
    |
info: rule `missing-argument` is enabled by default

error[unknown-argument]: Argument `subject` does not match any known parameter
   --&gt; tests/unit/api/test_middleware.py:313:9
    |
311 |     claims = middleware.get_firebase_claims(request)
312 |     expected = middleware.FirebaseClaims(
313 |         subject=&quot;7vH1VaTSXC2tTM67LooOkYmS78qc&quot;,
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
314 |         audience=&quot;manticore-474331&quot;,
315 |         exp=now + 1800,
    |
info: rule `unknown-argument` is enabled by default

error[unknown-argument]: Argument `audience` does not match any known parameter
   --&gt; tests/unit/api/test_middleware.py:314:9
    |
312 |     expected = middleware.FirebaseClaims(
313 |         subject=&quot;7vH1VaTSXC2tTM67LooOkYmS78qc&quot;,
314 |         audience=&quot;manticore-474331&quot;,
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^
315 |         exp=now + 1800,
316 |         iat=now - 1800,
    |
info: rule `unknown-argument` is enabled by default
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-27 18:03</div>
            <div class="timeline-body"><p>@dhermes what you are seeing is a distinct issue, please see #1438.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-29 14:32</div>
            <div class="timeline-body"><p>It seems like <code>attrs</code> will also treat some unnanotated assignments in the class body as creating dataclass fields, and we will similarly fail to correctly understand these classes currently:</p>
<pre><code class="language-py">import attr

@attr.attrs
class VersionInfo:
    year = attr.attrib(type=int)

VersionInfo(year=42)  # error[unknown-argument] Argument `year` does not match any known parameter
</code></pre>
<p>If you change the <code>year</code> assignment to <code>year: int = attr.attrib(type=int)</code>, the false-positive error goes away.</p>
<p>This came up in https://github.com/astral-sh/ruff/pull/21685.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Not recognizing unannotated pydantic model fields" to "Third-party dataclass-like libraries (pydantic, attrs) will sometimes treat unannotated assignments as dataclass fields" by @AlexWaygood on 2025-11-29 14:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Stable" by @carljm on 2025-12-01 23:38</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 02:11:38 UTC
    </footer>
</body>
</html>
