<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>More helpful diagnostic when trying to use PEP 604 union types before 3.10 - astral-sh/ty #437</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>More helpful diagnostic when trying to use PEP 604 union types before 3.10</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/437">#437</a>
        opened by <a href="https://github.com/metaist">@metaist</a>
        on 2025-05-18 03:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/metaist">@metaist</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I believe this is distinct from #122 because even the most basic UnionType seems to fail.</p>
<pre><code class="language-python"># test.py
from typing import Union

A = Union[int, str]
B = int | str
</code></pre>
<pre><code class="language-bash">$ uvx ty check test.py

error[unsupported-operator]: Operator `|` is unsupported between objects of type `&lt;class 'int'&gt;` and `&lt;class 'str'&gt;`
 --&gt; test.py:4:5
  |
3 | A = Union[int, str]
4 | B = int | str
  |     ^^^^^^^^^
  |
info: rule `unsupported-operator` is enabled by default
</code></pre>
<h3>Version</h3>
<p>ty 0.0.1-alpha.5 and ty 0.0.1-alpha.5 (4ad13f211 2025-05-17)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-18 06:10</div>
            <div class="timeline-body"><p>Thank you for reporting this.</p>
<p>If you set the Python version to 3.10 or higher, this should not lead to an error.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/metaist">@metaist</a> on 2025-05-18 11:12</div>
            <div class="timeline-body"><p>Oh, right ðŸ¤¦</p>
<p><code>uvx --python 3.10 ty check test.py</code> didn't work, I now see the <code>--python-version</code> flag and the accompanying note</p>
<blockquote>
<p>ty will not infer the Python version from the Python environment at this time.</p>
</blockquote>
<p>Maybe a <code>hint</code> or some other helpful message like mypy's (see below):</p>
<blockquote>
<p><code>X | Y</code> syntax for unions requires running with <code>--python-version 3.10</code> or higher</p>
</blockquote>
<p>I also noticed that <code>ty</code> <em>doesn't</em> complain about <code>UnionType</code> in function definitions even without <code>from __future__ import annotations</code>.</p>
<pre><code class="language-python">def f(x: int|str) -&gt; None: ...
</code></pre>
<pre><code class="language-bash">$ uvx --python 3.9 mypy --strict test.py
test.py:1: error: X | Y syntax for unions requires Python 3.10  [syntax]
Found 1 error in 1 file (checked 1 source file)

$ uvx ty check --python-version 3.9 test.py
All checks passed!
</code></pre>
<pre><code class="language-python">from __future__ import annotations
def f(x: int|str) -&gt; None: ...
</code></pre>
<pre><code class="language-bash">$ uvx --python 3.9 mypy --strict test.py
Success: no issues found in 1 source file

$ uvx ty check --python-version 3.9 test.py
All checks passed!
</code></pre>
<p>Not  sure if this should be a separate issue, so I'll close this one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @metaist on 2025-05-18 11:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-19 08:06</div>
            <div class="timeline-body"><blockquote>
<p>Maybe a <code>hint</code> or some other helpful message like mypy's (see below):</p>
<blockquote>
<p><code>X | Y</code> syntax for unions requires running with <code>--python-version 3.10</code> or higher</p>
</blockquote>
</blockquote>
<p>I can very much relate, since I ran into the exact same thing a few hours before you posted this issue, and it also took me a bit to figure out what was going on. Reopening this so we can keep track of this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @sharkdp on 2025-05-19 08:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-19 08:09</div>
            <div class="timeline-body"><blockquote>
<p><code>uvx --python 3.10 ty check test.py</code> didn't work, I now see the <code>--python-version</code> flag and the accompanying note</p>
</blockquote>
<p>So close! ðŸ˜„</p>
<p>But seriously, I wonder if this should &quot;just work&quot;, or if we should at least attempt to detect this discrepancy somehow and emit a warning? Haven't thought through it though. There might be legitimate use cases where one would want to run <code>uvx --python 3.10 ty check</code> even though the target Python version is 3.9.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-19 08:20</div>
            <div class="timeline-body"><blockquote>
<p>I also noticed that <code>ty</code> <em>doesn't</em> complain about <code>UnionType</code> in function definitions even without <code>from __future__ import annotations</code>.</p>
<p>def f(x: int|str) -&gt; None: ...</p>
</blockquote>
<p>This is a false negative, yes. Since it leads to an error at runtime, I think we should try to catch this. It would be great if you could open a new issue for this â€” thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by @sharkdp on 2025-05-19 08:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/metaist">@metaist</a> on 2025-05-19 14:26</div>
            <div class="timeline-body"><blockquote>
<p>But seriously, I wonder if this should &quot;just work&quot;, or if we should at least attempt to detect this discrepancy somehow and emit a warning? Haven't thought through it though. There might be legitimate use cases where one would want to run <code>uvx --python 3.10 ty check</code> even though the target Python version is 3.9.</p>
</blockquote>
<p><code>uv</code> has made it so easy for me to switch between python versions that I often forget which version I have active in the venv at any given time so <code>uvx --python &lt;version&gt;</code> has been my way of &quot;forcing&quot; a specific version when I really care.</p>
<p>So for <code>ty</code> my mental model is &quot;use the active python version, unless I override with --python-version&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Support PEP 604 UnionTypes" to "More helpful diagnostic when trying to use PEP 604 union types before 3.10" by @sharkdp on 2025-05-19 14:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-05-19 15:48</div>
            <div class="timeline-body"><p>I think our fallback default for Python version is 3.13? So if you were getting 3.9 that implies you have a <code>pyproject.toml</code> which specifies that as your lower bound Python version? Is that correct?</p>
<p>I think it's plausible that we might add a fallback to whatever Python is on your shell path (which I think is the feature being discussed here), but it seems unlikely to me that we would give that priority over what's in the <code>pyproject.toml</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/metaist">@metaist</a> on 2025-05-19 16:13</div>
            <div class="timeline-body"><p>@carljm Yes, in my original issue I submitted I was working in a context with a <code>pyproject.toml</code> that has a lower bound of Python 3.9.</p>
<p>While both <code>mypy</code> and <code>pyright</code> look at the Python on the shell path for their default version, I do appreciate the idea of having <code>pyproject.toml</code> take priority where the implication is something like &quot;this code should satisfies type checks for all versions of python you claim to support in your <code>pyproject.toml</code>&quot;.</p>
<p>This will impact my CI flow (which changes up the python version and re-runs all the linters/type checkers), but I'd learn to mentally rewrite: <code>uvx --python 3.9 ty check</code> to <code>uvx ty check --python-version 3.9</code> (and both <code>mypy</code> and <code>pyright</code> support equivalent <code>--python-version</code> flags).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-19 16:20</div>
            <div class="timeline-body"><blockquote>
<p>This will impact my CI flow (which changes up the python version and re-runs all the linters/type checkers), but I'd learn to mentally rewrite: uvx --python 3.9 ty check to uvx ty check --python-version 3.9 (and both mypy and pyright support equivalent --python-version flags).</p>
</blockquote>
<p>What I have in mind for this use case is to distinguish between the lowest supported python version (which is what you specify with <code>requires-python</code>) and the version you currently check against.</p>
<p>The lowest supported Python version would be used for syntax errors. The <em>current</em> Python version would be used for resolving types (would it type check when using Python XX). The current python verison could be inferred from the current used Python version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-19 16:54</div>
            <div class="timeline-body"><blockquote>
<p>What I have in mind for this use case is to distinguish between the lowest supported python version (which is what you specify with <code>requires-python</code>) and the version you currently check against.</p>
<p>The lowest supported Python version would be used for syntax errors. The <em>current</em> Python version would be used for resolving types (would it type check when using Python XX). The current python verison could be inferred from the current used Python version.</p>
</blockquote>
<p>I don't agree that this is a useful distinction for type checking. If my project supports Python 3.8, I want to know that it's going to work on Python 3.8 even if I'm using Python 3.13 for local development. Whether it's a syntax error or a type error doesn't make much difference here: if type checking fails on Python 3.8, that means that ty can't confirm that my code will run without error on Python 3.8, which is something I'd want to know about.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-05-19 17:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:19:55 UTC
    </footer>
</body>
</html>
