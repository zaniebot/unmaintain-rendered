<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Specialized typevars are wrongly considered still generic for variance inference - astral-sh/ty #1459</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Specialized typevars are wrongly considered still generic for variance inference</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1459">#1459</a>
        opened by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a>
        on 2025-10-30 23:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on 2025-10-30 23:53</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Hopefully I understand variance enough for this.</p>
<p>A type being given to <code>self</code> in a method should not affect the variance of a class generic. Even if there is some reason I don't know about why it should, then since both covariance and contravariance are affected bivariance should be too,</p>
<p>https://play.ty.dev/37f6360e-1d6d-42f7-9551-6f7cd441efae</p>
<pre><code class="language-py">from ty_extensions import static_assert, is_subtype_of

class Bivariant[T]:
    def uses_int_self(self: Bivariant[int]):
        ...

static_assert(is_subtype_of(Bivariant[int], Bivariant[object]))
static_assert(is_subtype_of(Bivariant[object], Bivariant[int]))

class Covariant[T]:
    def make_cls_covariant(self) -&gt; T:
        raise NotImplemented

    def uses_int_self(self: Covariant[int]):
        ...

# Should not raise?
static_assert(is_subtype_of(Covariant[int], Covariant[object]))

class Contravariant[T]:
    def make_cls_contravariant(self, value: T):
        raise NotImplemented

    def uses_int_self(self: Contravariant[int]):
        ...

# Should not raise?
static_assert(is_subtype_of(Contravariant[object], Contravariant[int]))
</code></pre>
<h3>Version</h3>
<p>playground (3be3a10a2)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-10-31 18:27</div>
            <div class="timeline-body"><p>Thanks for the report! Yes, I think you are correct. I don't think this is actually related to <code>self</code> annotations, either. This method should also not affect variance inference, but it currently does in ty:</p>
<pre><code class="language-py">    def uses_other(self, other: Covariant[int]): ...
</code></pre>
<p>So I think the root cause is that typevars which are &quot;specialized away&quot; should be ignored in variance inference, but we currently don't ignore them. Our internal representation of <code>Covariant[int]</code> includes the typevar, but <code>Covariant[int]</code> is not a generic type: for variance inference purposes it should not be considered to include the typevar at all. (I haven't verified this with code exploration, it's just my intuition of what is probably wrong.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @carljm on 2025-10-31 18:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">generics</span> added by @carljm on 2025-10-31 18:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Adding a self type to co/contra variant class methods makes them invariant" to "Specialized typevars are wrongly considered still generic for variance inference" by @carljm on 2025-10-31 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "GA" by @carljm on 2025-10-31 18:28</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 02:11:38 UTC
    </footer>
</body>
</html>
