<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>os.path functions get wrong type assignments. - astral-sh/ty #405</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>os.path functions get wrong type assignments.</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/405">#405</a>
        opened by <a href="https://github.com/Michallote">@Michallote</a>
        on 2025-05-15 09:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Michallote">@Michallote</a></div>
            <div class="timeline-body">Summary
<p>Minimum code fail:</p>
<pre><code>#fail.py
import os

def get_rel(output_directory: str) -&gt; str:
    assert os.path.exists(
        output_directory
    ), f&quot;Output directory &#x27;{output_directory}&#x27; does not exist. Create the folder and try again.&quot;
    output_directory = os.path.relpath(output_directory)
    return output_directory
</code></pre>
<p>And running in the terminal:</p>
<pre><code>$ uvx ty check fail.py
WARN ty is pre-release software and not ready for production use. Expect to encounter bugs, missing features, and fatal errors.
error[invalid-assignment]: Object of type `bytes` is not assignable to `str`
  --&gt; fail.py:9:5
   |
 7 |         output_directory
 8 |     ), f&quot;Output directory &#x27;{output_directory}&#x27; does not exist. Create the folder and try again.&quot;
 9 |     output_directory = os.path.relpath(output_directory)
   |     ^^^^^^^^^^^^^^^^
10 |     return output_directory
   |
info: rule `invalid-assignment` is enabled by default

Found 1 diagnostic
</code></pre>
<p>commenting os.path.exists does not change the outcome.</p>
Version
<p>ty 0.0.1-alpha.2</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-15 09:44</div>
            <div class="timeline-body"><p>Playground: https://play.ty.dev/79aa2c89-ec65-438f-91e6-81d9a6341275</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-15 11:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">Protocols</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-15 11:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">Protocols</span> removed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-15 11:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-15 11:32</div>
            <div class="timeline-body"><p>Thank you for reporting this. <code>os.path.relpath</code> is overloaded in typeshed:</p>
<pre><code>@overload
def relpath(path: LiteralString, start: LiteralString | None = None) -&gt; LiteralString: ...
@overload
def relpath(path: BytesPath, start: BytesPath | None = None) -&gt; bytes: ...
@overload
def relpath(path: StrPath, start: StrPath | None = None) -&gt; str: ...
</code></pre>
<p>We mistakenly use the second overload here which returns <code>bytes</code>. The reason we do this is that we don&#x27;t understand the <code>BytesPath</code> type alias yet (since it&#x27;s a <code>typing.TypeAlias</code> alias, not a PEP 695 <code>type</code> alias):</p>
<pre><code>BytesPath: TypeAlias = bytes | PathLike[bytes]
</code></pre>
<p>see <a href="https://github.com/astral-sh/ty/issues/221">astral-sh/ty#221</a> which keeps track of our type alias support.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Michallote">@Michallote</a> on 2025-05-15 15:58</div>
            <div class="timeline-body"><p>But the operation overloading should return StrPath if my input is typed as a string no? Or the BytesPath makes an union with str too therefore defaulting to it first as it doesn&#x27;t check the last one?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jelle-openai">@jelle-openai</a> on 2025-05-15 16:31</div>
            <div class="timeline-body"><p>Because ty doesn&#x27;t understand <code>TypeAlias</code>, it treats both <code>BytesPath</code> and <code>StrPath</code> as essentially Any and picks the first one that matches.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-06 15:55</div>
            <div class="timeline-body"><p>Thanks again for the report! I&#x27;m closing this in favour of <a href="https://github.com/astral-sh/ty/issues/544">astral-sh/ty#544</a>, since the fix for this will just be to implement #544</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-06 15:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-12 01:38</div>
            <div class="timeline-body"><p>Confirmed that this is fixed by <a href="https://github.com/astral-sh/ruff/pull/21394">astral-sh/ruff#21394</a></p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:24:31 UTC
    </footer>
</body>
</html>
