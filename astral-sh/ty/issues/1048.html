<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BUG: false positive in `df.attrs.update()` - astral-sh/ty #1048</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>BUG: false positive in `df.attrs.update()`</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1048">#1048</a>
        opened by <a href="https://github.com/janosh">@janosh</a>
        on 2025-08-19 06:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/janosh">@janosh</a> on 2025-08-19 06:12</div>
            <div class="timeline-body"><h3>Summary</h3>
<pre><code class="language-python"># ty-pandas-attrs.py
import pandas as pd

df = pd.DataFrame({&quot;A&quot;: [1, 2, 3], &quot;B&quot;: [4, 5, 6]})
df.attrs.update(name=&quot;dummy&quot;, foo=&quot;bar&quot;) # &lt;-- type error here
</code></pre>
<p><code>ty 0.0.1-alpha.18 (d697cc092 2025-08-14)</code> raises a type error:</p>
<blockquote>
<p>Argument to bound method <code>update</code> is incorrect: Expected <code>Mapping[str, Any]</code>, found <code>dict[Hashable, Any]</code>tyinvalid-argument-type</p>
</blockquote>
<h3>Expected Behavior</h3>
<p>changing to</p>
<pre><code class="language-diff">- df.attrs.update(name=&quot;dummy&quot;, foo=&quot;bar&quot;)
+ df.attrs.update({&quot;name&quot;: &quot;dummy&quot;, &quot;foo&quot;: &quot;bar&quot;})
</code></pre>
<p>resolves the type error. both work at run time and i'd expect both to type check fine</p>
<p>first reported in https://github.com/pandas-dev/pandas/issues/62140</p>
<h3>Version</h3>
<p>ty 0.0.1-alpha.18 (d697cc092 2025-08-14)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-08-19 16:43</div>
            <div class="timeline-body"><p>Thank your for the (very nicely minimized) report!</p>
<p>Pandas <a href="https://github.com/pandas-dev/pandas/blob/main/pandas/core/generic.py#L317">types <code>DataFrame::attrs</code> as <code>dict[Hashable, Any]</code></a>. The typeshed definition for <code>MutableMapping::update</code> (inherited by <code>dict</code>) has <a href="https://github.com/python/typeshed/blob/main/stdlib/typing.pyi#L810">one overload</a> that accepts <code>**kwargs</code>, and that overload requires that <code>self</code> be of type <code>Mapping[str, _VT]</code> -- that is, its keys must be strings. A <code>dict</code> with key type <code>Hashable</code> is not assignable to a <code>Mapping</code> with key type <code>str</code>, so this overload fails to match the call.</p>
<p>It feels like the type of <code>self</code> on that <code>**kwargs</code> overload for <code>update</code> could be less strict somehow, but it's not clear exactly how. It does need to be a mapping for which strings are valid keys; it doesn't need to be a mapping whose keys are <em>all</em> strings. The underlying issue here is that in this particular case we'd prefer the key type to behave contravariantly, but dictionaries (and mutable mappings generally) are invariant in their key type (which is required for their soundness generally, but not in a way that impacts this particular example.)</p>
<p>So ultimately I think this type error is correct, given the type system specification and the type information currently provided by pandas and the standard library. (Of course, it can still be a false positive relative to runtime behavior, but the fix for that will need to be in the type spec, or in typeshed, or in pandas / pandas-stubs, not just in ty.) Mypy and pyright both also give versions of exactly the same error on the same code snippet.</p>
<p>Off the top of my head I am not sure exactly what would be a good fix here; it may be something worth raising as a question in the Typing section of discuss.python.org. If in practice dataframe attrs all have string keys, then tightening the type annotation on <code>DataFrame::attrs</code> to <code>dict[str, Any]</code> would be the simplest fix.</p>
<p>Closing this as I don't think this is actionable for ty, but we will certainly update if there's a broader consensus of type checkers that this case should be handled differently somehow.</p>
<p>Thanks again for the great report!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-08-19 16:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-19 16:53</div>
            <div class="timeline-body"><blockquote>
<p>It feels like the type of <code>self</code> on that <code>**kwargs</code> overload for <code>update</code> could be less strict somehow, but it's not clear exactly how. It does need to be a mapping for which strings are valid keys; it doesn't need to be a mapping whose keys are <em>all</em> strings.</p>
</blockquote>
<p>hmmm, this patch makes our error go away? I can see about making a typeshed PR</p>
<pre><code class="language-diff">diff --git a/crates/ty_vendored/vendor/typeshed/stdlib/typing.pyi b/crates/ty_vendored/vendor/typeshed/stdlib/typing.pyi
index 90743a7cc3..f926428414 100644
--- a/crates/ty_vendored/vendor/typeshed/stdlib/typing.pyi
+++ b/crates/ty_vendored/vendor/typeshed/stdlib/typing.pyi
@@ -1319,13 +1319,13 @@ class MutableMapping(Mapping[_KT, _VT]):
         &quot;&quot;&quot;
 
     @overload
-    def update(self: Mapping[str, _VT], m: SupportsKeysAndGetItem[str, _VT], /, **kwargs: _VT) -&gt; None: ...
+    def update(self: SupportsKeysAndGetItem[str, _VT], m: SupportsKeysAndGetItem[str, _VT], /, **kwargs: _VT) -&gt; None: ...
     @overload
     def update(self, m: Iterable[tuple[_KT, _VT]], /) -&gt; None: ...
     @overload
-    def update(self: Mapping[str, _VT], m: Iterable[tuple[str, _VT]], /, **kwargs: _VT) -&gt; None: ...
+    def update(self: SupportsKeysAndGetItem[str, _VT], m: Iterable[tuple[str, _VT]], /, **kwargs: _VT) -&gt; None: ...
     @overload
-    def update(self: Mapping[str, _VT], **kwargs: _VT) -&gt; None: ...
+    def update(self: SupportsKeysAndGetItem[str, _VT], **kwargs: _VT) -&gt; None: ...
 
 Text = str
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-19 17:17</div>
            <div class="timeline-body"><p>hmm, it's not quite so simple. The ty error only goes away if I make that change because we're missing some protocol features; mypy still doesn't like the code in the original snippet even with that change to typeshed. The reason is that even <code>SupportsKeysAndGetItem</code> is invariant in its first type parameter. ~~(I'm not totally sure it needs to be, though?)~~ Edit, yeah, it obviously does need to be.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-19 17:23</div>
            <div class="timeline-body"><p><em>this</em> seems to make even mypy happy with the original snippet, however: at last, a protocol with a contravariant parameter for the key type!</p>
<pre><code class="language-diff">diff --git a/crates/ty_vendored/vendor/typeshed/stdlib/typing.pyi b/crates/ty_vendored/vendor/typeshed/stdlib/typing.pyi
index 90743a7cc3..10ed9dc525 100644
--- a/crates/ty_vendored/vendor/typeshed/stdlib/typing.pyi
+++ b/crates/ty_vendored/vendor/typeshed/stdlib/typing.pyi
@@ -25,7 +25,7 @@ import collections  # noqa: F401  # pyright: ignore[reportUnusedImport]
 import sys
 import typing_extensions
 from _collections_abc import dict_items, dict_keys, dict_values
-from _typeshed import IdentityFunction, ReadableBuffer, SupportsKeysAndGetItem
+from _typeshed import IdentityFunction, ReadableBuffer, SupportsGetItem, SupportsKeysAndGetItem
 from abc import ABCMeta, abstractmethod
 from re import Match as Match, Pattern as Pattern
 from types import (
@@ -1319,13 +1319,13 @@ class MutableMapping(Mapping[_KT, _VT]):
         &quot;&quot;&quot;
 
     @overload
-    def update(self: Mapping[str, _VT], m: SupportsKeysAndGetItem[str, _VT], /, **kwargs: _VT) -&gt; None: ...
+    def update(self: SupportsGetItem[str, _VT], m: SupportsKeysAndGetItem[str, _VT], /, **kwargs: _VT) -&gt; None: ...
     @overload
     def update(self, m: Iterable[tuple[_KT, _VT]], /) -&gt; None: ...
     @overload
-    def update(self: Mapping[str, _VT], m: Iterable[tuple[str, _VT]], /, **kwargs: _VT) -&gt; None: ...
+    def update(self: SupportsGetItem[str, _VT], m: Iterable[tuple[str, _VT]], /, **kwargs: _VT) -&gt; None: ...
     @overload
-    def update(self: Mapping[str, _VT], **kwargs: _VT) -&gt; None: ...
+    def update(self: SupportsGetItem[str, _VT], **kwargs: _VT) -&gt; None: ...
 
 Text = str
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-19 17:45</div>
            <div class="timeline-body"><p>The stubs were actually changed very recently in typeshed here (I merged the change during pycon only a few months ago!) https://github.com/python/typeshed/pull/14099</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-19 17:52</div>
            <div class="timeline-body"><p>trying out a typeshed change here: https://github.com/python/typeshed/pull/14593</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-19 19:07</div>
            <div class="timeline-body"><blockquote>
<p>trying out a typeshed change here: <a href="https://github.com/python/typeshed/pull/14593">python/typeshed#14593</a></p>
</blockquote>
<p>Now merged -- thanks for the report @janosh! We'll pick up the change in our next automated typeshed sync.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/janosh">@janosh</a> on 2025-08-20 12:55</div>
            <div class="timeline-body"><p>@AlexWaygood wonderful, thanks for the quick fix! really enjoying <code>ty</code>. i've been hoping astral does a type checker for well over a year and it definitely delivers :)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 02:11:25 UTC
    </footer>
</body>
</html>
