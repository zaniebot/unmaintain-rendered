<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ty fails to lookup relative imports if the relative path from the nearest import root includes an invalid module name - astral-sh/ty #839</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ty fails to lookup relative imports if the relative path from the nearest import root includes an invalid module name</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/839">#839</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-07-17 12:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><p>Langchain has an <a href="https://github.com/langchain-ai/langchain/blob/491f63ca82806a98b18f785d0d315e7f5d8de29f/libs/standard-tests/langchain_tests/unit_tests/__init__.py#L21"><code>__init__.py</code></a> with the following content</p>
<pre><code># ruff: noqa: E402
import pytest

# Rewrite assert statements for test suite so that implementations can
# see the full error message from failed asserts.
# https://docs.pytest.org/en/7.1.x/how-to/writing_plugins.html#assertion-rewriting
modules = [
    &quot;chat_models&quot;,
    &quot;embeddings&quot;,
    &quot;tools&quot;,
]

for module in modules:
    pytest.register_assert_rewrite(f&quot;langchain_tests.unit_tests.{module}&quot;)

from .chat_models import ChatModelUnitTests
from .embeddings import EmbeddingsUnitTests
from .tools import ToolsUnitTests

__all__ = [&quot;ChatModelUnitTests&quot;, &quot;EmbeddingsUnitTests&quot;, &quot;ToolsUnitTests&quot;]
</code></pre>
<p>ty fails to resolve the relative imports <code>chat_models</code>, <code>embeddings</code> and <code>.tools</code> even though those files clearly exist. Pyright seems fine with the import.</p>
<p>The issue seems to be that <code>file_to_module</code> fails because the relative path to the search root (which is the project root) <code>libs/standard-tests/langchain_tests/unit_tests/teswt.py</code> can&#x27;t be turned into a valid module name because of the <code>standard-tests</code>.</p>
<p>A solution here is to add <code>standard-tests</code> to the search path but having to do this is at least confusing in an LSP setup (where ty should just work out of the box)</p>
<p><a href="https://play.ty.dev/d35224bf-eb57-47c3-8877-e4a4175702dc">Playground</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">imports</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-17 12:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;ty fails to lookup relative imports even if they clearly exist in the parent directory&quot; to &quot;ty fails to lookup relative imports if the relative path from the nearest import root includes an invalid module name&quot; by <a href="https://github.com/carljm">@carljm</a> on 2025-07-18 19:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-22 12:43</div>
            <div class="timeline-body"><p>An alterntive here is to make <code>file_to_module</code> less strict. Instead, it tries to walk up the directory chain until it finds no <code>__init__.py</code> and uses that as the module name. The behavior would remain unchagned if there&#x27;s no <code>__init__.py</code> (namespace package).</p>
<p>This would also help in the case where a user opens a source definition for a stub file. <code>resolve_module</code> will always return the stub file, making <code>file_to_module</code> return <code>None</code> for the source module. CC: @Gankra</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-14 09:12</div>
            <div class="timeline-body"><p>Relative imports also fail if the module uses a name that isn&#x27;t a valid Python identifier, see <a href="https://github.com/astral-sh/ty/issues/1529">astral-sh/ty#1529</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Stable&quot; by <a href="https://github.com/carljm">@carljm</a> on 2025-11-14 17:38</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:25:05 UTC
    </footer>
</body>
</html>
