<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Concatenate special form - astral-sh/ty #1535</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Support Concatenate special form</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1535">#1535</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-11-12 23:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><p>https://typing.python.org/en/latest/spec/generics.html#paramspec</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Stable&quot; by <a href="https://github.com/carljm">@carljm</a> on 2025-11-12 23:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/carljm">@carljm</a> on 2025-11-12 23:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">typing semantics</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-11-13 10:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/vlashada">@vlashada</a> on 2025-12-14 08:54</div>
            <div class="timeline-body"><p><code>ty</code> fails to infer the return type (<code>T</code>) for a generic method whose first parameter is a callable typed with <code>Callable[Concatenate[SelfType, P], T]</code>. In practice this shows up in <code>polars.DataFrame.pipe</code>, where <code>reveal_type(df.pipe(f))</code> becomes <code>Unknown</code> even when <code>f</code> is fully annotated to return <code>DataFrame</code>.</p>
<p>Polars documents <code>DataFrame.pipe</code> as:</p>
<pre><code>DataFrame.pipe(
    function: Callable[Concatenate[DataFrame, P], T],
    *args: P.args,
    **kwargs: P.kwargs,
) -&gt; T
</code></pre>
Reproduction (no third-party deps)
<p>https://play.ty.dev/60c9407f-0310-4b4e-b078-fba3d381f132</p>
<pre><code>from typing import Callable, Concatenate, ParamSpec, TypeVar, reveal_type

P = ParamSpec(&quot;P&quot;)
T = TypeVar(&quot;T&quot;)

class DF:
    def pipe(self, function: Callable[Concatenate[&quot;DF&quot;, P], T], *args: P.args, **kwargs: P.kwargs) -&gt; T:
        return function(self, *args, **kwargs)

def f(df: DF) -&gt; DF:
    return df

reveal_type(DF())          # expected: DF
reveal_type(DF().pipe(f))  # expected: DF; actual (ty): Unknown
</code></pre>
Reproduction (real-world: Polars)
<pre><code>import polars as pl
from typing import reveal_type

def f(df: pl.DataFrame) -&gt; pl.DataFrame:
    return df

reveal_type(pl.DataFrame())          # expected: DataFrame
reveal_type(pl.DataFrame().pipe(f))  # expected: DataFrame; actual (ty): Unknown
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-12-15 05:37</div>
            <div class="timeline-body"><p>@vlashada Thanks for the report. The issue that you&#x27;re highlighting is actually <a href="https://github.com/astral-sh/ruff/pull/21551">astral-sh/ruff#21551</a>. I tried out your example (the &quot;no third-party deps&quot; one) and it works:</p>
<pre><code>info[revealed-type]: Revealed type
  --&gt; /Users/dhruv/playground/ty/bug-report/main.py:21:13
   |
21 | reveal_type(DF())  # expected: DF
   |             ^^^^ `DF`
22 | reveal_type(DF().pipe(f))  # expected: DF; actual (ty): Unknown
   |

info[revealed-type]: Revealed type
  --&gt; /Users/dhruv/playground/ty/bug-report/main.py:22:13
   |
21 | reveal_type(DF())  # expected: DF
22 | reveal_type(DF().pipe(f))  # expected: DF; actual (ty): Unknown
   |             ^^^^^^^^^^^^ `DF`
   |

Found 2 diagnostics
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-12-15 09:05</div>
            <div class="timeline-body"><p>Related to <a href="https://github.com/astral-sh/ruff/pull/21958">astral-sh/ruff#21958</a>, it might be useful to try modeling <code>classmethod</code> using typeshed&#x27;s definition once <code>Concatenate</code> support has landed because it&#x27;s used to define the callable type as <code>Callable[Concatenate[type[_T], _P], _R_co]</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-15 19:35</div>
            <div class="timeline-body"><p>After looking more at classmethod recently for <a href="https://github.com/astral-sh/ruff/pull/21958">astral-sh/ruff#21958</a>, I am skeptical that we will be able to implement classmethod support solely using the typeshed definition -- but I suspect we could use it more than we do today.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:25:57 UTC
    </footer>
</body>
</html>
