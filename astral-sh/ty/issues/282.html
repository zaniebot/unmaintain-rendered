<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ty does not respect workspace-level `experimental.completions.enable` - astral-sh/ty #282</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ty does not respect workspace-level <code>experimental.completions.enable</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/282">#282</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2025-05-08 18:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a></div>
            <div class="timeline-body"><p>Steps to reproduce:</p>
<ul>
<li>Install ty's VS Code extension.</li>
<li>In the workspace-level <code>.vscode/settings.json</code>, set <code>ty.experimental.completions.enable</code> to <code>true</code>.</li>
<li>Try to trigger completion in a Python file.</li>
</ul>
<p>Here's the relevant part of the <code>initialize</code> request:</p>
<pre><code class="language-json5">{
    ...,
    &quot;initializationOptions&quot;: {
        &quot;settings&quot;: [
            { ..., &quot;experimental&quot;: { &quot;completions&quot;: { &quot;enable&quot;: true } } }
        ],
        &quot;globalSettings&quot;: { ... }
    },
	...
}
</code></pre>
<p>And here's the full response (note that there's no <code>completionProvider</code>):</p>
<pre><code class="language-json5">Result: {
    &quot;capabilities&quot;: {
        &quot;diagnosticProvider&quot;: {
            &quot;identifier&quot;: &quot;ty&quot;,
            &quot;interFileDependencies&quot;: true,
            &quot;workspaceDiagnostics&quot;: false
        },
        &quot;hoverProvider&quot;: true,
        &quot;inlayHintProvider&quot;: {},
        &quot;positionEncoding&quot;: &quot;utf-16&quot;,
        &quot;textDocumentSync&quot;: {
            &quot;change&quot;: 2,
            &quot;openClose&quot;: true
        },
        &quot;typeDefinitionProvider&quot;: true
    },
    &quot;serverInfo&quot;: {
        &quot;name&quot;: &quot;ty&quot;,
        &quot;version&quot;: &quot;0.0.0&quot;
    }
}
</code></pre>
<p>This happens because ty is hardcoded to <a href="https://github.com/astral-sh/ruff/blob/981bd70d393fe29324c07c3ffce5ecddd40e6bd6/crates/ty_server/src/server.rs#L57-L58">check for this setting under <code>globalSettings</code></a>:</p>
<pre><code class="language-rust">let server_capabilities =
    Self::server_capabilities(position_encoding, global_settings.experimental.as_ref());
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-05-08 18:19</div>
            <div class="timeline-body"><p>I'd even argue that the <code>settings</code>/<code>globalSettings</code> structure is specific to VS Code and ty should not assume it, if only for the sake of other clients.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @AlexWaygood on 2025-05-08 19:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-08 19:22</div>
            <div class="timeline-body"><p>What do you think we should change with the settings structure?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-05-08 22:10</div>
            <div class="timeline-body"><p>I think ty should use <a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#workspace_configuration"><code>workspace/configuration</code></a> instead. <code>initializationOptions</code> has <a href="https://github.com/microsoft/language-server-protocol/issues/567">vague semantics</a> and is therefore <a href="https://github.com/microsoft/language-server-protocol/issues/567#issuecomment-448538082">not recommended</a>. For reference, Pyright does this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-05-14 16:10</div>
            <div class="timeline-body"><blockquote>
<p>I think ty should use <a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#workspace_configuration"><code>workspace/configuration</code></a> instead. <code>initializationOptions</code> has <a href="https://github.com/microsoft/language-server-protocol/issues/567">vague semantics</a> and is therefore <a href="https://github.com/microsoft/language-server-protocol/issues/567#issuecomment-448538082">not recommended</a>.</p>
</blockquote>
<p>Yeah, I've been thinking about this lately. I agree that the server should pull the configuration instead of relying on initialization options. This would be especially important with ty because currently the <a href="https://github.com/astral-sh/ty-vscode/blob/f4c1f5707e5965533a2239772d6e8dbf954a5475/src/extension.ts#L99-L103">VS Code extension restarts the server</a> every time a client config is updated and that would mean re-indexing the project which could be expensive for large projects.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-05-14 16:22</div>
            <div class="timeline-body"><p>Also, currently, the ty language server doesn't have support for multiple workspaces so the server only stores settings for a single workspace and cannot handle if some settings are configured at a workspace level.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-06-25 09:53</div>
            <div class="timeline-body"><p>This setting has been removed in <a href="https://github.com/astral-sh/ty/releases/tag/0.0.1-alpha.11">0.0.1-alpha.11</a> but the <code>python.ty.disableLanguageServices</code> has a similar issue and I'll be taking this up holistically when working on https://github.com/astral-sh/ty/issues/82. So, I'll mark this issue as resolved as there's nothing to be done here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2025-06-25 09:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">completions</span> added by @AlexWaygood on 2025-10-03 12:20</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:19:48 UTC
    </footer>
</body>
</html>
