<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Narrowing of `int | Sequence[str]` with `isinstance(Sequence)` is not Sequence[str] - astral-sh/ty #2493</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Narrowing of <code>int | Sequence[str]</code> with <code>isinstance(Sequence)</code> is not Sequence[str]</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/2493">#2493</a>
        opened by <a href="https://github.com/henriquegemignani">@henriquegemignani</a>
        on 2026-01-14 14:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/henriquegemignani">@henriquegemignani</a></div>
            <div class="timeline-body">Summary
<p>Playground: https://play.ty.dev/6143bcb7-6aa9-405d-ba62-33a4ea7e764d</p>
<p>Code:</p>
<pre><code>from collections.abc import Sequence

type JsonType_RO = int | Sequence[str]


def encode_a(value: JsonType_RO) -&gt; None:
    if isinstance(value, Sequence):
        sequence_value: Sequence[str] = value

def encode_b(value: JsonType_RO) -&gt; None:
    if isinstance(value, Sequence[str]):
        sequence_value: Sequence[str] = value
</code></pre>
<p>Errors:</p>
<pre><code>Object of type `(int &amp; Sequence[object]) | Sequence[str]` is not assignable to `Sequence[str]` (invalid-assignment) [Ln 8, Col 41]
Object of type `JsonType_RO` is not assignable to `Sequence[str]` (invalid-assignment) [Ln 12, Col 41]
</code></pre>
<p>The main case is <code>encode_a</code>. I&#x27;d expect <code>value</code> to be narrowed to <code>Sequence[str]</code>, but that&#x27;s not the case. As far as I could find, that should be valid typing. I tried to find some related issue, but no luck with search.</p>
<p><code>encode_b</code> is just an attempt to investigate further, but it&#x27;s interesting how that causes ty to not narrow at all.</p>
Version
<p>ty 0.0.11 (830cb9cc6 2026-01-09)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-14 14:33</div>
            <div class="timeline-body"><p>Thanks! This is basically the same as #1578. ty is warning you here that it&#x27;s entirely possible for an object to be an instance of both <code>int</code> and <code>Sequence</code> simultaneously: they&#x27;re not disjoint types:</p>
<pre><code>&gt;&gt;&gt; from typing import Sequence
&gt;&gt;&gt; class Foo(int, Sequence): ...
... 
&gt;&gt;&gt;
</code></pre>
<p>You can fix the diagnostic here by using <code>if not isinstance(value, int)</code> instead of <code>if isinstance(value, Sequence)</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-14 14:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henriquegemignani">@henriquegemignani</a> on 2026-01-14 15:13</div>
            <div class="timeline-body"><p>Is there a way to annotate that such subclass of <code>int</code> is not allowed? In the actual use in my code base it does already <code>if isinstance(value, int)</code>, but the actual type is <code>int | Mapping[str, JsonType_RO] | Sequence[JsonType_RO]</code> and adding a <code>not isinstance(value, Mapping)</code> doesn&#x27;t work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-14 15:23</div>
            <div class="timeline-body"><blockquote>
<p>Is there a way to annotate that such subclass of <code>int</code> is not allowed?</p>
</blockquote>
<p>No, Python&#x27;s type system doesn&#x27;t currently support a way to annotate &quot;exact types&quot;, and we don&#x27;t have any extensions to the type system for that currently in ty. Such types would unfortunately not be very useful unless you used them <em>everywhere</em>, but in most cases it isn&#x27;t desirable to distinguish between &quot;any instance of <code>T</code>&quot;, and &quot;any object that is an instance of <em>exactly</em> <code>T</code>&quot;. So I think the use cases for types like this would actually turn out to be pretty limited, unfortunately.</p>
<p>If you&#x27;re willing to use the <code>ty_extensions</code> module, you could do something like this:</p>
<pre><code>from ty_extensions import Intersection, Not
from collections.abc import Sequence

type JsonType_RO = Intersection[int, Not[Sequence[object]]] | Sequence[str]


def encode_a(value: JsonType_RO) -&gt; None:
    if isinstance(value, Sequence):
        sequence_value: Sequence[str] = value
</code></pre>
<p>But note that the ty_extensions module doesn&#x27;t actually exist at runtime right now; you need to import it in an <code>if TYPE_CHECKING</code> block if you want to use it in a <code>.py</code> file.</p>
<p>I&#x27;m curious to know more about this, though:</p>
<blockquote>
<p>adding a <code>not isinstance(value, Mapping)</code> doesn&#x27;t work.</p>
</blockquote>
<p>Why doesn&#x27;t that work in this case for you? Can you give another minimal example? :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henriquegemignani">@henriquegemignani</a> on 2026-01-14 16:00</div>
            <div class="timeline-body"><blockquote>
<p>Why doesn&#x27;t that work in this case for you? Can you give another minimal example? :-)</p>
</blockquote>
<p>Funnily enough in my actual code-base doing this worked, but I&#x27;m not sure why it doesn&#x27;t in the minimal example. https://play.ty.dev/a28ea65f-d286-4653-9f32-ea2c5398488c</p>
<p>Edit: because I forgot an <code>else</code>...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2026-01-14 16:12</div>
            <div class="timeline-body"><p>I think the working version can even be simplified a bit more:</p>
<pre><code>from collections.abc import Sequence, Mapping

type JsonObject_RO = Mapping[str, &quot;JsonType_RO&quot;]
type JsonType_RO = int | JsonObject_RO | Sequence[&quot;JsonType_RO&quot;]


def encode_json_value(value: JsonType_RO) -&gt; None:
    if isinstance(value, int):
        int_value: int = value

    elif not isinstance(value, Mapping):
        sequence_value: Sequence[JsonType_RO] = value

    elif not isinstance(value, Sequence):
        mapping_value: JsonObject_RO = value

    else:
        raise RuntimeError()
</code></pre>
<p>https://play.ty.dev/8bb7aa29-e0f6-43b0-aefc-1958933ec6b5</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:27:07 UTC
    </footer>
</body>
</html>
