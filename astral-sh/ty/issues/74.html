<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>make code completions an experimental opt-in before the alpha release - astral-sh/ty #74</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>make code completions an experimental opt-in before the alpha release</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/74">#74</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2025-05-01 12:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><pre><code>          We could do something similar to what r-a does with their &quot;experimental&quot; capabilities which requires explicit opt-in from client side. Refer to the first paragraph in https://github.com/rust-lang/rust-analyzer/blob/master/docs/book/src/contributing/lsp-extensions.md#lsp-extensions:</code></pre>
<blockquote>
<p>All capabilities are enabled via the experimental field of <code>ClientCapabilities</code> or <code>ServerCapabilities</code>.</p>
</blockquote>
<p>Specifically, <a href="https://github.com/rust-lang/rust-analyzer/blob/5d66d45005fef79751294419ab9a9fa304dfdf5c/editors/code/src/client.ts#L290-L330">here</a> they send the capabilities that the VS Code extension supports.</p>
<p>So, for us it could look like below which would be sent when during the server initialization process:</p>
<pre><code>&quot;capabilities&quot;: {
	&quot;experimental&quot;: {
		&quot;completions&quot;: {
			&quot;enabled&quot;: true
		}
	}
} 
</code></pre>
<p><em>Originally posted by @dhruvmanila in <a href="https://github.com/astral-sh/ruff/issues/17744">astral-sh/ruff#17744</a>#issuecomment-2843213742</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-05-01 12:34</div>
            <div class="timeline-body"><p>Specifically motivated by <a href="https://github.com/astral-sh/ruff/pull/17744">astral-sh/ruff#17744</a>#pullrequestreview-2808094461, where it&#x27;s probably a good idea to <em>not</em> have code completion until it means some minimal standard of quality. In astral-sh/ruff#17744, I just built a very small end-to-end MVP to make completions actually work via LSP.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-05-01 12:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-01 12:37</div>
            <div class="timeline-body"><p>At least, before the LSP alpha, which might not be part of the initial CLI</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-06 07:02</div>
            <div class="timeline-body"><p>CC: @charliermarsh in case you&#x27;re interested in taking this on</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-06 12:32</div>
            <div class="timeline-body"><p>Yeah I can do this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-06 13:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-07 03:07</div>
            <div class="timeline-body"><p>Looking into this more, I think these should just be <code>initializationOptions</code>, maybe? It seems like the whole <code>experimental</code> thing is more for servers to indicate to clients that they support non-standard extensions. \cc @dhruvmanila</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-05-07 13:04</div>
            <div class="timeline-body"><p>The <code>initializationOptions</code> just says that the server supports completions and what all specific features of completions that the server supports. This is mainly used by the client to make sure it asks for completions at the right time e.g., after the <code>.</code> character in <code>module.</code>.</p>
<p>What we want here is that, by default, the completions should be off as it&#x27;s pretty barebones but we don&#x27;t want to block users / us from trying out completions. And, we also don&#x27;t want to be competing with other language servers that will still be required for full completion support. This is why we want it to be an opt-in feature rather than opt-out for now.</p>
<p>Does that make sense?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-05-07 13:08</div>
            <div class="timeline-body"><p>We basically want the equivalent of <code>--preview</code> for the language server. If we used the <code>--preview</code> flag from the command-line, that would make it harder for users because it would require them to understand how to override the command used by the editor to start the server. And, that would be different for each editor. Another option if it&#x27;s possible would be to make it a server option instead of relying on a specific namespace in the capabilities.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-07 13:12</div>
            <div class="timeline-body"><p>Makes sense, I&#x27;m just not sure that we want <em>exactly</em> what RA is doing, since <code>experimental</code> is actually part of the LSP spec and has a specific meaning, and it&#x27;s not clear to me that we actually want that meaning.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-07 13:39</div>
            <div class="timeline-body"><p>I searched the node lsp client code to see how and where to pass the experimental capabilities but I didn&#x27;t see a way how it could be customized when creating the client:</p>
<p>https://github.com/microsoft/vscode-languageserver-node/blob/c02c91cb63c8524a476e32ff56343c2370881262/client/src/common/client.ts#L1404-L1405</p>
<p>I&#x27;d suggest to go with <code>initializationOptions</code> for now. We can migrate away from it in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-07 13:42</div>
            <div class="timeline-body"><p>Nevermind, I think I found the relevant code:</p>
<ol>
<li>https://github.com/rust-lang/rust-analyzer/blob/15d87419f1a123d8f888d608129c3ce3ff8f13d4/editors/code/src/client.ts#L291-L292</li>
<li>https://github.com/rust-lang/rust-analyzer/blob/15d87419f1a123d8f888d608129c3ce3ff8f13d4/editors/code/src/client.ts#L297-L340</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-07 13:43</div>
            <div class="timeline-body"><p>Thanks, I&#x27;ll look into it today.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-07 15:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[red-knot] make code completions an experimental opt-in before the alpha release&quot; to &quot;make code completions an experimental opt-in before the alpha release&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-07 15:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-07 15:34</div>
            <div class="timeline-body"><p>I&#x27;m fairly certain that we don&#x27;t want to use the experimental capabilities stuff, which is intended for non-standard extensions. I think we want to pass initialization options, then have the server <em>not</em> return completion support unless the initialization options contain the relevant setting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-05-07 15:40</div>
            <div class="timeline-body"><blockquote>
<p>I think we want to pass initialization options, then have the server <em>not</em> return completion support unless the initialization options contain the relevant setting.</p>
</blockquote>
<p>I think it&#x27;s fine to make it a server setting as well. Should we have a &quot;preview&quot; namespace for it? For example, the following in VS Code?</p>
<pre><code>{
	&quot;ty.preview.completions&quot;: &quot;true&quot;
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-05-07 15:42</div>
            <div class="timeline-body"><p>I&#x27;m seeing precedence in other settings using &quot;experimental&quot; instead:</p>
<pre><code>&quot;typescript.tsserver.experimental.enableProjectDiagnostics&quot;: false,

// Enable the command to toggle the experimental notebook inline diff editor.
&quot;notebook.diff.experimental.toggleInline&quot;: false,

&quot;ruff.enableExperimentalFormatter&quot;: false,

// Use ESLint version 8.57 or later and `eslint.useFlatConfig` instead.
// Enables support of experimental Flat Config (aka eslint.config.js). Requires ESLint version &gt;= 8.21 &lt; 8.57.0).
&quot;eslint.experimental.useFlatConfig&quot;: false,

// Try prettier&#x27;s [new ternary formatting](<a href="https://github.com/prettier/prettier/pull/13183">prettier/prettier#13183</a>) before it becomes the default behavior.
&quot;prettier.experimentalTernaries&quot;: false,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-05-07 16:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">completions</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-03 12:20</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:24:03 UTC
    </footer>
</body>
</html>
