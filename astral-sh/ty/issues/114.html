<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calling `is_file_open` degrades current query to durability LOW - astral-sh/ty #114</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Calling <code>is_file_open</code> degrades current query to durability LOW</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/114">#114</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-04-23 06:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><p>We noticed in <a href="https://github.com/astral-sh/ruff/pull/17463">astral-sh/ruff#17463</a>#discussion_r2054587050 that calling <code>is_file_open</code> degrades the durability of otherwise MEDIUM or HIGH durability queries to LOW because the <code>Project::open_files_set</code> and <code>Project::files</code> fields have durability LOW.</p>
<p>What this means is that we degrade the durability of type inference and semantic index queries to LOW if they have any type checking or semantic syntax errors. Which is unfortunate, because it requires that Salsa can&#x27;t use the fast-path to mark the queries as &quot;up-to-date&quot; after a revision change.</p>
<p>To some extend, this problem is similar to the one we experienced in the module resolver where module resolution first tries first-party files (that have a low durability) and only then tests for third party files.</p>
<p>The easiest solution is to change <code>is_file_open</code> to early return for vendored paths and system paths that aren&#x27;t subpaths of the project directory.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-23 06:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[red-knot] Calling `is_file_open` degrades current query to durability LOW&quot; to &quot;Calling `is_file_open` degrades current query to durability LOW&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-07 15:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-17 05:16</div>
            <div class="timeline-body"><p>I think what we could do here now is to call <code>IncludeExcludeFilter::matches_file</code> before testing if the file is in the <code>open_files_set</code>. This should give us a very low false positive rate.</p>
<p>The only thing we may need to investigate is if we can use a prefix filter for <code>ExcludeFilter</code> to avoid traversing all ancestors to determine if the file is excluded (similar to what we do in <code>IncludeFitler</code>). Instead, the method would return early if no prefix matcher matches. We still have to visit all ancestors if any prefix matcher matches because of negated patterns.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone &quot;Beta&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-15 07:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;GA&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-15 07:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:24:07 UTC
    </footer>
</body>
</html>
