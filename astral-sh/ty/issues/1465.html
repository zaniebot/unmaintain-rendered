<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ty incorrectly infers tensor arithmetic expression as `int | float` instead of `Tensor` - astral-sh/ty #1465</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ty incorrectly infers tensor arithmetic expression as <code>int | float</code> instead of <code>Tensor</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1465">#1465</a>
        opened by <a href="https://github.com/anmorgunov">@anmorgunov</a>
        on 2025-11-02 15:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/anmorgunov">@anmorgunov</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>When performing arithmetic operations on PyTorch tensors (e.g., <code>1.0 / (base ** (torch.arange(...).float() / dim))</code>), ty incorrectly infers the result type as <code>int | float</code> instead of <code>Tensor</code>. This causes false positive errors
when passing the result to methods like <code>nn.Module.register_buffer()</code>, which expect a <code>Tensor | None</code>. mypy correctly infers the type.</p>
<pre><code class="language-py">import torch
import torch.nn as nn


class SimpleModule(nn.Module):
    &quot;&quot;&quot;A simple module that demonstrates the register_buffer type inference issue.&quot;&quot;&quot;

    def __init__(self, dim: int):
        super().__init__()

        # This works fine - explicit Tensor
        tensor_explicit = torch.randn(dim)
        self.register_buffer(&quot;explicit_buffer&quot;, tensor_explicit)

        # This is the problem - ty complains about this
        # The expression (1.0 / base**(...)) returns a Tensor, but ty infers int | float
        base = 10000
        inv_freq = 1.0 / (base ** (torch.arange(0, dim, 2).float() / dim))
        self.register_buffer(&quot;inv_freq&quot;, inv_freq, persistent=False)

</code></pre>
<p>uvx ty check returns:</p>
<pre><code>uvx ty check register_buffer_repro.py
error[invalid-argument-type]: Argument to bound method `register_buffer` is incorrect
  --&gt; register_buffer_repro.py:20:42
   |
18 |         base = 10000
19 |         inv_freq = 1.0 / (base ** (torch.arange(0, dim, 2).float() / dim))
20 |         self.register_buffer(&quot;inv_freq&quot;, inv_freq, persistent=False)
   |                                          ^^^^^^^^ Expected `Tensor | None`, found `int | float`
21 |         # ty error: Expected `Tensor | None`, found `int | float`
   |
info: Method defined here
   --&gt; .venv/lib/python3.13/site-packages/torch/nn/modules/module.py:525:9
    |
523 |     forward: Callable[..., Any] = _forward_unimplemented
524 |
525 |     def register_buffer(
    |         ^^^^^^^^^^^^^^^
526 |         self, name: str, tensor: Optional[Tensor], persistent: bool = True
    |                          ------------------------ Parameter declared here
527 |     ) -&gt; None:
528 |         r&quot;&quot;&quot;Add a buffer to the module.
    |
info: rule `invalid-argument-type` is enabled by default
</code></pre>
<h3>Version</h3>
<p>ty 0.0.1-alpha.25 (3abd4c968 2025-10-29)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @sharkdp on 2025-11-03 18:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">type-inference</span> added by @sharkdp on 2025-11-03 18:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-11-03 18:46</div>
            <div class="timeline-body"><p>Thank you for reporting this.</p>
<p>I can't fully confirm this at the moment as my connection is too bad to download pytorch, but it looks like we're not respecting <a href="https://github.com/pytorch/pytorch/blob/f3913ea641d871f04fa2b6588a77f63efeeb9f10/torch/_tensor.py#L1112-L1113"><code>__rpow__</code> on <code>Tensor</code></a> correctly.</p>
<p>An MRE would be:</p>
<pre><code class="language-py">class Tensor:
    def __rpow__(self, other) -&gt; Tensor:
        return self

reveal_type(2 ** Tensor())  # int, should be Tensor
</code></pre>
<p>https://play.ty.dev/ba18a5e4-18ff-4903-9000-6485079a6eb4</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/anmorgunov">@anmorgunov</a> on 2025-11-03 18:56</div>
            <div class="timeline-body"><p>can confirm that it comes from raising to the power</p>
<pre><code class="language-py">import torch

inv_freq = 2**torch.Tensor([1, 2, 3, 4, 5])

reveal_type(inv_freq)
</code></pre>
<pre><code class="language-py">info[revealed-type]: Revealed type
 --&gt; check.py:5:13
  |
3 | inv_freq = 2**torch.Tensor([1, 2, 3, 4, 5])
4 |
5 | reveal_type(inv_freq)
  |             ^^^^^^^^ `int`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-03 20:26</div>
            <div class="timeline-body"><p>Thanks for the report! The root cause of this (thanks @AlexWaygood) is that the signature of <code>int.__pow__</code> is defined using a PEP 613 type alias in typeshed (<code>_PositiveInteger</code>), which we don't yet support correctly, so we wrongly think that the call to <code>int.__pow__</code> succeeds:</p>
<p>https://github.com/astral-sh/ruff/blob/fe4ee81b9749bd326845aec30e694af8568549e6/crates/ty_vendored/vendor/typeshed/stdlib/builtins.pyi#L553-L568</p>
<p>Once we support PEP 613, we will find that none of the <code>int.__pow__</code> overloads match, which will then cause us to fallback to using <code>Tensor.__rpow__</code> to infer the result of this expression.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-11-03 20:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-12 01:27</div>
            <div class="timeline-body"><p>Confirmed this will be fixed by https://github.com/astral-sh/ruff/pull/21394</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:20:53 UTC
    </footer>
</body>
</html>
