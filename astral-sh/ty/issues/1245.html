<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inheritance Issue From Web3.py - astral-sh/ty #1245</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Inheritance Issue From Web3.py</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1245">#1245</a>
        opened by <a href="https://github.com/kirigami-alex">@kirigami-alex</a>
        on 2025-09-24 13:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/kirigami-alex">@kirigami-alex</a> on 2025-09-24 13:14</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>The documented example from Web3.py (<a href="https://web3py.readthedocs.io/en/stable/providers.html#web3.providers.rpc.AsyncHTTPProvider">link</a>) which looks like this:</p>
<pre><code class="language-py">from aiohttp import ClientSession
from web3 import AsyncWeb3, AsyncHTTPProvider

async def bug():
    w3 = AsyncWeb3(AsyncHTTPProvider(endpoint_uri))
    custom_session = ClientSession()
    await w3.provider.cache_async_session(custom_session)
    w3.provider.disconnect()
</code></pre>
<p>Throws this error from Ty:</p>
<pre><code>error[unresolved-attribute]: Type `AsyncBaseProvider` has no attribute `cache_async_session`
  --&gt; src/silly_test.py:10:11
   |
 8 |     # If you want to pass in your own session:
 9 |     custom_session = ClientSession()
10 |     await w3.provider.cache_async_session(custom_session) # This method is an async method so it needs to be handled accordingly
   |           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
11 |     # when you're finished, disconnect:
12 |     w3.provider.disconnect()
   |
info: rule `unresolved-attribute` is enabled by default
</code></pre>
<h3>Version</h3>
<p>ty 0.0.1-alpha.21</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "This Example from Web3.py Throws an Error with Ty" to "Inheritance Issue From Web3.py" by @kirigami-alex on 2025-09-24 13:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-09-24 14:58</div>
            <div class="timeline-body"><p>Thanks for the report!</p>
<p>I think this is an issue with web3's type annotations, that you'll need to report to the web3 library. Mypy and pyright both report the same issue (note that I had to add a <code>-&gt; None</code> annotation to your function to reproduce the issue with mypy, since mypy by default does not type-check the bodies of functions without type annotations):</p>
<pre><code class="language-sh">~/dev % cat foo.py                          
from aiohttp import ClientSession
from web3 import AsyncWeb3, AsyncHTTPProvider

async def bug() -&gt; None:
    w3 = AsyncWeb3(AsyncHTTPProvider(endpoint_uri))
    custom_session = ClientSession()
    await w3.provider.cache_async_session(custom_session)
    w3.provider.disconnect()
~/dev % uvx --with=aiohttp --with=web3 mypy foo.py         
foo.py:5: error: Name &quot;endpoint_uri&quot; is not defined  [name-defined]
foo.py:7: error: &quot;AsyncBaseProvider&quot; has no attribute &quot;cache_async_session&quot;  [attr-defined]
foo.py:8: error: Value of type &quot;Coroutine[Any, Any, None]&quot; must be used  [unused-coroutine]
foo.py:8: note: Are you missing an await?
Found 3 errors in 1 file (checked 1 source file)
~/dev [1] % uvx --with=aiohttp --with=web3 pyright foo.py
/Users/alexw/dev/foo.py
  /Users/alexw/dev/foo.py:5:38 - error: &quot;endpoint_uri&quot; is not defined (reportUndefinedVariable)
  /Users/alexw/dev/foo.py:7:23 - error: Cannot access attribute &quot;cache_async_session&quot; for class &quot;AsyncBaseProvider&quot;
    Attribute &quot;cache_async_session&quot; is unknown (reportAttributeAccessIssue)
  /Users/alexw/dev/foo.py:8:5 - error: Result of async function call is not used; use &quot;await&quot; or assign result to variable (reportUnusedCoroutine)
3 errors, 0 warnings, 0 informations
</code></pre>
<p>If we look at the web3 library, we can see that the <code>AsyncWeb3.provider</code> property is annotated as returning an instance of <a href="https://github.com/ethereum/web3.py/blob/a1c2e83a523c8da07939aeafffd12ba98531d3be/web3/main.py#L488-L490"><code>AsyncBaseProvider</code></a>, but <code>AsyncBaseProvider</code> doesn't have a <code>cache_async_session</code> attribute or method (<a href="https://github.com/ethereum/web3.py/blob/a1c2e83a523c8da07939aeafffd12ba98531d3be/web3/providers/async_base.py#L73-L182">source</a>). The <code>AsyncHTTPProvider</code> subclass of <code>AsyncBaseProvider</code> <em>does</em> have <a href="https://github.com/ethereum/web3.py/blob/a1c2e83a523c8da07939aeafffd12ba98531d3be/web3/providers/rpc/async_rpc.py#L84-L87">a <code>cache_async_session</code> method</a>, but ty hasn't been given enough information from web3's type annotations to know that <code>w3.provider</code> is an instance of <code>AsyncHTTPProvider</code> rather than an instance of <code>AsyncBaseProvider</code> here. To fix this, the web3 maintainers might consider making the <code>AsyncWeb3</code> class generic -- possibly something like this might fix things, but I haven't tested it:</p>
<pre><code class="language-diff">diff --git a/web3/main.py b/web3/main.py
index b388f95b..35286871 100644
--- a/web3/main.py
+++ b/web3/main.py
@@ -43,6 +43,8 @@ from typing import (
     Type,
     Union,
     cast,
+    Generic,
+    TypeVar,
 )
 
 from eth_typing import (
@@ -447,7 +449,10 @@ class Web3(BaseWeb3):
 # -- async -- #
 
 
-class AsyncWeb3(BaseWeb3):
+T = TypeVar(&quot;T&quot;, bound=AsyncBaseProvider)
+
+
+class AsyncWeb3(BaseWeb3, Generic[T]):
     # mypy Types
     eth: AsyncEth
     net: AsyncNet
@@ -460,7 +465,7 @@ class AsyncWeb3(BaseWeb3):
 
     def __init__(
         self,
-        provider: Optional[AsyncBaseProvider] = None,
+        provider: Optional[T] = None,
         middleware: Optional[Sequence[Any]] = None,
         modules: Optional[Dict[str, Union[Type[Module], Sequence[Any]]]] = None,
         external_modules: Optional[
@@ -486,11 +491,11 @@ class AsyncWeb3(BaseWeb3):
         return await self.provider.is_connected(show_traceback)
 
     @property
-    def provider(self) -&gt; AsyncBaseProvider:
-        return cast(AsyncBaseProvider, self.manager.provider)
+    def provider(self) -&gt; T:
+        return cast(T, self.manager.provider)
 
     @provider.setter
-    def provider(self, provider: AsyncBaseProvider) -&gt; None:
+    def provider(self, provider: T) -&gt; None:
         self.manager.provider = provider
 
     @property
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-09-24 14:58</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 02:11:32 UTC
    </footer>
</body>
</html>
