<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inverse tree query - astral-sh/ty #1704</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Inverse tree query</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1704">#1704</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-12-01 12:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><p>Implement a salsa query that, given a file, returns an index that allows querying the ancestor chain of any given node.</p>
<p>Being able to retrieve the ancestors (or parents) is often required when:</p>
<ul>
<li>generating fixes</li>
<li>In LSP methods, e.g. <code>CoveringNode</code> is all about having a node + its ancestor chain</li>
</ul>
<p>The easiest solution is to build a <code>ParentMap</code> that stores an <code>IndexVec&lt;NodeId, NodeId&gt;</code>: the index is the node, and the value is its parent. This should be very fast to build, but requires <code>O(n)</code> storage. It might be possible to store the information in a more condensed form by using the information that the ids are assigned pre-order (the ids of children are always larger than the parent, I think we do something similar for <code>scopes</code> in the <code>SemanticIndex</code></p>
<p>The new data structure should provide methods to:</p>
<ul>
<li>get a node's parent</li>
<li>get a node's ancestor</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @MichaReiser on 2025-12-01 12:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> removed by @MichaReiser on 2025-12-01 13:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-12-01 14:18</div>
            <div class="timeline-body"><p>Is this showing up as a performance bottleneck somewhere?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-01 14:45</div>
            <div class="timeline-body"><p>No, it's more that there are cases in type inference where we can't get the necessary information because we lack the ability to do upward traversal.</p>
<p>I'm not sure if performance is an issue in find references where we clone ancestors for every visited node but there are other ways we can mitigate that cost</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-12-01 14:48</div>
            <div class="timeline-body"><p>Ah I see, I knew we did it all the time in the LSP, I didn't realize we were flaunting our AST privilege!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @carljm on 2025-12-02 00:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-12-02 11:52</div>
            <div class="timeline-body"><p>@MichaReiser can I work on this , this seems veryy interesting to me.
Thank you : )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-02 11:56</div>
            <div class="timeline-body"><p>I removed the help wanted label because it's not entirely clear to me what the API should be. Specifically, I ran into issues when using this new api in <code>CoveringNode</code> where it ended up being awkward. That's why I don't think it's a good candidate for a contributor issue at the moment. I'm sorry</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/11happy">@11happy</a> on 2025-12-02 11:59</div>
            <div class="timeline-body"><p>Sure no worries , I understand, however I am still interested to work on this whenever things are more clear.
Thank  you : )</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:21:07 UTC
    </footer>
</body>
</html>
