<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>typing.Self is not recognized as compatible with self - astral-sh/ty #2468</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>typing.Self is not recognized as compatible with self</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/2468">#2468</a>
        opened by <a href="https://github.com/lelit">@lelit</a>
        on 2026-01-12 14:44
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/lelit">@lelit</a> on 2026-01-12 14:44</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>This is similar to #2255, but triggers a different violation, so I opted to open a new issue.</p>
<p>The following is a stripped down version of a <em>mixin</em>  I usually add to my <code>ORM</code> classes:</p>
<pre><code class="language-python">from __future__ import annotations

from collections.abc import Callable
from collections.abc import Sequence
from typing import Any
from typing import Self


class ReprMixin:
    REPR_ATTRS: Sequence[tuple[str, Callable[[Self, str], Any]] | str] | None = None

    def __repr__(self) -&gt; str:
        classname = self.__class__.__name__
        if self.REPR_ATTRS is not None:
            attrs = []
            for item in self.REPR_ATTRS:
                if isinstance(item, str):
                    attrs.append((item, getattr(self, item)))
                else:
                    name, func  = item
                    attrs.append((name, func(self, name)))
            attrs_v = ' '.join(f'{n}={v}' for n, v in attrs)
            return f'&lt;{classname} {attrs_v}&gt;'
        else:
            return 'bad configuration'


class Foo(ReprMixin):
    REPR_ATTRS = ('foo', ('bar', lambda s, n: getattr(s, n).upper()))

    def __init__(self):
        self.foo = 'foo'
        self.bar = 'bar'


foo = Foo()
print(repr(foo))
# &lt;Foo foo=foo bar=BAR&gt;
</code></pre>
<p>This is what I get with <code>ty check</code>:</p>
<pre><code>$ ty version
ty 0.0.10

$ ty check test.py
error[invalid-argument-type]: Argument is incorrect
  --&gt; test.py:21:46
   |
19 |                 else:
20 |                     name, func  = item
21 |                     attrs.append((name, func(self, name)))
   |                                              ^^^^ Expected `&lt;special-form 'typing.Self'&gt;`, found `Self@__repr__`
22 |             attrs_v = ' '.join(f'{n}={v}' for n, v in attrs)
23 |             return f'&lt;{classname} {attrs_v}&gt;'
   |
info: rule `invalid-argument-type` is enabled by default

Found 1 diagnostic
</code></pre>
<p>For the record, also ``mypy` is not happy:</p>
<pre><code>$ mypy --version
mypy 1.17.1 (compiled: yes)

$ mypy test.py 
test.py:21: error: Argument 1 has incompatible type &quot;ReprMixin&quot;; expected &quot;Self&quot;  [arg-type]
Found 1 error in 1 file (checked 1 source file)
</code></pre>
<p>OTOH, <code>pyrefly</code> likes it:</p>
<pre><code>$ pyrefly --version
pyrefly 0.47.0

$ pyrefly check test.py 
 INFO 0 errors
</code></pre>
<p>and so does <code>pyright</code>:</p>
<pre><code>$ pyright --version
pyright 1.1.407

$ pyright test.py 
0 errors, 0 warnings, 0 informations
</code></pre>
<p>See also the corresponding <a href="https://play.ty.dev/4b803ba2-7fe3-4be2-8649-19f7ffc1402d">playground</a>.</p>
<h3>Version</h3>
<p>0.0.10</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 14:54:34 UTC
    </footer>
</body>
</html>
