<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>exponential runtime for some large unions - astral-sh/ty #1968</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>exponential runtime for some large unions</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1968">#1968</a>
        opened by <a href="https://github.com/markjm">@markjm</a>
        on 2025-12-17 01:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/markjm">@markjm</a> on 2025-12-17 01:37</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Hi all - thank you so much for this promising new project! I am excited to get our company using <code>ty</code> ASAP. With the beta announcement today, I tried it out on our JUMBO codebase. In doing so, I have identified the below issue:</p>
<p>Included here is a minimal repro from our codebase (reduced as much as possible and business logic filtered out, i realize it looks silly but i figure it demonstrated the issue well):</p>
<pre><code class="language-python">&quot;&quot;&quot;
Minimal reproduction for ty type checker exponential slowdown.

Run with:
    TY_MAX_PARALLELISM=1 ty check slow_ty_repro.py

Timings:
    4 types: &lt;1s
    5 types: &lt;1s
    6 types: ~8s
    7 types: &gt;60s (hits my timeout)

Example debug logs:
2025-12-17 01:33:38.681798202 DEBUG left implies right left=(M6 ≤ U_co@apply ≤ M1 | M2 | M3 | ... omitted 4 union elements) right=(U_co@apply ≤ M1 | M2 | M3 | ... omitted 4 union elements)
2025-12-17 01:33:38.682086278 DEBUG left and right overlap left=(M6 ≤ U_co@apply ≤ M1 | M2 | M3 | ... omitted 4 union elements) right=(U_co@apply ≤ M1 | M2 | M3 | ... omitted 4 union elements) intersection=(M6 ≤ U_co@apply ≤ M1 | M2 | M3 | ... omitted 4 union elements)
2025-12-17 01:33:38.683285882 DEBUG left implies right left=(M3 ≤ U_co@apply ≤ M1 | M2 | M3 | ... omitted 4 union elements) right=(U_co@apply ≤ M1 | M2 | M3 | ... omitted 4 union elements)
2025-12-17 01:33:38.683605638 DEBUG left and right overlap left=(M3 ≤ U_co@apply ≤ M1 | M2 | M3 | ... omitted 4 union elements) right=(U_co@apply ≤ M1 | M2 | M3 | ... omitted 4 union elements) intersection=(M3 ≤ U_co@apply ≤ M1 | M2 | M3 | ... omitted 4 union elements)
2025-12-17 01:33:38.683894444 DEBUG left implies right left=(M3 ≤ U_co@apply ≤ M1 | M2 | M3 | ... omitted 4 union elements) right=(M3 ≤ U_co@apply)
2025-12-17 01:33:38.683919264 DEBUG left and right overlap left=(M3 ≤ U_co@apply ≤ M1 | M2 | M3 | ... omitted 4 union elements) right=(M3 ≤ U_co@apply) intersection=(M3 ≤ U_co@apply ≤ M1 | M2 | M3 | ... omitted 4 union elements)

&quot;&quot;&quot;

from __future__ import annotations

from typing import Callable
from typing import Generic
from typing import TypeVar
from typing import Union


class M1: pass
class M2: pass
class M3: pass
class M4: pass
class M5: pass
class M6: pass
class M7: pass

Msg = Union[M1, M2, M3, M4, M5, M6, M7]

T = TypeVar(&quot;T&quot;)
U_co = TypeVar(&quot;U_co&quot;, covariant=True)


class Stream(Generic[T]):
    def apply(self, func: Callable[[&quot;Stream[T]&quot;], &quot;Stream[U_co]&quot;]) -&gt; &quot;Stream[U_co]&quot;:
        return func(self)


TMsg = TypeVar(&quot;TMsg&quot;, bound=Msg)


class Builder(Generic[TMsg]):
    def build(self) -&gt; Stream[TMsg]:
        stream: Stream[TMsg] = Stream()
        stream = stream.apply(self._handler) # i think here is where the issue triggers?
        return stream

    def _handler(self, stream: Stream[Msg]) -&gt; Stream[Msg]:
        return stream

</code></pre>
<p>this initially just surfaced as what seemed to be a hang during a repo-wide <code>ty check</code>, but debug logs allowed me to narrow down to this file then I just hacked away until i got something which seemed reasonable to share.</p>
<h3>Version</h3>
<p>0.0.2</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/markjm">@markjm</a> on 2025-12-17 02:04</div>
            <div class="timeline-body"><p>PS - to report a secondary issue: I notice yall have https://play.ty.dev/ for sharing snippets. Attempting to paste this snippet there causes the web page to hang and crash (but idk how to capture debug information from that crash to showcase the issue)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-17 03:59</div>
            <div class="timeline-body"><p>Thank you for the minimized reproduction!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @AlexWaygood on 2025-12-17 07:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Stable" by @AlexWaygood on 2025-12-17 07:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-17 14:44</div>
            <div class="timeline-body"><p>Here's a subset of the flamegraph (~70% of the time) for a union of 6 items</p>
<p><img width="1477" height="640" alt="Image" src="https://github.com/user-attachments/assets/0fa66dc0-e298-4b60-a017-1d6f4e2eb578" /></p>
<p>Here's the whole flamegraph https://share.firefox.dev/4aTSiT2</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-12-17 16:34</div>
            <div class="timeline-body"><p>I just pushed up https://github.com/astral-sh/ruff/pull/22030, and confirmed locally that it makes the execution time for this example not depend on the number of <code>M1</code>, <code>M2</code>, etc, classes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dcreager on 2025-12-17 18:35</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:54:35 UTC
    </footer>
</body>
</html>
