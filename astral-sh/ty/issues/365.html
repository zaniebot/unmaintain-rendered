<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>panic: If we have at least one binding, the scope-start should not be definitely visible - astral-sh/ty #365</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>panic: If we have at least one binding, the scope-start should not be definitely visible</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/365">#365</a>
        opened by <a href="https://github.com/jelle-openai">@jelle-openai</a>
        on 2025-05-13 18:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jelle-openai">@jelle-openai</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<pre><code>error[panic]: Panicked at crates/ty_python_semantic/src/symbol.rs:824:17 when checking `&lt;snip&gt;.py`: `internal error: entered unreachable code: If we have at least one binding, the scope-start should not be definitely visible`
info: This indicates a bug in ty.
info: If you could open an issue at https://github.com/astral-sh/ty/issues/new?title=%5Bpanic%5D, we'd be very appreciative!
info: Platform: macos aarch64
info: Args: [&quot;ty&quot;, &quot;check&quot;, &quot;.&quot;]
info: run with `RUST_BACKTRACE=1` environment variable to show the full backtrace information
info: query stacktrace:
   0: symbol_by_id(Id(1c51a9b))
             at crates/ty_python_semantic/src/symbol.rs:576
   1: infer_expression_types(Id(1c6a4a5))
             at crates/ty_python_semantic/src/types/infer.rs:222
   2: infer_scope_types(Id(1c257c7))
             at crates/ty_python_semantic/src/types/infer.rs:121
   3: check_types(Id(4a7b))
             at crates/ty_python_semantic/src/types.rs:84
</code></pre>
<p>As before, can try to minimize if this isn't enough to tell the source of the crash.</p>
<h3>Version</h3>
<p>ty 0.0.1-alpha.1 (12f466e46 2025-05-13)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-13 18:30</div>
            <div class="timeline-body"><p>That <em>is</em> a fun one! Yes please, a minimal repro would be great here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fatal</span> added by @AlexWaygood on 2025-05-13 18:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">control flow</span> added by @AlexWaygood on 2025-05-13 18:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-05-13 18:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-05-13 18:31</div>
            <div class="timeline-body"><p>Will probably need an example to fix this -- but I think there is also a mypy-primer project where we see it, so we should be able to track it down there and fix it, and then see if that fixes your case as well. Thanks for the report!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @carljm on 2025-05-13 18:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">control flow</span> removed by @carljm on 2025-05-13 18:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-05-13 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">control flow</span> added by @AlexWaygood on 2025-05-13 18:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jelle-openai">@jelle-openai</a> on 2025-05-13 18:40</div>
            <div class="timeline-body"><p>Here you go:</p>
<pre><code class="language-python">def f():
    pass


def g(a):
    if not c.get(&quot;t&quot;):
        return


if __name__ == &quot;__main__&quot;:
    while True:
        b = f()
        if b == -1:
            break

        c = h()
        if not c:
            break
</code></pre>
<p>So the global <code>c</code> is being used inside function <code>g()</code>, but it's only defined conditionally in the <code>if __name__</code> block.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-15 18:41</div>
            <div class="timeline-body"><p>Thank you very much. I further narrowed it down to</p>
<pre><code class="language-py">def g():
    c

while True:
    if flag1:
        break

    c = 1

    break
</code></pre>
<p>Interestingly, we do not panic for the following, seemingly equivalent <code>if</code> construct:</p>
<pre><code class="language-py">if True:
    if flag1:
        pass
    else:
        c = 1
</code></pre>
<p>So it looks like this has something to do with <code>while</code> loops or <code>break</code> statements.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @sharkdp by @sharkdp on 2025-05-15 18:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-15 20:20</div>
            <div class="timeline-body"><p>Even simpler:</p>
<pre><code class="language-py">while True:
    if flag1:
        break
    else:
        c = 1
        break

c
</code></pre>
<p>Interestingly, if we move the <code>break</code> out of the conditional branches…</p>
<pre><code class="language-py">while True:
    if flag1:
        pass
    else:
        c = 1

    break

c
</code></pre>
<p>… it does not panic</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-16 07:47</div>
            <div class="timeline-body"><p>I think I know what the problem is. When we save break snapshots, we fail to update them with visibility constraints. So for the first <code>break</code> here …</p>
<pre><code class="language-py">while True:
    if flag1:
        break
    else:
        c = 1
        break

c
</code></pre>
<p>… we fail to record <em>any</em> visibility constraints (for the implicit <code>c = &lt;unbound&gt;</code> binding at the start of scope), because they are only added at the end of control flow branches. When we later merge in the break states after the loop, we are therefore left with a <code>c = &lt;unbound&gt;</code> definition which is still <code>AlwaysTrue</code>, leading to that panic</p>
<p>This can also lead to wrong type inference:</p>
<pre><code class="language-py">c = 1

while True:
    if False:
        c = 2
        break
    break

reveal_type(c)  # should be `1`, but we reveal `1, 2`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-05-22 03:18</div>
            <div class="timeline-body"><p>We track both visibility constraints (added at the end of a branch) and reachability constraints (added at the start of the branch). If we updated the reachability constraint, and visibility constraints for all pre-existing bindings, at the start of the branch, and then created new bindings in the branch with initial visibility constraints matching reachability constraints at the point of the binding, would that work and potentially solve this problem? Or am I missing another reason why have to add branch visibility constraints at the end of the branch?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-22 06:30</div>
            <div class="timeline-body"><p>(I put work here a bit on hold since https://github.com/astral-sh/ruff/pull/18041 was also making major changes to the semantic index builder, and there were other things to do)</p>
<blockquote>
<p>If we updated the reachability constraint, and visibility constraints for all pre-existing bindings, at the start of the branch, and then created new bindings in the branch with initial visibility constraints matching reachability constraints at the point of the binding, would that work and potentially solve this problem?</p>
</blockquote>
<p>This sounds like it can work, yes! And it might actually be a major simplification of the code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Beta" by @carljm on 2025-06-11 00:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-06-17 07:24</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:19:51 UTC
    </footer>
</body>
</html>
