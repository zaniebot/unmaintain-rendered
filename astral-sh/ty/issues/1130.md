```yaml
number: 1130
title: "Account for TypedDicts in narrowing of `isinstance(..., dict)`"
type: issue
state: open
author: JelleZijlstra
labels:
  - narrowing
  - typeddict
assignees: []
created_at: 2025-09-04T23:11:13Z
updated_at: 2026-01-09T02:33:37Z
url: https://github.com/astral-sh/ty/issues/1130
synced_at: 2026-01-10T01:56:40Z
```

# Account for TypedDicts in narrowing of `isinstance(..., dict)`

---

_Issue opened by @JelleZijlstra on 2025-09-04 23:11_

### Summary

We just closed #456, but there's one special case that needs more attention: `isinstance(x, dict)`. The tricky part is that TypedDicts are instances of `dict` at runtime, but are not (generally) assignable to any materialization of `dict[Any, Any]`. (See the proposed spec change in https://github.com/python/typing/pull/2072 for the details.)

Current behavior is as follows ([playground](https://play.ty.dev/89647293-a588-442d-ae5c-d0e2fbdacd2c)):

```python
from typing import TypedDict

class X(TypedDict):
    a: int

def _(x: list | X):
    if isinstance(x, dict):
        reveal_type(x)  # X & Top[dict[Unknown, Unknown]]
    else:
        reveal_type(x)  # list[Unknown] | (X & ~Top[dict[Unknown, Unknown]])
```

Mypy and pyright both infer `X` in the positive branch and `list[Any]` in the negative branch, which is what we'd want.

I know TypedDict support is still missing a lot of functionality, so things will change, but I see a few options:

- Make TypedDict types into subtypes of `Top[dict[Unknown, Unknown]]`. That would make this sample work correctly, but it's technically wrong in that TypedDicts aren't materializations of `dict[Any, Any]`. As such, it may cause issues with other possible use cases for `Top[]`. It would also allow some unsafe operations (https://github.com/JelleZijlstra/unsoundness/blob/main/examples/narrowing/isinstance_dict.py).
- Change the spec so that TypedDict types are assignable to `dict[str, Any]`. I think that's a defensible change, but it's not what the current spec says and I don't know if such a change would see a positive reception.
- Add a new special form `ty_extensions.AnyTypedDict`, with the semantics that any TypedDict type is a subtype of `AnyTypedDict`. The only allowed operations on `AnyTypedDict` are those that are allowed on any TypedDict (so no `.clear()`; `.keys()` returns an iterable of `str`; `.values()` an iterable of `object`; etc.). `isinstance(x, dict)` would narrow to `AnyTypedDict | Top[dict[Unknown, Unknown]]`. This is technically correct and would fix the soundness hole in https://github.com/JelleZijlstra/unsoundness/blob/main/examples/narrowing/isinstance_dict.py, but it would introduce a new user-visible concept.

### Version

_No response_

---

_Label `narrowing` added by @AlexWaygood on 2025-09-04 23:12_

---

_Comment by @carljm on 2025-09-04 23:51_

> * Change the spec so that TypedDict types are assignable to `dict[str, Any]`

I think this would also require that TypedDict types are all subtypes of `Top[dict[str, Any]]`?

And this also would require that `.clear()` be part of the `TypedDict` type, allowing that unsoundness.

> * it would introduce a new user-visible concept.

We could potentially spell the new type `Top[TypedDict]` instead of `AnyTypedDict` (I'd probably prefer to stay away from the word "Any" regardless, as part of the name of a fully-static type), which means it doesn't require any new symbols.



---

_Renamed from "Narrowing of `isinstance(..., dict)`" to "Account for TypedDicts in narrowing of `isinstance(..., dict)`" by @carljm on 2026-01-09 02:33_

---

_Label `typeddict` added by @carljm on 2026-01-09 02:33_

---

_Added to milestone `Stable` by @carljm on 2026-01-09 02:33_

---
