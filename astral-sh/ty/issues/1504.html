<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Length of concatenation of tuples is not inferred - astral-sh/ty #1504</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Length of concatenation of tuples is not inferred</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1504">#1504</a>
        opened by <a href="https://github.com/ThorstenBuss">@ThorstenBuss</a>
        on 2025-11-08 13:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ThorstenBuss">@ThorstenBuss</a></div>
            <div class="timeline-body">Summary
<p>When running <code>ty check</code> on the following code, it gives you an invalid-return-type error. This is not the expected behavior since the concatenation of a tuple with one entry and one with two entries always has tree entries.</p>
<pre><code>def concat(a: tuple[int], b: tuple[int, int]) -&gt; tuple[int, int, int]:
    return a + b
</code></pre>
<p>https://play.ty.dev/cdc8212c-6304-491f-904f-b4cd6468992c</p>
Version
<p>ty 0.0.1-alpha.25</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-09 16:31</div>
            <div class="timeline-body"><p>Thanks for the feature request!</p>
<p>It&#x27;s true that other type checkers accept this code. However, it&#x27;s also easy to demonstrate that there are ways of breaking the assumptions that other type checkers make about this code. For example, both mypy and pyright report no diagnostics on the following snippet and report that the type of <code>x</code> is <code>tuple[int, int, int]</code>. But at runtime, <code>x</code> has value <code>(1, 2, 3, 4, 5)</code>, which pretty obviously isn&#x27;t consistent with that type!</p>
<pre><code>from typing import overload, TypeVar

T = TypeVar(&quot;T&quot;)

class Foo(tuple[int, int]):
    @overload
    def __add__(self, other: tuple[int, ...]) -&gt; tuple[int, ...]: ...
    @overload
    def __add__(self, other: tuple[T, ...]) -&gt; tuple[int | T, ...]: ...
    def __add__(self, other: tuple[object, ...]) -&gt; tuple[object, ...]:
        return (1, 2, 3, 4, 5)
    
    __radd__ = __add__

def concat(a: tuple[int], b: tuple[int, int]) -&gt; tuple[int, int, int]:
    return a + b

x = concat((1,), Foo((1, 2)))
reveal_type(x)
</code></pre>
<p>One way to resolve the unsound behaviour of other type checkers here would be to ban users from overriding <code>__add__</code> and <code>__radd__</code> on tuple subclasses. But this seems unnecessarily restrictive: users might have a good reason to override these methods on custom tuple subclasses (in particular on <code>NamedTuple</code> classes, which are all implicitly tuple subclasses). While we plan to take this approach to &quot;solve&quot; tuple-subclass unsoundness for some other areas where we special-case tuples, it also doesn&#x27;t <em>fully</em> address the unsoundness issues: the tuple subclass could always be defined in a third-party library that isn&#x27;t type-checked with ty, and ty wouldn&#x27;t flag the unsound subclass since all diagnostics are silenced for packages installed in your virtual environment.</p>
<p>We actually used to have the special case you&#x27;re asking for here, but we ripped it out for the reasons stated above, and also a few other reasons:</p>
<ul>
<li>It simplifies our implementation internally</li>
<li>It turns out that the special case for tuple addition makes it more likely that ty runs into pathological performance issues when inferring types for unannotated instance attributes.</li>
<li>Empirically, <a href="https://github.com/astral-sh/ruff/pull/19636#issuecomment-3136012420">surprisingly little ecosystem code seemed to rely on the special case</a></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-09 16:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:25:55 UTC
    </footer>
</body>
</html>
