<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pair of mutually recursive generic `Protocol` definitions - astral-sh/ty #1587</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>pair of mutually recursive generic <code>Protocol</code> definitions</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1587">#1587</a>
        opened by <a href="https://github.com/gertvdijk">@gertvdijk</a>
        on 2025-11-18 23:05
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gertvdijk">@gertvdijk</a></div>
            <div class="timeline-body"><p>I&#x27;ve got a small Python typing showcase (currently using mypy) up at https://github.com/gertvdijk/mypy-sibling-generics-demo. Was wondering how <code>ty</code> would handle/show this, tried it out, but sadly it triggers <code>ty</code> to panic (tested at <a href="https://github.com/gertvdijk/mypy-sibling-generics-demo/commit/18e84d223ffb2dfdd53e5ee362db47101e15a9f5">this current latest commit</a>). It told me to create this bug report, so here I am. ðŸ˜„</p>
<p>Steps to reproduce: clone that project, and running <code>ty</code> triggers it basically. I believe the output below includes all necessary info, but please LMK if you need anything else or even a smaller MRE.</p>
<pre><code>$ git clone https://github.com/gertvdijk/mypy-sibling-generics-demo.git &amp;&amp; cd mypy-sibling-generics-demo
$ uv add --dev ty
$ uv run ty check
error[panic]: Panicked at crates/ty_python_semantic/src/types/instance.rs:822:18 when checking `/path/to/mypy-sibling-generics-demo/foobar/client.py`: `Class wrapped by `Protocol` should be a protocol class`
info: This indicates a bug in ty.
info: If you could open an issue at https://github.com/astral-sh/ty/issues/new?title=%5Bpanic%5D, we&#x27;d be very appreciative!
info: Platform: linux x86_64
info: Version: 0.0.1-alpha.27
[...]
</code></pre>


Full output

<pre><code>error[panic]: Panicked at crates/ty_python_semantic/src/types/instance.rs:822:18 when checking `/path/to/mypy-sibling-generics-demo/foobar/client.py`: `Class wrapped by `Protocol` should be a protocol class`
info: This indicates a bug in ty.
info: If you could open an issue at https://github.com/astral-sh/ty/issues/new?title=%5Bpanic%5D, we&#x27;d be very appreciative!
info: Platform: linux x86_64
info: Version: 0.0.1-alpha.27
info: Args: [&quot;ty&quot;, &quot;check&quot;]
info: run with `RUST_BACKTRACE=1` environment variable to show the full backtrace information
info: query stacktrace:
   0: is_equivalent_to_object_inner(Id(25801))
             at crates/ty_python_semantic/src/types/instance.rs:663
             cycle heads: infer_definition_types(Id(300e)) -&gt; iteration = 2
   1: infer_deferred_types(Id(300b))
             at crates/ty_python_semantic/src/types/infer.rs:141
             cycle heads: infer_definition_types(Id(300d)) -&gt; iteration = 2, TypeVarInstance &lt; &#x27;db &gt;::lazy_bound_(Id(1c801)) -&gt; iteration = 2
   2: TypeVarInstance &lt; &#x27;db &gt;::lazy_bound_(Id(1c800))
             at crates/ty_python_semantic/src/types.rs:8734
   3: infer_definition_types(Id(300e))
             at crates/ty_python_semantic/src/types/infer.rs:94
   4: infer_deferred_types(Id(300c))
             at crates/ty_python_semantic/src/types/infer.rs:141
   5: TypeVarInstance &lt; &#x27;db &gt;::lazy_bound_(Id(1c801))
             at crates/ty_python_semantic/src/types.rs:8734
   6: infer_definition_types(Id(300d))
             at crates/ty_python_semantic/src/types/infer.rs:94
   7: infer_scope_types(Id(2400))
             at crates/ty_python_semantic/src/types/infer.rs:70
   8: check_file_impl(Id(c01))
             at crates/ty_project/src/lib.rs:535


error[panic]: Panicked at crates/ty_python_semantic/src/types/instance.rs:822:18 when checking `/path/to/mypy-sibling-generics-demo/foobar/server.py`: `Class wrapped by `Protocol` should be a protocol class`
info: This indicates a bug in ty.
info: If you could open an issue at https://github.com/astral-sh/ty/issues/new?title=%5Bpanic%5D, we&#x27;d be very appreciative!
info: Platform: linux x86_64
info: Version: 0.0.1-alpha.27
info: Args: [&quot;ty&quot;, &quot;check&quot;]
info: run with `RUST_BACKTRACE=1` environment variable to show the full backtrace information
info: query stacktrace:
   0: is_equivalent_to_object_inner(Id(26801))
             at crates/ty_python_semantic/src/types/instance.rs:663
             cycle heads: infer_definition_types(Id(380d)) -&gt; iteration = 2
   1: infer_deferred_types(Id(3808))
             at crates/ty_python_semantic/src/types/infer.rs:141
             cycle heads: infer_definition_types(Id(380c)) -&gt; iteration = 2, TypeVarInstance &lt; &#x27;db &gt;::lazy_bound_(Id(1e801)) -&gt; iteration = 2
   2: TypeVarInstance &lt; &#x27;db &gt;::lazy_bound_(Id(1e800))
             at crates/ty_python_semantic/src/types.rs:8734
   3: infer_definition_types(Id(380d))
             at crates/ty_python_semantic/src/types/infer.rs:94
   4: infer_deferred_types(Id(3809))
             at crates/ty_python_semantic/src/types/infer.rs:141
   5: TypeVarInstance &lt; &#x27;db &gt;::lazy_bound_(Id(1e801))
             at crates/ty_python_semantic/src/types.rs:8734
   6: infer_definition_types(Id(380c))
             at crates/ty_python_semantic/src/types/infer.rs:94
   7: infer_scope_types(Id(2800))
             at crates/ty_python_semantic/src/types/infer.rs:70
   8: check_file_impl(Id(c00))
             at crates/ty_project/src/lib.rs:535


Found 2 diagnostics
WARN A fatal error occurred while checking some files. Not all project files were analyzed. See the diagnostics list above for details.
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fatal</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-18 23:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">Protocols</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-18 23:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Beta&quot; by <a href="https://github.com/carljm">@carljm</a> on 2025-11-18 23:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[panic] `Class wrapped by `Protocol` should be a protocol class`&quot; to &quot;[panic] Class wrapped by `Protocol` should be a protocol class&quot; by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-11-19 02:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on 2025-11-19 06:52</div>
            <div class="timeline-body"><p>I was able to minimize the code to this smaller/standalone repo:</p>
<pre><code>from typing import Any, Protocol, TypeVar

Req_t_co = TypeVar(&quot;Req_t_co&quot;, bound=&quot;BaseRequest[Any]&quot;)
Res_t_co = TypeVar(&quot;Res_t_co&quot;, bound=&quot;BaseResponse[Any]&quot;)

class BaseRequest(Protocol[Res_t_co]):
    def get_response_type() :
        ...

class BaseResponse(Protocol[Req_t_co]):
    def get_request_type() :
        ...

SCReq_t_co = TypeVar(&quot;SCReq_t_co&quot;, bound=&quot;ServerContextRequest[Any]&quot;)
SCResp_t_co = TypeVar(&quot;SCResp_t_co&quot;, bound=&quot;ServerContextResponse[Any]&quot;)

class ServerContextRequest(
    BaseRequest[SCResp_t_co], Protocol[SCResp_t_co]
):
    ...

class ServerContextResponse(
    BaseResponse[SCReq_t_co], Protocol[SCReq_t_co]
):
    ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-19 12:17</div>
            <div class="timeline-body"><p>Thanks @MeGaGiGaGon -- that&#x27;s extremely helpful!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-19 12:47</div>
            <div class="timeline-body"><p>The class that&#x27;s causing us to panic here is <code>ServerContextResponse</code>. The way we figure out if a class is a <code>Protocol</code> class or not is by iterating through its explicit bases in reverse order and seeing if any of them are either <code>Protocol</code> or <code>Protocol[T, S]</code> etc:</p>
<p>https://github.com/astral-sh/ruff/blob/18a14bfaf114460e77b0792d49e0824e5c8a43d5/crates/ty_python_semantic/src/types/class.rs#L1640-L1668</p>
<p>It looks like at an earlier stage of type-checking, we looked at <code>ServerContextResponse</code>&#x27;s explicit bases, saw <code>Protocol</code> in there, decided it was a <code>Protocol</code> class, and created a <code>ProtocolInstanceType</code>. But later on, when looking at the same class, we now think that the types of the class&#x27;s explicit bases are <code>[Never, Never]</code> rather than <code>[&lt;class &#x27;BaseResponse[SCReq_t_co@ServerContextResponse]&#x27;&gt;, typing.Protocol[SCReq_t_co]]</code> -- meaning that we no longer infer it as being a protocol class, and therefore causing us to panic when we retrieve the interface for a previously constructed <code>ProtocolInstanceType</code> that refers to this class.</p>
<p>I came to this conclusion by adding these debug prints:</p>
<pre><code>diff --git a/crates/ty_python_semantic/src/types/class.rs b/crates/ty_python_semantic/src/types/class.rs
index 8ac9eca111..46494f73e7 100644
--- a/crates/ty_python_semantic/src/types/class.rs
+++ b/crates/ty_python_semantic/src/types/class.rs
@@ -1648,6 +1648,15 @@ impl&lt;&#x27;db&gt; ClassLiteral&lt;&#x27;db&gt; {
         self.known(db)
             .map(KnownClass::is_protocol)
             .unwrap_or_else(|| {
+                if self.name(db) == &quot;ServerContextResponse&quot; {
+                    println!(
+                        &quot;Explicit bases: {:?}&quot;,
+                        self.explicit_bases(db)
+                            .iter()
+                            .map(|t| t.display(db).to_string())
+                            .collect::&lt;Vec&lt;_&gt;&gt;()
+                    );
+                }
                 // Iterate through the last three bases of the class
                 // searching for `Protocol` or `Protocol[]` in the bases list.
                 //
diff --git a/crates/ty_python_semantic/src/types/protocol_class.rs b/crates/ty_python_semantic/src/types/protocol_class.rs
index 6cb204231f..b5a143a06b 100644
--- a/crates/ty_python_semantic/src/types/protocol_class.rs
+++ b/crates/ty_python_semantic/src/types/protocol_class.rs
@@ -37,6 +37,9 @@ impl&lt;&#x27;db&gt; ClassLiteral&lt;&#x27;db&gt; {
 impl&lt;&#x27;db&gt; ClassType&lt;&#x27;db&gt; {
     /// Returns `Some` if this is a protocol class, `None` otherwise.
     pub(super) fn into_protocol_class(self, db: &amp;&#x27;db dyn Db) -&gt; Option&lt;ProtocolClass&lt;&#x27;db&gt;&gt; {
+        if self.name(db) == &quot;ServerContextResponse&quot; {
+            dbg!(self.is_protocol(db));
+        }
         self.is_protocol(db).then_some(ProtocolClass(self))
     }
 }
</code></pre>
<p>Which, for the minimal repro above, cause us to print:</p>
<pre><code>Explicit bases: [&quot;&lt;class &#x27;BaseResponse[SCReq_t_co@ServerContextResponse]&#x27;&gt;&quot;, &quot;typing.Protocol[SCReq_t_co]&quot;]
Explicit bases: [&quot;&lt;class &#x27;BaseResponse[SCReq_t_co@ServerContextResponse]&#x27;&gt;&quot;, &quot;typing.Protocol[SCReq_t_co]&quot;]
[crates/ty_python_semantic/src/types/protocol_class.rs:41:13] self.is_protocol(db) = true
Explicit bases: [&quot;&lt;class &#x27;BaseResponse[SCReq_t_co@ServerContextResponse]&#x27;&gt;&quot;, &quot;typing.Protocol[SCReq_t_co]&quot;]
Explicit bases: [&quot;&lt;class &#x27;BaseResponse[SCReq_t_co@ServerContextResponse]&#x27;&gt;&quot;, &quot;typing.Protocol[SCReq_t_co]&quot;]
Explicit bases: [&quot;&lt;class &#x27;BaseResponse[SCReq_t_co@ServerContextResponse]&#x27;&gt;&quot;, &quot;typing.Protocol[SCReq_t_co]&quot;]
Explicit bases: [&quot;&lt;class &#x27;BaseResponse[SCReq_t_co@ServerContextResponse]&#x27;&gt;&quot;, &quot;typing.Protocol[SCReq_t_co]&quot;]
[crates/ty_python_semantic/src/types/protocol_class.rs:41:13] self.is_protocol(db) = true
Explicit bases: [&quot;&lt;class &#x27;BaseResponse[SCReq_t_co@ServerContextResponse]&#x27;&gt;&quot;, &quot;typing.Protocol[SCReq_t_co]&quot;]
Explicit bases: [&quot;&lt;class &#x27;BaseResponse[SCReq_t_co@ServerContextResponse]&#x27;&gt;&quot;, &quot;typing.Protocol[SCReq_t_co]&quot;]
Explicit bases: [&quot;Never&quot;, &quot;Never&quot;]
[crates/ty_python_semantic/src/types/protocol_class.rs:41:13] self.is_protocol(db) = false
Explicit bases: [&quot;Never&quot;, &quot;Never&quot;]
</code></pre>
<p>I don&#x27;t understand how this can be possible, since <code>explicit_bases</code> is a Salsa query: surely after it&#x27;s been called once, the result should be cached and it should return the same types every time?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-19 13:37</div>
            <div class="timeline-body"><blockquote>
<p>I don&#x27;t understand how this can be possible, since explicit_bases is a Salsa query: surely after it&#x27;s been called once, the result should be cached and it should return the same types every time?</p>
</blockquote>
<p>Unless there&#x27;s a cycle, in which case the query runs many times. But all other queries participating in the same cycle should re-run.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-19 13:39</div>
            <div class="timeline-body"><blockquote>
<p>Unless there&#x27;s a cycle, in which case the query runs many times</p>
</blockquote>
<p>Right, but my debug print is printing the value <em>returned</em> by <code>ClassLiteral::explicit_bases()</code>. It will only return a result after the cycle has converged, I think? And after it&#x27;s returned a value once, that value should be cached, and it shouldn&#x27;t ever run the query again?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-19 13:51</div>
            <div class="timeline-body"><blockquote>
<p>It will only return a result after the cycle has converged, I think?</p>
</blockquote>
<p><code>is_protocol</code> might participate in the cycle and it can then see the provisional value (not converged value). This changed when I improved cycle handling performance. If there are multiple nested cycles, we no longer iterate the inner cycle to completion before iterating the outer cycle because this has exponential runtime. Instead, all cycles (the outermost and all nested cycles) iterate at once, all seeing the provisional values of the other cycle heads until they all converge. This has the benefit that the complexity is bound by how quickly the problem converges and not by the number of nested cycles + how quickly the problem converges</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-19 13:53</div>
            <div class="timeline-body"><p>OK, thanks. In that case this <code>.expect()</code> call seems definitely unsafe, as we can&#x27;t rely on <code>is_protocol</code> returning a consistent thing for one class.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-19 14:24</div>
            <div class="timeline-body"><p>Here&#x27;s a patch that gets rid of the <code>.expect()</code> call:</p>

Patch

<pre><code>diff --git a/crates/ty_python_semantic/src/types/display.rs b/crates/ty_python_semantic/src/types/display.rs
index b8a8a05ac4..f003b5d2cd 100644
--- a/crates/ty_python_semantic/src/types/display.rs
+++ b/crates/ty_python_semantic/src/types/display.rs
@@ -195,7 +195,7 @@ impl&lt;&#x27;db&gt; super::visitor::TypeVisitor&lt;&#x27;db&gt; for AmbiguousClassCollector&lt;&#x27;db&gt; {
             Type::ProtocolInstance(ProtocolInstanceType {
                 inner: Protocol::FromClass(class),
                 ..
-            }) =&gt; return self.visit_type(db, Type::from(class)),
+            }) =&gt; return self.visit_type(db, Type::from(*class)),
             _ =&gt; {}
         }
 
@@ -392,12 +392,14 @@ impl Display for DisplayRepresentation&lt;&#x27;_&gt; {
                 }
             }
             Type::ProtocolInstance(protocol) =&gt; match protocol.inner {
-                Protocol::FromClass(ClassType::NonGeneric(class)) =&gt; {
-                    class.display_with(self.db, self.settings.clone()).fmt(f)
-                }
-                Protocol::FromClass(ClassType::Generic(alias)) =&gt; {
-                    alias.display_with(self.db, self.settings.clone()).fmt(f)
-                }
+                Protocol::FromClass(class) =&gt; match *class {
+                    ClassType::NonGeneric(class) =&gt; {
+                        class.display_with(self.db, self.settings.clone()).fmt(f)
+                    }
+                    ClassType::Generic(alias) =&gt; {
+                        alias.display_with(self.db, self.settings.clone()).fmt(f)
+                    }
+                },
                 Protocol::Synthesized(synthetic) =&gt; {
                     f.write_str(&quot;&lt;Protocol with members &quot;)?;
                     let interface = synthetic.interface();
diff --git a/crates/ty_python_semantic/src/types/generics.rs b/crates/ty_python_semantic/src/types/generics.rs
index 169b69e496..45d1cea575 100644
--- a/crates/ty_python_semantic/src/types/generics.rs
+++ b/crates/ty_python_semantic/src/types/generics.rs
@@ -1565,9 +1565,9 @@ impl&lt;&#x27;db&gt; SpecializationBuilder&lt;&#x27;db&gt; {
                     // generic protocol, we will need to check the types of the protocol members to be
                     // able to infer the specialization of the protocol that the class implements.
                     Type::ProtocolInstance(ProtocolInstanceType {
-                        inner: Protocol::FromClass(ClassType::Generic(alias)),
+                        inner: Protocol::FromClass(class),
                         ..
-                    }) =&gt; Some(alias),
+                    }) =&gt; class.into_generic_alias(),
                     _ =&gt; None,
                 };
 
diff --git a/crates/ty_python_semantic/src/types/instance.rs b/crates/ty_python_semantic/src/types/instance.rs
index 523f7fc796..ac7e5294b9 100644
--- a/crates/ty_python_semantic/src/types/instance.rs
+++ b/crates/ty_python_semantic/src/types/instance.rs
@@ -10,7 +10,7 @@ use crate::semantic_index::definition::Definition;
 use crate::types::constraints::{ConstraintSet, IteratorConstraintsExtension};
 use crate::types::enums::is_single_member_enum;
 use crate::types::generics::{InferableTypeVars, walk_specialization};
-use crate::types::protocol_class::walk_protocol_interface;
+use crate::types::protocol_class::{ProtocolClass, walk_protocol_interface};
 use crate::types::tuple::{TupleSpec, TupleType};
 use crate::types::{
     ApplyTypeMappingVisitor, ClassBase, ClassLiteral, FindLegacyTypeVarsVisitor,
@@ -44,13 +44,17 @@ impl&lt;&#x27;db&gt; Type&lt;&#x27;db&gt; {
                     .as_ref(),
             )),
             Some(KnownClass::Object) =&gt; Type::object(),
-            _ if class_literal.is_protocol(db) =&gt; {
-                Self::ProtocolInstance(ProtocolInstanceType::from_class(class))
-            }
-            _ if class_literal.is_typed_dict(db) =&gt; Type::typed_dict(class),
-            // We don&#x27;t call non_tuple_instance here because we&#x27;ve already checked that the class
-            // is not `object`
-            _ =&gt; Type::NominalInstance(NominalInstanceType(NominalInstanceInner::NonTuple(class))),
+            _ =&gt; class_literal
+                .is_typed_dict(db)
+                .then(|| Type::typed_dict(class))
+                .or_else(|| {
+                    class.into_protocol_class(db).map(|protocol_class| {
+                        Self::ProtocolInstance(ProtocolInstanceType::from_class(protocol_class))
+                    })
+                })
+                .unwrap_or(Type::NominalInstance(NominalInstanceType(
+                    NominalInstanceInner::NonTuple(class),
+                ))),
         }
     }
 
@@ -601,7 +605,7 @@ pub(super) fn walk_protocol_instance_type&lt;&#x27;db, V: super::visitor::TypeVisitor&lt;&#x27;d
 impl&lt;&#x27;db&gt; ProtocolInstanceType&lt;&#x27;db&gt; {
     // Keep this method private, so that the only way of constructing `ProtocolInstanceType`
     // instances is through the `Type::instance` constructor function.
-    fn from_class(class: ClassType&lt;&#x27;db&gt;) -&gt; Self {
+    fn from_class(class: ProtocolClass&lt;&#x27;db&gt;) -&gt; Self {
         Self {
             inner: Protocol::FromClass(class),
             _phantom: PhantomData,
@@ -625,7 +629,7 @@ impl&lt;&#x27;db&gt; ProtocolInstanceType&lt;&#x27;db&gt; {
     pub(super) fn as_nominal_type(self) -&gt; Option&lt;NominalInstanceType&lt;&#x27;db&gt;&gt; {
         match self.inner {
             Protocol::FromClass(class) =&gt; {
-                Some(NominalInstanceType(NominalInstanceInner::NonTuple(class)))
+                Some(NominalInstanceType(NominalInstanceInner::NonTuple(*class)))
             }
             Protocol::Synthesized(_) =&gt; None,
         }
@@ -634,7 +638,7 @@ impl&lt;&#x27;db&gt; ProtocolInstanceType&lt;&#x27;db&gt; {
     /// Return the meta-type of this protocol-instance type.
     pub(super) fn to_meta_type(self, db: &amp;&#x27;db dyn Db) -&gt; Type&lt;&#x27;db&gt; {
         match self.inner {
-            Protocol::FromClass(class) =&gt; SubclassOfType::from(db, class),
+            Protocol::FromClass(class) =&gt; SubclassOfType::from(db, *class),
 
             // TODO: we can and should do better here.
             //
@@ -805,11 +809,17 @@ impl&lt;&#x27;db&gt; VarianceInferable&lt;&#x27;db&gt; for ProtocolInstanceType&lt;&#x27;db&gt; {
 
 /// An enumeration of the two kinds of protocol types: those that originate from a class
 /// definition in source code, and those that are synthesized from a set of members.
+///
+/// # Ordering
+///
+/// Ordering between variants is stable and should be the same between runs.
+/// Ordering within variants is based on the wrapped data&#x27;s salsa-assigned id and not on its values.
+/// The id may change between runs, or when e.g. a `Protocol` was garbage-collected and recreated.
 #[derive(
     Copy, Clone, Debug, Eq, PartialEq, Hash, salsa::Update, PartialOrd, Ord, get_size2::GetSize,
 )]
 pub(super) enum Protocol&lt;&#x27;db&gt; {
-    FromClass(ClassType&lt;&#x27;db&gt;),
+    FromClass(ProtocolClass&lt;&#x27;db&gt;),
     Synthesized(SynthesizedProtocolType&lt;&#x27;db&gt;),
 }
 
@@ -817,10 +827,7 @@ impl&lt;&#x27;db&gt; Protocol&lt;&#x27;db&gt; {
     /// Return the members of this protocol type
     fn interface(self, db: &amp;&#x27;db dyn Db) -&gt; ProtocolInterface&lt;&#x27;db&gt; {
         match self {
-            Self::FromClass(class) =&gt; class
-                .into_protocol_class(db)
-                .expect(&quot;Class wrapped by `Protocol` should be a protocol class&quot;)
-                .interface(db),
+            Self::FromClass(class) =&gt; class.interface(db),
             Self::Synthesized(synthesized) =&gt; synthesized.interface(),
         }
     }
diff --git a/crates/ty_python_semantic/src/types/protocol_class.rs b/crates/ty_python_semantic/src/types/protocol_class.rs
index 6cb204231f..5e77bc5e99 100644
--- a/crates/ty_python_semantic/src/types/protocol_class.rs
+++ b/crates/ty_python_semantic/src/types/protocol_class.rs
@@ -42,7 +42,15 @@ impl&lt;&#x27;db&gt; ClassType&lt;&#x27;db&gt; {
 }
 
 /// Representation of a single `Protocol` class definition.
-#[derive(Debug, Copy, Clone, PartialEq, Eq)]
+///
+/// # Ordering
+///
+/// Ordering between variants is stable and should be the same between runs.
+/// Ordering within variants is based on the wrapped data&#x27;s salsa-assigned id and not on its values.
+/// The id may change between runs, or when e.g. a `ProtocolClass` was garbage-collected and recreated.
+#[derive(
+    Debug, Copy, Clone, PartialEq, Eq, Hash, salsa::Update, get_size2::GetSize, PartialOrd, Ord,
+)]
 pub(super) struct ProtocolClass&lt;&#x27;db&gt;(ClassType&lt;&#x27;db&gt;);
 
 impl&lt;&#x27;db&gt; ProtocolClass&lt;&#x27;db&gt; {
@@ -124,6 +132,19 @@ impl&lt;&#x27;db&gt; ProtocolClass&lt;&#x27;db&gt; {
             report_undeclared_protocol_member(context, first_definition, self, class_place_table);
         }
     }
+
+    pub(super) fn apply_type_mapping_impl&lt;&#x27;a&gt;(
+        self,
+        db: &amp;&#x27;db dyn Db,
+        type_mapping: &amp;TypeMapping&lt;&#x27;a, &#x27;db&gt;,
+        tcx: TypeContext&lt;&#x27;db&gt;,
+        visitor: &amp;ApplyTypeMappingVisitor&lt;&#x27;db&gt;,
+    ) -&gt; Self {
+        Self(
+            self.0
+                .apply_type_mapping_impl(db, type_mapping, tcx, visitor),
+        )
+    }
 }
 
 impl&lt;&#x27;db&gt; Deref for ProtocolClass&lt;&#x27;db&gt; {
</code></pre>


<p>But with that patch applied, we still panic on the repro in <a href="https://github.com/astral-sh/ty/issues/1587">astral-sh/ty#1587</a>#issuecomment-3551075375, just in a different place:</p>
<pre><code>error[panic]: Panicked at /Users/alexw/.cargo/git/checkouts/salsa-e6f3bb7c2a062968/a885bb4/src/function/execute.rs:321:21 when checking `/Users/alexw/dev/ruff/foo.py`: `ClassLiteral &lt; &#x27;db &gt;::explicit_bases_(Id(4c09)): execute: too many cycle iterations`
info: This indicates a bug in ty.
info: If you could open an issue at https://github.com/astral-sh/ty/issues/new?title=%5Bpanic%5D, we&#x27;d be very appreciative!
info: Platform: macos aarch64
info: Version: ruff/0.14.5+60 (18a14bfaf 2025-11-19)
info: Args: [&quot;target/debug/ty&quot;, &quot;check&quot;, &quot;foo.py&quot;, &quot;--python-version=3.14&quot;]
info: run with `RUST_BACKTRACE=1` environment variable to show the full backtrace information
info: query stacktrace:
   0: cached_protocol_interface(Id(6805))
             at crates/ty_python_semantic/src/types/protocol_class.rs:790
   1: is_equivalent_to_object_inner(Id(8003))
             at crates/ty_python_semantic/src/types/instance.rs:667
   2: infer_deferred_types(Id(1409))
             at crates/ty_python_semantic/src/types/infer.rs:141
             cycle heads: infer_definition_types(Id(140b)) -&gt; iteration = 200, TypeVarInstance &lt; &#x27;db &gt;::lazy_bound_(Id(5803)) -&gt; iteration = 200
   3: TypeVarInstance &lt; &#x27;db &gt;::lazy_bound_(Id(5802))
             at crates/ty_python_semantic/src/types.rs:8734
   4: infer_definition_types(Id(140c))
             at crates/ty_python_semantic/src/types/infer.rs:94
   5: infer_deferred_types(Id(140a))
             at crates/ty_python_semantic/src/types/infer.rs:141
   6: TypeVarInstance &lt; &#x27;db &gt;::lazy_bound_(Id(5803))
             at crates/ty_python_semantic/src/types.rs:8734
   7: infer_definition_types(Id(140b))
             at crates/ty_python_semantic/src/types/infer.rs:94
   8: infer_scope_types(Id(1000))
             at crates/ty_python_semantic/src/types/infer.rs:70
   9: check_file_impl(Id(c00))
             at crates/ty_project/src/lib.rs:535


Found 1 diagnostic
WARN A fatal error occurred while checking some files. Not all project files were analyzed. See the diagnostics list above for details.
</code></pre>
<p>I think this confirms that the reason why we were not considering the class a <code>Protocol</code> class later on was because we were trying to converge on a cycle for the <code>explicit_bases</code> query.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-19 14:25</div>
            <div class="timeline-body"><p>That patch might be worth applying anyway. It&#x27;s probably slightly more efficient, and it&#x27;s nice to get rid of <code>.expect()</code> calls where possible. It also makes it clear that the underlying bug here isn&#x27;t really in our <code>Protocol</code> machinery (edit: or, at least not the bit in <code>instance.rs</code>...? Not sure...).</p>
<p>I&#x27;ll make a PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-19 15:14</div>
            <div class="timeline-body"><blockquote>
<p>OK, thanks. In that case this .expect() call seems definitely unsafe, as we can&#x27;t rely on is_protocol returning a consistent thing for one class.</p>
</blockquote>
<p>I have to read the code more carefully but I&#x27;ve to catch a train. Overall, all queries that participate in a cycle should be rerun, and the results of a query are consistent within an iteration.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-24 20:26</div>
            <div class="timeline-body"><p>An x-failing mdtest for this was added in <a href="https://github.com/astral-sh/ruff/pull/21594">astral-sh/ruff#21594</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[panic] Class wrapped by `Protocol` should be a protocol class&quot; to &quot;[panic] `ClassLiteral::explicit_bases` fails to converge on a pair of mutually recursive `Protocol` definitions&quot; by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-24 20:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[panic] `ClassLiteral::explicit_bases` fails to converge on a pair of mutually recursive `Protocol` definitions&quot; to &quot;[panic] `ClassLiteral::explicit_bases` fails to converge on a pair of mutually recursive generic `Protocol` definitions&quot; by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-24 20:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-28 15:52</div>
            <div class="timeline-body"><p>@carljm is this still something you plan to look into next week?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-02 00:44</div>
            <div class="timeline-body"><p>I don&#x27;t remember saying that I planned to, but sure, if it needs an owner I&#x27;m happy to look into it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/carljm">@carljm</a> on 2025-12-02 00:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2025-12-04 23:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[panic] `ClassLiteral::explicit_bases` fails to converge on a pair of mutually recursive generic `Protocol` definitions&quot; to &quot;pair of mutually recursive generic `Protocol` definitions&quot; by <a href="https://github.com/carljm">@carljm</a> on 2025-12-04 23:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fatal</span> removed by <a href="https://github.com/carljm">@carljm</a> on 2025-12-04 23:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cycles</span> added by <a href="https://github.com/carljm">@carljm</a> on 2025-12-04 23:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone &quot;Beta&quot; by <a href="https://github.com/carljm">@carljm</a> on 2025-12-04 23:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Stable&quot; by <a href="https://github.com/carljm">@carljm</a> on 2025-12-04 23:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by <a href="https://github.com/carljm">@carljm</a> on 2025-12-04 23:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-04 23:22</div>
            <div class="timeline-body"><p>This no longer panics, but we can have false negatives on one of the upper bounds; there are TODOs in the tests to capture this, should also be fixable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-05 11:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by <a href="https://github.com/carljm">@carljm</a> on 2025-12-05 17:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cycles</span> removed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-19 12:07</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:26:01 UTC
    </footer>
</body>
</html>
