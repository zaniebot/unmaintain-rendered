<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validation of attribute assignments does not handle unions/intersections correctly - astral-sh/ty #1163</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Validation of attribute assignments does not handle unions/intersections correctly</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1163">#1163</a>
        opened by <a href="https://github.com/Glyphack">@Glyphack</a>
        on 2025-09-10 13:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Glyphack">@Glyphack</a> on 2025-09-10 13:09</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>This example is extracted from mdtests after adding explicit <code>self</code> annotation (related https://github.com/astral-sh/ruff/pull/18007)</p>
<p>After adding self annotation the following example fails:</p>
<pre><code class="language-py">from typing import Literal, Any

class DataDescriptor:
    def __get__(self: &quot;DataDescriptor&quot;, instance: object, owner: type | None = None) -&gt; Literal[&quot;data&quot;]:
        return &quot;data&quot;

    def __set__(self: &quot;DataDescriptor&quot;, instance: object, value: int) -&gt; None:
        pass

def _(flag: bool):
    class Meta7(type):
        if flag:
            attr: DataDescriptor = DataDescriptor()
        else:
            attr: Literal[2] = 2

    class C7(metaclass=Meta7):
        pass

    # Invalid assignment to data descriptor attribute `attr` on type `&lt;class 'C7'&gt;` with custom `__set__` method (invalid-assignment)
    C7.attr = 2 if flag else 100
</code></pre>
<p>https://play.ty.dev/d25588da-713f-44d3-b35e-937808f43c06</p>
<p>I expected the error to be related to DataDescriptor, since we added the <code>self</code> annotation and it failed.
I could not find why adding <code>self</code> annotation causes the issue so I tried to change the other annotation.</p>
<p>This example has no diagnostics:</p>
<pre><code class="language-py">from typing import Literal, Any

class DataDescriptor:
    def __get__(self: &quot;DataDescriptor&quot;, instance: object, owner: type | None = None) -&gt; Literal[&quot;data&quot;]:
        return &quot;data&quot;

    def __set__(self: &quot;DataDescriptor&quot;, instance: object, value: int) -&gt; None:
        pass

def _(flag: bool):
    class Meta7(type):
        attr: DataDescriptor = DataDescriptor()

    class C7(metaclass=Meta7):
        pass

    C7.attr = 2 if flag else 100
</code></pre>
<h3>Version</h3>
<p>fd7eb1e22</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "False positive `invalid-assignment` for union of `DataDescriptor` and `Literal` in metaclass attribute" to "False positive `invalid-assignment` on `DataDescriptor` metaclass attribute when using explicit `self` annotation" by @Glyphack on 2025-09-10 13:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-09-10 18:04</div>
            <div class="timeline-body"><p>@sharkdp Is this something you can look into?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @sharkdp by @sharkdp on 2025-09-10 18:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-10 18:26</div>
            <div class="timeline-body"><p>Yes, I noticed this too on the test changes for https://github.com/astral-sh/ruff/pull/20303, and wanted to look into it anyway. Thanks for reporting this separately @Glyphack.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "False positive `invalid-assignment` on `DataDescriptor` metaclass attribute when using explicit `self` annotation" to "Validation of attribute assignments does not handle unions/intersections correctly" by @sharkdp on 2025-09-16 13:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @sharkdp on 2025-09-16 13:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">attribute access</span> added by @sharkdp on 2025-09-16 13:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-16 13:44</div>
            <div class="timeline-body"><p>The core issue here is that <code>validate_attribute_assignment</code> doesn't handle unions/intersections of attributes correctly. This can also be demonstrated with a much smaller, and easier-to-understand example. An error should be emitted in the final line here, but currently isn't:</p>
<pre><code class="language-py">def _(flag: bool):
    class C:
        if flag:
            attr: int = 1
        else:
            attr: str = &quot;&quot;

    C.attr = 2  # should be an error
</code></pre>
<p>https://play.ty.dev/f0d21117-4aa3-4ff4-9546-020bfcbfd84d</p>
<p>In the OP example, this is a related problem, where we look up the type of the attribute on the meta type, and get <code>DataDescriptor | Literal[2]</code> as a response. Instead of checking assignability to both of these types, we treat them as a union and try to call <code>__set__</code>. This leads to a problem, because <code>DataDescriptor | Literal[2]</code> is not assignable to the now-annotated <code>self</code> attribute on the <code>__set__</code> method.</p>
<p>The solution to this is to properly distribute our assignment validation logic over unions and intersections.</p>
<p>It doesn't seem like a high-priority issue for me, since it never came up elsewhere, and since conflicting declarations like these are not supported by any other type checker. I propose to keep this open for now, and fix it after the type-of-self changes have landed, after which it will be easier to see the impact of our fix. In the type-of-self PR, we can add a TODO to the test-case above for now.</p>
<p>FYI @AlexWaygood since you were working on a refactor of <code>validate_attribute_assignment</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-09-16 13:53</div>
            <div class="timeline-body"><blockquote>
<p>FYI <a href="https://github.com/AlexWaygood">@AlexWaygood</a> since you were working on a refactor of <code>validate_attribute_assignment</code>?</p>
</blockquote>
<p>Still am! It's still quite WIP right now though -- see https://github.com/astral-sh/ruff/pull/19936. And https://github.com/astral-sh/ruff/pull/20368 is higher priority for me to finish. And this week my top priority is working on a couple of release blockers for CPython 3.14.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @sharkdp by @sharkdp on 2025-09-30 07:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Stable" by @carljm on 2025-12-02 03:23</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 02:11:29 UTC
    </footer>
</body>
</html>
