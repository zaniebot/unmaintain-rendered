<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`UnboundLocalError` not detected when variable not declared as `global` or `nonlocal` is `del`'d - astral-sh/ty #769</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>UnboundLocalError</code> not detected when variable not declared as <code>global</code> or <code>nonlocal</code> is <code>del</code>'d</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/769">#769</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-07-05 17:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Ty doesn't emit any error on this code, but it should:</p>
<pre><code class="language-py">X = 42

def f():
    print(X)

    if False:
        del X
</code></pre>
<p>At runtime, calling <code>f()</code> will always fail:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; X = 42
&gt;&gt;&gt; def f():
...     print(X)
...     if False:
...         del X
...         
&gt;&gt;&gt; f()
Traceback (most recent call last):
  File &quot;&lt;python-input-3&gt;&quot;, line 1, in &lt;module&gt;
    f()
    ~^^
  File &quot;&lt;python-input-2&gt;&quot;, line 2, in f
    print(X)
          ^
UnboundLocalError: cannot access local variable 'X' where it is not associated with a value
</code></pre>
<p>The fact that there is a <code>del</code> statement affecting the <code>X</code> variable later on in the function means that <code>X</code> must be a local variable for the duration of the entire function scope. I.e., the <code>print()</code> call on the first line of the function that attempts to load the symbol <code>X</code> cannot reach the definition of <code>X</code> in the global scope. <code>X</code> can <em>only</em> ever be a local variable inside this function due to the later <code>del</code> statement, even though that <code>del</code> statement is unreachable.</p>
<p>Practically speaking, we need to edit this check so that it also checks whether there were any <em>deletions</em> in this scope as well as any <em>bindings</em> in this scope, and returns <code>Place::Unbound</code> if so: https://github.com/astral-sh/ruff/blob/44f2f77748f5ed36b78243075c849a091adfaaf8/crates/ty_python_semantic/src/types/infer.rs#L5708-L5719</p>
<p>@oconnor663, I wonder if you might be interested in this? It's sort-of adjacent to your work on the <code>nonlocal</code> statement :-)</p>
<h3>Version</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">runtime semantics</span> added by @AlexWaygood on 2025-07-05 17:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "`UnboundLocalError` not detected when variable not declared as `global` or `nonlocal` is del'd" to "`UnboundLocalError` not detected when variable not declared as `global` or `nonlocal` is `del`'d" by @AlexWaygood on 2025-07-05 17:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-07-05 17:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @oconnor663 by @oconnor663 on 2025-07-07 14:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-07-07 14:23</div>
            <div class="timeline-body"><p>Nice, I'll take it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-07-16 16:09</div>
            <div class="timeline-body"><p>There's a <a href="https://github.com/astral-sh/ruff/blob/291699b375f694c659fe82bdd68b149bde2494ee/crates/ty_python_semantic/resources/mdtest/del.md#L45-L47">related TODO</a> to lint on <code>del x</code> when there is no <code>x</code> in the local scope:</p>
<pre><code class="language-py">def delete():
    # TODO: this results in `UnboundLocalError`; we should emit `unresolved-reference`
    del x
</code></pre>
<p>Maybe once &quot;<code>del [name]</code> requires <code>[name]</code> in the local scope&quot; is enforced, then we won't need to implement &quot;<code>del [name]</code> causes all uses of <code>[name]</code> to resolve to the local binding&quot; as a separate rule, because the only way to make the <code>del</code> legal will be to make a local binding, and that has the same effect?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-16 16:35</div>
            <div class="timeline-body"><blockquote>
<p>Maybe once &quot;<code>del [name]</code> requires <code>[name]</code> in the local scope&quot; is enforced, then we won't need to implement &quot;<code>del [name]</code> causes all uses of <code>[name]</code> to resolve to the local binding&quot; as a separate rule, because the only way to make the <code>del</code> legal will be to make a local binding, and that has the same effect?</p>
</blockquote>
<p>I think the better strategy would be the opposite: if we implement &quot;<code>del [name]</code> causes all uses of <code>[name]</code> to resolve to the local binding&quot;, we shouldn't need a separate implementation for <code>&quot;del [name] requires [name] in the local scope&quot;</code> — it should naturally fall out of the semantics of the first rule. And the first rule is the more important one, because we won't (or, shouldn't, at least!) emit an <code>unresolved-reference</code> diagnostic for a <code>del</code> statement referring to an unresolved reference if the <code>del</code> statement is in a branch that we determine to be unreachable at type-inference time — but even if the <code>del</code> statement is unreachable, it <em>still</em> impacts the resolution of that name for all other loads in that scope</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-16 16:36</div>
            <div class="timeline-body"><p>@AlexWaygood this must have been painful to type out on your phone with all the backticks ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-16 16:37</div>
            <div class="timeline-body"><p>Shush</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-07-18 21:58</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:20:15 UTC
    </footer>
</body>
</html>
