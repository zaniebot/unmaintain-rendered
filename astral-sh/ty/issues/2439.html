<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emit diagnostic when specializing a non-generic class - astral-sh/ty #2439</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Emit diagnostic when specializing a non-generic class</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/2439">#2439</a>
        opened by <a href="https://github.com/tamireinhorn">@tamireinhorn</a>
        on 2026-01-11 03:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/tamireinhorn">@tamireinhorn</a> on 2026-01-11 03:56</div>
            <div class="timeline-body"><p>I wrote a function like:</p>
<pre><code class="language-py">def fetch_user_countries_count(
    source: str, source_ids: list[int]
) -&gt; sa.Sequence[sa.RowMapping[str, Any]]:
    user_locations = user_author_locations_cte(source=source, source_ids=source_ids)
    stmt = select_countries_with_author_count(user_locations)
    with SESSION() as sess:
        return sess.execute(stmt).mappings().all()
</code></pre>
<p>And yet, when I call it anywhere else, I get:</p>
<pre><code class="language-py">def fetch_user_countries_count(
    source: str,
    source_ids: list[int]
) -&gt; @Todo
</code></pre>
<p>I don't understand what else I should be doing. I tried changing the inner types but to no avail. I saw nothing mentioning said Todo type in the docs as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-11 14:16</div>
            <div class="timeline-body"><p>Hey, thanks for the report, and sorry for the confusing UX :-)</p>
<p>The <code>@Todo</code> type doesn't mean that you've done anything wrong -- it means that there's some missing logic in ty itself and we don't know how to infer a good type here. To know exactly what the <code>Todo</code> is about here, we'll need a way to reproduce this -- how is the variable <code>sa</code> defined in your code? Is that a third-party module?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @AlexWaygood on 2026-01-11 14:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> added by @AlexWaygood on 2026-01-11 17:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tamireinhorn">@tamireinhorn</a> on 2026-01-11 18:21</div>
            <div class="timeline-body"><blockquote>
<p>Hey, thanks for the report, and sorry for the confusing UX :-)</p>
<p>The <code>@Todo</code> type doesn't mean that you've done anything wrong -- it means that there's some missing logic in ty itself and we don't know how to infer a good type here. To know exactly what the <code>Todo</code> is about here, we'll need a way to reproduce this -- how is the variable <code>sa</code> defined in your code? Is that a third-party module?</p>
</blockquote>
<p>yeah, SA is defined as <code>import sqlalchemy as sa</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2026-01-12 05:47</div>
            <div class="timeline-body"><p>In debug build, it gives me the <code>@Todo(specialized non-generic class)</code> type:</p>
<pre><code class="language-py">import typing as t

import sqlalchemy as sa

def _(x: sa.Sequence[sa.RowMapping[str, t.Any]]):
    # revealed: @Todo(specialized non-generic class)
    reveal_type(x)
</code></pre>
<p>mypy and Pyright both error on the annotation:</p>
<pre><code>mypy: &quot;Sequence&quot; expects no type arguments, but 1 given  [type-arg]
mypy: &quot;RowMapping&quot; expects no type arguments, but 2 given  [type-arg]
Pyright: Expected no type arguments for class &quot;RowMapping&quot; [reportInvalidTypeArguments]
</code></pre>
<p>ty doesn't raise this error and this suggests that these classes is non-generic, so I think we just need to raise a diagnostic and infer <code>Unknown</code> for these cases. In the code, it's marked as TODO:</p>
<p>https://github.com/astral-sh/ruff/blob/09ff3e705639e4773f185994744390fdeb518e8e/crates/ty_python_semantic/src/types/infer/builder/type_expression.rs#L730-L732</p>
<p>https://github.com/astral-sh/ruff/blob/09ff3e705639e4773f185994744390fdeb518e8e/crates/ty_python_semantic/src/types/infer/builder/type_expression.rs#L1066-L1068</p>
<p>I don't see any open issues for this so we can use this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "@Todo type" to "Emit diagnostic when specializing a non-generic class" by @dhruvmanila on 2026-01-12 05:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @dhruvmanila on 2026-01-12 05:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> removed by @dhruvmanila on 2026-01-12 05:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">generics</span> added by @dhruvmanila on 2026-01-12 05:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by @dhruvmanila on 2026-01-12 05:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Stable" by @dhruvmanila on 2026-01-12 05:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tamireinhorn">@tamireinhorn</a> on 2026-01-12 06:56</div>
            <div class="timeline-body"><blockquote>
<p>In debug build, it gives me the <code>@Todo(specialized non-generic class)</code> type:</p>
<pre><code class="language-py">import typing as t

import sqlalchemy as sa

def _(x: sa.Sequence[sa.RowMapping[str, t.Any]]):
    # revealed: @Todo(specialized non-generic class)
    reveal_type(x)
</code></pre>
<p>mypy and Pyright both error on the annotation:</p>
<pre><code>mypy: &quot;Sequence&quot; expects no type arguments, but 1 given  [type-arg]
mypy: &quot;RowMapping&quot; expects no type arguments, but 2 given  [type-arg]
Pyright: Expected no type arguments for class &quot;RowMapping&quot; [reportInvalidTypeArguments]
</code></pre>
<p>ty doesn't raise this error and this suggests that these classes is non-generic, so I think we just need to raise a diagnostic and infer <code>Unknown</code> for these cases. In the code, it's marked as TODO:</p>
<p>https://github.com/astral-sh/ruff/blob/09ff3e705639e4773f185994744390fdeb518e8e/crates/ty_python_semantic/src/types/infer/builder/type_expression.rs#L730-L732</p>
<p>https://github.com/astral-sh/ruff/blob/09ff3e705639e4773f185994744390fdeb518e8e/crates/ty_python_semantic/src/types/infer/builder/type_expression.rs#L1066-L1068</p>
<p>I don't see any open issues for this so we can use this.</p>
</blockquote>
<p>I forgot to mention, but on later testing, I removed the wrong type arguments for RowMapping, and ty still spat out the same type. I put them in just to check what happened and did not remove them from the example posted here. Can edit if preferred.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2026-01-12 09:34</div>
            <div class="timeline-body"><blockquote>
<p>I forgot to mention, but on later testing, I removed the wrong type arguments for RowMapping, and ty still spat out the same type. I put them in just to check what happened and did not remove them from the example posted here. Can edit if preferred.</p>
</blockquote>
<p>Yeah, I suspect that's because <code>sa.Sequence</code> itself is a non-generic class (as highlighted by mypy)?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 09:59:02 UTC
    </footer>
</body>
</html>
