<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`ty` not detecting `pixi` environments if installed by `pixi global` - astral-sh/ty #796</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>ty</code> not detecting <code>pixi</code> environments if installed by <code>pixi global</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/796">#796</a>
        opened by <a href="https://github.com/JaRoSchm">@JaRoSchm</a>
        on 2025-07-10 13:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/JaRoSchm">@JaRoSchm</a> on 2025-07-10 13:28</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Hi, although https://github.com/astral-sh/ruff/pull/18267 has been merged a while back, there is still a problem if <code>ty</code> is installed by <code>pixi global install -c conda-forge/label/ty_alpha -c conda-forge ty</code> (the following does not occur if <code>ty</code> is installed by <code>uv tool install ty</code>). I have the most recent versions (<code>ty 0.0.1-alpha.14</code> and <code>pixi 0.49.0</code>) of both tools installed.</p>
<p>First, I create a pixi project resulting in this <code>pixi.toml</code>:</p>
<pre><code class="language-toml">[workspace]
authors = [&quot;...&quot;]
channels = [&quot;conda-forge&quot;]
name = &quot;test_pixi_ty&quot;
platforms = [&quot;linux-64&quot;]
version = &quot;0.1.0&quot;

[tasks]

[dependencies]
python = &quot;&gt;=3.13.5,&lt;3.14&quot;
numpy = &quot;&gt;=2.3.1,&lt;3&quot;
</code></pre>
<p>Then I run the command <code>pixi shell</code> which correctly sets <code>$CONDA_PREFIX</code> to <code>/home/username/Devel/test_pixi_ty/.pixi/envs/default</code>. The variable <code>$VIRTUAL_ENV</code> is not set. If I create a file which just imports numpy, this runs without problem. Running <code>ty check</code> on the file gives</p>
<pre><code class="language-sh">WARN ty is pre-release software and not ready for production use. Expect to encounter bugs, missing features, and fatal errors.
error[unresolved-import]: Cannot resolve imported module `numpy`
 --&gt; test.py:1:8
  |
1 | import numpy as np
  |        ^^^^^^^^^^^
  |
info: make sure your Python environment is properly configured: https://docs.astral.sh/ty/modules/#python-environment
info: rule `unresolved-import` is enabled by default

Found 1 diagnostic
</code></pre>
<p>Although I don't know anything about the internals of <code>pixi</code>, I suspect that the reason for this is, that <code>pixi</code> installs its global tools into their own &quot;conda&quot; environment. So even if the correct <code>$CONDA_PREFIX</code> is set in my shell, <code>ty</code> somehow seems to pick up the wrong one from its own environment. An indication for this is that if I add numpy to the global environment of <code>ty</code> (<code>pixi global install -c conda-forge/label/ty_alpha -c conda-forge ty --with numpy</code>), everything works as expected.</p>
<p>As this architecture is fundamental to <code>pixi</code> and probably will not be changed, is there something <code>ty</code> can do to pick up the right <code>$CONDA_PREFIX</code> variable?</p>
<p>Thank your for your great work!</p>
<h3>Version</h3>
<p>ty 0.0.1-alpha.14</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-10 13:34</div>
            <div class="timeline-body"><p>cc @wolfv maybe you have some insights here.</p>
<p>Can you share verbose output for the ty invocation? Is Pixi setting <code>CONDA_PREFIX</code> to the tool environment on invocation?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JaRoSchm">@JaRoSchm</a> on 2025-07-10 14:17</div>
            <div class="timeline-body"><p>Here is the verbose output:</p>
<details>

<pre><code class="language-sh">2025-07-10 16:11:18.927157761 WARN ty is pre-release software and not ready for production use. Expect to encounter bugs, missing features, and fatal errors.
2025-07-10 16:11:18.927991267 DEBUG Version: 0.0.1-alpha.14
2025-07-10 16:11:18.928013409 DEBUG Architecture: x86_64, OS: linux, case-sensitive: case-sensitive
2025-07-10 16:11:18.928116703 DEBUG Searching for a project in '/home/jschmidt/Devel/test_pixi_ty'
2025-07-10 16:11:18.928143584 DEBUG The ancestor directories contain no `pyproject.toml`. Falling back to a virtual project.
2025-07-10 16:11:18.928162048 DEBUG Searching for a user-level configuration at `/home/jschmidt/.config/ty/ty.toml`
2025-07-10 16:11:18.953596231 INFO Defaulting to python-platform `linux`
2025-07-10 16:11:18.953641907 DEBUG Resolving `CONDA_PREFIX` environment variable: /home/jschmidt/.pixi/envs/ty
2025-07-10 16:11:18.953679929 DEBUG Attempting to parse virtual environment metadata at '/home/jschmidt/.pixi/envs/ty/pyvenv.cfg'
2025-07-10 16:11:18.953690679 DEBUG Searching for site-packages directory in sys.prefix /home/jschmidt/.pixi/envs/ty
2025-07-10 16:11:18.953882369 DEBUG Resolved site-packages directories for this environment are: SitePackagesPaths({&quot;/home/jschmidt/.pixi/envs/ty/lib/python3.13/site-packages&quot;})
2025-07-10 16:11:18.953911073 DEBUG Including `.` in `environment.root`
2025-07-10 16:11:18.953936301 DEBUG Adding first-party search path '/home/jschmidt/Devel/test_pixi_ty'
2025-07-10 16:11:18.953952261 DEBUG Using vendored stdlib
2025-07-10 16:11:18.954306306 DEBUG Adding site-packages search path '/home/jschmidt/.pixi/envs/ty/lib/python3.13/site-packages'
2025-07-10 16:11:18.954332485 INFO Python version: Python 3.13, platform: linux
2025-07-10 16:11:18.954770248 DEBUG Setting included paths: 1
2025-07-10 16:11:18.954787901 DEBUG Reloading files for project `test_pixi_ty`
2025-07-10 16:11:18.954918797 DEBUG Starting main loop
2025-07-10 16:11:18.954933545 DEBUG Waiting for next main loop message.
2025-07-10 16:11:18.954993467 DEBUG Checking project 'test_pixi_ty'
2025-07-10 16:11:18.957628961 INFO Indexed 1 file(s) in 0.003s
Checking ------------------------------------------------------------ 0/1 files                                                                                                                         2025-07-10 16:11:18.957833716 DEBUG Checking file '/home/jschmidt/Devel/test_pixi_ty/test.py'
2025-07-10 16:11:18.958153667 DEBUG Resolving dynamic module resolution paths
2025-07-10 16:11:18.958198692 DEBUG Skipping editable installation: /home/jschmidt/.pixi/envs/ty/lib/python3.1/site-packages does not point to a directory
2025-07-10 16:11:18.958216285 DEBUG Skipping editable installation: /home/jschmidt/.pixi/envs/ty/lib/python/site-packages does not point to a directory
2025-07-10 16:11:18.958251491 DEBUG Module `numpy` not found in search paths
Checking ------------------------------------------------------------ 1/1 files                                                                                                                         2025-07-10 16:11:18.958356769 DEBUG Checking all files took 0.001s
error[unresolved-import]: Cannot resolve imported module `numpy`
 --&gt; test.py:1:8
  |
1 | import numpy as np
  |        ^^^^^^^^^^^
  |
info: make sure your Python environment is properly configured: https://docs.astral.sh/ty/modules/#python-environment
info: rule `unresolved-import` is enabled by default

Found 1 diagnostic
2025-07-10 16:11:18.958483457 DEBUG Exiting main loop
(test_pixi_ty) (CPG_stable) jschmidt-laptop:~/Devel/test_pixi_ty % ty check -vvv test.py
  2025-07-10T14:11:28.500682Z  WARN ty: ty is pre-release software and not ready for production use. Expect to encounter bugs, missing features, and fatal errors.
    at crates/ty/src/lib.rs:64 on ThreadId(1)

  2025-07-10T14:11:28.500703Z DEBUG ty: Version: 0.0.1-alpha.14
    at crates/ty/src/lib.rs:69 on ThreadId(1)

  2025-07-10T14:11:28.500726Z DEBUG ruff_db::system::os: Architecture: x86_64, OS: linux, case-sensitive: case-sensitive
    at crates/ruff_db/src/system/os.rs:45 on ThreadId(1)

  2025-07-10T14:11:28.500823Z DEBUG ty_project::metadata: Searching for a project in '/home/jschmidt/Devel/test_pixi_ty'
    at crates/ty_project/src/metadata.rs:134 on ThreadId(1)

  2025-07-10T14:11:28.500852Z DEBUG ty_project::metadata: The ancestor directories contain no `pyproject.toml`. Falling back to a virtual project.
    at crates/ty_project/src/metadata.rs:240 on ThreadId(1)

  2025-07-10T14:11:28.500939Z DEBUG ty_project::metadata::configuration_file: Searching for a user-level configuration at `/home/jschmidt/.config/ty/ty.toml`
    at crates/ty_project/src/metadata/configuration_file.rs:47 on ThreadId(1)

  2025-07-10T14:11:28.513582Z  INFO ty_project::metadata::options: Defaulting to python-platform `linux`
    at crates/ty_project/src/metadata/options.rs:133 on ThreadId(1)

  2025-07-10T14:11:28.513620Z DEBUG ty_python_semantic::site_packages: Resolving `CONDA_PREFIX` environment variable: /home/jschmidt/.pixi/envs/ty
    at crates/ty_python_semantic/src/site_packages.rs:148 on ThreadId(1)

  2025-07-10T14:11:28.513646Z DEBUG ty_python_semantic::site_packages: Attempting to parse virtual environment metadata at '/home/jschmidt/.pixi/envs/ty/pyvenv.cfg'
    at crates/ty_python_semantic/src/site_packages.rs:300 on ThreadId(1)

  2025-07-10T14:11:28.513655Z DEBUG ty_python_semantic::site_packages: Searching for site-packages directory in sys.prefix /home/jschmidt/.pixi/envs/ty
    at crates/ty_python_semantic/src/site_packages.rs:832 on ThreadId(1)

  2025-07-10T14:11:28.513792Z DEBUG ty_python_semantic::site_packages: Resolved site-packages directories for this environment are: SitePackagesPaths({&quot;/home/jschmidt/.pixi/envs/ty/lib/python3.13/site-packages&quot;})
    at crates/ty_python_semantic/src/site_packages.rs:619 on ThreadId(1)

  2025-07-10T14:11:28.513827Z DEBUG ty_project::metadata::options: Including `.` in `environment.root`
    at crates/ty_project/src/metadata/options.rs:236 on ThreadId(1)

  2025-07-10T14:11:28.513853Z DEBUG ty_python_semantic::module_resolver::resolver: Adding first-party search path '/home/jschmidt/Devel/test_pixi_ty'
    at crates/ty_python_semantic/src/module_resolver/resolver.rs:193 on ThreadId(1)

  2025-07-10T14:11:28.513877Z DEBUG ty_python_semantic::module_resolver::resolver: Using vendored stdlib
    at crates/ty_python_semantic/src/module_resolver/resolver.rs:216 on ThreadId(1)

  2025-07-10T14:11:28.514166Z DEBUG ty_python_semantic::module_resolver::resolver: Adding site-packages search path '/home/jschmidt/.pixi/envs/ty/lib/python3.13/site-packages'
    at crates/ty_python_semantic/src/module_resolver/resolver.rs:228 on ThreadId(1)

  2025-07-10T14:11:28.514183Z  INFO ty_project::metadata::options: Python version: Python 3.13, platform: linux
    at crates/ty_project/src/metadata/options.rs:183 on ThreadId(1)

  2025-07-10T14:11:28.514557Z DEBUG ty_project: Setting included paths: 1
    at crates/ty_project/src/lib.rs:326 on ThreadId(1)

  2025-07-10T14:11:28.514568Z DEBUG ty_project: Reloading files for project `test_pixi_ty`
    at crates/ty_project/src/lib.rs:471 on ThreadId(1)

  2025-07-10T14:11:28.514685Z DEBUG ty: Starting main loop
    at crates/ty/src/lib.rs:255 on ThreadId(1)

  2025-07-10T14:11:28.514698Z DEBUG ty: Waiting for next main loop message.
    at crates/ty/src/lib.rs:377 on ThreadId(1)

  2025-07-10T14:11:28.514762Z DEBUG ty_project: Checking project 'test_pixi_ty'
    at crates/ty_project/src/lib.rs:220 on ThreadId(2)
    in ty_project::Project::check

  2025-07-10T14:11:28.517341Z  INFO ty_project: Indexed 1 file(s) in 0.003s
    at crates/ty_project/src/lib.rs:459 on ThreadId(2)
    in ty_project::Project::index_files with project=test_pixi_ty
    in ty_project::Project::check

Checking ------------------------------------------------------------ 0/1 files                                                                                                                           2025-07-10T14:11:28.517546Z DEBUG ty_python_semantic::types: Checking file '/home/jschmidt/Devel/test_pixi_ty/test.py'
    at crates/ty_python_semantic/src/types.rs:95 on ThreadId(2)
    in ty_project::check_file with file=file(Id(c00))
    in ty_project::Project::check

  2025-07-10T14:11:28.517888Z DEBUG ty_python_semantic::module_resolver::resolver: Resolving dynamic module resolution paths
    at crates/ty_python_semantic/src/module_resolver/resolver.rs:302 on ThreadId(2)
    in ty_project::check_file with file=file(Id(c00))
    in ty_project::Project::check

  2025-07-10T14:11:28.517963Z DEBUG ty_python_semantic::module_resolver::resolver: Skipping editable installation: /home/jschmidt/.pixi/envs/ty/lib/python3.1/site-packages does not point to a directory
    at crates/ty_python_semantic/src/module_resolver/resolver.rs:387 on ThreadId(2)
    in ty_project::check_file with file=file(Id(c00))
    in ty_project::Project::check

  2025-07-10T14:11:28.517982Z DEBUG ty_python_semantic::module_resolver::resolver: Skipping editable installation: /home/jschmidt/.pixi/envs/ty/lib/python/site-packages does not point to a directory
    at crates/ty_python_semantic/src/module_resolver/resolver.rs:387 on ThreadId(2)
    in ty_project::check_file with file=file(Id(c00))
    in ty_project::Project::check

  2025-07-10T14:11:28.518026Z DEBUG ty_python_semantic::module_resolver::resolver: Module `numpy` not found in search paths
    at crates/ty_python_semantic/src/module_resolver/resolver.rs:42 on ThreadId(2)
    in ty_project::check_file with file=file(Id(c00))
    in ty_project::Project::check

Checking ------------------------------------------------------------ 1/1 files                                                                                                                           2025-07-10T14:11:28.518133Z DEBUG ty_project: Checking all files took 0.001s
    at crates/ty_project/src/lib.rs:269 on ThreadId(2)
    in ty_project::Project::check

error[unresolved-import]: Cannot resolve imported module `numpy`
 --&gt; test.py:1:8
  |
1 | import numpy as np
  |        ^^^^^^^^^^^
  |
info: make sure your Python environment is properly configured: https://docs.astral.sh/ty/modules/#python-environment
info: rule `unresolved-import` is enabled by default

Found 1 diagnostic
  2025-07-10T14:11:28.518253Z DEBUG ty: Exiting main loop
    at crates/ty/src/lib.rs:245 on ThreadId(1)
</code></pre>
</details>

<p>Indeed, <code>pixi</code> sets <code>$CONDA_ENV</code> to the tool environment. So probably this is a question to the <code>pixi</code> team, how <code>ty</code> could get the local <code>$CONDA_ENV</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-10 14:20</div>
            <div class="timeline-body"><p>Maybe related to https://github.com/astral-sh/ty/issues/611</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JaRoSchm">@JaRoSchm</a> on 2025-07-10 14:29</div>
            <div class="timeline-body"><blockquote>
<p>Maybe related to <a href="https://github.com/astral-sh/ty/issues/611">#611</a></p>
</blockquote>
<p>I found this issue too, but I don't think it is related because pixi doesn't have a base environment anymore. If we translate the problem here to the old conda workflow, <code>ty</code> is just in a different conda environment compared to the dependencies of the project.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">imports</span> added by @MichaReiser on 2025-07-10 14:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-10 14:37</div>
            <div class="timeline-body"><blockquote>
<p>Indeed, pixi sets $CONDA_ENV to the tool environment.</p>
</blockquote>
<p>I don't know if it should do that, e.g., <code>uv tool install ty</code> just installs a <code>ty</code> binary â€” there's no <code>VIRTUAL_ENV</code> injection.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Hofer-Julian">@Hofer-Julian</a> on 2025-07-15 12:52</div>
            <div class="timeline-body"><p>Yeah, that's a bit annoying. We discussed it within the team, and we can't just stop setting <code>CONDA_PREFIX</code> since packages might rely on it.</p>
<p>For now, the best way is to add <code>ty</code> to your Pixi environment instead of installing it globally.</p>
<p>We'd be open to add a way for packages to communicate to <code>pixi global</code> that they don't want <code>CONDA_PREFIX</code> to be set</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Hofer-Julian">@Hofer-Julian</a> on 2025-09-23 08:39</div>
            <div class="timeline-body"><p>I've added a feature to Pixi which allows packages to opt-out of activating <code>CONDA_PREFIX</code> when installed via <code>pixi global</code>: https://github.com/prefix-dev/pixi/pull/4619. I also opened a PR to the <a href="https://github.com/conda-forge/ty-feedstock/pull/36">ty-feedstock</a>.</p>
<p>As soon as there's another Pixi release and the feedstock PR has been merged, this issue can be closed in my opinion</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JaRoSchm">@JaRoSchm</a> on 2025-10-07 10:29</div>
            <div class="timeline-body"><p>Fixed in pixi 0.56.0. Thank you for working on this!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @JaRoSchm on 2025-10-07 10:29</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:40:07 UTC
    </footer>
</body>
</html>
