<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check implementation consistency for an overloaded function - astral-sh/ty #109</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Check implementation consistency for an overloaded function</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/109">#109</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2025-04-30 18:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-04-30 18:56</div>
            <div class="timeline-body"><p>The task here is to check whether the overloaded signatures is consistent with the implementation signature if it's present. Specifically, from the spec:</p>
<blockquote>
<p>If an overload implementation is defined, type checkers should validate that it is consistent with all of its associated overload signatures. The implementation should accept all potential sets of arguments that are accepted by the overloads and should produce all potential return types produced by the overloads. In typing terms, this means the input signature of the implementation should be <a href="https://typing.python.org/en/latest/spec/glossary.html#term-assignable">assignable</a> to the input signatures of all overloads, and the return type of all overloads should be assignable to the return type of the implementation.</p>
<p>If the implementation is inconsistent with its overloads, a type checker should report an error.</p>
<p>https://typing.python.org/en/latest/spec/overload.html#implementation-consistency</p>
</blockquote>
<p>The following function is the one where all overload checks happen:</p>
<p>https://github.com/astral-sh/ruff/blob/bd5fb826bce149d8a834767e6c175c2e4d90105a/crates/red_knot_python_semantic/src/types/infer.rs#L990-L990</p>
<p>Specifically, it loops over each of the overloaded function that needs to be checked here:</p>
<p>https://github.com/astral-sh/ruff/blob/bd5fb826bce149d8a834767e6c175c2e4d90105a/crates/red_knot_python_semantic/src/types/infer.rs#L1036-L1039</p>
<p>which are used to perform various checks.</p>
<p><strong>Notes:</strong></p>
<ul>
<li>We can reuse the <a href="https://github.com/astral-sh/ruff/blob/bd5fb826bce149d8a834767e6c175c2e4d90105a/crates/red_knot_python_semantic/src/types/diagnostic.rs#L487-L487"><code>INVALID_OVERLOAD</code></a> lint rule to raise a diagnostic for this check</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @dhruvmanila on 2025-04-30 18:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LaBatata101">@LaBatata101</a> on 2025-04-30 20:48</div>
            <div class="timeline-body"><p>Can I try this one?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-04-30 21:09</div>
            <div class="timeline-body"><p>Sure!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @LaBatata101 by @dhruvmanila on 2025-04-30 21:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Check implementation consistency for an overloaded function" to "Check implementation consistency for an overloaded function" by @MichaReiser on 2025-05-07 15:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">overloads</span> added by @AlexWaygood on 2025-05-10 18:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/j178">@j178</a> on 2025-06-05 15:22</div>
            <div class="timeline-body"><p>Hi, I ran into an issue when playing with this.</p>
<p>When using <code>Signature::is_assignable_to(f1, f2)</code>, it's supposed to check if  the <strong>return type</strong> of <code>f1</code> is assignable to the return type of <code>f2</code>, and if the <strong>input type</strong> of <code>f2</code> is assignable to the input type <code>f1</code>.</p>
<p>Then the following snippet will error becase the implementation input type (<code>str|int</code>) is not assignable to <code>int</code> or <code>str</code>:</p>
<pre><code class="language-py">from typing import overload

@overload
def f(x: int) -&gt; int: pass
@overload
def f(x: str) -&gt; str: pass
def f(x: str|int) -&gt; str|int:  # error: [invalid-overload]
    return x
</code></pre>
<p>but neither <code>mypy</code> nor <code>pyright</code> do not report error on this: <a href="https://mypy-play.net/?mypy=latest&amp;python=3.12&amp;gist=afa534e1eae815ceab3f91930c562acb">mypy playground</a>, <a href="https://pyright-play.net/?code=GYJw9gtgBALgngBwJYDsDmUkQWEMpgBuApiADZgCGAJgDRQDClZZlARmcQFBcACRpCjS7ViwKMAAUADwBcmFDACUUALQA%2BBTHkJKAZz18B5KtRFiJM%2BXpggVGqDZA79h0eKlzHtgD6plappOforyUADEUChgUKTgIFxQSVAgxDAAriAoUNJcQA">pyright playground</a></p>
<p>I also tried this code in <code>pyright</code>: <a href="https://pyright-play.net/?code=GYJw9gtgBALgngBwJYDsDmUkQWEMpgBuApiADZgCGAJgFC0ACRpFNt1xwUwAFAB4AuTChgBKKAFoAfMJhCElAM6LGzclTocuvQVEUwQ46XoPylKrd35CARnBjFFRmXYeKBtKF6ghiMAK4gKFB8tEA">pyright playground</a></p>
<pre><code class="language-py">from typing import overload

@overload
def f(x: int) -&gt; int: pass
@overload
def f(x: str) -&gt; str: pass
def f(x: bytes) -&gt; bytes:
    return x
</code></pre>
<p>Hereâ€™s what pyright says:</p>
<pre><code>Overloaded implementation is not consistent with signature of overload 1
  Type &quot;(x: bytes) -&gt; bytes&quot; is not assignable to type &quot;(x: int) -&gt; int&quot;
    Parameter 1: type &quot;int&quot; is incompatible with type &quot;bytes&quot;
      &quot;int&quot; is not assignable to &quot;bytes&quot;
    Function return type &quot;int&quot; is incompatible with type &quot;bytes&quot;
      &quot;int&quot; is not assignable to &quot;bytes&quot;  (reportInconsistentOverload)
</code></pre>
<p>Looks like that pyright and mypy are checking both input type AND return type of each overload are assignable to the corresponding types in the implementation?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-06-06 00:12</div>
            <div class="timeline-body"><p>@j178 Yes, signature assignability is not actually the right operation here, the sense is reversed for parameters vs return type. We sorted this out in https://github.com/astral-sh/ruff/pull/17800 but I guess we didn't update the issue description here.</p>
<p>Note also that @LaBatata101 already has a good PR up for this in https://github.com/astral-sh/ruff/pull/17800 -- it's just waiting on a different fix so it doesn't add too many false positives.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Beta" by @carljm on 2025-06-11 01:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "GA" by @carljm on 2025-06-11 01:01</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 02:10:50 UTC
    </footer>
</body>
</html>
