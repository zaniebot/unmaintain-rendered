<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publish diagnostics for all open files - astral-sh/ty #1652</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Publish diagnostics for all open files</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1652">#1652</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-11-27 08:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><p>ty&#x27;s LSP does support the PublishDiagnostics notification, however, it only publishes the diagnostics for the changed file. It never pushes diagnostics for related files.</p>
<p>Let&#x27;s say you have</p>
<p><code>lib.py</code>:</p>
<pre><code>
class Foo:
    name: str
</code></pre>
<p><code>main.py</code>:</p>
<pre><code>from lib import Foo

foo = Foo()

print(foo.name)
</code></pre>
<p>Now, you change <code>Foo.name</code> to <code>Foo.name2</code>. Note, how ty doesn&#x27;t show any diagnostics in <code>main.py</code>. The new diagnostics only show up once you start making changes to <code>main.py</code></p>
<p>We should send the <code>PublishNotification</code> for all open documents. However, doing so on every <code>didChange</code> notification seems a bit much and possibly expensive. That&#x27;s why I think the approach taken by Pyrefly to only do this in <code>didSave</code> seems reasonable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Stable&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-27 08:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-27 08:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-27 08:52</div>
            <div class="timeline-body"><p>I assigned this to the Stable milestone for now but I think we should prioritize this based on user feedback. Most clients support pull diagnostics and/or workspace diagnostics, in which case the PublishDiagnostic notification isn&#x27;t used at all (except for notebooks)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/joaotavora">@joaotavora</a> on 2025-12-12 09:31</div>
            <div class="timeline-body"><blockquote>
<p>but I think we should prioritize this based on user feedback. Most clients support pull diagnostics and/or workspace diagnostics, in which case the PublishDiagnostic notification isn&#x27;t used at all (except for notebooks)</p>
</blockquote>
<p>Two pieces of feedback:</p>
<ol>
<li><p>Eglot, the built-in client for Emacs doesn&#x27;t support pull diagnostics yet, as most servers I work with don&#x27;t support it. It is superior, and I do plan to add it (maybe using ty as a testbed).</p>
<p>But I think it would be really nice for you not to let go of publishDiagnostics just yet, as not only should ty work with older clients but also my experience of almost 10 years with close to a hundred of servers it is the overwhelming preference of servers and clients such as the one I maintain are well attuned to it (regardless of whether you send publishDiagnostics for all open files or even unopened files).</p>
</li>
<li><p>On a tangent, and perhaps more pressing question, in the current implementation of ty, does the publishDiagnostics only come in when the file changes in the file system or a didSave is sent?  Nothing is published on didChange??  Most servers (with notable exception to rust-analyzer) work like that, I think.  Maybe there is a way to activate this?</p>
<p>I&#x27;d like to make <code>ty</code> the default preference of my new LSP server multiplexer thing (https://github.com/joaotavora/rassumfrassum) but without the above change, I have to stick to basedpyright, as it still provides a slightly more stable experience.</p>
</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-12 10:07</div>
            <div class="timeline-body"><p>ty does support publish diagnostics already (on <code>didChange</code>) but it only publishes diagnostics for the changed file. This is not sufficient if you have <code>lib.py</code> and <code>main.py</code> where you make a change in <code>lib.py</code> but there&#x27;s now a typing error in <code>main.py</code> because of it. This is what this issue is about.</p>
<p>It&#x27;s our plan to fix this as part of ty&#x27;s stable release</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/joaotavora">@joaotavora</a> on 2025-12-12 10:52</div>
            <div class="timeline-body"><blockquote>
<p>ty does support publish diagnostics already (on didChange) but it only publishes diagnostics for the changed file.</p>
</blockquote>
<p>Aha.  I had a better look at the JSONRPC conversation and I can confirm this.  However, something odd happens (which was why I thought id didn&#x27;t do this).  The <code>:version</code> field on these publish diagnostics is always &quot;one behind&quot;.  So a newly opened file has version 0, then the client makes a tiny change and sends a new <code>didChange</code> and says <code>&quot;version&quot;: 1</code> in the <code>textDocument</code> section.  <code>ty</code> duly follows up with a <code>textDocument/publishDiagnostics</code>, but for <code>&quot;version&quot;: 0</code>.  Should be version 1!!   I&#x27;m using <code>INFO Version: 0.0.1-alpha.32</code> if it helps.  Sorry to shoehorn a bug report here.</p>
<blockquote>
<p>This is not sufficient if you have lib.py and main.py where you make a change in lib.py but there&#x27;s now a typing error in main.py because of it. This is what this issue is about.  It&#x27;s our plan to fix this as part of ty&#x27;s stable release</p>
</blockquote>
<p>That&#x27;s great, and very nice.  Not a showstopper though.  A number of servers have this current behavior IIRC.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-12 11:13</div>
            <div class="timeline-body"><p>Oh nice, find. I should have a fix any minute :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/joaotavora">@joaotavora</a> on 2025-12-14 22:13</div>
            <div class="timeline-body"><p>Hello again @MichaReiser and sorry in advance if I keep hijacking this issue with tangents.  Eglot now supports &quot;pull diagnostics&quot;.  I found that <code>ty server</code> is much snappier in this mode (maybe just an impression, but why would that be? ¯_(ツ)_/¯)</p>
<p>Anyway  I was expecting this mode to address precisely the use case you described in the beginning of this issue, which is to provide diagnostics for documents directly affected by a change to a given document.</p>
<p>As far as I can read in the LSP spec, there is the &#x27;relatedDocumentSupport&#x27; client sub-capability, but no server that I know consults it or does anything useful with it.</p>
<p>Is supporting this part of the plans for the <code>textDocument/diagnostics</code> request, too, or only <code>textDocument/publishDiagnostics</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-15 07:01</div>
            <div class="timeline-body"><blockquote>
<p>As far as I can read in the LSP spec, there is the &#x27;relatedDocumentSupport&#x27; client sub-capability, but no server that I know consults it or does anything useful with it</p>
</blockquote>
<p>No, we don&#x27;t plan to support this unless there&#x27;s clear evidence that clients need it. The reason is that we actually don&#x27;t have that information. There are ways we could compute it but it&#x27;s non-trivial. VS Code doesn&#x27;t need it, it simply re-pulls diagnostics for all open files when the server announces <code>interFileDependencies: true</code>. I think the same is true for Zed.</p>
<p>ty also supports workspace diagnostics, which is closer to the traditional push diagnostics where the server pushes new diagnostics across the entire workspace.</p>
<blockquote>
<p>Anyway I was expecting this mode to address precisely the use case you described in the beginning of this issue, which is to provide diagnostics for documents directly affected by a change to a given document.</p>
</blockquote>
<p>Can you say more about what you tried and what isn&#x27;t working? Ideally, in a separate issue because this is unrelated to push diagnostics.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/joaotavora">@joaotavora</a> on 2025-12-15 09:42</div>
            <div class="timeline-body"><p>On Mon, Dec 15, 2025 at 7:01 AM Micha Reiser <em><strong>@</strong></em>.***&gt;
wrote:</p>
<blockquote>
<p>As far as I can read in the LSP spec, there is the
&#x27;relatedDocumentSupport&#x27; client sub-capability, but no server that I know
consults it or does anything useful with it</p>
<p>No, we don&#x27;t plan to support this unless there&#x27;s clear evidence that
clients need it. The reason is that we actually don&#x27;t have that
information. There are ways we could compute it but it&#x27;s non-trivial. VS
Code doesn&#x27;t need it, it simply re-pulls diagnostics for all open files
when the server announces interFileDependencies: true. I think the same is
true for Zed.</p>
</blockquote>
<p>I naively expected the language server to maintain a dependency graph
between files.  Not only do I not care about VSCode (as you may or may not
expect), I think brute-forcing this from the client is pretty inefficient.
clangd seems to maintain this, for example.  It publishes diagnostics for
affected files and affected files only (though only on didSave).</p>
<blockquote>
<p>Can you say more about what you tried and what isn&#x27;t working?</p>
</blockquote>
<p>Not much more to add.  It&#x27;d say it&#x27;s fairly on-topic, it matches EXACTLY
the case which <em>you</em> described in the opening post, down to the file names
:-)  I expected a breaking change to lib.py followed by a
<code>textDocument/diagnostic</code> of lib.py to bring in &quot;diagnostics for related
files&quot;, just as you put it.  Naively, I expected this to come in a
&#x27;relatedDocuments&#x27; of the response to the pull.</p>
<blockquote>
<p>Ideally, in a separate issue because this is unrelated to push
diagnostics.</p>
</blockquote>
<p>Sorry, wouldn&#x27;t know where to start.  Feel free to convert me into a
discussion, another issue (it&#x27;s what I do in my repos).  Or just ignore me
:-)</p>
<p>Happy holidays,
João</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-15 10:30</div>
            <div class="timeline-body"><blockquote>
<p>I think brute-forcing this from the client is pretty inefficient.
clangd seems to maintain this, for example.  It publishes diagnostics for
affected files and affected files only (though only on didSave).</p>
</blockquote>
<p>It&#x27;s pretty okay. The only thing clients have to do is request new diagnostics for all open files. You can add a little debounce for the files that aren&#x27;t focused and should get very good performance. If that&#x27;s not sufficient, the solution here really is workspace diagnostics where the server pushes new diagnostics.</p>
<blockquote>
<p>Not much more to add.  It&#x27;d say it&#x27;s fairly on-topic, it matches EXACTLY
the case which <em>you</em> described in the opening post, down to the file names
:-)  I expected a breaking change to lib.py followed by a
<code>textDocument/diagnostic</code> of lib.py to bring in &quot;diagnostics for related
files&quot;, just as you put it.  Naively, I expected this to come in a
&#x27;relatedDocuments&#x27; of the response to the pull.</p>
</blockquote>
<p>The expected flow here without related document support but with <code>interFileDependencies</code> is that the client requests diagnostics for <code>main.py</code>,</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/joaotavora">@joaotavora</a> on 2025-12-15 11:57</div>
            <div class="timeline-body"><p>Micha Reiser <em><strong>@</strong></em>.***&gt; writes:</p>
<blockquote>
<ul>
<li>MichaReiser left a comment (astral-sh/ty#1652)</li>
</ul>
<p>I think brute-forcing this from the client is pretty inefficient.
clangd seems to maintain this, for example. It publishes diagnostics for
affected files and affected files only (though only on didSave).</p>
<p>It&#x27;s pretty okay. The only thing clients have to do is request new diagnostics for all open files. You can add a little
debounce for the files that aren&#x27;t focused and should get very good performance. If that&#x27;s not sufficient, the solution
here really is workspace diagnostics where the server pushes new
diagnostics.</p>
</blockquote>
<p>My guess is the level of okayness would depend on how many files are
open...  A &quot;little debounce&quot; is high complexity for marginal reward, as
Emacs users frequently have a window that lists diagnostics in visited
files, focused, visible or not.  Falling back to workspace diagnostics
(if the server even supports them) is admitting defeat, likely bringing
in loads of uninteresting information.  If this is how it&#x27;s supposed to
work, it makes sense for me now that clangd hasn&#x27;t moved to pull
diagnostics, and my opinion is that it&#x27;s much better to use its
exclusive knowledge of the dependency graph to trace the implication of
a given document change.  In fact I don&#x27;t see any other way you&#x27;re going
solve this issue as you describe it.</p>
<blockquote>
<p>The expected flow here without related document support but with
interFileDependencies is that the client requests diagnostics for
main.py,</p>
</blockquote>
<p>Okay, will do that.  Possibly when you implement this issue, I&#x27;ll turn
off diagnostic pulls for &#x27;ty&#x27; entirely and that should solve things
nicely.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ficd0">@ficd0</a> on 2025-12-19 20:12</div>
            <div class="timeline-body"><blockquote>
<p>Most clients support pull diagnostics and/or workspace diagnostics, in which case the PublishDiagnostic notification isn&#x27;t used at all (except for notebooks)</p>
</blockquote>
<p>Chiming in here: <a href="https://github.com/kakoune-lsp/kakoune-lsp">kakoune-lsp</a> is to Kakoune what eglot is to Emacs, and it also doesn&#x27;t support pull diagnostics. I&#x27;m actually not sure about Helix, but I suspect that may be the case too.</p>
<p>The suggestion to push on <code>didSave</code> but not <code>didChange</code> seems reasonable. Perhaps pushing on <code>didChange</code> could be enabled via a config option if there&#x27;s a good reason for it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ficd0">@ficd0</a> on 2025-12-19 20:51</div>
            <div class="timeline-body"><p>I don&#x27;t mind giving this feature a shot, actually, if it&#x27;s not being worked on already. I am new to programming in Rust, however, so I would very much appreciate some input on whether my thinking is correct here.</p>
<p>Assuming we&#x27;re talking about the <code>ty_server</code> crate in the <code>ruff</code> repository:</p>
<p>It seems like we&#x27;re <a href="https://github.com/astral-sh/ruff/blob/1a18ada931c3a2de2b11abe3f01461c6032e7503/crates/ty_server/src/server/api/notifications.rs">not handling the <code>didSave</code> notification</a> from the client, so we&#x27;d need to add a handler that&#x27;s wired to <code>lsp_types::notification::DidSaveTextDocument</code> and called from the notification dispatcher</p>
<p>Its <code>run</code> implementation would probably just need to iterate all the document handles in the session and call <code>publish_diagnostics_if_needed</code> for each of them.</p>
<p>If I could get some assurance that I&#x27;m on the right track here, I&#x27;m happy to give this a shot :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-19 20:53</div>
            <div class="timeline-body"><p>That sounds about right.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-31 16:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ficd0">@ficd0</a> on 2026-01-02 01:49</div>
            <div class="timeline-body"><p>I&#x27;ve opened a PR with my fix :)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:26:07 UTC
    </footer>
</body>
</html>
