<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avoid re-indexing when new files are added - astral-sh/ty #97</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Avoid re-indexing when new files are added</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/97">#97</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-05-04 11:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><p>ty re-indexes all project files when a new file is added because it currently has no other way to determine if the file is ignored by a .gitignore (or some other rule). This is wasteful and can make ty unnecessarily slow when switching between commits.</p>
<p>We should explore a cheaper way to determine if a file is excluded that doesn&#x27;t require traversing an entire sub-tree.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-04 11:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Skylion007">@Skylion007</a> on 2025-05-04 18:56</div>
            <div class="timeline-body"><p>@MichaReiser For <code>.gitignore</code> specifically there is https://git-scm.com/docs/git-check-ignore which I am sure has rust bindings.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-04 18:58</div>
            <div class="timeline-body"><p>Thanks @Skylion007 We use the <code>ignore</code> crate for traversing and finding the files. I think it also has some APIs to test individual files. It would be best to use the <code>ignore</code> file to ensure we get consistent results between incremental and initial indexing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Skylion007">@Skylion007</a> on 2025-05-04 19:01</div>
            <div class="timeline-body"><p>@MichaReiser The API you are looking for is <code>matcher::matched</code> https://docs.rs/ignore/latest/ignore/gitignore/struct.Gitignore.html#method.matched</p>
<pre><code>let matcher = WalkBuilder::new(&quot;.&quot;)
    .standard_filters(true)
    .build_ignore();

let path = Path::new(&quot;my/project/root/src/foo.rs&quot;);
matcher.matched(path, false);  // false = treat as file
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-07 15:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-10 18:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-09 16:53</div>
            <div class="timeline-body"><p>I think we would have to use <a href="https://docs.rs/ignore/latest/ignore/gitignore/struct.Gitignore.html#method.matched_path_or_any_parents"><code>matched_path_or_any_parents</code></a> and the &quot;hard part&quot; is to collect all ignore files for a given file. Maybe @BurntSushi has an idea on how this could be done with the ignore crate.</p>
<p>I suspect that it will require us to build something custom (or create an adhoc <code>WalkBuilder</code> as you suggest which is sort of expensive and I&#x27;m not sure if it accounts for ancestor ignore files?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-06-09 16:57</div>
            <div class="timeline-body"><p>Yeah you can&#x27;t really do this with <code>ignore</code>. <code>ignore</code> isn&#x27;t designed to deal with one file path at a time. It&#x27;s designed only for doing entire traversals. It basically has two halves: a very low-level API for parsing and matching a single gitignore file and a very high-level API for doing a full directory traversal. There&#x27;s really nothing inbetween those two.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:24:06 UTC
    </footer>
</body>
</html>
