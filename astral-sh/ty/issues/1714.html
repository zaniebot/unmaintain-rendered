<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>support generic protocols in typevar solving - astral-sh/ty #1714</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>support generic protocols in typevar solving</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1714">#1714</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-12-01 23:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/carljm">@carljm</a> on 2025-12-01 23:45</div>
            <div class="timeline-body"><p><em>No description provided.</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Beta" by @carljm on 2025-12-01 23:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">generics</span> added by @carljm on 2025-12-01 23:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">Protocols</span> added by @carljm on 2025-12-01 23:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dcreager by @carljm on 2025-12-01 23:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AlexWaygood by @carljm on 2025-12-01 23:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Beta" by @carljm on 2025-12-16 21:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Stable" by @carljm on 2025-12-16 21:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Stable" by @carljm on 2025-12-19 23:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "M1" by @carljm on 2025-12-19 23:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ooopus">@ooopus</a> on 2025-12-28 01:56</div>
            <div class="timeline-body"><p>I think this is another instance of #1714 (generic protocol involvement in typevar solving).</p>
<p>When sorting a <code>list[str]</code> with <code>key=len</code>, ty widens the element type to <code>Sized</code>, which then causes false positives when the result is used as <code>str</code>.</p>
<pre><code class="language-python">from __future__ import annotations

import re

def build_regex(forms: list[str]) -&gt; str:
    sorted_forms = sorted(forms, key=len)

    reveal_type(sorted_forms)  # ty infers list[Sized] (unexpected)
    # Any downstream use that requires `str` then fails:
    escaped = [re.escape(f) for f in sorted_forms]  # ty: expected str/bytes, got Sized
    return &quot;|&quot;.join(escaped)
</code></pre>
<p>Expected:</p>
<ul>
<li><code>sorted_forms</code> should be inferred as <code>list[str]</code> (same element type as the input iterable).</li>
</ul>
<p>Actual:</p>
<ul>
<li><code>sorted_forms</code> is inferred as <code>list[Sized]</code>, losing the concrete element type and producing false positives.</li>
</ul>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:51:35 UTC
    </footer>
</body>
</html>
