<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assertions on object attributes do not refine later checks - astral-sh/ty #519</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Assertions on object attributes do not refine later checks</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/519">#519</a>
        opened by <a href="https://github.com/adamh-oai">@adamh-oai</a>
        on 2025-05-26 23:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/adamh-oai">@adamh-oai</a></div>
            <div class="timeline-body">Summary
<p>I&#x27;m sure there&#x27;s real type system terms to describe this, but should be clear enough from an example:</p>
<pre><code>class A:
    value: str | None

def foo(zzz: A):
    if zzz.value and len(zzz.value):
        print(zzz.value)

# no error
def bar(zzz: A):
    value = zzz.value
    if value and len(value):
        print(zzz.value)
</code></pre>
<p>This produces:</p>
<pre><code>$ uvx ty@latest check .
error[invalid-argument-type]: Argument to function `len` is incorrect
 --&gt; nullable.py:6:26
  |
5 | def foo(zzz: A):
6 |     if zzz.value and len(zzz.value):
  |                          ^^^^^^^^^ Expected `Sized`, found `str | None`
7 |         print(zzz.value)
  |
info: Function defined here
    --&gt; stdlib/builtins.pyi:1500:5
     |
1498 | def isinstance(obj: object, class_or_tuple: _ClassInfo, /) -&gt; bool: ...
1499 | def issubclass(cls: type, class_or_tuple: _ClassInfo, /) -&gt; bool: ...
1500 | def len(obj: Sized, /) -&gt; int: ...
     |     ^^^ ---------- Parameter declared here
1501 |
1502 | license: _sitebuiltins._Printer
     |
info: rule `invalid-argument-type` is enabled by default

Found 1 diagnostic

</code></pre>
<p>This is <em>technically</em> correct in that the value could have changed behind your back between the test and use, but fairly common so wanted to check if it&#x27;s intended.  In my unscientific sampling of the errors ty reports in our codebase, this seems to be the most common cause.</p>
Version
<p>ty 0.0.1-alpha.7</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-27 00:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-27 00:07</div>
            <div class="timeline-body"><p>Thanks for the report! The good news is that this is a feature we&#x27;re very actively working on. It should hopefully be ready soon ðŸš€</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:24:40 UTC
    </footer>
</body>
</html>
