<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>panic when running ty - astral-sh/ty #709</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>panic when running ty</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/709">#709</a>
        opened by <a href="https://github.com/Matt-Ord">@Matt-Ord</a>
        on 2025-06-26 09:17
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Matt-Ord">@Matt-Ord</a> on 2025-06-26 09:17</div>
            <div class="timeline-body"><h3>Summary</h3>
<pre><code>slate-corevscode âžœ /workspaces/slate (annotations) $ ty check ./slate_core/plot/
WARN ty is pre-release software and not ready for production use. Expect to encounter bugs, missing features, and fatal errors.
error[panic]: Panicked at /root/.cargo/git/checkouts/salsa-e6f3bb7c2a062968/09627e4/src/function/fetch.rs:165:25 when checking `/workspaces/slate/slate_core/plot/_plot.py`: `dependency graph cycle when querying value_type_(Id(2a800)), set cycle_fn/cycle_initial to fixpoint iterate.
Query stack:
[
    check_types(Id(c05)),
    infer_scope_types(Id(8000)),
    infer_deferred_types(Id(8498)),
    explicit_bases_(Id(18005)),
    infer_scope_types(Id(4d37)),
    cached_protocol_interface(Id(c80a)),
    infer_definition_types(Id(11736)),
    signature_(Id(16424)),
    infer_deferred_types(Id(11736)),
    value_type_(Id(2a800)),
    infer_scope_types(Id(4c95)),
    place_by_id(Id(fc3f)),
    place_by_id(Id(fc3d)),
    infer_definition_types(Id(5215)),
    try_mro_(Id(28009)),
    infer_expression_types(Id(2dfa)),
    infer_definition_types(Id(20d74)),
    infer_expression_types(Id(2df3)),
    explicit_bases_(Id(18013)),
    member_lookup_with_policy_(Id(b03a)),
    place_by_id(Id(fc25)),
    infer_definition_types(Id(1d4a4)),
    member_lookup_with_policy_(Id(b03b)),
    place_by_id(Id(fc26)),
    infer_definition_types(Id(1cf7e)),
    infer_definition_types(Id(1cf7c)),
    member_lookup_with_policy_(Id(b042)),
    place_by_id(Id(fc30)),
    try_mro_(Id(28002)),
    member_lookup_with_policy_(Id(b040)),
    place_by_id(Id(fc2b)),
    infer_definition_types(Id(19d15)),
    member_lookup_with_policy_(Id(b041)),
    place_by_id(Id(fc2c)),
    infer_definition_types(Id(20bd)),
]`
info: This indicates a bug in ty.
info: If you could open an issue at https://github.com/astral-sh/ty/issues/new?title=%5Bpanic%5D, we'd be very appreciative!
info: Platform: linux x86_64
info: Args: [&quot;ty&quot;, &quot;check&quot;, &quot;./slate_core/plot/&quot;]
info: run with `RUST_BACKTRACE=1` environment variable to show the full backtrace information
info: query stacktrace:
   0: infer_scope_types(Id(4c95))
             at crates/ty_python_semantic/src/types/infer.rs:139
   1: value_type_(Id(2a800))
             at crates/ty_python_semantic/src/types.rs:7420
   2: infer_deferred_types(Id(11736))
             at crates/ty_python_semantic/src/types/infer.rs:207
   3: signature_(Id(16424))
             at crates/ty_python_semantic/src/types/function.rs:526
             cycle heads: infer_definition_types(Id(11736)) -&gt; IterationCount(1)
   4: infer_definition_types(Id(11736))
             at crates/ty_python_semantic/src/types/infer.rs:168
   5: cached_protocol_interface(Id(c80a))
             at crates/ty_python_semantic/src/types/protocol_class.rs:330
   6: infer_scope_types(Id(4d37))
             at crates/ty_python_semantic/src/types/infer.rs:139
   7: explicit_bases_(Id(18005))
             at crates/ty_python_semantic/src/types/class.rs:763
   8: infer_deferred_types(Id(8498))
             at crates/ty_python_semantic/src/types/infer.rs:207
   9: infer_scope_types(Id(8000))
             at crates/ty_python_semantic/src/types/infer.rs:139
  10: check_types(Id(c05))
             at crates/ty_python_semantic/src/types.rs:89


error[panic]: Panicked at /root/.cargo/git/checkouts/salsa-e6f3bb7c2a062968/09627e4/src/function/fetch.rs:165:25 when checking `/workspaces/slate/slate_core/plot/_animate.py`: `dependency graph cycle when querying value_type_(Id(2a800)), set cycle_fn/cycle_initial to fixpoint iterate.
Query stack:
[
    check_types(Id(c02)),
    infer_scope_types(Id(4c04)),
    infer_definition_types(Id(5029)),
    infer_expression_types(Id(5c05)),
    signature_(Id(12001)),
    infer_deferred_types(Id(521b)),
    value_type_(Id(2a800)),
    infer_scope_types(Id(4c95)),
    infer_definition_types(Id(217f)),
    infer_definition_types(Id(1c498)),
    member_lookup_with_policy_(Id(a028)),
    place_by_id(Id(ec1c)),
    place_by_id(Id(ec1a)),
    infer_definition_types(Id(218b)),
    infer_definition_types(Id(203f)),
    member_lookup_with_policy_(Id(a027)),
    place_by_id(Id(ec1b)),
    infer_definition_types(Id(1ae27)),
    file_to_module(Id(11022)),
    source_text(Id(11022)),
]`
info: This indicates a bug in ty.
info: If you could open an issue at https://github.com/astral-sh/ty/issues/new?title=%5Bpanic%5D, we'd be very appreciative!
info: Platform: linux x86_64
info: Args: [&quot;ty&quot;, &quot;check&quot;, &quot;./slate_core/plot/&quot;]
info: run with `RUST_BACKTRACE=1` environment variable to show the full backtrace information
info: query stacktrace:
   0: infer_scope_types(Id(4c95))
             at crates/ty_python_semantic/src/types/infer.rs:139
   1: value_type_(Id(2a800))
             at crates/ty_python_semantic/src/types.rs:7420
   2: infer_deferred_types(Id(521b))
             at crates/ty_python_semantic/src/types/infer.rs:207
   3: signature_(Id(12001))
             at crates/ty_python_semantic/src/types/function.rs:526
   4: infer_expression_types(Id(5c05))
             at crates/ty_python_semantic/src/types/infer.rs:244
   5: infer_definition_types(Id(5029))
             at crates/ty_python_semantic/src/types/infer.rs:168
   6: infer_scope_types(Id(4c04))
             at crates/ty_python_semantic/src/types/infer.rs:139
   7: check_types(Id(c02))
             at crates/ty_python_semantic/src/types.rs:89

</code></pre>
<p>full code can be found at
https://github.com/Matt-Ord/slate</p>
<h3>Version</h3>
<p>ty 0.0.1-alpha.12</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-06-26 10:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fatal</span> added by @AlexWaygood on 2025-06-26 10:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Matt-Ord">@Matt-Ord</a> on 2025-07-03 08:05</div>
            <div class="timeline-body"><p>@AlexWaygood just to confirm that this still exists in 13. I narrowed down the root cause to</p>
<pre><code>from __future__ import annotations

import numpy as np

type NestedLength = int | tuple[NestedLength, ...]


def size_from_nested_shape(shape: NestedLength) -&gt; int:
    &quot;&quot;&quot;Get the size from a nested shape.&quot;&quot;&quot;
    if isinstance(shape, int):
        return shape
    return np.prod([size_from_nested_shape(sub_shape) for sub_shape in shape]).item()

</code></pre>
<p>Interestingly, ty check hangs if I remove size_from_nested_shape</p>
<pre><code>from __future__ import annotations

type NestedLength = int | tuple[NestedLength, ...]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-03 08:47</div>
            <div class="timeline-body"><blockquote>
<p>I narrowed down the root cause</p>
</blockquote>
<p>Thank you! This looks like another case of https://github.com/astral-sh/ty/issues/256.</p>
<blockquote>
<p>Interestingly, ty check hangs if I remove size_from_nested_shape</p>
</blockquote>
<p>Thanks. I'll mention that in a comment on the linked ticket.</p>
<p>A single use of the type turns this into a panic:</p>
<pre><code class="language-py">from __future__ import annotations

type NestedLength = int | tuple[NestedLength, ...]

n: NestedLength
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-07-03 08:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 02:11:14 UTC
    </footer>
</body>
</html>
