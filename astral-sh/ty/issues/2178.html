<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ty: assert membership doesn't narrow `str` to `Literal` for `TypedDict` key (minimal repro) - astral-sh/ty #2178</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ty: assert membership doesn&#x27;t narrow <code>str</code> to <code>Literal</code> for <code>TypedDict</code> key (minimal repro)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/2178">#2178</a>
        opened by <a href="https://github.com/dsfaccini">@dsfaccini</a>
        on 2025-12-23 02:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dsfaccini">@dsfaccini</a></div>
            <div class="timeline-body">Summary
<p>Minimal repro of <code>assert</code> not narrowing a <code>str</code> to a <code>Literal</code> before populating a <code>TypedDict</code>.</p>
<p>Playground link: https://play.ty.dev/28bae877-4f82-452c-95c9-5cf5ba8cd0e2</p>
Repro (no external deps)
<p><code>ty_repro_assert_literal.py</code>:</p>
<pre><code>from typing import Literal, TypedDict
from dataclasses import dataclass

class InputAudio(TypedDict):
    data: str
    format: Literal[&#x27;wav&#x27;, &#x27;mp3&#x27;]

@dataclass
class Item:
    data: str
    format: str

def build_audio(item: Item) -&gt; InputAudio:
    assert item.format in (&#x27;wav&#x27;, &#x27;mp3&#x27;)
    return InputAudio(data=item.data, format=item.format)

if __name__ == &#x27;__main__&#x27;:
    print(build_audio(Item(&#x27;x&#x27;, &#x27;wav&#x27;)))
</code></pre>
<p>Run:</p>
<pre><code>uvx ty check ty_repro_assert_literal.py
</code></pre>
Actual result
<pre><code>error[invalid-argument-type]: Invalid argument to key &quot;format&quot; with declared type `Literal[&quot;wav&quot;, &quot;mp3&quot;]` on TypedDict `InputAudio`
  --&gt; ty_repro_assert_literal.py:15:12
   |
13 | def build_audio(item: Item) -&gt; InputAudio:
14 |     assert item.format in (&#x27;wav&#x27;, &#x27;mp3&#x27;)
15 |     return InputAudio(data=item.data, format=item.format)
   |            ----------                 -------^^^^^^^^^^^
   |            |                          |      |
   |            |                          |      value of type `str`
   |            |                          key has declared type `Literal[&quot;wav&quot;, &quot;mp3&quot;]`
   |            TypedDict `InputAudio`
</code></pre>
Expected result
<p>The membership assert should narrow <code>item.format</code> to <code>Literal[&#x27;wav&#x27;, &#x27;mp3&#x27;]</code>, allowing assignment into the <code>TypedDict</code> without diagnostics.</p>
Notes
<p>Ty 0.0.4 via <code>uvx ty check</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;ty: assert membership doesn&#x27;t narrow str to Literal for TypedDict key (minimal repro)&quot; to &quot;ty: assert membership doesn&#x27;t narrow `str` to `Literal` for `TypedDict` key (minimal repro)&quot; by <a href="https://github.com/dsfaccini">@dsfaccini</a> on 2025-12-23 02:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MeGaGiGaGon">@MeGaGiGaGon</a> on 2025-12-23 02:25</div>
            <div class="timeline-body"><p>This is the same as #1566</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dsfaccini">@dsfaccini</a> on 2025-12-23 02:35</div>
            <div class="timeline-body"><p>aahh sorry for that, I wasn&#x27;t too diligent in my search, I&#x27;ll close this one too then.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dsfaccini">@dsfaccini</a> on 2025-12-23 02:35</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:26:43 UTC
    </footer>
</body>
</html>
