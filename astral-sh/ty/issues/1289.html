<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[panic] Typeshed should always have a `object` class in `builtins.pyi` - astral-sh/ty #1289</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[panic] Typeshed should always have a <code>object</code> class in <code>builtins.pyi</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1289">#1289</a>
        opened by <a href="https://github.com/copdips">@copdips</a>
        on 2025-09-30 22:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/copdips">@copdips</a></div>
            <div class="timeline-body">Summary
<p><code>0.0.1-alpha.20</code> is ok, but <code>0.0.1-alpha.21</code> is KO.</p>
<pre><code>error[panic]: Panicked at crates/ty_python_semantic/src/types/instance.rs:188:18 when checking `/home/xiang/git/myrepo/backend/rename_invoice_title_to_template_name_migration.py`: `Typeshed should always have a `object` class in `builtins.pyi``
info: This indicates a bug in ty.
info: If you could open an issue at https://github.com/astral-sh/ty/issues/new?title=%5Bpanic%5D, we&#x27;d be very appreciative!
info: Platform: linux x86_64
info: Version: 0.0.1-alpha.21
info: Args: [&quot;ty&quot;, &quot;check&quot;, &quot;.&quot;]
info: run with `RUST_BACKTRACE=1` environment variable to show the full backtrace information
info: query stacktrace:
   0: Type &lt; &#x27;db &gt;::member_lookup_with_policy_(Id(780e))
             at crates/ty_python_semantic/src/types.rs:768
             cycle heads: place_by_id(Id(8801)) -&gt; IterationCount(0)
   1: inner(Id(11400))
             at crates/ty_python_semantic/src/types/instance.rs:596
   2: infer_expression_types_impl(Id(450a))
             at crates/ty_python_semantic/src/types/infer.rs:192
             cycle heads: Type &lt; &#x27;db &gt;::member_lookup_with_policy_(Id(7801)) -&gt; IterationCount(0), infer_definition_types(Id(3c75)) -&gt; IterationCount(0), infer_definition_types(Id(3cc2)) -&gt; IterationCount(0)
   3: infer_definition_types(Id(aca5))
             at crates/ty_python_semantic/src/types/infer.rs:97
   4: place_by_id(Id(8802))
             at crates/ty_python_semantic/src/place.rs:706
             cycle heads: Type &lt; &#x27;db &gt;::member_lookup_with_policy_(Id(7801)) -&gt; IterationCount(0), infer_definition_types(Id(3cc2)) -&gt; IterationCount(0), infer_definition_types(Id(3c75)) -&gt; IterationCount(0), place_by_id(Id(8801)) -&gt; IterationCount(0)
   5: Type &lt; &#x27;db &gt;::member_lookup_with_policy_(Id(7801))
             at crates/ty_python_semantic/src/types.rs:768
   6: infer_definition_types(Id(3c75))
             at crates/ty_python_semantic/src/types/infer.rs:97
   7: infer_definition_types(Id(3cc2))
             at crates/ty_python_semantic/src/types/infer.rs:97
   8: place_by_id(Id(8801))
             at crates/ty_python_semantic/src/place.rs:706
   9: ClassLiteral &lt; &#x27;db &gt;::try_mro_(Id(9000))
             at crates/ty_python_semantic/src/types/class.rs:1386
  10: ClassLiteral &lt; &#x27;db &gt;::is_typed_dict_(Id(8c00))
             at crates/ty_python_semantic/src/types/class.rs:1386
  11: infer_definition_types(Id(3c23))
             at crates/ty_python_semantic/src/types/infer.rs:97
  12: place_by_id(Id(8800))
             at crates/ty_python_semantic/src/place.rs:706
  13: Type &lt; &#x27;db &gt;::member_lookup_with_policy_(Id(7800))
             at crates/ty_python_semantic/src/types.rs:768
  14: infer_definition_types(Id(98c6))
             at crates/ty_python_semantic/src/types/infer.rs:97
  15: infer_scope_types(Id(941f))
             at crates/ty_python_semantic/src/types/infer.rs:68
  16: check_file_impl(Id(c00))
             at crates/ty_project/src/lib.rs:522
</code></pre>
Version
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-01 06:11</div>
            <div class="timeline-body"><p>Thanks for opening this issue. I&#x27;ll need a few more details to help you.</p>
<p>Can you tell us more about your setup? Are you using a custom typeshed? What changes did you make to it? What&#x27;s your configuration? How do you run ty?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-01 06:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fatal</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-01 06:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-10-01 15:57</div>
            <div class="timeline-body"><p>Regardless of what is causing this for the OP, we need some way to error for user-exposable invariant violations like this that doesn&#x27;t emit the &quot;This is a bug in ty, please file an issue&quot; message.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-10-02 01:20</div>
            <div class="timeline-body"><p>Echoing above, it would be great to have a minimal reproduction for this. That error message usually means that we&#x27;ve encountered a cycle processing the definition of <code>object</code> itself (hence Micha&#x27;s question about whether you&#x27;re using a custom typeshed).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-10-02 01:25</div>
            <div class="timeline-body"><p>It could also mean (more simply but perhaps less likely?), that a custom typeshed lacking <code>object</code> is in use :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/copdips">@copdips</a> on 2025-10-02 23:33</div>
            <div class="timeline-body"><p>Hello,</p>
<p>Sorry for the late reply. By commenting out sections of my script step by step, I finally managed to reproduce the issue with just a single line in my script:</p>
<pre><code>from __future__ import annotations
</code></pre>
<p>In my repo root, I have the following structure: f<code>rontend</code>, <code>backend</code>, and <code>.venv </code>folders. Inside <code>backend/pyproject.toml</code>, I have:</p>
<pre><code># file backend/pyproject.toml,
[project]
name = &quot;backend&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.13&quot;

[tool.ty.environment]
root = [&quot;.&quot;]
extra-paths = [&quot;../.venv/lib/python3.13/site-packages&quot;]
</code></pre>
<p>Running <code>ty check</code> from the <code>backend</code> folder, with <code>ty==0.0.1a21</code>, I encounter the error mentioned above.</p>
<p>I can work around the error in three ways:</p>
<ul>
<li>by downgrading to <code>ty==0.0.1a20</code></li>
<li>by running <code>ty</code> from the repo root instead of <code>backend</code> folder</li>
<li>by removing the line <code>extra-paths = [&quot;../.venv/lib/python3.13/site-packages&quot;]</code> from <code>backend/pyproject.toml</code> file</li>
</ul>
<p>PS: All tests are executed with the <code>.venv</code> environment activated.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-03 06:21</div>
            <div class="timeline-body"><p>Hmm, that&#x27;s odd. Certainly not what I expected. Can you run ty in verbose mode (<code>ty check -v</code>) and share the initial logs where it lists the discovered search paths (and version, etc).</p>
<p>What might also be useful is if you could share <code>ls -al ../.venv/lib/python3.13/site-packages</code>. I wonder what&#x27;s in that directory that breaks our standard library definitions</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-03 09:19</div>
            <div class="timeline-body"><p>The contents of <code>extra-paths</code> <em>shouldn&#x27;t</em> matter here, since <code>builtins</code> is one of the stdlib modules we (correctly) view as non-shadowable, and we skip all non-stdlib search paths when resolving a non-shadowable module name: https://github.com/astral-sh/ruff/blob/f9688bd05c7083374696e95413abe6e7e275f270/crates/ty_python_semantic/src/module_resolver/resolver.rs#L689-L696</p>
<p>That said, I would also be interested in seeing the contents of the <code>../.venv/lib/python3.13/site-packages</code> directory here. And FWIW @copdips, using <code>extra-paths</code> to point to a virtual environment isn&#x27;t <em>really</em> the intended use case for that setting -- you should really specify your virtual environment using the <a href="https://docs.astral.sh/ty/reference/configuration/#python"><code>python</code></a> setting. For most modules (but (theoretically, at least) not <code>builtins</code>), search paths in <code>extra-paths</code> take precedence over even ty&#x27;s vendored stdlib stubs when resolving modules. But at runtime, modules installed into <code>site-packages</code> have lower precedence than the stdlib when it comes to module resolution, so those aren&#x27;t the semantics you&#x27;d usually want for third-party packages installed into a virtual environment. If you use the <code>python</code> setting to specify a virtual environment rather than <code>extra-paths</code>, you should get more intuitive behaviour from ty&#x27;s module resolution overall.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/copdips">@copdips</a> on 2025-10-03 21:46</div>
            <div class="timeline-body"><p>Hello,</p>
<p>I did some debugging, it seems that the newest <code>typing_extensions==4.15.0</code> conflicts with the newest <code>ty==0.0.1a21</code>. Downgrading one of them fixed the issue, or I can use other 2 workarounds I explained earlier.</p>
<p><code>typing_extensions==4.15.0rc</code> has the same issue,  <code>typing_extensions==4.14.1</code> is ok.</p>
<pre><code>23:42 $ uv pip list
Using Python 3.13.0 environment at: /home/xiang/git/myrepo/.venv
Package           Version
----------------- --------
ty                0.0.1a21
typing-extensions 4.15.0
</code></pre>
</p>
 

ty check -vv test_ty.py output:
<p>

<pre><code>22:58 $ ty check -vv test_ty.py 
2025-10-03 22:58:46.405792903 WARN ty is pre-release software and not ready for production use. Expect to encounter bugs, missing features, and fatal errors.
2025-10-03 22:58:46.42123177 DEBUG Version: 0.0.1-alpha.21
2025-10-03 22:58:46.421265495 DEBUG Architecture: x86_64, OS: linux, case-sensitive: case-sensitive
2025-10-03 22:58:46.421370665 DEBUG Searching for a project in &#x27;/home/xiang/git/merepo/backend&#x27;
2025-10-03 22:58:46.421521112 DEBUG Resolving requires-python constraint: `&gt;=3.13`
2025-10-03 22:58:46.421633781 DEBUG Resolved requires-python constraint to: 3.13
2025-10-03 22:58:46.421656537 DEBUG Found project at &#x27;/home/xiang/git/merepo/backend&#x27;
2025-10-03 22:58:46.421725159 DEBUG Searching for a user-level configuration at `/home/xiang/.config/ty/ty.toml`
2025-10-03 22:58:46.422581517 INFO Defaulting to python-platform `linux`
2025-10-03 22:58:46.42302159 DEBUG Resolving `VIRTUAL_ENV` environment variable: /home/xiang/git/merepo/.venv
2025-10-03 22:58:46.423071179 DEBUG Attempting to parse virtual environment metadata at &#x27;/home/xiang/git/merepo/.venv/pyvenv.cfg&#x27;
2025-10-03 22:58:46.423128652 DEBUG Searching for site-packages directory in sys.prefix /home/xiang/git/merepo/.venv
2025-10-03 22:58:46.423173712 DEBUG Resolved site-packages directories for this virtual environment are: SitePackagesPaths({&quot;/home/xiang/git/merepo/.venv/lib/python3.13/site-packages&quot;, &quot;/home/xiang/git/merepo/.venv/lib64/python3.13/site-packages&quot;})
2025-10-03 22:58:46.4235659 DEBUG Searching for real stdlib directory in sys.prefix /usr
2025-10-03 22:58:46.423651137 DEBUG Resolved real stdlib path for this virtual environment is: /usr/lib/python3.12
2025-10-03 22:58:46.423687143 DEBUG Adding extra search-path `/home/xiang/git/merepo/.venv/lib/python3.13/site-packages`
2025-10-03 22:58:46.423711667 DEBUG Adding first-party search path `/home/xiang/git/merepo/backend`
2025-10-03 22:58:46.423737956 DEBUG Using vendored stdlib
2025-10-03 22:58:46.42413483 DEBUG Adding site-packages search path `/home/xiang/git/merepo/.venv/lib/python3.13/site-packages`
2025-10-03 22:58:46.424184791 DEBUG Adding site-packages search path `/home/xiang/git/merepo/.venv/lib64/python3.13/site-packages`
2025-10-03 22:58:46.424224366 INFO Python version: Python 3.13, platform: linux
2025-10-03 22:58:46.424812197 DEBUG Setting included paths: 1
2025-10-03 22:58:46.424940638 DEBUG Reloading files for project `backend`
2025-10-03 22:58:46.425064603 DEBUG Starting main loop
2025-10-03 22:58:46.425104271 DEBUG Waiting for next main loop message.
2025-10-03 22:58:46.425735338 DEBUG Checking all files in project &#x27;backend&#x27;
2025-10-03 22:58:46.427934109 INFO Indexed 1 file(s) in 0.002s
2025-10-03 22:58:46.428126785 DEBUG Checking file &#x27;/home/xiang/git/merepo/backend/test_ty.py&#x27;
2025-10-03 22:58:46.467839896 INFO Error looking up `builtins.object` in typeshed: expected to find a class definition on Python 3.13, but found a symbol of type `Never` instead. Falling back to `Unknown` for the symbol instead.
2025-10-03 22:58:46.468618179 DEBUG Checking all files took 0.041s
error[panic]: Panicked at crates/ty_python_semantic/src/types/instance.rs:188:18 when checking `/home/xiang/git/merepo/backend/test_ty.py`: `Typeshed should always have a `object` class in `builtins.pyi``
info: This indicates a bug in ty.
info: If you could open an issue at https://github.com/astral-sh/ty/issues/new?title=%5Bpanic%5D, we&#x27;d be very appreciative!
info: Platform: linux x86_64
info: Version: 0.0.1-alpha.21
info: Args: [&quot;ty&quot;, &quot;check&quot;, &quot;-vv&quot;, &quot;test_ty.py&quot;]
info: run with `RUST_BACKTRACE=1` environment variable to show the full backtrace information
info: query stacktrace:
   0: Type &lt; &#x27;db &gt;::member_lookup_with_policy_(Id(2c0e))
             at crates/ty_python_semantic/src/types.rs:768
             cycle heads: place_by_id(Id(3401)) -&gt; IterationCount(0)
   1: inner(Id(ac00))
             at crates/ty_python_semantic/src/types/instance.rs:596
   2: infer_expression_types_impl(Id(30e0))
             at crates/ty_python_semantic/src/types/infer.rs:192
             cycle heads: Type &lt; &#x27;db &gt;::member_lookup_with_policy_(Id(2c01)) -&gt; IterationCount(0), infer_definition_types(Id(1469)) -&gt; IterationCount(0), infer_definition_types(Id(14b6)) -&gt; IterationCount(0)
   3: infer_definition_types(Id(4899))
             at crates/ty_python_semantic/src/types/infer.rs:97
   4: place_by_id(Id(3402))
             at crates/ty_python_semantic/src/place.rs:706
             cycle heads: Type &lt; &#x27;db &gt;::member_lookup_with_policy_(Id(2c01)) -&gt; IterationCount(0), infer_definition_types(Id(14b6)) -&gt; IterationCount(0), infer_definition_types(Id(1469)) -&gt; IterationCount(0), place_by_id(Id(3401)) -&gt; IterationCount(0)
   5: Type &lt; &#x27;db &gt;::member_lookup_with_policy_(Id(2c01))
             at crates/ty_python_semantic/src/types.rs:768
   6: infer_definition_types(Id(1469))
             at crates/ty_python_semantic/src/types/infer.rs:97
   7: infer_definition_types(Id(14b6))
             at crates/ty_python_semantic/src/types/infer.rs:97
   8: place_by_id(Id(3401))
             at crates/ty_python_semantic/src/place.rs:706
   9: ClassLiteral &lt; &#x27;db &gt;::try_mro_(Id(3c00))
             at crates/ty_python_semantic/src/types/class.rs:1386
  10: ClassLiteral &lt; &#x27;db &gt;::is_typed_dict_(Id(3800))
             at crates/ty_python_semantic/src/types/class.rs:1386
  11: infer_definition_types(Id(1417))
             at crates/ty_python_semantic/src/types/infer.rs:97
  12: place_by_id(Id(3400))
             at crates/ty_python_semantic/src/place.rs:706
  13: Type &lt; &#x27;db &gt;::member_lookup_with_policy_(Id(2c00))
             at crates/ty_python_semantic/src/types.rs:768
  14: infer_definition_types(Id(1400))
             at crates/ty_python_semantic/src/types/infer.rs:97
  15: infer_scope_types(Id(1000))
             at crates/ty_python_semantic/src/types/infer.rs:68
  16: check_file_impl(Id(c00))
             at crates/ty_project/src/lib.rs:522


Found 1 diagnostic
2025-10-03 22:58:46.468995557 WARN A fatal error occurred while checking some files. Not all project files were analyzed. See the diagnostics list above for details.
2025-10-03 22:58:46.46900536 DEBUG Exiting main loop
</code></pre>
</p>
 

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/copdips">@copdips</a> on 2025-10-03 22:04</div>
            <div class="timeline-body"><p>I just created a new repo to reproduce this issue:</p>
<p>https://github.com/copdips/ty-issues-1289</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/copdips">@copdips</a> on 2025-10-04 13:36</div>
            <div class="timeline-body"><blockquote>
<p>you should really specify your virtual environment using the <a href="https://docs.astral.sh/ty/reference/configuration/#python">python</a> setting</p>
</blockquote>
<p>yes, this one fixed the issue too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-04 13:48</div>
            <div class="timeline-body"><p>This means that the issue is likely that we&#x27;re resolving <code>typing_extensions</code> to the <code>typing_extensions.py</code> file in your virtual environment rather than the <code>typing_extensions.pyi</code> file in our vendored typeshed stubs for the stdlib. The reason why we&#x27;re giving the file in your virtual environment priority over the file in our vendored typeshed stubs is because you&#x27;ve specified the virtual environment using the <code>extra-paths</code> setting rather than the <code>python</code> setting. The effect of us resolving the <code>typing_extensions</code> module to the wrong file is then that we end up with cycles when trying to resolve the class definition for <code>object</code> in typeshed&#x27;s <code>builtins.pyi</code>, because the <code>builtins</code> module imports <code>typing_extensions</code> and depends on many definitions in that module.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> removed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-04 13:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-06 08:00</div>
            <div class="timeline-body"><p>Can we detect this misuse of <code>environment.extra-paths</code> somehow (by detecting that it points to a virtual environment), and show a helpful error message (that refers to <code>environment.python</code>)? Or are there valid use cases where I&#x27;d point <code>extra-paths</code> to a virtual env.? Or would the detection itself be prone to false positives?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-06 08:02</div>
            <div class="timeline-body"><p><a href="https://docs.astral.sh/ty/reference/configuration/#environment">Our documentation</a> also lists <code>extra-paths</code> first (before <code>python</code>). I realize that it&#x27;s just alphabetical order, but maybe we could still move <code>extra-paths</code> further down somehow? Instead (or in addition), we could also mention the <code>python</code> setting in the <code>extra-paths</code> description.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-06 11:26</div>
            <div class="timeline-body"><p>I&#x27;ve put up three PRs that should help with this issue: one PR to fix the immediate crash, and two to help guide users towards using the <code>python</code> option and away from using the <code>extra-paths</code> option:</p>
<ul>
<li>https://github.com/astral-sh/ruff/pull/20715</li>
<li>https://github.com/astral-sh/ruff/pull/20717</li>
<li>https://github.com/astral-sh/ruff/pull/20718</li>
</ul>
<p>One last thing that we could consider is to rename the <code>extra-paths</code> option to something like <code>non-environment-paths</code>, to make it less &quot;inviting&quot;, since this isn&#x27;t the first time I&#x27;ve seen users making use of this option when they shouldn&#x27;t really be doing so. I think this is also worth considering (though unfortunately <code>non-environment-paths</code> still comes before <code>python</code> in the alphabet ðŸ˜„). I&#x27;ll hold off on proposing this until my already-filed PRs are reviewed, however, since it&#x27;s a more invasive change.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-06 15:40</div>
            <div class="timeline-body"><p>It was decided not to rename the <code>extra-paths</code> option for now, so I&#x27;ll close this. Thanks for the report @copdips, and thanks especially for creating the repo to easily reproduce the issue!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-06 15:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-10-06 15:45</div>
            <div class="timeline-body"><blockquote>
<p>Regardless of what is causing this for the OP, we need some way to error for user-exposable invariant violations like this that doesn&#x27;t emit the &quot;This is a bug in ty, please file an issue&quot; message.</p>
</blockquote>
<p>Created #1313 to track this.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:25:39 UTC
    </footer>
</body>
</html>
