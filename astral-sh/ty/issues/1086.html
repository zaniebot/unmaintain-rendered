<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove `Definition` from `CallableType` - astral-sh/ty #1086</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Remove <code>Definition</code> from <code>CallableType</code></h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1086">#1086</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-08-22 06:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><p>Today, <code>CallableType</code> stores a <code>Definition</code> so that <code>signature_help</code> and <code>inlay_hints</code> can extract a docstring. However, it seems semantically wrong that two <code>CallableType</code> that are only different in their definition don't compare equal (and are interned twice):</p>
<blockquote>
<p>If the type we have is &quot;the type of all callables that take a single parameter named <code>x</code> of type <code>int</code> and return a <code>str</code>&quot; (this is <code>Type::CallableType</code>), there are many, many possible runtime inhabitants of that type, and we have no idea where they might be defined. So it doesn't make sense for that type to store or be able to provide a <code>Definition</code>.</p>
</blockquote>
<p>As far as typing's concerned, two <code>CallableType</code>s are equivalent even if their <code>Definition</code> differs. I suspect that this could lead to subtle bugs where we show an incorrect docstring if the <code>Definition</code> isn't removed in all type operations and we then propagate.</p>
<p>There's also no strong reason for the LSP to use <code>CallableTypes</code> in the first place. The only reason the LSP server depends on <code>CallableType</code> to have a <code>Definition</code> is because <a href="https://github.com/astral-sh/ruff/blob/4ac2b2c22283c9f8eb7f7fd945ab1c5f08098ab4/crates/ty_python_semantic/src/types/ide_support.rs#L819"><code>call_signature_details</code></a> calls <code>into_callable()</code> on the callee (<code>CallExpression::func</code>) which resolves <code>a = Class()</code> to <code>Class.__init__</code>, something that calling <code>bindings()</code> directly on <code>Type</code> doesn't, I suspect due to this TODO:</p>
<p>https://github.com/astral-sh/ruff/blob/14fe1228e72dca90db6b3dbb7e07f973d175ea0e/crates/ty_python_semantic/src/types.rs#L4683-L4696</p>
<p>We should rewrite the LSP so that <code>call_signature_details</code> doesn't call <code>into_callable</code> and instead resolves the bindings directly on the callee's type but without loosing support for resolving constructor calls. This will then allow us to remove <code>Definition</code> from <code>CallableType</code>.</p>
<p>You can find some more details in the conversation in https://github.com/astral-sh/ty/issues/1071#issuecomment-3209578522</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2025-08-22 06:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-17 17:55</div>
            <div class="timeline-body"><p>This is complicated by the issues discussed in #770. We currently wrongly infer a method literal type when accessing a method off a non-final class. Since a subclass could override the method, this is wrong; we should infer just the general callable type instead. But if we do that, and remove definition from callable types, we will lose all detailed hover information and goto for methods; this is a bad outcome.</p>
<p>So I'm not sure if we can remove tracking an optional definition in callable types.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-17 17:58</div>
            <div class="timeline-body"><p>Or else we need a deeper refactor so that attribute lookups etc return more than just a type, they return a type plus additional information needed for the LSP.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:20:32 UTC
    </footer>
</body>
</html>
