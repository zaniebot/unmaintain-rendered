<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Completions for `[item.&lt;CURSOR&gt; for item in xs]` fail because of how the comprehension is parsed - astral-sh/ty #2365</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Completions for <code>[item.&lt;CURSOR&gt; for item in xs]</code> fail because of how the comprehension is parsed</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/2365">#2365</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2026-01-06 12:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>This video shows how the type of <code>item</code> in <code>[item.&lt;CURSOR&gt; for item in xs]</code> is not known, and that in turn is the cause for completions not working:</p>
<p>https://github.com/user-attachments/assets/0d0b1ab5-c2a7-4e80-b639-0dd358857c68</p>
<p>The reason for why the type of <code>item</code> is not known seems likely related to how this <a href="https://play.ty.dev/c6d74417-84cd-482f-80fe-95716636b902">invalid comprehension is parsed</a>:</p>
<pre><code>ModModule {
    node_index: NodeIndex(None),
    range: 0..43,
    body: [
        AnnAssign(
            StmtAnnAssign {
                node_index: NodeIndex(
                    1,
                ),
                range: 0..20,
                target: Name(
                    ExprName {
                        node_index: NodeIndex(
                            2,
                        ),
                        range: 0..2,
                        id: Name(&quot;xs&quot;),
                        ctx: Store,
                    },
                ),
                annotation: Subscript(
                    ExprSubscript {
                        node_index: NodeIndex(
                            4,
                        ),
                        range: 4..13,
                        value: Name(
                            ExprName {
                                node_index: NodeIndex(
                                    5,
                                ),
                                range: 4..8,
                                id: Name(&quot;list&quot;),
                                ctx: Load,
                            },
                        ),
                        slice: Name(
                            ExprName {
                                node_index: NodeIndex(
                                    6,
                                ),
                                range: 9..12,
                                id: Name(&quot;str&quot;),
                                ctx: Load,
                            },
                        ),
                        ctx: Load,
                    },
                ),
                value: Some(
                    List(
                        ExprList {
                            node_index: NodeIndex(
                                7,
                            ),
                            range: 16..20,
                            elts: [
                                StringLiteral(
                                    ExprStringLiteral {
                                        node_index: NodeIndex(
                                            8,
                                        ),
                                        range: 17..19,
                                        value: StringLiteralValue {
                                            inner: Single(
                                                StringLiteral {
                                                    range: 17..19,
                                                    node_index: NodeIndex(
                                                        9,
                                                    ),
                                                    value: &quot;&quot;,
                                                    flags: StringLiteralFlags {
                                                        quote_style: Double,
                                                        prefix: Empty,
                                                        triple_quoted: false,
                                                        unclosed: false,
                                                    },
                                                },
                                            ),
                                        },
                                    },
                                ),
                            ],
                            ctx: Load,
                        },
                    ),
                ),
                simple: true,
            },
        ),
        Expr(
            StmtExpr {
                node_index: NodeIndex(
                    10,
                ),
                range: 21..43,
                value: List(
                    ExprList {
                        node_index: NodeIndex(
                            11,
                        ),
                        range: 21..43,
                        elts: [
                            Attribute(
                                ExprAttribute {
                                    node_index: NodeIndex(
                                        12,
                                    ),
                                    range: 22..31,
                                    value: Name(
                                        ExprName {
                                            node_index: NodeIndex(
                                                13,
                                            ),
                                            range: 22..26,
                                            id: Name(&quot;item&quot;),
                                            ctx: Load,
                                        },
                                    ),
                                    attr: Identifier {
                                        id: Name(&quot;for&quot;),
                                        range: 28..31,
                                        node_index: NodeIndex(
                                            14,
                                        ),
                                    },
                                    ctx: Load,
                                },
                            ),
                            Compare(
                                ExprCompare {
                                    node_index: NodeIndex(
                                        15,
                                    ),
                                    range: 32..42,
                                    left: Name(
                                        ExprName {
                                            node_index: NodeIndex(
                                                16,
                                            ),
                                            range: 32..36,
                                            id: Name(&quot;item&quot;),
                                            ctx: Load,
                                        },
                                    ),
                                    ops: [
                                        In,
                                    ],
                                    comparators: [
                                        Name(
                                            ExprName {
                                                node_index: NodeIndex(
                                                    17,
                                                ),
                                                range: 40..42,
                                                id: Name(&quot;xs&quot;),
                                                ctx: Load,
                                            },
                                        ),
                                    ],
                                },
                            ),
                        ],
                        ctx: Load,
                    },
                ),
            },
        ),
    ],
}
</code></pre>
<p>Specifically, it seems to be parsed as a list.</p>
<p>To fix this, I think it would be a good idea to see if we can make this specific case parse as a comprehension.</p>
<h3>Version</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">completions</span> added by @BurntSushi on 2026-01-06 12:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Pre-stable 1" by @BurntSushi on 2026-01-06 12:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-06 12:55</div>
            <div class="timeline-body"><blockquote>
<p>To fix this, I think it would be a good idea to see if we can make this specific case parse as a comprehension.</p>
</blockquote>
<p>Agree. The tricky bit here is that we want to disable our &quot;parse a keyword as an expression&quot; recovery logic when parsing the first list element. This probably requires adding some more state:</p>
<p>One possibility is to add a new flag to <code>ExpressionContext</code> e.g. <code>IN_COMPREHENSION_ELEMENT</code>, and, if so, skip over the keyword recovery logic in <code>parse_identifier</code> if the current identifier is <code>for</code>. We might want to add a new <code>parse_identifier</code> function so that we don't need to pass <code>ExpressionContext</code> at all call sites (seems annoying).</p>
<p>The alternative is to add the flag to the parser state. But I generally prefer to have local flags over global state.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @BurntSushi by @BurntSushi on 2026-01-06 13:06</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:21:42 UTC
    </footer>
</body>
</html>
