<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incorrect type narrowing for literal patterns - astral-sh/ty #1349</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Incorrect type narrowing for literal patterns</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1349">#1349</a>
        opened by <a href="https://github.com/erictraut">@erictraut</a>
        on 2025-10-14 00:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/erictraut">@erictraut</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I just fixed a longstanding bug in pyright that ty appears to suffer from too. It's related to literal patterns in <code>case</code> statements. The runtime uses equality checks for literal pattern matching, but equality checks can succeed for non-overlapping types.</p>
<p>Consider the following:</p>
<pre><code class="language-python">def func(x: int):
    match x:
        case 1.0:
            reveal_type(x) # ty incorrectly reveals Never here
            print(&quot;This code is reachable&quot;)

func(1)
</code></pre>
<h3>Version</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2025-10-14 03:43</div>
            <div class="timeline-body"><p>I think we got this right in visibility constraints but not narrowing @carljm ---in the former we <a href="https://github.com/astral-sh/ruff/blob/5e08e5451df62398caf16034ae50621e46688641/crates/ty_python_semantic/src/semantic_index/reachability_constraints.rs#L725-L730">only do any narrowing if the subject type is single-valued</a> but in the latter we <a href="https://github.com/astral-sh/ruff/blob/5e08e5451df62398caf16034ae50621e46688641/crates/ty_python_semantic/src/types/narrow.rs#L1002-L1003">always narrow to subject type</a>.</p>
<p>For singly-valued subjects we can still do some narrowing...</p>
<pre><code class="language-py">def func(x: Literal[&quot;spam&quot;]):
    match x:
        case 4:
            reveal_type(x)  # Never
</code></pre>
<p>but also if the subject is a union of singly-valued types</p>
<pre><code class="language-py">def func(x: Literal[&quot;ham&quot;, &quot;spam&quot;] | None):
    match x:
        case &quot;ham&quot;:
            reveal_type(x)  # Literal[&quot;ham&quot;]
        case &quot;spam&quot;:
            reveal_type(x)  # Literal[&quot;spam&quot;]
        case &quot;eggs&quot;:
            reveal_type(x)  # Never
</code></pre>
<p>or even a singly-valued type union'd to something else</p>
<pre><code class="language-py">def func(x: Literal[&quot;ham&quot;, &quot;spam&quot;] | int):
    match x:
        case &quot;ham&quot;:
            reveal_type(x)  # Literal[&quot;ham&quot;] | int
        case &quot;spam&quot;:
            reveal_type(x)  # Literal[&quot;spam&quot;] | int
        case &quot;eggs&quot;:
            reveal_type(x)  # int
</code></pre>
<p>Are there other cases you can do this?</p>
<p>Edit: We have this logic already implemented in <a href="https://github.com/astral-sh/ruff/blob/5e08e5451df62398caf16034ae50621e46688641/crates/ty_python_semantic/src/types/narrow.rs#L478"><code>evaluate_expr_eq</code></a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2025-10-14 04:08</div>
            <div class="timeline-body"><p>@erictraut I tried to test these examples in the pyright playground but I think it hasn't picked up the fix you mentioned. Do you know if pyright does the above narrowing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/erictraut">@erictraut</a> on 2025-10-14 05:26</div>
            <div class="timeline-body"><p>The pyright playground runs only published versions of pyright. The fix I mentioned will be in the next published version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-10-14 07:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">narrowing</span> added by @AlexWaygood on 2025-10-14 07:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">runtime semantics</span> added by @AlexWaygood on 2025-10-14 07:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ericmarkmartin">@ericmarkmartin</a> on 2025-10-14 12:55</div>
            <div class="timeline-body"><p>@AlexWaygood I'm happy to take this one</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @ericmarkmartin by @AlexWaygood on 2025-10-14 13:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-10-14 15:00</div>
            <div class="timeline-body"><blockquote>
<p>We have this logic already implemented in <a href="https://github.com/astral-sh/ruff/blob/5e08e5451df62398caf16034ae50621e46688641/crates/ty_python_semantic/src/types/narrow.rs#L478"><code>evaluate_expr_eq</code></a></p>
</blockquote>
<p>Yes, this should just be a matter of using that existing logic for match patterns also</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-10-16 07:50</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:20:47 UTC
    </footer>
</body>
</html>
