<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typed dictionary narrowing not working - astral-sh/ty #2540</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Typed dictionary narrowing not working</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/2540">#2540</a>
        opened by <a href="https://github.com/gaborbernat">@gaborbernat</a>
        on 2026-01-17 01:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gaborbernat">@gaborbernat</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<pre><code class="language-python">from typing import TypedDict, final

class InnerA(TypedDict):
    foo: str

class InnerB(TypedDict):
    bar: str

@final
class OuterWithA(TypedDict):
    inner: InnerA

@final
class OuterWithB(TypedDict):
    inner: InnerB

InnerUnion = OuterWithA | OuterWithB

@final
class Response(TypedDict):
    data: InnerUnion

# This should work - the dict literal matches OuterWithA structure
response: Response = {
    &quot;data&quot;: {
        &quot;inner&quot;: {
            &quot;foo&quot;: &quot;hello&quot;
        }
    }
}
</code></pre>
<p>The error shows ty can't narrow the union type based on the dict literal structure, even though {&quot;inner&quot;: {&quot;foo&quot;: &quot;hello&quot;}} clearly matches OuterWithA and not OuterWithB:</p>
<pre><code>error[invalid-argument-type]: Invalid argument to key &quot;data&quot; with declared type `OuterWithA | OuterWithB` on TypedDict `Response`
  --&gt; /tmp/ty_repro.py:24:22
   |
23 |    # This should work - the dict literal matches OuterWithA structure
24 |    response: Response = {
   |  _______________________-
25 | |      &quot;data&quot;: {
   | | _____------__^
   | ||     |
   | ||     key has declared type `OuterWithA | OuterWithB`
26 | ||         &quot;inner&quot;: {
27 | ||             &quot;foo&quot;: &quot;hello&quot;
28 | ||         }
29 | ||     }
   | ||_____^ value of type `dict[Unknown | str, Unknown | dict[Unknown | str, Unknown | str]]`
30 | |  }
   | |__- TypedDict `Response`
   |
info: Item declaration
  --&gt; /tmp/ty_repro.py:21:5
   |
19 | @final
20 | class Response(TypedDict):
21 |     data: InnerUnion
   |     ---------------- Item declared here
22 |
23 | # This should work - the dict literal matches OuterWithA structure
   |
info: rule `invalid-argument-type` is enabled by default

Found 1 diagnostic
</code></pre>
<h3>Platform</h3>
<p>macos</p>
<h3>Version</h3>
<p>0.0.11</p>
<h3>Python version</h3>
<p>3.14</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @gaborbernat on 2026-01-17 01:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-17 01:16</div>
            <div class="timeline-body"><p>I cannot reproduce this in the <a href="https://play.ty.dev/f4136d80-7916-4b88-8fc3-04806580abf9">playground</a>. Are you using the latest version of ty?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> removed by @AlexWaygood on 2026-01-17 01:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">typeddict</span> added by @AlexWaygood on 2026-01-17 01:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-17 01:20</div>
            <div class="timeline-body"><p>Sorry, I see you said that you're using 0.0.11. I can reproduce it with that version, but not on the latest release (0.0.12). So the fix here is to upgrade to the latest version of ty :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2026-01-17 01:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on 2026-01-17 02:23</div>
            <div class="timeline-body"><p>Indeed I've been using 0.0.11 oh well I guess I'll try again next week thank you.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-17 03:04:16 UTC
    </footer>
</body>
</html>
