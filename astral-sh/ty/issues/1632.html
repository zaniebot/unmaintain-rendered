<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`typing.Annotated` error happens with `ty` but not `pyright` with `jaxtyping` - astral-sh/ty #1632</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>typing.Annotated</code> error happens with <code>ty</code> but not <code>pyright</code> with <code>jaxtyping</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1632">#1632</a>
        opened by <a href="https://github.com/toddpocuca">@toddpocuca</a>
        on 2025-11-25 19:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/toddpocuca">@toddpocuca</a></div>
            <div class="timeline-body">Summary
<pre><code>from jaxtyping import Key
import jax.random as jr

def hi(key: Key = jr.key(0)) -&gt; Key:
    return key
</code></pre>
<pre><code>error[invalid-type-form]: `typing.Annotated` requires at least two arguments when used in a type expression
  --&gt; tests/inference/test_continuous.py:82:13
   |
81 | # `typing.Annotated` requires at least two arguments when used in a type expression (ty invalid-type-form)
82 | def hi(key: Key = jr.key(0)) -&gt; Key:
   |             ^^^
83 |     return key
   |
info: rule `invalid-type-form` is enabled by default

error[invalid-type-form]: `typing.Annotated` requires at least two arguments when used in a type expression
  --&gt; tests/inference/test_continuous.py:82:33
   |
81 | # `typing.Annotated` requires at least two arguments when used in a type expression (ty invalid-type-form)
82 | def hi(key: Key = jr.key(0)) -&gt; Key:
   |                                 ^^^
83 |     return key
   |
info: rule `invalid-type-form` is enabled by default
</code></pre>
<p>I&#x27;m not sure what&#x27;s going on, but I&#x27;ve never had an issue with <code>jaxtyping</code> before.</p>
Version
<p>ty 0.0.1-alpha.27 (26d7b6864 2025-11-18)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-25 20:52</div>
            <div class="timeline-body"><p>Hmm, interesting. Thanks for the report!</p>
<p>I think the diagnostic we are giving here is correct. Mypy gives the same diagnostic, and so does pyright, but only in strict mode. <code>jaxtyping.Key</code> (along with many other types in <code>jaxtyping</code>) is just an alias for <code>typing.Annotated</code> (via a couple import indirections). And <code>typing.Annotated</code> normally requires two arguments when used in a type annotation (e.g. <code>Annotated[SomeType, &quot;some annotation&quot;]</code>).</p>
<p>I wonder why all the jaxtyping types are aliases to <code>Annotated</code> if they are supposed to be used &quot;bare&quot; like this? Why aren&#x27;t they e.g. aliases to <code>typing.Any</code> instead? (If you annotate something as <code>jaxtyping.Key</code> and check it in pyright non-strict mode, it&#x27;s just being typed as <code>Any</code> anyway.) Maybe @patrick-kidger can shed some light on the intent here?</p>
<p>I think we will continue to error on this by default, but if this is a widely-used pattern we could perhaps use a more fine-grained error code than just <code>invalid-type-form</code>, so projects using jaxtyping can disable this error?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">library</span> added by <a href="https://github.com/carljm">@carljm</a> on 2025-11-25 20:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/patrick-kidger">@patrick-kidger</a> on 2025-11-25 21:28</div>
            <div class="timeline-body"><p>This is not the intended use of jaxtyping :) <code>Key</code> on its own does not mean anything. jaxtyping type hints require both an array and a shape, e.g. <code>Key[Array, &quot;batch channels&quot;]</code>.</p>
<p>I suspect in this case @toddpocuca is after specifically a scalar key (like is returned from <code>jr.key</code>) which would be <code>Key[Array, &quot;&quot;]</code>. Note that vector (or matrix, ...) shaped key arrays can be obtained using <code>jr.split</code> or returned from <code>jax.vmap</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-25 21:29</div>
            <div class="timeline-body"><p>Thank you @patrick-kidger !</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-25 21:30</div>
            <div class="timeline-body"><p>Closing as not-planned since the diagnostic is correct, and this isn&#x27;t the intended use of jaxtyping.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2025-11-25 21:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:26:05 UTC
    </footer>
</body>
</html>
