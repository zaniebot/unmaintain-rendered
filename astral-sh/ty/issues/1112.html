<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`pytest.skip` (and variants) are `NoReturn` but not properly detected - astral-sh/ty #1112</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>pytest.skip</code> (and variants) are <code>NoReturn</code> but not properly detected</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1112">#1112</a>
        opened by <a href="https://github.com/mflova">@mflova</a>
        on 2025-09-01 09:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/mflova">@mflova</a> on 2025-09-01 09:42</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Maybe it is because <code>NoReturn</code> is not supported yet, but this snippet is OK for <code>mypy</code> but not for <code>ty</code>:</p>
<pre><code class="language-py">import pytest


def my_fixture() -&gt; (
    int
):  #  error[invalid-return-type] Function can implicitly return `None`, which is not assignable to return type `int`
    try:
        return 2
    except NotImplementedError:
        pytest.skip(&quot;Not implemented&quot;)
</code></pre>
<p>However, this is OK despite it is also based on <code>NoReturn</code>:</p>
<pre><code class="language-py">from typing import NoReturn


def my_fixture() -&gt; int:
    try:
        return 2
    except NotImplementedError:
        func()


def func() -&gt; NoReturn:
    raise NotImplementedError(&quot;This function is not yet implemented&quot;)
</code></pre>
<p>Both functions are labelled as <code>NoReturn</code>. I guess it is related to the decorator attached to <code>skip</code> from <code>pytest</code></p>
<h3>Version</h3>
<p>0.0.1-alpha.19</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-01 10:37</div>
            <div class="timeline-body"><p>Thank you for reporting this.</p>
<p>The problem is the <code>_with_exception</code> decorator on <code>pytest.skip</code>. Our generics solver is not yet capable of resolving the <a href="https://github.com/pytest-dev/pytest/blob/8d99211f0ce3927eb7ee579f7b4f969da06dc787/src/_pytest/outcomes.py#L92-L98"><code>_F</code> typevar</a> in a call to <code>_with_exception</code>, and so we infer <code>_WithException[Unknown, &lt;class 'Skipped'&gt;]</code> for <code>pytest.skip</code>. The <code>Unknown</code> in the first type parameter means that calls to <code>pytest.skip</code> will also result in <code>Unknown</code>.</p>
<p><code>pytest</code> has actually recently updated the definition of <code>pytest.skip</code>. So if you use the latest version from <code>pytest</code>s main branch, everything should work:</p>
<pre><code class="language-py">â–¶ uv run --no-project --with pytest@git+https://github.com/pytest-dev/pytest ty check main.py
All checks passed!
</code></pre>
<p>Related ty issue which addresses the underlying issue (and should make this work for old pytest versions): https://github.com/astral-sh/ty/issues/623</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">generics</span> added by @sharkdp on 2025-09-01 10:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Stable" by @carljm on 2025-11-14 17:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/graipher">@graipher</a> on 2025-12-01 07:26</div>
            <div class="timeline-body"><p>@sharkdp Even with <code>pytest&gt;=9</code>, where the original code by the OP passes, it does not work in all circumstances:</p>
<pre><code class="language-python">from typing import reveal_type

import pytest


def test_foo(s: str | None) -&gt; None:
    if s is None:
        pytest.skip()
    reveal_type(s)

</code></pre>
<pre><code>$ uvx ty check .
info[revealed-type]: Revealed type
 --&gt; src/foo/__init__.py:9:17
  |
7 |     if s is None:
8 |         pytest.skip()
9 |     reveal_type(s)
  |                 ^ `str | None`
  |
</code></pre>
<p><code>ty 0.0.1-alpha.29</code>, <code>pytest 9.0.1</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-12-01 07:48</div>
            <div class="timeline-body"><p>@graipher Looks like your example is related to #685</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-03 19:32</div>
            <div class="timeline-body"><p>@alex Out of curiosity, since you mentioned this issue is a blocker for cryptography: does it work for you on <code>pytest&gt;=9</code>, where they changed their annotations to bypass this limitation of our current constraint solver? Or are you stuck on an earlier pytest version? Or are you still seeing symptoms like @graipher on <code>pytest&gt;=9</code>, where the root cause problem is actually #685?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/alex">@alex</a> on 2025-12-03 19:39</div>
            <div class="timeline-body"><p>We're on pytest 9 for python &gt;= 3.10 -- so I suspect for my local reproduction that means its <em>actually</em> #685. However we need to support python 3.8 and 3.9, which require older pytest, so we don't benefit from the workaround.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:40:30 UTC
    </footer>
</body>
</html>
