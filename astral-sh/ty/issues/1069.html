<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>stop unioning un-annotated module globals with Unknown - astral-sh/ty #1069</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>stop unioning un-annotated module globals with Unknown</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1069">#1069</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-08-20 22:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><p>Our reasons why we currently union with Unknown are described in https://github.com/astral-sh/ruff/blob/main/crates/ty_python_semantic/resources/mdtest/doc/public_type_undeclared_symbols.md</p>
<p>While this is technically reasonable, from a gradual guarantee perspective, and consistent with our class-attribute behavior, I think ultimately for module globals, it&#x27;s the wrong tradeoff for users.</p>
<p>External mutation of module globals is relatively rare, and I don&#x27;t think it is important that we avoid &quot;false positives&quot; on code that does that. It is fine if you need to add a wider annotation to your module global in this uncommon case, so as to explicitly allow an external mutation you want to be able to do.</p>
<p>On the flip side, un-annotated module globals with unambiguous types that aren&#x27;t intended for external mutation are common, and requiring them to be annotated or <code>Final</code> in order to avoid the union with <code>Unknown</code> is just irritating and doesn&#x27;t add value.</p>
<p>I think the tradeoffs are different for class attributes, where mutation (if you include mutation on instances) is very common. That&#x27;s not to say we won&#x27;t ultimately decide to change course there, as well, but I think initially it makes sense to just change this for module globals.</p>
<p>This would also imply no longer unioning with Unknown when unannotated module globals are referenced from a nested scope in the same module.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Beta&quot; by <a href="https://github.com/carljm">@carljm</a> on 2025-08-20 22:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by <a href="https://github.com/carljm">@carljm</a> on 2025-08-20 22:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">typing semantics</span> added by <a href="https://github.com/carljm">@carljm</a> on 2025-08-20 22:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/carljm">@carljm</a> on 2025-08-22 13:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/carljm">@carljm</a> on 2025-08-22 14:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-08-22 14:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-08-22 15:48</div>
            <div class="timeline-body"><p>Three notes on this from discussion with @AlexWaygood :</p>
<ol>
<li>This should imply that we widen inferred literal types (e.g. <code>x = 3</code> would infer a public type of <code>int</code>)</li>
<li>Nested scopes within the same module should see the same type as an import would</li>
<li>We should remain open to changing our mind here depending on the mypy-primer report (e.g. if it causes tons of new false positives, for instance from monkeypatching module globals in test suites)</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-01 14:40</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:25:22 UTC
    </footer>
</body>
</html>
