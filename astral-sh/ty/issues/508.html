<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add subdiagnostic hint if async context manager is used in non-async `with` statement - astral-sh/ty #508</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add subdiagnostic hint if async context manager is used in non-async <code>with</code> statement</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/508">#508</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-05-25 11:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><p>CPython just added a really nice hint to its diagnostic message if you use an async context manager in a non-async <code>with</code> statement:</p>
<pre><code>Python 3.14.0a7+ (heads/main:fac41f56d4b, May 25 2025, 12:27:36) [Clang 17.0.0 (clang-1700.0.13.3)] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; class Foo:
...     async def __aenter__(self): ...
...     async def __aexit__(self, *args): ...
...     
&gt;&gt;&gt; with Foo():
...     ...
...     
Traceback (most recent call last):
  File &quot;&lt;python-input-1&gt;&quot;, line 1, in &lt;module&gt;
    with Foo():
         ~~~^^
TypeError: &#x27;Foo&#x27; object does not support the context manager protocol (missed __exit__ method) but it supports the asynchronous context manager protocol. Did you mean to use &#x27;async with&#x27;?
</code></pre>
<p>We should add a subdiagnostic to our equivalent error message that suggests using <code>async with</code> instead of <code>with</code>, so that it looks something like:</p>
<pre><code>error: Object of type `Foo` cannot be used with `with` because it does not implement `__enter__` and `__exit__`
note: Objects of type `Foo` *can* be used as async context managers
note: Consider using `async with` here
</code></pre>
<p>(Here&#x27;s a playground link to show our current error message: https://play.ty.dev/00fecd74-416e-46d1-8368-a2b87cbb84cd.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-25 11:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-25 11:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-25 12:11</div>
            <div class="timeline-body"><p>@lipefree -- this should be fairly easy to do, if you&#x27;re still looking for easy issues :-)</p>
<ul>
<li>Here&#x27;s an example of an existing diagnostic where we add a subdiagnostic giving additional information: https://github.com/astral-sh/ruff/blob/83a036960b8e7d31856a5f10d208b9eac894a187/crates/ty_python_semantic/src/types/infer.rs#L5751-L5755</li>
<li>The area of the code you&#x27;d need to edit is here: https://github.com/astral-sh/ruff/blob/83a036960b8e7d31856a5f10d208b9eac894a187/crates/ty_python_semantic/src/types.rs#L6099-L6104</li>
<li>We&#x27;d only want to add the subdiagnostic if <code>context_expression.try_call_dunder(db, &quot;__aenter__&quot;, CallArgumentTypes::none())</code> and <code>context_expression.try_call_dunder(db, &quot;__aexit__&quot;, CallArgumentTypes::positional([Type::none(db), Type::none(db), Type::none(db)]))</code> both return <code>Ok()</code> variants</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lipefree">@lipefree</a> on 2025-05-25 17:15</div>
            <div class="timeline-body"><p>Hey @AlexWaygood ! I will try to look into it tonight then and see if I can come up with something !</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-25 18:21</div>
            <div class="timeline-body"><p>(Tests should be added using <a href="https://github.com/astral-sh/ruff/tree/main/crates/ty_test#diagnostic-snapshotting">mdtest snapshots</a> to https://github.com/astral-sh/ruff/blob/main/crates/ty_python_semantic/resources/mdtest/with/sync.md)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-26 19:34</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:24:39 UTC
    </footer>
</body>
</html>
