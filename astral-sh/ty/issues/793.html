<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`ty` incorrectly skips over definitions that are not bindings when checking not-local loads - astral-sh/ty #793</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>ty</code> incorrectly skips over definitions that are not bindings when checking not-local loads</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/793">#793</a>
        opened by <a href="https://github.com/oconnor663">@oconnor663</a>
        on 2025-07-09 16:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/oconnor663">@oconnor663</a></div>
            <div class="timeline-body"><p>https://play.ty.dev/9040c09e-01bb-4866-b4b5-9f5d49ea31d2</p>
<pre><code class="language-py">def f():
    x = 1
    def g():
        x: int
        def h():
            y = x
        h()
    g()
f()
</code></pre>
<pre><code>$ python test.py
Traceback (most recent call last):
  File &quot;/tmp/test.py&quot;, line 10, in &lt;module&gt;
    f()
    ~^^
  File &quot;/tmp/test.py&quot;, line 9, in f
    g()
    ~^^
  File &quot;/tmp/test.py&quot;, line 8, in g
    h()
    ~^^
  File &quot;/tmp/test.py&quot;, line 7, in h
    y = x
        ^
NameError: cannot access free variable 'x' where it is not associated with a value in enclosing scope
</code></pre>
<pre><code>$ uvx ty check test.py
All checks passed!
</code></pre>
<p><code>ty</code> currently skips over <code>x: int</code> in <code>g</code> and decides to load <code>x = 1</code> from <code>f</code>. My theory is that the comment here is correct, but the treatment of <code>.is_bound()</code> here isn't doing what the comment says it's doing: https://github.com/astral-sh/ruff/blob/1eff0300d3784d116a19909bf0c1a493de2aea61/crates/ty_python_semantic/src/types/infer.rs#L5935-L5950</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-07-09 17:47</div>
            <div class="timeline-body"><p>Here's another kind of related case:</p>
<pre><code class="language-py">x: int = 1
def f():
    x: str = &quot;hello&quot;
    def g():
        global x
        def h():
            y: int = x
            print(y)
        h()
    g()
f()
</code></pre>
<pre><code>$ python test.py
1
</code></pre>
<pre><code>$ uvx ty check test.py
error[invalid-assignment]: Object of type `str` is not assignable to `int`
 --&gt; test.py:7:13
  |
5 |         global x
6 |         def h():
7 |             y: int = x
  |             ^
8 |             print(y)
9 |         h()
  |
info: rule `invalid-assignment` is enabled by default
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-07-09 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">runtime semantics</span> added by @AlexWaygood on 2025-07-09 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-07-11 20:59</div>
            <div class="timeline-body"><p>Ok the first case is trickier than I thought, because you might have something like this:</p>
<pre><code class="language-python">def f():
    x: int
    def g1():
        return x
    def g2():
        nonlocal x
        x = 2
    g2()
    g1()
f()
</code></pre>
<p>This isn't a name error, because <code>g2</code> is called before <code>g1</code>. To avoid a false positive here, we'd need to track that <code>x</code> is <code>nonlocal</code> in a <em>sibling</em> inner scope (and possibly ask whether a binding is made in that scope). It looks like Pyright does do that analysis today, but afaik Ty doesn't. So I don't think it's necessarily a bug that the first case above isn't an error. However, it <em>is</em> a bug that the reported type is wrong:</p>
<pre><code class="language-py">x: int = 1
def f():
    x: str
    def g():
        reveal_type(x)  # should be `str`, is currently `int`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-07-14 15:11</div>
            <div class="timeline-body"><p>Fixing the second bug is uncovering a third semi-related false positive in current <code>main</code>:</p>
<pre><code class="language-py">def f():
    global x
    x = 5
def g():
    print(x)
</code></pre>
<pre><code>error[unresolved-reference]: Name `x` used when not defined
 --&gt; test2.py:5:11
  |
3 |     x = 5
4 | def g():
5 |     print(x)
  |           ^
  |
</code></pre>
<p>Edit: @AlexWaygood points out that this error might be intentional/preferable, even though the code works at runtime.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-07-16 15:47</div>
            <div class="timeline-body"><p>Note that we still don't check whether variables in enclosing scopes are ever <em>bound</em>, e.g.:</p>
<pre><code class="language-py">x: int
def f():
    y = x  # Ty doesn't lint here.
</code></pre>
<p>So for that reason, the first example at the top of this issue still doesn't lint. But now that https://github.com/astral-sh/ruff/pull/19336 is in, it is looking at the right variable, and we can see that by adding type declarations:</p>
<pre><code class="language-py">x = &quot;hello&quot;
def f():
    x: int
    def g():
        y: int = x  # previously invalid assignment, now allowed (even though this `x` is unbound)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @oconnor663 on 2025-07-16 15:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:20:17 UTC
    </footer>
</body>
</html>
