<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support `Annotated` types as instance attributes (and pydantic constrained types) - astral-sh/ty #1015</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Support `Annotated` types as instance attributes (and pydantic constrained types)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1015">#1015</a>
        opened by <a href="https://github.com/mvernacc">@mvernacc</a>
        on 2025-08-15 20:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/mvernacc">@mvernacc</a> on 2025-08-15 20:23</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I would like ty to support type inference on class instance attributes declared with <code>Annotated</code>. Particularly, I'm interested in correct type inference for fields of pydantic models (pydantic makes heavy use of <code>Annotated</code> on model fields).</p>
<h2>Simple example</h2>
<p>The playground below shows that:</p>
<ul>
<li>ty correctly infers the type <code>float</code> for an annotated variable (outside a class)</li>
<li>~~ty incorrectly infers type <code>int | float</code> for an annotated instance attribute~~<ul>
<li>[Edit] As @carljm pointed out below, this is actually correct due to a nuance in the python type system.</li>
</ul>
</li>
</ul>
<p>https://play.ty.dev/7dd54204-0cf0-4076-8ca0-d5e421ad66c3</p>
<h2>Example with Pydantic</h2>
<p>The below example shows a pydanic <code>BaseModel</code> subclass. One field uses <code>Annotated</code> directly. Another field uses a <a href="https://docs.pydantic.dev/2.3/usage/types/number_types/#constrained-floats">pydantic constrained number type</a> which uses <code>Annotated</code> under the hood.</p>
<pre><code class="language-python">from typing import Annotated, reveal_type

from pydantic import BaseModel, PositiveFloat


class MyModel(BaseModel):
    annotated: Annotated[float, &quot;test annotation&quot;]
    pydantic_constrained: PositiveFloat

m = MyModel(annotated=2.0, pydantic_constrained=1.0)
reveal_type(m.annotated)
reveal_type(m.pydantic_constrained)
</code></pre>
<p><code>ty</code> does not infer the types for ~~these fields correctly~~ [Edit: the first field's type is correct]:</p>
<pre><code>&gt; ty check demo.py
WARN ty is pre-release software and not ready for production use. Expect to encounter bugs, missing features, and fatal errors.
Checking ------------------------------------------------------------ 1/1 files                                                                                                                                  info[revealed-type]: Revealed type
  --&gt; demo.py:11:13
   |
10 | m = MyModel(annotated=2.0, pydantic_constrained=1.0)
11 | reveal_type(m.annotated)
   |             ^^^^^^^^^^^ `int | float`
12 | reveal_type(m.pydantic_constrained)
   |

info[revealed-type]: Revealed type
  --&gt; scripts/ty_demo.py:12:13
   |
10 | m = MyModel(annotated=2.0, pydantic_constrained=1.0)
11 | reveal_type(m.annotated)
12 | reveal_type(m.pydantic_constrained)
   |             ^^^^^^^^^^^^^^^^^^^^^^ `Unknown`
   |

Found 2 diagnostics
</code></pre>
<p>For comparison, <code>pyright</code> infers type <code>float</code> for both fields. This is the behavior I desire:</p>
<pre><code>  demo.py:11:13 - information: Type of &quot;m.annotated&quot; is &quot;float&quot;
  demo.py:12:13 - information: Type of &quot;m.pydantic_constrained&quot; is &quot;float&quot;
0 errors, 0 warnings, 2 informations 
</code></pre>
<p>Possibly related issues:</p>
<ul>
<li>https://github.com/astral-sh/ty/issues/111</li>
<li>https://github.com/astral-sh/ty/issues/504</li>
</ul>
<p>p.s. Thank you for your work on ty! I love its speed and am looking forward to using it more. Better support for pydantic models would allow my team and I to adopt ty on more of our projects :)</p>
<h3>Version</h3>
<p>ty 0.0.1-alpha.18</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-08-15 20:54</div>
            <div class="timeline-body"><p>Thanks for the report!</p>
<p>Our inference of <code>float | int</code> for the field named <code>annotated</code> is the same as pyright's inference of <code>float</code>. There's an <a href="https://typing.python.org/en/latest/spec/special-types.html#special-cases-for-float-and-complex">awkward special case</a> in the Python type system where an annotation of <code>float</code> actually means <code>float | int</code> (<code>float</code> is not a supertype of <code>int</code>). Other type checkers attempt to &quot;hide&quot; this special case by also displaying the type <code>float | int</code> as just <code>float</code>. We feel that hiding the behavior this way just leads to even more confusing behavior in cases of type narrowing, so we display the full actual type. So when we say <code>float | int</code> here, that is the same type (with the same behavior) as pyright means by <code>float</code>; it's the direct interpretation of your <code>float</code> annotation.</p>
<p>The issue with <code>PositiveFloat</code> is a known limitation in our handling of implicit (legacy) type aliases; it should be fixed soon.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-08-15 20:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mvernacc">@mvernacc</a> on 2025-08-16 13:28</div>
            <div class="timeline-body"><blockquote>
<p>the type system contains a straightforward shortcut: when an argument is annotated as having type <code>float</code>, an argument of type <code>int</code> is acceptable</p>
</blockquote>
<p>TIL, thanks for pointing this out @carljm . It makes sense for ty to not hide this now that I know about it.</p>
<p>I'll watch for #221 to be resolved :)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 02:11:24 UTC
    </footer>
</body>
</html>
