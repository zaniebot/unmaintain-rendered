<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows | VSCode | Code completion doesn't work for local variables - astral-sh/ty #2135</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Windows | VSCode | Code completion doesn't work for local variables</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/2135">#2135</a>
        opened by <a href="https://github.com/LittleLittleCloud">@LittleLittleCloud</a>
        on 2025-12-20 20:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/LittleLittleCloud">@LittleLittleCloud</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Code completion doesn't work for local variables. from the video below you can see if I disable <code>ty</code> language server, the completion for <code>abc</code> shows up. After I enable <code>ty</code> language server, the code completion for local variables doesn't work, but code completion for property/method name still working</p>
<p>https://github.com/user-attachments/assets/97fc6f68-7ac2-4071-87f0-97ec6b7980bb</p>
<p>I think it's duplicate/regression of this issue #1864</p>
<h3>Version</h3>
<p>ruff==0.14.10 + ty==0.0.4 + ty extension==2025.74.0</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @carljm on 2025-12-22 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-12-23 08:43</div>
            <div class="timeline-body"><p>Thanks for the report! It seems to be working on my end:</p>
<p>https://github.com/user-attachments/assets/81bb82dc-8cd0-4c10-85c7-bf6fb4bd58ba</p>
<p>Could it be that whichever extension (or builtin feature) is providing the ghost text is somehow interfering with the completion request? Can you use <code>&quot;ty.trace.server&quot;: &quot;messages&quot;</code> setting and check whether you see a <code>textDocument/completion</code> request under &quot;ty Language Server Trace&quot; channel:</p>
<pre><code>[Trace - 14:11:54] Sending request 'textDocument/completion - (310)'.
...
[Trace - 14:11:54] Received response 'textDocument/completion - (310)' in 128ms.
</code></pre>
<p>https://github.com/user-attachments/assets/a8f8f5cf-7d20-4dcb-8a86-d79ae4549b8e</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">completions</span> added by @dhruvmanila on 2025-12-23 08:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-mre</span> added by @MichaReiser on 2025-12-23 08:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LittleLittleCloud">@LittleLittleCloud</a> on 2025-12-23 22:15</div>
            <div class="timeline-body"><p>@dhruvmanila Here's the trace message from my end. I put the first <code>completion</code> request in bold. It seems that the completion request didn't receive response immediately until get cancelled few seconds later</p>
<pre><code>[Trace - 2:12:36 PM] Sending notification 'textDocument/didChange'.
[Trace - 2:12:36 PM] Sending request 'textDocument/diagnostic - (1515)'.
[Trace - 2:12:36 PM] Received response 'textDocument/diagnostic - (1515)' in 2ms.
**[Trace - 2:12:36 PM] Sending request 'textDocument/completion - (1516)'.**
[Trace - 2:12:36 PM] Sending request 'textDocument/inlayHint - (1517)'.
[Trace - 2:12:36 PM] Sending request 'textDocument/diagnostic - (1518)'.
[Trace - 2:12:36 PM] Received response 'textDocument/inlayHint - (1517)' in 12ms.
[Trace - 2:12:36 PM] Received response 'textDocument/diagnostic - (1518)' in 17ms.
[Trace - 2:12:36 PM] Sending request 'textDocument/semanticTokens/full - (1519)'.
[Trace - 2:12:36 PM] Sending request 'textDocument/codeAction - (1520)'.
[Trace - 2:12:36 PM] Sending request 'textDocument/documentSymbol - (1521)'.
[Trace - 2:12:36 PM] Received response 'textDocument/semanticTokens/full - (1519)' in 7ms.
[Trace - 2:12:36 PM] Received response 'textDocument/documentSymbol - (1521)' in 7ms.
[Trace - 2:12:36 PM] Sending request 'textDocument/diagnostic - (1522)'.
[Trace - 2:12:36 PM] Received response 'textDocument/diagnostic - (1522)' in 2ms.
[Trace - 2:12:36 PM] Sending request 'textDocument/documentSymbol - (1523)'.
[Trace - 2:12:36 PM] Received response 'textDocument/documentSymbol - (1523)' in 3ms.
[Trace - 2:12:36 PM] Sending request 'textDocument/inlayHint - (1524)'.
[Trace - 2:12:36 PM] Received response 'textDocument/inlayHint - (1524)' in 1ms.
[Trace - 2:12:37 PM] Sending notification 'workspace/didChangeWatchedFiles'.
[Trace - 2:12:37 PM] Received request 'workspace/diagnostic/refresh - (2694)'.
[Trace - 2:12:37 PM] Sending response 'workspace/diagnostic/refresh - (2694)'. Processing request took 1ms
[Trace - 2:12:37 PM] Sending request 'textDocument/diagnostic - (1525)'.
[Trace - 2:12:37 PM] Sending request 'textDocument/diagnostic - (1526)'.
[Trace - 2:12:37 PM] Sending request 'textDocument/diagnostic - (1527)'.
[Trace - 2:12:37 PM] Received request 'workspace/inlayHint/refresh - (2695)'.
[Trace - 2:12:37 PM] Sending response 'workspace/inlayHint/refresh - (2695)'. Processing request took 1ms
[Trace - 2:12:37 PM] Received response 'textDocument/codeAction - (1520)' in 1226ms. Request failed: content modified (-32801).
[Trace - 2:12:37 PM] Received response 'textDocument/diagnostic - (1525)' in 4ms.
[Trace - 2:12:37 PM] Received response 'textDocument/diagnostic - (1526)' in 5ms.
[Trace - 2:12:37 PM] Received response 'textDocument/diagnostic - (1527)' in 6ms.
[Trace - 2:12:45 PM] Sending notification '$/cancelRequest'.
**[Trace - 2:12:45 PM] Received response 'textDocument/completion - (1516)' in 8808ms. Request failed: request was cancelled by client (-32800).**
[Trace - 2:12:45 PM] Sending request 'textDocument/diagnostic - (1528)'.
[Trace - 2:12:45 PM] Received response 'textDocument/diagnostic - (1528)' in 2ms.
[Trace - 2:12:45 PM] Sending request 'textDocument/diagnostic - (1529)'.
[Trace - 2:12:45 PM] Received response 'textDocument/diagnostic - (1529)' in 1ms.
[Trace - 2:12:45 PM] Sending request 'textDocument/diagnostic - (1530)'.
[Trace - 2:12:45 PM] Received response 'textDocument/diagnostic - (1530)' in 2ms.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-12-24 05:25</div>
            <div class="timeline-body"><p>Thanks for the logs, those are helpful!</p>
<blockquote>
<pre><code>**[Trace - 2:12:45 PM] Received response 'textDocument/completion - (1516)' in 8808ms. Request failed: request was cancelled by client (-32800).**
</code></pre>
</blockquote>
<p>It seems that the completion request is taking a long time to complete as it got cancelled after ~8 seconds.</p>
<p>Even the code action request took a long time (~1.2 second) and got cancelled:</p>
<blockquote>
<pre><code>[Trace - 2:12:37 PM] Received response 'textDocument/codeAction - (1520)' in 1226ms. Request failed: content modified (-32801).
</code></pre>
</blockquote>
<p>It might be useful to get some insights on the codebase like how it's structured, is it a large codebase, what are the dependencies? If the codebase is open-source, could you provide us with the link?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LittleLittleCloud">@LittleLittleCloud</a> on 2025-12-24 06:32</div>
            <div class="timeline-body"><p>@dhruvmanila I do confirm that the code completion works on a fresh new project so maybe this bug only appears under certain conditions. Let me try creating a minimal reproducable example for you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-12-24 06:54</div>
            <div class="timeline-body"><blockquote>
<p>Let me try creating a minimal reproducable example for you.</p>
</blockquote>
<p>That would be great, thank you!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:21:29 UTC
    </footer>
</body>
</html>
