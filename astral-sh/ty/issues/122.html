<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allow narrowing with `isinstance(x, str | int)` (PEP 604 union types) - astral-sh/ty #122</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Allow narrowing with <code>isinstance(x, str | int)</code> (PEP 604 union types)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/122">#122</a>
        opened by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a>
        on 2025-04-19 22:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-19 22:14</div>
            <div class="timeline-body"><p>Related:</p>
<p>What should be the expected revealed type here?</p>
<pre><code class="language-py">from typing_extensions import reveal_type

class A: ...
class B: ...
  
reveal_type(A | B) # revealed: `UnionType` or `type[A] | type[B]`?
</code></pre>
<p>Either way i think we must store the value of <code>A | B</code> as a <code>Type::Union</code>.</p>
<p>The way <code>mypy</code> handles this is it uses a <code>uses_pep604_syntax</code> flag in the <code>UnionType</code> class which allows it to reveal <code>UnionType</code>.</p>
<p>So, im not sure what the functionality should be</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-20 10:43</div>
            <div class="timeline-body"><p>What do you mean in your issue title when you say &quot;Allow <code>isinstance(x, str | int)</code>&quot;? We already allow these calls as long as you have <code>--python-version=3.10</code> (or higher) set: https://playknot.ruff.rs/fe84b883-b0cd-42bf-93c4-4e4d8f42f710</p>
<p>It's true that <code>reveal_type(int | str)</code> reveals <code>UnionType</code> -- but this is accurate regarding what the type is at runtime:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; type(int | str)
&lt;class 'types.UnionType'&gt;
</code></pre>
<p>Something we don't yet do is support narrowing inside these branches, e.g.</p>
<pre><code class="language-py">def f(x: object):
    if isinstance(x, (int, str)):
        reveal_type(x)  # revealed: int | str

    if isinstance(x, int | str):
        reveal_type(x)  # revealed: object
</code></pre>
<p>https://playknot.ruff.rs/1f038049-dcbf-41ce-a0f4-e6ee8b15c778</p>
<p>It would obviously be great if the second <code>isinstance()</code> call narrowed the type in the same way as the first one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Allow `isinstance(x, str | int)` (PEP 604 union types)" to "[red-knot] Allow narrowing with `isinstance(x, str | int)` (PEP 604 union types)" by @MatthewMckee4 on 2025-04-20 10:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-20 10:48</div>
            <div class="timeline-body"><p>Yeah, i meant regarding the narrowing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-20 10:50</div>
            <div class="timeline-body"><blockquote>
<p>Either way i think we must store the value of A | B as a Type::Union.
The way mypy handles this is it uses a uses_pep604_syntax flag in the UnionType class which allows it to reveal UnionType.
So, im not sure what the functionality should be</p>
</blockquote>
<p>Do you have any thoughts on this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-20 14:31</div>
            <div class="timeline-body"><p>This is quite a hard problem. (That doesn't mean that you <em>shouldn't</em> work on it -- though you of course don't have to -- it's just that there's a number of things to think through!)</p>
<p>I don't think we should infer the type of <code>A | B</code> here as a <code>Type::Union</code> because in contexts where we need to treat the object as a value expression that might lead to incorrect inferences. For example:</p>
<pre><code class="language-py">class A:
    x = 42

class B:
    x = 42

C = A | B

reveal_type(C.x)  # if we inferred `C` as having type `A | B`,
                  # we would fail to emit an error here and would reveal `Literal[42]`.
                  # But it fails at runtime! Because at runtime, `C` has type `types.UnionType`.
</code></pre>
<p>One solution here might be a new <code>Type</code> variant to represent these <code>types.UnionType</code> instances? We need to continue treating them as &quot;just instances of <code>types.UnionType</code>&quot; in the vast majority of cases, but in specific situations (like <code>isinstance()</code> narrowing), we need to be able to know what the original classes where that were <code>|</code>'d together to create the <code>UnionType</code> instance.</p>
<p>We have a similar problem for lots of other special typing constructs. For example:</p>
<pre><code class="language-py">from typing import Literal

X = Literal[&quot;foo&quot;, &quot;bar&quot;]

def f(x: X):
    reveal_type(x)
</code></pre>
<p>At runtime, the type of <code>X</code> is <code>typing._LiteralGenericAlias</code>. That's not a class that even exists in typeshed; typeshed just says that <code>typing.Literal</code> is an instance of <code>_SpecialForm</code>, and it just says that all instances of <code>_SpecialForm</code> return <code>object</code> from their <code>__getitem__</code> method. In most cases, we want to treat <code>Literal[&quot;foo&quot;, &quot;bar&quot;]</code> as an opaque object (which is why typeshed tells us to infer <code>object</code> for it), but in specific cases (where it's used in a type expression), we want to get back the original strings that were used to subscript <code>Literal</code>.</p>
<p>So I could see there being a more general solution there that doesn't just fix things for <code>UnionType</code>s: a <code>Type</code> variant that keeps track of the runtime type of the object as well as the type we should use whenever the object is used in a type expression:</p>
<pre><code class="language-rs">struct TypeForm&lt;'db&gt; {
    runtime_type: Type&lt;'db&gt;,
    in_type_expression: Type&lt;'db&gt;
}
</code></pre>
<p>where the union <code>A | B</code> would be represented as</p>
<pre><code class="language-rs">TypeForm {
    runtime_type: KnownClass::UnionType.to_instance(db),
    in_type_expression: UnionType::from_elements(db, [A, B]),
}
</code></pre>
<p>cc. @dcreager, who I know has been doing a fair bit of thinking about how to represent typeforms in red-knot's model recently</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-04-20 19:44</div>
            <div class="timeline-body"><p>Ah okay this makes a lot of sense, but yeah i see why its quite a hard issue that can be generalised to fix more issues, thanks for responding, it seems like i should leave this to the pros!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Allow narrowing with `isinstance(x, str | int)` (PEP 604 union types)" to "Allow narrowing with `isinstance(x, str | int)` (PEP 604 union types)" by @MichaReiser on 2025-05-07 15:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">narrowing</span> added by @AlexWaygood on 2025-05-10 18:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-11-08 18:20</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:39:13 UTC
    </footer>
</body>
</html>
