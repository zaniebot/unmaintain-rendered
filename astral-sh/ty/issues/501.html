<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handle `type[T]` for type variables - astral-sh/ty #501</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Handle <code>type[T]</code> for type variables</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/501">#501</a>
        opened by <a href="https://github.com/DouweM">@DouweM</a>
        on 2025-05-23 21:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/DouweM">@DouweM</a></div>
            <div class="timeline-body">Summary
<p>The following works in pyright, but not in pyrefly, mypy, or (which is why I&#x27;m here!) ty:</p>
<pre><code>from __future__ import annotations

from dataclasses import dataclass

from typing_extensions import (
    Generic,
    Sequence,
    TypeVar,
    assert_type,
)

T = TypeVar(&quot;T&quot;)


@dataclass
class Agent(Generic[T]):
    output_type: Sequence[type[T]]


class Foo:
    pass


class Bar:
    pass


# pyright - works
# mypy - error: Expression is of type &quot;Agent[object]&quot;, not &quot;Agent[Foo | Bar]&quot;  [assert-type]
# pyrefly - assert_type(Agent[Foo], Agent[Bar | Foo]) failed + Argument `list[type[Bar] | type[Foo]]` is not assignable to parameter `output_type` with type `Sequence[type[Foo]]` in function `Agent.__init__`
# ty - `Agent[Foo | Bar]` and `Agent[Unknown]` are not equivalent types
assert_type(Agent([Foo, Bar]), Agent[Foo | Bar])

# pyright - works
# mypy - error: Expression is of type &quot;Agent[Never]&quot;, not &quot;Agent[int | str]&quot;  [assert-type]
# pyrefly - assert_type(Agent[int], Agent[str | int]) failed + Argument `list[type[str] | type[int]]` is not assignable to parameter `output_type` with type `Sequence[type[int]]` in function `Agent.__init__`
# ty - `Agent[int | str]` and `Agent[Unknown]` are not equivalent types
assert_type(Agent([int, str]), Agent[int | str])

# works
assert_type(Agent[Foo | Bar]([Foo, Bar]), Agent[Foo | Bar])

# works
assert_type(Agent[int | str]([int, str]), Agent[int | str])
</code></pre>
<p>It would be great to see this work in ty, but if there&#x27;s a good reason the other 2 out of 3 typecheckers don&#x27;t support this I&#x27;d love to understand why!</p>
<ul>
<li>This is related to a new PydanticAI feature, if you&#x27;re curious check out <a href="https://github.com/pydantic/pydantic-ai/pull/1785">pydantic/pydantic-ai#1785</a>#issuecomment-2905774110</li>
<li>Issues for other type checkers:<ul>
<li>https://github.com/facebook/pyrefly/issues/345</li>
<li>https://github.com/python/mypy/issues/19142</li>
</ul>
</li>
</ul>
Version
<p>ty 0.0.1-alpha.6</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Sequence of types&quot; to &quot;Handle `type[T]` for type variables&quot; by <a href="https://github.com/dcreager">@dcreager</a> on 2025-05-24 13:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-05-24 13:37</div>
            <div class="timeline-body"><p>Thanks for the report! The underlying issue is that we don&#x27;t yet support <code>type[T]</code> for type variables. We didn&#x27;t have a tracking issue for that yet, so I&#x27;ve updated the issue title and we&#x27;ll use this one to track that feature.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">generics</span> added by <a href="https://github.com/dcreager">@dcreager</a> on 2025-05-24 13:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">type-inference</span> added by <a href="https://github.com/dcreager">@dcreager</a> on 2025-05-24 13:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-04 10:57</div>
            <div class="timeline-body"><p>#783 looks like a duplicate of this issue (but I&#x27;m leaving it open for now as I think it&#x27;ll be easier for users to find it on the issue tracker)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;GA&quot; by <a href="https://github.com/carljm">@carljm</a> on 2025-11-10 17:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Avasam">@Avasam</a> on 2025-11-11 17:28</div>
            <div class="timeline-body"><p>This may be related according to Alex:</p>
<p>Here&#x27;s a simple example where passing a variable annotated with a constrained <code>TypeVar</code> to <code>type</code>, then instantiating it, doesn&#x27;t match the <code>TypeVar</code> I started with (but instead only expects the constrained types):</p>
<pre><code>from typing import TypeVar

FileFlagValueT = TypeVar(&quot;FileFlagValueT&quot;, str, int, float)

# Simplified, see below for the real-world example
def foo(default_value: FileFlagValueT, value: str) -&gt; FileFlagValueT:
    return type(default_value)(value)
</code></pre>
<p>Results in:</p>
<pre><code>error[invalid-return-type]: Return type does not match returned value
   |
36 | def foo(default_value: FileFlagValueT, value: str) -&gt; FileFlagValueT:
   |                                                       -------------- Expected `FileFlagValueT@foo` because of return type
37 |     return type(default_value)(value)
   |            ^^^^^^^^^^^^^^^^^^^^^^^^^^ expected `FileFlagValueT@foo`, found `str | int | float`
   |
info: rule `invalid-return-type` is enabled by default
</code></pre>
<p>Real-world example, where I extract a bit of string, and see if can be parsed as another type. But also using the fallback value&#x27;s  type directly to avoid having to pass in a constructor separately. This should be &quot;type-safe&quot; as long as the <code>__new__/__init__</code> methods of the constrained types all accept a <code>str</code> as its lone parameter.</p>
<pre><code>def __value_from_filename(
    filename: str,
    delimiters: str,
    default_value: FileFlagValueT,
) -&gt; FileFlagValueT:
    if len(delimiters) != 2:
        raise ValueError(&quot;delimiters parameter must contain exactly 2 characters&quot;)
    try:
        string_value = filename.split(delimiters[0], 1)[1].split(delimiters[1])[0]
        value = type(default_value)(string_value)
    except (IndexError, ValueError):
        return default_value
    else:
        return value
</code></pre>
<p>mypy and pyright both pass here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/ibraheemdev">@ibraheemdev</a> by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-11-14 08:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone &quot;Stable&quot; by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-11-17 22:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Beta&quot; by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-11-17 22:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-11-28 08:20</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:24:38 UTC
    </footer>
</body>
</html>
