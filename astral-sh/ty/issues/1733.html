<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ty doesnt respect UV_PROJECT_ENVIRONMENT or `uv run`, leading it to incorrectly claim `unresolved-import` - astral-sh/ty #1733</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ty doesnt respect UV_PROJECT_ENVIRONMENT or <code>uv run</code>, leading it to incorrectly claim <code>unresolved-import</code></h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1733">#1733</a>
        opened by <a href="https://github.com/brycedrennan">@brycedrennan</a>
        on 2025-12-02 21:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/brycedrennan">@brycedrennan</a></div>
            <div class="timeline-body"><p>In a docker image, when <code>UV_PROJECT_ENVIRONMENT=/usr/local</code>, <code>ty</code> cannot resolve third-party imports even though <code>uv run python</code> can import them just fine.</p>
<p>The use case is having uv install into vanilla python docker images and then running the type checker against code in that image.</p>
<p>I see in previous discussion that we dont want to complicate <code>ty</code> with all the logic of finding the right python installation, but I would have expected <code>uv run</code> to have solved that such that <code>uv run ty</code> &quot;just works&quot;</p>
<p>Also note that <code>ty</code> is not respecting the environment that it's installed into. This is contrary to a <a href="https://github.com/astral-sh/ty/issues/684#issuecomment-3533238411">recent comment:</a></p>
<blockquote>
<p>We now respect the Python environment that ty itself is installed in</p>
</blockquote>
<p><strong>Repro</strong></p>
<pre><code class="language-bash">docker build -t ty-bug-repro .

# ty claims unresolved import:
docker run --rm ty-bug-repro uv run ty check
# error[unresolved-import]: Cannot resolve imported module `requests`

docker run --rm ty-bug-repro ty check
# error[unresolved-import]: Cannot resolve imported module `requests`

# But Python import works:
docker run --rm ty-bug-repro uv run main.py
# /usr/local/lib/python3.11/site-packages/requests/__init__.py
</code></pre>
<p><strong>Dockerfile:</strong></p>
<pre><code class="language-dockerfile">FROM python:3.11-slim
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/
ENV UV_PROJECT_ENVIRONMENT=/usr/local
WORKDIR /app
COPY . .
RUN uv sync 
</code></pre>
<p><strong>pyproject.toml:</strong></p>
<pre><code class="language-toml">[project]
name = &quot;ty-bug-repro&quot;
version = &quot;0.1.0&quot;
requires-python = &quot;&gt;=3.11&quot;
dependencies = [&quot;requests&quot;, &quot;ty&quot;]
</code></pre>
<p><strong>main.py:</strong></p>
<pre><code class="language-python">import requests
print(requests.__file__)
</code></pre>
<p><strong>Workarounds</strong>
I don't love any of these. Mostly because every other command in my makefile is identical for local dev vs running in my docker image.</p>
<p><strong>1. Set PYTHONPATH:</strong></p>
<pre><code class="language-dockerfile">ENV PYTHONPATH=/usr/local/lib/python3.11/site-packages
</code></pre>
<p><strong>2. Pass --python to ty:</strong></p>
<pre><code class="language-bash">ty check --python /usr/local/bin/python3
</code></pre>
<p><strong>3. Fake a venv:</strong></p>
<pre><code class="language-dockerfile">ENV VIRTUAL_ENV=/usr/local
RUN printf &quot;home = /usr/local/bin\nversion = 3.11\n&quot; &gt; /usr/local/pyvenv.cfg
</code></pre>
<p><strong>4. Suppress the error</strong></p>
<pre><code class="language-toml">[tool.ty.rules]
unresolved-import = &quot;ignore&quot;
</code></pre>
<h3>Version</h3>
<p>0.0.1-alpha.29</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-02 22:46</div>
            <div class="timeline-body"><p>I'm surprised to hear that <code>uv run ty check</code> doesn't work with <code>UV_PROJECT_ENVIRONMENT=/usr/local</code>. I can look into that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @zanieb by @zanieb on 2025-12-02 22:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Beta" by @carljm on 2025-12-02 23:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Beta" by @carljm on 2025-12-04 22:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Stable" by @carljm on 2025-12-04 22:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/notarealuseralcemy">@notarealuseralcemy</a> on 2026-01-09 16:24</div>
            <div class="timeline-body"><pre><code>ty check --python $(uv run -- which python)
</code></pre>
<p>is maybe a slightly easier workaround in *nix, if the command should be run in multiple environments (like CI/pre-commit hooks, in my case).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-09 16:31</div>
            <div class="timeline-body"><p>The reason it doesn't work with <code>UV_PROJECT_ENVIRONMENT</code> is that there's no <code>pyvenv.cfg</code> in the <code>VIRTUAL_ENV</code> location and ty rejects it. The &quot;fix&quot; is probably to allow environments via <code>VIRTUAL_ENV</code> as long as they have the expected site-packages structure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2026-01-09 19:16</div>
            <div class="timeline-body"><p>@zanieb We should also make the same change for &quot;environment ty is installed into&quot; -- currently that requires venv only, but it should allow system environments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2026-01-09 19:19</div>
            <div class="timeline-body"><p>We might not actually want <code>VIRTUAL_ENV=&lt;system-env&gt;</code> to work, as it could be confusing? Maybe we should read <code>UV_PROJECT_ENVIRONMENT</code> and only allow it in that case?</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:21:09 UTC
    </footer>
</body>
</html>
