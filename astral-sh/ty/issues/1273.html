<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>a way to explicitly specify variance using the new generic syntax - astral-sh/ty #1273</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>a way to explicitly specify variance using the new generic syntax</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1273">#1273</a>
        opened by <a href="https://github.com/DetachHead">@DetachHead</a>
        on 2025-09-29 05:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/DetachHead">@DetachHead</a></div>
            <div class="timeline-body"><p>the new generic syntax is got a significant downgrade compared to the old syntax where you can no longer explicitly specify the variance.</p>
<p>it would be nice if ty had a way to work around this, eg:</p>
<pre><code class="language-py">from ty_extensions import In, Out, InOut

class Foo[In[T]]: ... # contravariant
class Foo[Out[T]]: ... # covariant
class Foo[InOut[T]]: ... # invariant
</code></pre>
<p>(the names <code>In</code> and <code>Out</code> are taken from other languages like typescript, but perhaps for readability they could just be called <code>Covariant</code>, <code>Contravariant</code>, etc)</p>
<p>semi-related: #1017</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wish</span> added by @sharkdp on 2025-09-29 06:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">generics</span> added by @sharkdp on 2025-09-29 06:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-01 11:44</div>
            <div class="timeline-body"><p>Thanks for the feature request. Unfortunately your proposed way of spelling this is invalid syntax, so -- while I think in general we're open to adding experimental special forms where they can help move the type system forward -- this specific spelling wouldn't work, as it would be (correctly) rejected by CPython's parser at runtime and also our parser:</p>
<pre><code class="language-pycon">&gt;&gt;&gt; class Foo[In[T]]: ...
  File &quot;&lt;python-input-0&gt;&quot;, line 1
    class Foo[In[T]]: ...
                ^
SyntaxError: invalid syntax
</code></pre>
<p>I'm also not sure I agree that this kind of special form would move the type system forward, however, I'm afraid. It was a deliberate decision -- discussed at some length -- to avoid adding a way to explicitly specify variance as part of PEP-695. My impression is that a significant majority of Python developers are very happy that they no longer have to worry about the variance of type parameters when typing their code. There <em>are</em> cases when you need to force a type checker to accept a typevar as being covariant even though it would &quot;naturally&quot; infer the typevar as invariant (or similar), but I think they're pretty rare and usually unsound. Personally, I'm happy to say that users should be forced to use the more verbose legacy syntax in the unusual situation that they need this kind of thing.</p>
<p>For now, I'm going to close this -- even if we did want to consider this feature request, we certainly wouldn't get to it any time soon, as there are many more pressing features that we still need to implement. But I'm happy to reconsider an alternative spelling if I can see evidence that it would be helpful to other developers too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-10-01 11:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DetachHead">@DetachHead</a> on 2025-10-01 12:42</div>
            <div class="timeline-body"><blockquote>
<p>Thanks for the feature request. Unfortunately your proposed way of spelling this is invalid syntax, so -- while I think in general we're open to adding experimental special forms where they can help move the type system forward -- this specific spelling wouldn't work, as it would be (correctly) rejected by CPython's parser at runtime and also our parser:</p>
</blockquote>
<p>my bad, i should've checked that it was valid syntax before opening this lol</p>
<blockquote>
<p>I'm also not sure I agree that this kind of special form would move the type system forward, however, I'm afraid. It was a deliberate decision -- discussed at some length -- to avoid adding a way to explicitly specify variance as part of PEP-695. My impression is that a significant majority of Python developers are very happy that they no longer have to worry about the variance of type parameters when typing their code. There <em>are</em> cases when you need to force a type checker to accept a typevar as being covariant even though it would &quot;naturally&quot; infer the typevar as invariant (or similar), but I think they're pretty rare and usually unsound. Personally, I'm happy to say that users should be forced to use the more verbose legacy syntax in the unusual situation that they need this kind of thing.</p>
</blockquote>
<p>i'm not proposing that users are forced to specify the variance explicitly (though i would suggest an optional rule to do that), but i don't agree that it's a rare edge case to want to specify them. if you're developing a library i think it's essential to <em>always</em> specify the variance explicitly. otherwise you could unknowingly publish a breaking change to your API if you accidentally turn a class with a covariant generic into an invariant one by adding a new method.</p>
<p>i'm also convinced that while many users would consider it convenient that they don't have to think about variance, all hiding it does is make it more confusing when they encounter variance-related type errors.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-01 12:51</div>
            <div class="timeline-body"><blockquote>
<p>i'm not proposing that users are forced to specify the variance explicitly</p>
</blockquote>
<p>I know you weren't!</p>
<blockquote>
<p>but i don't agree that it's a rare edge case to want to specify them</p>
</blockquote>
<p>but this is where I still disagree :-)</p>
<p>I sympathise with what you're saying about library development, but I think the vast majority of programmers using Python typing are not library developers! And I think even for library development, you can usually ensure that your type annotations are working as expected by adding tests that make use of functions such as <code>static_assert</code> and <code>assert_never</code>.</p>
<p>So I am still open to reconsidering this if we see meither more real-world use cases or more evidence that others agree with you. But for now I still see little value in reopening this :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DetachHead">@DetachHead</a> on 2025-10-09 10:25</div>
            <div class="timeline-body"><blockquote>
<p>otherwise you could unknowingly publish a breaking change to your API if you accidentally turn a class with a covariant generic into an invariant one by adding a new method.</p>
</blockquote>
<p>to add to this i want to point out a recent example: the unintentional breaking change to frozen dataclasses introduced in python 3.13. see https://github.com/microsoft/pyright/discussions/11012</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-10-09 16:13</div>
            <div class="timeline-body"><p>@AlexWaygood I'd be inclined to leave this open in &quot;wish&quot; state; that makes it more findable for other developers who want to provide &quot;real-world use cases&quot; or &quot;evidence that it would be helpful to other developers too&quot;.</p>
<p>I agree it likely won't be a priority for us anytime soon, absent a PEP to standardize it. (But I do find the library-developer use-case pretty convincing; it's a lot more verbose to write assertion tests about the variance of a library class than to specify the variance of a typevar.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @carljm on 2025-10-09 16:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KotlinIsland">@KotlinIsland</a> on 2025-10-10 14:19</div>
            <div class="timeline-body"><pre><code class="language-py">class A[T: Out, R: Out[int]]: ...
</code></pre>
<p>and they could be reused for use-site variance:</p>
<pre><code class="language-py">def f(l: list[Out[object]]):
    l.append(1)  # expect error
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jorenham">@jorenham</a> on 2025-10-10 19:32</div>
            <div class="timeline-body"><p>As @carljm noted in https://discuss.python.org/t/should-variance-inference-ignore-underscore-prefixed-attributes/102978, it is unclear whether underscore-prefixed attributes should influence variance, as that would require the intent behind them. As far as I can tell, that's a pretty big class of use &quot;real-world use cases&quot; already.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-10-10 22:33</div>
            <div class="timeline-body"><p>@jorenham Explicitly specifying variance of a typevar doesn't solve that problem, though -- you still need to agree on rules around the use of &quot;private&quot; variables, in exactly the same way, or else you just end up moving the errors to places where the type-checker says &quot;you explicitly said this typevar is covariant, but you're using it contravariantly/invariantly.&quot; So I don't think this alone constitutes a use case for explicit specification of variance. (I do find &quot;library authors want to ensure they don't accidentally break their own intentions&quot; to be a reasonable use case.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Z post-stable" by @carljm on 2025-11-15 01:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Z post-stable" by @carljm on 2025-11-18 16:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:20:43 UTC
    </footer>
</body>
</html>
