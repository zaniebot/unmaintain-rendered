<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bidirectional inference with comprehensions - astral-sh/ty #1602</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Bidirectional inference with comprehensions</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1602">#1602</a>
        opened by <a href="https://github.com/gjcarneiro">@gjcarneiro</a>
        on 2025-11-20 17:07
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gjcarneiro">@gjcarneiro</a></div>
            <div class="timeline-body">Summary
<p>With Ty a27, a simple dict literal <code>{&quot;foo&quot;: &quot;abc&quot;}</code> is interpreted as <code>dict[Unknown | str, Unknown | str]</code>, which causes downstream problems.</p>
<p>https://play.ty.dev/9134dfe2-2020-4bcd-8549-4d22e562a562</p>
Version
<p>ty 0.0.1-alpha.27</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-20 17:13</div>
            <div class="timeline-body"><p>Thanks for the report! This is intentional behavior, though we&#x27;re continuing to evaluate it. If you haven&#x27;t annotated the dict, it seems unwarranted to assume that just because the initial contents were <code>str: str</code>, that those are supposed to be the only possible contents.</p>
<p>Can you say more about specifically what the &quot;downstream problems&quot; are?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gjcarneiro">@gjcarneiro</a> on 2025-11-20 17:38</div>
            <div class="timeline-body"><p>Maybe it&#x27;s unrelated to the <code>Unknown</code>, it&#x27;s just that <code>Unknown</code> confused me greatly.  Here&#x27;s the scenario: https://play.ty.dev/36b11db1-359e-41b6-b90f-0fe5acd9e27c</p>
<p>It seems like the list comprehension generating a list of dicts doesn&#x27;t work so well.  Maybe I wrongly assumed the <code>Unknown</code> was to blame.</p>
<pre><code>discounts: list[CreateParamsDiscount] = [
        {&quot;coupon&quot;: coupon_id} for coupon_id in apply_stripe_coupons
    ]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-20 17:52</div>
            <div class="timeline-body"><p>cc. @sharkdp / @ibraheemdev -- it looks like we&#x27;re possibly not propagating the type context fully into the list comprehension? (Was this one of the things you discussed at the on-site? I vaguely remember there being some talk about it being hard to propagate type context into a completely different scope, because it needs to travel from one <code>TypeInferenceBuilder</code> to another...?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;`{&quot;foo&quot;: &quot;abc&quot;}` type revealed as `dict[Unknown | str, Unknown | str]`&quot; to &quot;dictionary literal inside comprehension not inferred as TypedDict, even with annotation&quot; by <a href="https://github.com/carljm">@carljm</a> on 2025-11-20 17:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-20 18:00</div>
            <div class="timeline-body"><p>Yeah, I think the <code>| Unknown</code> part is unrelated here; <code>dict[str, str]</code> would fail the assignment to <code>CreateParamsDiscount</code> too. The issue is we&#x27;re not applying the type context from the annotation and inferring <code>CreateParamsDiscount</code> in the comprehension.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bidirectional inference</span> added by <a href="https://github.com/carljm">@carljm</a> on 2025-11-20 18:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Stable&quot; by <a href="https://github.com/carljm">@carljm</a> on 2025-11-20 18:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-20 18:01</div>
            <div class="timeline-body"><p>(I put this in stable as a P0 but I suspect it will come up a lot; if there&#x27;s a reasonable fix available it would be great to get it into the beta)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">typeddict</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-20 18:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-11-20 18:26</div>
            <div class="timeline-body"><blockquote>
<p>cc. @sharkdp / @ibraheemdev -- it looks like we&#x27;re possibly not propagating the type context fully into the list comprehension? (Was this one of the things you discussed at the on-site? I vaguely remember there being some talk about it being hard to propagate type context into a completely different scope, because it needs to travel from one TypeInferenceBuilder to another...?)</p>
</blockquote>
<p>Exactly. I was aware about this limitation in type inference for comprehensions. After we saw that the &quot;outer&quot; type context handled a lot of cases, @ibraheemdev and I decided that it was fine to postpone this (see <a href="https://github.com/astral-sh/ruff/pull/20962">astral-sh/ruff#20962</a>#discussion_r2482437556). I did add tests with a TODO <a href="https://github.com/astral-sh/ruff/blob/c4767f5aa89df66815736376127a71ab49777fe9/crates/ty_python_semantic/resources/mdtest/comprehensions/basic.md?plain=1#L177-L191">here</a> that are very similar to the scenario described in this issue. But I failed to create a ticket for the follow-up, so thanks for opening this @gjcarneiro.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">typeddict</span> removed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-11-20 18:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;dictionary literal inside comprehension not inferred as TypedDict, even with annotation&quot; to &quot;Bidirectional inference with comprehensions&quot; by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-11-27 02:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone &quot;Stable&quot; by <a href="https://github.com/carljm">@carljm</a> on 2026-01-08 18:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Pre-stable 1&quot; by <a href="https://github.com/carljm">@carljm</a> on 2026-01-08 18:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/ibraheemdev">@ibraheemdev</a> by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2026-01-09 05:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:26:03 UTC
    </footer>
</body>
</html>
