<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[panic] Panic when inferring definition types using generics - astral-sh/ty #380</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[panic] Panic when inferring definition types using generics</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/380">#380</a>
        opened by <a href="https://github.com/sarimak">@sarimak</a>
        on 2025-05-14 10:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sarimak">@sarimak</a></div>
            <div class="timeline-body"><pre><code>$ ty --version
ty 0.0.1-alpha.1

$ RUST_BACKTRACE=1 uvx ty check test.py
WARN ty is pre-release software and not ready for production use. Expect to encounter bugs, missing features, and fatal errors.
error[panic]: Panicked at /root/.cargo/git/checkouts/salsa-e6f3bb7c2a062968/7edce6e/src/function/execute.rs:209:25 when checking `.../test.py`: `infer_definition_types(Id(a655)): execute: too many cycle iterations`
info: This indicates a bug in ty.
info: If you could open an issue at https://github.com/astral-sh/ty/issues/new?title=%5Bpanic%5D, we&#x27;d be very appreciative!
info: Platform: linux x86_64
info: Args: [&quot;ty&quot;, &quot;check&quot;, &quot;test.py&quot;]
info: Backtrace:
   0: &lt;unknown&gt;
   1: &lt;unknown&gt;
...
 115: &lt;unknown&gt;
 116: &lt;unknown&gt;
 117: start_thread
             at ./nptl/pthread_create.c:448:8
 118: __GI___clone3
             at ./misc/../sysdeps/unix/sysv/linux/x86_64/clone3.S:78:0

info: query stacktrace:
   0: infer_definition_types(Id(a72e))
             at crates/ty_python_semantic/src/types/infer.rs:148
   1: infer_definition_types(Id(a7e3))
             at crates/ty_python_semantic/src/types/infer.rs:148
   2: symbol_by_id(Id(3028))
             at crates/ty_python_semantic/src/symbol.rs:576
   3: member_lookup_with_policy_(Id(2818))
             at crates/ty_python_semantic/src/types.rs:536
   4: infer_definition_types(Id(6b8f))
             at crates/ty_python_semantic/src/types/infer.rs:148
   5: symbol_by_id(Id(3027))
             at crates/ty_python_semantic/src/symbol.rs:576
   6: member_lookup_with_policy_(Id(2817))
             at crates/ty_python_semantic/src/types.rs:536
   7: infer_expression_types(Id(1802))
             at crates/ty_python_semantic/src/types/infer.rs:222
   8: infer_scope_types(Id(1004))
             at crates/ty_python_semantic/src/types/infer.rs:121
   9: check_types(Id(c00))
             at crates/ty_python_semantic/src/types.rs:84


Found 1 diagnostic
WARN A fatal error occurred while checking some files. Not all project files were analyzed. See the diagnostics list above for details.
</code></pre>
<pre><code>$ cat test.py
from collections.abc import Callable, Coroutine
from typing import Any, ParamSpec, TypeVar

import asyncssh

P = ParamSpec(&quot;P&quot;)
T = TypeVar(&quot;T&quot;)


def _handle_exceptions(
    func: Callable[P, Coroutine[Any, Any, T]],
) -&gt; Callable[P, Coroutine[Any, Any, T]]:
    async def inner(*args: Any, **kwargs: Any) -&gt; T:
        return await func(*args, **kwargs)

    return inner


class SFTPClient:
    @_handle_exceptions
    async def _connect(self) -&gt; None:
        self._conn = await asyncssh.connect()
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[panic]&quot; to &quot;[panic] Panic when inferring definition types using generics&quot; by <a href="https://github.com/sarimak">@sarimak</a> on 2025-05-14 10:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fatal</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-14 11:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">generics</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-14 11:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-14 11:44</div>
            <div class="timeline-body"><p>Thanks so much for the MRE, it&#x27;s really helpful!</p>
<p>This is the same panic message as #256 and it also involves generics, so it seems likely that it has a similar underlying cause. I don&#x27;t see any obviously self-referential types here, though, which is interesting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-06-27 14:33</div>
            <div class="timeline-body"><p>I&#x27;m going to close this as a duplicate of #256 -- it seems likely the self-reference is in asyncssh.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2025-06-27 14:33</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:24:29 UTC
    </footer>
</body>
</html>
