<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account for TypedDicts in narrowing of `isinstance(..., dict)` - astral-sh/ty #1130</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Account for TypedDicts in narrowing of `isinstance(..., dict)`</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1130">#1130</a>
        opened by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a>
        on 2025-09-04 23:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> on 2025-09-04 23:11</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>We just closed #456, but there's one special case that needs more attention: <code>isinstance(x, dict)</code>. The tricky part is that TypedDicts are instances of <code>dict</code> at runtime, but are not (generally) assignable to any materialization of <code>dict[Any, Any]</code>. (See the proposed spec change in https://github.com/python/typing/pull/2072 for the details.)</p>
<p>Current behavior is as follows (<a href="https://play.ty.dev/89647293-a588-442d-ae5c-d0e2fbdacd2c">playground</a>):</p>
<pre><code class="language-python">from typing import TypedDict

class X(TypedDict):
    a: int

def _(x: list | X):
    if isinstance(x, dict):
        reveal_type(x)  # X &amp; Top[dict[Unknown, Unknown]]
    else:
        reveal_type(x)  # list[Unknown] | (X &amp; ~Top[dict[Unknown, Unknown]])
</code></pre>
<p>Mypy and pyright both infer <code>X</code> in the positive branch and <code>list[Any]</code> in the negative branch, which is what we'd want.</p>
<p>I know TypedDict support is still missing a lot of functionality, so things will change, but I see a few options:</p>
<ul>
<li>Make TypedDict types into subtypes of <code>Top[dict[Unknown, Unknown]]</code>. That would make this sample work correctly, but it's technically wrong in that TypedDicts aren't materializations of <code>dict[Any, Any]</code>. As such, it may cause issues with other possible use cases for <code>Top[]</code>. It would also allow some unsafe operations (https://github.com/JelleZijlstra/unsoundness/blob/main/examples/narrowing/isinstance_dict.py).</li>
<li>Change the spec so that TypedDict types are assignable to <code>dict[str, Any]</code>. I think that's a defensible change, but it's not what the current spec says and I don't know if such a change would see a positive reception.</li>
<li>Add a new special form <code>ty_extensions.AnyTypedDict</code>, with the semantics that any TypedDict type is a subtype of <code>AnyTypedDict</code>. The only allowed operations on <code>AnyTypedDict</code> are those that are allowed on any TypedDict (so no <code>.clear()</code>; <code>.keys()</code> returns an iterable of <code>str</code>; <code>.values()</code> an iterable of <code>object</code>; etc.). <code>isinstance(x, dict)</code> would narrow to <code>AnyTypedDict | Top[dict[Unknown, Unknown]]</code>. This is technically correct and would fix the soundness hole in https://github.com/JelleZijlstra/unsoundness/blob/main/examples/narrowing/isinstance_dict.py, but it would introduce a new user-visible concept.</li>
</ul>
<h3>Version</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">narrowing</span> added by @AlexWaygood on 2025-09-04 23:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-09-04 23:51</div>
            <div class="timeline-body"><blockquote>
<ul>
<li>Change the spec so that TypedDict types are assignable to <code>dict[str, Any]</code></li>
</ul>
</blockquote>
<p>I think this would also require that TypedDict types are all subtypes of <code>Top[dict[str, Any]]</code>?</p>
<p>And this also would require that <code>.clear()</code> be part of the <code>TypedDict</code> type, allowing that unsoundness.</p>
<blockquote>
<ul>
<li>it would introduce a new user-visible concept.</li>
</ul>
</blockquote>
<p>We could potentially spell the new type <code>Top[TypedDict]</code> instead of <code>AnyTypedDict</code> (I'd probably prefer to stay away from the word &quot;Any&quot; regardless, as part of the name of a fully-static type), which means it doesn't require any new symbols.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Narrowing of `isinstance(..., dict)`" to "Account for TypedDicts in narrowing of `isinstance(..., dict)`" by @carljm on 2026-01-09 02:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">typeddict</span> added by @carljm on 2026-01-09 02:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Stable" by @carljm on 2026-01-09 02:33</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:48:55 UTC
    </footer>
</body>
</html>
