<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Type of `global` variable is not narrowed in function scopes - astral-sh/ty #311</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Type of <code>global</code> variable is not narrowed in function scopes</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/311">#311</a>
        opened by <a href="https://github.com/ion-elgreco">@ion-elgreco</a>
        on 2025-05-10 16:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ion-elgreco">@ion-elgreco</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<pre><code class="language-python">class Instance: ...

_instance: Instance | None = None

def get_instance() -&gt; Instance:
    &quot;&quot;&quot;Lazy static to get the instance&quot;&quot;&quot;
    global _instance
    if _instance is None:
        _instance = Instance()
    return _instance
</code></pre>
<p>https://play.ty.dev/f0b802a2-9e21-438d-8946-6386a45b45b5</p>
<p>We already checked that if it's None we assign a value to it, so the return value can't be possibly None anymore</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-05-10 17:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">narrowing</span> added by @AlexWaygood on 2025-05-10 17:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Return type incorrectly recognized as None" to "Type of `global` variable is not narrowed in function scopes" by @AlexWaygood on 2025-05-10 17:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-12 10:13</div>
            <div class="timeline-body"><p>Thank you for reporting this. The problem here is that narrowing on <code>global</code>s is inherently unsafe. Consider this:</p>
<pre><code class="language-py">x: int | None = 1

def reset_x() -&gt; None:
    global x
    x = None

def f() -&gt; None:
    global x

    if x is not None:
        reset_x()
        reveal_type(x)  # ?
</code></pre>
<p>Other type checkers such as mypy and pyright report <code>int</code> here, but at runtime, <code>x</code> is <code>None</code>. We might still support this eventually. See #164 for a similar discussion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-13 01:17</div>
            <div class="timeline-body"><blockquote>
<p>The problem here is that narrowing on <code>global</code>s is inherently unsafe.</p>
</blockquote>
<p>This is true, and it's also possible that code from another thread could mutate the global in a concurrent program.</p>
<p>The unsafety here also applies to narrowing of attributes and subscript expressions, however. You already linked to #164, but just to spell it out:</p>
<pre><code class="language-py">class Foo:
    x: int | None = 1

def reset_x(t: Foo) -&gt; None:
    t.x = None

def f(t: Foo) -&gt; None:
    if t.x is not None:
        reset_x(t)
        reveal_type(x)  # ?
</code></pre>
<p>But we intend to support narrowing for attributes and subscripts nonetheless, since a lot of real-world code relies on it, users strongly expect it to work, and the practical experience of existing type checkers has been that the theoretical unsoundness here rarely causes practical issues in Python code.</p>
<p>I think narrowing for <code>global</code> variables, as suggested in this issue, has more or less the same set of considerations as narrowing for attributes or subscripts. I can't see a strong justification for doing attribute/subscript narrowing, but not <code>global</code>-variable narrowing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Beta" by @carljm on 2025-06-11 00:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-07-14 20:11</div>
            <div class="timeline-body"><p>Our behavior today seems to depend on whether the variable is free or marked <code>global</code>:</p>
<pre><code class="language-py">x: int | None = None

def f():
    if x is not None:
        y: int = x  # allowed

def f():
    global x
    if x is not None:
        y: int = x  # error: [invalid-assignment]
</code></pre>
<p>Probably those two examples should either both pass or both fail?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-07-14 20:15</div>
            <div class="timeline-body"><p>Those two examples should both pass; and the fact that the first already passes suggests that it shouldn't be too hard to make the second pass as well?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @oconnor663 on 2025-07-22 23:42</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:19:49 UTC
    </footer>
</body>
</html>
