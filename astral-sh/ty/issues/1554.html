<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LSP: Support nested projects - astral-sh/ty #1554</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>LSP: Support nested projects</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1554">#1554</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-11-14 13:38
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-14 13:38</div>
            <div class="timeline-body"><p>When opening a folder that contains nested ty projects, ty should use the correct configuration for each nested project rathern than using the outer most configuration.</p>
<pre><code>- parser/
  - src/parser
    - lib.py
  - ty.toml
- linter
  - src/linter
    - lib.py
  - ty.toml  
</code></pre>
<p>ty should use the <code>parser/ty.toml</code> configuration for all files in <code>parser/</code> and the <code>linter/ty.toml</code> configuration for all files in <code>linter</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Stable" by @MichaReiser on 2025-11-14 13:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2025-11-14 13:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-14 17:18</div>
            <div class="timeline-body"><p>Just a question of clarification: the example shown in the description doesn't look like &quot;nested projects&quot; to me? It looks like side-by-side projects? Unless it is implied that there is an outer <code>ty.toml</code> or <code>pyproject.toml</code> that isn't mentioned.</p>
<p>So is this issue just for supporting &quot;multiple projects open at once in LSP&quot;, or is it for supporting nested projects?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-14 17:24</div>
            <div class="timeline-body"><p>You could also have an outer project which complicates things slightly because you then need to exclude the paths of the inner projects.</p>
<p>But yes, the main feature is that if you open an outer folder that contains multiple project (nested or side by side), then ty should use the closest ty configuration instead of the closest configuration to the root folder</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-16 11:54</div>
            <div class="timeline-body"><p>I started an implementation in https://github.com/astral-sh/ruff/compare/main...micha/lsp-mono-repo</p>
<p>What's left to do is:</p>
<ul>
<li>The current heuristics of creating a db for each <code>pyproject.toml</code> seems to eager as it's not clear when there are multiple nested <code>pyproject.toml</code> if each member should be checked on their own or if it's a single workspace. I think we want to change the heuristics to ignore <code>pyproject.toml</code> files that use the default configuration (after resolving the virtual env path from the editor)</li>
<li>The server needs to rediscover the projects when the <code>pythonEnvironment</code> configuration changes OR when a<code>pyproject.toml</code> or <code>ty.toml</code> file was created or deleted.</li>
<li>We need to call <code>File::sync</code> for every open file for every open database if any database was closed (e.g. when a inner project was removed, the files now all belong to the outer project, but it may already have an interned <code>File</code> that now needs updating)</li>
</ul>
<p>One thing that's unclear to me is whether we need to sync the open file state for every database even if the file doesn't belong to this DB instance. For example, a project might import a file from another project (made available through the virtual env). Changes to the imported file (even when unsaved) should be reflected for both databases.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Stable" by @MichaReiser on 2025-12-31 16:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Pre-stable 1" by @MichaReiser on 2025-12-31 16:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @Gankra by @Gankra on 2026-01-09 03:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-09 09:13</div>
            <div class="timeline-body"><p>I'm not convinced this is the solution as it won't be able to support arbitrary setting differences, but I think it's worth mentioning.</p>
<p>What I had in mind for uv-workspaces (where all projects use the same search paths) was to heavily lean on overrides to toggle rules (and other settings) at a sub-project level</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-09 09:22</div>
            <div class="timeline-body"><p>Clsoing in favor of</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2026-01-09 09:22</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:48:55 UTC
    </footer>
</body>
</html>
