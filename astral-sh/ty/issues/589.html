<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>traversal of 'Never' branches - astral-sh/ty #589</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>traversal of 'Never' branches</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/589">#589</a>
        opened by <a href="https://github.com/lczyk">@lczyk</a>
        on 2025-06-05 23:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/lczyk">@lczyk</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>one more based on <a href="https://github.com/MarcinKonowalczyk/type_conversion_dict">type_conversion_dict</a>. There is a helper function for converting to a custom dictionary type. here is a mwe to reproduce</p>
<pre><code class="language-python">from typing import Union
from typing_extensions import reveal_type

class MyDict(dict):
    pass


# These are not needed for the example, but the actual function is overloaded.

# from typing import Any, overload
# @overload
# def nested_convert(d: dict) -&gt; MyDict: ...
# @overload
# def nested_convert(d: list) -&gt; list: ...
# @overload
# def nested_convert(d: Any, *, _depth: int) -&gt; Any: ...


def nested_convert(d: Union[dict, list], *, _depth: int = 0) -&gt; Union[MyDict, list]:
    &quot;&quot;&quot;Convert a nested dict to MyDict.&quot;&quot;&quot;

    if isinstance(d, dict):
        kv = ((k, nested_convert(v, _depth=_depth + 1)) for k, v in d.items())
        return MyDict(kv)
    elif isinstance(d, list):
        vs = (nested_convert(v, _depth=_depth + 1) for v in d)
        return list(vs)
    else:
        if _depth == 0:
            raise TypeError(&quot;Input must be a dict or a list&quot;)
        reveal_type(d)
        return d

</code></pre>
<p>which gives</p>
<pre><code>error[invalid-return-type] mwe.py:31:16: Return type does not match returned value: expected `MyDict | list[Unknown]`, found `(dict[Unknown, Unknown] &amp; ~dict[Unknown, Unknown] &amp; ~list[Unknown]) | (list[Unknown] &amp; ~dict[Unknown, Unknown] &amp; ~list[Unknown])`
</code></pre>
<p>but works in mypy.</p>
<p>i'm unsure whether this is a correct behaviour of mypy...? mypy does not show any output for <code>reveal_type</code> and the language server reports <code>d</code>'s type (in the last <code>return d</code> line) as <code>Never</code>, presumably since that branch is never taken by mypy.</p>
<p>This is definitely a bit more of a fringe example and can also be kinda solved with <code>@no_type_check</code> decorator (since the actual implementation has a bunch of overloads on top of it to provide the interface. It's hopefully an interesting example though.</p>
<h3>Version</h3>
<p>ty 0.0.1-alpha.8 (c1337c962 2025-06-02)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-06-05 23:36</div>
            <div class="timeline-body"><p>I think this is a nice example for #456</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-06-05 23:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lczyk">@lczyk</a> on 2025-06-05 23:38</div>
            <div class="timeline-body"><p>hmm... i did see that thread but it did not seem like the same thing. i will have a more thorough read! ty :))</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:20:05 UTC
    </footer>
</body>
</html>
