<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stack overflows for recursive protocols - astral-sh/ty #93</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Stack overflows for recursive protocols</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/93">#93</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-05-07 07:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body"><p>astral-sh/ruff#17880 fixed one particular stack overflow involving <code>is_fully_static</code>-checks on recursive protocols, but there are other type properties that have the same problem (assignability, equivalence). To fix this, we probably need a more general solution that might also supersede the specific handling for <code>is_fully_static</code>.</p>
<p>Example with stack overflow:</p>
<pre><code>from __future__ import annotations

from typing import Protocol

class P(Protocol):
    parent: P

class Q(Protocol):
    parent: Q

def _(p: P, q: Q):
    p = q
</code></pre>
<p>Existing tests, commented out:</p>
<p>https://github.com/astral-sh/ruff/blob/04457f99b6ba69dff38c1163a1668b6332ebd8b3/crates/ty_python_semantic/resources/mdtest/protocols.md?plain=1#L1585-L1594</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-07 07:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-07 07:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;ty beta&quot; by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-07 07:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-07 07:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[ty] Stack overflows for recursive protocols&quot; to &quot;Stack overflows for recursive protocols&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-07 15:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-09 12:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-09 12:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-09 12:56</div>
            <div class="timeline-body"><p>Let&#x27;s keep this open because we can only handle self-referential protocols. See <a href="https://github.com/astral-sh/ruff/pull/17929">astral-sh/ruff#17929</a>#issuecomment-2863922607</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-09 12:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-09 12:58</div>
            <div class="timeline-body"><p>In particular, there are still problems with mutually-recursive protocols, see <a href="https://github.com/astral-sh/ruff/pull/17929">astral-sh/ruff#17929</a>#discussion_r2080141116.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fatal</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-10 18:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LordAro">@LordAro</a> on 2025-06-10 14:18</div>
            <div class="timeline-body"><p>In the interests of reporting, I&#x27;ve got this with <code>ty 0.0.1-alpha.8</code>, which I <em>think</em> is after the above was merged? So this is a separate issue for Protocols that are self-referential? Unless the use of Self circumvents that...</p>
<pre><code>from __future__ import annotations

from typing import Protocol, Self

class Loc(Protocol):
    all_loc: Self
    def __getitem__(self, item: str) -&gt; Loc | None: ...
</code></pre>
<p>Removing either line from Loc allows it to pass</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/carljm">@carljm</a> on 2025-06-10 23:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/carljm">@carljm</a> on 2025-06-10 23:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-06-11 01:12</div>
            <div class="timeline-body"><p>Yeah, the use of <code>Self</code> here adds an indirection to the recursion that bypasses the current simple self-recursion detection.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-08-15 01:25</div>
            <div class="timeline-body"><p>I think we can close this issue as recursive protocols generally do not stack overflow anymore? There may be some more specific bugs yet, but those should get individual issues opened for them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2025-08-15 01:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:24:05 UTC
    </footer>
</body>
</html>
