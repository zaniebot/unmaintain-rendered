<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>isinstance(obj, dict) on object | None narrows to type where dict.get() fails with Expected Never - astral-sh/ty #2372</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>isinstance(obj, dict) on object | None narrows to type where dict.get() fails with Expected Never</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/2372">#2372</a>
        opened by <a href="https://github.com/yilei">@yilei</a>
        on 2026-01-06 22:20
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/yilei">@yilei</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>When narrowing <code>object | None</code> to <code>dict</code> using <code>isinstance()</code>, ty reveals the type as <code>Top[dict[Unknown, Unknown]]</code>, but subsequent calls to <code>dict.get()</code> fail with <code>Expected Never, found Literal[&quot;key&quot;]</code>. This makes common patterns for handling untyped JSON-like data unusable.</p>
<h3>Minimal Reproducer</h3>
<pre><code class="language-python">def get_value(body: object | None) -&gt; str | None:
    if isinstance(body, dict):
        # ty reveals body as `Top[dict[Unknown, Unknown]]`
        # but dict.get() fails with &quot;Expected Never, found Literal['key']&quot;
        value = body.get(&quot;key&quot;)  # ty error here
        if isinstance(value, str):
            return value
    return None
</code></pre>
<h3>Error Output</h3>
<pre><code>error[invalid-argument-type]: Argument to bound method `get` is incorrect
  --&gt; test.py:6:26
   |
 4 |         # ty reveals body as `Top[dict[Unknown, Unknown]]`
 5 |         # but dict.get() fails with &quot;Expected Never, found Literal['key']&quot;
 6 |         value = body.get(&quot;key&quot;)  # ty error here
   |                          ^^^^^ Expected `Never`, found `Literal[&quot;key&quot;]`
   |
info: Matching overload defined here
    --&gt; stdlib/builtins.pyi:3015:9
     |
3013 |     # Positional-only in dict, but not in MutableMapping
3014 |     @overload  # type: ignore[override]
3015 |     def get(self, key: _KT, default: None = None, /) -&gt; _VT | None:
     |         ^^^       -------- Parameter declared here
3016 |         &quot;&quot;&quot;Return the value for key if key is in the dictionary, else default.&quot;&quot;&quot;
     |
info: Non-matching overloads for bound method `get`:
info:   (self, key: _KT@dict, default: _VT@dict, /) -&gt; _VT@dict
info:   (self, key: _KT@dict, default: _T@get, /) -&gt; _VT@dict | _T@get
</code></pre>
<h3>Expected Behavior</h3>
<p>Pyright narrows <code>body</code> to <code>dict[Unknown, Unknown]</code> and allows <code>.get()</code> calls with any string key. ty should allow the same.</p>
<h3>ty Version</h3>
<p>ty 0.0.9 (f1652f05d 2026-01-05)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @yilei on 2026-01-06 22:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/yilei">@yilei</a> on 2026-01-06 22:57</div>
            <div class="timeline-body"><p>I'm so sorry, I did not mean to create this issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @yilei on 2026-01-06 23:14</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:21:42 UTC
    </footer>
</body>
</html>
