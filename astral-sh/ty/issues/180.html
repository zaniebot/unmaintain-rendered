<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>calls to functions returning `Never`/`NoReturn` are terminal - astral-sh/ty #180</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>calls to functions returning <code>Never</code>/<code>NoReturn</code> are terminal</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/180">#180</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-03-13 08:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body">Summary
<p>The following code emits a <code>invalid-return-type</code> diagnostic, but shouldn&#x27;t:</p>
<pre><code>from typing import NoReturn
import sys

def f() -&gt; NoReturn:
#          ^^^^^^^^ Function can implicitly return `None`, which is not assignable to return type `Never`
    sys.exit(1)
</code></pre>
<p><code>sys.exit</code> is annotated with returning <code>NoReturn</code>, but the problem is that we don&#x27;t have an explicit <code>return</code> statement here.</p>
<p>This is related to unreachable code analysis. We already have some special handling for detecting whether or not the end of scope is reachable (i.e. replacing <code>sys.exit(1)</code> with <code>while True: pass</code> works fine), but this does not take calls to functions returning <code>Never</code>/<code>NoReturn</code> into account.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-03-13 08:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[red-knot] Return type checking in presence of calls to `Never`/`NoReturn`&quot; to &quot;[red-knot] Return type checking for `Never`/`NoReturn`&quot; by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-03-13 08:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> on 2025-03-15 15:58</div>
            <div class="timeline-body"><p>Hi David, I would like to work on this. Would this be an OK first issue to pick up?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-03-15 19:16</div>
            <div class="timeline-body"><p>You are certainly welcome to try! However, I do not think that this is a particularly beginner friendly task. We might have some issues labeled with &quot;help wanted&quot; that might be more suitable for a first contribution.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> on 2025-03-15 20:19</div>
            <div class="timeline-body"><p>Got it. I will try to find another issue, or another minor task in this area (I do see some TODOs in the tests, for example).</p>
<p>However, one thing is not clear to me. You mention in the issue description that replacing <code>sys.exit(1)</code> with <code>while True: pass</code> does not give an error. I tried that out, and indeed there is no error.</p>
<p>However, the following <strong>also</strong> does not give any error:</p>
<pre><code>def f() -&gt; int:
  while True:
    pass
</code></pre>
<p>(Notice that I changed the return value to <code>int</code>.)</p>
<p>Here, if the &quot;<code>while True</code> never returns anything&quot; inference was being done correctly, the above should have errored out, right?</p>
<p>Moreover, the following gives an error:</p>
<pre><code># &quot;Object of type `Literal[&quot;foo&quot;]` is not assignable to return type `int`&quot;
def f() -&gt; int:
  while True:
    pass

  return &quot;foo&quot;
</code></pre>
<p>... which makes me wonder if <code>red-knot</code> does not correctly understand the <code>while True: pass</code> case at all. Am I missing something?</p>
<p>Edit: looking at <a href="https://github.com/astral-sh/ruff/pull/15676">astral-sh/ruff#15676</a>/, which introduced the unreachability-detection, I don&#x27;t see a &quot;<code>while True</code> with no <code>break</code>&quot; condition.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[red-knot] Return type checking for `Never`/`NoReturn`&quot; to &quot;[red-knot] calls to functions returning `Never`/`NoReturn` are terminal&quot; by <a href="https://github.com/carljm">@carljm</a> on 2025-03-26 20:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> on 2025-04-08 13:39</div>
            <div class="timeline-body"><blockquote>
<p>However, the following <strong>also</strong> does not give any error:</p>
<p>def f() -&gt; int:
while True:
pass</p>
<p>(Notice that I changed the return value to <code>int</code>.)</p>
</blockquote>
<p>Because there are no reachable <code>return</code> statements, and the end of function scope is not visible, it makes sense that there are no diagnostics emitted currently, because we aren&#x27;t checking the return value at all.</p>
<p>However, in this case, the correct thing to do would be to enforce that the function&#x27;s annotated return type is <code>Never</code>, isn&#x27;t it?
@sharkdp does this seem fit for a separate issue?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-09 07:01</div>
            <div class="timeline-body"><p>@abhijeetbodas2001 Sorry for responding so late, I must have missed the notification about your original message while I was out on vacation.</p>
<blockquote>
<p>Here, if the &quot;<code>while True</code> never returns anything&quot; inference was being done correctly, the above should have errored out, right?</p>
</blockquote>
<p>I don&#x27;t think so. A function annotated with <code>int</code> that loops endlessly is not incorrect. You can think of the endless loop as returning <code>Never</code>, but <code>Never</code> is assignable to the return type <code>int</code> (<code>Never</code> is assignable to any type), so nothing wrong there.</p>
<blockquote>
<p>Moreover, the following gives an error:</p>
</blockquote>
<p>Yes, we don&#x27;t silence <em>all</em> errors in unreachable code. And in this case, it&#x27;s arguable if that would be an improvement. If the loop were not endless, that return statement <em>would</em> be wrong. So flagging it does not seem like unwanted behavior to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> on 2025-04-09 07:38</div>
            <div class="timeline-body"><blockquote>
<p>(Never is assignable to any type)</p>
</blockquote>
<p>Ah! I missed this. That makes sense then. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[red-knot] calls to functions returning `Never`/`NoReturn` are terminal&quot; to &quot;calls to functions returning `Never`/`NoReturn` are terminal&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-07 15:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/WAKayser">@WAKayser</a> on 2025-05-08 05:12</div>
            <div class="timeline-body"><p>Currently NoReturn cannot be used to narrow a type.  Which is a relatively common pattern in for example Flask examples. Where abort() can be used to return an error code early. This can be used to make sure that the request contains valid data.</p>
<p>For reference here is another example that currently doesnt work.</p>
<pre><code>from typing import NoReturn, reveal_type

def raise_error() -&gt; NoReturn:
    raise Exception(&#x27;test&#x27;)


def test(x: str | None) -&gt; None:
    if x is None:
        raise_error()
    
    reveal_type(x)
    # Should be &quot;str&quot; is &quot;str | None&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">control flow</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-11 07:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Avasam">@Avasam</a> on 2025-05-18 18:34</div>
            <div class="timeline-body"><p>Same issue, different symptoms. I have this simplified example that&#x27;s causing <code>warning[possibly-unbound-attribute]: Attribute </code>ignore<code>on type</code>QCloseEvent | None<code> is possibly unbound</code> since ty doesn&#x27;t see that</p>
<pre><code>from PySide6 import QtGui
from PySide6.QtWidgets import QMainWindow

class MainWindow(QMainWindow):
    def closeEvent(self, event: QtGui.QCloseEvent | None = None):
        &quot;&quot;&quot;Exit safely when closing the window.&quot;&quot;&quot;

        if event is None or False:  # `or False` is actually some other condition, simplified for this example
            sys.exit(1)  # Here ty should see that `event` can&#x27;t be `None` if this branch wasn&#x27;t taken

        # ... some more checks and user prompts happened here

        # Fallthrough case: Prevent program from closing.
        event.ignore()

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ilius">@ilius</a> on 2025-05-23 07:12</div>
            <div class="timeline-body"><p>Also for <code>os.execl</code>, <code>os.execle</code>, <code>os.execlp</code>, <code>os.execlpe</code>, <code>os.execvp</code>, <code>os.execvpe</code>.</p>
<p>Funcs in <code>os.py</code> that mention &quot;replacing the current process&quot; in their doc.</p>
<pre><code>def restartLow() -&gt; typing.NoReturn:
	&quot;&quot;&quot;Will not return from the function.&quot;&quot;&quot;
	os.execl(
		sys.executable,
		sys.executable,
		*sys.argv,
	)
</code></pre>
<pre><code>def execl(file, *args):
    &quot;&quot;&quot;execl(file, *args)

    Execute the executable file with argument list args, replacing the
    current process. &quot;&quot;&quot;
    execv(file, args)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> by <a href="https://github.com/carljm">@carljm</a> on 2025-06-17 16:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Eutropios">@Eutropios</a> on 2025-06-26 04:23</div>
            <div class="timeline-body"><p>This error arises in the context of the argparse module, where <code>argparse.ArgumentParser.error</code> calls <code>sys.exit</code>:</p>
<pre><code>    def exit(self, status=0, message=None):
        if message:
            self._print_message(message, _sys.stderr)
        _sys.exit(status)

    def error(self, message):
        &quot;&quot;&quot;error(message: string)

        Prints a usage message incorporating the message to stderr and
        exits.

        If you override this in a subclass, it should not return -- it
        should either exit or raise an exception.
        &quot;&quot;&quot;
        self.print_usage(_sys.stderr)
        args = {&#x27;prog&#x27;: self.prog, &#x27;message&#x27;: message}
        self.exit(2, _(&#x27;%(prog)s: error: %(message)s\n&#x27;) % args)
</code></pre>
<p>This issue persists when subclassing:</p>
<pre><code>class FooParser(argparse.ArgumentParser):

    def error(self, message: str) -&gt; NoReturn:
        self.exit(1, f&quot;{self.usage}: error: {message}\n&quot;)
</code></pre>
<p>Ty emits:
<code>Function always implicitly returns </code>None<code>, which is not assignable to return type </code>Never<code>ty[invalid-return-type](https://ty.dev/rules#invalid-return-type)</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2025-07-04 18:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> on 2025-07-05 06:33</div>
            <div class="timeline-body"><p>Most of the false positives were fixed in <a href="https://github.com/astral-sh/ruff/pull/18333">astral-sh/ruff#18333</a>, but see also <a href="https://github.com/astral-sh/ty/issues/685">astral-sh/ty#685</a> for an issue pertaining to type narrowing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/WAKayser">@WAKayser</a> on 2025-07-09 07:19</div>
            <div class="timeline-body"><p>This has not been fully closed yet. And is not only in nested if statements like in #685.  My previous test case isnt supported correctly still. <a href="https://github.com/astral-sh/ty/issues/180">astral-sh/ty#180</a>#issuecomment-2861795534</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-09 07:27</div>
            <div class="timeline-body"><blockquote>
<p>My previous test case isnt supported correctly still. <a href="https://github.com/astral-sh/ty/issues/180#issuecomment-2861795534">#180 (comment)</a></p>
</blockquote>
<p>Unfortunately not, no. We do now consider the <code>raise_error()</code> call to be terminal (you can check that by <a href="https://play.ty.dev/079489c9-108e-43b0-9495-c05cb1a9b54b">adding an unknown symbol after the <code>raise_error()</code> call</a>, for which no error will be emitted, since it&#x27;s unreachable), but we do not yet preserve the <code>x is not None</code> narrowing constraint from the (implicit) else branch in that conditional. This is already tracked in <a href="https://github.com/astral-sh/ty/issues/690">astral-sh/ty#690</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Eutropios">@Eutropios</a> on 2025-07-09 20:31</div>
            <div class="timeline-body"><p>My <a href="https://github.com/astral-sh/ty/issues/180#issuecomment-3007000359">issue</a> still persists even after the pull request. Should I open a new issue?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/abhijeetbodas2001">@abhijeetbodas2001</a> on 2025-07-10 05:34</div>
            <div class="timeline-body"><blockquote>
<p>My <a href="https://github.com/astral-sh/ty/issues/180#issuecomment-3007000359">issue</a> still persists even after the pull request. Should I open a new issue?</p>
</blockquote>
<p>When subclassing, in your example, if you explicitly annotate <code>self</code> as <code>FooParser</code>, then the error vanishes, for example: https://play.ty.dev/631e5827-6f8a-4144-9261-428a127486f0.</p>
<p>Without this annotation, the type of <code>self</code> which ty infers is <code>Unknown</code> (which is also thus the inferred type of <code>self.exit</code>), which causes the error you see. Not inferring the type of <code>self</code> correctly seems to be tracked at <a href="https://github.com/astral-sh/ty/issues/159">astral-sh/ty#159</a>, though @sharkdp could confirm.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-10 06:30</div>
            <div class="timeline-body"><blockquote>
<p>though <a href="https://github.com/sharkdp">@sharkdp</a> could confirm.</p>
</blockquote>
<p>Can confirm ðŸ˜ƒ. Thank you for the analysis.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Eutropios">@Eutropios</a> on 2025-07-11 18:37</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>My <a href="https://github.com/astral-sh/ty/issues/180#issuecomment-3007000359">issue</a> still persists even after the pull request. Should I open a new issue?</p>
</blockquote>
<p>When subclassing, in your example, if you explicitly annotate <code>self</code> as <code>FooParser</code>, then the error vanishes, for example: https://play.ty.dev/631e5827-6f8a-4144-9261-428a127486f0.</p>
<p>Without this annotation, the type of <code>self</code> which ty infers is <code>Unknown</code> (which is also thus the inferred type of <code>self.exit</code>), which causes the error you see. Not inferring the type of <code>self</code> correctly seems to be tracked at <a href="https://github.com/astral-sh/ty/issues/159">#159</a>, though <a href="https://github.com/sharkdp">@sharkdp</a> could confirm.</p>
</blockquote>
<p>I see, thank you for the explanation ðŸ˜„</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:24:14 UTC
    </footer>
</body>
</html>
