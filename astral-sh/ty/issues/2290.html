<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go to definition cannot solve relative import in third-party files when using a virtual env location other than `.venv` - astral-sh/ty #2290</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Go to definition cannot solve relative import in third-party files when using a virtual env location other than <code>.venv</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/2290">#2290</a>
        opened by <a href="https://github.com/winlaic">@winlaic</a>
        on 2025-12-31 02:31
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/winlaic">@winlaic</a></div>
            <div class="timeline-body"><p>When I ctrl click into the source of some installed packages, it turns out that if there are relative import in the source code, <code>ty</code> could not infer where the definition of the symbol. Here is a example of the <code>transformers</code> library:</p>
<p><img width="783" height="574" alt="Image" src="https://github.com/user-attachments/assets/ff9d7704-f237-4621-8e05-385631e30429" /></p>
<p>You can see code <code>from .cache_utils import Cache, EncoderDecoderCache</code>, the <code>Cache</code> and <code>EncoderDecoderCache</code> are infered as <code>Unknown</code> and I can't ctrl click it. But I am sure the definition exists in <code>transformers.cache_utils</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/winlaic">@winlaic</a> on 2025-12-31 02:46</div>
            <div class="timeline-body"><p>BTW, I am using this version of ty vscode extension:</p>
<p><img width="384" height="165" alt="Image" src="https://github.com/user-attachments/assets/183ef0a6-49cb-4a4b-90eb-dcf860c31b26" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2025-12-31 08:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">imports</span> added by @MichaReiser on 2025-12-31 08:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-31 08:36</div>
            <div class="timeline-body"><p>Hmm, I'm unable to reproduce this. What I tried is:</p>
<ul>
<li>Install <code>torch</code> with uv, using Python 3.10 (<code>uv add torch --python 3.10</code>)</li>
<li>Select that environment in VS Code</li>
<li>Click on <code>modeling_outputs</code> in <code>from transformers.modeling_outputs import TokenClassifierOutput</code></li>
<li>Click on <code>Cache</code>.</li>
</ul>
<p>Can you say more about how you installed the <code>torch</code> dependency and on what platform you're on?</p>
<p>Can you also tell me what ty version you're using (Click on <code>{}</code> next to <code>Python</code> in the bottom toolbar)</p>
<p><img width="2192" height="656" alt="Image" src="https://github.com/user-attachments/assets/c08824b4-ea58-41b9-9a40-ff84ff55384b" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> added by @MichaReiser on 2025-12-31 08:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/winlaic">@winlaic</a> on 2026-01-05 02:22</div>
            <div class="timeline-body"><p>Sorry for the late reply...</p>
<p>I am using VS Code <code>1.102.1</code> (universial) on macOS and it remote connect to a Ubuntu 20.04.6 LTS server.</p>
<p>The <code>ty</code> version is <code>0.0.8</code></p>
<p><img width="379" height="121" alt="Image" src="https://github.com/user-attachments/assets/c06f8195-be09-46f4-a97f-93e2a1d7fe4c" /></p>
<p>and I used <code>uv pip</code> to install the <code>torch</code> and <code>transformers</code> library, not using <code>uv add</code>
I used <code>uv venv --relocatable --python 3.10</code> to create the environment, at <code>/dev/shm/$USER/venv/ZipVoice</code>.</p>
<p>as of now, I still can't ctrl click it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-08 09:12</div>
            <div class="timeline-body"><p>Thanks. I suspect this is related to using <code>--relocatable</code> but I was also able to reproduce it by installing the dependencies using <code>pip</code> instead of <code>uv</code>. What's interesting is that renaming the virtual env from <code>venv</code> to <code>.venv</code> fixes the issue! I'm not sure why this is happening</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-08 09:29</div>
            <div class="timeline-body"><p>What's interesting is that changing the import to an absolute import makes the imports work:</p>
<pre><code>from transformers.cache_utils import Cache, EncoderDecoderCache
from .cache_utils import Cache, EncoderDecoderCache
from .utils import ModelOutput
</code></pre>
<p>The first line works, the second does not. So something's off with resolving relative imports</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Go to definition can not solve relative import in source code." to "Go to definition cannot solve relative import in source code." by @AlexWaygood on 2026-01-08 09:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-08 09:56</div>
            <div class="timeline-body"><p>Okay, I think there are two issues:</p>
<ul>
<li><code>file_to_module</code> matches on any search path instead of using the best matching search path</li>
<li><code>SearchPathIter</code> doesn't include site packages???</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-08 10:39</div>
            <div class="timeline-body"><p>Okay, I figured out what the root cause is here.</p>
<p>The issue is that we open the torch file using the <a href="https://github.com/astral-sh/ruff/blob/e60586f3b960aa952cd9c135c632abe570051805/crates/ty_server/src/session.rs#L1262-L1277">default database</a>, which fails to automatically discover the <code>venv</code>, so site packages are not included in the search paths in <code>file_to_module</code>.</p>
<p>I'm not exactly sure what the solution here is but I'm leaning towards removing the default database concept and just using the first project instead (or using a single database for all projects, see the mono repository discussion)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> removed by @MichaReiser on 2026-01-08 10:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Go to definition cannot solve relative import in source code." to "Go to definition cannot solve relative import in third-party files when using a virtual env location other than `.venv`" by @MichaReiser on 2026-01-08 10:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2026-01-08 10:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Pre-stable 1" by @MichaReiser on 2026-01-08 10:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-08 11:17</div>
            <div class="timeline-body"><p>With https://github.com/astral-sh/ruff/pull/22455, I'm not sure what the use case for the default database is and I think we can simply always use the default database. The way I remember it is that the main reason for adding it in the first place was that we don't want to show diagnostics for non-project files, but that's handled if we respect excludes. @dhruvmanila / @Gankra do you see cases where we would still need the default database?</p>
<p>I think the main downside of making this change is that we incorrectly assume the same virtual env for files from outside the project. This doesn't seem terrible to me, and we already accidentally picked up the project's <code>.venv</code> today.</p>
<p>Edit: I can confirm that removing all the default database stuff fixes this issue</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2026-01-08 17:27</div>
            <div class="timeline-body"><p>Yeah I think the main Correct Benefit of the default database is &quot;you opened a random python file from outside your worktree in your IDE session and it is nonsense for us to assume the worktree's venv is in scope&quot; but also in that case yeah i don't think assuming the worktree's venv is particularly harmful...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @MichaReiser by @Gankra on 2026-01-09 04:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2026-01-09 08:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/winlaic">@winlaic</a> on 2026-01-10 10:12</div>
            <div class="timeline-body"><p>Thanks guys! Looking forward to updating to the new version!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:21:38 UTC
    </footer>
</body>
</html>
