<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intersection with `@final` generic class is incorrectly simplified to Never - astral-sh/ty #512</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Intersection with `@final` generic class is incorrectly simplified to Never</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/512">#512</a>
        opened by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a>
        on 2025-05-26 01:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> on 2025-05-26 01:12</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>This intersection is incorrectly simplified to Never.</p>
<pre><code class="language-python">from typing import TypeVar, Generic, final, reveal_type
from ty_extensions import Intersection

T_co = TypeVar(&quot;T_co&quot;, covariant=True)

class Base(Generic[T_co]):
    def f(self) -&gt; T_co:
        raise NotImplementedError

@final
class Child(Base[T_co]):
    pass

def f(x: Intersection[Base[int], Child[object]]):
    reveal_type(x)  # Never, expect Child[int]
</code></pre>
<p>https://play.ty.dev/06b37356-775c-4128-ab4a-7a65e159bc87</p>
<h3>Version</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-05-26 06:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">generics</span> added by @AlexWaygood on 2025-05-26 06:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">set-theoretic types</span> added by @AlexWaygood on 2025-05-26 06:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-26 06:28</div>
            <div class="timeline-body"><p>I think this is possibly related to #492</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-05-30 00:07</div>
            <div class="timeline-body"><p>I don't think it's #492 exactly -- there's no attempt here to have different specializations of a single class in the same MRO. Rather the problem is that in <code>is_disjoint_from</code> we don't account for the possibility that a final generic type can overlap with a base class that it isn't a subtype of (due to variance). <code>Child[object]</code> is not a subtype of <code>Base[int]</code> (wrong variance), but <code>Child[int]</code> is a subtype of both, so they should not be considered disjoint (and we should simplify the intersection to the common subtype, which is kind of a separate but related issue).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-30 22:20</div>
            <div class="timeline-body"><p>It's related to #492 in that the cause of #492 is that our MRO now consists of a sequence of generic aliases rather than a sequence of class literals following our implementation of generics, but some parts of our code (such as the check for duplicate bases) have not yet been adjusted to account for that change. Similarly here, our implementation of disjointness for <code>@final</code> instance types calls <code>Class::is_subclass_of()</code>, and <code>Base[int].is_subclass_of(Child[object])</code> does not return <code>true</code> in our current model. This is because <code>Child[object]</code> does not appear in the MRO of <code>Base[int]</code>.</p>
<p>https://github.com/astral-sh/ruff/blob/aa1fad61e0f9fe0c7faac876f2ef55cd3817fc6c/crates/ty_python_semantic/src/types/instance.rs#L94-L101</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Beta" by @carljm on 2025-07-23 23:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Beta" by @carljm on 2025-08-15 15:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "GA" by @carljm on 2025-08-15 15:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> on 2025-09-05 00:26</div>
            <div class="timeline-body"><p>Another example that @carljm tells me probably has the same root cause:</p>
<pre><code class="language-python">from ty_extensions import Top, Intersection
from typing import Any

class Base[T]:
    def get(self) -&gt; T: raise NotImplementedError
    def push(self, obj: T) -&gt; None: ...

class Child[T](Base[T]):
    pass

def _(x: Intersection[Base[Any], Child[Any]]):
    reveal_type(x.get)  # ty: Never; expect something like `() -&gt; Any`
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Intersection with @final generic class is incorrectly simplified to Never" to "Intersection with `@final` generic class is incorrectly simplified to Never" by @AlexWaygood on 2025-10-06 16:56</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 02:11:06 UTC
    </footer>
</body>
</html>
