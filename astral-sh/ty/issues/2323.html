<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generic protocol methods cannot soundly be implemented by a non-generic method - astral-sh/ty #2323</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Generic protocol methods cannot soundly be implemented by a non-generic method</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/2323">#2323</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2026-01-04 21:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/carljm">@carljm</a> on 2026-01-04 21:36</div>
            <div class="timeline-body"><blockquote>
<p>I've come across an interesting case: how is <code>Self</code> handled when used in a protocol? Based on the logic, the code below should trigger a type error, but surprisingly, neither <code>mypy</code> nor <code>pyright</code> or <code>ty</code> flag it. Whatâ€™s the reasoning behind this?</p>
<pre><code class="language-python">from __future__ import annotations

from typing import Protocol, Self


class Semigroup(Protocol):
    def op(
        self: Self,
        other: Self,
    ) -&gt; Self: ...


class IntSum:
    def __init__(self, value: int):
        self.value = value

    def op(self, other: IntSum) -&gt; IntSum:
        return IntSum(
            self.value + other.value,
        )


class StringConcat:
    def __init__(self, value: str):
        self.value = value

    def op(self, other: StringConcat) -&gt; StringConcat:
        return StringConcat(
            self.value + other.value,
        )


def combine_semi[T: Semigroup](
    a: T,
    b: T,
) -&gt; T:
    return a.op(b)


x = combine_semi(
    IntSum(1),
    StringConcat(&quot;hello&quot;),
)
</code></pre>
</blockquote>
<p><em>Originally posted by @kamalfarahani in <a href="https://github.com/astral-sh/ty/issues/2255#issuecomment-3703527962">#2255</a></em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2026-01-04 21:38</div>
            <div class="timeline-body"><p>All other type-checkers (unsoundly) allow this, and so does ty. But it's clearly unsound -- <code>IntSum</code> and <code>StringConcat</code> should not be considered to implement the <code>Semigroup</code> protocol.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2026-01-04 22:09</div>
            <div class="timeline-body"><p>This is not really specific to <code>Self</code> (as should be evident, since <code>Self</code> is syntactic sugar for a type variable), it affects generic protocols more broadly:</p>
<pre><code class="language-py">from __future__ import annotations

from typing import Protocol, Self


class Semigroup[T](Protocol):
    def op(
        self: T,
        other: T,
    ) -&gt; T: ...


class IntSum:
    def __init__(self, value: int):
        self.value = value

    def op(self, other: IntSum) -&gt; IntSum:
        return IntSum(
            self.value + other.value,
        )


class StringConcat:
    def __init__(self, value: str):
        self.value = value

    def op(self, other: StringConcat) -&gt; StringConcat:
        return StringConcat(
            self.value + other.value,
        )


def combine_semi[T: Semigroup](
    a: T,
    b: T,
) -&gt; T:
    return a.op(b)


x = combine_semi(
    IntSum(1),
    StringConcat(&quot;hello&quot;),
)
</code></pre>
<p>Even if <code>self</code> parameter isn't involved, it's still unsound:</p>
<pre><code class="language-py">from __future__ import annotations

from typing import Protocol, Self


class Semigroup[T](Protocol):
    def op(
        self,
        a: T,
        b: T,
    ) -&gt; T: ...


class IntSum:
    def __init__(self, value: int):
        self.value = value

    def op(self, a: IntSum, b: IntSum) -&gt; IntSum:
        return IntSum(
            a.value + b.value,
        )


class StringConcat:
    def __init__(self, value: str):
        self.value = value

    def op(self, a: StringConcat, b: StringConcat) -&gt; StringConcat:
        return StringConcat(
            a.value + b.value,
        )


def combine_semi[T: Semigroup](
    a: T,
    b: T,
) -&gt; T:
    return a.op(a, b)


x = combine_semi(
    IntSum(1),
    StringConcat(&quot;hello&quot;),
)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Only methods using `Self` should satisfy a protocol method using `Self`" to "Generic protocol methods cannot soundly be implemented by a non-generic method" by @carljm on 2026-01-04 22:11</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:51:35 UTC
    </footer>
</body>
</html>
