<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Different type error output in fastapi - astral-sh/ty #285</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Different type error output in fastapi</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/285">#285</a>
        opened by <a href="https://github.com/alphavector">@alphavector</a>
        on 2025-05-08 23:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/alphavector">@alphavector</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<pre><code>&gt; git clone git@github.com:fastapi/fastapi.git
&gt; cd fastapi
&gt; git rev-parse --short HEAD
9a33ba46
</code></pre>
<p>mypy</p>
<pre><code>&gt; uvx --with-requirements requirements-tests.txt --with 'pydantic&gt;=2.0.2,&lt;3.0.0' mypy fastapi
Success: no issues found in 44 source files
</code></pre>
<p>ty</p>
<pre><code>&gt; uvx --with-requirements requirements-tests.txt --with 'pydantic&gt;=2.0.2,&lt;3.0.0' ty check --ignore 'unresolved-import' --ignore 'unused-ignore-comment' --color=never fastapi
</code></pre>
<details>
  <summary>output</summary>

<pre><code class="language-shell">warning: lint:possibly-unresolved-reference: Name `TypeAdapter` used when possibly not defined
   --&gt; fastapi/_compat.py:111:33
    |
110 |         def __post_init__(self) -&gt; None:
111 |             self._type_adapter: TypeAdapter[Any] = TypeAdapter(
    |                                 ^^^^^^^^^^^
112 |                 Annotated[self.field_info.annotation, self.field_info]
113 |             )
    |
info: `lint:possibly-unresolved-reference` is enabled by default

warning: lint:possibly-unresolved-reference: Name `TypeAdapter` used when possibly not defined
   --&gt; fastapi/_compat.py:111:52
    |
110 |         def __post_init__(self) -&gt; None:
111 |             self._type_adapter: TypeAdapter[Any] = TypeAdapter(
    |                                                    ^^^^^^^^^^^
112 |                 Annotated[self.field_info.annotation, self.field_info]
113 |             )
    |
info: `lint:possibly-unresolved-reference` is enabled by default

warning: lint:possibly-unresolved-reference: Name `model_process_schema` used when possibly not defined
   --&gt; fastapi/_compat.py:386:56
    |
384 |         definitions: Dict[str, Dict[str, Any]] = {}
385 |         for model in flat_models:
386 |             m_schema, m_definitions, m_nested_models = model_process_schema(
    |                                                        ^^^^^^^^^^^^^^^^^^^^
387 |                 model, model_name_map=model_name_map, ref_prefix=REF_PREFIX
388 |             )
    |
info: `lint:possibly-unresolved-reference` is enabled by default

warning: lint:possibly-unresolved-reference: Name `model_process_schema` used when possibly not defined
   --&gt; fastapi/_compat.py:386:56
    |
384 |         definitions: Dict[str, Dict[str, Any]] = {}
385 |         for model in flat_models:
386 |             m_schema, m_definitions, m_nested_models = model_process_schema(
    |                                                        ^^^^^^^^^^^^^^^^^^^^
387 |                 model, model_name_map=model_name_map, ref_prefix=REF_PREFIX
388 |             )
    |
info: `lint:possibly-unresolved-reference` is enabled by default

warning: lint:possibly-unresolved-reference: Name `model_process_schema` used when possibly not defined
   --&gt; fastapi/_compat.py:386:56
    |
384 |         definitions: Dict[str, Dict[str, Any]] = {}
385 |         for model in flat_models:
386 |             m_schema, m_definitions, m_nested_models = model_process_schema(
    |                                                        ^^^^^^^^^^^^^^^^^^^^
387 |                 model, model_name_map=model_name_map, ref_prefix=REF_PREFIX
388 |             )
    |
info: `lint:possibly-unresolved-reference` is enabled by default

warning: lint:possibly-unresolved-reference: Name `model_process_schema` used when possibly not defined
   --&gt; fastapi/_compat.py:386:56
    |
384 |         definitions: Dict[str, Dict[str, Any]] = {}
385 |         for model in flat_models:
386 |             m_schema, m_definitions, m_nested_models = model_process_schema(
    |                                                        ^^^^^^^^^^^^^^^^^^^^
387 |                 model, model_name_map=model_name_map, ref_prefix=REF_PREFIX
388 |             )
    |
info: `lint:possibly-unresolved-reference` is enabled by default

warning: lint:possibly-unresolved-reference: Name `REF_PREFIX` used when possibly not defined
   --&gt; fastapi/_compat.py:387:66
    |
385 |         for model in flat_models:
386 |             m_schema, m_definitions, m_nested_models = model_process_schema(
387 |                 model, model_name_map=model_name_map, ref_prefix=REF_PREFIX
    |                                                                  ^^^^^^^^^^
388 |             )
389 |             definitions.update(m_definitions)
    |
info: `lint:possibly-unresolved-reference` is enabled by default

warning: lint:possibly-unresolved-reference: Name `REF_PREFIX` used when possibly not defined
   --&gt; fastapi/_compat.py:387:66
    |
385 |         for model in flat_models:
386 |             m_schema, m_definitions, m_nested_models = model_process_schema(
387 |                 model, model_name_map=model_name_map, ref_prefix=REF_PREFIX
    |                                                                  ^^^^^^^^^^
388 |             )
389 |             definitions.update(m_definitions)
    |
info: `lint:possibly-unresolved-reference` is enabled by default

warning: lint:possibly-unresolved-reference: Name `REF_PREFIX` used when possibly not defined
   --&gt; fastapi/_compat.py:387:66
    |
385 |         for model in flat_models:
386 |             m_schema, m_definitions, m_nested_models = model_process_schema(
387 |                 model, model_name_map=model_name_map, ref_prefix=REF_PREFIX
    |                                                                  ^^^^^^^^^^
388 |             )
389 |             definitions.update(m_definitions)
    |
info: `lint:possibly-unresolved-reference` is enabled by default

warning: lint:possibly-unresolved-reference: Name `REF_PREFIX` used when possibly not defined
   --&gt; fastapi/_compat.py:387:66
    |
385 |         for model in flat_models:
386 |             m_schema, m_definitions, m_nested_models = model_process_schema(
387 |                 model, model_name_map=model_name_map, ref_prefix=REF_PREFIX
    |                                                                  ^^^^^^^^^^
388 |             )
389 |             definitions.update(m_definitions)
    |
info: `lint:possibly-unresolved-reference` is enabled by default

warning: lint:possibly-unresolved-reference: Name `is_pv1_scalar_field` used when possibly not defined
   --&gt; fastapi/_compat.py:411:17
    |
409 |         if field.sub_fields:  # type: ignore[attr-defined]
410 |             if not all(
411 |                 is_pv1_scalar_field(f)
    |                 ^^^^^^^^^^^^^^^^^^^
412 |                 for f in field.sub_fields  # type: ignore[attr-defined]
413 |             ):
    |
info: `lint:possibly-unresolved-reference` is enabled by default

warning: lint:possibly-unresolved-reference: Name `is_pv1_scalar_field` used when possibly not defined
   --&gt; fastapi/_compat.py:423:28
    |
421 |             if field.sub_fields is not None:  # type: ignore[attr-defined]
422 |                 for sub_field in field.sub_fields:  # type: ignore[attr-defined]
423 |                     if not is_pv1_scalar_field(sub_field):
    |                            ^^^^^^^^^^^^^^^^^^^
424 |                         return False
425 |             return True
    |
info: `lint:possibly-unresolved-reference` is enabled by default

warning: lint:possibly-unresolved-reference: Name `REF_PREFIX` used when possibly not defined
   --&gt; fastapi/_compat.py:467:62
    |
465 |         # This expects that GenerateJsonSchema was already used to generate the definitions
466 |         return field_schema(  # type: ignore[no-any-return]
467 |             field, model_name_map=model_name_map, ref_prefix=REF_PREFIX
    |                                                              ^^^^^^^^^^
468 |         )[0]
    |
info: `lint:possibly-unresolved-reference` is enabled by default

warning: lint:possibly-unresolved-reference: Name `get_flat_models_from_fields` used when possibly not defined
   --&gt; fastapi/_compat.py:471:18
    |
470 |     def get_compat_model_name_map(fields: List[ModelField]) -&gt; ModelNameMap:
471 |         models = get_flat_models_from_fields(fields, known_models=set())
    |                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^
472 |         return get_model_name_map(models)  # type: ignore[no-any-return]
    |
info: `lint:possibly-unresolved-reference` is enabled by default

warning: lint:possibly-unresolved-reference: Name `get_flat_models_from_fields` used when possibly not defined
   --&gt; fastapi/_compat.py:486:18
    |
484 |         Dict[str, Dict[str, Any]],
485 |     ]:
486 |         models = get_flat_models_from_fields(fields, known_models=set())
    |                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^
487 |         return {}, get_model_definitions(
488 |             flat_models=models, model_name_map=model_name_map
    |
info: `lint:possibly-unresolved-reference` is enabled by default

warning: lint:possibly-unresolved-reference: Name `get_model_definitions` used when possibly not defined
   --&gt; fastapi/_compat.py:487:20
    |
485 |     ]:
486 |         models = get_flat_models_from_fields(fields, known_models=set())
487 |         return {}, get_model_definitions(
    |                    ^^^^^^^^^^^^^^^^^^^^^
488 |             flat_models=models, model_name_map=model_name_map
489 |         )
    |
info: `lint:possibly-unresolved-reference` is enabled by default

warning: lint:possibly-unresolved-reference: Name `is_pv1_scalar_field` used when possibly not defined
   --&gt; fastapi/_compat.py:492:16
    |
491 |     def is_scalar_field(field: ModelField) -&gt; bool:
492 |         return is_pv1_scalar_field(field)
    |                ^^^^^^^^^^^^^^^^^^^
493 |
494 |     def is_sequence_field(field: ModelField) -&gt; bool:
    |
info: `lint:possibly-unresolved-reference` is enabled by default

warning: lint:possibly-unresolved-reference: Name `is_pv1_scalar_sequence_field` used when possibly not defined
   --&gt; fastapi/_compat.py:498:16
    |
497 |     def is_scalar_sequence_field(field: ModelField) -&gt; bool:
498 |         return is_pv1_scalar_sequence_field(field)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
499 |
500 |     def is_bytes_field(field: ModelField) -&gt; bool:
    |
info: `lint:possibly-unresolved-reference` is enabled by default

warning: lint:possibly-unresolved-reference: Name `server_urls` used when possibly not defined
    --&gt; fastapi/applications.py:1005:37
     |
1003 |             async def openapi(req: Request) -&gt; JSONResponse:
1004 |                 root_path = req.scope.get(&quot;root_path&quot;, &quot;&quot;).rstrip(&quot;/&quot;)
1005 |                 if root_path not in server_urls:
     |                                     ^^^^^^^^^^^
1006 |                     if root_path and self.root_path_in_servers:
1007 |                         self.servers.insert(0, {&quot;url&quot;: root_path})
     |
info: `lint:possibly-unresolved-reference` is enabled by default

warning: lint:possibly-unresolved-reference: Name `server_urls` used when possibly not defined
    --&gt; fastapi/applications.py:1008:25
     |
1006 |                     if root_path and self.root_path_in_servers:
1007 |                         self.servers.insert(0, {&quot;url&quot;: root_path})
1008 |                         server_urls.add(root_path)
     |                         ^^^^^^^^^^^
1009 |                 return JSONResponse(self.openapi())
     |
info: `lint:possibly-unresolved-reference` is enabled by default

error: lint:invalid-type-form: The first argument to `Callable` must be either a list of types, ParamSpec, Concatenate, or `...`
  --&gt; fastapi/background.py:41:22
   |
39 |         self,
40 |         func: Annotated[
41 |             Callable[P, Any],
   |                      ^
42 |             Doc(
43 |                 &quot;&quot;&quot;
   |
info: `lint:invalid-type-form` is enabled by default

error: lint:invalid-argument-type: Argument to this function is incorrect
   --&gt; fastapi/dependencies/utils.py:128:9
    |
126 |     return get_sub_dependant(
127 |         depends=depends,
128 |         dependency=depends.dependency,
    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ Expected `(...) -&gt; Any`, found `Unknown | ((...) -&gt; Any) | None`
129 |         path=path,
130 |         name=param_name,
    |
info: Function defined here
   --&gt; fastapi/dependencies/utils.py:142:5
    |
142 | def get_sub_dependant(
    |     ^^^^^^^^^^^^^^^^^
143 |     *,
144 |     depends: params.Depends,
145 |     dependency: Callable[..., Any],
    |     ------------------------------ Parameter declared here
146 |     path: str,
147 |     name: Optional[str] = None,
    |
info: `lint:invalid-argument-type` is enabled by default

error: lint:invalid-argument-type: Argument to this function is incorrect
   --&gt; fastapi/dependencies/utils.py:139:47
    |
137 |         &quot;A parameter-less dependency must have a callable dependency&quot;
138 |     )
139 |     return get_sub_dependant(depends=depends, dependency=depends.dependency, path=path)
    |                                               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ Expected `(...) -&gt; Any`, found `Unknown | ((...) -&gt; Any) | None`
    |
info: Function defined here
   --&gt; fastapi/dependencies/utils.py:142:5
    |
142 | def get_sub_dependant(
    |     ^^^^^^^^^^^^^^^^^
143 |     *,
144 |     depends: params.Depends,
145 |     dependency: Callable[..., Any],
    |     ------------------------------ Parameter declared here
146 |     path: str,
147 |     name: Optional[str] = None,
    |
info: `lint:invalid-argument-type` is enabled by default

error: lint:invalid-argument-type: Argument to this function is incorrect
   --&gt; fastapi/dependencies/utils.py:294:17
    |
292 |             sub_dependant = get_param_sub_dependant(
293 |                 param_name=param_name,
294 |                 depends=param_details.depends,
    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ Expected `Depends`, found `Depends | None`
295 |                 path=path,
296 |                 security_scopes=security_scopes,
    |
info: Function defined here
   --&gt; fastapi/dependencies/utils.py:118:5
    |
118 | def get_param_sub_dependant(
    |     ^^^^^^^^^^^^^^^^^^^^^^^
119 |     *,
120 |     param_name: str,
121 |     depends: params.Depends,
    |     ----------------------- Parameter declared here
122 |     path: str,
123 |     security_scopes: Optional[List[str]] = None,
    |
info: `lint:invalid-argument-type` is enabled by default

warning: lint:possibly-unbound-attribute: Attribute `field_info` on type `ModelField | Unknown | None` is possibly unbound
   --&gt; fastapi/dependencies/utils.py:310:23
    |
308 |             continue
309 |         assert param_details.field is not None
310 |         if isinstance(param_details.field.field_info, params.Body):
    |                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
311 |             dependant.body_params.append(param_details.field)
312 |         else:
    |
info: `lint:possibly-unbound-attribute` is enabled by default

warning: lint:possibly-unresolved-reference: Name `cm` used when possibly not defined
   --&gt; fastapi/dependencies/utils.py:560:44
    |
558 |     elif is_async_gen_callable(call):
559 |         cm = asynccontextmanager(call)(**sub_values)
560 |     return await stack.enter_async_context(cm)
    |                                            ^^
    |
info: `lint:possibly-unresolved-reference` is enabled by default

error: lint:unresolved-attribute: Type `Mapping[str, Any]` has no attribute `getlist`
   --&gt; fastapi/dependencies/utils.py:721:17
    |
719 |     alias = alias or field.alias
720 |     if is_sequence_field(field) and isinstance(values, (ImmutableMultiDict, Headers)):
721 |         value = values.getlist(alias)
    |                 ^^^^^^^^^^^^^^
722 |     else:
723 |         value = values.get(alias, None)
    |
info: `lint:unresolved-attribute` is enabled by default

warning: lint:possibly-unresolved-reference: Name `results` used when possibly not defined
   --&gt; fastapi/dependencies/utils.py:870:17
    |
868 |             ) -&gt; None:
869 |                 result = await fn()
870 |                 results.append(result)  # noqa: B023
    |                 ^^^^^^^
871 |
872 |             async with anyio.create_task_group() as tg:
    |
info: `lint:possibly-unresolved-reference` is enabled by default

warning: lint:possibly-unresolved-reference: Name `status_code` used when possibly not defined
   --&gt; fastapi/openapi/utils.py:351:62
    |
349 |                     if isinstance(status_code_param.default, int):
350 |                         status_code = str(status_code_param.default)
351 |             operation.setdefault(&quot;responses&quot;, {}).setdefault(status_code, {})[
    |                                                              ^^^^^^^^^^^
352 |                 &quot;description&quot;
353 |             ] = route.response_description
    |
info: `lint:possibly-unresolved-reference` is enabled by default

warning: lint:possibly-unresolved-reference: Name `status_code` used when possibly not defined
   --&gt; fastapi/openapi/utils.py:370:21
    |
368 |                         response_schema = {}
369 |                 operation.setdefault(&quot;responses&quot;, {}).setdefault(
370 |                     status_code, {}
    |                     ^^^^^^^^^^^
371 |                 ).setdefault(&quot;content&quot;, {}).setdefault(route_response_media_type, {})[
372 |                     &quot;schema&quot;
    |
info: `lint:possibly-unresolved-reference` is enabled by default

error: lint:no-matching-overload: No overload of bound method `__init__` matches arguments
   --&gt; fastapi/params.py:84:18
    |
 82 |           self.include_in_schema = include_in_schema
 83 |           self.openapi_examples = openapi_examples
 84 |           kwargs = dict(
    |  __________________^
 85 | |             default=default,
 86 | |             default_factory=default_factory,
 87 | |             alias=alias,
 88 | |             title=title,
 89 | |             description=description,
 90 | |             gt=gt,
 91 | |             ge=ge,
 92 | |             lt=lt,
 93 | |             le=le,
 94 | |             min_length=min_length,
 95 | |             max_length=max_length,
 96 | |             discriminator=discriminator,
 97 | |             multiple_of=multiple_of,
 98 | |             allow_inf_nan=allow_inf_nan,
 99 | |             max_digits=max_digits,
100 | |             decimal_places=decimal_places,
101 | |             **extra,
102 | |         )
    | |_________^
103 |           if examples is not None:
104 |               kwargs[&quot;examples&quot;] = examples
    |
info: `lint:no-matching-overload` is enabled by default

error: lint:no-matching-overload: No overload of bound method `__init__` matches arguments
   --&gt; fastapi/params.py:540:18
    |
538 |           self.include_in_schema = include_in_schema
539 |           self.openapi_examples = openapi_examples
540 |           kwargs = dict(
    |  __________________^
541 | |             default=default,
542 | |             default_factory=default_factory,
543 | |             alias=alias,
544 | |             title=title,
545 | |             description=description,
546 | |             gt=gt,
547 | |             ge=ge,
548 | |             lt=lt,
549 | |             le=le,
550 | |             min_length=min_length,
551 | |             max_length=max_length,
552 | |             discriminator=discriminator,
553 | |             multiple_of=multiple_of,
554 | |             allow_inf_nan=allow_inf_nan,
555 | |             max_digits=max_digits,
556 | |             decimal_places=decimal_places,
557 | |             **extra,
558 | |         )
    | |_________^
559 |           if examples is not None:
560 |               kwargs[&quot;examples&quot;] = examples
    |
info: `lint:no-matching-overload` is enabled by default

error: lint:call-non-callable: Object of type `None` is not callable
   --&gt; fastapi/routing.py:212:22
    |
211 |     if is_coroutine:
212 |         return await dependant.call(**values)
    |                      ^^^^^^^^^^^^^^^^^^^^^^^^
213 |     else:
214 |         return await run_in_threadpool(dependant.call, **values)
    |
info: `lint:call-non-callable` is enabled by default

error: lint:call-non-callable: Object of type `None` is not callable
   --&gt; fastapi/routing.py:383:19
    |
381 |                 )
382 |             assert dependant.call is not None, &quot;dependant.call must be a function&quot;
383 |             await dependant.call(**solved_result.values)
    |                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
384 |
385 |     return app
    |
info: `lint:call-non-callable` is enabled by default

error: lint:unresolved-attribute: Type `&lt;module 'fastapi'&gt;` has no attribute `exceptions`
   --&gt; fastapi/utils.py:98:15
    |
 96 |         return ModelField(**kwargs)  # type: ignore[arg-type]
 97 |     except (RuntimeError, PydanticSchemaGenerationError):
 98 |         raise fastapi.exceptions.FastAPIError(
    |               ^^^^^^^^^^^^^^^^^^
 99 |             &quot;Invalid args for response field! Hint: &quot;
100 |             f&quot;check that {type_} is a valid Pydantic field type. &quot;
    |
info: `lint:unresolved-attribute` is enabled by default

Found 35 diagnostics

</code></pre>
</details>

<h3>Version</h3>
<p>ty 0.0.0-alpha.7 (905a3e1e5 2025-05-07)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-05-08 23:21</div>
            <div class="timeline-body"><p>Thanks for the report!</p>
<p>We don't consider differing results from mypy to be a bug in and of itself. Many of these specific diagnostics do look like false positives, which we would consider a bug (and some of them will already be gone in the next ty release); I haven't checked all of them.</p>
<p>We do look at false positives broadly across the ecosystem and prioritize the ones we see most frequently. I suspect many of these false positives are already represented there (and many we already have open issues for). If you'd like <code>fastapi</code> to also be considered in that analysis, the best thing would be to submit a PR to include it in https://github.com/hauntsaninja/mypy_primer/</p>
<p>I'm going to close this issue, not because we don't want to fix the false positives here, but just because a blanket issue for &quot;everything affecting fastapi&quot; duplicates other existing issues and is too broad to be useful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-05-08 23:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:19:48 UTC
    </footer>
</body>
</html>
