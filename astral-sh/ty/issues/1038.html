<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ty failed at infer flask_login type LocalProxy - astral-sh/ty #1038</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ty failed at infer flask_login type LocalProxy</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1038">#1038</a>
        opened by <a href="https://github.com/asukaminato0721">@asukaminato0721</a>
        on 2025-08-18 09:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/asukaminato0721">@asukaminato0721</a></div>
            <div class="timeline-body">Summary
<p>https://github.com/langgenius/dify/blob/ae7de7d36be8f9d3620b18f5ab200c3ca956e2dd/api/controllers/console/app/app.py#L118</p>
<pre><code>error[invalid-argument-type]: Argument to bound method `create_app` is incorrect
   --&gt; controllers/console/app/app.py:118:76
    |
117 |         app_service = AppService()
118 |         app = app_service.create_app(current_user.current_tenant_id, args, current_user)
    |                                                                            ^^^^^^^^^^^^ Expected `Account`, found `Unknown | LocalProxy[Unknown]`
119 |
120 |         return app, 201
    |
info: Function defined here
  --&gt; services/app_service.py:73:9
   |
71 |         return app_models
72 |
73 |     def create_app(self, tenant_id: str, args: dict, account: Account) -&gt; App:
   |         ^^^^^^^^^^                                   ---------------- Parameter declared here
74 |         &quot;&quot;&quot;
75 |         Create app
   |
info: rule `invalid-argument-type` is enabled by default
</code></pre>
Version
<p>ty 0.0.1a18</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-08-19 00:22</div>
            <div class="timeline-body"><p>Thanks for the report!</p>
<p>It appears to me that <code>LocalProxy</code> is the correct type inference for <code>flask_login.current_user</code>: https://github.com/maxcountryman/flask-login/blob/main/src/flask_login/utils.py#L25</p>
<p><code>LocalProxy</code> seems like a class that is carefully designed to faithfully proxy another type at runtime, but I don&#x27;t see any way for a type checker to reasonably understand that an instance of <code>LocalProxy</code> should be accepted where an instance of <code>Account</code> is expected.</p>
<p>Does this work under another type checker? In my testing, pyright issues the same error we do. Mypy does not, but it just considers <code>current_user</code> to be of type <code>Any</code> -- I&#x27;m not sure why, but maybe because it considers some of these libraries untyped and doesn&#x27;t follow imports in them.</p>
<p>If having <code>current_user</code> treated as type <code>Any</code> is a workable solution, you could achieve this by providing your own type stub for <code>flask_login</code> module.</p>
<p>Closing this for now because it doesn&#x27;t appear to be a bug in ty, but will happily reopen if further discussion reveals something we should improve here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2025-08-19 00:22</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:25:19 UTC
    </footer>
</body>
</html>
