<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>imports from non-terminating modules silently resolved as Never - astral-sh/ty #1709</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>imports from non-terminating modules silently resolved as Never</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1709">#1709</a>
        opened by <a href="https://github.com/zilto">@zilto</a>
        on 2025-12-01 15:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/zilto">@zilto</a> on 2025-12-01 15:29</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I'm getting new type errors when upgrading from <code>0.0.1a21</code> to <code>0.0.1a22</code>. Some light code change on my end make the type-checker pass, but I'm unsure if my code or <code>ty</code> is incorrect.</p>
<h2>Setup</h2>
<p>I'm using <code>ty</code> across two libraries, so I'm trying to have a reduced example, but I didn't try the following repro</p>
<h3>From the main library (can't edit this code)</h3>
<pre><code class="language-python"># library/destinations/implementations/foo/factory.py
class Destination(abc.ABC, Generic[Config, Client]): ...

class foo(Destination[FooConfig, FooClient]): ...
</code></pre>
<pre><code class="language-python"># library/destinations/__init__.py
from library.destinations.impl.foo.factory import foo

__all__ = [&quot;foo&quot;]
</code></pre>
<h3>From the downstream library (can edit this code)</h3>
<p>In <code>0.0.1a21</code>, the following code passes all checks (<code>ty check</code>)</p>
<pre><code class="language-python">import library

def create_destination() -&gt; library.destinations.foo:
   return library.destinations.foo(...)
</code></pre>
<p>In <code>0.0.1a22</code>, the code fails with</p>
<pre><code class="language-shell">def create_destination() -&gt; Generator[library.destinations.foo, None, None]:
                                                                    ^^^^^^^^^^^^^^^^^^^
info: rule `invalid-type-form` is enabled by default
</code></pre>
<p>This fixes it</p>
<pre><code class="language-python">import library
from library.destinations import foo

def create_destination() -&gt; foo:
   return library.destinations.foo(...)
</code></pre>
<h3>Version</h3>
<p>0.0.1a22</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> added by @sharkdp on 2025-12-01 18:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-12-01 18:01</div>
            <div class="timeline-body"><p>Thank you for reporting this.</p>
<p>Before we dig further into this, two questions:</p>
<ul>
<li>0.0.1a22 is a couple of releases behind the latest version. Can you still reproduce this with the latest version?</li>
<li>The error message that you get on 0.0.1a22 looks like it points to code that is different from what you have in your snippet?</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zilto">@zilto</a> on 2025-12-01 20:03</div>
            <div class="timeline-body"><p>Hi!</p>
<blockquote>
<p>0.0.1a22 is a couple of releases behind the latest version. Can you still reproduce this with the latest version?</p>
</blockquote>
<p>Yes, the same behavior is found in <code>0.0.1a29</code>. I was upgrading from <code>0.0.1a19</code> when I found the behavior change. I downgraded versions until I found the change happening from <code>0.0.1a21</code> and <code>0.0.1a22</code></p>
<blockquote>
<p>The error message that you get on 0.0.1a22 looks like it points to code that is different from what you have in your snippet?</p>
</blockquote>
<p>I tried to trim the initial error message. This is what I get for <code>0.0.1a22</code></p>
<pre><code class="language-shell">error[invalid-type-form]: Variable of type `Never` is not allowed in a type expression
  --&gt; tests/conftest.py:18:16
   |
16 | def tmp_duckdb_destination(
17 |     tmp_path: pathlib.Path,
18 | ) -&gt; Generator[dlt.destinations.duckdb, None, None]:
   |                ^^^^^^^^^^^^^^^^^^^^^^^
   |
info: rule `invalid-type-form` is enabled by default
</code></pre>
<p>This is what I get for <code>0.0.1a29</code></p>
<pre><code class="language-shell">error[invalid-type-form]: Variable of type `Never` is not allowed in a type expression
  --&gt; tests/conftest.py:18:16
   |
16 | def tmp_duckdb_destination(
17 |     tmp_path: pathlib.Path,
18 | ) -&gt; Generator[dlt.destinations.duckdb, None, None]:
   |                ^^^^^^^^^^^^^^^^^^^^^^^
   |
help: The variable may have been inferred as `Never` because its definition was inferred as being unreachable
info: rule `invalid-type-form` is enabled by default
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-12-01 20:16</div>
            <div class="timeline-body"><blockquote>
<p>I tried to trim the initial error message.</p>
</blockquote>
<p>Ah, I see. Now have a completely different error message. Did you see the &quot;help&quot; text in the diagnostic that you get on 0.0.1a29?</p>
<blockquote>
<p>The variable may have been inferred as <code>Never</code> because its definition was inferred as being unreachable</p>
</blockquote>
<p>Can you check if <code>dlt.destinations.duckdb</code> is maybe guarded by a <code>sys.version_info &gt;= …</code> check or a <code>sys.platform</code> check? Or if there could be some other reason why ty thinks that this symbols is unreachable?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zilto">@zilto</a> on 2025-12-04 14:59</div>
            <div class="timeline-body"><blockquote>
<p>Can you check if dlt.destinations.duckdb is maybe guarded by a sys.version_info &gt;= … check or a sys.platform check?</p>
</blockquote>
<p>Searching the codebase, <code>sys.platform</code> is used twice and <code>sys.version_info</code> only once. All of these instances are within the closure of functions, suggesting no impact on the current issue.</p>
<blockquote>
<p>Or if there could be some other reason why ty thinks that this symbols is unreachable?
My guess would be that there's some name shadowing in the codebase and <code>ty</code> name resolution diverges from the Pyhton name resolution. See step 4. and 5.</p>
</blockquote>
<p>The import for <code>dlt.destinations.duckdb</code> is as follow:</p>
<ol>
<li><p><code>repro.py</code> (type-checked user code)</p>
<pre><code class="language-python">import dlt

def foo() -&gt; dlt.destinations.duckdb:
  return dlt.destinations.duckdb(...)
</code></pre>
</li>
<li><p><code>dlt/__init__.py</code></p>
<pre><code class="language-python">from dlt import destinations

__all__ = (&quot;destinations&quot;, ...)
</code></pre>
</li>
<li><p><code>dlt/destinations/__init__.py</code></p>
<pre><code class="language-python">from dlt.destinations.impl.duckdb.factory import duckdb

__all__ = (&quot;duckdb&quot;, ...)
</code></pre>
</li>
<li><p><code>dlt/destinations/impl/__init__.py</code>
This file is empty. There is no import or public namespace</p>
</li>
<li><p><code>dlt/destinations/impl/duckdb/__init__.py</code>
This file is empty. There is no import or public namespace</p>
</li>
<li><p><code>dlt/destinations/impl/duckdb/factory.py</code></p>
<pre><code class="language-python"># actual class implementation
class duckdb: ...
</code></pre>
</li>
</ol>
<p>It would be useful to have a traceback until the type resolution hits <code>Never</code> in addition to the message</p>
<pre><code class="language-shell">error[invalid-type-form]: Variable of type `Never` is not allowed in a type expression
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-12-04 16:00</div>
            <div class="timeline-body"><p>Ok, this is interesting. The problematic code is here:</p>
<p>https://github.com/dlt-hub/dlt/blob/e8d45369f1607d36bee5f002a661458f1fabe733/dlt/<strong>init</strong>.py#L92-L94</p>
<p>This assertion checks that <code>_Container._INSTANCE is None</code>. However, that attribute is clearly declared as having type <code>Container</code> here:</p>
<p>https://github.com/dlt-hub/dlt/blob/e8d45369f1607d36bee5f002a661458f1fabe733/dlt/common/configuration/container.py#L32</p>
<p>This is why <code>ty</code> infers that this condition is always false. And it considers all code that comes after it as unreachable.</p>
<p>Here is where ty does something that is probably unexpected: When we load symbols from this module, we consider their value at the end of the scope. Since the end of the scope is not reachable, we infer the type of <code>dlt.destinations</code> as <code>Never</code>.</p>
<p>You could fix this by guarding it as <code>if not TYPE_CHECKING</code>, or by giving <code>_Container._INSTANCE</code> a different type (e.g. <code>Container | None</code>).</p>
<p>In ty, we should probably also try to improve the situation somehow. I saw a similar problem recently where a  module ended in a <code>while True</code> loop...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> removed by @AlexWaygood on 2025-12-04 16:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-04 16:57</div>
            <div class="timeline-body"><p>At the very least, we should probably error directly on the import from such a module, rather than just silently inferring the type as <code>Never</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Stable" by @carljm on 2025-12-04 16:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "`invalid-type-form` regression from `0.0.1a21 -> 0.0.1a22`" to "imports from non-terminating modules resolved as Never" by @carljm on 2025-12-04 16:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">unreachable-code</span> added by @carljm on 2025-12-04 16:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zilto">@zilto</a> on 2025-12-05 14:39</div>
            <div class="timeline-body"><p>@sharkdp Thank you so much for the investigation. Will see how I can fix the Python code upstream.</p>
<p>Feel free to close this issue when appropriate</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "imports from non-terminating modules resolved as Never" to "imports from non-terminating modules silently resolved as Never" by @carljm on 2025-12-05 16:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 02:11:47 UTC
    </footer>
</body>
</html>
