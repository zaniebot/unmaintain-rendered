<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Function not recognized as satisfying ParamSpec Protocol - astral-sh/ty #2542</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Function not recognized as satisfying ParamSpec Protocol</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/2542">#2542</a>
        opened by <a href="https://github.com/gaborbernat">@gaborbernat</a>
        on 2026-01-17 05:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/gaborbernat">@gaborbernat</a></div>
            <div class="timeline-body"><p>A function with matching signature is not recognized as satisfying a Protocol that uses ParamSpec.</p>
<h2>Minimal reproduction</h2>
<pre><code class="language-python">from typing import Protocol, ParamSpec, Callable, Awaitable, Any

P = ParamSpec(&quot;P&quot;)

class ASGIApp(Protocol):
    async def __call__(self, scope: Any, receive: Any, send: Any) -&gt; None: ...

class MiddlewareFactory(Protocol[P]):
    def __call__(self, app: ASGIApp, /, *args: P.args, **kwargs: P.kwargs) -&gt; ASGIApp: ...

def my_middleware(app: ASGIApp) -&gt; ASGIApp:
    async def wrapper(scope: Any, receive: Any, send: Any) -&gt; None:
        await app(scope, receive, send)
    return wrapper

def add_middleware(factory: MiddlewareFactory[...]) -&gt; None:
    pass

add_middleware(my_middleware)
</code></pre>
<h2>Error</h2>
<pre><code>error[invalid-argument-type]: Argument to function `add_middleware` is incorrect
  --&gt; issue.py:19:16
   |
17 |     pass
18 |
19 | add_middleware(my_middleware)
   |                ^^^^^^^^^^^^^ Expected `MiddlewareFactory[(...)]`, found `def my_middleware(app: ASGIApp) -&gt; ASGIApp`
</code></pre>
<h2>Expected behavior</h2>
<p><code>my_middleware</code> has signature <code>(app: ASGIApp) -&gt; ASGIApp</code> which should satisfy <code>MiddlewareFactory[...]</code> since it takes
<code>app</code> as first argument and returns <code>ASGIApp</code>, with no additional args/kwargs (matching empty ParamSpec).</p>
<h3>Version</h3>
<p>0.0.12</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-17 11:38</div>
            <div class="timeline-body"><p>Thanks! Is this the same as #1635?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gaborbernat">@gaborbernat</a> on 2026-01-17 15:07</div>
            <div class="timeline-body"><ul>
<li>Indeed, just here my repro doesn't have any dependency ðŸ˜…</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-17 15:11</div>
            <div class="timeline-body"><p>Thanks! We know what the cause is here, though (https://github.com/astral-sh/ty/issues/1714) -- the reason #1635 has not been closed as a duplicate is because people are more likely to find it on the issue tracker than #1714, which has a bit of an abstract title. And #1635 has a link to https://github.com/astral-sh/ty/issues/157#issuecomment-3554317390 in the issue thread, which is a repro without a dependency</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2026-01-17 15:11</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-17 16:06:16 UTC
    </footer>
</body>
</html>
