<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>exponential runtime for some large unions (part 2) - astral-sh/ty #2123</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>exponential runtime for some large unions (part 2)</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/2123">#2123</a>
        opened by <a href="https://github.com/markjm">@markjm</a>
        on 2025-12-19 23:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/markjm">@markjm</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I'm back!</p>
<p>I want to express my gratitude for the quick fix on #1968. The repro works like a charm now. Unfortunately, when I tried out 0.0.3 (or 4) on the actual sourcecode which triggered the issue in our codebase, I could still repro the slowdown :(</p>
<p>I have below another similar repro which I see still has exponential runtime based on the size of the <code>StreamMessage</code> union:</p>
<pre><code class="language-python">&quot;&quot;&quot;
ty type checker hang reproduction.
Run: uvx ty==0.0.4 check ty_repro.py
&quot;&quot;&quot;

from __future__ import annotations

from typing import Callable
from typing import Generic
from typing import TypeVar
from typing import Union


class M1: pass
class M2: pass
class M3: pass
class M4: pass
class M5: pass
class M6: pass
class M7: pass
class M8: pass
class M9: pass
class M10: pass
class M11: pass
class M12: pass
class M13: pass
class M14: pass
class M15: pass

# limiting the # of elements in this union improves runtime. For me, 12 elements takes 5sec, 13 takes 12sec, and grows further
StreamMessage = Union[M1, M2, M3, M4, M5, M6, M7, M8, M9, M10, M11, M12, M13, M14, M15]

T = TypeVar(&quot;T&quot;)
U_co = TypeVar(&quot;U_co&quot;, covariant=True)


class AsyncStream(Generic[T]):
    def apply(self, func: Callable[[AsyncStream[T]], AsyncStream[U_co]]) -&gt; AsyncStream[U_co]:
        return func(self)

    def filter(self, predicate: Callable[[T], bool]) -&gt; AsyncStream[T]:
        return AsyncStream()  # type: ignore

    def peek_index(self, action: Callable[[T, int], None]) -&gt; AsyncStream[T]:
        return AsyncStream()  # type: ignore


TStreamMessage = TypeVar(&quot;TStreamMessage&quot;, bound=StreamMessage)


class Builder(Generic[TStreamMessage]):
    def build(self) -&gt; AsyncStream[TStreamMessage]:
        stream = AsyncStream().filter(lambda x: True)  # type: ignore
        stream = stream.apply(self._handle_2).apply(self._handle_1)
        stream = stream.peek_index(self._peek)
        return stream

    def _handle_1(self, stream: AsyncStream[TStreamMessage]) -&gt; AsyncStream[TStreamMessage]:
        return AsyncStream()  # type: ignore

    def _handle_2(self, stream: AsyncStream[StreamMessage]) -&gt; AsyncStream[StreamMessage]:
        return AsyncStream()  # type: ignore

    def _peek(self, item: StreamMessage, index: int) -&gt; None:
        pass
</code></pre>
<p>This is as much of a repro i could narrow before heading out for the week, so sorry its a bit messy. Happy holidays!</p>
<h3>Version</h3>
<p>0.0.4</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Stable" by @carljm on 2025-12-19 23:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @carljm on 2025-12-19 23:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Stable" by @carljm on 2025-12-19 23:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "M1" by @carljm on 2025-12-19 23:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">generics</span> added by @carljm on 2025-12-20 00:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dcreager by @dcreager on 2026-01-09 13:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:21:29 UTC
    </footer>
</body>
</html>
