<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dataclass: wrong type on field access via class - astral-sh/ty #1522</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>dataclass: wrong type on field access via class</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1522">#1522</a>
        opened by <a href="https://github.com/Tinche">@Tinche</a>
        on 2025-11-11 14:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Tinche">@Tinche</a></div>
            <div class="timeline-body">Summary
<p>MRE:</p>
<pre><code>from dataclasses import dataclass

@dataclass
class A:
    a: int

@dataclass(slots=True)
class ASlot:
    a: int

reveal_type(A.a)
reveal_type(ASlot.a)
</code></pre>
<p>Playground link: https://play.ty.dev/1eb91b94-d161-45d1-9e98-81630885079e</p>
<p>In both cases, ty reveals <code>int</code>. At runtime, the first case will raise an AttributeError (<code>a</code> does not exist on the class), and in the second the type is completely different [a member_descriptor instance that all slot classes have]).</p>
Version
<p>ty 0.0.1-alpha.26 (b225fd8b4 2025-11-10)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">dataclasses</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-11 15:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">attribute access</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-11-11 15:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-11 15:40</div>
            <div class="timeline-body"><p>Thanks for the report!</p>
<p>For reference, although it doesn&#x27;t match runtime, our current behavior matches both <a href="https://pyright-play.net/?pyrightVersion=1.1.405&amp;code=GYJw9gtgBAJghgFzgYwDZwM4YKYagSwgAcwQFZEV0sAoGgAXiTUwxpaygEEAuGqAVDg8CAOwR1GlDhgAUGVGAQYAvABUQAV2wBKdtTxcAyooR9BQkfnF0Q2AG7Y4qAPoIAnkWyyuAOjh6do7Obp7exqb%2BOkA">pyright</a> and <a href="https://pyrefly.org/sandbox/?project=N4IgZglgNgpgziAXKOBDAdgEwEYHsAeAdAA4CeS4ATrgLYAEmqALqgMZSpxzx0Q3G5KTBszYcuAHXRSAAoxbtOcKYq50Agoil0ddVIl7omU2fLFKAFHCi4mcALwAVSgFcYAShXi4GgMo2mLXRdPQMIIxN0ShgANxhUKAB9JlJiGAt1QlRPKNj4pJS0jP9bLJyQABoQFyZoOBJyRBAAYjoAVVqoCBS6MBd0VlrcdGVpLBgwXsEaZkT0FxpsGEoLfDCjdzoAWgA%2BOjgmSiCQ6KYXSmCwCRAAOQWlo7pgfABfa6lKkDJosChSQiYtCgFFaAAVSD8-vsMDgCHRWMNIABzc7MCDDQhSVq%2BGAwOgACyYTGIcEQAHoyd8Jn9CIIkWSYOgyZhcKw4GSEehkaihkyppQ9DFUNBUNhYPDERAUZQ0cM6LhiLz6lIyEx8cMtnFKHB0cF7HRrgBmQgARgATO90CAXlU2LU4gAxaAwChoLB4Ihka1AA">pyrefly</a>, and also matches the revealed types of <a href="https://mypy-play.net/?mypy=latest&amp;python=3.12&amp;gist=e7d1511134f2aa562af0ae8970c7feee">mypy</a>. Mypy issues an additional error on <code>ASlot.a</code>, which is kind of weird since that&#x27;s the one of the two above cases that <em>doesn&#x27;t</em> emit a runtime error.</p>
<p>If we were to try to model the runtime behavior more accurately, we also would need to consider the presence or absence of a default value. This makes no difference with <code>slots=True</code> (in that case all fields are always member descriptors on the class), but with <code>slots=False</code> any field with a default value returns the default value if accessed as an attribute on the class.</p>
<p>There are additional subtleties if descriptors are used as field types...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Tinche">@Tinche</a> on 2025-11-11 16:00</div>
            <div class="timeline-body"><blockquote>
<p>If we were to try to model the runtime behavior more accurately, we also would need to consider the presence or absence of a default value. This makes no difference with slots=True (in that case all fields are always member descriptors on the class), but with slots=False any field with a default value returns the default value if accessed as an attribute on the class.</p>
</blockquote>
<p>Huh, interesting. In attrs we chose to clean up the class vars to the best of our ability (for slotted classes obviously not possible); looks like dataclasses went another way. The idea being to always have to use <code>attrs.fields()</code> for this information.</p>
<p>And it looks like if the field doesn&#x27;t have a default but a factory, dataclasses will not leave it on the class.</p>
<p>To continue on this tangent: my first thought was if the default wasn&#x27;t provided dataclasses will let attribute access go to the class <code>__dict__</code>, but doesn&#x27;t seem so - the default is also in the signature for the <code>__init__</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-11 16:14</div>
            <div class="timeline-body"><blockquote>
<p>In attrs we chose to clean up the class vars to the best of our ability (for slotted classes obviously not possible); looks like dataclasses went another way.</p>
</blockquote>
<p>I think this is my main concern with spending effort modeling runtime behavior of dataclasses more closely. This behavior isn&#x27;t specified or standardized for <code>dataclass_transform</code>, so it&#x27;s likely that whatever we do will be wrong for some dataclass-transform-using libraries.</p>
<p>Which leaves me slightly more inclined to just continue to match the other type checkers -- if it&#x27;s important to get this behavior right, then it would be worth standardizing it for <code>dataclass_transform</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Tinche">@Tinche</a> on 2025-11-11 19:11</div>
            <div class="timeline-body"><p>Understood, but the case when there is no default is pretty clear-cut, right?</p>
<p>The discussion about default handling can be left for fine tuning sometime in the future I suppose.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-11 19:34</div>
            <div class="timeline-body"><blockquote>
<p>Understood, but the case when there is no default is pretty clear-cut, right?</p>
</blockquote>
<p>I guess a dataclass-transform-using library could do something else there, but it&#x27;s quite unlikely, so probably yes?</p>
<p>I think it&#x27;s a low priority for ty to emit an error on these accesses, but in principle I think it would be fine.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:25:56 UTC
    </footer>
</body>
</html>
