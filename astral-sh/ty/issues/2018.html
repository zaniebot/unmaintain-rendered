<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incorrect type inference - astral-sh/ty #2018</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Incorrect type inference</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/2018">#2018</a>
        opened by <a href="https://github.com/Yura52">@Yura52</a>
        on 2025-12-17 15:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Yura52">@Yura52</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>(Please feel free to edit the issue title as needed!)</p>
<p>In the following snippet, <code>foo</code> passes the type checks, but <code>bar</code> does not:</p>
<pre><code class="language-py">def foo[T](a: None | T, b: None | T) -&gt; T:
    if a is None:
        assert b is not None
    else:
        b = a
    return b


def bar[T](a: None | T, b: None | T) -&gt; T:
    if a is None:
        assert b is not None
    else:
        if b is None:
            b = a
    return b
</code></pre>
<p>Namely, <code>ty check</code> says:</p>
<pre><code>error[invalid-return-type]: Return type does not match returned value
  --&gt; local/ty_test.py:15:12
   |
13 |         if b is None:
14 |             b = a
15 |     return b
   |            ^ expected `T@bar`, found `None | T@bar`
   |
  ::: local/ty_test.py:9:41
   |
 9 | def bar[T](a: None | T, b: None | T) -&gt; T:
   |                                         - Expected `T@bar` because of return type
10 |     if a is None:
11 |         assert b is not None
   |
info: rule `invalid-return-type` is enabled by default
</code></pre>
<p>However, <code>b</code> always becomes <code>T</code> by the end of both functions, so the reported error seems to be false positive.</p>
<h3>Version</h3>
<p>0.0.2</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/oconnor663">@oconnor663</a> on 2025-12-17 18:25</div>
            <div class="timeline-body"><p>It looks like we're failing to unify the two branches? https://play.ty.dev/9830b46c-09df-4123-a317-4e058ccc86e5</p>
<pre><code class="language-py">def bar(a: int | None, b: int | None):
    if a is None:
        assert b is not None
        reveal_type(b)  # int
    else:
        if b is None:
            b = a
        reveal_type(b)  # int
    reveal_type(b)      # int | None
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-17 18:26</div>
            <div class="timeline-body"><p>It's possible this might be related to https://github.com/astral-sh/ty/issues/690</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-17 18:32</div>
            <div class="timeline-body"><p>Yes this is #690 - thanks for the report!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-12-17 18:32</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:21:22 UTC
    </footer>
</body>
</html>
