<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>right hand of operator incorrectly takes precedence - astral-sh/ty #1154</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>right hand of operator incorrectly takes precedence</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1154">#1154</a>
        opened by <a href="https://github.com/KotlinIsland">@KotlinIsland</a>
        on 2025-09-09 08:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/KotlinIsland">@KotlinIsland</a> on 2025-09-09 08:56</div>
            <div class="timeline-body"><h3>Summary</h3>
<pre><code class="language-py">from __future__ import annotations

class A:
    def __or__(self, other: A) -&gt; A:
        return self

    def __ror__(self, other: A) -&gt; B:
        return B()

class B(A):
    def __ror__(self, other: A) -&gt; B:
        return B()

class C(A):
    pass
    
def f(
    a: A = C(),
    b: B = B(),
):
    x = a | b  # ty: B, runtime: C

f()
</code></pre>
<p>this unsafety is also discussed in this issue:</p>
<ul>
<li>#630</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "regression: right hand of operator incorrectly takes precedence" to "right hand of operator incorrectly takes precedence" by @KotlinIsland on 2025-09-09 09:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-09-09 16:54</div>
            <div class="timeline-body"><p>Pyright gives <code>str</code> here (though it's not clear to me what logic it uses to reach that conclusion); mypy and ty both give <code>int</code>. Unlike the case in #630, mypy does not give an &quot;unsafe overlapping dunder definitions&quot; diagnostic here.</p>
<p>This seems sufficiently similar to #630 that I'm not sure it makes sense to have two separate issues open?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-09-09 16:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KotlinIsland">@KotlinIsland</a> on 2025-09-09 23:24</div>
            <div class="timeline-body"><p>pyright gives<code>str</code> because it doesn't special case the right-hand subtype rule like mypy (and seemingly ty) does. it's invalid to take this rule into account because you don't actually know if the right is a subclass of the left, as demonstrated in the op</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KotlinIsland">@KotlinIsland</a> on 2025-09-09 23:55</div>
            <div class="timeline-body"><p>@carljm these are two separate issues, this issue can be reproduced with completely valid operator definitions, i've updated the OP to demonstrate</p>
<p>the issue is that the right hand subtype rule should only be applied when the <strong>exact</strong> types of the values are known, if it's potentially a subtype then it's unsound to do this specialisation</p>
<p>if we were to introduce <code>Exact</code> types, like &quot;use-site final&quot;, or an equal lower and upper bound on a type, then we could perform this safely</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-09-10 00:18</div>
            <div class="timeline-body"><p>Ok -- and the idea is that we can achieve soundness here by a) only applying the RHS subtype precedence rule if we know it applies, due to finality of the LHS, and b) implementing the warning in #630, so we would warn in any case where not applying the RHS subtype precedence rule could lead to unsound results.</p>
<p>Don't have time to work through all the cases in detail right now, but I think this makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @carljm on 2025-09-10 00:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/KotlinIsland">@KotlinIsland</a> on 2025-09-10 00:30</div>
            <div class="timeline-body"><p>thank you ðŸ™‚</p>
<p>i agree with your points. although for completeness, we should say &quot;the lower bound of the lhs&quot;, as finality is only a single possible case</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 02:11:29 UTC
    </footer>
</body>
</html>
