<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>No member completions offered for variable of type `T | Unknown` - astral-sh/ty #2197</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>No member completions offered for variable of type <code>T | Unknown</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/2197">#2197</a>
        opened by <a href="https://github.com/rodrigoscc">@rodrigoscc</a>
        on 2025-12-24 03:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/rodrigoscc">@rodrigoscc</a> on 2025-12-24 03:26</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Hello,</p>
<p>I've found a case where autocomplete won't work even tho the type of the variable is clear. It is when I iterate over a list, the variable attributes are not autocompleted inside the for loop:
<img width="638" height="347" alt="Image" src="https://github.com/user-attachments/assets/77452a4a-b079-429e-8a2f-e37e612eed87" /></p>
<p><code>i</code> type is correctly detected as <code>Unknown | A</code> and I can even go to definition of its attributes, but autocomplete doesn't work. Here's the playground link: https://play.ty.dev/80851291-8503-4aaf-b5aa-f286949c820b</p>
<p>Thanks for this amazing LSP! :)</p>
<h3>Version</h3>
<p>0.0.6</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-12-24 09:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @AlexWaygood on 2025-12-24 09:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">completions</span> added by @AlexWaygood on 2025-12-24 09:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sinon">@sinon</a> on 2025-12-24 10:16</div>
            <div class="timeline-body"><p>The loop aspect doesn't seem to be the cause it's any union of types (not specifically to <code>Unknown</code>) seems to be stop the completions.</p>
<p>https://play.ty.dev/937e266f-1665-4b5d-a2c0-d7b4174c3a0d</p>
<pre><code class="language-py">import random
from ty_extensions import Unknown
class A:
    def __init__(self, msg: str):
        self.msg = msg

class B:
    def __init__(self, msg: str):
        self.message = msg


a = [A(&quot;hello&quot;), A(&quot;no&quot;)]. # list[A | Unknown]
b: list[A] = [A(&quot;hello&quot;), A(&quot;no&quot;)]
c: list[A | B] = [A(&quot;hello&quot;), A(&quot;no&quot;), B(&quot;yes&quot;)]

def something() -&gt; A | B:
    return random.choice([A(&quot;a&quot;), B(&quot;b&quot;)])

d = something()

# no completion
d.m

for i in a:
    # no completion
    i.m

for i in b:
    # works
    i.msg

for i in c:
    # no completion
    i.m
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "completion not working for loop variable attributes" to "No member completions offered for variable of type `T | Unknown`" by @AlexWaygood on 2025-12-24 12:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-24 12:57</div>
            <div class="timeline-body"><p>Thanks @rodrigoscc for the report and thanks @sinon for the initial triage!!</p>
<p>The problem here is <a href="https://github.com/astral-sh/ruff/blob/81f34fbc8e404cd26fa40ee86a339947dce7617c/crates/ty_python_semantic/src/types/list_members.rs#L165-L172">this branch</a> in our routine for collecting &quot;all members&quot; of a given type. On a union type <code>T | S</code>, the available members will be the <em>intersection</em> of <code>&lt;set of members available on T&gt;</code> with <code>&lt;set of members available on S&gt;</code>. That makes sense from a type-theory perspective, but it's obviously suboptimal for this specific case.</p>
<p>The problem is that a dynamic type such as <code>Any</code> or <code>Unknown</code> has an infinite number of members available on it, but it would take a &quot;very long time&quot;™️ for us to enumerate an infinite number of members, so instead of attempting to do that the <code>all_members()</code> routine just returns an empty set if you ask for all members available on a dynamic type. And the intersection of any set with an empty set is another empty set.</p>
<p>The long and short of it is that this routine is too naive currently when it comes to unions that include dynamic types. Shouldn't be too hard to fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Wizzerinus">@Wizzerinus</a> on 2025-12-24 13:44</div>
            <div class="timeline-body"><p>Honestly I think this approach could be changed in general, not only for unions of dynamic types. Consider, for example, the type <code>T | None</code> (with T being some concrete type). While getting members from this type is not sound at runtime, it is still often useful to get autocompletion for its members, for example, i.e. to see what is possible to do with values of type T, without having to insert an <code>assert obj is not None</code> before that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-24 13:47</div>
            <div class="timeline-body"><blockquote>
<p>Honestly I think this approach could be changed in general, not only for unions of dynamic types. Consider, for example, the type <code>T | None</code> (with T being some concrete type). While getting members from this type is not sound at runtime, it is still often useful to get autocompletion for its members, for example, i.e. to see what is possible to do with values of type T, without having to insert an <code>assert obj is not None</code> before that.</p>
</blockquote>
<p>Maybe. But wouldn't it be confusing for a user to have a situation where ty suggests an autocompletion, you accept that autocompletion suggestion, and then ty immediately complains about the code that it just added for you?</p>
<p>We should look at what other language servers like pylance do here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Wizzerinus">@Wizzerinus</a> on 2025-12-24 14:01</div>
            <div class="timeline-body"><p>Basedpyright gives all (or at least, multiple of) union fields in the completions:</p>
<p><img width="686" height="542" alt="Image" src="https://github.com/user-attachments/assets/1cb99c32-bbed-43a9-bf90-b451628cb09f" /></p>
<p><img width="678" height="605" alt="Image" src="https://github.com/user-attachments/assets/20f15893-c183-4305-8c09-b544b8317e41" /></p>
<p>So does pyrefly:</p>
<p><img width="680" height="651" alt="Image" src="https://github.com/user-attachments/assets/94a0c388-c864-40e9-adea-2f5e68f17640" /></p>
<p>(EDIT: fixed Basedpyright and Pyrefly ss's being swapped)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-24 14:04</div>
            <div class="timeline-body"><p>Thanks @Wizzerinus, that's super helpful!</p>
<p>I would still be inclined to view that as a separate issue that should maybe be fixed in a separate PR. But it's extremely valuable to know how other LSPs handle union types here!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Pre-stable 1" by @AlexWaygood on 2026-01-06 23:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-06 23:57</div>
            <div class="timeline-body"><p>@zsol mentioned that this was one of his top annoyances with ty right now, and it was also mentioned as a point of frustration in https://github.com/astral-sh/ty/issues/2373, so we should treat this as high-priority</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2026-01-07 00:03</div>
            <div class="timeline-body"><p>Though I think if we do #1240 (and make it default) that will reduce the priority on this quite a lot. (We should still do it, of course.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2026-01-07 15:15</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:41:51 UTC
    </footer>
</body>
</html>
