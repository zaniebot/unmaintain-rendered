<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Narrow nonlocal type based on position of inner scope - astral-sh/ty #710</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Narrow nonlocal type based on position of inner scope</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/710">#710</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-06-26 11:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body"><p>With https://github.com/astral-sh/ruff/pull/18750 merged, we now consider all reachable bindings for nonlocal types. This can cause overly wide union types in cases where the inner scope is only executed after narrowing the type in the outer scope through an assignment. For example:</p>
<pre><code class="language-py">def outer(x=None):
    # â€¦

    x = 1

    def inner():
        reveal_type(x)  # Unknown | None | Literal[1], should not contain `None`
    
    inner()
</code></pre>
<p>This should be fixed by considering the position of the inner scope within the enclosing scope. Only bindings that appear after the definition of the inner scope should be considered.</p>
<p>A similar problem appears with type narrowing through conditions.</p>
<pre><code class="language-py">def outer(x: int | None):
    if x is not None:
        def inner():
            reveal_type(x)  # int | None, should be int
        
        inner()
</code></pre>
<p>Fixing this as well might follow a similar strategy, if we implement the &quot;treat every new narrowing of a definition as a new definition&quot; strategy proposed in https://github.com/astral-sh/ty/issues/690.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">control flow</span> added by @sharkdp on 2025-06-26 11:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-14 15:25</div>
            <div class="timeline-body"><p>This is now fixed, at least for both examples given here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-11-14 15:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:20:12 UTC
    </footer>
</body>
</html>
