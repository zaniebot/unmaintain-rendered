```yaml
number: 1724
title: "Duplicate suggestions for already imported \"unimported\" completions"
type: issue
state: open
author: MatthewMckee4
labels:
  - server
  - completions
assignees: []
created_at: 2025-12-02T16:33:09Z
updated_at: 2026-01-09T15:24:30Z
url: https://github.com/astral-sh/ty/issues/1724
synced_at: 2026-01-10T01:56:40Z
```

# Duplicate suggestions for already imported "unimported" completions

---

_Issue opened by @MatthewMckee4 on 2025-12-02 16:33_

### Summary

I guess we do no filtering to remove duplicates.

<img width="480" height="238" alt="Image" src="https://github.com/user-attachments/assets/6b685833-4674-41be-ba64-db3331e11188" />

I would expect not to see `TypeVar (import typing)` here.

### Version

_No response_

---

_Renamed from "Duplicate completions for already imported "unimported" completions" to "Duplicate suggestions for already imported "unimported" completions" by @MatthewMckee4 on 2025-12-02 16:33_

---

_Label `server` added by @AlexWaygood on 2025-12-02 16:35_

---

_Label `completions` added by @AlexWaygood on 2025-12-02 16:35_

---

_Comment by @BurntSushi on 2025-12-02 17:02_

I think the problem is here:

https://github.com/astral-sh/ruff/blob/05d053376b73b911b74dcbad647d2ae6a988b505/crates/ty_ide/src/completion.rs#L64-L65

Actually, I think there are two problems here.

1. `dedup_by` only deals with adjacent duplicates. That may have been fine at one point, but the ranking has grown more sophisticated and probably isn't appropriate any more.
2. The deduplication is done on the symbol name _and_ module name. A symbol in scope lacks a module name. An auto-import symbol always has a module name. So fundamentally, a symbol in scope will never deduplicate with an auto-import symbol.

Since auto-import symbols always come with a module name, then I think one way to deduplicate them with in scope symbols is to find the module in which each symbol in scope is defined. Then compare it with the module name on the auto-import symbol.

We might be able to add this information here:

https://github.com/astral-sh/ruff/blob/05d053376b73b911b74dcbad647d2ae6a988b505/crates/ty_ide/src/importer.rs#L358-L362

Actually, I think we already have it?

https://github.com/astral-sh/ruff/blob/05d053376b73b911b74dcbad647d2ae6a988b505/crates/ty_python_semantic/src/semantic_model.rs#L335

Since we're already computing the set of members in scope at the cursor in order to figure out how to write import edits.

Then I think we can deduplicate here:

https://github.com/astral-sh/ruff/blob/05d053376b73b911b74dcbad647d2ae6a988b505/crates/ty_ide/src/completion.rs#L539-L566

---

_Added to milestone `Stable` by @MichaReiser on 2025-12-02 18:05_

---

_Assigned to @BurntSushi by @BurntSushi on 2026-01-09 15:24_

---
