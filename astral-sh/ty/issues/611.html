<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Use `.venv` over `base` conda environment - astral-sh/ty #611</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Use <code>.venv</code> over <code>base</code> conda environment</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/611">#611</a>
        opened by <a href="https://github.com/Danielkonge">@Danielkonge</a>
        on 2025-06-08 16:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Danielkonge">@Danielkonge</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>In some cases, one can have a <code>.venv</code> without activating it (e.g. a <code>.venv</code> created by bazel), but it will currently not be found with a standard setup, where conda is installed.</p>
<p>This is because even without activating a conda environment, you will still usually have ~ ~<code>CONDA_DEFAULT_ENV=base</code>~ <code>CONDA_PREFIX=/opt/anaconda3</code>, so ty will use site-packages from your base conda environment and not look in the <code>.venv</code>.</p>
<p>I think ty should generally prefer the <code>.venv</code> over the base conda environment here. It is less clear if you would prefer the <code>.venv</code> if any non-standard environment is activated, but at least for the base environment I think that the current behavior is unexpected.</p>
<h3>Version</h3>
<p>ty 0.0.1-alpha.8 (c1337c962 2025-06-02)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-08 17:33</div>
            <div class="timeline-body"><p>Heh, we discussed exactly this situation in https://github.com/astral-sh/ruff/pull/18267#discussion_r2104676295, and decided that if the <code>VIRTUAL_ENV</code> environment variable had not been set (indicating that the local virtual environment had not been explicitly activated) but the <code>CONDA_PREFIX</code> environment variable <em>was</em> set (indicating that the conda environment <em>had</em> been explicitly activated), then the explicitly activated environment should take priority over any implicit virtual environment discovery.</p>
<p>I've never used bazel — can I ask why you're not able to explicitly activate your local virtual environment? If that's totally out of the question, would setting the <code>VIRTUAL_ENV</code> environment variable manually, or using <code>--python=.venv</code>, work for you?</p>
<p>(The <code>--python</code> argument can also be specified in a config file: <code>tool.ty.environment.python</code> in a pyproject.toml file, or just <code>environment.python</code> in a ty.toml file.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">imports</span> added by @AlexWaygood on 2025-06-08 17:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-08 17:34</div>
            <div class="timeline-body"><p>I don't think we look at the <code>CONDA_DEFAULT_ENV</code> environment variable at all at the moment BTW — we just look at the <code>CONDA_PREFIX</code> environment variable</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Danielkonge">@Danielkonge</a> on 2025-06-08 18:13</div>
            <div class="timeline-body"><blockquote>
<p>I don't think we look at the CONDA_DEFAULT_ENV environment variable at all at the moment BTW — we just look at the CONDA_PREFIX environment variable</p>
</blockquote>
<p>Ah, you are probably right, the default prefix is just <code>CONDA_PREFIX=/opt/anaconda3</code>, so that is probably where you get the path from.</p>
<blockquote>
<p>I've never used bazel — can I ask why you're not able to explicitly activate your local virtual environment? If that's totally out of the question, would setting the VIRTUAL_ENV environment variable manually, or using --python=.venv, work for you?</p>
</blockquote>
<p>It is definitely possible to make an activate script, but I don't think that is the common way to do it in bazel (though I could be wrong here). Usually I would just point to the correct path and that should be fine, but I couldn't figure out how to give the path correctly for <code>ty server</code>. (Though to be fair, I just quickly tried it.) For now I solved it by just deactivating the default conda, but it would be nice to have a better solution.</p>
<p>Correct me if I'm wrong here, but is <code>--python=.venv</code> just for <code>ty check</code>? I will try to specify a <code>ty.toml</code> file instead for now (I do something similar with ruff, where the <code>ruffconfig.toml</code> works fine).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-08 22:39</div>
            <div class="timeline-body"><blockquote>
<p>Correct me if I'm wrong here, but is <code>--python=.venv</code> just for <code>ty check</code>?</p>
</blockquote>
<p>Yup, you'd do something like <code>ty check --python=.venv</code> if you wanted to specify the location of your Python installation from the CLI</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Danielkonge">@Danielkonge</a> on 2025-06-08 22:43</div>
            <div class="timeline-body"><blockquote>
<p>Yup, you'd do something like ty check --python=.venv if you wanted to specify the location of your Python installation from the CLI</p>
</blockquote>
<p>Is there a reason for not allowing <code>ty server --python=.venv</code>? (Not that this is a big problem, since you can give the server a config file.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-08 23:48</div>
            <div class="timeline-body"><blockquote>
<p>Is there a reason for not allowing <code>ty server --python=.venv</code>?</p>
</blockquote>
<p>hmm, that might be reasonable... @MichaReiser, WDYT?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-09 05:17</div>
            <div class="timeline-body"><p>The LSP uses a different model. The client sends the settings during the initialize request or the server can explicitly request them from the client. This is due to most users never seeing the CLI when using the server, e.g. because VS code starts the server for them. This also enables workspace or user wide LSP settings that you wouldn't get with CLI arguments.</p>
<p>We do plan to implement client settings support for ty and the python option seems like an important one, we just haven't gotten to it yet</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-06-09 05:20</div>
            <div class="timeline-body"><p>Related: https://github.com/astral-sh/ty-vscode/issues/26, https://github.com/astral-sh/ty/issues/82</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-06-09 13:49</div>
            <div class="timeline-body"><blockquote>
<p>Heh, we discussed exactly this situation in https://github.com/astral-sh/ruff/pull/18267#discussion_r2104676295, and decided that if the VIRTUAL_ENV environment variable had not been set (indicating that the local virtual environment had not been explicitly activated) but the CONDA_PREFIX environment variable was set (indicating that the conda environment had been explicitly activated), then the explicitly activated environment should take priority over any implicit virtual environment discovery.</p>
</blockquote>
<p>I think this is the wrong behavior and does not match uv. <code>CONDA_PREFIX</code> can be set to the base environment without it being explicitly activated. In uv, it was originally implemented as done here, but we needed to change it in a subsequent version.</p>
<p>See https://github.com/astral-sh/uv/pull/7691 (most of the discussion is in https://github.com/astral-sh/uv/issues/7124)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-06-09 13:52</div>
            <div class="timeline-body"><p>(If <code>CONDA_PREFIX</code> is set to something other than the base environment, I agree it should take precedence over any implicit discovery)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-09 13:54</div>
            <div class="timeline-body"><p>Ah, https://github.com/astral-sh/uv/pull/7691/files is a great reference, thanks. I wasn't aware that this was how conda base environments worked. In that case, I definitely agree we should change our behaviour to match uv's here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/griffinbaker12">@griffinbaker12</a> on 2025-07-26 21:29</div>
            <div class="timeline-body"><p>Hi everyone,</p>
<p>Just wanted to add some information to this issue as I'm running into a related problem when using <code>ty</code> with Conda environments.</p>
<p>Following the conversation here and in the linked issues, I can confirm that the current environment detection causes a server panic. When I have a Conda environment activated, the <code>$VIRTUAL_ENV</code> variable it sets causes the <code>ty</code> LSP server to crash on startup.</p>
<p>Here is the key error from my <code>lsp.log</code>:</p>
<pre><code>ERROR panicked at crates/ty_server/src/session.rs:391:30:
Default configuration to be valid: Failed to discover local Python environment

Caused by:
   0: Invalid `VIRTUAL_ENV` environment variable `/path/to/my/conda/envs/my-env`: points to a broken venv with no pyvenv.cfg file
   1: No such file or directory (os error 2)
</code></pre>
<p>I was able to work around this by modifying my LSP client's startup command to <code>sh -c 'unset VIRTUAL_ENV &amp;&amp; ty server'</code>, which seems to confirm that the server is misinterpreting the Conda environment.</p>
<p>I see the plan is to align the behavior with <code>uv</code>. If this isn't already being worked on, I'd be excited to try tackling it as my first contribution. Please let me know if that's something you'd be open to.</p>
<p>Thanks for all your work on this great tool!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-28 06:59</div>
            <div class="timeline-body"><p>Thanks @griffinbaker12 for reporting. This is the same underlying issue as https://github.com/astral-sh/ty/issues/859</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-07-28 13:05</div>
            <div class="timeline-body"><p>I'm happy to review a change to make the logic match uv.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Beta" by @MichaReiser on 2025-08-15 12:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @Gankra by @carljm on 2025-08-15 15:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Gankra on 2025-08-20 13:07</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:20:06 UTC
    </footer>
</body>
</html>
