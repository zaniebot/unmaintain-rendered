<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`no-matching-overload` when using `cv2` and `numpy` - astral-sh/ty #2479</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>no-matching-overload</code> when using <code>cv2</code> and <code>numpy</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/2479">#2479</a>
        opened by <a href="https://github.com/Carrot-shreds">@Carrot-shreds</a>
        on 2026-01-13 10:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Carrot-shreds">@Carrot-shreds</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Sample code</p>
<pre><code class="language-py">import cv2
import numpy as np

image = cv2.imread(&quot;image.png&quot;)
if image is not None:
    np.average(image)
</code></pre>
<p>It works good and no typing error with pyright</p>
<p>But <code>ty check</code> got</p>
<pre><code>error[no-matching-overload]: No overload of function `average` matches arguments
 --&gt; src\Model\Data\test.py:6:5
  |
4 | image = cv2.imread(&quot;image.png&quot;) 
5 | if image is not None:
6 |     np.average(image)
  |     ^^^^^^^^^^^^^^^^^
  |
info: First overload defined here
   --&gt; .venv\Lib\site-packages\numpy\lib\_function_base_impl.pyi:145:5
    |
144 |   @overload
145 |   def average(
    |  _____^
146 | |     a: _ArrayLikeFloat_co,
147 | |     axis: None = None,
148 | |     weights: _ArrayLikeFloat_co | None = None,
149 | |     returned: L[False] = False,
150 | |     *,
151 | |     keepdims: L[False] | _NoValueType = ...,
152 | | ) -&gt; floating: ...
    | |_____________^
153 |   @overload
154 |   def average(
    |
info: Possible overloads for function `average`:
info:   (a: _SupportsArray[dtype[bool[bool]] | dtype[integer[Any]] | dtype[floating[Any]]] | _NestedSequence[_SupportsArray[dtype[bool[bool]] | dtype[integer[Any]] | dtype[floating[Any]]]] | int | float | _NestedSequence[int | float], axis: None = None, weights: _SupportsArray[dtype[bool[bool]] | dtype[integer[Any]] | dtype[floating[Any]]] | _NestedSequence[_SupportsArray[dtype[bool[bool]] | dtype[integer[Any]] | dtype[floating[Any]]]] | int | ... omitted 3 union elements = None, returned: Literal[False] = False, *, keepdims: Literal[False] | _NoValueType = ...) -&gt; floating[Any]
info:   (a: _SupportsArray[dtype[bool[bool]] | dtype[integer[Any]] | dtype[floating[Any]]] | _NestedSequence[_SupportsArray[dtype[bool[bool]] | dtype[integer[Any]] | dtype[floating[Any]]]] | int | float | _NestedSequence[int | float], axis: None = None, weights: _SupportsArray[dtype[bool[bool]] | dtype[integer[Any]] | dtype[floating[Any]]] | _NestedSequence[_SupportsArray[dtype[bool[bool]] | dtype[integer[Any]] | dtype[floating[Any]]]] | int | ... omitted 3 union elements = None, *, returned: Literal[True], keepdims: Literal[False] | _NoValueType = ...) -&gt; tuple[floating[Any], floating[Any]]
info:   (a: _SupportsArray[dtype[bool[bool]] | dtype[integer[Any]] | dtype[floating[Any]] | dtype[complexfloating[Any, Any]]] | _NestedSequence[_SupportsArray[dtype[bool[bool]] | dtype[integer[Any]] | dtype[floating[Any]] | dtype[complexfloating[Any, Any]]]] | int | ... omitted 3 union elements, axis: None = None, weights: _SupportsArray[dtype[bool[bool]] | dtype[integer[Any]] | dtype[floating[Any]] | dtype[complexfloating[Any, Any]]] | _NestedSequence[_SupportsArray[dtype[bool[bool]] | dtype[integer[Any]] | dtype[floating[Any]] | dtype[complexfloating[Any, Any]]]] | int | ... omitted 4 union elements = None, returned: Literal[False] = False, *, keepdims: Literal[False] | _NoValueType = ...) -&gt; complexfloating[Any, Any]
info:   (a: _SupportsArray[dtype[bool[bool]] | dtype[integer[Any]] | dtype[floating[Any]] | dtype[complexfloating[Any, Any]]] | _NestedSequence[_SupportsArray[dtype[bool[bool]] | dtype[integer[Any]] | dtype[floating[Any]] | dtype[complexfloating[Any, Any]]]] | int | ... omitted 3 union elements, axis: None = None, weights: _SupportsArray[dtype[bool[bool]] | dtype[integer[Any]] | dtype[floating[Any]] | dtype[complexfloating[Any, Any]]] | _NestedSequence[_SupportsArray[dtype[bool[bool]] | dtype[integer[Any]] | dtype[floating[Any]] | dtype[complexfloating[Any, Any]]]] | int | ... omitted 4 union elements = None, *, returned: Literal[True], keepdims: Literal[False] | _NoValueType = ...) -&gt; tuple[complexfloating[Any, Any], complexfloating[Any, Any]]
info:   (a: _SupportsArray[dtype[bool[bool]] | dtype[integer[Any]] | dtype[floating[Any]] | dtype[complexfloating[Any, Any]]] | _NestedSequence[_SupportsArray[dtype[bool[bool]] | dtype[integer[Any]] | dtype[floating[Any]] | dtype[complexfloating[Any, Any]]]] | int | ... omitted 5 union elements, axis: SupportsIndex | Sequence[SupportsIndex] | None = None, weights: object = None, *, returned: Literal[True], keepdims: bool | bool[bool] | _NoValueType = ...) -&gt; tuple[Any, Any]
info:   (a: _SupportsArray[dtype[bool[bool]] | dtype[integer[Any]] | dtype[floating[Any]] | dtype[complexfloating[Any, Any]]] | _NestedSequence[_SupportsArray[dtype[bool[bool]] | dtype[integer[Any]] | dtype[floating[Any]] | dtype[complexfloating[Any, Any]]]] | int | ... omitted 5 union elements, axis: SupportsIndex | Sequence[SupportsIndex] | None = None, weights: object = None, returned: bool | bool[bool] = False, *, keepdims: bool | bool[bool] | _NoValueType = ...) -&gt; Any
info: rule `no-matching-overload` is enabled by default

Found 1 diagnostic
</code></pre>
<p>Most cv2 image functions like <code>imread</code>, <code>cvtColor</code> return <code>cv2.mat_wrapper.Mat | NumPyArrayNumeric</code> , and <code>NumPyArrayNumeric</code> were defined as <code>ndarray[Any, dtype[integer[Any] | floating[Any]]]</code>  in cv2.tying.
It seems like this problem was occured because ty do not think <code>dtype[integer[Any] | floating[Any]]</code> equal to <code>dtype[integer[Any]] | dtype[floating[Any]]</code></p>
<h3>Version</h3>
<p>ty 0.0.11 (830cb9cc6 2026-01-09)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2026-01-13 20:28</div>
            <div class="timeline-body"><p>I don't think that <code>dtype[integer[Any]] | dtype[floating[Any]]</code> should be assignable to <code>dtype[integer[Any] | floating[Any]]</code>.</p>
<p>My testing suggests this is an issue of real type incompatibility between cv2 stubs and numpy stubs, at certain versions. Given a particular version of opencv-python and numpy, I'm seeing the same behavior for ty and pyright. Given <code>opencv-python==4.11.0.86</code>, both ty and pyright are fine with your code on numpy 1.x, error on numpy &gt;=2,&lt;2.3, and are fine again on numpy 2.3+. It looks like the numpy type annotation was changed in 2.x a way that makes it incompatible with opencv, and then changed back again in 2.3.</p>
<p>Can you re-check  to ensure you are using the exact same numpy and opencv versions for testing pyright and testing ty? If you find a scenario where ty and pyright differ on this snippet, please provide the exact steps you are using to reproduce.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> added by @carljm on 2026-01-13 20:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2026-01-13 22:19</div>
            <div class="timeline-body"><p>Going to go ahead and close to keep the tracker actionable, but will happily reopen if you do have an example showing ty behavior differing on the same numpy/cv versions!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2026-01-13 22:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Carrot-shreds">@Carrot-shreds</a> on 2026-01-14 09:00</div>
            <div class="timeline-body"><p>Thank you for your testing! It's indeed a problem related to these dependency version, instead of the type checker.</p>
<p>I'm using python3.13 with the latest <code>opencv-python&gt;=4.12.0.88</code>, which lock the maximum verion of numpy to <code>numpy&lt;2.3.0</code>, so my numpy was degrade to <code>numpy&gt;=2.2.6</code> automatically. And it should be fixed in the next cv2 release.
After i change my dependencies to <code>opencv-python&gt;=4.11.0.86</code>, <code>numpy&gt;=2.4.1</code>, the error was disappeared.</p>
<p>About the difference of ty and pyright. Sorry I made a mistake that i didn't actually test the sample code with pyright, I just write another similar case as a sample and ty check it. I retest the sample with <code>numpy==2.2.6</code> and <code>opencv-python==4.12.0.88</code> using both pyright and ty. They all give the same &quot;no-matching-overload&quot; error as your result.</p>
<p>But i also retest my actual project code, they do act differently.
(In a new uv 3.13.9 env with numpy==2.2.6 and opencv-python==4.12.0.88)</p>
<pre><code>import cv2
import numpy as np
...
def func(img: np.ndarray):
    if len(img.shape) != 2:
        img = cv2.cvtColor(img, cv2.COLOR_RGB2GRAY)
    if np.average(img) &lt; 128:
        img = 255 - img
    ...
</code></pre>
<pre><code>PS G:\code\Python\tytest&gt; uvx pyright --pythonpath .venv/Scripts/python main.py
0 errors, 0 warnings, 0 informations
</code></pre>
<p>And <code>uvx ty check main.py</code> will got the same error as the sample code.</p>
<p>I also found if I change the code like this, pyright will also give the error like ty.</p>
<pre><code>import cv2
import numpy as np
...
def func(image_in: np.ndarray):
    if len(image_in.shape) != 2:
        img = cv2.cvtColor(image_in, cv2.COLOR_RGB2GRAY)
    else:
        img = image_in
    if np.average(img) &lt; 128:
        img = 255 - img
    ...
</code></pre>
<pre><code>PS G:\code\Python\tytest&gt; uvx pyright --pythonpath .venv/Scripts/python main.py
g:\code\Python\tytest\main.py
  g:\code\Python\tytest\main.py:12:8 - error: No overloads for &quot;average&quot; match the provided arguments (reportCallIssue)
  g:\code\Python\tytest\main.py:12:19 - error: Argument of type &quot;MatLike | ndarray[Unknown, Unknown]&quot; cannot be assigned to parameter &quot;a&quot; of type &quot;_ArrayLikeComplex_co | _ArrayLikeObject_co&quot; in function &quot;average&quot;
    Type &quot;MatLike | ndarray[Unknown, Unknown]&quot; is not assignable to type &quot;_ArrayLikeComplex_co | _ArrayLikeObject_co&quot;
      Type &quot;NumPyArrayNumeric&quot; is not assignable to type &quot;_ArrayLikeComplex_co | _ArrayLikeObject_co&quot;
        &quot;ndarray[Any, dtype[integer[Any] | floating[Any]]]&quot; is incompatible with protocol &quot;_SupportsArray[dtype[numpy.bool[builtins.bool]] | dtype[integer[Any]] | dtype[floating[Any]] | dtype[complexfloating[Any, Any]]]&quot;
          &quot;__array__&quot; is an incompatible type
            No overloaded function matches type &quot;() -&gt; ndarray[Any, _DType_co@_SupportsArray]&quot;
        &quot;ndarray[Any, dtype[integer[Any] | floating[Any]]]&quot; is incompatible with protocol &quot;_NestedSequence[_SupportsArray[dtype[numpy.bool[builtins.bool]] | dtype[integer[Any]] | dtype[floating[Any]] | dtype[complexfloating[Any, Any]]]]&quot;
          &quot;__reversed__&quot; is not present
          &quot;count&quot; is not present
    ... (reportArgumentType)
2 errors, 0 warnings, 0 informations
</code></pre>
<p>I think the behaviour difference perhaps because pyright's default <code>typeCheckingMode=&quot;standard&quot;</code> is less strict than ty's strategy.
Anyway, change the numpy version do solve the problem. Thanks again for teams wonderful working!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-14 09:38:04 UTC
    </footer>
</body>
</html>
