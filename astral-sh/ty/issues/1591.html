<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unexpected invalid-argument-type error for pandas DataFrame with columns - astral-sh/ty #1591</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Unexpected invalid-argument-type error for pandas DataFrame with columns</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1591">#1591</a>
        opened by <a href="https://github.com/knutae">@knutae</a>
        on 2025-11-19 11:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/knutae">@knutae</a> on 2025-11-19 11:16</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>The following code produces an invalid-argument-type error</p>
<pre><code class="language-python">import pandas

def frametest():
    return pandas.DataFrame([[1], [2]], columns=[&quot;a&quot;, &quot;b&quot;])
</code></pre>
<p>Output:</p>
<pre><code>$ uvx ty check pandas_columns.py
error[invalid-argument-type]: Argument to bound method `__init__` is incorrect
 --&gt; pandas_columns.py:4:41
  |
3 | def frametest():
4 |     return pandas.DataFrame([[1], [2]], columns=[&quot;a&quot;, &quot;b&quot;])
  |                                         ^^^^^^^^^^^^^^^^^^ Expected `ExtensionArray | ndarray[@Todo, dtype[Any]] | Index | ... omitted 4 union elements`, found `list[Unknown | str]`
  |
info: Method defined here
   --&gt; .venv/lib/python3.11/site-packages/pandas/core/frame.py:698:9
    |
696 |     # Constructors
697 |
698 |     def __init__(
    |         ^^^^^^^^
699 |         self,
700 |         data=None,
701 |         index: Axes | None = None,
702 |         columns: Axes | None = None,
    |         --------------------------- Parameter declared here
703 |         dtype: Dtype | None = None,
704 |         copy: bool | None = None,
    |
info: rule `invalid-argument-type` is enabled by default

Found 1 diagnostic
</code></pre>
<p>This was tested with the latest pandas version, 2.3.3.</p>
<p>Note that it works with ty version 0.0.1-alpha.26, but fails with 0.0.1-alpha.27.</p>
<h3>Version</h3>
<p>0.0.1-alpha.27</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-19 20:15</div>
            <div class="timeline-body"><p>Thanks for the report! It looks like this error is in fact correct, though we definitely need to provide better diagnostics here (tracked in https://github.com/astral-sh/ty/issues/163). The best fix on your end is to simply install the <code>pandas-stubs</code> stubs package, which provides better type annotations for pandas users.</p>
<p>Pyright gives the same error here, and provides a great diagnostic to explain the root cause:</p>
<pre><code>  /Users/carlmeyer/projects/ruff-examples/pandastest/main.py:3:13 - information: Type of &quot;pandas.DataFrame.__init__&quot; is &quot;(self: DataFrame, data: Unknown | None = None, index: ExtensionArray | ndarray[tuple[Any, ...], dtype[Any]] | Index | Series | SequenceNotStr[Unknown] | range | None = None, columns: ExtensionArray | ndarray[tuple[Any, ...], dtype[Any]] | Index | Series | SequenceNotStr[Unknown] | range | None = None, dtype: ExtensionDtype | str | dtype[Any] | type[str] | type[complex] | type[bool] | type[object] | None = None, copy: bool | None = None) -&gt; None&quot;
  /Users/carlmeyer/projects/ruff-examples/pandastest/main.py:6:49 - error: Argument of type &quot;list[str]&quot; cannot be assigned to parameter &quot;columns&quot; of type &quot;Axes | None&quot; in function &quot;__init__&quot;
    Type &quot;list[str]&quot; is not assignable to type &quot;Axes | None&quot;
      &quot;list[str]&quot; is not assignable to &quot;ExtensionArray&quot;
      &quot;list[str]&quot; is not assignable to &quot;ndarray[_AnyShape, dtype[Any]]&quot;
      &quot;list[str]&quot; is not assignable to &quot;Index&quot;
      &quot;list[str]&quot; is not assignable to &quot;Series&quot;
      &quot;list[str]&quot; is incompatible with protocol &quot;SequenceNotStr[Unknown]&quot;
        &quot;index&quot; is an incompatible type
          Type &quot;(value: str, start: SupportsIndex = 0, stop: SupportsIndex = sys.maxsize, /) -&gt; int&quot; is not assignable to type &quot;(value: Any, /, start: int = 0, stop: int = ...) -&gt; int&quot;
    ... (reportArgumentType)
</code></pre>
<p>Ultimately the bug is a single mis-placed character in the signature of the <code>index</code> method of pandas' <code>SequenceNotStr</code> type. In <a href="https://github.com/pandas-dev/pandas/blob/2.3.x/pandas/_typing.py#L140">the 2.3.x branch of pandas, that method has this signature</a>:</p>
<pre><code class="language-py">def index(self, value: Any, /, start: int = 0, stop: int = ...) -&gt; int: ...
</code></pre>
<p>Note that the <code>/</code> comes after <code>value</code> parameter, but before <code>start</code> and <code>stop</code>, meaning that <code>start</code> and <code>stop</code> may be passed as keywords.</p>
<p>But <a href="https://github.com/python/typeshed/blob/main/stdlib/builtins.pyi#L1117">in typeshed, the builtin <code>list</code> type has an <code>index</code> method with this signature</a>:</p>
<pre><code class="language-py">def index(self, value: _T, start: SupportsIndex = 0, stop: SupportsIndex = sys.maxsize, /) -&gt; int: ...
</code></pre>
<p>Here the <code>/</code> comes after all the parameters, meaning they are all positional-only; none may be passed as a keyword argument. That discrepancy makes <code>list</code> not assignable to the <code>SequenceNotStr</code> protocol.</p>
<p>This pandas bug has been fixed <a href="https://github.com/pandas-dev/pandas/blob/main/pandas/_typing.py#L124">in the main branch of pandas</a>, and <a href="https://github.com/pandas-dev/pandas-stubs/blob/main/pandas-stubs/_typing.pyi#L106">does not occur in pandas-stubs</a> (which is why installing <code>pandas-stubs</code> fixes the problem).</p>
<p>So closing this as not a bug in ty, though it definitely provides a great example of why we need https://github.com/astral-sh/ty/issues/163, as well as https://github.com/astral-sh/ty/issues/1537.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-11-19 20:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-19 20:53</div>
            <div class="timeline-body"><p>(Oh, and the reason this &quot;worked&quot; on alpha 26 and failed on alpha 27 was simply that alpha 27 added proper validation of method assignability on protocols. So it was really an improvement in ty that caused us to catch this true positive error!)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 02:11:43 UTC
    </footer>
</body>
</html>
