<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gray out unreachable code - astral-sh/ty #784</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Gray out unreachable code</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/784">#784</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-07-08 16:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-08 16:02</div>
            <div class="timeline-body"><p>This can be done by creating a diagnostic with the <code>UnnecessaryCode</code> tag.</p>
<p>Our reachability infrastructure should be powerful enough to support this but recording reachability constraints for every node is probably too expensive and we have to do it at the basic block level instead.</p>
<p>The diagnostic reported by ty should also cover the maximum span that's unreachable instead of having a diagnostic for each node (which would be very verbose. It's worth looking into how other type checker handle this).</p>
<p>There's an UX question for what we want to do about code that is unreachable with the current configuration settings (e.g. for a newer python version). Ideally, this code gets grayed out in the LSP but reporting a diagnostic in the CLI might be annoying (but can be useful to detect code that's no longer revelant after upgrading to a newer Python version)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2025-07-08 16:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/erictraut">@erictraut</a> on 2025-07-08 16:24</div>
            <div class="timeline-body"><p>For reference, <a href="https://github.com/microsoft/pyright/blob/5ba9dcf9802382b4db529221ba353ae3edc597ad/packages/pyright-internal/src/analyzer/checker.ts#L2832">here is the code</a> in pyright that does this. It works roughly like you surmised. Once it discovers an unreachable statement, it extends the range to the last statement in the block.</p>
<p>One consideration: If you plan to also emit a &quot;real&quot; diagnostic (an error or warning) for unreachable code in addition to emitting a &quot;tagged hint&quot; diagnostic, you need to make sure that these diagnostics use different ranges. If the ranges are identical, clients like VS Code will drop (i.e. ignore) the tagged hint. To work around this, pyright adopts a trick from the TypeScript language server. It uses the full range for the tagged hint but uses a much shorter range (corresponding to the the first token of the first statement) for the &quot;real&quot; diagnostic.</p>
<p>Here's how that appears in VS Code:</p>
<p><img width="227" height="96" alt="Image" src="https://github.com/user-attachments/assets/9b789113-7fc2-4245-b4ba-7af6bbb6dfe2" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-08 17:49</div>
            <div class="timeline-body"><p>Just for reference: We have existing tests for this here: https://github.com/astral-sh/ruff/blob/fda188953f9b739e4baf42bad1e88e812d1f1d78/crates/ty_python_semantic/resources/mdtest/unreachable.md?plain=1#L8-L104</p>
<blockquote>
<p>There's an UX question for what we want to do about code that is unreachable with the current configuration settings (e.g. for a newer python version). Ideally, this code gets grayed out in the LSP but reporting a diagnostic in the CLI might be annoying (but can be useful to detect code that's no longer revelant after upgrading to a newer Python version)</p>
</blockquote>
<p>Tests for this are also already available: https://github.com/astral-sh/ruff/blob/fda188953f9b739e4baf42bad1e88e812d1f1d78/crates/ty_python_semantic/resources/mdtest/unreachable.md?plain=1#L106-L203</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/erictraut">@erictraut</a> on 2025-07-08 18:50</div>
            <div class="timeline-body"><blockquote>
<p>There's an UX question for what we want to do about code that is unreachable with the current configuration settings (e.g. for a newer python version).</p>
</blockquote>
<p>For reference, pyright distinguishes between three types of <a href="https://microsoft.github.io/pyright/#/type-concepts-advanced?id=reachability">unreachable code</a>:</p>
<ol>
<li>Structural: due to control flow statements like <code>return</code> and <code>raise</code></li>
<li>Static conditions: based on the use of <a href="https://microsoft.github.io/pyright/#/type-concepts-advanced?id=reachability">statically-evaluated conditional expressions</a> like version or platform checks, <code>TYPE_CHECKING</code>, etc.</li>
<li>Type analysis: based on full type analysis</li>
</ol>
<p>All three of these result in &quot;grayed out&quot; text in the editor, but only categories 1 and 3 generate &quot;unreachable code&quot; diagnostics. I only recently added the &quot;unreachable code&quot; diagnostic, so I haven't received much feedback on it yet. This check is not enabled by default, even in pyright's strict mode, because there are many legitimate cases where unreachable code appears in code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-08 18:56</div>
            <div class="timeline-body"><blockquote>
<p>This check is not enabled by default, even in pyright's strict mode, because there are many legitimate cases where unreachable code appears in code.</p>
</blockquote>
<p>That's interesting. My instinct is that we should at least emit diagnostics by default for category (1). The reason is the amount of confusion I've seen among users of type checkers -- on the mypy issue tracker, on Stack Overflow, and similar -- due to the fact that many errors which would normally be caught by a type checker are (for very good reasons) not emitted on code in unreachable branches. It's often easy to introduce code that would never be reachable by accident; I think users deserve to know that we won't be able to provide a good analysis of those regions of their codebase.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/erictraut">@erictraut</a> on 2025-07-08 19:51</div>
            <div class="timeline-body"><p>Yeah, there are many directions ty could go here. One could even make the argument that category 1 isn't something that a type checker should ever report. It's arguably more of a linter concern.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/DetachHead">@DetachHead</a> on 2025-10-05 11:02</div>
            <div class="timeline-body"><p>IMO unreachable code is almost always unintentional (with the exception of <code>TYPE_CHECKING</code> blocks), and therefore should be an error, not just a greyed out hint.</p>
<p>regarding python version/platform checks, if the type checker considers those unreachable when they aren't, that often means the type checker is wrong. for example:</p>
<pre><code class="language-py">if sys.version_info &lt; (3, 13):
    print(&quot;you are on an old version of python :(&quot;) # error: unreachable
else:
    print(&quot;you're on the latest python version :)&quot;)
</code></pre>
<p>the fact that the developer wrote such a check means they expect their code to be run on more than one python version. but i don't think any of the type checkers currently support this (#1309)</p>
<p>sidenote: it also seems that unlike <a href="https://basedpyright.com/?pythonVersion=3.13&amp;typeCheckingMode=all&amp;code=JYWwDg9gTgLgBAZwJ4IFDuAM0SgdANwFMoFgIA7AfWHMwjgB44AKAZgBo4BGVgSgC5UcYdzgBqOACJJcAMRxiUaPzhRCkWAFVyagIYBjABa6ARgBtCLBPSxwArjsIHj5y-ogATSwHddCcgDk8LrkClBKUJwwhsAIqg4woG5QfoZw3hB2Zh5wAOb07uAWMIRmSPbkXiX6JR68QA">other type checkers</a>, <a href="https://play.ty.dev/b5064cbc-d00d-43d1-ba51-7fc520bc72ab">ty is able to type check unreachable code</a>. i'm not sure if this is intentional (i hope it is) or if this functionality will go away once ty is able to detect unreachable code, but if the latter is the case, that means it's even more important to have the option to report unreachable code as an error because otherwise invvalid code that would normally be caught by the type checker will go undetected.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-05 11:10</div>
            <div class="timeline-body"><blockquote>
<p>sidenote: it also seems that unlike <a href="https://basedpyright.com/?pythonVersion=3.13&amp;typeCheckingMode=all&amp;code=JYWwDg9gTgLgBAZwJ4IFDuAM0SgdANwFMoFgIA7AfWHMwjgB44AKAZgBo4BGVgSgC5UcYdzgBqOACJJcAMRxiUaPzhRCkWAFVyagIYBjABa6ARgBtCLBPSxwArjsIHj5y-ogATSwHddCcgDk8LrkClBKUJwwhsAIqg4woG5QfoZw3hB2Zh5wAOb07uAWMIRmSPbkXiX6JR68QA">other type checkers</a>, <a href="https://play.ty.dev/b5064cbc-d00d-43d1-ba51-7fc520bc72ab">ty is able to type check unreachable code</a>. i'm not sure if this is intentional (i hope it is) or if this functionality will go away once ty is able to detect unreachable code</p>
</blockquote>
<p>We already have the capability to detect unreachable code internally, and we already suppress many diagnostics in code blocks we understand as unreachable (to prevent false-positive errors that would occur when type-checking unreachable code).</p>
<p>As you've spotted, we don't currently suppress <em>all</em> diagnostics in unreachable blocks; there are some diagnostics that we think we can reliably check for even in unreachable blocks. It remains to be seen whether this is sustainable, though, as we're still coming across situations where we can't reliably type-check code in unreachable blocks, and where we'll therefore likely need to suppress our diagnostics more aggressively. See https://github.com/astral-sh/ty/issues/1165 for a recent example.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-06 07:47</div>
            <div class="timeline-body"><blockquote>
<p>sidenote: it also seems that unlike <a href="https://basedpyright.com/?pythonVersion=3.13&amp;typeCheckingMode=all&amp;code=JYWwDg9gTgLgBAZwJ4IFDuAM0SgdANwFMoFgIA7AfWHMwjgB44AKAZgBo4BGVgSgC5UcYdzgBqOACJJcAMRxiUaPzhRCkWAFVyagIYBjABa6ARgBtCLBPSxwArjsIHj5y-ogATSwHddCcgDk8LrkClBKUJwwhsAIqg4woG5QfoZw3hB2Zh5wAOb07uAWMIRmSPbkXiX6JR68QA">other type checkers</a>, <a href="https://play.ty.dev/b5064cbc-d00d-43d1-ba51-7fc520bc72ab">ty is able to type check unreachable code</a>. i'm not sure if this is intentional (i hope it is)</p>
</blockquote>
<p>Our current behavior is intentional, yes. The reasoning is described in this test suite: https://github.com/astral-sh/ruff/blob/main/crates/ty_python_semantic/resources/mdtest/unreachable.md#no-incorrect-diagnostics-in-unreachable-code</p>
<p>This test case demonstrates something very close to your example: https://github.com/astral-sh/ruff/blob/main/crates/ty_python_semantic/resources/mdtest/unreachable.md#emit-diagnostics-for-definitely-wrong-code</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Stable" by @MichaReiser on 2025-11-14 08:39</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 02:11:16 UTC
    </footer>
</body>
</html>
