<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salsa panic for `steam.py` - astral-sh/ty #1377</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Salsa panic for <code>steam.py</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1377">#1377</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-10-17 08:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-17 08:35</div>
            <div class="timeline-body"><p>With the new salsa version merged in https://github.com/astral-sh/ruff/pull/20645 and after adding cycle handing to <code>lazy_default</code>, ty panics in 1/3 of the runs with <code>Provisional memo retry limit exceeded for ... this usually indicates a bug in salsa's cycle caching/locking.</code></p>
<p>The panic seems to be related to multithreading, as I can't reproduce it when running in a single thread (<code>TY_MAX_PARALLELISM=1</code>). Two threads tend to be sufficient to trigger it.</p>
<p>Here a specifc instance of the panic, enriched with the current cycle heads of the query panicking:</p>
<pre><code>Panicked at /Users/micha/astral/salsa/src/function/memo.rs:166:17 when checking `/private/tmp/mypy_primer/projects/steam.py/steam/message.py`: `Provisional retry for memo infer_deferred_types(Id(609b)) exceeded.
Cycle heads: CycleHeads([
    CycleHead { database_key_index: infer_deferred_types(Id(978a)), iteration_count: AtomicIterationCount(2), removed: false }, 
    CycleHead { database_key_index: infer_deferred_types(Id(9782)), iteration_count: AtomicIterationCount(0), removed: false }, 
    CycleHead { database_key_index: TypeVarInstance &lt; 'db &gt;::lazy_default_(Id(5a403)), iteration_count: AtomicIterationCount(0), removed: false },
    CycleHead { database_key_index: TypeVarInstance &lt; 'db &gt;::lazy_bound_(Id(5a404)), iteration_count: AtomicIterationCount(2), removed: false },
    CycleHead { database_key_index: infer_deferred_types(Id(9783)), iteration_count: AtomicIterationCount(2), removed: false }, 
    CycleHead { database_key_index: infer_definition_types(Id(605f)), iteration_count: AtomicIterationCount(2), removed: false }, 
    CycleHead { database_key_index: infer_definition_types(Id(9406)), iteration_count: AtomicIterationCount(1), removed: false }, 
    CycleHead { database_key_index: infer_definition_types(Id(616b)), iteration_count: AtomicIterationCount(0), removed: false }, 
    CycleHead { database_key_index: Type &lt; 'db &gt;::member_lookup_with_policy_(Id(1cc0b)), iteration_count: AtomicIterationCount(0), removed: false }, 
    CycleHead { database_key_index: infer_definition_types(Id(5e4f2)), iteration_count: AtomicIterationCount(1), removed: false }, 
    CycleHead { database_key_index: ClassLiteral &lt; 'db &gt;::explicit_bases_(Id(22406)), iteration_count: AtomicIterationCount(0), removed: false }, 
    CycleHead { database_key_index: Type &lt; 'db &gt;::is_redundant_with_(Id(2bc0d)), iteration_count: AtomicIterationCount(0), removed: false }, 
    CycleHead { database_key_index: infer_definition_types(Id(9787)), iteration_count: AtomicIterationCount(0), removed: false }, 
    CycleHead { database_key_index: TypeVarInstance &lt; 'db &gt;::lazy_bound_(Id(5a400)), iteration_count: AtomicIterationCount(1), removed: false }, 
    CycleHead { database_key_index: ClassLiteral &lt; 'db &gt;::is_typed_dict_(Id(2240d)), iteration_count: AtomicIterationCount(1), removed: false }, 
    CycleHead { database_key_index: ClassLiteral &lt; 'db &gt;::explicit_bases_(Id(2240d)), iteration_count: AtomicIterationCount(1), removed: false }, 
    CycleHead { database_key_index: infer_deferred_types(Id(9419)), iteration_count: AtomicIterationCount(0), removed: false }, 
    CycleHead { database_key_index: TypeVarInstance &lt; 'db &gt;::lazy_bound_(Id(5a402)), iteration_count: AtomicIterationCount(0), removed: false }, 
    CycleHead { database_key_index: infer_deferred_types(Id(9626)), iteration_count: AtomicIterationCount(0), removed: false }, 
    CycleHead { database_key_index: ClassLiteral &lt; 'db &gt;::explicit_bases_(Id(3a007)), iteration_count: AtomicIterationCount(1), removed: false }
])

Cycle { head_iteration_count: IterationCount(1), memo_iteration_count: IterationCount(2), verified_at: R2, database_key_index: ClassLiteral &lt; 'db &gt;::explicit_bases_(Id(3a007)), inner: true },  &lt;-- updated
Cycle { head_iteration_count: IterationCount(0), memo_iteration_count: IterationCount(2), verified_at: R2, database_key_index: infer_deferred_types(Id(9626)), inner: true },  &lt;-- updated
Cycle { head_iteration_count: IterationCount(0), memo_iteration_count: IterationCount(2), verified_at: R2, database_key_index: TypeVarInstance &lt; 'db &gt;::lazy_bound_(Id(5a402)), inner: true },  &lt;-- updated
Cycle { head_iteration_count: IterationCount(0), memo_iteration_count: IterationCount(2), verified_at: R2, database_key_index: infer_deferred_types(Id(9419)), inner: true },  &lt;-- updated
Cycle { head_iteration_count: IterationCount(1), memo_iteration_count: IterationCount(2), verified_at: R2, database_key_index: ClassLiteral &lt; 'db &gt;::explicit_bases_(Id(2240d)), inner: true },  &lt;-- updated
Cycle { head_iteration_count: IterationCount(1), memo_iteration_count: IterationCount(2), verified_at: R2, database_key_index: ClassLiteral &lt; 'db &gt;::is_typed_dict_(Id(2240d)), inner: true },  &lt;-- updated
Cycle { head_iteration_count: IterationCount(1), memo_iteration_count: IterationCount(2), verified_at: R2, database_key_index: TypeVarInstance &lt; 'db &gt;::lazy_bound_(Id(5a400)), inner: false },  &lt;-- updated
Cycle { head_iteration_count: IterationCount(0), memo_iteration_count: IterationCount(2), verified_at: R2, database_key_index: infer_definition_types(Id(9787)), inner: true },  &lt;-- updated
Cycle { head_iteration_count: IterationCount(0), memo_iteration_count: IterationCount(2), verified_at: R2, database_key_index: Type &lt; 'db &gt;::is_redundant_with_(Id(2bc0d)), inner: true }, &lt;-- updated
Cycle { head_iteration_count: IterationCount(0), memo_iteration_count: IterationCount(2), verified_at: R2, database_key_index: ClassLiteral &lt; 'db &gt;::explicit_bases_(Id(22406)), inner: true }, &lt;-- updated
Cycle { head_iteration_count: IterationCount(1), memo_iteration_count: IterationCount(2), verified_at: R2, database_key_index: infer_definition_types(Id(5e4f2)), inner: false },  &lt;-- updated
Cycle { head_iteration_count: IterationCount(0), memo_iteration_count: IterationCount(0), verified_at: R2, database_key_index: Type &lt; 'db &gt;::member_lookup_with_policy_(Id(1cc0b)), inner: false }, 
Cycle { head_iteration_count: IterationCount(0), memo_iteration_count: IterationCount(0), verified_at: R2, database_key_index: infer_definition_types(Id(616b)), inner: false }, 
Cycle { head_iteration_count: IterationCount(1), memo_iteration_count: IterationCount(1), verified_at: R2, database_key_index: infer_definition_types(Id(9406)), inner: false }, 
Cycle { head_iteration_count: IterationCount(2), memo_iteration_count: IterationCount(2), verified_at: R2, database_key_index: infer_definition_types(Id(605f)), inner: false }, 
Cycle { head_iteration_count: IterationCount(2), memo_iteration_count: IterationCount(2), verified_at: R2, database_key_index: infer_deferred_types(Id(9783)), inner: false }, 
Cycle { head_iteration_count: IterationCount(2), memo_iteration_count: IterationCount(2), verified_at: R2, database_key_index: TypeVarInstance &lt; 'db &gt;::lazy_bound_(Id(5a404)), inner: false }, 
Cycle { head_iteration_count: IterationCount(0), memo_iteration_count: IterationCount(0), verified_at: R2, database_key_index: TypeVarInstance &lt; 'db &gt;::lazy_default_(Id(5a403)), inner: false }, 
Cycle { head_iteration_count: IterationCount(0), memo_iteration_count: IterationCount(0), verified_at: R2, database_key_index: infer_deferred_types(Id(9782)), inner: false }, 
Cycle { head_iteration_count: IterationCount(2), memo_iteration_count: IterationCount(2), verified_at: R2, database_key_index: infer_deferred_types(Id(978a)), inner: false }, 

</code></pre>
<p>I don't fully understand what's happening yet but:</p>
<ul>
<li>The query is blocked in <code>blocks_on</code></li>
<li>The query is retried because there are newer memos for some of its cycle heads (they have a different iteration count)</li>
<li>The query re-executes but it ends up with the same outdated cycle heads after every retry. This suggests that salsa returns cached results for its dependencies when it shouldn't.</li>
<li>The query itself isn't a cycle head (but it has cycle handling enabled)</li>
<li>Changing <code>validate_maybe_iterate</code> to recursively fetch the cycle heads seems to fix the issue (why?)</li>
</ul>
<p>... A fixpoint iteration with that many nested cycle heads would never have completed with the old salsa version :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @MichaReiser by @MichaReiser on 2025-10-17 08:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fatal</span> added by @MichaReiser on 2025-10-17 08:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Beta" by @MichaReiser on 2025-10-17 08:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-23 07:47</div>
            <div class="timeline-body"><p>This was fixed in https://github.com/astral-sh/ruff/pull/21038</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-10-23 07:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @MichaReiser on 2025-10-23 08:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-10-24 16:31</div>
            <div class="timeline-body"><p>This should, hopefully, now be fixed for good, see https://github.com/astral-sh/ruff/pull/21059</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-10-24 16:31</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:40:50 UTC
    </footer>
</body>
</html>
