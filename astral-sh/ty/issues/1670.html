<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Non deterministic diagnostics - astral-sh/ty #1670</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Non deterministic diagnostics</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1670">#1670</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-11-28 21:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Ecosystem reports now often show flaky diffs, for example https://github.com/astral-sh/ruff/pull/21595#issuecomment-3568122741. Sometimes it's flaky diagnostics, sometimes it's only the ordering of union elements that changes between runs.</p>
<p>This has become more prevalent since https://github.com/astral-sh/ruff/pull/20566 landed.</p>
<p>We need deterministic diagnostic output (including messages) for GitLab output reports (or baselines)</p>
<p>A PR fixing the instability should also enable the CI job added in https://github.com/astral-sh/ruff/pull/21864, demonstrating that the instability is fixed</p>
<h3>Version</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Stable" by @MichaReiser on 2025-11-28 21:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2025-11-28 21:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mtshiba">@mtshiba</a> on 2025-11-29 03:21</div>
            <div class="timeline-body"><p>The simplest solution is to sort the union types in the cycle recovery function. We can also do this for recursively defined types only, as in https://github.com/astral-sh/ruff/pull/21683.</p>
<p>But honestly, I don't really understand why this happens. Is it a flaw in our implementation, as in https://github.com/astral-sh/ruff/pull/20966, or is it a salsa specification or bug? It seems I need to look into this in more detail.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-29 14:53</div>
            <div class="timeline-body"><p>Some notes from our internal Discord channel on why this might be happening https://discord.com/channels/1039017663004942429/1443381998100938783/1443492249307582484</p>
<p>I don't think this is a Salsa bug. It's just that some queries are execution order dependent and there's no deterministic execution order for cycles (because they can be entered from many different queries, running on multiple threads at the same time)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Stable" by @MichaReiser on 2025-12-31 16:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Pre-stable 1" by @MichaReiser on 2025-12-31 16:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @carljm by @carljm on 2026-01-09 15:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @mtshiba by @carljm on 2026-01-09 15:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @oconnor663 by @carljm on 2026-01-09 15:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @carljm by @carljm on 2026-01-09 15:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:21:05 UTC
    </footer>
</body>
</html>
