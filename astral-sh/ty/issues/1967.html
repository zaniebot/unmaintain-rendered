<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prefer *-stubs when finding packages - astral-sh/ty #1967</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Prefer *-stubs when finding packages</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1967">#1967</a>
        opened by <a href="https://github.com/Boon-in-Oz">@Boon-in-Oz</a>
        on 2025-12-16 23:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Boon-in-Oz">@Boon-in-Oz</a></div>
            <div class="timeline-body"><p>Hi, this is going to be a hand-wavy issue, sorry.</p>
<p>I&#x27;m excited to try ty over Pylance in VS Code. I&#x27;ve immediately run into an issue though.</p>
<p>I run VS Code, and my module, in a Rez environment. I have a wrapped C++ package (a binary called ape.pyd) that I use a lot, which has custom stubs package called ape-stubs. In the Rez environment, PYTHONPATH contains the directories for both the package containing the ape.pyd, and the directory containing ape-stubs, but the pyd directory comes first.</p>
<p>With Pyright/Pylance this used to work. ape-stubs was used for autocompletion etc. However ty appears to be using ape.pyd, and it&#x27;s not finding any of the useful information in the stubs.</p>
<p>I set the log level to &quot;trace&quot; and saw this in the output (I&#x27;m filtering by &quot;ape&quot;, and I&#x27;ve condensed the file paths. Also as you can see I have a directory junction from C to S):</p>
<pre><code>2025-12-17 10:22:04.872486000 DEBUG ty:main ty_project::metadata::options: Adding `c:\path_to_pyd\packages\ape\1.0\python-3.10` from the `PYTHONPATH` environment variable to `extra_paths`
2025-12-17 10:22:04.872533100 DEBUG ty:main ty_project::metadata::options: Adding `c:\path_to_stubs` from the `PYTHONPATH` environment variable to `extra_paths`
...
2025-12-17 10:22:04.876326600 DEBUG ty:main ty_python_semantic::module_resolver::resolver: Adding extra search-path `S:\path_to_pyd\packages\ape\1.0\python-3.10`
2025-12-17 10:22:04.876435300 DEBUG ty:main ty_python_semantic::module_resolver::resolver: Adding extra search-path `S:\path_to_stubs`
...
2025-12-17 10:22:04.882233300 DEBUG ty:main ruff_db::files::file_root: Adding new file root &#x27;S:\path_to_pyd\packages\ape\1.0\python-3.10&#x27; of kind LibrarySearchPath
2025-12-17 10:22:04.882242200 DEBUG ty:main ruff_db::files::file_root: Adding new file root &#x27;S:\path_to_stubs&#x27; of kind LibrarySearchPath
...
2025-12-17 10:22:04.885231400 DEBUG ty:main ty_python_semantic::module_resolver::resolver: Adding editable installation to module resolution path S:\path_above_stubs
2025-12-17 10:22:04.885242800 DEBUG ty:main ruff_db::files::file_root: Adding new file root &#x27;S:\path_above_stubs&#x27; of kind LibrarySearchPath
</code></pre>
<p>I <em>think</em> the language server should see that it has a package called <code>ape</code> in a search path, and <code>ape-stubs</code> in a later search path, and prefer <code>ape-stubs</code> even though it found <code>ape</code> first.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-12-16 23:52</div>
            <div class="timeline-body"><p>Our code does first search every search-path for a stub, and only then if it fails searches for non-stubs. So whatever&#x27;s happening here is us getting confused and not finding ape-stubs at all.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-12-16 23:59</div>
            <div class="timeline-body"><p>I&#x27;m certainly suspicious that the junction&#x27;s making us get confused. I&#x27;m also suspicious about the fact that <code>S:\path_to_stubs</code> and <code>S:\path_above_stubs</code> are both things you list in your output. That&#x27;s a common recipe for us getting confused (<a href="https://github.com/astral-sh/ty/issues/1730">astral-sh/ty#1730</a>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">imports</span> added by <a href="https://github.com/Gankra">@Gankra</a> on 2025-12-17 00:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/Gankra">@Gankra</a> on 2025-12-17 00:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Boon-in-Oz">@Boon-in-Oz</a> on 2025-12-17 01:06</div>
            <div class="timeline-body"><p>Thanks for that info. I can attempt some other things to see if I can narrow the junction part down, at least. Regarding that, the recent  change to the VS Code &quot;python.locator&quot; broke the PyLance language server for me and I have to use the setting <code>&quot;python.locator&quot;: &quot;js&quot;</code> (rather than <code>native</code>) for that to work correctly.</p>
<p>Regarding the path I labeled as <code>path_above_stubs</code>, I&#x27;m not sure where that is coming from. It is the directory above <code>path_to_stubs</code> (in case my shorthand is confusing). It might be coming from somewhere else in my environment that I&#x27;ve missed, but it doesn&#x27;t have the associated line with &quot;from the <code>PYTHONPATH</code> environment variable&quot; in the log like the other paths do.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-12-17 01:12</div>
            <div class="timeline-body"><p>The logs suggest that <code>path_above_stubs</code> is an editable installed into your venv</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Boon-in-Oz">@Boon-in-Oz</a> on 2025-12-17 02:15</div>
            <div class="timeline-body"><p>You&#x27;re correct, thanks. It&#x27;s in a .pth file. I removed it and while those lines are now gone from the log, the problem of not using the stubs remains.</p>
<p>I have also managed to run my VS Code in a Rez environment build entirely from my S: drive, with no junctions, and I&#x27;m still getting the problem. Here&#x27;s a new log summary:</p>
<pre><code>2025-12-17 12:58:17.494912000 DEBUG ty:main ty_project::metadata::options: Adding `s:\path_to_pyd\packages\ape\1.0\python-3.10` from the `PYTHONPATH` environment variable to `extra_paths`
2025-12-17 12:58:17.494946300 DEBUG ty:main ty_project::metadata::options: Adding `S:\path_to_stubs` from the `PYTHONPATH` environment variable to `extra_paths`
...
2025-12-17 12:58:17.497297200 DEBUG ty:main ty_python_semantic::module_resolver::resolver: Adding extra search-path `S:\path_to_pyd\packages\ape\1.0\python-3.10`
2025-12-17 12:58:17.497379900 DEBUG ty:main ty_python_semantic::module_resolver::resolver: Adding extra search-path `S:\path_to_stubs`
...
2025-12-17 12:58:17.500628200 DEBUG ty:main ty_python_semantic::module_resolver::resolver: Using vendored stdlib
2025-12-17 12:58:17.500930300 DEBUG ty:main ty_python_semantic::module_resolver::resolver: Adding site-packages search path `S:\...\python3.10.11\Lib\site-packages`
2025-12-17 12:58:17.500994500  INFO ty:main ty_project::metadata::options: Python version: Python 3.10, platform: win32
...
2025-12-17 12:58:17.501120000 DEBUG ty:main ruff_db::files::file_root: Adding new file root &#x27;S:\path_to_pyd\packages\ape\1.0\python-3.10&#x27; of kind LibrarySearchPath
2025-12-17 12:58:17.501128900 DEBUG ty:main ruff_db::files::file_root: Adding new file root &#x27;S:\path_to_stubs&#x27; of kind LibrarySearchPath
...
2025-12-17 12:58:17.501762600 DEBUG ty:main ty_server::session: Registering diagnostic capability with OpenFilesOnly diagnostic mode
2025-12-17 12:58:17.501810100 DEBUG ty:main ty_python_semantic::module_resolver::resolver: Resolving dynamic module resolution paths
2025-12-17 12:58:17.502208600 DEBUG ty:main ty_python_semantic::module_resolver::resolver: Adding editable installation to module resolution path ...
...
2025-12-17 12:58:17.506657700 DEBUG ty:main ty_server::server::main_loop: Processing deferred notification `textDocument/didOpen`
2025-12-17 12:58:17.506685500  INFO ty:main notification{method=&quot;textDocument/didOpen&quot;}: ty_server::session: Initializing the default project
2025-12-17 12:58:17.507848300  INFO ty:main notification{method=&quot;textDocument/didOpen&quot;}: ty_project::metadata::options: Defaulting to python-platform `win32`
...
2025-12-17 12:58:17.508598800 DEBUG ty:main notification{method=&quot;textDocument/didOpen&quot;}: ty_project::metadata::options: Adding `s:\path_to_pyd\packages\ape\1.0\python-3.10` from the `PYTHONPATH` environment variable to `extra_paths`
2025-12-17 12:58:17.508630500 DEBUG ty:main notification{method=&quot;textDocument/didOpen&quot;}: ty_project::metadata::options: Adding `S:\path_to_stubs` from the `PYTHONPATH` environment variable to `extra_paths`
...
2025-12-17 12:58:17.510881800 DEBUG ty:main notification{method=&quot;textDocument/didOpen&quot;}: ty_python_semantic::module_resolver::resolver: Adding extra search-path `S:\path_to_pyd\packages\ape\1.0\python-3.10`
2025-12-17 12:58:17.510964100 DEBUG ty:main notification{method=&quot;textDocument/didOpen&quot;}: ty_python_semantic::module_resolver::resolver: Adding extra search-path `S:\path_to_stubs`
...
2025-12-17 12:58:17.514290600 DEBUG ty:main notification{method=&quot;textDocument/didOpen&quot;}: ty_python_semantic::module_resolver::resolver: Using vendored stdlib
2025-12-17 12:58:17.514540400  INFO ty:main notification{method=&quot;textDocument/didOpen&quot;}: ty_project::metadata::options: Python version: Python 3.14, platform: win32
...
2025-12-17 12:58:17.514664700 DEBUG ty:main notification{method=&quot;textDocument/didOpen&quot;}: ruff_db::files::file_root: Adding new file root &#x27;S:\path_to_pyd\packages\ape\1.0\python-3.10&#x27; of kind LibrarySearchPath
2025-12-17 12:58:17.514673400 DEBUG ty:main notification{method=&quot;textDocument/didOpen&quot;}: ruff_db::files::file_root: Adding new file root &#x27;S:\path_to_stubs&#x27; of kind LibrarySearchPath
</code></pre>
<p>I&#x27;ve attached a full log, similarly redacted.</p>
<p><a href="https://github.com/user-attachments/files/24203119/vscode_ty_log_launch_from_s.txt">vscode_ty_log_launch_from_s.txt</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Boon-in-Oz">@Boon-in-Oz</a> on 2025-12-17 02:25</div>
            <div class="timeline-body"><p>As an experiment, I copied the <code>ape-stubs</code> directory from <code>S:\path_to_stubs</code> to <code>s:\path_to_pyd\packages\ape\1.0\python-3.10</code>, and ty now reads the stubs correctly. I&#x27;m not sure if that will be a possible long-term fix for us, but hopefully it tells you more about the problem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-18 10:09</div>
            <div class="timeline-body"><p>I think the issue here is simply the ordering of the paths. Could you try changing <code>PYTHONPATH</code> so that the stubs path comes before <code>S:\path_to_pyd\packages\ape\1.0\python-3.10</code> (which should make ty try the stubs path first)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Boon-in-Oz">@Boon-in-Oz</a> on 2025-12-18 20:31</div>
            <div class="timeline-body"><p>I don&#x27;t think that&#x27;s an option for me, because my PYTHONPATH is built by Rez.</p>
<p>I think the language server should see that it has a package called ape in a search path, and ape-stubs in a later search path, and prefer ape-stubs even though it found ape first. That appears to be how PyRight does it, anyhow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-24 00:09</div>
            <div class="timeline-body"><p>I think @Boon-in-Oz has the right analysis here. According to https://typing.python.org/en/latest/spec/distributing.html#import-resolution-ordering a <code>foo-stubs</code> package should always take priority over a <code>foo</code> package, regardless of search path ordering. It looks like we implemented this wrong: we are going search-path-entry by search-path-entry looking first for <code>foo-stubs</code> and then for <code>foo</code>, where instead we need to hoist the <code>-stubs</code> handling out to the top level: first try an entire resolve (on all search paths) for <code>foo-stubs</code>, and then for <code>foo</code>.</p>
<p>Here is a playground that should type-check cleanly but currently doesn&#x27;t: https://play.ty.dev/64f64de3-bd08-4007-ac1f-7899d91b5c48</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Stable&quot; by <a href="https://github.com/carljm">@carljm</a> on 2025-12-24 00:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-24 07:23</div>
            <div class="timeline-body"><blockquote>
<p>According to <a href="https://typing.python.org/en/latest/spec/distributing.html#import-resolution-ordering">typing.python.org/en/latest/spec/distributing.html#import-resolution-ordering</a> a foo-stubs package should always take priority over a foo package, regardless of search path ordering.</p>
</blockquote>
<p>If I understand the spec correctly that&#x27;s only the case for third-party search paths (and they should be ignored for first-party or extra-paths?).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-27 19:31</div>
            <div class="timeline-body"><blockquote>
<p>If I understand the spec correctly that&#x27;s only the case for third-party search paths (and they should be ignored for first-party or extra-paths?).</p>
</blockquote>
<p>Yeah, it looks like that is the intent of the spec. Would be interesting to see what other type checkers actually do here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BryceBeagle">@BryceBeagle</a> on 2026-01-15 19:24</div>
            <div class="timeline-body"><p>I believe that we&#x27;re also encountering this -- we&#x27;re using Bazel to execute <code>ty</code> and are making use of <code>--extra-search-path</code> to dynamically add 3rd party packages to the search path.</p>
<p>Because Bazel/<a href="https://github.com/bazel-contrib/rules_python"><code>rules_python</code></a> does not set up a true Python virtual environment, I&#x27;m not aware of any other way to do this dynamically. We didn&#x27;t have to do this special magic with <code>mypy</code> because it&#x27;s a Python process and we just fiddled with <code>PYTHONPATH</code>/<code>sys.path</code> directly at start-up.</p>
<pre><code>bazel-out/darwin_arm64-opt-exec-ST-a828a81199fe/bin/external/com_github__astral-sh__ty/ty-aarch64-apple-darwin/ty check \
      --python external/python_3_10_aarch64-apple-darwin/bin/python3 \
      --python-version 3.10 \
      --color=always \
      --extra-search-path external/pypi_root_darwin_arm64_protobuf/site-packages \
      --extra-search-path external/pypi_root_darwin_arm64_grpcio/site-packages \
      --extra-search-path external/pypi_root_darwin_arm64_typing_extensions/site-packages \
      --extra-search-path external/pypi_root_darwin_arm64_nexus_rpc/site-packages \
      --extra-search-path external/pypi_root_darwin_arm64_six/site-packages \
      --extra-search-path external/pypi_root_darwin_arm64_python_dateutil/site-packages \
      --extra-search-path external/pypi_root_darwin_arm64_types_protobuf/site-packages \
...
      --extra-search-path external/pypi_root_darwin_arm64_pyjwt/site-packages \
      --extra-search-path external/pypi_root_darwin_arm64_datadog/site-packages \
      --extra-search-path external/pypi_root_darwin_arm64_pyyaml/site-packages \
      foobar/__init__.py \
      foobar/blah__client_pb2.py \
      foobar/blah_pb2.py \
      foobar/blah_worker_pb2.py \
      foobar/blah_pb2.pyi
</code></pre>
<p>The problem is that (unless I manually give some packages priority) the order of 3rd party packages originates from <a href="https://bazel.build/extending/depsets#order">Bazel&#x27;s internal <code>depset</code> traversal algorithm</a>. And sometimes it selects the ~normal package (in this case <code>protobuf</code>) before the stubs package (in this case <code>types_protobuf</code>), resulting in errors</p>
<pre><code>error[unresolved-attribute]: Module `google.protobuf.timestamp_pb2` has no member `Timestamp`
    --&gt; foobar/blah_pb2.pyi:1845:29
     |
1843 |     def retried_things(self) -&gt; google.protobuf.internal.containers.RepeatedScalarFieldContainer[builtins.str]: ...
1844 |     @property
1845 |     def started_at(self) -&gt; google.protobuf.timestamp_pb2.Timestamp: ...
     |                             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
1846 |     def __init__(
1847 |         self,
     |
info: rule `unresolved-attribute` is enabled by default
</code></pre>
<p>What I&#x27;ve done to get around this is have a hardcoded list of &quot;known stubs packages&quot; that I ensure get enumerated with <code>--extra-search-path</code> first when we construct the CLI args. But ideally I wouldn&#x27;t have to do this</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:26:27 UTC
    </footer>
</body>
</html>
