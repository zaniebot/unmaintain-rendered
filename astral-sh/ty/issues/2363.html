<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intersection of `~type` and `~Callable[..., Unknown]` fails `all_type_pairs_are_assignable_to_their_union` - astral-sh/ty #2363</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Intersection of <code>~type</code> and <code>~Callable[..., Unknown]</code> fails <code>all_type_pairs_are_assignable_to_their_union</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/2363">#2363</a>
        opened by <a href="https://github.com/github-actions">@github-actions</a>
        on 2026-01-06 12:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/github-actions">@github-actions</a></div>
            <div class="timeline-body"><p>Run listed here: https://github.com/astral-sh/ty/actions/runs/20747681194</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2026-01-06 12:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">type properties</span> added by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2026-01-06 12:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-06 12:21</div>
            <div class="timeline-body"><pre><code>failures:

---- types::property_tests::stable::all_type_pairs_are_assignable_to_their_union stdout ----

Failing types were:
~type &amp; ~Literal[b&quot;&quot;] &amp; ~((...) -&gt; Unknown)
~type | &lt;class &#x27;ABC&#x27;&gt;

Failing types were:
~type &amp; ~((...) -&gt; Unknown)
~type | &lt;class &#x27;ABC&#x27;&gt;

Failing types were:
~type &amp; ~((...) -&gt; Unknown)
~type | &lt;class &#x27;ABC&#x27;&gt;

Failing types were:
~type &amp; ~((...) -&gt; Unknown)
~type

thread &#x27;types::property_tests::stable::all_type_pairs_are_assignable_to_their_union&#x27; (4472) panicked at /home/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/quickcheck-1.0.3/src/tester.rs:165:28:
[quickcheck] TEST FAILED. Arguments: (Intersection { pos: [], neg: [BuiltinInstance(&quot;type&quot;), Callable { params: GradualForm, returns: None }] }, Intersection { pos: [], neg: [BuiltinInstance(&quot;type&quot;)] })

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-06 12:21</div>
            <div class="timeline-body"><pre><code>failures:

---- types::property_tests::stable::all_type_pairs_are_assignable_to_their_union stdout ----

&lt;-- snip --&gt;

Failing types were:
~type &amp; ~((...) -&gt; Unknown)
~type

thread &#x27;types::property_tests::stable::all_type_pairs_are_assignable_to_their_union&#x27; (4472) panicked at /home/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/quickcheck-1.0.3/src/tester.rs:165:28:
[quickcheck] TEST FAILED. Arguments: (Intersection { pos: [], neg: [BuiltinInstance(&quot;type&quot;), Callable { params: GradualForm, returns: None }] }, Intersection { pos: [], neg: [BuiltinInstance(&quot;type&quot;)] })
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-06 12:36</div>
            <div class="timeline-body"><p>I&#x27;m struggling to reproduce this. All these assertions pass for me <a href="https://play.ty.dev/f1b722bb-c296-4ef5-b694-fe24fefdb9cd">in the playground</a>:</p>
<pre><code>from ty_extensions import Not, Intersection, is_assignable_to, Unknown, static_assert
from typing import Callable, reveal_type

static_assert(is_assignable_to(Not[type], Not[type] | Intersection[Not[type], Not[Callable[..., Unknown]]]))
static_assert(is_assignable_to(Not[type], Intersection[Not[type], Not[Callable[..., Unknown]]] | Not[type]))
static_assert(is_assignable_to(Not[type], Not[type] | Intersection[Not[Callable[..., Unknown]], Not[type]]))
static_assert(is_assignable_to(Not[type], Intersection[Not[Callable[..., Unknown]], Not[type]] | Not[type]))

static_assert(is_assignable_to(Intersection[Not[type], Not[Callable[..., Unknown]]], Not[type] | Intersection[Not[type], Not[Callable[..., Unknown]]]))
static_assert(is_assignable_to(Intersection[Not[Callable[..., Unknown]], Not[type]], Not[type] | Intersection[Not[Callable[..., Unknown]], Not[type]]))
static_assert(is_assignable_to(Intersection[Not[type], Not[Callable[..., Unknown]]], Intersection[Not[type], Not[Callable[..., Unknown]]] | Not[type]))
static_assert(is_assignable_to(Intersection[Not[Callable[..., Unknown]], Not[type]], Intersection[Not[Callable[..., Unknown]], Not[type]] | Not[type]))

type A = Not[type]
type B = Intersection[Not[type], Not[Callable[..., Unknown]]]

static_assert(is_assignable_to(A, A | B))
static_assert(is_assignable_to(A, B | A))
static_assert(is_assignable_to(B, A | B))
static_assert(is_assignable_to(B, B | A))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2026-01-06 18:16</div>
            <div class="timeline-body"><p>It looks like the bug is specific to callable types with no return annotation (as distinct from callable types with an explicit return annotation of <code>Unknown</code>). Apparently this makes a difference somewhere, even though these should be equivalent and we display them the same. So it requires <code>CallableTypeOf</code> to <a href="https://play.ty.dev/0695b057-1336-4ef5-afc9-d93319f4f6aa">reproduce in Python</a>:</p>
<pre><code>from ty_extensions import static_assert, is_assignable_to, Intersection, Not, Unknown, CallableTypeOf
from typing import Callable

# This passes because `Callable[..., Unknown]` has an explicit Unknown return type
static_assert(is_assignable_to(Intersection[Not[type], Not[Callable[..., Unknown]]], Not[type]))

# Function with no return annotation (has implicit Unknown return type internally)
def no_return_annotation(*args, **kwargs): ...

# This fails:
static_assert(is_assignable_to(Intersection[Not[type], Not[CallableTypeOf[no_return_annotation]]], Not[type]))
</code></pre>
<p>(Full disclosure, Claude tracked this down)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-06 18:25</div>
            <div class="timeline-body"><p>Looks like a regression introduced in ty@0.0.7; the assertion passes on ty@0.0.6.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-06 18:29</div>
            <div class="timeline-body"><p>The regression bisects to <a href="https://github.com/astral-sh/ruff/pull/22145">astral-sh/ruff#22145</a> -- cc. @charliermarsh</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2026-01-06 18:31</div>
            <div class="timeline-body"><p>I&#x27;ve already got Claude working on a fix</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-06 18:36</div>
            <div class="timeline-body"><p>It seems like quite the footgun that we represent &quot;no return type&quot; differently to &quot;explicitly returns <code>Unknown</code>&quot;, honestly -- is there any reason for that?</p>
<p>Skimming through places where the <code>Signature::return_ty</code> field is accessed, I think I can see ~5 possible bugs or so due to us incorrectly treating &quot;no return type&quot; differently to &quot;explicitly returns <code>Unknown</code>&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2026-01-06 18:43</div>
            <div class="timeline-body"><p>I remember debating about it in the early days of callable signature representation. I don&#x27;t think there was a strong reason -- it seemed better not to throw away information, but probably it would be better to throw it away, if it should never make a difference.</p>
<p>It looks like the bug here has to do with materialization of a callable with (Rust) <code>None</code> return not being handled correctly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Daily property test run failed on Tue Jan 06 2026&quot; to &quot;Intersection of `~type` and `~Callable[..., Unknown]` fails `all_type_pairs_are_assignable_to_their_union`&quot; by <a href="https://github.com/carljm">@carljm</a> on 2026-01-06 18:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2026-01-06 18:49</div>
            <div class="timeline-body"><p>I have a narrow fix working here for the materialization problem -- before I put it up, going to try the broader fix of making the return type non-optional and eagerly inserting <code>Unknown</code> for no-return-annotation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2026-01-07 00:58</div>
            <div class="timeline-body"><blockquote>
<p>I think I can see ~5 possible bugs or so</p>
</blockquote>
<p>You were not wrong. I&#x27;ve so far discovered two additional bugs fixed by <a href="https://github.com/astral-sh/ruff/pull/22425">astral-sh/ruff#22425</a>, and added tests for them. So the count stands at 3; we&#x27;ll see if I get to 5.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2026-01-07 17:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:26:58 UTC
    </footer>
</body>
</html>
