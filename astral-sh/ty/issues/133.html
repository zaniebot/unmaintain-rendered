<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model implicit imports of submodules, if it occurs in a parent module __init__.py - astral-sh/ty #133</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Model implicit imports of submodules, if it occurs in a parent module <strong>init</strong>.py</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/133">#133</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-04-08 13:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-08 13:11</div>
            <div class="timeline-body"><p>Consider the following case <strong>(<a href="https://playknot.ruff.rs/68b7810b-06b5-4914-b0a2-8bc1d5513181">playground</a>):</strong></p>
<p><code>main.py</code></p>
<pre><code class="language-py">import module

# Missing explicit import of submodule:
# import module.submodule

print(module.submodule.SubmoduleClass)
</code></pre>
<p><code>module/__init__.py</code></p>
<pre><code class="language-py">from module.submodule import SubmoduleClass
</code></pre>
<p><code>module/submodule.py</code></p>
<pre><code class="language-py">class SubmoduleClass: ...
</code></pre>
<p>This works at runtime due to a quirk in module resolution (the <code>from module.submodule import SubmoduleClass</code> import implicitly stores <code>submodule</code> as an attribute on <code>module</code>, thanks @AlexWaygood).</p>
<p>It is not considered good practice to rely on this, but people will probably write code that does so. Neither pyright nor mypy report any errors here. Should we attempt to model this behavior as well?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-04-09 13:44</div>
            <div class="timeline-body"><p>Do mypy/pyright emit errors on the same scenario, but without the submodule import in <code>__init__.py</code>?</p>
<p>That is, are they actually modeling the import side effect, or are they simply failing to catch this category of error altogether?</p>
<p>~~My feeling is that the code as written only works by non-local &quot;accident&quot;, and there is only upside to requiring an explicit import of the submodule in the module where it is used. So I like our current behavior.~~</p>
<p>EDIT: On further reflection, I think there could be a case for handling this, specifically in the case shown where the module's own <code>__init__.py</code> always imports the submodule. This is more robust than the general case, and more plausible for us to detect.</p>
<p>The more general case is that this scenario can occur, and work at runtime, with the submodule import located literally anywhere in the codebase, as long as it's in a module that happens to get imported before the submodule access in <code>main.py</code> occurs. But this is extremely fragile, as order of imports can easily change unintentionally. I don't think we should (or can) handle that general case. The only way we could, I think, would be to always assume all submodules are available as attributes. That is, give up on catching this class of error entirely.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-09 17:31</div>
            <div class="timeline-body"><p><em>With</em> the <code>from module.submodule import SubmoduleClass</code> import in <code>module/__init__.py</code>:</p>
<ul>
<li>Mypy: no error</li>
<li>Pyright: main.py:6:14 - error: &quot;submodule&quot; is not a known attribute of module &quot;module&quot;</li>
<li>Red Knot: main.py:6:7: Type <code>&lt;module 'module'&gt;</code> has no attribute <code>submodule</code></li>
</ul>
<p><em>Without</em> the <code>from module.submodule import SubmoduleClass</code> import in <code>module/__init__.py</code>:</p>
<ul>
<li>Exactly the same behavior for all type checkers</li>
</ul>
<hr />
<p>I might have only tried mpyp in the original example. It seems like we are consistent with pyright here. And it seems like <code>mypy</code> simply doesn't aim to catch this category of error. So it seems like we can maybe just close this without changing anything?</p>
<blockquote>
<p>EDIT: On further reflection, I think there could be a case for handling this, specifically in the case shown where the module's own <code>__init__.py</code> always imports the submodule. This is more robust than the general case, and more plausible for us to detect.</p>
</blockquote>
<p>üëç</p>
<blockquote>
<p>The more general case is that this scenario can occur, and work at runtime, with the submodule import located literally anywhere in the codebase, as long as it's in a module that happens to get imported before the submodule access in <code>main.py</code> occurs. But this is extremely fragile, as order of imports can easily change unintentionally.</p>
</blockquote>
<p>Do not remind me of my C++ times!</p>
<blockquote>
<p>I don't think we should (or can) handle that general case.</p>
</blockquote>
<p>Absolutely. In this case, the diagnostic would technically be a &quot;false positive&quot; (it &quot;works&quot; at runtime), but is arguably serving a purpose. Because it allows you to find missing explicit imports that might end up causing trouble.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-09 17:35</div>
            <div class="timeline-body"><blockquote>
<p>Absolutely. In this case, the diagnostic would technically be a &quot;false positive&quot; (it &quot;works&quot; at runtime), but is arguably serving a purpose. Because it allows you to find missing explicit imports that might end up causing trouble.</p>
</blockquote>
<p>I suppose we could add a subdiagnostic (or at least detailed documentation) explaining this point. I agree that this is a case where I'd personally prefer the false positive over the false negative, but it could be confusing to users that the attribute access &quot;works fine at runtime&quot; but we emit a diagnostic about it anyway</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Model implicit imports of submodules?" to "[red-knot] Model implicit imports of submodules, if it occurs in a parent module __init__.py" by @carljm on 2025-04-09 17:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Model implicit imports of submodules, if it occurs in a parent module __init__.py" to "[red-knot] Model implicit imports of submodules, if it occurs in a parent module __init__.py?" by @carljm on 2025-04-09 17:53</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-04-09 17:53</div>
            <div class="timeline-body"><p>I edited the issue title to reflect (I think) our agreement on what we would change here, if we change anything at all. But I'm comfortable changing nothing at all unless real-world false-positive data convinces us to make this a priority over other things.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Model implicit imports of submodules, if it occurs in a parent module __init__.py?" to "Model implicit imports of submodules, if it occurs in a parent module __init__.py?" by @MichaReiser on 2025-05-07 15:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-10 17:27</div>
            <div class="timeline-body"><p>I just closed https://github.com/astral-sh/ty/issues/313 as a duplicate of this issue. I think we should make the suggested change here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">imports</span> added by @AlexWaygood on 2025-05-10 18:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">runtime semantics</span> added by @AlexWaygood on 2025-05-11 07:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Model implicit imports of submodules, if it occurs in a parent module __init__.py?" to "Model implicit imports of submodules, if it occurs in a parent module __init__.py" by @carljm on 2025-05-19 19:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Beta" by @carljm on 2025-06-11 00:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-07-01 00:30</div>
            <div class="timeline-body"><p>Example case that should work after <code>uv add msgspec</code>:</p>
<pre><code class="language-py">import msgspec

msgspec.json.decode
</code></pre>
<p>Should not emit <code>unresolved-attribute</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/erictraut">@erictraut</a> on 2025-07-01 00:39</div>
            <div class="timeline-body"><blockquote>
<p>Do mypy/pyright emit errors on the same scenario, but without the submodule import in <code>__init__.py</code>?</p>
</blockquote>
<p>Mypy seems to be a bit inconsistent here ‚Äî¬†or I wasn't able to discern the logic behind its choices. With pyright, I tried to be deliberate and principled about which cases I modeled and which I did not. These choices and the reasoning behind them are documented <a href="https://microsoft.github.io/pyright/#/import-statements">here</a> if you're interested.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-07-01 00:42</div>
            <div class="timeline-body"><p>I think this issue corresponds to adding support for item number 2 under &quot;implicit module loads&quot; in the pyright doc?</p>
<p>Except the doc (and @sharkdp 's test above) suggests that pyright might be particular about the import in <code>__init__.py</code> using the specific syntactic form <code>from .a import b</code> (rather than e.g. <code>from module.a import b</code>)? I'm not sure I see a strong case for distinguishing those two, if they resolve to the same submodule.</p>
<p>Other than that, pyright's choices look good to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-07-14 17:22</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>Do mypy/pyright emit errors on the same scenario, but without the submodule import in <code>__init__.py</code>?</p>
</blockquote>
<p>Mypy seems to be a bit inconsistent here ‚Äî or I wasn't able to discern the logic behind its choices. With pyright, I tried to be deliberate and principled about which cases I modeled and which I did not. These choices and the reasoning behind them are documented <a href="https://microsoft.github.io/pyright/#/import-statements">here</a> if you're interested.</p>
</blockquote>
<p>I agree mypy's logic around this is hard to reason about from a user's perspective. There is a consistent logic of some form being applied, however -- @brianschubert gave a great explanation of how it approaches this issue in https://github.com/python/typeshed/issues/14246#issuecomment-2959398061</p>
<p>I also prefer pyright's choices overall on this matter</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @Gankra by @carljm on 2025-08-15 14:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Gankra on 2025-10-31 14:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-31 14:45</div>
            <div class="timeline-body"><p>Reopening this since the originally reported issue described in https://github.com/astral-sh/ty/issues/133#issue-3046355761 isn't yet fixed (and we should still consider adding support for it)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @AlexWaygood on 2025-10-31 14:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-10-31 15:26</div>
            <div class="timeline-body"><p>Note: Fixing the originally reported issue should probably <em>not</em> be done with available_submodule_attributes, and instead just, more correct handling of the effects of <code>from..import</code> in .py files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-10-31 17:49</div>
            <div class="timeline-body"><blockquote>
<p>Reopening this since the originally reported issue described in <a href="https://github.com/astral-sh/ty/issues/133#issue-3046355761">#133 (comment)</a> isn't yet fixed (and we should still consider adding support for it)</p>
</blockquote>
<p>My understanding here is a bit stronger than &quot;we should still consider&quot; -- I think we have already considered it, and it is clear that we should support it, and we should aim to do it for the beta. (That's actually the problem that I thought we were prioritizing for the beta by prioritizing this issue, but it seems like several similar problems got conflated in this issue, and we ended up focusing on a different one first.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danielhollas">@danielhollas</a> on 2025-10-31 17:59</div>
            <div class="timeline-body"><blockquote>
<p>My understanding here is a bit stronger than &quot;we should still consider&quot;</p>
</blockquote>
<p>Just a random note &quot;from the field&quot;: This issue is currently the biggest source of false positives in our codebases. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-10-31 18:22</div>
            <div class="timeline-body"><p>I will look into what's required to make this test case, which captures the original issue, pass:</p>
<p>https://github.com/astral-sh/ruff/blob/main/crates/ty_python_semantic/resources/mdtest/import/nonstandard_conventions.md#from-import-of-non-submodule-non-stub-check</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-10-31 18:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @sharkdp on 2025-10-31 18:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-05 17:51</div>
            <div class="timeline-body"><p>Ok so mea culpa the <em>exact</em> issue in OP is <em>still</em> not fixed by https://github.com/astral-sh/ruff/pull/21173</p>
<p>But there's a lot of different behaviours we could or could not implement here, so I opted to break out a ton of more specific/fine-grained issues as followups. Many of the followups should be really easy to implement too:</p>
<ul>
<li>#1482</li>
<li>#1484</li>
<li>#1485</li>
<li>#1486</li>
<li>#1487</li>
<li>#1489</li>
<li>#1490</li>
<li>#1526</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Gankra on 2025-11-10 23:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-11 18:34</div>
            <div class="timeline-body"><p>Ok I believe the original issue is now <em>actually</em> fixed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/fitz-vivodyne">@fitz-vivodyne</a> on 2025-11-12 15:33</div>
            <div class="timeline-body"><p>If this is in fact fixed the pinned issue can be updated: https://github.com/astral-sh/ty/issues/445</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:39:14 UTC
    </footer>
</body>
</html>
