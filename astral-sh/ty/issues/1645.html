<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instance attribute inferred as `Unknown | T` in method despite being assigned concrete type in `__init__` - astral-sh/ty #1645</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Instance attribute inferred as <code>Unknown | T</code> in method despite being assigned concrete type in <code>__init__</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1645">#1645</a>
        opened by <a href="https://github.com/sinon">@sinon</a>
        on 2025-11-26 11:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sinon">@sinon</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<h4>Problem</h4>
<p>When investigating adopting <code>ty</code> in an existing codebase which is currently checked by <code>mypy</code> and <code>pyright</code>. I get following odd case where an sttribute defined in <code>__init__</code> has the expected type but when this attribute is then accessed in a method it gains an <code>| Unknown</code> which then seems to trigger <code>missing-argument</code> error as it seems to get confused about whether the <code>self</code> is present.</p>
<h5>Expected Behavior</h5>
<p><code>self._jwk_client</code> should have type <code>PyJWKClient</code> in both <code>__init__</code> and <code>_get_signing_key</code>.</p>
<h5>Actual Behavior</h5>
<ul>
<li>In <code>__init__</code>: type is correctly <code>PyJWKClient</code></li>
<li>In <code>_get_signing_key</code>: type becomes <code>Unknown | PyJWKClient</code></li>
<li>This causes spurious <code>missing-argument</code> errors</li>
</ul>
<h4>MRE</h4>
<pre><code class="language-toml">[project]
name = &quot;mre-pyjwt&quot;
version = &quot;0.1.0&quot;
description = &quot;MRE for ty issue&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.11&quot;
dependencies = [  &quot;pyjwt[crypto]&gt;=2.10.0&quot;,]
</code></pre>
<pre><code class="language-py">from typing import reveal_type

import jwt


class JWTVerifier:
    def __init__(
        self,
        *,
        jwk_set_url: str,
    ) -&gt; None:
        self._jwk_client = jwt.PyJWKClient(
            jwk_set_url,
        )
        reveal_type(self._jwk_client)  # PyJWKClient

    def _get_signing_key(self, token: str) -&gt; jwt.PyJWK:
        kid = jwt.get_unverified_header(token)[&quot;kid&quot;]
        reveal_type(self._jwk_client)  # Unknown | PyJWKClient
        self._jwk_client.get_signing_key(kid) # error[missing-argument] No argument provided for required parameter `kid` of function `get_signing_key`
        return self._jwk_client.get_signing_key(kid=kid) # error[missing-argument] No argument provided for required parameter `self` of function `get_signing_key`
</code></pre>
<h3>Expected Behavior</h3>
<p><code>self._jwk_client</code> should have type <code>PyJWKClient</code> in both <code>__init__</code> and <code>_get_signing_key</code>.</p>
<h3>Actual Behavior</h3>
<ul>
<li>In <code>__init__</code>: type is correctly <code>PyJWKClient</code></li>
<li>In <code>_get_signing_key</code>: type becomes <code>Unknown | PyJWKClient</code></li>
<li>This causes spurious <code>missing-argument</code> errors</li>
</ul>
<p>It's present in all versions from 0.0.1-alpha.24 onwards, where the <code>self._jwk_client</code> goes from being <code>Unknown</code> / <code>Unknown</code> to <code>PyJWKClient</code> / <code>PyJWKClient | Unknown</code></p>
<pre><code class="language-sh">âžœ uv tool run ty@0.0.1-alpha.23 check . --output-format concise
main.py:15:21: info[revealed-type] Revealed type: `Unknown`
main.py:19:21: info[revealed-type] Revealed type: `Unknown`
Found 2 diagnostics

âžœ uv tool run ty@0.0.1-alpha.24 check . --output-format concise
main.py:15:21: info[revealed-type] Revealed type: `PyJWKClient`
main.py:19:21: info[revealed-type] Revealed type: `Unknown | PyJWKClient`
main.py:20:9: error[missing-argument] No argument provided for required parameter `kid` of function `get_signing_key`
main.py:21:16: error[missing-argument] No argument provided for required parameter `self` of function `get_signing_key`
Found 4 diagnostics
</code></pre>
<p>I assume this isn't strictly related to the upstream library specifically as <code>ty</code> is correctly detecting the <code>PyJWKClient</code> in the <code>__init__</code> ðŸ¤” (my naive attempts to reproduce in ty playground without pyjwk did fail that but that is potentially a skill issue on my part)</p>
<p>Please let me know if I can provide any further details to help debug, apologies if this has already been reported searching on <code>missing-argument</code> didn't turn up anything that quite fit.</p>
<h3>Version</h3>
<p>0.0.1-alpha.24-28</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-11-26 12:09</div>
            <div class="timeline-body"><p>Thank you for reporting this.</p>
<p><em>Within</em> <code>__init__</code>, you see the locally narrowed type of <code>PyJWKClient</code>. But since <code>_jwk_client</code> is not annotated, it might be externally mutated (I guess we could consider making exceptions for &quot;private&quot; attributes?). This is why we union with <code>Unknown</code> for the type of the attribute when accessed in other methods (see https://github.com/astral-sh/ty/issues/1515#issuecomment-3512306787 for a more detailed explanation).</p>
<p>You can either annotate <code>_jwk_client: jwt.PyJWKClient</code> on the class body, or annotate the attribute assignment (<code>self._jwk_client: jwt.PyJWKClient = jwt.PyJWKClient(â€¦)</code>) to fix this.</p>
<p>See https://github.com/astral-sh/ty/issues/1515 for a similar discussion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @sharkdp on 2025-11-26 12:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">attribute access</span> added by @sharkdp on 2025-11-26 12:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sinon">@sinon</a> on 2025-11-26 12:20</div>
            <div class="timeline-body"><p>I had tried specifying the type explicitly (even adding a cast) but still get the same errors</p>
<pre><code class="language-py">class JWTVerifier:
    def __init__(
        self,
        *,
        jwk_set_url: str,
    ) -&gt; None:
        self.jwk_client: jwt.PyJWKClient = jwt.PyJWKClient(
            jwk_set_url,
        )
        reveal_type(self.jwk_client)  # PyJWKClient

    def get_signing_key(self, token: str) -&gt; jwt.PyJWK:
        kid = jwt.get_unverified_header(token)[&quot;kid&quot;]
        reveal_type(self.jwk_client)  # PyJWKClient
        self.jwk_client = cast(jwt.PyJWKClient, self.jwk_client)  # warning[redundant-cast] Value is already of type `PyJWKClient`
        self.jwk_client.get_signing_key(kid)  # error[missing-argument] No argument provided for required parameter `kid` of function `get_signing_key`
        return self.jwk_client.get_signing_key(kid=kid)  # error[missing-argument] No argument provided for required parameter `self` of function `get_signing_key`
</code></pre>
<p>or</p>
<pre><code class="language-py">class JWTVerifier:
    def __init__(
        self,
        *,
        jwk_set_url: str,
    ) -&gt; None:
        self.jwk_client: jwt.PyJWKClient = jwt.PyJWKClient(
            jwk_set_url,
        )
        reveal_type(self.jwk_client)  # PyJWKClient

    def get_signing_key(self, token: str) -&gt; jwt.PyJWK:
        kid = jwt.get_unverified_header(token)[&quot;kid&quot;]
        reveal_type(self.jwk_client)  # PyJWKClient
        self.jwk_client = cast(jwt.PyJWKClient, self.jwk_client)
        client: jwt.PyJWKClient = self.jwk_client
        client.get_signing_key(kid)
        return client.get_signing_key(kid=kid)
</code></pre>
<p>So they get rid of the <code>Unknown</code> but not the errors ðŸ¤”</p>
<p>In terms of other typecheckers (for the original MRE not above code) I see following behaviour:
<code>mypy</code> - they are actually both revealed as <code>Any</code> (though this might just not be picking up the venvs packages when running with <code>uv tool</code>)
<code>basedpyright</code> (easier to run to <code>uv tool</code>) reports <code>PyJWKClient</code> for each reveal (various infos/warns due to additional default rules but not the error <code>ty</code> experiences)
<code>pyrefly</code> - has <code>PyJWKClient</code> and <code>PyJWKClient | Unknown</code> but no errors</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-11-26 14:25</div>
            <div class="timeline-body"><p>Oh, I just now recognized <code>PyJWKClient</code>. I actually saw the same error in another project yesterday.</p>
<p>The problem is that the <code>get_signing_key</code> method is overwritten here: https://github.com/jpadilla/pyjwt/blob/f7b872edd08c2584f06efe90715495c401684063/jwt/jwks_client.py#L50-L52</p>
<p>We thus infer <code>jwks_client.get_signing_key</code> as a union of the bound method and the plain function:</p>
<pre><code>(bound method PyJWKClient.get_signing_key(kid: str) -&gt; PyJWK) | (def get_signing_key(self, kid: str) -&gt; PyJWK)
</code></pre>
<p>So I think this is actually a bug in ty, see https://github.com/astral-sh/ty/issues/350.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-11-26 14:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sinon">@sinon</a> on 2025-11-26 14:35</div>
            <div class="timeline-body"><blockquote>
<p>Oh, I just now recognized <code>PyJWKClient</code>. I actually saw the same error in another project yesterday.</p>
<p>The problem is that the <code>get_signing_key</code> method is overwritten here: https://github.com/jpadilla/pyjwt/blob/f7b872edd08c2584f06efe90715495c401684063/jwt/jwks_client.py#L50-L52</p>
<p>We thus infer <code>jwks_client.get_signing_key</code> as a union of the bound method and the plain function:</p>
<pre><code>(bound method PyJWKClient.get_signing_key(kid: str) -&gt; PyJWK) | (def get_signing_key(self, kid: str) -&gt; PyJWK)
</code></pre>
<p>So I think this is actually a bug in ty, see <a href="https://github.com/astral-sh/ty/issues/350">#350</a>.</p>
</blockquote>
<p>Ah, nice thank you @sharkdp! Good to see this is scheduled for Stable milestone so I can safely link #350 when suppressing the error</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:21:03 UTC
    </footer>
</body>
</html>
