<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accessing a class attribute via an instance produces Unknown type - astral-sh/ty #1706</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Accessing a class attribute via an instance produces Unknown type</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1706">#1706</a>
        opened by <a href="https://github.com/alex">@alex</a>
        on 2025-12-01 13:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/alex">@alex</a> on 2025-12-01 13:47</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Minimal reproducer: https://play.ty.dev/ee9d00f3-683c-4ab6-8a10-b2494da94501</p>
<pre><code>import typing

BAR: typing.Any = None

class Binding:
    ffi = BAR

    def __init__(self) -&gt; None:
        typing.reveal_type(self.ffi)
</code></pre>
<p>For comparison with mypy: https://mypy-play.net/?mypy=latest&amp;python=3.12&amp;gist=ae1fd0175a91a34e7106fe67ca405d04</p>
<p>(Apologies if there's an existing bug for this, I attempted to search but didn't see anything.)</p>
<h3>Version</h3>
<p>0e651b50b (playground)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @sharkdp on 2025-12-01 18:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">attribute access</span> added by @sharkdp on 2025-12-01 18:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-12-01 18:16</div>
            <div class="timeline-body"><p>Thank you for reporting this.</p>
<p>ty distinguishes between the declared type, and the control-flow-sensitive (local) inferred type. Here, the inferred type for <code>BAR</code> is <code>None</code>, and since the class body is eagerly executed, we know that it's still <code>None</code> when <code>ffi = BAR</code> is executed. Since the <code>ffi</code> attribute is not declared, we union with <code>Unknown</code> (see <a href="https://github.com/astral-sh/ruff/blob/main/crates/ty_python_semantic/resources/mdtest/doc/public_type_undeclared_symbols.md">this document</a> for an explanation why).</p>
<p>So this is pretty much the intended behavior at the moment, but we do realize that it is confusing to seemingly ignore the declared type. See #136 for a related discussion.</p>
<p>(Even if we prefer the declared type of <code>BAR</code> here, though, <code>ffi</code> is still un-annotated and not declared anywhere. If you want to enforce an attribute type of <code>Any</code>, that attribute will probably have to be annotated/declared explicitly)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/alex">@alex</a> on 2025-12-01 21:19</div>
            <div class="timeline-body"><p>I think I understand the theory here -- at least as to <code>Unknown</code> on all public APIs. However, the user experience is fairly confusing, to make this practical I think <code>ty</code> needs some sort of &quot;type coverage&quot; mode that tells me anyplace <code>| Unknown</code> is getting added to my types.</p>
<p>And as for #136, using something other than my declared types is fairly confusing and seems to risk leaking implementation details -- which is precisely what I understand the <code>| Unknown</code> behavior to be helping avoid.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-01 21:25</div>
            <div class="timeline-body"><blockquote>
<p>using something other than my declared types is fairly confusing</p>
</blockquote>
<p>At risk of straying into territory that better belongs in https://github.com/astral-sh/ty/issues/136, the problem here is that in other cases just using the declared type is confusing/wrong! With <code>x: int | None = 3</code>, people definitely expect us to locally use the inferred type of the RHS (which cannot be <code>None</code>) until/unless we see <code>None</code> assigned, rather than just the declared type <code>int | None</code>. So we need to sort out whether there is any principled behavior here that will also give the results people expect, or whether the only option is some sort of heuristic (e.g. &quot;use the declared type but filter union types specifically&quot;).</p>
<blockquote>
<p>the user experience is fairly confusing, to make this practical I think <code>ty</code> needs some sort of &quot;type coverage&quot; mode that tells me anyplace <code>| Unknown</code> is getting added to my types.</p>
</blockquote>
<p>Yeah, I agree with this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-01 21:27</div>
            <div class="timeline-body"><blockquote>
<p>With <code>x: int | None = 3</code>, people definitely expect us to locally use the inferred type of the RHS (which cannot be <code>None</code>) until/unless we see <code>None</code> assigned, rather than just the declared type <code>int | None</code>.</p>
</blockquote>
<p>well, <a href="https://mypy-play.net/?mypy=latest&amp;python=3.12&amp;gist=249eb5d90455778220bf82539d1f6aa1">mypy users won't necessarily expect that</a>. But I do agree that refusing to narrow on the initial assignment (and yet narrowing in all other situations) can be viewed as inconsistent.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-01 21:33</div>
            <div class="timeline-body"><p>Thanks for the report! Ultimately I think this example covers territory that is covered in #136 (annotations of <code>Any</code> are discussed extensively as an example case there) and #1240, so I'll close this as duplicate (of the latter, semi-arbitrarily).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-12-01 21:33</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 02:11:47 UTC
    </footer>
</body>
</html>
