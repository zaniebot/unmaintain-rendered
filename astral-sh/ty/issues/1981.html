<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Make the &quot;implicit shadowing&quot; note on `invalid-assignment` additional, don't replace the main message - astral-sh/ty #1981</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Make the &quot;implicit shadowing&quot; note on <code>invalid-assignment</code> additional, don't replace the main message</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1981">#1981</a>
        opened by <a href="https://github.com/lucach">@lucach</a>
        on 2025-12-17 07:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/lucach">@lucach</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>In #1556 I suggested to improve the diagnostic range for <code>invalid-assignment</code> by moving the range from the target to the expression on the right-hand side. @sharkdp greatly improved this in https://github.com/astral-sh/ruff/pull/21476, but I fear there's one special case for which the changes actually caused a regression.</p>
<p>When <code>invalid-assignment</code> warns about implicit shadowing, it is not quite right to blame (only) the RHS. That expression in itself is not faulty. The diagnostic range should either extend to the entire assignment, or just cover the target.</p>
<p><a href="https://play.ty.dev/0ecc746e-20bc-44bf-a885-d44570fd9967">Minimal example in the Playground</a></p>
<p>The relevant code is <a href="https://github.com/astral-sh/ruff/blob/b0bc990cbf2a0a75ced52de0d6ba3d51d35072ee/crates/ty_python_semantic/src/types/diagnostic.rs#L2402-L2485">here</a>, and I would have attempted a fix myself, but I'm not sure where to best treat this special case.</p>
<h3>Version</h3>
<p>ad3de4e48</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">diagnostics</span> added by @AlexWaygood on 2025-12-17 07:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/lucach">@lucach</a> on 2025-12-19 08:59</div>
            <div class="timeline-body"><p>Thinking about this a bit more, it also doesn't feel ideal that the shadowing diagnostics &quot;suppresses&quot; (at least in the concise diagnostics shown e.g. in the playground) the possible type error.</p>
<p>In the <a href="https://play.ty.dev/0ecc746e-20bc-44bf-a885-d44570fd9967">original example</a> reported above, there is function shadowing but no type error (indeed, [if you add <code>Callable[[], None</code> as a type annotation, ty correctly emits no diagnostics](https://play.ty.dev/4b7f0da7-c3f8-48ec-92b4-b280de3e51cc)).</p>
<p>But there are cases in which <strong>both</strong> shadowing and a type error play a role, but ty reports only one diagnostics about shadowing... which is shadowing (ha!) the &quot;type mismatch&quot; diagnostic. Here is a <a href="https://play.ty.dev/299f856a-edf3-4e60-b530-6eef9df183db">simple example</a>, which <a href="https://play.ty.dev/da7fa0b2-1a86-4d37-a0b5-d8cee17d1a9b">correctly shows up as a type mismatch when adding the annotation</a>.</p>
<p>Given all of this, I wonder if it makes sense to separate shadowing into its own separate diagnostic code, such that when there is both shadowing and a type error, both could be shown, and users could enable/disable shadowing specifically.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @carljm on 2025-12-22 23:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">good first issue</span> added by @carljm on 2025-12-22 23:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Improve diagnostic range for `invalid-assignment` when it is about shadowing" to "Make the "implicit shadowing" note on `invalid-assignment` additional, don't replace the main message" by @carljm on 2025-12-22 23:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-22 23:59</div>
            <div class="timeline-body"><p>Thanks! This &quot;implicit shadowing&quot; diagnostic dates back to very early days of ty, before we had our current diagnostic system. Currently we literally just replace the normal diagnostic message for <code>invalid-assignment</code> with a different one, when we detect that the &quot;declared type&quot; is a function or class literal. At the very least, we should instead leave the normal <code>invalid-assignment</code> diagnostic message, and tack on &quot;Are you implicitly shadowing a function/class?&quot; as a <code>note</code> sub-diagnostic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Stable" by @carljm on 2025-12-22 23:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-12-29 09:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:21:20 UTC
    </footer>
</body>
</html>
