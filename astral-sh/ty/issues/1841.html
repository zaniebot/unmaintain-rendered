<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`ty` ignores type hints for C extension - astral-sh/ty #1841</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>`ty` ignores type hints for C extension</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1841">#1841</a>
        opened by <a href="https://github.com/albireox">@albireox</a>
        on 2025-12-10 16:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/albireox">@albireox</a> on 2025-12-10 16:00</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I have a small project that using <code>pyo3</code> to create Python bindings for some Rust code. The package also includes some Python code to import and expose some of the bindings. The <code>python</code> directory structure is</p>
<pre><code>python/
└─ rheader/
   ├─ __init__.py
   ├─ _rheader.abi3.so
   ├─ _rheader.pyi
   └─ py.typed
</code></pre>
<p>where <code>_rheader.abi3.so</code> is the compiled library produced using <code>maturin</code>, and I added <code>_rheader.pyi</code> type hints.</p>
<p><code>_rheader.pyi</code>:</p>
<pre><code class="language-python">class Header:
    &quot;&quot;&quot;Representation of a header.&quot;&quot;&quot;

    keywords: dict[str, Keyword]

class Keyword:
    &quot;&quot;&quot;Representation of a header keyword.&quot;&quot;&quot;

    name: str
    value: str | int | float | bool | None
    comment: str | None

def read_header(file_path: str) -&gt; dict:
    &quot;&quot;&quot;Reads a header from a file and returns it as a dictionary.&quot;&quot;&quot;
    ...

def read_header_to_class(file_path: str, cls: type) -&gt; Header:
    &quot;&quot;&quot;Reads a header from a file and returns it as an instance of :obj:`.Header`.&quot;&quot;&quot;
    ...
</code></pre>
<p>and <code>__init__.py</code>:</p>
<pre><code class="language-python">__all__ = [
    &quot;Header&quot;,
    &quot;Keyword&quot;,
    &quot;read_header&quot;,
    &quot;read_header_to_class&quot;,
]


from ._rheader import Header, Keyword, read_header, read_header_to_class
</code></pre>
<p>In <code>__init__.py</code> <code>ty</code> complains that <code>Cannot resolve imported module ._rheader</code>. This happens whether I use <code>pyo3</code> with the <code>abi3-py39</code> feature or not.</p>
<h3>Version</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-10 16:07</div>
            <div class="timeline-body"><p>Do you have a <code>pyproject.toml</code> or <code>ty.toml</code> anywhere? From what current-working-directory do you run ty?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> added by @carljm on 2025-12-10 16:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">imports</span> added by @carljm on 2025-12-10 16:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/albireox">@albireox</a> on 2025-12-10 16:09</div>
            <div class="timeline-body"><p>Here's the complete file structure</p>
<pre><code>rheader/
├─ .vscode/
│  └─ settings.json
├─ python/
│  └─ rheader/
│     ├─ __init__.py
│     ├─ _rheader.abi3.so
│     ├─ _rheader.pyi
│     └─ py.typed
├─ src/
│  ├─ header.rs
│  ├─ lib.rs
│  ├─ python.rs
│  └─ tools.rs
├─ .envrc
├─ .gitignore
├─ Cargo.lock
├─ Cargo.toml
├─ pyproject.toml
├─ README.md
└─ uv.lock
</code></pre>
<p>The <code>pyproject.toml</code> looks like</p>
<pre><code class="language-toml">[project]
name = &quot;rheader&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.9&quot;
dependencies = []

[build-system]
requires = [&quot;maturin&gt;=1.0,&lt;2.0&quot;]
build-backend = &quot;maturin&quot;

[tool.maturin]
python-source = &quot;python&quot;
module-name = &quot;rheader._rheader&quot;

[dependency-groups]
dev = [
    &quot;ipdb&gt;=0.13.13&quot;,
    &quot;ipython&gt;=8.18.1&quot;,
]
</code></pre>
<p>and the <code>Cargo.toml</code></p>
<pre><code class="language-toml">[package]
name = &quot;rheader&quot;
version = &quot;0.1.0&quot;
edition = &quot;2024&quot;

[lib]
name = &quot;rheader&quot;
crate-type = [&quot;cdylib&quot;]

[dependencies]
anyhow = &quot;1.0.100&quot;
bytes = &quot;1.11.0&quot;
flate2 = { version = &quot;1.1.5&quot;, features = [&quot;zlib-rs&quot;], default-features = false }
regex = &quot;1.12.2&quot;

[dependencies.pyo3]
version = &quot;0.27.2&quot;
features = [&quot;abi3-py39&quot;]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-10 16:23</div>
            <div class="timeline-body"><p>You'll need to tell <code>ty</code> that the root of your python code is in <code>python</code> by setting <code>environment.root = [&quot;python&quot;]</code>. See https://docs.astral.sh/ty/modules/#first-party-modules</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-10 16:24</div>
            <div class="timeline-body"><p>CC: @Gankra a case where our desperate resolution mode doesn't work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/albireox">@albireox</a> on 2025-12-10 16:26</div>
            <div class="timeline-body"><p>Ah! You're completely right and I had missed that part of the documentation. It works as expected when I set the root. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-12-10 16:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-10 16:27</div>
            <div class="timeline-body"><p>I'm actually surprised this didn't work as-is. Even without <code>environment.root = [&quot;python&quot;]</code>, I would have thought given the top-level outer dir as root, we'd have just treated it as a package named <code>python.rheader</code> and the relative import would still work...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-10 16:28</div>
            <div class="timeline-body"><blockquote>
<p>You'll need to tell <code>ty</code> that the root of your python code is in <code>python</code> by setting <code>environment.root = [&quot;python&quot;]</code>. See https://docs.astral.sh/ty/modules/#first-party-modules</p>
</blockquote>
<p>@michareiser I thought we already automatically added a top-level <code>python/</code> directory as a search path whenever we saw one, since this is such a common directory structure for maturin-based projects</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-10 16:29</div>
            <div class="timeline-body"><p>See</p>
<ul>
<li>https://github.com/astral-sh/ruff/pull/20263</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-10 16:33</div>
            <div class="timeline-body"><p>I wasn't able to successfully reproduce this issue:</p>
<pre><code>ruff-examples/issue1841 on  main [✘?]
➜ tree
.
├── main.py
├── pyproject.toml
├── python
│   └── rheader
│       ├── __init__.py
│       └── _rheader.pyi
└── README.md

3 directories, 5 files

ruff-examples/issue1841 on  main [✘?]
➜ cat python/rheader/__init__.py
from ._rheader import X

reveal_type(X)

ruff-examples/issue1841 on  main [✘?]
➜ cat python/rheader/_rheader.pyi
X = 1

ruff-examples/issue1841 on  main [✘?]
➜ cat pyproject.toml
[project]
name = &quot;issue1841&quot;
version = &quot;0.1.0&quot;
description = &quot;Add your description here&quot;
readme = &quot;README.md&quot;
requires-python = &quot;&gt;=3.13&quot;
dependencies = []

ruff-examples/issue1841 on  main [✘?]
➜ uvx ty check .
warning[undefined-reveal]: `reveal_type` used without importing it
 --&gt; python/rheader/__init__.py:3:1
  |
1 | from ._rheader import X
2 |
3 | reveal_type(X)
  | ^^^^^^^^^^^
  |
info: This is allowed for debugging convenience but will fail at runtime
info: rule `undefined-reveal` is enabled by default

info[revealed-type]: Revealed type
 --&gt; python/rheader/__init__.py:3:13
  |
1 | from ._rheader import X
2 |
3 | reveal_type(X)
  |             ^ `Literal[1]`
  |

Found 2 diagnostics
</code></pre>
<p>So there is some factor here I don't understand.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-10 16:37</div>
            <div class="timeline-body"><p>Maybe there's some <code>ty.toml</code> or <code>pyproject.toml</code> with a <code>tool.ty</code> section in one of the ancestor directories?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-10 16:38</div>
            <div class="timeline-body"><p>That would explain it -- in that case adding the <code>environment.root</code> wasn't the key factor, just adding any kind of ty config at all, in the right place...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/albireox">@albireox</a> on 2025-12-10 20:27</div>
            <div class="timeline-body"><p>At least in my case I don't think I have any <code>pyproject.toml</code> above this project with a <code>[tool.ty]</code> section. I'm only now starting to use <code>ty</code> and I'm fairly sure I've never added a <code>[tool.ty]</code> section. Same with <code>ty.toml</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-10 20:59</div>
            <div class="timeline-body"><p>@albireox what was your current working directory you were running ty from?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/albireox">@albireox</a> on 2025-12-10 21:04</div>
            <div class="timeline-body"><p>I was running it using the VSCode extension and I had the root of the directory (where the <code>Cargo.toml</code> and <code>pyproject.toml</code> files are).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-12-11 15:05</div>
            <div class="timeline-body"><p>If we auto-add <code>python/</code> as a root then this looks suspiciously like <a href="https://github.com/astral-sh/ruff/blob/main/crates/ty_python_semantic/resources/mdtest/import/workspaces.md#tests-directory-with-ambiguous-project-directories-via-editables">this known broken case</a></p>
<p>But if you're running from within the top-level rheader directory that case shouldn't be relevant...</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:55:22 UTC
    </footer>
</body>
</html>
