<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>division-by-zero error raised when conditional statements check for division by 0 - astral-sh/ty #443</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>division-by-zero error raised when conditional statements check for division by 0</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/443">#443</a>
        opened by <a href="https://github.com/DirkNZ">@DirkNZ</a>
        on 2025-05-18 23:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/DirkNZ">@DirkNZ</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>When using a conditional check to cover the case where you might divide by zero, ty raises a division-by-zero error. MyPy will pass.</p>
<p>Example: <a href="https://play.ty.dev/8f7eb7d5-acb5-41fe-95c8-08f725dfd812">Playground</a></p>
<pre><code class="language-py">a: int = 1
b: int = 0

c = a / b if b &gt; 0 else 0

if b &gt; 0:
    c = a / b
else:
    c = 0

# mypy passes in both
# ty fails in both:
# error[division-by-zero]: Cannot divide object of type `Literal[1]` by zero
#  --&gt; type_example.py:4:5
#   |
# 2 | b: int = 0
# 3 |
# 4 | c = a / b if b &gt; 0 else 0
#   |     ^^^^^
#   |
# info: rule `division-by-zero` is enabled by default`
</code></pre>
<h3>Version</h3>
<p>ty 0.0.1-alpha.5 (3b726d87a 2025-05-17)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @sharkdp on 2025-05-19 07:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">control flow</span> added by @sharkdp on 2025-05-19 07:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-19 07:45</div>
            <div class="timeline-body"><p>Thank you for reporting this.</p>
<p>Internal note: we detect those expressions/statements as unreachable, but we do not silence the division-by-zero diagnostic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/tonka3000">@tonka3000</a> on 2025-05-19 20:16</div>
            <div class="timeline-body"><p>Not 100% sure but this could be another example</p>
<pre><code class="language-py">from enum import IntEnum


class DesignState(IntEnum):
    SUCCESS = 0
    ERROR = 1


class Design:
    def __init__(self, state: DesignState):
        self.state: DesignState = state


def stats(designs: list[Design]):
    feasible = 0
    error = 0
    total = 0
    for d in designs:
        total += 1
        if d.state == DesignState.SUCCESS:
            feasible += 1
        elif d.state == DesignState.ERROR:
            error += 1

    feasible_factor = feasible / total if total &gt; 0 else 0.0 # Cannot divide object of type `Literal[0]` by zeroty(division-by-zero) , Cannot divide object of type `Literal[1]` by zeroty(division-by-zero)
</code></pre>
<p>false positive message are:</p>
<ul>
<li>Cannot divide object of type <code>Literal[0]</code> by zeroty(division-by-zero)</li>
<li>Cannot divide object of type <code>Literal[1]</code> by zeroty(division-by-zero)</li>
</ul>
<p>This should not happend here because <code>total &gt; 0</code> check is there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-05-19 22:13</div>
            <div class="timeline-body"><p>Yes, the latter case is because we don't yet implement narrowing for <code>&gt;</code> or <code>&lt;</code> tests; we should be able to eliminate some <code>Literal</code> types with such narrowing. Though tbh my feeling is we should probably disable <code>division-by-zero</code> by default; it is prone to the same sort of &quot;if our control flow and narrowing is not perfect, it gives false positives&quot; problems as <code>possibly-unresolved-reference</code> is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-20 05:17</div>
            <div class="timeline-body"><blockquote>
<p>it is prone to the same sort of &quot;if our control flow and narrowing is not perfect, it gives false positives&quot; problems as possibly-unresolved-reference is.</p>
</blockquote>
<p>Isn't this true for many diagnostics. Even invalid call diagnostics are possible because of incorrect narrowing (if the signature is strict enough)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-05-20 14:41</div>
            <div class="timeline-body"><blockquote>
<p>Isn't this true for many diagnostics.</p>
</blockquote>
<p>In general, yes. In practice, there are significant qualitative differences. Diagnostics (such as divide-by-zero) that rely for their correctness on distinguishing very particular literal values from each other require more and different kinds of narrowing to be supported. For example, neither mypy nor pyright support narrowing a union of literal integers based on an inequality test; this narrowing just rarely turns out to be useful, except for divide-by-zero. Not coincidentally, neither one supports a divide-by-zero diagnostic, either.</p>
<p>I'm not in principle opposed to implementing support for inequality narrowing and unreachable-code silencing and seeing if that gets us close enough for divide-by-zero to work well. But I don't think either inequality-narrowing nor divide-by-zero should be a priority at this point, and I do think we should disable divide-by-zero until we are ready to prioritize reducing its false positives.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">unreachable-code</span> added by @sharkdp on 2025-05-26 11:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-26 12:27</div>
            <div class="timeline-body"><p>I think this can be closed, now that we don't emit this diagnostic by default: https://play.ty.dev/d4f6b510-383d-47ef-8edc-f9e232245410</p>
<p>We will further track the core issue in #443. I added a link to this ticket as an example.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-05-26 12:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:19:56 UTC
    </footer>
</body>
</html>
