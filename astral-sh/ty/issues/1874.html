<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stack overflow in `GenericContext::inferable_typevars()` - astral-sh/ty #1874</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Stack overflow in <code>GenericContext::inferable_typevars()</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1874">#1874</a>
        opened by <a href="https://github.com/n-gao">@n-gao</a>
        on 2025-12-13 08:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/n-gao">@n-gao</a></div>
            <div class="timeline-body">Summary
<p>I am not entirely sure what&#x27;s the issue is here, but the following code causes a stack overflow in ty. The error persists for many ty versions. Pyright gets the types right.</p>
<pre><code>from __future__ import annotations
from typing import Protocol


class A[S, R](Protocol):
    def get(self, s: S) -&gt; R: ...
    def set(self, s: S, r: R) -&gt; S: ...
    def merge[R2](self, other: A[S, R2]) -&gt; A[S, tuple[R, R2]]: ...


class Impl[S, R](A[S, R]):
    def foo(self, s: S) -&gt; S:
        return self.set(s, self.get(s))
</code></pre>
<p>Removing the <code>foo</code> function or the <code>merge</code> function allows <code>ty</code>to pass.</p>
<pre><code>ty check src/cups/core/lens.py -vvvv
(cups) ngao@CUSPAI-MK63F6HL7J CUPS % ty check test.py -vvvv              
  2025-12-13T08:40:17.566573Z DEBUG ty: Version: 0.0.1-alpha.34 (ef3d48ac4 2025-12-12)
    at crates/ty/src/lib.rs:79 on ThreadId(1)

  2025-12-13T08:40:17.567679Z DEBUG ruff_db::system::os: Architecture: aarch64, OS: macos, case-sensitive: case-insensitive
    at crates/ruff_db/src/system/os.rs:47 on ThreadId(1)

  2025-12-13T08:40:17.567720Z DEBUG ty_project::metadata: Searching for a project in &#x27;/Users/ngao/Documents/CUPS&#x27;
    at crates/ty_project/src/metadata.rs:135 on ThreadId(1)

  2025-12-13T08:40:17.569377Z DEBUG ty_project::metadata::pyproject: Resolving requires-python constraint: `&gt;=3.12, &lt;3.14`
    at crates/ty_project/src/metadata/pyproject.rs:67 on ThreadId(1)

  2025-12-13T08:40:17.569537Z DEBUG ty_project::metadata::pyproject: Resolved requires-python constraint to: 3.12
    at crates/ty_project/src/metadata/pyproject.rs:101 on ThreadId(1)

  2025-12-13T08:40:17.569557Z DEBUG ty_project::metadata: Project without `tool.ty` section: &#x27;/Users/ngao/Documents/CUPS&#x27;
    at crates/ty_project/src/metadata.rs:234 on ThreadId(1)

  2025-12-13T08:40:17.569585Z DEBUG ty_project::metadata::configuration_file: Searching for a user-level configuration at `/Users/ngao/.config/ty/ty.toml`
    at crates/ty_project/src/metadata/configuration_file.rs:47 on ThreadId(1)

  2025-12-13T08:40:17.572370Z  INFO ty_project::metadata::options: Defaulting to python-platform `darwin`
    at crates/ty_project/src/metadata/options.rs:144 on ThreadId(1)

  2025-12-13T08:40:17.572540Z DEBUG ty_python_semantic::site_packages: Resolving `VIRTUAL_ENV` environment variable: /Users/ngao/Documents/CUPS/.venv
    at crates/ty_python_semantic/src/site_packages.rs:172 on ThreadId(1)

  2025-12-13T08:40:17.572604Z DEBUG ty_python_semantic::site_packages: Attempting to parse virtual environment metadata at &#x27;/Users/ngao/Documents/CUPS/.venv/pyvenv.cfg&#x27;
    at crates/ty_python_semantic/src/site_packages.rs:399 on ThreadId(1)

  2025-12-13T08:40:17.573560Z DEBUG ty_python_semantic::site_packages: Searching for site-packages directory in sys.prefix /Users/ngao/Documents/CUPS/.venv
    at crates/ty_python_semantic/src/site_packages.rs:1161 on ThreadId(1)

  2025-12-13T08:40:17.574071Z DEBUG ty_python_semantic::site_packages: Resolved site-packages directories for this virtual environment are: [&quot;/Users/ngao/Documents/CUPS/.venv/lib/python3.12/site-packages&quot;]
    at crates/ty_python_semantic/src/site_packages.rs:567 on ThreadId(1)

  2025-12-13T08:40:17.574224Z DEBUG ty_python_semantic::site_packages: Searching for real stdlib directory in sys.prefix /Users/ngao/.local/share/uv/python/cpython-3.12.10-macos-aarch64-none
    at crates/ty_python_semantic/src/site_packages.rs:1308 on ThreadId(1)

  2025-12-13T08:40:17.574232Z DEBUG ty_python_semantic::site_packages: Resolved real stdlib path for this virtual environment is: /Users/ngao/.local/share/uv/python/cpython-3.12.10-macos-aarch64-none/lib/python3.12
    at crates/ty_python_semantic/src/site_packages.rs:607 on ThreadId(1)

  2025-12-13T08:40:17.574238Z DEBUG ty_project::metadata::options: Including `.` and `./src` in `environment.root` because a `./src` directory exists
    at crates/ty_project/src/metadata/options.rs:254 on ThreadId(1)

  2025-12-13T08:40:17.574271Z DEBUG ty_python_semantic::module_resolver::resolver: Adding first-party search path `/Users/ngao/Documents/CUPS/src`
    at crates/ty_python_semantic/src/module_resolver/resolver.rs:585 on ThreadId(1)

  2025-12-13T08:40:17.574443Z DEBUG ty_python_semantic::module_resolver::resolver: Adding first-party search path `/Users/ngao/Documents/CUPS`
    at crates/ty_python_semantic/src/module_resolver/resolver.rs:585 on ThreadId(1)

  2025-12-13T08:40:17.574449Z DEBUG ty_python_semantic::module_resolver::resolver: Using vendored stdlib
    at crates/ty_python_semantic/src/module_resolver/resolver.rs:608 on ThreadId(1)

  2025-12-13T08:40:17.575334Z DEBUG ty_python_semantic::module_resolver::resolver: Adding site-packages search path `/Users/ngao/Documents/CUPS/.venv/lib/python3.12/site-packages`
    at crates/ty_python_semantic/src/module_resolver/resolver.rs:624 on ThreadId(1)

  2025-12-13T08:40:17.575352Z  INFO ty_project::metadata::options: Python version: Python 3.12, platform: darwin
    at crates/ty_project/src/metadata/options.rs:213 on ThreadId(1)

  2025-12-13T08:40:17.575525Z DEBUG ruff_db::files::file_root: Adding new file root &#x27;/Users/ngao/Documents/CUPS/.venv/lib/python3.12/site-packages&#x27; of kind LibrarySearchPath
    at crates/ruff_db/src/files/file_root.rs:84 on ThreadId(1)

  2025-12-13T08:40:17.577803Z DEBUG ruff_db::files::file_root: Adding new file root &#x27;/Users/ngao/Documents/CUPS&#x27; of kind Project
    at crates/ruff_db/src/files/file_root.rs:84 on ThreadId(1)

  2025-12-13T08:40:17.578278Z DEBUG ty_project: Setting included paths: 1
    at crates/ty_project/src/lib.rs:368 on ThreadId(1)

  2025-12-13T08:40:17.578303Z DEBUG ty_project: Reloading files for project `cups`
    at crates/ty_project/src/lib.rs:518 on ThreadId(1)

  2025-12-13T08:40:17.578384Z DEBUG ty: Starting main loop
    at crates/ty/src/lib.rs:271 on ThreadId(1)

  2025-12-13T08:40:17.578407Z DEBUG ty: Waiting for next main loop message.
    at crates/ty/src/lib.rs:402 on ThreadId(1)

  2025-12-13T08:40:17.578752Z DEBUG ty_project: Checking all files in project &#x27;cups&#x27;
    at crates/ty_project/src/lib.rs:257 on ThreadId(2)
    in ty_project::Project::check

  2025-12-13T08:40:17.585454Z  INFO ty_project: Indexed 1 file(s) in 0.007s
    at crates/ty_project/src/lib.rs:506 on ThreadId(2)
    in ty_project::Project::index_files with project=cups
    in ty_project::Project::check

  2025-12-13T08:40:17.586653Z DEBUG ty_python_semantic::types: Checking file &#x27;/Users/ngao/Documents/CUPS/test.py&#x27;
    at crates/ty_python_semantic/src/types.rs:125 on ThreadId(2)
    in ty_project::check_file with file=file(Id(c00))
    in ty_project::Project::check


thread &#x27;&lt;unknown&gt;&#x27; (20987205) has overflowed its stack
fatal runtime error: stack overflow, aborting
zsh: abort      ty check test.py -vvvv
</code></pre>
Version
<p>ty 0.0.1-alpha.34 (ef3d48ac4 2025-12-12)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-13 12:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fatal</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-13 12:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">Protocols</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-13 12:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-13 16:23</div>
            <div class="timeline-body"><p>Running this snippet under LLDB, the looping part of the stacktrace is:</p>
<pre><code>frame #5112: 0x0000000101451f9c ty`_$LT$ty_python_semantic..types..generics..GenericContext..inferable_typevars..CollectTypeVars$u20$as$u20$ty_python_semantic..types..visitor..TypeVisitor$GT$::visit_type::h73510f1602c669bf(self=0x0000000170df6540, db=&amp;dyn ty_python_semantic::db::Db @ 0x000000016ff15ea0, ty=&lt;unavailable&gt;) at generics.rs:317:17
frame #5113: 0x00000001017bec9c ty`ty_python_semantic::types::signatures::walk_signature::h32ec0b1a757e4641(db=&amp;dyn ty_python_semantic::db::Db @ 0x000000016ff15f98, signature=0x00000001290fafe8, visitor=0x0000000170df6540) at signatures.rs:491:17
frame #5114: 0x00000001014ef4fc ty`ty_python_semantic::types::walk_callable_type::h30a5c4d16c4bf2bc(db=&amp;dyn ty_python_semantic::db::Db @ 0x000000016ff16048, ty=CallableType @ 0x000000016ff16058, visitor=0x0000000170df6540) at types.rs:12257:9
frame #5115: 0x0000000100f5770c ty`ty_python_semantic::types::visitor::TypeVisitor::visit_callable_type::ha76a773ab4130376(self=0x0000000170df6540, db=&amp;dyn ty_python_semantic::db::Db @ 0x000000016ff16098, callable=CallableType @ 0x000000016ff160a8) at visitor.rs:42:9
frame #5116: 0x00000001012d7ca0 ty`ty_python_semantic::types::protocol_class::walk_protocol_member::haeb2e884e8ceb4c0(db=&amp;dyn ty_python_semantic::db::Db @ 0x000000016ff16110, member=0x000000016ff162b8, visitor=0x0000000170df6540) at protocol_class.rs:668:55
frame #5117: 0x00000001012d835c ty`ty_python_semantic::types::protocol_class::walk_protocol_interface::hba233de5948c4862(db=&amp;dyn ty_python_semantic::db::Db @ 0x000000016ff162f0, interface=ProtocolInterface @ 0x000000016ff16300, visitor=0x0000000170df6540) at protocol_class.rs:194:9
frame #5118: 0x0000000100f69e54 ty`ty_python_semantic::types::instance::walk_protocol_instance_type::h796e65760b3f6eac(db=&amp;dyn ty_python_semantic::db::Db @ 0x000000016ff16398, protocol=ProtocolInstanceType @ 0x000000016ff163f0, visitor=0x0000000170df6540) at instance.rs:622:9
frame #5119: 0x0000000100f57c30 ty`ty_python_semantic::types::visitor::TypeVisitor::visit_protocol_instance_type::h6d7ae37e3ac56165(self=0x0000000170df6540, db=&amp;dyn ty_python_semantic::db::Db @ 0x000000016ff163e0, protocol=&lt;unavailable&gt;) at visitor.rs:86:9
frame #5120: 0x00000001018ee4b8 ty`ty_python_semantic::types::visitor::walk_non_atomic_type::h6820f47603474c50(db=&amp;dyn ty_python_semantic::db::Db @ 0x000000016ff164c0, non_atomic_type=NonAtomicType @ 0x000000016ff166a0, visitor=0x0000000170df6540) at visitor.rs:240:21
frame #5121: 0x00000001018ef1c8 ty`ty_python_semantic::types::visitor::walk_type_with_recursion_guard::h44688c152e23bc73(db=&amp;dyn ty_python_semantic::db::Db @ 0x000000016ff16640, ty=Type @ 0x000000016ff16700, visitor=0x0000000170df6540, recursion_guard=0x0000000170df6540) at visitor.rs:265:13
</code></pre>
<p>So we&#x27;re entering into an infinite loop in the <code>GenericContext::inferable_typevars()</code> method, and the recursion guard isn&#x27;t detecting the infinite loop.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-13 16:27</div>
            <div class="timeline-body"><p>The reason why the recursion guard fails to detect the infinite loop is because it sees a different type each time. The type gets more and more infinitely nested. I applied this diff:</p>
<pre><code>diff --git a/crates/ty_python_semantic/src/types/generics.rs b/crates/ty_python_semantic/src/types/generics.rs
index 58ccd28ca0..e5db6b12b2 100644
--- a/crates/ty_python_semantic/src/types/generics.rs
+++ b/crates/ty_python_semantic/src/types/generics.rs
@@ -314,6 +314,7 @@ impl&lt;&#x27;db&gt; GenericContext&lt;&#x27;db&gt; {
             }
 
             fn visit_type(&amp;self, db: &amp;&#x27;db dyn Db, ty: Type&lt;&#x27;db&gt;) {
+                println!(&quot;{}&quot;, ty.display(db));
                 walk_type_with_recursion_guard(db, ty, self, &amp;self.recursion_guard);
             }
         }
</code></pre>
<p>And hit <code>CTRL-C</code> when ty started printing types like this:</p>
<pre><code>tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[tuple[R2@merge, R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge], R2@merge]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;stack overflow&quot; to &quot;Stack overflow in `GenericContext::inferable_typevars()`&quot; by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-13 16:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-13 17:04</div>
            <div class="timeline-body"><p>This fixes the overflow and passes all our current tests:</p>
<pre><code>diff --git a/crates/ty_python_semantic/src/types/generics.rs b/crates/ty_python_semantic/src/types/generics.rs
index 58ccd28ca0..421d1df2c9 100644
--- a/crates/ty_python_semantic/src/types/generics.rs
+++ b/crates/ty_python_semantic/src/types/generics.rs
@@ -313,6 +313,12 @@ impl&lt;&#x27;db&gt; GenericContext&lt;&#x27;db&gt; {
                 walk_bound_type_var_type(db, bound_typevar, self);
             }
 
+            fn visit_protocol_instance_type(&amp;self, db: &amp;&#x27;db dyn Db, protocol: ProtocolInstanceType&lt;&#x27;db&gt;) {
+                if let Some(nominal_type) = protocol.as_nominal_type() {
+                    self.visit_nominal_instance_type(db, nominal_type);
+                }
+            }
+
             fn visit_type(&amp;self, db: &amp;&#x27;db dyn Db, ty: Type&lt;&#x27;db&gt;) {
                 walk_type_with_recursion_guard(db, ty, self, &amp;self.recursion_guard);
             }
</code></pre>
<p>The approach is just to avoid recursing into the types of a protocol&#x27;s members in this method; just treat the <code>ProtocolInstanceType</code> as if it were a nominal type.</p>
<p>But I&#x27;m unsure if this is the correct fix, because I don&#x27;t feel like I understand well enough what this method does, and there&#x27;s not much documentation in <code>generics.rs</code> to help me out :-(</p>
<p>@dcreager, can you advise? Another possible solution would be to add a depth limit to the visitor, like Carl added to the other visitor in https://github.com/astral-sh/ruff/commit/8727a7b1797bb4a21c0237bd5b36f1e08b213bb4. But that seems less efficient than just avoiding recursing into the members of a protocol, if that&#x27;s indeed unnecessary here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-12-14 03:18</div>
            <div class="timeline-body"><p>I think this is not limited to protocol types. I have a draft fix up at <a href="https://github.com/astral-sh/ruff/pull/21971">astral-sh/ruff#21971</a>, waiting on CI / ecosystem results for it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-12-14 12:55</div>
            <div class="timeline-body"><p>I&#x27;ve confirmed that <a href="https://github.com/astral-sh/ruff/pull/21971">astral-sh/ruff#21971</a> does not stack overflow on @n-gao&#x27;s example</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dcreager">@dcreager</a> on 2025-12-15 15:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:26:24 UTC
    </footer>
</body>
</html>
