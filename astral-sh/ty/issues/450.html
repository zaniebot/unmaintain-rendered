<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Failed to discover site packages directory for PyPy - astral-sh/ty #450</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Failed to discover site packages directory for PyPy</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/450">#450</a>
        opened by <a href="https://github.com/bendoerry">@bendoerry</a>
        on 2025-05-19 14:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/bendoerry">@bendoerry</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>If I create a venv using PyPy, and then run ty check, I get the following error:</p>
<pre><code>ty failed
  Cause: Invalid search path settings
  Cause: Failed to discover the site-packages directory: Could not find the `site-packages` directory for the Python installation at `sys.prefix` path `/some/directory/.venv`
</code></pre>
<p>If I then copy the directory <code>.venv/lib/pypy3.11</code> to <code>.venv/lib/python3.11</code>, ty runs as expected.</p>
<p>This venv was created using</p>
<pre><code>uv venv --seed --python pypy@3.11
</code></pre>
<h3>Version</h3>
<p>ty 0.0.1-alpha.5</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">imports</span> added by @AlexWaygood on 2025-05-19 14:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AlexWaygood by @AlexWaygood on 2025-05-19 14:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Mathemmagician">@Mathemmagician</a> on 2025-05-19 14:51</div>
            <div class="timeline-body"><p>hi!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @Mathemmagician by @AlexWaygood on 2025-05-19 14:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @AlexWaygood by @AlexWaygood on 2025-05-19 14:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Mathemmagician">@Mathemmagician</a> on 2025-05-19 15:05</div>
            <div class="timeline-body"><p>To recap, <code>.venv</code> is structured differently depending on how it was created. For example, using uv, or using pypy.</p>
<p><code>ty</code> needs to know where <code>site-packages</code> is. Currently, it's looking at a single dir location. pypy uses a different convention, which want to also support.</p>
<p>Need to double-check if there are any other formats to support.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Mathemmagician">@Mathemmagician</a> on 2025-05-19 15:59</div>
            <div class="timeline-body"><p>Investigated how virtual environments are created in different ways, summary table of whether <code>Implementation</code> flag is present and where <code>/site-packages</code> is located:</p>
<pre><code>| Virtual Environment      | Has Implementation | Interpreter | UV Installed | Site Packages Path                | Interpreter Path                                          |
|--------------------------|--------------------|-------------|--------------|-----------------------------------|-----------------------------------------------------------|
| .uv-pypy-virtualenv      | Yes                | PyPy        | Yes          | /lib/pypy3.11/site-packages       | ~/.local/share/uv/python/pypy-3.11.11-macos-x86_64-none/bin |
| .virtualenv              | Yes                | CPython     | No           | /lib/python3.10/site-packages     | /Library/Frameworks/Python.framework/Versions/3.10/bin    |
| .python3-venv            | No                 | N/A         | No           | /lib/python3.10/site-packages     | /Library/Frameworks/Python.framework/Versions/3.10/bin    |
| .uv-pypy-venv            | No                 | N/A         | Yes          | /lib/pypy3.11/site-packages       | ~/.local/share/uv/python/pypy-3.11.11-macos-x86_64-none/bin |
| .uv_venv_pypy            | Yes                | PyPy        | Yes          | /lib/pypy3.11/site-packages       | ~/.local/share/uv/python/pypy-3.11.11-macos-x86_64-none/bin |
| .uv                      | Yes                | CPython     | Yes          | /lib/python3.12/site-packages     | ~/.local/share/uv/python/cpython-3.12.10-macos-x86_64-none/bin |
</code></pre>
<p>The Implementation lookup strategy therefore can be:</p>
<ol>
<li>CPython -&gt; <code>/lib/pythonX.Y/site-packages</code></li>
<li>Pypy -&gt; <code>/lib/pypyX.Y/site-packages</code></li>
<li>Missing/Other value? -&gt; Check both</li>
</ol>
<p>Next, will be making a change in <a href="https://github.com/astral-sh/ruff/blob/main/crates/ty_python_semantic/src/site_packages.rs">ruff's site_packages.rs</a></p>
<p>Side note - something to double check is that <code>/site-packages/</code> might be located at different paths on Windows machines, i.e., <code>Lib</code> instead of <code>lib</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-19 16:00</div>
            <div class="timeline-body"><blockquote>
<p>Side note - something to double check is that <code>/site-packages/</code> might be located at different paths on Windows machines, i.e., <code>Lib</code> instead of <code>lib</code></p>
</blockquote>
<p>yup -- we already support this for CPython virtual environments. It should hopefully be similar for PyPy virtual environments!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Mathemmagician">@Mathemmagician</a> on 2025-05-19 16:45</div>
            <div class="timeline-body"><p>Note for myself to check how poetry fits in here...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Skylion007">@Skylion007</a> on 2025-05-19 17:07</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ty/issues/455 Might be a duplicate</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-19 21:32</div>
            <div class="timeline-body"><p>I checked, and GraalPy virtual environments are also located in the same place as CPython virtual environments, whether they're created with the stdlib <code>venv</code> module, the virtualenv library or uv. For GraalPy virtual environments, the <code>implementation</code> key is set to <code>GraalVM</code> if it is present in the <code>pyvenv.cfg</code> file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-19 21:33</div>
            <div class="timeline-body"><p>There are other Python implementations such as RustPython, IronPython and Jython, but for now I think it's okay to limit ourselves to the Python implementations supported by uv, which are CPython, PyPy and GraalPy.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-05-20 18:46</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:19:56 UTC
    </footer>
</body>
</html>
