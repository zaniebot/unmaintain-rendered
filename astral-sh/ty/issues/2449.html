<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>False positives for cls/self in dict creation - astral-sh/ty #2449</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>False positives for cls/self in dict creation</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/2449">#2449</a>
        opened by <a href="https://github.com/adamjstewart">@adamjstewart</a>
        on 2026-01-11 17:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/adamjstewart">@adamjstewart</a></div>
            <div class="timeline-body">Summary
<p>Ty appears to be hard-coded to assume that <code>cls</code> and <code>self</code> are reserved keywords for classes. However, this is not always true, for example in the following perfectly valid (albeit confusing) Python code:</p>
<pre><code>dict(cls=1)
dict(self=2)
</code></pre>
<p><code>ty check</code> with no custom <code>pyproject.toml</code> configuration results in:</p>
<pre><code>error[parameter-already-assigned]: Multiple values provided for parameter `cls` of function `__new__`
 --&gt; test.py:1:6
  |
1 | dict(cls=1)
  |      ^^^^^
2 | dict(self=2)
  |
info: rule `parameter-already-assigned` is enabled by default

error[no-matching-overload]: No overload of bound method `__init__` matches arguments
 --&gt; test.py:2:1
  |
1 | dict(cls=1)
2 | dict(self=2)
  | ^^^^^^^^^^^^
  |
info: First overload defined here
    --&gt; stdlib/builtins.pyi:2962:9
     |
2960 |     # Also multiprocessing.managers.SyncManager.dict()
2961 |     @overload
2962 |     def __init__(self) -&gt; None: ...
     |         ^^^^^^^^^^^^^^^^^^^^^^
2963 |     @overload
2964 |     def __init__(self: dict[str, _VT], **kwargs: _VT) -&gt; None: ...  # pyright: ignore[reportInvalidTypeVarUse]  #11780
     |
info: Possible overloads for bound method `__init__`:
info:   (self) -&gt; None
info:   (self: dict[str, _VT@dict], **kwargs: _VT@dict) -&gt; None
info:   (self, map: SupportsKeysAndGetItem[_KT@dict, _VT@dict], /) -&gt; None
info:   (self: dict[str, _VT@dict], map: SupportsKeysAndGetItem[str, _VT@dict], /, **kwargs: _VT@dict) -&gt; None
info:   (self, iterable: Iterable[tuple[_KT@dict, _VT@dict]], /) -&gt; None
info:   (self: dict[str, _VT@dict], iterable: Iterable[tuple[str, _VT@dict]], /, **kwargs: _VT@dict) -&gt; None
info:   (self: dict[str, str], iterable: Iterable[list[str]], /) -&gt; None
info:   (self: dict[bytes, bytes], iterable: Iterable[list[bytes]], /) -&gt; None
info: rule `no-matching-overload` is enabled by default

Found 2 diagnostics
</code></pre>
<p>For comparison, <code>mypy --strict</code> does not flag these lines of code.</p>
Version
<p>ty 0.0.11</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-11 17:28</div>
            <div class="timeline-body"><p>Thanks for the report!</p>
<blockquote>
<p>Ty appears to be hard-coded to assume that <code>cls</code> and <code>self</code> are reserved keywords for classes.</p>
</blockquote>
<p>There&#x27;s no hard-coding of this, I can assure you :-)</p>
<p>This looks like a typeshed bug to me, not a ty bug. Passing <code>self</code> as a keyword argument into <code>dict.__init__</code> only works at runtime because <code>dict.__init__</code>&#x27;s first argument is positional-only at runtime. (It <em>cannot</em> be passed via keyword argument at runtime, therefore there&#x27;s no ambiguity about which parameter <code>self=42</code> is &quot;filling&quot; -- it <em>must</em> be the <code>**kwargs</code> keyword-variadic parameter in the signature for <code>dict.__init__</code>.)</p>
<p>We can see here that <code>__init__</code> methods are not treated specially by Python at runtime; it really is illegal to pass the <code>self</code> parameter twice if the <code>self</code> parameter is not positional-only:</p>
<pre><code>Python 3.13.1 (main, Jan  3 2025, 12:04:03) [Clang 15.0.0 (clang-1500.3.9.4)] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; class PositionalOnly:
...     def __init__(self, /, **kwargs): ...
...     
&gt;&gt;&gt; class PosOrKeyword:
...     def __init__(self, **kwargs): ...
...     
&gt;&gt;&gt; PositionalOnly(self=42)
&lt;__main__.PositionalOnly object at 0x101718c20&gt;
&gt;&gt;&gt; PosOrKeyword(self=42)
Traceback (most recent call last):
  File &quot;&lt;python-input-3&gt;&quot;, line 1, in &lt;module&gt;
    PosOrKeyword(self=42)
    ~~~~~~~~~~~~^^^^^^^^^
TypeError: PosOrKeyword.__init__() got multiple values for argument &#x27;self&#x27;
&gt;&gt;&gt; PositionalOnly.__init__(PositionalOnly(), self=42)
&gt;&gt;&gt; PosOrKeyword.__init__(PosOrKeyword(), self=42)
Traceback (most recent call last):
  File &quot;&lt;python-input-5&gt;&quot;, line 1, in &lt;module&gt;
    PosOrKeyword.__init__(PosOrKeyword(), self=42)
    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: PosOrKeyword.__init__() got multiple values for argument &#x27;self&#x27;
</code></pre>
<p>So the fix for this issue will be to make the <code>self</code> parameter positional-only in <a href="https://github.com/python/typeshed/blob/5a45a9a5bcec0c64f7fcaf3db92b9159cee05d9c/stdlib/builtins.pyi#L1178-L1205">these methods</a> upstream. If a PR doing that is accepted, we&#x27;ll automatically reflect the changes in our vendored copy of typeshed&#x27;s stubs after a few days. (We sync our vendored version of typeshed every two weeks.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-11 17:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-11 17:30</div>
            <div class="timeline-body"><blockquote>
<p>For comparison, <code>mypy --strict</code> does not flag these lines of code.</p>
</blockquote>
<p>Indeed. And it also does not emit a diagnostic on this code, even though the code fails at runtime!</p>
<pre><code>class Foo:
    def __init__(self, **kwargs: object) -&gt; None: ...

Foo(self=42)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/adamjstewart">@adamjstewart</a> on 2026-01-11 17:37</div>
            <div class="timeline-body"><blockquote>
<p>Passing <code>self</code> as a keyword argument into <code>dict.__init__</code> only works at runtime because <code>dict.__init__</code>&#x27;s first argument is positional-only. (It cannot be passed via keyword, therefore there&#x27;s no ambiguity about which parameter <code>self=42</code> is &quot;filling&quot; -- it <em>must</em> be the <code>**kwargs</code> keyword-variadic parameter in the signature for <code>dict.__init__</code>.)</p>
</blockquote>
<p>I don&#x27;t fully understand this part. From what I can tell, this is valid Python code:</p>
<pre><code>&gt;&gt;&gt; dict(cls=1, self=2)
{&#x27;cls&#x27;: 1, &#x27;self&#x27;: 2}
&gt;&gt;&gt; dict(self=1, cls=2)
{&#x27;self&#x27;: 1, &#x27;cls&#x27;: 2}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/adamjstewart">@adamjstewart</a> on 2026-01-11 17:40</div>
            <div class="timeline-body"><p>Oh, I think I understand. The code is valid, but ty marks it as invalid because typeshed is incorrect. Let me see if I can work up a PR. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-11 17:41</div>
            <div class="timeline-body"><p>Yes, sorry! The first parameter in typeshed&#x27;s <code>dict.__init__</code> signature is currently marked as positional-or-keyword, but it should be marked as positional-only, and that&#x27;s where the bug is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/adamjstewart">@adamjstewart</a> on 2026-01-11 17:44</div>
            <div class="timeline-body"><p>Based on comments, it seems this was somewhat intentional while mypy caught up to pyright? <a href="https://github.com/python/typeshed/pull/11780">python/typeshed#11780</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-11 17:47</div>
            <div class="timeline-body"><blockquote>
<p>Based on comments, it seems this was somewhat intentional while mypy caught up to pyright? <a href="https://github.com/python/typeshed/pull/11780">python/typeshed#11780</a></p>
</blockquote>
<p>I&#x27;m confused -- I don&#x27;t see any comments in that linked thread that are relevant to what we&#x27;re discussing here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/adamjstewart">@adamjstewart</a> on 2026-01-11 17:48</div>
            <div class="timeline-body"><p>Ah, I&#x27;m talking about comments like:</p>
<pre><code>    @overload
    def __init__(self: dict[str, _VT], **kwargs: _VT) -&gt; None: ...  # pyright: ignore[reportInvalidTypeVarUse]  #11780
</code></pre>
<p>I assume the fix you&#x27;re envisioning is changing this to:</p>
<pre><code>    @overload
    def __init__(self: dict[str, _VT], /, **kwargs: _VT) -&gt; None: ...
</code></pre>
<p>? And I&#x27;m also assuming that this is the reason for the pyright ignore?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-11 17:49</div>
            <div class="timeline-body"><p>That is indeed the fix I&#x27;m envisioning, but that&#x27;s not the reason for the pyright ignore</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-11 17:50</div>
            <div class="timeline-body"><p>I made a PR: <a href="https://github.com/python/typeshed/pull/15262">python/typeshed#15262</a></p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:27:05 UTC
    </footer>
</body>
</html>
