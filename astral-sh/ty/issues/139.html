<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wrong possibly-unbound diagnostic for named expression in Boolean chain - astral-sh/ty #139</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Wrong possibly-unbound diagnostic for named expression in Boolean chain</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/139">#139</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-04-03 08:21
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-03 08:21</div>
            <div class="timeline-body"><p>This seems like a control flow / statically-known-branches bug?</p>
<pre><code class="language-py">def _(flag: bool):
    if flag and (x := 1):
        x  # possibly-unresolved-reference
</code></pre>
<p>(https://play.ty.dev/cc0c8c06-d78f-4b7c-9b3b-d81fdbcea0e2)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @sharkdp on 2025-04-03 08:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Wrong possibly-unbound diagnostic in named expression" to "[red-knot] Wrong possibly-unbound diagnostic for named expression in Boolean chain" by @sharkdp on 2025-04-03 08:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-03 11:38</div>
            <div class="timeline-body"><p>Added it to the &quot;GA&quot; milestone as it's important we fix this, but I don't think walruses are common enough to warrant prioritising it. LMK if you disagree!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2025-05-07 15:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Wrong possibly-unbound diagnostic for named expression in Boolean chain" to "Wrong possibly-unbound diagnostic for named expression in Boolean chain" by @MichaReiser on 2025-05-07 15:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/nickdrozd">@nickdrozd</a> on 2025-05-08 02:47</div>
            <div class="timeline-body"><p>I don't know about others, but I use this pattern all the time. Therefore, currently ty blasts me with false positives.</p>
<p>Here is an example from some code that does algebra stuff:</p>
<pre><code class="language-python">    def __floordiv__(self, other: Count) -&gt; Count:
        if other == 1:
            return self

        assert isinstance(other, int)

        if (((lgcd := gcd(other, l := self.l)) == 1
                or (rgcd := gcd(other, r := self.r))) == 1
                or (div := gcd(lgcd, rgcd)) == 1):
            return make_div(self, other)

        return ((l // div) + (r // div)) // (other // div)
</code></pre>
<p>Admittedly this snippet goes a little overboard with assignment expressions. Still, it works fine. ty flags five variables as possibly unresolved, all false positives.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gusutabopb">@gusutabopb</a> on 2025-05-09 07:47</div>
            <div class="timeline-body"><p>I hit this issue when trying out <code>ty</code> on an existing code base.</p>
<p>Sample code:</p>
<pre><code class="language-python">import random

if (random.random() &gt; 0.5) and (m := random.random()):
    # m is always defined, but ty warns it may not be (incorrect)
    print(m)
</code></pre>
<p>ty output</p>
<pre><code>warning: lint:possibly-unresolved-reference: Name `m` used when possibly not defined
 --&gt; r_and_m.py:5:11
  |
3 | if (random.random() &gt; 0.5) and (m := random.random()):
4 |     # m is always defined. ty warns it may not be (incorrect)
5 |     print(m)
  |           ^
  |
info: `lint:possibly-unresolved-reference` is enabled by default
</code></pre>
<p>Flipping the order of the operators &quot;fixes&quot; the issue though:</p>
<pre><code class="language-python">import random

if (m := random.random()) and (random.random() &gt; 0.5):
    # m is always defined. ty is silent (correct)
    print(m)
</code></pre>
<p>ty output</p>
<pre><code>All checks passed!
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">control flow</span> added by @AlexWaygood on 2025-05-11 07:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">runtime semantics</span> added by @AlexWaygood on 2025-05-11 07:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danielhollas">@danielhollas</a> on 2025-06-07 01:31</div>
            <div class="timeline-body"><p>I've tested all the snippets here (both on the playground and latest alpha.8 version) and none of them report any diagnostics. ðŸŽ‰</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-06-07 01:36</div>
            <div class="timeline-body"><p>I think this bug still exists. It was fixed in https://github.com/astral-sh/ruff/pull/18010, but that caused a performance regression and had to be rolled back, and I don't think we've investigated the root cause of the regression yet in order to try to re-land the fix. The reason there are no longer any diagnostics is that we decided to disable the <code>possibly-unbound-reference</code> diagnostic by default, since it will inevitably have some false positives.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danielhollas">@danielhollas</a> on 2025-06-07 01:44</div>
            <div class="timeline-body"><blockquote>
<p>The reason there are no longer any diagnostics is that we decided to disable the possibly-unbound-reference diagnostic by default, since it will inevitably have some false positives.</p>
</blockquote>
<p>Ah, that's what I was missing, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-06-17 08:12</div>
            <div class="timeline-body"><p>Closing this in favor of https://github.com/astral-sh/ty/issues/626, which has a bit more details on <code>possibly-unresolved-reference</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-06-17 08:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 02:10:52 UTC
    </footer>
</body>
</html>
