<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server panics if `ProgramSettings` of default database are invalid - astral-sh/ty #859</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Server panics if <code>ProgramSettings</code> of default database are invalid</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/859">#859</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2025-07-21 07:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a></div>
            <div class="timeline-body"><p>It appears that ty panics when given an URI that does not point to an actual file (and whose parent isn't a directory):</p>
<details>
<summary>Logs with stack traces</summary>

<pre><code class="language-text">06:52:05,649 INFO   latform.lsp.impl.LspServerImpl - TYServerDescriptor@diagnostics(Initializing;0): Starting LSP server 
06:52:05,649 FINE   on.impl.DaemonCodeAnalyzerImpl - Stopping process: toRestartAlarm true myDisposed false reason: 'Write action finish' 
06:52:05,649 FINE   on.impl.DaemonCodeAnalyzerImpl - Rescheduling highlighting: isDone false 
06:52:05,649 INFO   rm.lsp.api.LspServerDescriptor - TYServerDescriptor@diagnostics: starting LSP server: /home/runner/.local/bin/ty [server] 
06:52:05,649 FINE   figurations.GeneralCommandLine - Executing [/home/runner/.local/bin/ty server] 
06:52:05,649 FINE   figurations.GeneralCommandLine -   environment: {} (+CONSOLE) 
06:52:05,649 FINE   figurations.GeneralCommandLine -   charset: UTF-8 
06:52:05,654 FINE   figurations.GeneralCommandLine - Process /home/runner/.local/bin/ty server started with pid 2908 
06:52:05,655 INFO   latform.lsp.impl.LspServerImpl - TYServerDescriptor@diagnostics(Initializing;0): LSP server process started: /home/runner/.local/bin/ty server 
06:52:05,660 FINE   connector.Lsp4jServerConnector - TYServerDescriptor@diagnostics: LSP server listener thread started 
06:52:05,660 FINE   connector.Lsp4jServerConnector - TYServerDescriptor@diagnostics: initializing LSP server 
06:52:05,668 FINE   connector.Lsp4jServerConnector - --&gt; TYServerDescriptor@diagnostics: {&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:&quot;1&quot;,&quot;method&quot;:&quot;initialize&quot;,&quot;params&quot;:{&quot;processId&quot;:null,&quot;rootPath&quot;:&quot;/src&quot;,&quot;rootUri&quot;:&quot;file:///src&quot;,&quot;initializationOptions&quot;:{},&quot;capabilities&quot;:{&quot;workspace&quot;:{&quot;applyEdit&quot;:true,&quot;workspaceEdit&quot;:{&quot;documentChanges&quot;:true,&quot;resourceOperations&quot;:[&quot;create&quot;],&quot;failureHandling&quot;:&quot;abort&quot;,&quot;normalizesLineEndings&quot;:true},&quot;didChangeWatchedFiles&quot;:{&quot;relativePatternSupport&quot;:true,&quot;dynamicRegistration&quot;:true},&quot;executeCommand&quot;:{&quot;dynamicRegistration&quot;:false},&quot;workspaceFolders&quot;:true,&quot;semanticTokens&quot;:{&quot;refreshSupport&quot;:true}},&quot;textDocument&quot;:{&quot;synchronization&quot;:{&quot;willSave&quot;:false,&quot;willSaveWaitUntil&quot;:false,&quot;didSave&quot;:true,&quot;dynamicRegistration&quot;:false},&quot;completion&quot;:{&quot;completionItem&quot;:{&quot;snippetSupport&quot;:true,&quot;documentationFormat&quot;:[&quot;markdown&quot;,&quot;plaintext&quot;],&quot;deprecatedSupport&quot;:true,&quot;tagSupport&quot;:{&quot;valueSet&quot;:[1]},&quot;insertReplaceSupport&quot;:true,&quot;resolveSupport&quot;:{&quot;properties&quot;:[&quot;documentation&quot;]},&quot;labelDetailsSupport&quot;:true},&quot;completionItemKind&quot;:{&quot;valueSet&quot;:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25]},&quot;completionList&quot;:{&quot;itemDefaults&quot;:[&quot;commitCharacters&quot;,&quot;editRange&quot;,&quot;insertTextFormat&quot;,&quot;insertTextMode&quot;,&quot;data&quot;]}},&quot;hover&quot;:{&quot;contentFormat&quot;:[&quot;markdown&quot;,&quot;plaintext&quot;]},&quot;references&quot;:{&quot;dynamicRegistration&quot;:true},&quot;formatting&quot;:{&quot;dynamicRegistration&quot;:true},&quot;definition&quot;:{&quot;linkSupport&quot;:true},&quot;typeDefinition&quot;:{&quot;linkSupport&quot;:true},&quot;codeAction&quot;:{&quot;codeActionLiteralSupport&quot;:{&quot;codeActionKind&quot;:{&quot;valueSet&quot;:[&quot;quickfix&quot;,&quot;&quot;,&quot;source&quot;,&quot;refactor&quot;]}},&quot;disabledSupport&quot;:true,&quot;dataSupport&quot;:true,&quot;resolveSupport&quot;:{&quot;properties&quot;:[&quot;edit&quot;]}},&quot;documentLink&quot;:{&quot;tooltipSupport&quot;:true,&quot;dynamicRegistration&quot;:true},&quot;colorProvider&quot;:{&quot;dynamicRegistration&quot;:true},&quot;publishDiagnostics&quot;:{&quot;tagSupport&quot;:{&quot;valueSet&quot;:[1,2]},&quot;versionSupport&quot;:true,&quot;dataSupport&quot;:true},&quot;semanticTokens&quot;:{&quot;requests&quot;:{&quot;range&quot;:false,&quot;full&quot;:{&quot;delta&quot;:false}},&quot;tokenTypes&quot;:[&quot;namespace&quot;,&quot;type&quot;,&quot;class&quot;,&quot;enum&quot;,&quot;interface&quot;,&quot;struct&quot;,&quot;typeParameter&quot;,&quot;parameter&quot;,&quot;variable&quot;,&quot;property&quot;,&quot;enumMember&quot;,&quot;event&quot;,&quot;function&quot;,&quot;method&quot;,&quot;macro&quot;,&quot;keyword&quot;,&quot;modifier&quot;,&quot;comment&quot;,&quot;string&quot;,&quot;number&quot;,&quot;regexp&quot;,&quot;operator&quot;,&quot;decorator&quot;],&quot;tokenModifiers&quot;:[&quot;declaration&quot;,&quot;definition&quot;,&quot;readonly&quot;,&quot;static&quot;,&quot;deprecated&quot;,&quot;abstract&quot;,&quot;async&quot;,&quot;modification&quot;,&quot;documentation&quot;,&quot;defaultLibrary&quot;],&quot;formats&quot;:[&quot;relative&quot;],&quot;overlappingTokenSupport&quot;:true,&quot;multilineTokenSupport&quot;:true,&quot;serverCancelSupport&quot;:false}},&quot;window&quot;:{&quot;showMessage&quot;:{},&quot;showDocument&quot;:{&quot;support&quot;:true}},&quot;general&quot;:{&quot;staleRequestSupport&quot;:{&quot;cancel&quot;:true,&quot;retryOnContentModified&quot;:[]}}},&quot;clientInfo&quot;:{&quot;name&quot;:&quot;PyCharm&quot;,&quot;version&quot;:&quot;251.26927.90&quot;},&quot;workspaceFolders&quot;:[{&quot;uri&quot;:&quot;file:///src&quot;,&quot;name&quot;:&quot;src&quot;}]}} 
06:52:05,668 FINE   connector.Lsp4jServerConnector - &lt;-- TYServerDescriptor@diagnostics: {&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:&quot;1&quot;,&quot;result&quot;:{&quot;capabilities&quot;:{&quot;completionProvider&quot;:{&quot;triggerCharacters&quot;:[&quot;.&quot;]},&quot;declarationProvider&quot;:true,&quot;definitionProvider&quot;:true,&quot;diagnosticProvider&quot;:{&quot;identifier&quot;:&quot;ty&quot;,&quot;interFileDependencies&quot;:true,&quot;workspaceDiagnostics&quot;:false},&quot;hoverProvider&quot;:true,&quot;inlayHintProvider&quot;:{},&quot;positionEncoding&quot;:&quot;utf-16&quot;,&quot;semanticTokensProvider&quot;:{&quot;full&quot;:true,&quot;legend&quot;:{&quot;tokenModifiers&quot;:[&quot;definition&quot;,&quot;readonly&quot;,&quot;async&quot;],&quot;tokenTypes&quot;:[&quot;namespace&quot;,&quot;class&quot;,&quot;parameter&quot;,&quot;selfParameter&quot;,&quot;clsParameter&quot;,&quot;variable&quot;,&quot;property&quot;,&quot;function&quot;,&quot;method&quot;,&quot;keyword&quot;,&quot;string&quot;,&quot;number&quot;,&quot;decorator&quot;,&quot;builtinConstant&quot;,&quot;typeParameter&quot;]},&quot;range&quot;:true},&quot;signatureHelpProvider&quot;:{&quot;retriggerCharacters&quot;:[&quot;)&quot;],&quot;triggerCharacters&quot;:[&quot;(&quot;,&quot;,&quot;]},&quot;textDocumentSync&quot;:{&quot;change&quot;:2,&quot;openClose&quot;:true},&quot;typeDefinitionProvider&quot;:true},&quot;serverInfo&quot;:{&quot;name&quot;:&quot;ty&quot;,&quot;version&quot;:&quot;0.0.1-alpha.15&quot;}}} 
06:52:05,674 FINE   connector.Lsp4jServerConnector - --&gt; TYServerDescriptor@diagnostics: {&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;initialized&quot;,&quot;params&quot;:{}} 
06:52:05,674 INFO   latform.lsp.impl.LspServerImpl - TYServerDescriptor@diagnostics(Running;0): LSP server initialized in 0.025s, name = ty, version = 0.0.1-alpha.15 
06:52:05,676 FINE   connector.Lsp4jServerConnector - &lt;-- TYServerDescriptor@diagnostics: {&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:0,&quot;method&quot;:&quot;workspace/configuration&quot;,&quot;params&quot;:{&quot;items&quot;:[{&quot;scopeUri&quot;:&quot;file:///src&quot;,&quot;section&quot;:&quot;ty&quot;}]}} 
06:52:05,678 FINE   connector.Lsp4jServerConnector - --&gt; TYServerDescriptor@diagnostics: {&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:0,&quot;result&quot;:[null]} 
06:52:05,678 FINE   connector.Lsp4jServerConnector - &lt;-- TYServerDescriptor@diagnostics: {&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:1,&quot;method&quot;:&quot;client/registerCapability&quot;,&quot;params&quot;:{&quot;registrations&quot;:[{&quot;id&quot;:&quot;workspace/didChangeWatchedFiles&quot;,&quot;method&quot;:&quot;workspace/didChangeWatchedFiles&quot;,&quot;registerOptions&quot;:{&quot;watchers&quot;:[{&quot;globPattern&quot;:&quot;**/ty.toml&quot;},{&quot;globPattern&quot;:&quot;**/.gitignore&quot;},{&quot;globPattern&quot;:&quot;**/.ignore&quot;},{&quot;globPattern&quot;:&quot;**/pyproject.toml&quot;},{&quot;globPattern&quot;:&quot;**/*.py&quot;},{&quot;globPattern&quot;:&quot;**/*.pyi&quot;},{&quot;globPattern&quot;:&quot;**/*.ipynb&quot;}]}}]}} 
06:52:05,678 INFO   latform.lsp.impl.LspServerImpl - TYServerDescriptor@diagnostics(Running;0): STDERR: 2025-07-21 06:52:05.678331553  WARN Failed to deserialize workspace options for file:///src: invalid type: null, expected struct ClientOptions. Using default options. 
06:52:05,678 INFO   latform.lsp.impl.LspServerImpl - TYServerDescriptor@diagnostics(Running;0): STDERR: 2025-07-21 06:52:05.678617249 ERROR Failed to create project for `/src`: Failed to discover project configuration: project path '/src' is not a directory. Falling back to default settings 
06:52:05,679 FINE   connector.Lsp4jServerConnector - --&gt; TYServerDescriptor@diagnostics: {&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:1,&quot;result&quot;:null} 
06:52:05,679 FINE   connector.Lsp4jServerConnector - &lt;-- TYServerDescriptor@diagnostics: {&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;window/showMessage&quot;,&quot;params&quot;:{&quot;message&quot;:&quot;Failed to load project rooted at /src. Please refer to the logs for more details.&quot;,&quot;type&quot;:1}} 
06:52:05,680 INFO   latform.lsp.impl.LspServerImpl - TYServerDescriptor@diagnostics(Running;0): window/showMessage: Failed to load project rooted at /src. Please refer to the logs for more details. 
06:52:05,682 FINE   latform.lsp.impl.LspServerImpl - TYServerDescriptor@diagnostics(Running;0): Opening files after server initialization or after move/rename: [temp:///src/invalid-assignment.py] 
06:52:05,682 FINE   on.impl.DaemonCodeAnalyzerImpl - Stopping process: toRestartAlarm true myDisposed false reason: 'Write action finish' 
06:52:05,682 FINE   on.impl.DaemonCodeAnalyzerImpl - Rescheduling highlighting: isDone false 
06:52:05,683 FINE   connector.Lsp4jServerConnector - --&gt; TYServerDescriptor@diagnostics: {&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;textDocument/didOpen&quot;,&quot;params&quot;:{&quot;textDocument&quot;:{&quot;uri&quot;:&quot;file:///src/invalid-assignment.py&quot;,&quot;languageId&quot;:&quot;python&quot;,&quot;version&quot;:2,&quot;text&quot;:&quot;a: str = 1\n&quot;}}} 
06:52:05,685 INFO   latform.lsp.impl.LspServerImpl - TYServerDescriptor@diagnostics(Running;1): STDERR: 2025-07-21 06:52:05.685708676  INFO Defaulting to python-platform `linux` 
06:52:05,686 INFO   latform.lsp.impl.LspServerImpl - TYServerDescriptor@diagnostics(Running;1): STDERR: 2025-07-21 06:52:05.686029436 ERROR panicked at crates/ty_server/src/session.rs:364:30: 
Default configuration to be valid: /src does not point to a directory 
   0: &lt;unknown&gt; 
   1: &lt;unknown&gt; 
   2: &lt;unknown&gt; 
   3: &lt;unknown&gt; 
   4: &lt;unknown&gt; 
   5: &lt;unknown&gt; 
   6: &lt;unknown&gt; 
   7: &lt;unknown&gt; 
   8: &lt;unknown&gt; 
   9: &lt;unknown&gt; 
  10: &lt;unknown&gt; 
  11: &lt;unknown&gt; 
  12: &lt;unknown&gt; 
 
panicked at crates/ty_server/src/session.rs:364:30: 
Default configuration to be valid: /src does not point to a directory 
   0: &lt;unknown&gt; 
   1: &lt;unknown&gt; 
   2: &lt;unknown&gt; 
   3: &lt;unknown&gt; 
   4: &lt;unknown&gt; 
   5: &lt;unknown&gt; 
   6: &lt;unknown&gt; 
   7: &lt;unknown&gt; 
   8: &lt;unknown&gt; 
   9: &lt;unknown&gt; 
  10: &lt;unknown&gt; 
  11: &lt;unknown&gt; 
  12: &lt;unknown&gt; 
06:52:05,687 INFO   latform.lsp.impl.LspServerImpl - TYServerDescriptor@diagnostics(Running;1): STDERR: 2025-07-21 06:52:05.687145482 ERROR panicked at /root/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/jod-thread-1.0.0/src/lib.rs:33:22: 
called `Result::unwrap()` on an `Err` value: Any { .. } 
   0: &lt;unknown&gt; 
   1: &lt;unknown&gt; 
   2: &lt;unknown&gt; 
   3: &lt;unknown&gt; 
   4: &lt;unknown&gt; 
   5: &lt;unknown&gt; 
   6: &lt;unknown&gt; 
   7: &lt;unknown&gt; 
   8: &lt;unknown&gt; 
   9: &lt;unknown&gt; 
  10: &lt;unknown&gt; 
  11: &lt;unknown&gt; 
  12: &lt;unknown&gt; 
  13: &lt;unknown&gt; 
  14: &lt;unknown&gt; 
  15: __libc_start_main 
  16: &lt;unknown&gt; 
 
panicked at /root/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/jod-thread-1.0.0/src/lib.rs:33:22: 
called `Result::unwrap()` on an `Err` value: Any { .. } 
   0: &lt;unknown&gt; 
   1: &lt;unknown&gt; 
   2: &lt;unknown&gt; 
   3: &lt;unknown&gt; 
   4: &lt;unknown&gt; 
   5: &lt;unknown&gt; 
   6: &lt;unknown&gt; 
   7: &lt;unknown&gt; 
   8: &lt;unknown&gt; 
   9: &lt;unknown&gt; 
  10: &lt;unknown&gt; 
  11: &lt;unknown&gt; 
  12: &lt;unknown&gt; 
  13: &lt;unknown&gt; 
  14: &lt;unknown&gt; 
  15: __libc_start_main 
  16: &lt;unknown&gt; 
06:52:05,689 INFO   latform.lsp.impl.LspServerImpl - TYServerDescriptor@diagnostics(Running;1): LSP server process terminated. Exit code: 101
</code></pre>
</details>

<p>The URI is from a test framework (IntelliJ's). That ty can't resolve things is expected, but it shouldn't panic here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-21 07:14</div>
            <div class="timeline-body"><blockquote>
<p>The URI is from a test framework (IntelliJ's). That ty can't resolve things is expected, but it shouldn't panic here.</p>
</blockquote>
<p>Fair. It's not entirely clear what ty should do in this case. I guess the easiest is to simply ignore this owrkspace all together. But I'm not sure if this is more useful in your case.</p>
<p>Can you tell us more what this test framework is doing? Is it to test LSP functionality?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2025-07-21 07:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fatal</span> added by @MichaReiser on 2025-07-21 07:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-07-21 07:24</div>
            <div class="timeline-body"><p>The framework is used under the hood by many tests within the IntelliJ code base (and so is not specifically used to test language servers). On setup, it creates a mock project at some temporary directory; this mock project's path is also set to a mock URI (here, <code>temp:///src</code>).</p>
<p>I don't actually understand it either. All I know is that it works in such a manner by default.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Invalid URIs cause panic" to "Invalid workspace root URIs cause panic" by @MichaReiser on 2025-07-21 07:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Beta" by @MichaReiser on 2025-07-28 06:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Invalid workspace root URIs cause panic" to "Server panics if `ProgramSettings` of default database aren't invalid" by @MichaReiser on 2025-07-28 07:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-28 07:01</div>
            <div class="timeline-body"><p>Note, this is also an issue outside tests, e.g .when the <code>VIRTUALEN_ENV</code> variable points to an invalid directory as described here https://github.com/astral-sh/ty/issues/611#issuecomment-3123403717</p>
<p>Overall, my assumption that resolving the default <code>ProgramSettings</code> can never fail was incorrect.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @Gankra by @Gankra on 2025-08-22 14:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-11-12 21:33</div>
            <div class="timeline-body"><p>Status: none of the reported ways of inducing a crash happen anymore. Without any known crashers, we maybe should just close? (If anyone knows other settings-based-crashers, do speak up).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Gankra on 2025-11-13 18:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @zanieb on 2025-12-17 20:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-17 20:48</div>
            <div class="timeline-body"><p>Opening because https://github.com/astral-sh/ty/issues/2031 encounters this panic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Server panics if `ProgramSettings` of default database aren't invalid" to "Server panics if `ProgramSettings` of default database are invalid" by @carljm on 2025-12-17 21:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Gankra on 2025-12-18 14:47</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:20:20 UTC
    </footer>
</body>
</html>
