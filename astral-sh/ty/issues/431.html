<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance regression in 0.0.1a4 - astral-sh/ty #431</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Performance regression in 0.0.1a4</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/431">#431</a>
        opened by <a href="https://github.com/danielhollas">@danielhollas</a>
        on 2025-05-16 21:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/danielhollas">@danielhollas</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>I noticed a big performance regression in the latest release. Ultimately (and to my surprise) I was able to produce the following very simple reproducer:</p>
<pre><code class="language-python">from pathlib import Path

def func(p: Path) -&gt; None:
     p.read_bytes()
</code></pre>
<pre><code class="language-console">/tmp via C v13.3.1-gcc via üêç v3.12.7 
‚ùØ time uvx ty@0.0.1a4 check test.py 
WARN ty is pre-release software and not ready for production use. Expect to encounter bugs, missing features, and fatal errors.
All checks passed!

real	0m0.891s
user	0m0.723s
sys	0m0.165s
/tmp via C v13.3.1-gcc via üêç v3.12.7 
‚ùØ time uvx ty@0.0.1a3 check test.py 
WARN ty is pre-release software and not ready for production use. Expect to encounter bugs, missing features, and fatal errors.
All checks passed!

real	0m0.070s
user	0m0.025s
sys	0m0.033s
</code></pre>
<p>I am honestly still thinking that I clearly must be doing something wrong... üò∞</p>
<p>I have bisected the issue to this PR: https://github.com/astral-sh/ruff/pull/18010
(this is my first time bisecting a rust program so I might have messed up somewhere).</p>
<p>Running with debug output reveales that the execution &quot;freezes&quot; always at this output:</p>
<pre><code>  2025-05-16T21:50:37.723099Z  INFO ty_project: Indexed 1 file(s)
    at crates/ty_project/src/lib.rs:421 on ThreadId(2)
    in ty_project::Project::index_files with project=tmp
    in ty_project::Project::check

Checking ------------------------------------------------------------ 0/1 files                                                             2025-05-16T21:50:37.723229Z DEBUG ty_python_semantic::types: Checking file '/tmp/test.py'
    at crates/ty_python_semantic/src/types.rs:88 on ThreadId(2)
    in ty_project::check_file with file=file(Id(800))
    in ty_project::Project::check
</code></pre>
<p>But the only thing after that is</p>
<pre><code>All checks passed!
  2025-05-16T21:50:38.568862Z DEBUG ty: Exiting main loop
    at crates/ty/src/lib.rs:227 on ThreadId(1)
</code></pre>
<h3>Version</h3>
<p>0.0.1a4</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @AlexWaygood on 2025-05-16 21:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danielhollas">@danielhollas</a> on 2025-05-16 22:01</div>
            <div class="timeline-body"><p>Hmm, <code>tomllib</code> does not depend on <code>pathlib</code> so it is at least conceivable that this was missed in Codspeed benchmarks? I also don't see any 800ms sleep added anywhere in https://github.com/astral-sh/ruff/pull/18010? üòÖ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/danielhollas">@danielhollas</a> on 2025-05-17 00:18</div>
            <div class="timeline-body"><p>I added the code snippet from above to the vendored tomllib package that's used to benchmark ty   and indeed Codspeed is <strong>not</strong> happy.</p>
<p>https://github.com/astral-sh/ruff/pull/18145#issuecomment-2887873362</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-05-17 11:42</div>
            <div class="timeline-body"><p>Thanks for reporting and bisecting this! Taking a look.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-05-17 12:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-05-17 12:36</div>
            <div class="timeline-body"><p>Reverted the offending change for now so we can make a fixed release; will dig further into the cause of the regression later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-05-17 12:39</div>
            <div class="timeline-body"><p>(Once we identify the root cause, we should also add a benchmark which would have caught this.)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:19:55 UTC
    </footer>
</body>
</html>
