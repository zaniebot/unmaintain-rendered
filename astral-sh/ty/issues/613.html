<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server setting related errors are reported for the Python file - astral-sh/ty #613</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Server setting related errors are reported for the Python file</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/613">#613</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-06-09 07:09
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-09 07:09</div>
            <div class="timeline-body"><p>I've a <code>main.py</code> with an unresolved reference error and an error in my pyproject.toml</p>
<p>The server groups the pyproject.error under the <code>main.py</code></p>
<p><code>pyproject.toml</code>:</p>
<pre><code class="language-toml">[project]
name = &quot;micha-test&quot;

[tool.ty.src]
exclude = [&quot;***&quot;]

</code></pre>
<p><code>main.py</code>:</p>
<pre><code class="language-py">def foo(a: str | None, b):
	if a is not None:
	   print(a)

unresolved

</code></pre>
<p><img width="942" alt="Image" src="https://github.com/user-attachments/assets/59b2e9c5-eeea-4fdb-a772-1ac2b66924cb" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2025-06-09 07:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2025-06-09 07:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-06-09 08:38</div>
            <div class="timeline-body"><p>Is this on <code>main</code>? Due to https://github.com/astral-sh/ty/issues/76, I'm unable to get this as an error.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-09 14:36</div>
            <div class="timeline-body"><p>Yes and no. It's on my include/exclude branch but I think it's a pre existing problem. You need to start with a valid configuration or the server crashes. Then make changes which the server picks up</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-09 15:56</div>
            <div class="timeline-body"><p>The reason for this behavior is the code here</p>
<p>https://github.com/astral-sh/ruff/blob/b44062b9ae08dcd8941ac76dbce2ab2c61840691/crates/ty_project/src/lib.rs#L251-L256</p>
<p>The benefit it has is that setting related diagnostics show up even if only calling <code>check_file</code> and never <code>check</code>. The downside is that the file is incorrect.</p>
<p>We should probably remove the setting diagnostics from there and find another way to expose them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "server: setting related errors are reported for the python file." to "Server setting related errors are reported for the Python file" by @dhruvmanila on 2025-06-25 09:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-07-08 13:10</div>
            <div class="timeline-body"><p>My initial feeling is we want to send a <a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#window_showMessageRequest">ShowMessage</a> request if we encounter a settings diagnostic (prompting the user to open the file and then get in-file diagnostics). I'll look at what other LSPs do here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-07-08 13:19</div>
            <div class="timeline-body"><p>rust-analyzer reserves this little button which goes yellow when this kind of issue occurs. you have to just notice it and hover your mouse over it (or click it to go to rust-analyzer's global logs). Not the UX we want.</p>
<p><img width="1358" height="871" alt="Image" src="https://github.com/user-attachments/assets/a7270c2c-25e8-48e8-a5a5-463201d13014" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-07-08 13:26</div>
            <div class="timeline-body"><p>By contrast pylance/pyright seems to simply take every possible configuration error in stride? Like if you properly define settings it will respect them, but if you mess them up in anyway it will act like they're not there... I also don't really love this, but it's certainly implementable.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-08 14:02</div>
            <div class="timeline-body"><blockquote>
<p>Like if you properly define settings it will respect them, but if you mess them up in anyway it will act like they're not there... I also don't really love this, but it's certainly implementable.</p>
</blockquote>
<p>This touches on https://github.com/astral-sh/ty/issues/76. I'm not sure what we currently do if the settings are invalid during startup (I think we simply panic) but ty preserves the old configuration if a user makes changes and the configuration then becomes invalid. For this issue, we can focus on how we want to surface those configuration errors, specifically how we want to do this if the check mode is <code>OpenFiles</code>.</p>
<p>The reason configuration files need special handling is because our LSP doesn't promote that our extension can handle <code>pyproject.toml</code> or <code>ty.toml</code> files. I see two solutions:</p>
<ol>
<li>Add <code>pyproject.toml</code> and <code>ty.toml</code> files to the support files. Surface the setting diagnostics if <code>check_file</code> is called with the corresponding configuration file. I feel like this is a more invasive change and it's not quiet clear to me where this breaks our current architecture. Which is why I'd probably go with 2.</li>
<li>Use the LSPs publish diagnostic to:</li>
</ol>
<ul>
<li>Publish the initiale diagnostics after the project was opened</li>
<li>Re-Publish the diagnostics after a change to a <code>ty.toml</code> or <code>project.toml</code></li>
<li>Clearing the diagnostics after closing a project (not something that can easily be tested today)</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @Gankra by @MichaReiser on 2025-07-08 14:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2025-07-08 14:28</div>
            <div class="timeline-body"><p>Looking into option 2.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/erictraut">@erictraut</a> on 2025-07-08 16:03</div>
            <div class="timeline-body"><blockquote>
<p>By contrast pylance/pyright seems to simply take every possible configuration error in stride?</p>
</blockquote>
<p>When pyright detects a config error, it emits an error message to a log. If it's the CLI version of the pyright, this error text is output directly to stdout (or stderr if the user has requested JSON output in stdout). If pyright is run as a language server, this log information is output using the <a href="https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#logTrace">LogTrace</a> mechanism in the language server protocol. In VS Code, this appears in the &quot;Output&quot; tab. That's admittedly not very discoverable for language server users.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-23 08:49</div>
            <div class="timeline-body"><p>This has been fixed in the latest release.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-07-23 08:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 02:11:10 UTC
    </footer>
</body>
</html>
