<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>workspace symbols request failing - astral-sh/ty #1844</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>workspace symbols request failing</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1844">#1844</a>
        opened by <a href="https://github.com/insane-dreamer">@insane-dreamer</a>
        on 2025-12-10 18:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/insane-dreamer">@insane-dreamer</a> on 2025-12-10 18:30</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>When using the &quot;search symbol&quot; feature in <code>zed</code> no results are shown, and <code>ty</code> panics with:</p>
<pre><code>2025-12-10T10:15:56-08:00 INFO  [lsp] starting language server process. binary path: &quot;/home/sean/.local/share/zed/languages/ty/ty-0.0.1-alpha.33/ty-x86_64-unknown-linux-gnu/ty&quot;, working directory: &quot;/home/sean/dev/cpe&quot;, args: [&quot;server&quot;]
2025-12-10T10:16:01-08:00 ERROR [crates/project/src/lsp_store.rs:7620] workspace symbols request

Caused by:
    request handler panicked at crates/ruff_source_file/src/line_index.rs:198:44:
    byte index 40962 is out of bounds of `&quot;&quot;&quot;
    import os
    import logging
    from ...engine import *
    import numpy as np
    
    from .channel_space import internalize_coo`[...]
    run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre>
<p>the issue isn't specific to the above file. If I remove that file and restart the server, it errors on the next file it hits:</p>
<pre><code>2025-12-10T10:21:31-08:00 ERROR [crates/project/src/lsp_store.rs:7620] workspace symbols request

Caused by:
    request handler panicked at crates/ruff_source_file/src/line_index.rs:198:44:
    byte index 12080 is out of bounds of `import unittest
    import logging
    import numpy as np
    from neuropype.engine import *
    from neuropype.nodes import ROIActivations, ROIsToVertices
    from neuropype.utilities.testing import expect_exception
    
    
    logger = logging.getLogger(__name__)
    
    
    class ROIsTestCase`[...]
    run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre>
<p>In both cases the trace shows a backtick on the last line  ``` that is not in the actual code.</p>
<h3>Version</h3>
<p>0.0.1-alpha.33, on Ubuntu 24.04</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @AlexWaygood on 2025-12-10 18:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fatal</span> added by @AlexWaygood on 2025-12-10 18:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-11 09:07</div>
            <div class="timeline-body"><p>Thanks for reporting. Curious. This either suggests that our internal document state is outdated or the byte index is indeed out of bounds. I tried workspace symbols across a few projects in Zed and unfortunately wasn't able to reproduce the issue.</p>
<p>Would you be able to share the entire source text of the file for which the request failed (the file containing <code>class ROIsTestCase</code>[...]`)?</p>
<p>The last backtick is from the panick message. There's also a backtick before the <code>import unittest</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-info</span> added by @MichaReiser on 2025-12-11 09:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/insane-dreamer">@insane-dreamer</a> on 2025-12-11 17:09</div>
            <div class="timeline-body"><p>Here is the second file. I ran it again and confirmed it produced the same error.
Also:</p>
<ul>
<li><p><code>basedpyright</code> works ok on this same project (with this same  file) -- and search by symbol works if I disable <code>ty</code> and select <code>basedpyright</code> in my settings.</p>
</li>
<li><p><code>ty</code> works ok on other projects I tested (though it only partially finds all the symbols, but I'll file that as a separate issue)</p>
</li>
</ul>
<p><a href="https://github.com/user-attachments/files/24107909/test_rois.zip">test_rois.zip</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/insane-dreamer">@insane-dreamer</a> on 2025-12-11 19:24</div>
            <div class="timeline-body"><p>@MichaReiser forgot to tag you in above response</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-11 19:26</div>
            <div class="timeline-body"><p>Tagging isn't necessary. I'm subscribed to all issues :)</p>
<p>Hmm, I tried your file but ty just doesn't want to crash...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/insane-dreamer">@insane-dreamer</a> on 2025-12-11 20:37</div>
            <div class="timeline-body"><p>I tried moving the file I sent you into its own project and it works fine there. But it reliably crashes when used in the main project (which I can't post here). Could there be a stale <code>ty</code> index that needs to be reset on the project? How would I test that?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-12 10:10</div>
            <div class="timeline-body"><blockquote>
<p>But it reliably crashes when used in the main project (which I can't post here)</p>
</blockquote>
<p>Interesting. I wonder if ty ends up confusing two files. Do you use any symlinking in your project?</p>
<blockquote>
<p>Could there be a stale ty index that needs to be reset on the project? How would I test that?</p>
</blockquote>
<p>ty doesn't use any persistent caching. Just restarting the server (or VS Code) should be enough to get a &quot;clean&quot; start</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/insane-dreamer">@insane-dreamer</a> on 2025-12-12 17:25</div>
            <div class="timeline-body"><p>@MichaReiser I made a clean pull of the repo with the offending project, and same issue.</p>
<p>I'm deleting the files that <code>ty</code> is panicking on, and seeing a couple of patterns which may be clues.  I haven't found them all yet, so it's definitely not just one or two files that might somehow be corrupt. It's crashing on specific things in those files, though not when the file is in a project by its own.</p>
<p>After deleting 7 files in the codebase I finally got it to where <code>ty</code> was no longer panicking and symbol search is working (not sure if it's returning all results but that's a separate issue).</p>
<p>I noticed two patterns:</p>
<ul>
<li>a few of the files have an &quot;unresolve-attribute&quot; error flagged by <code>ty</code>:</li>
</ul>
<p><img width="1043" height="129" alt="Image" src="https://github.com/user-attachments/assets/ca003c07-a8b1-435b-9d53-039e3a8fedf4" /></p>
<ul>
<li>a couple other files have docstrings with non-ascii characters:</li>
</ul>
<p><img width="782" height="106" alt="Image" src="https://github.com/user-attachments/assets/0431678c-8265-411f-8da0-2f125d0f506f" /></p>
<p>In these cases, I deleted the docstring, and <code>ty</code> no longer panicked on the file. So pretty sure that is one issue.</p>
<p>On the other hand, one of the files it panicked on had neither of the above conditions -- couldn't see anything unusual with it at all.</p>
<p>I can't post the files here, but hopefully the above helps to narrow it down.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-12 17:52</div>
            <div class="timeline-body"><p>Thanks for going so deep on this investigation. Non ASCII characters are certainly a strong suspect. Out of interest, can you also reproduce the crashes when using VS Code?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/insane-dreamer">@insane-dreamer</a> on 2025-12-12 18:07</div>
            <div class="timeline-body"><p>I don't use VSCode or have it installed, so couldn't say.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Stable" by @MichaReiser on 2025-12-31 15:41</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:51:35 UTC
    </footer>
</body>
</html>
