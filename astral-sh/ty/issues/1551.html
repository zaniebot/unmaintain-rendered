<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test server: Swallows test errors because it throws an exception that there are unawaited responses - astral-sh/ty #1551</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Test server: Swallows test errors because it throws an exception that there are unawaited responses</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1551">#1551</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-11-14 11:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-14 11:40</div>
            <div class="timeline-body"><p>The <code>Drop</code> handler of the test server contains an assertion that all messages were processed. This assertion runs except when a test panicks.</p>
<p>However, most tests don't panic if an expected message wasn't received, instead, they exit early with an <code>Err</code> result. In this case, the assertion in the drop handler still runs which is then very likely to panic because the test didn't get a chance to consume all its expected messages (if it expects two different kind of mesages).</p>
<p>I think we should simply remove the assertion. Tests that want to assert that all messages were consumed can do so by calling the existing method (we can make it public) at the end of the test.</p>
<p>The only assertion that I think we want to keep is that the server doesn't send any new messages after shutdown.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @MichaReiser on 2025-11-14 11:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @AlexWaygood on 2025-11-14 11:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-14 18:48</div>
            <div class="timeline-body"><p>I think what we have in #21451 should be sufficient for most tests. It's still a bit of a footgun but only very few tests use the <code>try_</code> variants (and they either panic or ignore the error, so they're not affected by the outlined issue)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-11-14 18:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 02:11:41 UTC
    </footer>
</body>
</html>
