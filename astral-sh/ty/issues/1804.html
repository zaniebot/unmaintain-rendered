<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`async with` usage with `asynccontextmanager`-decorated function results in `Unknown` - astral-sh/ty #1804</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>async with</code> usage with <code>asynccontextmanager</code>-decorated function results in <code>Unknown</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1804">#1804</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-12-08 11:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-12-08 11:58</div>
            <div class="timeline-body"><p>Consider the following example, where the usage of a <code>asynccontextmanager</code>-decorated function in an <code>async with</code> statement results in an <code>Unknown</code> type:</p>
<pre><code class="language-py">from contextlib import asynccontextmanager
from typing import AsyncGenerator

class Session: ...

@asynccontextmanager
async def connect() -&gt; AsyncGenerator[Session]:
    yield Session()


async def main():
    async with connect() as session:
        # TODO: should be `Session`
        reveal_type(session)  # revealed: Unknown
</code></pre>
<p>https://play.ty.dev/8f142494-1d12-48fd-8ea5-005b1bdf62dd</p>
<p>The problem is that we currently infer <code>() -&gt; _AsyncGeneratorContextManager[Unknown, None]</code> for <code>connect</code>. The signature of <code>asynccontextmanager</code> is:</p>
<pre><code class="language-py">def asynccontextmanager(func: Callable[_P, AsyncIterator[_T_co]]) -&gt; Callable[_P, _AsyncGeneratorContextManager[_T_co]]
</code></pre>
<p>so this requires generics-solver support for <code>Callable</code> and generic protocols.</p>
<p>Note that we have a test for this here: https://github.com/astral-sh/ruff/blob/a364195335eb920ff429c43832c4ee464051ea9a/crates/ty_python_semantic/resources/mdtest/with/async.md?plain=1#L203-L222</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">generics</span> added by @sharkdp on 2025-12-08 11:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Beta" by @sharkdp on 2025-12-08 11:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AlexWaygood by @carljm on 2025-12-08 17:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dcreager by @carljm on 2025-12-08 17:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-12-09 21:49</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 11:41:24 UTC
    </footer>
</body>
</html>
