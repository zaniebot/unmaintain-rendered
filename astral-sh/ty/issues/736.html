<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Failing to catch return type mismatch in async functions only - astral-sh/ty #736</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Failing to catch return type mismatch in async functions only</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/736">#736</a>
        opened by <a href="https://github.com/rian-dolphin">@rian-dolphin</a>
        on 2025-07-01 08:37
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/rian-dolphin">@rian-dolphin</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>ty correctly identifies return type mismatches in synchronous functions but doesn't catch the same error in async functions.</p>
<h2>Minimal Reproducible Example</h2>
<h3>Sync version (works correctly)</h3>
<pre><code class="language-python"># sync_test.py
class ExpectedOutput:
    def __init__(self, data: str):
        self.data = data

class ResultWrapper:
    def __init__(self, output: ExpectedOutput):
        self.output = output

def get_result() -&gt; ResultWrapper:
    return ResultWrapper(ExpectedOutput(&quot;test data&quot;))

def should_return_expected_output() -&gt; ExpectedOutput:
    &quot;&quot;&quot;Should return ExpectedOutput but returns ResultWrapper&quot;&quot;&quot;
    result = get_result()
    return result  # Type error: should be result.output
</code></pre>
<p><strong>Result</strong>: <code>uvx ty check sync_test.py</code> correctly reports:</p>
<pre><code>error[invalid-return-type]: Return type does not match returned value
  --&gt; sync_test.py:15:40
   |
15 | def should_return_expected_output() -&gt; ExpectedOutput:
   |                                        -------------- Expected `ExpectedOutput` because of return type
16 |     &quot;&quot;&quot;Should return ExpectedOutput but returns ResultWrapper&quot;&quot;&quot;
17 |     result = get_result()
18 |     return result  # Type error: should be result.output
   |            ^^^^^^ expected `ExpectedOutput`, found `ResultWrapper`
   |
info: rule `invalid-return-type` is enabled by default
</code></pre>
<h3>Async version (fails to catch error)</h3>
<pre><code class="language-python"># async_test.py
class ExpectedOutput:
    def __init__(self, data: str):
        self.data = data

class ResultWrapper:
    def __init__(self, output: ExpectedOutput):
        self.output = output

async def get_result() -&gt; ResultWrapper:
    return ResultWrapper(ExpectedOutput(&quot;test data&quot;))

async def should_return_expected_output() -&gt; ExpectedOutput:
    &quot;&quot;&quot;Should return ExpectedOutput but returns ResultWrapper&quot;&quot;&quot;
    result = await get_result()
    return result  # Type error: should be result.output
</code></pre>
<p><strong>Result</strong>: <code>uvx ty check async_test.py</code> incorrectly reports:</p>
<pre><code>All checks passed!
</code></pre>
<h2>Environment</h2>
<ul>
<li>ty version: Latest from <code>uvx ty</code> (ty 0.0.1-alpha.12 (f7446a6ee 2025-06-25))</li>
<li>Platform: macOS</li>
</ul>
<h2>Impact</h2>
<p>I noticed this when using Pydantic AI <code>agent.run()</code></p>
<h3>Version</h3>
<p>ty 0.0.1-alpha.12 (f7446a6ee 2025-06-25)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-07-02 06:47</div>
            <div class="timeline-body"><p>Thank you for reporting this. The problem is not that we don't catch return type mismatches in async functions, but rather that the inferred type for <code>result = await â€¦</code> here is a dynamic type (a <code>@Todo</code> type that represents the fact that we don't support something yet, namely <code>await</code> in this case) which is assignable to everything.</p>
<p>This will be solved once we have support for async/await.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-07-02 06:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-07-30 09:51</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:20:14 UTC
    </footer>
</body>
</html>
