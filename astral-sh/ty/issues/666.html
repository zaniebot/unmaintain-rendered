<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consider using top / bottom materialization for assignability check - astral-sh/ty #666</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Consider using top / bottom materialization for assignability check</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/666">#666</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2025-06-17 05:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-06-17 05:12</div>
            <div class="timeline-body"><p>The concept of top and bottom materialization of a type was added in https://github.com/astral-sh/ruff/pull/18594.</p>
<p>@carljm mentioned that this could potentially be used to perform assignability, especially when gradual types are involved. Formally, if we want to check whether <code>T</code> is assignable to <code>U</code>, then we could check whether <code>T'</code>, the bottom materialization (or lower bound materialization) of <code>T</code>, is a subtype of <code>U'</code>, the top materialization (or upper bound materialization) of <code>U</code>.</p>
<p>The main benefit here is that this would eliminate any special handling of gradual types in the subtyping check and could eliminate any potential bugs that might exists in the current assignability implementation.</p>
<p>This issue is to keep track of this potential change if we decide to do it.</p>
<p>This would still require fulfilling the TODOs that are currently present in the implementation of type materialization in <code>Type::materialize</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-design</span> added by @dhruvmanila on 2025-06-17 05:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">type properties</span> added by @dhruvmanila on 2025-06-17 05:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jelle-openai">@jelle-openai</a> on 2025-06-17 16:33</div>
            <div class="timeline-body"><p>From reading your description of the concept of a &quot;top materialization&quot;, I think this would be incorrect because of the issue I discovered in https://github.com/python/typing/issues/2027.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-06-17 21:51</div>
            <div class="timeline-body"><p>I think to be correct, it requires that the top materialization of e.g. <code>list[Any]</code> properly be the type <code>list[*]</code> (that is, the type including all lists, no matter their contained type); this is already mentioned in our materialization implementation as a TODO. So this issue is dependent on having some representation for that type.</p>
<p>Currently we approximate the top materialization by materializing <code>list[Any]</code> to <code>list[T]</code>, where <code>T</code> is an unresolved type variable. This adequately fulfills our needs for the current use of materialization in overload resolution, where we simply need <code>list[T]</code> to be assignable only to <code>list[Any]</code> and no other list type (that is, for our current purposes we only need to care about what the top materialization is assignable to, not what is assignable to the top materialization). But you're right that fixing the top materialization so it works correctly in both directions is a pre-requisite to moving forward with this issue.</p>
<p>This type <code>list[*]</code> is really just the &quot;top&quot; extension of the rule you mention in https://github.com/python/typing/issues/2027 (that if <code>A'</code> and <code>A''</code> are both materializations of <code>A</code>, <code>A' | A''</code> must be as well), since it is the union of all possible &quot;immediate&quot; materializations of <code>list[Any]</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Z post-stable" by @carljm on 2025-11-14 15:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Z post-stable" by @carljm on 2025-11-18 16:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 02:11:12 UTC
    </footer>
</body>
</html>
