<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excessive runtime in specialization of generic method with union of functions - astral-sh/ty #1261</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Excessive runtime in specialization of generic method with union of functions</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1261">#1261</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-09-26 09:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body"><p>The following snippet (distilled from an <a href="https://github.com/unionai-oss/pandera/blob/660095b7c985e45173f48b02a96655779158357a/tests/test_inspection_utils.py#L97">ecosystem example on pandera</a>, modified to make it self-contained and failing on <code>main</code>) causes an excessively large runtime which scales badly with both the number of <code>.merge</code> calls and the number of union elements:</p>
<pre><code>from __future__ import annotations
from typing import Self, reveal_type

class C[T]:
    value: T

    def __init__(self, v: T) -&gt; None:
        self.value = v

    def merge(self: Self, other: Self) -&gt; C[T]:
        raise NotImplementedError


class A1:
    def method(self): ...
class A2:
    def method(self): ...
class A3:
    def method(self): ...

def _(a: A1 | A2 | A3):
    c = C(a.method)
    reveal_type(c.merge(c).merge(c).merge(c))
</code></pre>
<p>This seems to be caused by unnecessary extra work when applying the specialization.</p>
<p>This currently blocks the merge of <a href="https://github.com/astral-sh/ruff/pull/20517">astral-sh/ruff#20517</a> (<code>typing.Self</code> for the first parameter of instance methods)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-26 09:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">generics</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-26 09:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-26 10:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-09-26 11:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-26 11:43</div>
            <div class="timeline-body"><p>The debug-print of the <code>C[(bound method A1.method() -&gt; Unknown) | (bound method A2.method() -&gt; Unknown) | (bound method A3.method() -&gt; Unknown)]</code> type (after going through <code>c.merge(c).merge(c).merge(c)</code>, which, in principle, shouldn&#x27;t change the type) is 10 MiB large, or 45k lines long.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-09-26 14:29</div>
            <div class="timeline-body"><p>This smells a bit like something that might be solved by abstracting more eagerly to a general callable type instead of a singleton bound-method type? We already do this in generic container inference.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Beta&quot; by <a href="https://github.com/carljm">@carljm</a> on 2025-09-26 14:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-29 11:25</div>
            <div class="timeline-body"><p>closed by <a href="https://github.com/astral-sh/ruff/pull/20596">astral-sh/ruff#20596</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-29 11:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-09-29 11:28</div>
            <div class="timeline-body"><p>Should we add a regression test (or a regression benchmark) for this?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-29 11:51</div>
            <div class="timeline-body"><p>I think it&#x27;s okay <em>not</em> to add a benchmark for this, because as soon as <a href="https://github.com/astral-sh/ruff/pull/20517">astral-sh/ruff#20517</a> is merged, regressing on this would cause timeouts in several projects across the ecosystem, and huge slowdowns in others. If you&#x27;d prefer a benchmark that you can run locally, though, I can certainly add one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-09-29 11:52</div>
            <div class="timeline-body"><p>No, that&#x27;s fine, that makes sense! It&#x27;s probably good to avoid exponential explosion in the number of benchmarks we have, as well as avoiding exponential explosion in the benchmarks themselves ðŸ˜†</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:25:37 UTC
    </footer>
</body>
</html>
