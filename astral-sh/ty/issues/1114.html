<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inner function does not preserve narrowed type - astral-sh/ty #1114</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Inner function does not preserve narrowed type</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1114">#1114</a>
        opened by <a href="https://github.com/mflova">@mflova</a>
        on 2025-09-01 10:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mflova">@mflova</a></div>
            <div class="timeline-body">Summary
<p><code>Mypy</code> and <code>pyright</code> apparently do not have this problem. In my example below, <code>obj</code> from <code>inner_func</code> is guaranteed to be a type string. This can also be seen in the first <code>reveal_type</code>. However, it seems that <code>ty</code> is taking the type of <code>obj</code> to be the input argument one (<code>int | str</code>) instead of the narrowed down (<code>str</code>)</p>
<pre><code>from collections.abc import Mapping
from typing import Any
from typing_extensions import reveal_type


def func(obj: int | str) -&gt; None:
    obj = str(obj) if isinstance(obj, int) else obj
    reveal_type(obj)  #  str

    def inner_func():
        reveal_type(obj)  # int | str
</code></pre>
Version
<p>0.0.1-alpha.19</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-01 10:50</div>
            <div class="timeline-body"><p>Thank you for reporting this.</p>
<p>This is a known limitation that is documented in <a href="https://github.com/astral-sh/ruff/blob/bbfcf6e111648052783bdb68ec71706fc69b714f/crates/ty_python_semantic/resources/mdtest/public_types.md?plain=1#L251-L299">these tests</a>. We currently do not yet analyze the control flow in the outer function to the extend that it would allow us to infer that the narrowing inside <code>inner_func</code> is safe for all calls to it. For example, narrowing would be unsafe if the body of the <code>func</code> function would continue like this:</p>
<pre><code>    obj = 1
    inner_func()
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">narrowing</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-01 10:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">control flow</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-01 10:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mtshiba">@mtshiba</a> on 2025-09-01 11:24</div>
            <div class="timeline-body"><p>astral-sh/ruff#19932 addresses this issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2025-09-02 17:38</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:25:26 UTC
    </footer>
</body>
</html>
