<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown code blocks are not displaying correctly in hover docs - astral-sh/ty #2283</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Markdown code blocks are not displaying correctly in hover docs</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/2283">#2283</a>
        opened by <a href="https://github.com/kfalcetano">@kfalcetano</a>
        on 2025-12-31 00:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/kfalcetano">@kfalcetano</a> on 2025-12-31 00:01</div>
            <div class="timeline-body"><h3>Summary</h3>
<h2>Issue</h2>
<p>There appear to be HTML rendering problems when viewing formatted hover docs containing markdown (triple backtick <code>```</code>) code blocks.</p>
<h2>Environment</h2>
<p>VSCode  (Windows + WSL) with <code>astral-sh.ty</code> extension version 2025.80.0, packaged with <code>ty==0.0.8</code></p>
<h2>Playground Link</h2>
<p>This was reproducible in playground: https://play.ty.dev/ceef294d-c7fd-4c77-aac9-0ad6d48c091d</p>
<h2>Screenshots</h2>
<h3>Markdown</h3>
<p><img width="508" height="218" alt="Image" src="https://github.com/user-attachments/assets/72c8c1c3-55af-4d88-a951-ba4b815e8c1e" /></p>
<h3>reStructuredText</h3>
<p><img width="368" height="222" alt="Image" src="https://github.com/user-attachments/assets/a619b4b1-75a4-42fd-9a40-16194cf579e5" /></p>
<h3>Google</h3>
<p><img width="493" height="255" alt="Image" src="https://github.com/user-attachments/assets/eab9ffa5-724a-415d-82de-29ec5758f15f" /></p>
<h2>Sample Code</h2>
<pre><code class="language-python3">def markdown_example():
    &quot;&quot;&quot;Example docstring with markdown codeblock
    ## Example
    Usage
    ```
    from lib import markdown_example
    def some_function():
        markdown_example()
    ```
    &quot;&quot;&quot;
    pass


def reST_example():
    &quot;&quot;&quot;Example docstring with reST codeblock

    Example
    -------
    Usage ::
        from lib import reST_example
        def some_function():
            reST_example()
    &quot;&quot;&quot;
    pass


def google_style_example():
    &quot;&quot;&quot;Example docstring with google style codeblock

    Example:
        &gt;&gt;&gt; from lib import google_style_example
        &gt;&gt;&gt;
        &gt;&gt;&gt; def main():
        &gt;&gt;&gt;    google_style_example()
        &gt;&gt;&gt;
        &gt;&gt;&gt; main()
    &quot;&quot;&quot;
    pass
</code></pre>
<h3>Version</h3>
<p>ty 0.0.8</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @AlexWaygood on 2025-12-31 00:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @MichaReiser on 2025-12-31 08:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @Gankra by @MichaReiser on 2025-12-31 08:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-31 08:14</div>
            <div class="timeline-body"><p>@Gankra could you take a look at this. The <code>\_example</code> escaping looks suspicious.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Pre-stable 1" by @MichaReiser on 2025-12-31 15:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/kfalcetano">@kfalcetano</a> on 2025-12-31 19:51</div>
            <div class="timeline-body"><p>Was curious about how this is handled, and it seems like <code>in_any_code</code> in <a href="https://github.com/astral-sh/ruff/blob/e71fd9c0408dbedff0c80b6855c5612c82091f59/crates/ty_ide/src/docstring.rs#L184"><code>render_markdown()</code></a> should be true when in a markdown code block, but the outputs indicate it's false at the offending lines (inserting escapes and nbsps). The only places it is set true are lines 239 and 251, so not sure if the <code>starting_literal</code> parsing is expected to handle the code block fence or the handling is just missing, but that might be the place to look.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2026-01-04 19:11</div>
            <div class="timeline-body"><p>This is the same underlying issue as #2291 -- we don't parse markdown codefences at all, and so we treat the contents as normal markdown that should be parsed and escaped.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Gankra on 2026-01-04 19:11</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:51:35 UTC
    </footer>
</body>
</html>
