<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>possibly unbound and unresolved attribute diagnostic when storing attributes - astral-sh/ty #664</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>possibly unbound and unresolved attribute diagnostic when storing attributes</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/664">#664</a>
        opened by <a href="https://github.com/Glyphack">@Glyphack</a>
        on 2025-06-16 19:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Glyphack">@Glyphack</a></div>
            <div class="timeline-body">Summary
<p>Ty emits &quot;possibly-unbound-attribute&quot; diagnostic on setting the attribute.</p>
<pre><code>from typing import Self

class Foo:
    def __init(self: Self, flag: bool):
        if flag:
            self.x = 1 # error possibly-unbound-attribute
</code></pre>
<p>https://play.ty.dev/617d2c31-fe1b-4c8a-9787-7b7baf1f886d</p>
<p>Currently in a class body if an instance attribute is conditionally defined or undefined, we emit a diagnostic on setting the attribute.</p>
<p>Instead ty should report when accessing the attribute. In the previous code example if we only accessed the <code>self.x</code> when it&#x27;s undefined the diagnostic made sense.</p>
<p>Another example of where this diagnostic makes sense.</p>
<pre><code>class C:
    if flag:
        x: int

C().x  # error: [possibly-unbound-attribute]
</code></pre>
<p>comments from @carljm:</p>
<blockquote>
<p>I think that in the case of a possibly-unbound implicit instance attribute, we should never emit a diagnostic on that, whether inside or outside the class body, and whether setting or accessing the attribute</p>
</blockquote>
<p>comments from @sharkdp on implementation:</p>
<blockquote>
<p>I agree that we shouldn&#x27;t even attempt to emit that diagnostic in case that it refers to an instance attribute. For other attribute accesses, like on class bodies or modules, it probably still makes sense, but might be similarly problematic to possibly-unresolved-reference, which we&#x27;ve recently degraded to ignored-by-default.
Fixing that would require a richer return type for Type::member, I think. We are planning to do that anyway for better error messages, but I guess in the non-error case, we could also return additional metadata (what kind of attribute is this, is the returned type the result of a descriptor <strong>get</strong> method, etc.)</p>
</blockquote>
Version
<p>373a3bfcd</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-06-16 20:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">attribute access</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-06-16 20:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-07 08:55</div>
            <div class="timeline-body"><p>The examples in this ticket do not emit errors anymore. This might be due to our recent changes to <code>Self</code> type variables? The errors still appear on <a href="https://github.com/astral-sh/ruff/pull/18473">astral-sh/ruff#18473</a>, but they probably need to be fixed on that branch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-07 08:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-07 09:18</div>
            <div class="timeline-body"><p>Actually, that&#x27;s not true. This example still leads to the same error:</p>
<pre><code>from typing import Self

class C:
    def __init__(self: Self) -&gt; None:
        [... for self.a in range(10)]
</code></pre>
<p>https://play.ty.dev/22a5c060-38f5-434c-a6b9-9cdc467d55bb</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-07 09:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-07 10:00</div>
            <div class="timeline-body"><p>It fails for comprehensions because the definition of <code>self.a</code> is within the (eagerly evaluated) comprehension scope, and our detection of potential instance attributes by checking for methods in classes <a href="https://github.com/astral-sh/ruff/blob/15af4c0a34dd6d86d9aa98115ae1e1e9392c7eef/crates/ty_python_semantic/src/semantic_index/builder.rs#L195-L197">here</a> does not account for that.</p>
<p>Similarly, <a href="https://github.com/astral-sh/ruff/blob/15af4c0a34dd6d86d9aa98115ae1e1e9392c7eef/crates/ty_python_semantic/src/semantic_index.rs#L166-L177">this check</a> is also too naive.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-07 10:02</div>
            <div class="timeline-body"><p>this sounds similar to <a href="https://github.com/astral-sh/ty/issues/147">astral-sh/ty#147</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Glyphack">@Glyphack</a> on 2025-10-08 08:35</div>
            <div class="timeline-body"><p>I can work on this one if you are not working on it (I don&#x27;t have any idea what needs to change I&#x27;ll look around if you have a solution already let me know.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-10-08 09:34</div>
            <div class="timeline-body"><blockquote>
<p>I can work on this one if you are not working on it (I don&#x27;t have any idea what needs to change I&#x27;ll look around if you have a solution already let me know.)</p>
</blockquote>
<p>That sounds great. The two source ranges I linked above are good places to start. I think we probably want to skip over eagerly-executed scopes before trying to identify the method scope (and its parent class scope). We should also take care of skipping type-parameter scopes, which I think is not done consistently at the moment: For example:</p>
<pre><code>class C:
    def f[T](self):
        [[... for self.x in ...] for ... in ...]
</code></pre>
<p>Here, I think we have the following scope stack when discovering the <code>self.x</code> expression (I have not checked this, might also look slightly different):</p>
<pre><code>inner comprehension scope (eagerly executed)
outer comprehension scope (eagerly executed)
scope of function `f`
type parameter scope `[T]`
scope of class `C`
</code></pre>
<p>So if we want to properly mark (and later recognize) this as an attribute assignment to <code>self.x</code>, we should first skip all non-function eagerly-executed scopes (in this case: the two comprehensions), then verify that we are in a function scope, then skip the type parameter scope, then verify that the function is inside a class.</p>
<p>Maybe it makes sense to limit this to eager comprehension scopes for now(?).</p>
<p>This old PR is probably also interesting: <a href="https://github.com/astral-sh/ruff/pull/17012">astral-sh/ruff#17012</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/Glyphack">@Glyphack</a> by <a href="https://github.com/carljm">@carljm</a> on 2025-10-08 16:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2025-11-11 22:45</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:24:52 UTC
    </footer>
</body>
</html>
