<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track open files in server - astral-sh/ty #619</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Track open files in server</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/619">#619</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-06-09 18:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/18482 starts purging AST nodes after checking a file is complete. However, purging the AST is undesired for open files in the server because providing completions or any other AST based information then requires reparsing the file.</p>
<p>The <code>Project</code> already has infrastructure to track the open files but we aren't using it in the LSP today. We should extend the LSP to call <code>open_file</code> and <code>close_file</code> in its notification handlers.</p>
<p>CC: @ibraheemdev maybe a follow up task to your PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @MichaReiser on 2025-06-09 18:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Beta" by @MichaReiser on 2025-06-09 18:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-06-10 02:10</div>
            <div class="timeline-body"><p>Related, I might have to add a new method (or an enum variant in <code>ProjectFiles</code>) to force check all files in case workspace diagnostics is requested.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-11 05:27</div>
            <div class="timeline-body"><blockquote>
<p>Related, I might have to add a new method (or an enum variant in ProjectFiles) to force check all files in case workspace diagnostics is requested.</p>
</blockquote>
<p>I think we have two options here:</p>
<ul>
<li>Remove the <code>check</code> special casing where it only checks a given set of files if <code>open_files</code> is set and only use <code>check_file</code> in the LSP if the check mode is: Open files only.</li>
<li>Keep the <code>open_files</code> handling as is, but add a <code>CheckMode</code> to the server</li>
</ul>
<p>It's not clear to me what the better fit is. I do think we want to keep calling <code>check_file</code> in <code>pull_diagnostics</code> and only call <code>check</code> in workspace diagnostics. If that's the case, then making the <code>check</code> call in workspace diagnostics conditional on whether the user opted in to workspace or open file diagnostics seems easy enough and it could simplify the project model (which now has multiple fields around &quot;open files&quot;).</p>
<p>One other thing that's unclear to me is if removing the open files handling breaks our WASM/benchmark model.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @MichaReiser on 2025-06-24 10:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-07-08 09:18</div>
            <div class="timeline-body"><blockquote>
<p>The <code>Project</code> already has infrastructure to track the open files but we aren't using it in the LSP today. We should extend the LSP to call <code>open_file</code> and <code>close_file</code> in its notification handlers.</p>
</blockquote>
<p>This doesn't work well with workspace diagnostics because the diagnostic builder avoids adding any diagnostic for a closed file which is checked by the <code>db.is_file_open</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2025-07-18 14:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:20:07 UTC
    </footer>
</body>
</html>
