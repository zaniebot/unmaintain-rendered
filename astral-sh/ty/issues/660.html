<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Too-many fix point iterations in growing union of literals - astral-sh/ty #660</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Too-many fix point iterations in growing union of literals</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/660">#660</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-06-16 07:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body"><p><code>ty</code> panics with &quot;infer_expression_type(Id(1401)): execute: too many cycle iterations&quot; for the following example:</p>
<pre><code class="language-py">from typing import Self

class C:
  def __init__(self: Self):
    self.a = 0

  def b(self: Self):
    self.a = self.a + 1
</code></pre>
<p>When inferring the type of the <code>a</code> attribute, we take bindings in all methods into account, so we infer a growing union of literals <code>Unknown | Literal[0, 1, 2, 3, …]</code> here. This is not really related to attribute accesses though. The same thing would happen if we had full fixpoint iteration for loops (I believe):</p>
<pre><code class="language-py">i = 0
while True:
    i += 1

    reveal_type(i)
</code></pre>
<p>This was orginally reported by @glyphack.</p>
<p>Comments by @carljm:</p>
<blockquote>
<p>The simplest approach here is to dramatically reduce the maximum size of literal unions we support
The infrastructure for this is all already in place, so it’s literally just changing a number
The question is whether we want to be able to support larger explicit literal unions than we want to accumulate in fixpoint iteration
If so, then that requires more additional infrastructure complication
But I think we could set a literal-union size limit of anything under 200 (the salsa iteration limit) and make this too-many-iterations error go away
(But we’d still iterate that many times, and hundreds of iterations might not be great for perf)
Another approach would be to add complication to the cycle handling function of some query in that cycle so that if it sees a growing union of literals, it falls back sooner
And of course a third approach would just be to infer Unknown | int in the first place for undeclared = 1 instead of Unknown | Literal[1], and make the issue go away entirely</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @sharkdp on 2025-06-16 07:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">type-inference</span> added by @sharkdp on 2025-06-16 07:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fatal</span> added by @AlexWaygood on 2025-06-16 07:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-08-20 17:53</div>
            <div class="timeline-body"><p>I think #957 is the right way to address this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @sharkdp by @sharkdp on 2025-08-22 13:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-08-28 14:46</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:20:09 UTC
    </footer>
</body>
</html>
