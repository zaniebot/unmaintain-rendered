<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>panics when type-checking CRTP generic classes - astral-sh/ty #91</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>panics when type-checking CRTP generic classes</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/91">#91</a>
        opened by <a href="https://github.com/wence-">@wence-</a>
        on 2025-05-07 14:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/wence-">@wence-</a></div>
            <div class="timeline-body"><h3>Summary</h3>
<p>[I found a few similar looking issues which may have the same cause, but this particular instantiation seemed to be new.]</p>
<p>Aside: the requested web link to report a new issue: <code>https://github.com/astral-sh/ty/issues/new?title=%5Bpanic%5D</code> does not resolve.</p>
<p>Consider:</p>
<pre><code class="language-python">from typing import Any, Generic, TypeVar

T = TypeVar(&quot;T&quot;, bound=&quot;Node[Any]&quot;)

class Node(Generic[T]):
    members: tuple[T, ...]

class Concrete(Node[&quot;Concrete&quot;]):
    ...

reveal_type(Concrete.members)
</code></pre>
<pre><code>$ target/debug/ty check --python-version 3.13 bug.py
error: panic: Panicked at /usr/local/cargo/git/checkouts/salsa-e6f3bb7c2a062968/f78a641/src/function/execute.rs:210:25 when checking `/home/coder/doodles/python/pyright/what.py`: `infer_definition_types(Id(1003)): execute: too many cycle iterations`
info: This indicates a bug in ty.
info: If you could open an issue at https://github.com/astral-sh/ty/issues/new?title=%5Bpanic%5D we'd be very appreciative!
info: Platform: linux x86_64
info: Args: [&quot;target/debug/ty&quot;, &quot;check&quot;, &quot;bug.py&quot;, &quot;--python-version&quot;, &quot;3.13&quot;]
info: run with `RUST_BACKTRACE=1` environment variable to show the full backtrace information
info: query stacktrace:
   0: infer_scope_types(Id(c00))
             at crates/ty_python_semantic/src/types/infer.rs:119
   1: check_types(Id(800))
             at crates/ty_python_semantic/src/types.rs:83


Found 1 diagnostic
WARN A fatal error occurred while checking some files. Not all project files were analyzed. See the diagnostics list above for details.
</code></pre>
<p>A slightly different error (but presumably a similar root cause) occurs for the PEP695 version</p>
<pre><code class="language-python">from typing import Any


class Node[T: &quot;Node[Any]&quot;]:
    members: tuple[T, ...]

class Concrete(Node[&quot;Concrete&quot;]):
    ...

reveal_type(Concrete.members)
</code></pre>
<pre><code>$ target/debug/ty check --python-version 3.13 bug.py
error: panic: Panicked at /usr/local/cargo/git/checkouts/salsa-e6f3bb7c2a062968/f78a641/src/function/fetch.rs:131:25 when checking `/home/coder/doodles/python/pyright/what.py`: `dependency graph cycle when querying pep695_generic_context_(Id(2c01)), set cycle_fn/cycle_initial to fixpoint iterate.
Query stack:
[
    check_types(Id(800)),
    infer_scope_types(Id(c00)),
    member_lookup_with_policy_(Id(200b)),
    explicit_bases_query_(Id(2c02)),
    infer_deferred_types(Id(1004)),
    pep695_generic_context_(Id(2c01)),
    infer_definition_types(Id(1001)),
    symbol_by_id(Id(280c)),
    use_def_map(Id(c00)),
    member_lookup_with_policy_(Id(200a)),
    imported_modules(Id(1812)),
    all_narrowing_constraints_for_expression(Id(2470)),
    member_lookup_with_policy_(Id(2009)),
    imported_modules(Id(1811)),
]`
info: This indicates a bug in ty.
info: If you could open an issue at https://github.com/astral-sh/ty/issues/new?title=%5Bpanic%5D we'd be very appreciative!
info: Platform: linux x86_64
info: Args: [&quot;target/debug/ty&quot;, &quot;check&quot;, &quot;bug.py&quot;, &quot;--python-version&quot;, &quot;3.13&quot;]
info: run with `RUST_BACKTRACE=1` environment variable to show the full backtrace information
info: query stacktrace:
   0: infer_definition_types(Id(1001))
             at crates/ty_python_semantic/src/types/infer.rs:146
   1: pep695_generic_context_(Id(2c01))
             at crates/ty_python_semantic/src/types/class.rs:499
   2: infer_deferred_types(Id(1004))
             at crates/ty_python_semantic/src/types/infer.rs:184
   3: explicit_bases_query_(Id(2c02))
             at crates/ty_python_semantic/src/types/class.rs:499
   4: member_lookup_with_policy_(Id(200b))
             at crates/ty_python_semantic/src/types.rs:537
   5: infer_scope_types(Id(c00))
             at crates/ty_python_semantic/src/types/infer.rs:119
   6: check_types(Id(800))
             at crates/ty_python_semantic/src/types.rs:83


Found 1 diagnostic
WARN A fatal error occurred while checking some files. Not all project files were analyzed. See the diagnostics list above for details.
</code></pre>
<h3>Version</h3>
<p>ty version =&gt; ty unknown; ruff version =&gt; ruff 0.11.8+84 (3dedd70a9 2025-05-07)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-05-07 14:32</div>
            <div class="timeline-body"><p>Thanks for the report! Yes, this is a known issue, we're considering possible solutions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-05-07 14:33</div>
            <div class="timeline-body"><p>(The bug-reporting link will be live soon.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/wence-">@wence-</a> on 2025-05-07 14:42</div>
            <div class="timeline-body"><blockquote>
<p>Thanks for the report! Yes, this is a known issue, we're considering possible solutions.</p>
</blockquote>
<p>Thanks, happy for this one to be closed if it's captured by other issues.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[ty] panics when type-checking CRTP generic classes" to "panics when type-checking CRTP generic classes" by @MichaReiser on 2025-05-07 15:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-05-07 17:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-08 14:15</div>
            <div class="timeline-body"><p>Thank you for reporting this. I will add your examples to #256 to collect all of them in one place.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-05-08 14:15</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:19:32 UTC
    </footer>
</body>
</html>
