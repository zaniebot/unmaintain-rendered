<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enum union and intersection with Any not simplifying correctly - astral-sh/ty #1155</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Enum union and intersection with Any not simplifying correctly</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1155">#1155</a>
        opened by <a href="https://github.com/github-actions">@github-actions</a>
        on 2025-09-09 12:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/github-actions">@github-actions</a></div>
            <div class="timeline-body"><p>Run listed here: https://github.com/astral-sh/ty/actions/runs/17581914325</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @github-actions[bot] on 2025-09-09 12:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">type properties</span> added by @github-actions[bot] on 2025-09-09 12:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-09-09 12:17</div>
            <div class="timeline-body"><pre><code>failures:

---- types::property_tests::stable::subtype_of_is_antisymmetric stdout ----

thread 'types::property_tests::stable::subtype_of_is_antisymmetric' panicked at /home/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/quickcheck-1.0.3/src/tester.rs:165:28:
[quickcheck] TEST FAILED. Arguments: (Intersection { pos: [Union([Any, EnumLiteral(&quot;unsafe&quot;)]), EnumLiteral(&quot;unsafe&quot;)], neg: [] }, EnumLiteral(&quot;unsafe&quot;))
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-09 15:41</div>
            <div class="timeline-body"><p>It looks like <code>(Any | E) &amp; E = Any &amp; E | E</code> doesn't simplify to <code>E</code>, or that it is not considered equivalent to <code>E</code>.</p>
<p>(I'm using <code>E</code> instead of <code>Literal[SafeUUID.unsafe]</code> as a placeholder for some enum literal)</p>
<p>It looks like we <em>do</em> consider them equivalent if <code>E</code> is a singleton, e.g. if you remove the <code>B</code> variant from the enum in https://play.ty.dev/f0d5d174-f462-4dc8-9c97-3e2cb339e09d</p>
<p>But <code>Any &amp; E | E = E</code> should hold for every (fully static) type, I think? <code>Any &amp; E | E</code> has a bottom materialization of <code>E</code>, and a top materialization of <code>E</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-09-09 16:40</div>
            <div class="timeline-body"><p>Could this have been caused by https://github.com/astral-sh/ruff/pull/20285 ? I don't think that was intended to change any behavior that would affect this case, but it did touch the definition of <code>is_single_valued</code> for enums, and it seems like quite coincidental timing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Daily property test run failed on Tue Sep 09 2025" to "Enum union and intersection with Any not simplifying correctly" by @carljm on 2025-09-09 16:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @sharkdp by @sharkdp on 2025-09-09 19:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-09 19:04</div>
            <div class="timeline-body"><p>I can take a look tomorrow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-09-10 07:44</div>
            <div class="timeline-body"><p>This has nothing to do with the newly merged PR.</p>
<p>It's a bug that has probably been around for two months, since I introduced enum literals originally. I think we just got very lucky here to generate just the (<code>(Any | E) &amp; E</code>, <code>E</code>) combination with the same enum literal appearing three times.</p>
<p>=&gt; https://github.com/astral-sh/ruff/pull/20324</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-09-10 13:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">enums</span> added by @AlexWaygood on 2025-09-23 20:01</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:20:36 UTC
    </footer>
</body>
</html>
