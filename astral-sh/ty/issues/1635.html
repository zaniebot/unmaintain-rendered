<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>False positive on Starlette middleware registration - astral-sh/ty #1635</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>False positive on Starlette middleware registration</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/1635">#1635</a>
        opened by <a href="https://github.com/Asaf31214">@Asaf31214</a>
        on 2025-11-25 21:12
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/Asaf31214">@Asaf31214</a> on 2025-11-25 21:12</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Register any FastAPI middleware, custom or built-in:</p>
<pre><code class="language-python">app = FastAPI()
app.add_middleware(NoStoreAuthMiddleware) # custom, subclass of BaseHTTPMiddleware
app.add_middleware(RateLimitMiddleware) # custom, subclass of BaseHTTPMiddleware
app.add_middleware( 
    CORSMiddleware, # built-in middleware, from fastapi.middleware.cors
    allow_origins=[&quot;*&quot;],
    allow_credentials=True,
    allow_methods=[&quot;*&quot;],
    allow_headers=[&quot;*&quot;],
) 
</code></pre>
<p>run:
<code>ty check</code>, without any specified rules at <code>pyproject.toml</code></p>
<p>No issue until ty@0.0.1a25 (expected result)
But for versions ty@0.0.1a26 and ty@0.0.1a27 (current latest):</p>
<pre><code>error[invalid-argument-type]: Argument to bound method `add_middleware` is incorrect
  --&gt; main.py:31:20
   |
30 | app = FastAPI(default_response_class=ORJSONResponse, lifespan=lifespan)
31 | app.add_middleware(NoStoreAuthMiddleware)
   |                    ^^^^^^^^^^^^^^^^^^^^^ Expected `_MiddlewareFactory[Unknown]`, found `&lt;class 'NoStoreAuthMiddleware'&gt;`
32 | app.add_middleware(RateLimitMiddleware)
33 | app.add_middleware(ExceptionHandlerMiddleware)
   |
info: Method defined here
   --&gt; .venv/lib/python3.14/site-packages/starlette/applications.py:118:9
    |
116 |         self.router.host(host, app=app, name=name)  # pragma: no cover
117 |
118 |     def add_middleware(
    |         ^^^^^^^^^^^^^^
119 |         self,
120 |         middleware_class: _MiddlewareFactory[P],
    |         --------------------------------------- Parameter declared here
121 |         *args: P.args,
122 |         **kwargs: P.kwargs,
    |
info: rule `invalid-argument-type` is enabled by default
</code></pre>
<p>same error for all 3 middlewares registered here.</p>
<p>this is also mentioned at issue #1564  by @dmytro-GL <a href="https://github.com/astral-sh/ty/issues/1564#issuecomment-3548995805">here</a></p>
<h3>Version</h3>
<p>ty 0.0.1-alpha.27</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-25 21:24</div>
            <div class="timeline-body"><p>Thanks for the report! It looks like <code>_MiddlewareFactory</code> is a protocol which is generic over a <code>ParamSpec</code>, so I think we should revisit this once #157 is done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Stable" by @carljm on 2025-11-25 21:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Stable" by @carljm on 2025-11-25 23:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Beta" by @carljm on 2025-11-25 23:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-11-25 23:56</div>
            <div class="timeline-body"><p>Putting this in beta milestone as I think we should ensure it's either fixed or suppressed in some way for the beta.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Asaf31214">@Asaf31214</a> on 2025-11-26 00:35</div>
            <div class="timeline-body"><p>Update: same behaviour on 0.0.1-alpha.28</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "FastAPI middleware registration false positive error at versions >=0.0.1a26" to "False positive on Starlette middleware registration" by @dhruvmanila on 2025-12-04 05:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-12-04 05:17</div>
            <div class="timeline-body"><p>For context, this is same as https://github.com/astral-sh/ty/issues/157#issuecomment-3554317390 which is a self-contained example to reproduce this. This possibly requires #1714.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dhruvmanila by @dhruvmanila on 2025-12-04 05:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @dhruvmanila by @carljm on 2025-12-08 17:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AlexWaygood by @carljm on 2025-12-08 17:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-16 21:09</div>
            <div class="timeline-body"><p>Didn't get this into the beta, but it's a high priority follow-up.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Beta" by @carljm on 2025-12-16 21:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Stable" by @carljm on 2025-12-16 21:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/thejcannon">@thejcannon</a> on 2025-12-17 16:00</div>
            <div class="timeline-body"><p>(as far as examples goes, it doesn't get much smaller than this)</p>
<pre><code>#!/usr/bin/env -S uv run --with starlette==0.50.0,ty==0.0.2 ty check --

from starlette_context.middleware import RawContextMiddleware
from starlette.middleware import Middleware

Middleware(RawContextMiddleware)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @AlexWaygood by @AlexWaygood on 2025-12-17 16:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Stable" by @carljm on 2025-12-19 23:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "M1" by @carljm on 2025-12-19 23:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/condemil">@condemil</a> on 2025-12-26 10:41</div>
            <div class="timeline-body"><p>Another minimal reproducible example:</p>
<pre><code class="language-python">from starlette.middleware import Middleware
from starlette.middleware.httpsredirect import HTTPSRedirectMiddleware

# ty(invalid-argument-type): Argument to bound method `__init__` is incorrect: Expected `_MiddlewareFactory[(...)]`, found `&lt;class 'HTTPSRedirectMiddleware'&gt;`
middleware = Middleware(HTTPSRedirectMiddleware)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Kludex">@Kludex</a> on 2026-01-09 09:16</div>
            <div class="timeline-body"><p>When this is fixed, I'm open to add <code>ty</code> to the <code>starlette</code>s pipeline.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @dcreager by @dcreager on 2026-01-09 13:43</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:48:55 UTC
    </footer>
</body>
</html>
