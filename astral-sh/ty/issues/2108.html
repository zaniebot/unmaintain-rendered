<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>False positive: `conflicting-declarations` on try/except import fallback pattern - astral-sh/ty #2108</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>False positive: <code>conflicting-declarations</code> on try/except import fallback pattern</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/2108">#2108</a>
        opened by <a href="https://github.com/The-Red-Dragons">@The-Red-Dragons</a>
        on 2025-12-19 11:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/The-Red-Dragons">@The-Red-Dragons</a></div>
            <div class="timeline-body">Summary
Summary
<p>ty reports <code>conflicting-declarations</code> when using the common Python pattern for optional imports with a fallback to <code>None</code>.</p>
Environment
<ul>
<li>ty version: 0.0.4</li>
<li>Python version: 3.14</li>
<li>OS: Ubuntu 24.04</li>
</ul>
Reproduction
<pre><code>from mymodule import MyClass as MyClassType

# Type declaration for the variable
translator: MyClassType | None

try:
    from mymodule import translator
except (ImportError, ModuleNotFoundError, AttributeError):
    translator = None
</code></pre>
Expected Behavior
<p>No error - this is a common pattern for optional dependencies where:</p>
<ol>
<li>The type is declared as <code>T | None</code></li>
<li>We try to import the real value</li>
<li>On failure, we fall back to <code>None</code></li>
</ol>
Actual Behavior
<pre><code>error[conflicting-declarations]: Conflicting declared types for `translator`: `MyClass | None` and `MyClass`
</code></pre>
Real-world Use Case
<p>This pattern is widely used for optional features:</p>
<pre><code># Optional translator support
translator: Translator | None

try:
    from utils.localization import translator
except ImportError:
    translator = None  # Feature disabled if not installed

# Later in code
if translator is not None:
    message = translator.t(&quot;key&quot;)
</code></pre>
Workaround
<p>Using <code>conflicting-declarations = &quot;warn&quot;</code> in configuration.</p>
Version
<p>0.0.4</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-22 23:51</div>
            <div class="timeline-body"><p>Here&#x27;s a version that ty is currently happy with:</p>
<pre><code>try:
    from os import environ
except (ImportError, ModuleNotFoundError, AttributeError):
    environ: None = None
</code></pre>
<p>But I&#x27;m not claiming this version is better, and other type-checkers won&#x27;t like it. I think we should be happy with the OP version.</p>
<p>One way to get there is #1836</p>
<p>Another way could be to just silence <code>conflicting-declarations</code> (it&#x27;s not necessary for soundness) and instead union the declarations. (Given that this is a reasonable option, it&#x27;s also a reasonable workaround to just use <code>conflicting-declarations = &quot;ignore&quot;</code> in your <code>tool.ty.rules</code> config.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Stable&quot; by <a href="https://github.com/carljm">@carljm</a> on 2025-12-22 23:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-12-23 05:15</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:26:38 UTC
    </footer>
</body>
</html>
