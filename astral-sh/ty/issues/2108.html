<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>False positive: `conflicting-declarations` on try/except import fallback pattern - astral-sh/ty #2108</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>False positive: `conflicting-declarations` on try/except import fallback pattern</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/2108">#2108</a>
        opened by <a href="https://github.com/The-Red-Dragons">@The-Red-Dragons</a>
        on 2025-12-19 11:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/The-Red-Dragons">@The-Red-Dragons</a> on 2025-12-19 11:13</div>
            <div class="timeline-body"><h3>Summary</h3>
<h2>Summary</h2>
<p>ty reports <code>conflicting-declarations</code> when using the common Python pattern for optional imports with a fallback to <code>None</code>.</p>
<h2>Environment</h2>
<ul>
<li>ty version: 0.0.4</li>
<li>Python version: 3.14</li>
<li>OS: Ubuntu 24.04</li>
</ul>
<h2>Reproduction</h2>
<pre><code class="language-python">from mymodule import MyClass as MyClassType

# Type declaration for the variable
translator: MyClassType | None

try:
    from mymodule import translator
except (ImportError, ModuleNotFoundError, AttributeError):
    translator = None
</code></pre>
<h2>Expected Behavior</h2>
<p>No error - this is a common pattern for optional dependencies where:</p>
<ol>
<li>The type is declared as <code>T | None</code></li>
<li>We try to import the real value</li>
<li>On failure, we fall back to <code>None</code></li>
</ol>
<h2>Actual Behavior</h2>
<pre><code>error[conflicting-declarations]: Conflicting declared types for `translator`: `MyClass | None` and `MyClass`
</code></pre>
<h2>Real-world Use Case</h2>
<p>This pattern is widely used for optional features:</p>
<pre><code class="language-python"># Optional translator support
translator: Translator | None

try:
    from utils.localization import translator
except ImportError:
    translator = None  # Feature disabled if not installed

# Later in code
if translator is not None:
    message = translator.t(&quot;key&quot;)
</code></pre>
<h2>Workaround</h2>
<p>Using <code>conflicting-declarations = &quot;warn&quot;</code> in configuration.</p>
<h3>Version</h3>
<p>0.0.4</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-22 23:51</div>
            <div class="timeline-body"><p>Here's a version that ty is currently happy with:</p>
<pre><code class="language-py">try:
    from os import environ
except (ImportError, ModuleNotFoundError, AttributeError):
    environ: None = None
</code></pre>
<p>But I'm not claiming this version is better, and other type-checkers won't like it. I think we should be happy with the OP version.</p>
<p>One way to get there is #1836</p>
<p>Another way could be to just silence <code>conflicting-declarations</code> (it's not necessary for soundness) and instead union the declarations. (Given that this is a reasonable option, it's also a reasonable workaround to just use <code>conflicting-declarations = &quot;ignore&quot;</code> in your <code>tool.ty.rules</code> config.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Stable" by @carljm on 2025-12-22 23:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dhruvmanila on 2025-12-23 05:15</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:53:03 UTC
    </footer>
</body>
</html>
