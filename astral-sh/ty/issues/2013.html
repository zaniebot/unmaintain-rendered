<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>No error reported for incorrect arguments passed to function generic over a `ParamSpec` - astral-sh/ty #2013</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>No error reported for incorrect arguments passed to function generic over a <code>ParamSpec</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/2013">#2013</a>
        opened by <a href="https://github.com/WillDuke">@WillDuke</a>
        on 2025-12-17 14:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/WillDuke">@WillDuke</a></div>
            <div class="timeline-body">Summary
<p><code>ty</code> no longer raises a diagnostic on this code:</p>
<pre><code>from typing import ParamSpec, TypeVar, Callable

P = ParamSpec(&quot;P&quot;)
T = TypeVar(&#x27;T&#x27;)

def fn(p1: int, p2: int):
    ...

def submit(fn: Callable[P, T], *args: P.args, **kwargs: P.kwargs):
    ...

submit(fn, p1=1, p2=&quot;wrong&quot;)
</code></pre>
<p>Here&#x27;s the <a href="https://play.ty.dev/74ba704a-07ae-4e6a-ba36-b0fae27b8a10">link</a> to the playground with the above snippet.</p>
<p>Here&#x27;s a motivating example where this comes up (<a href="https://play.ty.dev/51c02e59-ff26-4904-a6b2-b73326bd6e2c">link</a>).</p>
<pre><code>from concurrent.futures import ThreadPoolExecutor



def fn(p1: int, p2: int):
    ...

with ThreadPoolExecutor() as executor:
    executor.submit(fn, p1=1, p2=&quot;wrong&quot;)
</code></pre>
<p>I was originally going to submit this issue because I noticed that the diagnostic gave (what I think is) the correct error but highlighted p1 instead of p2, but as of today the diagnostic no longer appears at all.</p>
<p>Here&#x27;s the original diagnostic issue using ty as built into Zed, updated yesterday. (Notice the 1 is underlined instead of &quot;wrong&quot;.)</p>
<p><img alt="Image" src="https://github.com/user-attachments/assets/e30c99ee-b067-46f8-9b76-82a0602c1d8b"></p>
Version
<p>main (2a61fe235)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-17 14:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">generics</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-17 14:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Stable&quot; by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-17 14:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-17 14:38</div>
            <div class="timeline-body"><p>Thanks for the report! I&#x27;m not <em>totally</em> sure that this ever worked -- I think the error you were seeing before was an unrelated bug ðŸ˜†</p>
<p>But it definitely <em>should</em> work, agreed!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/WillDuke">@WillDuke</a> on 2025-12-17 14:55</div>
            <div class="timeline-body"><p>Thanks, the original error fooled me into thinking this was already supported!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;ty no longer reports type mismatches in a ParamSpec&quot; to &quot;No error reported for incorrect arguments passed to function generic over a `ParamSpec`&quot; by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-17 16:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-17 16:17</div>
            <div class="timeline-body"><p>@dhruvmanila, is this related to the last bullet point in <a href="https://github.com/astral-sh/ty/issues/1861">astral-sh/ty#1861</a>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-12-23 04:50</div>
            <div class="timeline-body"><p>Interesting, I think this was working before even though the diagnostic position is incorrect:</p>
<pre><code>$ uvx &quot;ty@0.0.1a35&quot; check .
Installed 1 package in 6ms
error[invalid-argument-type]: Argument to function `submit` is incorrect
  --&gt; main.py:13:12
   |
13 | submit(fn, p1=1, p2=&quot;wrong&quot;)
   |            ^^^^ Expected `int`, found `Literal[&quot;wrong&quot;]`
   |
info: Function defined here
  --&gt; main.py:10:5
   |
10 | def submit(fn: Callable[P, T], *args: P.args, **kwargs: P.kwargs): ...
   |     ^^^^^^                     ------------- Parameter declared here
   |
info: rule `invalid-argument-type` is enabled by default

Found 1 diagnostic
</code></pre>
<p>But, it stopped working in <code>0.0.2</code>, it might be related to the generic <code>Callable</code> PR. I&#x27;ll take a look.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-12-23 04:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-12-24 06:52</div>
            <div class="timeline-body"><p>I tried a few combinations of the original snippet and it seems to only occur when the <code>Callable</code> has a generic return type <code>T</code> and that the passed in function does not have an annotated return type. For example:</p>
<pre><code>from typing import Callable

def fn(a: int): ...

def submit[**P, T](fn: Callable[P, T], *args: P.args, **kwargs: P.kwargs): ...

submit(fn, a=&quot;a&quot;)
</code></pre>
<p>I think I see what the issue is but I&#x27;m not exactly sure what the solution should be. For a <code>Callable[P, T]</code> we&#x27;d create two constraints corresponding to <code>P</code> and <code>T</code> and combine them using <code>and</code> <a href="https://github.com/astral-sh/ruff/blob/81f34fbc8e404cd26fa40ee86a339947dce7617c/crates/ty_python_semantic/src/types/signatures.rs#L486">here</a>. For the above example, this would be:</p>
<pre><code>((a: int) â‰¤ P@submit)  # for P
never                  # for T
</code></pre>
<p>And, the fact that it&#x27;s <code>never</code> for <code>T</code> means that the <code>and</code> call would result in both <code>P</code> and <code>T</code> be never satisfied so we loose the paramspec constraint as well from the specialization:</p>
<pre><code># should be [(a: int), Unknown]
specialization: [(...), Unknown]
</code></pre>
<p>Using <code>or</code> between <code>P</code> and <code>T</code> would resolve this but I&#x27;m not sure if that&#x27;s the correct approach. I&#x27;d want to first understand why it&#x27;s <code>and</code> in the first place.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-27 00:34</div>
            <div class="timeline-body"><p>Definitely seems like a @dcreager question, but my thoughts just on reading this are 1) <code>and</code> instead of <code>or</code> seems correct here? We need both the return type and the parameters to match, not just one or the other. And 2) what seems wrong here is the <code>never</code> for <code>T</code> -- <code>T</code> should be unconstrained here (or constrained to <code>Unknown</code>, which is equivalent?), there should be no constraints on its type that would cause the overall <code>and</code> to fail to be satisfied.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2026-01-07 08:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2026-01-07 17:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/WillDuke">@WillDuke</a> on 2026-01-07 21:00</div>
            <div class="timeline-body"><p>Thanks for the fix! Incidentally, #22425 resurfaced the earlier issue from 0.0.1a35 where the diagnostic highlights the wrong parameter. Is that worth a separate issue?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2026-01-08 07:09</div>
            <div class="timeline-body"><blockquote>
<p>Thanks for the fix! Incidentally, #22425 resurfaced the earlier issue from 0.0.1a35 where the diagnostic highlights the wrong parameter. Is that worth a separate issue?</p>
</blockquote>
<p>https://github.com/astral-sh/ty/issues/2198</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:26:31 UTC
    </footer>
</body>
</html>
