<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stack overflow, but only when running ty with AddressSanitizer - astral-sh/ty #1226</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Stack overflow, but only when running ty with AddressSanitizer</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/1226">#1226</a>
        opened by <a href="https://github.com/qarmin">@qarmin</a>
        on 2025-09-21 09:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/qarmin">@qarmin</a></div>
            <div class="timeline-body"><p>When running the file check with ty under AddressSanitizer, I get a stack overflow error.
Running ty normally, however, does not cause this issue.
AddressSanitizer uses more stack space, which is why the error becomes visible in this setup.</p>
<p>I’m not sure whether creating a larger file (e.g., by duplicating parts of it) would make it crash under normal ty as well — I haven’t been able to reproduce it that way. It’s possible that ty already has some form of internal limit in place.</p>
<p>I know this looks like an edge case, but I suspect something similar could happen in regular ty on systems where the default stack size is much smaller than on Linux.</p>
<p>File is quite big(~28KB), but contains such code(objs[&#x27;...&#x27;] part is repeated multiple times)</p>
<pre><code>#!/usr/bin/python3
&quot;&quot;&quot;An ASCII 5x9 (monospace) pattern.&quot;&quot;&quot;
from pyxstitch.font import BaseFontFactory


class FiveByNineMono(BaseFontFactory):
    &quot;&quot;&quot;Font factory definition.&quot;&quot;&quot;

    def _display(self):
        &quot;&quot;&quot;Display name.&quot;&quot;&quot;
        return self._monospace_ascii()

    def _height_width(self):
        &quot;&quot;&quot;Font height and width.&quot;&quot;&quot;
        return (9, 5)

    def _initialize_characters(self):
        &quot;&quot;&quot;Initialize default characters.&quot;&quot;&quot;
        objs = {}
        objs[&#x27;A&#x27;] = self._build_character(&quot;&quot;&quot;
|    |    |1.00|    |    |
|    |1.00|    |1.00|    |
|1.00|    |    |    |1.00|
|1.00|1.00|1.00|1.00|1.00|
|1.00|    |    |    |1.00|
|1.00|    |    |    |1.00|
|1.00|    |    |    |1.00|
|    |    |    |    |    |
|    |    |    |    |    |
&quot;&quot;&quot;)

...

        objs[&#x27;~&#x27;] = self._build_character(&quot;&quot;&quot;
|    |    |    |    |    |
|    |    |    |    |    |
|    |1.00|    |    |    |
|1.00|    |1.00|    |1.00|
|    |    |    |1.00|    |
|    |    |    |    |    |
|    |    |    |    |    |
|    |    |    |    |    |
|    |    |    |    |    |
&quot;&quot;&quot;)
        objs[&#x27;`&#x27;] = self._build_character(&quot;&quot;&quot;
|    |1.00|    |    |    |
|    |    |1.00|    |    |
|    |    |    |1.00|    |
|    |    |    |    |    |
|    |    |    |    |    |
|    |    |    |    |    |
|    |    |    |    |    |
|    |    |    |    |    |
|    |    |    |    |    |
&quot;&quot;&quot;)
        return objs
</code></pre>
<p>command</p>
<pre><code>timeout -v 40 ty check TEST___FILE.py
</code></pre>
<p>App was compiled with nightly rust compiler to be able to use address sanitizer
(You can ignore this part if there is no address sanitizer error)
On Ubuntu 24.04, the commands to compile were:</p>
<pre><code>rustup default nightly
rustup component add rust-src --toolchain nightly-x86_64-unknown-linux-gnu
rustup component add llvm-tools-preview --toolchain nightly-x86_64-unknown-linux-gnu

export RUST_BACKTRACE=1 # or full depending on project
export ASAN_SYMBOLIZER_PATH=$(which llvm-symbolizer-18)
export ASAN_OPTIONS=symbolize=1
RUSTFLAGS=&quot;-Zsanitizer=address&quot; cargo +nightly build --target x86_64-unknown-linux-gnu
</code></pre>
<p>cause this</p>
<pre><code>WARN ty is pre-release software and not ready for production use. Expect to encounter bugs, missing features, and fatal errors.
AddressSanitizer:DEADLYSIGNAL
=================================================================
==137935==ERROR: AddressSanitizer: stack-overflow on address 0x7bc352fff6e0 (pc 0x7fc356f88a21 bp 0x7bc352ffe510 sp 0x7bc352ffdcc8 T1)
    #0 0x7fc356f88a21  (/lib/x86_64-linux-gnu/libc.so.6+0x188a21) (BuildId: 282c2c16e7b6600b0b22ea0c99010d2795752b5f)
    #1 0x55da1120ea1b in __asan_memcpy /rustc/llvm/src/llvm-project/compiler-rt/lib/asan/asan_interceptors_memintrinsics.cpp:63:3
    #2 0x55da1209508d in ty_python_semantic::semantic_index::builder::SemanticIndexBuilder::add_place::hb5493e89bae3c3b9 /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff-main/crates/ty_python_semantic/src/semantic_index/builder.rs:583:74
    #3 0x55da1209508d in _$LT$ty_python_semantic..semantic_index..builder..SemanticIndexBuilder$u20$as$u20$ruff_python_ast..visitor..Visitor$GT$::visit_expr::hc6788a153953f4ab /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff-main/crates/ty_python_semantic/src/semantic_index/builder.rs:2340:41
    #4 0x55da12bc80a5 in ruff_python_ast::visitor::walk_expr::h4719d17c0df48d3f /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff-main/crates/ruff_python_ast/src/visitor.rs
    #5 0x55da12096179 in _$LT$ty_python_semantic..semantic_index..builder..SemanticIndexBuilder$u20$as$u20$ruff_python_ast..visitor..Visitor$GT$::visit_expr::hc6788a153953f4ab /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/collections/hash/map.rs
    #6 0x55da12bc7e35 in ruff_python_ast::visitor::walk_expr::h4719d17c0df48d3f /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff-main/crates/ruff_python_ast/src/visitor.rs:393:21
    #7 0x55da12096179 in _$LT$ty_python_semantic..semantic_index..builder..SemanticIndexBuilder$u20$as$u20$ruff_python_ast..visitor..Visitor$GT$::visit_expr::hc6788a153953f4ab /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/collections/hash/map.rs

...

    #239 0x55da12096179 in _$LT$ty_python_semantic..semantic_index..builder..SemanticIndexBuilder$u20$as$u20$ruff_python_ast..visitor..Visitor$GT$::visit_expr::hc6788a153953f4ab /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/collections/hash/map.rs
    #240 0x55da12bc7e35 in ruff_python_ast::visitor::walk_expr::h4719d17c0df48d3f /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff-main/crates/ruff_python_ast/src/visitor.rs:393:21
    #241 0x55da12096179 in _$LT$ty_python_semantic..semantic_index..builder..SemanticIndexBuilder$u20$as$u20$ruff_python_ast..visitor..Visitor$GT$::visit_expr::hc6788a153953f4ab /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/collections/hash/map.rs
    #242 0x55da12bc7e35 in ruff_python_ast::visitor::walk_expr::h4719d17c0df48d3f /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff-main/crates/ruff_python_ast/src/visitor.rs:393:21
    #243 0x55da12096179 in _$LT$ty_python_semantic..semantic_index..builder..SemanticIndexBuilder$u20$as$u20$ruff_python_ast..visitor..Visitor$GT$::visit_expr::hc6788a153953f4ab /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/collections/hash/map.rs
    #244 0x55da12bc7e35 in ruff_python_ast::visitor::walk_expr::h4719d17c0df48d3f /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff-main/crates/ruff_python_ast/src/visitor.rs:393:21
    #245 0x55da12096179 in _$LT$ty_python_semantic..semantic_index..builder..SemanticIndexBuilder$u20$as$u20$ruff_python_ast..visitor..Visitor$GT$::visit_expr::hc6788a153953f4ab /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/collections/hash/map.rs
    #246 0x55da12bc7e35 in ruff_python_ast::visitor::walk_expr::h4719d17c0df48d3f /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff-main/crates/ruff_python_ast/src/visitor.rs:393:21
    #247 0x55da12096179 in _$LT$ty_python_semantic..semantic_index..builder..SemanticIndexBuilder$u20$as$u20$ruff_python_ast..visitor..Visitor$GT$::visit_expr::hc6788a153953f4ab /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/collections/hash/map.rs

SUMMARY: AddressSanitizer: stack-overflow (/lib/x86_64-linux-gnu/libc.so.6+0x188a21) (BuildId: 282c2c16e7b6600b0b22ea0c99010d2795752b5f) 
Thread T1 created by T0 here:
    #0 0x55da111f5301 in pthread_create /rustc/llvm/src/llvm-project/compiler-rt/lib/asan/asan_interceptors.cpp:250:3
    #1 0x55da13c19a86 in std::sys::thread::unix::Thread::new::h2555aeb2bcdf6327 /rustc/0be8e16088894483a7012c5026c3247c14a0c3c2/library/std/src/sys/thread/unix.rs:104:19
    #2 0x55da11f67a30 in std::thread::Builder::spawn_unchecked_::h85a7f1c7b1a25ff3 /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/mod.rs:598:30
    #3 0x55da11f67a30 in std::thread::Builder::spawn_unchecked::h541d1a865816a5bb /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/mod.rs:467:37
    #4 0x55da11f55e89 in std::thread::Builder::spawn::h65b7effa7540d50f /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/thread/mod.rs:399:23
    #5 0x55da11f55e89 in _$LT$rayon_core..registry..DefaultSpawn$u20$as$u20$rayon_core..registry..ThreadSpawn$GT$::spawn::hc5eca8b024d3c5d4 /home/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/rayon-core-1.13.0/src/registry.rs:95:11
    #6 0x55da112c4318 in rayon_core::registry::Registry::new::hc4065a4219b0d8e7 /home/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/rayon-core-1.13.0/src/registry.rs:313:57
    #7 0x55da112c4318 in rayon_core::registry::init_global_registry::_$u7b$$u7b$closure$u7d$$u7d$::hef75eb5d1ebe8484 /home/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/rayon-core-1.13.0/src/registry.rs:182:28
    #8 0x55da112c4318 in rayon_core::registry::set_global_registry::_$u7b$$u7b$closure$u7d$$u7d$::h55b3d26ab058ed6e /home/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/rayon-core-1.13.0/src/registry.rs:196:18
    #9 0x55da112c4318 in std::sync::poison::once::Once::call_once::_$u7b$$u7b$closure$u7d$$u7d$::h35b4127dc3bdebd1 /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sync/poison/once.rs:156:41
    #10 0x55da13c189a6 in std::sys::sync::once::futex::Once::call::hbf65caffdcf730e3 /rustc/0be8e16088894483a7012c5026c3247c14a0c3c2/library/std/src/sys/sync/once/futex.rs:178:21
    #11 0x55da112b442e in std::sync::poison::once::Once::call_once::hc999ea7115fd9b82 /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sync/poison/once.rs:156:20
    #12 0x55da112b442e in rayon_core::registry::set_global_registry::hd6b9ca0cd8fef619 /home/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/rayon-core-1.13.0/src/registry.rs:195:22
    #13 0x55da112a58f6 in rayon_core::registry::init_global_registry::hc54bf32f7537e6ee /home/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/rayon-core-1.13.0/src/registry.rs:182:5
    #14 0x55da112a58f6 in rayon_core::ThreadPoolBuilder$LT$S$GT$::build_global::h022e2f660dbc55aa /home/runner/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/rayon-core-1.13.0/src/lib.rs:278:24
    #15 0x55da1124609b in ty::setup_rayon::hfe165997c724802c /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff-main/crates/ty/src/lib.rs:518:10
    #16 0x55da1124609b in ty::run::ha867af71524ec85b /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff-main/crates/ty/src/lib.rs:36:5
    #17 0x55da1123f35f in ty::main::h2ba48b027e072ccf /home/runner/work/Automated-Fuzzer/Automated-Fuzzer/ruff-main/crates/ty/src/main.rs:6:5
    #18 0x55da11240162 in core::ops::function::FnOnce::call_once::h8f0a9857e62db6fd /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/ops/function.rs:250:5
    #19 0x55da11240162 in std::sys::backtrace::__rust_begin_short_backtrace::h65cdbea652bbb29c /home/runner/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/std/src/sys/backtrace.rs:158:18
    #20 0x55da1124178b in main (/home/runner/.cargo/bin/ty+0x13c578b) (BuildId: b6a5d2a29c33627ac412f6c89dca6396e1c24bf2)
    #21 0x7fc356e2a1c9  (/lib/x86_64-linux-gnu/libc.so.6+0x2a1c9) (BuildId: 282c2c16e7b6600b0b22ea0c99010d2795752b5f)
    #22 0x7fc356e2a28a in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2a28a) (BuildId: 282c2c16e7b6600b0b22ea0c99010d2795752b5f)
    #23 0x55da11182e64 in _start (/home/runner/.cargo/bin/ty+0x1306e64) (BuildId: b6a5d2a29c33627ac412f6c89dca6396e1c24bf2)

==137935==ABORTING

##### Automatic Fuzzer note, output status &quot;Some(1)&quot;, output signal &quot;None&quot;
</code></pre>
<p>File - <a href="https://github.com/user-attachments/files/22450800/compressed.zip">compressed.zip</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fatal</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-09-21 09:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fatal</span> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-09-22 08:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-09-22 08:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-09-22 08:18</div>
            <div class="timeline-body"><p>ty is highly recursive. That&#x27;s why stack overflows are certainly possible and why we increased the default stack size. I&#x27;ll merge this into <a href="https://github.com/astral-sh/ty/issues/96">astral-sh/ty#96</a> as it isn&#x27;t address sanitizer specific, it&#x27;s just that it&#x27;s more likely to happen with an address sanitizer because of its overhead (as you pointed out)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-09-22 08:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fuzzer</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-05 13:08</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:25:34 UTC
    </footer>
</body>
</html>
