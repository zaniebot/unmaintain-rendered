<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annotated assignments of non-name targets are not checked - astral-sh/ty #509</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Annotated assignments of non-name targets are not checked</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/509">#509</a>
        opened by <a href="https://github.com/mtshiba">@mtshiba</a>
        on 2025-05-25 15:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/mtshiba">@mtshiba</a> on 2025-05-25 15:03</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>The following code passes without any errors.</p>
<pre><code class="language-python">l = []
l[0]: int = &quot;foo&quot;

class C:
    declared: int

c = C()
c.unresolved: int = &quot;foo&quot;
c.declared: str = &quot;foo&quot;
</code></pre>
<p>I thought these should be reported as type errors, but it seems that mypy and pyright treat such annotated assignments as &quot;semantically invalid&quot; and report errors without type checking.
In any case, since the current version of ty does not report any problems for this, some kind of fix should be made. In particular, the lack of checking for attribute existence (<code>c.unresolved</code>) is an obvious bug that should be fixed.</p>
<p>see also: https://github.com/microsoft/pylance-release/issues/537</p>
<h3>Version</h3>
<p>ty 0.0.1a6 (ruff@83a036960)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">attribute access</span> added by @AlexWaygood on 2025-05-25 15:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">typing semantics</span> added by @AlexWaygood on 2025-05-25 15:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @sharkdp on 2025-05-26 12:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-05-27 17:51</div>
            <div class="timeline-body"><p>I think annotated assignments of non-Name targets should be treated as inherently semantically invalid and always error, like mypy and pyright do.</p>
<p>Ideally, in addition to emitting the error that the annotation is invalid, we would just then ignore the annotation, and check the assignment as if it were an un-annotated assignment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jelle-openai">@jelle-openai</a> on 2025-05-27 18:06</div>
            <div class="timeline-body"><p>Note both mypy and pyright accept annotations on attribute assignments of self, like this:</p>
<pre><code class="language-python">from typing import Any
class X:
    def __init__(self, x: Any):
        self.x: int = x
        
    def method(self) -&gt; None:
        reveal_type(self.x) # int
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-05-27 18:08</div>
            <div class="timeline-body"><p>Yes, thanks: annotated assignments to attributes of <code>self</code> should be accepted.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-28 08:48</div>
            <div class="timeline-body"><p>FWIW, pyright also supports this (mypy emits an error on the attribute assignment):</p>
<pre><code class="language-py">class C:
    @classmethod
    def f(cls) -&gt; None:
        cls.x: int = 1


reveal_type(C.x)  # int
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-05 10:46</div>
            <div class="timeline-body"><p>One related thing that does seem to me to be buggy is that we do not currently infer that <code>Foo</code> has an instance attribute <code>x</code> for something like this:</p>
<pre><code class="language-py">class Foo:
    def __init__(self):
        self.x: int

f = Foo()

# Type `Foo` has no attribute `x` (unresolved-attribute)
reveal_type(f.x)  # revealed: Unknown
</code></pre>
<p>If you're not actually assigning to <code>self.x</code>, I don't really know why you'd do this rather than annotating it in the class body, which seems more explicit:</p>
<pre><code class="language-py">class Foo:
    x: int
</code></pre>
<p>But <a href="https://github.com/pytest-dev/pytest/blob/3e30eae05fcf37880db1db842d022d873cb2166d/src/_pytest/fixtures.py#L399-L407">popular libraries such as pytest</a> do this, it appears to be supported by <a href="https://mypy-play.net/?mypy=latest&amp;python=3.12&amp;gist=4cd4ceb8f42b1d8342e30df4d50535aa">mypy</a> and <a href="https://pyright-play.net/?pythonVersion=3.12&amp;strict=true&amp;enableExperimentalFeatures=true&amp;code=MYGwhgzhAEBiD28BcAoa7oBMCmAzaA%2BgQJYB2xALkQBQTYi4CUqGr0dDAdAB5LRkUUKfAF44iaoxQAnbADdsYEAQoBPAA7ZquHoyA">pyright</a>, and it doesn't seem any less safe than annotating an instance attribute in the class body without assigning to it. So I think we should add support for this pattern.</p>
<p>Our lack of support for this pattern appears to be the cause of several new false positives in the mypy_primer report in https://github.com/astral-sh/ruff/pull/18041#issuecomment-2888978759.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-06-06 00:18</div>
            <div class="timeline-body"><blockquote>
<p>One related thing that does seem to me to be buggy</p>
</blockquote>
<p>This is related, but to me seems separate enough from the title of this issue to deserve its own issue. I created https://github.com/astral-sh/ty/issues/590</p>
<p>I suspect this might be pretty easy to fix (and thus could get the &quot;help wanted&quot; label), but I'm not familiar enough with the details of our instance attribute machinery to be confident of that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "GA" by @carljm on 2025-08-15 01:50</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 02:11:06 UTC
    </footer>
</body>
</html>
