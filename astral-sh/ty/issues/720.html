<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nontransitive subtyping involving protocols and `object` - astral-sh/ty #720</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Nontransitive subtyping involving protocols and `object`</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/720">#720</a>
        opened by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a>
        on 2025-06-28 15:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/JelleZijlstra">@JelleZijlstra</a> on 2025-06-28 15:42</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>ty currently fails the last assert in this file:</p>
<pre><code class="language-python">from ty_extensions import static_assert, is_subtype_of
from typing import Protocol

class P(Protocol):
    def __str__(self) -&gt; str: ...

class P2(Protocol):
    x: int

static_assert(is_subtype_of(object, P))
static_assert(is_subtype_of(P2, object))
static_assert(is_subtype_of(P2, P))
</code></pre>
<p>https://play.ty.dev/23be40f7-3ebf-4785-991b-29c7508b5e22</p>
<p>That is, it accepts that <code>P2 &lt;: object</code> and <code>object &lt;: P</code>, but not that <code>P2 &lt;: P</code>.</p>
<p>ty has <a href="https://github.com/astral-sh/ruff/blob/c5995c40d3714b3d532864b3d45adc5c88ce7b24/crates/ty_python_semantic/src/types/property_tests.rs#L93">a property test</a> asserting that subtyping is transitive, but it apparently didn't catch this case.</p>
<p>Transitivity of subtyping is important for making union simplification deterministic, but it seems that is not an issue in practice here, because <code>P</code> is also a subtype of <code>object</code> (in the other direction) and ty prefers simplifying to <code>object</code>.</p>
<p>I think this is more of a curiosity than a real bug that can break soundness, but reporting it anyway in case it's more serious than I thought.</p>
<h3>Version</h3>
<p><em>No response</em></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-28 15:53</div>
            <div class="timeline-body"><blockquote>
<p>ty has <a href="https://github.com/astral-sh/ruff/blob/c5995c40d3714b3d532864b3d45adc5c88ce7b24/crates/ty_python_semantic/src/types/property_tests.rs#L93">a property test</a> asserting that subtyping is transitive, but it apparently didn't catch this case.</p>
</blockquote>
<p>yes, we don't generate any protocol types to throw at our property tests yet, because our subtyping/assignability implementation for protocols is very much unfinished. I expect there are probably quite a few more issues like this you'd be able to find if you put your mind to it ;-) My plan had been to add protocols to our property tests once we were a bit further along on our protocols implementation.</p>
<p>Progress on protocols has been a bit slower than expected because it turns out that as soon as you start naively poking at the types of a protocol's members to do a subtype check, you end up with stack overflows if that protocol's members contain (directly or indirectly) a recursive reference back to the original protocol... and protocols like that are surprisingly common!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-06-28 16:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">type properties</span> added by @AlexWaygood on 2025-06-28 16:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">Protocols</span> added by @AlexWaygood on 2025-06-28 16:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AlexWaygood by @AlexWaygood on 2025-06-29 12:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Beta" by @carljm on 2025-08-05 14:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-09-10 11:13</div>
            <div class="timeline-body"><p>This was fixed in https://github.com/astral-sh/ruff/pull/20284</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-09-10 11:13</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 02:11:14 UTC
    </footer>
</body>
</html>
