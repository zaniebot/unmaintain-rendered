<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>validate TypeIs and TypeGuard definitions - astral-sh/ty #2267</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>validate TypeIs and TypeGuard definitions</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/2267">#2267</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-12-29 23:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><p>In order to fully pass the conformance suite for <code>TypeIs</code> and <code>TypeGuard</code>, we need to add some extra validations of functions annotated with a <code>TypeIs</code> or <code>TypeGuard</code> return type.</p>
<ol>
<li>The function should accept exactly one parameter (not counting <code>self</code> or <code>cls</code> if it's a method / classmethod).</li>
<li>For <code>TypeIs</code>, the type parameter of the <code>TypeIs</code> return type must be assignable to the annotated type of the single parameter.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">typing semantics</span> added by @carljm on 2025-12-29 23:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">help wanted</span> added by @carljm on 2025-12-29 23:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">conformance</span> added by @carljm on 2025-12-29 23:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @charliermarsh by @charliermarsh on 2025-12-30 15:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dangotbanned">@dangotbanned</a> on 2025-12-30 17:39</div>
            <div class="timeline-body"><blockquote>
<p>The function should accept exactly one parameter (not counting self or cls if it's a method / classmethod).</p>
</blockquote>
<p>Is this a new requirement of type narrowing functions?</p>
<p>The spec describes something quite different currently:</p>
<p>https://typing.python.org/en/latest/spec/narrowing.html#typeis</p>
<blockquote>
<p>Type narrowing functions must accept at least one positional argument. The type narrowing behavior is applied to the first positional argument passed to the function. <strong>The function may accept additional arguments, but they are not affected by type narrowing</strong>. If a type narrowing function is implemented as an instance method or class method, the first positional argument maps to the second parameter (after <code>self</code> or <code>cls</code>).</p>
</blockquote>
<p>There are these examples as well which show multiple parameters:</p>
<blockquote>
<pre><code class="language-py">def is_str_list(val: list[object], allow_empty: bool) -&gt; TypeGuard[list[str]]:
    if len(val) == 0:
        return allow_empty
    return all(isinstance(x, str) for x in val)

def is_set_of[T](val: set[Any], type: type[T]) -&gt; TypeGuard[set[T]]:
    return all(isinstance(x, type) for x in val)
</code></pre>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-30 18:10</div>
            <div class="timeline-body"><p>My bad, should have double checked the spec. You're right, extra parameters are allowed. (I'm not sure they should be tbh, since if they affect the return type of the function at all, that means the function isn't sound in some way -- but whether I think they should be isn't relevant here ðŸ˜‰)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2025-12-30 18:17</div>
            <div class="timeline-body"><p>(Just confirming that I believe the linked PR implements the appropriate behavior.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jelle-openai">@jelle-openai</a> on 2026-01-05 17:24</div>
            <div class="timeline-body"><blockquote>
<p>if they affect the return type of the function at all, that means the function isn't sound in some way</p>
</blockquote>
<p>That's not true for TypeGuard, though it is true for TypeIs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dangotbanned">@dangotbanned</a> on 2026-01-06 12:29</div>
            <div class="timeline-body"><p>FYI, <a href="https://github.com/narwhals-dev/narwhals/blob/00858bba9666a2cbf71d271308a0ab07413d6867/narwhals/_utils.py#L708-L757">this disaster</a> is understood by <em>at-least</em> <code>pyright</code> - if you wanted a challenge ðŸ˜‰</p>
<p><img width="868" alt="Image" src="https://github.com/user-attachments/assets/65593716-1ed3-4785-9c14-4be72759facb" /></p>
<p>Like a lot of python typing, that came <em>after</em> it was already in use at runtime. I'm not vouching for this as a good idea.</p>
<p>It still has <a href="https://github.com/search?q=repo%3Anarwhals-dev/narwhals%20isinstance_or_issubclass&amp;type=code">quite a few hits on a code search</a> and you might be suprised to know it was once even worse (https://github.com/narwhals-dev/narwhals/pull/3139)</p>
<pre><code class="language-py">from typing import Any, TypeVar, overload
from typing_extensions import TypeIs

_T1 = TypeVar(&quot;_T1&quot;)
_T2 = TypeVar(&quot;_T2&quot;)
_T3 = TypeVar(&quot;_T3&quot;)


class DType: ...


@overload
def isinstance_or_issubclass(
    obj_or_cls: type, cls_or_tuple: type[_T]
) -&gt; TypeIs[type[_T]]: ...


@overload
def isinstance_or_issubclass(
    obj_or_cls: object | type, cls_or_tuple: type[_T]
) -&gt; TypeIs[_T | type[_T]]: ...


@overload
def isinstance_or_issubclass(
    obj_or_cls: type, cls_or_tuple: tuple[type[_T1], type[_T2]]
) -&gt; TypeIs[type[_T1 | _T2]]: ...


@overload
def isinstance_or_issubclass(
    obj_or_cls: object | type, cls_or_tuple: tuple[type[_T1], type[_T2]]
) -&gt; TypeIs[_T1 | _T2 | type[_T1 | _T2]]: ...


@overload
def isinstance_or_issubclass(
    obj_or_cls: type, cls_or_tuple: tuple[type[_T1], type[_T2], type[_T3]]
) -&gt; TypeIs[type[_T1 | _T2 | _T3]]: ...


@overload
def isinstance_or_issubclass(
    obj_or_cls: object | type, cls_or_tuple: tuple[type[_T1], type[_T2], type[_T3]]
) -&gt; TypeIs[_T1 | _T2 | _T3 | type[_T1 | _T2 | _T3]]: ...


@overload
def isinstance_or_issubclass(
    obj_or_cls: Any, cls_or_tuple: tuple[type, ...]
) -&gt; TypeIs[Any]: ...


def isinstance_or_issubclass(obj_or_cls: Any, cls_or_tuple: Any) -&gt; bool:
    # from narwhals.dtypes import DType

    if isinstance(obj_or_cls, DType):
        return isinstance(obj_or_cls, cls_or_tuple)
    return isinstance(obj_or_cls, cls_or_tuple) or (
        isinstance(obj_or_cls, type) and issubclass(obj_or_cls, cls_or_tuple)
    )
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2026-01-06 17:02</div>
            <div class="timeline-body"><p>@dangotbanned I'm not seeing anything there that I think should give us problems, but there definitely might be a bug. Can you also show some examples of using it that should work, particularly if they don't currently? (And in that case, might be good to open a new issue for it, too, since this issue is just about the validation.)</p>
<p>(I realized yesterday that generic <code>TypeIs</code> functions are a case where a multi-argument <code>TypeIs</code> function can be sound and sensible -- so I was just wrong to suggest that they should be single-argument.)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:21:36 UTC
    </footer>
</body>
</html>
