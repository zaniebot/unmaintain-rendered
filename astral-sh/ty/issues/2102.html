<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>local vars reported as types in lsp autocompletion - astral-sh/ty #2102</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>local vars reported as types in lsp autocompletion</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/2102">#2102</a>
        opened by <a href="https://github.com/egorbn">@egorbn</a>
        on 2025-12-19 06:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/egorbn">@egorbn</a></div>
            <div class="timeline-body"><h3>Question</h3>
<p>Not sure if this is expected behavior, but locally defined variables are reported as <code>Struct</code> or <code>Value</code>, when really they should be reported as <code>Variable</code> in the lsp autocompletion.</p>
<p>Here's some example code:</p>
<pre><code class="language-python">def bar(baz: int) -&gt; int:
    return baz


if __name__ == &quot;__main__&quot;:
    msg = &quot;Hello ty&quot;
    print(msg)

    number = bar(3)
    print(number)
</code></pre>
<p>https://play.ty.dev/8825913f-afcf-46be-875e-0ce1553f977e</p>
<h1><code>Value</code> kind</h1>
<p>When completing <code>msg</code> in the print statement, the &quot;kind&quot; of the autocomplete is shows as <code>Value</code> in <code>neovim</code>.</p>
<p>In the online playground the kind icon is also not variable kind, so I'm guessing it's also linked to something like <code>Value</code>.</p>
<p>This kind is shown when variables are declared with literal values.</p>
<h2><code>neovim</code></h2>
<p><img width="1118" height="65" alt="Image" src="https://github.com/user-attachments/assets/851296e5-f875-47d6-9c20-46999bacd588" /></p>
<h2>online playground</h2>
<p><img width="545" height="65" alt="Image" src="https://github.com/user-attachments/assets/0ee73a4f-c416-4b30-ab95-e600adb79c71" /></p>
<h1><code>Struct</code> kind</h1>
<p>When a variable is assigned the return value of a function, the kind is reported as <code>Struct</code>.</p>
<h2><code>neovim</code></h2>
<p><img width="965" height="87" alt="Image" src="https://github.com/user-attachments/assets/05c7514e-1dc5-4f6a-abbe-acb0a23fe2df" /></p>
<h2>online playground</h2>
<p><img width="547" height="70" alt="Image" src="https://github.com/user-attachments/assets/cb0a02d1-9697-4831-b748-f6bfdcce26e1" /></p>
<h1>Question</h1>
<p>Is this expected behavior?</p>
<h1>Suggestion</h1>
<p>I think it would be better to report both as <code>Variable</code> kind, in-line with most tools (at least the ones I'm familiar with).</p>
<p>When I see an autocomplete for a local variable, I want to know that it's a local variable.</p>
<h3>Version</h3>
<p>ty 0.0.4 (c1e6188b1 2025-12-18)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> added by @egorbn on 2025-12-19 06:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">question</span> removed by @AlexWaygood on 2025-12-19 08:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @AlexWaygood on 2025-12-19 08:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">completions</span> added by @AlexWaygood on 2025-12-19 08:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @BurntSushi by @AlexWaygood on 2025-12-19 08:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-12-19 14:39</div>
            <div class="timeline-body"><p>This is a little tricky to me. I'm not quite sure what the right answer is here. I definitely do agree that using a kind of &quot;struct&quot; for an <code>int</code> is very odd though, and we should improve there.</p>
<p>At least currently, the &quot;kind&quot; of a completion for a symbol in scope is determined by its type:</p>
<p>https://github.com/astral-sh/ruff/blob/e177cc2a5a5d5e25c06ea6b0bbac9209f37fe756/crates/ty_ide/src/completion.rs#L325-L383</p>
<p>An <code>int</code> value has this type:</p>
<pre><code>NominalInstance(
    NominalInstanceType(
        NonTuple(
            NonGeneric(
                ClassLiteral(
                    Id(4c01),
                ),
            ),
        ),
    ),
)
</code></pre>
<p>Arguably changing this to a <code>Value</code> kind would be an improvement over <code>Struct</code>. But it's still not quite what you're looking for here.</p>
<p>This makes me wonder whether using the type (or only the type) is the right thing? Consider this example:</p>
<pre><code class="language-python">class zqzqzq: pass
zqzqzq_var = zqzqzq
zqzq&lt;CURSOR&gt;
</code></pre>
<p>Right now we return:</p>
<pre><code>zqzqzq :: Class
zqzqzq_var :: Class
</code></pre>
<p>I think a kind of <code>Class</code> for <code>zqzqzq</code> is correct. But what should the kind for <code>zqzqzq_var</code> be? It still seems like <code>Class</code> is appropriate here <em>and</em> more specific than, say, <code>Variable</code>.</p>
<p>Maybe I'm overthinking this and we should use simpler rules for determining the kind and just go by how the name was bound initially. So <code>zqzqzq</code> would continue being a <code>Class</code> but <code>zqzqzq_var</code> would be a <code>Variable</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-19 15:08</div>
            <div class="timeline-body"><p>I would expect <code>Variable</code> for <code>_var</code>, which is also what I'd expect us to show if I hover it (it tells me it's a variable of type <code>Class</code>). This is also what pylance does.</p>
<p>Is <code>zqzqzq_var = zqzqzq</code> the var in this example a legacy type alias? in which case variable does make sense too, I think</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-19 15:10</div>
            <div class="timeline-body"><p>This does sound like we should be determining this on the <code>DefinitionKind</code> of the variable (from the use-def map) rather than the type of the variable</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-12-19 15:43</div>
            <div class="timeline-body"><p>@AlexWaygood Do you think we can use <a href="https://github.com/astral-sh/ruff/blob/e177cc2a5a5d5e25c06ea6b0bbac9209f37fe756/crates/ty_python_semantic/src/types.rs#L8400"><code>Type::definition</code></a> to get a <a href="https://github.com/astral-sh/ruff/blob/e177cc2a5a5d5e25c06ea6b0bbac9209f37fe756/crates/ty_python_semantic/src/types/definition.rs#L8-L17"><code>TypeDefinition</code></a>? And then from there it's straight-forward to get a <code>Definition</code> and thus a <code>DefinitionKind</code>.</p>
<p>This would avoid needing to use the use-def map directly (which seems trickier?).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-12-19 15:46</div>
            <div class="timeline-body"><p>No, sadly, that doesn't work. That's for the <em>type</em> definition. Ignore me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-19 16:17</div>
            <div class="timeline-body"><blockquote>
<p>This would avoid needing to use the use-def map directly (which seems trickier?).</p>
</blockquote>
<p>You might also be able to use some of the go-to-definition machinery for this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/egorbn">@egorbn</a> on 2025-12-19 16:29</div>
            <div class="timeline-body"><p>Thanks folks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-12-19 16:32</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>This would avoid needing to use the use-def map directly (which seems trickier?).</p>
</blockquote>
<p>You might also be able to use some of the go-to-definition machinery for this</p>
</blockquote>
<p>Yeah I looked at that. But it occurred to me that, at least in some cases, we're already accessing the use-def map to get completions in the first place. And we can usually get the definition when we do it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @BurntSushi by @BurntSushi on 2026-01-09 15:52</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:21:27 UTC
    </footer>
</body>
</html>
