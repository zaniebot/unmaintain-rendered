<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`invalid-type-form` emitted for non-type tuple index expressions - astral-sh/ty #727</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>invalid-type-form</code> emitted for non-type tuple index expressions</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ty/issues/727">#727</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-06-30 07:59
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body"><p>ty emits <code>invalid-type-form</code> for non-type expressions like the following that do not produce errors at runtime:</p>
<pre><code class="language-py">tuple[1]
</code></pre>
<p>While the above case may seem nonsensical, there are real-world code examples where a strict treatment of non-type <code>tuple[ ]</code> expressions under the restricted grammar of type-expressions would lead to false positives (https://github.com/astral-sh/ruff/pull/18991#issuecomment-3018171342). For example:</p>
<pre><code class="language-py">runtime_type_representation = tuple[(int, str) * 3]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @sharkdp on 2025-06-30 07:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">type-inference</span> added by @sharkdp on 2025-06-30 07:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-30 13:32</div>
            <div class="timeline-body"><p>One way to fix this might be to:</p>
<ol>
<li>Refactor <code>infer_type_expression()</code> to return a <code>Result</code> rather than eagerly emitting diagnostics (this might also help with https://github.com/astral-sh/ty/issues/667)</li>
<li>In non-annotation contexts, attempt to parse the inner value as a type expression (and infer a <code>Type::GenericAlias</code> type if so, like we do on <code>main</code>), but if that returns an <code>Err</code>, fall back to <code>Type::NominalInstance(&quot;GenericAlias&quot;)</code> without emitting a diagnostic</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Z post-stable" by @carljm on 2025-11-14 15:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Removed from milestone "Z post-stable" by @carljm on 2025-11-18 16:10</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:20:13 UTC
    </footer>
</body>
</html>
