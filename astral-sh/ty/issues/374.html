<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support custom builtins - astral-sh/ty #374</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Support custom builtins</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/374">#374</a>
        opened by <a href="https://github.com/kkpattern">@kkpattern</a>
        on 2025-05-14 02:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/kkpattern">@kkpattern</a></div>
            <div class="timeline-body"><p>Thanks for this awesome tool!</p>
<p>Some python projects have custom builtins defined. For example, we may add a <code>tr</code> function to builtins for localization:</p>
<pre><code># defined somewhere else.
import builtins

def _tr(source: str) -&gt; str:
    &quot;localize a string.&quot;
    return source

builtins.__dict__[&quot;tr&quot;] = _tr

# in other python scripts.
tr(1)
</code></pre>
<p>Pyright <a href="https://github.com/microsoft/pyright/blob/main/docs/builtins.md">support</a> custom builtins with a <code>__builtins__.pyi</code> file:</p>
<pre><code>def tr(source: str) -&gt; str: ...
</code></pre>
<pre><code>‚ùØ pyright main.py
/.../main.py
  /.../main.py:12:4 - error: Argument of type &quot;Literal[1]&quot; cannot be assigned to parameter &quot;source&quot; of type &quot;str&quot; in function &quot;tr&quot;
  ¬†¬†&quot;Literal[1]&quot; is not assignable to &quot;str&quot; (reportArgumentType)
1 error, 0 warnings, 0 informations
</code></pre>
<p>Customizing builtins may not be a good practice. But considering ruff also <a href="https://docs.astral.sh/ruff/settings/#builtins">support</a> additional builtins, there should be many Python projects doing this. So it would be nice if <code>ty</code> support custom builtins.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wish</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-14 05:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-14 05:48</div>
            <div class="timeline-body"><p>Thanks for opening this issue. This makes sense.</p>
<p>I don&#x27;t have a great recommendation for you. The only thing that comes to mind is that you could define a custom typeshed and include your custom builtins file in it but that&#x27;s a lot of work and something like <code>__builtins__</code> sounds like a nice alternative.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-14 10:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Julian-J-S">@Julian-J-S</a> on 2025-05-16 07:26</div>
            <div class="timeline-body"><p>yes, please ü§ì</p>
<p>Databricks notebooks are another widely used example where this is &quot;required&quot;.
Databricks injects lots of essential variables into every notebook like</p>
<ul>
<li><code>spark</code>: The <code>SparkSession</code> every data operation is build upon</li>
<li><code>dbutils</code>: Databricks utility functions like notebook parameters/widgets</li>
<li><code>display</code>: Displaying notebook inside Databrticks with interactive  tables and plots</li>
<li>much more...</li>
</ul>
<p>These are all top-level variables available by default.</p>
<p>It is commen (and supported by pyright) to create a <code>typings/__builtins__.pyi</code> file like @kkpattern  mentioned.
Example file:</p>
<pre><code>from databricks.sdk.runtime import *
from pyspark.sql.session import SparkSession
from pyspark.sql.functions import udf as U
from pyspark.sql.context import SQLContext

udf = U
spark: SparkSession
sc = spark.sparkContext
sqlContext: SQLContext
sql = sqlContext.sql
table = sqlContext.table
getArgument = dbutils.widgets.getArgument

def displayHTML(html): ...
def display(input=None, *args, **kwargs): ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Julian-J-S">@Julian-J-S</a> on 2025-10-11 17:09</div>
            <div class="timeline-body"><p>Is there any update or plan on this?</p>
<p>Would still be very useful to have ü§ìüòä</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">wish</span> removed by <a href="https://github.com/carljm">@carljm</a> on 2025-10-30 16:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-10-30 16:49</div>
            <div class="timeline-body"><p>I don&#x27;t think we will likely do this for our upcoming beta release, but given the (somewhat surprising, to me) number of upvotes on the issue, maybe we should consider doing it before our GA release.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone &quot;Stable&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-11-14 08:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Wizzerinus">@Wizzerinus</a> on 2025-12-17 09:09</div>
            <div class="timeline-body"><p>I&#x27;m thinking to attempt this since it is one of our team&#x27;s current blockers in adopting ty over basedpyright and probably doesn&#x27;t involve complicated type system tinkering (having to figure out both workarounds for python typing and the intricacies of how ty works under the hood at the same time is probably too much). If it&#x27;s reasonable to pick this up of course :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andrewgross">@andrewgross</a> on 2025-12-19 18:45</div>
            <div class="timeline-body"><p>Adding my +1 for this. I have a similar use case to @Julian-J-S where I have notebooks (also from Databricks) where I have pre-run scripts for Jupyter Kernels:</p>
<pre><code>&quot;jupyter.runStartupCommands&quot;: [
        &quot;import somelib.helpers.development&quot;,
    ],
</code></pre>
<p>This defines things like <code>spark</code>, <code>dbutils</code> etc. With <code>basedpyright</code> I was using the <code>typings/__builtins.pyi__</code> to avoid flagging things defined in my pre-run code. I am not sure if there is a good way to hook into the actual jupyter kernel for these sorts of definitions, but I think just having a way to define the typings would be helpful</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Wizzerinus">@Wizzerinus</a> on 2025-12-19 20:55</div>
            <div class="timeline-body"><p>okie, I think I should ask about the design here before continuing.</p>
<p>the possible designs are:
a) find <code>__builtins__.pyi</code> in the root of the project
done: currently in PR (except I need to fix the fact that this file can also be found in a venv package)
b) find <code>__builtins__.pyi</code> anywhere? I only know that Pyright supports the first option, but idk if it looks for the file anywhere.
c) have a configuration option where to find the builtins file, default to not look for that file.
d) Some other option.</p>
<p>Pyright uses <code>__builtins__.pyi</code> found somewhere (I&#x27;m not sure where).
As far as I know, Mypy, Pyrefly, and Pycharm do not support custom builtins (Pycharm supports custom names, but they will be untyped).</p>
<p>I don&#x27;t think I should really discuss the design here a lot since I think either version accomplishes the same thing from my point of view, and only 1 typechecker supports this currently so there&#x27;s no convention, so it&#x27;s more about what would be the most consistent with what ty is currently doing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-19 20:58</div>
            <div class="timeline-body"><p>I haven&#x27;t tried but the documentation suggests that Pyrefly supports some version of this https://pyrefly.org/en/docs/migrating-from-pyright/#extending-builtins</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Wizzerinus">@Wizzerinus</a> on 2025-12-19 21:08</div>
            <div class="timeline-body"><p>That seems like a new mechanic I didn&#x27;t see last time I scoured the docs, so that&#x27;s cool. Thank you for finding it!</p>
<p>I&#x27;m thinking that we could probably have <code>__builtins__.pyi</code> in project root detected by default, and allow overriding the path to the stub in the config. That would mean overriding stubPath would require putting <code>typings.__builtins__</code> instead of just <code>typings</code> in the config, but also means we&#x27;re not cornercasing a name that doesn&#x27;t really mean anything (which alleviates a concern I&#x27;ve heard earlier).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-23 13:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:24:29 UTC
    </footer>
</body>
</html>
