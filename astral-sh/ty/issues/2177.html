<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ty: assert membership doesn't narrow Literal for TypedDict value - astral-sh/ty #2177</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ty: assert membership doesn't narrow Literal for TypedDict value</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/2177">#2177</a>
        opened by <a href="https://github.com/dsfaccini">@dsfaccini</a>
        on 2025-12-23 02:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Issue opened by <a href="https://github.com/dsfaccini">@dsfaccini</a> on 2025-12-23 02:15</div>
            <div class="timeline-body"><h3>Summary</h3>
<p>Ty rejects a TypedDict literal value even after an <code>assert</code> narrowing check.</p>
<p>NOTE: playground link incoming</p>
<h3>Repro (self-contained)</h3>
<p><code>ty_repro_openai_audio.py</code>:</p>
<pre><code class="language-python"># /// script
# dependencies = [
#     &quot;openai&gt;=1.57&quot;,
# ]
# ///

from typing import Literal
from dataclasses import dataclass

from openai.types.chat.chat_completion_content_part_input_audio_param import InputAudio


@dataclass
class Item:
    data: str
    format: str


def build_audio(item: Item) -&gt; InputAudio:
    # Guard intended to narrow format to the allowed literal set.
    assert item.format in (&quot;wav&quot;, &quot;mp3&quot;)
    return InputAudio(data=item.data, format=item.format)


def main() -&gt; Literal[&quot;ok&quot;]:
    build_audio(Item(data=&quot;d&quot;, format=&quot;wav&quot;))
    return &quot;ok&quot;


if __name__ == &quot;__main__&quot;:
    print(main())
</code></pre>
<p>Run:</p>
<pre><code class="language-bash">uvx ty check ty_repro_openai_audio.py
</code></pre>
<h3>Actual result</h3>
<pre><code>error[invalid-argument-type]: Invalid argument to key &quot;format&quot; with declared type `Literal[&quot;wav&quot;, &quot;mp3&quot;]` on TypedDict `InputAudio`
  --&gt; ty_repro_openai_audio.py:22:12
   |
20 |     # Guard intended to narrow format to the allowed literal set.
21 |     assert item.format in (&quot;wav&quot;, &quot;mp3&quot;)
22 |     return InputAudio(data=item.data, format=item.format)
   |            ----------                 -------^^^^^^^^^^^
   |            |                          |      |
   |            |                          |      value of type `str`
   |            |                          key has declared type `Literal[&quot;wav&quot;, &quot;mp3&quot;]`
   |            TypedDict `InputAudio`
</code></pre>
<h3>Expected result</h3>
<p>The <code>assert item.format in (&quot;wav&quot;, &quot;mp3&quot;)</code> should narrow <code>item.format</code> to the literal union and allow the <code>InputAudio</code> TypedDict assignment with no diagnostic.</p>
<h3>Notes</h3>
<p>Ty version: 0.0.4 via <code>uvx ty check</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dsfaccini">@dsfaccini</a> on 2025-12-23 02:18</div>
            <div class="timeline-body"><p>closing this in favour of #2178 bc the openai dep is not necessary for repro. sorry for the spam.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dsfaccini on 2025-12-23 02:18</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 01:53:03 UTC
    </footer>
</body>
</html>
