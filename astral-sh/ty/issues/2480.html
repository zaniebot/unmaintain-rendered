<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Missing type narrowing for `NoReturn` control flow - astral-sh/ty #2480</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Missing type narrowing for <code>NoReturn</code> control flow</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ty/issues/2480">#2480</a>
        opened by <a href="https://github.com/mvaldi">@mvaldi</a>
        on 2026-01-13 14:03
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mvaldi">@mvaldi</a></div>
            <div class="timeline-body"><h1>Type narrowing not working after calling a <code>NoReturn</code> function</h1>
<p>Hi! I love this project. It's blazingly fast and i use it daily. i found what i believe is a bug with type narrowing after calling a function typed as <code>NoReturn</code></p>
<h2>Summary</h2>
<p>When a function with return type <code>NoReturn</code> is called inside an <code>if</code> block to guard against <code>None</code>, <code>ty</code> does not narrow the type of the variable in subsequent code. The variable still shows as <code>str | None</code> instead of being narrowed to <code>str</code>.</p>
<h2>Minimal Reproduction</h2>
<pre><code class="language-python">from typing import NoReturn


def raise_error() -&gt; NoReturn:
    &quot;&quot;&quot;Raise an error.&quot;&quot;&quot;
    msg = &quot;This is a test error&quot;
    raise ValueError(msg)


data: dict[str, str] = {}

api_key = data.get(&quot;api_key&quot;)
if not api_key:
    raise_error()


def use_api_key(api_key: str) -&gt; None:
    &quot;&quot;&quot;Use an API key.&quot;&quot;&quot;
    api_key.startswith(&quot;sk_&quot;)


use_api_key(api_key)  # &lt;-- Error reported here
</code></pre>
<h2>Expected Behavior</h2>
<p>After the <code>if not api_key: raise_error()</code> block, <code>ty</code> should understand that:</p>
<ol>
<li>The <code>raise_error()</code> function <strong>never returns</strong> (it's typed as <code>NoReturn</code>)</li>
<li>Therefore, if execution continues past that point, <code>api_key</code> cannot be <code>None</code> or falsy</li>
<li>The type of <code>api_key</code> should be narrowed from <code>str | None</code> to <code>str</code></li>
</ol>
<p>This is the same behavior as if you used <code>raise ValueError()</code> directly in the <code>if</code> block.</p>
<h2>Actual Behavior</h2>
<p><code>ty</code> reports an error on the <code>use_api_key(api_key)</code> call:</p>
<pre><code>Argument to function `use_api_key` is incorrect: Expected `str`, found `str | None`
  invalid-argument-type
</code></pre>
<h2>Environment</h2>
<ul>
<li><strong>ty version</strong>: 0.0.11</li>
<li><strong>OS</strong>: Linux</li>
<li><strong>Python version</strong>: 3.12+</li>
</ul>
<h2>Workaround</h2>
<p>Currently, I have to add an explicit <code>api_key = &quot;&quot;</code> after the guard, which defeats the purpose of having the <code>NoReturn</code> typed function.</p>
<h3>Version</h3>
<p>0.0.11</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-13 14:05</div>
            <div class="timeline-body"><p>Thanks! this is #690</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2026-01-13 14:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-13 14:23:19 UTC
    </footer>
</body>
</html>
