<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Remove special casing for tuple addition - astral-sh/ruff #19636</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Remove special casing for tuple addition</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19636">#19636</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-07-30 12:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR removes our special casing for tuple addition from <code>TypeInferenceBuilder::infer_binary_expression_type</code>. After #19635 (which this PR is based on top of) has landed, our generics solver works well enough with tuple types that we can just use the generic signature on the typeshed stub for <code>tuple.__add__</code> rather than implementing any special casing here for tuples. The typeshed <code>__add__</code> signature results in us inferring less precise types in many instances, but we nonetheless continue to infer a type that is <em>precise enough</em> for nearly all practical use cases involving tuples. This can be seen from the fact that this PR has no impact on the typing conformance tests, and has a very minimal mypy_primer diff (two diagnostics removed, four diagnostics changed).</p>
<p>The special casing on <code>main</code> has minimal upside, then -- but it has significant downsides.</p>
<ul>
<li><p>It causes significant performance issues for various pathological cases involving tuples. This can be seen from the Codspeed results on this PR. We also no longer hang when checking the snippet given in https://github.com/astral-sh/ty/issues/765 -- in fact, we type-check it almost instantly. Even with this PR, it's probably possible to produce pathological code samples that will make ty's execution time blow up due to extremely large tuple types, and we should work on a more comprehensive fix for this issue. But I think it's notable that many of the cases we've found regarding this so far have been related to tuple addition, and this PR gets rid of that particular trigger for the problem.</p>
</li>
<li><p>The special casing is currently not applied for tuple subclasses: but a subclass of <code>tuple[int, str]</code> should be treated exactly the same way as <code>tuple[int, str]</code> with respect to the special casing applied by ty, since we would allow an instance of the subclass to be passed wherever an instance of <code>tuple[int, str]</code> is expected. Extending the special casing so that it also applies to tuple subclasses would be possible, but in order to do this in a sound manner we would have to ban any overrides of <code>__add__</code> or <code>__radd__</code> on a tuple subclass. Otherwise, we'd have no way of ensuring that an <code>__(r)add__</code> override on a tuple subclass was sound, since the behaviour of <code>tuple.__(r)add__</code> cannot be described fully in a type annotation.</p>
<p>Banning <code>__add__</code> and <code>__radd__</code> overrides on tuple subclasses feels overly restrictive to me; given the other downsides and the minimal upsides of this special casing, I lean towards simply removing it.</p>
</li>
</ul>
<p>Closes https://github.com/astral-sh/ty/issues/765</p>
<h2>Test Plan</h2>
<p>Mdtests updated</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-07-30 12:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-07-30 12:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-07-30 12:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-07-30 12:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @AlexWaygood on 2025-07-30 12:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-30 12:09</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on typing conformance tests</h2>
<p>No changes detected when running ty on typing conformance tests âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-30 12:10</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">vision (https://github.com/pytorch/vision)
- references/depth/stereo/transforms.py:190:16: error[invalid-return-type] Return type does not match returned value: expected `tuple[tuple[Unknown, Unknown], tuple[@Todo(Inference of subscript on special form), @Todo(Inference of subscript on special form)], tuple[@Todo(Inference of subscript on special form), @Todo(Inference of subscript on special form)]]`, found `tuple[tuple[Unknown, Unknown], tuple[()] | tuple[Unknown] | tuple[None], tuple[()] | tuple[Unknown] | tuple[None]]`
+ references/depth/stereo/transforms.py:190:16: error[invalid-return-type] Return type does not match returned value: expected `tuple[tuple[Unknown, Unknown], tuple[@Todo(Inference of subscript on special form), @Todo(Inference of subscript on special form)], tuple[@Todo(Inference of subscript on special form), @Todo(Inference of subscript on special form)]]`, found `tuple[tuple[Unknown, Unknown], tuple[Unknown, ...] | tuple[None, ...], tuple[Unknown, ...] | tuple[None, ...]]`
- references/depth/stereo/transforms.py:485:16: error[invalid-return-type] Return type does not match returned value: expected `tuple[tuple[Unknown, Unknown], tuple[@Todo(Inference of subscript on special form), @Todo(Inference of subscript on special form)], tuple[@Todo(Inference of subscript on special form), @Todo(Inference of subscript on special form)]]`, found `tuple[tuple[()] | tuple[Unknown], tuple[()] | tuple[Unknown] | tuple[None], tuple[()] | tuple[Unknown] | tuple[None]]`
+ references/depth/stereo/transforms.py:485:16: error[invalid-return-type] Return type does not match returned value: expected `tuple[tuple[Unknown, Unknown], tuple[@Todo(Inference of subscript on special form), @Todo(Inference of subscript on special form)], tuple[@Todo(Inference of subscript on special form), @Todo(Inference of subscript on special form)]]`, found `tuple[tuple[Unknown, ...], tuple[Unknown, ...] | tuple[None, ...], tuple[Unknown, ...] | tuple[None, ...]]`
- references/depth/stereo/transforms.py:579:9: error[invalid-assignment] Object of type `tuple[()] | tuple[Unknown] | tuple[@Todo(Inference of subscript on special form), @Todo(Inference of subscript on special form)]` is not assignable to `tuple[@Todo(Inference of subscript on special form), @Todo(Inference of subscript on special form)]`
+ references/depth/stereo/transforms.py:580:9: error[invalid-assignment] Object of type `tuple[None | Unknown, ...] | tuple[@Todo(Inference of subscript on special form), @Todo(Inference of subscript on special form)]` is not assignable to `tuple[@Todo(Inference of subscript on special form), @Todo(Inference of subscript on special form)]`
- references/depth/stereo/transforms.py:580:9: error[invalid-assignment] Object of type `tuple[()] | tuple[None | Unknown] | tuple[@Todo(Inference of subscript on special form), @Todo(Inference of subscript on special form)]` is not assignable to `tuple[@Todo(Inference of subscript on special form), @Todo(Inference of subscript on special form)]`
- references/depth/stereo/transforms.py:601:16: error[invalid-return-type] Return type does not match returned value: expected `tuple[tuple[Unknown, Unknown], tuple[@Todo(Inference of subscript on special form), @Todo(Inference of subscript on special form)], tuple[@Todo(Inference of subscript on special form), @Todo(Inference of subscript on special form)]]`, found `tuple[tuple[Unknown, Unknown], tuple[(@Todo(Inference of subscript on special form) &amp; None) | Unknown, (@Todo(Inference of subscript on special form) &amp; None) | Unknown], tuple[()] | tuple[(@Todo(Inference of subscript on special form) &amp; None) | Unknown]]`
+ references/depth/stereo/transforms.py:601:16: error[invalid-return-type] Return type does not match returned value: expected `tuple[tuple[Unknown, Unknown], tuple[@Todo(Inference of subscript on special form), @Todo(Inference of subscript on special form)], tuple[@Todo(Inference of subscript on special form), @Todo(Inference of subscript on special form)]]`, found `tuple[tuple[Unknown, Unknown], tuple[(@Todo(Inference of subscript on special form) &amp; None) | Unknown, (@Todo(Inference of subscript on special form) &amp; None) | Unknown], tuple[(@Todo(Inference of subscript on special form) &amp; None) | Unknown, ...]]`
- Found 1483 diagnostics
+ Found 1482 diagnostics

scipy (https://github.com/scipy/scipy)
- scipy/linalg/_decomp_schur.py:247:16: error[index-out-of-bounds] Index 0 is out of bounds for tuple `tuple[()]` with length 0
- Found 6803 diagnostics
+ Found 6802 diagnostics

</code></pre>
</details>
No memory usage changes detected âœ…

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-07-30 12:16</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_INSTRUMENTATION_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/alex%2Ftuple-add?runnerMode=Instrumentation">CodSpeed Instrumentation Performance Report</a></h2>
<h3>Merging #19636 will <strong>improve performances by 90.81%</strong></h3>
<p><sub>Comparing <code>alex/tuple-add</code> (dbe53ab) with <code>main</code> (38049aa)</sub></p>
<h3>Summary</h3>
<p><code>âš¡ 1</code> improvements<br />
<code>âœ… 40</code> untouched benchmarks<br />
<code>ðŸ†• 1</code> new benchmarks</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| âš¡ | <code>ty_micro[many_tuple_assignments]</code> | 119.4 ms | 62.6 ms | +90.81% |
| ðŸ†• | <code>ty_micro[many_tuple_assignments]</code> | N/A | 57.9 ms | N/A |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @AlexWaygood on 2025-07-30 12:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-07-30 12:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_benchmark/benches/ty.rs</code>:357 on 2025-07-30 12:42</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    criterion.bench_function(&quot;ty_micro[tuple_implicit_instance_attributes]&quot;, |b| {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-30 12:42</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> approved on 2025-07-30 14:17</div>
            <div class="timeline-body"><blockquote>
<p>The special casing on <code>main</code> has minimal upside, then</p>
</blockquote>
<p>I do think it was a fun &quot;look what we can do&quot; feature, but that's not worth it given the downsides you've listed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-07-30 16:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-07-30 16:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-30 16:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:14:40 UTC
    </footer>
</body>
</html>
