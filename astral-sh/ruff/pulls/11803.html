<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[POC] `ruff server` Expand format action capability - astral-sh/ruff #11803</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[POC] <code>ruff server</code> Expand format action capability</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11803">#11803</a>
        opened by <a href="https://github.com/T-256">@T-256</a>
        on 2024-06-08 16:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/T-256">@T-256</a></div>
            <div class="timeline-body">

Summary
<p>implement <a href="https://github.com/astral-sh/ruff/issues/11756">astral-sh/ruff#11756</a>#issuecomment-2155720286 which is currently not ready for notebook documents:</p>
<pre><code>{
    &quot;ruff.format.action&quot;: {
        &quot;fix&quot;: true,
        &quot;isort&quot;: true,
        &quot;style&quot;: true,
    }
}
</code></pre>
<p>This PR also moves <code>ruff.fixAll</code> and <code>ruff.organizeImports</code> under <code>ruff.sourceAction</code> superset.</p>
Test Plan
<p>Not tested yet</p>
<p>(self-note: also mention revealment issues on ruff-vscode/ruff-lsp)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/T-256">@T-256</a> reviewed on 2024-06-08 16:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/T-256">@T-256</a> on <code>crates/ruff_server/src/fix.rs</code>:169 on 2024-06-08 16:17</div>
            <div class="timeline-body"><p>feel free to rewrite this function. I think it could be better implementation at here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-06-08 17:17</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-06-10 21:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-06-11 04:14</div>
            <div class="timeline-body"><p>Thank you for opening this! I&#x27;ll give this a through review tomorrow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/snowsignal">@snowsignal</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-11 06:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-06-11 12:15</div>
            <div class="timeline-body"><p>Meta note: we should decide whether we want to support this functionality before reviewing the implementation itself.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/T-256">@T-256</a> on 2024-06-11 12:43</div>
            <div class="timeline-body"><blockquote>
<p>Meta note: we should decide whether we want to support this functionality before reviewing the implementation itself.</p>
</blockquote>
<p>For better decision, here is list of issues that this change may have affect on them:</p>
<ul>
<li>https://github.com/astral-sh/ruff/issues/11756</li>
<li>https://github.com/astral-sh/ruff/issues/8232</li>
<li>https://github.com/astral-sh/ruff-lsp/issues/409</li>
<li>https://github.com/astral-sh/ruff-lsp/issues/335</li>
</ul>
<p>Also, in my preference, I don&#x27;t have any code action/format on save enablement, instead After bunch of time and complete write on that file I manually run <code>fixAll</code>, <code>orginizeImport</code> and <code>Format Document</code> commands to finalizing codes. I&#x27;ll be happy to have these three commands in one place and by only executing <code>Format Document</code> all others executed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;`ruff server` Expand format action capability&quot; to &quot;[POC] `ruff server` Expand format action capability&quot; by <a href="https://github.com/T-256">@T-256</a> on 2024-06-11 12:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/gegoune">@gegoune</a> on 2024-06-11 14:08</div>
            <div class="timeline-body"><p>As a user I would like to have all of those three actions executed on save. At the moment I am relying on external tool to provide some of that automation (for Neovim) and would really like to have it streamlined.</p>
<p>I can imagine race conditions and ordering issues resulting from using two tools interacting.</p>
<p>Basically, to phrase it differently, since I am already running <code>ruff server</code> I would like it to handle <code>--fix</code> as well (instead of having to also run it separately). Not sure if that&#x27;s against LSP protocol though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-06-12 00:00</div>
            <div class="timeline-body"><p>@T-256 We&#x27;re still deliberating on this, but we should have an update soon.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-12 06:11</div>
            <div class="timeline-body"><p>I&#x27;m commenting here because it seems that most of the discussion happened on the PR to this point and not in the issue.</p>
<p>I agree that this solves a real user problem, but I&#x27;m not sure if this, or even a custom command that groups these different actions is the right solution.</p>
<p>I&#x27;ve two main concerns:</p>
<p>First, the new settings don&#x27;t work with range formatting. Ruff doesn&#x27;t support applying <em>organize imports</em> or fixing stylistic lints to a sub range. These operations always apply to the entire document. That means that we either can&#x27;t support range formatting anymore if the options are enabled or that ruff would always &quot;format&quot; the entire document, ignoring the users <em>format changed lines only</em> setting. I think either isn&#x27;t a good outcome.</p>
<p>The alternative of having a custom command that runs formatting, isort, and stylistic fixes at once suffers from the same problem where.</p>
<p>Second, there are now multiple ways to configure the same behavior, except that the behavior is slightly different. My worry is that users will copy paste together their configuration without fully understanding what they&#x27;re configuring. I do that too. But I worry that this will lead to &quot;almost&quot; functional configurations that are then hard to debug. What if they have organize imports on save enabled in their VS code settings AND included import sorting as part of formatting. Maybe everything goes well and Ruff just spends a few cycles doing unnecessary import resorting or it leads to very subtle bugs that are hard to reproduce.</p>
<p>That&#x27;s why I prefer that we have one way to configure a specific behavior over multiple ones.</p>
<p>Now, this doesn&#x27;t solve the problem for editors that don&#x27;t support running multiple commands on save. Are there editor specific solutions that we could implement (outside of <code>ruff_server</code>), e.g. a custom plugin? Are there existing issues for these editors for adding support for running multiple commands on save? What&#x27;s their progress?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/T-256">@T-256</a> on 2024-06-12 10:12</div>
            <div class="timeline-body"><blockquote>
<p>That means that we either can&#x27;t support range formatting anymore if the options are enabled or that ruff would always &quot;format&quot; the entire document</p>
</blockquote>
<p>As I said in <a href="https://github.com/astral-sh/ruff/issues/11756">astral-sh/ruff#11756</a>#issuecomment-2155720286, Only <em>Format Document</em> will respect these settings, <em>Format Selection</em> or <em>Format changed lines on save</em> ignores these settings.</p>
<p>Your second concern is True, and I agree to it.</p>
<p>This was just a POC of idea I had in my mind. I close this PR because of it comes with few UX complexity.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/T-256">@T-256</a> on 2024-06-12 10:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:04:33 UTC
    </footer>
</body>
</html>
