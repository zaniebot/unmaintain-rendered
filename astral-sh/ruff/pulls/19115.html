<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`ruff`] Fix `RUF033` breaking with named default expressions - astral-sh/ruff #19115</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>ruff</code>] Fix <code>RUF033</code> breaking with named default expressions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19115">#19115</a>
        opened by <a href="https://github.com/robsdedude">@robsdedude</a>
        on 2025-07-03 07:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>The generated fix for <code>RUF033</code> would cause a syntax error for named expressions as parameter defaults.</p>
<pre><code class="language-python">from dataclasses import InitVar, dataclass
@dataclass
class Foo:
    def __post_init__(self, bar: int = (x := 1)) -&gt; None:
        pass
</code></pre>
<p>would be turned into</p>
<pre><code class="language-python">from dataclasses import InitVar, dataclass
@dataclass
class Foo:
    x: InitVar[int] = x := 1
    def __post_init__(self, bar: int = (x := 1)) -&gt; None:
        pass
</code></pre>
<p>instead of the syntactically correct</p>
<pre><code class="language-python"># ...
x: InitVar[int] = (x := 1)
# ...
</code></pre>
<h2>Test Plan</h2>
<p>Test reproducer (plus some extra tests) have been added to the test suite.</p>
<h2>Related</h2>
<p>Fixes: https://github.com/astral-sh/ruff/issues/18950</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-03 07:49</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @robsdedude on 2025-07-03 08:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @ntBre on 2025-07-04 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @ntBre on 2025-07-04 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/post_init_default.rs</code>:157 on 2025-07-04 20:13</div>
            <div class="timeline-body"><p>This check looks kind of convoluted and unnecessary to me. I don't think the <code>ParameterWithDefault</code> AST node is likely to change. That's basically what it's checking right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/post_init_default.rs</code>:164 on 2025-07-04 20:19</div>
            <div class="timeline-body"><p>I don't think we need to switch all the way to using the code generator here. Can't we just check if the expression <code>is_expr_named</code> and add parens if so? Or I think we could even check the <code>parenthesized_range</code> and preserve the parens it came with.</p>
<p>It's nice to prefer range replacements because the generator strips out any comments, as well as being much more verbose.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-04 20:21</div>
            <div class="timeline-body"><p>Thanks! I think the results look right, but I have a couple of suggestions for the implementation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-07-04 22:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/src/rules/ruff/rules/post_init_default.rs</code>:157 on 2025-07-04 22:43</div>
            <div class="timeline-body"><p>Yes. In particular it's asserting that no other syntactic element is added after the parameter's default value to make sure that the following deletion does not accidentally end up deleting something else but the default value.</p>
<p>I obviously can't give you an example of what such an element would look like because I don't have a crystal ~~ball~~ <em>snake</em>, but think of type hints that have been added and would've made a similar assumption invalid: if anything follows after a parameter name, it's its default value.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/post_init_default.rs</code>:157 on 2025-07-09 18:53</div>
            <div class="timeline-body"><p>I still think this is an overly defensive check and not <em>really</em> related to the issue at hand. I imagine it would be pretty clear that we should re-evaluate any use of <code>ParameterWithDefault</code> if the Python grammar changes, so I'd rather not clutter the rule implementation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-09 18:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-07-22 17:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/src/rules/ruff/rules/post_init_default.rs</code>:164 on 2025-07-22 17:59</div>
            <div class="timeline-body"><p>I managed to rewrite it using <code>parenthesized_range</code>. It's passing the same tests. But if feels crazy fragile. Looking at the code I cannot convince myself of its correctness and that I haven't missed any edge case. I don't feel comfortable with my name being attached to that code. Sorry.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @robsdedude on 2025-07-22 17:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-22 18:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/post_init_default.rs</code>:164 on 2025-07-22 18:07</div>
            <div class="timeline-body"><p>If you feel that strongly about it, we can keep the old implementation. I don't really see how it's more fragile, and we have similar checks in other rules, but this was only a slight preference on my part, not a blocker. I'd much rather fix the bug and give you credit for your work here. I'll approve and merge this if you want to revert/drop the last commit and reopen the PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/robsdedude">@robsdedude</a> on <code>crates/ruff_linter/src/rules/ruff/rules/post_init_default.rs</code>:164 on 2025-07-23 07:36</div>
            <div class="timeline-body"><p>Where I think this is fragile: if the Syntax ever changes, string replacements like these bake in too many assumptions. That's how this bug happened in the first place: a new syntax construct (walrus operator) was introduced and the replacement logic wasn't up to the task.</p>
<p>Moreover, <code>parenthesized_range</code> calls <code>parentheses_iterator</code>, which in turn is documented with</p>
<pre><code class="language-rust">/// Returns an iterator over the ranges of the optional parentheses surrounding an expression.
</code></pre>
<p>Yeah no... these parens are surely not optional :grimacing: It's quite unfortunate, I find, that the AST does not always include the parens where they're necessary in the expression's range. But neither does Python's own <code>ast</code> module :shrug:</p>
<p>I slept a night over it and I'll re-open the PR. If not, I would've given you permission to take my code and commit it under your name. So regardless of how this ends <em>some</em> fix can be merged.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/robsdedude">@robsdedude</a> reviewed on 2025-07-23 07:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @robsdedude on 2025-07-23 07:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-07-23 14:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/ruff/rules/post_init_default.rs</code>:164 on 2025-07-23 14:33</div>
            <div class="timeline-body"><blockquote>
<p>Where I think this is fragile: if the Syntax ever changes, string replacements like these bake in too many assumptions. That's how this bug happened in the first place: a new syntax construct (walrus operator) was introduced and the replacement logic wasn't up to the task.</p>
</blockquote>
<p>Ahh, I see where you're coming from. I think that explains the other assertion too. I guess I wasn't really thinking about it in the same way since the walrus operator and Python 3.8 predate Ruff by ~3 years. So it wasn't so much that something new came out and broke us, just that the initial rule implementation didn't account for everything that already existed.</p>
<blockquote>
<p>Yeah no... these parens are surely not optional</p>
</blockquote>
<p>I can also see what you mean here, but I always read this as referring to a Rust <code>Option</code>, like the return type of <code>parenthesized_range</code>, as in the expression may or may not have parentheses rather than may or may not require parentheses.</p>
<p>Anyway, I'm happy with either implementation. I'll give this another quick review now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/resources/test/fixtures/ruff/RUF033.py</code>:116 on 2025-07-23 14:35</div>
            <div class="timeline-body"><p>Can we use a different name here? It's funny, but I think we try to avoid this kind of thing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-07-23 14:39</div>
            <div class="timeline-body"><p>Thanks again! Just one nit about a test case name, but this is otherwise good to go from my side.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-07-24 13:06</div>
            <div class="timeline-body"><p>Thank you! I'll merge after the patch release finishes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ntBre on 2025-07-24 13:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ntBre on 2025-07-24 13:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-24 14:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:13:55 UTC
    </footer>
</body>
</html>
