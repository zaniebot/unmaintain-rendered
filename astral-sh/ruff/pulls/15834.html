<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] gather type prevalence statistics - astral-sh/ruff #15834</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] gather type prevalence statistics</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15834">#15834</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-01-30 18:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><p>Something Alex and I threw together during our 1:1 this morning. Allows us to collect statistics on the prevalence of various types in a file, most usefully TODO types or other dynamic types.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @carljm on 2025-01-30 18:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @carljm on 2025-01-30 18:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @carljm on 2025-01-30 18:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @carljm on 2025-01-30 18:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-01-30 19:01</div>
            <div class="timeline-body"><p>Hmm, the test failure here is very odd! Test definitely passes locally. Will have to look into this later.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-30 21:44</div>
            <div class="timeline-body"><p>that is really weird. it passes for me locally too (and it's obviously passing on all but one of our CI jobs).</p>
<p>That said, the statistic given by the one job that's failing is a statistic that makes more sense intuitively to me...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-01-31 00:04</div>
            <div class="timeline-body"><p>The issue is that in a release build we (intentionally, for perf reasons) omit tracking of distinct messages / file-and-line information for Todo types. So this results in fewer different kinds of Todo types in a release build. Then this interacts with another bug, which is that we are using <code>FxHashMap::extend</code> wrongly to combine statistics from different scopes (this won't sum the totals when the key exists in both maps). The latter bug only shows up if the same type occurs in more than one scope, and that only occurs in our tests when running in release mode so that all Todo types are the same.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-01-31 00:32</div>
            <div class="timeline-body"><p>Pushed a commit that fixes statistics merging, and fixes the tests.</p>
<p>It remains the case that we can't add any tests specifically testing that the statistics for &quot;different&quot; Todo types are differentiated, or those tests will fail on a release build. (We could switch any such tests off in release build.) We can still build features making use of this differentiation, but they will only work in debug build.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-31 10:32</div>
            <div class="timeline-body"><blockquote>
<p>We can still build features making use of this differentiation, but they will only work in debug build.</p>
</blockquote>
<p>I think it's okay to make some statistics-related features only available if debug assertions are enabled. Statistics collection doesn't need to be that fast.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-31 10:42</div>
            <div class="timeline-body"><p>The bug we had in our use of <code>HashMap::extend()</code> makes me wonder if it is worth using a &quot;proper&quot; reimplementation of Python's <code>collections.Counter</code> class, like https://docs.rs/counter/latest/counter/, rather than rolling our own version. We could make the additional dependency conditional on a <code>statistics</code> optional feature.</p>
<p>But for now, it still may not be worth the additional dependency.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2025-01-31 15:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-01-31 15:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-31 15:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/statistics.rs</code>:7 on 2025-01-31 21:43</div>
            <div class="timeline-body"><p>Do we expect this method to be called multiple times in the same revision and file for it to be a salsa query?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-01-31 21:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-01-31 21:45</div>
            <div class="timeline-body"><p>Should this be gated to debug only builds? How is it intended to be used?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-01-31 22:22</div>
            <div class="timeline-body"><p>Depending on what this is used for: have you considered using Countme? E.g. by adding a count flag to every relevant type?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-31 22:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/statistics.rs</code>:7 on 2025-01-31 22:52</div>
            <div class="timeline-body"><p>Perhaps roughly equally likely as <code>check_types</code>, which is a query? It's very parallel to <code>check_types</code>, so seems reasonable to handle them the same way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-01-31 22:57</div>
            <div class="timeline-body"><blockquote>
<p>Should this be gated to debug only builds? How is it intended to be used?</p>
</blockquote>
<p>Two potential uses are as part of ecosystem check, and as a user-facing feature to measure static type coverage. Former could perhaps be debug-gated (though we may want to run ecosystem check on release build for speed), latter cannot be.</p>
<blockquote>
<p>have you considered using Countme?</p>
</blockquote>
<p>I don't think countme works for this. If we have 20 expressions in a file typed as <code>Type::Any</code>, there aren't 20 distinct instances of any struct created that could be counted with countme.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-01 08:51</div>
            <div class="timeline-body"><p>I'm sort of leaning towards reverting this change until we have a concrete usage that informs the design and avoids this just being dead code:</p>
<ul>
<li>It's unclear if the function should be a query (is this function ever called in watch mode?)</li>
<li>The map currently counts <code>Literal[&quot;str&quot;]</code> and <code>Literal[&quot;st&quot;]</code> as two separate types. Do we need this precision? If not, we could use a <code>Vec</code> instead of a hash map with absolute indices for the few types we want to distinguish (e.g. how many classes, functions, string literals, etc)</li>
<li>What about types nested in <code>Union</code>s and <code>Intersection</code>s or declared types? The current implementation disregards them completely</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-01 17:14</div>
            <div class="timeline-body"><p>The idea was just to land an MVP that wasn't too complicated. Perhaps you're right and this really is too minimal to even be worth keeping in the source code, though.</p>
<blockquote>
<p>It's unclear if the function should be a query (is this function ever called in watch mode?)</p>
</blockquote>
<p>probably not</p>
<blockquote>
<p>The map currently counts <code>Literal[&quot;str&quot;]</code> and <code>Literal[&quot;st&quot;]</code> as two separate types. Do we need this precision? If not, we could use a <code>Vec</code> instead of a hash map with absolute indices for the few types we want to distinguish (e.g. how many classes, functions, string literals, etc)</p>
</blockquote>
<p>What's the downside of having this level of precision?</p>
<blockquote>
<p>What about types nested in <code>Union</code>s and <code>Intersection</code>s or declared types? The current implementation disregards them completely</p>
</blockquote>
<p>We're aware. Again, this was meant to be just a simple MVP. I think even just knowing the number of &quot;pure TODO types&quot; we infer when running on <code>tomllib</code> would be interesting and useful to me right now. And since each TODO type records its provenance when we run red-knot with debug assertions enabled, this could give us useful information about which features should be prioritised next (which TODOs are most important to tackle).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-01 18:21</div>
            <div class="timeline-body"><blockquote>
<p>What's the downside of having this level of precision?</p>
</blockquote>
<p>More granular statistics have a higher runtime cost (performance and storage). The most simple representation -- and probably sufficient for this MVP -- is to only count the number of todo types. This can be done with a single usize. The next step is to store the type kind: Literal, Unknown, any. This can be done with a fixed array or vector. Counting the unique usages of each type (which this PR implements) requires a hash map which requires expensive hashing and is probably large. We should only use the hash map solution if we have a need for it -- which I don't think we currently do</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:09:37 UTC
    </footer>
</body>
</html>
