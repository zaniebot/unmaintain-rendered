<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bump MSRV to 1.83 - astral-sh/ruff #16294</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>bump MSRV to 1.83</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16294">#16294</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2025-02-21 02:06
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/carljm">@carljm</a> on 2025-02-21 02:06</div>
            <div class="timeline-body"><p>According to our new MSRV policy (see https://github.com/astral-sh/ruff/issues/16370 ), bump our MSRV to 1.83 (N - 2), and autofix some new clippy lints.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @carljm on 2025-02-21 02:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @carljm on 2025-02-21 02:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @carljm on 2025-02-21 02:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-21 02:16</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">breaking</span> added by @MichaReiser on 2025-02-21 07:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">breaking</span> removed by @MichaReiser on 2025-02-21 07:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-02-21 07:07</div>
            <div class="timeline-body"><p>This is technically a breaking change for anyone building Ruff from source because they now need a newer Rust version to do so.</p>
<p>I have a slight preference to keep the current MSRV unless there's a lot of boilerplate involved.</p>
<p>The other thing we have to consider when bumping the MSRV is whether downstream packaging tools have updated to this Rust version (e.g. homebrew). This should be fine, considering that uv already uses 1.83</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-02-21 07:32</div>
            <div class="timeline-body"><p>Ok I'll try the boilerplate tomorrow. Just annoying writing uglier code that shouldn't need to be that way to accommodate older rust versions :/ doesn't seem like it should be hard for anyone to use 1.83 instead of 1.80, and I'm sure we'll bump it up sometime...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-21 08:39</div>
            <div class="timeline-body"><p>I'd say it depends on how much more boilerplate it requires. If it's something you can do in 15min, let's keep the MSRV as is. If not, bump it (although a lower MSRV might also be important for other projects using salsa)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-02-22 01:34</div>
            <div class="timeline-body"><blockquote>
<p>If it's something you can do in 15min</p>
</blockquote>
<p>I wasn't able to find something that compiles within 15min, but maybe you know how to do it.</p>
<p>The problem is at https://github.com/salsa-rs/salsa/blob/1ff42613cbaa699567009895a6d00b87bf7772e6/src/cycle.rs#L97 -- hashset iterators only starting implementing <code>Default</code> in Rust 1.83.</p>
<p>In the owning <code>IntoIterator</code> impl above I can just replace <code>.unwrap_or_default()</code> with <code>.unwrap_or_else(|| FxHashSet::default().into_iter())</code>. But in the borrowed version I can't figure out what I can put in the <code>.unwrap_or_else()</code> without getting errors about borrowing from a local, or returning the wrong type. Even if I remove the Copied and let it be just an iterator over <code>&amp;DatabaseKeyIndex</code>, I still get errors about borrowing from a local if I try to use <code>FxHashSet::default().iter()</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-22 08:21</div>
            <div class="timeline-body"><p>Yeah, I think you'd have to write your own iterator. Which is definitely less nice but it's not a show-stopper:</p>
<pre><code class="language-rust">impl std::iter::IntoIterator for CycleHeads {
    type Item = DatabaseKeyIndex;
    type IntoIter = std::collections::hash_set::IntoIter&lt;Self::Item&gt;;

    fn into_iter(self) -&gt; Self::IntoIter {
        self.0
            .map(|heads| *heads)
            .unwrap_or_else(|| FxHashSet::default())
            .into_iter()
    }
}

pub struct CycleHeadsIter&lt;'a&gt;(Option&lt;std::collections::hash_set::Iter&lt;'a, DatabaseKeyIndex&gt;&gt;);

impl&lt;'a&gt; Iterator for CycleHeadsIter&lt;'a&gt; {
    type Item = DatabaseKeyIndex;

    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
        self.0.as_mut()?.next().copied()
    }

    fn last(self) -&gt; Option&lt;Self::Item&gt; {
        self.0?.last().copied()
    }
}

impl FusedIterator for CycleHeadsIter&lt;'_&gt; {}

impl&lt;'a&gt; std::iter::IntoIterator for &amp;'a CycleHeads {
    type Item = DatabaseKeyIndex;
    type IntoIter = CycleHeadsIter&lt;'a&gt;;

    fn into_iter(self) -&gt; Self::IntoIter {
        CycleHeadsIter(self.0.as_ref().map(|heads| heads.iter()))
    }
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-02-22 18:27</div>
            <div class="timeline-body"><p>Thanks! Added this to the Salsa PR to maintain 1.80 compat, will close this for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-02-22 18:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @carljm on 2025-02-25 20:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @carljm on 2025-02-25 20:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-02-26 07:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2025-02-26 07:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2025-02-26 14:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-02-26 14:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-26 14:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:49:31 UTC
    </footer>
</body>
</html>
