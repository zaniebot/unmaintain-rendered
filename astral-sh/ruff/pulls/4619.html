<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove source position from `FormatElement::DynamicText` - astral-sh/ruff #4619</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Remove source position from <code>FormatElement::DynamicText</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4619">#4619</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-05-24 07:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-24 07:46</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR removes the <code>source_position</code> from the <code>DynamicText</code> because it isn't always possible (at least in Ruff) to know the source position for dynamically formatted texts. We now used to pass <code>TextSize::default</code> which is incorrect because it will create source mappings from position <code>0</code> to the position in the output document, which is obviously incorrect and may drip over consumers of the source map.</p>
<p>Providing source position information for <code>dynamic_text</code>s is still encouraged. That's why I leave the <code>source_position</code> on the <code>dynamic_text</code> builder as an <code>Optional</code> argument. The builder emits the new  <code>FormatElement::SourcePosition</code> element if the position is set.</p>
<p>I decided to introduce the new <code>FormatElement::SourcePosition</code> in favor of changing the <code>position</code> field on <code>DynamicText</code> to <code>Option&lt;TextSize&gt;</code> because of:</p>
<ul>
<li>Having a dedicated IR element allows us to emit source positions at the start and end of every node even if we don't have a token.</li>
<li>Changing the field to <code>Option&lt;TextSize&gt;</code> on <code>DynamicText</code> increases the field from 4 to 8 bytes so that <code>DynamicText</code> takes 24 bytes in total. This will prevent us from reducing our <code>FormatElement</code> back to 24 bytes again.</li>
</ul>
<h2>Test Plan</h2>
<p>I ran the formatter tests and added a new doctest for the new source position element</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-24 07:46</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #4619</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4619" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ<ul>
<li><strong>PR #4622</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4622" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #4632</strong> <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4632" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4619?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-24 07:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_formatter/src/printer/mod.rs</code>:325 on 2023-05-24 07:50</div>
            <div class="timeline-body"><p>I'm fairly certain that <code>+= text.text_len()</code> produces incorrect results for dynamic texts (text that haven't been present in the source code.</p>
<p>Let's assume that the formatter replaces <code>&quot;String with useless \' escape&quot;</code> with &quot;String with useless ' escape&quot;. It will now map the source position of the <code>&quot;</code> to after the end of the string, which is incorrect. The result is worse if the new text is longer than the original text, because it then  maps the source position past the end of the source-string.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_formatter/src/format_element.rs</code>:389 on 2023-05-24 08:12</div>
            <div class="timeline-body"><p><code>assert_eq_size</code> tells you in the error message the sizes of both structs and doesn't just give you some random const evaluation math error.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-24 08:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_formatter/src/builders.rs</code>:309 on 2023-05-24 08:13</div>
            <div class="timeline-body"><p>There are multiple markers per source position because we need to know where it starts and ends in the formatted document.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-05-24 08:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-05-24 08:34</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
linter/all-rules/large/dataset.py          1.00     15.0Â±0.13ms     2.7 MB/sec    1.05     15.7Â±0.07ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.6Â±0.00ms     4.6 MB/sec    1.02      3.7Â±0.01ms     4.5 MB/sec
linter/all-rules/numpy/globals.py          1.00    374.8Â±4.77Âµs     7.9 MB/sec    1.01    379.7Â±2.21Âµs     7.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.2Â±0.02ms     4.1 MB/sec    1.03      6.5Â±0.01ms     4.0 MB/sec
linter/default-rules/large/dataset.py      1.00      7.4Â±0.02ms     5.5 MB/sec    1.10      8.1Â±0.02ms     5.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1571.9Â±5.17Âµs    10.6 MB/sec    1.05   1649.5Â±2.97Âµs    10.1 MB/sec
linter/default-rules/numpy/globals.py      1.01    174.9Â±0.30Âµs    16.9 MB/sec    1.00    173.7Â±1.73Âµs    17.0 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.4Â±0.01ms     7.6 MB/sec    1.08      3.6Â±0.01ms     7.1 MB/sec
parser/large/dataset.py                    1.00      5.7Â±0.02ms     7.2 MB/sec    1.01      5.7Â±0.01ms     7.1 MB/sec
parser/numpy/ctypeslib.py                  1.00   1116.5Â±2.13Âµs    14.9 MB/sec    1.01   1130.6Â±6.09Âµs    14.7 MB/sec
parser/numpy/globals.py                    1.00    114.7Â±0.26Âµs    25.7 MB/sec    1.02    116.8Â±0.48Âµs    25.3 MB/sec
parser/pydantic/types.py                   1.00      2.4Â±0.00ms    10.4 MB/sec    1.01      2.5Â±0.00ms    10.4 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                    pr
-----                                      ----                                    --
linter/all-rules/large/dataset.py          1.00     16.0Â±0.09ms     2.5 MB/sec     1.00     16.0Â±0.08ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.1Â±0.04ms     4.1 MB/sec     1.00      4.1Â±0.04ms     4.1 MB/sec
linter/all-rules/numpy/globals.py          1.00    480.4Â±6.38Âµs     6.1 MB/sec     1.01    484.4Â±4.64Âµs     6.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.7Â±0.05ms     3.8 MB/sec     1.00      6.8Â±0.08ms     3.8 MB/sec
linter/default-rules/large/dataset.py      1.02      8.0Â±0.04ms     5.1 MB/sec     1.00      7.8Â±0.04ms     5.2 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.04  1706.7Â±134.30Âµs     9.8 MB/sec    1.00  1648.7Â±12.71Âµs    10.1 MB/sec
linter/default-rules/numpy/globals.py      1.01    191.3Â±2.03Âµs    15.4 MB/sec     1.00    189.0Â±9.69Âµs    15.6 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.6Â±0.02ms     7.2 MB/sec     1.00      3.6Â±0.09ms     7.1 MB/sec
parser/large/dataset.py                    1.00      6.4Â±0.03ms     6.4 MB/sec     1.00      6.4Â±0.03ms     6.4 MB/sec
parser/numpy/ctypeslib.py                  1.00  1188.6Â±13.30Âµs    14.0 MB/sec     1.00  1187.8Â±21.08Âµs    14.0 MB/sec
parser/numpy/globals.py                    1.00    120.5Â±1.67Âµs    24.5 MB/sec     1.00    120.4Â±1.79Âµs    24.5 MB/sec
parser/pydantic/types.py                   1.01      2.7Â±0.03ms     9.6 MB/sec     1.00      2.7Â±0.02ms     9.6 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2023-05-24 09:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">autoformatter</span> added by @MichaReiser on 2023-05-24 09:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-05-24 14:26</div>
            <div class="timeline-body"><p>Is the source position only used for debugging the formatter IR right now?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-05-24 14:36</div>
            <div class="timeline-body"><blockquote>
<p>Is the source position only used for debugging the formatter IR right now?</p>
</blockquote>
<p>I don't think it's used at all right now. But we'll need it to support range formatting (to extract the selected range from the formatted document). So I thought I put it in place already :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-05-24 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-05-24 14:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-05-24 14:36</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 03:50:43 UTC
    </footer>
</body>
</html>
