<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] add auto-completion MVP to LSP - astral-sh/ruff #17744</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] add auto-completion MVP to LSP</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17744">#17744</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2025-04-30 18:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>This PR does the wiring necessary to respond to completion requests from
LSP clients.</p>
<p>As far as the actual completion results go, they are nearly about the
dumbest and simplest thing we can do: we simply return a de-duplicated
list of all identifiers from the current module.</p>
<p>Ref astral-sh/ty#86</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @BurntSushi on 2025-04-30 18:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @BurntSushi on 2025-04-30 18:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @BurntSushi on 2025-04-30 18:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @BurntSushi on 2025-04-30 18:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @BurntSushi on 2025-04-30 18:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-04-30 18:24</div>
            <div class="timeline-body"><p>Demo:</p>
<p>https://github.com/user-attachments/assets/07b25e50-cd5e-4403-886b-d398f151a2b4</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @BurntSushi on 2025-04-30 18:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @BurntSushi on 2025-04-30 18:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @BurntSushi on 2025-04-30 18:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @BurntSushi on 2025-04-30 18:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @BurntSushi on 2025-04-30 18:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @BurntSushi on 2025-04-30 18:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "red_knot_server: add auto-completion MVP" to "[red-knot] red_knot_server: add auto-completion MVP" by @BurntSushi on 2025-04-30 18:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @BurntSushi on 2025-04-30 18:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-30 18:26</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-04-30 18:48</div>
            <div class="timeline-body"><p>Looks reasonable to me, but I'd rather have @dhruvmanila or @MichaReiser look at the LSP side.</p>
<p>My main concern here is that I would probably prefer to release the alpha with no autocomplete than with autocomplete that doesn't make use of type information. But we can always ship a quick diff to turn it off right before the alpha release, if we don't get far enough.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-04-30 19:02</div>
            <div class="timeline-body"><p>@carljm Would you be okay to have it disabled by default, but allow an env var or some other undocumented toggle enable it? Just for practical purposes of keeping it in tree and being able to iterate.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-04-30 19:06</div>
            <div class="timeline-body"><blockquote>
<p>@carljm Would you be okay to have it disabled by default, but allow an env var or some other undocumented toggle enable it? Just for practical purposes of keeping it in tree and being able to iterate.</p>
</blockquote>
<p>Oh for sure, that's what I was imagining, definitely not that we'd rip out the code entirely. I'm fine with doing that now, or waiting and seeing where we're at with it end of next week.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-04-30 19:08</div>
            <div class="timeline-body"><p>SGTM!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-04-30 20:32</div>
            <div class="timeline-body"><p>We could do something similar to what r-a does with their &quot;experimental&quot; capabilities which requires explicit opt-in from client side. Refer to the first paragraph in https://github.com/rust-lang/rust-analyzer/blob/master/docs/book/src/contributing/lsp-extensions.md#lsp-extensions:</p>
<blockquote>
<p>All capabilities are enabled via the experimental field of <code>ClientCapabilities</code> or <code>ServerCapabilities</code>.</p>
</blockquote>
<p>Specifically, <a href="https://github.com/rust-lang/rust-analyzer/blob/5d66d45005fef79751294419ab9a9fa304dfdf5c/editors/code/src/client.ts#L290-L330">here</a> they send the capabilities that the VS Code extension supports.</p>
<p>So, for us it could look like below which would be sent when during the server initialization process:</p>
<pre><code class="language-json">&quot;capabilities&quot;: {
	&quot;experimental&quot;: {
		&quot;completions&quot;: {
			&quot;enabled&quot;: true
		}
	}
} 
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_server/src/server/api.rs</code>:41 on 2025-04-30 20:38</div>
            <div class="timeline-body"><p>I think this should use <code>BackgroundSchedule::LatencySensitive</code> as completions should be prioritized than e.g., computing the diagnostics or computing the inlay hints. This wouldn't really affect much right now but might do when we need to compute symbols across the workspace like e.g., suggest users that a possible symbol that matches the text at the current cursor position exists in another module (auto-imports).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_ide/src/completion.rs</code>:27 on 2025-04-30 20:40</div>
            <div class="timeline-body"><p>Can we rely on <code>visit_identifier</code> here instead? Or, did you encounter any issues when using that method?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-04-30 20:40</div>
            <div class="timeline-body"><p>Looks good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] red_knot_server: add auto-completion MVP" to "[red-knot] add auto-completion MVP to LSP" by @MichaReiser on 2025-05-01 06:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_ide/src/completion.rs</code>:21 on 2025-05-01 06:03</div>
            <div class="timeline-body"><p>This doesn't have to be as part of this PR because I think it would require fleshing out some API for it but we could do this by resolving the <code>semantic_index</code>, iterating over all scopes, and collecting the names from every scope.</p>
<p>This would be a nice stepping stone to the next step where you'd identify in which scope you are and only suggest the names from that or its ancestor scopes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_ide/src/completion.rs</code>:11 on 2025-05-01 06:04</div>
            <div class="timeline-body"><p>This could, probably return a <code>&amp;'db str</code> but I'm fine with a <code>String</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_server/src/server.rs</code>:232 on 2025-05-01 06:05</div>
            <div class="timeline-body"><p>Nit: We probably want to tinker with the options here in the future</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-05-01 06:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-05-01 11:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/red_knot_ide/src/completion.rs</code>:11 on 2025-05-01 11:55</div>
            <div class="timeline-body"><p>Yeah it eventually has to get turned into a <code>String</code> anyway. And I figured this would all be refactored soon anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-05-01 11:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/red_knot_server/src/server.rs</code>:232 on 2025-05-01 11:56</div>
            <div class="timeline-body"><p>Yup I looked, but they all seemed pretty in the weeds. I also noticed that even if I didn't set this, the client still tried to send completion requests. But this seemed the &quot;most correct&quot; given what exists now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_ide/src/completion.rs</code>:21 on 2025-05-01 12:06</div>
            <div class="timeline-body"><blockquote>
<p>we could do this by resolving the <code>semantic_index</code>, iterating over all scopes, and collecting the names from every scope.</p>
</blockquote>
<p>we already have a query that basically does that in https://github.com/astral-sh/ruff/blob/main/crates/red_knot_python_semantic/src/semantic_index/re_exports.rs (but it only visits the global scope, currently at least)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-05-01 12:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-05-01 12:35</div>
            <div class="timeline-body"><p>Thank you @dhruvmanila for the tip about an experimental opt-in! I created an issue tracking that for the alpha milestone: https://github.com/astral-sh/ty/issues/74</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-05-01 12:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/red_knot_server/src/server/api.rs</code>:41 on 2025-05-01 12:55</div>
            <div class="timeline-body"><p>Yeah makes sense. I did see this and wondered if I should use it, but nothing else did yet so I was unsure. Nice catch!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-05-01 12:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/red_knot_ide/src/completion.rs</code>:27 on 2025-05-01 12:57</div>
            <div class="timeline-body"><p>Yeah! Just didn't know about it. Nice catch. :-) Much simpler.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/red_knot_ide/src/completion.rs</code>:21 on 2025-05-01 12:58</div>
            <div class="timeline-body"><p>This sounds great, thank you for the idea. I didn't know about this! This looks like a next good step.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-05-01 12:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2025-05-01 16:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2025-05-01 16:08</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-05-01 16:08</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:12:05 UTC
    </footer>
</body>
</html>
