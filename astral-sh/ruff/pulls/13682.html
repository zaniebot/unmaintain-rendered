<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmonise methods for distinguishing different Python source types - astral-sh/ruff #13682</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Harmonise methods for distinguishing different Python source types</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13682">#13682</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-10-08 17:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-08 17:42</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>I was looking into #13246 to see if we could land the proposed change as part of Ruff 0.7, and noticed that we're currently pretty inconsistent in how we try to determine whether something is a Python source file or not (and, if so, what kind of source file it is). This PR tries to make it so that we only ever use <code>ruff_python_ast::PySourceType</code> for that purpose. This removes duplicated logic and the number of magic <code>&quot;py&quot;</code> or <code>&quot;pyi&quot;</code> strings across the codebase, and it should make it easier to make changes such as #13246 in the future.</p>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @AlexWaygood on 2024-10-08 17:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2024-10-08 17:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-10-08 17:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-08 17:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_server/src/session/index.rs</code>:76 on 2024-10-08 17:58</div>
            <div class="timeline-body"><p>this compares case-sensitively where the existing code compares case-insensitively. I don't actually know if that's correct for Jupyter notebooks, but I do know that casing <em>does</em> matter for other Python files. <code>import foo</code> succeeds if the <code>foo</code> module is found at <code>foo.py</code>, but fails if the <code>foo</code> module is found at <code>foo.PY</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-10-08 18:04</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>‚úÖ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>‚úÖ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-10-08 18:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/red_knot_server/src/session/index.rs</code>:76 on 2024-10-08 18:24</div>
            <div class="timeline-body"><p>Hard to get data on this...</p>
<img width="1775" alt="Screenshot 2024-10-08 at 1 24 01‚ÄØPM" src="https://github.com/user-attachments/assets/a5bb8b27-edc6-4a40-b06a-6a463760d275">

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2024-10-08 18:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/red_knot_server/src/session/index.rs</code>:76 on 2024-10-08 18:25</div>
            <div class="timeline-body"><p>Seems overkill to make the breaking change for <code>ipynb</code>, I think the <code>.PY</code> import logic does make sense though?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-10-08 20:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_server/src/session/index.rs</code>:76 on 2024-10-08 20:41</div>
            <div class="timeline-body"><blockquote>
<p>this compares case-sensitively where the existing code compares case-insensitively. I don't actually know if that's correct for Jupyter notebooks, but I do know that casing <em>does</em> matter for other Python files. <code>import foo</code> succeeds if the <code>foo</code> module is found at <code>foo.py</code>, but fails if the <code>foo</code> module is found at <code>foo.PY</code></p>
</blockquote>
<p>Is this also true on case insensitive file systems? I do think that import resolver is different from what we consider a python file</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-10-08 20:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_server/src/session/index.rs</code>:76 on 2024-10-08 20:54</div>
            <div class="timeline-body"><p>My experience is that most applications don't consider file extensions to be case sensitive. Naming a file test.txt or test.TXT doesn't change the application in which my desktop environment opens the file. That's why I think we shouldn't treat file extensions as case sensitive but I can see how this is beyond the scope of this pr</p>
<p>It does make sense that the module resolver only tests for the existence of ‚Äô<module>.py‚Äô and whether ‚Äô<module>.PY‚Äô is considered to match depends on the file system's case sensitivity</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-09 10:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_server/src/session/index.rs</code>:76 on 2024-10-09 10:48</div>
            <div class="timeline-body"><p>For now I will revert these changes so that this PR is a &quot;pure refactor&quot; that does not change functionality. I think we may need to review this, though. In most places, we currently do case-sensitive matching for file extensions. Maybe that's correct or maybe it's incorrect, but it seems like we're pretty inconsistent right now. (And if that inconsistency is correct, because we need to apply logic in different situations, then we could at least add some comments to explain it more clearly üòÑ)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @zanieb by @AlexWaygood on 2024-10-09 10:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @AlexWaygood on 2024-10-09 10:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_builtins/rules/builtin_module_shadowing.rs</code>:48 on 2024-10-09 12:34</div>
            <div class="timeline-body"><p>Nit: This seems somewhat common. We could consider introducing a method for it: <code>is_python_or_stub</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-10-09 12:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-10-09 12:35</div>
            <div class="timeline-body"><p>Could you create an issue to re-visit the case-insensitive extension matching and assign it to the next milestone. We should re visit this soon.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-10-09 13:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_builtins/rules/builtin_module_shadowing.rs</code>:48 on 2024-10-09 13:00</div>
            <div class="timeline-body"><p>makes sense</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2024-10-09 13:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-10-09 13:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-10-09 13:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-10-09 13:19</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/alex/remove-redundant-routines">CodSpeed Performance Report</a></h2>
<h3>Merging #13682 will <strong>degrade performances by 4.13%</strong></h3>
<p><sub>Comparing <code>alex/remove-redundant-routines</code> (ac777ae) with <code>main</code> (b9827a4)</sub></p>
<h3>Summary</h3>
<p><code>‚ùå 1</code> regressions
<code>‚úÖ 31</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/alex/remove-redundant-routines">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>main</code> | <code>alex/remove-redundant-routines</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ‚ùå | <code>lexer[numpy/globals.py]</code> | 28.9 ¬µs | 30.1 ¬µs | -4.13% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-09 13:24</div>
            <div class="timeline-body"><p>the codspeed flamegraph for this PR is very noisy so it's hard to tell, but I <em>think</em> that's just a false positive. I don't think I can see anything that would be plausibly related to this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-10-09 13:29</div>
            <div class="timeline-body"><blockquote>
<p>Could you create an issue to re-visit the case-insensitive extension matching and assign it to the next milestone. We should re visit this soon.</p>
</blockquote>
<p>I opened https://github.com/astral-sh/ruff/issues/13691</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 21:00:08 UTC
    </footer>
</body>
</html>
