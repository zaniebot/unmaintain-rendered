<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Fix `python` setting in mdtests, and rewrite a `site-packages` test as an mdtest - astral-sh/ruff #17222</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Fix <code>python</code> setting in mdtests, and rewrite a <code>site-packages</code> test as an mdtest</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17222">#17222</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-04-05 16:04
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-05 16:04</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR does the following things:</p>
<ul>
<li>Fixes the <code>python</code> configuration setting for mdtest (added in https://github.com/astral-sh/ruff/pull/17221) so that it expects a path pointing to a venv's <code>sys.prefix</code> variable rather than the a path pointing to the venv's <code>site-packages</code> subdirectory. This brings the <code>python</code> setting in mdtest in sync with our CLI <code>--python</code> flag.</li>
<li>Tweaks mdtest so that it automatically creates a valid <code>pyvenv.cfg</code> file for you if you don't specify one. This makes it much more ergonomic to write an mdtest with a custom <code>python</code> setting: red-knot will reject a <code>python</code> setting that points to a directory that doesn't have a <code>pyvenv.cfg</code> file in it</li>
<li>Tweaks mdtest so that it doesn't check a custom <code>pyvenv.cfg</code> as Python source code if you <em>do</em> add a custom <code>pyvenv.cfg</code> file for your mock virtual environment in an mdtest. (You get a lot of diagnostics about Python syntax errors in the <code>pyvenv.cfg</code> file, otherwise!)</li>
<li>Rewrites the test added in https://github.com/astral-sh/ruff/pull/17178 as an mdtest, and deletes the original test that was added in that PR</li>
</ul>
<h2>Test Plan</h2>
<p>I verified that the new mdtest fails if I revert the changes to <code>resolver.rs</code> that were added in https://github.com/astral-sh/ruff/pull/17178</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @AlexWaygood on 2025-04-05 16:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-04-05 16:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-04-05 16:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-04-05 16:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-04-05 16:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2025-04-05 16:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-05 16:06</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/lib.rs</code>:243 on 2025-04-05 17:06</div>
            <div class="timeline-body"><p>Hmm, GitHub doesn't allow me to add a suggestion.</p>
<p>Can you move the <code>let python_version = test.configuration().python_version().unwrap_or_default();</code> out of the <code>if let Some(python_path) = python_path</code> and use the same version in the <code>ProgramSettings</code> initializer. Just to ensure that we use the same version.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/lib.rs</code>:278 on 2025-04-05 17:07</div>
            <div class="timeline-body"><p>I only noticed this now. The <code>PythonCliFlag</code> variant isn't very accurate because the source is either <code>environment.python</code> or <code>--python</code>. But that's unrelated to this PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-04-05 17:08</div>
            <div class="timeline-body"><p>Nice. This was a bit more work than expected. Thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-06 11:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/relative.md</code>:271 on 2025-04-06 11:44</div>
            <div class="timeline-body"><p>this doesn't work on Windows, because on Windows the <code>site-packages</code> subdirectory is in a different path relative to <code>sys.prefix</code> (and red-knot knows this, which is what is causing the test to fail!). For the test to pass on Windows, this would need to be</p>
<pre><code class="language-suggestion">`/src/.venv/Lib/site-packages/foo/__init__.py`:

```py
from .a import A as A
```

`/src/.venv/Lib/site-packages/foo/a.py`:

```py
class A: ...
```
</code></pre>
<p>(which is honestly more sane; I wish it were like this on non-Windows platforms too).</p>
<p>I'm wondering about adding a &quot;magic path segment&quot; like this, which mdtest would automatically replace with whatever the path to <code>site-package</code> is on the platform that the test is being run on, before it writes the file to the memory file system:</p>
<pre><code class="language-suggestion">`/src/.venv/&lt;path-to-site-packages&gt;/foo/__init__.py`:

```py
from .a import A as A
```

`/src/.venv/&lt;path-to-site-packages&gt;/foo/a.py`:

```py
class A: ...
```
</code></pre>
<p>But this also feels like a certain amount of spiralling complexity. It might be best to say that tests which need to mock out <code>site-packages</code> should stay written in Rust rather than use mdtests?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-06 12:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/relative.md</code>:271 on 2025-04-06 12:11</div>
            <div class="timeline-body"><p>I implemented the &quot;magic path segment&quot; solution (and documented it) in https://github.com/astral-sh/ruff/pull/17222/commits/33976270346528217fe59c9cd09db9f7c7b37bb5. It's not <em>too</em> much added complexity, though I'm still not totally sure it's worth it. The alternative is just to close this PR, though (and maybe revert https://github.com/astral-sh/ruff/pull/17221), so I figured I'd push it to this PR so it can be reviewed. And it is nice to have as many tests as possible be mdtests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @AlexWaygood on 2025-04-06 12:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @AlexWaygood on 2025-04-06 12:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2025-04-06 12:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-04-06 17:18</div>
            <div class="timeline-body"><p>uff, this is annoying... but I remember that I ran into this before.</p>
<p>I do like your solution and, thanks for documenting it. An alternative is to have platform-specific tests (only run them on UNIX), but it's not that we want one or the other. It's more that we might want both and use magic paths if we want to test some generic venv behavior and platform-specific tests if we want to test platform-specific venv behavior.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-04-06 17:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-04-06 17:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-06 17:24</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:41:06 UTC
    </footer>
</body>
</html>
