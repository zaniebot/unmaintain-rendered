<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Don't send publish diagnostics for clients supporting pull diagnostics - astral-sh/ruff #21772</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Don&#x27;t send publish diagnostics for clients supporting pull diagnostics</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21772">#21772</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-12-03 07:55
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">Summary
<p>fixes: <a href="https://github.com/astral-sh/ty/issues/1727">astral-sh/ty#1727</a></p>
<p>This PR fixes the reported duplicated diagnostic in <a href="https://github.com/astral-sh/ty/issues/1727">astral-sh/ty#1727</a> by skipping <code>publish_diagnostics</code>
if pull diagnostics are enabled, similar to how we do this in other places.</p>
<p>While this PR fixes the duplicate diagnostics, there&#x27;s still the question why vim sends <code>didChangeWatchedFiles</code> for
a file that&#x27;s currently open in the editor. The issue with that is that the server is now in this awkward spot
that it has to decide whether it should use the new content on disk OR the content that&#x27;s currently open in the editor (as reported by <code>didOpen</code>, <code>didChange</code>). For now, ty uses the content sent by <code>didOpen</code>/<code>didChange</code>,
meaning, ty will ignore the new content when checking the project.</p>
<p>I think this is the sensible thing to do here. The client either has to tell the server that the file is now closed,
in which case ty will use the content from disk, or that the user accepted the on-disk changes over the in-editor changes
by sending a <code>didChange</code> notification.</p>
Test Plan
<p>Added E2E test</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-03 07:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-03 07:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-03 07:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-03 07:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-03 07:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-03 07:55</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-03 07:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-03 07:57</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-03 07:59</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>scikit-build-core (https://github.com/scikit-build/scikit-build-core)
- src/scikit_build_core/_logging.py:153:13: warning[unsupported-base] Unsupported class base with type `&lt;class &#x27;Mapping[str, Style]&#x27;&gt; | &lt;class &#x27;Mapping[str, Divergent]&#x27;&gt;`
- Found 42 diagnostics
+ Found 41 diagnostics


</code></pre>


<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-03 08:14</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-03 08:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/AlexWaygood">@AlexWaygood</a> removed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-03 08:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-03 08:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/carljm">@carljm</a> removed by <a href="https://github.com/carljm">@carljm</a> on 2025-12-04 00:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/carljm">@carljm</a> on 2025-12-04 00:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-12-04 05:49</div>
            <div class="timeline-body"><blockquote>
<p>While this PR fixes the duplicate diagnostics, there&#x27;s still the question why vim sends <code>didChangeWatchedFiles</code> for
a file that&#x27;s currently open in the editor.</p>
</blockquote>
<p>Yeah, I&#x27;m not sure either. I looked at the request payload:</p>
<pre><code>{
  jsonrpc = &#x27;2.0&#x27;,
  method = &#x27;workspace/didChangeWatchedFiles&#x27;,
  params = {
    changes = {
      { type = 3, uri = &#x27;file:///Users/dhruv/dotfiles/4913&#x27; },
      { type = 1, uri = &#x27;file:///Users/dhruv/dotfiles/t.py&#x27; },
      { type = 3, uri = &#x27;file:///Users/dhruv/dotfiles/t.py~&#x27; },
    },
  },
}
</code></pre>
<p>It seems to be sending an entry stating that the <code>t.py</code> file was created which seems weird because the file is already open in the editor and it already exists on the filesystem.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-12-04 05:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-04 07:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-04 07:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-04 07:12</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:21:20 UTC
    </footer>
</body>
</html>
