```yaml
number: 21517
title: "[`flake8-implicit-str-concat`] Avoid invalid fix generated by autofix (`ISC003`)"
type: pull_request
state: merged
author: prakhar1144
labels:
  - bug
  - fixes
assignees: []
merged: true
base: main
head: fix-19757
created_at: 2025-11-18T21:57:27Z
updated_at: 2025-11-22T01:22:36Z
url: https://github.com/astral-sh/ruff/pull/21517
synced_at: 2026-01-10T16:48:02Z
```

# [`flake8-implicit-str-concat`] Avoid invalid fix generated by autofix (`ISC003`)

---

_Pull request opened by @prakhar1144 on 2025-11-18 21:57_

## Summary

As reported in #19757:
While attempting ISC003 autofix for an expression with explicit string concatenation, with either operand being a string literal that wraps across multiple lines (in parentheses) - it resulted in generating a fix which caused runtime error.

Example:
```
_ = "abc" + (
    "def"
    "ghi"
)
```
was being auto-fixed to:
```
_ = "abc" (
    "def"
    "ghi"
)
```
which raised `TypeError: 'str' object is not callable`

This commit makes changes to just report diagnostic - no autofix in such cases.

Fixes #19757.

## Test Plan
Added example scenarios in `crates/ruff_linter/resources/test/fixtures/flake8_implicit_str_concat/ISC.py`.



---

_Comment by @prakhar1144 on 2025-11-18 21:59_

As per suggestion in https://github.com/astral-sh/ruff/pull/19778#discussion_r2257641741:
> I think we can probably just use this helper function to check if left and right are parenthesized and avoid the fix if either of them is

> We can also still report a diagnostic in this case, we just can't autofix it. Another option would be to try to move one of the expressions into the existing parentheses from the other expression, but that might be too involved. I'd be happy with just offering a diagnostic but no fix if one of them is parenthesized to avoid causing the runtime error.



---

_Comment by @astral-sh-bot[bot] on 2025-11-18 22:08_


<!-- generated-comment ecosystem -->


## `ruff-ecosystem` results

### Linter (stable)
✅ ecosystem check detected no linter changes.

### Linter (preview)
✅ ecosystem check detected no linter changes.





---

_Marked ready for review by @prakhar1144 on 2025-11-18 22:08_

---

_Review comment by @amyreese on `crates/ruff_linter/src/rules/flake8_implicit_str_concat/rules/explicit.rs`:100 on 2025-11-19 01:36_

Let's also make it clear that the existing autofix would result in broken code, and maybe include a link to the issue.

---

_Review comment by @amyreese on `crates/ruff_linter/src/rules/flake8_implicit_str_concat/rules/explicit.rs`:98 on 2025-11-19 01:41_

I think it's preferred to have this as a separate function that takes appropriate arguments rather than a block.

I think it would also be better to have a function that takes both left and right sides at the same time, and then the code below could be something like:

```rust
if !is_either_side_parenthesized(left, right, ...) {
    diagnostic.set_fix(...);
}
```

---

_@amyreese requested changes on 2025-11-19 01:42_

---

_Label `bug` added by @amyreese on 2025-11-19 01:42_

---

_Label `fixes` added by @amyreese on 2025-11-19 01:42_

---

_Converted to draft by @prakhar1144 on 2025-11-19 15:31_

---

_@prakhar1144 reviewed on 2025-11-19 15:32_

---

_Review comment by @prakhar1144 on `crates/ruff_linter/src/rules/flake8_implicit_str_concat/rules/explicit.rs`:100 on 2025-11-19 15:32_

Extended the comment:

```diff
diff --git a/crates/ruff_linter/src/rules/flake8_implicit_str_concat/rules/explicit.rs b/crates/ruff_linter/src/rules/flake8_implicit_str_concat/rules/explicit.rs
index 58f3db33bd..8edb7b46ad 100644
--- a/crates/ruff_linter/src/rules/flake8_implicit_str_concat/rules/explicit.rs
+++ b/crates/ruff_linter/src/rules/flake8_implicit_str_concat/rules/explicit.rs
@@ -98,6 +98,8 @@ pub(crate) fn explicit(checker: &Checker, expr: &Expr) {
                 };
                 // If either `left` or `right` is parenthesized, generating
                 // a fix would be too involved. Just report the diagnostic.
+                // Currently, attempting `generate_fix` would result in
+                // an invalid code. See: #19757
                 if is_parenthesized(left) || is_parenthesized(right) {
                     return;
                 }
```

---

_@prakhar1144 reviewed on 2025-11-19 15:44_

---

_Review comment by @prakhar1144 on `crates/ruff_linter/src/rules/flake8_implicit_str_concat/rules/explicit.rs`:98 on 2025-11-19 15:44_

> I think it would also be better to have a function that takes both left and right sides at the same time

That'd result in the new function body being:
```rs
  is_left_parenthesized = parenthesized_range(
      left.into(),
      bin_op.into(),
      checker.comment_ranges(),
      checker.source(),
  )
  .is_some();
  
   is_right_parenthesized = parenthesized_range(
      right.into(),
      bin_op.into(),
      checker.comment_ranges(),
      checker.source(),
  )
  .is_some();
  
  is_left_parenthesized || is_right_parenthesized
 ```
 
 which is a bit verbose... with repeated code ?
 
 I had thought about a separate function while writing this, but preferred this approach because:
 * It's only called twice in adjacent lines, localized scope, so closure felt natural
 * it doesn't have complex logic worth unit testing

---

_Marked ready for review by @prakhar1144 on 2025-11-19 16:03_

---

_Review requested from @amyreese by @prakhar1144 on 2025-11-19 16:03_

---

_Comment by @prakhar1144 on 2025-11-19 16:03_

This is ready to review.

---

_@amyreese approved on 2025-11-22 01:21_

---

_Renamed from "[flake8-implicit-str-concat] Avoid invalid fix generated by autofix (ISC003)" to "[`flake8-implicit-str-concat`] Avoid invalid fix generated by autofix (`ISC003`)" by @amyreese on 2025-11-22 01:22_

---

_Merged by @amyreese on 2025-11-22 01:22_

---

_Closed by @amyreese on 2025-11-22 01:22_

---
