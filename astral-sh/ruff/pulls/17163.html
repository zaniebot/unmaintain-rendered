<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Fix `str(â€¦)` calls - astral-sh/ruff #17163</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Fix <code>str(â€¦)</code> calls</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17163">#17163</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-04-03 07:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body">Summary
<p>The existing signature for <code>str</code> calls had various problems, one of which I noticed while looking at some ecosystem projects (<code>scrapy</code>, added as a project to mypy_primer in this PR).</p>
Test Plan
<ul>
<li>New tests for <code>str(â€¦)</code> calls.</li>
<li>Observed reduction of false positives in ecosystem checks</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-03 07:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-03 07:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-03 07:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-03 07:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-03 07:54</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>scrapy (https://github.com/scrapy/scrapy)
- error[lint:no-matching-overload] /tmp/mypy_primer/projects/scrapy/tests/test_http2_client_protocol.py:104:41: No overload of class `str` matches arguments
- error[lint:no-matching-overload] /tmp/mypy_primer/projects/scrapy/tests/test_http2_client_protocol.py:104:60: No overload of class `str` matches arguments
- error[lint:no-matching-overload] /tmp/mypy_primer/projects/scrapy/tests/test_http2_client_protocol.py:159:26: No overload of class `str` matches arguments
- error[lint:no-matching-overload] /tmp/mypy_primer/projects/scrapy/tests/test_http2_client_protocol.py:159:45: No overload of class `str` matches arguments
- error[lint:no-matching-overload] /tmp/mypy_primer/projects/scrapy/tests/test_http2_client_protocol.py:172:21: No overload of class `str` matches arguments
- error[lint:no-matching-overload] /tmp/mypy_primer/projects/scrapy/tests/test_http2_client_protocol.py:172:40: No overload of class `str` matches arguments
- error[lint:no-matching-overload] /tmp/mypy_primer/projects/scrapy/tests/test_http2_client_protocol.py:340:31: No overload of class `str` matches arguments
- error[lint:no-matching-overload] /tmp/mypy_primer/projects/scrapy/tests/test_http2_client_protocol.py:354:25: No overload of class `str` matches arguments
- error[lint:no-matching-overload] /tmp/mypy_primer/projects/scrapy/tests/test_http2_client_protocol.py:356:50: No overload of class `str` matches arguments
- error[lint:no-matching-overload] /tmp/mypy_primer/projects/scrapy/tests/test_http2_client_protocol.py:576:31: No overload of class `str` matches arguments
- error[lint:no-matching-overload] /tmp/mypy_primer/projects/scrapy/tests/test_http2_client_protocol.py:691:43: No overload of class `str` matches arguments
- error[lint:no-matching-overload] /tmp/mypy_primer/projects/scrapy/tests/test_http2_client_protocol.py:694:24: No overload of class `str` matches arguments
- error[lint:no-matching-overload] /tmp/mypy_primer/projects/scrapy/tests/test_http2_client_protocol.py:694:24: No overload of class `str` matches arguments
- error[lint:no-matching-overload] /tmp/mypy_primer/projects/scrapy/tests/test_http2_client_protocol.py:694:24: No overload of class `str` matches arguments
- error[lint:no-matching-overload] /tmp/mypy_primer/projects/scrapy/tests/test_http2_client_protocol.py:694:41: No overload of class `str` matches arguments
- error[lint:no-matching-overload] /tmp/mypy_primer/projects/scrapy/tests/test_http2_client_protocol.py:694:41: No overload of class `str` matches arguments
- error[lint:no-matching-overload] /tmp/mypy_primer/projects/scrapy/tests/test_http2_client_protocol.py:694:41: No overload of class `str` matches arguments
- error[lint:no-matching-overload] /tmp/mypy_primer/projects/scrapy/scrapy/core/http2/stream.py:193:27: No overload of class `str` matches arguments
- error[lint:no-matching-overload] /tmp/mypy_primer/projects/scrapy/scrapy/core/http2/stream.py:194:30: No overload of class `str` matches arguments
- error[lint:no-matching-overload] /tmp/mypy_primer/projects/scrapy/scrapy/core/http2/stream.py:235:25: No overload of class `str` matches arguments
- error[lint:no-matching-overload] /tmp/mypy_primer/projects/scrapy/scrapy/core/http2/stream.py:246:33: No overload of class `str` matches arguments
- error[lint:no-matching-overload] /tmp/mypy_primer/projects/scrapy/scrapy/core/http2/stream.py:467:21: No overload of class `str` matches arguments
- Found 1523 diagnostics
+ Found 1501 diagnostics

</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-03 10:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/call/builtins.md</code>:53 on 2025-04-03 10:46</div>
            <div class="timeline-body"><p>I can tell what you had for breakfast this morning!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2877 on 2025-04-03 10:52</div>
            <div class="timeline-body"><p>interesting: these overloads differ from typeshed&#x27;s overloads in that <code>str(encoding=&#x27;utf8&#x27;)</code> is permitted by these overloads, but not by typeshed&#x27;s. It&#x27;s hard to say whether it should or shouldn&#x27;t be permitted, really: it works at runtime, but arguably the type checker would be doing the user a favour by telling the user off for doing it, since there&#x27;s no reason why it would ever be useful (it&#x27;s almost certainly indicative of a user error)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-04-03 10:52</div>
            <div class="timeline-body"><p>thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-03 11:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2877 on 2025-04-03 11:18</div>
            <div class="timeline-body"><p>Oh, right. I didn&#x27;t realize that <code>object</code> is required in the second overload in typeshed. Should we just ignore the discrepancy? Change it in Red Knot? Change it in typeshed?</p>
<p>I agree that it&#x27;s useless to do <code>str(encoding=&#x27;utf-8&#x27;)</code>, but it is valid at runtime, clearly specified as such in the <a href="https://docs.python.org/3/library/stdtypes.html#str">documentation</a>, and seemingly harmless. I also doubt that we would catch actual errors by disallowing it. So I&#x27;m inclined to say that it should be changed in typeshed?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-03 11:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2877 on 2025-04-03 11:23</div>
            <div class="timeline-body"><p>hmm, that&#x27;s a fair point about the documentation. I still weakly prefer the typeshed stubs as they are: I just can&#x27;t think of any reason why a user would want to write <code>str(encoding=&#x27;utf8&#x27;)</code> when they could just as well write <code>str()</code> or <code>&quot;&quot;</code>. I think the only reason why it would ever appear in a codebase would be as a result of a typo or a bad codemod, so I&#x27;d prefer for type checkers to complain about it.</p>
<p>I really don&#x27;t have a strong opinion, though! If you feel like sending a PR to typeshed, feel free -- the other typeshed maintainers might feel differently ðŸ˜„</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-03 11:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2877 on 2025-04-03 11:26</div>
            <div class="timeline-body"><p>I don&#x27;t feel strongly about it, and not really familiar with typeshed&#x27;s policies when it comes to questions like this, so I guess it&#x27;s fine to just leave it as a discrepancy.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-03 11:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-03 11:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-03 11:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-04-03 17:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2877 on 2025-04-03 17:42</div>
            <div class="timeline-body"><p>I think typeshed should be changed: this is a classic case of &quot;what should a type checker report&quot; vs &quot;what should a linter report&quot;. Perfectly reasonable to write a lint rule saying &quot;this call is silly&quot;, but IMO not reasonable for a type checker to claim the call is a type error, when it clearly is not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-04-03 17:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2877 on 2025-04-03 17:43</div>
            <div class="timeline-body"><p>(But &quot;thinking typeshed should be changed&quot; is as far as I will take this, I don&#x27;t care enough to submit a PR and follow through on debating it ðŸ˜† )</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-03 17:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:2877 on 2025-04-03 17:44</div>
            <div class="timeline-body"><blockquote>
<p>Perfectly reasonable to write a lint rule saying &quot;this call is silly&quot;, but IMO not reasonable for a type checker to claim the call is a type error, when it clearly is not.</p>
</blockquote>
<p>hmm, sounds like there could be a gap in the market for a type-aware linter here ðŸ¤”</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:12:53 UTC
    </footer>
</body>
</html>
