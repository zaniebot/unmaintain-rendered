<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ruff_python_formatter: support reformatting Markdown code blocks - astral-sh/ruff #9030</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>ruff_python_formatter: support reformatting Markdown code blocks</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/9030">#9030</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2023-12-06 22:32
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>(This is not possible to actually use until https://github.com/astral-sh/ruff/pull/8854 is merged.)</p>
<p>This commit slots in support for formatting Markdown fenced code blocks<a href="https://spec.commonmark.org/0.30/#fenced-code-blocks">1</a>. With the refactoring done for reStructuredText previously, this ended up being pretty easy to add. Markdown code blocks are also quite a bit easier to parse and recognize correctly.</p>
<p>One point of contention in #8860 is whether to assume that unlabeled Markdown code fences are Python or not by default. In this PR, we make such an assumption. This follows what <code>rustdoc</code> does. The mitigation here is that if an unlabeled code block isn't Python, then it probably won't parse as Python. And we'll end up skipping it. So in the vast majority of cases, the worst thing that can happen is a little bit of wasted work.</p>
<p>Closes #8860</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">docstring</span> added by @BurntSushi on 2023-12-06 22:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @BurntSushi on 2023-12-06 22:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Added to milestone "Formatter: Stable" by @BurntSushi on 2023-12-06 22:32</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @BurntSushi on 2023-12-06 22:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @BurntSushi on 2023-12-06 22:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-12-06 22:47</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Formatter (stable)</h3>
<p>âœ… ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>âœ… ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/expression/string/docstring.rs</code>:1212 on 2023-12-07 01:07</div>
            <div class="timeline-body"><p>So this is, e.g., the number of backticks?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/expression/string/docstring.rs</code>:1248 on 2023-12-07 01:08</div>
            <div class="timeline-body"><p>Is there a source for this regex or was it written by hand for these purposes?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/expression/string/docstring.rs</code>:1248 on 2023-12-07 01:10</div>
            <div class="timeline-body"><p>Is there any sense in checking for the triple quotes / tildes out-of-band before running the regex, since the vast majority of lines won't contain them? Or would you expect (wink wink) regex to perform equivalently-or-better?</p>
<p>Edit: hah, nevermind, you already have this above ðŸ¤¦</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/expression/string/docstring.rs</code>:1350 on 2023-12-07 01:10</div>
            <div class="timeline-body"><p>Nit: uncloded -&gt; unclosed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/expression/string/docstring.rs</code>:1305 on 2023-12-07 01:12</div>
            <div class="timeline-body"><p>What is this case? The code is under-indented compared to the opening of the code fence? I actually don't know what Markdown does in that case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-12-07 01:12</div>
            <div class="timeline-body"><p>Looks great.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/docstring_code_examples.py</code>:1292 on 2023-12-07 02:32</div>
            <div class="timeline-body"><p>Nice test suite and I like how you documented the cases.</p>
<p>Should we add a test where the code block itself contains closing quotes at a different indentation level:</p>
<pre><code class="language-python">def test() {
	&quot;&quot;&quot;
  You can use this function to render markdown, even conditionally.

	```py
	if 5 == 4:
		a = &quot;&quot;&quot;
			It supports **code blocks** 
			```py
				print(&quot;Hello World&quot;)
			```
  	&quot;&quot;&quot;
</code></pre>
<p>A simplified version that triggered me to make this example is that</p>
<pre><code class="language-python">def test() {
	&quot;&quot;&quot;
  Code block with incorrectly placed closing fences
	
	```python
	
		 ```
	  #Â The above fences should not close the code block
		a = 10
	```

	Now the code block is closed
	&quot;&quot;&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/string/docstring.rs</code>:4 on 2023-12-07 02:33</div>
            <div class="timeline-body"><p>all of them? Is this the start of a rebellion against our pedantic rules (I consider joining :P)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/string/docstring.rs</code>:1214 on 2023-12-07 02:35</div>
            <div class="timeline-body"><p>That's a lot of supported ticks ðŸ¤£ But makes sense, using <code>u32</code> would require some annoying casts</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/string/docstring.rs</code>:1321 on 2023-12-07 02:40</div>
            <div class="timeline-body"><p>Does <code>starts_with</code> work with over intended lines</p>
<pre><code class="language-python">def test():
	&quot;&quot;&quot;
	A docstring
		over intended
		```python
		print(&quot;a&quot;)
		```
	&quot;&quot;&quot;
	
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/normalizer.rs</code>:86 on 2023-12-07 02:43</div>
            <div class="timeline-body"><p>I mean... markdown is a superset of HTML where almost anything is valid....</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-12-07 02:44</div>
            <div class="timeline-body"><p>LGTM.</p>
<p>My only fear is into how many weird edge cases we'll run where we would need a full markdown parser to parse nested structures correctly. But that's something we can figure out later.</p>
<p>I recommend releasing this soon under the formatter Beta where we have some more wiggle room to make breaking changes if any of our assumptions were wrong.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-12-07 16:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/expression/string/docstring.rs</code>:1212 on 2023-12-07 16:55</div>
            <div class="timeline-body"><p>Yup! I've tweaked the docs to make this clearer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-12-07 16:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/expression/string/docstring.rs</code>:1248 on 2023-12-07 16:57</div>
            <div class="timeline-body"><p>Written by hand. And indeed, I did add a &quot;fast path,&quot; but I actually speculate that it isn't necessary. While <code>Regex::captures</code> isn't the fastest thing in the world, what isn't fast is the path that reports a match. The path that <em>doesn't</em> report a match should be quite fast. It only has to use a slower engine to resolve capture groups if a match is detected.</p>
<p>But, the fast path here is very simple.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-12-07 17:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/expression/string/docstring.rs</code>:1305 on 2023-12-07 17:06</div>
            <div class="timeline-body"><p>Yeah it's a weird case. I believe it is technically valid Markdown. But when I allowed it, it led to an idempotency bug that seemed a little tricky to fix. Basically, it seemed like a bug that was probably okay to ship with, and we can prioritize fixing it based on user feedback.</p>
<p>Good call out though. I added this comment:</p>
<pre><code class="language-rust">        // When a line in a Markdown fenced closed block is indented *less*
        // than the opening indent, we treat the entire block as invalid.
        //
        // I believe that code blocks of this form are actually valid Markdown
        // in some cases, but the interplay between it and our docstring
        // whitespace normalization leads to undesirable outcomes. For example,
        // if the line here is unindented out beyond the initial indent of the
        // docstring itself, then this causes the entire docstring to have
        // its indent normalized. And, at the time of writing, a subsequent
        // formatting run undoes this indentation, thus violating idempotency.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-12-07 19:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/docstring_code_examples.py</code>:1292 on 2023-12-07 19:01</div>
            <div class="timeline-body"><p>So in the first case, the <code>&quot;&quot;&quot;</code> ends the docstring and makes the entire thing invalid Python. I tried playing with it a bit to massage it into a more &quot;useful&quot; test, but couldn't get to anything I liked.</p>
<p>In the second case, we do actually allow the first set of closing fences to close the block. Markdown technically allows up to three spaces of indentation before the start of the fences, but I think that's a little tricky to enforce in this context given that we're in a docstring. So I ended up just deciding that Markdown fences could be indented as much as possible. This isn't as much of an issue here, since we specifically do not support (at least, not yet anyway) the sort of Markdown code block that is inserted purely by indentation and not fences. I added this as a test case though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-12-07 19:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/expression/string/docstring.rs</code>:4 on 2023-12-07 19:04</div>
            <div class="timeline-body"><p>Oh my heavens no, haha. No rebellion here. I sometimes add this to the top of a file when adding a new chunk of code. I just forgot to remove it.</p>
<p>I do find some of our Clippy lints a touch pedantic, but no strong feelings. Yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-12-07 19:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/expression/string/docstring.rs</code>:1214 on 2023-12-07 19:06</div>
            <div class="timeline-body"><p>Yeah I did consider this when I wrote down the data type, but didn't see a good reason to artificially restrict it. That is, I don't any issues arising from a lot of ticks that we would be unique from the more general issue of a supremely long line.</p>
<p>But if we wanted to restrict this, probably <code>u8</code> would be good enough. 255 ticks ought to be enough for anyone, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-12-07 19:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/src/expression/string/docstring.rs</code>:1321 on 2023-12-07 19:07</div>
            <div class="timeline-body"><p>Yeah that works, because we strip all leading whitespace.</p>
<p>Test case added. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2023-12-07 19:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_python_formatter/tests/normalizer.rs</code>:86 on 2023-12-07 19:07</div>
            <div class="timeline-body"><p>Yeah I just mean valid fence blocks, not all of Markdown. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-12-07 19:09</div>
            <div class="timeline-body"><blockquote>
<p>My only fear is into how many weird edge cases we'll run where we would need a full markdown parser to parse nested structures correctly. But that's something we can figure out later.</p>
</blockquote>
<p>Yeah right, this PR only covers naked code fence blocks. It won't work with fenced code blocks inside of quote blocks for example. I do indeed feel like that's something we can add later if there's demand for it. And yeah, that may wind up requiring a full Markdown parser (<code>pulldown-cmark</code> perhaps).</p>
<blockquote>
<p>I recommend releasing this soon under the formatter Beta where we have some more wiggle room to make breaking changes if any of our assumptions were wrong.</p>
</blockquote>
<p>Yeah the plan is to get this out soon. Basically want to get this merged, get #8855 fixed up and then write a blog post. :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-12-07 19:30</div>
            <div class="timeline-body"><p>Going to bring this in. As usual, if y'all have any more feedback, I'd be happy to address it in follow-up PRs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2023-12-07 19:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2023-12-07 19:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-12-07 19:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-12-07 20:23</div>
            <div class="timeline-body"><p>Is it supported to have additional text after the language marker? For example: https://github.com/pypa/hatch/blob/52a81d80cd03bfb90d99a5837c778971ea0c8c22/src/hatch/env/plugin/interface.py#L23-L41</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-12-07 21:57</div>
            <div class="timeline-body"><p>Ah yeah good catch. I did indeed specifically add support for that, but neglected to add a test. I added one in https://github.com/astral-sh/ruff/pull/9050.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:01:44 UTC
    </footer>
</body>
</html>
