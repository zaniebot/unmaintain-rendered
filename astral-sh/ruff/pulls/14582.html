<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[airflow] Avoid deprecated values (AIR302) - astral-sh/ruff #14582</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[airflow] Avoid deprecated values (AIR302)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14582">#14582</a>
        opened by <a href="https://github.com/uranusjr">@uranusjr</a>
        on 2024-11-25 07:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/uranusjr">@uranusjr</a></div>
            <div class="timeline-body">Summary
<p>Airflow 3.0 removes various deprecated functions, members, modules, and other values. They have been deprecated in 2.x, but the removal causes incompatibilities that we want to detect.</p>
<p>(We are deprecating a lot more things. I want to use this to establish a basic structure so future checks can be submitted more easily.)</p>
<p>Ref: #14626</p>
Test Plan
<p>A test fixture is included in the PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-25 09:03</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+1 -1 violations, +0 -0 fixes in 1 projects; 54 projects unchanged)</p>
<a href="https://github.com/apache/airflow">apache/airflow</a> (+1 -1 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
- <a href="https://github.com/apache/airflow/blob/1e0a499d1357a2025e71a38038fb61490969a9df/performance/src/performance_dags/performance_dag/performance_dag.py#L230">performance/src/performance_dags/performance_dag/performance_dag.py:230:11:</a> AIR301 DAG should have an explicit `schedule` argument
+ <a href="https://github.com/apache/airflow/blob/1e0a499d1357a2025e71a38038fb61490969a9df/performance/src/performance_dags/performance_dag/performance_dag.py#L244">performance/src/performance_dags/performance_dag/performance_dag.py:244:9:</a> AIR302 `schedule_interval` is removed in Airflow 3.0; use schedule instead
</pre>

</p>

Changes by rule (2 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| AIR302 | 1 | 1 | 0 | 0 | 0 |
| AIR301 | 1 | 0 | 1 | 0 | 0 |</p>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-25 09:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-25 09:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/codes.rs</code>:1034 on 2024-11-25 09:50</div>
            <div class="timeline-body"><p>Can you tell me a bit about your intended rule numbering? It seems you&#x27;ve something in mind because you chose 302 over e.g 301.</p>
<p>Somewhat related. The numpy rule is called <code>Numpy2Deprecation</code>. Should we align this rule&#x27;s name to <code>Airflow3Deprecation</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/airflow/rules/deprecated_members.rs</code>:68 on 2024-11-25 09:51</div>
            <div class="timeline-body"><p>We could consider adding a <code>Modules::Airflow</code> to avoid semantic name lookups for users not using airflow. See https://github.com/astral-sh/ruff/blob/928ffd66503759679823c5f346941ef58486766e/crates/ruff_linter/src/rules/numpy/rules/numpy_2_0_deprecation.rs#L162-L164</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-11-25 09:52</div>
            <div class="timeline-body"><p>This is great. Thank you. I&#x27;ve two small questions/suggestions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/uranusjr">@uranusjr</a> reviewed on 2024-11-25 11:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/uranusjr">@uranusjr</a> on <code>crates/ruff_linter/src/codes.rs</code>:1034 on 2024-11-25 11:41</div>
            <div class="timeline-body"><p>Well simply because I implemented #14581 (which used AIR301) before this. We don’t really have a rule on these; I can switch them around if it is nicer.</p>
<p>(Now that I think of it, should we start with 300 instead…?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sbrugman">@sbrugman</a> reviewed on 2024-11-25 11:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sbrugman">@sbrugman</a> on <code>crates/ruff_linter/src/rules/airflow/rules/deprecated_members.rs</code>:42 on 2024-11-25 11:45</div>
            <div class="timeline-body"><p>Is there some documentation available already, such as a migration guide? We could also link the changelog or deprecation PRs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-25 11:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/codes.rs</code>:1034 on 2024-11-25 11:58</div>
            <div class="timeline-body"><blockquote>
<p>these; I can switch them around if it is nicer.</p>
</blockquote>
<p>Ah no, it&#x27;s fine. Either way works for us.</p>
<blockquote>
<p>(Now that I think of it, should we start with 300 instead…?)</p>
</blockquote>
<p>We haven&#x27;t been very consistent about whether we start with 0 or 1 across linters, but I think we&#x27;ve been mostly consistent for a single inter. That&#x27;s why I would prefer starting with 301, considering that there&#x27;s already 001.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/uranusjr">@uranusjr</a> reviewed on 2024-11-26 08:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/uranusjr">@uranusjr</a> on <code>crates/ruff_linter/src/rules/airflow/rules/deprecated_members.rs</code>:42 on 2024-11-26 08:34</div>
            <div class="timeline-body"><p>Unfortunately there’s not. We may create it later, but would it also make sense to use this as the documentation? I can make the description here a bit longer, and the guide can link back to these rules instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-26 08:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/airflow/rules/deprecated_members.rs</code>:42 on 2024-11-26 08:39</div>
            <div class="timeline-body"><p>It probably &quot;depends,&quot; but I have a slight preference toward having this documentation outside of Ruff, at least if it should also cover <em>why</em> something has been deprecated and provide guidance with what it should be replaced instead. Otherwise, the &quot;burden&quot; for maintaining the list falls on us and I don&#x27;t see us having the authority or knowledge to maintain the list.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/uranusjr">@uranusjr</a> reviewed on 2024-11-26 10:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/uranusjr">@uranusjr</a> on <code>crates/ruff_linter/src/rules/airflow/rules/deprecated_members.rs</code>:42 on 2024-11-26 10:09</div>
            <div class="timeline-body"><p>Got it, that makes sense. We will create a separate migration guide then. This will be done later and we’ll add the link here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/uranusjr">@uranusjr</a> reviewed on 2024-11-26 10:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/uranusjr">@uranusjr</a> on <code>crates/ruff_linter/src/rules/airflow/rules/deprecated_members.rs</code>:68 on 2024-11-26 10:27</div>
            <div class="timeline-body"><p>Module declared in #14581 instead. I’ll wait for that to be merged first and rebase this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-26 12:39</div>
            <div class="timeline-body"><p>Feel free to ping me when you rebased the PR and I&#x27;ll merge it. This is great work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/uranusjr">@uranusjr</a> on 2024-11-27 10:17</div>
            <div class="timeline-body"><p>Alright, I’ve added argument deprecation to AIR302. I also added some structure in the module since we’re probably going to add other kinds of deprecation (like <code>foo[&quot;deprecated&quot;]</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-11-27 10:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_linter/src/rules/airflow/rules/removal_in_3.rs</code>:67 on 2024-11-27 10:39</div>
            <div class="timeline-body"><p>I think this is the same as the existing <code>AIR301</code>, right? If so, we should remove the <code>AIR301</code> implementation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/uranusjr">@uranusjr</a> reviewed on 2024-11-28 06:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/uranusjr">@uranusjr</a> on <code>crates/ruff_linter/src/rules/airflow/rules/removal_in_3.rs</code>:67 on 2024-11-28 06:30</div>
            <div class="timeline-body"><p>The point of <code>AIR301</code> is to detect DAGs without a schedule argument, like this</p>
<pre><code>DAG(dag_id=&quot;foo&quot;)
</code></pre>
<p>while the rule here is to detect a DAG using a deprecated schedule argument like</p>
<pre><code>DAG(dag_id=&quot;foo&quot;, schedule_interval=&quot;@daily&quot;)
</code></pre>
<p>We shouldn’t remove AIR301 because AIR302 does not catch the error in the first DAG. I think we should also detect <code>schedule_interval</code> and <code>timetable</code> in AIR301, so the second DAG only emits AIR302 instead of both errors.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/uranusjr">@uranusjr</a> on 2024-11-28 13:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/uranusjr">@uranusjr</a> reviewed on 2024-11-28 13:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/uranusjr">@uranusjr</a> on <code>crates/ruff_linter/src/rules/airflow/rules/removal_in_3.rs</code>:67 on 2024-11-28 13:28</div>
            <div class="timeline-body"><p>Done in the latest commit</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-29 16:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/airflow/rules/removal_in_3.rs</code>:67 on 2024-11-29 16:58</div>
            <div class="timeline-body"><p>Returning a <code>vec</code> of possible deprecations here is suboptimal for performance because it means that Ruff allocates at least two vectors for every <code>airflow</code> call expression.</p>
<p>I think we could do better by changing the API slightly</p>
<pre><code>fn deprecated_keyword_argument(arguments: &amp;Arguments, argument: &amp;str, replacement: Option&lt;&amp;str&gt;) -&gt; Option&lt;Diagnostic&gt; {
	let keyword = arguments.find_keyword(argument)?;
	
	Some(Diagnostic::new(
        Airflow3Removal {
            deprecated: argument.to_string(),
            replacement: match replacement {
                Some(name) =&gt; Replacement::Name(name.to_owned()),
                None =&gt; Replacement::None,
            },
        },
        keyword
            .arg
            .as_ref()
            .map_or_else(|| keyword.range(), Ranged::range),
    ));
}
</code></pre>
<p>and you can then use it like this</p>
<pre><code>    let deprecations = match qualname.segments() {
        [&quot;airflow&quot;, .., &quot;DAG&quot; | &quot;dag&quot;] =&gt; {
					checker.diagnostics.extend(removed_argument(arguments, &quot;timetable&quot;, Some(&quot;schedule&quot;)));
					checker.diagnostics.extend(removed_argument(arguments, &quot;schedule_interval&quot;, Some(&quot;schedule&quot;)));
		}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/uranusjr">@uranusjr</a> reviewed on 2024-12-01 15:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/uranusjr">@uranusjr</a> on <code>crates/ruff_linter/src/rules/airflow/rules/removal_in_3.rs</code>:67 on 2024-12-01 15:45</div>
            <div class="timeline-body"><p>Sounds good to me. I was struggling to find a way to do this more efficiently.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/uranusjr">@uranusjr</a> reviewed on 2024-12-02 06:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/uranusjr">@uranusjr</a> on <code>crates/ruff_linter/src/rules/airflow/rules/removal_in_3.rs</code>:67 on 2024-12-02 06:37</div>
            <div class="timeline-body"><p>Alright this is pretty nice! Need to suppress Clippy since we do want to add more cases here in the future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-02 07:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-02 07:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-12-02 09:14</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:08:49 UTC
    </footer>
</body>
</html>
