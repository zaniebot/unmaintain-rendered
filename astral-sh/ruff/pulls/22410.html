<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check required-version before parsing rules - astral-sh/ruff #22410</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Check required-version before parsing rules</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22410">#22410</a>
        opened by <a href="https://github.com/jelle-openai">@jelle-openai</a>
        on 2026-01-06 00:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jelle-openai">@jelle-openai</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes #19922.</p>
<p>The approach I used is to check the required-version separately before parsing the TOML. This feels a bit ugly because we have to parse the TOML separately, but other approaches I considered seemed worse:</p>
<ul>
<li>Put the version validation inside SerDe deserialization for RequiredVersion. But this feels wrong: a required version that doesn't match the current version should still parse. Also, I think this means the user might see more errors than just the one for the version mismatch, when ideally they should only see the version mismatch error.</li>
<li>Rewrite Options to be much more lenient in parsing everything else (in particular, don't validate rule names). However, this would be a bigger rewrite, and might still cause issues similar to #19922 if e.g. a new field is added.</li>
</ul>
<h2>Test Plan</h2>
<p>New test cases added.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2026-01-06 09:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:48 on 2026-01-06 09:43</div>
            <div class="timeline-body"><p>I think we can avoid the double parsing by doing something like this:</p>
<pre><code class="language-rust">    let value: toml::Value =
        toml::from_str(&amp;contents).with_context(|| format!(&quot;Failed to parse {}&quot;, path.display()))?;

    check_required_version(&amp;value, path, &amp;[&quot;tool&quot;, &quot;ruff&quot;])?;

    value
        .try_into()
        .with_context(|| format!(&quot;Failed to parse {}&quot;, path.display()))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by @MichaReiser on 2026-01-06 09:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-06 09:46</div>
            <div class="timeline-body"><p>Nice</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-06 09:49</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-06 09:51</div>
            <div class="timeline-body"><p>Hmm, the ecosystem changes are a bit surprising. Can you try rebasing on main?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jelle-openai">@jelle-openai</a> on 2026-01-06 16:58</div>
            <div class="timeline-body"><p>Hm do those changes mean it found more autofixes? That would be weird.</p>
<p>I'll apply your suggested change and merge in with latest main.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jelle-openai">@jelle-openai</a> reviewed on 2026-01-06 18:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jelle-openai">@jelle-openai</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:48 on 2026-01-06 18:37</div>
            <div class="timeline-body"><p>That version caused a regression where we no longer showed exact error locations for errors in the TOML. Codex came up with an approach that avoids the double parse while preserving exact error locations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:138 on 2026-01-07 08:28</div>
            <div class="timeline-body"><p>What's the reason that we need to check for <code>required_version</code> in addition to <code>required-version</code>? Can we add a test demonstrating this behavior (assuming it is needed?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:62 on 2026-01-07 08:28</div>
            <div class="timeline-body"><p>Nice find!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:149 on 2026-01-07 08:29</div>
            <div class="timeline-body"><p>I suspect that we lose the span in the error message compared to when deserializing the value as part of the serde deserialization. I'm inclined to return <code>Ok</code> here and defer to the &quot;full&quot; deserialization in that case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2026-01-07 08:36</div>
            <div class="timeline-body"><p>Thanks. This is great and nice find with <code>DeTable</code>.</p>
<p>I only have a question whether we need the <code>required_version</code> fallback and if we retain the spans in error messages if the required version fails to parse.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jelle-openai">@jelle-openai</a> reviewed on 2026-01-07 16:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jelle-openai">@jelle-openai</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:62 on 2026-01-07 16:32</div>
            <div class="timeline-body"><p>Codex found it :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jelle-openai">@jelle-openai</a> reviewed on 2026-01-07 16:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jelle-openai">@jelle-openai</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:138 on 2026-01-07 16:34</div>
            <div class="timeline-body"><p>Yeah this was the AI's code and I should have validated it's needed. It looks like Ruff only supports the dash version, so we shouldn't look at the underscored one.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jelle-openai">@jelle-openai</a> reviewed on 2026-01-07 16:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jelle-openai">@jelle-openai</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:149 on 2026-01-07 16:34</div>
            <div class="timeline-body"><p>I'll add a test for this case too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jelle-openai">@jelle-openai</a> reviewed on 2026-01-07 16:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jelle-openai">@jelle-openai</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:149 on 2026-01-07 16:54</div>
            <div class="timeline-body"><p>You were right, changed it as you suggested.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/jelle-openai">@jelle-openai</a> reviewed on 2026-01-07 16:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/jelle-openai">@jelle-openai</a> on <code>crates/ruff_workspace/src/pyproject.rs</code>:138 on 2026-01-07 16:56</div>
            <div class="timeline-body"><p>Removed the underscore fallback</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2026-01-07 17:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2026-01-07 17:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2026-01-07 17:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2026-01-07 17:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/jelle-openai">@jelle-openai</a> on 2026-01-07 17:51</div>
            <div class="timeline-body"><p>Thanks for the review and merge @MichaReiser!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:18:46 UTC
    </footer>
</body>
</html>
