<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Replace `String` with `SmolStr` for nodes `Identifier` and `ExprName` - astral-sh/ruff #9202</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Replace <code>String</code> with <code>SmolStr</code> for nodes <code>Identifier</code> and <code>ExprName</code></h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/9202">#9202</a>
        opened by <a href="https://github.com/LaBatata101">@LaBatata101</a>
        on 2023-12-19 21:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/LaBatata101">@LaBatata101</a> on 2023-12-19 21:11</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Changes the type of the <code>id</code> field in the <code>Identifier</code> and <code>ExprName</code> nodes from <code>String</code> to <code>SmolStr</code>.  This is a required change for the new parser.</p>
<p>This PR is part of #9152</p>
<h2>Test Plan</h2>
<p><code>cargo test --lib</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @charliermarsh on 2023-12-19 21:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @charliermarsh on 2023-12-19 21:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-12-19 21:43</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>âœ… ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>âœ… ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pyflakes/rules/strings.rs</code>:750 on 2023-12-19 23:07</div>
            <div class="timeline-body"><p>This is unrelated to your change and doesn't need to be fixed as part of this PR: @charliermarsh should we use <code>HashSet</code>s instead of <code>Vec</code> for these sets (convert from <code>Vec</code> to <code>Set</code> when converting from <code>Options</code> to <code>Settings</code>)? Or is the reason we don't do this because we only use <code>Options</code> for plugin specific configurations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pylint/rules/no_method_decorator.rs</code>:134 on 2023-12-19 23:18</div>
            <div class="timeline-body"><p>GitHub doesn't allow me to make a suggestion on the entire code. We can avoid calling <code>to_string</code> here by changing <code>explicit_decorator_calls</code> to <code>HashMap&lt;&amp;str, TextRange&gt;</code>.</p>
<p>The <code>id.to_string</code> call on linne 128 also seems unnecessary (we can use the <code>SmolStr</code> directly or use <code>as_str</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1743 on 2023-12-19 23:35</div>
            <div class="timeline-body"><p>How did you decide where to use <code>SmolStr</code>? Should <code>ExprIpyEscapeCommand</code>, <code>StringLiteral</code>, and <code>FStringElement</code> use <code>SmolStr</code> too or is it intentional that they do not because they're less likely to be short?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-12-19 23:39</div>
            <div class="timeline-body"><p>Thank you.</p>
<p>The code changes look good to me. The two main questions that I have are:</p>
<ul>
<li>How did you decide on <code>smol_str</code> over any of the other small string crates? For example, <a href="https://crates.io/crates/compact_str"><code>compact_str</code></a> supports up to 24 bytes and 12 bytes on 32-bit architectures. But I'm unfamiliar with all the crates, so there might be other considerations. The intention isn't that you change the small string crate, but that we document how we made the decision in case we want to re-visit it in the future.</li>
<li>How did you decide on where to use <code>SmolStr</code>? E.g. you use it for Names and Identifiers but not for String literals.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-12-19 23:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-12-20 00:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/pyflakes/rules/strings.rs</code>:750 on 2023-12-20 00:21</div>
            <div class="timeline-body"><p>@MichaReiser -- We could change to <code>Set</code>, I don't think there's a specific reason for it. But one problem is that if we <em>do</em> use<code>HashSet&lt;String&gt;</code>, then we would need to allocate here to convert from <code>SmolStr</code> to <code>String</code> for the <code>contains</code> check, right?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-12-20 01:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pyflakes/rules/strings.rs</code>:750 on 2023-12-20 01:02</div>
            <div class="timeline-body"><p>Hmm yeah that might be, because <code>contains</code> takes <code>&amp;T</code> and not <code>Deref&lt;T&gt;</code>. Except if we use <code>SmolStr</code> everywhere...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-12-20 01:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/pyflakes/rules/strings.rs</code>:750 on 2023-12-20 01:12</div>
            <div class="timeline-body"><p>That is true... I can try it separately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-12-20 04:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pyflakes/rules/strings.rs</code>:750 on 2023-12-20 04:01</div>
            <div class="timeline-body"><p>I should not have brought this up. It's probably not worth it, considering that these vectors only contain very few items and hashing might be more expensive than just comparing the length of every string first.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-12-20 04:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/pyflakes/rules/strings.rs</code>:750 on 2023-12-20 04:04</div>
            <div class="timeline-body"><p>I think that's why I left them as vectors, because the size of these is typically very small.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LaBatata101">@LaBatata101</a> on 2023-12-20 20:58</div>
            <div class="timeline-body"><blockquote>
<p>How did you decide on <code>smol_str</code> over any of the other small string crates? For example, <a href="https://crates.io/crates/compact_str"><code>compact_str</code></a> supports up to 24 bytes and 12 bytes on 32-bit architectures. But I'm unfamiliar with all the crates, so there might be other considerations. The intention isn't that you change the small string crate, but that we document how we made the decision in case we want to re-visit it in the future.</p>
</blockquote>
<p>I haven't investigated much about the different string crates, I found out about <code>smol_str</code> when l was looking into rust-analyzer parser source code. I tested in the new parser to see if it had any performance improvement, and it gave a slight performance increase IIRC, that was the reason I chose it ðŸ¤£. But it's probably a good idea to do a proper comparison between different string crates in the future.</p>
<blockquote>
<p>How did you decide on where to use <code>SmolStr</code>? E.g. you use it for Names and Identifiers but not for String literals.</p>
</blockquote>
<p>Since <code>SmolStr</code> allocates strings up to 23 bytes long on the stack, and strings in Python are also used for documentation, they can get quite large, so I didn't see much benefit from using <code>SmolStr</code> for string literals. However, for Names and Identifiers, which are usually small, and are a common token in the code, using <code>SmolStr</code> for them will, probably, save quite a lot of allocations.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-12-20 20:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-20 20:59</div>
            <div class="timeline-body"><p>Thank for separating this out!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/LaBatata101">@LaBatata101</a> reviewed on 2023-12-20 21:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/LaBatata101">@LaBatata101</a> on <code>crates/ruff_python_ast/src/nodes.rs</code>:1743 on 2023-12-20 21:06</div>
            <div class="timeline-body"><p>I already answered most of this question in another comment, but I didn't mention <code>ExprIpyEscapeCommand</code>. I haven't seen many examples of real world use of <code>ExprIpyEscapeCommand</code> so I don't know if they are usually short, like <code>Names</code> and <code>Identifiers</code>. Can't really tell if they are a suitable candidate to use <code>SmolStr</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-20 21:08</div>
            <div class="timeline-body"><p>Do you mind either merging <code>main</code> (there's a type error against new changes), or giving me edit privileges on this branch to clean up prior to merging?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LaBatata101">@LaBatata101</a> on 2023-12-20 21:21</div>
            <div class="timeline-body"><blockquote>
<p>Do you mind either merging <code>main</code> (there's a type error against new changes), or giving me edit privileges on this branch to clean up prior to merging?</p>
</blockquote>
<p>I think you already have edit privileges on this branch</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-12-20 21:26</div>
            <div class="timeline-body"><p>Ah right, thank you, it was an HTTPS vs. SSH thing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2023-12-20 22:17</div>
            <div class="timeline-body"><p>It looks like there is almost <a href="https://codspeed.io/astral-sh/ruff/branches/LaBatata101:smolstr-id">no difference</a> in the micro-benchmarks? Is this change still worth doing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/soft_keywords.rs</code>:205 on 2023-12-20 23:50</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    Tok::Name { name: ComactString::new_inline(name) }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-12-20 23:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-12-20 23:53</div>
            <div class="timeline-body"><blockquote>
<p>It looks like there is almost <a href="https://codspeed.io/astral-sh/ruff/branches/LaBatata101:smolstr-id">no difference</a> in the micro-benchmarks? Is this change still worth doing?</p>
</blockquote>
<p>That's the observation I made as well when I did this change a while back https://github.com/astral-sh/ruff/pull/6174</p>
<p>I wouldn't expect any changes for all benchmarks other than the lexer because our (old) parser allocates way too much, so any other improvements are lost in the noise.</p>
<p>I'm surprised that the lexer benchmarks are regressing. But the microbenchmarks might just be too short and exercise the exact same memory pattern for each run, allowing the allocator to re-use the allocations cheaply.</p>
<p>Or the change indeed is not as impactful as we thought.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-12-21 10:38</div>
            <div class="timeline-body"><p>Using <a href="https://github.com/astral-sh/ruff/pull/9229"><code>CompactString</code></a> seems more promising (but the API is more annoying). The main difference to <code>SmolStr</code> is that:</p>
<ul>
<li><code>CompactString::clone</code> is <code>O(n)</code> compared to <code>SmolStr</code>'s <code>O(1)</code>. Cloning in <code>O(1)</code> could be useful but we don't see any significant benefits from it from our existing benchmarks. Maybe we would need to update some downstream code to use <code>SmolStr</code> too.</li>
<li><code>CompactString</code> has no optimisation to store more than 23 whitespace only characters on the stack. This is an optimisation that we don't need.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-12-22 03:41</div>
            <div class="timeline-body"><p>Copying this here from the Discord conversation with @LaBatata101</p>
<blockquote>
<p>My current thinking on small-string crates:</p>
<ul>
<li>SmolStr shows too little benefits at the moment to justify adding a new dependency. That's why I wouldn't merge the PR just yet. We can revisit after switching the parser to see if it brings greater benefits (I'm doubtful but performance is hard to predict)
CompactStr: It improves the lexer performance by about 5%, but the speedups don't manifest in parser or linter improvements. I suspect that it is because our current parser is slow, and that it reduces the number of allocations for an Identifier from 2 to one, which is significant but maybe not significant enough. The API is a bit cumbersome when it comes to comparing with  str, which raises the entry barrier for new contributors (applies in general, yet another string type in Rust for them to understand)</li>
<li>Hipstr: As @Labatata101 pointed out, it requires adding lifetimes to Token and all Nodes which is too big a refactor for now.</li>
</ul>
<p>I'm leaning towards deferring the refactor until we've switched to the new parser to re-evaluate the benefits.
It's also worth considering alternatives or combining it with other improvements reducing the number of allocations. For example, we could explore using an Arena for the AST. This greatly reduces the number of allocations (and removes the Drop time), with the result that allocating for Names proportionally becomes more significant (and removing it yields greater performance improvements).</p>
<p>What I haven't analyzed yet is whether using a small string crate improves Ruff's memory consumption. A reduced memory consumption on its own would be justification enough for me to switch to a small string crate.</p>
</blockquote>
<p>@LaBatata101 do you want to analyze the memory consumption or should we move forward without the small string optimisation for now (and close our both PRs?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/LaBatata101">@LaBatata101</a> on 2023-12-23 20:48</div>
            <div class="timeline-body"><blockquote>
<p>do you want to analyze the memory consumption or should we move forward without the small string optimisation for now (and close our both PRs?)</p>
</blockquote>
<p>I think it's better to close both of our PRs for now, and do an in-depth analysis after the new parser is merged.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @LaBatata101 on 2023-12-23 20:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-05-08 21:29</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:57:29 UTC
    </footer>
</body>
</html>
