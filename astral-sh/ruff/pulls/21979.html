<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Remove invalid statement-keyword completions in for-statements - astral-sh/ruff #21979</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Remove invalid statement-keyword completions in for-statements</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21979">#21979</a>
        opened by <a href="https://github.com/RasmusNygren">@RasmusNygren</a>
        on 2025-12-14 19:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/RasmusNygren">@RasmusNygren</a></div>
            <div class="timeline-body"><p>In <code>for x in &lt;CURSOR&gt;</code> statements it&#x27;s only valid to provide expressions that eventually evaluate to an iterable. While it&#x27;s extremely difficult to know if something can evaulate to an iterable in a general case, there are some suggestions we know can never lead to an iterable. Most keywords are such and hence we remove them here.</p>
Summary
<p>This suppresses statement-keywords from auto-complete suggestions in <code>for x in &lt;CURSOR&gt;</code> statements where we know they can never be valid, as whatever is typed has to (at some point) evaluate to an iterable.</p>
<p>It handles the core issue from <a href="https://github.com/astral-sh/ty/issues/1774">astral-sh/ty#1774</a> but there&#x27;s a lot of related cases that probably has to be handled piece-wise.</p>
Test Plan
<p>New tests and verifying in the playground.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-14 19:17</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-14 19:19</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
+ pandas-stubs/_typing.pyi:1218:16: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 5136 diagnostics
+ Found 5137 diagnostics


</code></pre>


<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-14 19:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-14 19:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/RasmusNygren">@RasmusNygren</a> on <code>crates/ty_ide/src/completion.rs</code>:480 on 2025-12-14 20:08</div>
            <div class="timeline-body"><p>It might make more sense to make <code>add_keyword_completions</code> context-aware and avoid adding the incorrect completions to begin with rather than pruning them here after the fact.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/RasmusNygren">@RasmusNygren</a> on <code>crates/ty_ide/src/completion.rs</code>:1655 on 2025-12-14 20:10</div>
            <div class="timeline-body"><p>It probably makes sense here to make <code>find_typed_text</code> return a struct that contains both the text and the range so we don&#x27;t have to make these computations again from the bare string.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/RasmusNygren">@RasmusNygren</a> reviewed on 2025-12-14 20:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/RasmusNygren">@RasmusNygren</a> on 2025-12-14 21:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/RasmusNygren">@RasmusNygren</a> on 2025-12-14 21:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/RasmusNygren">@RasmusNygren</a> on 2025-12-14 21:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/RasmusNygren">@RasmusNygren</a> on 2025-12-14 21:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/RasmusNygren">@RasmusNygren</a> on 2025-12-14 21:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/RasmusNygren">@RasmusNygren</a> on 2025-12-14 21:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/BurntSushi">@BurntSushi</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-14 21:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/dcreager">@dcreager</a> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-15 07:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/carljm">@carljm</a> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-15 07:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/sharkdp">@sharkdp</a> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-15 07:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:1655 on 2025-12-15 16:54</div>
            <div class="timeline-body"><p>Yeah I think that&#x27;s a good idea. Doesn&#x27;t have to be in this PR though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:1648 on 2025-12-15 16:58</div>
            <div class="timeline-body"><p>I remain slightly concerned about adding more and more of these &quot;do we match this AST pattern?&quot; checks. I think it&#x27;s fine for now, but:</p>
<ol>
<li>I think eventually this is going to impact perf.</li>
<li>The &quot;check this case, then this case, and then this case&quot; approach already buckled under its own weight for imports. Now we have a &quot;look at the stuff we have <em>once</em>, and classify our case based on that.&quot;</li>
</ol>
<p>I don&#x27;t think there&#x27;s any action item here right now. Mostly just voicing my thoughts.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:470 on 2025-12-15 17:01</div>
            <div class="timeline-body"><p>I guess we don&#x27;t technically have to call this unless we know we&#x27;ve added some keywords to the completions. And that only happens for scope based completions. So this will do an unnecessary AST check for <code>object.attr</code> and import completions.</p>
<p>But maybe we&#x27;ll eventually rule out other things here besides keywords that we know can&#x27;t be iterable. So I&#x27;m not sure it&#x27;s worth trying to optimize this out?</p>
<p>I think part of my problem is that I don&#x27;t have an intuition for the costs associated with calling <code>covering_node</code>. Maybe I&#x27;m tilting at windmills.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2025-12-15 17:02</div>
            <div class="timeline-body"><p>Thank you! I think this LGTM as-is. I left some comments, but I&#x27;m not sure there&#x27;s anything actionable from them right now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-15 17:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:480 on 2025-12-15 17:08</div>
            <div class="timeline-body"><p>Yeah I&#x27;m not quite sure what the right architecture ought to be here. I suppose we could end up ruling out other completions as well.</p>
<p>Maybe having the completion collector &quot;know&quot; what the context is, and then its add methods could choose to ignore completions added that are incompatible with that context. But I think that&#x27;s a bigger refactor.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-12-15 17:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-12-15 17:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/RasmusNygren">@RasmusNygren</a> reviewed on 2025-12-15 18:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/RasmusNygren">@RasmusNygren</a> on <code>crates/ty_ide/src/completion.rs</code>:1648 on 2025-12-15 18:27</div>
            <div class="timeline-body"><p>Gathering all my thoughts here instead of responding in the various threads.</p>
<p>I share your concerns and in theory I like the approach of building a context (before adding any completions) that has enough information such that we can later determine what completions should be added or ignored. Ignoring that this would be a big refactor, what slightly concerns me with that approach is that the size and the amount of information we would need to capture in the context could get out of hand, in order to support all the different cases where we might want to add or suppress different suggestions. So in practice I&#x27;m not quite sure how you would architect that to make it intuitive to work with.</p>
<p>To the extent it&#x27;s doable, I do agree that we at the very least should stick to something like a single token-based pruning loop and a single AST-traversal pruning loop (I don&#x27;t see how we can get away without both as long as we do any pruning at all) that either mutate completions in-place or builds some list of predicate functions that can be used to filter completions. This at least gets us away from a whole bunch of individual checks that all do their own AST traversal to remove bad suggestions. I&#x27;m not sure this would be quite as simple to do when we add new completions though (without bigger refactors), as that usually requires more work.</p>
<p>At some point a refactor in some direction is probably due though to make this scale nicer (both in terms of performance and readability), but to me it&#x27;s not obvious what the right refactor to do here is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2026-01-15 18:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:21:44 UTC
    </footer>
</body>
</html>
