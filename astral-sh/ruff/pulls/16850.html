<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Show more precise messages in invalid type expressions - astral-sh/ruff #16850</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Show more precise messages in invalid type expressions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16850">#16850</a>
        opened by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a>
        on 2025-03-19 15:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-19 15:26</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Some error messages are not very specific and could be improved</p>
<h2>Test Plan</h2>
<p>Not yet sure where to put some tests, but will just test invalid type expressions</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-03-19 15:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-19 15:29</div>
            <div class="timeline-body"><p>Im not fully sure where to put tests for the currently unsupported special forms and type qualifiers</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-19 15:34</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-19 15:46</div>
            <div class="timeline-body"><blockquote>
<p>Im not fully sure where to put tests for the currently unsupported special forms and type qualifiers</p>
</blockquote>
<p>maybe these files?</p>
<ul>
<li>https://github.com/astral-sh/ruff/blob/main/crates/red_knot_python_semantic/resources/mdtest/annotations/unsupported_type_qualifiers.md</li>
<li>https://github.com/astral-sh/ruff/blob/main/crates/red_knot_python_semantic/resources/mdtest/annotations/unsupported_special_forms.md</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-19 15:47</div>
            <div class="timeline-body"><p>Yeah, i thought that, but we does providing error messages not imply that we are supporting them partially?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-19 15:49</div>
            <div class="timeline-body"><p>True. We'll need comprehensive test suites covering each special form eventually, so you can create new files for each now if you like! But equally, I don't think it matters too much right now; I'd be inclined to just adjust the prose a little bit in those files saying that we don't fully support them, but we do detect some invalid uses when they appear in type expressions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-19 15:50</div>
            <div class="timeline-body"><p>Okay, will do that then, thanks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-19 16:08</div>
            <div class="timeline-body"><p>Tests failing because</p>
<pre><code class="language-python">def _(
    a: Final
) -&gt; None: ...
</code></pre>
<p>raises no error</p>
<p>Ill change it to Final | int.</p>
<p>@AlexWaygood why does this happen exactly?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-03-19 16:14</div>
            <div class="timeline-body"><blockquote>
<p>@AlexWaygood why does this happen exactly?</p>
</blockquote>
<p>That's because we currently only validate that parameter annotations are valid annotation expressions. Bare <code>Final</code> <em>is</em> a valid <em>annotation expression</em>, even though it's not a valid <em>type expression</em>.</p>
<p>You can take a look at the typing spec page here for an explanation of the difference between the two concepts: https://typing.python.org/en/latest/spec/annotations.html#type-and-annotation-expressions. <code>Final</code> is a valid annotation expression but not a valid type expression; <code>Final | int</code> is neither a valid annotation expression nor a valid type expression.</p>
<p>Now, is <code>Final</code> a valid parameter annotation? No! ðŸ˜„ But the reason it's invalid isn't relevant to the changes you're making here, and we shouldn't attempt to detect the invalidity as part of the <code>Type::in_type_expression()</code> method. At some point, we'll need to add some extra validation specifically for parameter annotations that checks exactly whether the annotation expression is one of the expressions that are disallowed in the specific context of parameter annotations. But we haven't implemented that additional check yet :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-19 16:18</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-03-19 16:19</div>
            <div class="timeline-body"><p>Okay understood. What function infers the type of parameter annotations?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MatthewMckee4 on 2025-03-19 16:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MatthewMckee4 on 2025-03-19 16:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MatthewMckee4 on 2025-03-19 16:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MatthewMckee4 on 2025-03-19 16:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @MatthewMckee4 on 2025-03-19 16:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/unsupported_special_forms.md</code>:43 on 2025-03-19 16:27</div>
            <div class="timeline-body"><pre><code class="language-suggestion">One thing that is supported is error messages for using special forms in type expressions.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/annotations/unsupported_special_forms.md</code>:46 on 2025-03-19 16:27</div>
            <div class="timeline-body"><pre><code class="language-suggestion">from typing_extensions import Unpack, TypeGuard, TypeIs, Concatenate
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3611 on 2025-03-19 16:31</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// Type qualifiers are always invalid in *type expressions*,
    /// but these ones are okay with 0 arguments in *annotation expressions*
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3613 on 2025-03-19 16:32</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// Type qualifiers that are invalid in type expressions,
    /// and which would require exactly one argument even if they appeared in an annotation expression
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-03-19 16:33</div>
            <div class="timeline-body"><blockquote>
<p>What function infers the type of parameter annotations?</p>
</blockquote>
<p><code>TypeInferenceBuilder::infer_parameter</code> and <code>TypeInferenceBuilder::infer_parameter_with_default</code> both call into <code>TypeInferenceBuilder::infer_optional_annotation_expression</code> to infer the annotated type.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-03-19 16:33</div>
            <div class="timeline-body"><p>Looks great, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-03-19 16:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3610 on 2025-03-19 16:35</div>
            <div class="timeline-body"><p>Since this PR is removing <code>ClassVarInTypeExpression</code> and <code>FinalInTypeExpression</code>, can we also rename <code>ProtocolInTypeExpression</code> to just <code>Protocol</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-03-19 16:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3610 on 2025-03-19 16:36</div>
            <div class="timeline-body"><p>Yeah</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-03-19 16:57</div>
            <div class="timeline-body"><p>Thanks, this is great!! I pushed a commit to make the <code>match</code> a bit more readable, since it was getting a bit big and the <code>KnownInstance</code> branches were interspersed with some of the other branches</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-03-19 17:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-03-19 17:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-03-19 17:29</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:41:05 UTC
    </footer>
</body>
</html>
