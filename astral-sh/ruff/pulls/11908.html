<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Strip out non-pyi files from the typeshed zip file created at build time - astral-sh/ruff #11908</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Strip out non-pyi files from the typeshed zip file created at build time</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11908">#11908</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-06-17 17:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This tweaks the red-knot <code>build.rs</code> script to ensure that all non-<code>.pyi</code> files are stripped out from the zip created at build time, and asserts as much in our test suite. This means there's less room for error if typeshed changes its directory structure unexpectedly, which could theoretically cause us to accidentally start bundling parts of typeshed's test suite as part of the zip.</p>
<p>The only non-<code>.pyi</code> file we'll need from typeshed is the <code>stdlib/VERSIONS</code> file, and I think it's easier if we add that to the Ruff binary separately via <code>include_str!()</code>.</p>
<h2>Test Plan</h2>
<p>Add some more assertions to <code>module.rs</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2024-06-17 17:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2024-06-17 17:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-06-17 17:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/build.rs</code>:91 on 2024-06-17 21:33</div>
            <div class="timeline-body"><p>Doesn't the walkdir entry expose whether it is a directory or not? I find it a bit confusing that we are handling dirs in this predicate</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot/build.rs</code>:40 on 2024-06-17 21:34</div>
            <div class="timeline-body"><p>What's the motivation for passing a relative path when the predicate logic makes the path absolute again by joining (and the extension part doesn't care about relative or absolute)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-06-17 21:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-06-17 23:07</div>
            <div class="timeline-body"><p>I don't have any major objection to this PR, but I find the motivation for it a little weak, and it's not clear to me that it's worth the added build-script complexity.</p>
<p>If typeshed changes its directory structure, we should catch that in the typeshed-vendoring-update PR (and we should have tests relying on typeshed that will fail in that PR to alert us to the problem.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-06-17 23:09</div>
            <div class="timeline-body"><p>If this was motivated by an actual problem we encountered that this would have solved, then I don't have a problem with it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-06-18 13:37</div>
            <div class="timeline-body"><p>I think you're right, it's probably not worth the added complexity for now. Thanks for the reviews.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-06-18 13:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-06-18 13:37</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:04:53 UTC
    </footer>
</body>
</html>
