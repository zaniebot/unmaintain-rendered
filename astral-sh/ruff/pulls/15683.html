<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Support custom typeshed Markdown tests - astral-sh/ruff #15683</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Support custom typeshed Markdown tests</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15683">#15683</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-01-23 08:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body">Summary
<ul>
<li>Add feature to specify a custom typeshed from within Markdown-based tests</li>
<li>Port &quot;builtins&quot; unit tests from <code>infer.rs</code> to Markdown tests, part of #13696</li>
</ul>
Test Plan
<ul>
<li>Tests for the custom typeshed feature</li>
<li>New Markdown tests for deleted Rust unit tests</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-23 08:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-23 08:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-23 08:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-23 08:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-23 08:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/module_resolver/testing.rs</code>:76 on 2025-01-23 08:48</div>
            <div class="timeline-body"><p>Drive-by fix. Unrelated to this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/lib.rs</code>:154 on 2025-01-23 08:54</div>
            <div class="timeline-body"><pre><code></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/lib.rs</code>:178 on 2025-01-23 08:55</div>
            <div class="timeline-body"><p>Nit: Should we just call <code>Program::update_from_settings</code>?</p>
<p>It has the advantage that it avoids setting values (and, therefore, bumping the salsa revision) if the values are unchanged.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-01-23 08:56</div>
            <div class="timeline-body"><p>Sweet</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-23 08:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/src/lib.rs</code>:178 on 2025-01-23 08:59</div>
            <div class="timeline-body"><p>... and looks better. Thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-23 09:17</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>âœ… ecosystem check detected no linter changes.</p>
Linter (preview)
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/mdtest_custom_typeshed.md</code>:82 on 2025-01-23 10:02</div>
            <div class="timeline-body"><p>heh, that&#x27;s annoying ðŸ˜† but fine for now, I think, since I imagine making <code>reveal_type</code> work even if it&#x27;s not defined in a custom typeshed would require much more invasive special casing for the function.</p>
<p>Mypy&#x27;s approach might be interesting to you though -- it <em>by default</em> uses a custom typeshed for its tests, which you can find in https://github.com/python/mypy/tree/master/test-data/unit/lib-stub. The reason for this is largely to improve the runtime of the tests -- the default custom typeshed is very simple, and mypy&#x27;s tests would be much slower if they all used the much-more-complex &quot;real&quot; typeshed in every test. Mypy&#x27;s approach has <em>many</em> downsides: there have often been PRs that appear to fix bugs, and pass all tests, but don&#x27;t actually fix the bug when mypy runs on real user code, because of the difference between mypy&#x27;s mock typeshed and the real typeshed mypy uses when checking user code. But it also has upsides apart from performance:</p>
<ul>
<li>Mypy&#x27;s tests are better isolated from random typeshed changes that cause tests to fail</li>
<li>It&#x27;s very easy to override a single file or two from mypy&#x27;s custom typeshed in a test case, without having to provide definitions for <code>reveal_type</code> in every test case.</li>
</ul>
<p>Overall I&#x27;m definitely not advocating for mypy&#x27;s approach; I think the costs outweigh the benefits given how much faster our tests are than mypy&#x27;s. But it is an <em>interesting</em> approach.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/db.rs</code>:139 on 2025-01-23 10:10</div>
            <div class="timeline-body"><p>hmm, it is still true that we will still <em>have</em> a typeshed directory to use even if this field is <code>None</code> though, right? (We&#x27;ll just use the vendored typeshed directory.) In that sense, even if we&#x27;re renaming the CLI option to <code>--typeshed</code> rather than <code>--custom-typeshed</code>, I still think <code>custom_typeshed</code> might be a better variable name for us to use internally for fields like this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/mdtest_custom_typeshed.md</code>:1 on 2025-01-23 10:12</div>
            <div class="timeline-body"><p>it took me a second to clock that this was actually an integration test for the feature, as well as documentation ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:12 on 2025-01-23 10:14</div>
            <div class="timeline-body"><p>If you like, you could link to https://github.com/python/typeshed/blob/c546278aae47de0b2b664973da4edb613400f6ce/stdlib/VERSIONS#L1-L18 here, which explains the format of the <code>VERSIONS</code> file. And our parser for the <code>VERSIONS</code> file is at https://github.com/astral-sh/ruff/blob/main/crates/red_knot_python_semantic/src/module_resolver/typeshed.rs</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:258 on 2025-01-23 10:14</div>
            <div class="timeline-body"><p>maybe link to the test?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/src/lib.rs</code>:151 on 2025-01-23 10:20</div>
            <div class="timeline-body"><p>nit: strictly speaking we&#x27;re constructing a module <em>name</em> from the module path</p>
<pre><code>                    let module_name = path
</code></pre>
<p>The logic here LGTM though, assuming all paths in <code>typeshed_files</code> are already relative to <code>/typeshed/stdlib</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/src/lib.rs</code>:156 on 2025-01-23 10:22</div>
            <div class="timeline-body"><p>should this be something like this?</p>
<pre><code>                    let default_version = PythonVersion::default();
                    let _ = writeln!(content, &quot;{module_path}: {default_version}-&quot;);
</code></pre>
<p>though that might make upgrading our default Python version harder, I suppose? Not sure</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/src/parser.rs</code>:136 on 2025-01-23 10:23</div>
            <div class="timeline-body"><p>it might again be good to link to https://github.com/python/typeshed/blob/c546278aae47de0b2b664973da4edb613400f6ce/stdlib/VERSIONS#L1-L18 here, as many readers of this might not be familiar with the <code>VERSIONS</code> file</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-23 10:23</div>
            <div class="timeline-body"><p>Brilliant!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-23 10:26</div>
            <div class="timeline-body"><p>I guess this feature again suffers from the problem that, when rendered, you don&#x27;t see the filenames at all :/</p>

Screenshot

<p><img src="https://github.com/user-attachments/assets/d443ca8e-5354-4f55-ada5-8425bd36bafc" alt="image"></p>


<p>But, not a problem new to this PR, and this PR obviously doesn&#x27;t have to fix it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/db.rs</code>:139 on 2025-01-23 10:45</div>
            <div class="timeline-body"><p>The field is called <code>typeshed</code> (with the same type) in <code>program::SearchPathSettings</code>, which is used in lots of places. I chose a consistent naming here. I renamed both fields now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-23 10:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-23 10:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/src/lib.rs</code>:156 on 2025-01-23 10:53</div>
            <div class="timeline-body"><p>Also not sure. I feel like what we have is less surprising? And it follows this (now removed) comment from the &quot;planned features&quot; section:</p>
<blockquote>
<p>If no such file is created explicitly, one should be created implicitly including entries enabling all specified <code>&lt;typeshed-root&gt;/stdlib</code> files <strong>for all supported Python versions</strong>.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-23 10:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/src/lib.rs</code>:156 on 2025-01-23 10:57</div>
            <div class="timeline-body"><p>hmm, yeah. So I guess if we wanted to make it dynamic, it should be something like <code>PythonVersion::minimum_supported()</code> rather than <code>PythonVersion::default()</code>. But we don&#x27;t have that method, and I don&#x27;t think it&#x27;s worth adding just for this. So let&#x27;s go with what you have now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-23 11:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/db.rs</code>:139 on 2025-01-23 11:32</div>
            <div class="timeline-body"><p>It looks like many of these fields have now been renamed from <code>typeshed</code> to <code>custom_typeshed</code>, but still not this specific one ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-23 11:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-23 11:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-23 11:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/resources/mdtest/mdtest_custom_typeshed.md</code>:82 on 2025-01-23 14:22</div>
            <div class="timeline-body"><blockquote>
<p>Mypy&#x27;s tests are better isolated from random typeshed changes that cause tests to fail</p>
</blockquote>
<p>To clarify my understanding:  This part we&#x27;re fairly well insulated from, since we&#x27;re vendoring specific SHAs of typeshed.  We&#x27;ll get test failures when we update our vendored copy, if there have been incompatible changes â€” but that&#x27;s a <em>good</em> thing, since those are real things we have to fix, and CI forces us to fix them before we can commit the typeshed update.  Do I have all of that right?</p>
<blockquote>
<p>It&#x27;s very easy to override a single file or two from mypy&#x27;s custom typeshed in a test case, without having to provide definitions for <code>reveal_type</code> in every test case.</p>
</blockquote>
<p>Does mypy&#x27;s ability to override individual files depend on it using a custom typeshed by default?  i.e. I could imagine an additional <code>environment.typeshed_override = true</code> mdtest config that lets us override individual files but retain the rest of our vendored real typeshed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-01-23 14:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-23 15:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/mdtest_custom_typeshed.md</code>:82 on 2025-01-23 15:11</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>Mypy&#x27;s tests are better isolated from random typeshed changes that cause tests to fail</p>
</blockquote>
<p>To clarify my understanding: This part we&#x27;re fairly well insulated from, since we&#x27;re vendoring specific SHAs of typeshed. We&#x27;ll get test failures when we update our vendored copy, if there have been incompatible changes â€” but that&#x27;s a <em>good</em> thing, since those are real things we have to fix, and CI forces us to fix them before we can commit the typeshed update. Do I have all of that right?</p>
</blockquote>
<p>Yes, that&#x27;s all correct! Our tests are more vulnerable to breaking whenever we do a typeshed sync, and already have broken several times when we&#x27;ve tried to sync typeshed. So mypy&#x27;s tests are closer to being unit tests, in that they control the input to their tests totally; ours are more like integration tests. But as you say, this makes our tests more representative of how we&#x27;ll actually type-check our users&#x27; code, so it&#x27;s a good thing!</p>
<blockquote>
<p>Does mypy&#x27;s ability to override individual files depend on it using a custom typeshed by default? i.e. I could imagine an additional <code>environment.typeshed_override = true</code> mdtest config that lets us override individual files but retain the rest of our vendored real typeshed.</p>
</blockquote>
<p>That&#x27;s true, I suppose that could work!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-23 16:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/db.rs</code>:139 on 2025-01-23 16:47</div>
            <div class="timeline-body"><p>Oops, I&#x27;ll take a look. Thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/builtins.md</code>:41 on 2025-01-23 17:01</div>
            <div class="timeline-body"><p>I wonder if mdtest should just automatically include this in any custom typeshed (if you don&#x27;t specify your own <code>typing_extensions</code>), so we don&#x27;t have to specify it in each test?</p>
<p>But I guess there&#x27;s value in simple, explicit behavior; we can wait and see how painful this is; maybe not too bad if we don&#x27;t have too many tests using custom typeshed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-23 17:06</div>
            <div class="timeline-body"><p>This is awesome!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-23 17:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/builtins.md</code>:41 on 2025-01-23 17:07</div>
            <div class="timeline-body"><p>(I think ideally we would have at least a <em>few</em> more tests using custom typesheds, so I wouldn&#x27;t want to make it <em>too</em> painful to write these tests)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-23 17:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/builtins.md</code>:41 on 2025-01-23 17:08</div>
            <div class="timeline-body"><p>Anyway, we already discussed this at <a href="https://github.com/astral-sh/ruff/pull/15683">astral-sh/ruff#15683</a>#discussion_r1926701227 ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-23 18:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/builtins.md</code>:41 on 2025-01-23 18:00</div>
            <div class="timeline-body"><p>I saw that convo but I didn&#x27;t see any specific proposal there to do something to make this easier. I guess we could do the override-files-instead-of-replace-entirely thing, but I kind of like the idea that we can write tests that more fully control typeshed contents; I think replacing just one file without causing lots of cascading import errors would be hard (though I guess maybe import errors are fine, we won&#x27;t surface them in typeshed.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-01-23 18:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/builtins.md</code>:41 on 2025-01-23 18:01</div>
            <div class="timeline-body"><p>Replacing files is probably also more expensive to implement because it requires reading and copying all vendored files to the memory file system (not hugely expensive but not free).</p>
<p>I do like the idea of an extra <code>environment</code> option that e.g. includes whatever&#x27;s necessary for <code>reveal_type</code></p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:10:45 UTC
    </footer>
</body>
</html>
