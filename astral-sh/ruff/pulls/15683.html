<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Support custom typeshed Markdown tests - astral-sh/ruff #15683</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Support custom typeshed Markdown tests</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15683">#15683</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-01-23 08:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-01-23 08:48</div>
            <div class="timeline-body"><h2>Summary</h2>
<ul>
<li>Add feature to specify a custom typeshed from within Markdown-based tests</li>
<li>Port &quot;builtins&quot; unit tests from <code>infer.rs</code> to Markdown tests, part of #13696</li>
</ul>
<h2>Test Plan</h2>
<ul>
<li>Tests for the custom typeshed feature</li>
<li>New Markdown tests for deleted Rust unit tests</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @sharkdp on 2025-01-23 08:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-01-23 08:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @sharkdp on 2025-01-23 08:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-01-23 08:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-23 08:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/module_resolver/testing.rs</code>:76 on 2025-01-23 08:48</div>
            <div class="timeline-body"><p>Drive-by fix. Unrelated to this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/lib.rs</code>:154 on 2025-01-23 08:54</div>
            <div class="timeline-body"><pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/lib.rs</code>:178 on 2025-01-23 08:55</div>
            <div class="timeline-body"><p>Nit: Should we just call <code>Program::update_from_settings</code>?</p>
<p>It has the advantage that it avoids setting values (and, therefore, bumping the salsa revision) if the values are unchanged.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-01-23 08:56</div>
            <div class="timeline-body"><p>Sweet</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-23 08:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/src/lib.rs</code>:178 on 2025-01-23 08:59</div>
            <div class="timeline-body"><p>... and looks better. Thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-23 09:17</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/mdtest_custom_typeshed.md</code>:82 on 2025-01-23 10:02</div>
            <div class="timeline-body"><p>heh, that's annoying ðŸ˜† but fine for now, I think, since I imagine making <code>reveal_type</code> work even if it's not defined in a custom typeshed would require much more invasive special casing for the function.</p>
<p>Mypy's approach might be interesting to you though -- it <em>by default</em> uses a custom typeshed for its tests, which you can find in https://github.com/python/mypy/tree/master/test-data/unit/lib-stub. The reason for this is largely to improve the runtime of the tests -- the default custom typeshed is very simple, and mypy's tests would be much slower if they all used the much-more-complex &quot;real&quot; typeshed in every test. Mypy's approach has <em>many</em> downsides: there have often been PRs that appear to fix bugs, and pass all tests, but don't actually fix the bug when mypy runs on real user code, because of the difference between mypy's mock typeshed and the real typeshed mypy uses when checking user code. But it also has upsides apart from performance:</p>
<ul>
<li>Mypy's tests are better isolated from random typeshed changes that cause tests to fail</li>
<li>It's very easy to override a single file or two from mypy's custom typeshed in a test case, without having to provide definitions for <code>reveal_type</code> in every test case.</li>
</ul>
<p>Overall I'm definitely not advocating for mypy's approach; I think the costs outweigh the benefits given how much faster our tests are than mypy's. But it is an <em>interesting</em> approach.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/db.rs</code>:139 on 2025-01-23 10:10</div>
            <div class="timeline-body"><p>hmm, it is still true that we will still <em>have</em> a typeshed directory to use even if this field is <code>None</code> though, right? (We'll just use the vendored typeshed directory.) In that sense, even if we're renaming the CLI option to <code>--typeshed</code> rather than <code>--custom-typeshed</code>, I still think <code>custom_typeshed</code> might be a better variable name for us to use internally for fields like this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/mdtest_custom_typeshed.md</code>:1 on 2025-01-23 10:12</div>
            <div class="timeline-body"><p>it took me a second to clock that this was actually an integration test for the feature, as well as documentation ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:12 on 2025-01-23 10:14</div>
            <div class="timeline-body"><p>If you like, you could link to https://github.com/python/typeshed/blob/c546278aae47de0b2b664973da4edb613400f6ce/stdlib/VERSIONS#L1-L18 here, which explains the format of the <code>VERSIONS</code> file. And our parser for the <code>VERSIONS</code> file is at https://github.com/astral-sh/ruff/blob/main/crates/red_knot_python_semantic/src/module_resolver/typeshed.rs</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:258 on 2025-01-23 10:14</div>
            <div class="timeline-body"><p>maybe link to the test?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/src/lib.rs</code>:151 on 2025-01-23 10:20</div>
            <div class="timeline-body"><p>nit: strictly speaking we're constructing a module <em>name</em> from the module path</p>
<pre><code class="language-suggestion">                    let module_name = path
</code></pre>
<p>The logic here LGTM though, assuming all paths in <code>typeshed_files</code> are already relative to <code>/typeshed/stdlib</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/src/lib.rs</code>:156 on 2025-01-23 10:22</div>
            <div class="timeline-body"><p>should this be something like this?</p>
<pre><code class="language-suggestion">                    let default_version = PythonVersion::default();
                    let _ = writeln!(content, &quot;{module_path}: {default_version}-&quot;);
</code></pre>
<p>though that might make upgrading our default Python version harder, I suppose? Not sure</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/src/parser.rs</code>:136 on 2025-01-23 10:23</div>
            <div class="timeline-body"><p>it might again be good to link to https://github.com/python/typeshed/blob/c546278aae47de0b2b664973da4edb613400f6ce/stdlib/VERSIONS#L1-L18 here, as many readers of this might not be familiar with the <code>VERSIONS</code> file</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-01-23 10:23</div>
            <div class="timeline-body"><p>Brilliant!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-01-23 10:26</div>
            <div class="timeline-body"><p>I guess this feature again suffers from the problem that, when rendered, you don't see the filenames at all :/</p>
<details>
<summary>Screenshot</summary>

<p><img src="https://github.com/user-attachments/assets/d443ca8e-5354-4f55-ada5-8425bd36bafc" alt="image" /></p>
</details>

<p>But, not a problem new to this PR, and this PR obviously doesn't have to fix it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/db.rs</code>:139 on 2025-01-23 10:45</div>
            <div class="timeline-body"><p>The field is called <code>typeshed</code> (with the same type) in <code>program::SearchPathSettings</code>, which is used in lots of places. I chose a consistent naming here. I renamed both fields now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-23 10:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-23 10:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/src/lib.rs</code>:156 on 2025-01-23 10:53</div>
            <div class="timeline-body"><p>Also not sure. I feel like what we have is less surprising? And it follows this (now removed) comment from the &quot;planned features&quot; section:</p>
<blockquote>
<p>If no such file is created explicitly, one should be created implicitly including entries enabling all specified <code>&lt;typeshed-root&gt;/stdlib</code> files <strong>for all supported Python versions</strong>.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-23 10:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/src/lib.rs</code>:156 on 2025-01-23 10:57</div>
            <div class="timeline-body"><p>hmm, yeah. So I guess if we wanted to make it dynamic, it should be something like <code>PythonVersion::minimum_supported()</code> rather than <code>PythonVersion::default()</code>. But we don't have that method, and I don't think it's worth adding just for this. So let's go with what you have now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-23 11:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/db.rs</code>:139 on 2025-01-23 11:32</div>
            <div class="timeline-body"><p>It looks like many of these fields have now been renamed from <code>typeshed</code> to <code>custom_typeshed</code>, but still not this specific one ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-01-23 11:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-01-23 11:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-01-23 11:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/resources/mdtest/mdtest_custom_typeshed.md</code>:82 on 2025-01-23 14:22</div>
            <div class="timeline-body"><blockquote>
<p>Mypy's tests are better isolated from random typeshed changes that cause tests to fail</p>
</blockquote>
<p>To clarify my understanding:  This part we're fairly well insulated from, since we're vendoring specific SHAs of typeshed.  We'll get test failures when we update our vendored copy, if there have been incompatible changes â€” but that's a <em>good</em> thing, since those are real things we have to fix, and CI forces us to fix them before we can commit the typeshed update.  Do I have all of that right?</p>
<blockquote>
<p>It's very easy to override a single file or two from mypy's custom typeshed in a test case, without having to provide definitions for <code>reveal_type</code> in every test case.</p>
</blockquote>
<p>Does mypy's ability to override individual files depend on it using a custom typeshed by default?  i.e. I could imagine an additional <code>environment.typeshed_override = true</code> mdtest config that lets us override individual files but retain the rest of our vendored real typeshed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-01-23 14:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-23 15:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/mdtest_custom_typeshed.md</code>:82 on 2025-01-23 15:11</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>Mypy's tests are better isolated from random typeshed changes that cause tests to fail</p>
</blockquote>
<p>To clarify my understanding: This part we're fairly well insulated from, since we're vendoring specific SHAs of typeshed. We'll get test failures when we update our vendored copy, if there have been incompatible changes â€” but that's a <em>good</em> thing, since those are real things we have to fix, and CI forces us to fix them before we can commit the typeshed update. Do I have all of that right?</p>
</blockquote>
<p>Yes, that's all correct! Our tests are more vulnerable to breaking whenever we do a typeshed sync, and already have broken several times when we've tried to sync typeshed. So mypy's tests are closer to being unit tests, in that they control the input to their tests totally; ours are more like integration tests. But as you say, this makes our tests more representative of how we'll actually type-check our users' code, so it's a good thing!</p>
<blockquote>
<p>Does mypy's ability to override individual files depend on it using a custom typeshed by default? i.e. I could imagine an additional <code>environment.typeshed_override = true</code> mdtest config that lets us override individual files but retain the rest of our vendored real typeshed.</p>
</blockquote>
<p>That's true, I suppose that could work!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-01-23 16:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/db.rs</code>:139 on 2025-01-23 16:47</div>
            <div class="timeline-body"><p>Oops, I'll take a look. Thanks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/builtins.md</code>:41 on 2025-01-23 17:01</div>
            <div class="timeline-body"><p>I wonder if mdtest should just automatically include this in any custom typeshed (if you don't specify your own <code>typing_extensions</code>), so we don't have to specify it in each test?</p>
<p>But I guess there's value in simple, explicit behavior; we can wait and see how painful this is; maybe not too bad if we don't have too many tests using custom typeshed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-23 17:06</div>
            <div class="timeline-body"><p>This is awesome!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-23 17:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/builtins.md</code>:41 on 2025-01-23 17:07</div>
            <div class="timeline-body"><p>(I think ideally we would have at least a <em>few</em> more tests using custom typesheds, so I wouldn't want to make it <em>too</em> painful to write these tests)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-01-23 17:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/builtins.md</code>:41 on 2025-01-23 17:08</div>
            <div class="timeline-body"><p>Anyway, we already discussed this at https://github.com/astral-sh/ruff/pull/15683#discussion_r1926701227 ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-01-23 18:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/builtins.md</code>:41 on 2025-01-23 18:00</div>
            <div class="timeline-body"><p>I saw that convo but I didn't see any specific proposal there to do something to make this easier. I guess we could do the override-files-instead-of-replace-entirely thing, but I kind of like the idea that we can write tests that more fully control typeshed contents; I think replacing just one file without causing lots of cascading import errors would be hard (though I guess maybe import errors are fine, we won't surface them in typeshed.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-01-23 18:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/builtins.md</code>:41 on 2025-01-23 18:01</div>
            <div class="timeline-body"><p>Replacing files is probably also more expensive to implement because it requires reading and copying all vendored files to the memory file system (not hugely expensive but not free).</p>
<p>I do like the idea of an extra <code>environment</code> option that e.g. includes whatever's necessary for <code>reveal_type</code></p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:57:51 UTC
    </footer>
</body>
</html>
