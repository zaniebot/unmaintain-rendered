<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Handle special case returning `NotImplemented` - astral-sh/ruff #17034</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Handle special case returning <code>NotImplemented</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17034">#17034</a>
        opened by <a href="https://github.com/cake-monotone">@cake-monotone</a>
        on 2025-03-28 11:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cake-monotone">@cake-monotone</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Closes #16661</p>
<p>This PR includes two changes:</p>
<ul>
<li><code>NotImplementedType</code> is now a member of <code>KnownClass</code></li>
<li>We skip <code>is_assignable_to</code> checks for <code>NotImplemented</code> when checking return types</li>
</ul>
<h3>Limitation</h3>
<pre><code class="language-py">def f(cond: bool) -&gt; int:
    return 1 if cond else NotImplemented
</code></pre>
<p>The implementation covers cases where <code>NotImplemented</code> appears inside a <code>Union</code>.
However, for more complex types (ex. <code>Intersection</code>) it will not worked. In my opinion, supporting such complexity is unnecessary at this point.</p>
<h2>Test Plan</h2>
<p>Two <code>mdtest</code> files were updated:</p>
<ul>
<li><code>mdtest/function/return_type.md</code></li>
<li><code>mdtest/type_properties/is_singleton.md</code></li>
</ul>
<p>To test <code>KnownClass</code>, run:</p>
<pre><code class="language-bash">cargo test -p red_knot_python_semantic -- types::class::
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @cake-monotone on 2025-03-28 11:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @cake-monotone on 2025-03-28 11:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @cake-monotone on 2025-03-28 11:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @cake-monotone on 2025-03-28 11:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Handle special case returning NotImplemented" to "[red-knot] Handle special case returning `NotImplemented`" by @cake-monotone on 2025-03-28 11:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-28 11:54</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">rich (https://github.com/Textualize/rich)
+ error[lint:invalid-argument-type] /tmp/mypy_primer/projects/rich/rich/control.py:198:27: Object of type `dict | @Todo[crates/red_knot_python_semantic/src/types/infer.rs:3627]` cannot be assigned to parameter 2 (`table`) of bound method `translate`; expected type `_TranslateTable`
- error[lint:invalid-argument-type] /tmp/mypy_primer/projects/rich/rich/control.py:198:27: Object of type `dict | @Todo[crates/red_knot_python_semantic/src/types/infer.rs:3615]` cannot be assigned to parameter 2 (`table`) of bound method `translate`; expected type `_TranslateTable`

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cake-monotone">@cake-monotone</a> on 2025-03-28 13:39</div>
            <div class="timeline-body"><p>Handling unions may not even be necessary. A comparison between commits using <code>mypy-primer</code> showed no differences.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/function/return_type.md</code>:275 on 2025-03-28 14:00</div>
            <div class="timeline-body"><pre><code class="language-suggestion">## NotImplemented

`NotImplemented` is a special symbol in Python. It is commonly used to control the fallback behavior
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/function/return_type.md</code>:276 on 2025-03-28 14:00</div>
            <div class="timeline-body"><p>Is this trailing backslash needed?</p>
<pre><code class="language-suggestion">of special dunder methods.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:1371 on 2025-03-28 14:12</div>
            <div class="timeline-body"><p>I don't think that this needs to be split into two cases by Python version, or needs a TODO comment.</p>
<p>Regardless of Python version, the &quot;original&quot; definition in typeshed is at <code>builtins._NotImplementedType</code>; <code>types.NotImplementedType</code> is just an alias to that. So <code>builtins._NotImplementedType</code> is the only definition we have to recognize here <code>try_from_file_name</code>. If we recognize that one (on any Python version), then the alias in <code>types</code> module will resolve correctly (once we fix https://github.com/astral-sh/ruff/issues/17032).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:1186 on 2025-03-28 14:15</div>
            <div class="timeline-body"><p>I don't think we need this TODO comment. Even on newer Python versions, I think the simplest approach is to always consider <code>builtins._NotImplementedType</code> as the canonical definition of this type, since it's the one that will always exist.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:1008 on 2025-03-28 14:16</div>
            <div class="timeline-body"><p>Not sure we need any of this comment, as mentioned below; I think the simplest approach will be to always consider <code>builtins._NotImplementedType</code> the canonical definition.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-03-28 14:19</div>
            <div class="timeline-body"><p>This looks great, thank you!</p>
<p>I agree that the union implementation is <em>probably</em> unnecessary in practice, but it also doesn't cost very much to include it, and it is plausible that someone might write an if-expression that conditionally returns <code>NotImplemented</code>, so I would suggest we leave it in place.</p>
<p>Mostly I think we can remove some of the commentary and extra complexity around <code>builtins._NotImplementedType</code> vs <code>types.NotImplementedType</code>, and just let <code>builtins._NotImplementedType</code> be canonical on every Python version. The only thing in this PR that I think really should change when we fix https://github.com/astral-sh/ruff/issues/17032 is the one failing <code>is_singleton</code> test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_singleton.md</code>:102 on 2025-03-28 14:49</div>
            <div class="timeline-body"><p>I'm not exactly sure if these backslashes are required here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/resources/mdtest/type_properties/is_singleton.md</code>:118 on 2025-03-28 14:51</div>
            <div class="timeline-body"><p>Same as above, not sure if we need the backslash here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-03-28 15:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @dhruvmanila on 2025-03-28 15:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cake-monotone">@cake-monotone</a> reviewed on 2025-03-30 03:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cake-monotone">@cake-monotone</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:1371 on 2025-03-30 03:17</div>
            <div class="timeline-body"><p>That makes sense. That clears up my confusion Thanks! üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-03-30 18:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @carljm on 2025-03-30 18:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @carljm on 2025-03-30 18:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-02 07:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:1371 on 2025-04-02 07:24</div>
            <div class="timeline-body"><p>I just ran red knot on some code and saw &quot;Object of type <code>_NotImplementedType</code> is not assignable to return type ‚Ä¶&quot; errors. Took me quite a while to realize that the feature implemented here only works if the target version is set to 3.9 (https://playknot.ruff.rs/c7f2fe9a-294e-4b9a-bd67-03a72eaae726), but not if it is set to 3.10 or higher (https://playknot.ruff.rs/e4d30864-6338-4b69-9962-982c330c09f4). This probably relates to the discussion here and/or to #17032. I just wanted to raise this, in case it wasn't known that the tests here only succeed on 3.9.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cake-monotone">@cake-monotone</a> reviewed on 2025-04-02 07:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cake-monotone">@cake-monotone</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:1371 on 2025-04-02 07:37</div>
            <div class="timeline-body"><p>Hmm, that looks so weird... I'll look into it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cake-monotone">@cake-monotone</a> reviewed on 2025-04-02 07:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/cake-monotone">@cake-monotone</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:1371 on 2025-04-02 07:52</div>
            <div class="timeline-body"><p>Ahh, it was my mistake üò¢
<code>_NotImplementedType</code> exists in builtins.pyi regardless of the version, so it's not really related to #17032. I simply forgot to remove the if condition.
Thanks for catching that! I'll fix it soon.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:11:02 UTC
    </footer>
</body>
</html>
