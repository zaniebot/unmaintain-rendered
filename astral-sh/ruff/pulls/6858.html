<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avoid parsing other parts of a format specification if replacements are present - astral-sh/ruff #6858</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Avoid parsing other parts of a format specification if replacements are present</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6858">#6858</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2023-08-24 19:31
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>Closes #6767
Replaces https://github.com/astral-sh/ruff/pull/6773 (this cherry-picks some parts from there)
Alternative to the approach introduced in #6616 which added support for placeholders in format specifications while retaining parsing of other format specification parts.</p>
<p>The idea is that if there are placeholders in a format specification we will not attempt to glean semantic meaning from the other parts of the format specification we'll just extract all of the placeholders ignoring other characters. The dynamic content of placeholders can drastically change the meaning of the format specification in ways unknowable by static analysis. This change prevents false analysis and will ensure safety if we build other rules on top of this at the cost of missing detection of some bad specifications.</p>
<p>Minor note: I've use &quot;replacements&quot; and &quot;placeholders&quot; interchangeably but am trying to go with &quot;placeholder&quot; as I think it's a better term for the static analysis concept here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @zanieb on 2023-08-24 19:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-08-24 19:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_python_literal/src/format.rs</code>:954 on 2023-08-24 19:42</div>
            <div class="timeline-body"><p>Here's an example case where we no longer detect invalid format type specifications because there was a replacement earlier â€” this is a trade-off for generally safer analysis.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-08-24 19:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_python_literal/src/format.rs</code>:816 on 2023-08-24 19:42</div>
            <div class="timeline-body"><p>Here we lose all these additional fields which were correct in this test but <em>could</em> be wrong depending on the dynamic content of the placeholder.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @zanieb on 2023-08-24 19:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-24 19:55</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.04      5.3Â±0.09ms     7.6 MB/sec    1.00      5.2Â±0.06ms     7.9 MB/sec
formatter/numpy/ctypeslib.py               1.01   1055.0Â±3.85Âµs    15.8 MB/sec    1.00  1041.2Â±14.72Âµs    16.0 MB/sec
formatter/numpy/globals.py                 1.08    107.0Â±6.56Âµs    27.6 MB/sec    1.00     99.2Â±1.34Âµs    29.7 MB/sec
formatter/pydantic/types.py                1.09      2.1Â±0.14ms    11.9 MB/sec    1.00  1972.2Â±25.70Âµs    12.9 MB/sec
linter/all-rules/large/dataset.py          1.00     11.6Â±0.20ms     3.5 MB/sec    1.08     12.5Â±0.64ms     3.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.1Â±0.04ms     5.4 MB/sec    1.08      3.3Â±0.11ms     5.0 MB/sec
linter/all-rules/numpy/globals.py          1.00    448.1Â±4.94Âµs     6.6 MB/sec    1.02    458.4Â±1.65Âµs     6.4 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.1Â±0.09ms     4.2 MB/sec    1.05      6.4Â±0.10ms     4.0 MB/sec
linter/default-rules/large/dataset.py      1.00      6.1Â±0.07ms     6.7 MB/sec    1.05      6.4Â±0.11ms     6.4 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1356.8Â±15.71Âµs    12.3 MB/sec    1.03   1395.8Â±7.68Âµs    11.9 MB/sec
linter/default-rules/numpy/globals.py      1.01    163.6Â±0.59Âµs    18.0 MB/sec    1.00    161.8Â±2.24Âµs    18.2 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.9Â±0.02ms     8.9 MB/sec    1.02      2.9Â±0.08ms     8.8 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      5.3Â±0.11ms     7.7 MB/sec    1.00      5.3Â±0.17ms     7.7 MB/sec
formatter/numpy/ctypeslib.py               1.01  1029.8Â±32.42Âµs    16.2 MB/sec    1.00  1024.3Â±27.21Âµs    16.3 MB/sec
formatter/numpy/globals.py                 1.00     97.8Â±3.29Âµs    30.2 MB/sec    1.01     98.8Â±5.43Âµs    29.9 MB/sec
formatter/pydantic/types.py                1.00  1983.0Â±45.52Âµs    12.9 MB/sec    1.00  1982.5Â±57.70Âµs    12.9 MB/sec
linter/all-rules/large/dataset.py          1.00     12.6Â±0.16ms     3.2 MB/sec    1.01     12.7Â±0.20ms     3.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.5Â±0.05ms     4.8 MB/sec    1.01      3.5Â±0.09ms     4.8 MB/sec
linter/all-rules/numpy/globals.py          1.00   431.6Â±10.74Âµs     6.8 MB/sec    1.01    435.3Â±9.36Âµs     6.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.5Â±0.14ms     3.9 MB/sec    1.01      6.6Â±0.13ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.00      7.1Â±0.13ms     5.8 MB/sec    1.00      7.0Â±0.12ms     5.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1503.2Â±36.14Âµs    11.1 MB/sec    1.01  1517.2Â±43.22Âµs    11.0 MB/sec
linter/default-rules/numpy/globals.py      1.01    177.2Â±6.23Âµs    16.6 MB/sec    1.00    176.0Â±4.86Âµs    16.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.1Â±0.06ms     8.1 MB/sec    1.00      3.1Â±0.06ms     8.1 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_literal/src/format.rs</code>:360 on 2023-08-25 04:01</div>
            <div class="timeline-body"><p>Nit: I think you could now consider having <code>consume_all_placeholders</code> return a vector rather than taking <code>&amp;mut Vec</code> and returning text, since you won't use the remaining text if it returns anything.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_literal/src/format.rs</code>:353 on 2023-08-25 04:10</div>
            <div class="timeline-body"><p>Since you mentioned that this felt awkward to you in the prior PR, I tried to simplify it a little by using the text directly:</p>
<pre><code class="language-rust">/// Parses a format part within a format spec
fn parse_nested_placeholder(text: &amp;str) -&gt; Result&lt;Option&lt;(FormatPart, &amp;str)&gt;, FormatSpecError&gt; {
    match FormatString::parse_spec(text, AllowPlaceholderNesting::No) {
        // Not a nested placeholder, OK
        Err(FormatParseError::MissingStartBracket) =&gt; Ok(None),
        Err(err) =&gt; Err(FormatSpecError::InvalidPlaceholder(err)),
        Ok((format_part, text)) =&gt; Ok(Some((format_part, text))),
    }
}

/// Parse and consume all placeholders in a format spec
/// This will also consume any intermediate characters such as `x` and `y` in `&quot;x{foo}y{bar}z&quot;`
/// If no placeholders are present, the text will be returned unmodified.
fn consume_all_placeholders(mut text: &amp;str) -&gt; Result&lt;Vec&lt;FormatPart&gt;, FormatSpecError&gt; {
    let mut placeholders = vec![];
    while let Some(bracket) = text.find('{') {
        if let Some((format_part, rest)) = parse_nested_placeholder(&amp;text[bracket..])? {
            text = rest;
            placeholders.push(format_part);
        } else {
            text = &amp;text[bracket + 1..];
        }
    }
    Ok(placeholders)
}
</code></pre>
<p>Don't feel strongly, only a suggestion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_literal/src/format.rs</code>:358 on 2023-08-25 04:11</div>
            <div class="timeline-body"><p>Should we not run this loop &quot;for every <code>{</code>&quot;, rather than &quot;for every character, as long as there's a <code>{</code> somewhere later on in the string&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-08-25 04:11</div>
            <div class="timeline-body"><p>Looks great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-08-25 16:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_python_literal/src/format.rs</code>:358 on 2023-08-25 16:04</div>
            <div class="timeline-body"><p>Yeah that's true we're doing unnecessary calls to <code>parse_nested_placeholder</code> here and we should be able to scan forward to avoid that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-08-25 16:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_python_literal/src/format.rs</code>:353 on 2023-08-25 16:04</div>
            <div class="timeline-body"><p>I'll study this :) thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2023-08-25 16:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ruff_python_literal/src/format.rs</code>:360 on 2023-08-25 16:04</div>
            <div class="timeline-body"><p>ğŸ‘</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2023-08-25 16:28</div>
            <div class="timeline-body"><p>#6877 fixes CI</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @zanieb on 2023-08-25 17:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2023-08-25 17:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-25 17:42</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:59:48 UTC
    </footer>
</body>
</html>
