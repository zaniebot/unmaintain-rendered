<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Enforce specifying paths for mdtest code blocks in a separate preceding line - astral-sh/ruff #15890</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Enforce specifying paths for mdtest code blocks in a separate preceding line</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15890">#15890</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2025-02-02 23:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a></div>
            <div class="timeline-body">Summary
<p>Resolves #15695, rework of #15704.</p>
<p>This change modifies the Mdtests framework so that:</p>
<ul>
<li><p>Paths must now be specified in a separate preceding line:</p>
<pre><code>`a.py`:

```py
x = 1
```
</code></pre>
<p>If the path of a file conflicts with its <code>lang</code>, an error will be thrown.</p>
</li>
<li><p>Configs are no longer accepted. The pattern still take them into account, however, to avoid &quot;Unterminated code block&quot; errors.</p>
</li>
<li><p>Unnamed files are now assigned unique, <code>lang</code>-respecting paths automatically.</p>
</li>
</ul>
<p>Additionally, all legacy usages have been updated.</p>
Test Plan
<p>Unit tests and Markdown tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-02-02 23:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-02-02 23:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-02-02 23:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-02-02 23:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-02 23:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-02 23:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-02-02 23:58</div>
            <div class="timeline-body"><p>Removing unnecessary paths is a tedious task and thus not tackled in this PR. If anyone wants to do so, please, be my guest.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-03 09:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/README.md</code>:1 on 2025-02-03 09:06</div>
            <div class="timeline-body"><p>There is still a now-outdated reference to <code>path=…</code> in this README.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-03 09:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/src/parser.rs</code>:168 on 2025-02-03 09:20</div>
            <div class="timeline-body"><p>The mandatory colon looks like something that&#x27;s easy to miss. Should we make it optional in the pattern here, capture whether it&#x27;s present or not, and then show an error if it&#x27;s missing? Otherwise, if someone forgets to use one, it might be more difficult to debug what&#x27;s wrong.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-03 09:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/src/parser.rs</code>:381 on 2025-02-03 09:23</div>
            <div class="timeline-body"><p>Do we want an exception for <code>lang=text</code> here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-03 09:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/src/parser.rs</code>:382 on 2025-02-03 09:24</div>
            <div class="timeline-body"><p>Maybe</p>
<pre><code>                    &quot;File ending of test file path `{explicit_path}` does not match `lang={lang}` of code block&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-03 09:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/src/parser.rs</code>:394 on 2025-02-03 09:24</div>
            <div class="timeline-body"><p>Should we match on <code>&quot;py&quot;</code> explicitly, and show an error for unsupported extensions?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-03 09:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/src/parser.rs</code>:359 on 2025-02-03 09:27</div>
            <div class="timeline-body"><p>I misunderstood this message completely at first. I thought <code>toml</code>-configs would not be allowed anymore for some reason. Maybe something like:</p>
<pre><code>            return Err(anyhow::anyhow!(&quot;Trailing code-block metadata is not supported. Only the code block language can be specified.&quot;));
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-03 09:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/src/parser.rs</code>:855 on 2025-02-03 09:32</div>
            <div class="timeline-body"><p>Maybe we should give those autogenerated file names a more distinct name, and not just <code>test_#.py</code>? <code>test_1.py</code> is simple enough that someone might actually want to use it. Something like <code>mdtest_snippet_#.py</code> or <code>mdtest_{mangled_test_name}_#.py</code> would be much more unlikely to generate a clash, and we could forbid this pattern from being used in the explicit path name.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> requested changes on 2025-02-03 09:34</div>
            <div class="timeline-body"><p>Thank you! I think we can improve the error message for developers a bit, but otherwise this looks great.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-02-03 14:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/red_knot_test/src/parser.rs</code>:168 on 2025-02-03 14:56</div>
            <div class="timeline-body"><p>I thought it would be problematic if something like this were to be considered a named block:</p>
<pre><code>Lorem ipsum dolor sit amet consectetur adipiscing
`elit`  &lt;!-- Typo: No dot --&gt;

```python
x = 1
```
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-02-03 15:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/red_knot_test/README.md</code>:1 on 2025-02-03 15:00</div>
            <div class="timeline-body"><p>I wasn&#x27;t sure what to do with this. Maybe the entire section should be removed?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/lib.rs</code>:114 on 2025-02-03 15:00</div>
            <div class="timeline-body"><pre><code>                project_root.join(&amp;embedded.path)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-03 15:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/lib.rs</code>:112 on 2025-02-03 15:00</div>
            <div class="timeline-body"><p>I&#x27;m not a 100% sure if this works but maybe?</p>
<pre><code>                SystemPathBuf::from(&amp;embedded.path)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-02-03 15:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-02-03 15:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/red_knot_test/src/lib.rs</code>:112 on 2025-02-03 15:18</div>
            <div class="timeline-body"><p>Nope, this doesn&#x27;t compile. The other one does, though.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-03 19:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/README.md</code>:1 on 2025-02-03 19:01</div>
            <div class="timeline-body"><p>I don&#x27;t think we should remove the &quot;Asserting on full diagnostic output&quot; section. It&#x27;s something we still plan to do (see also: <a href="https://github.com/astral-sh/ruff/issues/15867">astral-sh/ruff#15867</a>). Maybe rephrase that section as (remove the part about incremental tests):</p>
<blockquote>
<p>By default, an <code>output</code> block will specify diagnostic output for the file <code>&lt;workspace-root&gt;/test.py</code>.
An <code>output</code> block can be prefixed by a <code>&lt;path&gt;:</code> label as usual, to explicitly specify the Python file for which it
asserts diagnostic output.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-03 19:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/src/parser.rs</code>:168 on 2025-02-03 19:05</div>
            <div class="timeline-body"><p>I think we should do something about that. That&#x27;s a disadvantage of specifying the path outside the code snippet. Someone might write something like:</p>
<pre><code>A long sentence that forces a line break .... this also works with
`int`:
```py
…
```
</code></pre>
<p>And it looks like we would currently treat this as being a code block for a file named <code>int</code>. I guess we could enforce two newlines before <code>&lt;path&gt;:</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-02-03 19:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/src/parser.rs</code>:168 on 2025-02-03 19:41</div>
            <div class="timeline-body"><p>Yes, I think requiring two consecutive newlines before the path would reduce the potential for error, without ruling out any formatting we would want to use; I don&#x27;t think we&#x27;d ever want the file path to be closely visually associated with the preceding line/paragraph.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-02-03 19:50</div>
            <div class="timeline-body"><p>Other than the change to require two newlines before the path, this looks good to me. Thank you @InSyncWithFoo !</p>
<p>It looks like this doesn&#x27;t implement @sharkdp &#x27;s suggestion from #15704 that consecutive unnamed code blocks would be merged into a single file. I like that idea, but I also think it&#x27;s probably better if we leave that as a separate change/improvement, rather than adding it to this PR. We could file an issue to track the idea?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_test/src/parser.rs</code>:297 on 2025-02-03 22:43</div>
            <div class="timeline-body"><p>I don&#x27;t see any test failures if this stays marked as <code>unreachable!()</code>, so I think I will revert this change? It seems better to catch unexpected cases faster.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-02-03 23:06</div>
            <div class="timeline-body"><p>Looks good! Thanks for all the thorough tests!</p>
<p>It looks to me like the updates to <code>README.md</code> need a bit of work still, I think it&#x27;ll be easiest if I just make some additional updates there and then merge.</p>
<p>There&#x27;s also one code change I commented inline that I think I will revert, unless there&#x27;s a reason for it that I&#x27;m not seeing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-02-03 23:14</div>
            <div class="timeline-body"><p>@sharkdp I will hold off on merging this since you still have a change-request on it; go ahead and merge if it looks OK to you?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-02-04 07:26</div>
            <div class="timeline-body"><p>Thank you very much!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-02-04 07:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-02-04 07:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-04 20:06</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:11:03 UTC
    </footer>
</body>
</html>
