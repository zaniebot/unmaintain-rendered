<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decouple `Diagnostic` from &quot;all violations&quot; enumeration - astral-sh/ruff #3352</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Decouple <code>Diagnostic</code> from &quot;all violations&quot; enumeration</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/3352">#3352</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-03-05 20:35
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">Summary
<p>Today, we capture all diagnostics in a <code>Diagnostic</code> struct. One of the fields of that struct is of type <code>DiagnosticKind</code>, which is a struct generated by the <code>register_rules!</code> proc macro, alongside <code>Rule</code>. Like <code>Rule</code>, <code>DiagnosticKind</code> is an enum over all diagnostic variants. The net effect is that every diagnostic depends on every other diagnostic, which makes it difficult for us to break up the rule-implementing modules, since they <em>all</em> rely on one another.</p>
<p>This PR modifies the object hierarchy such that <code>DiagnosticKind</code> is no longer an enum over all diagnostics. Instead, it&#x27;s a dumb struct, like:</p>
<pre><code>#[derive(Debug, PartialEq, Eq, Serialize, Deserialize)]
pub struct DiagnosticKind {
    /// The identifier of the corresponding [`Rule`].
    pub name: String,
    /// The message body to display to the user, to explain the diagnostic.
    pub body: String,
    /// The message to display to the user, to explain the suggested fix.
    pub commit: Option&lt;String&gt;,
    /// Whether the diagnostic is automatically fixable.
    pub fixable: bool,
}
</code></pre>
<p>...meaning we can pass it around anywhere, it depends on nothing, etc.</p>
<p>Notably, before, <code>DiagnosticKind</code> implemented methods that created <code>body</code>, <code>commit</code>, etc. Now, they&#x27;re eagerly evaluated as fields on the struct. Similarly, all of our test fixtures will change, as instead of containing the denormalized <code>DiagnosticKind</code>, they now contain the evaluated <code>DiagnosticKind</code> with all of its fields. (I&#x27;ve intentionally avoided checking in more than one of these, to make the PR more readable, so tests will fail for now.)</p>
<p>The <code>Rule</code> enum is unchanged. Instead of implementing a <code>.rule()</code> method on <code>DiagnosticKind</code>, we implement <code>From&lt;&amp;DiagnosticKind&gt; for &amp;&#x27;static Rule</code>, and convert via a stringly-typed match statement that&#x27;s generated as part of the proc macro. It&#x27;s not statically enforced, but it <em>is</em> automated. (Perhaps there&#x27;s a way to enforce it statically? But the whole point is that <code>DiagnosticKind</code> can&#x27;t depend on &quot;all rules&quot;, so that may be difficult.)</p>
<p>We may want to consider the object hierarchy more holistically, but the net effect of this PR is that we could in theory start decomposing <code>ruff</code> into smaller crates by breaking up this inter-dependency.</p>
<p>In my preliminary testing, the CPython benchmarks are unchanged.</p>
Test Plan
<p><code>cargo test --lib</code> passes locally, though invalidates <em>every</em> snapshot in roughly the same way -- the objects now look like this:</p>
<pre><code>+---
+source: crates/ruff/src/rules/flake8_simplify/mod.rs
+assertion_line: 49
+expression: diagnostics
+---
+- kind:
+    body: &quot;Multiple `isinstance` calls for `a`, merge into a single call&quot;
+    fixable: true
+    commit: &quot;Merge `isinstance` calls for `a`&quot;
+    rule: DuplicateIsinstanceCall
+  location:
+    row: 1
+    column: 3
+  end_location:
+    row: 1
+    column: 45
+  fix:
+    content: &quot;isinstance(a, (int, float))&quot;
+    location:
+      row: 1
+      column: 3
+    end_location:
+      row: 1
+      column: 45
+  parent: ~
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-05 20:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-05 20:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-05 20:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/registry.rs</code>:888 on 2023-03-05 20:35</div>
            <div class="timeline-body"><p>As an aside, this might be better-named <code>DiagnosticMeta</code> now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-05 20:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/registry.rs</code>:894 on 2023-03-05 20:36</div>
            <div class="timeline-body"><p>As an aside, this might be better-named <code>suggestion</code> or something. <code>commit</code> is bad (I think I came up with it).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_annotations/rules.rs</code>:669 on 2023-03-05 20:36</div>
            <div class="timeline-body"><p>We could shorthand this by either (1) implementing more <code>From</code> variants (like <code>impl From&lt;&amp;Diagnostic&gt; for &amp;&#x27;static Rule</code>), or (2) letting <code>checker.patch</code> take <code>Diagnostic</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-05 20:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-05 20:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/registry.rs</code>:890 on 2023-03-05 20:38</div>
            <div class="timeline-body"><p>I kind of wish there were <code>&amp;&#x27;static str</code>, but it causes problems with <code>Deserialize</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-05 20:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_macros/src/register_rules.rs</code>:67 on 2023-03-05 20:38</div>
            <div class="timeline-body"><p>Goodbye, no longer an enum...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-05 20:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/pyupgrade/rules/unnecessary_future_import.rs</code>:87 on 2023-03-05 20:38</div>
            <div class="timeline-body"><p>Very mechanical.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-05 21:19</div>
            <div class="timeline-body"><p>Confusingly these failing CI checks are running on an older revision?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-03-06 10:06</div>
            <div class="timeline-body"><p>Can&#x27;t say too much about the proc macro code, but otherwise looks good</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-06 13:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_simplify/snapshots/ruff__rules__flake8_simplify__tests__SIM101_SIM101.py.snap.new</code>:10 on 2023-03-06 13:49</div>
            <div class="timeline-body"><p>I don&#x27;t know if there&#x27;s a way for us to avoid denormalizing the rule here. Previously, this would&#x27;ve been a <code>DuplicateIsinstanceCall</code> struct with its fields, rather than the materialized message, which is arguably better than what we have here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-06 13:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_simplify/snapshots/ruff__rules__flake8_simplify__tests__SIM101_SIM101.py.snap.new</code>:10 on 2023-03-06 13:57</div>
            <div class="timeline-body"><p>More succinctly, there isn&#x27;t a way to go from <code>DiagnosticKind</code> back to the originating <code>Violation</code> struct. Instead, you can only go from <code>DiagnosticKind</code> to <code>Rule</code> (which is a singleton object, not something that contains the relevant fields).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_annotations/rules.rs</code>:669 on 2023-03-06 14:00</div>
            <div class="timeline-body"><p>@konstin - Do you know of any pattern to make these conversions more streamlined? Or does this look right to you?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-06 14:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff/src/rules/flake8_annotations/rules.rs</code>:669 on 2023-03-07 10:56</div>
            <div class="timeline-body"><p>i think <code>From</code> is the wrong trait for the kind of trick we want to do. i&#x27;d actually go with a <code>.rule()</code> on Diagnostic:</p>
<pre><code>impl Diagnostic {
    pub fn rule(&amp;self) -&gt; &amp;&#x27;static Rule {
        (&amp;self.kind).into()
    }
}
</code></pre>
<p>otherwise this also works <code>diagnostic.kind.rule()</code></p>
<pre><code>        impl DiagnosticKind {
            pub fn rule(&amp;self) -&gt; &amp;&#x27;static Rule {
                match self.rule.as_str() {
                    #from_impls_for_diagnostic_kind
                    _ =&gt; unreachable!(&quot;invalid rule name: {}&quot;, self.rule),
                }
            }
        }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-03-07 10:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff/src/rules/pandas_vet/mod.rs</code>:50 on 2023-03-07 10:58</div>
            <div class="timeline-body"><p>is there are reason for the fully qualified notation here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-03-07 10:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-07 14:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_annotations/rules.rs</code>:669 on 2023-03-07 14:56</div>
            <div class="timeline-body"><p>The issue is that we need to keep <code>Diagnostic</code> and <code>DiagnosticKind</code> separate from <code>Rule</code> -- they can&#x27;t depend on <code>Rule</code>, otherwise all diagnostic implementations end up depending on all other implementations.</p>
<p>Specifically, <code>Rule</code> will end up being defined in the <code>ruff</code> crate, while <code>Diagnostic</code> and <code>DiagnosticKind</code> will probably be defined in some kind of <code>ruff_linter_base_types</code> crate (not the actual name, just an example).</p>
<p>Perhaps we could have an <code>AsRule</code> trait that we implement in the <code>ruff</code> crate for this conversion?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-08 03:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_annotations/rules.rs</code>:669 on 2023-03-08 03:07</div>
            <div class="timeline-body"><p>Yeah, maybe a trait is the way to go here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_annotations/rules.rs</code>:669 on 2023-03-08 03:10</div>
            <div class="timeline-body"><p>Let me push a variant that uses that approach. It&#x27;s actually far fewer changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-08 03:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-08 04:30</div>
            <div class="timeline-body"><p>Ok, went ahead and regenerated the fixtures. As mentioned above, the fixtures now contain the denormalized <code>DiagnosticKind</code> data (i.e., the full message, rather than the struct type with its fields).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/lib_wasm.rs</code>:217 on 2023-03-08 09:12</div>
            <div class="timeline-body"><p>Cloning shouldn&#x27;t be necessary here (<code>message</code> isn&#x27;t borrowed). You may need to destruct <code>body</code> and <code>commit</code> in case the borrow checker isn&#x27;t clever enough to understand that the moves are non-overlapping.</p>
<pre><code>            message: message.kind.body,
            location: message.location,
            end_location: message.end_location,
            fix: message.fix.map(|fix| ExpandedFix {
                content: fix.content,
                message: message.kind.commit,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/registry.rs</code>:888 on 2023-03-08 09:21</div>
            <div class="timeline-body"><p>I&#x27;m not sure on the name <code>DiagnosticMeta</code> but to me it seems that this struct is an instantiated (or serialized) diagnostic. In java, you would probably call this a <code>DiagnosticDto</code> :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-03-08 09:25</div>
            <div class="timeline-body"><p>LGTM. At least as far as I can tell. I&#x27;m still trying to get my head around how lint rules and diagnostics work. But this should solve our immediate needs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-03-08 17:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/registry.rs</code>:888 on 2023-03-08 17:46</div>
            <div class="timeline-body"><p>I don&#x27;t think <code>DiagnosticMeta</code> is right either, I almost PR&#x27;d that but then I realized it was off too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-08 17:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-03-08 17:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-03-08 17:51</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:52:38 UTC
    </footer>
</body>
</html>
