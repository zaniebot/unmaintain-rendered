<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix(PERF102): earlier binding causes false positive when analyzing possible incorrect dict iterator - astral-sh/ruff #9978</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix(PERF102): earlier binding causes false positive when analyzing possible incorrect dict iterator</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/9978">#9978</a>
        opened by <a href="https://github.com/mikeleppane">@mikeleppane</a>
        on 2024-02-13 20:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/mikeleppane">@mikeleppane</a> on 2024-02-13 20:53</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This review contains a fix for a false positive scenario in <code>incorrect dict iterator</code> rule <a href="https://docs.astral.sh/ruff/rules/incorrect-dict-iterator/">PERF102</a>
The problem is that if the current scope contains a binding before <code>For Statement</code> (same binding as loop variables) then the rule considers that as a used variable. This causes a false positive scenario. It matters whether references are bound to a loop variable in for statement and after it.</p>
<p>See: https://github.com/astral-sh/ruff/issues/8786</p>
<h2>Test Plan</h2>
<pre><code class="language-bash">cargo test
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Fix(PERF102): earlier binding caused false positive when analyzing possible incorrect dict iterator" to "Fix(PERF102): earlier binding causes false positive when analyzing possible incorrect dict iterator" by @mikeleppane on 2024-02-13 21:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-02-13 21:07</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+10 -0 violations, +0 -0 fixes in 4 projects; 39 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/airflow">apache/airflow</a> (+3 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --no-preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/apache/airflow/blob/3d35fe602ce4c033e47dbe3a4d67f673a14f48d9/airflow/providers/google/cloud/hooks/bigquery.py#L3190'>airflow/providers/google/cloud/hooks/bigquery.py:3190:17:</a> PERF102 When using only the keys of a dict use the `keys()` method
+ <a href='https://github.com/apache/airflow/blob/3d35fe602ce4c033e47dbe3a4d67f673a14f48d9/airflow/providers/google/cloud/transfers/gcs_to_bigquery.py#L716'>airflow/providers/google/cloud/transfers/gcs_to_bigquery.py:716:21:</a> PERF102 When using only the keys of a dict use the `keys()` method
+ <a href='https://github.com/apache/airflow/blob/3d35fe602ce4c033e47dbe3a4d67f673a14f48d9/airflow/www/views.py#L2120'>airflow/www/views.py:2120:25:</a> PERF102 When using only the keys of a dict use the `keys()` method
</pre>

</p>
</details>
<details><summary><a href="https://github.com/bokeh/bokeh">bokeh/bokeh</a> (+2 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --no-preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/core/has_props.py#L732'>src/bokeh/core/has_props.py:732:21:</a> PERF102 When using only the keys of a dict use the `keys()` method
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/embed/util.py#L270'>src/bokeh/embed/util.py:270:36:</a> PERF102 When using only the keys of a dict use the `keys()` method
</pre>

</p>
</details>
<details><summary><a href="https://github.com/rotki/rotki">rotki/rotki</a> (+4 -0 violations, +0 -0 fixes)</summary>
<p>

<pre>
+ <a href='https://github.com/rotki/rotki/blob/6ee9854254b72a52c03b50b123d265682aecc448/rotkehlchen/tests/api/test_settings.py#L234'>rotkehlchen/tests/api/test_settings.py:234:27:</a> PERF102 When using only the keys of a dict use the `keys()` method
+ <a href='https://github.com/rotki/rotki/blob/6ee9854254b72a52c03b50b123d265682aecc448/rotkehlchen/tests/api/test_settings.py#L244'>rotkehlchen/tests/api/test_settings.py:244:27:</a> PERF102 When using only the keys of a dict use the `keys()` method
+ <a href='https://github.com/rotki/rotki/blob/6ee9854254b72a52c03b50b123d265682aecc448/rotkehlchen/tests/utils/blockchain.py#L457'>rotkehlchen/tests/utils/blockchain.py:457:51:</a> PERF102 When using only the keys of a dict use the `keys()` method
+ <a href='https://github.com/rotki/rotki/blob/6ee9854254b72a52c03b50b123d265682aecc448/rotkehlchen/tests/utils/blockchain.py#L491'>rotkehlchen/tests/utils/blockchain.py:491:47:</a> PERF102 When using only the keys of a dict use the `keys()` method
</pre>

</p>
</details>
<details><summary><a href="https://github.com/zulip/zulip">zulip/zulip</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --no-preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/zulip/zulip/blob/e246db6709b9edf73d62204c8e6fd6469f3ee15f/zerver/migrations/0221_subscription_notifications_data_migration.py#L47'>zerver/migrations/0221_subscription_notifications_data_migration.py:47:48:</a> PERF102 When using only the keys of a dict use the `keys()` method
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PERF102 | 10 | 10 | 0 | 0 | 0 |</p>
</p>
</details>

<h3>Linter (preview)</h3>
<p>ℹ️ ecosystem check <strong>detected linter changes</strong>. (+10 -0 violations, +0 -0 fixes in 4 projects; 39 projects unchanged)</p>
<details><summary><a href="https://github.com/apache/airflow">apache/airflow</a> (+3 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/apache/airflow/blob/3d35fe602ce4c033e47dbe3a4d67f673a14f48d9/airflow/providers/google/cloud/hooks/bigquery.py#L3190'>airflow/providers/google/cloud/hooks/bigquery.py:3190:17:</a> PERF102 When using only the keys of a dict use the `keys()` method
+ <a href='https://github.com/apache/airflow/blob/3d35fe602ce4c033e47dbe3a4d67f673a14f48d9/airflow/providers/google/cloud/transfers/gcs_to_bigquery.py#L716'>airflow/providers/google/cloud/transfers/gcs_to_bigquery.py:716:21:</a> PERF102 When using only the keys of a dict use the `keys()` method
+ <a href='https://github.com/apache/airflow/blob/3d35fe602ce4c033e47dbe3a4d67f673a14f48d9/airflow/www/views.py#L2120'>airflow/www/views.py:2120:25:</a> PERF102 When using only the keys of a dict use the `keys()` method
</pre>

</p>
</details>
<details><summary><a href="https://github.com/bokeh/bokeh">bokeh/bokeh</a> (+2 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/core/has_props.py#L732'>src/bokeh/core/has_props.py:732:21:</a> PERF102 When using only the keys of a dict use the `keys()` method
+ <a href='https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/embed/util.py#L270'>src/bokeh/embed/util.py:270:36:</a> PERF102 When using only the keys of a dict use the `keys()` method
</pre>

</p>
</details>
<details><summary><a href="https://github.com/rotki/rotki">rotki/rotki</a> (+4 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/rotki/rotki/blob/6ee9854254b72a52c03b50b123d265682aecc448/rotkehlchen/tests/api/test_settings.py#L234'>rotkehlchen/tests/api/test_settings.py:234:27:</a> PERF102 When using only the keys of a dict use the `keys()` method
+ <a href='https://github.com/rotki/rotki/blob/6ee9854254b72a52c03b50b123d265682aecc448/rotkehlchen/tests/api/test_settings.py#L244'>rotkehlchen/tests/api/test_settings.py:244:27:</a> PERF102 When using only the keys of a dict use the `keys()` method
+ <a href='https://github.com/rotki/rotki/blob/6ee9854254b72a52c03b50b123d265682aecc448/rotkehlchen/tests/utils/blockchain.py#L457'>rotkehlchen/tests/utils/blockchain.py:457:51:</a> PERF102 When using only the keys of a dict use the `keys()` method
+ <a href='https://github.com/rotki/rotki/blob/6ee9854254b72a52c03b50b123d265682aecc448/rotkehlchen/tests/utils/blockchain.py#L491'>rotkehlchen/tests/utils/blockchain.py:491:47:</a> PERF102 When using only the keys of a dict use the `keys()` method
</pre>

</p>
</details>
<details><summary><a href="https://github.com/zulip/zulip">zulip/zulip</a> (+1 -0 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --output-format concise --preview --select ALL</pre>
</p>
<p>

<pre>
+ <a href='https://github.com/zulip/zulip/blob/e246db6709b9edf73d62204c8e6fd6469f3ee15f/zerver/migrations/0221_subscription_notifications_data_migration.py#L47'>zerver/migrations/0221_subscription_notifications_data_migration.py:47:48:</a> PERF102 When using only the keys of a dict use the `keys()` method
</pre>

</p>
</details>
<details><summary>Changes by rule (1 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| PERF102 | 10 | 10 | 0 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mikeleppane">@mikeleppane</a> on 2024-02-13 21:19</div>
            <div class="timeline-body"><p>Hmm...some false positives from ecosystem tests. I need to investigate...</p>
<p>Update: I now know what's the issue. I need to refactor the code to properly tackle the issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @mikeleppane on 2024-02-14 08:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @mikeleppane on 2024-02-15 07:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-02-15 07:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mikeleppane">@mikeleppane</a> on 2024-02-15 13:17</div>
            <div class="timeline-body"><p>@dhruvmanila Question:
If you have the following code:</p>
<pre><code class="language-python">def foo():
    for key, value in some_dict.items():
        ...

    for key, value in some_dict.items():
        ...
</code></pre>
<p>What's the best way to get all the child statements of foo func when analyzing the first <code>ForStmt</code>? Or, put it differently, get all statements from the parent/global scope. So, in this case, those would be the two <code>ForStmt</code>s.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-02-16 07:19</div>
            <div class="timeline-body"><p>I believe you can use the semantic model to traverse up the tree until you reach a function definition and then you can get the body of the function which would contain all of the statements.</p>
<p>So, the <code>current_statements</code> would return an iterator over all the statements in the current hierarchy, starting from the first <code>for</code> loop to the function definition:</p>
<p>https://github.com/astral-sh/ruff/blob/fe79798c12b4771cee0b0c59964ad7bd751c3779/crates/ruff_python_semantic/src/model.rs#L894-L901</p>
<p>@mikeleppane Does this help?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mikeleppane">@mikeleppane</a> on 2024-02-16 11:22</div>
            <div class="timeline-body"><blockquote>
<p>I believe you can use the semantic model to traverse up the tree until you reach a function definition and then you can get the body of the function which would contain all of the statements.</p>
<p>So, the <code>current_statements</code> would return an iterator over all the statements in the current hierarchy, starting from the first <code>for</code> loop to the function definition:</p>
<p>https://github.com/astral-sh/ruff/blob/fe79798c12b4771cee0b0c59964ad7bd751c3779/crates/ruff_python_semantic/src/model.rs#L894-L901</p>
<p>@mikeleppane Does this help?</p>
</blockquote>
<p>Yeah, I could use that. Thanks! Originally, I thought that there might be some short-cut to get those required stmts, but this will do it.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 22:58:18 UTC
    </footer>
</body>
</html>
