<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recover from unexpected token at end of expr - astral-sh/ruff #10981</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Recover from unexpected token at end of expr</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10981">#10981</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-04-16 18:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This fixes a bug in the parser when <code>Mode::Expression</code> is used where the parser didn't recover from unexpected token after the expression.</p>
<p>The current solution isn't ideal as the parser will drop all the remaining tokens after the initial expression has been parsed. This is to avoid panicking especially in the context of forward annotation like:</p>
<pre><code class="language-python">x: Literal[&quot;foo&quot;, &quot;bar baz&quot;]
</code></pre>
<p>Here, the parser is being given the <code>bar baz</code> as the source to be parsed using <code>Mode::Expression</code>. The parser will parse <code>bar</code> as a name expression and then stop because the expression ends there. But, it seems like there's more tokens remaining. This specific case could potentially be recovered by using a <code>ExprTuple</code> and raising a &quot;missing comma&quot; error but I've avoided that complexity for now.</p>
<h2>Test Plan</h2>
<p>Add new test cases for <code>Mode::Expression</code> and verified the snapshots.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dhruvmanila on 2024-04-16 18:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by @dhruvmanila on 2024-04-16 18:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2024-04-16 18:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-04-16 18:57</div>
            <div class="timeline-body"><p>The way I solved this in RomeJS is by what you describe. It parses an array expression. You could also look at how TypeScript's parseExpression recovers. But I'm okay doing this in a follow up</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-04-16 18:57</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2024-04-16 19:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-04-16 19:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-16 19:01</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:03:50 UTC
    </footer>
</body>
</html>
