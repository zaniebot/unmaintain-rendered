```yaml
number: 7664
title: "Add `cell` field to JSON output format"
type: pull_request
state: merged
author: dhruvmanila
labels:
  - linter
assignees: []
merged: true
base: main
head: dhruv/cell-idx-json-output
created_at: 2023-09-26T06:25:48Z
updated_at: 2023-10-13T01:12:27Z
url: https://github.com/astral-sh/ruff/pull/7664
synced_at: 2026-01-12T15:55:24Z
```

# Add `cell` field to JSON output format

---

_@dhruvmanila_

## Summary

This PR adds a new `cell` field to the JSON output format which indicates the Notebook cell this diagnostic (and fix) belongs to. It also updates the location for the diagnostic and fixes as per the `NotebookIndex`. It will be used in the VSCode extension to display the diagnostic in the correct cell.

The diagnostic and edit start and end source locations are translated for the notebook as per the `NotebookIndex`. The end source location for an edit needs some special handling.

### Edit end location

To understand this, the following context is required:

1. Visible lines in Jupyter Notebook vs JSON array strings: The newline is part of the string in the JSON format. This means that if there are 3 visible lines in a cell where the last line is empty then the JSON would contain 2 strings in the source array, both ending with a newline:

**JSON format:**
```json
[
	"# first line\n",
	"# second line\n",
]
```

**Notebook view:**
```python
1 # first line
2 # second line
3
```

2. If an edit needs to remove an entire line including the newline, then the end location would be the start of the next row.

To remove a statement in the following code:
```python
import os
```

The edit would be:
```
start: row 1, col 1
end: row 2, col 1
```

Now, here's where the problem lies. The notebook index doesn't have any information for row 2 because it doesn't exists in the actual notebook. The newline was added by Ruff to concatenate the source code and it's removed before writing back. But, the edit is computed looking at that newline.

This means that while translating the end location for an edit belong to a Notebook, we need to check if both the start and end location belongs to the same cell. If not, then the end location should be the first character of the next row and if so, translate that back to the last character of the previous row. Taking the above example, the translated location for Notebook would be:
```
start: row 1, col 1
end: row 1, col 10
```

## Test Plan

Add test cases for notebook output in the JSON format and update existing snapshots.

---

_Comment by @dhruvmanila on 2023-09-26 06:25_

Current dependencies on/for this PR:
* main
  * **PR #7921** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7921" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7925** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7925" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #7664** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7664" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  üëà

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7664?utm_source=stack-comment).

---

_Comment by @codspeed-hq[bot] on 2023-09-26 06:40_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/dhruv/cell-idx-json-output)

### Merging #7664 will **not alter performance**

<sub>Comparing <code>dhruv/cell-idx-json-output</code> (7aca63a) with <code>main</code> (1e184e6)</sub>



### Summary

`‚úÖ 25` untouched benchmarks






---

_Label `linter` added by @dhruvmanila on 2023-10-12 04:16_

---

_Marked ready for review by @dhruvmanila on 2023-10-12 04:17_

---

_Review requested from @charliermarsh by @dhruvmanila on 2023-10-12 04:17_

---

_Review requested from @konstin by @dhruvmanila on 2023-10-12 04:17_

---

_Comment by @github-actions[bot] on 2023-10-12 04:32_

## PR Check Results
### Ecosystem
‚ÑπÔ∏è ecosystem check **detected changes**. (+6, -6, 0 error(s))

<details><summary>airflow (+4, -4)</summary>
<p>

<pre>
- [*] 16066 fixable with the `--fix` option (6343 hidden fixes can be enabled with the `--unsafe-fixes` option).
+ [*] 16069 fixable with the `--fix` option (6343 hidden fixes can be enabled with the `--unsafe-fixes` option).
- <a href='https://github.com/apache/airflow/blob/1f63199351efe9a240c5ae07ce31b79fb0353d64/airflow/providers/google/cloud/hooks/bigquery.py#L1580'>airflow/providers/google/cloud/hooks/bigquery.py:1580:35:</a> PYI055 Multiple `type` members in a union. Combine them into one, e.g., `type[CopyJob | QueryJob | LoadJob | ExtractJob]`.
+ <a href='https://github.com/apache/airflow/blob/1f63199351efe9a240c5ae07ce31b79fb0353d64/airflow/providers/google/cloud/hooks/bigquery.py#L1580'>airflow/providers/google/cloud/hooks/bigquery.py:1580:35:</a> PYI055 [*] Multiple `type` members in a union. Combine them into one, e.g., `type[CopyJob | QueryJob | LoadJob | ExtractJob]`.
- <a href='https://github.com/apache/airflow/blob/1f63199351efe9a240c5ae07ce31b79fb0353d64/airflow/providers/google/cloud/hooks/bigquery.py#L1587'>airflow/providers/google/cloud/hooks/bigquery.py:1587:14:</a> PYI055 Multiple `type` members in a union. Combine them into one, e.g., `type[CopyJob | QueryJob | LoadJob | ExtractJob]`.
+ <a href='https://github.com/apache/airflow/blob/1f63199351efe9a240c5ae07ce31b79fb0353d64/airflow/providers/google/cloud/hooks/bigquery.py#L1587'>airflow/providers/google/cloud/hooks/bigquery.py:1587:14:</a> PYI055 [*] Multiple `type` members in a union. Combine them into one, e.g., `type[CopyJob | QueryJob | LoadJob | ExtractJob]`.
- <a href='https://github.com/apache/airflow/blob/1f63199351efe9a240c5ae07ce31b79fb0353d64/airflow/providers/smtp/hooks/smtp.py#L103'>airflow/providers/smtp/hooks/smtp.py:103:15:</a> PYI055 Multiple `type` members in a union. Combine them into one, e.g., `type[smtplib.SMTP_SSL | smtplib.SMTP]`.
+ <a href='https://github.com/apache/airflow/blob/1f63199351efe9a240c5ae07ce31b79fb0353d64/airflow/providers/smtp/hooks/smtp.py#L103'>airflow/providers/smtp/hooks/smtp.py:103:15:</a> PYI055 [*] Multiple `type` members in a union. Combine them into one, e.g., `type[smtplib.SMTP_SSL | smtplib.SMTP]`.
</pre>

</p>
</details>
<details><summary>bokeh (+2, -2)</summary>
<p>

<pre>
- [*] 17800 fixable with the `--fix` option (4727 hidden fixes can be enabled with the `--unsafe-fixes` option).
+ [*] 17801 fixable with the `--fix` option (4727 hidden fixes can be enabled with the `--unsafe-fixes` option).
- <a href='https://github.com/bokeh/bokeh/blob/8fa062ac8938a6c064caa2dd50be7013f04fa2f7/src/bokeh/core/validation/decorators.py#L67'>src/bokeh/core/validation/decorators.py:67:13:</a> PYI055 Multiple `type` members in a union. Combine them into one, e.g., `type[Error | Warning]`.
+ <a href='https://github.com/bokeh/bokeh/blob/8fa062ac8938a6c064caa2dd50be7013f04fa2f7/src/bokeh/core/validation/decorators.py#L67'>src/bokeh/core/validation/decorators.py:67:13:</a> PYI055 [*] Multiple `type` members in a union. Combine them into one, e.g., `type[Error | Warning]`.
</pre>

</p>
</details>
Rules changed: 1

| Rule | Changes | Additions | Removals |
| ---- | ------- | --------- | -------- |
| PYI055 | 8 | 4 | 4 |



---

_Review comment by @konstin on `crates/ruff_notebook/src/index.rs`:40 on 2023-10-12 09:29_

```suggestion
    pub fn translate_location(&self, source_location: &SourceLocation) -> SourceLocation {
```

---

_@konstin approved on 2023-10-12 09:29_

---

_Merged by @dhruvmanila on 2023-10-13 01:06_

---

_Closed by @dhruvmanila on 2023-10-13 01:06_

---

_Branch deleted on 2023-10-13 01:06_

---
