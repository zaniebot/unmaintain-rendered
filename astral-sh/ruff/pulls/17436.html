<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Initial tests for protocols - astral-sh/ruff #17436</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Initial tests for protocols</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17436">#17436</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-04-16 21:13
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-16 21:13</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>There are still many tests missing from this test suite (see the long TODO list at the bottom of this file). But this PR already adds around 1,000 lines of tests, which feels like enough for now: I'd like to actually start implementing some of this stuff ðŸ˜„</p>
<p>TODO: figure out how to make pre-commit happy...</p>
<h2>Test Plan</h2>
<p>this pr is all tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2025-04-16 21:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-04-16 21:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-04-16 21:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-04-16 21:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-16 21:15</div>
            <div class="timeline-body"><p>Rendered version: https://github.com/astral-sh/ruff/blob/alex/protocol-tests/crates/red_knot_python_semantic/resources/mdtest/protocols.md</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-16 21:16</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-16 21:16</div>
            <div class="timeline-body"><p>we really need to figure out why we aren't getting any red-knot tests run on PRs that only touch MarkDown files right now ðŸ˜„</p>
<p>but I ran the new tests locally and I promise that they all pass!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @AlexWaygood on 2025-04-16 21:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/protocols.md</code>:389 on 2025-04-17 00:39</div>
            <div class="timeline-body"><p>These should be TODOs as well</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/protocols.md</code>:383 on 2025-04-17 00:41</div>
            <div class="timeline-body"><p>I think there should be TODO comments here?</p>
<p>There are enough cases of this below that maybe it's intentional to assume any <code>static-assert-error</code> is implicitly a TODO? I don't think I like this, though; too subtle and confusing, when there are other diagnostics that are correct and not TODOs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/protocols.md</code>:451 on 2025-04-17 00:41</div>
            <div class="timeline-body"><p>TODO comments?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/protocols.md</code>:485 on 2025-04-17 00:42</div>
            <div class="timeline-body"><p>TODO comments?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/protocols.md</code>:538 on 2025-04-17 00:43</div>
            <div class="timeline-body"><p>TODO comments? ...I think at this point I'll stop commenting on these, but there are more below...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/protocols.md</code>:515 on 2025-04-17 00:45</div>
            <div class="timeline-body"><p>The code block below seems to be missing any demonstration of this, it only shows that they are assignable/subtype of <code>object</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/protocols.md</code>:597 on 2025-04-17 00:47</div>
            <div class="timeline-body"><p>I think it would be better to use a name here that doesn't look like it's <code>typing.Final</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/protocols.md</code>:588 on 2025-04-17 00:49</div>
            <div class="timeline-body"><p>If <code>Y</code> does provide methods or attributes that are part of <code>X</code>s interface, and the types of those are such that no subtype of <code>Y</code> could (respecting Liskov) possibly satisfy <code>X</code>s interface, we can still consider them disjoint.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-04-17 00:53</div>
            <div class="timeline-body"><p>Fantastically thorough!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-17 10:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/protocols.md</code>:383 on 2025-04-17 10:30</div>
            <div class="timeline-body"><p>Hah, yes, sorry about that. I got lazy and thought I might be able to get away without explicit TODO comments for <code>static-assert-error</code>s in this test suite, since there's no reason you'd have a <code>static-assert-error</code> in this Markdown file if it wasn't something that you wanted to pass eventually.</p>
<p>I'll add the TODOs :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-17 10:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/protocols.md</code>:588 on 2025-04-17 10:39</div>
            <div class="timeline-body"><p>Indeed! This is something I wanted to discuss; thanks for bringing it up. I seem to remember us having this conversation about nominal types on one of @sharkdp's PRs (I can't easily find the reference), and IIRC you were opposed to applying the same principle there. E.g. we could consider <code>A</code> and <code>B</code> here disjoint, because they both have a covariant (read-only) <code>x</code> attribute, but the type of <code>A.x</code> is disjoint from <code>B.x</code>. There can be no possible Liskov-compliant subclass of both <code>A</code> and <code>B</code> here; they are definitely disjoint:</p>
<pre><code class="language-py">class A:
    @property
    def x(self) -&gt; bool:
        return True

class B:
    @property
    def x(self) -&gt; str:
        return &quot;x&quot;
</code></pre>
<p>Is it justifiable to apply this principle to structural types but not nominal types? It feels inconsistent to me</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-17 10:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/protocols.md</code>:515 on 2025-04-17 10:46</div>
            <div class="timeline-body"><p>oops, thanks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-17 11:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/protocols.md</code>:588 on 2025-04-17 11:35</div>
            <div class="timeline-body"><p>(Going to land the PR for now as I don't think my current language precludes the idea that we might infer other pairs of protocols as disjoint in the future. Happy to revisit it later!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-04-17 11:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-04-17 11:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-17 11:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-04-17 12:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/protocols.md</code>:588 on 2025-04-17 12:56</div>
            <div class="timeline-body"><p>I do think there might be reasons to consider it for structural types and not nominal types, but I also think it's not high priority and fine to defer it either way, so let's just not worry about it for now.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:33:28 UTC
    </footer>
</body>
</html>
