<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] While loop modeling cleanup - astral-sh/ruff #18994</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] While loop modeling cleanup</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18994">#18994</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-06-27 19:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-06-27 19:24</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>I found the previous code here very confusing, and it also did some unnecessary work. Hopefully this is a bit easier to understand.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-06-27 19:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-06-27 19:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @sharkdp on 2025-06-27 19:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @sharkdp on 2025-06-27 19:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/semantic_index/builder.rs</code>:1543 on 2025-06-27 19:27</div>
            <div class="timeline-body"><p>I think we were missing a negated reachability constraint here before.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-06-27 19:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-27 19:28</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">bandersnatch (https://github.com/pypa/bandersnatch)
- TOTAL MEMORY USAGE: ~88MB
+ TOTAL MEMORY USAGE: ~80MB

vision (https://github.com/pytorch/vision)
-     memo fields = ~304MB
+     memo fields = ~276MB

discord.py (https://github.com/Rapptz/discord.py)
-     memo fields = ~189MB
+     memo fields = ~207MB

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/semantic_index/builder.rs</code>:1543 on 2025-06-27 19:30</div>
            <div class="timeline-body"><p>Is it difficult to capture this in a regression test?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/semantic_index/builder.rs</code>:1543 on 2025-06-27 19:32</div>
            <div class="timeline-body"><p>If that's the case, I should probably write a regression test for this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-06-27 19:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @sharkdp on 2025-06-27 19:33</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/semantic_index/builder.rs</code>:1517 on 2025-06-27 19:37</div>
            <div class="timeline-body"><p>It looks like we can replace all four of these lines, and the below call to <code>self.record_reachability_constraint_id(first_predicate_id)</code>, with the single line:</p>
<pre><code class="language-suggestion">                let first_reachability_constraint = self.record_reachability_constraint(predicate);
</code></pre>
<p>and avoid some repeat work, too.</p>
<p>Also, the comment line below &quot;So the body's full reachability constraint is <code>first</code>.&quot; might need a bit of attention, since we no longer have anything here named <code>first</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-06-27 19:42</div>
            <div class="timeline-body"><p>Nice, thank you.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-06-27 20:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/semantic_index/builder.rs</code>:1543 on 2025-06-27 20:52</div>
            <div class="timeline-body"><blockquote>
<p>Is it difficult to capture this in a regression test?</p>
</blockquote>
<p>Oh, haha. Didn't even see your comment when I wrote mine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-06-27 21:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/semantic_index/builder.rs</code>:1543 on 2025-06-27 21:08</div>
            <div class="timeline-body"><blockquote>
<p>Didn't even see your comment when I wrote mine.</p>
</blockquote>
<p>That's because it wasn't there yet! GH does this funny thing where it dates a review comment to the moment it was drafted, even if it was published as part of a review batch later on.</p>
<p>I'm the one who didn't see your comment before submitting my review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/semantic_index/builder.rs</code>:1543 on 2025-06-30 09:28</div>
            <div class="timeline-body"><p>That previous behavior was actually correct. The key is that the constraint was only applied after the branches had been merged. This is needs to record fewer constraints overall, so I changed it back. This also allows us to take one fewer snapshot which should help with performance.</p>
<p>I tried to capture this in the updates comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-06-30 09:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @sharkdp on 2025-06-30 09:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-06-30 09:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-06-30 09:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-30 09:38</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:39:36 UTC
    </footer>
</body>
</html>
