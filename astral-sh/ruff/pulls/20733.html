<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pylint`] Implement `stop-iteration-return` (`PLR1708`) - astral-sh/ruff #20733</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pylint</code>] Implement <code>stop-iteration-return</code> (<code>PLR1708</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20733">#20733</a>
        opened by <a href="https://github.com/fatelei">@fatelei</a>
        on 2025-10-07 04:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/fatelei">@fatelei</a></div>
            <div class="timeline-body">Summary
<p>implement pylint rule stop-iteration-return / R1708</p>
Test Plan


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pylint/rules/stop_iteration_return.rs</code>:15 on 2025-10-15 19:31</div>
            <div class="timeline-body"><p>I tried this out on Python 3.7, which is the earliest version we support, and it raises a runtime error even then, so I think we should try to emphasize that a  bit more than just saying it was deprecated and will be removed.</p>
<p>I also don&#x27;t think it matters if the exception has a value, at least on 3.13:</p>
<pre><code>Python 3.13.7 (main, Aug 15 2025, 12:34:02) [GCC 15.2.1 20250813] on linux
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; def my_generator():
...     yield 1
...     yield 2
...     raise StopIteration
...
&gt;&gt;&gt; for _ in my_generator(): ...
...
Ellipsis
Ellipsis
Traceback (most recent call last):
  File &quot;&lt;python-input-0&gt;&quot;, line 4, in my_generator
    raise StopIteration
StopIteration

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File &quot;&lt;python-input-1&gt;&quot;, line 1, in &lt;module&gt;
    for _ in my_generator(): ...
             ~~~~~~~~~~~~^^
RuntimeError: generator raised StopIteration
&gt;&gt;&gt;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pylint/rules/stop_iteration_return.rs</code>:49 on 2025-10-15 19:33</div>
            <div class="timeline-body"><p>The <code>use return instead</code> part might be nice as the <code>fix_title</code>. I believe it will display even if the rule doesn&#x27;t actually have a fix.</p>
<pre><code>    fn message(&amp;self) -&gt; String {
        &quot;Explicit `raise StopIteration` in generator&quot;.to_string()
    }
    
    fn fix_title(&amp;self) -&gt; Option&lt;String&gt; {
        &quot;Use `return` instead&quot;.to_string()
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/codes.rs</code>:287 on 2025-10-15 19:35</div>
            <div class="timeline-body"><p>New rules have to be added in <code>RuleGroup::Preview</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pylint/rules/stop_iteration_return.rs</code>:68 on 2025-10-15 19:36</div>
            <div class="timeline-body"><p>I could be wrong, but I&#x27;m pretty sure this scope kind is for when you&#x27;re inside of a generator expression, not inside the definition of a generator function. I&#x27;m not seeing any new snapshot files to confirm that, though. You&#x27;ll need to run the tests locally and accept any new snapshots for the new tests you added to work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pylint/rules/stop_iteration_return.rs</code>:78 on 2025-10-15 19:39</div>
            <div class="timeline-body"><p>I think we&#x27;ll need to use <a href="https://github.com/astral-sh/ruff/blob/d2e8d765705956694ac7bb23f4de179352b3c3ed/crates/ruff_python_semantic/src/model.rs#L273"><code>has_builtin_binding</code></a> here. That will make sure <code>StopIteration</code> hasn&#x27;t been shadowed or anything like that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> requested changes on 2025-10-15 19:45</div>
            <div class="timeline-body"><p>Thank you! This looks good to me overall, I just had a few fairly small suggestions besides needing to add the test snapshots. Let me know if you need  help with that. It might also be good for @amyreese to take a quick look.</p>
<p>I think this is a good rule to add, especially since this pattern will always (?) cause a runtime error on the versions of Python we support.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-15 19:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-15 19:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/fatelei">@fatelei</a> on 2025-10-16 02:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/fatelei">@fatelei</a> on 2025-10-16 02:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/fatelei">@fatelei</a> on 2025-10-16 02:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/fatelei">@fatelei</a> on 2025-10-16 02:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-16 02:31</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/pylint/rules/stop_iteration_return.rs</code>:91 on 2025-10-20 22:26</div>
            <div class="timeline-body"><p>Since this is likely the more &quot;expensive&quot; portion of the check (iterating over every statement in the parent function&#x27;s body), I&#x27;d suggest extracting this logic into a function, and call that function from inside the matching branches below, so that we only check for a generator function context if the statement actually matches <code>raise StopIteration</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/pylint/rules/stop_iteration_return.rs</code>:122 on 2025-10-20 22:40</div>
            <div class="timeline-body"><p>I think this nested if block could actually be replaced with:</p>
<pre><code>if checker.semantic().match_builtin_expr(&amp;func, &quot;StopIteration&quot;)
</code></pre>
<p>See the <code>blocking-input</code> rule for an example: https://github.com/astral-sh/ruff/blob/511710e1ef930050d6a58d73251ddf85558ecc93/crates/ruff_linter/src/rules/flake8_async/rules/blocking_input.rs#L46</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/pylint/rules/stop_iteration_return.rs</code>:133 on 2025-10-20 22:40</div>
            <div class="timeline-body"><p>Same for <code>match_builtin_expr</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/src/rules/pylint/rules/stop_iteration_return.rs</code>:108 on 2025-10-20 23:00</div>
            <div class="timeline-body"><p>Since the two arms of this if-else share their internal logic, it might be possible to combine them into a match statement to reduce duplication and nesting. Something like:</p>
<pre><code>match &amp;raise_stmt.exc.as_ref() {
  Some(ast::Expr::Call(...) | ast::Expr::Name(...)) =&gt; {
    ...
  },
  _ =&gt; {}
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> requested changes on 2025-10-20 23:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ty/docs/environment.md</code>:45 on 2025-10-22 21:23</div>
            <div class="timeline-body"><p>I think we should revert changes to this file, unless this is just a GitHub rendering bug.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/pylint/rules/stop_iteration_return.rs</code>:16 on 2025-10-22 21:28</div>
            <div class="timeline-body"><p>The first part here feels a bit redundant, and then I think the fact that it raises a runtime error is a bit more severe than breaking an abstraction. I think we could just say something like:</p>
<pre><code>/// Raising `StopIteration` in a generator function causes a `RuntimeError`
/// when the generator is iterated over.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> reviewed on 2025-10-22 21:31</div>
            <div class="timeline-body"><p>Thanks, this is looking good! I noticed that we have a related rule in <a href="https://docs.astral.sh/ruff/rules/return-in-generator/#return-in-generator-b901">return-in-generator (B901)</a>, and instead of triggering on <code>return</code> statements, it actually runs on function definition statements. Then its visitor looks for both yields and <code>return</code> statements. I think it might make sense to mirror that structure here so that we don&#x27;t have to traverse multiple scopes looking for an enclosing function. B901 can even avoid visiting nested functions since those will be traversed later by the <code>Checker</code>:</p>
<p>https://github.com/astral-sh/ruff/blob/766ed5b5f394b3dae19dba4859aac797b48fbd00/crates/ruff_linter/src/rules/flake8_bugbear/rules/return_in_generator.rs#L123-L125</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> reviewed on 2025-10-22 22:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ty/docs/environment.md</code>:45 on 2025-10-22 22:02</div>
            <div class="timeline-body"><p>I think this is github due to the branch being based on a two-week old rev. When I did a local rebase, it didn&#x27;t show in the results.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> reviewed on 2025-10-22 22:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/amyreese">@amyreese</a> on <code>crates/ruff_linter/resources/test/fixtures/pylint/stop_iteration_return.py</code>:71 on 2025-10-22 22:03</div>
            <div class="timeline-body"><p>There&#x27;s also some extra indentation and whitespace in here. I suggest running <code>ruff format</code> on this fixture and then re-running the tests and accept the snapshot changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-10-23 21:34</div>
            <div class="timeline-body"><p>Thank you! This looks good to me now if @amyreese is happy with it.</p>
<p>I pushed two commits fixing the merge conflicts from one of my PRs earlier and fixing a small nit about the function order.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;feat: implement pylint rule stop-iteration-return / R1708&quot; to &quot;[`pylint`] Implement `stop-iteration-return` (`PLR1708`)&quot; by <a href="https://github.com/ntBre">@ntBre</a> on 2025-10-23 21:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/amyreese">@amyreese</a> approved on 2025-10-23 22:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/amyreese">@amyreese</a> on 2025-10-23 22:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/amyreese">@amyreese</a> on 2025-10-23 22:02</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:19:17 UTC
    </footer>
</body>
</html>
