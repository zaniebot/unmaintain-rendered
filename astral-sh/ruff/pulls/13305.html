<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consider `__new__` methods as special function type for enforcing class method or static method rules - astral-sh/ruff #13305</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Consider <code>__new__</code> methods as special function type for enforcing class method or static method rules</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13305">#13305</a>
        opened by <a href="https://github.com/cake-monotone">@cake-monotone</a>
        on 2024-09-10 11:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/cake-monotone">@cake-monotone</a> on 2024-09-10 11:08</div>
            <div class="timeline-body"><h2>Summary</h2>
<p><code>__new__</code> methods are technically static methods, with <code>cls</code> as their first argument. However, Ruff currently classifies them as classmethod, which causes two issues:</p>
<ul>
<li>It conveys incorrect information, leading to confusion. For example, in cases like ARG003, <code>__new__</code> is explicitly treated as a classmethod.</li>
<li>Future rules that should apply to staticmethod may not be applied correctly due to this misclassification.</li>
</ul>
<p>Motivated by this, the current PR makes the following adjustments:</p>
<ol>
<li><p>Introduces <code>FunctionType::NewMethod</code> as an enum variant, since, for the purposes of lint rules, <code>__new__</code> sometimes behaves like a static method and other times like a class method. This is an internal change.</p>
</li>
<li><p>The following rule behaviors and messages are totally unchanged:</p>
<ul>
<li><a href="https://docs.astral.sh/ruff/rules/too-many-arguments/#too-many-arguments-plr0913">too-many-arguments (PLR0913)</a></li>
<li><a href="https://docs.astral.sh/ruff/rules/too-many-positional-arguments/#too-many-positional-arguments-plr0917">too-many-positional-arguments (PLR0917)</a></li>
</ul>
</li>
<li><p>The following rule behaviors are unchanged, but the messages have been changed for correctness to use &quot;<code>__new__</code> method&quot; instead of &quot;class method&quot;:</p>
<ul>
<li><a href="https://docs.astral.sh/ruff/rules/self-or-cls-assignment/#self-or-cls-assignment-plw0642">self-or-cls-assignment (PLW0642)</a></li>
</ul>
</li>
<li><p>The following rules are changed <em>unconditionally</em> (not gated behind preview) because their current behavior is an honest bug: it just isn't true that <code>__new__</code> is a class method, and it <em>is</em> true that <code>__new__</code> is a static method:</p>
<ul>
<li><a href="https://docs.astral.sh/ruff/rules/unused-class-method-argument/#unused-class-method-argument-arg003">unused-class-method-argument (ARG003)</a> no longer applies to <code>__new__</code></li>
<li><a href="https://docs.astral.sh/ruff/rules/unused-static-method-argument/#unused-static-method-argument-arg004">unused-static-method-argument (ARG004)</a> now applies to <code>__new__</code></li>
</ul>
</li>
<li><p>The only changes which differ based on <code>preview</code> are the following:</p>
<ul>
<li><a href="https://docs.astral.sh/ruff/rules/invalid-first-argument-name-for-class-method/#invalid-first-argument-name-for-class-method-n804">invalid-first-argument-name-for-class-method (N804)</a>: This is <em>skipped</em> when <code>preview</code> is <em>enabled</em>. When <code>preview</code> is <em>disabled</em>, the rule is the same but the <em>message</em> has been modified to say &quot;<code>__new__</code> method&quot; instead of &quot;class method&quot;.</li>
<li><a href="https://docs.astral.sh/ruff/rules/bad-staticmethod-argument/#bad-staticmethod-argument-plw0211">bad-staticmethod-argument (PLW0211)</a>: When <code>preview</code> is enabled, this now applies to <code>__new__</code>.</li>
</ul>
</li>
</ol>
<p>Closes #13154</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @cake-monotone on 2024-09-10 11:08</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-09-10 11:22</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚ÑπÔ∏è ecosystem check <strong>detected linter changes</strong>. (+2 -2 violations, +0 -0 fixes in 1 projects; 54 projects unchanged)</p>
<details><summary><a href="https://github.com/latchbio/latch">latchbio/latch</a> (+2 -2 violations, +0 -0 fixes)</summary>
<p>

<pre>
- <a href='https://github.com/latchbio/latch/blob/5e0367a180d1d3b321492f1c3939aee4c1665278/src/latch_cli/centromere/utils.py#L67'>src/latch_cli/centromere/utils.py:67:34:</a> ARG003 Unused class method argument: `args`
+ <a href='https://github.com/latchbio/latch/blob/5e0367a180d1d3b321492f1c3939aee4c1665278/src/latch_cli/centromere/utils.py#L67'>src/latch_cli/centromere/utils.py:67:34:</a> ARG004 Unused static method argument: `args`
- <a href='https://github.com/latchbio/latch/blob/5e0367a180d1d3b321492f1c3939aee4c1665278/src/latch_cli/centromere/utils.py#L67'>src/latch_cli/centromere/utils.py:67:42:</a> ARG003 Unused class method argument: `kwargs`
+ <a href='https://github.com/latchbio/latch/blob/5e0367a180d1d3b321492f1c3939aee4c1665278/src/latch_cli/centromere/utils.py#L67'>src/latch_cli/centromere/utils.py:67:42:</a> ARG004 Unused static method argument: `kwargs`
</pre>

</p>
</details>
<details><summary>Changes by rule (2 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| ARG004 | 2 | 2 | 0 | 0 | 0 |
| ARG003 | 2 | 0 | 2 | 0 | 0 |</p>
</p>
</details>

<h3>Linter (preview)</h3>
<p>‚ÑπÔ∏è ecosystem check <strong>detected linter changes</strong>. (+2 -2 violations, +0 -0 fixes in 1 projects; 54 projects unchanged)</p>
<details><summary><a href="https://github.com/latchbio/latch">latchbio/latch</a> (+2 -2 violations, +0 -0 fixes)</summary>
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
- <a href='https://github.com/latchbio/latch/blob/5e0367a180d1d3b321492f1c3939aee4c1665278/src/latch_cli/centromere/utils.py#L67'>src/latch_cli/centromere/utils.py:67:34:</a> ARG003 Unused class method argument: `args`
+ <a href='https://github.com/latchbio/latch/blob/5e0367a180d1d3b321492f1c3939aee4c1665278/src/latch_cli/centromere/utils.py#L67'>src/latch_cli/centromere/utils.py:67:34:</a> ARG004 Unused static method argument: `args`
- <a href='https://github.com/latchbio/latch/blob/5e0367a180d1d3b321492f1c3939aee4c1665278/src/latch_cli/centromere/utils.py#L67'>src/latch_cli/centromere/utils.py:67:42:</a> ARG003 Unused class method argument: `kwargs`
+ <a href='https://github.com/latchbio/latch/blob/5e0367a180d1d3b321492f1c3939aee4c1665278/src/latch_cli/centromere/utils.py#L67'>src/latch_cli/centromere/utils.py:67:42:</a> ARG004 Unused static method argument: `kwargs`
</pre>

</p>
</details>
<details><summary>Changes by rule (2 rules affected)</summary>
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| ARG004 | 2 | 2 | 0 | 0 | 0 |
| ARG003 | 2 | 0 | 2 | 0 | 0 |</p>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cake-monotone">@cake-monotone</a> on 2024-09-10 11:52</div>
            <div class="timeline-body"><p>I'm sure there are other breaking changes besides the ruff-ecosystem results
I'll try to summarize them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to @AlexWaygood by @AlexWaygood on 2024-09-10 13:21</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cake-monotone">@cake-monotone</a> on 2024-09-11 09:42</div>
            <div class="timeline-body"><h2>Affected Rules</h2>
<ul>
<li><strong>ARG003</strong>: unused-class-method-argument</li>
<li><strong>ARG004</strong>: unused-static-method-argument</li>
<li><strong>PLW0642</strong>: self-or-cls-assignment</li>
<li><strong>PLW0211</strong>: bad-staticmethod-argument</li>
<li><strong>N804</strong>: invalid-first-argument-name-for-class-method</li>
<li><strong>PLR0913</strong>: too-many-arguments</li>
<li><strong>PLR0917</strong>: too-many-positional-arguments</li>
</ul>
<h3>ARG003, ARG004</h3>
<p><strong>ARG003</strong> (<code>unused-class-method-argument</code>) -&gt; <strong>ARG004</strong> (<code>unused-static-method-argument</code>)</p>
<h3>PLW0642</h3>
<p><code>__new__</code> methods will no longer be checked by <strong>PLW0642</strong>. This rule only applies to methods and class methods, not static methods.</p>
<h3>N804, PLW0211</h3>
<p><strong>N804</strong> (<code>invalid-first-argument-name-for-class-method</code>) -&gt; <strong>PLW0211</strong> (<code>bad-staticmethod-argument</code>)</p>
<h3>PLR0913, PLR0917</h3>
<p><strong>PLR0913</strong> (<code>too-many-arguments</code>) and <strong>PLR0917</strong> (<code>too-many-positional-arguments</code>) behave differently for classmethod and staticmethod. In classmethod, the first argument cls is excluded from the argument count. In staticmethod, cls is not excluded, so the argument limit applies more strictly.</p>
<h2>Example</h2>
<p>You can view an example of how these rules are applied here:
https://play.ruff.rs/2df5f2b6-093f-4988-a562-c6101a1c71cc</p>
<pre><code class="language-py">class ClassDunderNew:
    @classmethod
    def __new__(
        cls,
        x,  # ARG003: Unused class method argument: `x`
    ):
        cls = 1  # PLW0642: Reassigned `cls` variable in class method

    @classmethod
    def __new__(  # PLR0913: Too many arguments in function definition (6 &gt; 5)  # PLR0917: Too many positional arguments (6/5)
        self,  # N804: First argument of a class method should be named `cls`
        a1, a2, a3, a4, a5,
        a6,
    ):
        ...


class StaticDunderNew:
    @staticmethod
    def __new__(
        cls,
        x,  # ARG004: Unused static method argument: `x`
    ):
        cls = 1

    @staticmethod
    def __new__(  # PLR0913: Too many arguments in function definition (6 &gt; 5)  # PLR0917: Too many positional arguments (6/5)
        self,  # PLW0211: First argument of a static method should not be named `self`
        a1, a2, a3, a4, a5,
    ):
        ...
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cake-monotone">@cake-monotone</a> on 2024-09-11 09:51</div>
            <div class="timeline-body"><p>I reviewed all the code affected by <code>function_type::classify</code>. Let me know if I missed any affected rules.</p>
<p>Please check if these affected rules are acceptable. :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Unassigned @AlexWaygood by @AlexWaygood on 2024-09-19 16:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @MichaReiser on 2024-12-26 09:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> added by @MichaReiser on 2024-12-26 09:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">needs-decision</span> removed by @dylwil3 on 2025-02-15 18:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2025-02-15 18:53</div>
            <div class="timeline-body"><p>Thanks so much!</p>
<p>I think this is pretty much good to go - had to tweak some things to rebase, and I decided we should special case the counting of arguments for the &quot;too-many-(positional-)arguments&quot; rules to treat <code>__new__</code> like a classmethod, since it seems more intuitive there. Also added more test fixtures to track changes if we decide to further modify the treatment of <code>__new__</code> later.</p>
<p>My only hesitation on merging is whether this should be considered breaking and wait until the next minor release - thoughts @AlexWaygood / @MichaReiser ?</p>
<p>Also to Alex: It'd be great if you could spot check the conflict resolution for PYI019 to make sure it's in line with what you had in mind for the recent changes to that rule. https://github.com/astral-sh/ruff/pull/13305/files#diff-bfce927fd2c71368a7fc9c045c1f51f03f4ac25e398ed8b3a571caf01f4efe06</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-15 21:35</div>
            <div class="timeline-body"><p>I'd prefer if this is a preview only change just because of the scope of it. It's definitely a breaking change otherwise</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2025-02-16 19:25</div>
            <div class="timeline-body"><p>I don't think making the change preview only makes sense in many cases, since I consider the old behavior a bug/incorrect. Here's what I ended up doing. Even though this is a long list, there are actually not so many behavior changes, so I wouldn't consider this breaking, personally. What do you think?</p>
<ol>
<li><p>As suggested by Alex, I introduced <code>FunctionType::NewMethod</code> as an enum variant, since, for the purposes of lint rules, <code>__new__</code> sometimes behaves like a static method and other times like a class method. This is an internal change.</p>
</li>
<li><p>The following rule behaviors and messages are totally unchanged:</p>
<ul>
<li><a href="https://docs.astral.sh/ruff/rules/too-many-arguments/#too-many-arguments-plr0913">too-many-arguments (PLR0913)</a></li>
<li><a href="https://docs.astral.sh/ruff/rules/too-many-positional-arguments/#too-many-positional-arguments-plr0917">too-many-positional-arguments (PLR0917)</a></li>
</ul>
</li>
<li><p>The following rule behaviors are unchanged, but the messages have been changed for correctness to use &quot;<code>__new__</code> method&quot; instead of &quot;class method&quot;:</p>
<ul>
<li><a href="https://docs.astral.sh/ruff/rules/self-or-cls-assignment/#self-or-cls-assignment-plw0642">self-or-cls-assignment (PLW0642)</a></li>
</ul>
</li>
<li><p>The following rules are changed <em>unconditionally</em> (not gated behind preview) because I think their current behavior is an honest bug: it just isn't true that <code>__new__</code> is a class method, and it <em>is</em> true that <code>__new__</code> is a static method:</p>
<ul>
<li><a href="https://docs.astral.sh/ruff/rules/unused-class-method-argument/#unused-class-method-argument-arg003">unused-class-method-argument (ARG003)</a> no longer applies to <code>__new__</code></li>
<li><a href="https://docs.astral.sh/ruff/rules/unused-static-method-argument/#unused-static-method-argument-arg004">unused-static-method-argument (ARG004)</a> now applies to <code>__new__</code></li>
</ul>
</li>
<li><p>The only changes which differ based on <code>preview</code> are the following:</p>
<ul>
<li><a href="https://docs.astral.sh/ruff/rules/invalid-first-argument-name-for-class-method/#invalid-first-argument-name-for-class-method-n804">invalid-first-argument-name-for-class-method (N804)</a>: This is <em>skipped</em> when <code>preview</code> is <em>enabled</em>. When <code>preview</code> is <em>disabled</em>, the rule is the same but the <em>message</em> has been modified to say &quot;<code>__new__</code> method&quot; instead of &quot;class method&quot;.</li>
<li><a href="https://docs.astral.sh/ruff/rules/bad-staticmethod-argument/#bad-staticmethod-argument-plw0211">bad-staticmethod-argument (PLW0211)</a>: When <code>preview</code> is enabled, this now applies to <code>__new__</code>.</li>
</ul>
</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_semantic/src/analyze/function_type.rs</code>:44 on 2025-02-16 19:44</div>
            <div class="timeline-body"><pre><code class="language-suggestion">            &quot;__init_subclass__&quot; | &quot;__class_getitem__&quot; =&gt; FunctionType::ClassMethod, // Implicit class methods.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_unused_arguments/rules/unused_arguments.rs</code>:471 on 2025-02-16 19:59</div>
            <div class="timeline-body"><pre><code class="language-suggestion">                        // we use `method()` here rather than `function()`, as although `__new__` is
                        // an implicit staticmethod, `__new__` methods must always have &gt;= parameter
                        method(Argumentable::StaticMethod, parameters, scope, checker);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/pep8_naming/rules/invalid_first_argument_name.rs</code>:141 on 2025-02-16 20:00</div>
            <div class="timeline-body"><p>Lol, yet another reason for us to introduce a <code>summary_sentence()</code> method to the Violation trait instead of deriving the summary sentence from the <code>message()</code> method üôÉ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_python_semantic/src/analyze/function_type.rs</code>:15 on 2025-02-16 20:01</div>
            <div class="timeline-body"><p>Nit: you could use doc-comments here so that we get nice tooltips when hovering over this method in VSCode</p>
<pre><code class="language-suggestion">    /// `__new__` is an implicit static method but
    /// is treated similarly to class methods for several lint rules
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-02-16 20:02</div>
            <div class="timeline-body"><p>This looks excellent! Thanks @cake-monotone for the PR, and thanks @dylwil3 for driving it over the line!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @dylwil3 on 2025-02-16 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Refactor method classification logic: `__new__` methods are now classified as `staticmethod`" to "Consider `__new__` methods as special function type for enforcing class method or static method rules" by @dylwil3 on 2025-02-16 20:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dylwil3 on 2025-02-16 20:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dylwil3 on 2025-02-16 20:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/pep8_naming/rules/invalid_first_argument_name.rs</code>:242 on 2025-02-16 20:26</div>
            <div class="timeline-body"><p>Oh, I guess it might be good to add a note about this to the rule's docs?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_unused_arguments/rules/unused_arguments.rs</code>:470 on 2025-02-16 20:27</div>
            <div class="timeline-body"><p>Ah shoot, my previous suggestion had a typo -- it should have been this :-(</p>
<pre><code class="language-suggestion">                        // an implicit staticmethod, `__new__` methods must always have &gt;=1 parameters
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-16 20:28</div>
            <div class="timeline-body"><p>argh sorry, a couple of tiny nits I missed pre-merge that might be good to address as a followup</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:57:51 UTC
    </footer>
</body>
</html>
