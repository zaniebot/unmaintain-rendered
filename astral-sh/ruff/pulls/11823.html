<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`ruff server`: Improve error message when a command is run on an unavailable document - astral-sh/ruff #11823</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>ruff server</code>: Improve error message when a command is run on an unavailable document</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11823">#11823</a>
        opened by <a href="https://github.com/snowsignal">@snowsignal</a>
        on 2024-06-10 14:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/snowsignal">@snowsignal</a></div>
            <div class="timeline-body">Summary
<p>Fixes #11744.</p>
<p>We now show a distinct popup message when we fail to get a document snapshot during command execution. This message more clearly communicates the issue to the user, instead of a generic &quot;ruff encountered an error&quot; message.</p>
Test Plan
<p>Try running <code>Fix all auto-fixable problems</code> on an incompatible file (for example: <code>settings.json</code>). You should see the following popup message:
<img alt="Screenshot 2024-06-11 at 11 47 16 AM" src="https://github.com/astral-sh/ruff/assets/19577865/3a28e3d7-3896-4dd0-b117-f87300dd3b68"></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-06-10 14:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-06-10 14:18</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/jane/server/exe-command-warn">CodSpeed Performance Report</a>
Merging #11823 will <strong>not alter performance</strong>
<p>Comparing <code>jane/server/exe-command-warn</code> (94efad9) with <code>main</code> (4e9d771)</p>
Summary
<p><code>✅ 30</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-06-10 14:27</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-10 14:34</div>
            <div class="timeline-body"><p>Have you looked into how other LSPs handle this? I&#x27;m kind of surprised that VS Code sends us this request in the first place, considering that we only subscribed for Python files.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-06-10 16:34</div>
            <div class="timeline-body"><p>@MichaReiser VS Code makes a command available for every file, unless you add a filter (which isn&#x27;t possible for us).</p>
<p>Here&#x27;s how other langauge servers handle this:</p>
<ul>
<li><p>ES Lint simply ignores the command (see <a href="https://github.com/astral-sh/ruff-vscode/pull/487">astral-sh/ruff-vscode#487</a>#pullrequestreview-2098123258)</p>
</li>
<li><p>With <code>rust-analyzer</code>, some commands are ignored, while others show a very visible error message:
<img alt="Screenshot 2024-06-10 at 9 29 41 AM" src="https://github.com/astral-sh/ruff/assets/19577865/4ec65064-9729-4a6c-ad2f-86000933311b"></p>
</li>
<li><p><code>insta</code> shows a visible error message:
<img alt="Screenshot 2024-06-10 at 9 33 06 AM" src="https://github.com/astral-sh/ruff/assets/19577865/2998d847-88bc-4973-93c5-f518c3947b29"></p>
</li>
</ul>
<p>Maybe we should just show a more descriptive error message, then? I&#x27;m not too opinionated either way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-06-10 17:31</div>
            <div class="timeline-body"><p>Hmm, interesting. My main concern is that not finding the document is, in most cases, a valid error. For example, it was the root cause for untitled files, and having the server fail instead of silently ignoring the error was a good case. It makes me worried that it will be harder to debug such kind of errors in the future. So yes, maybe showing a more user visible error would help us to still catch the error that something went wrong.</p>
<p>Disclaimer: It&#x27;s not entirely clear when and how often this kind of requests are sent by VS code. Is it only when a user manually requests e.g. import sorting or does it also happen when they have organize imports enabled on save? Is there a way for us to narrow the requests for which we should apply the more lenient handling?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-06-10 17:51</div>
            <div class="timeline-body"><blockquote>
<p>Disclaimer: It&#x27;s not entirely clear when and how often this kind of requests are sent by VS code. Is it only when a user manually requests e.g. import sorting or does it also happen when they have organize imports enabled on save?</p>
</blockquote>
<p>It&#x27;s whenever a command gets run, which usually has to be done through the command palette (so, manual execution). I don&#x27;t think there&#x27;s a way to run a command on save built-in to VS Code - usually, those are done with source actions, and are only enabled for a specific language.</p>
<blockquote>
<p>Is there a way for us to narrow the requests for which we should apply the more lenient handling?</p>
</blockquote>
<p>Not really. I think it would make more sense to just show a descriptive error message that allows the user to narrow down the problem themselves.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-06-11 06:19</div>
            <div class="timeline-body"><blockquote>
<p>It&#x27;s whenever a command gets run, which usually has to be done through the command palette (so, manual execution).</p>
</blockquote>
<p>I would then prefer if we would also show a user facing error in addition to logging a warning to insta similar to insta. It would ensure that we still surface real errors and I don&#x27;t think it would be annoying, considering that triggering requires a manual user interaction.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;`ruff server`: Silently handle unavailable file&quot; to &quot;`ruff server`: Improve error message when a command is run on an unavailable document&quot; by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-06-11 18:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-06-11 18:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/snowsignal">@snowsignal</a> on 2024-06-11 18:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-06-11 18:50</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:04:36 UTC
    </footer>
</body>
</html>
