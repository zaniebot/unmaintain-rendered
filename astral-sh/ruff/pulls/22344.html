<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Optimize `IntersectionType` for the common case of a single negated element - astral-sh/ruff #22344</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Optimize <code>IntersectionType</code> for the common case of a single negated element</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22344">#22344</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2026-01-02 19:10
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body">Summary
<p>We call <code>Type::negate()</code> a lot across the codebase. In most cases, it creates an intersection type with 0 positive elements and a single negative element.</p>
<p>Our representation of <code>IntersectionType</code> is currently not very well optimised for this very common case, however: no matter how many negative elements are in the intersection, we always use an <code>FxOrderSet</code> to store these negative elements. I believe that, like most generic Rust collections, <code>OrderSet</code> does not allocate if it has 0 elements contained inside it, but performs a heap allocation as soon as a single element is allocated.</p>
<p>This PR gets rid of the heap allocation for the common case of a single negative element. This leads to across-the-board speedups of 1-4%, including a 4-5% speedup on colour-science, one of the benchmarks on which we currently do worst.</p>
Test Plan
<p>Existing tests all pass and the primer report is clean (except for the known set of flakes).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-02 19:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-02 19:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-02 19:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-02 19:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-02 19:11</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ‚úÖ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-02 19:12</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>pydantic (https://github.com/pydantic/pydantic)
- pydantic/fields.py:943:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
+ pydantic/fields.py:943:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
- pydantic/fields.py:983:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
+ pydantic/fields.py:983:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
- pydantic/fields.py:1026:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
+ pydantic/fields.py:1026:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
- pydantic/fields.py:1066:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
+ pydantic/fields.py:1066:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
- pydantic/fields.py:1109:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
+ pydantic/fields.py:1109:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
- pydantic/fields.py:1148:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
+ pydantic/fields.py:1148:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
- pydantic/fields.py:1188:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
+ pydantic/fields.py:1188:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
- pydantic/fields.py:1567:13: error[invalid-argument-type] Argument is incorrect: Expected `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`, found `Top[dict[Unknown, Unknown]] | (((dict[str, Divergent], /) -&gt; None) &amp; ~Top[dict[Unknown, Unknown]]) | None`
+ pydantic/fields.py:1567:13: error[invalid-argument-type] Argument is incorrect: Expected `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`, found `Top[dict[Unknown, Unknown]] | (((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) &amp; ~Top[dict[Unknown, Unknown]]) | None`

scikit-build-core (https://github.com/scikit-build/scikit-build-core)
- src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 48 diagnostics
+ Found 47 diagnostics

prefect (https://github.com/PrefectHQ/prefect)
- src/integrations/prefect-dbt/prefect_dbt/core/settings.py:94:28: error[invalid-assignment] Object of type `T@resolve_block_document_references | dict[str, Any]` is not assignable to `dict[str, Any]`
+ src/integrations/prefect-dbt/prefect_dbt/core/settings.py:94:28: error[invalid-assignment] Object of type `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements` is not assignable to `dict[str, Any]`
- src/integrations/prefect-dbt/prefect_dbt/core/settings.py:99:28: error[invalid-assignment] Object of type `T@resolve_variables | dict[str, Any]` is not assignable to `dict[str, Any]`
+ src/integrations/prefect-dbt/prefect_dbt/core/settings.py:99:28: error[invalid-assignment] Object of type `T@resolve_variables | str | int | ... omitted 4 union elements` is not assignable to `dict[str, Any]`
- src/prefect/cli/deploy/_core.py:86:21: error[invalid-assignment] Object of type `T@resolve_block_document_references | dict[str, Any]` is not assignable to `dict[str, Any]`
+ src/prefect/cli/deploy/_core.py:86:21: error[invalid-assignment] Object of type `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements` is not assignable to `dict[str, Any]`
- src/prefect/cli/deploy/_core.py:87:21: error[invalid-assignment] Object of type `T@resolve_variables` is not assignable to `dict[str, Any]`
+ src/prefect/cli/deploy/_core.py:87:21: error[invalid-assignment] Object of type `T@resolve_variables | str | int | ... omitted 4 union elements` is not assignable to `dict[str, Any]`
- src/prefect/deployments/steps/core.py:137:38: error[invalid-argument-type] Argument is incorrect: Expected `T@resolve_variables`, found `T@resolve_block_document_references | dict[str, Any]`
+ src/prefect/deployments/steps/core.py:137:38: error[invalid-argument-type] Argument is incorrect: Expected `T@resolve_variables`, found `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements`
- src/prefect/utilities/templating.py:320:13: error[invalid-assignment] Invalid subscript assignment with key of type `object` and value of type `T@resolve_block_document_references | dict[str, Any]` on object of type `dict[str, Any]`
+ src/prefect/utilities/templating.py:320:13: error[invalid-assignment] Invalid subscript assignment with key of type `object` and value of type `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements` on object of type `dict[str, Any]`
- src/prefect/utilities/templating.py:323:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_block_document_references | dict[str, Any]`, found `list[T@resolve_block_document_references | dict[str, Any] | Unknown]`
+ src/prefect/utilities/templating.py:323:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_block_document_references | dict[str, Any]`, found `list[T@resolve_block_document_references | dict[str, Any] | str | ... omitted 5 union elements]`
- src/prefect/utilities/templating.py:437:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_variables`, found `dict[object, T@resolve_variables | Unknown]`
+ src/prefect/utilities/templating.py:437:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_variables`, found `dict[object, T@resolve_variables | str | int | ... omitted 5 union elements]`
- src/prefect/utilities/templating.py:442:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_variables`, found `list[T@resolve_variables | Unknown]`
+ src/prefect/utilities/templating.py:442:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_variables`, found `list[T@resolve_variables | str | int | ... omitted 5 union elements]`
- src/prefect/workers/base.py:232:13: error[invalid-argument-type] Argument is incorrect: Expected `T@resolve_variables`, found `T@resolve_block_document_references | dict[str, Any]`
+ src/prefect/workers/base.py:232:13: error[invalid-argument-type] Argument is incorrect: Expected `T@resolve_variables`, found `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements`
- src/prefect/workers/base.py:234:20: error[invalid-argument-type] Argument expression after ** must be a mapping type: Found `T@resolve_variables`
+ src/prefect/workers/base.py:234:20: error[invalid-argument-type] Argument expression after ** must be a mapping type: Found `T@resolve_variables | str | int | ... omitted 4 union elements`

static-frame (https://github.com/static-frame/static-frame)
- static_frame/core/bus.py:671:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[Bus[Any], object_]`, found `InterGetItemLocReduces[Top[Index[Any]] | TypeBlocks | Top[Bus[Any]] | ... omitted 6 union elements, object_]`
+ static_frame/core/bus.py:671:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[Bus[Any], object_]`, found `InterGetItemLocReduces[Top[Index[Any]] | Top[Series[Any, Any]] | TypeBlocks | ... omitted 6 union elements, object_]`
- static_frame/core/index.py:580:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[TVContainer_co@loc, TVDtype@Index]`, found `InterGetItemLocReduces[Any | Bottom[Series[Any, Any]], TVDtype@Index]`
+ static_frame/core/index.py:580:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[TVContainer_co@loc, TVDtype@Index]`, found `InterGetItemLocReduces[Top[Series[Any, Any]] | Any, TVDtype@Index]`
- static_frame/core/node_selector.py:526:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[TVContainer_co@InterfaceSelectQuartet, Any]`, found `InterGetItemLocReduces[Unknown | Bottom[Series[Any, Any]], Any]`
+ static_frame/core/node_selector.py:526:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[TVContainer_co@InterfaceSelectQuartet, Any]`, found `InterGetItemLocReduces[Top[Series[Any, Any]] | Unknown, Any]`
- static_frame/core/series.py:772:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Series[Any, Any], TVDtype@Series]`, found `InterGetItemILocReduces[Top[Index[Any]] | TypeBlocks | Top[Bus[Any]] | ... omitted 6 union elements, generic[object]]`
+ static_frame/core/series.py:772:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Series[Any, Any], TVDtype@Series]`, found `InterGetItemILocReduces[Series[Any, Any] | TypeBlocks | Batch | ... omitted 6 union elements, generic[object]]`
- static_frame/core/series.py:4072:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[SeriesHE[Any, Any], TVDtype@SeriesHE]`, found `InterGetItemILocReduces[Top[Index[Any]] | TypeBlocks | Top[Bus[Any]] | ... omitted 7 union elements, generic[object]]`
+ static_frame/core/series.py:4072:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[SeriesHE[Any, Any], TVDtype@SeriesHE]`, found `InterGetItemILocReduces[Bottom[Series[Any, Any]] | TypeBlocks | Batch | ... omitted 7 union elements, generic[object]]`

pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
+ pandas-stubs/_typing.pyi:1232:16: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
+ tests/frame/test_groupby.py:229:15: error[type-assertion-failure] Type `Series[Any]` does not match asserted type `Series[str | bytes | int | ... omitted 12 union elements]`
+ tests/frame/test_groupby.py:625:15: error[type-assertion-failure] Type `Series[Any]` does not match asserted type `Series[str | bytes | int | ... omitted 12 union elements]`
- Found 5153 diagnostics
+ Found 5156 diagnostics

rotki (https://github.com/rotki/rotki)
- rotkehlchen/chain/decoding/tools.py:97:13: error[invalid-argument-type] Argument to function `decode_transfer_direction` is incorrect: Expected `(A@BaseDecoderTools &amp; BTCAddress) | (A@BaseDecoderTools &amp; ChecksumAddress) | (A@BaseDecoderTools &amp; SubstrateAddress) | (A@BaseDecoderTools &amp; SolanaAddress)`, found `A@BaseDecoderTools`
+ rotkehlchen/chain/decoding/tools.py:99:13: error[invalid-argument-type] Argument to function `decode_transfer_direction` is incorrect: Expected `Sequence[A@BaseDecoderTools]`, found `Unknown | tuple[BTCAddress, ...] | tuple[ChecksumAddress, ...] | tuple[SubstrateAddress, ...] | tuple[SolanaAddress, ...]`
- rotkehlchen/chain/decoding/tools.py:98:13: error[invalid-argument-type] Argument to function `decode_transfer_direction` is incorrect: Expected `(A@BaseDecoderTools &amp; BTCAddress) | (A@BaseDecoderTools &amp; ChecksumAddress) | (A@BaseDecoderTools &amp; SubstrateAddress) | (A@BaseDecoderTools &amp; SolanaAddress) | None`, found `A@BaseDecoderTools | None`
- rotkehlchen/chain/decoding/tools.py:99:13: error[invalid-argument-type] Argument to function `decode_transfer_direction` is incorrect: Expected `Sequence[(A@BaseDecoderTools &amp; BTCAddress) | (A@BaseDecoderTools &amp; ChecksumAddress) | (A@BaseDecoderTools &amp; SubstrateAddress) | (A@BaseDecoderTools &amp; SolanaAddress)]`, found `Unknown | tuple[BTCAddress, ...] | tuple[ChecksumAddress, ...] | tuple[SubstrateAddress, ...] | tuple[SolanaAddress, ...]`
- Found 2095 diagnostics
+ Found 2093 diagnostics


</code></pre>


<p>No memory usage changes detected ‚úÖ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2026-01-02 19:20</div>
            <div class="timeline-body">

<a href="https://codspeed.io/astral-sh/ruff/branches/alex%2Foptimize-intersections-single-neg?utm_source=github&amp;utm_medium=comment&amp;utm_content=header">CodSpeed Performance Report</a>
Merging #22344 will <strong>not alter performance</strong>
<p>Comparing <code>alex/optimize-intersections-single-neg</code> (e1cbb79) with <code>main</code> (24dd149)</p>
Summary
<p><code>‚úÖ 23</code> untouched<br>
<code>‚è© 30</code> skipped[^skipped]</p>
<p>[^skipped]: 30 benchmarks were skipped, so the baseline results were used instead. If they were deleted from the codebase, <a href="https://codspeed.io/astral-sh/ruff/branches/alex%2Foptimize-intersections-single-neg?sectionId=benchmark-comparison-section-baseline-result-skipped&amp;utm_source=github&amp;utm_medium=comment&amp;utm_content=archive">click here and archive them to remove them from the performance reports</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-02 19:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-02 19:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-02 19:49</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-02 19:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-03 10:10</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/22353 applies the same optimisation to <code>IntersectionType::positive()</code>. It <em>might</em> provide an additional speedup on top of the changes in this PR. But the effect of applying the optimisation to <code>IntersectionType::positive</code> looks to be much smaller than the effect of applying it to <code>IntersectionType::negative</code>, and the change adds further complexity. So I&#x27;d prefer to consider that as a standalone change after this lands (if this PR is accepted).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2026-01-03 16:52</div>
            <div class="timeline-body"><p>Nice find.</p>
<p>I would be interested in exploring if we can use a <code>Box&lt;[Type&lt;&#x27;db&gt;]&gt;</code> in <code>IntersectionType</code> either by:</p>
<ul>
<li>Use a dedicated union with a <code>Slice</code> (empty or more than one element) and <code>Single</code> (exactly one element)</li>
<li>Use a <code>SmallVec</code> instead</li>
</ul>
<p>The advantage of using a slice is that it doesn&#x27;t increase the complexity of the read methods (they can all be abstracted by implementing <code>Deref</code> where the <code>Target</code> is a <code>[T]</code> (use <code>std::slice::from_ref</code> to create a slice from a single element). The ordered set can be converted into a boxed slice using https://docs.rs/ordermap/latest/ordermap/set/struct.OrderSet.html#method.into_boxed_slice (which I believe is as expensive as calling <code>Vec::into_boxed_slice</code>)).</p>
<p>The <code>IntersectionBuilder</code> would keep your existing enum</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-03 17:10</div>
            <div class="timeline-body"><blockquote>
<p>I would be interested in exploring if we can use a <code>Box&lt;[Type&lt;&#x27;db&gt;]&gt;</code> in <code>IntersectionType</code></p>
</blockquote>
<p>I think this might degrade the performance of <code>intersection.negative(db).contains(...)</code>, which is called in some very hot methods. But I can try it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-03 17:35</div>
            <div class="timeline-body"><blockquote>
<p>I think this might degrade the performance of intersection.negative(db).contains(...), which is called in some very hot methods. But I can try it!</p>
</blockquote>
<p>I also just noticed that <code>into_boxed_slice</code> doesn&#x27;t return <code>&amp;[T]</code> but a custom <code>Slice</code> type... So what I suggested won&#x27;t work</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-03 17:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-03 17:36</div>
            <div class="timeline-body"><blockquote>
<p>I also just noticed that <code>into_boxed_slice</code> doesn&#x27;t return <code>&amp;[T]</code> but a custom <code>Slice</code> type... So what I suggested won&#x27;t work</p>
</blockquote>
<p>right. But I&#x27;m trying out your suggestion of a smallvec, just for comparison.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-03 17:38</div>
            <div class="timeline-body"><blockquote>
<p>right. But I&#x27;m trying out your suggestion of a smallvec, just for comparison.</p>
</blockquote>
<p>Doesn&#x27;t that mean that we need to copy (and create a new allocation) for the <em>many elements</em> case?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-03 17:40</div>
            <div class="timeline-body"><blockquote>
<p>Doesn&#x27;t that mean that we need to copy (and create a new allocation) for the <em>many elements</em> case?</p>
</blockquote>
<p>Yes. Which is why I didn&#x27;t go for that in this PR üòÑ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-03 18:01</div>
            <div class="timeline-body"><p>The codspeed report on the smallvec version does actually seem to indicate a similar level of speedup, and it seems to indicate that a broader range of benchmarks benefit? https://codspeed.io/astral-sh/ruff/branches/alex%2Foptimize-intersections-single-neg-slice?utm_source=github&amp;utm_medium=check&amp;utm_content=details</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types.rs</code>:14629 on 2026-01-04 19:19</div>
            <div class="timeline-body"><p>The duplication here is a bit unfortunate and it spills store logic into the intersection logic. Should we add a <code>map</code> and <code>try_map</code> (early returns if the mapping function returns <code>None</code>)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types.rs</code>:14390 on 2026-01-04 19:21</div>
            <div class="timeline-body"><pre><code>/// To avoid unnecessary allocations for the common case of 1 negative elements,
/// we use this enum to represent the negative elements of an intersection type.
</code></pre>
<p>Empty sets don&#x27;t require any allocations</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types.rs</code>:14430 on 2026-01-04 19:22</div>
            <div class="timeline-body"><p>I suggest making this a struct comment instead of repeating it multiple times across the implementation. That also gives you an opportunity to explain why we don&#x27;t do it (because it&#x27;s all about avoiding allocations)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types.rs</code>:14454 on 2026-01-04 19:28</div>
            <div class="timeline-body"><p>Can we implement the <code>GetSize</code> trait instead</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types.rs</code>:14393 on 2026-01-04 19:32</div>
            <div class="timeline-body"><p>This might be tricky but we&#x27;ll need to implement <code>PartialEq</code>, <code>Eq</code> and <code>Hash</code> manually so that <code>Empty</code> compares equal to <code>Multiple(empty set)</code> and <code>Single</code> compares equal to <code>Multiple(set_containing_one_element)</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2026-01-04 19:33</div>
            <div class="timeline-body"><p>This looks good. But I think we have to manually implement <code>PartialEq</code>, <code>Eq</code> and <code>Hash</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2026-01-04 19:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types.rs</code>:14393 on 2026-01-04 19:34</div>
            <div class="timeline-body"><p>Good spot.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2026-01-04 20:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types.rs</code>:14629 on 2026-01-04 20:28</div>
            <div class="timeline-body"><p>I think this would lead to more code overall because:</p>
<ul>
<li>We would need two new methods on <code>NegativeIntersectionElements</code> (<code>map</code> and <code>try_map</code>) -- one for this method and one for <code>recursive_type_normalized_impl</code></li>
<li>The new methods would not be able to reuse the <code>normalized_set</code> and <code>opt_normalized_set</code> helpers that we have already in <code>normalized_impl</code> and <code>recursive_type_normalized_impl</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-04 20:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types.rs</code>:14605 on 2026-01-05 08:48</div>
            <div class="timeline-body"><p>I&#x27;m not sure if it&#x27;s less efficient but I would implement this by</p>
<pre><code>        self.len() == other.len() &amp;&amp; std::iter::eq(self.iter(), other.iter())
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types.rs</code>:14621 on 2026-01-05 08:49</div>
            <div class="timeline-body"><p>Same as <code>eq</code>, I would implement this using the same implementation as <code>IndexSet</code>:</p>
<pre><code>				self.len().hash(state);
        for value in self {
            value.hash(state);
        }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types.rs</code>:14629 on 2026-01-05 08:52</div>
            <div class="timeline-body"><blockquote>
<p>We would need two new methods on NegativeIntersectionElements (map and try_map) -- one for this method and one for recursive_type_normalized_impl</p>
</blockquote>
<p>But that&#x27;s not different from the duplication in normalize.</p>
<blockquote>
<p>The new methods would not be able to reuse the normalized_set and opt_normalized_set helpers that we have already in normalized_impl and recursive_type_normalized_impl</p>
</blockquote>
<p>I think we can avoid that by first mapping and then calling <code>sort_unstable_by</code>. It might suggest that this should be a method on <code>NegativeIntersectionElements</code> and not on <code>IntersectionType</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2026-01-05 08:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types.rs</code>:14629 on 2026-01-05 13:00</div>
            <div class="timeline-body"><p>I think <a href="https://github.com/astral-sh/ruff/pull/22344">astral-sh/ruff#22344</a>/commits/a293de809794ad669e7adda8e99a8e8ac9f4c584 is what you&#x27;re asking for here. It&#x27;s only 3 lines more code overall, but it does feel more repetitive to me. I still prefer the PR without that change, personally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2026-01-05 13:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-05 13:05</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2026-01-05 13:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types.rs</code>:14629 on 2026-01-05 13:09</div>
            <div class="timeline-body"><p>This is what I had in mind (but keeping <code>normalized_impl</code> where it was before)</p>
<pre><code>Index: crates/ty_python_semantic/src/types.rs
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&lt;+&gt;UTF-8
===================================================================
diff --git a/crates/ty_python_semantic/src/types.rs b/crates/ty_python_semantic/src/types.rs
--- a/crates/ty_python_semantic/src/types.rs	(revision a293de809794ad669e7adda8e99a8e8ac9f4c584)
+++ b/crates/ty_python_semantic/src/types.rs	(date 1767618499646)
@@ -14525,22 +14525,41 @@
         }
     }
 
-    fn normalized_impl(&amp;self, db: &amp;&#x27;db dyn Db, visitor: &amp;NormalizedVisitor&lt;&#x27;db&gt;) -&gt; Self {
+    fn map&lt;F&gt;(&amp;self, mut map: F) -&gt; Self
+    where
+        F: FnMut(&amp;Type&lt;&#x27;db&gt;) -&gt; Type&lt;&#x27;db&gt;,
+    {
         match self {
             NegativeIntersectionElements::Empty =&gt; NegativeIntersectionElements::Empty,
             NegativeIntersectionElements::Single(ty) =&gt; {
-                NegativeIntersectionElements::Single(ty.normalized_impl(db, visitor))
+                NegativeIntersectionElements::Single(map(ty))
+            }
+            NegativeIntersectionElements::Multiple(set) =&gt; {
+                NegativeIntersectionElements::Multiple(set.into_iter().map(map).collect())
+            }
+        }
+    }
+
+    fn try_map&lt;F&gt;(&amp;self, mut map: F) -&gt; Option&lt;Self&gt;
+    where
+        F: FnMut(&amp;Type&lt;&#x27;db&gt;) -&gt; Option&lt;Type&lt;&#x27;db&gt;&gt;,
+    {
+        Some(match self {
+            NegativeIntersectionElements::Empty =&gt; NegativeIntersectionElements::Empty,
+            NegativeIntersectionElements::Single(ty) =&gt; {
+                NegativeIntersectionElements::Single(map(ty)?)
             }
             NegativeIntersectionElements::Multiple(set) =&gt; {
-                let mut set: FxOrderSet&lt;Type&lt;&#x27;db&gt;&gt; = set
-                    .iter()
-                    .map(|ty| ty.normalized_impl(db, visitor))
-                    .collect();
-
-                set.sort_unstable_by(|l, r| union_or_intersection_elements_ordering(db, l, r));
-                NegativeIntersectionElements::Multiple(set)
+                let set: Option&lt;FxOrderSet&lt;_&gt;&gt; = set.into_iter().map(map).collect();
+                NegativeIntersectionElements::Multiple(set?)
             }
-        }
+        })
+    }
+
+    fn normalized_impl(&amp;self, db: &amp;&#x27;db dyn Db, visitor: &amp;NormalizedVisitor&lt;&#x27;db&gt;) -&gt; Self {
+        let mut normalized = self.map(|ty| ty.normalized_impl(db, visitor));
+        normalized.sort_unstable_by(|l, r| union_or_intersection_elements_ordering(db, l, r));
+        normalized
     }
 
     fn recursive_type_normalized_impl(
@@ -14549,33 +14568,17 @@
         div: Type&lt;&#x27;db&gt;,
         nested: bool,
     ) -&gt; Option&lt;Self&gt; {
-        match self {
-            NegativeIntersectionElements::Empty =&gt; Some(NegativeIntersectionElements::Empty),
-            NegativeIntersectionElements::Single(ty) =&gt; {
-                let ty = if nested {
-                    ty.recursive_type_normalized_impl(db, div, nested)?
-                } else {
-                    ty.recursive_type_normalized_impl(db, div, nested)
-                        .unwrap_or(div)
-                };
-                Some(NegativeIntersectionElements::Single(ty))
-            }
-            NegativeIntersectionElements::Multiple(set) =&gt; {
-                let set = if nested {
-                    set.iter()
-                        .map(|ty| ty.recursive_type_normalized_impl(db, div, nested))
-                        .collect::&lt;Option&lt;FxOrderSet&lt;Type&lt;&#x27;db&gt;&gt;&gt;&gt;()?
-                } else {
-                    set.iter()
-                        .map(|ty| {
-                            ty.recursive_type_normalized_impl(db, div, nested)
-                                .unwrap_or(div)
-                        })
-                        .collect()
-                };
-                Some(NegativeIntersectionElements::Multiple(set))
-            }
-        }
+        let normalized = if nested {
+            self.try_map(|ty| ty.recursive_type_normalized_impl(db, div, nested))?
+        } else {
+            self.map(|ty| {
+                ty.recursive_type_normalized_impl(db, div, nested)
+                    .unwrap_or(div)
+            })
+        };
+
+        // Interesting, we don&#x27;t sort here???
+        Some(normalized)
     }
 }
 
</code></pre>
<p>I find this does a better job at abstracting how we represent the negated elements internally.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2026-01-05 13:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types.rs</code>:14629 on 2026-01-05 13:24</div>
            <div class="timeline-body"><p>Ah, that <em>is</em> nice, thanks! Applied.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2026-01-05 13:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-05 13:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-05 13:41</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2026-01-05 13:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2026-01-05 15:27</div>
            <div class="timeline-body"><blockquote>
<p>#22353 applies the same optimisation to <code>IntersectionType::positive()</code>. It <em>might</em> provide an additional speedup on top of the changes in this PR. But the effect of applying the optimisation to <code>IntersectionType::positive</code> looks to be much smaller than the effect of applying it to <code>IntersectionType::negative</code>, and the change adds further complexity. So I&#x27;d prefer to consider that as a standalone change after this lands (if this PR is accepted).</p>
</blockquote>
<p>I rebased #22353 on <code>main</code> after this landed, and the performance impact was not impressive: <a href="https://github.com/astral-sh/ruff/pull/22353">astral-sh/ruff#22353</a>#issuecomment-3710891185. So it looks like this is best kept as only an optimisation for <code>IntersectionType::negative</code>.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:22:33 UTC
    </footer>
</body>
</html>
