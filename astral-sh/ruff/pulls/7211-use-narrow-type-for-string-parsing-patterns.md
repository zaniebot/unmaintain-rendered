```yaml
number: 7211
title: Use narrow type for string parsing patterns
type: pull_request
state: merged
author: dhruvmanila
labels:
  - internal
  - parser
  - python312
assignees: []
merged: true
base: dhruv/pep-701
head: dhruv/fstring-parser-2
created_at: 2023-09-07T05:30:39Z
updated_at: 2023-09-14T02:16:10Z
url: https://github.com/astral-sh/ruff/pull/7211
synced_at: 2026-01-12T02:39:09Z
```

# Use narrow type for string parsing patterns

---

_Pull request opened by @dhruvmanila on 2023-09-07 05:30_

## Summary

This PR adds a new enum type `StringType` which is either a string literal, byte literal or f-string. The motivation behind this is to have a narrow type which is accepted in `concatenate_strings` as that function is only applicable for the mentioned 3 types. This makes the code more readable and easy to reason about.

A future improvement (which was prototyped here and removed) is to split the current string literal pattern in LALRPOP definition into two parts:
1. A single string literal or a f-string: This means no checking for bytes / non-bytes and other unnecessary compution
2. Two or more of string/byte/f-string: This will call the `concatenate_strings` function.

The reason for removing the second change is because of how ranges work. The range for an individual string/byte is the entire range which includes the quotes as well but if the same string/byte is part of a f-string, then it only includes the range for the content (without the quotes / inner range). The current string parser returns with the former range.

To give an example, for `"foo"`, the range of the string would be `0..5`, but for `f"foo"` the range of the string would be `2..5` while the range for the f-string expression would be `0..6`. The ranges are correct but they differ in the context the string constant itself is being used for. Is it part of a f-string or is it a standalone string?

## Test Plan

`cargo test`


---

_Comment by @dhruvmanila on 2023-09-07 05:30_

Current dependencies on/for this PR:
* main
  * **PR #7035** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7035" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7013** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7013" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #6659** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6659" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #7041** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7041" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #7211** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7211" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  üëà
            * **PR #7263** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7263" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
              * **PR #7331** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7331" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
                * **PR #7325** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7325" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
                  * **PR #7326** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7326" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
                    * **PR #7327** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7327" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
                      * **PR #7328** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7328" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
                        * **PR #7329** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7329" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7211?utm_source=stack-comment).

---

_Label `parser` added by @dhruvmanila on 2023-09-07 07:23_

---

_Renamed from "Use narrow types for string parsing patterns" to "Use narrow type for string parsing patterns" by @dhruvmanila on 2023-09-07 12:24_

---

_Marked ready for review by @dhruvmanila on 2023-09-07 12:31_

---

_Review requested from @MichaReiser by @dhruvmanila on 2023-09-07 12:34_

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/python.lalrpop`:672 on 2023-09-07 12:58_

Is using `@L` for the `end_location` intentional?

---

_@MichaReiser approved on 2023-09-07 12:59_

---

_@dhruvmanila reviewed on 2023-09-07 13:26_

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/python.lalrpop`:672 on 2023-09-07 13:26_

Oh, it must be a typo. Thanks for pointing it out. This reminds me that I should write some test cases around strings used in match cases and mapping keys.

---

_Label `internal` added by @dhruvmanila on 2023-09-08 03:30_

---

_Label `python312` added by @dhruvmanila on 2023-09-12 11:17_

---

_Comment by @codspeed-hq[bot] on 2023-09-14 01:49_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/dhruv/fstring-parser-2)

### Merging #7211 will **degrade performances by 9.7%**

<sub>:warning: No base runs were found</sub>

<sub>Falling back to comparing <code>dhruv/fstring-parser-2</code> (5f17468) with <code>main</code> (04183b0)</sub>



### Summary

`‚ùå 8` regressions
`‚úÖ 17` untouched benchmarks



> :warning: _Please fix the performance issues or [acknowledge them on CodSpeed](https://codspeed.io/astral-sh/ruff/branches/dhruv/fstring-parser-2)._

### Benchmarks breakdown

|     | Benchmark | `main` | `dhruv/fstring-parser-2` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ‚ùå | `lexer[numpy/globals.py]` | 233.2 ¬µs | 252.9 ¬µs | -7.8% |
| ‚ùå | `lexer[large/dataset.py]` | 9.8 ms | 10.7 ms | -8.4% |
| ‚ùå | `lexer[pydantic/types.py]` | 4.1 ms | 4.6 ms | -9.7% |
| ‚ùå | `parser[numpy/ctypeslib.py]` | 12.4 ms | 12.7 ms | -2.31% |
| ‚ùå | `parser[large/dataset.py]` | 68.4 ms | 70 ms | -2.29% |
| ‚ùå | `lexer[numpy/ctypeslib.py]` | 2 ms | 2.1 ms | -7.71% |
| ‚ùå | `lexer[unicode/pypinyin.py]` | 620.2 ¬µs | 673.4 ¬µs | -7.89% |
| ‚ùå | `parser[unicode/pypinyin.py]` | 4.3 ms | 4.4 ms | -2.53% |


---

_Merged by @dhruvmanila on 2023-09-14 02:07_

---

_Closed by @dhruvmanila on 2023-09-14 02:07_

---

_Branch deleted on 2023-09-14 02:07_

---
