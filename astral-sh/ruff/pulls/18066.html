<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Support property tests for `BoundSuper` - astral-sh/ruff #18066</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Support property tests for <code>BoundSuper</code></h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18066">#18066</a>
        opened by <a href="https://github.com/cake-monotone">@cake-monotone</a>
        on 2025-05-13 12:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/cake-monotone">@cake-monotone</a></div>
            <div class="timeline-body">

Summary
<p>This PR includes the following changes:</p>
<ul>
<li><p>Fix incorrect <code>disjoint_from</code> behavior for <code>BoundSuper</code> types with dynamic parameters</p>
</li>
<li><p>Add <code>Ty::BoundSuper</code> cases to property tests</p>
</li>
</ul>
Test Plan
<ol>
<li>Property tests for <code>BoundSuper</code></li>
</ol>
<ul>
<li><code>QUICKCHECK_TESTS=10000 cargo test -p ty_python_semantic -- --ignored types::property_tests::stable</code></li>
</ul>
<ol>
<li>Regression tests for incorrect disjoint_from behavior (mdtest)</li>
</ol>
<ul>
<li><code>cargo test -p ty_python_semantic --test mdtest -- disjoint</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/cake-monotone">@cake-monotone</a> on 2025-05-13 12:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/cake-monotone">@cake-monotone</a> on 2025-05-13 12:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/cake-monotone">@cake-monotone</a> on 2025-05-13 12:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/cake-monotone">@cake-monotone</a> on 2025-05-13 12:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-13 12:32</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>hydra-zen (https://github.com/mit-ll-responsible-ai/hydra-zen)
+ error[type-assertion-failure] tests/annotations/declarations.py:951:5: Actual type `FullBuilds[Unknown] | StdBuilds[Unknown]` is not the same as asserted type `FullBuilds[@Todo(Support for `typing.TypeAlias`)] | StdBuilds[@Todo(Support for `typing.TypeAlias`)]`
- Found 649 diagnostics
+ Found 650 diagnostics

</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-13 13:07</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-05-13 19:58</div>
            <div class="timeline-body"><p>Nice, thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-05-13 19:59</div>
            <div class="timeline-body"><p>Can you run with <code>QUICKCHECK_TESTS=1000000</code>? We&#x27;ve seen infrequent failures that show up in CI later be consistently missed with lower quickcheck counts.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cake-monotone">@cake-monotone</a> on 2025-05-14 14:27</div>
            <div class="timeline-body"><blockquote>
<p>Can you run with <code>QUICKCHECK_TESTS=1000000</code>? We&#x27;ve seen infrequent failures that show up in CI later be consistently missed with lower quickcheck counts.</p>
</blockquote>
<p>Okay!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cake-monotone">@cake-monotone</a> on 2025-05-14 14:36</div>
            <div class="timeline-body"><p>I tried it out and got an error related to tuple.</p>
<p>It seems like <code>tuple</code> is never disjoint from any instance type, for example <code>is_disjoint_from(tuple[()], int)</code> returns False:
https://play.ty.dev/29a090cb-4019-4b2b-a554-8b80e86ff457</p>
<p>I think this is a related issue with #18004. Similar to <a href="https://github.com/astral-sh/ruff/pull/18004">#18004</a>, we could temporarily work around this by disabling the following code:
https://github.com/astral-sh/ruff/blob/5f3d8f6b21ebd8afa91a8fec8383defbebfb7408/crates/ty_python_semantic/src/types/property_tests/type_generation.rs#L321-L325</p>
<p>But the quality of the daily property tests might suffer a bit until it&#x27;s properly fixed.
Shall we try disabling tuple generation for now?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-05-16 14:18</div>
            <div class="timeline-body"><blockquote>
<p>It seems like <code>tuple</code> is never disjoint from any instance type</p>
</blockquote>
<p>I think this is correct based on our current definition of the tuple type as including potential user subclasses of <code>tuple</code>, which might multiply-inherit from the other type as well. (Well, in the specific case of <code>int</code> we could consider it disjoint due to &quot;multiple bases have instance layout conflict&quot;, but we don&#x27;t model that yet.)</p>
<p>What specific property test does this end up failing?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/cake-monotone">@cake-monotone</a> on 2025-05-17 10:08</div>
            <div class="timeline-body"><blockquote>
<p>What specific property test does this end up failing?</p>
</blockquote>
<pre><code>all_fully_static_type_pairs_are_subtype_of_their_union
[AlwaysFalsy, tuple[()] | ~super(int, int)]
</code></pre>
<p>which means <code>tuple[()] | ~super(int, int)</code> is expected to be a subtype of  <code>AlwaysFalsy | tuple[()] | ~super(int, int)</code>.</p>
<p>At this moment, <code>AlwaysFalsy | tuple[()] | ~super(int, int)</code> will become <code>~super(int, int)</code></p>
<p>its because:</p>
<ul>
<li>AlwaysFalsy | tuple[()] = AlwaysFalsy  (<code>tuple[()]</code> is a subtype of <code>AlwaysFalsy</code>)</li>
<li>AlwaysFalsy | ~super&lt;int, int&gt; = ~super&lt;int, int&gt; (<code>super&lt;int, int&gt;.bool()</code> == <code>AlwaysTrue</code>)</li>
</ul>
<p>However, <code>tuple[()] | ~super(int, int)</code> is not a subtype of <code>~super(int, int)</code></p>
<p>its because:</p>
<ul>
<li><code>tuple[()]</code> is not subtype of <code>~super(int, int)</code>  (I guess it&#x27;s wrong)</li>
</ul>
<p>If my understanding is correct, two things need to be addressed:</p>
<ul>
<li>The empty tuple literal <code>tuple[()]</code> should be handled more accurately.</li>
<li>The <code>BoundSuper</code> type should represent a set of special instances (not including custom child class of <code>super</code>). Therefore, <code>is_disjoint_from(tuple[...], BoundSuper)</code> should return <code>true</code>, unlike with typical instances.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-06-10 15:54</div>
            <div class="timeline-body"><p>Sorry for delay getting back to this. Our latest thinking is that we do want empty tuple to continue to be a subtype of <code>AlwaysFalsy</code> (and we will forbid user subclasses of tuple from overriding <code>__bool__</code>, to make this sound). I think this means that our handling of empty tuple is OK here, but we do need to fix that <code>BoundSuper</code> should be a more limited type, and disjoint from arbitrary instances. It seems like that should be sufficient here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/AlexWaygood">@AlexWaygood</a> removed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-10 15:55</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:14:27 UTC
    </footer>
</body>
</html>
