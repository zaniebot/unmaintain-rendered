<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] `Literal[True,False]` normalized to `builtins.bool` - astral-sh/ruff #13178</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] <code>Literal[True,False]</code> normalized to <code>builtins.bool</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13178">#13178</a>
        opened by <a href="https://github.com/dylwil3">@dylwil3</a>
        on 2024-08-31 03:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a></div>
            <div class="timeline-body"><p>The <code>UnionBuilder</code> builds <code>builtins.bool</code> when handed <code>Literal[True]</code> and <code>Literal[False]</code>.</p>
<p>Caveat: If the builtins module is unfindable somehow, the builder falls back to the union type of these two literals.</p>
<p>First task from astral-sh/ty#245</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-08-31 03:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-08-31 03:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-08-31 03:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dylwil3">@dylwil3</a> on 2024-08-31 03:48</div>
            <div class="timeline-body"><p>Note: Attempting to call <code>builtins_symbol_ty_by_name</code> on a the default <code>TestDb</code> (without making a <code>src</code> directory and initializing a <code>Program</code>) causes a panic. Is this expected behavior? From the docstring I would&#x27;ve expected to just get <code>Type::Unbound</code>. The panic originates from <code>Program::get(db)</code> here:</p>
<p>https://github.com/astral-sh/ruff/blob/3ceedf76b8df1cfe749d0bb4c4f0aad6ee97ef6a/crates/red_knot_python_semantic/src/module_resolver/resolver.rs#L545-L550</p>
<p>If that&#x27;s unexpected I can open an issue.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-08-31 03:55</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>âœ… ecosystem check detected no linter changes.</p>
Linter (preview)
<p>âœ… ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/builder.rs</code>:278 on 2024-08-31 04:34</div>
            <div class="timeline-body"><p>I think it would be fine to just add all this to the existing <code>setup_db</code> in this module. It&#x27;s using a memory &quot;file system&quot; so nothing very slow is happening here. If the builders may now depend on Program, it&#x27;s better to just have it in all tests and not have to think about which tests need what kind of setup.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/builder.rs</code>:65 on 2024-08-31 04:42</div>
            <div class="timeline-body"><p>So I should have been clearer in my description of the desired behavior; we want to not just ensure that we can&#x27;t build a union containing exactly Literal[True] and Literal[False], we want to ensure that any union we build, even if it contains other types also, always replaces those two Literals, if both present, with bool.</p>
<p>So let&#x27;s add a test for the case where there is also another type in the union.</p>
<p>To implement this, I think we&#x27;ll probably want to add a <code>simplify</code> method that gets called before building the final union, similar to what we have for intersections. It can do a single pass over the elements, tracking whether it finds both Boolean literal types, and if so removing them both and adding bool.</p>
<p>The other way to handle it might be upfront when types are added. This seems like it might be less efficient given the need to search the existing elements for the other literal bool type whenever a literal bool type is added to the union. But this is probably ok in practice, especially if we can do it only when a previously-not-present literal bool type is added to the union. I think whichever seems to work out better in the code can be fine.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> requested changes on 2024-08-31 04:46</div>
            <div class="timeline-body"><p>Thank you!!</p>
<p>It&#x27;s not great that we can create a TestDb without a Program which will then panic in some cases; it&#x27;d be ideal if creating a TestDb always created a fully functional db, or if the lack of a Program were handled more gracefully than a panic. Thanks for catching that! I can create an issue for it later; should be addressed separately.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-31 17:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2024-09-01 02:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/red_knot_python_semantic/src/types/builder.rs</code>:278 on 2024-09-01 02:39</div>
            <div class="timeline-body"><p>Done!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dylwil3">@dylwil3</a> reviewed on 2024-09-01 02:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dylwil3">@dylwil3</a> on <code>crates/red_knot_python_semantic/src/types/builder.rs</code>:65 on 2024-09-01 02:41</div>
            <div class="timeline-body"><p>Whoops that was definitely my bad ðŸ˜… Let me know if the current commit is any closer!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/builder.rs</code>:68 on 2024-09-01 05:38</div>
            <div class="timeline-body"><p>nice approach!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/builder.rs</code>:75 on 2024-09-01 05:40</div>
            <div class="timeline-body"><p>I would just eliminate this check; if someone uses a typeshed without a <code>bool</code> type, then <code>Unknown</code> is the right type here. (I think there&#x27;s a separate TODO we should address, which is that in most cases where we look up a type from builtins, we should be replacing <code>Unbound</code> with <code>Unknown</code> -- but this code here shouldn&#x27;t be worrying about that detail.)</p>
<pre><code>            self.elements.remove(&amp;Type::BooleanLiteral(true));
            self.elements.remove(&amp;Type::BooleanLiteral(false));
            self.elements.insert(bool_ty);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-09-01 05:42</div>
            <div class="timeline-body"><p>Looks great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2024-09-01 05:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2024-09-01 05:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-09-01 12:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-09-02 07:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/builder.rs</code>:68 on 2024-09-02 07:56</div>
            <div class="timeline-body"><p>It would be interesting to look at the generated code. <code>into</code> creates an <code>OrderSet</code> which in turn allocates.</p>
<p>I prefer using <code>self.elements.contains(Type::BooleanLiteral(true) &amp;&amp; self.elements.contains(Type::BooleanLiteral(false))</code>, which does not depend on the compiler being able to see through that the allocation isn&#x27;t necessary (which requires rather involved analysis)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:06:27 UTC
    </footer>
</body>
</html>
