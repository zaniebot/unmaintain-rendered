```yaml
number: 6973
title: Avoid parenthesizing multiline strings in binary expressions
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: avoid-parenthesizing-multiline-strings
created_at: 2023-08-29T11:37:23Z
updated_at: 2023-08-30T14:03:18Z
url: https://github.com/astral-sh/ruff/pull/6973
synced_at: 2026-01-12T02:45:38Z
```

# Avoid parenthesizing multiline strings in binary expressions

---

_Pull request opened by @MichaReiser on 2023-08-29 11:37_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

Avoid parenthesizing binary expressions that have a left multiline string and a parenthesized right side because the multiline string is guarnateed not to fit. 

<!-- What's the purpose of the change? What does it do, and why? -->

## Test Plan

Added unit tests. 

The similarity index for django increases from 0.99948 to 0.99957 (one file less with changes). This change does not impact the other projects. 

<!-- How was it tested? -->


---

_Comment by @MichaReiser on 2023-08-29 11:37_

Current dependencies on/for this PR:
* main
  * **PR #6973** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6973" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6973?utm_source=stack-comment).

---

_Label `formatter` added by @MichaReiser on 2023-08-29 11:37_

---

_@charliermarsh reviewed on 2023-08-29 16:05_

---

_Review comment by @charliermarsh on `crates/ruff_python_formatter/src/expression/expr_bin_op.rs`:278 on 2023-08-29 16:05_

What if the left or right has comments, but is itself parenthesized and thus doesn't require these outer parentheses, like:

```python
expected_content = (
    """<?xml version="1.0" encoding="UTF-8"?>
<sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
<sitemap><loc>%s/simple/sitemap-simple.xml</loc><lastmod>%s</lastmod>
</sitemap>
</sitemapindex>
"""
    %
    (
        # Doesnt need parentheses
        self.base_url
    )
)
```


---

_@MichaReiser reviewed on 2023-08-30 08:23_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_bin_op.rs`:278 on 2023-08-30 08:23_

I added a test for parenthesized right sides but decided to keep the formatting as is if the right side contains any leading comments because our current binary expression formatting would format the above as

```python
expected_content = 
    """<?xml version="1.0" encoding="UTF-8"?>
<sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
<sitemap><loc>%s/simple/sitemap-simple.xml</loc><lastmod>%s</lastmod>
</sitemap>
</sitemapindex>
"""
%
(
      # Doesnt need parentheses
      self.base_url
)
```

Which results in a syntax error. I haven't seen this in any real project yet and don't think it justifies implementing an entire new binary expression layout.

---

_@charliermarsh approved on 2023-08-30 13:38_

---

_Merged by @MichaReiser on 2023-08-30 14:03_

---

_Closed by @MichaReiser on 2023-08-30 14:03_

---

_Branch deleted on 2023-08-30 14:03_

---
