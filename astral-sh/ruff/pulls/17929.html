<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Recursive protocols - astral-sh/ruff #17929</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Recursive protocols</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17929">#17929</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-05-07 19:34
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-07 19:34</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Use a self-reference &quot;marker&quot; ~~and fixpoint iteration~~ to solve the stack overflow problems with recursive protocols. This is not pretty and somewhat tedious, but seems to work fine. Much better than all my fixpoint-iteration attempts anyway.</p>
<p>closes https://github.com/astral-sh/ty/issues/93</p>
<h2>Test Plan</h2>
<p>New Markdown tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @sharkdp on 2025-05-07 19:34</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-07 19:38</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @sharkdp on 2025-05-08 13:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-05-08 13:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-05-08 13:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @sharkdp on 2025-05-08 13:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-05-08 13:17</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @sharkdp on 2025-05-08 13:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-08 13:19</div>
            <div class="timeline-body"><p>Moving this out of draft-mode to get a general review before I spend more time resolving all the minor TODOs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-05-08 13:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types.rs</code>:652 on 2025-05-08 13:40</div>
            <div class="timeline-body"><p>could you add this test, with a TODO comment that it should pass? (It doesn't overflow, but the static assertion fails.) I can tackle it later.</p>
<pre><code class="language-py">class Foo(Protocol):
    @property
    def x(self) -&gt; &quot;Foo&quot;: ...

class Bar(Protocol):
    @property
    def x(self) -&gt; &quot;Bar&quot;: ...

static_assert(is_equivalent_to(Foo, Bar))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/protocols.md</code>:1620 on 2025-05-08 13:47</div>
            <div class="timeline-body"><pre><code class="language-suggestion">Make sure that we handle self-reference correctly, even if the self-reference appears deeply nested
within the type of a protocol member:
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/protocol_class.rs</code>:119 on 2025-05-08 13:50</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        self.members(db).all(|member| member.ty.is_fully_static(db))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-05-08 13:52</div>
            <div class="timeline-body"><p>This looks like an excellent solution to me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/resources/mdtest/protocols.md</code>:1632 on 2025-05-08 14:15</div>
            <div class="timeline-body"><pre><code class="language-suggestion">Make sure that we handle self-reference correctly, even if the self-reference appears deeply nested
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-05-08 14:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-05-08 14:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/resources/mdtest/protocols.md</code>:1632 on 2025-05-08 14:20</div>
            <div class="timeline-body"><p>mdformat, what are you doing...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-05-08 14:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/resources/mdtest/protocols.md</code>:1632 on 2025-05-08 14:38</div>
            <div class="timeline-body"><p>Someday I'll write a markdown formatter ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types.rs</code>:634 on 2025-05-08 16:10</div>
            <div class="timeline-body"><p>Was just about to ask if we could re-use this technique for generics :smile:</p>
<p>:+1: for it being a TODO</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-05-08 16:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/protocols.md</code>:1674 on 2025-05-08 17:03</div>
            <div class="timeline-body"><p>These assertions are good, but it would be nice to also have some assertions that we actually understand these nested recursive types, e.g. that <code>instance_of_recursive.t[1][1]</code> is <code>Recursive</code>, etc.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types.rs</code>:598 on 2025-05-08 17:05</div>
            <div class="timeline-body"><p>Should we be consistent about naming? <code>replace_self_reference</code> vs <code>replace_recursive_reference</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types.rs</code>:594 on 2025-05-08 17:08</div>
            <div class="timeline-body"><p>I suspect that in order to reuse this for generics, we might have to accept more possibilities here than just ClassLiteral?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/protocol_class.rs</code>:69 on 2025-05-08 17:20</div>
            <div class="timeline-body"><p>It seems like this approach has a significant limitation, in that it can handle direct self-reference, but it can't handle mutual recursion (because we can only represent a self-reference, not a &quot;recursive reference to arbitrary something&quot;, which means we can't break a recursive loop involving more than one protocol.) And indeed, this still stack overflows on this branch:</p>
<pre><code class="language-py">from __future__ import annotations

from typing import Protocol
from ty_extensions import is_fully_static, is_subtype_of, static_assert

class Foo(Protocol):
    x: Bar

class Bar(Protocol):
    x: Foo

static_assert(is_fully_static(Foo))
static_assert(is_fully_static(Bar))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-05-08 17:24</div>
            <div class="timeline-body"><p>Thank you!!</p>
<p>This clearly addresses a lot of the practical cases we see, but it does still have a problem with mutual recursion of multiple different classes.</p>
<p>I think we could consider landing this anyway as an initial step, but I think we will need to figure out how to generalize it beyond simple self-reference.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-05-08 17:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types.rs</code>:634 on 2025-05-08 17:26</div>
            <div class="timeline-body"><p>The doc-comment of this function is probably more relevant? This is just the place where we would also have to look for references to the protocol class.</p>
<p>Instead of <code>ClassLiteral</code>, I would imagine that this function would maybe have to take <code>Type</code> as an argument if we want to handle self-referential type aliases like <code>type Tree = dict[str, Tree]</code>. Or maybe an enum (different things that we would want to replace).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-05-08 18:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types.rs</code>:594 on 2025-05-08 18:12</div>
            <div class="timeline-body"><p>Yes, see the other comment above in response to Doug (which I wrote after this was posted, I guess).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-05-08 18:30</div>
            <div class="timeline-body"><p>After talking to @carljm we decided to merge this as an immediate solution to an observed real-world problem. I don't think it introduces any <em>wrong</em> behavior either. And as Carl pointed out, the tests are hopefully useful in any case.</p>
<p>That said, we also think that there are severe limitations here (see Carl's comment regarding mutually-recursive protocols). And it's also not clear if this is a generalizable solution that would also work for self-referential type aliases or generic classes. @dcreager: it's probably not useful to spend time right now trying to make this specific approach here work for generics.</p>
<p>What I will do instead after merging this is to take one step back and think about <a href="https://github.com/astral-sh/ty/issues/256">the broader problem here</a>, and do some research. Hopefully that leads to a general solution. I might not be able to spend the necessary amount of time on this before Tuesday. So if anyone else wants to work on this before then, feel free to do that (let me know).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-05-09 12:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-05-09 12:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-05-09 12:54</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:57:30 UTC
    </footer>
</body>
</html>
