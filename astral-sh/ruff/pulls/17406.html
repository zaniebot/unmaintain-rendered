<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Dataclasses: support `order=True` - astral-sh/ruff #17406</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Dataclasses: support <code>order=True</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17406">#17406</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-04-15 09:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-15 09:50</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Support dataclasses with <code>order=True</code>:</p>
<pre><code class="language-py">@dataclass(order=True)
class WithOrder:
    x: int

WithOrder(1) &lt; WithOrder(2)  # no error
</code></pre>
<p>Also adds some additional tests to <code>dataclasses.md</code>.</p>
<p>ticket: #16651</p>
<h2>Test Plan</h2>
<p>New Markdown tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @sharkdp on 2025-04-15 09:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-15 09:53</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @sharkdp on 2025-04-15 10:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-04-15 10:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-04-15 10:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @sharkdp on 2025-04-15 10:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-15 10:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>.github/workflows/mypy_primer.yaml</code>:71 on 2025-04-15 10:50</div>
            <div class="timeline-body"><p>I added a few projects with dataclass usage, some of which use <code>order=True</code>, but still no ecosystem changes. The usage of the order-methods is often hidden, e.g. by adding dataclass instances to a list which will then be sorted. We did not previously emit false positives in these cases (would rely on generics), so there are obviously no changes now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-15 13:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:850 on 2025-04-15 13:53</div>
            <div class="timeline-body"><p>@dcreager Here, I'm synthesizing a signature for autogenerated <code>__lt__</code> methods (and similar) for dataclasses. I think the <code>other</code> argument should have an annotated type of <code>Self</code>, such that instances of the dataclass can be compared with <code>other</code> instances, but not with completely unrelated types. Since we don't have <code>Self</code> yet, I tried to construct the <code>Type::Instance(â€¦)</code> type that corresponds to this <code>ClassLiteralType</code>. Would you mind taking a look at the <code>self.default_specialization(db)</code> call here to see if that looks correct?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:838 on 2025-04-15 13:56</div>
            <div class="timeline-body"><p>As an aside, we might consider an <code>impl From&lt;Signature&gt; for Symbol</code> since this pattern is starting to show up a lot</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:850 on 2025-04-15 14:04</div>
            <div class="timeline-body"><p>I think where this might fail is when you're autogenerating <code>__lt__</code> for a generic alias (a specialized generic class) â€” you'd end up with the argument annotated with the default specialization applied, and not the specialization from the generic alias:</p>
<pre><code class="language-py">@dataclass(order=True)
class A[T]:
    x: T

reveal_type(A[int].__lt__)  # might be: A[Any] â†’ bool 
</code></pre>
<p><code>ClassLiteralType::class_member</code> has a <code>specialization</code> parameter, which <code>ClassType</code> uses to pass down the generic alias's specialization if there is one. That way we can apply it to the base classes in the MRO. I think the fix would be to pass that along to <code>ClassLiteralType::own_class_member</code>, and <em>that's</em> the specialization that you would apply to <code>other</code>. (And you might want to add a new <code>Type::apply_optional_specialization</code> to make that a bit more ergonomic)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-04-15 14:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-15 20:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:838 on 2025-04-15 20:02</div>
            <div class="timeline-body"><p>I'll note this down as a (follow up) to-do.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-15 20:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/generics.rs</code>:119 on 2025-04-15 20:05</div>
            <div class="timeline-body"><p>We currently have a problem on main, where we do not consider two instances of <code>C[int]</code> to be the same: https://playknot.ruff.rs/ee8f9cb9-a73f-480a-bb2c-83b6e1bb5e89, since we were comparing Salsa IDs in <code>is_assignable_to</code>. Thank you @dcreager for helping me in tracking (heh) this down.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-15 20:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/generics.rs</code>:28 on 2025-04-15 20:07</div>
            <div class="timeline-body"><p>Haven't investigated why this is necessary. Can look into getting rid of this, if we see the need.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-15 20:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/dataclasses.md</code>:389 on 2025-04-15 20:08</div>
            <div class="timeline-body"><p>@AlexWaygood I already added a couple of non-<code>order</code>-related tests in this PR, so I added the test that you suggested as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-15 20:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:844 on 2025-04-15 20:10</div>
            <div class="timeline-body"><p>This is only true for bound methods. We currently infer the wrong signature for explicit dunder calls, e.g. <code>MyDataclass.__lt__(left, right)</code>. This is a pre-existing problem with <code>__init__</code> as well. I will tackle this in a separate follow-up.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-04-15 20:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/src/types/generics.rs</code>:28 on 2025-04-15 20:14</div>
            <div class="timeline-body"><p>The auto-generated <code>new</code> constructor for an interned struct has <code>Borrow</code>-like traits for its parameters, since it's doing a hash table lookup.  Whereas <code>new</code> for a tracked struct takes in the field type directly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-15 20:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/slots.rs</code>:27 on 2025-04-15 20:22</div>
            <div class="timeline-body"><p>Not completely sure about the <code>None</code> here...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-15 20:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:850 on 2025-04-15 20:24</div>
            <div class="timeline-body"><blockquote>
<p>I think where this might fail is when you're autogenerating <strong>lt</strong> for a generic alias (a specialized generic class) â€” you'd end up with the argument annotated with the default specialization applied, and not the specialization from the generic alias:</p>
</blockquote>
<p>Yes, that was exactly right. Fixed and added a test.</p>
<blockquote>
<p>And you might want to add a new <code>Type::apply_optional_specialization</code> to make that a bit more ergonomic</p>
</blockquote>
<p>I wasn't sure what you were suggesting here. Which part could be made more ergonomic? The <code>Type::instance(self.apply_optional_specialization(db, specialization))</code> construction?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-04-15 20:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/src/types/slots.rs</code>:27 on 2025-04-15 20:27</div>
            <div class="timeline-body"><p>That's correct, since <code>base</code> is a class literal (so if it's a generic class, it's not specialized yet), so it can't possibly have a specialization to pass down</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-04-15 20:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:850 on 2025-04-15 20:30</div>
            <div class="timeline-body"><blockquote>
<p>I wasn't sure what you were suggesting here. Which part could be made more ergonomic? The <code>Type::instance(self.apply_optional_specialization(db, specialization))</code> construction?</p>
</blockquote>
<p>Nope, now that I see how you've done it, disregard this suggestion! Was thinking you would apply the specialization to the <code>Type</code> â€” but that doesn't work, since you need to apply the specialization first to get a <code>ClassType</code> that you can pass to <code>Type::instance</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-04-15 21:16</div>
            <div class="timeline-body"><p>I re-ran the job five times and it succeeded every single time. I also couldn't reproduce the panic locally.</p>
<p><img src="https://github.com/user-attachments/assets/bfcf5b5a-a838-48c3-9cbb-1a207f2df8cb" alt="image" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>.github/workflows/mypy_primer.yaml</code>:71 on 2025-04-16 23:46</div>
            <div class="timeline-body"><p>ðŸŽ‰</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/dataclasses.md</code>:108 on 2025-04-16 23:47</div>
            <div class="timeline-body"><p>Hmm, I wonder if our display for bound methods really should show both the class the method was fetched from, and the object to which its <code>self</code> is bound...</p>
<p>Although mypy and pyright both reveal less than we do; they just reveal this as simply <code>() -&gt; str</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-04-16 23:50</div>
            <div class="timeline-body"><p>Looks good!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-04-17 06:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/dataclasses.md</code>:108 on 2025-04-17 06:58</div>
            <div class="timeline-body"><blockquote>
<p>Hmm, I wonder if our display for bound methods really should show both the class the method was fetched from, and the object to which its <code>self</code> is bound...</p>
</blockquote>
<p>That sounds potentially useful. What are some cases where this would show two different types? I can imagine something like <code>SomeClass.some_function.__get__(OtherClass())</code> which should show <code>&lt;bound method SomeFunction.some_function of OtherClass object&gt;</code>. But there are probably more realistic scenarios where this would show up?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-04-17 06:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-04-17 06:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-17 06:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-04-17 13:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/dataclasses.md</code>:108 on 2025-04-17 13:00</div>
            <div class="timeline-body"><p>The main case I was thinking of is simply inheritance without a method override, as in the case shown here. It's a bit confusing that even though <code>WithoutRepr</code> does not have its own <code>__repr__</code> and we are finding the <code>__repr__</code> from <code>object</code>, that we show <code>WithoutRepr.__repr__</code>, a syntax that implies a <code>__repr__</code> method defined on <code>WithoutRepr</code> class. I kind of want it to say <code>object.__repr__</code> instead, but then we would no longer be showing the type of the bound <code>self</code> object.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-05-02 08:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:838 on 2025-05-02 08:23</div>
            <div class="timeline-body"><p>This pattern has since vanished from our code base; removing the to-do.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:57:29 UTC
    </footer>
</body>
</html>
