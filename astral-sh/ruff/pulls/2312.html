<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improve rule config resolution - astral-sh/ruff #2312</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Improve rule config resolution</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/2312">#2312</a>
        opened by <a href="https://github.com/not-my-profile">@not-my-profile</a>
        on 2023-01-28 20:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/not-my-profile">@not-my-profile</a></div>
            <div class="timeline-body"><p>Ruff allows rules to be enabled with <code>select</code> and disabled with
<code>ignore</code>, where the more specific rule selector takes precedence,
for example:</p>
<pre><code>`--select ALL --ignore E501` selects all rules except E501
`--ignore ALL --select E501` selects only E501</code></pre>
<p>(If both selectors have the same specificity ignore selectors
take precedence.)</p>
<p>Ruff always had two quirks:</p>
<ul>
<li><p>If <code>pyproject.toml</code> specified <code>ignore = [&quot;E501&quot;]</code> then you could
previously not override that with <code>--select E501</code> on the command-line
(since the resolution didn&#x27;t take into account that the select was
specified after the ignore).</p>
</li>
<li><p>If <code>pyproject.toml</code> specified <code>select = [&quot;E501&quot;]</code> then you could
previously not override that with <code>--ignore E</code> on the command-line
(since the resolution didn&#x27;t take into account that the ignore was
specified after the select).</p>
</li>
</ul>
<p>Since d067efe2656dfa86c8ac2baa87f43f408e862a3a (#1245)
<code>extend-select</code> and <code>extend-ignore</code> always override
<code>select</code> and <code>ignore</code> and are applied iteratively in pairs,
which introduced another quirk:</p>
<ul>
<li>If some <code>pyproject.toml</code> file specified <code>extend-select</code>
or <code>extend-ignore</code>, <code>select</code> and <code>ignore</code> became pretty much
unreliable after that with no way of resetting that.</li>
</ul>
<p>This commit fixes all of these quirks by making later configuration
sources take precedence over earlier configuration sources.</p>
<p>While this is a breaking change, it fixes the broken status quo.</p>
<p>Fixes #2300.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Improve rule resolution&quot; to &quot;Improve rule config resolution&quot; by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-01-28 20:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-01-28 20:44</div>
            <div class="timeline-body"><p>I think this makes much more sense and is much more user-friendly / understandable.</p>
<p>This obviously breaks existing configurations that relied on the previous weird behavior ... however I&#x27;d expect most ruff config files to not rely on this weird behavior ... but that&#x27;s just a hunch.</p>
<p>How you want to go about this is very much your call. It would be possible to support both the old and the new config resolution at the same time and only use the new resolution based on some <code>tool.ruff.edition</code> setting but I am not really interested in implementing that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-28 20:47</div>
            <div class="timeline-body"><p>I just have to take a look at some of the more complex setups in the wild and see how they&#x27;d be affected.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-28 21:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/settings/configuration.rs</code>:211 on 2023-01-28 21:36</div>
            <div class="timeline-body"><p>I think this is backwards, since we want our selections to take precedence over those that we&#x27;re merging in (and so, they have to come later).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-28 21:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/settings/configuration.rs</code>:211 on 2023-01-28 21:37</div>
            <div class="timeline-body"><p>If I invert this, the Dagster repo (probably the most involved deployment) works as-is (no breaking change).</p>
<p>They have this config:</p>
<pre><code>[tool.ruff]

# Extend root configuration.
extend = &quot;../../pyproject.toml&quot;

# Match black. Note that this also checks comment line length, but black does not format comments.
line-length = 88

# Use extend-ignore so that we ignore all the same codes ignored in root.
extend-ignore = [

  # (Unused import): When the same symbol is imported in multiple blocks, the
  # last import takes precedence for python. This causes Ruff to think an
  # import in an earlier block is unused and report F401.
  &quot;F401&quot;,

  # (Redefinition): This happens frequently in docs_snippets when we import the same symbol in multiple
  # snippets within the same file.
  &quot;F811&quot;,

  # (local variable assigned but never used): This happens a lot in docs snippets for didactic
  # purposes.
  &quot;F841&quot;,

]
</code></pre>
<p>So, I guess that could now use <code>ignore</code> instead of <code>extend-ignore</code>, but it works either way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-28 21:41</div>
            <div class="timeline-body"><blockquote>
<p>How you want to go about this is very much your call. It would be possible to support both the old and the new config resolution at the same time and only use the new resolution based on some tool.ruff.edition setting but I am not really interested in implementing that.</p>
</blockquote>
<p>Don&#x27;t worry, I definitely don&#x27;t want to support both.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-28 21:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/settings/mod.rs</code>:245 on 2023-01-28 21:45</div>
            <div class="timeline-body"><p>Do you mind adding some comments throughout this method? Or explaining the logic in more detail here? I&#x27;m tracing it but having trouble following.</p>
<p>As a specific example: if I have <code>select = [&quot;F&quot;]</code> in my <code>pyproject.toml</code>, and I do <code>--select A</code>, then I end up with two rule selections:</p>
<pre><code>[RuleSelection { select: Some([Prefix { prefix: F, redirected_from: None }]), ignore: Some([Prefix { prefix: A, redirected_from: None }]), extend_select: None, extend_ignore: None, fixable: None, unfixable: None }, RuleSelection { select: Some([Prefix { prefix: A, redirected_from: None }]), ignore: None, extend_select: None, extend_ignore: None, fixable: None, unfixable: None }]
</code></pre>
<p>But, how do the <code>F</code> rules not end up in the select set?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-28 21:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/settings/mod.rs</code>:245 on 2023-01-28 21:51</div>
            <div class="timeline-body"><p>Oh, I see -- do we, in effect, only use the last <code>RuleSelection</code> that contains a non-empty <code>select</code>? The rest gets discarded?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-28 21:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/settings/mod.rs</code>:245 on 2023-01-28 21:53</div>
            <div class="timeline-body"><p>If that&#x27;s the correct interpretation how would I do the following: create a <code>pyproject.toml</code> that enables all the <code>F</code> rules, then extend it from another <code>pyproject.toml</code> to also include the <code>E</code> rules? I think I know the answer, but it would be helpful to hear it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-28 21:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/settings/mod.rs</code>:245 on 2023-01-28 21:55</div>
            <div class="timeline-body"><p>Separate question: under this scheme, is there <em>ever</em> any difference between specifying <code>ignore</code> and <code>extend-ignore</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/not-my-profile">@not-my-profile</a> reviewed on 2023-01-29 03:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on <code>src/settings/configuration.rs</code>:211 on 2023-01-29 03:19</div>
            <div class="timeline-body"><p>Ah yes ... very good catch! Thanks :) Fixed via force push.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on <code>src/settings/configuration.rs</code>:211 on 2023-01-29 03:20</div>
            <div class="timeline-body"><p>Nice that my assumption was correct in that it likely doesn&#x27;t break real world configs :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/not-my-profile">@not-my-profile</a> reviewed on 2023-01-29 03:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on <code>src/settings/mod.rs</code>:245 on 2023-01-29 03:49</div>
            <div class="timeline-body"><p>I added some comments :)</p>
<blockquote>
<p>if I have select = [&quot;F&quot;] in my pyproject.toml, and I do --select A, [..] But, how do the F rules not end up in the select set?</p>
</blockquote>
<p>If <code>selection.select.is_some()</code> then the <code>select_set</code> is overridden.</p>
<blockquote>
<p>do we, in effect, only use the last RuleSelection that contains a non-empty select? The rest gets discarded?</p>
</blockquote>
<p>No, multiple RuleSelections can all contribute to <code>select_set</code> if they only use <code>extend_select</code> / <code>ignore</code> but not <code>select</code>.</p>
<blockquote>
<p>how would I do the following: create a pyproject.toml that enables all the F rules, then extend it from another pyproject.toml to also include the E rules?</p>
</blockquote>
<p><code>select</code> can be extended via <code>extend-select</code>.</p>
<blockquote>
<p>Separate question: under this scheme, is there ever any difference between specifying ignore and extend-ignore?</p>
</blockquote>
<p>Very good catch! I didn&#x27;t even notice that but indeed we can deprecate <code>extend-ignore</code> since it now can always be replaced with <code>ignore</code>. The reasoning behind that is that now <code>ignore</code>/<code>extend-ignore</code> can only ever deselect already selected rules ... it&#x27;s impossible for an ignore option to take precedence over a latter select option. Since the &quot;ignore set&quot; isn&#x27;t something that is kept track of anymore ... the function only keeps track of the effectively selected rules, <code>extend-ignore</code> doesn&#x27;t fulfill any purpose anymore.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/not-my-profile">@not-my-profile</a> reviewed on 2023-01-29 03:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-01-29 04:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-29 18:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/settings/mod.rs</code>:245 on 2023-01-29 18:49</div>
            <div class="timeline-body"><p>Cool, I <em>think</em> this makes sense. I&#x27;d like to try adding a section in the README to explain this before we merge. If I do that, do you mind reviewing for clarity and correctness?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on <code>src/settings/mod.rs</code>:245 on 2023-01-29 20:29</div>
            <div class="timeline-body"><p>But of course :)</p>
<p>While I don&#x27;t think this will affect most ruff configurations this technically still is a breaking change, so we probably should also document it in <code>BREAKING_CHANGES.md</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/not-my-profile">@not-my-profile</a> reviewed on 2023-01-29 20:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-01-29 20:30</div>
            <div class="timeline-body"><p>(force pushed a small refactor that removed <code>extend_ignore</code> from the new <code>RuleSelection</code> struct and removed some needless <code>Option</code> wrapping around the fields that don&#x27;t require it)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-29 20:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/settings/mod.rs</code>:245 on 2023-01-29 20:36</div>
            <div class="timeline-body"><p>Definitely, will do. Mechanically, probably easiest for me to open those changes as a separate PR on <code>main</code> and then just rebase that PR after this merges...?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/not-my-profile">@not-my-profile</a> reviewed on 2023-01-29 20:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on <code>src/settings/mod.rs</code>:245 on 2023-01-29 20:40</div>
            <div class="timeline-body"><p>You have write permissions on my branch so you could just push your commits there :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/settings/mod.rs</code>:245 on 2023-01-29 22:37</div>
            <div class="timeline-body"><p>Ok, I went ahead and pushed a first-pass in the <code>README.md</code> and <code>BREAKING_CHANGES.md</code>. Feedback welcome.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-29 22:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/not-my-profile">@not-my-profile</a> reviewed on 2023-01-30 04:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on <code>src/settings/mod.rs</code>:245 on 2023-01-30 04:20</div>
            <div class="timeline-body"><p>Thank you so much, I think you described it very well :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on 2023-01-30 04:21</div>
            <div class="timeline-body"><p>(force pushed to fix the CI failure, which was caused by the README now including the <code>--extend-ignore</code> setting which this PR hides from the help output)</p>
<p>I think we should also mention in the new <em>Rule resolution</em> section in the README and the BREAKING_CHANGES.md entry that <code>extend-ignore</code> is now deprecated since it behaves exactly like <code>ignore</code>.</p>
<p>(This is now already mentioned in the documentation of the <code>extend-ignore</code> setting but I think it would make sense to repeat it ... note that I have also updated the CLI help to hide the <code>--extend-ignore</code> flag.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/settings/mod.rs</code>:245 on 2023-01-30 04:30</div>
            <div class="timeline-body"><p>Great. I&#x27;ll try to get this out tomorrow!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-30 04:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-30 13:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>README.md</code>:437 on 2023-01-30 13:08</div>
            <div class="timeline-body"><p>I do <em>kind</em> of wonder if we should just leave this visible in the CLI to avoid confusion (due to the asymmetry with <code>--select</code>). What do you think? Bad idea?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/not-my-profile">@not-my-profile</a> reviewed on 2023-01-30 17:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on <code>README.md</code>:437 on 2023-01-30 17:33</div>
            <div class="timeline-body"><p>If we leave it I think we should add <code>DEPRECATED</code> to the description ... however I don&#x27;t think that would really reduce the confusion since we&#x27;d have to explain why it&#x27;s deprecated ... which would probably be too verbose. I consider <code>--extend-ignore</code> to effectively be an alias for <code>--ignore</code> ... and we currently don&#x27;t document e.g. that <code>ruff clean</code> has <code>ruff --clean</code> as an alias in the CLI help.</p>
<p>I don&#x27;t have a strong opinion about this, if you think it should be listed we can add it back.</p>
<p>Note that I have also removed <code>extend-ignore</code> from the JSON schema ... which could also be confusing for users but I think it&#x27;s worth it to stop it from being autocompleted for users writing new configs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on <code>README.md</code>:437 on 2023-01-30 20:59</div>
            <div class="timeline-body"><p>I think I prefer to hide it. I have updated the message to mention that it&#x27;s deprecated since it still shows up in the clap shell completion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/not-my-profile">@not-my-profile</a> reviewed on 2023-01-30 20:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-30 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-30 21:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:52:01 UTC
    </footer>
</body>
</html>
