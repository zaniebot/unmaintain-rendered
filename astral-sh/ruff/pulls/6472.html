<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improve Ruff Formatter Interoperability - astral-sh/ruff #6472</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Improve Ruff Formatter Interoperability</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6472">#6472</a>
        opened by <a href="https://github.com/magic-akari">@magic-akari</a>
        on 2023-08-10 06:53
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/magic-akari">@magic-akari</a></div>
            <div class="timeline-body">

Summary
<p>Thank you for developing such an amazing project.</p>
<p>I am currently trying to port the ruff python formatter to wasm. See https://github.com/wasm-fmt/ruff_fmt
I ran into some issues that prevented me from moving forward.</p>
<p>Here are some changes to make it more interoperable for downstream developers:</p>
<ol>
<li>~Change the visibility of some structs. This is a straightforward task, adding some missing <code>pub</code> keywords.~</li>
<li>~Export some default config functions.~</li>
<li>Implement <code>FromStr</code> for some structs, so that users can easily parse configuration from strings.</li>
<li>Fix <code>with_quote_style</code></li>
<li>Fix <code>indent_style</code> serde default value</li>
</ol>
Test Plan
<p>Most of the changes don&#x27;t involve logic changes, except for a couple of <code>FromStrs</code>, and I&#x27;ll add test cases if necessary.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-10 06:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_formatter/src/lib.rs</code>:125 on 2023-08-10 06:55</div>
            <div class="timeline-body"><p>Thank you for exploring the use of the formatter in wasm. We already use the formatter in our playground and didn&#x27;t had a need to make these fields public. Could you explain why it is necessary to make the fields public for your use case. All the fields are intentionally private (here and in <code>PyFormatOptions</code>)</p>
<p>Also: We provide no API stability guarantees. Any of this could change at any time.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/magic-akari">@magic-akari</a> on <code>crates/ruff_formatter/src/lib.rs</code>:125 on 2023-08-10 07:12</div>
            <div class="timeline-body"><p>I hadn&#x27;t noticed that there was already a formatter for wasm, I looked at the documentation but didn&#x27;t find it.
My intention was to export it to the dprint plugin.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/magic-akari">@magic-akari</a> reviewed on 2023-08-10 07:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/magic-akari">@magic-akari</a> reviewed on 2023-08-10 07:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/magic-akari">@magic-akari</a> on <code>crates/ruff_formatter/src/lib.rs</code>:125 on 2023-08-10 07:15</div>
            <div class="timeline-body"><p>https://github.com/wasm-fmt/ruff_fmt/blob/60669453962a858bbdc3bf015b2f1771603c9104/crates/ruff_fmt_dprint/src/configuration/configuration.rs#L26</p>
<p>https://github.com/wasm-fmt/ruff_fmt/blob/60669453962a858bbdc3bf015b2f1771603c9104/crates/ruff_fmt_dprint/src/configuration/resolve_config.rs#L36-L42</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/magic-akari">@magic-akari</a> on 2023-08-10 07:35</div>
            <div class="timeline-body"><p>@MichaReiser
I need to adapt some configuration of dprint.
It looks like ruff&#x27;s playground formatter is not configurable.</p>
<p>https://github.com/astral-sh/ruff/blob/ac5c8bb3b683fb009b39098c00f9357e9aeb6e38/crates/ruff_wasm/src/lib.rs#L270-L276</p>
<p>https://github.com/astral-sh/ruff/blob/ac5c8bb3b683fb009b39098c00f9357e9aeb6e38/crates/ruff_python_formatter/src/options.rs#L54-L59</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-10 07:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_formatter/src/lib.rs</code>:125 on 2023-08-10 07:35</div>
            <div class="timeline-body"><blockquote>
<p><a href="https://github.com/wasm-fmt/ruff_fmt/blob/60669453962a858bbdc3bf015b2f1771603c9104/crates/ruff_fmt_dprint/src/configuration/configuration.rs#L26">wasm-fmt/ruff_fmt@6066945/crates/ruff_fmt_dprint/src/configuration/configuration.rs#L26</a></p>
</blockquote>
<p>You can use <code>LineWidth::try_from(u16)</code> to get a line width</p>
<blockquote>
<p><a href="https://github.com/wasm-fmt/ruff_fmt/blob/60669453962a858bbdc3bf015b2f1771603c9104/crates/ruff_fmt_dprint/src/configuration/resolve_config.rs#L36-L42">wasm-fmt/ruff_fmt@6066945/crates/ruff_fmt_dprint/src/configuration/resolve_config.rs#L36-L42</a></p>
</blockquote>
<p>It may be a bit more cumbersome but you can do</p>
<pre><code>let resolved_config = PyFormatOptions::default()
	.with_indent_style(indent_style)
	.with_line_with(line_with)
	.with_quote_style(quote_style)
	with_magic_trailing_comma(magic_trailing_comma)
</code></pre>
<p>You may also want to use <code>PyFormatOptions::from_extension()</code> or <code>::from_source_type</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/magic-akari">@magic-akari</a> reviewed on 2023-08-10 07:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/magic-akari">@magic-akari</a> on <code>crates/ruff_formatter/src/lib.rs</code>:125 on 2023-08-10 07:41</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/blob/ac5c8bb3b683fb009b39098c00f9357e9aeb6e38/crates/ruff_python_formatter/src/options.rs#L69-L72</p>
<p>I suppose the signature of <code>with_quote_style</code> should be <code>mut self</code> and not a reference type. Is that correct?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-10 07:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_formatter/src/lib.rs</code>:125 on 2023-08-10 07:42</div>
            <div class="timeline-body"><p>That&#x27;s correct</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-10 07:50</div>
            <div class="timeline-body">PR Check Results
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.2±0.09ms     4.9 MB/sec    1.00      8.2±0.02ms     5.0 MB/sec
formatter/numpy/ctypeslib.py               1.00  1650.7±37.17µs    10.1 MB/sec    1.03  1699.3±65.30µs     9.8 MB/sec
formatter/numpy/globals.py                 1.00    184.8±4.56µs    16.0 MB/sec    1.03    191.0±8.14µs    15.5 MB/sec
formatter/pydantic/types.py                1.00      3.5±0.08ms     7.3 MB/sec    1.02      3.5±0.08ms     7.2 MB/sec
linter/all-rules/large/dataset.py          1.00     10.2±0.05ms     4.0 MB/sec    1.04     10.6±0.03ms     3.8 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.7±0.01ms     6.1 MB/sec    1.02      2.8±0.00ms     6.0 MB/sec
linter/all-rules/numpy/globals.py          1.01    389.0±0.80µs     7.6 MB/sec    1.00    386.9±0.37µs     7.6 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.3±0.04ms     4.8 MB/sec    1.04      5.5±0.02ms     4.7 MB/sec
linter/default-rules/large/dataset.py      1.00      5.3±0.02ms     7.7 MB/sec    1.08      5.7±0.01ms     7.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1155.4±2.47µs    14.4 MB/sec    1.05   1209.1±9.37µs    13.8 MB/sec
linter/default-rules/numpy/globals.py      1.00    134.0±2.83µs    22.0 MB/sec    1.02    136.1±0.38µs    21.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.4±0.07ms    10.4 MB/sec    1.04      2.6±0.03ms    10.0 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00     10.0±0.05ms     4.1 MB/sec    1.00      9.9±0.06ms     4.1 MB/sec
formatter/numpy/ctypeslib.py               1.00  1876.0±10.87µs     8.9 MB/sec    1.01  1903.5±18.15µs     8.7 MB/sec
formatter/numpy/globals.py                 1.00    190.2±1.33µs    15.5 MB/sec    1.04    198.8±5.75µs    14.8 MB/sec
formatter/pydantic/types.py                1.00      4.2±0.02ms     6.1 MB/sec    1.02      4.3±0.04ms     6.0 MB/sec
linter/all-rules/large/dataset.py          1.01     12.5±0.04ms     3.2 MB/sec    1.00     12.5±0.05ms     3.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.5±0.01ms     4.7 MB/sec    1.00      3.5±0.02ms     4.7 MB/sec
linter/all-rules/numpy/globals.py          1.00    361.7±3.62µs     8.2 MB/sec    1.01    365.5±7.61µs     8.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.5±0.03ms     3.9 MB/sec    1.00      6.5±0.04ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.00      6.8±0.02ms     6.0 MB/sec    1.01      6.8±0.05ms     6.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1402.6±6.12µs    11.9 MB/sec    1.00   1407.9±7.61µs    11.8 MB/sec
linter/default-rules/numpy/globals.py      1.00    143.6±4.34µs    20.5 MB/sec    1.00    143.4±1.14µs    20.6 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.1±0.04ms     8.3 MB/sec    1.00      3.0±0.02ms     8.4 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/magic-akari">@magic-akari</a> on 2023-08-10 08:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/magic-akari">@magic-akari</a> on 2023-08-10 08:28</div>
            <div class="timeline-body"><p>There are multiple commits here,
I think it&#x27;s fine use squash merge or I squash locally and then force push to the branch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-08-10 09:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/options.rs</code>:41 on 2023-08-10 09:01</div>
            <div class="timeline-body"><p>The preferred way to use this is to construct <code>PyFormatOptions::default()</code> and then override the fields you need, just like <a href="https://github.com/astral-sh/ruff/blob/9bb21283cade3069ff8860477aff120b31492e90/crates/ruff_dev/src/format_dev.rs#L836-L846">format_dev</a> does.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/magic-akari">@magic-akari</a> reviewed on 2023-08-10 09:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/magic-akari">@magic-akari</a> on <code>crates/ruff_python_formatter/src/options.rs</code>:41 on 2023-08-10 09:28</div>
            <div class="timeline-body"><p>IndentStyle has its own <code>Default</code> value <code>2</code>.
LineWidth has its own <code>Default</code> value <code>80</code>.</p>
<p>Maybe it was from <code>Rome</code> config.
But I think this exported default function is OK for me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/options.rs</code>:41 on 2023-08-10 10:27</div>
            <div class="timeline-body"><p>What @konstin suggests is that you use <code>PyFormatOptions::default()</code> and only set the <code>indent_style</code> and <code>line_with</code> if you want to override the default value.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-10 10:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/magic-akari">@magic-akari</a> reviewed on 2023-08-10 10:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/magic-akari">@magic-akari</a> on <code>crates/ruff_python_formatter/src/options.rs</code>:41 on 2023-08-10 10:36</div>
            <div class="timeline-body"><p>This makes sense.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/magic-akari">@magic-akari</a> reviewed on 2023-08-10 10:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/magic-akari">@magic-akari</a> on <code>crates/ruff_python_formatter/src/options.rs</code>:41 on 2023-08-10 10:44</div>
            <div class="timeline-body"><p>@MichaReiser I noticed that when a field is missing, <code>line_width</code> will give the same result (both 88).</p>
<p>But <code>indent_style</code> is different.
The default value of <code>PyFormatOptions</code> returns <code>Space(4)</code>, and serde&#x27;s default value is <code>Tab</code>.
Is this intentional?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-08-10 11:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/options.rs</code>:41 on 2023-08-10 11:03</div>
            <div class="timeline-body"><p>The default value from <code>IndentStyle</code> comes from <code>ruff_formatter</code>, not from <code>ruff_python_formatter</code>. That&#x27;s why you should start with <code>PyFormatOptions::default</code> and get or set everything from that <code>PyFormatOptions</code> object, which has the right defaults for python.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/magic-akari">@magic-akari</a> reviewed on 2023-08-10 11:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/magic-akari">@magic-akari</a> on <code>crates/ruff_python_formatter/src/options.rs</code>:41 on 2023-08-10 11:38</div>
            <div class="timeline-body"><p>I mean that the default <code>indent_style</code> value should be same in both <code>PyFormatOptions::default</code> and serde default .</p>
<p>https://github.com/astral-sh/ruff/blob/ac5c8bb3b683fb009b39098c00f9357e9aeb6e38/crates/ruff_python_formatter/src/options.rs#L16-L23</p>
<p>https://github.com/astral-sh/ruff/blob/ac5c8bb3b683fb009b39098c00f9357e9aeb6e38/crates/ruff_python_formatter/src/options.rs#L36-L46</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-08-10 12:39</div>
            <div class="timeline-body"><p>These changes look good to me. Thanks for contributing them upstream.</p>
<p>I will be interested to see where it goes with your <code>dprint</code> implementation. Just a reminder, the formatter API isn&#x27;t stable, and we may change it in minor releases without notice.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-10 12:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-10 12:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-10 12:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/magic-akari">@magic-akari</a> on 2023-08-11 19:29</div>
            <div class="timeline-body"><p>You can try it:</p>
<ol>
<li>instal dprint: https://dprint.dev/install/</li>
<li>config the plugin</li>
</ol>
<pre><code>dprint config add wasm-fmt/ruff_fmt
</code></pre>
<hr>
<p>I am using ruff formatter as git dependency.
I was wondering if there was a roadmap. I&#x27;m waiting for it to be published on crates.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-14 07:16</div>
            <div class="timeline-body"><blockquote>
<p>I was wondering if there was a roadmap. I&#x27;m waiting for it to be published on crates.</p>
</blockquote>
<p>We don&#x27;t have any near-term plans on publishing our crates to crates.io because people will (not unjustified) assume that the APIs are stable and we aren&#x27;t ready to give that guarantee yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-01-20 06:40</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:56:12 UTC
    </footer>
</body>
</html>
