<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add definitions for match statement - astral-sh/ruff #13147</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add definitions for match statement</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13147">#13147</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-08-29 07:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR adds definition for match patterns.</p>
<h2>Test Plan</h2>
<p>Update the existing test case for match statement symbols to verify that the definitions are added as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @dhruvmanila on 2024-08-29 07:40</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/node_key.rs</code>:15 on 2024-08-30 13:23</div>
            <div class="timeline-body"><p>I want to change the struct name because it doesn't correspond to only nodes now that an identifier can be represented as a key.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:864 on 2024-08-30 13:24</div>
            <div class="timeline-body"><p>This delegation is required so that the expressions are recorded in the <code>UseDefMap</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:832 on 2024-08-30 13:25</div>
            <div class="timeline-body"><p>If I'm not mistaken, I think the structural matching will be dependent on the type of the subject expression.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-08-30 13:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2024-08-30 13:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dhruvmanila on 2024-08-30 13:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2024-08-30 13:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dhruvmanila on 2024-08-30 13:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-08-30 13:29</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/node_key.rs</code>:37 on 2024-08-30 13:51</div>
            <div class="timeline-body"><p>There's not much in it, but I'd be tempted to do something like this (diff is relative to your branch):</p>
<pre><code class="language-diff">diff --git a/crates/red_knot_python_semantic/src/node_key.rs b/crates/red_knot_python_semantic/src/node_key.rs
index 9683b0e7f..6aead4ce6 100644
--- a/crates/red_knot_python_semantic/src/node_key.rs
+++ b/crates/red_knot_python_semantic/src/node_key.rs
@@ -21,14 +21,21 @@ impl NodeKey {
     where
         N: Into&lt;AnyNodeRef&lt;'a&gt;&gt;,
     {
-        let node = node.into();
+        Self::from(node.into())
+    }
+}
+
+impl From&lt;AnyNodeRef&lt;'_&gt;&gt; for NodeKey {
+    fn from(node: AnyNodeRef) -&gt; Self {
         NodeKey {
             kind: Kind::Node(node.kind()),
             range: node.range(),
         }
     }
+}
 
-    pub(super) fn from_identifier(identifier: &amp;Identifier) -&gt; Self {
+impl From&lt;&amp;Identifier&gt; for NodeKey {
+    fn from(identifier: &amp;Identifier) -&gt; Self {
         NodeKey {
             kind: Kind::Identifier,
             range: identifier.range(),
diff --git a/crates/red_knot_python_semantic/src/semantic_index/definition.rs b/crates/red_knot_python_semantic/src/semantic_index/definition.rs
index 75c95a4bd..a54dd67fc 100644
--- a/crates/red_knot_python_semantic/src/semantic_index/definition.rs
+++ b/crates/red_knot_python_semantic/src/semantic_index/definition.rs
@@ -462,6 +462,6 @@ impl From&lt;&amp;ast::ParameterWithDefault&gt; for DefinitionNodeKey {
 
 impl From&lt;&amp;ast::Identifier&gt; for DefinitionNodeKey {
     fn from(identifier: &amp;ast::Identifier) -&gt; Self {
-        Self(NodeKey::from_identifier(identifier))
+        Self(NodeKey::from(identifier))
     }
 }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/semantic_index/definition.rs</code>:166 on 2024-08-30 13:57</div>
            <div class="timeline-body"><p>Maybe <code>pattern_root</code> might be a better name for this field? (And same for the equivalent field on <code>MatchPatternDefinitionKind</code>?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-30 13:59</div>
            <div class="timeline-body"><p>This seems reasonable to me, but @carljm will obviously be the better reviewer here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index.rs</code>:1099 on 2024-08-30 15:30</div>
            <div class="timeline-body"><p>nit: if you don't need the index for any other reason, you can just use the <code>use_def_map</code> salsa query directly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:832 on 2024-08-30 20:59</div>
            <div class="timeline-body"><p>I'm curious how you see the pros and cons of this separate pattern visitor, vs including this visit functionality directly in the builder, with some context state stored on the builder when we are visiting a pattern (similar to <code>current_assignment</code>?</p>
<p>The need to explicitly delegate <code>visit_expr</code> (and potentially other things in future?) seems like a downside of the separate-visitor approach. There are advantages to maintaining the invariant that everything will get visited by the same visitor.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/definition.rs</code>:166 on 2024-08-30 21:02</div>
            <div class="timeline-body"><p>It is a pattern, so I think <code>root_pattern</code> would be better than <code>pattern_root</code> if we did change the name. But tbh I think <code>pattern</code> is also fine; typically we'd call everything else a &quot;sub-pattern&quot; -- the top-level pattern is &quot;the pattern.&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/definition.rs</code>:299 on 2024-08-30 21:05</div>
            <div class="timeline-body"><p>I think we will also need to store a reference to the subject here; see comments on type inference side.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:832 on 2024-08-30 21:07</div>
            <div class="timeline-body"><p>Yes, it will, which means we need a reference to the subject stored in the pattern Definition as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:809 on 2024-08-30 21:17</div>
            <div class="timeline-body"><p>I think you mean <code>self.types.expression_ty(subject)</code> here (<code>self.index</code> is the semantic index, which doesn't have an <code>expression_ty</code> method.)</p>
<p>It's a bit misleading to say &quot;available in ...&quot;, because it won't be, if we are inferring a single match pattern definition region, unless we ensure it gets put there. And we should only infer the type of the subject once, even if we have many match-pattern definitions referring to it. This is why we add the subject as a standalone expression in the semantic index; so that we can query its type directly using a cached Salsa query. So the approach we will want here is that we will call the Salsa query <code>infer_expression_types(db, expression)</code>, where we get <code>expression</code> (which is an <code>Expression</code> ingredient) from <code>self.index.expression(the_subject_ast_expr)</code>, and extend our own inference with the result. Once that's done then we can look up its type in <code>self.types.expression_ty(subject.scoped_ast_id())</code>. (This is all similar to what's currently done in <code>infer_assignment_definition</code>).</p>
<p>It's fine for all of this to remain a TODO in this PR! I would just re-word the comment a bit:</p>
<pre><code class="language-suggestion">        // against the subject expression type (which we can query via `infer_expression_types`)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:835 on 2024-08-30 21:24</div>
            <div class="timeline-body"><p>In this method, anywhere we would have created a <code>Definition</code> in semantic indexing, we should be calling <code>self.infer_definition(...)</code> to lookup the Definition by node (identifier in this case) and infer types in that definition's region. This is what ensures we never double infer types: a given expression or definition is only inferred in one region, and &quot;outer&quot; regions always get access to those types by going through the cached Salsa query.</p>
<p>At least that's the design so far. This case is a little odd, because a match pattern definition is a very limited region (just an identifier) that doesn't actually include any expressions. Currently there is also an invariant that we maintain that doing scope-level inference will infer a type for every Definition in that scope, and have those types in its <code>self.types.definitions</code> map. But I actually don't think we rely on that invariant anywhere, like we do on the all-expressions-have-types invariant.</p>
<p>I still think for now it's probably best if we go ahead and do inference on all the match-pattern Definitions when we encounter them here?</p>
<p>Looking at this now, I also think when we do proper type inference for match statements, we will need to create a new ingredient and Salsa query for inferring types on a pattern and matching it against a subject, otherwise we will end up inferring types on expressions within the pattern multiple times (once per definition in that pattern), which is something we want to avoid. That new query doesn't need to happen in this PR, but it would be good to add a TODO here, something like <code>// TODO Salsa query for inferring pattern types and matching against subject</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-08-30 21:37</div>
            <div class="timeline-body"><p>This looks good! Match statements are really tricky, and push the edges of the current design -- thanks for carefully thinking through how to handle them.</p>
<p>The main substantive change I think we need is that I think each match-pattern Definition needs to keep a reference to the subject of the match statement. And I think that scope-level inference should call <code>infer_definition_types</code> for the match-pattern definitions when they are encountered, though this one may not be strictly necessary, and I'm open to discussion on it.</p>
<p>Still approving anyway, since any of these things could also be done in a follow-up PR, with no harm done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/node_key.rs</code>:15 on 2024-09-02 07:47</div>
            <div class="timeline-body"><p>For all I'm concerned, <code>Identifier</code> is a node. It has a value and range. It only lacks a <code>NodeKind</code> and a <code>AnyNode</code> implementation, but we could easily add that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-09-02 07:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-09-02 08:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/node_key.rs</code>:37 on 2024-09-02 08:12</div>
            <div class="timeline-body"><p>Yeah, I like this. I'll take that up as a follow-up. Thanks for suggestion</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @MichaReiser removed by @MichaReiser on 2024-09-02 08:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-09-02 08:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:832 on 2024-09-02 08:30</div>
            <div class="timeline-body"><p>The main reason for me to keep the visitor separate was because of the state variables which includes both the <code>index</code> and <code>pattern</code>. Here, the <code>pattern</code> is the outermost pattern being visited and is required to store because of the recursive nature of the visitor pattern. One advantage of using a separate visitor is that the state is reset as soon as the work is done.</p>
<blockquote>
<p>The need to explicitly delegate <code>visit_expr</code> (and potentially other things in future?) seems like a downside of the separate-visitor approach. There are advantages to maintaining the invariant that everything will get visited by the same visitor.</p>
</blockquote>
<p>I didn't realize that this delegation would be required until a bit later when I noticed some tests failing. That said, I think it makes sense to maintain this invariant to avoid any future failure like the one I mentioned. We could create a separate <code>State</code> struct which maintains the necessary variables.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:809 on 2024-09-02 08:34</div>
            <div class="timeline-body"><p>That makes sense, thanks for the explanation. I'll also add a reference to <code>self.infer_assignment_definition</code> in the comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-09-02 08:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-09-02 08:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/node_key.rs</code>:15 on 2024-09-02 08:41</div>
            <div class="timeline-body"><p>Sounds good, I can add that as a follow-up.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-09-02 08:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:832 on 2024-09-02 08:48</div>
            <div class="timeline-body"><p>I'll make this change as a follow-up.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-09-02 08:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:835 on 2024-09-02 08:48</div>
            <div class="timeline-body"><blockquote>
<p>I still think for now it's probably best if we go ahead and do inference on all the match-pattern Definitions when we encounter them here?</p>
</blockquote>
<p>This requires creating the definition which requires the identifier index in the root pattern. This means we need to use the visitor pattern / save context on the type inference builder. I avoided this for now because I wasn't sure exactly how the type inference was going to work here which itself is a separate task. Still, if you want I can take that up as a follow-up work to infer the definition types by storing the context on the builder.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-09-02 08:55</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/dhruv/match-definition">CodSpeed Performance Report</a></h2>
<h3>Merging #13147 will <strong>degrade performances by 10.11%</strong></h3>
<p><sub>Comparing <code>dhruv/match-definition</code> (097e81c) with <code>main</code> (227fa4e)</sub></p>
<h3>Summary</h3>
<p><code>❌ 1</code> regressions
<code>✅ 31</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/dhruv/match-definition">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>main</code> | <code>dhruv/match-definition</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ❌ | <code>linter/all-with-preview-rules[numpy/globals.py]</code> | 827.9 µs | 921 µs | -10.11% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2024-09-02 09:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2024-09-02 09:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-09-02 09:10</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/semantic_index/builder.rs</code>:832 on 2024-09-02 09:40</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/13209</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-09-02 09:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-09-03 17:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:835 on 2024-09-03 17:00</div>
            <div class="timeline-body"><p>I'm not sure I understand &quot;This requires creating the definition which requires the identifier index in the root pattern&quot; -- I wasn't suggesting to fully do the inference here, just to actually make it go through the <code>infer_definition_types</code> query path (but then still end up with <code>Unknown</code> for now). But now that this is merged it's fine, we can follow up in a future PR on the inference part.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:835 on 2024-09-03 18:10</div>
            <div class="timeline-body"><p>I can look at it tomorrow morning. I might need to go through the discussion again to expand my comment ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-09-03 18:10</div>
            <div class="timeline-body"></div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:06:15 UTC
    </footer>
</body>
</html>
