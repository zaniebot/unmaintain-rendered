<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] diagnostic for dataclass field order - astral-sh/ruff #19825</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] diagnostic for dataclass field order</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19825">#19825</a>
        opened by <a href="https://github.com/PrettyWood">@PrettyWood</a>
        on 2025-08-08 11:46
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/PrettyWood">@PrettyWood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Emit diagnostic when defining a field without a default after a field with a default, see <a href="https://github.com/astral-sh/ruff/blob/dbc137c9516808baa292da7a928e50ba36a14d39/crates/red_knot_python_semantic/resources/mdtest/dataclasses.md?plain=1#L120">existing TODO</a></p>
<p><img width="875" height="450" alt="Screenshot 2025-08-08 at 13 46 29" src="https://github.com/user-attachments/assets/60c353f6-4f7a-41ab-bfb1-b4fd230fadf5" /></p>
<p>Part of https://github.com/astral-sh/ty/issues/111</p>
<h2>Test Plan</h2>
<p>Updated Markdown tests</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @PrettyWood on 2025-08-08 11:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @PrettyWood on 2025-08-08 11:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @PrettyWood on 2025-08-08 11:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @PrettyWood on 2025-08-08 11:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-08-08 11:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-08 11:51</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<details>
<summary>Changes were detected when running ty on typing conformance tests</summary>

<pre><code class="language-diff">--- old-output.txt	2025-08-21 13:57:29.996336756 +0000
+++ new-output.txt	2025-08-21 13:57:32.501345368 +0000
@@ -214,9 +214,6 @@
 dataclasses_kwonly.py:23:11: error[too-many-positional-arguments] Too many positional arguments: expected 1, got 2
 dataclasses_kwonly.py:38:11: error[too-many-positional-arguments] Too many positional arguments: expected 1, got 2
 dataclasses_kwonly.py:53:11: error[too-many-positional-arguments] Too many positional arguments: expected 1, got 2
-dataclasses_kwonly.py:61:1: error[missing-argument] No argument provided for required parameter `c`
-dataclasses_kwonly.py:61:9: error[invalid-argument-type] Argument is incorrect: Expected `int`, found `float`
-dataclasses_kwonly.py:61:14: error[parameter-already-assigned] Multiple values provided for parameter `b`
 dataclasses_order.py:50:4: error[unsupported-operator] Operator `&lt;` is not supported for types `DC1` and `DC2`
 dataclasses_postinit.py:28:7: error[unresolved-attribute] Type `DC1` has no attribute `x`
 dataclasses_postinit.py:29:7: error[unresolved-attribute] Type `DC1` has no attribute `y`
@@ -270,11 +267,17 @@
 dataclasses_transform_func.py:77:36: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `T@create_model_frozen`
 dataclasses_transform_func.py:97:1: error[invalid-assignment] Property `id` defined in `Customer3` is read-only
 dataclasses_transform_meta.py:60:36: error[unknown-argument] Argument `other_name` does not match any known parameter
+dataclasses_transform_meta.py:66:18: error[too-many-positional-arguments] Too many positional arguments: expected 0, got 2
 dataclasses_transform_meta.py:73:6: error[unsupported-operator] Operator `&lt;` is not supported for types `Customer1` and `Customer1`
 dataclasses_transform_meta.py:79:6: error[unsupported-operator] Operator `&lt;` is not supported for types `Customer2` and `Customer2`
+dataclasses_transform_meta.py:83:8: error[missing-argument] No argument provided for required parameter `id`
+dataclasses_transform_meta.py:83:18: error[too-many-positional-arguments] Too many positional arguments: expected 0, got 2
 dataclasses_usage.py:50:6: error[missing-argument] No argument provided for required parameter `unit_price`
 dataclasses_usage.py:51:28: error[invalid-argument-type] Argument is incorrect: Expected `int | float`, found `Literal[&quot;price&quot;]`
 dataclasses_usage.py:52:36: error[too-many-positional-arguments] Too many positional arguments: expected 3, got 4
+dataclasses_usage.py:61:5: error[dataclass-field-order] Required field `b` cannot be defined after fields with default values
+dataclasses_usage.py:67:5: error[dataclass-field-order] Required field `b` cannot be defined after fields with default values
+dataclasses_usage.py:73:5: error[dataclass-field-order] Required field `b` cannot be defined after fields with default values
 dataclasses_usage.py:83:13: error[too-many-positional-arguments] Too many positional arguments: expected 1, got 2
 dataclasses_usage.py:88:5: error[invalid-assignment] Object of type `dataclasses.Field[Literal[&quot;&quot;]]` is not assignable to `int`
 dataclasses_usage.py:127:8: error[too-many-positional-arguments] Too many positional arguments: expected 1, got 2
@@ -850,5 +853,5 @@
 typeddicts_operations.py:60:1: error[type-assertion-failure] Argument does not have asserted type `str | None`
 typeddicts_type_consistency.py:101:1: error[invalid-assignment] Object of type `Unknown | None` is not assignable to `str`
 typeddicts_usage.py:40:24: error[invalid-type-form] The special form `typing.TypedDict` is not allowed in type expressions. Did you mean to use a concrete TypedDict or `collections.abc.Mapping[str, object]` instead?
-Found 851 diagnostics
+Found 854 diagnostics
 WARN A fatal error occurred while checking some files. Not all project files were analyzed. See the diagnostics list above for details.
</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-08 11:53</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">attrs (https://github.com/python-attrs/attrs)
+ tests/test_annotations.py:91:13: error[dataclass-field-order] Required field `y` cannot be defined after fields with default values
+ tests/test_hooks.py:68:13: error[dataclass-field-order] Required field `y` cannot be defined after fields with default values
- Found 556 diagnostics
+ Found 558 diagnostics

svcs (https://github.com/hynek/svcs)
+ src/svcs/_core.py:73:5: error[dataclass-field-order] Required field `takes_container` cannot be defined after fields with default values
+ src/svcs/_core.py:74:5: error[dataclass-field-order] Required field `enter` cannot be defined after fields with default values
- Found 102 diagnostics
+ Found 104 diagnostics

trio (https://github.com/python-trio/trio)
+ src/trio/_core/_run.py:1497:5: error[dataclass-field-order] Required field `_ki_protected` cannot be defined after fields with default values
+ src/trio/_dtls.py:164:5: error[dataclass-field-order] Required field `epoch_seqno` cannot be defined after fields with default values
+ src/trio/_dtls.py:328:5: error[dataclass-field-order] Required field `msg_type` cannot be defined after fields with default values
+ src/trio/_dtls.py:329:5: error[dataclass-field-order] Required field `msg_seq` cannot be defined after fields with default values
+ src/trio/_dtls.py:338:5: error[dataclass-field-order] Required field `content_type` cannot be defined after fields with default values
+ src/trio/_tests/test_highlevel_open_tcp_listeners.py:145:5: error[dataclass-field-order] Required field `_proto` cannot be defined after fields with default values
- Found 656 diagnostics
+ Found 662 diagnostics

dd-trace-py (https://github.com/DataDog/dd-trace-py)
- tests/debugging/utils.py:134:12: error[missing-argument] No arguments provided for required parameters `rate`, `condition`, `template`, `segments`, `take_snapshot`, `probe_id`, `version`
+ tests/debugging/utils.py:134:12: error[missing-argument] No arguments provided for required parameters `rate`, `condition`, `condition_error_rate`, `template`, `segments`, `take_snapshot`, `limits`, `source_file`, `line`, `probe_id`, `version`, `tags`
- tests/debugging/utils.py:142:12: error[missing-argument] No arguments provided for required parameters `rate`, `condition`, `template`, `segments`, `take_snapshot`, `evaluate_at`, `probe_id`, `version`
+ tests/debugging/utils.py:142:12: error[missing-argument] No arguments provided for required parameters `rate`, `condition`, `condition_error_rate`, `template`, `segments`, `take_snapshot`, `limits`, `evaluate_at`, `module`, `func_qname`, `probe_id`, `version`, `tags`
- tests/debugging/utils.py:149:12: error[missing-argument] No arguments provided for required parameters `rate`, `condition`, `template`, `segments`, `take_snapshot`, `probe_id`, `version`
+ tests/debugging/utils.py:149:12: error[missing-argument] No arguments provided for required parameters `rate`, `condition`, `condition_error_rate`, `template`, `segments`, `take_snapshot`, `limits`, `source_file`, `line`, `probe_id`, `version`, `tags`
- tests/debugging/utils.py:157:12: error[missing-argument] No arguments provided for required parameters `rate`, `condition`, `template`, `segments`, `take_snapshot`, `evaluate_at`, `probe_id`, `version`
+ tests/debugging/utils.py:157:12: error[missing-argument] No arguments provided for required parameters `rate`, `condition`, `condition_error_rate`, `template`, `segments`, `take_snapshot`, `limits`, `evaluate_at`, `module`, `func_qname`, `probe_id`, `version`, `tags`
- tests/debugging/utils.py:164:12: error[missing-argument] No arguments provided for required parameters `condition`, `kind`, `name`, `value`, `probe_id`, `version`
+ tests/debugging/utils.py:164:12: error[missing-argument] No arguments provided for required parameters `condition`, `condition_error_rate`, `kind`, `name`, `value`, `source_file`, `line`, `probe_id`, `version`, `tags`
- tests/debugging/utils.py:172:12: error[missing-argument] No arguments provided for required parameters `condition`, `kind`, `name`, `value`, `evaluate_at`, `probe_id`, `version`
+ tests/debugging/utils.py:172:12: error[missing-argument] No arguments provided for required parameters `condition`, `condition_error_rate`, `kind`, `name`, `value`, `evaluate_at`, `module`, `func_qname`, `probe_id`, `version`, `tags`
- tests/debugging/utils.py:179:12: error[missing-argument] No arguments provided for required parameters `condition`, `probe_id`, `version`
+ tests/debugging/utils.py:179:12: error[missing-argument] No arguments provided for required parameters `condition`, `condition_error_rate`, `module`, `func_qname`, `probe_id`, `version`, `tags`
- tests/debugging/utils.py:185:12: error[missing-argument] No arguments provided for required parameters `target_span`, `decorations`, `probe_id`, `version`
+ tests/debugging/utils.py:185:12: error[missing-argument] No arguments provided for required parameters `target_span`, `decorations`, `source_file`, `line`, `probe_id`, `version`, `tags`
- tests/debugging/utils.py:192:12: error[missing-argument] No arguments provided for required parameters `target_span`, `decorations`, `evaluate_at`, `probe_id`, `version`
+ tests/debugging/utils.py:192:12: error[missing-argument] No arguments provided for required parameters `target_span`, `decorations`, `evaluate_at`, `module`, `func_qname`, `probe_id`, `version`, `tags`
- tests/debugging/utils.py:199:12: error[missing-argument] No arguments provided for required parameters `rate`, `condition`, `session_id`, `level`, `probe_id`, `version`
+ tests/debugging/utils.py:199:12: error[missing-argument] No arguments provided for required parameters `rate`, `condition`, `condition_error_rate`, `session_id`, `level`, `module`, `func_qname`, `probe_id`, `version`, `tags`

prefect (https://github.com/PrefectHQ/prefect)
- src/integrations/prefect-docker/prefect_docker/worker.py:950:35: error[missing-argument] No argument provided for required parameter `root`
- src/integrations/prefect-docker/tests/test_worker.py:1187:9: error[missing-argument] No argument provided for required parameter `root`
- src/integrations/prefect-kubernetes/tests/test_observer.py:78:42: error[missing-argument] No argument provided for required parameter `root`
- src/integrations/prefect-kubernetes/tests/test_observer.py:155:42: error[missing-argument] No argument provided for required parameter `root`
- src/integrations/prefect-redis/tests/test_messaging.py:452:30: error[missing-argument] No argument provided for required parameter `root`
- src/integrations/prefect-redis/tests/test_ordering.py:23:12: error[missing-argument] No argument provided for required parameter `root`
- src/prefect/client/schemas/responses.py:469:16: error[missing-argument] No argument provided for required parameter `root`
- src/prefect/events/related.py:36:9: error[missing-argument] No argument provided for required parameter `root`
- src/prefect/events/related.py:51:12: error[missing-argument] No argument provided for required parameter `root`
- src/prefect/runner/runner.py:1048:17: error[missing-argument] No argument provided for required parameter `root`
- src/prefect/runner/runner.py:1064:26: error[missing-argument] No argument provided for required parameter `root`
- src/prefect/runner/runner.py:1097:17: error[missing-argument] No argument provided for required parameter `root`
- src/prefect/runner/runner.py:1106:13: error[missing-argument] No argument provided for required parameter `root`
- src/prefect/runner/runner.py:1122:26: error[missing-argument] No argument provided for required parameter `root`
- src/prefect/server/events/actions.py:142:20: error[missing-argument] No argument provided for required parameter `root`
- src/prefect/server/events/actions.py:200:20: error[missing-argument] No argument provided for required parameter `root`
- src/prefect/server/events/actions.py:216:30: error[missing-argument] No argument provided for required parameter `root`
- src/prefect/server/events/actions.py:232:30: error[missing-argument] No argument provided for required parameter `root`
- src/prefect/server/events/schemas/automations.py:432:25: error[missing-argument] No argument provided for required parameter `root`
- src/prefect/server/events/schemas/automations.py:448:21: error[missing-argument] No argument provided for required parameter `root`
- Found 2951 diagnostics
+ Found 2931 diagnostics

</code></pre>
</details>
No memory usage changes detected ‚úÖ

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @PrettyWood on 2025-08-08 12:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-08-14 01:00</div>
            <div class="timeline-body"><p>This is great, thank you! I rebased and pushed a couple additional tests, plus reworked the AST-node-finding so it uses our existing indexing of assignments and can handle more complex cases (e.g. a version-conditional field, as shown in the added test).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-08-14 01:08</div>
            <div class="timeline-body"><p>Looking at the conformance suite results, I think we need to take <code>kw_only</code> into account here (keyword-only fields don't participate in this check, since they go to the end of the <code>__init__</code> signature and are not positional). I think also <code>init=False</code> fields should be ignored?</p>
<p>So I think we should land https://github.com/astral-sh/ruff/pull/19677 and then take those into account.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/PrettyWood">@PrettyWood</a> on 2025-08-14 06:44</div>
            <div class="timeline-body"><p>Great thank you so much for the review + improvements @carljm! I‚Äôm still getting familiar with the codebase, so your feedback is really helpful.
You‚Äôre right about <code>kw_only</code> and <code>init=False</code> fields. I reckon we should merge this first and I'll come back to this PR afterward. Tell me if I can help</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-08-14 15:08</div>
            <div class="timeline-body"><p>We already supported <code>init</code> arg, and I just merged the PR for <code>kw_only</code> support, so I think we are ready to add consideration of those to this PR! If you are up for doing that, that would be great.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/PrettyWood">@PrettyWood</a> on 2025-08-14 16:27</div>
            <div class="timeline-body"><p>Sure I'll work on it this weekend</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/PrettyWood">@PrettyWood</a> on 2025-08-17 17:53</div>
            <div class="timeline-body"><p>@carljm Should be good. Feel free to update directly the branch!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-18 08:29</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> requested changes on 2025-08-19 00:53</div>
            <div class="timeline-body"><p>Thanks! Looking at the conformance test suite, I see that this diff introduces a false positive at https://github.com/python/typing/blob/main/conformance/tests/dataclasses_kwonly.py#L58</p>
<p>The problem appears to be that when emitting this field-ordering diagnostic, we aren't respecting the dataclass-level <code>kw_only</code> parameter, only field-level <code>kw_only</code>.</p>
<p>Similarly, the many new diagnostics in <code>freqtrade</code> on this PR are also false positives. <code>freqtrade</code> uses Pydantic, and Pydantic uses <code>dataclass_transform</code> with <code>kw_only_default=True</code>: https://github.com/pydantic/pydantic/blob/main/pydantic/_internal/_model_construction.py#L78</p>
<p>So we need to add some test cases using <code>@dataclass(kw_only=True)</code> and <code>@dataclass_transform(kw_only_default=True)</code> and make sure we are respecting those as well, when considering which fields are kw-only.</p>
<p>I think there is also a somewhat-related existing bug with the handling of <code>KW_ONLY</code>, where its effects are wrongly considered to span from a base class to an inheriting class: https://github.com/astral-sh/ty/issues/1047 That existing bug doesn't necessarily need to be fixed in this PR, but we need to make sure not to recreate it in a new location, and I think the current version of this PR does.</p>
<p>I think maybe a common thread in all the above is that we need some better intermediate abstration layers; right now <code>own_fields</code> and <code>fields</code> give us &quot;raw&quot; information from each field's direct annotation, not considering any dataclass-level settings, and then we process that raw information separately in <code>own_synthesized_member</code> (to construct the <code>__init__</code> signature) and also in the dataclass-checking code. I suspect we want an intermediate API to return &quot;processed fields&quot; that already accounts for dataclass-level settings, too.</p>
<p>cc @thejchap and @sharkdp</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/PrettyWood">@PrettyWood</a> on 2025-08-19 07:57</div>
            <div class="timeline-body"><p>@carljm Ok I'll take a step back on this PR. Probably best to first look at https://github.com/astral-sh/ty/issues/1047 (I suggested a fix https://github.com/astral-sh/ruff/pull/19986) and wait for feedbacks from others.
Thank you very much for the very precise reviews.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-08-19 18:55</div>
            <div class="timeline-body"><p>@PrettyWood Your fix for astral-sh/ty#1047 looked good, I merged it!</p>
<p>FWIW I don't think there's any need to take a step back here or wait for other input, especially with that fix merged. I think this PR is close, we just need to add some tests for the cases I mentioned above (where there is dataclass-level <code>kw_only</code> kwarg or dataclass-transform-level <code>kw_only_default</code> kwarg) and figure out how to handle them best. If you don't have time and would rather hand this off to someone else, that's of course fine, just let us know. But if you want to propose a refactor that allows us to handle those cases, I think that would be the next step here.</p>
<p>Really appreciate your contributions!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/PrettyWood">@PrettyWood</a> on 2025-08-19 19:27</div>
            <div class="timeline-body"><p>Perfect thank you! Happy to keep working on it for sure! I'll work on the follow-up tomorrow</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/PrettyWood">@PrettyWood</a> on 2025-08-20 12:47</div>
            <div class="timeline-body"><p>@carljm I kept extending <code>own_fields</code> directly (since I already added some contextual logic with <code>_: KW_ONLY</code> that sets <code>field.kw_only = Some(true)</code>). I don‚Äôt think we need a separate ‚Äúprocessed fields‚Äù yet (if ever) but if you‚Äôd prefer me to split it I'll do it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/PrettyWood">@PrettyWood</a> reviewed on 2025-08-20 13:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/PrettyWood">@PrettyWood</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:1424 on 2025-08-20 13:20</div>
            <div class="timeline-body"><p>This is to support</p>
<pre><code class="language-py">@dataclass(kw_only=True)
class KwOnlyClassWithPositionalField:
    x: int = 1
    y: str = field(kw_only=False, default=&quot;hello&quot;)
    # error: [dataclass-field-order] &quot;Required field `z` cannot be defined after fields with default values&quot;
    z: float = field(kw_only=False)
</code></pre>
<p>because when <code>dataclasses.field</code> is used, <code>default</code> is not <code>None</code> but <code>Some(Dynamic(Unknown))</code></p>
<p>TBH I think it's a bit weird. I would expect in this example to have both <code>x</code> and <code>y</code>
with <code>default_ty = None</code></p>
<pre><code class="language-py">@dataclass
class A:
    x: int
    y: int = field(metadata={&quot;random&quot;: &quot;info&quot;})
</code></pre>
<p>But it meant refactoring <code>FieldInstance</code> to have <code>default_type</code> being an <code>Option</code>
So in the meantime I think it's ok like this. Happy to go further if needed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/dataclasses.md</code>:568 on 2025-08-20 20:58</div>
            <div class="timeline-body"><p>Shouldn't this say the opposite? No fields (of a <code>kw_only=True</code> dataclass) participate in field ordering checks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:1424 on 2025-08-20 21:02</div>
            <div class="timeline-body"><p>I do think we should fix this properly in this PR by making <code>default_ty</code> be an <code>Option</code>. It is possible for <code>default_ty</code> to be <code>Unknown</code> for other reasons, like if there was an unknown import for example. These cases shouldn't be treated as &quot;no default&quot;.</p>
<p>I think this problem is currently causing false positives in the ecosystem report for this PR, for example <a href="https://github.com/python-trio/trio/blob/main/src/trio/_channel.py#L152">in trio</a> where we consider the return type of <code>attrs.Factory</code> to be <code>Unknown</code> (due to limitations in our current constraint solver), and so we treat that wrongly as &quot;no default value&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/infer.rs</code>:1424 on 2025-08-20 21:09</div>
            <div class="timeline-body"><p>Looking at the conformance suite results, the one remaining false positive we add in this PR is at https://github.com/python/typing/blob/main/conformance/tests/dataclasses_usage.py#L186</p>
<p>I think if we fix <code>default_ty</code> to be an <code>Option</code>, then we can easily fix this false positive also, by ensuring that we set it to <code>Some</code> if <code>default_factory</code> is specified. We could for now just make that <code>Some(Unknown)</code>, although I think adding proper support for <code>default_factory</code> would actually be quite easy -- we just need to take the argument type of <code>default_factory</code> and <code>Type::try_call</code> it with no arguments, and use the return type of that call. This could also be done as a separate PR, though I'd probably prefer that PR to land first in that case, so we avoid adding a new false positive with this diagnostic.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_benchmark/benches/ty_walltime.rs</code>:145 on 2025-08-20 21:17</div>
            <div class="timeline-body"><p>I think we should revert this change, and if it causes problems that's a sign that means this PR isn't ready to land yet. Freqtrade does not have a large number of true positives for this diagnostic, so if we are causing a large number of new diagnostics, they are almost certainly false positives, and we don't want to land new diagnostics with large numbers of false positives on real ecosystem code.</p>
<p>The freqtrade false positives are weird, because I would have expected them to be fixed with this PR; they are false positives on lines like https://github.com/freqtrade/freqtrade/blob/develop/freqtrade/rpc/api_server/api_schemas.py#L19, because we see previous fields on <a href="https://github.com/pydantic/pydantic/blob/f7a9b73517afecf25bf898e3b5f591dffe669778/pydantic/main.py#L121">pydantic.BaseModel</a>, and for some reason we aren't respecting <code>kw_only_default</code> <a href="https://github.com/pydantic/pydantic/blob/f7a9b73517afecf25bf898e3b5f591dffe669778/pydantic/_internal/_model_construction.py#L78">on their dataclass-transform metaclass</a>.</p>
<p>Boiling this down to <a href="https://play.ty.dev/15f3c09e-ad52-45d3-8a1c-1d7b1bf64d8f">a minimal example</a>, it looks to me like our support for <code>kw_only_default</code> just currently doesn't work for metaclass-based dataclass-transforms, only for decorator-based ones.</p>
<p>Unfortunately I think this needs to be fixed (whether in this PR or a separate one that lands first) before we can land this PR; it just causes too many false positives in real projects otherwise.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> requested changes on 2025-08-20 21:42</div>
            <div class="timeline-body"><p>Thank you! The updates look great, and I agree we don't need a new abstraction layer (yet?) -- it's fine to just ensure that the fields returned from <code>own_fields</code> already have a fully correct <code>kw_only</code> value. My main concern is just that we be clear about the contract: do the Field objects returned from <code>own_fields</code> represent exactly what is explicitly specified in that Field definition, or do they represent our full understanding of the field, including what's inherited from dataclass arguments and dataclass-transform arguments? I think it's fine if it's the latter, so long as that's consistent.</p>
<p>Sorry for requesting changes again -- in many cases we are happy to land PRs with remaining TODOs, but adding new false positives in the ecosystem is something we are very reluctant to do, and at the moment this PR adds a lot of them. It turns out we need to improve our support for other dataclass features significantly in order to add this diagnostic without false positives.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/PrettyWood">@PrettyWood</a> on <code>crates/ruff_benchmark/benches/ty_walltime.rs</code>:145 on 2025-08-20 22:08</div>
            <div class="timeline-body"><p>Yes sorry this should have been reverted.
And no problem happy to take the time to fully tackle everything. I'll look at it tomorrow</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/PrettyWood">@PrettyWood</a> reviewed on 2025-08-20 22:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/PrettyWood">@PrettyWood</a> reviewed on 2025-08-20 22:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/PrettyWood">@PrettyWood</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/dataclasses.md</code>:568 on 2025-08-20 22:09</div>
            <div class="timeline-body"><p>üôà oops</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/PrettyWood">@PrettyWood</a> on 2025-08-20 22:11</div>
            <div class="timeline-body"><blockquote>
<p>think it's fine if it's the latter, so long as that's consistent.</p>
</blockquote>
<p>For me yes. Happy to add a docstring on <code>own_fields</code> to make it explicit</p>
<blockquote>
<p>I think if we fix default_ty to be an Option</p>
</blockquote>
<p>Perfect glad we agree. I didn't want to put too much in a single PR but you're right, better that than having new false positives. I'll work on it tomorrow</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/PrettyWood">@PrettyWood</a> on 2025-08-21 09:34</div>
            <div class="timeline-body"><p>@carljm Better :) Commits should be self-explanatory.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-08-21 15:06</div>
            <div class="timeline-body"><p>Thank you! The conformance suite results look great here now! The ecosystem results look mostly great :) The one case where it looks like we are still adding false positives is that <a href="https://github.com/astral-sh/ty/issues/1068">we don't support <code>field_specifiers</code> on <code>dataclass_transform</code></a>, so we interpret <code>= attrs.field(...)</code> as a default value rather than as a field specifier, leading to the false positives we see on trio, svcs, and the attrs tests.</p>
<p>Ideally, we would support <code>field_specifiers</code> before we land this, so we avoid adding false positives. Trying to decide if we can go in the other direction and land this first (just to avoid collecting merge conflicts here in the meantime), but I think it would make it important that we address <code>field_specifiers</code> soon.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/PrettyWood">@PrettyWood</a> on 2025-08-21 15:47</div>
            <div class="timeline-body"><p>I'll fix the <code>field_specifiers</code> in a dedicated PR and we'll rebase/merge this one after</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/dataclass_transform.md</code>:113 on 2025-08-21 15:52</div>
            <div class="timeline-body"><p>This test looks great. Nit: I think this section is to show basic usage, and arguments are tested below. I think we should move this down with the rest of the <code>kw_only_default</code> tests below, and just add an example with metaclass there. (I think the example here with decorator is probably redundant with the test we already have down there, and we don't need both?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/dataclasses/dataclass_transform.md</code>:260 on 2025-08-21 16:20</div>
            <div class="timeline-body"><p>The test immediately above here I thought should be fixed by logic you added in this PR, but then I realized why it isn't -- commented below.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/class.rs</code>:2496 on 2025-08-21 17:44</div>
            <div class="timeline-body"><p>There's a test (I commented above) that I would expect this logic to fix, but it doesn't fix it. And I think I understand why. Currently <code>DataclassParams</code> is just a bitset, but this isn't really adequate when we have to compose it with <code>DataclassTransformerParams</code>. With the bitset representation, we can't distinguish &quot;no <code>kw_only</code> argument&quot; from <code>kw_only=False</code> -- they are both represented by the bit being off. I think we will need to change <code>DataclassParams</code> so that at least <code>kw_only</code> can be tri-valued. Because &quot;no <code>kw_only</code> arg&quot; should default to the dataclass-transform's <code>kw_only_default</code> value, but <code>kw_only=False</code> should potentially override it.</p>
<p>I think this doesn't need to be fixed in this PR, but it does impact the correctness of this code, so I think we should add a TODO comment here.</p>
<pre><code class="language-suggestion">                        // TODO `kw_only=False` should override `kw_only_default=True`, this will require
                        // a tri-valued representation for `DataclassParams::KW_ONLY`
                        .is_some_and(|params| params.contains(DataclassParams::KW_ONLY))
                        || self.try_metaclass(db).is_ok_and(|(_, transformer_params)| {
                            transformer_params.is_some_and(|params| {
                                params.contains(DataclassTransformerParams::KW_ONLY_DEFAULT)
                            })
                        })
                    {
                        // `@dataclass(kw_only=True)` or `@dataclass_transform(kw_only_default=True)`
                        field.kw_only = Some(true);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-08-21 17:46</div>
            <div class="timeline-body"><p>Code here looks great, just a few minor comments! I think once we resolve the <code>field_specifiers</code> false positives, this is ready to go.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:14:56 UTC
    </footer>
</body>
</html>
