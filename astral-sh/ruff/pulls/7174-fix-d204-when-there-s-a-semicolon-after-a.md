```yaml
number: 7174
title: "Fix D204 when there's a semicolon after a docstring"
type: pull_request
state: merged
author: konstin
labels: []
assignees: []
merged: true
base: main
head: 09-05-Fix_D204_when_there_s_a_semicolon_after_a_docstring
created_at: 2023-09-05T21:31:03Z
updated_at: 2023-09-11T13:13:52Z
url: https://github.com/astral-sh/ruff/pull/7174
synced_at: 2026-01-12T15:55:23Z
```

# Fix D204 when there's a semicolon after a docstring

---

_@konstin_

## Summary

Another statement on the same line as the docstring would previous make the D204 (newline after docstring) fix fail:

```python
class StatementOnSameLineAsDocstring:
    "After this docstring there's another statement on the same line separated by a semicolon." ;priorities=1
    def sort_services(self):
        pass
```

The fix handles this case manually:

```python
class StatementOnSameLineAsDocstring:
    "After this docstring there's another statement on the same line separated by a semicolon."

    priorities=1
    def sort_services(self):
        pass
```

Fixes #7088

## Test Plan

Added a new `D` test case 


---

_Comment by @konstin on 2023-09-05 21:31_

Current dependencies on/for this PR:
* main
  * **PR #7173** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7173" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7174** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7174" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7174?utm_source=stack-comment).

---

_@konstin reviewed on 2023-09-05 21:32_

---

_Review comment by @konstin on `crates/ruff/src/rules/pydocstyle/rules/blank_before_after_class.rs`:239 on 2023-09-05 21:32_

@MichaReiser since this is not indentation but whitespace between statement and a following `;` i don't need to use the python whitespace functions, right?

---

_Comment by @codspeed-hq[bot] on 2023-09-05 21:42_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/09-05-Fix_D204_when_there_s_a_semicolon_after_a_docstring)

### Merging #7174 will **degrade performances by 4.52%**

<sub>Comparing <code>09-05-Fix_D204_when_there_s_a_semicolon_after_a_docstring</code> (9d114a8) with <code>09-05-Ignore_single_quote_docstrings_with_newline_escape</code> (2d20e37)</sub>



### Summary

`âŒ 1` regressions
`âœ… 24` untouched benchmarks



> :warning: _Please fix the performance issues or [acknowledge them on CodSpeed](https://codspeed.io/astral-sh/ruff/branches/09-05-Fix_D204_when_there_s_a_semicolon_after_a_docstring)._

### Benchmarks breakdown

|     | Benchmark | `09-05-Ignore_single_quote_docstrings_with_newline_escape` | `09-05-Fix_D204_when_there_s_a_semicolon_after_a_docstring` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| âŒ | `linter/all-rules[unicode/pypinyin.py]` | 15.4 ms | 16.2 ms | -4.52% |


---

_@charliermarsh reviewed on 2023-09-05 22:28_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/pydocstyle/rules/blank_before_after_class.rs`:241 on 2023-09-05 22:28_

What if itâ€™s followed by a comment?

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/pydocstyle/rules/blank_before_after_class.rs`:239 on 2023-09-05 22:29_

Itâ€™s best to use the Python whitespace functions unless youâ€™re parsing text within a string or within a comment (is my understanding).

---

_@charliermarsh reviewed on 2023-09-05 22:29_

---

_Review comment by @charliermarsh on `crates/ruff/src/rules/pydocstyle/rules/blank_before_after_class.rs`:240 on 2023-09-05 22:30_

We have some has_following_content utilities - can we use any of them here?

---

_@charliermarsh reviewed on 2023-09-05 22:30_

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pydocstyle/rules/blank_before_after_class.rs`:239 on 2023-09-06 06:21_

From the python spec

> Except at the beginning of a logical line or in string literals, the whitespace characters space, tab and formfeed can be used interchangeably to separate tokens. Whitespace is needed between two tokens only if their concatenation could otherwise be interpreted as a different token (e.g., ab is one token, but a b is two tokens).

[source](https://docs.python.org/3/reference/lexical_analysis.html#whitespace-between-tokens)

To me this means that any other whitespace should not be considered whitespace and are a syntax error (because whitespace isn't a valid identifier start). 

I use the python whitespace methods consistently to:

* Avoid having to reason about whether it is guaranteed that the input program is correct and thus, it is safe to accept all whitesapce
* `is_python_whitespace` (or the trim variants) could in theory be faster because they can operate on bytes (no unicode)

---

_Review comment by @MichaReiser on `crates/ruff/src/rules/pydocstyle/rules/blank_before_after_class.rs`:267 on 2023-09-06 06:25_

Could we move this up to line 223 where we intentionally skip the first line? 

We could then improve the perforamnce by cloning the univeral newlines iterator rather than creating a new one from scratch on line 230. That avoids that we scan the first line 2 (actually 3 times, 2 to find the end of the first line, once to trim it.)

---

_@MichaReiser approved on 2023-09-06 06:27_

---

_@konstin reviewed on 2023-09-06 09:55_

---

_Review comment by @konstin on `crates/ruff/src/rules/pydocstyle/rules/blank_before_after_class.rs`:241 on 2023-09-06 09:55_

Good catch, added a comment test

---

_@konstin reviewed on 2023-09-06 09:57_

---

_Review comment by @konstin on `crates/ruff/src/rules/pydocstyle/rules/blank_before_after_class.rs`:240 on 2023-09-06 09:57_

i tried but i don't think they fit here

---

_@konstin reviewed on 2023-09-06 10:24_

---

_Review comment by @konstin on `crates/ruff/src/rules/pydocstyle/rules/blank_before_after_class.rs`:267 on 2023-09-06 10:24_

Turns out we do actually have to parse the first line twice

---

_Comment by @github-actions[bot] on 2023-09-06 10:38_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---

_Merged by @konstin on 2023-09-11 13:09_

---

_Closed by @konstin on 2023-09-11 13:09_

---

_Branch deleted on 2023-09-11 13:09_

---
