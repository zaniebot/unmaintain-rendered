<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Ignore surrounding whitespace when looking for `&lt;!-- snapshot-diagnostics --&gt;` directives in mdtests - astral-sh/ruff #16380</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Ignore surrounding whitespace when looking for <code>&lt;!-- snapshot-diagnostics --&gt;</code> directives in mdtests</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16380">#16380</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-02-25 18:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body">Summary
<p>Something unfortunate that happened while I was working on #16321 was that I initially added an HMTL comment like this:</p>
<pre><code>&lt;!--snapshot-diagnostics --&gt;
</code></pre>
<p>...and I failed to notice for quite a while that there where no snapshots being tested for that specific test. (The directive was missing a whitespace between the <code>&lt;!--</code> opener and the word &quot;snapshot&quot;, meaning that mdtest wasn&#x27;t recognising it as a directive.)</p>
<p>This PR changes the parsing of these directives so that whitespace surrounding the phrase &quot;snapshot-diagnostics&quot; is ignored inside HTML comments.</p>
Test Plan
<p>I added a unit test to the <code>red_knot_test</code> crate. I also manually verified that if you apply this diff, running <code>cargo test -p red_knot_python_semantic</code> creates a new snapshot for you:</p>
<pre><code>diff --git a/crates/red_knot_python_semantic/resources/mdtest/attributes.md b/crates/red_knot_python_semantic/resources/mdtest/attributes.md
index 6920bf18c..cd6171572 100644
--- a/crates/red_knot_python_semantic/resources/mdtest/attributes.md
+++ b/crates/red_knot_python_semantic/resources/mdtest/attributes.md
@@ -125,6 +125,8 @@ C.only_declared = &quot;overwritten on class&quot;
 
 #### Mixed declarations/bindings in class body and `__init__`
 
+&lt;!--snapshot-diagnostics    --&gt;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-25 18:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-25 18:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-25 18:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-25 18:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-25 18:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/BurntSushi">@BurntSushi</a> by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-25 18:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-25 18:59</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>âœ… ecosystem check detected no linter changes.</p>
Linter (preview)
<p>âœ… ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>âœ… ecosystem check detected no format changes.</p>
Formatter (preview)
<p>âœ… ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/red_knot_test/src/parser.rs</code>:430 on 2025-02-25 19:08</div>
            <div class="timeline-body"><p>Hmmm, should these have been removed? I think so, because now when this branch is taken, we either successfully parse an HTML comment (in which case, the previous state should probably be retained) or we report an error. It might be worth an added unit test for this? Although I wonder if it&#x27;s actually impossible to observe. I&#x27;m thinking about something where you have</p>
<pre><code>`some/file/path.py`:

&lt;!-- snapshot-diagnostics --&gt;

```py
print(&quot;frob&quot;)
```
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2025-02-25 19:08</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-27 13:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/src/parser.rs</code>:430 on 2025-02-27 13:21</div>
            <div class="timeline-body"><p>Hmm yeah, good question. I <em>think</em> you&#x27;re right, I think removing these is probably best?</p>
<p>I&#x27;m not entirely sure how to easily add a useful unit test for this (and doesn&#x27;t seem worth spending a lot of time on), but happy to add one as a followup if you can think of something ðŸ˜„</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-27 13:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-27 13:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-27 13:25</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:11:48 UTC
    </footer>
</body>
</html>
