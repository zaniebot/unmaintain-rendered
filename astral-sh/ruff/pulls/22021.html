<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Support custom builtins - astral-sh/ruff #22021</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Support custom builtins</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22021">#22021</a>
        opened by <a href="https://github.com/Wizzerinus">@Wizzerinus</a>
        on 2025-12-17 12:30
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Wizzerinus">@Wizzerinus</a></div>
            <div class="timeline-body">

Summary
<p>Adds the support for custom builtins in ty. They can now be added by placing a <code>__builtins__.pyi</code> file in the project root and defining any necessary builtins.</p>
<p>Right now <code>builtins.pyi</code> is not supported because it&#x27;s shadowed by Typeshed (Pyright does support both AFAIK), but I think this is not really a problem.</p>
<p>Fixes <a href="https://github.com/astral-sh/ty/issues/374">astral-sh/ty#374</a></p>
Test Plan
<p>Added mdtests for custom builtins, did some manual tests on our project that makes heavy use of builtins.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/Wizzerinus">@Wizzerinus</a> on 2025-12-17 12:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/Wizzerinus">@Wizzerinus</a> on 2025-12-17 12:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/Wizzerinus">@Wizzerinus</a> on 2025-12-17 12:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/Wizzerinus">@Wizzerinus</a> on 2025-12-17 12:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-17 12:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-17 12:35</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ‚úÖ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-17 12:36</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>tornado (https://github.com/tornadoweb/tornado)
- tornado/gen.py:255:62: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `None | Awaitable[Unknown] | list[Awaitable[Unknown]] | dict[Any, Awaitable[Unknown]] | Future[Unknown]`, found `_T@next | _T@next | _VT@next`
+ tornado/gen.py:255:62: error[invalid-argument-type] Argument to bound method `__init__` is incorrect: Expected `None | Awaitable[Unknown] | list[Awaitable[Unknown]] | dict[Any, Awaitable[Unknown]] | Future[Unknown]`, found `_T@next | _VT@next | _T@next`

pydantic (https://github.com/pydantic/pydantic)
- pydantic/fields.py:943:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
+ pydantic/fields.py:943:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
- pydantic/fields.py:983:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
+ pydantic/fields.py:983:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
- pydantic/fields.py:1026:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
+ pydantic/fields.py:1026:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
- pydantic/fields.py:1066:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
+ pydantic/fields.py:1066:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
- pydantic/fields.py:1109:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
+ pydantic/fields.py:1109:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
- pydantic/fields.py:1148:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
+ pydantic/fields.py:1148:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
- pydantic/fields.py:1188:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`
+ pydantic/fields.py:1188:5: error[invalid-parameter-default] Default value of type `PydanticUndefinedType` is not assignable to annotated parameter type `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`
- pydantic/fields.py:1567:13: error[invalid-argument-type] Argument is incorrect: Expected `dict[str, Divergent] | ((dict[str, Divergent], /) -&gt; None) | None`, found `Top[dict[Unknown, Unknown]] | (((dict[str, Divergent], /) -&gt; None) &amp; ~Top[dict[Unknown, Unknown]]) | None`
+ pydantic/fields.py:1567:13: error[invalid-argument-type] Argument is incorrect: Expected `dict[str, int | float | str | ... omitted 3 union elements] | ((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) | None`, found `Top[dict[Unknown, Unknown]] | (((dict[str, int | float | str | ... omitted 3 union elements], /) -&gt; None) &amp; ~Top[dict[Unknown, Unknown]]) | None`

Tanjun (https://github.com/FasterSpeeding/Tanjun)
- tanjun/dependencies/data.py:347:12: error[invalid-return-type] Return type does not match returned value: expected `_T@cached_inject`, found `Coroutine[Any, Any, _T@cached_inject | Coroutine[Any, Any, _T@cached_inject]] | _T@cached_inject`
+ tanjun/dependencies/data.py:347:12: error[invalid-return-type] Return type does not match returned value: expected `_T@cached_inject`, found `_T@cached_inject | Coroutine[Any, Any, _T@cached_inject | Coroutine[Any, Any, _T@cached_inject]]`

xarray (https://github.com/pydata/xarray)
- xarray/core/dataarray.py:5744:16: error[invalid-return-type] Return type does not match returned value: expected `T_Xarray@map_blocks`, found `DataArray | Dataset`
+ xarray/core/dataarray.py:5744:16: error[invalid-return-type] Return type does not match returned value: expected `T_Xarray@map_blocks`, found `T_Xarray@map_blocks | DataArray | Dataset`
- xarray/core/dataset.py:8873:16: error[invalid-return-type] Return type does not match returned value: expected `T_Xarray@map_blocks`, found `DataArray | Dataset`
+ xarray/core/dataset.py:8873:16: error[invalid-return-type] Return type does not match returned value: expected `T_Xarray@map_blocks`, found `T_Xarray@map_blocks | DataArray | Dataset`

scikit-build-core (https://github.com/scikit-build/scikit-build-core)
- src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 41 diagnostics
+ Found 40 diagnostics

scikit-learn (https://github.com/scikit-learn/scikit-learn)
- sklearn/externals/array_api_extra/_lib/_at.py:300:17: warning[possibly-missing-attribute] Attribute `dtype` may be missing on object of type `int | slice[Any, Any, Any] | EllipsisType | Array | tuple[int | slice[Any, Any, Any] | EllipsisType | Array, ...]`
+ sklearn/externals/array_api_extra/_lib/_at.py:300:17: warning[possibly-missing-attribute] Attribute `dtype` may be missing on object of type `int | Array | tuple[int | slice[Any, Any, Any] | EllipsisType | Array, ...] | slice[Any, Any, Any] | EllipsisType`
- sklearn/externals/array_api_extra/_lib/_at.py:301:17: warning[possibly-missing-attribute] Attribute `shape` may be missing on object of type `int | slice[Any, Any, Any] | EllipsisType | Array | tuple[int | slice[Any, Any, Any] | EllipsisType | Array, ...]`
+ sklearn/externals/array_api_extra/_lib/_at.py:301:17: warning[possibly-missing-attribute] Attribute `shape` may be missing on object of type `int | Array | tuple[int | slice[Any, Any, Any] | EllipsisType | Array, ...] | slice[Any, Any, Any] | EllipsisType`
- sklearn/externals/array_api_extra/_lib/_at.py:308:25: error[invalid-argument-type] Argument to function `apply_where` is incorrect: Expected `Array`, found `int | slice[Any, Any, Any] | EllipsisType | Array | tuple[int | slice[Any, Any, Any] | EllipsisType | Array, ...]`
+ sklearn/externals/array_api_extra/_lib/_at.py:308:25: error[invalid-argument-type] Argument to function `apply_where` is incorrect: Expected `Array`, found `int | Array | tuple[int | slice[Any, Any, Any] | EllipsisType | Array, ...] | slice[Any, Any, Any] | EllipsisType`

static-frame (https://github.com/static-frame/static-frame)
- static_frame/core/bus.py:671:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[Bus[Any], object_]`, found `InterGetItemLocReduces[Top[Index[Any]] | Top[Series[Any, Any]] | TypeBlocks | ... omitted 6 union elements, object_]`
- static_frame/core/bus.py:675:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Bus[Any], object_]`, found `InterGetItemILocReduces[Top[Bus[Any]] | TypeBlocks | Batch | ... omitted 6 union elements, generic[object]]`
+ static_frame/core/bus.py:671:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemLocReduces[Bus[Any], object_]`, found `InterGetItemLocReduces[Top[Bus[Any]] | TypeBlocks | Batch | ... omitted 6 union elements, object_]`
+ static_frame/core/bus.py:675:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Bus[Any], object_]`, found `InterGetItemILocReduces[Top[Index[Any]] | TypeBlocks | Top[Bus[Any]] | ... omitted 6 union elements, generic[object]]`
- static_frame/core/series.py:4072:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[SeriesHE[Any, Any], TVDtype@SeriesHE]`, found `InterGetItemILocReduces[Self@iloc | SeriesHE[Any, Any], generic[object]]`
+ static_frame/core/series.py:4072:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[SeriesHE[Any, Any], TVDtype@SeriesHE]`, found `InterGetItemILocReduces[Bottom[Series[Any, Any]] | TypeBlocks | Batch | ... omitted 7 union elements, generic[object]]`

pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
+ pandas-stubs/_typing.pyi:1223:16: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
+ tests/frame/test_groupby.py:228:15: error[type-assertion-failure] Type `Series[Any]` does not match asserted type `Series[str | bytes | int | ... omitted 12 union elements]`
+ tests/frame/test_groupby.py:624:15: error[type-assertion-failure] Type `Series[Any]` does not match asserted type `Series[str | bytes | int | ... omitted 12 union elements]`
- Found 5100 diagnostics
+ Found 5103 diagnostics


</code></pre>


<p>No memory usage changes detected ‚úÖ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Wizzerinus">@Wizzerinus</a> on 2025-12-17 13:05</div>
            <div class="timeline-body"><p>Hm, I&#x27;m not sure why colour-science&#x27;s performance fell down more than twice. Back to the drawing board I guess.</p>
<p>EDIT: nevermind, I checked the report once again and that&#x27;s not actually the case. phew.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-12-17 14:39</div>
            <div class="timeline-body"><p>This looks good to me. Thank you. I&#x27;d appreciate a second opinion on the change itself as we never made a formal decision on the issue itself.</p>
<p>It would be great to document this new feature (over in the ty repository)</p>
<p>I think this is useful and it might also provides an easy workaround for <a href="https://github.com/astral-sh/ty/issues/1297">astral-sh/ty#1297</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Wizzerinus">@Wizzerinus</a> on 2025-12-17 15:41</div>
            <div class="timeline-body"><p>Yep, I&#x27;ll document this once(/if) it&#x27;s merged (looks like it&#x27;s in a different repo so a separate PR is necessary anyway).</p>
<p>Does seem useful for IPython stuff, though currently it would require making a builtins file in the project, which seems slightly hacky.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-12-18 11:09</div>
            <div class="timeline-body"><p>I agree we should let users customise the <code>builtins</code> module without having to provide a whole custom typeshed directory. My only reservations here are whether this is the best design. It seems strange to me to have &quot;implicit magic&quot; treatment of a <code>__builtins__</code> name:</p>
<ul>
<li>Why <code>__builtins__</code> specifically? Do modules with that name have any special treatment at runtime? (I don&#x27;t think so?)</li>
<li>Do any other type checkers give implicit special treatment to a <code>__builtins__.pyi</code> stub that happens to be in the workspace root, or is this currently a pyright-specific feature?</li>
</ul>
<p>To me a more intuitive design would be to have this be an opt-in configurable setting, e.g. you&#x27;d put something like this in your configuration file:</p>
<pre><code>custom-builtins = &quot;__builtins__.pyi&quot;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-18 11:12</div>
            <div class="timeline-body"><p>I like convention over configuration but also wouldn&#x27;t mind it being an option. The performance is probably comparable between the two because one requires resolving the settings first and the other does an unnecessary <code>resolve_module</code> call</p>
<blockquote>
<p><code>custom-builtins = &quot;__builtins__.pyi&quot;</code></p>
</blockquote>
<p>This would be under a new <code>analysis</code> section.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-18 11:15</div>
            <div class="timeline-body"><blockquote>
<p>I like convention over configuration but also wouldn&#x27;t mind it being an option.</p>
</blockquote>
<p>Right, that&#x27;s why I was curious if there really was a convention here, or if this was currently just a pyright-specific thing. If e.g. pyrefly or mypy also does the same thing as pyright here, I&#x27;m happy to go with the crowd. But this is not the design I would choose otherwise</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-18 11:19</div>
            <div class="timeline-body"><p>We could establish the convention. That&#x27;s how conventions happen :)</p>
<p>It just feels slightly easier if all you have to do is: Create a <code>__builtins__.pyi</code>, done compared to create a <code>builtins.pyi</code>, set <code>custom-builtins</code>. It also makes it easier for users migrating from pyright</p>
<p>Edit: pyrefly also supports <code>__builtins__.py</code> https://pyrefly.org/en/docs/migrating-from-pyright/#extending-builtins</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Wizzerinus">@Wizzerinus</a> on 2025-12-18 11:19</div>
            <div class="timeline-body"><p>Yeah, it does seem that mypy does not support this feature (and it makes sense that Pyrefly does not support it since it only just released recently). I would be happy to swap to any other way to determine where (and whether) the project stores custom builtins if necessary.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-18 11:22</div>
            <div class="timeline-body"><p>I think one issue with the current implementation is that <code>resolve_module</code> resolves <code>__builtins__.py</code> from any search path, including third-party ones. We should definitely change that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Wizzerinus">@Wizzerinus</a> on 2025-12-18 11:23</div>
            <div class="timeline-body"><p>Yeah, that I definitely should look into fixing :D</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-18 11:26</div>
            <div class="timeline-body"><p>It still seems very strange to me that, without any explicit configuration to opt into it, we would have very special treatment of a module name that (as far as I know) has no special treatment at runtime by the interpreter. That doesn&#x27;t seem like intuitive behaviour at all to me; we&#x27;ll have to make sure we document it well.</p>
<p>But if both pyright and pyrefly already agree on this design, then I&#x27;m okay with moving forward here.</p>
<p>Curious if @sharkdp or @carljm have any thoughts</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Wizzerinus">@Wizzerinus</a> on 2025-12-18 11:32</div>
            <div class="timeline-body"><p>I don&#x27;t think Pyrefly agrees on this behavior, and quite frankly, from what I&#x27;ve seen in the Pyrefly GitHub this was not brought up to Pyrefly&#x27;s devs at all (at least publicly). so ü§∑üèº‚Äç‚ôÇÔ∏è and yeah, when you put it this way it makes much less sense that I did it like this now</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-21 19:11</div>
            <div class="timeline-body"><blockquote>
<p>Edit: pyrefly also supports <code>__builtins__.py</code> <a href="https://pyrefly.org/en/docs/migrating-from-pyright/#extending-builtins">pyrefly.org/en/docs/migrating-from-pyright#extending-builtins</a></p>
</blockquote>
<p>but (according to those docs), it only supports this feature if you put the <code>__builtins__.pyi</code> file in a directory that you&#x27;ve explicitly listed as an extra search path via pyrefly&#x27;s <a href="https://pyrefly.org/en/docs/configuration/#site-package-path"><code>site-package-path</code> config setting</a>. Pyrefly&#x27;s <code>site-package-path</code> config setting is their equivalent of our <code>extra-paths</code> configuration setting, though unlike us (and contradicting the spec?) they give the paths specified by this setting the lowest priority in import resolution.</p>
<p>Giving this <em>very</em> special behaviour to <code>__builtins__.pyi</code> files that we specifically find in an <code>extra-paths</code> search path seems much more defensible to me than implicitly giving this very special behaviour to <em>any</em> <code>__builtins__.pyi</code> file from any search path.</p>
<p>But at that point, you&#x27;ve already said that the user will need some kind of explicit configuration to opt into this behaviour (they need to specify a certain directory in the <code>extra-paths</code> config setting). So it still seems to <em>me</em> that the clearest behaviour would be to have a specific <code>custom-builtins</code> config setting just for opting into this feature, where you can specify the specific file you want ty to treat as a custom <code>builtins</code> stub.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-21 19:46</div>
            <div class="timeline-body"><blockquote>
<p>But at that point, you&#x27;ve already said that the user will need some kind of explicit configuration to opt into this behaviour (they need to specify a certain directory in the extra-paths config setting). So it still seems to me that the clearest behaviour would be to have a specific custom-builtins config setting just for opting into this feature, where you can specify the specific file you want ty to treat as a custom builtins stub.</p>
</blockquote>
<p>One concern I have with the ability to specify an arbitrary path is that we may fail to resolve imports in that file if it isn&#x27;t in one of the search paths. This is not an argument against it, it&#x27;s just something that should be called out in the documentation.</p>
<p>We probably also want to make sure that ty raises typing errors in <code>__builtins__.pyi</code>, and the easiest way to do that is to require the file to be in <code>project.root</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-21 19:50</div>
            <div class="timeline-body"><p>I think the documentation for this option should be quite extensive in general. It&#x27;s an advanced option that should be treated with extreme care, in my opinion. Python&#x27;s builtin classes are some of the most important types in Python. Typeshed updates and refines its annotations for these methods on a regular basis, but by using this option you won&#x27;t benefit from any upstream improvements to these types. There&#x27;s also a much higher risk of ty crashing if you use a custom builtins file, because nearly all of our tests are written using typeshed&#x27;s <code>builtins.pyi</code>, and it&#x27;s very fundamental to type-checking most Python code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-21 20:04</div>
            <div class="timeline-body"><p>Ah no, sorry, please disregard my last comment -- I misunderstood the feature. This layers additional symbols on top of typeshed&#x27;s <code>builtins.pyi</code> file, rather than replacing typeshed&#x27;s <code>builtins.pyi</code> file entirely.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Wizzerinus">@Wizzerinus</a> on 2025-12-21 21:23</div>
            <div class="timeline-body"><p>Yeah, this does not replace builtins but rather add to them, replacing entirely sounds crazy since basic types that are likely hardcoded to some extent (i.e. types of literals) can get &#x27;destroyed&#x27;, so it&#x27;s for the best this is not done.</p>
<p>From my comment in the ty issue:</p>
<blockquote>
<p>I&#x27;m thinking that we could probably have <strong>builtins</strong>.pyi in project root detected by default, and allow overriding the path to the stub in the config. That would mean overriding stubPath would require putting typings.<strong>builtins</strong> instead of just typings in the config, but also means we&#x27;re not cornercasing a name that doesn&#x27;t really mean anything (which alleviates a concern I&#x27;ve heard earlier).</p>
</blockquote>
<p>Which is basically the same version proposed in <a href="https://github.com/astral-sh/ruff/pull/22021">astral-sh/ruff#22021</a>#issuecomment-3679305754 but with a defaut. Though I am unsure whether having the default set to <code>__builtins__</code> or have no default value is better.</p>
<p>I will implement this some time next week, I am somewhat sick right now so gotta hope I won&#x27;t take too long</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-22 08:58</div>
            <div class="timeline-body"><p>IMO, defaulting to <code>__builtins__.pyi</code> seems fine and we could consider an option that allows you to rename the module name (it would be a module name and not a path). I would be okay not adding the option in this initial version. It&#x27;s something we can easily add later based on user requests unless we&#x27;re concerned that users make use of this feature by accident (again, I think that&#x27;s unlikely, given the very specific module name)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-23 00:59</div>
            <div class="timeline-body"><p>Both pyright and pyrefly support <code>__builtins__.pyi</code> in the project root or in an extra-path; I think that&#x27;s sufficient to establish a convention, and we should just make life easier for users and follow the same convention. I&#x27;m not that worried about special-casing the module name: it&#x27;s a dunder name, which Python already tells people to expect to have special behavior, and it&#x27;s not used as a module name by Python itself. It might not be the design I&#x27;d have chosen from a blank slate, but it&#x27;s easy for users, and I don&#x27;t think it&#x27;s sufficiently problematic to warrant introducing an incompatibility with other type checkers over.</p>
<p>I also don&#x27;t think we need to discriminate which search path we found <code>__builtins__.pyi</code> in. Neither pyright nor pyrefly actually do this (despite their documentation arguably implying otherwise). I tested this: if you create a venv and put <code>__builtins__.pyi</code> in its <code>site-packages</code> directory, and type check using that virtualenv, both pyright and pyrefly will discover the <code>__builtins__.pyi</code> and treat it as extra builtins.</p>
<p>Also, both pyright and pyrefly are happy to use it even if it is <code>__builtins__.py</code>, not <code>__builtins__.pyi</code>.</p>
<blockquote>
<p>but (according to those docs), it only supports this feature if you put the <code>__builtins__.pyi</code> file in a directory that you&#x27;ve explicitly listed as an extra search path</p>
</blockquote>
<p>No, pyrefly also supports it in the project root, which I expect is the common case. The docs do say that, and I tested and verified it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-23 01:01</div>
            <div class="timeline-body"><p>I also don&#x27;t think we should implement a config option to specify the path to the <code>__builtins__.py[i]</code> file. That just seems like extra complexity in our implementation, and extra cognitive load for readers of our docs, to support something that no user has asked for and doesn&#x27;t have any clear use case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-12-23 01:02</div>
            <div class="timeline-body"><p>So basically I think we should implement the simplest-possible (and easiest to implement!) version of this feature, which matches pyright and pyrefly, and not overthink it :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-12-23 01:08</div>
            <div class="timeline-body"><p>This looks good to me; thanks for the contribution!</p>
<p>Will hold off on merging for now to give @AlexWaygood and @MichaReiser another chance to consider if they want to advocate for any changes here -- but I&#x27;d suggest we merge this as-is and spend our time on other things.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/infer/builder.rs</code>:4961 on 2025-12-23 07:51</div>
            <div class="timeline-body"><p>What&#x27;s the reason for making this change here rather than changing <code>module.static_member</code>? Are there other places where we call <code>module.static_member</code> that require the same treatment?</p>
<p>Should we use <code>known</code> module here instead of matching by name?</p>
<pre><code>                let sym = if module.module(db).known(db).is_builtins() {
					builtins_symbol(db, attribute)
				} else {
					module.static_member(db, attribute)
                };
                
                if let Place::Defined(attr_ty, _, _) = sym.place {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/place.rs</code>:403 on 2025-12-23 07:51</div>
            <div class="timeline-body"><pre><code>    resolve_module_confident(db, &amp;ModuleName::new_static(&quot;__builtins__&quot;).unwrap())
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-12-23 08:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-23 09:51</div>
            <div class="timeline-body"><p>If Micha and Carl both agree on this design, that&#x27;s good enough for me :-)</p>
<p>(and sorry for misreading the Pyrefly docs!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Wizzerinus">@Wizzerinus</a> reviewed on 2025-12-23 12:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Wizzerinus">@Wizzerinus</a> on <code>crates/ty_python_semantic/src/types/infer/builder.rs</code>:4961 on 2025-12-23 12:32</div>
            <div class="timeline-body"><p>Getting back to this.</p>
<p>So, moving that change to <code>Type::static_member</code> allows us to pass the following test (assuming <code>foo: int</code> is defined in the stub):</p>
<pre><code>import builtins
import inspect

reveal_type(inspect.getattr_static(builtins, &quot;foo&quot;))  # revealed: int
</code></pre>
<p>If I had to guess (I have not tested it), moving it to <code>ModuleLiteralType::static_member</code> would also allow us to pass the following test:</p>
<pre><code>import builtins

reveal_type(getattr(builtins, &quot;foo&quot;))  # revealed: int
</code></pre>
<p>So far so good (though I do not want to think about the consequences of <code>builtins.__dict__</code> being type-revealed; I assume we could reveal an intersection type of the builtins dict and the <code>__builtins__</code> dict there).</p>
<p>However, the comment on <code>fn builtins_symbol</code> explicitly says:</p>
<pre><code>/// Note that this function is only intended for use in the context of the builtins *namespace*
/// and should not be used when a symbol is being explicitly imported from the `builtins` module
/// (e.g. `from builtins import int`).
</code></pre>
<p>And the passing tests contradict this comment. I don&#x27;t know why the comment is in here, since I barely have any experience working with ty&#x27;s codebase, but I assume it&#x27;s there for a reason and I shouldn&#x27;t introduce behavior that directly goes against the comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Wizzerinus">@Wizzerinus</a> on 2025-12-23 12:41</div>
            <div class="timeline-body"><p>Resolved the comments and rebased to fix a conflict with the recent crate change. I have one additional question about moving the builtins check into <code>module.static_member</code>, described above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-12-23 13:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/infer/builder.rs</code>:4961 on 2025-12-23 13:13</div>
            <div class="timeline-body"><p>Makes sense to keep it where it is for now. Thanks for taking a look</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Wizzerinus">@Wizzerinus</a> on 2025-12-23 13:31</div>
            <div class="timeline-body"><p>had to force push to satisfy clippy and formatter, so automerge will have to be reenabled, whoops</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-23 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-23 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-23 13:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andrewgross">@andrewgross</a> on 2026-01-14 17:14</div>
            <div class="timeline-body"><p>Very excited this got merged and the ref used in <code>ty</code>. Any chance there will be a new release soon so that <code>ruff</code> and my associated ruff pre commit hooks and also be aware of the file?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/andrewgross">@andrewgross</a> on 2026-01-14 17:16</div>
            <div class="timeline-body"><p>Nevermind, it is in place, guess I just need to figure out how to get <code>ruff</code> to use the same file as <code>ty</code></p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:21:48 UTC
    </footer>
</body>
</html>
