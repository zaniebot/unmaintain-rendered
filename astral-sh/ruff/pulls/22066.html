<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Track narrowing unions to prevent exponential blowup - astral-sh/ruff #22066</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Track narrowing unions to prevent exponential blowup</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22066">#22066</a>
        opened by <a href="https://github.com/zanieb">@zanieb</a>
        on 2025-12-19 02:39
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a></div>
            <div class="timeline-body"><p>See https://github.com/astral-sh/ty/issues/2026#issuecomment-3673229602</p>
<p>I'm mostly exploring this as a short-term way to resolve the exponential complexity of recursive analysis as described in the linked issue. It may or may not have longstanding value once we support discriminated (or &quot;tagged&quot;) unions for typed dicts.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @zanieb on 2025-12-19 02:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @zanieb on 2025-12-19 02:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-19 02:41</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-19 02:42</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">prefect (https://github.com/PrefectHQ/prefect)
- src/integrations/prefect-dbt/prefect_dbt/core/settings.py:94:28: error[invalid-assignment] Object of type `dict[str, Any] | T@resolve_block_document_references | str | ... omitted 4 union elements` is not assignable to `dict[str, Any]`
+ src/integrations/prefect-dbt/prefect_dbt/core/settings.py:94:28: error[invalid-assignment] Object of type `dict[str, Any] | T@resolve_block_document_references | int | ... omitted 4 union elements` is not assignable to `dict[str, Any]`
- src/prefect/cli/deploy/_core.py:86:21: error[invalid-assignment] Object of type `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements` is not assignable to `dict[str, Any]`
+ src/prefect/cli/deploy/_core.py:86:21: error[invalid-assignment] Object of type `T@resolve_block_document_references | int | dict[str, Any] | ... omitted 4 union elements` is not assignable to `dict[str, Any]`
- src/prefect/deployments/steps/core.py:137:38: error[invalid-argument-type] Argument is incorrect: Expected `T@resolve_variables`, found `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements`
+ src/prefect/deployments/steps/core.py:137:38: error[invalid-argument-type] Argument is incorrect: Expected `T@resolve_variables`, found `T@resolve_block_document_references | int | dict[str, Any] | ... omitted 4 union elements`
- src/prefect/utilities/templating.py:320:13: error[invalid-assignment] Invalid subscript assignment with key of type `object` and value of type `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements` on object of type `dict[str, Any]`
+ src/prefect/utilities/templating.py:320:13: error[invalid-assignment] Invalid subscript assignment with key of type `object` and value of type `T@resolve_block_document_references | int | dict[str, Any] | ... omitted 4 union elements` on object of type `dict[str, Any]`
- src/prefect/utilities/templating.py:323:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_block_document_references | dict[str, Any]`, found `list[T@resolve_block_document_references | dict[str, Any] | str | ... omitted 5 union elements]`
+ src/prefect/utilities/templating.py:323:16: error[invalid-return-type] Return type does not match returned value: expected `T@resolve_block_document_references | dict[str, Any]`, found `list[T@resolve_block_document_references | int | dict[str, Any] | ... omitted 5 union elements]`
- src/prefect/workers/base.py:228:13: error[invalid-argument-type] Argument is incorrect: Expected `T@resolve_variables`, found `T@resolve_block_document_references | dict[str, Any] | str | ... omitted 4 union elements`
+ src/prefect/workers/base.py:228:13: error[invalid-argument-type] Argument is incorrect: Expected `T@resolve_variables`, found `T@resolve_block_document_references | int | dict[str, Any] | ... omitted 4 union elements`

scikit-build-core (https://github.com/scikit-build/scikit-build-core)
+ src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 42 diagnostics
+ Found 43 diagnostics

jax (https://github.com/google/jax)
+ jax/_src/tree_util.py:302:31: error[invalid-argument-type] Argument to bound method `register_node` is incorrect: Expected `(Hashable, Iterable[object], /) -&gt; T@register_pytree_node`, found `(_AuxData@register_pytree_node, _Children@register_pytree_node, /) -&gt; T@register_pytree_node`
+ jax/_src/tree_util.py:305:31: error[invalid-argument-type] Argument to bound method `register_node` is incorrect: Expected `(Hashable, Iterable[object], /) -&gt; T@register_pytree_node`, found `(_AuxData@register_pytree_node, _Children@register_pytree_node, /) -&gt; T@register_pytree_node`
+ jax/_src/tree_util.py:308:31: error[invalid-argument-type] Argument to bound method `register_node` is incorrect: Expected `(Hashable, Iterable[object], /) -&gt; T@register_pytree_node`, found `(_AuxData@register_pytree_node, _Children@register_pytree_node, /) -&gt; T@register_pytree_node`
- Found 2802 diagnostics
+ Found 2805 diagnostics

static-frame (https://github.com/static-frame/static-frame)
- static_frame/core/series.py:772:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Series[Any, Any], TVDtype@Series]`, found `InterGetItemILocReduces[Series[Any, Any] | Top[Index[Any]] | TypeBlocks | ... omitted 6 union elements, generic[object]]`
+ static_frame/core/series.py:772:16: error[invalid-return-type] Return type does not match returned value: expected `InterGetItemILocReduces[Series[Any, Any], TVDtype@Series]`, found `InterGetItemILocReduces[Series[Any, Any], generic[object]]`

pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
- pandas-stubs/_typing.pyi:1223:16: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 5086 diagnostics
+ Found 5085 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-12-19 02:56</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/zb%2Fnarrow-track?utm_source=github&amp;utm_medium=comment&amp;utm_content=header">CodSpeed Performance Report</a></h2>
<h3>Merging #22066 will <strong>improve performance by 72.68%</strong></h3>
<p><sub>Comparing <code>zb/narrow-track</code> (fd525e8) with <code>main</code> (1a18ada)</sub></p>
<h3>Summary</h3>
<p><code>⚡ 2</code> improvements<br />
<code>✅ 20</code> untouched<br />
<code>⏩ 30</code> skipped[^skipped]</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Mode | Benchmark | <code>BASE</code> | <code>HEAD</code> | Efficiency |
| --- | ---- | --------- | ------ | ------ | ---------- |
| ⚡ | WallTime | <a href="https://codspeed.io/astral-sh/ruff/branches/zb%2Fnarrow-track?uri=crates%2Fruff_benchmark%2Fbenches%2Fty_walltime.rs%3A%3Amedium%5Bcolour-science%5D&amp;runnerMode=WallTime&amp;utm_source=github&amp;utm_medium=comment&amp;utm_content=benchmark"><code>medium[colour-science]</code></a> | 107.1 s | 100.7 s | +6.35% |
| ⚡ | WallTime | <a href="https://codspeed.io/astral-sh/ruff/branches/zb%2Fnarrow-track?uri=crates%2Fruff_benchmark%2Fbenches%2Fty_walltime.rs%3A%3Alarge%5Bpydantic%5D&amp;runnerMode=WallTime&amp;utm_source=github&amp;utm_medium=comment&amp;utm_content=benchmark"><code>large[pydantic]</code></a> | 105.9 s | 61.3 s | +72.68% |</p>
<p>[^skipped]: 30 benchmarks were skipped, so the baseline results were used instead. If they were deleted from the codebase, <a href="https://codspeed.io/astral-sh/ruff/branches/zb%2Fnarrow-track?sectionId=benchmark-comparison-section-baseline-result-skipped&amp;utm_source=github&amp;utm_medium=comment&amp;utm_content=archive">click here and archive them to remove them from the performance reports</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-19 17:40</div>
            <div class="timeline-body"><p>Hm is this a fix for some false positives?</p>
<pre><code>pandas-stubs (https://github.com/pandas-dev/pandas-stubs)
- tests/frame/test_groupby.py:228:15: error[type-assertion-failure] Type `Series[Any]` does not match asserted type `Series[str | bytes | int | ... omitted 12 union elements]`
- tests/frame/test_groupby.py:624:15: error[type-assertion-failure] Type `Series[Any]` does not match asserted type `Series[str | bytes | int | ... omitted 12 union elements]`
- Found 5085 diagnostics
+ Found 5083 diagnostics
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/infer/builder.rs</code>:7147 on 2025-12-19 21:19</div>
            <div class="timeline-body"><p>If you make <code>narrowing_unions</code> an <code>FxOrderMap</code>, this can become a <code>pop</code>, since the nested calls should be stack-like</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/infer/builder.rs</code>:7032 on 2025-12-19 21:27</div>
            <div class="timeline-body"><p>nit: let chains!</p>
<pre><code class="language-suggestion">        let call_expression_tcx = if let Some(Type::Union(union)) = call_expression_tcx.annotation
            &amp;&amp; let Some(&amp;narrowed_ty) = self.narrowing_unions.get(&amp;union)
        {
            TypeContext::new(Some(narrowed_ty))
        } else {
            call_expression_tcx
        };
</code></pre>
<p>(I mildly prefer how that means you don't have to repeat the fallback case)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> approved on 2025-12-19 21:30</div>
            <div class="timeline-body"><p>This looks fine to me, esp with an eye towards landing a quick fix and iterating on that as follow-on work.</p>
<p>@ibraheemdev mentioned in discord:</p>
<blockquote>
<p>I think we need something slightly different than [this] PR though, we should be propagating the narrowed type context through the nested calls instead of the entire union, but not ignoring it completely</p>
</blockquote>
<p>It looks like with the latest commit, you are propagating the narrowed <em>type</em> (though not the narrowed <em>type context</em>) along with the union. I'm not sure whether that's sufficient, but if not, I'm happy to address that as a follow-on.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/zanieb">@zanieb</a> reviewed on 2025-12-19 21:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/zanieb">@zanieb</a> on <code>crates/ty_python_semantic/src/types/infer/builder.rs</code>:7032 on 2025-12-19 21:33</div>
            <div class="timeline-body"><p>Strong agree. The AI doesn't know about the power of let-chains yet, I think — too new.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-19 21:35</div>
            <div class="timeline-body"><p>Thanks for giving this a look!</p>
<blockquote>
<p>It looks like with the latest commit, you are propagating the narrowed type (though not the narrowed type context) along with the union. I'm not sure whether that's sufficient, but if not, I'm happy to address that as a follow-on.</p>
</blockquote>
<p>Ah interesting. I missed the nuance there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-12-19 21:41</div>
            <div class="timeline-body"><blockquote>
<p>Ah interesting. I missed the nuance there.</p>
</blockquote>
<p>It <em>might</em> be the case that the narrowed type context will always end up being the narrowed type — that's the point of the bidi type context after all. But I'm not certain whether there are cases where the narrowed type will still be narrower than the narrowed type context, and if so, whether that's important. I would defer to @ibraheemdev on that question.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-12-20 04:02</div>
            <div class="timeline-body"><p>As discussed on Discord, I don't think this is correct. We already correctly propagate the narrowed type context during inference, this PR essentially argues that if a child call has a union as type context which we are currently narrowing as part of a parent call, the child call will narrow to the same element as the parent. It's very rare to have nested generic calls where this matters in the first place, but that heuristic is not necessarily true, e.g.,</p>
<pre><code class="language-py">def f(x: list[int | None] | list[str | None]) -&gt; str:
    return &quot;&quot;

def g[T](x: T) -&gt; list[T]:
    return [x]

# regression: error: Expected `list[int | None] | list[str | None]`, found `list[str | None | int]`
f(g(f(g(1))))
</code></pre>
<p>The performance improvement here seems to be in cases where didn't need to narrow in the first place, which https://github.com/astral-sh/ruff/pull/22102 should address.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2025-12-20 04:04</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @zanieb on 2025-12-20 04:04</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:18:13 UTC
    </footer>
</body>
</html>
