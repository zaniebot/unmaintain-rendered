<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>py-fuzzer: fix minimization logic when `--only-new-bugs` is passed - astral-sh/ruff #17739</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>py-fuzzer: fix minimization logic when <code>--only-new-bugs</code> is passed</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17739">#17739</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-04-30 15:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-04-30 15:27</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR fixes an issue in the py-fuzzer script described in https://github.com/astral-sh/ruff/pull/17702#issuecomment-2841720242. Namely, if run with <code>--only-new-bugs</code>, it's not sufficient for the script to just check that the bug exists in the new version of Ruff/red-knot when the script is minimizing the code that triggers the bug. The script must also check that the minimized version of the code <em>also</em> continues to <em>not</em> cause a panic on the baseline executable if <code>--only-new-bugs</code> is passed. Otherwise, the minimization has gone &quot;too far&quot;. It's no longer a <em>new</em> bug if it's been minimized to a snippet that causes a panic on both the test executable <em>and</em> the baseline executable.</p>
<p>The first commit here just simplifies the way we run red-knot on the randomly generated code: the <code>--project</code> CLI argument is no longer necessary, and it's no longer necessary to write a <code>pyproject.toml</code> file to the temporary directory. The second commit here is the one that meaningfully fixes the bug.</p>
<h2>Test Plan</h2>
<p>I checked that the script continues to pass with mypy using <code>uv run --directory ./python/py-fuzzer --dev mypy</code> from the root of my local Ruff clone.</p>
<p>I also did the following to test this change:</p>
<ol>
<li><p>I checked out https://github.com/astral-sh/ruff/commit/4a621c2c12fb65fae343883ad17ce535411c5712 (the commit prior to https://github.com/astral-sh/ruff/commit/8a6787b39e178ff829d58d775b4d65d83b061c53)</p>
</li>
<li><p>I ran <code>cargo build -p red_knot --target-dir ./target/baseline</code> to create a baseline executable.</p>
</li>
<li><p>I checked out this branch again.</p>
</li>
<li><p>I ran the following command:</p>
<pre><code>uvx \                                           
--python=3.13 \
--force-reinstall \
--from=./python/py-fuzzer \
fuzz \
--baseline-executable=&quot;./target/baseline/debug/red_knot&quot; \
--bin=red_knot \
--only-new-bugs \
50
</code></pre>
<p>which produced the following output:</p>
<pre><code>Running `cargo build --release` since no test executable was specified...
Sequentially running the fuzzer on 1 randomly generated source-code files...
Ran fuzzer on seed 50                                         [1/1]
The following code triggers a red-knot panic:

class name_3[name_2: name_0]:
    pass
name_3.name_4
assert name_3[name_0]
import name_0

New bugs found in the following seeds:
50
</code></pre>
<p>I then confirmed that the script had correctly minimized the snippet to something that caused a panic on this branch but had <em>not</em> caused a panic prior to https://github.com/astral-sh/ruff/commit/8a6787b39e178ff829d58d775b4d65d83b061c53, unlike the buggy behaviour that the script displays on <code>main</code>.</p>
</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-04-30 15:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @AlexWaygood on 2025-04-30 15:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-04-30 15:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-04-30 15:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-04-30 15:37</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-04-30 17:47</div>
            <div class="timeline-body"><p>Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-04-30 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-04-30 17:48</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-30 17:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:57:30 UTC
    </footer>
</body>
</html>
