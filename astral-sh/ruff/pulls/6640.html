<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refactor `SourceKind` to store file content - astral-sh/ruff #6640</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Refactor <code>SourceKind</code> to store file content</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6640">#6640</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-08-17 07:51
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>This PR changes two things. You may want to take a look at the individual commits. I'm not entirely convinced whether we should land this change and it certainly needs more testing:</p>
<ol>
<li>It changes <code>Diagnostics</code> to store the notebooks rather than the <code>SourceKind</code>. The sole reason is that we don't need the kind. We only need the notebook index to resolve cells. Ideally, this would be handled by a custom diagnostic kind, but we aren't there yet</li>
<li>I changed <code>SourceKind</code> to store the content for both <code>Notebooks</code> and regular Python files. This allows us to align <code>lint_fix</code> to never return the input in place, and instead return the updated result as a <code>Cow&lt;'a, SourceKind&gt;</code>. I find this easier to reason about than having to remember that notebooks are updated in place, but regular source code is not. However, this has the downside that we now need to clone the Notebooks, which may be rather expensive (multiple large vecs).</li>
</ol>
<p>I'm looking for general feedback. Also happy if someone with more understanding on jupyter notebooks wants to take this over.</p>
<h2>Test Plan</h2>
<!-- How was it tested? -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-17 07:51</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #6629</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6629" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #6640</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6640" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6640?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-17 08:26</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.01      3.3Â±0.01ms    12.2 MB/sec    1.00      3.3Â±0.01ms    12.3 MB/sec
formatter/numpy/ctypeslib.py               1.01    677.9Â±9.42Âµs    24.6 MB/sec    1.00    673.6Â±8.83Âµs    24.7 MB/sec
formatter/numpy/globals.py                 1.00     70.4Â±0.33Âµs    41.9 MB/sec    1.00     70.2Â±0.66Âµs    42.0 MB/sec
formatter/pydantic/types.py                1.02  1360.9Â±14.58Âµs    18.7 MB/sec    1.00  1335.4Â±18.96Âµs    19.1 MB/sec
linter/all-rules/large/dataset.py          1.00     10.7Â±0.05ms     3.8 MB/sec    1.00     10.7Â±0.04ms     3.8 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.9Â±0.01ms     5.8 MB/sec    1.00      2.9Â±0.01ms     5.7 MB/sec
linter/all-rules/numpy/globals.py          1.00    323.2Â±2.29Âµs     9.1 MB/sec    1.00    324.4Â±1.02Âµs     9.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.5Â±0.02ms     4.6 MB/sec    1.01      5.5Â±0.02ms     4.6 MB/sec
linter/default-rules/large/dataset.py      1.01      5.6Â±0.02ms     7.3 MB/sec    1.00      5.5Â±0.02ms     7.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1195.4Â±7.92Âµs    13.9 MB/sec    1.00   1194.8Â±6.09Âµs    13.9 MB/sec
linter/default-rules/numpy/globals.py      1.00    125.5Â±0.52Âµs    23.5 MB/sec    1.00    125.5Â±0.76Âµs    23.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.5Â±0.01ms    10.1 MB/sec    1.00      2.5Â±0.02ms    10.1 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      4.8Â±0.22ms     8.5 MB/sec    1.05      5.0Â±0.29ms     8.2 MB/sec
formatter/numpy/ctypeslib.py               1.00   969.8Â±39.07Âµs    17.2 MB/sec    1.00   970.1Â±38.45Âµs    17.2 MB/sec
formatter/numpy/globals.py                 1.00     95.0Â±4.15Âµs    31.1 MB/sec    1.04     99.1Â±7.46Âµs    29.8 MB/sec
formatter/pydantic/types.py                1.00  1967.0Â±88.09Âµs    13.0 MB/sec    1.02  1997.4Â±114.85Âµs    12.8 MB/sec
linter/all-rules/large/dataset.py          1.00     17.8Â±0.48ms     2.3 MB/sec    1.03     18.4Â±0.59ms     2.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      5.0Â±0.18ms     3.3 MB/sec    1.00      5.0Â±0.32ms     3.3 MB/sec
linter/all-rules/numpy/globals.py          1.02   624.8Â±48.44Âµs     4.7 MB/sec    1.00   614.5Â±29.54Âµs     4.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      9.2Â±0.30ms     2.8 MB/sec    1.05      9.7Â±0.37ms     2.6 MB/sec
linter/default-rules/large/dataset.py      1.00      9.9Â±0.33ms     4.1 MB/sec    1.05     10.4Â±0.33ms     3.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.1Â±0.08ms     7.9 MB/sec    1.02      2.1Â±0.13ms     7.8 MB/sec
linter/default-rules/numpy/globals.py      1.00   254.0Â±15.06Âµs    11.6 MB/sec    1.04   263.9Â±13.66Âµs    11.2 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.4Â±0.20ms     5.8 MB/sec    1.04      4.6Â±0.21ms     5.6 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/source_kind.rs</code>:6 on 2023-08-17 08:48</div>
            <div class="timeline-body"><p>It would be nice to store the <code>PySourceType</code> on the <code>SourceKind</code> as well (making it a <code>Program</code> or <code>SourceFile</code> entity). However, it is a bit awkward because <code>PySourceType</code> has a <code>Jupyter</code> variant, but that variant should only be used to <code>Jupyter</code>...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/linter.rs</code>:66 on 2023-08-17 08:49</div>
            <div class="timeline-body"><p>The change here is that the linter now returns the transformed <code>SourceKind</code> which aligns the handling of Notebooks with regular python files in the sense that it doesn't mutate the source file in place.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/linter.rs</code>:377 on 2023-08-17 08:50</div>
            <div class="timeline-body"><p>Not sure why this is optional, but wanted to avoid increasing the scope of this even more.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/source_kind.rs</code>:24 on 2023-08-17 08:51</div>
            <div class="timeline-body"><p>This for sure is more expensive than the old &quot;update in place&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-17 08:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @MichaReiser on 2023-08-17 08:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @MichaReiser on 2023-08-17 08:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2023-08-17 08:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-17 14:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_cli/src/diagnostics.rs</code>:67 on 2023-08-17 14:38</div>
            <div class="timeline-body"><p>This looks reasonable. So this allows us to keep the string content on <code>SourceKind::Python</code>, since we no longer store the Python source kind on here anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-08-17 14:38</div>
            <div class="timeline-body"><p>I think I'm supportive of this. It's really nice to avoid the <code>&amp;mut</code> on the source kind.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2023-08-17 14:48</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-17 18:57</div>
            <div class="timeline-body"><p>@dhruvmanila any opinion on this? Any recommendations on how to test the changes?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/linter.rs</code>:377 on 2023-08-17 19:50</div>
            <div class="timeline-body"><p>The reason this is optional is because there's no <code>--add-noqa</code> support for Jupyter Notebooks yet. The logic for <code>add_noqa_to_path</code> basically calls into <code>check_path</code> and as far as I recall there were some circular dependency problems. Maybe it could be solved now with the recent changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-08-17 19:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/message/mod.rs</code>:140 on 2023-08-17 19:53</div>
            <div class="timeline-body"><p>nit:</p>
<pre><code class="language-suggestion">    pub fn new(notebooks: &amp;'a FxHashMap&lt;String, Notebook&gt;) -&gt; Self {
        Self { notebooks }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/source_kind.rs</code>:24 on 2023-08-18 04:48</div>
            <div class="timeline-body"><p>Yeah, my main reason to update in place was to avoid cloning the entire notebook. Actually, the only thing we need to update with each linting cycle are the cell markers and the transformed source code can be looped over to the next iteration cycle. The cell content can be updated at the end before we actually update the Notebook that too only when <code>--fix</code> is passed.</p>
<p>Using the above idea, we could create a <code>NotebookView</code> which would only contain the necessary fields (for now I think it's cell markers only and the concatenated source code?) and should be much cheaper to clone. We would not even clone it and use an <code>updated</code> method on the view with the <code>SourceMap</code> and transformed source code and create a new view with the updated source code and cell markers. Once the linter iteration is complete, we can <em>apply</em> the view onto the Notebook, update the cell content then and write the Notebook back to the disk.</p>
<p>I think the abstraction would be to have a view into the source code be it Python or Jupyter and the view would have <code>updated</code> method to update the view. At the end the view will be applied to the concrete type and saved onto the disk.</p>
<p>This is just a rough idea based on my morning walk :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/test.rs</code>:58 on 2023-08-18 04:48</div>
            <div class="timeline-body"><p>This is good. Thanks for doing this :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2023-08-18 04:52</div>
            <div class="timeline-body"><p>Thanks for making these changes :)</p>
<p>In the near future we should move towards finalizing an abstraction layer between different sources and the engines (linter, formatter, etc.).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-08-18 05:11</div>
            <div class="timeline-body"><blockquote>
<p>Any recommendations on how to test the changes?</p>
</blockquote>
<p>My main concern would be to test the linter loop (&gt; 2 iterations) with <code>--fix</code>. The way we could do this is to use a source code where some fixes overlap so that then the other fixes gets applied in the next iteration allowing us to make sure the updates are taking place correctly. I gave a quick test and it's good. There are 4 iteration loops in the following test case. I'll add this test case in another PR.</p>
<h3>Cells</h3>
<ol>
<li></li>
</ol>
<pre><code class="language-python">import random
import math
</code></pre>
<ol start="2">
<li></li>
</ol>
<pre><code class="language-python">try:
    print()
except ValueError:
    pass
</code></pre>
<ol start="3">
<li></li>
</ol>
<pre><code class="language-python">import random
import pprint

random.randint(10, 20)
</code></pre>
<ol start="4">
<li></li>
</ol>
<pre><code class="language-python">foo = 1
if foo is 2:
    raise ValueError(f&quot;Invalid foo: {foo is 1}&quot;)
</code></pre>
<p>Command:</p>
<pre><code>cargo run --bin ruff --package ruff_cli -- check --no-cache --isolated --select=I,F,SIM /path/to/test.ipynb --fix --diff
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-18 06:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/source_kind.rs</code>:24 on 2023-08-18 06:21</div>
            <div class="timeline-body"><p>I don't think I'm able to follow. Do you want to take a stab at this together with performing the renaming that you suggested? Or is this something that needs changing before landing this PR?</p>
<p>I tried to change <code>raw</code> to an <code>Rc</code> to get cheap cloning. However, it turns out that <code>update_cell_content</code> mutates the raw cells. The only larger structure that doesn't seem to get updated is <code>valid_code_cells</code>.</p>
<p>I think we could also move out <code>index</code> from the <code>Notebook</code> because it is only used in <code>Diagnostics</code> and instead have a <code>JupyterIndex</code> that is either <code>Lazy(Notebook)</code> or <code>Built(Index)</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-18 08:31</div>
            <div class="timeline-body"><p>Thanks @dhruvmanila for the extensive test plan. I played through the commands (showing diagnostics, diff, and fixing) and it works as expected</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-18 08:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/linter.rs</code>:377 on 2023-08-18 08:32</div>
            <div class="timeline-body"><p>Could <code>add_noqa_to_path</code> detect the <code>PySourceType</code> and exit early (with a warning) if it is a Jupyter notebook to avoid that all downstream code has to handle optional source kinds?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Store notebooks on Diagnostics" to "Refactor `SourceKind` to store file content" by @MichaReiser on 2023-08-18 08:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff/src/source_kind.rs</code>:24 on 2023-08-18 10:42</div>
            <div class="timeline-body"><blockquote>
<p>Do you want to take a stab at this together with performing the renaming that you suggested?</p>
</blockquote>
<p>Yeah, I can give it a go next week.</p>
<blockquote>
<p>Or is this something that needs changing before landing this PR?</p>
</blockquote>
<p>No</p>
<blockquote>
<p>The only larger structure that doesn't seem to get updated is <code>valid_code_cells</code>.</p>
</blockquote>
<p>What do you mean here by &quot;larger structure&quot;? As <code>valid_code_cells</code> is just a vector of <code>u32</code>.</p>
<blockquote>
<p>However, it turns out that <code>update_cell_content</code> mutates the raw cells.</p>
</blockquote>
<p>Yeah, this update isn't really required for every linter loop. We can avoid doing that and only update it at the end. This basically uses the concatenated source code and cell markers to update the cell content.</p>
<blockquote>
<p>I think we could also move out <code>index</code> from the <code>Notebook</code> because it is only used in <code>Diagnostics</code> and instead have a <code>JupyterIndex</code> that is either <code>Lazy(Notebook)</code> or <code>Built(Index)</code>.</p>
</blockquote>
<p>Yeah, this is a good idea.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-08-18 10:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/source_kind.rs</code>:24 on 2023-08-18 11:02</div>
            <div class="timeline-body"><blockquote>
<p>What do you mean here by &quot;larger structure&quot;? As valid_code_cells is just a vector of u32.</p>
</blockquote>
<p>With large, I mean any non-fixed size heap allocated data structure that requires a deep clone.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-18 11:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-08-18 13:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-08-18 13:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-18 13:45</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:59:36 UTC
    </footer>
</body>
</html>
