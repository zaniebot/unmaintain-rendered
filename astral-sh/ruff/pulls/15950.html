<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Merge Markdown code blocks inside a single section - astral-sh/ruff #15950</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Merge Markdown code blocks inside a single section</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15950">#15950</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-02-04 21:43
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-02-04 21:43</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Allow for literate style in Markdown tests and merge multiple (unnamed) code blocks into a single embedded file.</p>
<p>closes #15941 (see ticket for a more detailed description of the general idea, or look at the exemplary changes in the Markdown files)</p>
<p>Note: unfortunately, this conflicts badly with #15945 by @BurntSushi. This PR is definitely low-priority, so I'm happy to resolve conflicts here once #15945 is merged.</p>
<h2>Test Plan</h2>
<ul>
<li>Interactively made sure that error-lines were reported correctly in multi-snippet sections.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @sharkdp on 2025-02-04 21:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @sharkdp on 2025-02-05 09:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @sharkdp on 2025-02-05 09:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-02-05 09:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @sharkdp on 2025-02-05 09:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-02-05 09:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/parser.rs</code>:168 on 2025-02-05 10:06</div>
            <div class="timeline-body"><p>It might be worth to move this comment into the <code>CodeBlockStructure</code>'s doccomment</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/parser.rs</code>:181 on 2025-02-05 10:07</div>
            <div class="timeline-body"><p>I find the <code>Structure</code> postfix not very meaningful. Why isn't a <code>CodeBlock</code> a structure itself.</p>
<p>Reading the comment, the focus here is that this structure holds the code blocks for a single file.</p>
<p>How about:</p>
<ul>
<li>EmbeddedFileLineIndex (has the advantage that everyone familiar with <code>LineIndex</code> immediately knows what this is)</li>
<li>EmbeddedFileSourceMap (similar to the source map used for jupyter notebooks)</li>
<li>FileCodeBlockLines</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/parser.rs</code>:217 on 2025-02-05 10:07</div>
            <div class="timeline-body"><p>Nit: <code>Autogenerated(PySourceType)</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/parser.rs</code>:286 on 2025-02-05 10:09</div>
            <div class="timeline-body"><p>Nit: I'd be surprised that <code>code</code> constructs the code when calling. Maybe rename to <code>to_code</code> or can we do the joining more eagerly when constructing <code>EmbeddedFile</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/parser.rs</code>:623 on 2025-02-05 10:10</div>
            <div class="timeline-body"><p>Can we make those messages more useful and include some line numbers or at least test name or is this done further up in the parser?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/lib.rs</code>:140 on 2025-02-05 10:12</div>
            <div class="timeline-body"><p>Nit: Could we simplify this by collecting the dimensions instead of using a <code>Box&lt;dyn impl Iterator&gt;</code>. I suspect that the performance difference is minimal.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-02-05 10:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-05 11:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/src/lib.rs</code>:140 on 2025-02-05 11:42</div>
            <div class="timeline-body"><p>I wanted to make it lazy to avoid counting line numbers for all snippets even if we never emit a test failure, but that might have been an unnecessary optimization, I agree. Will look into it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/src/lib.rs</code>:117 on 2025-02-05 12:12</div>
            <div class="timeline-body"><p>We could consider:</p>
<ol>
<li>Adding a <code>full_path()</code> method to <code>EmbeddedFile</code> (and removing the <code>path_str()</code> method)</li>
<li>Implementing <code>PartialEq&lt;str&gt;</code> for <code>EmbeddedFilePath</code></li>
</ol>
<details>
<summary>Patch</summary>

<pre><code class="language-diff">diff --git a/crates/red_knot_test/src/lib.rs b/crates/red_knot_test/src/lib.rs
index 5bd878e98..4d86d8bc3 100644
--- a/crates/red_knot_test/src/lib.rs
+++ b/crates/red_knot_test/src/lib.rs
@@ -110,11 +110,7 @@ fn run_test&lt;'s&gt;(db: &amp;mut db::Db, test: &amp;'s parser::MarkdownTest) -&gt; Result&lt;(), F
                 &quot;Supported file types are: py, pyi, text&quot;
             );
 
-            let full_path = if embedded.path_str().starts_with('/') {
-                SystemPathBuf::from(embedded.path_str())
-            } else {
-                project_root.join(embedded.path_str())
-            };
+            let full_path = embedded.full_path(&amp;project_root);
 
             if let Some(ref typeshed_path) = custom_typeshed_path {
                 if let Ok(relative_path) = full_path.strip_prefix(typeshed_path.join(&quot;stdlib&quot;)) {
diff --git a/crates/red_knot_test/src/parser.rs b/crates/red_knot_test/src/parser.rs
index 048f09844..3e6271360 100644
--- a/crates/red_knot_test/src/parser.rs
+++ b/crates/red_knot_test/src/parser.rs
@@ -1,6 +1,7 @@
 use std::{borrow::Cow, collections::hash_map::Entry};
 
 use anyhow::bail;
+use ruff_db::system::{SystemPath, SystemPathBuf};
 use rustc_hash::FxHashMap;
 
 use ruff_index::{newtype_index, IndexVec};
@@ -232,12 +233,19 @@ impl EmbeddedFilePath&lt;'_&gt; {
     }
 
     fn is_allowed_explicit_path(path: &amp;str) -&gt; bool {
-        [
-            EmbeddedFilePath::AutogeneratedPy,
-            EmbeddedFilePath::AutogeneratedPyi,
-        ]
-        .iter()
-        .all(|autogenerated| path != autogenerated.as_str())
+        path != &amp;EmbeddedFilePath::AutogeneratedPy &amp;&amp; path != &amp;EmbeddedFilePath::AutogeneratedPyi
+    }
+}
+
+impl PartialEq&lt;str&gt; for EmbeddedFilePath&lt;'_&gt; {
+    fn eq(&amp;self, other: &amp;str) -&gt; bool {
+        self.as_str() == other
+    }
+}
+
+impl PartialEq&lt;EmbeddedFilePath&lt;'_&gt;&gt; for str {
+    fn eq(&amp;self, other: &amp;EmbeddedFilePath&lt;'_&gt;) -&gt; bool {
+        self == other.as_str()
     }
 }
 
@@ -286,8 +294,13 @@ impl EmbeddedFile&lt;'_&gt; {
         }
     }
 
-    pub(crate) fn path_str(&amp;self) -&gt; &amp;str {
-        self.path.as_str()
+    pub(crate) fn full_path(&amp;self, project_root: &amp;SystemPath) -&gt; SystemPathBuf {
+        let path = self.path.as_str();
+        if path.starts_with('/') {
+            SystemPathBuf::from(path)
+        } else {
+            project_root.join(path)
+        }
     }
 
     pub(crate) fn code_block_dimensions(&amp;self) -&gt; impl Iterator&lt;Item = CodeBlockDimensions&gt; + '_ {
@@ -820,11 +833,11 @@ mod tests {
             panic!(&quot;expected two files&quot;);
         };
 
-        assert_eq!(file_1.path_str(), &quot;mod_a.pyi&quot;);
+        assert_eq!(&amp;file_1.path, &quot;mod_a.pyi&quot;);
         assert_eq!(file_1.lang, &quot;pyi&quot;);
         assert_eq!(file_1.code(), &quot;a: int&quot;);
 
-        assert_eq!(file_2.path_str(), &quot;mod_b.pyi&quot;);
+        assert_eq!(&amp;file_2.path, &quot;mod_b.pyi&quot;);
         assert_eq!(file_2.lang, &quot;pyi&quot;);
         assert_eq!(file_2.code(), &quot;b: str&quot;);
     }
@@ -867,11 +880,11 @@ mod tests {
             panic!(&quot;expected two files&quot;);
         };
 
-        assert_eq!(main.path_str(), &quot;main.py&quot;);
+        assert_eq!(&amp;main.path, &quot;main.py&quot;);
         assert_eq!(main.lang, &quot;py&quot;);
         assert_eq!(main.code(), &quot;from foo import y&quot;);
 
-        assert_eq!(foo.path_str(), &quot;foo.py&quot;);
+        assert_eq!(&amp;foo.path, &quot;foo.py&quot;);
         assert_eq!(foo.lang, &quot;py&quot;);
         assert_eq!(foo.code(), &quot;y = 2&quot;);
 
@@ -1044,7 +1057,7 @@ mod tests {
             panic!(&quot;expected one file&quot;);
         };
 
-        assert_eq!(file.path_str(), &quot;foo.py&quot;);
+        assert_eq!(&amp;file.path, &quot;foo.py&quot;);
         assert_eq!(file.lang, &quot;py&quot;);
         assert_eq!(file.code(), &quot;x = 1&quot;);
     }
@@ -1164,7 +1177,7 @@ mod tests {
             panic!(&quot;expected one file&quot;);
         };
 
-        assert_eq!(file.path_str(), &quot;lorem&quot;);
+        assert_eq!(&amp;file.path, &quot;lorem&quot;);
         assert_eq!(file.code(), &quot;x = 1&quot;);
     }
 
@@ -1189,7 +1202,7 @@ mod tests {
             panic!(&quot;expected one file&quot;);
         };
 
-        assert_eq!(file.path_str(), &quot;lorem.yaml&quot;);
+        assert_eq!(&amp;file.path, &quot;lorem.yaml&quot;);
         assert_eq!(file.code(), &quot;x = 1&quot;);
     }
 
@@ -1405,7 +1418,7 @@ mod tests {
             panic!(&quot;expected one file&quot;);
         };
 
-        assert_eq!(file.path_str(), &quot;foo.py&quot;);
+        assert_eq!(&amp;file.path, &quot;foo.py&quot;);
         assert_eq!(file.code(), &quot;x = 1&quot;);
     }
 
@@ -1430,7 +1443,7 @@ mod tests {
             panic!(&quot;expected one file&quot;);
         };
 
-        assert_eq!(file.path_str(), &quot;foo.py&quot;);
+        assert_eq!(&amp;file.path, &quot;foo.py&quot;);
         assert_eq!(file.code(), &quot;x = 1&quot;);
     }
 
@@ -1454,7 +1467,7 @@ mod tests {
             panic!(&quot;expected one file&quot;);
         };
 
-        assert_eq!(file.path_str(), &quot;foo.py&quot;);
+        assert_eq!(&amp;file.path, &quot;foo.py&quot;);
         assert_eq!(file.code(), &quot;x = 1&quot;);
     }
 
@@ -1479,7 +1492,7 @@ mod tests {
             panic!(&quot;expected one file&quot;);
         };
 
-        assert_eq!(file.path_str(), &quot;foo bar.py&quot;);
+        assert_eq!(&amp;file.path, &quot;foo bar.py&quot;);
         assert_eq!(file.code(), &quot;x = 1&quot;);
     }
</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/src/parser.rs</code>:154 on 2025-02-05 12:16</div>
            <div class="timeline-body"><p>Questions I'm wondering while reading through this diff for the first time:</p>
<ol>
<li>I assume <code>CodeBlock</code> is meant to be an abstraction for a code block. In which case, why can't the dimensions of the code block be queried on a <code>CodeBlock</code> instance? I'm surprised there isn't a <code>dimensions: CodeBlockDimensions</code> field</li>
<li>Why is there a <code>backtick_offset</code> field on both <code>CodeBlock</code> and <code>CodeBlockDimensions</code>?</li>
</ol>
<p>Some more docs on how these structs interrelate might be really helpful</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/src/parser.rs</code>:201 on 2025-02-05 12:16</div>
            <div class="timeline-body"><pre><code class="language-suggestion">        dimensions: impl IntoIterator&lt;Item = CodeBlockDimensions&gt;,
    ) -&gt; CodeBlockStructure {
        CodeBlockStructure {
            start_line_and_line_count: dimensions
                .into_iter()
                .map(|d| (md_index.line_index(d.backtick_offset).get(), d.line_count))
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-05 12:22</div>
            <div class="timeline-body"><p>Fantastic!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-02-05 16:42</div>
            <div class="timeline-body"><p>I looked at the impact on the test suite and the README, and it looks fantastic to me, thank you!!</p>
<p>Didn't look at the code, since Alex and Micha already did, and it will likely change once conflicts with the diagnostic snapshotting PR are resolved anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/src/parser.rs</code>:217 on 2025-02-05 20:08</div>
            <div class="timeline-body"><p>This requires pulling in <code>ruff_python_ast</code> and handling the existence of <code>Ipynb</code>. I made the change in eaf4d41f64ab400b5058fe9b347f174e09476629. Not sure which version I prefer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-05 20:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-05 20:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/src/lib.rs</code>:117 on 2025-02-05 20:09</div>
            <div class="timeline-body"><blockquote>
<ol>
<li>Adding a <code>full_path()</code> method to <code>EmbeddedFile</code></li>
</ol>
</blockquote>
<p>:+1:</p>
<blockquote>
<p>2. Implementing <code>PartialEq&lt;str&gt;</code> for <code>EmbeddedFilePath</code></p>
</blockquote>
<p>I did not do that. After merging in the snapshot test changes, we now need to externally access the relative path as well. I renamed <code>path_str</code> to <code>relative_path</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-05 20:10</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/src/parser.rs</code>:154 on 2025-02-05 20:10</div>
            <div class="timeline-body"><p>I removed all the overhead that was needed to make this work lazily. I hope the new structure is more clear.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-05 21:21</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-02-05 21:25</div>
            <div class="timeline-body"><p>The failure on Windows is unrelated, see https://github.com/astral-sh/ruff/pull/15981. The tests were previously passing on Windows, and I didn't change anything path-specific or similar :crossed_fingers:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-02-05 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-02-05 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-05 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:129 on 2025-02-05 21:52</div>
            <div class="timeline-body"><p>was this meant to be</p>
<pre><code class="language-suggestion">## Literate style
</code></pre>
<p>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/README.md</code>:136 on 2025-02-05 21:52</div>
            <div class="timeline-body"><pre><code class="language-suggestion"># My literate test
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_test/src/parser.rs</code>:285 on 2025-02-05 21:58</div>
            <div class="timeline-body"><p>nit</p>
<pre><code class="language-suggestion">        let existing_code = self.code.to_mut();
        existing_code.push('\n');
        existing_code.push_str(new_code);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-05 22:00</div>
            <div class="timeline-body"><p>Thank you! The final version is much easier to understand</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-02-05 22:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/README.md</code>:129 on 2025-02-05 22:12</div>
            <div class="timeline-body"><p>Yes. Thanks. I'll fix that. Too much Python typing over the last months :-)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:57:52 UTC
    </footer>
</body>
</html>
