<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Reduce number of inline stored definitions per place - astral-sh/ruff #19409</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Reduce number of inline stored definitions per place</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19409">#19409</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-07-17 18:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-17 18:57</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>The <code>UseDefMap</code> are the main driver of ty's memory usage. This PR reduces the size of the <code>use_def_maps</code> on a large project by 1.5GB (~10%).</p>
<p>This is accomplished by updating how many items we store in the <code>SmallVec</code>'s stored in the <code>PlaceTable</code>.</p>
<ul>
<li><code>LiveBinding</code>: Has a size of 12 bytes</li>
<li><code>LiveDeclaration</code>: Has a size of 8 bytes</li>
</ul>
<p>Ideally we'd pick numbers that ensure that the <code>SmallVec</code> isn't larger than a regular <code>Vec</code>. However, that would mean that we can only store 2 live declarations and only one live binding inline. I picked:</p>
<ul>
<li><code>LiveBinding</code>: 2, that means each SmallVec has a size of 32 bytes, leaving 7 bytes unused. I considered going down to 1, so that the <code>SmallVec</code> has the same size as a <code>Vec</code> but that only reduces <code>Bindings</code> from 40 bytes to 32 bytes (saving only 8 bytes).</li>
<li><code>LiveDeclaration</code>: 2, that means each SmallVec has a size of 24 bytes, the same as a <code>Vec</code>. This leaves 7 bytes unuused</li>
</ul>
<p>Not only does this improve memory usage but it also shows that this change improves performance by a few percent.</p>
<p>The remaining main driver of the <code>UseDefMap</code> size is <code>reachability_constraints</code> (about 30%). Reducing <code>Bindings</code> further would also still be valuable because we create a lot of them.</p>
<h2>How did you find this?</h2>
<p>I used the following patch. Be aware, this is hacky and it seems to double count each value but it still gives the right proportional numbers. But this wouldn't have been possible without @ibraheemdev's work on adding the <code>heap_size</code> feature to salsa</p>
<details>
	<summary>Patch</summary>

<pre><code class="language-patch">Subject: [PATCH] Reduce inline size of live declarations
---
Index: crates/ty_python_semantic/src/semantic_index/use_def.rs
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&lt;+&gt;UTF-8
===================================================================
diff --git a/crates/ty_python_semantic/src/semantic_index/use_def.rs b/crates/ty_python_semantic/src/semantic_index/use_def.rs
--- a/crates/ty_python_semantic/src/semantic_index/use_def.rs	(revision b8d2037373ee1aafe0574e4a6d202c609a7de6ad)
+++ b/crates/ty_python_semantic/src/semantic_index/use_def.rs	(date 1752778903756)
@@ -270,7 +270,7 @@
 mod place_state;
 
 /// Applicable definitions and constraints for every use of a name.
-#[derive(Debug, PartialEq, Eq, salsa::Update, get_size2::GetSize)]
+#[derive(Debug, PartialEq, Eq, salsa::Update)]
 pub(crate) struct UseDefMap&lt;'db&gt; {
     /// Array of [`Definition`] in this scope. Only the first entry should be [`DefinitionState::Undefined`];
     /// this represents the implicit &quot;unbound&quot;/&quot;undeclared&quot; definition of every place.
@@ -341,6 +341,50 @@
     end_of_scope_reachability: ScopedReachabilityConstraintId,
 }
 
+pub(crate) fn use_def_map_size(map: &amp;UseDefMap&lt;'_&gt;) -&gt; usize {
+    use ruff_db::increment_memory_usage;
+
+    let all_definitions = ::get_size2::GetSize::get_heap_size(&amp;map.all_definitions);
+    increment_memory_usage(&quot;all_definitions&quot;, all_definitions);
+    let predicates = ::get_size2::GetSize::get_heap_size(&amp;map.predicates);
+    increment_memory_usage(&quot;predicates&quot;, predicates);
+    let narrowing_constraints = ::get_size2::GetSize::get_heap_size(&amp;map.narrowing_constraints);
+    increment_memory_usage(&quot;narrowing_constraints&quot;, narrowing_constraints);
+    let reachability_constraints =
+        ::get_size2::GetSize::get_heap_size(&amp;map.reachability_constraints);
+    increment_memory_usage(&quot;reachability_constraints&quot;, reachability_constraints);
+    let bindings_by_use = ::get_size2::GetSize::get_heap_size(&amp;map.bindings_by_use);
+    increment_memory_usage(&quot;bindings_by_use&quot;, bindings_by_use);
+    let node_reachability = ::get_size2::GetSize::get_heap_size(&amp;map.node_reachability);
+    increment_memory_usage(&quot;node_reachability&quot;, node_reachability);
+    let declarations_by_binding = ::get_size2::GetSize::get_heap_size(&amp;map.declarations_by_binding);
+    increment_memory_usage(&quot;declarations_by_binding&quot;, declarations_by_binding);
+    let bindings_by_definition = ::get_size2::GetSize::get_heap_size(&amp;map.bindings_by_definition);
+    increment_memory_usage(&quot;bindings_by_definition&quot;, bindings_by_definition);
+    let end_of_scope_places = ::get_size2::GetSize::get_heap_size(&amp;map.end_of_scope_places);
+    increment_memory_usage(&quot;end_of_scope_places&quot;, end_of_scope_places);
+    let reachable_definitions = ::get_size2::GetSize::get_heap_size(&amp;map.reachable_definitions);
+    increment_memory_usage(&quot;reachable_definitions&quot;, reachable_definitions);
+    let eager_snapshots = ::get_size2::GetSize::get_heap_size(&amp;map.eager_snapshots);
+    increment_memory_usage(&quot;eager_snapshots&quot;, eager_snapshots);
+    let end_of_scope_reachability =
+        ::get_size2::GetSize::get_heap_size(&amp;map.end_of_scope_reachability);
+    increment_memory_usage(&quot;end_of_scope_reachability&quot;, end_of_scope_reachability);
+
+    0 + all_definitions
+        + predicates
+        + narrowing_constraints
+        + reachability_constraints
+        + bindings_by_use
+        + node_reachability
+        + declarations_by_binding
+        + bindings_by_definition
+        + end_of_scope_places
+        + reachable_definitions
+        + eager_snapshots
+        + end_of_scope_reachability
+}
+
 pub(crate) enum ApplicableConstraints&lt;'map, 'db&gt; {
     UnboundBinding(ConstraintsIterator&lt;'map, 'db&gt;),
     ConstrainedBindings(BindingWithConstraintsIterator&lt;'map, 'db&gt;),
Index: crates/ty_python_semantic/src/semantic_index.rs
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&lt;+&gt;UTF-8
===================================================================
diff --git a/crates/ty_python_semantic/src/semantic_index.rs b/crates/ty_python_semantic/src/semantic_index.rs
--- a/crates/ty_python_semantic/src/semantic_index.rs	(revision b8d2037373ee1aafe0574e4a6d202c609a7de6ad)
+++ b/crates/ty_python_semantic/src/semantic_index.rs	(date 1752778603598)
@@ -5,12 +5,6 @@
 use ruff_db::parsed::parsed_module;
 use ruff_index::{IndexSlice, IndexVec};
 
-use ruff_python_ast::NodeIndex;
-use ruff_python_parser::semantic_errors::SemanticSyntaxError;
-use rustc_hash::{FxHashMap, FxHashSet};
-use salsa::Update;
-use salsa::plumbing::AsId;
-
 use crate::Db;
 use crate::module_name::ModuleName;
 use crate::node_key::NodeKey;
@@ -26,7 +20,12 @@
 };
 use crate::semantic_index::use_def::{EagerSnapshotKey, ScopedEagerSnapshotId, UseDefMap};
 use crate::semantic_model::HasTrackedScope;
-use crate::util::get_size::untracked_arc_size;
+use ruff_db::increment_memory_usage;
+use ruff_python_ast::NodeIndex;
+use ruff_python_parser::semantic_errors::SemanticSyntaxError;
+use rustc_hash::{FxHashMap, FxHashSet};
+use salsa::Update;
+use salsa::plumbing::AsId;
 
 pub mod ast_ids;
 mod builder;
@@ -49,7 +48,7 @@
 /// Returns the semantic index for `file`.
 ///
 /// Prefer using [`symbol_table`] when working with symbols from a single scope.
-#[salsa::tracked(returns(ref), no_eq, heap_size=get_size2::GetSize::get_heap_size)]
+#[salsa::tracked(returns(ref), no_eq, heap_size=semantic_index_size)]
 pub(crate) fn semantic_index(db: &amp;dyn Db, file: File) -&gt; SemanticIndex&lt;'_&gt; {
     let _span = tracing::trace_span!(&quot;semantic_index&quot;, ?file).entered();
 
@@ -93,7 +92,7 @@
 /// Using [`use_def_map`] over [`semantic_index`] has the advantage that
 /// Salsa can avoid invalidating dependent queries if this scope's use-def map
 /// is unchanged.
-#[salsa::tracked(returns(deref), heap_size=get_size2::GetSize::get_heap_size)]
+#[salsa::tracked(returns(deref), heap_size=use_def_map_heap_size)]
 pub(crate) fn use_def_map&lt;'db&gt;(db: &amp;'db dyn Db, scope: ScopeId&lt;'db&gt;) -&gt; ArcUseDefMap&lt;'db&gt; {
     let file = scope.file(db);
     let _span = tracing::trace_span!(&quot;use_def_map&quot;, scope=?scope.as_id(), ?file).entered();
@@ -196,7 +195,7 @@
 }
 
 /// The place tables and use-def maps for all scopes in a file.
-#[derive(Debug, Update, get_size2::GetSize)]
+#[derive(Debug, Update)]
 pub(crate) struct SemanticIndex&lt;'db&gt; {
     /// List of all place tables in this file, indexed by scope.
     place_tables: IndexVec&lt;FileScopeId, Arc&lt;PlaceTable&gt;&gt;,
@@ -244,6 +243,60 @@
     generator_functions: FxHashSet&lt;FileScopeId&gt;,
 }
 
+pub(crate) fn semantic_index_size(index: &amp;SemanticIndex&lt;'_&gt;) -&gt; usize {
+    let place_tables = ::get_size2::GetSize::get_heap_size(&amp;index.place_tables);
+    increment_memory_usage(&quot;places_tables&quot;, place_tables);
+    let scopes = ::get_size2::GetSize::get_heap_size(&amp;index.scopes);
+    increment_memory_usage(&quot;scopes&quot;, scopes);
+    let scopes_by_expression = ::get_size2::GetSize::get_heap_size(&amp;index.scopes_by_expression);
+    increment_memory_usage(&quot;scopes_by_expression&quot;, scopes_by_expression);
+    let definitions_by_node = ::get_size2::GetSize::get_heap_size(&amp;index.definitions_by_node);
+    increment_memory_usage(&quot;definitions_by_node&quot;, definitions_by_node);
+    let expressions_by_node = ::get_size2::GetSize::get_heap_size(&amp;index.expressions_by_node);
+    increment_memory_usage(&quot;expressions_by_node&quot;, expressions_by_node);
+    let scopes_by_node = ::get_size2::GetSize::get_heap_size(&amp;index.scopes_by_node);
+    increment_memory_usage(&quot;scopes_by_node&quot;, scopes_by_node);
+    let scope_ids_by_scope = ::get_size2::GetSize::get_heap_size(&amp;index.scope_ids_by_scope);
+    increment_memory_usage(&quot;scope_ids_by_scope&quot;, scope_ids_by_scope);
+    let use_def_maps = ::get_size2::GetSize::get_heap_size(&amp;index.use_def_maps);
+    increment_memory_usage(&quot;use_def_maps&quot;, use_def_maps);
+    let ast_ids = ::get_size2::GetSize::get_heap_size(&amp;index.ast_ids);
+    increment_memory_usage(&quot;ast_ids&quot;, ast_ids);
+    let imported_modules = ::get_size2::GetSize::get_heap_size(&amp;index.imported_modules);
+    increment_memory_usage(&quot;imported_modules&quot;, imported_modules);
+    let has_future_annotations = ::get_size2::GetSize::get_heap_size(&amp;index.has_future_annotations);
+    increment_memory_usage(&quot;has_future_annotations&quot;, has_future_annotations);
+    let eager_snapshots = ::get_size2::GetSize::get_heap_size(&amp;index.eager_snapshots);
+    increment_memory_usage(&quot;eager_snapshots&quot;, eager_snapshots);
+    let semantic_syntax_errors = ::get_size2::GetSize::get_heap_size(&amp;index.semantic_syntax_errors);
+    increment_memory_usage(&quot;semantic_syntax_errors&quot;, semantic_syntax_errors);
+    let generator_functions = ::get_size2::GetSize::get_heap_size(&amp;index.generator_functions);
+    increment_memory_usage(&quot;generator_functions&quot;, generator_functions);
+
+    let total = 0
+        + place_tables
+        + scopes
+        + scopes_by_expression
+        + definitions_by_node
+        + expressions_by_node
+        + use_def_maps
+        + ast_ids
+        + scopes_by_node
+        + scope_ids_by_scope
+        + imported_modules
+        + has_future_annotations
+        + eager_snapshots
+        + semantic_syntax_errors
+        + generator_functions;
+
+    increment_memory_usage(&quot;semantic_index&quot;, total);
+    total
+}
+
+pub(crate) fn use_def_map_heap_size(map: &amp;ArcUseDefMap&lt;'_&gt;) -&gt; usize {
+    crate::semantic_index::use_def::use_def_map_size(&amp;map.inner)
+}
+
 impl&lt;'db&gt; SemanticIndex&lt;'db&gt; {
     /// Returns the place table for a specific scope.
     ///
@@ -521,9 +574,8 @@
     }
 }
 
-#[derive(Debug, PartialEq, Eq, Clone, salsa::Update, get_size2::GetSize)]
+#[derive(Debug, PartialEq, Eq, Clone, salsa::Update)]
 pub(crate) struct ArcUseDefMap&lt;'db&gt; {
-    #[get_size(size_fn = untracked_arc_size)]
     inner: Arc&lt;UseDefMap&lt;'db&gt;&gt;,
 }
 
@@ -543,6 +595,12 @@
     }
 }
 
+impl&lt;'db&gt; get_size2::GetSize for ArcUseDefMap&lt;'db&gt; {
+    fn get_heap_size(&amp;self) -&gt; usize {
+        crate::semantic_index::use_def::use_def_map_size(&amp;self.inner)
+    }
+}
+
 pub struct AncestorsIter&lt;'a&gt; {
     scopes: &amp;'a IndexSlice&lt;FileScopeId, Scope&gt;,
     next_id: Option&lt;FileScopeId&gt;,
Index: crates/ty/src/lib.rs
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&lt;+&gt;UTF-8
===================================================================
diff --git a/crates/ty/src/lib.rs b/crates/ty/src/lib.rs
--- a/crates/ty/src/lib.rs	(revision b8d2037373ee1aafe0574e4a6d202c609a7de6ad)
+++ b/crates/ty/src/lib.rs	(date 1752778603581)
@@ -22,8 +22,8 @@
 use crossbeam::channel as crossbeam_channel;
 use rayon::ThreadPoolBuilder;
 use ruff_db::diagnostic::{Diagnostic, DisplayDiagnosticConfig, Severity};
-use ruff_db::max_parallelism;
 use ruff_db::system::{OsSystem, SystemPath, SystemPathBuf};
+use ruff_db::{max_parallelism, take_memory_usage};
 use salsa::plumbing::ZalsaDatabase;
 use ty_project::metadata::options::ProjectOptionsOverrides;
 use ty_project::watch::ProjectWatcher;
@@ -155,7 +155,10 @@
     match std::env::var(EnvVars::TY_MEMORY_REPORT).as_deref() {
         Ok(&quot;short&quot;) =&gt; write!(stdout, &quot;{}&quot;, db.salsa_memory_dump().display_short())?,
         Ok(&quot;mypy_primer&quot;) =&gt; write!(stdout, &quot;{}&quot;, db.salsa_memory_dump().display_mypy_primer())?,
-        Ok(&quot;full&quot;) =&gt; write!(stdout, &quot;{}&quot;, db.salsa_memory_dump().display_full())?,
+        Ok(&quot;full&quot;) =&gt; {
+            write!(stdout, &quot;{}&quot;, db.salsa_memory_dump().display_full())?;
+            write!(stdout, &quot;{:#?}&quot;, take_memory_usage())?;
+        }
         _ =&gt; {}
     }
 
Index: crates/ruff_db/src/lib.rs
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
&lt;+&gt;UTF-8
===================================================================
diff --git a/crates/ruff_db/src/lib.rs b/crates/ruff_db/src/lib.rs
--- a/crates/ruff_db/src/lib.rs	(revision b8d2037373ee1aafe0574e4a6d202c609a7de6ad)
+++ b/crates/ruff_db/src/lib.rs	(date 1752778603574)
@@ -43,6 +43,25 @@
     VERSION.set(version)
 }
 
+thread_local! {
+    static MEMORY_USAGE_MAP: std::cell::RefCell&lt;FxDashMap&lt;String, usize&gt;&gt; = std::cell::RefCell::new(FxDashMap::default());
+}
+
+pub fn take_memory_usage() -&gt; FxDashMap&lt;String, usize&gt; {
+    MEMORY_USAGE_MAP.with(|map| {
+        let mut map = map.borrow_mut();
+        std::mem::take(&amp;mut *map)
+    })
+}
+
+pub fn increment_memory_usage(ty: &amp;str, amount: usize) {
+    MEMORY_USAGE_MAP.with(|map| {
+        let map = map.borrow_mut();
+        let mut entry = map.entry(ty.to_string()).or_default();
+        *entry += amount;
+    });
+}
+
 /// Most basic database that gives access to files, the host system, source code, and parsed AST.
 #[salsa::db]
 pub trait Db: salsa::Database {

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @MichaReiser on 2025-07-17 18:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-17 19:01</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ‚úÖ</p>
<details>
<summary>Memory usage changes were detected when running on open source projects</summary>

<pre><code class="language-diff">flake8 (https://github.com/pycqa/flake8)
- TOTAL MEMORY USAGE: ~76MB
+ TOTAL MEMORY USAGE: ~69MB
-     memo fields = ~63MB
+     memo fields = ~57MB

trio (https://github.com/python-trio/trio)
- TOTAL MEMORY USAGE: ~194MB
+ TOTAL MEMORY USAGE: ~176MB
-     memo fields = ~152MB
+     memo fields = ~138MB

sphinx (https://github.com/sphinx-doc/sphinx)
- TOTAL MEMORY USAGE: ~316MB
+ TOTAL MEMORY USAGE: ~301MB
-     memo fields = ~260MB
+     memo fields = ~236MB

prefect (https://github.com/PrefectHQ/prefect)
- TOTAL MEMORY USAGE: ~657MB
+ TOTAL MEMORY USAGE: ~626MB
-     memo fields = ~541MB
+     memo fields = ~490MB

</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2025-07-17 19:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2025-07-17 19:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2025-07-17 19:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MichaReiser on 2025-07-17 19:38</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @MichaReiser on 2025-07-17 19:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2025-07-17 20:35</div>
            <div class="timeline-body"><p>Is it worth checking whether <code>Vec</code> or <code>ThinVec</code> is even better?  I wonder whether the CPU savings of not having to allocate in the small cases is relevant.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-18 05:51</div>
            <div class="timeline-body"><blockquote>
<p>Is it worth checking whether Vec or ThinVec is even better? I wonder whether the CPU savings of not having to allocate in the small cases is relevant.</p>
</blockquote>
<p>I can try <code>ThinVec</code>. I don't expect <code>Vec</code> to help much because it is as large for <code>LiveDeclaration</code> and we simply end up with more padding for <code>LiveBindings</code>, which doesn't seem like a good trade off</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-07-18 07:05</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_INSTRUMENTATION_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/micha%2Fplace-table-inline-definitions?runnerMode=Instrumentation">CodSpeed Instrumentation Performance Report</a></h2>
<h3>Merging #19409 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>micha/place-table-inline-definitions</code> (80b8dcd) with <code>main</code> (e6e029a)</sub></p>
<h3>Summary</h3>
<p><code>‚úÖ 41</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-07-18 07:07</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_WALLTIME_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/micha%2Fplace-table-inline-definitions?runnerMode=WallTime">CodSpeed WallTime Performance Report</a></h2>
<h3>Merging #19409 will <strong>not alter performance</strong></h3>
<p><sub>Comparing <code>micha/place-table-inline-definitions</code> (80b8dcd) with <code>main</code> (e6e029a)</sub></p>
<h3>Summary</h3>
<p><code>‚úÖ 7</code> untouched benchmarks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-07-18 07:07</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>‚úÖ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>‚ÑπÔ∏è ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to parse examples/mcp/databricks_mcp_cookbook.ipynb:12:1:8: Simple statements must be separated by newlines or semicolons
</code></pre>
</p>
</details>

<h3>Formatter (preview)</h3>
<p>‚ÑπÔ∏è ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<details><summary><a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)</summary>
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to parse examples/mcp/databricks_mcp_cookbook.ipynb:12:1:8: Simple statements must be separated by newlines or semicolons
</code></pre>
</p>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-18 07:15</div>
            <div class="timeline-body"><p>Using <code>ThinVec</code> does reduce memory usage by another 500MB or so but it also regresses performance by 15% on most instrumented and 5% on the walltime benchmarks. I'm not sure this is the right trade off. For now, I suggest we keep using <code>SmallVec</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-07-18 14:49</div>
            <div class="timeline-body"><p>Can we enable the <code>union</code> feature in <code>smallvec</code>? I believe that reduces its memory usage by one word.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-18 16:24</div>
            <div class="timeline-body"><blockquote>
<p>Can we enable the <code>union</code> feature in <code>smallvec</code>? I believe that reduces its memory usage by one word.</p>
</blockquote>
<p>I enabled the feature (and some more that are compatible with our MSRV) but it doesn't make a difference in this case</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/semantic_index/use_def/place_state.rs</code>:77 on 2025-07-18 16:28</div>
            <div class="timeline-body"><p>Why remove this constant? It's used in two places, and it seems strictly better to have a documented constant rather than an arbitrary magic number in the code.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-07-18 16:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-07-18 16:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-07-18 16:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-07-18 16:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-07-18 16:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/semantic_index/use_def/place_state.rs</code>:77 on 2025-07-18 16:30</div>
            <div class="timeline-body"><p>Lol, you had to comment exactly when I click merge.</p>
<p>Because it doesn't necessarily make sense to use the same constant in both places. The number needs to be picked based on the size of <code>LiveBinding</code> and <code>LiveDeclaration</code>. Having a single constant suggests that using the same value for both would be in some form desirable, it isn't.</p>
<p>I also don't think the comment adds much. It just describes what small vec does.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-07-18 16:30</div>
            <div class="timeline-body"><blockquote>
<p>I enabled the feature (and some more that are compatible with our MSRV) but it doesn't make a difference in this case</p>
</blockquote>
<p>That's odd, <code>SmallVec&lt;[LiveBinding; 2]&gt;</code> should be the same size as <code>Vec</code> with the <code>union</code> feature.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-18 16:35</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>I enabled the feature (and some more that are compatible with our MSRV) but it doesn't make a difference in this case</p>
</blockquote>
<p>That's odd, <code>SmallVec&lt;[LiveBinding; 2]&gt;</code> should be the same size as <code>Vec</code> with the <code>union</code> feature.</p>
</blockquote>
<p>Maybe r-a's wrong? I didn't use static assert.</p>
<p>But isn't LiveBinding 12 bytes and two elements are 24. There's no space for the tag?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-07-18 16:38</div>
            <div class="timeline-body"><p>Looks like <code>SmallVec&lt;[(u32, u32, u32); 2]&gt;&gt;()</code> is 40 bytes without the union feature, and 32 bytes with it. Without the union feature it gets an extra tag that isn't used. Not sure why this didn't show up in the memory usage report (maybe the saving got rounded away?).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-18 16:46</div>
            <div class="timeline-body"><pre><code class="language-rust">static_assertions::assert_eq_size!(SmallVec&lt;[LiveBinding; 2]&gt;, [u8; 32]);
</code></pre>
<p>This assertion compiles fine for both union and non union feature enabled. I don't know why :). I even tried enabling the <code>union</code> feature at the crate level</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-07-18 16:48</div>
            <div class="timeline-body"><p>Actually, I'm not able to reproduce your 3 <code>u32</code> example. Both of those compile fine with and without the <code>union</code> feature:</p>
<pre><code>static_assertions::assert_eq_size!(SmallVec&lt;[LiveBinding; 2]&gt;, [u8; 32]);
static_assertions::assert_eq_size!(SmallVec&lt;[(u32, u32, u32); 2]&gt;, [u8; 32]);
</code></pre>
<p>but this is a case where the union feature makes a difference</p>
<pre><code class="language-rust">static_assertions::assert_eq_size!(SmallVec&lt;[(u32, u32, u16); 2]&gt;, [u8; 32]);
</code></pre>
<blockquote>
<p>This means that there is potentially no space overhead compared to Vec. Note that smallvec can still be larger than Vec if the inline buffer is larger than two machine words.</p>
</blockquote>
<p>Which matches this description. 6 u32 are larger than 2 usize.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-07-18 16:55</div>
            <div class="timeline-body"><p>Aha, it looks like the <code>union</code> feature was already enabled transitively through our <code>version-ranges</code> dependency. In my sandbox your assertion fails without the <code>union</code> feature.</p>
<blockquote>
<p>but this is a case where the union feature makes a difference</p>
</blockquote>
<p>But this doesn't make sense anymore üôÉ</p>
<blockquote>
<p>This means that there is potentially no space overhead compared to Vec. Note that smallvec can still be larger than Vec if the inline buffer is larger than two machine words.</p>
</blockquote>
<p>Without the <code>union</code> feature, <a href="https://docs.rs/smallvec/latest/src/smallvec/lib.rs.html#674"><code>smallvec::SmallVecData</code></a> unconditionally gets an enum tag added by the compiler that is unnecessary, because the <code>capacity</code> field is already a discriminator.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 17:58:39 UTC
    </footer>
</body>
</html>
