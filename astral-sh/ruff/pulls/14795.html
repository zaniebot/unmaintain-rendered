<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migrate some inference tests to mdtests - astral-sh/ruff #14795</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Migrate some inference tests to mdtests</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14795">#14795</a>
        opened by <a href="https://github.com/dcreager">@dcreager</a>
        on 2024-12-05 19:50
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a></div>
            <div class="timeline-body"><p>As part of #13696, this PR ports a smallish number of inference tests over to the mdtest framework.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @dcreager on 2024-12-05 19:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @dcreager on 2024-12-05 19:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dcreager on 2024-12-05 19:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @dcreager on 2024-12-05 19:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @dcreager on 2024-12-05 19:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @AlexWaygood on 2024-12-05 19:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-12-05 19:57</div>
            <div class="timeline-body"><p>You may need to run <code>uvx pre-commit run --all-files</code> locally to placate our linters :-)</p>
<p>(Requires you to have <code>uv</code> installed locally, but nothing else)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-12-05 19:58</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-12-05 20:12</div>
            <div class="timeline-body"><p>Oh, and mdtests that contain invalid syntax need to be in files with <code>invalid_suntax</code> in their filenames, to exclude them from linters that only cope with valid Python syntax</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/assignment/nonlocal.md</code>:10 on 2024-12-05 20:37</div>
            <div class="timeline-body"><p>This pattern of &quot;assign x to y, then check the type of y&quot; was really an artifact of some limitations of the prior testing setup, here we can just elide it (and similar in below cases in this file):</p>
<pre><code class="language-suggestion">        reveal_type(x)  # revealed: Literal[1]
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/assignment/unbound.md</code>:71 on 2024-12-05 21:33</div>
            <div class="timeline-body"><p>The first and third lines here probably could be collapsed into a single <code>reveal_type(x)</code> at the top of the function body, with two diagnostics on that one line (the unresolved-reference error and the revealed Unknown type.) But in this case I think it's clearer to keep them separate.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/assignment/nonlocal.md</code>:1 on 2024-12-05 21:35</div>
            <div class="timeline-body"><p>I would put this file in <code>scopes/nonlocal.md</code> rather than <code>assignment/nonlocal.md</code>. These tests are about the semantics of nonlocal name lookups, the assignments are incidental (and, as I mention below, could just be removed.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2024-12-05 22:13</div>
            <div class="timeline-body"><blockquote>
<p>You may need to run <code>uvx pre-commit --all-files</code> locally to placate our linters</p>
<p>Oh, and mdtests that contain invalid syntax need to be in files with <code>invalid_suntax</code> in their filenames, to exclude them from linters that only cope with valid Python syntax</p>
</blockquote>
<p>Thanks!  Both fixed</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/assignment/unbound.md</code>:62 on 2024-12-05 22:16</div>
            <div class="timeline-body"><p>This test also feels more suitable to the <code>scopes/</code> directory than the <code>assignment/</code> directory. But it looks like that's also true of the previous two existing tests. I'd probably move them all to <code>scopes/unbound.md</code>, but it's also fine if we don't do that in this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/errors.md</code>:59 on 2024-12-05 22:18</div>
            <div class="timeline-body"><p>As @AlexWaygood mentioned, we'll probably need to put this in its own file with <code>invalid_syntax</code> in the name, e.g. <code>import/invalid_syntax.md</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-12-05 22:19</div>
            <div class="timeline-body"><p>Looks great, thank you! Feel free to go ahead and merge without another review after addressing comments/lints.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-05 22:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/errors.md</code>:63 on 2024-12-05 22:23</div>
            <div class="timeline-body"><p>Style micro-nit: we generally use <code>...</code> rather than <code>pass</code> in empty class bodies in mdtests, because blacken-docs (an autoformatter we run on our mdtests in CI via pre-commit) formats the classes more concisely if you do that</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/resources/mdtest/import/errors.md</code>:63 on 2024-12-05 22:29</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/resources/mdtest/assignment/nonlocal.md</code>:1 on 2024-12-05 22:32</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/resources/mdtest/assignment/nonlocal.md</code>:10 on 2024-12-05 22:32</div>
            <div class="timeline-body"><p>Done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/resources/mdtest/assignment/unbound.md</code>:62 on 2024-12-05 22:34</div>
            <div class="timeline-body"><p>Done, moved the previous two tests into <code>scopes/unbound.md</code> as well.  (To clarify, that means I left the first test here, which does seem to concern the semantics of <em>assigning</em> a currently unbound value)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/red_knot_python_semantic/resources/mdtest/assignment/unbound.md</code>:71 on 2024-12-05 22:38</div>
            <div class="timeline-body"><p>I went ahead and collapsed them — I think that produces a nice symmetry where there are different results for the same expression before and after the assignment:</p>
<pre><code class="language-python">    # error: [unresolved-reference]
    # revealed: Unknown
    reveal_type(x)
    x = 2
    # revealed: Literal[2]
    reveal_type(x)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2024-12-05 22:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-05 22:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/scopes/nonlocal.md</code>:40 on 2024-12-05 22:43</div>
            <div class="timeline-body"><p>Should this be a TODO?</p>
<pre><code class="language-suggestion">        # TODO: it's pretty weird to have an annotated assignment in a function where the
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-12-05 22:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/resources/mdtest/scopes/nonlocal.md</code>:40 on 2024-12-05 22:45</div>
            <div class="timeline-body"><p>FWIW, I intentionally didn't make it a TODO when I added it in the old test. It's in a gray area, but to me we should reserve TODO for things we definitely need to change, or at least revisit. I don't feel like it's clear that we need to change or revisit anything here. It's more like a musing that may be relevant to someone in the future considering this case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-12-05 23:23</div>
            <div class="timeline-body"><p>Thank you!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-12-06 10:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/literal/ellipsis.md</code>:7 on 2024-12-06 10:18</div>
            <div class="timeline-body"><p>The TODO here got lost, but it's fine; I'll address this in the statically-known branches PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2024-12-06 10:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2024-12-06 10:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-12-06 10:19</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-12-06 10:20</div>
            <div class="timeline-body"><p>Thanks! I hope it's fine I merged this. I can use it to write the <code>Ellipsis</code>-test in a nicer way in my PR: https://github.com/astral-sh/ruff/blob/5e1fdd3eecededdae22202dc98646d201d9e9303/crates/red_knot_python_semantic/resources/mdtest/literal/ellipsis.md</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dcreager">@dcreager</a> on 2024-12-06 14:41</div>
            <div class="timeline-body"><blockquote>
<p>Thanks! I hope it's fine I merged this.</p>
</blockquote>
<p>:+1: Not a problem, thanks for merging!</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:08:16 UTC
    </footer>
</body>
</html>
