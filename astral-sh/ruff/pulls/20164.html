<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty]eliminate definitely-impossible types from union in equality narrowing - astral-sh/ruff #20164</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty]eliminate definitely-impossible types from union in equality narrowing</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20164">#20164</a>
        opened by <a href="https://github.com/Renkai">@Renkai</a>
        on 2025-08-30 02:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Renkai">@Renkai</a></div>
            <div class="timeline-body"><p>solves <a href="https://github.com/astral-sh/ty/issues/939">astral-sh/ty#939</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Renkai">@Renkai</a> on 2025-08-30 02:55</div>
            <div class="timeline-body"><p>I want to see more logs to decide where to start, but it seems</p>
<pre><code> TY_LOG=trace cargo test -vvv -p ty_python_semantic -- mdtest__narrow_conditionals_in  --nocapture
</code></pre>
<p>doesn&#x27;t show more logs than</p>
<pre><code>cargo test -p ty_python_semantic -- mdtest__narrow_conditionals_in
</code></pre>
<p>Any thing wrong with my parameters?  @AlexWaygood It could be great if you can provide more tricks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Renkai">@Renkai</a> on 2025-08-30 07:58</div>
            <div class="timeline-body"><pre><code>cargo run --bin ty -- check --project ~/renkai-lab/playty -vv
</code></pre>
<p>can have some logs, can we also make them available for <code>cargo test</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-01 03:28</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-01 03:31</div>
            <div class="timeline-body">

<code>mypy_primer</code> results

Changes were detected when running on open source projects

<pre><code>beartype (https://github.com/beartype/beartype)
- beartype/_check/error/_pep/pep484585/errpep484585container.py:62:9: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[HintSign, range].__getitem__(key: HintSign, /) -&gt; range` cannot be called with key of type `HintSign | None` on object of type `dict[HintSign, range]`
- beartype/_check/error/_pep/pep484585/errpep484585mapping.py:56:9: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[HintSign, range].__getitem__(key: HintSign, /) -&gt; range` cannot be called with key of type `HintSign | None` on object of type `dict[HintSign, range]`
- Found 590 diagnostics
+ Found 588 diagnostics

kornia (https://github.com/kornia/kornia)
- kornia/contrib/models/efficient_vit/nn/act.py:43:19: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[str, @Todo(unsupported type[X] special form)].__getitem__(key: str, /) -&gt; @Todo(unsupported type[X] special form)` cannot be called with key of type `str | None` on object of type `dict[str, @Todo(unsupported type[X] special form)]`
- Found 809 diagnostics
+ Found 808 diagnostics

werkzeug (https://github.com/pallets/werkzeug)
- src/werkzeug/http.py:391:40: error[invalid-argument-type] Argument to function `unquote` is incorrect: Expected `str`, found `None | Unknown | str`
- src/werkzeug/http.py:553:34: error[invalid-argument-type] Argument to function `unquote` is incorrect: Expected `str`, found `(Unknown &amp; ~AlwaysFalsy) | (str &amp; ~AlwaysFalsy) | None`
- Found 369 diagnostics
+ Found 367 diagnostics

discord.py (https://github.com/Rapptz/discord.py)
- discord/appinfo.py:458:16: error[unsupported-operator] Operator `not in` is not supported for types `str` and `None`, in comparing `Literal[&quot;bot&quot;]` with `list[str] | None | Any | list[@Todo(list literal element type)]`
- discord/appinfo.py:464:55: warning[possibly-unbound-attribute] Attribute `value` on type `Permissions | None | Any` is possibly unbound
- discord/appinfo.py:478:16: error[unsupported-operator] Operator `not in` is not supported for types `str` and `None`, in comparing `Literal[&quot;bot&quot;]` with `list[str] | None | Any | list[@Todo(list literal element type)]`
- discord/appinfo.py:484:54: warning[possibly-unbound-attribute] Attribute `value` on type `Permissions | None | Any` is possibly unbound
- discord/guild.py:3418:37: warning[possibly-unbound-attribute] Attribute `id` on type `Snowflake | None | Any` is possibly unbound
+ discord/http.py:274:44: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- Found 531 diagnostics
+ Found 527 diagnostics

trio (https://github.com/python-trio/trio)
- src/trio/_highlevel_serve_listeners.py:52:25: error[invalid-argument-type] Method `__getitem__` of type `bound method Mapping[int, str].__getitem__(key: int, /) -&gt; str` cannot be called with key of type `int | None` on object of type `Mapping[int, str]`
- src/trio/_highlevel_serve_listeners.py:53:37: error[invalid-argument-type] Argument to function `strerror` is incorrect: Expected `int`, found `int | None`
- Found 683 diagnostics
+ Found 681 diagnostics

pydantic (https://github.com/pydantic/pydantic)
- pydantic/v1/types.py:704:12: error[unsupported-operator] Operator `&gt;=` is not supported for types `str` and `int`, in comparing `int | Literal[&quot;n&quot;, &quot;N&quot;, &quot;F&quot;]` with `Literal[0]`
- pydantic/v1/types.py:706:22: error[unsupported-operator] Operator `+` is unsupported between objects of type `int` and `int | Literal[&quot;n&quot;, &quot;N&quot;, &quot;F&quot;]`
- pydantic/v1/types.py:714:20: error[invalid-argument-type] Argument to function `abs` is incorrect: Expected `SupportsAbs[Unknown]`, found `int | Literal[&quot;n&quot;, &quot;N&quot;, &quot;F&quot;]`
- pydantic/v1/types.py:715:41: error[invalid-argument-type] Argument to function `abs` is incorrect: Expected `SupportsAbs[Unknown]`, found `int | Literal[&quot;n&quot;, &quot;N&quot;, &quot;F&quot;]`
- pydantic/v1/types.py:715:41: error[invalid-argument-type] Argument to function `abs` is incorrect: Expected `SupportsAbs[Unknown]`, found `int | Literal[&quot;n&quot;, &quot;N&quot;, &quot;F&quot;]`
- pydantic/v1/types.py:718:32: error[invalid-argument-type] Argument to function `abs` is incorrect: Expected `SupportsAbs[Unknown]`, found `int | Literal[&quot;n&quot;, &quot;N&quot;, &quot;F&quot;]`
- Found 768 diagnostics
+ Found 762 diagnostics

ignite (https://github.com/pytorch/ignite)
- tests/ignite/distributed/utils/__init__.py:154:10: error[unsupported-operator] Operator `in` is not supported for types `None` and `str`, in comparing `str | None` with `Literal[&quot;xla-tpu&quot;]`
+ tests/ignite/distributed/utils/__init__.py:154:10: error[unsupported-operator] Operator `in` is not supported for types `None` and `str`, in comparing `None | str` with `Literal[&quot;xla-tpu&quot;]`
- tests/ignite/distributed/utils/__init__.py:157:10: error[unsupported-operator] Operator `in` is not supported for types `None` and `str`, in comparing `str | None` with `Literal[&quot;horovod&quot;]`
+ tests/ignite/distributed/utils/__init__.py:157:10: error[unsupported-operator] Operator `in` is not supported for types `None` and `str`, in comparing `None | str` with `Literal[&quot;horovod&quot;]`
- tests/ignite/distributed/utils/__init__.py:258:10: error[unsupported-operator] Operator `in` is not supported for types `None` and `str`, in comparing `str | None` with `Literal[&quot;horovod&quot;]`
+ tests/ignite/distributed/utils/__init__.py:258:10: error[unsupported-operator] Operator `in` is not supported for types `None` and `str`, in comparing `None | str` with `Literal[&quot;horovod&quot;]`
- tests/ignite/distributed/utils/__init__.py:286:10: error[unsupported-operator] Operator `in` is not supported for types `None` and `str`, in comparing `str | None` with `Literal[&quot;xla-tpu&quot;]`
+ tests/ignite/distributed/utils/__init__.py:286:10: error[unsupported-operator] Operator `in` is not supported for types `None` and `str`, in comparing `None | str` with `Literal[&quot;xla-tpu&quot;]`

flake8-pyi (https://github.com/PyCQA/flake8-pyi)
- flake8_pyi/visitor.py:958:43: error[invalid-argument-type] Argument is incorrect: Expected `str`, found `str | None`
- Found 9 diagnostics
+ Found 8 diagnostics

apprise (https://github.com/caronc/apprise)
- apprise/config/base.py:1171:37: error[invalid-argument-type] Argument to function `_special_token_handler` is incorrect: Expected `str`, found `None | Unknown | str`
- apprise/config/base.py:1184:29: error[invalid-argument-type] Argument to function `_special_token_handler` is incorrect: Expected `str`, found `None | Unknown | str`
- Found 1800 diagnostics
+ Found 1798 diagnostics

cloud-init (https://github.com/canonical/cloud-init)
- cloudinit/sources/DataSourceVMware.py:995:17: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[str, dict[str, Interface]].__getitem__(key: str, /) -&gt; dict[str, Interface]` cannot be called with key of type `None | Unknown` on object of type `dict[str, dict[str, Interface]]`
- cloudinit/sources/DataSourceVMware.py:1003:17: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[str, dict[str, Interface]].__getitem__(key: str, /) -&gt; dict[str, Interface]` cannot be called with key of type `None | Unknown` on object of type `dict[str, dict[str, Interface]]`
- Found 632 diagnostics
+ Found 630 diagnostics

urllib3 (https://github.com/urllib3/urllib3)
- src/urllib3/util/ssl_.py:280:35: error[no-matching-overload] No overload of bound method `get` matches arguments
- src/urllib3/util/ssl_.py:283:35: error[no-matching-overload] No overload of bound method `get` matches arguments
- src/urllib3/util/ssl_.py:301:9: error[invalid-assignment] Object of type `int | (Unknown &amp; ~None)` is not assignable to attribute `minimum_version` of type `TLSVersion`
+ src/urllib3/util/ssl_.py:301:9: error[invalid-assignment] Object of type `int` is not assignable to attribute `minimum_version` of type `TLSVersion`
- src/urllib3/util/ssl_.py:306:9: error[invalid-assignment] Object of type `int | (Unknown &amp; ~None)` is not assignable to attribute `maximum_version` of type `TLSVersion`
+ src/urllib3/util/ssl_.py:306:9: error[invalid-assignment] Object of type `int` is not assignable to attribute `maximum_version` of type `TLSVersion`
- Found 392 diagnostics
+ Found 390 diagnostics

dragonchain (https://github.com/dragonchain/dragonchain)
- dragonchain/webserver/lib/dragonnet.py:82:120: error[invalid-argument-type] Argument to function `verification_storage_location` is incorrect: Expected `str`, found `str | Unknown | None`
- dragonchain/webserver/lib/dragonnet.py:89:79: error[invalid-argument-type] Argument to function `add_receipt` is incorrect: Expected `str`, found `str | Unknown | None`
- dragonchain/webserver/lib/dragonnet.py:93:124: error[invalid-argument-type] Argument to function `set_receieved_verification_for_block_from_chain_sync` is incorrect: Expected `str`, found `str | Unknown | None`
- Found 306 diagnostics
+ Found 303 diagnostics

pytest (https://github.com/pytest-dev/pytest)
- src/_pytest/config/__init__.py:498:25: warning[possibly-unbound-attribute] Attribute `replace` on type `str | None` is possibly unbound
- src/_pytest/pathlib.py:128:5: error[call-non-callable] Object of type `None` is not callable
- Found 471 diagnostics
+ Found 469 diagnostics

mitmproxy (https://github.com/mitmproxy/mitmproxy)
- mitmproxy/proxy/events.py:92:21: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[Command, type[CommandCompleted]].__getitem__(key: Command, /) -&gt; type[CommandCompleted]` cannot be called with key of type `Any | None` on object of type `dict[Command, type[CommandCompleted]]`
- Found 1825 diagnostics
+ Found 1824 diagnostics

bokeh (https://github.com/bokeh/bokeh)
- src/bokeh/plotting/_renderer.py:211:42: error[unsupported-operator] Operator `+` is unsupported between objects of type `str` and `str | None`
- src/bokeh/plotting/_renderer.py:212:34: error[unsupported-operator] Operator `+` is unsupported between objects of type `str` and `str | None`
- src/bokeh/plotting/_renderer.py:216:28: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[str, Any].__getitem__(key: str, /) -&gt; Any` cannot be called with key of type `str | None` on object of type `dict[str, Any]`
- Found 845 diagnostics
+ Found 842 diagnostics

openlibrary (https://github.com/internetarchive/openlibrary)
- openlibrary/plugins/upstream/addbook.py:383:16: warning[possibly-unbound-attribute] Attribute `startswith` on type `str | None` is possibly unbound
- Found 711 diagnostics
+ Found 710 diagnostics

prefect (https://github.com/PrefectHQ/prefect)
- src/prefect/context.py:944:36: error[invalid-argument-type] Method `__getitem__` of type `bound method ProfilesCollection.__getitem__(name: str) -&gt; Profile` cannot be called with key of type `Unknown | str | None` on object of type `ProfilesCollection`
+ src/prefect/flows.py:3093:28: warning[redundant-cast] Value is already of type `str`
+ src/prefect/flows.py:3106:28: warning[redundant-cast] Value is already of type `str`
- Found 3020 diagnostics
+ Found 3021 diagnostics

dd-trace-py (https://github.com/DataDog/dd-trace-py)
- ddtrace/contrib/internal/redis_utils.py:47:34: error[not-iterable] Object of type `list[Unknown] | dict[Unknown, Unknown] | str | None` may not be iterable
- ddtrace/contrib/internal/redis_utils.py:51:34: error[not-iterable] Object of type `list[Unknown] | dict[Unknown, Unknown] | str | None` may not be iterable
- ddtrace/contrib/internal/valkey_utils.py:56:34: error[not-iterable] Object of type `list[Unknown] | dict[Unknown, Unknown] | str | None` may not be iterable
- ddtrace/contrib/internal/valkey_utils.py:60:34: error[not-iterable] Object of type `list[Unknown] | dict[Unknown, Unknown] | str | None` may not be iterable
- Found 6611 diagnostics
+ Found 6607 diagnostics

rotki (https://github.com/rotki/rotki)
- rotkehlchen/api/v1/schemas.py:2585:41: warning[possibly-unbound-attribute] Attribute `name` on type `Location | None` is possibly unbound
- Found 1596 diagnostics
+ Found 1595 diagnostics

core (https://github.com/home-assistant/core)
- homeassistant/components/amberelectric/helpers.py:19:16: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[str, str].__getitem__(key: str, /) -&gt; str` cannot be called with key of type `Unknown | None` on object of type `dict[str, str]`
- homeassistant/components/hue/v1/device_trigger.py:140:23: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[str, dict[tuple[str, str], dict[str, int]]].__getitem__(key: str, /) -&gt; dict[tuple[str, str], dict[str, int]]` cannot be called with key of type `str | None` on object of type `dict[str, dict[tuple[str, str], dict[str, int]]]`
- homeassistant/components/hue/v1/device_trigger.py:191:29: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[str, dict[tuple[str, str], dict[str, int]]].__getitem__(key: str, /) -&gt; dict[tuple[str, str], dict[str, int]]` cannot be called with key of type `str | None` on object of type `dict[str, dict[tuple[str, str], dict[str, int]]]`
- homeassistant/components/mqtt/config_flow.py:822:46: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[str, set[type[StrEnum] | str | None]].__getitem__(key: str, /) -&gt; set[type[StrEnum] | str | None]` cannot be called with key of type `Any | None` on object of type `dict[str, set[type[StrEnum] | str | None]]`
- homeassistant/components/network/__init__.py:90:12: error[invalid-return-type] Return type does not match returned value: expected `str`, found `str | None | @Todo(Subscript expressions on intersections)`
- homeassistant/components/number/__init__.py:469:36: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[NumberDeviceClass, type[BaseUnitConverter]].__getitem__(key: NumberDeviceClass, /) -&gt; type[BaseUnitConverter]` cannot be called with key of type `NumberDeviceClass | None` on object of type `dict[NumberDeviceClass, type[BaseUnitConverter]]`
- homeassistant/components/opentherm_gw/climate.py:157:29: error[unsupported-operator] Operator `-` is unsupported between objects of type `Unknown | None` and `Literal[5]`
- homeassistant/components/opentherm_gw/climate.py:158:29: error[unsupported-operator] Operator `-` is unsupported between objects of type `Unknown | None` and `Literal[5]`
- homeassistant/components/screenlogic/coordinator.py:39:16: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[str, dict[str, Any]].__getitem__(key: str, /) -&gt; dict[str, Any]` cannot be called with key of type `str | None` on object of type `dict[str, dict[str, Any]]`
+ homeassistant/components/sonos/media.py:51:60: warning[unused-ignore-comment] Unused blanket `type: ignore` directive
- homeassistant/components/tibber/sensor.py:556:33: warning[possibly-unbound-attribute] Attribute `replace` on type `str | None` is possibly unbound
- Found 13344 diagnostics
+ Found 13335 diagnostics

pandas (https://github.com/pandas-dev/pandas)
- pandas/core/arrays/timedeltas.py:1116:49: error[invalid-argument-type] Argument to function `_ints_to_td64ns` is incorrect: Expected `str`, found `None | @Todo(Inference of subscript on special form)`
- Found 3380 diagnostics
+ Found 3379 diagnostics

sympy (https://github.com/sympy/sympy)
- sympy/core/expr.py:3304:36: error[unsupported-operator] Operator `**` is unsupported between objects of type `Unknown | None` and `Unknown | Literal[6]`
- sympy/core/expr.py:3317:37: error[unsupported-operator] Operator `/` is unsupported between objects of type `Literal[1]` and `Unknown | None`
- sympy/core/expr.py:3317:69: error[unsupported-operator] Operator `/` is unsupported between objects of type `Literal[1]` and `Unknown | None`
- sympy/core/exprtools.py:370:23: warning[possibly-unbound-attribute] Attribute `copy` on type `(Unknown &amp; ~Factors &amp; ~Literal[0] &amp; ~Expr) | None | (Basic &amp; ~Expr)` is possibly unbound
+ sympy/crypto/crypto.py:2257:12: warning[possibly-unbound-attribute] Attribute `join` on type `int | Unknown` is possibly unbound
- sympy/utilities/tests/test_lambdify.py:1176:12: error[invalid-argument-type] Method `__getitem__` of type `bound method dict[str, tuple[() -&gt; str | None] | tuple[int, int | float | None, list[str], str]].__getitem__(key: str, /) -&gt; tuple[() -&gt; str | None] | tuple[int, int | float | None, list[str], str]` cannot be called with key of type `str | None` on object of type `dict[str, tuple[() -&gt; str | None] | tuple[int, int | float | None, list[str], str]]`
- Found 13404 diagnostics
+ Found 13400 diagnostics

scipy (https://github.com/scipy/scipy)
- scipy/integrate/_ivp/ivp.py:623:14: error[call-non-callable] Object of type `Literal[&quot;RK45&quot;]` is not callable
- scipy/odr/_odrpack.py:1006:21: error[unsupported-operator] Operator `*` is unsupported between objects of type `@Todo(list literal element type) | None` and `Literal[10000]`
- scipy/odr/_odrpack.py:1006:38: error[unsupported-operator] Operator `*` is unsupported between objects of type `@Todo(list literal element type) | None` and `Literal[1000]`
- scipy/odr/_odrpack.py:1007:21: error[unsupported-operator] Operator `*` is unsupported between objects of type `@Todo(list literal element type) | None` and `Literal[100]`
- scipy/odr/_odrpack.py:1007:36: error[unsupported-operator] Operator `*` is unsupported between objects of type `@Todo(list literal element type) | None` and `Literal[10]`
- scipy/odr/_odrpack.py:1083:48: error[unsupported-operator] Operator `*` is unsupported between objects of type `@Todo(list literal element type) | None` and `Literal[10]`
- scipy/sparse/_compressed.py:507:16: error[unsupported-operator] Operator `%` is unsupported between objects of type `Unknown | None` and `Literal[2]`
- scipy/sparse/linalg/_norm.py:184:17: error[unsupported-operator] Operator `+` is unsupported between objects of type `(Unknown &amp; ~Literal[0] &amp; ~Literal[1]) | None` and `Literal[1]`
- scipy/sparse/linalg/_norm.py:187:57: error[unsupported-operator] Operator `/` is unsupported between objects of type `Literal[1]` and `(Unknown &amp; ~Literal[0] &amp; ~Literal[1]) | None`
- Found 6432 diagnostics
+ Found 6423 diagnostics

</code></pre>

No memory usage changes detected ✅

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/Renkai">@Renkai</a> on 2025-09-01 12:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/Renkai">@Renkai</a> on 2025-09-01 12:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/Renkai">@Renkai</a> on 2025-09-01 12:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/Renkai">@Renkai</a> on 2025-09-01 12:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/Renkai">@Renkai</a> on 2025-09-01 12:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[ty][WIP] eliminate definitely-impossible types from union in equality narrowing&quot; to &quot;[ty]eliminate definitely-impossible types from union in equality narrowing&quot; by <a href="https://github.com/Renkai">@Renkai</a> on 2025-09-01 23:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-09-02 22:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:650 on 2025-09-03 00:20</div>
            <div class="timeline-body"><p>It looks like we now have three copies of this identical logic -- can we extract a helper function instead?</p>
<p>Actually I wonder if we even need this logic anymore at all, now that our iteration support has improved (and already special cases string literals). It seems like this could all be replaced with something like <code>rhs_ty.try_iterate(db).ok()?.homogeneous_element_type(db)</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types.rs</code>:1064 on 2025-09-03 00:21</div>
            <div class="timeline-body"><p>We include <code>bool</code> and <code>LiteralString</code> here as types that make a type be a &quot;union with single valued&quot;, but where we actually use this method, we only really handle unions, and we don&#x27;t do any special handling for <code>bool</code> or <code>LiteralString</code>. So I don&#x27;t think there&#x27;s currently any benefit to including them here.</p>
<p>And probably enums should be considered as well as an effective &quot;union of single-valued types&quot; both here and above.</p>
<p>Maybe we could at least add some tests that have <code>bool</code>, <code>LiteralString</code> and enum types on the LHS -- I think that would illuminate cases that we&#x27;d want to handle. They could stay TODOs in this PR, if they aren&#x27;t easy to handle.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:626 on 2025-09-03 00:26</div>
            <div class="timeline-body"><p>I think that our handling of <code>==</code> narrowing is also missing this same logic, when the LHS isn&#x27;t all single-valued types, but does contain some single-valued types that could be eliminated.</p>
<p>Really, <code>==</code> and <code>in</code> narrowing are closely related: <code>==</code> is equivalent to <code>in</code> with just a single element on the RHS. Right now are implementations of them are totally separate. Is it possible that we could add support for this case to our <code>==</code> narrowing, and then re-implement our <code>in</code> narrowing in terms of repeated application of our <code>==</code> narrowing?</p>
<p>One last thought: rather than using all of <code>is_single_valued</code> and <code>is_union_of_single_valued</code> and now also <code>is_union_with_single_valued</code>, where the latter two each also have complicated semantics involving special handling of <code>bool</code> and <code>LiteralString</code> (and probably also <em>should</em> include enum types, but don&#x27;t), I think it might be clearer if we just eliminate those methods and use direct matches on <code>lhs_ty</code> here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> requested changes on 2025-09-03 00:42</div>
            <div class="timeline-body"><p>This looks great, thank you! I have a few comments: some that I think should definitely be addressed in this PR (avoiding tripled code that can be simplified, adding at least some tests for bool / LiteralString and enums) and some that could be addressed in this PR but could also be follow-ups (actually supporting bool/LiteralString/enum, the unification with <code>==</code> narrowing).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Renkai">@Renkai</a> reviewed on 2025-09-03 13:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Renkai">@Renkai</a> on <code>crates/ty_python_semantic/src/types/narrow.rs</code>:626 on 2025-09-03 13:31</div>
            <div class="timeline-body"><p>I tried use the in/not_in to replace the eq/not_eq, got many errors(11) include</p>
<pre><code>  crates/ty_python_semantic/resources/mdtest/scopes/global.md:84 unexpected error: [invalid-assignment] &quot;Object of type `int | None` is not assignable to `int`&quot;
  
    crates/ty_python_semantic/resources/mdtest/type_compendium/integer_literals.md:77 unmatched assertion: revealed: int &amp; ~Literal[54165]
  crates/ty_python_semantic/resources/mdtest/type_compendium/integer_literals.md:77 unexpected error: 21 [revealed-type] &quot;Revealed type: `int`&quot;

  crates/ty_python_semantic/resources/mdtest/narrow/while.md:57 unmatched assertion: revealed: Literal[3]
  crates/ty_python_semantic/resources/mdtest/narrow/while.md:57 unexpected error: 21 [revealed-type] &quot;Revealed type: `Literal[1, 2, 3]`&quot;

</code></pre>
<p>Maybe we shall create a new thread to discuss about how to combine in and eq, and the proposed behavior change of existing eq function.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Renkai">@Renkai</a> reviewed on 2025-09-03 13:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Renkai">@Renkai</a> on <code>crates/ty_python_semantic/src/types.rs</code>:1064 on 2025-09-03 13:53</div>
            <div class="timeline-body"><p>https://github.com/astral-sh/ruff/pull/20164/files#diff-4d769c34388fdd9011945264bed8fb2199b60ffefcbaa09d0804e4e6c347fd4dR134
added some TODOs in the in.md. If the tests looks good to you, I will take a look tomorrow to see if it&#x27;s doable for me in the near future.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-09-03 15:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/resources/mdtest/narrow/conditionals/in.md</code>:135 on 2025-09-03 15:07</div>
            <div class="timeline-body"><p>We don&#x27;t use HTML comments for TODOs, we are fine with TODOs showing up in the rendered output. In fact we use HTML comments for special markers like <code>&lt;!-- snapshot-diagnostics --&gt;</code>, and for that reason to avoid typos we make unknown HTML comments an error, which is why tests are failing on this PR.</p>
<p>I&#x27;ll fix this so you can see how we usually handle TODOs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-09-03 15:30</div>
            <div class="timeline-body"><p>Looks good, thank you! Pushed some updates and will go ahead and merge.</p>
<p>I think the highest priority follow-up would be to add enum support and address those TODOs. If you are interested, I think this would not be too hard. In principle it is just adding enums (along with <code>bool</code> and <code>LiteralString</code>) in <code>is_union_of_single_valued</code> and <code>is_union_with_single_valued</code>, and in the union logic in <code>evaluate_expr_in</code> and <code>evaluate_expr_not_in</code>. The one wrinkle is that we only consider enums single-valued if they don&#x27;t override <code>__eq__</code> or <code>__ne__</code>. This logic is currently buried inside the <code>EnumLiteral</code> branch of <code>Type::is_single_valued</code>; we would need to pull it out into a top-level <code>Type::overrides_eq_or_ne</code> method, since we would also need to call it from <code>is_union_of_single_valued</code> etc. (Should probably also add some tests showing we don&#x27;t do this narrowing for an enum class that does override <code>__eq__</code> or <code>__ne__</code>.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2025-09-03 15:34</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2025-09-03 15:34</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:18:11 UTC
    </footer>
</body>
</html>
