```yaml
number: 7013
title: "Make `SourceKind` a required parameter"
type: pull_request
state: merged
author: dhruvmanila
labels:
  - internal
assignees: []
merged: true
base: main
head: dhruv/source-kind-required
created_at: 2023-08-31T03:06:55Z
updated_at: 2023-09-13T09:46:06Z
url: https://github.com/astral-sh/ruff/pull/7013
synced_at: 2026-01-12T02:45:38Z
```

# Make `SourceKind` a required parameter

---

_Pull request opened by @dhruvmanila on 2023-08-31 03:06_

## Summary

This PR refactors the `check_path` function to make `SourceKind` a required parameter i.e., remove the `Option<...>`. The main blocker for this change was that `add_noqa` wasn't supported for Jupyter Notebooks but it's still fine to pass in the `SourceKind` without it. This is ok because the `PySourceType` is checked before and we don't proceed unless it's either a Python or stub file.

This is also required for the PEP 701 f-string parser changes because we want the source code to be available while parsing to extract the leading and trailing text for debug expressions. Here, `SourceKind` will provide that but it was an `Option<...>` before.

---

_Comment by @dhruvmanila on 2023-08-31 03:07_

Current dependencies on/for this PR:
* main
  * **PR #7035** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7035" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7013** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7013" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
      * **PR #6659** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6659" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #7041** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7041" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #7211** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7211" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
            * **PR #7263** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7263" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
              * **PR #7331** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7331" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
                * **PR #7325** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7325" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
                  * **PR #7326** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7326" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
                    * **PR #7327** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7327" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
                      * **PR #7328** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7328" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
                        * **PR #7329** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7329" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7013?utm_source=stack-comment).

---

_Review comment by @dhruvmanila on `crates/ruff/src/logging.rs`:175 on 2023-08-31 03:12_

This is the main change in this section of the diff otherwise it's just a formatter change.

---

_Review comment by @dhruvmanila on `crates/ruff/src/source_kind.rs`:21 on 2023-08-31 03:13_

Not required because of `is_macro::Is` usage on the enum.

---

_Review comment by @dhruvmanila on `crates/ruff_cli/src/commands/add_noqa.rs`:67 on 2023-08-31 03:14_

There are 2 types of errors: IO which can be easily converted to a anyhow error and `Diagnostics`. Should we instead return `Diagnostics` and send it to the `Printer`?

---

_@dhruvmanila reviewed on 2023-08-31 03:16_

---

_Review requested from @MichaReiser by @dhruvmanila on 2023-08-31 03:16_

---

_Comment by @github-actions[bot] on 2023-08-31 03:20_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---

_Review comment by @MichaReiser on `crates/ruff/src/linter.rs`:278 on 2023-08-31 06:05_

Nit: Remove the comment

---

_Review comment by @MichaReiser on `crates/ruff_cli/src/commands/add_noqa.rs`:62 on 2023-08-31 06:08_

Could we include the error in the message?

---

_Review comment by @MichaReiser on `crates/ruff_cli/src/commands/add_noqa.rs`:68 on 2023-08-31 06:09_

Maybe unify the error handling either by using `LintSource::try_from_path(...).and_then(|source| add_noqa_to_path(...))` or extracing into its own function and calling it. 

---

_@MichaReiser reviewed on 2023-08-31 06:10_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-08-31 06:10_

---

_Label `internal` added by @MichaReiser on 2023-08-31 06:10_

---

_@dhruvmanila reviewed on 2023-08-31 06:19_

---

_Review comment by @dhruvmanila on `crates/ruff_cli/src/commands/add_noqa.rs`:62 on 2023-08-31 06:19_

The error type is an enum where the first variant is an `IO` error while other is a `Diagnostics`. I'm not sure how to transform the `Diagnostics` into a meaningful message without the use of `Printer`.

---

_@charliermarsh reviewed on 2023-08-31 14:03_

---

_Review comment by @charliermarsh on `crates/ruff_cli/src/commands/add_noqa.rs`:62 on 2023-08-31 14:03_

I feel like the underlying issue here is that `Notebook::from_path` uses `Box<Diagnostics>` as its error type. Can we instead return an error there and convert to diagnostics as-needed? We can use a dedicated error enum to represent the IO error vs. the "you passed in something that isn't a notebook" error.

---

_@charliermarsh reviewed on 2023-08-31 21:37_

---

_Review comment by @charliermarsh on `crates/ruff_cli/src/commands/add_noqa.rs`:62 on 2023-08-31 21:37_

I'm going to do this refactor quickly because it's bothering me :joy:

---

_Review comment by @charliermarsh on `crates/ruff_cli/src/commands/add_noqa.rs`:62 on 2023-08-31 22:19_

See: https://github.com/astral-sh/ruff/pull/7035.

---

_@charliermarsh reviewed on 2023-08-31 22:19_

---

_@dhruvmanila reviewed on 2023-09-01 04:33_

---

_Review comment by @dhruvmanila on `crates/ruff_cli/src/commands/add_noqa.rs`:62 on 2023-09-01 04:33_

> I'm going to do this refactor quickly because it's bothering me ðŸ˜‚

No worries, thanks! :)

---

_Review requested from @MichaReiser by @dhruvmanila on 2023-09-01 13:22_

---

_@MichaReiser approved on 2023-09-04 07:31_

---

_Closed by @dhruvmanila on 2023-09-04 07:34_

---

_Reopened by @dhruvmanila on 2023-09-04 07:34_

---

_Comment by @dhruvmanila on 2023-09-04 07:35_

(Closing and re-opening the PR to trigger CI)

---

_Merged by @dhruvmanila on 2023-09-04 07:45_

---

_Closed by @dhruvmanila on 2023-09-04 07:45_

---

_Branch deleted on 2023-09-04 07:46_

---
