```yaml
number: 8333
title: Dedicated cache directory per ruff version
type: pull_request
state: merged
author: MichaReiser
labels:
  - cli
assignees: []
merged: true
base: main
head: 10-30-Dedicated_cache_directory_per_ruff_version
created_at: 2023-10-30T02:21:07Z
updated_at: 2023-10-30T09:08:39Z
url: https://github.com/astral-sh/ruff/pull/8333
synced_at: 2026-01-10T23:40:55Z
```

# Dedicated cache directory per ruff version

---

_Pull request opened by @MichaReiser on 2023-10-30 02:21_

## Summary

This PR changes our cache to use a dedicated cache directory per ruff version. 

* Before: `.ruff_cache/content`
* After: `.ruff_cache/0.1.3`



The motivation is that I want to rule out that hash collisions between cache keys causing ruff to load a cache created by another version.
Loading incompatible caches might be the root cause for https://github.com/astral-sh/ruff/issues/8147 (although unlikely, because users mention that they didn't upgrade ruff)
Other hash collissions are less problematic, because the Cache checks if the loaded file is for the same package, and otherwise clears the cache for that package. 


## Open questions

I'm unsure if this is considered a breaking change or not. It does change observable behavior of Ruff but we never included it in our public API.

## Test Plan

Verified that the cache is still used by comparing performance before/after

<!-- How was it tested? -->


---

_Comment by @MichaReiser on 2023-10-30 02:21_

Current dependencies on/for this PR:
* main
  * **PR #8333** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/8333" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/8333?utm_source=stack-comment).

---

_@MichaReiser reviewed on 2023-10-30 02:21_

---

_Review comment by @MichaReiser on `crates/ruff_cli/src/cache.rs`:105 on 2023-10-30 02:21_

Using `itoa` to write a single number felt overkill.

---

_@charliermarsh reviewed on 2023-10-30 02:27_

Will we still automatically clear old entries with this approach?

---

_Comment by @github-actions[bot] on 2023-10-30 02:38_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no linter changes.

âœ… ecosystem check detected no format changes.



---

_Comment by @MichaReiser on 2023-10-30 02:45_

> Will we still automatically clear old entries with this approach?

We continue to automatically clear old file entries, the same as the old version. 

What the version doesn't (nor did the baseline) is to clean up caches of old versions (except if you run `ruff clean`)

---

_Comment by @charliermarsh on 2023-10-30 02:59_

Oh interesting, so even the existing cache will _never_ remove files from old versions?

---

_@charliermarsh approved on 2023-10-30 02:59_

---

_Comment by @MichaReiser on 2023-10-30 03:07_

> Oh interesting, so even the existing cache will _never_ remove files from old versions?

Not as far as I know. The only cleanup code that I see is the removal of stale entries:

https://github.com/astral-sh/ruff/blob/6199590072e1d3817d983ec2b8c0136859fedbda/crates/ruff_cli/src/cache.rs#L192-L197

But there's no operation that iterates over all files and cleans unused entries, other than the `ruff clean`  command

---

_Merged by @MichaReiser on 2023-10-30 09:08_

---

_Closed by @MichaReiser on 2023-10-30 09:08_

---

_Branch deleted on 2023-10-30 09:08_

---

_Label `cli` added by @MichaReiser on 2023-10-30 09:08_

---
