```yaml
number: 4978
title: "perf(formatter): Skip bodies without comments"
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
  - performance
  - formatter
assignees: []
merged: true
base: main
head: perf-skip-body
created_at: 2023-06-09T05:57:05Z
updated_at: 2023-06-09T09:33:58Z
url: https://github.com/astral-sh/ruff/pull/4978
synced_at: 2026-01-12T15:55:17Z
```

# perf(formatter): Skip bodies without comments

---

_@MichaReiser_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR improves the performance of the comments extraction by skipping over bodies that contain no comments. 

The visitor already avoided visiting the children of a node if there are no comments in its range but we aren't doing this yet for bodies because bodies are not nodes. 
This PR adds the logic for skipping over bodies if there's no comment in the body range. 

```python
if test: # a comment 
	... 
```

The old implementation did visit the `if` statement, as well as the `body` and `orelse` because it contains a comment in its range. But this is unnecessary
because only the case header has a comment. 


## Test Plan

`cargo test`


---

_Comment by @MichaReiser on 2023-06-09 05:57_

Current dependencies on/for this PR:
* main
  * **PR #4954** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4954" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #4921** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4921" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #4922** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4922" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #4951** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4951" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #4961** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4961" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
            * **PR #4964** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4964" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
              * **PR #4979** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4979" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 
              * **PR #4978** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4978" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/4978?utm_source=stack-comment).

---

_Renamed from "perf(formatter): Avoid skipping bodies without comments" to "perf(formatter): Skip bodies without comments" by @MichaReiser on 2023-06-09 06:20_

---

_Label `internal` added by @MichaReiser on 2023-06-09 06:20_

---

_Label `performance` added by @MichaReiser on 2023-06-09 06:20_

---

_Label `autoformatter` added by @MichaReiser on 2023-06-09 06:20_

---

_Comment by @github-actions[bot] on 2023-06-09 06:52_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.02      6.5Â±0.02ms     6.3 MB/sec    1.00      6.4Â±0.01ms     6.4 MB/sec
formatter/numpy/ctypeslib.py               1.01   1357.2Â±7.20Âµs    12.3 MB/sec    1.00   1339.5Â±2.51Âµs    12.4 MB/sec
formatter/numpy/globals.py                 1.01    131.5Â±0.23Âµs    22.4 MB/sec    1.00    129.9Â±0.17Âµs    22.7 MB/sec
formatter/pydantic/types.py                1.02      2.7Â±0.02ms     9.6 MB/sec    1.00      2.6Â±0.02ms     9.7 MB/sec
linter/all-rules/large/dataset.py          1.00     14.0Â±0.02ms     2.9 MB/sec    1.00     14.0Â±0.04ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.4Â±0.00ms     4.9 MB/sec    1.00      3.4Â±0.01ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    423.2Â±0.61Âµs     7.0 MB/sec    1.00    423.3Â±0.60Âµs     7.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.9Â±0.01ms     4.3 MB/sec    1.00      5.9Â±0.01ms     4.3 MB/sec
linter/default-rules/large/dataset.py      1.00      6.7Â±0.01ms     6.0 MB/sec    1.01      6.8Â±0.01ms     6.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1471.2Â±3.38Âµs    11.3 MB/sec    1.01   1484.2Â±2.40Âµs    11.2 MB/sec
linter/default-rules/numpy/globals.py      1.00    166.1Â±0.29Âµs    17.8 MB/sec    1.00    166.7Â±0.23Âµs    17.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.1Â±0.01ms     8.3 MB/sec    1.00      3.1Â±0.01ms     8.3 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      7.6Â±0.06ms     5.3 MB/sec    1.15      8.7Â±0.07ms     4.7 MB/sec
formatter/numpy/ctypeslib.py               1.00  1556.5Â±15.14Âµs    10.7 MB/sec    1.12  1739.9Â±23.82Âµs     9.6 MB/sec
formatter/numpy/globals.py                 1.00    149.3Â±3.21Âµs    19.8 MB/sec    1.11    165.5Â±4.76Âµs    17.8 MB/sec
formatter/pydantic/types.py                1.00      3.1Â±0.04ms     8.2 MB/sec    1.13      3.5Â±0.04ms     7.2 MB/sec
linter/all-rules/large/dataset.py          1.00     16.4Â±0.10ms     2.5 MB/sec    1.01     16.6Â±0.12ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.2Â±0.05ms     4.0 MB/sec    1.01      4.2Â±0.04ms     3.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    497.1Â±5.72Âµs     5.9 MB/sec    1.00    499.3Â±6.78Âµs     5.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.0Â±0.05ms     3.6 MB/sec    1.01      7.1Â±0.06ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.00      8.2Â±0.04ms     5.0 MB/sec    1.00      8.2Â±0.06ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1755.9Â±29.79Âµs     9.5 MB/sec    1.00  1747.9Â±23.44Âµs     9.5 MB/sec
linter/default-rules/numpy/globals.py      1.00    198.1Â±2.83Âµs    14.9 MB/sec    1.01    200.1Â±6.00Âµs    14.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7Â±0.03ms     6.8 MB/sec    1.00      3.7Â±0.03ms     6.9 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Comment by @MichaReiser on 2023-06-09 07:17_

The benchmarks compare against `main` which does not yet have the `if statement` formatting. But we can see that the increase goes down from 25% slowdown to an at most 18% slowdown.

---

_Review requested from @konstin by @MichaReiser on 2023-06-09 07:17_

---

_Comment by @konstin on 2023-06-09 07:37_

With https://github.com/astral-sh/ruff/pull/4964#issuecomment-1583012574, i don't really see much performance difference 

---

_@konstin approved on 2023-06-09 07:39_

---

_Comment by @MichaReiser on 2023-06-09 09:33_

> With [#4964 (comment)](https://github.com/astral-sh/ruff/pull/4964#issuecomment-1583012574), i don't really see much performance difference

The linux result are in the range of what I expected and was able to reproduce locally. Not sure what happened with the windows run.

---

_Merged by @MichaReiser on 2023-06-09 09:33_

---

_Closed by @MichaReiser on 2023-06-09 09:33_

---

_Branch deleted on 2023-06-09 09:33_

---
