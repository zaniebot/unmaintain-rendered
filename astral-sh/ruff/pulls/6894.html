<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optional source map generation - astral-sh/ruff #6894</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Optional source map generation</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6894">#6894</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-08-26 11:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">

Summary
<p>This PR makes the formatter&#x27;s source map generation optional.</p>
<p>Source mapping informatin is useful to implement range formatting or to move the cursor to the same position in the formatted document. But it comes at the cost of a much larger <code>Document</code> (one each at the start and end of every node) and a large source map created by writting source markers in the Printer (one marker at the start and end of every text).
This PR makes the source map generation option so that we don&#x27;t pay the overhead when it isn&#x27;t needed.</p>
Test Plan
<pre><code>cargo test
</code></pre>
<p>Performance improves locally by about 16%</p>
<pre><code>formatter/numpy/globals.py
                        time:   [36.860 Âµs 36.908 Âµs 36.971 Âµs]
                        thrpt:  [79.811 MiB/s 79.946 MiB/s 80.050 MiB/s]
                 change:
                        time:   [-16.602% -16.431% -16.245%] (p = 0.00 &lt; 0.05)
                        thrpt:  [+19.396% +19.662% +19.907%]
                        Performance has improved.
Found 6 outliers among 100 measurements (6.00%)
  4 (4.00%) high mild
  2 (2.00%) high severe
formatter/pydantic/types.py
                        time:   [771.54 Âµs 773.43 Âµs 775.26 Âµs]
                        thrpt:  [32.896 MiB/s 32.974 MiB/s 33.055 MiB/s]
                 change:
                        time:   [-17.740% -17.519% -17.303%] (p = 0.00 &lt; 0.05)
                        thrpt:  [+20.923% +21.240% +21.566%]
                        Performance has improved.
formatter/numpy/ctypeslib.py
                        time:   [408.12 Âµs 408.48 Âµs 408.90 Âµs]
                        thrpt:  [40.722 MiB/s 40.763 MiB/s 40.799 MiB/s]
                 change:
                        time:   [-16.845% -15.595% -14.821%] (p = 0.00 &lt; 0.05)
                        thrpt:  [+17.400% +18.476% +20.257%]
                        Performance has improved.
Found 7 outliers among 100 measurements (7.00%)
  3 (3.00%) high mild
  4 (4.00%) high severe
formatter/large/dataset.py
                        time:   [2.1040 ms 2.1059 ms 2.1084 ms]
                        thrpt:  [19.295 MiB/s 19.318 MiB/s 19.336 MiB/s]
                 change:
                        time:   [-14.956% -14.812% -14.648%] (p = 0.00 &lt; 0.05)
                        thrpt:  [+17.162% +17.387% +17.586%]
                        Performance has improved.
Found 11 outliers among 100 measurements (11.00%)
  6 (6.00%) high mild
  5 (5.00%) high severe

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-26 11:55</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #6894</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6894"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite"></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6894?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Make source map generation configurable&quot; to &quot;Make source map generation optional&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-26 11:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Make source map generation optional&quot; to &quot;Optional source map generation&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-26 11:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-26 11:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-26 11:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/charliermarsh">@charliermarsh</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-26 11:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-26 12:26</div>
            <div class="timeline-body">PR Check Results
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.16      4.5Â±0.02ms     9.1 MB/sec    1.00      3.8Â±0.02ms    10.6 MB/sec
formatter/numpy/ctypeslib.py               1.12    882.8Â±2.44Âµs    18.9 MB/sec    1.00    789.3Â±2.16Âµs    21.1 MB/sec
formatter/numpy/globals.py                 1.10     82.7Â±0.35Âµs    35.7 MB/sec    1.00     75.5Â±0.37Âµs    39.1 MB/sec
formatter/pydantic/types.py                1.17   1680.5Â±9.86Âµs    15.2 MB/sec    1.00   1437.5Â±3.35Âµs    17.7 MB/sec
linter/all-rules/large/dataset.py          1.00     10.1Â±0.05ms     4.0 MB/sec    1.00     10.1Â±0.06ms     4.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      2.7Â±0.00ms     6.1 MB/sec    1.00      2.7Â±0.00ms     6.1 MB/sec
linter/all-rules/numpy/globals.py          1.01    381.0Â±0.65Âµs     7.7 MB/sec    1.00    378.9Â±1.44Âµs     7.8 MB/sec
linter/all-rules/pydantic/types.py         1.01      5.3Â±0.09ms     4.8 MB/sec    1.00      5.2Â±0.02ms     4.9 MB/sec
linter/default-rules/large/dataset.py      1.00      5.3Â±0.03ms     7.6 MB/sec    1.02      5.4Â±0.05ms     7.5 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1180.2Â±3.65Âµs    14.1 MB/sec    1.01   1190.1Â±4.07Âµs    14.0 MB/sec
linter/default-rules/numpy/globals.py      1.00    136.7Â±0.23Âµs    21.6 MB/sec    1.01    138.7Â±0.23Âµs    21.3 MB/sec
linter/default-rules/pydantic/types.py     1.00      2.4Â±0.02ms    10.6 MB/sec    1.01      2.4Â±0.01ms    10.5 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.22      5.2Â±0.07ms     7.8 MB/sec    1.00      4.3Â±0.06ms     9.5 MB/sec
formatter/numpy/ctypeslib.py               1.18  1010.4Â±25.81Âµs    16.5 MB/sec    1.00   854.0Â±12.90Âµs    19.5 MB/sec
formatter/numpy/globals.py                 1.16     94.1Â±1.57Âµs    31.3 MB/sec    1.00     80.8Â±1.95Âµs    36.5 MB/sec
formatter/pydantic/types.py                1.24  1954.0Â±25.11Âµs    13.1 MB/sec    1.00  1578.0Â±21.39Âµs    16.2 MB/sec
linter/all-rules/large/dataset.py          1.01     12.6Â±0.20ms     3.2 MB/sec    1.00     12.4Â±0.21ms     3.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.4Â±0.06ms     4.8 MB/sec    1.00      3.4Â±0.04ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.01    422.3Â±5.60Âµs     7.0 MB/sec    1.00    418.7Â±5.23Âµs     7.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.6Â±0.14ms     3.9 MB/sec    1.00      6.6Â±0.11ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.00      6.9Â±0.08ms     5.9 MB/sec    1.00      6.9Â±0.08ms     5.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1471.5Â±19.77Âµs    11.3 MB/sec    1.00  1474.0Â±15.48Âµs    11.3 MB/sec
linter/default-rules/numpy/globals.py      1.01    170.8Â±4.53Âµs    17.3 MB/sec    1.00    169.4Â±3.10Âµs    17.4 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.1Â±0.04ms     8.3 MB/sec    1.00      3.1Â±0.04ms     8.3 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2023-08-26 14:58</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/configurable-source-map-generation">CodSpeed Performance Report</a>
Merging #6894 will <strong>improve performances by 19.02%</strong>
<p>:warning: No base runs were found</p>
<p>Falling back to comparing <code>configurable-source-map-generation</code> (3053c1b) with <code>main</code> (ed1b412)</p>
Summary
<p><code>ðŸ”¥ 4</code> improvements
<code>âœ… 12</code> untouched benchmarks</p>
Benchmarks breakdown
<p>|     | Benchmark | <code>main</code> | <code>configurable-source-map-generation</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ðŸ”¥ | <code>formatter[numpy/ctypeslib.py]</code> | 13.9 ms | 12 ms | +16.19% |
| ðŸ”¥ | <code>formatter[pydantic/types.py]</code> | 26.3 ms | 22.1 ms | +19.02% |
| ðŸ”¥ | <code>formatter[numpy/globals.py]</code> | 1.4 ms | 1.3 ms | +10.53% |
| ðŸ”¥ | <code>formatter[large/dataset.py]</code> | 72.7 ms | 61.7 ms | +17.77% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-08-26 15:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-26 16:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-26 16:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-26 16:00</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:56:41 UTC
    </footer>
</body>
</html>
