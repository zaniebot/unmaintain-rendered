<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Support for TOML configs in Markdown tests - astral-sh/ruff #14785</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Support for TOML configs in Markdown tests</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14785">#14785</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2024-12-05 10:00
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-12-05 10:00</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This adds support for specifying the target Python version from a Markdown test. It is a somewhat limited ad-hoc solution, but designed to be future-compatible. TOML blocks can be added to arbitrary sections in the Markdown block. They have the following format:</p>
<pre><code class="language-markdown">```toml
[tool.knot.environment]
target-version = &quot;3.13&quot;
```
</code></pre>
<p>So far, there is nothing else that can be configured, but it should be straightforward to extend this to things like a custom typeshed path.</p>
<p>This is in preparation for the statically-known branches feature where we are going to have to specify the target version for lots of tests.</p>
<h2>Test Plan</h2>
<ul>
<li>New Markdown test that fails without the explicitly specified <code>target-version</code>.</li>
<li>Manually tested various error paths when specifying a wrong <code>target-version</code> field.</li>
<li>Made sure that running tests is as fast as before.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @sharkdp on 2024-12-05 10:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2024-12-05 10:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @sharkdp on 2024-12-05 10:00</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2024-12-05 10:00</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-12-05 10:03</div>
            <div class="timeline-body"><p>I'd suggest waiting on @carljm review. I remember he had concerns around exposing the &quot;full&quot; configuration.</p>
<p>I'd remove the <code>tool.knot</code> prefix for a more concise configuration similar to the format we'd use when configuring Red Knot in a <code>knot.toml</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-12-05 10:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/src/lib.rs</code>:32 on 2024-12-05 10:04</div>
            <div class="timeline-body"><p>Makes it possible to see the full error trace, not just the topmost context. For example:</p>
<pre><code>Error parsing `/home/shark/ruff/crates/red_knot_python_semantic/resources/mdtest/sys_version_info_310.md`: Error while parsing Markdown TOML config

Caused by:
    TOML parse error at line 2, column 23
      |
    2 | target-version = &quot;3.13
      |                       ^
    invalid basic string
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-12-05 10:09</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-12-05 10:14</div>
            <div class="timeline-body"><blockquote>
<p>I'd remove the <code>tool.knot</code> prefix for a more concise configuration similar to the format we'd use when configuring Red Knot in a <code>knot.toml</code></p>
</blockquote>
<p>The documentation in https://github.com/astral-sh/ruff/tree/main/crates/red_knot_test#configuration suggested that we want these blocks to contain a <code>pyproject.toml</code>-like config with a <code>[tool.knot]</code> section. I'm personally happy with both solutions, I don't mind the additional <code>tool.knot.</code> prefix too much. Maybe we want to support both eventually (using <code>file=knot.toml</code> or <code>file=pyproject.toml</code>?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-12-05 10:22</div>
            <div class="timeline-body"><blockquote>
<p>The documentation in <a href="https://github.com/astral-sh/ruff/tree/main/crates/red_knot_test?rgh-link-date=2024-12-05T10%3A14%3A18Z#configuration">main/crates/red_knot_test#configuration</a> suggested that we want these blocks to contain a pyproject.toml-like config with a [tool.knot] section. I'm personally happy with both solutions, I don't mind the additional tool.knot. prefix too much. Maybe we want to support both eventually (using file=knot.toml or file=pyproject.toml?)</p>
</blockquote>
<p>I'd prefer to default to a <code>knot.toml</code> configuration and only use the <code>pyproject.toml</code> layout when <code>file=pyproject.toml</code> (if there's even a use case for it because Carl argued in his proposal that end-to-end tests might be a better fit outside of mdtests and resolving options from the <code>pyproject.toml</code> (like <code>requires-python</code>) seems more like an end-to-end test case</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-12-05 10:33</div>
            <div class="timeline-body"><p>Okay, I collapsed it down to a <code>knot.toml</code>-like configuration for now and adapted the documentation. If someone wants to see the original version, the first commit is still there.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by @AlexWaygood on 2024-12-05 11:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/sys_version_info.md</code>:6 on 2024-12-05 15:58</div>
            <div class="timeline-body"><p>hmm... not the end of the world, but on the red-knot CLI we set a target version using <code>--target-version=py39</code> rather than <code>--target-version=&quot;3.9&quot;</code>. Similarly for Ruff, the option is <code>--target-version=py39</code> and in a configuration file it's <code>target-version = &quot;py39&quot;</code>.</p>
<p>I don't actually have a strong opinion on which is better, but it'd be nice to keep the red-knot CLI and the configuration setting here in sync, or it's hard to remember the difference between the two.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-12-05 15:58</div>
            <div class="timeline-body"><p>Nice, thank you!</p>
<p>I think it shouldn't be too hard to make this hierarchical as mentioned in the design doc, but it's fine to start with one-per-file. My main concern is that people may put it nested and misunderstand which tests it will apply to. Ideally IMO if we only support one-per-file we would error if it appears anywhere other than top-level. But if that's hard to do I don't want it to be a blocker.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/sys_version_info_310.md</code>:4 on 2024-12-05 16:00</div>
            <div class="timeline-body"><p>nit: It might be good to be a bit more explicit that this is also a unit test for the <code>red_knot_test</code> crate in some ways.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-05 16:00</div>
            <div class="timeline-body"><p>Nice!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-05 16:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/resources/mdtest/sys_version_info.md</code>:6 on 2024-12-05 16:01</div>
            <div class="timeline-body"><p>uv uses <code>3.9</code> and it's what I proposed in the CLI document</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-05 16:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/sys_version_info.md</code>:6 on 2024-12-05 16:02</div>
            <div class="timeline-body"><p>I see. In that case I'm fine with this, but we should open an issue to change how the CLI works.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-12-05 16:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_python_semantic/resources/mdtest/sys_version_info_310.md</code>:4 on 2024-12-05 16:37</div>
            <div class="timeline-body"><p>This is exactly what this comment was all about, but I can try to make it more explicit :smile:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-05 16:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/sys_version_info_310.md</code>:4 on 2024-12-05 16:39</div>
            <div class="timeline-body"><p>Yeah I think all I'm really asking for is</p>
<pre><code class="language-suggestion">This test makes sure that `red_knot_test` correctly parses the `target-version` option in a
toml configuration block. See `sys_version_info.md` for the actual tests for
`sys.version_info`.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-12-05 16:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-05 17:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/resources/mdtest/sys_version_info.md</code>:6 on 2024-12-05 17:44</div>
            <div class="timeline-body"><p>I plan to scope out the CLI work once the proposal is in a good shape</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-12-05 17:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/resources/mdtest/sys_version_info.md</code>:6 on 2024-12-05 17:46</div>
            <div class="timeline-body"><p>However it ends up, we need to make sure that we remember to align the two though</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/resources/mdtest/sys_version_info.md</code>:6 on 2024-12-05 17:58</div>
            <div class="timeline-body"><p>Absolutely. Consider me responsible for it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-05 17:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-12-05 17:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/resources/mdtest/sys_version_info.md</code>:6 on 2024-12-05 17:58</div>
            <div class="timeline-body"><p>Absolutely. Consider me responsible for it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Preliminary support for TOML configs in Markdown tests" to "[red-knot] Support for TOML configs in Markdown tests" by @sharkdp on 2024-12-06 08:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2024-12-06 09:13</div>
            <div class="timeline-body"><blockquote>
<p>I think it shouldn't be too hard to make this hierarchical as mentioned in the design doc</p>
</blockquote>
<p>You're right. I didn't realize that we could simply change the Python version using <code>Program::get(…).set_target_version(…).to(…)</code> (thanks Micha), and didn't want to re-create the salsa DB for every test, because that resulted in a 3x slowdown.</p>
<p>Multiple (hierarchical) configurations are now fully supported. I verified that the whole test suite still runs in the same time as before.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2024-12-06 09:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/red_knot_test/src/parser.rs</code>:186 on 2024-12-06 09:19</div>
            <div class="timeline-body"><p>I found this function name confusing. It's the current section's ID that's on top of the stack, not the ID of the parent section. When we see a new heading in the parser, this now changes the code to:</p>
<pre><code class="language-rs">let parent = self.stack.top(); // instead of self.stack.parent()

let section = Section {
    // …
    parent_id: Some(parent),
};

// …

let section_id = self.sections.push(section);
self.stack.push(section_id);

// now `self.stack.top()` refers to the child section
</code></pre>
<p>but this seems sensible to me. Before we push the new section, the current section is the parent section.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2024-12-06 09:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2024-12-06 09:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-12-06 09:22</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 20:42:56 UTC
    </footer>
</body>
</html>
