<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`airflow`] Block fixing if the symbol is an attribute access (`AIR3`) - astral-sh/ruff #17884</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>airflow</code>] Block fixing if the symbol is an attribute access (<code>AIR3</code>)</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17884">#17884</a>
        opened by <a href="https://github.com/Lee-W">@Lee-W</a>
        on 2025-05-06 08:25
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Lee-W">@Lee-W</a></div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<!-- What's the purpose of the change? What does it do, and why? -->

<p>Fixing cases like</p>
<pre><code class="language-python">from airflow import datasets
datasets.Dataset()
</code></pre>
<p>can be confusing in many cases. As Airflow 3 changes some path dramatically, the numbers of module parts might not even be equal</p>
<h2>Test Plan</h2>
<!-- How was it tested? -->

<p>test fixtures are added for this</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-06 08:31</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Block attr fix" to "[`airflow`] Block fixing if the symbol is an attribute access (`AIR3`)" by @Lee-W on 2025-05-06 09:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @Lee-W on 2025-05-06 09:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @ntBre on 2025-05-06 20:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @ntBre on 2025-05-06 20:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/airflow/rules/moved_to_provider_in_3.rs</code>:939 on 2025-05-06 20:31</div>
            <div class="timeline-body"><p>nit: I think there should be a helper like <code>expr.is_name_expr</code> (or <code>expr_name</code>?) to use instead of if-let since we're not using the let binding.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/airflow/rules/removal_in_3.rs</code>:880 on 2025-05-06 20:33</div>
            <div class="timeline-body"><p>Same as above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/airflow/rules/suggested_to_move_to_provider_in_3.rs</code>:282 on 2025-05-06 20:33</div>
            <div class="timeline-body"><p>Same as above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ntBre">@ntBre</a> on <code>crates/ruff_linter/src/rules/airflow/rules/suggested_to_update_3_0.rs</code>:290 on 2025-05-06 20:33</div>
            <div class="timeline-body"><p>Same as above.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ntBre">@ntBre</a> approved on 2025-05-06 20:41</div>
            <div class="timeline-body"><p>Thanks, the code changes look good to me. However, I might be slightly confused about the intention here. Do you think adding the additional imports will be too confusing for users? It seems like it would still be more convenient to get the fix and then format your imports afterward, or something like that, but I could be wrong.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Lee-W">@Lee-W</a> on 2025-05-07 00:34</div>
            <div class="timeline-body"><blockquote>
<p>Thanks, the code changes look good to me. However, I might be slightly confused about the intention here. Do you think adding the additional imports will be too confusing for users? It seems like it would still be more convenient to get the fix and then format your imports afterward, or something like that, but I could be wrong.</p>
</blockquote>
<p>The main reason is it could be wrongly fixed.</p>
<p>The example in the description will be fixed as</p>
<pre><code class="language-python">from __future__ import annotations

from airflow import datasets
from airflow.sdk import Asset

datasets.Asset()
</code></pre>
<p>which is wrong</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-07 06:43</div>
            <div class="timeline-body"><p>@Lee-W can you explain what's wrong about it? Is it that it unnecessarily imports <code>Asset</code> or is the <code>datasets.Asset</code> accessor wrong?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Lee-W">@Lee-W</a> on 2025-05-07 07:44</div>
            <div class="timeline-body"><blockquote>
<p>@Lee-W can you explain what's wrong about it? Is it that it unnecessarily imports <code>Asset</code> or is the <code>datasets.Asset</code> accessor wrong?</p>
</blockquote>
<p><code>airflow.datasets.Dataset</code> is updated as <code>airflow.sdk.Asset</code> in Airflow 3.0</p>
<p><code>datasets.Asset</code> is an error, and <code>Asset</code> is unnecessarily imported</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Lee-W">@Lee-W</a> reviewed on 2025-05-07 08:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Lee-W">@Lee-W</a> on <code>crates/ruff_linter/src/rules/airflow/rules/moved_to_provider_in_3.rs</code>:939 on 2025-05-07 08:53</div>
            <div class="timeline-body"><p>Just updated it. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Lee-W">@Lee-W</a> reviewed on 2025-05-07 08:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Lee-W">@Lee-W</a> on <code>crates/ruff_linter/src/rules/airflow/rules/removal_in_3.rs</code>:880 on 2025-05-07 08:53</div>
            <div class="timeline-body"><p>Just updated it. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Lee-W">@Lee-W</a> reviewed on 2025-05-07 08:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Lee-W">@Lee-W</a> on <code>crates/ruff_linter/src/rules/airflow/rules/suggested_to_move_to_provider_in_3.rs</code>:282 on 2025-05-07 08:53</div>
            <div class="timeline-body"><p>Just updated it. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Lee-W">@Lee-W</a> on <code>crates/ruff_linter/src/rules/airflow/rules/suggested_to_update_3_0.rs</code>:290 on 2025-05-07 08:53</div>
            <div class="timeline-body"><p>Just updated it. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Lee-W">@Lee-W</a> reviewed on 2025-05-07 08:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-07 18:19</div>
            <div class="timeline-body"><p>I could still be misunderstanding something, but it sounds like the right fix in this case would be to replace the whole <code>datasets.Dataset</code> with <code>Asset</code>? I don't remember the details of how the replacements are generated, so maybe there's a reason that would be difficult.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Lee-W">@Lee-W</a> on 2025-05-08 01:16</div>
            <div class="timeline-body"><p>Ideally (even this ideal case might not be 100% correct)</p>
<pre><code class="language-python">from airflow import datasets

datasets.Datasets()
</code></pre>
<p>should be replaced as</p>
<pre><code class="language-python">from airflow import sdk

sdk.Asset()
</code></pre>
<hr />
<p>However, this could introduce issues if we have something like</p>
<pre><code class="language-python">from airflow import io

io.path.ObjectStoragePath()


# `airflow.io.path.ObjectStoragePath` is updated as `airflow.sdk.ObjectStoragePath` in Airflow 3
#
# Should we just replace `io` with `sdk`?
# But some other names might still use `io`.
#
# Or should it be something like
# 
# from airflow import sdk
# sdk.ObjectStoragePath()
#
# but the count doesn't match, how should we achieve this? even if we achieve this, is it even correct?
</code></pre>
<p>These cases really depend on how the users use it and it hard to define what is the right fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ntBre">@ntBre</a> on 2025-05-08 14:26</div>
            <div class="timeline-body"><p>I think if you don't worry about trying to remove existing imports, everything should be okay right? In this case:</p>
<pre><code class="language-py">from airflow import datasets

datasets.Datasets()
</code></pre>
<p>I'd expect this transformation:</p>
<pre><code class="language-py">from airflow import datasets  # original import untouched
from airflow import sdk  # new import

sdk.Asset()
</code></pre>
<p>I think you could get the new <code>sdk</code> import by requesting  that from the <code>Importer</code> rather than the full path and then just replace <code>datasets.Datasets</code> with <code>sdk.Asset</code>. The importer should handle raising an error and avoiding a fix if there's a conflicting import.</p>
<p>And I think another rule (<a href="https://docs.astral.sh/ruff/rules/unused-import/#unused-import-f401">unused-import (F401)</a>) should clean up any imports that are unused at the end of the transformation, if it's also enabled.</p>
<p>I'm happy deferring to you here, but I was hopeful that we'd have an existing API that could handle what you needed!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Lee-W">@Lee-W</a> on 2025-05-08 15:46</div>
            <div class="timeline-body"><blockquote>
<p>I think if you don't worry about trying to remove existing imports, everything should be okay right? In this case:</p>
<pre><code class="language-python">from airflow import datasets

datasets.Datasets()
</code></pre>
<p>I'd expect this transformation:</p>
<pre><code class="language-python">from airflow import datasets  # original import untouched
from airflow import sdk  # new import

sdk.Asset()
</code></pre>
<p>I think you could get the new <code>sdk</code> import by requesting that from the <code>Importer</code> rather than the full path and then just replace <code>datasets.Datasets</code> with <code>sdk.Asset</code>. The importer should handle raising an error and avoiding a fix if there's a conflicting import.</p>
<p>And I think another rule (<a href="https://docs.astral.sh/ruff/rules/unused-import/#unused-import-f401">unused-import (F401)</a>) should clean up any imports that are unused at the end of the transformation, if it's also enabled.</p>
<p>I'm happy deferring to you here, but I was hopeful that we'd have an existing API that could handle what you needed!</p>
</blockquote>
<p>The current behavior still cannot replace <code>datasets.Dataset</code> with <code>sdk.Asset</code>. It replaces <code>datasets.Dataset</code> with <code>datasets.Asset</code>, which breaks users' code.</p>
<p>This kind of fixing could be problematic, as the import path length can differ.
In the following example, it's hard to define how to fix it and why it should be fixed that way.</p>
<pre><code class="language-python">from airflow import io

io.path.ObjectStoragePath()

# airflow.sdk.ObjectStoragePath in Airflow 3
</code></pre>
<p>Thus, I think we should avoid this kind of attribute fixing as the risk could be high</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-09 15:52</div>
            <div class="timeline-body"><p>Could we use some heuristic to determine what pattern the user is using and provide a fix in those cases (assuming there are some prominent usages?). It seems a shame to remove the fix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @Lee-W on 2025-05-10 00:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Lee-W">@Lee-W</a> on 2025-05-10 00:30</div>
            <div class="timeline-body"><blockquote>
<p>Could we use some heuristic to determine what pattern the user is using and provide a fix in those cases (assuming there are some prominent usages?). It seems a shame to remove the fix.</p>
</blockquote>
<p>I think the most prominent case is something like</p>
<pre><code class="language-python">from airflow.datasets import Dataset
Dataset()
</code></pre>
<p>which is correctly fixed already. What I'm doing in this PR is to prevent fixes that are known to be incorrect. As for the correct solution, it really depends on various factors, and I don't have a clear answer at this time. I plan to revisit this issue later. Thus, mark this PR as a draft.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-06-20 06:42</div>
            <div class="timeline-body"><p>What's the status on this PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Lee-W">@Lee-W</a> on 2025-06-21 06:27</div>
            <div class="timeline-body"><p>We've not yet had a chance to go back to this one. let me close it and create a new one till we have some bandwidth to work on it</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Lee-W on 2025-06-21 06:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:12:14 UTC
    </footer>
</body>
</html>
