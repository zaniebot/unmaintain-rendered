<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Shrink size of `AstNodeRef` - astral-sh/ruff #20028</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Shrink size of <code>AstNodeRef</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20028">#20028</a>
        opened by <a href="https://github.com/ibraheemdev">@ibraheemdev</a>
        on 2025-08-21 18:28
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Removes the <code>module_ptr</code> field from <code>AstNodeRef</code> in release mode, and change <code>NodeIndex</code> to a <code>NonZeroU32</code> to reduce the size of <code>Option&lt;AstNodeRef&lt;_&gt;&gt;</code> fields.</p>
<p>I believe CI runs in debug mode, so this won't show up in the memory report, but this reduces memory by ~2% in release mode.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @ibraheemdev on 2025-08-21 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @ibraheemdev on 2025-08-21 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @ibraheemdev on 2025-08-21 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @ibraheemdev on 2025-08-21 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @ibraheemdev on 2025-08-21 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @ibraheemdev on 2025-08-21 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @ibraheemdev on 2025-08-21 18:28</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_python_semantic/src/ast_node_ref.rs</code>:127 on 2025-08-21 18:28</div>
            <div class="timeline-body"><p>I'm not completely sure if this is worth the memory usage improvements, cc @MichaReiser.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-08-21 18:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-21 18:30</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-21 18:32</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @ibraheemdev on 2025-08-21 19:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-21 19:13</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/node_index.rs</code>:66 on 2025-08-22 06:39</div>
            <div class="timeline-body"><p>I was a bit confused by the <code>Debug</code> output because it wasn't clear to me that <code>..</code> means the same as dummy. I think something like <code>AtomicNodeIndex::dummy</code> would be more clear (and also avoids the line break)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/node_index.rs</code>:65 on 2025-08-22 06:40</div>
            <div class="timeline-body"><p>Should we add a <code>debug_assertion</code> here that <code>value + 1 != dummy</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/ast_node_ref.rs</code>:127 on 2025-08-22 06:43</div>
            <div class="timeline-body"><p>It's probably fine because <code>AstNodeRef</code> fields are all tracked separately (it's very likely that many indices change when you make a change in code) and
any query depending on an <code>AstNodeRef</code> field always depends on the AST too.</p>
<p>Could we now derive `Update?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-08-22 06:44</div>
            <div class="timeline-body"><p>Nice. Can you try to get some numbers from a real world project when using a release build? I'm curious how much this reduces the memory usage for <code>Expression</code> and <code>Definition</code> (of which we have many of)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on <code>crates/ty_python_semantic/src/ast_node_ref.rs</code>:127 on 2025-08-22 20:50</div>
            <div class="timeline-body"><blockquote>
<p>Could we now derive <code>Update</code></p>
</blockquote>
<p>I don't think so, the <code>Update</code> derive checks for equality of the fields, which would be incorrect here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ibraheemdev">@ibraheemdev</a> reviewed on 2025-08-22 20:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ibraheemdev">@ibraheemdev</a> on 2025-08-22 21:00</div>
            <div class="timeline-body"><p>Here's the diff from on a release build of <code>prefect</code>. The effect on <code>Definition</code> and <code>Expression</code> is quite significant.</p>
<pre><code class="language-diff"> Found 29228 diagnostics
 =======SALSA STRUCTS=======
-`Definition`                                       metadata=19.83MB  fields=39.66MB  count=495746
-`Expression`                                       metadata=12.75MB  fields=14.87MB  count=265605
+`Definition`                                       metadata=19.83MB  fields=27.76MB  count=495746
+`Expression`                                       metadata=12.75MB  fields=6.37MB   count=265605
 `StringLiteralType`                                metadata=3.24MB   fields=5.88MB   count=57943
 `IntersectionType`                                 metadata=1.99MB   fields=4.60MB   count=35545
 `File`                                             metadata=1.69MB   fields=4.52MB   count=26449
@@ -24,12 +24,12 @@
 `FileModule`                                       metadata=0.11MB   fields=0.29MB   count=1992
 `GenericAlias`                                     metadata=0.91MB   fields=0.26MB   count=16249
 `ModuleNameIngredient`                             metadata=0.24MB   fields=0.23MB   count=4344
-`Unpack`                                           metadata=0.17MB   fields=0.20MB   count=4223
 `ModuleLiteralType`                                metadata=0.44MB   fields=0.17MB   count=8470
 `TypeVarInstance`                                  metadata=0.12MB   fields=0.16MB   count=2176
 `StarImportPlaceholderPredicate`                   metadata=0.22MB   fields=0.16MB   count=7889
 `BoundMethodType`                                  metadata=0.36MB   fields=0.16MB   count=6485
 `GenericContext`                                   metadata=0.10MB   fields=0.15MB   count=1822
+`Unpack`                                           metadata=0.17MB   fields=0.14MB   count=4223
 `BoundTypeVarInstance`                             metadata=0.25MB   fields=0.07MB   count=4513
 `PatternPredicate`                                 metadata=0.02MB   fields=0.07MB   count=768
 `Project`                                          metadata=0.00MB   fields=0.06MB   count=1
@@ -51,7 +51,7 @@
 `module_type_symbols::interned_arguments`          metadata=0.00MB   fields=0.00MB   count=1
 =======SALSA QUERIES=======
 `semantic_index -&gt; ty_python_semantic::semantic_index::SemanticIndex`
-    metadata=21.75MB  fields=409.71MB count=6117
+    metadata=21.75MB  fields=407.52MB count=6117
 `parsed_module -&gt; ruff_db::parsed::ParsedModule`
     metadata=0.47MB   fields=284.40MB count=6126
 `use_def_map -&gt; alloc::sync::Arc&lt;ty_python_semantic::semantic_index::use_def::UseDefMap&gt;`
@@ -157,8 +157,8 @@
 `TypeVarInstance &lt; 'db &gt;::lazy_constraints_ -&gt; core::option::Option&lt;ty_python_semantic::types::TypeVarBoundOrConstraints&gt;`
     metadata=0.00MB   fields=0.00MB   count=3
 =======SALSA SUMMARY=======
-TOTAL MEMORY USAGE: 1420.38MB
+TOTAL MEMORY USAGE: 1397.73MB
     struct metadata = 71.31MB
-    struct fields = 93.10MB
+    struct fields = 72.63MB
     memo metadata = 213.48MB
-    memo fields = 1042.49MB
+    memo fields = 1040.30MB
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @ibraheemdev on 2025-08-22 21:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @ibraheemdev on 2025-08-22 21:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-22 21:03</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:15:14 UTC
    </footer>
</body>
</html>
