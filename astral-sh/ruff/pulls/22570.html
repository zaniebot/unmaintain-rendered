<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ruff server] Find config for files outside of open workspaces - astral-sh/ruff #22570</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ruff server] Find config for files outside of open workspaces</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22570">#22570</a>
        opened by <a href="https://github.com/ZedThree">@ZedThree</a>
        on 2026-01-14 12:08
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ZedThree">@ZedThree</a></div>
            <div class="timeline-body"><p>Fixes #17944</p>
<p>There's two different routes we can go down for finding settings for such files:</p>
<ul>
<li>the file is below an open workspace, so we can add any settings we find to that workspace</li>
<li>the file is not below an open workspace, in which case we can't cache them</li>
</ul>
<p>Given this filesystem layout:</p>
<pre><code>.
├── dir_0
│   ├── ruff.toml
│   └── test_0.py
└── dir_1
    ├── ruff.toml
    └── test_1.py
</code></pre>
<p>This fixes:</p>
<ul>
<li>cwd at top-level, opening <code>dir_0/test_0.py</code></li>
<li>cwd at top-level, opening <code>dir_0/test_0.py</code>, then <code>../dir_1/test_1.py</code> in same session</li>
<li>cwd in <code>dir_0</code>, opening <code>../dir_1/test_1.py</code></li>
<li>cwd in <code>dir_0</code>, opening <code>test_0.py</code> first, then <code>../dir_1/test_1.py</code> in same session</li>
</ul>
<p>without negatively affecting non-default workspaces (such as opening the folder in VS Code or <code>lsp-mode</code> in Emacs).</p>
<p>The main downside to this approach is the lack of workspace for files in <code>dir_1</code> -- we can't share already parsed settings.</p>
<hr />
<p>This doesn't work for the situation where we're opening a file in a nested directory below the default workspace, where we <em>do</em> have a config file:</p>
<pre><code>.
├── subdir
│   ├── ruff.toml
│   └── test_1.py
├── ruff.toml
└── test_0.py
</code></pre>
<p>Opening <code>test_0.py</code> first (in single file mode), and then opening <code>subdir/test_1.py</code> still uses the settings from <code>./ruff.toml</code> instead of <code>subdir/ruff.toml</code></p>
<h2>Test Plan</h2>
<p>Tested using the files described in <a href="https://github.com/astral-sh/ruff/issues/17944#issuecomment-3745670262">this comment</a></p>
<p>I noticed that ty has e2e testing of its lsp server, but this hasn't been implemented for ruff yet. I think this would need something like that to test automatically</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @AlexWaygood on 2026-01-14 12:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2026-01-14 12:20</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @MichaReiser on 2026-01-14 12:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2026-01-15 07:34</div>
            <div class="timeline-body"><p>(I've this on my TODO, I'll look at this later today after a meeting.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2026-01-16 10:30</div>
            <div class="timeline-body"><p>Thank you for this PR!</p>
<p>The setting resolution is a little bit complicated for the Ruff language server. I think it would be very useful (and would also help me review this faster) if you can link the specific changes to the directory structure which it tries to solve. For example, which directory structure is <code>RuffSettings::fallback</code> trying to resolve?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ZedThree">@ZedThree</a> on 2026-01-16 10:43</div>
            <div class="timeline-body"><p>Previously, <code>RuffSettings::fallback</code> just tried to look for user-specific config files. Now, it looks in the parent directory of the file being opened, and then its ancestors. So it now ends up searching the following in order, for example:</p>
<ul>
<li><code>/tmp/mvce/dir_0/</code></li>
<li><code>/tmp/mvce/</code></li>
<li><code>/tmp/</code></li>
<li><code>~/.config/ruff/</code></li>
</ul>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-16 10:58:08 UTC
    </footer>
</body>
</html>
