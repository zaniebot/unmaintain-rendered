<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consider quotes inside format-specs when choosing the quotes for an f-string - astral-sh/ruff #14493</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Consider quotes inside format-specs when choosing the quotes for an f-string</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14493">#14493</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2024-11-20 15:49
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fixes https://github.com/astral-sh/ruff/issues/13935</p>
<h2>Test Plan</h2>
<p>Added test</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2024-11-20 15:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by @MichaReiser on 2024-11-20 15:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @MichaReiser on 2024-11-20 15:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-20 15:56</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-20 16:01</div>
            <div class="timeline-body"><p>Hmm, this now leads to invalid syntax for <code>&quot;aaa &quot; f'{1=: &quot;abcd {'aa'}}'</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-20 16:29</div>
            <div class="timeline-body"><p>Okay, this is a pre-existing issue, but not one that gets fixed by this PR.</p>
<pre><code class="language-py">f'{1=: &quot;abcd {'aa'} \'\'}'
</code></pre>
<p>We can't change the outer quotes because the format-spec quotes then become the &quot;closing&quot; quotes of the entire-fstring (which they shouldn't). That means we have to preserve the quotes if:</p>
<ul>
<li>an expression has a format spec that contains the current quote character</li>
<li>the expression uses debug text</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-20 17:29</div>
            <div class="timeline-body"><p>I'll do another review myself of the code changes with a fresh mind tomorrow morning but I think this is mostly correct.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/string/normalize.rs</code>:965 on 2024-11-20 17:36</div>
            <div class="timeline-body"><p>This is slightly too naive because it incorrectly considers escaped quotes. I think this is fine considering how rare this syntax is and it doesn't lead to invalid syntax, it only results in ruff not picking the preferred quotes when it could.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-20 17:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/src/string/normalize.rs</code>:965 on 2024-11-21 07:01</div>
            <div class="timeline-body"><p>They can be nested as well but as you mentioned (and I agree) the syntax itself is rare enough to not worry about it. For example, <code>f&quot;{x:a{y:b{z}}}&quot;</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/src/string/normalize.rs</code>:941 on 2024-11-21 07:04</div>
            <div class="timeline-body"><p>The documentation seems to be a bit misleading as per the logic. I don't see it considering the debug expression.</p>
<p>I would also reword it as &quot;Returns <code>true</code> if the <code>f_string</code> has any part that ...&quot;</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/src/string/normalize.rs</code>:942 on 2024-11-21 07:04</div>
            <div class="timeline-body"><p>To be consistent, we're using this format everywhere although I see it's not being enforced and there are usages of both, I can change that in a different PR</p>
<pre><code class="language-suggestion">    f_string: &amp;FString,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_formatter/src/string/implicit.rs</code>:250 on 2024-11-21 07:13</div>
            <div class="timeline-body"><p>The only change here is the addition of this condition to return the quote that needs to be preserved? I'm curious to know why was this condition not present before this? It seems like it should've been present.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-11-21 07:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-21 07:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/string/normalize.rs</code>:965 on 2024-11-21 07:16</div>
            <div class="timeline-body"><p>Hmm, let me have a look if that means we also need to test for the expression parts</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-21 07:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/string/normalize.rs</code>:942 on 2024-11-21 07:21</div>
            <div class="timeline-body"><p>I prefer to keept it as is so that it's consistent with the function name, but I agree that we have both forms of spelling fstring. Although I don't think this is a big deal</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-21 07:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/string/implicit.rs</code>:250 on 2024-11-21 07:24</div>
            <div class="timeline-body"><p>Not 100%. I would have to remind myself of how the pre 312 fstring formatting works again. It might also just be that we were missing a test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/string/normalize.rs</code>:965 on 2024-11-21 10:17</div>
            <div class="timeline-body"><p>I added some more tests... this is tricky :laughing:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-11-21 10:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2024-11-21 11:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2024-11-22 12:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2024-11-22 12:43</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-11-22 12:43</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:07:54 UTC
    </footer>
</body>
</html>
