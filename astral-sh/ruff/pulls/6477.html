<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>`fmt: off..on` suppression comments - astral-sh/ruff #6477</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1><code>fmt: off..on</code> suppression comments</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6477">#6477</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-08-10 10:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-10 10:58</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>Implements support for <code>fmt: off</code> and <code>fmt: on</code> suppression comments on statement level.</p>
<p>This seems trivial but quickly gets complicated because you can have:</p>
<pre><code class="language-python"># fmt: off
# fmt: on
test
</code></pre>
<p>in which case we should not disable formatting (see test cases for more absurd usages of <code>fmt: off</code> and <code>fmt: on</code> combinations).</p>
<p>This PR does not address:</p>
<ul>
<li>warn if a suppression comment is used incorrectly</li>
<li>Fixing indentation of suppressed ranges</li>
</ul>
<h2>Test Plan</h2>
<p>I added many test files and believe that I covered all branches.</p>
<p>Small improvements in the similarity index:</p>
<p><strong>Before</strong></p>
<p>project | similarity index
-- | --
build | 0.75623
cpython | 0.75472
django | 0.99802
transformers | 0.99470
typeshed | 0.74233
warehouse | 0.99601
zulip | 0.99727</p>
<p><strong>After</strong></p>
<p>project | similarity index
-- | --
build | 0.75623
cpython | 0.75472
django | 0.99804
transformers | 0.99618
typeshed | 0.74233
warehouse | 0.99601
zulip | 0.99727</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-10 10:58</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #6443</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6443" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #6452</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6452" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #6477</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6477" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ<ul>
<li><strong>PR #6507</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6507" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #6561</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6561" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6477?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__fmtonoff.py.snap</code>:226 on 2023-08-10 11:13</div>
            <div class="timeline-body"><p>It does ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__fmtonoff.py.snap</code>:204 on 2023-08-10 11:13</div>
            <div class="timeline-body"><p>Ruff doesn't support expression level suppression comments.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/tests/snapshots/black_compatibility@simple_cases__fmtonoff4.py.snap</code>:31 on 2023-08-10 11:14</div>
            <div class="timeline-body"><p>Suppression comments between decorators are not supported.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-10 12:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @MichaReiser on 2023-08-10 12:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by @MichaReiser on 2023-08-10 12:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2023-08-10 12:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @MichaReiser on 2023-08-10 12:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/suite.rs</code>:76 on 2023-08-10 12:35</div>
            <div class="timeline-body"><p>I had to move the <code>first.format</code> out to avoid having to handle suppression comments in each branch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-10 12:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/suite.rs</code>:108 on 2023-08-10 12:36</div>
            <div class="timeline-body"><p>I had to move this into the <code>loop</code> to avoid having to handle the suppression comments on <code>second</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-10 12:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/suite.rs</code>:116 on 2023-08-10 12:36</div>
            <div class="timeline-body"><p>This is new</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-10 12:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/suite.rs</code>:185 on 2023-08-10 12:36</div>
            <div class="timeline-body"><p>This is new</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-10 12:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-10 12:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/suite.rs</code>:277 on 2023-08-10 12:37</div>
            <div class="timeline-body"><p>This is new</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-10 13:07</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.03      4.4Â±0.11ms     9.2 MB/sec    1.00      4.3Â±0.13ms     9.5 MB/sec
formatter/numpy/ctypeslib.py               1.00   821.4Â±22.03Âµs    20.3 MB/sec    1.03   843.9Â±21.86Âµs    19.7 MB/sec
formatter/numpy/globals.py                 1.00     84.0Â±2.83Âµs    35.1 MB/sec    1.04     87.7Â±1.74Âµs    33.6 MB/sec
formatter/pydantic/types.py                1.00  1695.1Â±38.16Âµs    15.0 MB/sec    1.01  1718.9Â±93.61Âµs    14.8 MB/sec
linter/all-rules/large/dataset.py          1.07     12.5Â±0.15ms     3.3 MB/sec    1.00     11.7Â±0.37ms     3.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.03      3.3Â±0.05ms     5.0 MB/sec    1.00      3.2Â±0.06ms     5.2 MB/sec
linter/all-rules/numpy/globals.py          1.06   471.6Â±10.18Âµs     6.3 MB/sec    1.00   444.3Â±10.05Âµs     6.6 MB/sec
linter/all-rules/pydantic/types.py         1.06      6.4Â±0.08ms     4.0 MB/sec    1.00      6.1Â±0.13ms     4.2 MB/sec
linter/default-rules/large/dataset.py      1.09      6.7Â±0.13ms     6.1 MB/sec    1.00      6.1Â±0.08ms     6.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.06  1436.6Â±14.27Âµs    11.6 MB/sec    1.00  1356.3Â±30.18Âµs    12.3 MB/sec
linter/default-rules/numpy/globals.py      1.03    167.4Â±2.01Âµs    17.6 MB/sec    1.00    162.4Â±4.26Âµs    18.2 MB/sec
linter/default-rules/pydantic/types.py     1.06      2.9Â±0.04ms     8.7 MB/sec    1.00      2.8Â±0.05ms     9.2 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.09      5.1Â±0.31ms     8.0 MB/sec    1.00      4.7Â±0.41ms     8.7 MB/sec
formatter/numpy/ctypeslib.py               1.05   927.6Â±35.41Âµs    18.0 MB/sec    1.00   882.6Â±50.07Âµs    18.9 MB/sec
formatter/numpy/globals.py                 1.00     89.5Â±4.45Âµs    33.0 MB/sec    1.00     89.4Â±4.89Âµs    33.0 MB/sec
formatter/pydantic/types.py                1.04  1861.9Â±71.24Âµs    13.7 MB/sec    1.00  1783.5Â±86.34Âµs    14.3 MB/sec
linter/all-rules/large/dataset.py          1.00     14.9Â±0.49ms     2.7 MB/sec    1.03     15.4Â±0.35ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.0Â±0.17ms     4.1 MB/sec    1.08      4.4Â±0.14ms     3.8 MB/sec
linter/all-rules/numpy/globals.py          1.00   531.2Â±21.23Âµs     5.6 MB/sec    1.04   554.7Â±20.82Âµs     5.3 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.7Â±0.32ms     3.3 MB/sec    1.05      8.1Â±0.28ms     3.1 MB/sec
linter/default-rules/large/dataset.py      1.02      8.1Â±0.40ms     5.0 MB/sec    1.00      8.0Â±0.39ms     5.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.04  1780.4Â±51.26Âµs     9.4 MB/sec    1.00  1716.0Â±61.20Âµs     9.7 MB/sec
linter/default-rules/numpy/globals.py      1.06   231.7Â±10.42Âµs    12.7 MB/sec    1.00    219.6Â±8.22Âµs    13.4 MB/sec
linter/default-rules/pydantic/types.py     1.03      3.8Â±0.11ms     6.8 MB/sec    1.00      3.7Â±0.13ms     7.0 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/verbatim.rs</code>:105 on 2023-08-11 12:15</div>
            <div class="timeline-body"><p>unfinished sentence</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/verbatim.rs</code>:138 on 2023-08-11 12:17</div>
            <div class="timeline-body"><p><code>slice::from_ref</code> is neat, i could have used that :eyes:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/verbatim.rs</code>:381 on 2023-08-11 12:22</div>
            <div class="timeline-body"><p>nit:</p>
<pre><code class="language-suggestion">                .map(Ranged::end)
                .unwrap_or(statement.end());
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/verbatim.rs</code>:411 on 2023-08-11 12:23</div>
            <div class="timeline-body"><p>nit: dedent the body</p>
<pre><code class="language-suggestion">        if self.comments.is_empty() {
            return None;
        }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-08-11 12:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/verbatim.rs</code>:41 on 2023-08-11 16:09</div>
            <div class="timeline-body"><p>Nit: include an example, showing comments before the <code>fmt off</code> that we'd want to handle here? (I follow what's going on, but it might be nice to show it visually.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/verbatim.rs</code>:181 on 2023-08-11 16:11</div>
            <div class="timeline-body"><p>Can you document each of these branches?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/verbatim.rs</code>:139 on 2023-08-11 16:17</div>
            <div class="timeline-body"><p>Could it ever be the case that we're missing out on &quot;special&quot; formatting of some of these comments? I don't have a more precise idea of when that could happen, but just acknowledging that these are typically handled by children, and we're now intercepting and formatting them here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/verbatim.rs</code>:364 on 2023-08-11 16:22</div>
            <div class="timeline-body"><p>Nit: <code>if-let</code> for single-case match?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/verbatim.rs</code>:445 on 2023-08-11 16:22</div>
            <div class="timeline-body"><p>Do you intentionally not <code>#[derive(Debug)]</code> here? (Asking for my own learning.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_formatter/src/verbatim.rs</code>:422 on 2023-08-11 16:31</div>
            <div class="timeline-body"><p>I wish there were a way to make this pattern clearer (find the index, split before and after, then split <em>at</em> the index), but I'm struggling to come up with anything better.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-08-11 16:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/verbatim.rs</code>:364 on 2023-08-11 17:42</div>
            <div class="timeline-body"><p>I'll have a look. I love match because  I find it easier to reason about than <code>let...else</code> or <code>if let... else</code> and our pedantic rule annoys me a lot that forces me to rewrite the if else to a match</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-11 17:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/verbatim.rs</code>:381 on 2023-08-14 10:05</div>
            <div class="timeline-body"><p>Clippy doesn't like that</p>
<pre><code>warning: called `map(&lt;f&gt;).unwrap_or(&lt;a&gt;)` on an `Option` value. This can be done more directly by calling `map_or(&lt;a&gt;, &lt;f&gt;)` instead
   --&gt; crates/ruff_python_formatter/src/verbatim.rs:327:23
    |
327 |               let end = comments
    |  _______________________^
328 | |                 .trailing_comments(statement)
329 | |                 .last()
330 | |                 .map(Ranged::end)
331 | |                 .unwrap_or(statement.end());
    | |___________________________________________^
    |
    = help: for further information visit https://rust-lang.github.io/rust-clippy/master/index.html#map_unwrap_or
    = note: `-W clippy::map-unwrap-or` implied by `-W clippy::pedantic`
help: use `map_or(&lt;a&gt;, &lt;f&gt;)` instead
    |
330 -                 .map(Ranged::end)
330 +                 .map_or(statement.end(), Ranged::end);
    |
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-14 10:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/verbatim.rs</code>:445 on 2023-08-14 10:08</div>
            <div class="timeline-body"><p>Mainly because I didn't need it, it's a private type, and printing iterators is always a bit awkward.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-14 10:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-14 10:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/verbatim.rs</code>:422 on 2023-08-14 10:11</div>
            <div class="timeline-body"><p>Yeah, it's a bit verbose, but that's why I introduced the iterator. I first had this code duplicated everywhere, :roll_eyes:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-14 10:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/verbatim.rs</code>:139 on 2023-08-14 10:17</div>
            <div class="timeline-body"><p>Good catch. This could be a problem if a statement overrides <code>fmt_leading_comments</code> or <code>fmt_trailing_comments</code>. I checked, and no expression or statement overrides these methods on <code>FormatNodeRule</code>. I went ahead and inlined the functions to not give the impression that this behavior should be customized.</p>
<p>Either way, I think it would be okay to format the comments with the default formatting. It may not be perfect but we're dealing with suppressed ranges anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-14 15:42</div>
            <div class="timeline-body"><p>The main reason why this PR regresses performance is because it is now necessary to look up the leading and trailing comments for every statement, and we do the same when formatting the statement.</p>
<p>We could improve this by moving the leading/trailing comments formatting for statements into <code>suite.rs</code> to avoid the additional hash map lookup. We may want to do this in the future, but it isn't necessary doing right now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-08-14 15:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-08-14 15:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-14 15:57</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 02:52:42 UTC
    </footer>
</body>
</html>
