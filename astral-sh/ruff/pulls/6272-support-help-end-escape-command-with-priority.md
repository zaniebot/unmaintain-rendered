```yaml
number: 6272
title: Support help end escape command with priority
type: pull_request
state: merged
author: dhruvmanila
labels:
  - parser
assignees: []
merged: true
base: main
head: dhruv/jupyter-help-magic
created_at: 2023-08-02T12:30:56Z
updated_at: 2023-08-07T15:31:04Z
url: https://github.com/astral-sh/ruff/pull/6272
synced_at: 2026-01-12T02:52:03Z
```

# Support help end escape command with priority

---

_Pull request opened by @dhruvmanila on 2023-08-02 12:30_

## Summary

This PR adds support for help end escape command in the lexer.

### What are "help end escape commands"?

First, the escape commands are special IPython syntax which enhances the functionality for the IPython REPL. There are 9 types of escape kinds which are recognized by the tokens which are present at the start of the command (`?`, `??`, `!`, `!!`, etc.).

Here, the help command is using either the `?` or `??` token at the start (`?str.replace` for example). Those 2 tokens are also supported when they're at the end of the command (`str.replace?`), but the other tokens aren't supported in that position.

There are mainly two types of help end escape commands:
1. Ending with either `?` or `??`, but it also starts with one of the escape tokens (`%matplotlib?`)
2. On the other hand, there's a stricter version for (1) which doesn't start with any escape tokens (`str.replace?`)

This PR adds support for (1) while (2) will be supported in the parser.

### Priority

Now, if the command starts and ends with an escape token, how do we decide the kind of this command? This is where priority comes into picture. This is simple as there's only one priority where `?`/`??` at the end takes priority over any other escape token and all of the other tokens are at the same priority. Remember that only `?`/`??` at the end is considered valid.

This is mainly useful in the case where someone would want to invoke the help command on the magic command itself. For example, in `%matplotlib?` the help command takes priority which means that we want help for the `matplotlib` magic function instead of calling the magic function itself.

### Specification

Here's where things get a bit tricky. What if there are question mark tokens at both ends. How do we decide if it's `Help` (`?`) kind or `Help2` (`??`) kind?

|     | Magic       | Value     | Kind    |
| --- | ---         | ---       | ---     |
| 1   | `?foo?`     | `foo`     | `Help`  |
| 2   | `??foo?`    | `foo`     | `Help`  |
| 3   | `?foo??`    | `foo`     | `Help2` |
| 4   | `??foo??`   | `foo`     | `Help2` |
| 5   | `???foo??`  | `foo`     | `Help2` |
| 6   | `??foo???`  | `foo???`  | `Help2` |
| 7   | `???foo???` | `?foo???` | `Help2` |

Looking at the above table:

- The question mark tokens on the right takes priority over the ones on the left but only if the number of question mark on the right is 1 or 2.
- If there are more than 2 question mark tokens on the right side, then the left side is used to determine the same.
- If the right side is used to determine the kind, then all of the question marks and whitespaces on the left side are ignored in the `value`, but if itâ€™s the other way around, then all of the extra question marks are part of the `value`.

### References

- IPython implementation using the regex: https://github.com/ipython/ipython/blob/292e3a23459ca965b8c1bfe2c3707044c510209a/IPython/core/inputtransformer2.py#L454-L462
- Priorities: https://github.com/ipython/ipython/blob/292e3a23459ca965b8c1bfe2c3707044c510209a/IPython/core/inputtransformer2.py#L466-L469

## Test Plan

Add a bunch of test cases for the lexer and verify that it matches the behavior of
IPython transformer.

resolves: #6357 


---

_Comment by @dhruvmanila on 2023-08-02 12:31_

Current dependencies on/for this PR:
* main
  * **PR #6272** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6272" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
    * **PR #6358** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6358" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6272?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-08-02 13:10_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.3Â±0.09ms     4.9 MB/sec    1.00      8.2Â±0.06ms     4.9 MB/sec
formatter/numpy/ctypeslib.py               1.01  1634.8Â±23.16Âµs    10.2 MB/sec    1.00  1623.0Â±12.67Âµs    10.3 MB/sec
formatter/numpy/globals.py                 1.00    184.2Â±4.99Âµs    16.0 MB/sec    1.00    184.7Â±5.06Âµs    16.0 MB/sec
formatter/pydantic/types.py                1.01      3.5Â±0.07ms     7.3 MB/sec    1.00      3.4Â±0.04ms     7.4 MB/sec
linter/all-rules/large/dataset.py          1.00     10.3Â±0.02ms     4.0 MB/sec    1.04     10.7Â±0.02ms     3.8 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      2.7Â±0.01ms     6.1 MB/sec    1.00      2.7Â±0.01ms     6.1 MB/sec
linter/all-rules/numpy/globals.py          1.01    384.5Â±0.68Âµs     7.7 MB/sec    1.00    379.8Â±2.41Âµs     7.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      4.7Â±0.01ms     5.4 MB/sec    1.03      4.9Â±0.04ms     5.2 MB/sec
linter/default-rules/large/dataset.py      1.04      5.4Â±0.01ms     7.6 MB/sec    1.00      5.2Â±0.01ms     7.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1150.4Â±3.38Âµs    14.5 MB/sec    1.00  1139.0Â±27.45Âµs    14.6 MB/sec
linter/default-rules/numpy/globals.py      1.03    132.2Â±2.70Âµs    22.3 MB/sec    1.00    128.3Â±5.37Âµs    23.0 MB/sec
linter/default-rules/pydantic/types.py     1.03      2.4Â±0.00ms    10.6 MB/sec    1.00      2.3Â±0.01ms    10.9 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      9.7Â±0.07ms     4.2 MB/sec    1.02      9.9Â±0.27ms     4.1 MB/sec
formatter/numpy/ctypeslib.py               1.00  1886.6Â±21.04Âµs     8.8 MB/sec    1.01  1911.5Â±33.78Âµs     8.7 MB/sec
formatter/numpy/globals.py                 1.00   214.6Â±10.47Âµs    13.7 MB/sec    1.01   217.9Â±12.76Âµs    13.5 MB/sec
formatter/pydantic/types.py                1.00      4.1Â±0.06ms     6.2 MB/sec    1.02      4.2Â±0.08ms     6.1 MB/sec
linter/all-rules/large/dataset.py          1.00     12.7Â±0.29ms     3.2 MB/sec    1.02     13.0Â±0.15ms     3.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.5Â±0.04ms     4.8 MB/sec    1.00      3.4Â±0.04ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    433.2Â±4.91Âµs     6.8 MB/sec    1.00    431.1Â±5.32Âµs     6.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.8Â±0.08ms     4.4 MB/sec    1.03      6.0Â±0.07ms     4.3 MB/sec
linter/default-rules/large/dataset.py      1.03      6.9Â±0.07ms     5.9 MB/sec    1.00      6.6Â±0.06ms     6.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.03  1424.2Â±21.64Âµs    11.7 MB/sec    1.00  1379.7Â±14.09Âµs    12.1 MB/sec
linter/default-rules/numpy/globals.py      1.02    165.2Â±2.92Âµs    17.9 MB/sec    1.00    162.3Â±3.76Âµs    18.2 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.0Â±0.06ms     8.4 MB/sec    1.00      3.0Â±0.08ms     8.5 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_@dhruvmanila reviewed on 2023-08-02 14:14_

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/lexer.rs`:1415 on 2023-08-02 14:14_

For reference, the IPython transformer will transform the above code as the below where `pinfo` and `pinfo2` corresponds to `Help` and `Help2` magic kind:
```python
get_ipython().run_line_magic('pinfo', 'foo')
get_ipython().run_line_magic('pinfo', 'foo')
get_ipython().run_line_magic('pinfo2', '   foo  ?')
get_ipython().run_line_magic('pinfo2', 'foo')
get_ipython().run_line_magic('pinfo2', 'foo')
get_ipython().run_line_magic('pinfo', 'foo')
get_ipython().run_line_magic('pinfo2', 'foo')
get_ipython().run_line_magic('pinfo2', 'foo???')
get_ipython().run_line_magic('pinfo2', '?foo???')
get_ipython().run_line_magic('pinfo', 'foo')
get_ipython().run_line_magic('pinfo2', ' ?')
get_ipython().run_line_magic('pinfo', '%foo')
get_ipython().run_line_magic('pinfo2', '%foo')

# This is the only difference between IPython transformers and our lexer where
# our lexer will emit this as cell magic (`%%`) command
get_ipython().run_line_magic('%foo???', '')
```

---

_Review requested from @MichaReiser by @dhruvmanila on 2023-08-02 18:32_

---

_Review requested from @konstin by @dhruvmanila on 2023-08-02 18:32_

---

_Label `parser` added by @MichaReiser on 2023-08-03 08:23_

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/lexer.rs`:434 on 2023-08-03 08:26_

```suggestion
                    // Check if it's a help magic command. The help magic
                    // command takes priority over any other magic command.
```

What I understand here is that it could now be either, right?

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/lexer.rs`:1442 on 2023-08-03 08:35_

What's the expected output for `????` or any other double question sequence without any content.

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/lexer.rs`:431 on 2023-08-03 08:43_

Would it make sense to have a branch for `?` to avoid the reverse inspection of the just lexed string?

```
			`'?' => {
				let mut question_count = 1u32;
				while self.cursor.eat_char('?') {
					question_count += 1;
				}

				if self.cursor.first == '\n' | '\r' | EOF_CHAR {
					// Decide whether to include the `?` 

					// magic help
				} else {
					// Never mind
					value.reserve(question_count);
					for 0..question_count {
						value.push('?');
					}
				}
			}
```

---

_@MichaReiser reviewed on 2023-08-03 08:43_

I have a few general questions before I feel comfortable reviewing this PR:

> In general,
* The number of question mark on the right side determine if itâ€™s a Help
    or Help2 and if there are more than 2 question mark tokens on the right
    side, then the left side is used to determine the same.
* If the right side is used to determine the kind, then all of the question
    marks on the left side are ignored in the value, but if itâ€™s the other
    way around, then all of the extra question marks are part of the value.

What happens if both left and right have more than two question mark tokens? Is it then always assumed to be `Help2` command? 

I understand that magic help commands must always start with a question mark. I wonder if we could use this information to avoid the *look behind* after lexing a magic command to verify whether it is a help command. What I'm thinking of is to create a new `lex_magic_help(left_kind)` method that you call when the left is either a `?` or `??`. The `LeftKind` is either `Help`, or `Help2` depending on the number of question marks (we can factor out some of the shared magc logic). 

Now, here is where things become unclear to me.  Is `?magic blabla` a regular magic command (not a help command)? 


The implementation can then store the offset before any additional left `?` tokens and call `self.cursor.eat_while(|c| c == '?')`, before starting with the real magic lexing. We can later sue that offset to decide whether we want to include the `?` int he 

---

_Review comment by @konstin on `crates/ruff_python_parser/src/lexer.rs`:446 on 2023-08-03 09:34_

```suggestion
                        [Some('?'), Some(c), _] if c != '?' && !c.is_whitespace() => {
```

---

_@konstin approved on 2023-08-03 09:35_

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/lexer.rs`:434 on 2023-08-03 13:33_

I think this comment is a bit unclear. The official terminology for the help command is "Dynamic object introspection". I'm trying to say if `%foo?` is actually a help command (`?`) (which it is). `?` takes priority over any other magic tokens. So, if we're lexing a magic command (as it started with a magic token) but it ended with either `?` or `??`, then the latter takes precedence.

---

_@dhruvmanila reviewed on 2023-08-03 13:33_

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/lexer.rs`:1442 on 2023-08-03 13:37_

Oh I tested this locally but didn't add it in the test case. We transform it to the way IPython does. Note that the first two `?` is consumed by `MagicKind`:
```rust
Tok::MagicCommand {
    value: "??".to_string(),
    kind: MagicKind::Help2,
}
```

---

_@dhruvmanila reviewed on 2023-08-03 13:37_

---

_@dhruvmanila reviewed on 2023-08-03 13:46_

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/lexer.rs`:431 on 2023-08-03 13:46_

My initial implementation used a branch method but the way I was doing it required some state variables, etc. This implementation looks actually reasonable. Let me check, I think this could be doable.

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/lexer.rs`:434 on 2023-08-04 02:38_

1 because the first char is already `?`, so we'll bump it up.

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/lexer.rs`:444 on 2023-08-04 02:38_

This is for the special case of having only question marks without any content (`????`). Help end magic command is only valid if it's preceded by non question mark / whitespace token.

---

_@dhruvmanila reviewed on 2023-08-04 02:43_

---

_Review requested from @MichaReiser by @dhruvmanila on 2023-08-04 02:44_

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/lexer.rs`:471 on 2023-08-04 06:06_

Nit: We should use `is_python_whitespace` here. Python only allows a subset of the unicode whitespace characters.

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/lexer.rs`:444 on 2023-08-04 06:09_

I would look at the last character in `value` to avoid having to write a state variable with every character (in addition to updating the vector).


```suggestion
                        || value.last().is_some_and(|c| !is_python_whitespace(c))
                        || !matches!(self.cursor.first(), '\n' | '\r' | EOF_CHAR)
```

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/lexer.rs`:442 on 2023-08-04 06:13_

If I understand this correctly, then it is about lexing out all starting question marks? 

Would it make sense to add the logic for eating all leading quotes at the top of `lex_magical_command`?

```rust
self.cursor.eat_while(|c| c == '?');
```

We could even move it to the `lex_magical_command`'s call-site where we matched the `?` if we only need to eat over th leading `?`when the start token is a `?`. So the question is, do we also need to eat over the `?` for `%??abc??` or is this invalid?


---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/lexer.rs`:1415 on 2023-08-04 06:15_

What about `%?foo??` or `%???`

---

_@MichaReiser reviewed on 2023-08-04 06:15_

---

_@MichaReiser reviewed on 2023-08-04 06:16_

We're almost there. I've a proposal on simplifying the `?` branch, but it depends on the exact semantics of help commands.

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/lexer.rs`:442 on 2023-08-05 00:54_

> If I understand this correctly, then it is about lexing out all starting question marks?

No, this is about lexing the _ending_ question marks if present. The terminology is ["help end"](https://github.com/ipython/ipython/blob/292e3a23459ca965b8c1bfe2c3707044c510209a/IPython/core/inputtransformer2.py#L465) magic command to avoid confusion but if you think this is unclear we can rename it?.

> Would it make sense to add the logic for eating all leading quotes at the top of `lex_magical_command`?

I don't think so because we only need to consume it if the magic command has `?` tokens (either 1 or 2) at the end. We won't know this until the cursor is at the end.

---

_@dhruvmanila reviewed on 2023-08-05 00:54_

---

_@dhruvmanila reviewed on 2023-08-05 01:14_

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/lexer.rs`:1415 on 2023-08-05 01:14_

Oh this is interesting and weird. Let me recap and get the semantics verified from the official implementation:

* Only 1 or 2 question marks at the end are valid and considered otherwise whichever token is present at the start is used to determine the `MagicKind`
* If there are 1 or 2 question marks at the end, only the `%`/`%%` token is _included_ in the command value, other magic kind tokens are ignored. But the magic kind will still be `Help`/`Help2` as it's still a priority:
	* `%foo?` -> (`%foo`, `Help`)
	* `!foo?` -> (`foo`, `Help`)
	* `/foo?` -> (`foo`, `Help`)
* Now, here's where things get weird. Looking at your example and remembering that the implementation is a regex:
	* `%?foo??` is a help command with value `foo`. Here, as `%` is followed by `?` it's ignored. On this note, any question mark in the middle will make every character on and before that position being ignored i.e., `%foo?bar?` will be a help command with value `bar` (again, remember it's a regex with captures).
	* `%???` is a magic command (`%`) as there are more than 2 question marks at the end

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/lexer.rs`:1415 on 2023-08-05 01:17_

My main question / concern is what is the correct implementation and should we follow the IPython implementation to the mark? If so, we'll have to make a few small changes to account for the above points.

---

_@dhruvmanila reviewed on 2023-08-05 01:17_

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/Cargo.toml`:18 on 2023-08-07 08:01_

Is the new dependency required because `is_python_whitespace` is now in `ruff_python_trivia`? It may make sense just to copy over the function (private) to avoid cyclic dependencies (ruff_python_trivia has a dev dependency on ruff_python_parser)

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/lexer.rs`:443 on 2023-08-07 08:18_

Does this mean that `??abc ??\n` is a magic command and not a magic help?

Nit:

```suggestion
                        || value.chars().last().map_or(true, is_python_whitespace)
```

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/lexer.rs`:457 on 2023-08-07 08:31_

Nit: Can we add a `as_str` method to `MagicKind` to avoid the potential allocation of `to_string` (I don't know if the compiler is able to see through the whole `format!` logic to know that it returns a static `str`)

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/lexer.rs`:434 on 2023-08-07 08:37_

Lt's use a `u32` here, just to be safe
```suggestion
                    self.cursor.bump();
                    let mut question_count = 1u32;
```

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/lexer.rs`:1415 on 2023-08-07 08:41_

My examples are probably purely artificial. We can decide to ignore them until they get reported. 

---

_@MichaReiser approved on 2023-08-07 08:41_

---

_@MichaReiser reviewed on 2023-08-07 08:42_

---

_Review comment by @MichaReiser on `crates/ruff_python_parser/src/lexer.rs`:441 on 2023-08-07 08:42_

It took me a very long time to understand this part (I even had to make code changes). It may be helpful to add an inline comment with a few code examples of what we're solving here. 

---

_@dhruvmanila reviewed on 2023-08-07 13:45_

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/lexer.rs`:443 on 2023-08-07 13:45_

Help command (`?` / `??`) are just a specific kind of escape command[^1] so they both are the help command just that as there's a whitespace before the ending `??`, the prefixed question marks are used to determine the kind of escape command. This is how it's parsed in IPython as well because the ending question marks are parsed using regex which [isn't allowing any whitespace before the ending question marks](https://github.com/ipython/ipython/blob/292e3a23459ca965b8c1bfe2c3707044c510209a/IPython/core/inputtransformer2.py#L457-L459).

[^1]: I'm going to make some updates into the terminology used across to avoid any future confusion, mainly rename `MagicCommand` to `EscapeCommand` so that `MagicKind::Magic` isn't confusing. This also how it's named in [IPython codebase](https://github.com/ipython/ipython/blob/292e3a23459ca965b8c1bfe2c3707044c510209a/IPython/core/inputtransformer2.py#L329-L346).

---

_@dhruvmanila reviewed on 2023-08-07 13:45_

---

_Review comment by @dhruvmanila on `crates/ruff_python_parser/src/lexer.rs`:441 on 2023-08-07 13:45_

Oh sorry that this was unclear. I'll add some additional comments, references and examples to make it understandable.

---

_Renamed from "Support Help magic command with priority" to "Support help end escape command with priority" by @dhruvmanila on 2023-08-07 14:30_

---

_Merged by @dhruvmanila on 2023-08-07 15:31_

---

_Closed by @dhruvmanila on 2023-08-07 15:31_

---

_Branch deleted on 2023-08-07 15:31_

---
