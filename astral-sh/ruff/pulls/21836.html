<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove `BackwardsTokenizer` based `parenthesized_range` references in `ruff_linter` - astral-sh/ruff #21836</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Remove <code>BackwardsTokenizer</code> based <code>parenthesized_range</code> references in <code>ruff_linter</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21836">#21836</a>
        opened by <a href="https://github.com/denyszhak">@denyszhak</a>
        on 2025-12-08 00:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/denyszhak">@denyszhak</a> on 2025-12-08 00:57</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>ruff_linter now uses optimized version of parenthesized_range on already precomputed tokens instead of generating those over again</p>
<p>Closes #21835</p>
<h2>Test Plan</h2>
<p>Ensured old tests are still successful. If any additional check required please hint the way and I would love to test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @denyszhak on 2025-12-08 00:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/denyszhak">@denyszhak</a> reviewed on 2025-12-08 00:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/denyszhak">@denyszhak</a> on <code>crates/ruff_linter/src/fix/edits.rs</code>:243 on 2025-12-08 00:57</div>
            <div class="timeline-body"><p>I plan to double check on this one</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/denyszhak">@denyszhak</a> reviewed on 2025-12-08 01:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/denyszhak">@denyszhak</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/snapshots/ruff_linter__rules__flake8_type_checking__tests__quoted-type-alias_TC008.py.snap</code>:473 on 2025-12-08 01:00</div>
            <div class="timeline-body"><p>Regression, will take a look at this soon</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-08 01:08</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @AlexWaygood on 2025-12-08 07:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2025-12-08 07:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-12-08 09:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/fix/edits.rs</code>:243 on 2025-12-08 09:44</div>
            <div class="timeline-body"><p>Let's keep using <code>SimpleTokenizer</code> here and only change the usages of <code>parenthesized_ranges</code>. We can look into replacing more usages of <code>SimpleTokenizer</code> in separate PRs.</p>
<p>It's not always trivial to replace <code>SimpleTokenizer</code> because the tokens have slightly different semantics.</p>
<p><code>SimpleTokenizer</code> can also be faster in many cases because it doesn't require a binary search to find the token. Instead, it can examine the first few bytes of the string directly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2025-12-08 09:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> removed by @MichaReiser on 2025-12-08 09:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "fix: ruff_linter uses optimized paranthesized_range" to "Remove `BackwardsTokenizer` based `paranthesized_range` implementation" by @MichaReiser on 2025-12-08 09:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-12-08 09:47</div>
            <div class="timeline-body"><p>Does this allow us to remove the old <code>parenthesized_ranges</code> implementation or are there usages outside <code>ruff_linter</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Remove `BackwardsTokenizer` based `paranthesized_range` implementation" to "Remove `BackwardsTokenizer` based `parenthesized_range` implementation" by @AlexWaygood on 2025-12-08 14:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/denyszhak">@denyszhak</a> on 2025-12-09 03:09</div>
            <div class="timeline-body"><blockquote>
<p>Does this allow us to remove the old <code>parenthesized_ranges</code> implementation or are there usages outside <code>ruff_linter</code>?</p>
</blockquote>
<p>Only 1 place left: <code>needs_line_break</code> under <code>ruff_python_formatter</code> still uses the old implementation. It looks like it's possible to migrate this one as well. Would you like me to do that and remove old implementation or focus purely on ruff_linter?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-12-09 12:06</div>
            <div class="timeline-body"><blockquote>
<p>Only 1 place left: needs_line_break under ruff_python_formatter still uses the old implementation. It looks like it's possible to migrate this one as well. Would you like me to do that and remove old implementation or focus purely on ruff_linter?</p>
</blockquote>
<p>Let's focus on the linter for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Remove `BackwardsTokenizer` based `parenthesized_range` implementation" to "Remove `BackwardsTokenizer` based `parenthesized_range` references in `ruff_linter`" by @MichaReiser on 2025-12-09 12:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/fix/edits.rs</code>:303 on 2025-12-09 12:08</div>
            <div class="timeline-body"><p>Do the call sites become much more awkward if we revert this change too?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-12-09 12:10</div>
            <div class="timeline-body"><p>This looks good. We mainly need to look into the regression</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/denyszhak">@denyszhak</a> reviewed on 2025-12-09 23:55</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/denyszhak">@denyszhak</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/snapshots/ruff_linter__rules__flake8_type_checking__tests__quoted-type-alias_TC008.py.snap</code>:473 on 2025-12-09 23:55</div>
            <div class="timeline-body"><p>@MichaReiser
In <code>quoted_type_alias</code>, the outer-parentheses check needs the original file tokens, but <code>tokens()</code> may point at the parsed-annotation token stream in this context. Is it acceptable to expose <code>source_tokens()</code> directly for this internal use, or is there a preferred way to access the original token stream without widening the public API?
Ultimately, all we need in this context is source token for outer check if we want to use new version, other approaches seem to be less clean.</p>
<p>wdyt?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/denyszhak">@denyszhak</a> reviewed on 2025-12-10 19:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/denyszhak">@denyszhak</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/snapshots/ruff_linter__rules__flake8_type_checking__tests__quoted-type-alias_TC008.py.snap</code>:473 on 2025-12-10 19:53</div>
            <div class="timeline-body"><p>I pushed the change for this one</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @denyszhak on 2025-12-10 23:55</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-12-11 09:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/flake8_type_checking/rules/type_alias_quotes.rs</code>:304 on 2025-12-11 09:00</div>
            <div class="timeline-body"><p>Oh nice find. I think exposing <code>source_tokens</code> here makes sense`</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-12-11 09:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/checkers/ast/mod.rs</code>:440 on 2025-12-11 09:01</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// Returns the [`Tokens`] for the parsed source file.
    /// 
    /// 
    /// Unlike [`Self::tokens`], this method always returns
    /// the tokens for the current file, even when within a parsed type annotation. 
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-12-11 09:04</div>
            <div class="timeline-body"><p>This is great, thank you.</p>
<p>I'll wait for https://github.com/astral-sh/ruff/pull/21895 to land first as this can otherwise lead to panics</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-12-11 12:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-12-11 12:04</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 16:42:35 UTC
    </footer>
</body>
</html>
