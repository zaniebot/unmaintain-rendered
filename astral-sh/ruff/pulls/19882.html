<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] render docstrings in hover - astral-sh/ruff #19882</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] render docstrings in hover</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19882">#19882</a>
        opened by <a href="https://github.com/Gankra">@Gankra</a>
        on 2025-08-12 18:18
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a></div>
            <div class="timeline-body"><p>This PR has several components:</p>
<ul>
<li>Introduce a Docstring String wrapper type that has render_plaintext and render_markdown methods, to force docstring handlers to pick a rendering format<ul>
<li>Implement <a href="https://peps.python.org/pep-0257/">PEP-257</a> docstring trimming for it</li>
<li>The markdown rendering just renders the content in a plaintext codeblock for now (followup work)</li>
</ul>
</li>
<li>Introduce a <code>DefinitionsOrTargets</code> type representing the partial evaluation of <code>GotoTarget::get_definition_targets</code> to ideally stop at getting <code>ResolvedDefinitions</code><ul>
<li>Add <code>declaration_targets</code>, <code>definition_targets</code>, and <code>docstring</code> methods to <code>DefinitionsOrTargets</code> for the 3 usecases we have for this operation</li>
<li><code>docstring</code> is of course the key addition here, it uses the same basic logic that <code>signature_help</code> was using: first check the goto-declaration for docstrings, then check the goto-definition for docstrings.</li>
</ul>
</li>
<li>Refactor <code>signature_help</code> to use the new APIs instead of implementing it itself<ul>
<li>Not fixed in this PR: an issue I found where <code>signature_help</code> will erroneously cache docs between functions that have the same type (hover docs don't have this bug)</li>
</ul>
</li>
<li>A handful of new tests and additions to tests to add docstrings in various places and see which get caught</li>
</ul>
<p>Examples of it working with stdlib, third party, and local definitions:
<img width="597" height="120" alt="Screenshot 2025-08-12 at 2 13 55â€¯PM" src="https://github.com/user-attachments/assets/eae54efd-882e-4b50-b5b4-721595224232" />
<img width="598" height="281" alt="Screenshot 2025-08-12 at 2 14 06â€¯PM" src="https://github.com/user-attachments/assets/5c9740d5-a06b-4c22-9349-da6eb9a9ba5a" />
<img width="327" height="180" alt="Screenshot 2025-08-12 at 2 14 18â€¯PM" src="https://github.com/user-attachments/assets/3b5647b9-2cdd-4c5b-bb7d-da23bff1bcb5" /></p>
<p>Notably modules don't work yet (followup work):
<img width="224" height="83" alt="Screenshot 2025-08-12 at 2 14 37â€¯PM" src="https://github.com/user-attachments/assets/7e9dcb70-a10e-46d9-a85c-9fe52c3b7e7b" /></p>
<p>Notably we don't show docs for an item if you hover its actual definition (followup work, but also, not the most important):
<img width="324" height="69" alt="Screenshot 2025-08-12 at 2 16 54â€¯PM" src="https://github.com/user-attachments/assets/d4ddcdd8-c3fc-4120-ac93-cefdf57933b4" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @Gankra on 2025-08-12 18:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @Gankra on 2025-08-12 18:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @Gankra on 2025-08-12 18:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @Gankra on 2025-08-12 18:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @Gankra on 2025-08-12 18:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @Gankra on 2025-08-12 18:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @Gankra on 2025-08-12 18:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-12 18:19</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<details>
<summary>Changes were detected when running ty on typing conformance tests</summary>

<pre><code class="language-diff">--- old-output.txt	2025-08-13 14:57:30.986477337 +0000
+++ new-output.txt	2025-08-13 14:57:31.053477542 +0000
@@ -1,5 +1,5 @@
 WARN ty is pre-release software and not ready for production use. Expect to encounter bugs, missing features, and fatal errors.
-fatal[panic] Panicked at /home/runner/.cargo/git/checkouts/salsa-e6f3bb7c2a062968/918d35d/src/function/execute.rs:215:25 when checking `/home/runner/work/ruff/ruff/typing/conformance/tests/aliases_typealiastype.py`: `infer_definition_types(Id(b5023)): execute: too many cycle iterations`
+fatal[panic] Panicked at /home/runner/.cargo/git/checkouts/salsa-e6f3bb7c2a062968/918d35d/src/function/execute.rs:215:25 when checking `/home/runner/work/ruff/ruff/typing/conformance/tests/aliases_typealiastype.py`: `infer_definition_types(Id(244b3)): execute: too many cycle iterations`
 _directives_deprecated_library.py:15:31: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `int`
 _directives_deprecated_library.py:30:26: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `str`
 _directives_deprecated_library.py:36:41: error[invalid-return-type] Function always implicitly returns `None`, which is not assignable to return type `Self@__add__`
</code></pre>
</details>

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-12 18:22</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…
No memory usage changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-08-12 18:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/hover.rs</code>:332 on 2025-08-12 18:28</div>
            <div class="timeline-body"><p>This result is a disappointment but a pre-existing issue that we don't really distinguish a class from an invocation of the initializer (future work).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-08-12 18:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/hover.rs</code>:541 on 2025-08-12 18:29</div>
            <div class="timeline-body"><p>This doesn't change the result at all but I changed this test in case one day our hover gets smart enough to see and render these docs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-08-12 18:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/hover.rs</code>:580 on 2025-08-12 18:30</div>
            <div class="timeline-body"><p>Similarly this doesn't change anything, but I added docs just in case something got smarter</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-08-12 18:31</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/hover.rs</code>:624 on 2025-08-12 18:31</div>
            <div class="timeline-body"><p>Future work, this should render eventually.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-08-12 18:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/hover.rs</code>:666 on 2025-08-12 18:33</div>
            <div class="timeline-body"><p>This one's even worse and produces no result because apparently hovering an import doesn't yield the module (even though I fixed goto-def on it in a previous PR). I assume this is because hover currently insists it needs the type of the hovered item, not the def/decl.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-08-12 18:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/hover.rs</code>:977 on 2025-08-12 18:34</div>
            <div class="timeline-body"><p>Another &quot;maybe one day&quot; change</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/docstring.rs</code>:81 on 2025-08-13 07:33</div>
            <div class="timeline-body"><p>I know this is pre-existing code, so I'm fine deferring it but I wonder if it makes sense to short-circuit if we parsed parameters by at least one style because most code will only use one convention.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/docstring.rs</code>:133 on 2025-08-13 07:38</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    // (all python whitespace is ascii so we can just remove that many bytes from the front).
</code></pre>
<p>I found this comment slightly confusing because whitespace in strings can be unicode whitespace. It's only whitespace in indentations (and between expressions etc) that are all ASCII</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/docstring.rs</code>:96 on 2025-08-13 07:40</div>
            <div class="timeline-body"><p>Yay, our second implementation of this algorithm (it makes sense for them to be different):</p>
<p>https://github.com/astral-sh/ruff/blob/9ae698fe30cf3526f0e7ae237b800b3ed19a819f/crates/ruff_python_formatter/src/string/docstring.rs#L27-L114</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/goto.rs</code>:187 on 2025-08-13 07:43</div>
            <div class="timeline-body"><p>Nit: The stub mapper type still feels a bit overkill to me. It feels like it could easily be replaced by an enum with two variants (map, don't map) and a method (that takes <code>db</code> as an argument) that does the mapping.</p>
<p>Maybe something for a follow up PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/goto.rs</code>:154 on 2025-08-13 07:45</div>
            <div class="timeline-body"><p>Could you add some documentation to these two variants. Without digging through <code>ResolvedDefinition</code> and <code>NavigationTargets</code>, it was hard to understand what each represents (and I did such a bad job to not document <code>NavigationTargets</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/hover.rs</code>:104 on 2025-08-13 07:53</div>
            <div class="timeline-body"><p>My idea behind making <code>HoverContent</code> an enum was that a <code>Hover</code> can be made up out of different building blocks where each building block knows how to render itself. A docstring could be such a building block and so is <code>Type</code>. Following that idea, I'd probably make <code>Docstring</code> its own enum variant. However, I'm not sure if what I had in mind back then does scale well and it heavily depends on how tightly the rendering is coupled between and maybe it's best if collapse <code>HoverContent</code> into <code>Hover</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/hover.rs</code>:136 on 2025-08-13 07:54</div>
            <div class="timeline-body"><p>Nit: Would it make sense for <code>docstring</code> to have a <code>render(MarkupKind)</code> method instead. It seems that would fit nicer together with <code>MarkupKind</code> and also allows to use the <code>fenced_code_block</code> helper</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-08-13 07:57</div>
            <div class="timeline-body"><p>This is excellent. Thank you for working on this. I only have a few detail comments that are at your own discretion.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-08-13 14:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/goto.rs</code>:187 on 2025-08-13 14:35</div>
            <div class="timeline-body"><p>I agree, I have several followup refactors planned here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/docstring.rs</code>:81 on 2025-08-13 14:39</div>
            <div class="timeline-body"><p>We actually have a test checked in for the mixed behaviour, so i guess @UnboundVariable thought it was something that we'll see in the wild?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-08-13 14:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/Gankra">@Gankra</a> on <code>crates/ty_ide/src/docstring.rs</code>:96 on 2025-08-13 14:40</div>
            <div class="timeline-body"><p>In retrospect I really should have checked because of course we do ðŸ˜“</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> reviewed on 2025-08-13 14:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @Gankra on 2025-08-13 14:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @Gankra on 2025-08-13 14:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-13 14:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:15:01 UTC
    </footer>
</body>
</html>
