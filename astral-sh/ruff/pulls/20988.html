<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Fall back to `Divergent` for deeply nested specializations - astral-sh/ruff #20988</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Fall back to <code>Divergent</code> for deeply nested specializations</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20988">#20988</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-10-20 10:40
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Fall back to <code>C[Divergent]</code> if we are trying to specialize <code>C[T]</code> with a type that itself already contains deeply nested specialized generic classes. This is a way to prevent infinite recursion for cases like <code>self.x = [self.x]</code> where type inference for the implicit instance attribute would not converge.</p>
<p>closes https://github.com/astral-sh/ty/issues/1383
closes https://github.com/astral-sh/ty/issues/837</p>
<h2>Test Plan</h2>
<p>Regression tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @sharkdp on 2025-10-20 10:40</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-10-20 12:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @sharkdp on 2025-10-20 12:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-10-20 13:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/class.rs</code>:1623 on 2025-10-20 13:03</div>
            <div class="timeline-body"><p>This still needs to be fine-tuned (using ecosystem impact and benchmarks).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-10-20 13:04</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/class.rs</code>:1635 on 2025-10-20 13:04</div>
            <div class="timeline-body"><p>I haven't understood the <code>scope</code> parameter of <code>Type::Divergent</code>. When we see an infinitely wrapped <code>list[list[list[‚Ä¶]]]</code> in a method of class <code>C</code>, is it still correct to set the scope parameter to the body scope of <code>list</code> (not of <code>C</code> or the method) here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @sharkdp on 2025-10-20 13:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-10-20 13:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-10-20 13:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @sharkdp on 2025-10-20 13:07</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-10-20 14:56</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @sharkdp on 2025-10-20 14:56</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-20 14:58</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ‚úÖ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-20 15:00</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ‚úÖ
No memory usage changes detected ‚úÖ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mtshiba">@mtshiba</a> reviewed on 2025-10-20 17:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mtshiba">@mtshiba</a> on <code>crates/ty_python_semantic/src/types/class.rs</code>:1635 on 2025-10-20 17:02</div>
            <div class="timeline-body"><p>Your use of <code>Divergent</code> in this PR seems to differ slightly from the original intended use. The intended use is to make functions with the potential for divergent type inference tracked, and to set the initial cycle value to <code>Divergent</code> instead of <code>Never</code>. If the resulting type contains <code>Divergent</code>, replace that type with <code>Divergent</code> itself to converge the inference.</p>
<p>https://github.com/astral-sh/ruff/pull/17371/files#diff-20b910c6e20faa962bb1642e111db1cbad8e66ace089bdd966ac9d7f9fa99ff2R649-R665</p>
<p>When I first introduced <code>Divergent</code> in #20312, I included <code>scope</code> to prevent <code>Divergent</code> from propagating to other types of inference. This was based on the use case in #17371.</p>
<p>https://github.com/astral-sh/ruff/pull/17371/commits/e3b896df046afbea1674c302617f44ac2ea9cda8#diff-fdebb876f3c3f16730728018e4b1223f844d9493cd7caa7ee94e4a7a7b02184f</p>
<p><code>call_divergent</code> calls <code>divergent</code>, but it does not diverge itself. Knowing where the divergence occurs can help prevent excessive type replacement.</p>
<p>#20333 and #20359 may also be helpful in understanding <code>Divergent</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-10-20 17:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by @sharkdp on 2025-10-20 17:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @sharkdp on 2025-10-21 07:50</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-21 07:56</div>
            <div class="timeline-body"><!-- generated-comment ty ecosystem-analyzer -->

<h2><code>ecosystem-analyzer</code> results</h2>
<p>No diagnostic changes detected ‚úÖ
<strong><a href="https://david-fix-1383.ecosystem-663.pages.dev/diff">Full report with detailed diff</a></strong> (<a href="https://david-fix-1383.ecosystem-663.pages.dev/timing">timing results</a>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> removed by @sharkdp on 2025-10-21 08:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @sharkdp on 2025-10-21 08:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @sharkdp on 2025-10-21 08:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> removed by @sharkdp on 2025-10-21 10:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @sharkdp on 2025-10-21 10:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> removed by @sharkdp on 2025-10-21 10:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @sharkdp on 2025-10-21 10:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-10-21 10:42</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/david%2Ffix-1383?utm_source=github&amp;utm_medium=comment&amp;utm_content=header">CodSpeed Performance Report</a></h2>
<h3>Merging #20988 will <strong>degrade performances by 4.99%</strong></h3>
<p><sub>Comparing <code>david/fix-1383</code> (438706a) with <code>main</code> (2c94337)</sub></p>
<h3>Summary</h3>
<p><code>‚ùå 2 (üëÅ 2)</code> regressions<br />
<code>‚úÖ 19</code> untouched<br />
<code>‚è© 30</code> skipped[^skipped]</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Mode | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | ---- | --------- | ------ | ------ | ------ |
| üëÅ | WallTime | <a href="https://codspeed.io/astral-sh/ruff/branches/david%2Ffix-1383?uri=crates%2Fruff_benchmark%2Fbenches%2Fty_walltime.rs%3A%3Amedium%5Bpandas%5D&amp;runnerMode=WallTime&amp;utm_source=github&amp;utm_medium=comment&amp;utm_content=benchmark"><code>medium[pandas]</code></a> | 32.6 s | 34 s | -4.11% |
| üëÅ | WallTime | <a href="https://codspeed.io/astral-sh/ruff/branches/david%2Ffix-1383?uri=crates%2Fruff_benchmark%2Fbenches%2Fty_walltime.rs%3A%3Amedium%5Bstatic-frame%5D&amp;runnerMode=WallTime&amp;utm_source=github&amp;utm_medium=comment&amp;utm_content=benchmark"><code>medium[static-frame]</code></a> | 8.7 s | 9.2 s | -4.99% |
[^skipped]: 30 benchmarks were skipped, so the baseline results were used instead. If they were deleted from the codebase, <a href="https://codspeed.io/astral-sh/ruff/branches/david%2Ffix-1383?sectionId=benchmark-comparison-section-baseline-result-skipped&amp;utm_source=github&amp;utm_medium=comment&amp;utm_content=archive">click here and archive them to remove them from the performance reports</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @sharkdp on 2025-10-21 11:51</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-10-21 14:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/class.rs</code>:1635 on 2025-10-21 14:59</div>
            <div class="timeline-body"><p>I currently don't see how that approach scales. We would need to add dedicated &quot;turn this type into <code>Divergent</code> if it contains <code>Divergent</code>&quot; logic everywhere. We can do this for tuples, but we also need to do it for sets, lists, and dicts. And it doesn't really stop with those syntactical constructs. What about something like</p>
<pre><code class="language-py">from typing import TypeVar, Literal

T = TypeVar(&quot;T&quot;)

def make_tuple(a: T) -&gt; tuple[T, Literal[1]]:
    return (a, 1)

class D:
    def f(self, other: &quot;D&quot;):
        self.x = make_tuple(other.x)

reveal_type(D().x)
</code></pre>
<p>Do we also specialize all call expressions to detect nested <code>Divergent</code> types? At that point, we could probably add it to <code>infer_expression_type</code> (and in fact, that might work, but done naively, we would get <code>Divergent</code> instead of <code>tuple[Divergent, ‚Ä¶]</code> etc).</p>
<p>What I'm proposing here is certainly not very elegant, I agree. But it does solve all of these cases (and more) without any special casing to certain syntactical forms.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> removed by @sharkdp on 2025-10-21 15:18</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @sharkdp on 2025-10-21 15:18</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-21 16:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/visitor.rs</code>:377 on 2025-10-21 16:12</div>
            <div class="timeline-body"><p>Would that mean that we also fall back to <code>DIVERGENT</code> for cases where a user combines complex types, but without any fixpoint involved?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/visitor.rs</code>:308 on 2025-10-21 16:13</div>
            <div class="timeline-body"><p>This is a very helpful comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-10-21 16:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-21 16:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/visitor.rs</code>:360 on 2025-10-21 16:15</div>
            <div class="timeline-body"><p>nit: derive <code>Default</code>? then this could be</p>
<pre><code class="language-suggestion">    let visitor = SpecializationDepthVisitor::default();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-21 16:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/visitor.rs</code>:322 on 2025-10-21 16:16</div>
            <div class="timeline-body"><p>can you optimize and return early here, avoiding the <code>match</code> entirely, if <code>self.max_depth == usize::MAX</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/visitor.rs</code>:386 on 2025-10-21 16:22</div>
            <div class="timeline-body"><p>I'd be tempted to define some helpers to make this test more readable, e.g.</p>
<pre><code class="language-diff">diff --git a/crates/ty_python_semantic/src/types/visitor.rs b/crates/ty_python_semantic/src/types/visitor.rs
index d3f848dbbd..9644c932c1 100644
--- a/crates/ty_python_semantic/src/types/visitor.rs
+++ b/crates/ty_python_semantic/src/types/visitor.rs
@@ -388,62 +388,45 @@ mod tests {
     fn test_generics_layering_depth() {
         let db = setup_db();
 
-        let list_of_int =
-            KnownClass::List.to_specialized_instance(&amp;db, [KnownClass::Int.to_instance(&amp;db)]);
+        let int = || KnownClass::Int.to_instance(&amp;db);
+        let list = |element| KnownClass::List.to_specialized_instance(&amp;db, [element]);
+        let dict = |key, value| KnownClass::Dict.to_specialized_instance(&amp;db, [key, value]);
+        let set = |element| KnownClass::Set.to_specialized_instance(&amp;db, [element]);
+        let str = || KnownClass::Str.to_instance(&amp;db);
+        let bytes = || KnownClass::Bytes.to_instance(&amp;db);
+        let union = |elements| UnionType::from_elements(&amp;db, elements);
+
+        let list_of_int = list(int());
         assert_eq!(specialization_depth(&amp;db, list_of_int), 1);
 
-        let list_of_list_of_int = KnownClass::List.to_specialized_instance(&amp;db, [list_of_int]);
+        let list_of_list_of_int = list(list_of_int);
         assert_eq!(specialization_depth(&amp;db, list_of_list_of_int), 2);
 
-        let list_of_list_of_list_of_int =
-            KnownClass::List.to_specialized_instance(&amp;db, [list_of_list_of_int]);
+        let list_of_list_of_list_of_int = list(list_of_list_of_int);
         assert_eq!(specialization_depth(&amp;db, list_of_list_of_list_of_int), 3);
 
-        let set_of_dict_of_str_and_list_of_int = KnownClass::Set.to_specialized_instance(
-            &amp;db,
-            [KnownClass::Dict
-                .to_specialized_instance(&amp;db, [KnownClass::Str.to_instance(&amp;db), list_of_int])],
-        );
+        let set_of_dict_of_str_and_list_of_int = set(dict(str, list_of_int));
         assert_eq!(
             specialization_depth(&amp;db, set_of_dict_of_str_and_list_of_int),
             3
         );
 
-        let union_type_1 =
-            UnionType::from_elements(&amp;db, [list_of_list_of_list_of_int, list_of_list_of_int]);
+        let union_type_1 = union([list_of_list_of_list_of_int, list_of_list_of_int]);
         assert_eq!(specialization_depth(&amp;db, union_type_1), 3);
 
-        let union_type_2 =
-            UnionType::from_elements(&amp;db, [list_of_list_of_int, list_of_list_of_list_of_int]);
+        let union_type_2 = union([list_of_list_of_int, list_of_list_of_list_of_int]);
         assert_eq!(specialization_depth(&amp;db, union_type_2), 3);
 
-        let tuple_of_tuple_of_int = Type::heterogeneous_tuple(
-            &amp;db,
-            [Type::heterogeneous_tuple(
-                &amp;db,
-                [KnownClass::Int.to_instance(&amp;db)],
-            )],
-        );
+        let tuple_of_tuple_of_int =
+            Type::heterogeneous_tuple(&amp;db, [Type::heterogeneous_tuple(&amp;db, [int()])]);
         assert_eq!(specialization_depth(&amp;db, tuple_of_tuple_of_int), 2);
 
-        let tuple_of_list_of_int_and_str = KnownClass::Tuple
-            .to_specialized_instance(&amp;db, [list_of_int, KnownClass::Str.to_instance(&amp;db)]);
+        let tuple_of_list_of_int_and_str =
+            KnownClass::Tuple.to_specialized_instance(&amp;db, [list_of_int, str()]);
         assert_eq!(specialization_depth(&amp;db, tuple_of_list_of_int_and_str), 1);
 
-        let list_of_union_of_lists = KnownClass::List.to_specialized_instance(
-            &amp;db,
-            [UnionType::from_elements(
-                &amp;db,
-                [
-                    KnownClass::List
-                        .to_specialized_instance(&amp;db, [KnownClass::Int.to_instance(&amp;db)]),
-                    KnownClass::List
-                        .to_specialized_instance(&amp;db, [KnownClass::Str.to_instance(&amp;db)]),
-                    KnownClass::List
-                        .to_specialized_instance(&amp;db, [KnownClass::Bytes.to_instance(&amp;db)]),
-                ],
-            )],
-        );
+        let list_of_union_of_lists = list(union([list(int()), list(str()), list(bytes())]));
+
         assert_eq!(specialization_depth(&amp;db, list_of_union_of_lists), 2);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/visitor.rs</code>:430 on 2025-10-21 16:22</div>
            <div class="timeline-body"><p>Should this be <code>Type::homogeneous_tuple()</code> rather than <code>KnownClass::Tuple.to_instance()</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-21 16:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> removed by @sharkdp on 2025-10-21 18:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @sharkdp on 2025-10-21 18:04</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> removed by @sharkdp on 2025-10-21 18:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @sharkdp on 2025-10-21 18:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-10-21 18:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/visitor.rs</code>:430 on 2025-10-21 18:25</div>
            <div class="timeline-body"><p>Yes. I actually fell into this trap where I thought I could just run <code>KnownClass::Tuple.to_specialized_instance(‚Ä¶)</code> to get a <code>tuple</code> type. I don't know <em>what</em> it generates, but it's not a tuple, apparently. Maybe we should prevent other developers from doing that by adding some kind of check?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/visitor.rs</code>:430 on 2025-10-21 18:35</div>
            <div class="timeline-body"><p>Yes, some kind of debug assertion in <code>.to_instance()</code> that checks you're not trying to create a tuple type using that method would probably be great</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-21 18:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/visitor.rs</code>:377 on 2025-10-21 18:35</div>
            <div class="timeline-body"><p>That is the &quot;not so elegant&quot; part of this PR, exactly. But 10 already seems to be deep enough not to cause any ecosystem changes here. Well, that's a bit hard to tell, of course, because <code>Divergent</code> acts like a dynamic type. But I <em>did</em> see changes when the limit was too low (or rather: when I was accidentally computing depths that were too large). Because introducing dynamic types all over the place typically leads to a reduction of diagnostics.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-10-21 18:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mtshiba">@mtshiba</a> reviewed on 2025-10-22 03:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mtshiba">@mtshiba</a> on <code>crates/ty_python_semantic/src/types/class.rs</code>:1635 on 2025-10-22 03:15</div>
            <div class="timeline-body"><p>I don't actually think it's necessary to apply this logic everywhere. That's work in progress in #20566.</p>
<p>The only place where this logic needs to be applied is within tracked functions that may diverge (e.g. <code>implicit_attribute_inner</code>, <code>infer_expression_type_impl</code>). That means that a <code>Divergent</code>-type suppression needs to be performed by the end of a cycle, and it would be most natural to do this at the end of the tracked function. Other places, such as <code>infer_tuple_expression</code>, don't actually need this logic. In fact, it's been removed in https://github.com/astral-sh/ruff/pull/20566/files#diff-5ade3020ce233d81ee50c1ec2debd673afc8ba08ede8ec664ca62e62aefbb2f7L5273-L5279, https://github.com/astral-sh/ruff/pull/20566/files#diff-411da1a5c9e0560d6b43091ca27247357a1e94a9077f9adb2cd6a23f495578b6L24-L28.</p>
<p>cc (as author of #20333, etc.): @carljm</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by @sharkdp on 2025-10-22 09:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-10-22 11:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/visitor.rs</code>:322 on 2025-10-22 11:11</div>
            <div class="timeline-body"><p>We probably could, but the <code>self.max_depth == usize::MAX</code> cases are hopefully <em>not</em> what we need to optimize for. It's not important that this is extremely fast for (too) deeply nested generic types. But it is important that this is fast for literally everything else.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-22 11:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/visitor.rs</code>:322 on 2025-10-22 11:14</div>
            <div class="timeline-body"><p>Thanks, that's helpful. It might be good to put that in a comment (that this &quot;optimization&quot; could actually be a pessimisation) -- I'm used to seeing that kind of &quot;return early&quot; clause in ad-hoc AST visitors like this that we write for Ruff rules, and was surprised not to see it here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/visitor.rs</code>:430 on 2025-10-22 11:16</div>
            <div class="timeline-body"><p>For posterity: we did this in https://github.com/astral-sh/ruff/pull/21027</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-22 11:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-10-22 11:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/class.rs</code>:1635 on 2025-10-22 11:26</div>
            <div class="timeline-body"><p>I had completely missed https://github.com/astral-sh/ruff/pull/20566 ‚Äî thank you for the reference. It looks like that still requires adding divergent-handling in lots of places, but I'm certainly not opposed to that. I would very much like there to be a more principled solution.</p>
<p>My problem is that I want something that fixes these panics <em>now</em> (to finally merge the type-of-<code>self</code> PR). I rolled back most of the changes here to leave the <code>CycleRecovery</code> setup intact and to be less invasive. I am proposing that we merge this PR to solve the immediate problem, and I'll be happy to remove all of this once we have a better solution (that still solves all of the test cases that are introduced in this PR).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/visitor.rs</code>:322 on 2025-10-22 11:27</div>
            <div class="timeline-body"><p>It looks like we'll soon remove all of this code anyway, so I'll leave it as is for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-10-22 11:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @sharkdp on 2025-10-22 11:27</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/visitor.rs</code>:375 on 2025-10-22 11:33</div>
            <div class="timeline-body"><p>10 does feel quite conservative here. My instinct would be to go with something a <em>bit</em> larger (32?) if it's possible. But it also probably doesn't matter that much if we're planning to get rid of this soon anyway. This is probably fine for a stopgap measure.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-10-22 11:33</div>
            <div class="timeline-body"><p>Thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> removed by @sharkdp on 2025-10-22 11:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ecosystem-analyzer</span> added by @sharkdp on 2025-10-22 11:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_python_semantic/src/types/generics.rs</code>:1275 on 2025-10-22 11:39</div>
            <div class="timeline-body"><p>Nit: I don't think this assertion is necessary. Rust always panics on out of bound index (even in release builds as not doing so would be UB)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-10-22 11:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/visitor.rs</code>:375 on 2025-10-22 11:39</div>
            <div class="timeline-body"><p>I made it 32 for now. I think we can only really fine-tune it once we combine this with type-of-<code>self</code>, which introduces those cases. I was worried that there are examples like</p>
<pre><code class="language-py">from typing import Self

def duplicate[T](x: T) -&gt; tuple[T, T]:
    return (x, x)

class C:
    def f(self: Self):
        self.x = duplicate(self.x)

reveal_type(C().x)
</code></pre>
<p>where the type expands <em>in breadth</em> exponentially at each layer.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-10-22 11:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-10-22 11:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/visitor.rs</code>:375 on 2025-10-22 11:46</div>
            <div class="timeline-body"><p>Actually, I'm setting it back to 14, because that seems to be at the edge of what we can still handle in that particular scenario. I added this as a test case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-22 11:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/visitor.rs</code>:375 on 2025-10-22 11:47</div>
            <div class="timeline-body"><p>Thanks for trying it out</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mtshiba">@mtshiba</a> reviewed on 2025-10-22 11:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mtshiba">@mtshiba</a> on <code>crates/ty_python_semantic/src/types/class.rs</code>:1635 on 2025-10-22 11:49</div>
            <div class="timeline-body"><p>Yes, as I said <a href="https://github.com/astral-sh/ruff/pull/20566#issuecomment-3431449139">here</a>, I'm in favor of provisionally merging the PR  anyway; the lack of self types means that a lot of recursive type inference is hidden by dynamic types.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-10-22 11:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/visitor.rs</code>:375 on 2025-10-22 11:51</div>
            <div class="timeline-body"><p>And here's an example of a case that we &quot;can't handle&quot; anymore with this PR (in the sense that we would lose precise type inference for that dict): https://play.ty.dev/e9b94a3d-704c-4078-90fc-ed9915cfb5e7</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-10-22 12:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_python_semantic/src/types/class.rs</code>:1635 on 2025-10-22 12:17</div>
            <div class="timeline-body"><p>Thank you for chiming in here, very much appreciated!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-10-22 12:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-10-22 12:29</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-10-22 12:29</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:16:34 UTC
    </footer>
</body>
</html>
