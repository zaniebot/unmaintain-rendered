```yaml
number: 15373
title: "[`ruff`] Stop parsing diagnostics from other sources for code action requests"
type: pull_request
state: merged
author: joouha
labels:
  - bug
  - server
assignees: []
merged: true
base: main
head: parse-own-diagnostics
created_at: 2025-01-09T12:22:39Z
updated_at: 2025-01-09T13:38:13Z
url: https://github.com/astral-sh/ruff/pull/15373
synced_at: 2026-01-10T20:34:00Z
```

# [`ruff`] Stop parsing diagnostics from other sources for code action requests

---

_Pull request opened by @joouha on 2025-01-09 12:22_

### Summary

This PR stops `ruff server` attempting to parse diagnostic data for diagnostics from other language servers.

### The issue

When using `ruff server` with [`typos-lsp`](https://github.com/tekumara/typos-lsp) in [`helix`](https://github.com/helix-editor/helix), it is impossible to apply code actions suggested by `typos-lsp`. 

### The cause

During a [`textDocument/codeAction`](https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocument_codeAction) request, the editor will send [`Diagnostic`]()s to `ruff server` as part of the [`codeActionContext`](https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#codeActionContext) - these may have been generated by other LSP servers.

According to the spec, the `Diagnostic.data` field can contain any data. However, `ruff server` attempts to parse all contextual diagnostics, and assumes the `data` field adheres to the data structure used by `ruff server`. 

Since other language servers are free to use their own data structure, parsing the diagnostics fails causing an error, which ultimately causes the code action request to fail.

### The fix

On code action requests, `ruff server` should only parse contextual diagnostics generated by `ruff server`.




---

_Comment by @github-actions[bot] on 2025-01-09 12:28_

<!-- generated-comment ecosystem -->
## `ruff-ecosystem` results
### Linter (stable)
✅ ecosystem check detected no linter changes.

### Linter (preview)
✅ ecosystem check detected no linter changes.




---

_Label `server` added by @MichaReiser on 2025-01-09 12:56_

---

_Label `bug` added by @MichaReiser on 2025-01-09 12:56_

---

_@MichaReiser approved on 2025-01-09 12:57_

Nice. Interesting that the client sends all known Diagnostic but that sort of makes sense.

---

_Merged by @MichaReiser on 2025-01-09 13:38_

---

_Closed by @MichaReiser on 2025-01-09 13:38_

---
