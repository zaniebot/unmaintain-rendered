<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Refactor inlay hints structure to use separate parts - astral-sh/ruff #20052</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Refactor inlay hints structure to use separate parts</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20052">#20052</a>
        opened by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a>
        on 2025-08-22 21:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a></div>
            <div class="timeline-body">

Summary
<p>Our internal inlay hints structure (<code>ty_ide::InlayHint</code>) now more closely resembles <code>lsp_types::InlayHint</code>.</p>
<p>This mainly allows us to convert to <code>lsp_types::InlayHint</code> with less hassle, but it also allows us to manage the different parts of the inlay hint better, which in the future will allow us to implement features like goto on the type part of the type inlay hint.</p>
<p>It also really isn&#x27;t important to store a specific <code>Type</code> instance in the <code>InlayHintContent</code>. So we remove this and use <code>InlayHintLabel</code> instead which just shows the representation of the type (along with other information).</p>
<p>We see a similar structure used in rust-analyzer too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-08-22 21:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-08-22 21:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-08-22 21:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-08-22 21:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-08-22 21:24</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-08-22 21:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-22 21:24</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/AlexWaygood">@AlexWaygood</a> removed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-22 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Refactor inlay hints&quot; to &quot;[ty] Refactor ty_ide inlay hints&quot; by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-08-22 21:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-08-22 21:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/ty_server/tests/e2e/inlay_hints.rs</code>:45 on 2025-08-22 21:30</div>
            <div class="timeline-body"><p>These change because we now use <code>InlayHintLabel::LabelParts</code> instead of <code>InlayHintLabel::String</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-22 21:30</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-22 21:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-22 21:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/carljm">@carljm</a> removed by <a href="https://github.com/carljm">@carljm</a> on 2025-08-22 23:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/carljm">@carljm</a> on 2025-08-22 23:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-08-22 23:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/ty_ide/src/inlay_hints.rs</code>:24 on 2025-08-22 23:35</div>
            <div class="timeline-body"><p>This is roughly how rust analyzer does it and we need to separate these for the goto targets</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-08-22 23:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-08-22 23:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/ty_ide/src/inlay_hints.rs</code>:58 on 2025-08-22 23:36</div>
            <div class="timeline-body"><p>I think i should change this to 2. @MichaReiser would you agree?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-08-22 23:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/ty_ide/src/inlay_hints.rs</code>:58 on 2025-08-22 23:37</div>
            <div class="timeline-body"><p>ive done it, i think it makes sense for us.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-08-22 23:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/ty_ide/src/inlay_hints.rs</code>:58 on 2025-08-22 23:42</div>
            <div class="timeline-body"><p>ah okay in this situation we only use 1 of the <code>InlayHintLabelPart</code>, but when we add the goto, we will use 2.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-08-22 23:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-23 12:33</div>
            <div class="timeline-body"><p>Could you extend the summary? I think I&#x27;ve an idea why we may want this but I&#x27;d rather be sure (and documenting this will also help a future reader who comes across this PR and wonders why it works the way it does)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-08-23 12:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/inlay_hints.rs</code>:58 on 2025-08-23 12:37</div>
            <div class="timeline-body"><p>I think it makes sense today because all our usages have exactly two parts. But it&#x27;s hard to tell, depending on how you plan to use this going forward.</p>
<p>A too-large number has the downside that <code>InlayHintLabel</code> becomes larger overall, wasting memory when we only need to store 1 or more than two elements. This is especially problematic if we create many <code>InlayHintLabel</code>s. I don&#x27;t think this is a big concern here.</p>
<p>I&#x27;m not even sure if it&#x27;s worth using a <code>SmallVec</code> here. We&#x27;ll need to serialize all that data later on, we might as well just store a Vec</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-08-24 18:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/ty_ide/src/inlay_hints.rs</code>:58 on 2025-08-24 18:53</div>
            <div class="timeline-body"><p>Currently because we don&#x27;t use the <code>target</code> variable in <code>InlayHintLabel</code>. This means we just have one <code>part</code> so we will only use one of the elements in the small vec.</p>
<p>I&#x27;ll change to vec for now anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_ide/src/inlay_hints.rs</code>:20 on 2025-08-25 08:00</div>
            <div class="timeline-body"><p>I think it&#x27;d be useful to add basic documentation for all the <code>pub</code> items in this module.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_ide/src/inlay_hints.rs</code>:61 on 2025-08-25 08:03</div>
            <div class="timeline-body"><p>I think <code>simple</code> sounds confusing, what does simple mean in the context of <code>InlayHintLabel</code>? Based on my other suggestion to introduce <code>with_target</code> for <code>InlayHintLabelPart</code>, we could rename this to <code>single(part: InlayHintLabelPart)</code> and let the caller construct the <code>InlayHintLabelPart</code> or just a <code>new(parts: Vec&lt;InlayHintLabelPart&gt;</code>) as <code>InlayHintLabelPart</code> is a public type.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_ide/src/inlay_hints.rs</code>:58 on 2025-08-25 08:04</div>
            <div class="timeline-body"><p>Are you thinking of expanding <code>InlayHintLabel</code> with additional fields in the future?</p>
<p>Regardless, I think the <code>parts</code> field should be private and we should expose this information via a method that returns <code>&amp;[InlayHintLabelPart]</code> instead.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_ide/src/inlay_hints.rs</code>:73 on 2025-08-25 08:05</div>
            <div class="timeline-body"><p>At first, I thought that the catch-all branch is for the empty vector (<code>[]</code>) but I don&#x27;t think that&#x27;s true, the branch that isn&#x27;t covered here is an <code>InlayHintLabelPart</code> where <code>target</code> is <code>Some</code>. Can you expand on why does the string needs to be added only when navigation target is not present? Based on the method name, I would expect this to add the string regardless of whether target is present or not.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_ide/src/inlay_hints.rs</code>:86 on 2025-08-25 08:08</div>
            <div class="timeline-body"><p>Same question as above, why should this append string only when navigation target is not present?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_ide/src/inlay_hints.rs</code>:129 on 2025-08-25 08:11</div>
            <div class="timeline-body"><p>I would recommend to keep the field private and expose methods to provide the information.</p>
<p>Additionally, I think we should have a <code>From&lt;&amp;str&gt;</code> / <code>From&lt;String&gt;</code> / <code>new(text: String)</code> implementation for <code>InlayHintLabelPart</code> and use builder pattern for the target like <code>with_target</code> because it&#x27;s optional.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_ide/src/inlay_hints.rs</code>:107 on 2025-08-25 08:17</div>
            <div class="timeline-body"><p>Let&#x27;s keep the <code>inlay_hint</code> field private, I don&#x27;t think we need to expose it publicly.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-08-25 08:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Assigned to <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-08-25 08:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-08-25 10:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/ty_ide/src/inlay_hints.rs</code>:20 on 2025-08-25 10:03</div>
            <div class="timeline-body"><p>I&#x27;ll try to make more things private</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/ty_ide/src/inlay_hints.rs</code>:129 on 2025-08-25 10:21</div>
            <div class="timeline-body"><p>going to leave the <code>with_target</code> method for now as we don&#x27;t use it yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-08-25 10:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-08-25 10:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/ty_ide/src/inlay_hints.rs</code>:73 on 2025-08-25 10:22</div>
            <div class="timeline-body"><p>Ive just removed these methods, i think its better for us to just be more explicit with what the specific parts are anyway.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> reviewed on 2025-08-25 10:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on <code>crates/ty_ide/src/inlay_hints.rs</code>:61 on 2025-08-25 10:22</div>
            <div class="timeline-body"><p>I have removed this too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-08-25 13:21</div>
            <div class="timeline-body"><p>Feel free to re-request for review once it&#x27;s ready.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-08-25 15:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MatthewMckee4">@MatthewMckee4</a> on 2025-08-25 15:26</div>
            <div class="timeline-body"><p>could you re run that cargo test, looks like a flake</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-08-26 04:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[ty] Refactor ty_ide inlay hints&quot; to &quot;[ty] Refactor inlay hints structure to use separate parts&quot; by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-08-26 04:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-08-26 04:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_ide/src/inlay_hints.rs</code>:73 on 2025-08-26 04:49</div>
            <div class="timeline-body"><p>Is this because that would allow us to have the navigation target that is relevant for that specific part of the label? For example, in <code>: Type</code>, it&#x27;s just the &quot;Type&quot; part that&#x27;s possible to do go to definition.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-08-26 04:50</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-08-26 04:50</div>
            <div class="timeline-body"><blockquote>
<p>could you re run that cargo test, looks like a flake</p>
</blockquote>
<p>I&#x27;m assuming that this was fixed?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-08-26 04:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-08-26 04:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-11-06 11:48</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:17:58 UTC
    </footer>
</body>
</html>
