<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[pydocstyle] Escaped docstring in docstring (D301 ) - astral-sh/ruff #12192</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[pydocstyle] Escaped docstring in docstring (D301 )</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12192">#12192</a>
        opened by <a href="https://github.com/ukyen8">@ukyen8</a>
        on 2024-07-04 21:27
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/ukyen8">@ukyen8</a> on 2024-07-04 21:27</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<!-- What's the purpose of the change? What does it do, and why? -->

<p>This PR updates D301 rule to allow inclduing escaped docstring,  e.g. <code>\&quot;&quot;&quot;Foo.\&quot;&quot;&quot;</code> or <code>\&quot;\&quot;\&quot;Bar.\&quot;\&quot;\&quot;</code>, within a docstring.</p>
<p>Related issue: #12152</p>
<h2>Test Plan</h2>
<p>Add more test cases to D301.py and update the snapshot file.</p>
<!-- How was it tested? -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @ukyen8 on 2024-07-04 21:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @charliermarsh on 2024-07-04 23:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">docstring</span> added by @charliermarsh on 2024-07-04 23:09</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-07-04 23:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/pydocstyle/rules/backslashes.rs</code>:73 on 2024-07-04 23:09</div>
            <div class="timeline-body"><p>We likely also need to handle single quotes here (i.e., escaped single quotes within single-quote docstrings).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ukyen8">@ukyen8</a> reviewed on 2024-07-05 20:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ukyen8">@ukyen8</a> on <code>crates/ruff_linter/src/rules/pydocstyle/rules/backslashes.rs</code>:73 on 2024-07-05 20:48</div>
            <div class="timeline-body"><p>But D301 is based on double quotes, do we need to cover single-quote docstring here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @charliermarsh by @ukyen8 on 2024-07-10 23:41</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-15 06:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pydocstyle/rules/backslashes.rs</code>:73 on 2024-07-15 06:51</div>
            <div class="timeline-body"><p>I haven't verified this myself but the way I read the code is that docstrings are extracted from any string literal</p>
<p>https://github.com/astral-sh/ruff/blob/7d16f831c4af4c78344c8e9a1bb8259fb425d671/crates/ruff_linter/src/docstrings/extraction.rs#L6-L15</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pydocstyle/rules/backslashes.rs</code>:85 on 2024-07-15 06:59</div>
            <div class="timeline-body"><p>This will panic if what comes after the <code>\</code> is shorter than 3 characters. I would rewrite this to something like</p>
<pre><code class="language-suggestion">            let after_first_backslash = &amp;bytes[position + 1..];
            let is_escaped_triple = after_first_backslash.starts_with(b&quot;\&quot;\&quot;\&quot;&quot;)
                || after_first_backslash.starts_with(b&quot;\'\'\'&quot;);
            if is_escaped_triple {
                return false;
            }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_linter/src/rules/pydocstyle/rules/backslashes.rs</code>:87 on 2024-07-15 07:12</div>
            <div class="timeline-body"><p>I don't think this assumption is correct and this might actually a bug in the existing implementation. For example, the function passed to <code>any</code> will be called twice for <code>\\</code>, once for each backslash position but the offsets aren't to indices apart.</p>
<p>What I understand is that you want to track if you're at the beginning of an escape sequence.</p>
<p>This is not fully fledged out, but I think we may have to rewrite the entire loop</p>
<pre><code class="language-rust">    while let Some(position) = memchr::memchr(b'\\', &amp;bytes[offset..]) {
        let after_escape = &amp;body[position + 1..];
        let next_char_len = after_escape.chars().next().unwrap_or_default();

        let Some(escaped_char) = &amp;after_escape.chars().next() else {
            break;
        };

        if matches!(escaped_char, '&quot;' | '\'') {
            let is_escaped_triple =
                after_escape.starts_with(&quot;\&quot;\&quot;\&quot;&quot;) || after_escape.starts_with(&quot;\'\'\'&quot;);

            if is_escaped_triple {
                // don't add a diagnostic
            }
            
            if position != 0 &amp;&amp; offset == position {
                // An escape sequence, e.g. `\a\b`
            }
        }
        
        

        offset = position + escaped_char.len_utf8();
    }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-15 07:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/ukyen8">@ukyen8</a> reviewed on 2024-07-17 21:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/ukyen8">@ukyen8</a> on <code>crates/ruff_linter/src/rules/pydocstyle/rules/backslashes.rs</code>:87 on 2024-07-17 21:56</div>
            <div class="timeline-body"><p>Thank you. This helps a lot!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-07-18 22:35</div>
            <div class="timeline-body"><p>Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2024-07-18 22:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2024-07-18 22:36</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 21:47:33 UTC
    </footer>
</body>
</html>
