<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add tests for `import` and `from ... import` statement - astral-sh/ruff #10771</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add tests for <code>import</code> and <code>from ... import</code> statement</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10771">#10771</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2024-04-04 06:54
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body">Summary
<p>This PR adds test cases for <code>import</code> and <code>import ... from</code> statement.</p>
<p>There are few more things in this PR related to the import statement parsing:</p>
<ol>
<li>Move helper function <code>parse_alias</code> and <code>parse_dotted_name</code> close to import statement parsing function</li>
<li>Improve error handling, especially when the field is <code>Option&lt;T&gt;</code>. We&#x27;ll use <code>None</code> if the value is missing instead of an invalid node and report an appropriate error.</li>
<li>Rename <code>TupleParenthesized</code> to <code>Parenthesized</code> and use it to generally inform the parser whether the elements are surrounded by parentheses or not.</li>
<li>Update logic to raise syntax error where it didn&#x27;t earlier. For example, a star import isn&#x27;t allowed in <code>import</code> statement or a star import cannot be mixed with other names in a <code>from ... import</code> statement.</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">parser</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-04 06:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-04 06:54</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-04 06:54</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-04-04 06:59</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/dhruv/import-stmt">CodSpeed Performance Report</a>
Merging #10771 will <strong>degrade performances by 4.46%</strong>
<p>Comparing <code>dhruv/import-stmt</code> (260acc2) with <code>dhruv/parser</code> (4a4e2fb)</p>
Summary
<p><code>❌ 1</code> regressions
<code>✅ 29</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/dhruv/import-stmt">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
Benchmarks breakdown
<p>|     | Benchmark | <code>dhruv/parser</code> | <code>dhruv/import-stmt</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ❌ | <code>parser[numpy/ctypeslib.py]</code> | 4.8 ms | 5.1 ms | -4.46% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:1119 on 2024-04-04 07:37</div>
            <div class="timeline-body"><p>I recommend updating all the numbers. It&#x27;s a bit painful but it otherwise becomes difficult to spot what the next free bit is.</p>
<pre><code>        const IMPORT_FROM_AS_NAMES_PARENTHESIZED = 1 &lt;&lt; 6;
        const IMPORT_FROM_AS_NAMES_UNPARENTHESIZED = 1 &lt;&lt; 7;
        const IMPORT_NAMES = 1 &lt;&lt; 8;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:1119 on 2024-04-04 07:38</div>
            <div class="timeline-body"><p>Another alternative (considering that it is a bitflag) is to have a flag <code>PARENTHESIZED</code> and for <code>IMPORT_FROM_AS_NAMES_PARENTHESIZED</code> you set <code>IMPORT_FROM_AS_NAMES</code> and <code>PARENTHESIZED</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:4 on 2024-04-04 07:39</div>
            <div class="timeline-body"><p>Nit: Uh no :P I don&#x27;t like itertools haha. It has a few extensions that make it non obvious that they&#x27;re allocating.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:434 on 2024-04-04 07:41</div>
            <div class="timeline-body"><p>Can we change this to <code>0</code> considering that the first ellipsis will always be eaten by the while loop?</p>
<pre><code>        let mut leading_dots = 0;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:446 on 2024-04-04 07:42</div>
            <div class="timeline-body"><p>Nit: I think I would rewrite this to a loop. It avoids checking twice if the parser is at a DOT or Ellipsis token</p>
<pre><code>        loop {
            progress.assert_progressing(self);

            if self.eat(TokenKind::Dot) {
                leading_dots += 1;
            } else if self.eat(TokenKind::Ellipsis) {
                leading_dots += 3;
            } else {
                break;
            }
        }
</code></pre>
<p>I otherwise recommend you to use <code>bump</code> for the Ellipsis case</p>
<pre><code>        while self.at_ts(DOT_ELLIPSIS_SET) {
            progress.assert_progressing(self);

            if self.eat(TokenKind::Dot) {
                leading_dots += 1;
            } else {
                self.bump(TokenKind::Ellipsis);
                leading_dots += 3;
            }
        }

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:460 on 2024-04-04 07:44</div>
            <div class="timeline-body"><p>Nit</p>
<pre><code>        let module = if self.at(TokenKind::Name) {
            Some(self.parse_dotted_name())
        } else {
            if leading_dots == 0 {
                // test_err from_import_missing_module
                // from
                // from import x
                self.add_error(
                    ParseErrorType::OtherError(&quot;Expected a module name&quot;.to_string()),
                    self.current_token_range(),
                );
            }
            None
        };

</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:503 on 2024-04-04 07:45</div>
            <div class="timeline-body"><p>What about <code>from x import *, *, a</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-04-04 07:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-04-04 10:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/mod.rs</code>:1119 on 2024-04-04 10:09</div>
            <div class="timeline-body"><p>Yeah, I like the alternative, will make it as a follow-up for other variants as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-04-04 10:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:4 on 2024-04-04 10:11</div>
            <div class="timeline-body"><p>I think I only use it for <code>join</code> which can be done with fold as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2024-04-04 10:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/parser/statement.rs</code>:503 on 2024-04-04 10:25</div>
            <div class="timeline-body"><p>It does report an error. Is the worry that there are 2 star imports in your test case? I&#x27;ll add it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-04 10:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-04-04 10:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-04 10:35</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:03:05 UTC
    </footer>
</body>
</html>
