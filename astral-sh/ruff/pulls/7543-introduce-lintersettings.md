```yaml
number: 7543
title: "Introduce `LinterSettings`"
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
assignees: []
merged: true
base: main
head: linter-settings
created_at: 2023-09-20T12:23:09Z
updated_at: 2023-09-20T16:04:55Z
url: https://github.com/astral-sh/ruff/pull/7543
synced_at: 2026-01-12T15:55:24Z
```

# Introduce `LinterSettings`

---

_@MichaReiser_

## Stack Summary

This stack splits `Settings` into `FormatterSettings` and `LinterSettings` and moves it into `ruff_workspace`. This change is necessary to add the `FormatterSettings` to `Settings` without adding `ruff_python_formatter` as a dependency to `ruff_linter` (and the linter should not contain the formatter settings). 

A quick overview of our settings struct at play:

* `Options`: 1:1 representation of the options in the `pyproject.toml` or `ruff.toml`.  Used for deserialization.
* `Configuration`: Resolved `Options`, potentially merged from multiple configurations (when using `extend`). The representation is very close if not identical to the `Options`.
* `Settings`: The resolved configuration that uses a data format optimized for reading. Optional fields are initialized with their default values. Initialized by `Configuration::into_settings` .

The goal of this stack is to split `Settings` into tool-specific resolved `Settings` that are independent of each other. This comes at the advantage that the individual crates don't need to know anything about the other tools. The downside is that information gets duplicated between `Settings`. Right now the duplication is minimal (`line-length`, `tab-width`) but we may need to come up with a solution if more expensive data needs sharing.

This stack focuses on `Settings`. Splitting `Configuration` into some smaller structs is something I'll follow up on later. 

## PR Summary

This PR extracts the linter-specific settings into a new `LinterSettings` struct and adds it as a `linter` field to the `Settings` struct. This is in preparation for moving `Settings` from `ruff_linter` to `ruff_workspace`

## Test Plan

`cargo test`

---

_Comment by @MichaReiser on 2023-09-20 12:23_

Current dependencies on/for this PR:
* main
  * **PR #7532** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7532" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7542** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7542" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
      * **PR #7543** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7543" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
        * **PR #7544** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7544" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #7545** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7545" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
            * **PR #7548** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7548" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
              * **PR #7549** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7549" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #7536** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/7536" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7543?utm_source=stack-comment).

---

_@MichaReiser reviewed on 2023-09-20 12:42_

---

_Review comment by @MichaReiser on `crates/ruff_linter/src/settings/mod.rs`:105 on 2023-09-20 12:42_

The changes in this file are the main changes. Everything else are just downstream refactors to use the new structure.

---

_Review requested from @charliermarsh by @MichaReiser on 2023-09-20 12:55_

---

_Label `internal` added by @MichaReiser on 2023-09-20 12:55_

---

_Marked ready for review by @MichaReiser on 2023-09-20 12:57_

---

_Review comment by @charliermarsh on `crates/ruff_workspace/src/configuration.rs`:168 on 2023-09-20 13:07_

I feel like some of these aren't linter-specific, like `namespace_packages` and `src` -- they would be generally applicable to any tool that does module / file resolution. But it's not important for now.

---

_Review comment by @charliermarsh on `crates/ruff_workspace/src/configuration.rs`:153 on 2023-09-20 13:07_

Should this be lifted up?

---

_@charliermarsh approved on 2023-09-20 13:07_

---

_@MichaReiser reviewed on 2023-09-20 13:09_

---

_Review comment by @MichaReiser on `crates/ruff_workspace/src/configuration.rs`:168 on 2023-09-20 13:09_

That's true, but the `Settings` are the resolved view for a tool. My current, not so nice approach, is to duplicate settings that apply to multiple tools when resolving the `Configuration`. Meaning, the `Configuration` applies` the right inheritance rules and, as a result, may end up initializing common fields identically. 

I don't think this is a performance problem because we only do this once per setting and settings tend to not have very large structures. 

---

_@MichaReiser reviewed on 2023-09-20 13:10_

---

_Review comment by @MichaReiser on `crates/ruff_workspace/src/configuration.rs`:153 on 2023-09-20 13:10_

The linter needs access to `target_version`. We can't access it if we lift it up. I'll lift it up in the `Configuration`, but the each `Setting` object needs its own copy of the `target_version`.

---

_Comment by @codspeed-hq[bot] on 2023-09-20 13:13_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/linter-settings)

### Merging #7543 will **improve performances by 2%**

<sub>Comparing <code>linter-settings</code> (308bae8) with <code>main</code> (8f41eab)</sub>



### Summary

`âš¡ 1` improvements
`âœ… 24` untouched benchmarks




### Benchmarks breakdown

|     | Benchmark | `main` | `linter-settings` | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| âš¡ | `linter/default-rules[pydantic/types.py]` | 38.8 ms | 38 ms | +2% |


---

_Renamed from "Introduce `LinterSettings` and `ResolverSettings`" to "Introduce `LinterSettings`" by @MichaReiser on 2023-09-20 14:00_

---

_Comment by @MichaReiser on 2023-09-20 14:41_

### Merge Activity

* **Sep 20, 10:41 AM**: [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7543) rebased this pull request after merging its parent, because this pull request is set to merge when ready.
* **Sep 20, 11:02 AM**: @MichaReiser merged this pull request with [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/7543).


---

_Comment by @github-actions[bot] on 2023-09-20 15:01_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.



---

_Merged by @MichaReiser on 2023-09-20 15:02_

---

_Closed by @MichaReiser on 2023-09-20 15:02_

---

_Branch deleted on 2023-09-20 15:02_

---
