<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add an implicit concatenation flag to string and bytes constants - astral-sh/ruff #6512</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add an implicit concatenation flag to string and bytes constants</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6512">#6512</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-08-11 19:24
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Per the discussion in https://github.com/astral-sh/ruff/discussions/6183, this PR adds an <code>implicit_concatenated</code> flag to the string and bytes constant variants. It's not actually <em>used</em> anywhere as of this PR, but it is covered by the tests.</p>
<p>Specifically, we now use a struct for the string and bytes cases, along with the <code>Expr::FString</code> node. That struct holds the value, plus the flag:</p>
<pre><code class="language-rust">#[derive(Clone, Debug, PartialEq, is_macro::Is)]
pub enum Constant {
    Str(StringConstant),
    Bytes(BytesConstant),
    ...
}

#[derive(Clone, Debug, PartialEq, Eq)]
pub struct StringConstant {
    /// The string value as resolved by the parser (i.e., without quotes, or escape sequences, or
    /// implicit concatenations).
    pub value: String,
    /// Whether the string contains multiple string tokens that were implicitly concatenated.
    pub implicit_concatenated: bool,
}

impl Deref for StringConstant {
    type Target = str;
    fn deref(&amp;self) -&gt; &amp;Self::Target {
        self.value.as_str()
    }
}

#[derive(Clone, Debug, PartialEq, Eq)]
pub struct BytesConstant {
    /// The bytes value as resolved by the parser (i.e., without quotes, or escape sequences, or
    /// implicit concatenations).
    pub value: Vec&lt;u8&gt;,
    /// Whether the string contains multiple string tokens that were implicitly concatenated.
    pub implicit_concatenated: bool,
}

impl Deref for BytesConstant {
    type Target = [u8];
    fn deref(&amp;self) -&gt; &amp;Self::Target {
        self.value.as_slice()
    }
}
</code></pre>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-11 19:42</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>✅ ecosystem check detected no changes.</p>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @charliermarsh on 2023-08-11 20:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2023-08-14 08:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff/src/rules/flake8_comprehensions/fixes.rs</code>:28 on 2023-08-14 08:30</div>
            <div class="timeline-body"><p>Did you refactor this code? Should it be part of this PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_ast/src/comparable.rs</code>:339 on 2023-08-14 08:32</div>
            <div class="timeline-body"><p>Is the idea here that two strings compare equal regardless of whether they are implicitly concatenated? If not, add the <code>implicit_concatenated</code> flag to <code>Str</code> and <code>Bytes</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/string.rs</code>:515 on 2023-08-14 08:35</div>
            <div class="timeline-body"><p>Nit: I find the <code>collect</code> + <code>into</code> hard to read. It's less expressive as the <code>Constant::Bytes</code> before that set focus on that this is a byte string</p>
<pre><code class="language-suggestion">            value: content.as_bytes().into(),
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/string.rs</code>:673 on 2023-08-14 08:39</div>
            <div class="timeline-body"><p>I believe we need to set the implicit concat flag in this case. But not entirely sure. But you can see how it expands the range of the current element.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-08-14 08:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @MichaReiser on 2023-08-14 08:39</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-08-14 11:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_ast/src/comparable.rs</code>:339 on 2023-08-14 11:23</div>
            <div class="timeline-body"><blockquote>
<p>Is the idea here that two strings compare equal regardless of whether they are implicitly concatenated?</p>
</blockquote>
<p>Yes</p>
<pre><code class="language-python">&gt;&gt;&gt; &quot;hello&quot; &quot; world&quot; == &quot;hello world&quot;
True
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2023-08-14 11:45</div>
            <div class="timeline-body"><p>Looks good!</p>
<p>(Just a mental node to revisit the implicit string concatenation while working on the parser implementation for f-string part as I'm noticing the complexity involved and the need for <code>strings.rs</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-14 13:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_comprehensions/fixes.rs</code>:28 on 2023-08-14 13:27</div>
            <div class="timeline-body"><p>Sorry, I think this was accidentally included when I was playing around with removing LibCST. I must've gotten my branches confused.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-14 13:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_ast/src/comparable.rs</code>:339 on 2023-08-14 13:27</div>
            <div class="timeline-body"><p>Yeah, that's intentional.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-14 13:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_ast/src/comparable.rs</code>:339 on 2023-08-14 13:28</div>
            <div class="timeline-body"><p>(Adding a note.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-14 13:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_parser/src/string.rs</code>:673 on 2023-08-14 13:33</div>
            <div class="timeline-body"><p>I think it's fine as-is, because <code>current</code> is just <code>Vec&lt;String&gt;</code>, and these get converted to <code>Expr::Constant</code> when pushed onto <code>deduped</code> (which sets the implicit flag).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_python_parser/src/string.rs</code>:515 on 2023-08-14 13:36</div>
            <div class="timeline-body"><p>Interestingly, <code>content.as_bytes().to_vec().into()</code> actually behaves differently (I'm seeing some lines that aren't too long be marked as such). I just woke up so I'm not sure why. I'm gonna look into it later, it could be a legitimate bug.</p>
<pre><code class="language-diff">   37    37 │ 10 10 | ) -&gt; None: ...
   38    38 │ 11 11 | def f5(
   39    39 │ 12 12 |     x: bytes = b&quot;50 character byte stringgggggggggggggggggggggggggg&quot;,  # OK
   40    40 │
         41 │+PYI053.pyi:18:16: PYI053 [*] String and bytes literals longer than 50 characters are not permitted
         42 │+   |
         43 │+16 | ) -&gt; None: ...
         44 │+17 | def f7(
         45 │+18 |     x: bytes = b&quot;50 character byte stringggggggggggggggggggggggggg\xff&quot;,  # OK
         46 │+   |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ PYI053
         47 │+19 | ) -&gt; None: ...
         48 │+20 | def f8(
         49 │+   |
         50 │+   = help: Replace with `...`
         51 │+
         52 │+ℹ Suggested fix
         53 │+15 15 |     x: bytes = b&quot;51 character byte stringgggggggggggggggggggggggggg&quot;,  # Error: PYI053
         54 │+16 16 | ) -&gt; None: ...
         55 │+17 17 | def f7(
         56 │+18    |-    x: bytes = b&quot;50 character byte stringggggggggggggggggggggggggg\xff&quot;,  # OK
         57 │+   18 |+    x: bytes = ...,  # OK
         58 │+19 19 | ) -&gt; None: ...
         59 │+20 20 | def f8(
         60 │+21 21 |     x: bytes = b&quot;51 character byte stringgggggggggggggggggggggggggg\xff&quot;,  # Error: PYI053
         61 │+
   41    62 │ PYI053.pyi:21:16: PYI053 [*] String and bytes literals longer than 50 characters are not permitted
   42    63 │    |
   43    64 │ 19 | ) -&gt; None: ...
   44    65 │ 20 | def f8(
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-08-14 13:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-08-14 13:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-08-14 13:46</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-08-14 13:46</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_parser/src/string.rs</code>:515 on 2023-08-14 13:55</div>
            <div class="timeline-body"><p>It differs for non ascii characters because <code>c as u8</code> truncates the non-ascii part. Whereas <code>.as_bytes</code> takes the string as is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-14 13:55</div>
            <div class="timeline-body"></div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:59:30 UTC
    </footer>
</body>
</html>
