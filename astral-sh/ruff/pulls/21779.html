<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Support re-exports in auto-import - astral-sh/ruff #21779</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Support re-exports in auto-import</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21779">#21779</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2025-12-03 20:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>This PR principally makes auto-import aware of re-exports in modules.
Here are some examples of re-exports that we previously ignored.</p>
<p>First is the &quot;redundant import alias&quot; idiom:</p>
<pre><code>import X as X
from module import X as X
</code></pre>
<p>Second is a wildcard import:</p>
<pre><code>from module import *
</code></pre>
<p>And third is a regular import with <code>__all__</code>:</p>
<pre><code>from module import X
__all__ = [&#x27;X&#x27;]
</code></pre>
<p>An import outside of the above is ignored for the purposes of
determining the exported interface of a module.
See: https://typing.python.org/en/latest/spec/distributing.html#library-interface-public-and-private-symbols</p>
<p>This PR also automatically skips over symbols in any module (or child
of a module) whose name starts with an underscore. (We don&#x27;t skip such
modules in first party code though, since we want to be able to offer
auto-import completions for things internal to a project while working
in that project.)</p>
<p>Both of these improvements are very relevant for using libraries like <code>numpy</code>.
Namely, <code>numpy</code> crafts its API via exports and <code>__all__</code>. <code>numpy</code> also has many
symbols inside of project-internal modules that can otherwise flood the results
of auto-import.</p>
<p>Closes <a href="https://github.com/astral-sh/ty/issues/1555">astral-sh/ty#1555</a>, Closes #21112, Closes <a href="https://github.com/astral-sh/ty/issues/895">astral-sh/ty#895</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-12-03 20:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-12-03 20:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-12-03 20:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-12-03 20:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-12-03 20:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-03 20:36</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/dcreager">@dcreager</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-12-03 20:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/carljm">@carljm</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-12-03 20:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/sharkdp">@sharkdp</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-12-03 20:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-03 20:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-12-03 20:38</div>
            <div class="timeline-body"><p>Demo for re-exports:</p>
<p>https://github.com/user-attachments/assets/072e141e-954e-4ded-9a2f-b3de7ce377a5</p>
<p>Demo that first party modules starting with a <code>_</code> are still included in auto-import:</p>
<p>https://github.com/user-attachments/assets/47eef4a5-31d0-442c-a9bc-68cd7feac4d1</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-03 20:38</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-12-03 20:40</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected âœ…</p>
<p>No memory usage changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/Gankra">@Gankra</a> by <a href="https://github.com/Gankra">@Gankra</a> on 2025-12-03 22:32</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_ide/src/completion.rs</code>:5819 on 2025-12-03 23:02</div>
            <div class="timeline-body"><p>What change is causing these suggestions to go away? They don&#x27;t seem to be defined in an underscore-prefixed module. They are defined in a <code>sys.version_info</code> conditional -- do we also add support for that in this PR? Or change the Python version we run these tests with?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_ide/src/completion.rs</code>:5886 on 2025-12-03 23:05</div>
            <div class="timeline-body"><p>Probably orthogonal to this PR, but the &quot;Current module&quot; bit caught me by surprise here. <code>ZQZQ</code> isn&#x27;t defined in the current module, it&#x27;s defined in <code>bar.py</code>. But maybe we use this text just to indicate &quot;not going to require a new import&quot;? As in, <code>foo</code> has been imported into your current module, so <code>foo.ZQZQ</code> is already available here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_ide/src/completion.rs</code>:5909 on 2025-12-03 23:06</div>
            <div class="timeline-body"><p>I guess the real test here is that (unlike in the case below with the explicit redundant-alias re-export convention), <code>&quot;ZQZQ :: foo&quot;</code> does <em>not</em> show up here. This definitely confused me on my first read of this test -- &quot;Why is <code>foo.py</code> even here? How is this a test of re-exports? What are we even testing for here?&quot;. I generally find that some comments regarding intent can help clarify such negative tests a lot. (Or really all tests -- but I&#x27;m not trying to dictate your test-writing style here, if you generally don&#x27;t comment them.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_ide/src/completion.rs</code>:5886 on 2025-12-03 23:12</div>
            <div class="timeline-body"><p>I guess the noteworthy thing here is that when auto-completing an attribute (vs adding an auto-import), we don&#x27;t care if the name is re-exported or not?</p>
<p>I think this is the right call for Python files, but I&#x27;m not sure about stubs / typeshed. I think in the case of stubs we maybe shouldn&#x27;t auto-complete non-re-exported names at all? But not totally sure, and it&#x27;s not a question that has to be answered in this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_ide/src/completion.rs</code>:5959 on 2025-12-03 23:14</div>
            <div class="timeline-body"><p>What if this were <code>bar.ZQ&lt;CURSOR&gt;</code> after <code>import bar</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_python_semantic/src/module_resolver/path.rs</code>:597 on 2025-12-03 23:14</div>
            <div class="timeline-body"><p>pub all the things! ðŸ˜†</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_server/tests/e2e/snapshots/e2e__notebook__auto_import.snap</code>:9 on 2025-12-03 23:15</div>
            <div class="timeline-body"><p>Are these changes that a reviewer should validate somehow?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_completion_eval/completion-evaluation-tasks.csv</code>:14 on 2025-12-03 23:17</div>
            <div class="timeline-body"><p>Are these changes that a reviewer should validate somehow?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_ide/src/symbols.rs</code>:1024 on 2025-12-04 00:13</div>
            <div class="timeline-body"><p>We have to allocate a String here, we can&#x27;t borrow a <code>&amp;str</code> from the AST?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_ide/src/symbols.rs</code>:763 on 2025-12-04 00:15</div>
            <div class="timeline-body"><p>This in particular seems like the place where the FIXME below about conditionals is most dangerous, because it could cause us to treat some symbols as private that should be public.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_ide/src/symbols.rs</code>:1162 on 2025-12-04 00:21</div>
            <div class="timeline-body"><p>If you&#x27;re wanting to test fixme cases, another &quot;statically known condition&quot; we should support here is <code>sys.version_info</code> checks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_ide/src/symbols.rs</code>:1451 on 2025-12-04 00:23</div>
            <div class="timeline-body"><p>I don&#x27;t see any tests for the fact that a subsequent non-augmented assignment (or import) of <code>__all__</code> clears previous names. (Or any fixme test for the fact that we&#x27;ll do this even if they are conditional, e.g. in</p>
<pre><code>if whatever:
    __all__ = [...]
else:
    __all__ = [...]
</code></pre>
<p>we will always take the <code>else</code> version of <code>__all__</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty_ide/src/symbols.rs</code>:1378 on 2025-12-04 00:24</div>
            <div class="timeline-body"><p>Are we sure that we should consider double-underscore names as exports from a module? (In this case the question is whether it should be considered as exported from <code>foo</code>, since the spec is clear that if it&#x27;s public in <code>foo</code>, the wildcard import makes it public in <code>test</code>.)</p>
<p>(I assume this was previously discussed and a decision was made for solid reasons, if so feel free to ignore.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-12-04 00:31</div>
            <div class="timeline-body"><p>Fantastic. What a test suite!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/completion.rs</code>:5819 on 2025-12-04 09:25</div>
            <div class="timeline-body"><p>I suspect it&#x27;s either because <code>importlib.metadata</code> uses <code>__all__</code> OR because the definition is version dependet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/symbols.rs</code>:121 on 2025-12-04 09:27</div>
            <div class="timeline-body"><p>Should this be an <code>FxIndexSet</code> so that we preserve the order in which the symbols are declared in all or do we never iterate over the symbols?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/symbols.rs</code>:387 on 2025-12-04 09:27</div>
            <div class="timeline-body"><p>It might be worth adding a constructor to <code>SymbolVisitor</code> that hides the &quot;these are the default states&quot; logic</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/symbols.rs</code>:800 on 2025-12-04 09:40</div>
            <div class="timeline-body"><p>Do we also need to consider modules starting with <code>_</code> as private or is this already handled elsewhere?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/symbols.rs</code>:786 on 2025-12-04 09:41</div>
            <div class="timeline-body"><p>Unrelated to this PR but I noticed that you&#x27;re using it in a few places. It would probalby be good if we have a single definition of what&#x27;s a constant. E.g. we have something similar (but different) in semantic tokens</p>
<p>https://github.com/astral-sh/ruff/blob/8f104faa5fb9ef87e06aef822b31f342a177a9d8/crates/ty_ide/src/semantic_tokens.rs#L256-L259</p>
<p>I&#x27;m pretty sure we have something similar in Ruff but my search skills are failing me right now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/symbols.rs</code>:905 on 2025-12-04 09:42</div>
            <div class="timeline-body"><p>Depending on your definition of <code>in_class</code>, you&#x27;ll want to unset <code>in_class</code> when entering a new function and unset <code>in_function</code> when entering a class. You might also want to unset <code>in_class</code> and <code>in_function</code> when entering a lambda expression</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/symbols.rs</code>:1030 on 2025-12-04 09:43</div>
            <div class="timeline-body"><p>You might want to override <code>visit_expression</code> to an empty method to avoid unnecessary work (the default walks the entire expression)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/symbols.rs</code>:763 on 2025-12-04 09:45</div>
            <div class="timeline-body"><p>I could see us decide to union instead of overriding <code>__all__</code> in those cases. There&#x27;s a risk that we suggest a few extra completions but it isn&#x27;t strictly <em>more wrong</em> than always using the last branch (which might be for another python version). The benefit of unioning is that  users at least see all completions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-12-04 09:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-04 14:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:5819 on 2025-12-04 14:05</div>
            <div class="timeline-body"><p>Yeah it&#x27;s because this PR switches to a stricter semantic when <code>__all__</code> is present, and the <code>Deprecated</code> symbols aren&#x27;t in <code>importlib.metadata.__all__</code>. (I think I mentioned this in a commit message. :P)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/completion.rs</code>:5819 on 2025-12-04 14:07</div>
            <div class="timeline-body"><blockquote>
<p>(I think I mentioned this in a commit message. :P)</p>
</blockquote>
<p>Should I tell you that...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-12-04 14:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-04 14:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:5819 on 2025-12-04 14:11</div>
            <div class="timeline-body"><p>For top-level conditionals, that behavior hasn&#x27;t changed (or shouldn&#x27;t have changed). At present, auto-import just assumes all such conditions are true. So you might get offered completions that don&#x27;t actually exist.</p>
<p>I filed <a href="https://github.com/astral-sh/ty/issues/1754">astral-sh/ty#1754</a> to track this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-04 14:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:5886 on 2025-12-04 14:14</div>
            <div class="timeline-body"><p>Yeah this is just a test thing. But I agree the language could be clearer here. I changed this to <code>&lt;no import required&gt;</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/symbols.rs</code>:447 on 2025-12-04 14:20</div>
            <div class="timeline-body"><p>nit: most entries in <code>__all__</code> are likely to be small -- could we use <code>ruff_python_ast::Name</code> here, for less memory allocation?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-04 14:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:5909 on 2025-12-04 14:20</div>
            <div class="timeline-body"><p>Yeah I can add a comment here. I sometimes comment tests. I can at least go through and add a quick note on tests expecting a negative result.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-04 14:27</div>
            <div class="timeline-body"><p>I think this PR probably closes <a href="https://github.com/astral-sh/ty/issues/895">astral-sh/ty#895</a>. I.e., I don&#x27;t think it would be desirable to have the <code>__all__</code> inference machinery you&#x27;re adding to <code>SymbolVisitor</code> added to the <code>ExportFinder</code> visitor, because the <code>ExportVisitor</code> in <code>ty_python_semantic</code> cannot use type inference to evaluate statically known conditions such as <code>sys.version_info</code> checks, but our <code>__all__</code> machinery in <code>ty_python_semantic</code> <em>does</em> use type inference to evaluate statically known conditions such as <code>sys.version_info</code> checks. So once this PR has landed, I think the conclusion is pretty clear that it would <em>not</em> be a good idea to unify the two visitors ðŸ˜„</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/symbols.rs</code>:566 on 2025-12-04 14:29</div>
            <div class="timeline-body"><p>note that for something like <code>from importlib import machinery</code>, <code>machinery</code> is actually a module. But that&#x27;s obviously hard to detect without type inference</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-04 14:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:5886 on 2025-12-04 14:29</div>
            <div class="timeline-body"><p>Yes, that&#x27;s correct.</p>
<p>I don&#x27;t think I have a strong opinion yet on whether auto-complete includes non-re-exported names based on whether it&#x27;s a stub or not. What makes the stub special enough that we should be stricter when it&#x27;s present? Is it just that it implies someone has thoughtfully crafted the public API and we should therefore be stricter about respecting it?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/completion.rs</code>:5886 on 2025-12-04 14:37</div>
            <div class="timeline-body"><p>You should assume that most names in a stub also exist at runtime.</p>
<p>Private names in a stub (starting with a single underscore) are often things that do not in fact exist at runtime. But you can&#x27;t impose a blanket rule that private names in stubs should never be considered unexported, because there are things like <code>os._exit</code> that are very much public API. The underscore there is to warn users that it&#x27;s a very dangerous API to use.</p>
<p>You can however have very high confidence that private names in stubs that define type aliases, protocols, type variables or typed dicts will not in fact exist at runtime. You can also have high confidence that most imported items will not exist at runtime: anything imported that is not included in <code>__all__</code>, does not refer to a submodule of the current package, and does not use the redundant alias convention. Lastly, anything decorated with <code>@type_check_only</code> in a stub file will not exist at runtime.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/symbols.rs</code>:800 on 2025-12-04 14:45</div>
            <div class="timeline-body"><p>Additionally, a symbol that starts with two underscores (but does not end with two underscores) should also probably be considered private</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/symbols.rs</code>:905 on 2025-12-04 14:46</div>
            <div class="timeline-body"><blockquote>
<p>You might also want to unset <code>in_class</code> and <code>in_function</code> when entering a lambda expression</p>
</blockquote>
<p>I doubt lambdas are relevant to Andrew&#x27;s work here, but if they are then we should do the same for comprehension scopes and generator expressions as we do for lambdas; these are also isolated scopes that can define their own symbols</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/symbols.rs</code>:933 on 2025-12-04 14:49</div>
            <div class="timeline-body"><p>do you also want to check <code>aug_assign.op</code> here? <code>__all__ *= 3</code> is a <code>StmtAugAssign</code> node -- I think if we see any <code>op</code> that&#x27;s not an addition here and the l.h.s. is <code>__all__</code>, we should mark <code>self.all_invalid = true</code> and abort before calling <code>self.extend_all()</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/symbols.rs</code>:1507 on 2025-12-04 14:59</div>
            <div class="timeline-body"><p>this looks incorrect. Since <code>foo.py</code> doesn&#x27;t have an <code>__all__</code> variable in it, the <code>from foo import *</code> import won&#x27;t actually import <code>_ZQZQZQ</code> into <code>test.py</code> (because of the leading underscore). Not only should <code>_ZQZQ</code> not be considered re-exported from <code>test.py</code> -- it&#x27;s actually undefined in <code>test.py</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/symbols.rs</code>:1539 on 2025-12-04 15:01</div>
            <div class="timeline-body"><p>this could do with a comment added to it that says that the <code>from foo import *</code> will actually import the <code>collections</code> symbol into <code>test.py</code> at runtime, but we nonetheless do not consider it <em>publicly re-exported</em> from either <code>foo</code> or <code>test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/symbols.rs</code>:1567 on 2025-12-04 15:03</div>
            <div class="timeline-body"><p>same here, I think this could do with a comment saying that this isn&#x27;t testing the runtime semantics of which symbols are imported as a result of the <code>*</code> import; it&#x27;s testing the semantics of which symbols we consider publicly exported according to the conventions in the typing spec</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/symbols.rs</code>:1833 on 2025-12-04 15:06</div>
            <div class="timeline-body"><p>(note that I believe this actually causes the <code>*</code> import to fail at runtime with <code>AttributeError</code>, because it tries to grab <code>TRICKSY</code> from <code>foo</code> but fails!)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> requested changes on 2025-12-04 15:08</div>
            <div class="timeline-body"><p>Epic test suite!!</p>
<p>I noticed one correctness issue. At runtime, <code>from foo import *</code> will not import any names starting with an underscore from <code>foo</code> if <code>foo</code> doesn&#x27;t define <code>__all__</code> (<a href="https://github.com/astral-sh/ruff/pull/21779">astral-sh/ruff#21779</a>#discussion_r2589422916). This is specced <a href="https://docs.python.org/3/reference/lexical_analysis.html#reserved-classes-of-identifiers">here</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/completion.rs</code>:5819 on 2025-12-04 15:15</div>
            <div class="timeline-body"><p>yeah, this seems like a very good change to me! <code>importlib.metadata.DeprecatedList</code> definitely isn&#x27;t part of that module&#x27;s public API.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/completion.rs</code>:5886 on 2025-12-04 15:18</div>
            <div class="timeline-body"><p>I do think Carl is correct here that we should not offer <code>ZQZQ</code> as an attribute completion here at all if it&#x27;s <code>foo.pyi</code> instead of <code>foo.py</code>. In the type checker, if <code>foo</code> is defined as a <code>pyi</code> file then I don&#x27;t think we consider <code>foo</code> to have a <code>ZQZQ</code> attribute at all, because it&#x27;s been defined in the <code>foo</code> module using an import that wasn&#x27;t an explicit re-export. Stubs often import many things in modules even though they don&#x27;t exist in those modules at runtime; it&#x27;s often necessary to do so in order to annotate the public interfaces of those modules.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-12-04 15:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-04 15:23</div>
            <div class="timeline-body"><p>What&#x27;s our behaviour if <code>__all__</code> is assigned or updated in a non-global scope? E.g.</p>
<pre><code>__all__ = []

def foo():
    __all__.append(&quot;bar&quot;)

class X:
    def method(self):
        __all__.extend([&quot;baz&quot;])
</code></pre>
<p>I might have missed it, but I didn&#x27;t spot any tests for that. Does our behaviour here align with what we do in <code>ty_python_semantic</code>&#x27;s inference for <code>__all__</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-04 15:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:5886 on 2025-12-04 15:34</div>
            <div class="timeline-body"><p>It actually looks like if I change this test to use <code>foo.pyi</code>, then <code>ZQZQ</code> isn&#x27;t offered today.</p>
<p>In any case, I filed an issue about this more generally so that we don&#x27;t lose track of it: <a href="https://github.com/astral-sh/ty/issues/1756">astral-sh/ty#1756</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:5959 on 2025-12-04 15:43</div>
            <div class="timeline-body"><p>Then <code>ZQZQ2</code> will be included, unlike in the auto-import case.</p>
<p>This was &quot;intended&quot; on my part. In the sense that this PR doesn&#x27;t change how we handle <code>__all__</code> for object-attr completions. And because I am uncertain what the right behavior is here. Maybe the right approach is for it to mimic auto-import and strictly adhere to <code>__all__</code> when it&#x27;s present? (It&#x27;s perhaps notable that pylance is similarly relaxed here. It&#x27;s also relaxed when it comes to respecting <code>__all__</code> for auto-import too. That is, even when <code>__all__</code> is defined, pylance will include symbols that aren&#x27;t part of <code>__all__</code>. So that&#x27;s probably where this behavior came from originally.)</p>
<p>In any case, I added this as a test (confirming current behavior) and created an issue for this: <a href="https://github.com/astral-sh/ty/issues/1757">astral-sh/ty#1757</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-04 15:43</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/symbols.rs</code>:121 on 2025-12-04 15:44</div>
            <div class="timeline-body"><p>No, we don&#x27;t care about order here. Just set membership. :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-04 15:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-04 15:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/symbols.rs</code>:387 on 2025-12-04 15:45</div>
            <div class="timeline-body"><p>Fair!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-04 15:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/symbols.rs</code>:566 on 2025-12-04 15:52</div>
            <div class="timeline-body"><p>Yeah I think there are other cases where this symbol kind isn&#x27;t quite correct. Or at least, not as precise as it could be.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-12-04 15:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/symbols.rs</code>:566 on 2025-12-04 15:54</div>
            <div class="timeline-body"><p>Maybe that&#x27;s worth adding a comment here? (No strong opinion though)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/symbols.rs</code>:763 on 2025-12-04 15:56</div>
            <div class="timeline-body"><p>Good catch. I filed <a href="https://github.com/astral-sh/ty/issues/1758">astral-sh/ty#1758</a> for tracking this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-04 15:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-04 15:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/symbols.rs</code>:786 on 2025-12-04 15:58</div>
            <div class="timeline-body"><p>Yeah hmmm. I&#x27;ll keep this in mind. The additional <code>name.len() &gt; 1</code> condition on that definition is interesting. I feel like that&#x27;s probably not what we want for auto-import?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-04 16:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/symbols.rs</code>:800 on 2025-12-04 16:03</div>
            <div class="timeline-body"><p>I don&#x27;t think modules need to be considered separately here? They&#x27;ll just be like a regular symbol. And auto-import doesn&#x27;t suggest modules yet.</p>
<p>Also note the comment here: we are still returning these as part of the public API.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-04 16:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/symbols.rs</code>:905 on 2025-12-04 16:05</div>
            <div class="timeline-body"><p>I don&#x27;t think we need this level of precision here. I added some comments to clarify:</p>
<pre><code>    /// Track if we&#x27;re currently inside a function at any point.
    ///
    /// This is true even when we&#x27;re inside a class definition
    /// that is inside a class.
    in_function: bool,
    /// Track if we&#x27;re currently inside a class at any point.
    ///
    /// This is true even when we&#x27;re inside a function definition
    /// that is inside a class.
    in_class: bool,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-04 16:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/symbols.rs</code>:933 on 2025-12-04 16:14</div>
            <div class="timeline-body"><p>Ooo nice catch! Done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-04 16:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/symbols.rs</code>:1030 on 2025-12-04 16:16</div>
            <div class="timeline-body"><p>Nice! Done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-04 16:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/symbols.rs</code>:1024 on 2025-12-04 16:22</div>
            <div class="timeline-body"><p>I did switch this to <code>Name</code>, so allocs should be avoided in many cases now.</p>
<p>Switching to a borrowed <code>&amp;str</code> looks a little more tricky to me. I can always revisit this if it turns out to be a bottleneck.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/symbols.rs</code>:1451 on 2025-12-04 16:25</div>
            <div class="timeline-body"><p>Nice catch. Tests added!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-04 16:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-04 16:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/symbols.rs</code>:1507 on 2025-12-04 16:38</div>
            <div class="timeline-body"><p>Ah I was intentionally allowing sunder and dunder names (when <code>__all__</code> isn&#x27;t defined) to be exported. But I guess it breaks down in the re-export case. Thank you for catching this! Fixed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-04 16:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/symbols.rs</code>:1378 on 2025-12-04 16:41</div>
            <div class="timeline-body"><p>I think this was wrong. In this case, I don&#x27;t think <code>__ZQZQZQ</code> is even available at runtime? I&#x27;ve fixed it so that this case no longer returns <code>__ZQZQZQ</code>.</p>
<p>But more generally:</p>
<blockquote>
<p>Are we sure that we should consider double-underscore names as exports from a module?</p>
</blockquote>
<p>I don&#x27;t think we are sure. But I think the last time we talked about it (I&#x27;m having trouble finding that discussion), we came down on the side of showing them but ranked down. That&#x27;s the status quo today.</p>
<p>But I did file <a href="https://github.com/astral-sh/ty/issues/1757">astral-sh/ty#1757</a> where we can perhaps talk about this decision more.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/symbols.rs</code>:1539 on 2025-12-04 16:46</div>
            <div class="timeline-body"><p>Aye. I&#x27;ve added similarish comments to other tests with a negative result.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/symbols.rs</code>:1833 on 2025-12-04 16:54</div>
            <div class="timeline-body"><p>Ah yup. I added a comment noting this (and to a couple other tests where this is true too).</p>
<p>Interestingly, pylance behaves the same as ty (now does with this PR): an import is still offered, but it results in a runtime error.</p>
<p>I guess ideally we wouldn&#x27;t offer completions for such things, but I opened an issue tracking that <a href="https://github.com/astral-sh/ty/issues/1760">astral-sh/ty#1760</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_server/tests/e2e/snapshots/e2e__notebook__auto_import.snap</code>:9 on 2025-12-04 16:56</div>
            <div class="timeline-body"><p>This is just the ranking position of the completion. I don&#x27;t think it&#x27;s something that needs to be watched too carefully. In this case, it changed because some completions were added and some removed. So it changed the relative position.</p>
<p>I added a filter that redacts this part of the snapshot. I think this is okay especially given that we already have an evaluation running in CI that pays attention to ranking.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-04 17:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/Gankra">@Gankra</a> removed by <a href="https://github.com/Gankra">@Gankra</a> on 2025-12-04 17:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-04 17:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_completion_eval/completion-evaluation-tasks.csv</code>:14 on 2025-12-04 17:20</div>
            <div class="timeline-body"><p>I do mention them in my commit message for this change. This particular change is an improvement, since the expected result now appears at rank position 2 instead of 4.</p>
<p>As for reviewers <em>validating</em> them... if you wanted to do that, I think you&#x27;d have to run a <code>show-one</code> command to look at the completions returned. In this case (from the <a href="https://github.com/astral-sh/ruff/blob/main/crates/ty_completion_eval/README.md#running-an-evaluation">eval README</a>), that&#x27;d be:</p>
<pre><code>$ cargo r -q -p ty_completion_eval internal-typeshed-hidden --index 0
ALERT_DESCRIPTION_UNKNOWN_PSK_IDENTITY (module: ssl)
NoneType (module: types) (*, 2/4)
NotImplementedType (module: types)
REG_NOTIFY_CHANGE_SECURITY (module: winreg)
-----
found 4 completions
</code></pre>
<p>And you can look at the input like so (for example):</p>
<pre><code>$ cat ./crates/ty_completion_eval/truth/internal-typeshed-hidden/main.py
# This is a case where a symbol from an internal module appears
# before the desired symbol from `typing`.
#
# We use a slightly different example than the one reported in
# the issue to capture the deficiency via ranking. That is, in
# astral-sh/ty#1274, the (current) top suggestion is the correct one.
#
# ref: <a href="https://github.com/astral-sh/ty/issues/1274">astral-sh/ty#1274</a>#issuecomment-3345923575
NoneTy&lt;CURSOR: types.NoneType&gt;
</code></pre>
<p>I had considered being more verbose here with snapshots of the actual completion results, but I thought that might be a bit too much. There are a lot of tasks and some tasks generate lots of completions. So it is a bit laborious to validate these.</p>
<p>CI does check that the overall MRR averaged across all tasks doesn&#x27;t dip below a certain threshold.</p>
<p>When the ranking change like this, I usually look at a few examples (as shown above) to confirm it&#x27;s what I expect. With a special focus on regressions (when the ranking of the desired result increases).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-12-04 17:32</div>
            <div class="timeline-body"><blockquote>
<p>What&#x27;s our behaviour if <code>__all__</code> is assigned or updated in a non-global scope? E.g.</p>
<pre><code>__all__ = []

def foo():
    __all__.append(&quot;bar&quot;)

class X:
    def method(self):
        __all__.extend([&quot;baz&quot;])
</code></pre>
<p>I might have missed it, but I didn&#x27;t spot any tests for that. Does our behaviour here align with what we do in <code>ty_python_semantic</code>&#x27;s inference for <code>__all__</code>?</p>
</blockquote>
<p>I added a test for it. Auto-import sees <code>__all__</code> as empty here, which I think matches what <code>ty_python_semantic</code> does. In particular, the auto-import AST scanner will avoid walking into class/function bodies when looking for exported symbols. (It only walks into function/class bodies for document symbols, i.e., when the LSP wants to display a hierarchy of symbols.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-12-04 17:35</div>
            <div class="timeline-body"><p>OK, I believe I&#x27;ve addressed all feedback (or created issues for them). Thanks for the very in depth reviews!!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-12-04 17:35</div>
            <div class="timeline-body"><blockquote>
<p>I added a test for it. Auto-import sees <code>__all__</code> as empty here, which I think matches what <code>ty_python_semantic</code> does. In particular, the auto-import AST scanner will avoid walking into class/function bodies when looking for exported symbols. (It only walks into function/class bodies for document symbols, i.e., when the LSP wants to display a hierarchy of symbols.)</p>
</blockquote>
<p>yeah, that sounds correct. Though I guess class scopes in the global scope are eagerly executed, so we should probably recognise that <code>__all__</code> will be nonempty at the end of this module:</p>
<pre><code>__all__ = []

class Whatever:
    __all__.append(&quot;foo&quot;)
</code></pre>
<p>I also wouldn&#x27;t worry about this too much if we get it wrong currently though:</p>
<ol>
<li>It&#x27;s a real edge case (why on earth would a person or LLM write code like this?)</li>
<li>We probably get this wrong in <code>ty_python_semantic</code> too now that I think about it</li>
<li>If it hurts performance to check in class scopes inside the global scope (or class scopes inside class scopes inside global scopes, etc.) then it&#x27;s definitely not worth it</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-12-04 17:37</div>
            <div class="timeline-body"><p>Yeah I think <code>ty_python_semantic</code> also avoids recursing into function/class bodies:</p>
<p>https://github.com/astral-sh/ruff/blob/cccb0bbaa41e95a1efbe997ebe8119454f9b93f9/crates/ty_python_semantic/src/dunder_all.rs#L407-L410</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-12-04 17:41</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/symbols.rs</code>:1034 on 2025-12-04 17:41</div>
            <div class="timeline-body"><p>strictly speaking <code>ast::Expr::Named</code> nodes (&quot;walrus expressions&quot;) can also be used to define symbols, including the <code>__all__</code> symbol. I wouldn&#x27;t worry about that here, but it could be worth a TODO comment. We handle this in <code>ExportFinder</code> in <code>ty_python_semantic</code>, I think</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/symbols.rs</code>:1499 on 2025-12-04 17:43</div>
            <div class="timeline-body"><pre><code>        // Without `__all__` present, a wildcard import
        // won&#x27;t include names starting with an underscore at runtime.
        // So `_ZQZQZQ` should not be present here.
        // See: https://docs.python.org/3/reference/lexical_analysis.html#reserved-classes-of-identifiers
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/symbols.rs</code>:1514 on 2025-12-04 17:43</div>
            <div class="timeline-body"><pre><code>        // Without `__all__` present, a wildcard import
        // won&#x27;t include names starting with an underscore at runtime.
        // So `__ZQZQZQ` should not be present here.
        // See https://docs.python.org/3/reference/lexical_analysis.html#reserved-classes-of-identifiers
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-12-04 17:44</div>
            <div class="timeline-body"><p>Thank you -- fantastic work!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-12-04 17:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/symbols.rs</code>:1034 on 2025-12-04 17:48</div>
            <div class="timeline-body"><p>Aye I see yeah. I&#x27;ve added a TODO comment for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-12-04 18:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-12-04 18:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-12-04 18:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:21:21 UTC
    </footer>
</body>
</html>
