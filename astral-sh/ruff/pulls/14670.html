<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mdtest: allow specifying a specific test inside a file - astral-sh/ruff #14670</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>mdtest: allow specifying a specific test inside a file</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/14670">#14670</a>
        opened by <a href="https://github.com/connorskees">@connorskees</a>
        on 2024-11-29 06:52
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/connorskees">@connorskees</a></div>
            <div class="timeline-body"><p>Resolves <a href="https://github.com/astral-sh/ruff/issues/13868">astral-sh/ruff#13868</a> by adding an environment variable <code>MDTEST_FILE_FILTER</code> which can be used to specify a substring for tests to be filtered by. I was working around this when implementing another PR by deleting all the other tests in a file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/connorskees">@connorskees</a> on 2024-11-29 06:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/connorskees">@connorskees</a> on 2024-11-29 06:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/connorskees">@connorskees</a> on 2024-11-29 06:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/connorskees">@connorskees</a> on 2024-11-29 06:52</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/connorskees">@connorskees</a> on <code>crates/red_knot_test/src/lib.rs</code>:72 on 2024-11-29 06:53</div>
            <div class="timeline-body"><p>maybe this printing is too prescriptive of the exact command to be run / not windows-friendly enough? happy to reword, though i think keeping at least the print for the env var name is useful and solves the discoverability problem</p>
<p>i also sort of wish we were able to print a further filter for the test name itself, e.g. <code>-- mdtest__unpacking</code>. i didn&#x27;t find a simple+robust way to generate this name</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/connorskees">@connorskees</a> on <code>crates/red_knot_test/src/lib.rs</code>:38 on 2024-11-29 06:56</div>
            <div class="timeline-body"><p>just doing a simple case-sensitive substring check. this could also be changed to do a glob or regex, though then we have to think about escaping if we want to print the expected filter for a given test. shouldn&#x27;t be too big of a deal, so happy to implement another solution if we want to</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/connorskees">@connorskees</a> reviewed on 2024-11-29 06:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/connorskees">@connorskees</a> reviewed on 2024-11-29 06:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/connorskees">@connorskees</a> on <code>crates/red_knot_test/src/lib.rs</code>:72 on 2024-11-29 06:57</div>
            <div class="timeline-body"><img alt="Captura de pantalla 2024-11-29 a la(s) 1 57 31 a m" src="https://github.com/user-attachments/assets/5d09d03f-3361-4a25-b574-1889eb9e0a2f">
This is what it looks like rendered

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-11-29 06:59</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-29 07:13</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-29 07:13</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-29 07:14</div>
            <div class="timeline-body"><p>Thank you.</p>
<p>This is just a small note for the future. Please be sure to ask before you start working on issues that are assigned to someone to avoid duplicate work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/lib.rs</code>:66 on 2024-11-29 07:15</div>
            <div class="timeline-body"><pre><code>                &quot;\nTo rerun this specific test, set the environment variable: {MDTEST_FILE_FILTER}=\&quot;{}\&quot;&quot;,
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/lib.rs</code>:72 on 2024-11-29 07:18</div>
            <div class="timeline-body"><p>I think it&#x27;s fine as it is now.</p>
<p>It might be possible to use the <a href="https://doc.rust-lang.org/std/macro.module_path.html"><code>module_path</code></a> macro in the test function that you then pass through to the run call</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_test/src/lib.rs</code>:18 on 2024-11-29 07:20</div>
            <div class="timeline-body"><p>I would rename the environment variable to <code>MDTEST_TEST_FILTER</code> because the filter isn&#x27;t filtering files, but the test cases defined in a test suite (md file)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-11-29 07:20</div>
            <div class="timeline-body"><p>This looks good. Could we add some documentation to the crate README that explains the environment variable and its syntax</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-11-29 07:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2024-11-29 11:52</div>
            <div class="timeline-body"><p>Thanks for the PR @connorskees! I really appreciate it.</p>
<p>This is probably the easiest version of this feature to implement, so I&#x27;m fine with landing it for now and then iterating. But there are a bunch of things I&#x27;m not really a <em>massive</em> fan of here. Again, we don&#x27;t necessarily need to make any of these changes here in this PR, I&#x27;m just noting them for posterity:</p>
Usability on Windows
<p>We don&#x27;t have any people working at Astral right now who develop primarily on Windows, but I&#x27;m sure we have contributors (or potential contributors) who use Windows primarily. I used to use Windows primarily, and setting environment variables is kind of a pain on Windows. I&#x27;m not sure there even is a way to set them ephemerally as part of a single process. Ideally I think this would be a CLI flag rather than an environment variable. (But, as I say, I&#x27;m sure that&#x27;s harder to implement, so I&#x27;m fine with going for an environment variable for now.)</p>
Other tests are still shown by <code>cargo test</code> as having run even though all subtests are skipped
<p>E.g. here&#x27;s what I see if I create a deliberate failure in multiple test files, but then only select one subtest (using <code>MDTEST_TEST_FILTER=&#x27;A single bare `except`&#x27; cargo test -p red_knot_python_semantic --test mdtest</code>):</p>

Screenshot

<p><img src="https://github.com/user-attachments/assets/d92c25aa-f90d-4fb8-a096-ba8042696bfd" alt="image"></p>


<p>Ideally all the mdtests except for <code>test mdtest__exception_control_flow</code> would show as <code>... SKIPPED</code>. Otherwise it gives the impression that you&#x27;re running more tests than you actually are.</p>
Very long command needed
<p>To select <a href="https://github.com/astral-sh/ruff/blob/main/crates/red_knot_python_semantic/resources/mdtest/exception/control_flow.md#a-single-bare-except">this test</a> I need to type this command at the terminal:</p>
<pre><code>MDTEST_TEST_FILTER=&#x27;A single bare `except`&#x27; cargo test -p red_knot_python_semantic --test mdtest
</code></pre>
<p>That&#x27;s really quite a long command, and note that I need to include the backticks around the word &quot;except&quot;, which isn&#x27;t obvious if you&#x27;re reading the name of the test from <a href="https://github.com/astral-sh/ruff/blob/main/crates/red_knot_python_semantic/resources/mdtest/exception/control_flow.md#a-single-bare-except">the rendered Markdown on GitHub</a>. It might be better if, as well as being able to select tests by name, <code>red_knot_test</code> assigned each subtest a unique &quot;test ID&quot;, and we also allowed selecting tests by their test IDs. The framework could tell you the IDs of the tests that failed in its error report, allowing you to easily rerun just those tests using e.g.</p>
<pre><code>MDTEST_TEST_ID=42 cargo test -p red_knot_python_semantic --test mdtest
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-29 11:58</div>
            <div class="timeline-body"><blockquote>
<p>I&#x27;m not sure there even is a way to set them ephemerally as part of a single process. Ideally I think this would be a CLI flag rather than an environment variable. (But, as I say, I&#x27;m sure that&#x27;s harder to implement, so I&#x27;m fine with going for an environment variable for now.)</p>
</blockquote>
<p>There is, it&#x27;s just a bit more awkward: <code>set RUST_BACKTRACE=1 &amp;&amp; cargo bench --bench accumulator</code></p>
<blockquote>
<p>That&#x27;s really quite a long command, an</p>
</blockquote>
<p>That&#x27;s true. However, the test runner printing the command for you somewhat mitigates this. I don&#x27;t like numbers, but maybe we can come up with another identifier.</p>
<blockquote>
<p>Other tests are still shown by cargo test as having run even though all subtests are skipped</p>
</blockquote>
<p>This probably requires our own test runner. We could try extracting the full test name using <code>module_path</code>, see <a href="https://github.com/astral-sh/ruff/pull/14670">astral-sh/ruff#14670</a>/files/249b8134a37aae59e51cb0f93e7d65c7ba191879#diff-3ac9b4142b5271acdd34e8027226477c72f0ecf71e1dfc2b3a7295b13a7d8e0f</p>
<p>@connorskees do you want to give this a try in a follow up PR?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-29 11:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-29 11:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/connorskees">@connorskees</a> on 2024-11-29 15:12</div>
            <div class="timeline-body"><p>hm <code>module_path!</code> seems not to include the name of the function. i <em>was</em> able to get the name of the function by copying some code directly from <code>dir_test</code>. it&#x27;s not too much code if we&#x27;re fine with a less-elegant solution:</p>
<pre><code>fn test_name(test_func_name: String, fixture_path: &amp;Path) -&gt; String {
    assert!(fixture_path.is_file());

    let dir_path = format!(&quot;{}/resources/mdtest&quot;, std::env!(&quot;CARGO_MANIFEST_DIR&quot;));
    let rel_path = fixture_path.strip_prefix(dir_path).unwrap();
    assert!(rel_path.is_relative());

    let mut test_name = test_func_name;
    test_name.push_str(&quot;__&quot;);

    let components: Vec&lt;_&gt; = rel_path.iter().collect();

    for component in &amp;components[0..components.len() - 1] {
        let component = component
            .to_string_lossy()
            .replace(|c: char| c.is_ascii_punctuation(), &quot;_&quot;);
        test_name.push_str(&amp;component);
        test_name.push(&#x27;_&#x27;);
    }

    test_name.push_str(
        &amp;rel_path
            .file_stem()
            .unwrap()
            .to_string_lossy()
            .replace(|c: char| c.is_ascii_punctuation(), &quot;_&quot;),
    );

    test_name
}

// ...

let test_name = test_name(&quot;mdtest&quot;.to_owned(), fixture_path);
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-11-29 15:22</div>
            <div class="timeline-body"><p>Ah right. You could try using <code>type_name</code>:</p>
<pre><code>pub fn main() {
    struct Type;

    println!(&quot;{}&quot;, std::any::type_name::&lt;Type&gt;());
}
</code></pre>
<p>and then hide it behind a macro.</p>
<p>But I&#x27;m also okay constructing the name from the test file</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:08:57 UTC
    </footer>
</body>
</html>
