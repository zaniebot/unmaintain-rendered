<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Implement `PLR2004` (`MagicValueComparison`) - astral-sh/ruff #1828</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Implement <code>PLR2004</code> (<code>MagicValueComparison</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/1828">#1828</a>
        opened by <a href="https://github.com/max0x53">@max0x53</a>
        on 2023-01-12 18:48
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/max0x53">@max0x53</a> on 2023-01-12 18:48</div>
            <div class="timeline-body"><p>This PR adds <a href="https://pylint.pycqa.org/en/latest/user_guide/messages/refactor/magic-value-comparison.html#magic-value-comparison-r2004">Pylint <code>R2004</code></a></p>
<p>Feel free to suggest changes and additions, I have tried to maintain parity with the Pylint implementation <a href="https://github.com/PyCQA/pylint/blob/main/pylint/extensions/magic_value.py"><code>magic_value.py</code></a></p>
<p>See #970</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/not-my-profile">@not-my-profile</a> reviewed on 2023-01-12 19:21</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/not-my-profile">@not-my-profile</a> on <code>src/pylint/rules/magic_value_comparison.rs</code>:17 on 2023-01-12 19:21</div>
            <div class="timeline-body"><p>I think the following would be more idiomatic:</p>
<pre><code class="language-rust">if matches!(value.try_into(), Ok(-1 | 0 | 1)) {
    None
}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/max0x53">@max0x53</a> reviewed on 2023-01-12 19:34</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/max0x53">@max0x53</a> on <code>src/pylint/rules/magic_value_comparison.rs</code>:17 on 2023-01-12 19:34</div>
            <div class="timeline-body"><p>Agreed!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-12 21:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/pylint/rules/magic_value_comparison.rs</code>:17 on 2023-01-12 21:08</div>
            <div class="timeline-body"><p>It looks like Pylint flags on any constant, but allows strings <code>&quot;&quot;</code> and <code>&quot;__main__&quot;</code>.</p>
<p>https://pylint.pycqa.org/en/latest/user_guide/configuration/all-options.html#valid-magic-values</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-12 21:09</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/pylint/rules/magic_value_comparison.rs</code>:40 on 2023-01-12 21:09</div>
            <div class="timeline-body"><p>I think we may need to avoid comparisons between <em>two</em> constants?</p>
<p>https://github.com/PyCQA/pylint/blob/0c5ab132e262280da98742e5cf73ecc1cbfa7377/pylint/extensions/magic_value.py#L81</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-12 21:09</div>
            <div class="timeline-body"><p>This looks great! Couple comments to get it fully aligned with the Pylint implementation.</p>
<p>Speaking of: how do you enable this check with Pylint? I notice it's part of an &quot;extension&quot;. Trying to figure out how to test it locally...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/max0x53">@max0x53</a> on 2023-01-12 22:35</div>
            <div class="timeline-body"><p>To test R2004 with pylint you will need to follow their instructions for <a href="https://pylint.pycqa.org/en/latest/development_guide/contributor_guide/tests/install.html">Contributor installation</a>.</p>
<p>Once the basic installation is complete you can run the following to confirm you are on the main branch.</p>
<pre><code class="language-bash">$ pylint --version
pylint 2.16.0-dev
</code></pre>
<p>Once installed you can run the following command to test R2004 (with the flag <a href="https://pylint.pycqa.org/en/latest/whatsnew/2/2.16/index.html">documented here</a>)</p>
<pre><code class="language-bash">$ pylint --load-plugins=pylint.extensions.magic_value ./magic_value_comparison.py | grep R2004
&lt;PATH&gt;/ruff/resources/test/fixtures/pylint/magic_value_comparison.py:6:3: R2004: Consider using a named constant or an enum instead of '10'. (magic-value-comparison)
&lt;PATH&gt;/ruff/resources/test/fixtures/pylint/magic_value_comparison.py:29:3: R2004: Consider using a named constant or an enum instead of '2'. (magic-value-comparison)
&lt;PATH&gt;/ruff/resources/test/fixtures/pylint/magic_value_comparison.py:44:3: R2004: Consider using a named constant or an enum instead of 'Hunter2'. (magic-value-comparison)
&lt;PATH&gt;/ruff/resources/test/fixtures/pylint/magic_value_comparison.py:50:3: R2004: Consider using a named constant or an enum instead of '3.141592653589793'. (magic-value-comparison)
&lt;PATH&gt;/ruff/resources/test/fixtures/pylint/magic_value_comparison.py:59:3: R2004: Consider using a named constant or an enum instead of 'b'something''. (magic-value-comparison)
</code></pre>
<p>Hope this helps!</p>
<p>Current <code>ruff</code> output for completeness</p>
<pre><code class="language-bash">resources/test/fixtures/pylint/magic_value_comparison.py:6:4: PLR2004 Magic number used in comparison, consider replacing 10 with a constant variable
resources/test/fixtures/pylint/magic_value_comparison.py:29:4: PLR2004 Magic number used in comparison, consider replacing 2 with a constant variable
resources/test/fixtures/pylint/magic_value_comparison.py:44:4: PLR2004 Magic number used in comparison, consider replacing 'Hunter2' with a constant variable
resources/test/fixtures/pylint/magic_value_comparison.py:50:4: PLR2004 Magic number used in comparison, consider replacing 3.141592653589793 with a constant variable
resources/test/fixtures/pylint/magic_value_comparison.py:59:4: PLR2004 Magic number used in comparison, consider replacing b'something' with a constant variable
Found 5 error(s).
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/max0x53">@max0x53</a> reviewed on 2023-01-12 22:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/max0x53">@max0x53</a> on <code>src/pylint/rules/magic_value_comparison.rs</code>:40 on 2023-01-12 22:38</div>
            <div class="timeline-body"><p>Good catch, have added a comment to hopefully better explain why the rule is skipped.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/max0x53">@max0x53</a> on <code>src/pylint/rules/magic_value_comparison.rs</code>:17 on 2023-01-12 22:39</div>
            <div class="timeline-body"><p>Have updated to reflect this, required a refactor of some of the workings but I believe for the better.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/max0x53">@max0x53</a> reviewed on 2023-01-12 22:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>src/pylint/rules/magic_value_comparison.rs</code>:53 on 2023-01-12 22:48</div>
            <div class="timeline-body"><p>I think it'll be simpler to do something like:</p>
<pre><code>for (a, b) in std::iter::once(left).chain(comparators.iter()).tuple_windows() {
  if matches!(a.node, ExprKind::Constant { ... }) &amp;&amp; matches!(b.node, ExprKind::Constant { .. }) {
    return;
  }
}
</code></pre>
<p>At the top of the function.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-01-12 22:49</div>
            <div class="timeline-body"><p>Oh, thank you! So helpful.</p>
<p>I think there are still a few false-positives here:</p>
<pre><code class="language-py">if x == 3:
    pass

if 1 == 3:
    pass

if 4 == 3 == x:
    pass
</code></pre>
<p>Ruff gives:</p>
<pre><code>❯ cargo run foo.py --select PLR2004 -n
    Finished dev [unoptimized + debuginfo] target(s) in 0.14s
     Running `target/debug/ruff foo.py --select PLR2004 -n`
foo.py:1:4: PLR2004 Magic number used in comparison, consider replacing 3 with a constant variable
foo.py:4:4: PLR2004 Magic number used in comparison, consider replacing 3 with a constant variable
foo.py:7:4: PLR2004 Magic number used in comparison, consider replacing 3 with a constant variable
foo.py:7:4: PLR2004 Magic number used in comparison, consider replacing 4 with a constant variable
Found 4 error(s).
</code></pre>
<p>Whereas Pylint gives:</p>
<pre><code>❯ pylint --load-plugins=pylint.extensions.magic_value foo.py | grep R2004
foo.py:1:3: R2004: Consider using a named constant or an enum instead of '3'. (magic-value-comparison)
</code></pre>
<p>I think this comes down to: (1) for the purpose of <em>skipping</em>, Pylint considers <code>1</code> and such to be constants, even if they don't get flagged as magic, whereas the current implementation here does not (since it relies on the number of diagnostics generated); and (2) it looks like Pylint actually skips if there's <em>any</em> constant comparison, not just if they're all constant.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/max0x53">@max0x53</a> on 2023-01-12 23:23</div>
            <div class="timeline-body"><p>Let me know if you would prefer the 2nd for loop to be refactored into an iterator, have left as is for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "Implement PLR2004" to "Implement `PLR2004` (`MagicValueComparison`)" by @charliermarsh on 2023-01-12 23:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-12 23:29</div>
            <div class="timeline-body"><p>Thank you! Running CI now. Will merge on pass.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/max0x53">@max0x53</a> on 2023-01-12 23:31</div>
            <div class="timeline-body"><p>Cheers! Appreciate you being so responsive to PRs and a credit to <code>ruff</code> for being as easy as it was to add new linting rules (docs and code were great)!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-12 23:37</div>
            <div class="timeline-body"><p>Thank you, that's awesome to hear! (\cc @not-my-profile as he's made some refactors lately that, IMO, made adding rules a lot more accessible.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @charliermarsh on 2023-01-13 00:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @charliermarsh on 2023-01-13 00:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-01-13 00:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/martinkozle">@martinkozle</a> on 2023-01-16 11:49</div>
            <div class="timeline-body"><p>Now how do I ignore this lint? Because when I put <code>ignore = [&quot;PLR2004&quot;]</code> in <code>pyproject.toml</code> it says that it is not a valid option.</p>
<p>Edit: nvm, it does have an effect, <code>Better TOML</code> VSCode extension just says that it is not a valid option, I don't know if the problem is on my end</p>
<p>Edit 2: The linting was based on the version of ruff that comes with the VSCode extension where this lint wasn't implemented yet. So yes, it was a problem on my end</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-01-16 16:28</div>
            <div class="timeline-body"><p>(We have to update the JSON Schema manually in the Schema Store, unfortunately, so it sometimes gets a little out-of-date with latest Ruff.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/ofek">@ofek</a> on 2023-01-18 06:07</div>
            <div class="timeline-body"><p>Feature request: https://github.com/charliermarsh/ruff/issues/1949</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 05:26:15 UTC
    </footer>
</body>
</html>
