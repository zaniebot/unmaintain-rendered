<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] IDE: add support for `object.&lt;CURSOR&gt;` completions - astral-sh/ruff #18468</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] IDE: add support for <code>object.&lt;CURSOR&gt;</code> completions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18468">#18468</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2025-06-04 18:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-06-04 18:57</div>
            <div class="timeline-body"><p>This PR adds logic for detecting <code>Name Dot [Name]</code> token patterns,
finding the corresponding <code>ExprAttribute</code>, getting the type of the
object and returning the members available on that object.</p>
<p>Here's a video demonstrating this working:</p>
<p>https://github.com/user-attachments/assets/42ce78e8-5930-4211-a18a-fa2a0434d0eb</p>
<p>Ref astral-sh/ty#86</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @BurntSushi on 2025-06-04 18:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @BurntSushi on 2025-06-04 18:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @BurntSushi on 2025-06-04 18:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @BurntSushi on 2025-06-04 18:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @BurntSushi on 2025-06-04 18:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @BurntSushi on 2025-06-04 18:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @BurntSushi on 2025-06-04 18:58</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-06-04 19:00</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-06-04 19:03</div>
            <div class="timeline-body"><blockquote>
<p>Ref #86</p>
</blockquote>
<p>you mean astral-sh/ty#86 ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @AlexWaygood on 2025-06-04 19:03</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-06-04 19:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-06-04 19:07</div>
            <div class="timeline-body"><p>Yup. That's a hard one to get right for me haha.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/completion.rs</code>:30 on 2025-06-04 19:12</div>
            <div class="timeline-body"><p>to add an additional wrinkle here: names that start and end with a double-underscore (&quot;dunders&quot;) indicate attributes/methods that are given special treatment by the interpreter. It's less common to access these directly -- you would usually do <code>1 + 2</code> rather than <code>(1).__add__(2)</code>, for example -- but they're also not really &quot;private&quot; in the same way as other names that start with an underscore. So IMO the sorting should be:</p>
<ol>
<li>Any names that do not start with an underscore</li>
<li>Dunder names</li>
<li>Any other names that start with an underscore</li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/completion.rs</code>:1038 on 2025-06-04 19:20</div>
            <div class="timeline-body"><p>the relevant issue here is https://github.com/astral-sh/ty/issues/159, if you want to link to it!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-06-04 19:21</div>
            <div class="timeline-body"><p>Nice! I haven't reviewed the AST/tokenizing stuff in depth, but this looks reasonable to me!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/sharkdp">@sharkdp</a> on 2025-06-04 19:25</div>
            <div class="timeline-body"><p>I am planning to review this tomorrow. One thing that surprised me when testing this locally in the playground: in a scenario like the following, I get no completions at all. I need to type one additional letter before I start to see the completions on <code>C</code>. The snapshot tests seem to indicate that this should work?</p>
<pre><code class="language-py">class C:
    foo: int
    bar: str

C.&lt;CURSOR&gt;
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-06-05 05:32</div>
            <div class="timeline-body"><blockquote>
<p>One thing that surprised me when testing this locally in the playground: in a scenario like the following, I get no completions at all. I need to type one additional letter before I start to see the completions on <code>C</code>. The snapshot tests seem to indicate that this should work?</p>
</blockquote>
<p>This is because the server capabilities needs to be updated to include the <code>.</code> (dot) trigger character:</p>
<pre><code class="language-diff">diff --git a/crates/ty_server/src/server.rs b/crates/ty_server/src/server.rs
index 84093d6ffa..4846e0219c 100644
--- a/crates/ty_server/src/server.rs
+++ b/crates/ty_server/src/server.rs
@@ -180,6 +180,7 @@ impl Server {
             completion_provider: experimental
                 .is_some_and(Experimental::is_completions_enabled)
                 .then_some(lsp_types::CompletionOptions {
+                    trigger_characters: Some(vec!['.'.to_string()]),
                     ..Default::default()
                 }),
             ..Default::default()
diff --git a/playground/ty/src/Editor/Editor.tsx b/playground/ty/src/Editor/Editor.tsx
index fca03cd08b..a25e3b4ddb 100644
--- a/playground/ty/src/Editor/Editor.tsx
+++ b/playground/ty/src/Editor/Editor.tsx
@@ -179,7 +179,7 @@ class PlaygroundServer
       monaco.languages.registerDocumentFormattingEditProvider(&quot;python&quot;, this);
   }
 
-  triggerCharacters: undefined;
+  triggerCharacters: string[] = [&quot;.&quot;];
 
   provideCompletionItems(
     model: editor.ITextModel,
</code></pre>
<p>This will then inform the client / playground to request completions on <code>.</code> (dot).</p>
<p>For reference, this is Pyright's trigger characters:</p>
<pre><code>triggerCharacters = { &quot;.&quot;, &quot;[&quot;, '&quot;', &quot;'&quot; }
</code></pre>
<p>For context, the client needs to know when it should request completions which by default is usually <code>[a-zA-Z]</code> but the server can expand that set to include additional characters relevant for the server.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_ide/src/completion.rs</code>:30 on 2025-06-05 05:41</div>
            <div class="timeline-body"><p>I agree with this sorting behavior. I have a custom implementation in my editor that does the sorting of completion items in this way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_ide/src/completion.rs</code>:20 on 2025-06-05 05:44</div>
            <div class="timeline-body"><p>Should we use the completion context that the client could provide? The context would contain <em>how</em> was the completion triggered and if it was invoked by a trigger character (e.g., <code>.</code>) then which character it was.</p>
<p>Regardless of whether we use this information or not, we'd still need to find the AST node so it might be that it isn't really useful today but it could be in the future.</p>
<p>Completion params: https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#completionParams
Completion context: https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#completionContext</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_ide/src/completion.rs</code>:69 on 2025-06-05 05:55</div>
            <div class="timeline-body"><p>I think this is a great start but it seems to have a few limitations. I don't think these needs to be addressed here but I thought to write it down as a note. For example, doing <code>[].&lt;CURSOR&gt;</code> falls back to providing completions from the scope. Maybe we shouldn't use the fallback behavior when we know that the completion was triggered from a <code>.</code> character? I'm not sure, you might want to play around with this in an editor context.</p>
<p>A follow-up to this would be to expand the token kind that can occur before the <code>.</code> character so that completions on objects other than a variable work like list, dictionary, strings, etc. For example, in <code>[].&lt;CURSOR&gt;</code> we would provide completions for list attributes. We might have to be careful here because we can't just look at the previous token as it's only <code>[].&lt;CURSOR&gt;</code> (a syntactically valid list) should provide completion and not <code>].&lt;CURSOR&gt;</code>. Also, the list could be arbitrary long which means that there would could be <code>n</code> number of previous tokens to look before we see the <code>[</code> corresponding to the <code>]</code> in which case maybe we should rely on the AST instead.</p>
<p>Another example is when an attribute access happens directly on an instantiated class like <code>A().&lt;CURSOR&gt;</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ty_ide/src/completion.rs</code>:219 on 2025-06-05 06:07</div>
            <div class="timeline-body"><p>Another test case would be to have nested attributes which I don't think is being handled correctly:</p>
<pre><code class="language-py">class A:
    x: str


class B:
    a: A


b = B()
b.a.&lt;CURSOR&gt;
</code></pre>
<p><img width="486" alt="Screenshot 2025-06-05 at 11 36 22" src="https://github.com/user-attachments/assets/d97c10ef-9ee6-43d7-8294-c1271d650664" /></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-06-05 06:14</div>
            <div class="timeline-body"><p>Thank you! I think this is a good start, I've a few suggestions on what could be done next.</p>
<p>It's a bit unfortunate that we don't yet have E2E test infrastructure for the server, so when testing any server related features that require editor interaction, we usually add a short video demonstrating the functionality in the PR description. I'd recommend to include that whenever you think it'd be useful which I think would be useful in this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/completion.rs</code>:13 on 2025-06-05 07:10</div>
            <div class="timeline-body"><p>Maybe something for another PR but It would be great if we could extend <code>Completion</code> here with a <code>kind</code> that tells VS code what the completion is (is it a variable, a field, etc...). This is currently hard coded in the playground to always be <code>Variable</code> but that will be incorrect with this PR.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_ide/src/completion.rs</code>:69 on 2025-06-05 07:13</div>
            <div class="timeline-body"><p>Another one: Anything parenthesized: <code>(a).</code> or <code>{ a: True }.</code>...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-06-05 07:14</div>
            <div class="timeline-body"><p>Nice!</p>
<p>I think we need to set the completion options in the playground and the LSP setup because <code>.</code> isn't a trigger character by default. From the LSP specification</p>
<pre><code>	/**
	 * The additional characters, beyond the defaults provided by the client (typically
	 * [a-zA-Z]), that should automatically trigger a completion request. For example
	 * `.` in JavaScript represents the beginning of an object property or method and is
	 * thus a good candidate for triggering a completion request.
	 *
	 * Most tools trigger a completion request automatically without explicitly
	 * requesting it using a keyboard shortcut (e.g. Ctrl+Space). Typically they
	 * do so when the user starts to type an identifier. For example if the user
	 * types `c` in a JavaScript file code complete will automatically pop up
	 * present `console` besides others as a completion item. Characters that
	 * make up identifiers don't need to be listed here.
	 */
	triggerCharacters?: string[];
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-06-05 07:32</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_ide/src/completion.rs</code>:69 on 2025-06-05 07:32</div>
            <div class="timeline-body"><p>I had a similar thought while playing with this and reviewing the code. There are not that many places in Python's syntax where a <code>.</code> can appear(?). The ellipsis <code>...</code>, float literals <code>3.14</code>, and relative imports such as <code>from .mod import x</code> come to mind. This is very hand-wavy, but maybe this suggests that an &quot;opt out&quot; approach could work? That is, instead of explicitly matching on a set of patterns, maybe we should always try to find an enclosing attribute-expression if we see <code>DOT</code> or <code>DOT NAME</code>? This would mean we would also start the enclosing-node search for things like a float literal (<code>3.&lt;CURSOR&gt;</code>), but maybe that's not a problem?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-06-05 13:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:13 on 2025-06-05 13:12</div>
            <div class="timeline-body"><p>Yeah @dhruvmanila has mentioned this a few times, but I've been focusing on breadth (making completions work in more places) over depth (improving completion quality). Maybe I should pause on breadth for the moment and look at depth.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-06-05 13:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:219 on 2025-06-05 13:15</div>
            <div class="timeline-body"><p>I've captured this in a test. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-06-05 13:24</div>
            <div class="timeline-body"><p>For the trigger characters, nice catch @sharkdp and @dhruvmanila. I didn't notice that because I've been testing this by specifically opting into auto-completions. My editor doesn't show them automatically. I'll look into changing that.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-06-05 13:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:69 on 2025-06-05 13:30</div>
            <div class="timeline-body"><p>Yeah I like that idea @sharkdp!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-06-05 14:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:30 on 2025-06-05 14:50</div>
            <div class="timeline-body"><p>Done!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:20 on 2025-06-05 14:53</div>
            <div class="timeline-body"><p>I made a note about this. But in addition to the point you bring up, I don't think that completion context helps with completions that are triggered manually (which is primarily how I use compeltions). In that case, from what I can tell, there is no trigger character provided.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-06-05 14:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-06-05 14:57</div>
            <div class="timeline-body"><p>Thanks all for the feedback! I've addressed what I think is easy to address in this PR. Otherwise, in follow-up work, I would like to focus on improving the somewhat naive token-based detection here with something more flexible. i.e., To make things like <code>[].&lt;CURSOR&gt;</code> and <code>(a).&lt;CURSOR&gt;</code> work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-05 14:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/completion.rs</code>:171 on 2025-06-05 14:57</div>
            <div class="timeline-body"><pre><code class="language-suggestion">/// attributes, and all single-underscore attributes after dunder attributes.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-06-05 14:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:69 on 2025-06-05 14:59</div>
            <div class="timeline-body"><p>(I'll work on this in another PR.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/completion.rs</code>:188 on 2025-06-05 15:00</div>
            <div class="timeline-body"><p>a name that starts with <code>__</code> but does not end with <code>__</code> ends up being a &quot;mangled&quot; name, which is even more private than names that only start with <code>_</code>. I don't think it's worth distinguishing here between names that start with a single <code>_</code> and &quot;mangled&quot; names, <em>but</em> we definitely shouldn't categorise names as being dunder names unless they both start and end with <code>__</code></p>
<pre><code class="language-suggestion">            if name.starts_with(&quot;__&quot;) &amp;&amp; name.ends_with(&quot;__&quot;) {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-05 15:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-06-05 15:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_ide/src/completion.rs</code>:188 on 2025-06-05 15:01</div>
            <div class="timeline-body"><p>(see https://docs.python.org/3/reference/lexical_analysis.html#reserved-classes-of-identifiers and https://docs.python.org/3/reference/expressions.html#index-5)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-06-05 15:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:188 on 2025-06-05 15:07</div>
            <div class="timeline-body"><p>I forgot about those. Thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-06-05 15:09</div>
            <div class="timeline-body"><blockquote>
<p>we usually add a short video demonstrating the functionality in the PR description. I'd recommend to include that whenever you think it'd be useful which I think would be useful in this PR.</p>
</blockquote>
<p>Yes, thank you! That's a good idea. I've added a video to the top-level comment here.</p>
<p>In speaking with @MichaReiser, it seems like it would be a good idea for me to be testing this in VS Code as well. So I'll look into setting that up.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2025-06-05 15:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2025-06-05 15:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-06-05 15:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2025-06-06 05:52</div>
            <div class="timeline-body"><blockquote>
<p>Yes, thank you! That's a good idea. I've added a video to the top-level comment here.</p>
</blockquote>
<p>Thank you!</p>
<blockquote>
<p>In speaking with @MichaReiser, it seems like it would be a good idea for me to be testing this in VS Code as well. So I'll look into setting that up.</p>
</blockquote>
<p>Sounds good! The README over at https://github.com/astral-sh/ty-vscode should be good on how to do it. Feel free to provide any feedback if anything was confusing :)</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 18:45:32 UTC
    </footer>
</body>
</html>
