<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`pyupgrade`] [`ruff`] Don't apply renamings if the new name is shadowed in a scope of one of the references to the binding (`UP049`, `RUF052`) - astral-sh/ruff #16032</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>pyupgrade</code>] [<code>ruff</code>] Don't apply renamings if the new name is shadowed in a scope of one of the references to the binding (<code>UP049</code>, <code>RUF052</code>)</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16032">#16032</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2025-02-08 00:29
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Helps with #16024.</p>
<p>A fix will no longer be offered if the new name is invalid as an identifier or if it shadows a type parameter from an outer scope, while complex stringified type hints will cause it to be marked as unsafe.</p>
<p>The error message has also been changed from &quot;Remove the leading underscores&quot; to &quot;Rename type parameter to remove leading underscores&quot;, as the former would not be the best suggestion when the new name is not a valid identifier (e.g., <code>_0</code>).</p>
<h2>Test Plan</h2>
<p><code>cargo nextest run</code> and <code>cargo insta test</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @InSyncWithFoo on 2025-02-08 00:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-08 00:35</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-02-08 00:38</div>
            <div class="timeline-body"><p>@ntBre <code>Renamer</code> has a small problem in that it would also rename <code>_T</code> in this case:</p>
<pre><code class="language-python">class C[_T]:
	def f[T](self):
		a: _T = ...
</code></pre>
<p>The new logic introduced in this PR <em>does</em> check for existing bindings for <code>T</code>, but only at the top of the class, so it won't be able to detect bindings declared within inner scopes. This is a general problem with <code>Renamer</code>, so I decided not to fix it for now; instead, I added <a href="https://github.com/astral-sh/ruff/pull/16032/files#diff-648c2dda3437ddd6741025bf549e4114ebf45d326ad4ec058d74a17fa7e83326R93-R104">a few test cases</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-08 10:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/pep695/private_type_parameter.rs</code>:164 on 2025-02-08 10:33</div>
            <div class="timeline-body"><p>I don't think checking this again is necessary; no tests fail if I remove this added code. We already check this on line 133 with the <code>ShadowedKind</code> logic.</p>
<pre><code class="language-suggestion"></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-08 10:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/pep695/private_type_parameter.rs</code>:146 on 2025-02-08 10:37</div>
            <div class="timeline-body"><p>I was discussing this issue with @ntBre on Friday -- we think the issue with replacing &quot;complex&quot; stringized references is probably a result of us setting an incorrect range somewhere for <code>ResolvedReference</code>s where the reference is a &quot;complex&quot; stringized reference. I'm okay with this for now, but we should try to see if we can fix the underlying bug rather than working around it repeatedly</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-02-08 11:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">fixes</span> added by @AlexWaygood on 2025-02-08 11:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-02-08 11:19</div>
            <div class="timeline-body"><p>Thanks! I pushed a few changes so that this is fixed more holistically, and added some test cases for RUF052 as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-08 11:22</div>
            <div class="timeline-body"><p>This doesn't close #16024, however. Even on this branch, we get this behaviour:</p>
<pre><code>~/dev/ruff (UP049)⚡ [1] % cargo run -- check --no-cache --preview --diff --select=UP049 --target-version=py312 foo.py
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.12s
     Running `target/debug/ruff check --no-cache --preview --diff --select=UP049 --target-version=py312 foo.py`
--- foo.py
+++ foo.py
@@ -1 +1 @@
-class Foo[_T, __T]: ...
+class Foo[T, T]: ...

Would fix 2 errors.
</code></pre>
<p>So the fix can still introduce invalid syntax.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`pyupgrade`] Better fix logic (`UP049`)" to "[`pyupgrade`] [`ruff`] Don't apply renamings if the new name is shadowed in a scope of one of the references to the binding (`UP049`, `RUF052`))" by @AlexWaygood on 2025-02-08 11:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[`pyupgrade`] [`ruff`] Don't apply renamings if the new name is shadowed in a scope of one of the references to the binding (`UP049`, `RUF052`))" to "[`pyupgrade`] [`ruff`] Don't apply renamings if the new name is shadowed in a scope of one of the references to the binding (`UP049`, `RUF052`)" by @AlexWaygood on 2025-02-08 11:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-02-08 11:25</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-02-08 11:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-08 16:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/pyupgrade/rules/pep695/private_type_parameter.rs</code>:146 on 2025-02-08 16:30</div>
            <div class="timeline-body"><p>Aha -- it looks like there's already an issue open for the problem about ranges being incorrect for parsed nodes inside complex string annotations. It's here: https://github.com/astral-sh/ruff/issues/10586</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-02-08 16:52</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:09:50 UTC
    </footer>
</body>
</html>
