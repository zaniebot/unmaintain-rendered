<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add `NotebookIndex` to the cache - astral-sh/ruff #6863</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Add <code>NotebookIndex</code> to the cache</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6863">#6863</a>
        opened by <a href="https://github.com/dhruvmanila">@dhruvmanila</a>
        on 2023-08-25 06:15
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR updates the <code>FileCache</code> to include an optional <code>NotebookIndex</code> to support caching for Jupyter Notebooks.</p>
<p>We only require the index to compute the diagnostics and thus we don't really need to store the entire <code>Notebook</code> on the <code>Diagnostics</code> struct. This means we only need the index to be stored in the cache to reconstruct the <code>Diagnostics</code>.</p>
<h2>Test Plan</h2>
<p>Update an existing test case to run over the fixtures under <code>ruff_notebook</code> crate where there are multiple Jupyter Notebook.</p>
<p>Locally, the following commands were run in order:</p>
<ol>
<li>Remove the cache: <code>rm -rf .ruff_cache</code></li>
<li>Run without cache: <code>cargo run --bin ruff -- check --isolated crates/ruff_notebook/resources/test/fixtures/jupyter/unused_variable.ipynb --no-cache</code></li>
<li>Run with cache: <code>cargo run --bin ruff -- check --isolated crates/ruff_notebook/resources/test/fixtures/jupyter/unused_variable.ipynb</code></li>
<li>Check whether the <code>.ruff_cache</code> directory was created or not</li>
<li>Run with cache again and verify: <code>cargo run --bin ruff -- check --isolated crates/ruff_notebook/resources/test/fixtures/jupyter/unused_variable.ipynb</code></li>
</ol>
<p>fixes: #6671</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-25 06:27</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-09 12:03</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #6863</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6863" target="_blank"><img src="https://static.graphite.dev/graphite-32x32-black.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6863?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @dhruvmanila on 2023-09-09 12:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @dhruvmanila on 2023-09-09 12:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @dhruvmanila on 2023-09-09 12:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @dhruvmanila on 2023-09-09 12:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_cli/src/cache.rs</code>:270 on 2023-09-11 06:39</div>
            <div class="timeline-body"><pre><code class="language-suggestion">    /// Notebook index if this file is a IPython Notebook.
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2023-09-11 06:40</div>
            <div class="timeline-body"><p>Does the cached output now match the uncached output? How does the performance between cached and uncached notebooks compare?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-09-11 07:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2023-09-12 12:57</div>
            <div class="timeline-body"><blockquote>
<p>Does the cached output now match the uncached output?</p>
</blockquote>
<p>Yes, I've expanded the existing test case to test against the fixtures in <code>ruff_notebook</code> crate which contains a number of notebooks. I've also tested locally using the mentioned steps in the PR description and the output match.</p>
<blockquote>
<p>How does the performance between cached and uncached notebooks compare?</p>
</blockquote>
<h3>Size</h3>
<p>With a test directory containing a few repositories with Jupyter notebooks:</p>
<pre><code class="language-console">$ tokei ../test-repos/notebooks -t &quot;Jupyter Notebooks&quot;
===============================================================================
 Language            Files        Lines         Code     Comments       Blanks
===============================================================================
 Jupyter Notebooks    1221            0            0            0            0
 |- Markdown           272        14168          422        10048         3698
 |- Python             273        47807        37056         4219         6532
 (Total)                          61975        37478        14267        10230
===============================================================================
 Total                1221            0            0            0            0
===============================================================================
</code></pre>
<p>The disk size has increased because of the addition of notebook index stored in the cache:</p>
<pre><code class="language-console">$ du -h -d 1 ../cache-test                      
 12M	../cache-test/no-notebook-index
 14M	../cache-test/with-notebook-index
</code></pre>
<h3>Performace</h3>
<p>With the following <code>ruff.toml</code>:</p>
<pre><code class="language-toml">include = [&quot;*.ipynb&quot;]
</code></pre>
<p>Earlier, the output of a cached run on Jupyter Notebooks were incorrect because the cell information was not stored in the cache. With that in mind, the benchmarks are as follows:</p>
<ol>
<li>Uncached vs Cached runs on Jupyter Notebooks only file set:</li>
</ol>
<pre><code class="language-console">$ hyperfine --warmup 5 \
  &quot;./target/release/ruff check -e --config ./ruff.toml --no-cache --select=ALL ../test-repos/notebooks&quot; \
  &quot;./target/release/ruff check -e --config ./ruff.toml --cache-dir ../cache-test/notebook-index --select=ALL ../test-repos/notebooks&quot;
Benchmark 1: ./target/release/ruff check -e --config ./ruff.toml --no-cache --select=ALL ../test-repos/notebooks
  Time (mean Â± Ïƒ):      1.127 s Â±  0.073 s    [User: 6.342 s, System: 0.391 s]
  Range (min â€¦ max):    1.018 s â€¦  1.246 s    10 runs
 
Benchmark 2: ./target/release/ruff check -e --config ./ruff.toml --cache-dir ../cache-test/notebook-index --select=ALL ../test-repos/notebooks
  Time (mean Â± Ïƒ):     192.9 ms Â±   3.8 ms    [User: 277.7 ms, System: 138.7 ms]
  Range (min â€¦ max):   185.8 ms â€¦ 198.9 ms    15 runs
 
Summary
  ./target/release/ruff check -e --config ./ruff.toml --cache-dir ../cache-test/notebook-index --select=ALL ../test-repos/notebooks ran
    5.84 Â± 0.40 times faster than ./target/release/ruff check -e --config ./ruff.toml --no-cache --select=ALL ../test-repos/notebooks
</code></pre>
<p>The numbers are in line with non-Jupyter Notebook dataset</p>
<ol start="2">
<li>Cached with and without <code>NotebookIndex</code> in the cache:</li>
</ol>
<pre><code class="language-console">$ hyperfine --warmup 5 \
  &quot;./../ruff/target/release/ruff check -e --config ./ruff.toml --cache-dir ../cache-test/ruff-old --select=ALL ../test-repos/notebooks&quot; \
  &quot;./target/release/ruff check -e --config ./ruff.toml --cache-dir ../cache-test/ruff-new --select=ALL ../test-repos/notebooks&quot;      
Benchmark 1: ./../ruff/target/release/ruff check -e --config ./ruff.toml --cache-dir ../cache-test/ruff-old --select=ALL ../test-repos/notebooks
  Time (mean Â± Ïƒ):     181.6 ms Â±   3.6 ms    [User: 261.9 ms, System: 134.0 ms]
  Range (min â€¦ max):   177.5 ms â€¦ 188.5 ms    16 runs
 
Benchmark 2: ./target/release/ruff check -e --config ./ruff.toml --cache-dir ../cache-test/ruff-new --select=ALL ../test-repos/notebooks
  Time (mean Â± Ïƒ):     188.6 ms Â±   4.3 ms    [User: 276.8 ms, System: 134.8 ms]
  Range (min â€¦ max):   181.7 ms â€¦ 197.1 ms    15 runs
 
Summary
  ./../ruff/target/release/ruff check -e --config ./ruff.toml --cache-dir ../cache-test/ruff-old --select=ALL ../test-repos/notebooks ran
    1.04 Â± 0.03 times faster than ./target/release/ruff check -e --config ./ruff.toml --cache-dir ../cache-test/ruff-new --select=ALL ../test-repos/notebooks
</code></pre>
<p>Here, we can see that the performance has gone down a bit because of the new <code>NotebookIndex</code> which needs to be cloned from the cache to be used on <code>Diagnostics</code>. Both <code>FileCache</code> and <code>Diagnostics</code> owns the <code>NotebookIndex</code> which is the reason for cloning.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2023-09-12 12:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_cli/src/cache.rs</code>:270 on 2023-09-12 12:58</div>
            <div class="timeline-body"><p>I think the notebook will still be termed as &quot;Jupyter Notebook&quot;. It's the escape commands which are termed with the &quot;Ipy&quot; prefix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @dhruvmanila on 2023-09-12 12:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @dhruvmanila on 2023-09-12 12:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-09-12 12:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 16:59:48 UTC
    </footer>
</body>
</html>
