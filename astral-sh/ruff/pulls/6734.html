<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parenthesize unsplittable nodes if it makes them fit - astral-sh/ruff #6734</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Parenthesize unsplittable nodes if it makes them fit</h1>

    <div class="meta">
        <span class="state-icon state-closed"></span>
        <a href="https://github.com/astral-sh/ruff/pull/6734">#6734</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-08-21 15:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">

Summary
<p>This PR implements black&#x27;s logic where it parenthesizes unsplittable nodes like constants or identifiers
if it makes them fit the line</p>
<p>closes <a href="https://github.com/astral-sh/ruff/issues/6271">astral-sh/ruff#6271</a></p>


Test Plan
<p>I added new test plans, diffed the output for <code>django</code> to ensure this PR introduces no regression, and verified that the similarity indices improve</p>
<p><strong>main</strong></p>
<p>| project      | similarity index |
|--------------|------------------|
| cpython      | 0.75473          |
| django       | 0.99805          |
| transformers | 0.99620          |
| twine        | 0.99876          |
| typeshed     | 0.99953          |
| warehouse    | 0.99601          |
| zulip        | 0.99727          |</p>
<p><strong>This PR</strong></p>
<p>| project      | similarity index |
|--------------|------------------|
| cpython      | 0.75475          |
| django       | 0.99880          |
| transformers | 0.99629          |
| twine        | 0.99929          |
| typeshed     | 0.99953          |
| warehouse    | 0.99613          |
| zulip        | 0.99852          |</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-21 15:22</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #6734</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6734"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite"></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6734?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;Revert &quot;Remove `mode` from `BestFitting`&quot;&quot; to &quot;Parenthesize unsplittable nodes if it makes them fit&quot; by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-21 15:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-21 15:24</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-21 15:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:226 on 2023-08-21 15:26</div>
            <div class="timeline-body"><p>I&#x27;m not very happy with this name. The branches are the same as for <code>Never</code> except for <code>IfBreaks</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_formatter/src/builders.rs</code>:1 on 2023-08-21 15:27</div>
            <div class="timeline-body"><p>The formatter changes bring back the <code>BestFitting::print_mode</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-21 15:27</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_formatter/src/printer/mod.rs</code>:319 on 2023-08-21 15:28</div>
            <div class="timeline-body"><p>This was a bug in the Printer where group modes set during a previous <code>fits</code> test stuck around.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2023-08-21 15:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-08-21 16:35</div>
            <div class="timeline-body">PR Check Results
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      3.3Â±0.01ms    12.3 MB/sec    1.01      3.3Â±0.01ms    12.2 MB/sec
formatter/numpy/ctypeslib.py               1.00    672.9Â±9.44Âµs    24.7 MB/sec    1.01   682.9Â±10.25Âµs    24.4 MB/sec
formatter/numpy/globals.py                 1.00     70.9Â±0.64Âµs    41.6 MB/sec    1.01     71.4Â±0.46Âµs    41.3 MB/sec
formatter/pydantic/types.py                1.00  1339.1Â±13.73Âµs    19.0 MB/sec    1.03  1385.0Â±18.36Âµs    18.4 MB/sec
linter/all-rules/large/dataset.py          1.00     10.4Â±0.03ms     3.9 MB/sec    1.00     10.4Â±0.03ms     3.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      2.9Â±0.00ms     5.8 MB/sec    1.00      2.8Â±0.01ms     5.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    319.8Â±1.09Âµs     9.2 MB/sec    1.02    325.5Â±1.31Âµs     9.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.4Â±0.01ms     4.7 MB/sec    1.00      5.4Â±0.02ms     4.7 MB/sec
linter/default-rules/large/dataset.py      1.00      5.6Â±0.01ms     7.3 MB/sec    1.00      5.6Â±0.01ms     7.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1188.7Â±2.86Âµs    14.0 MB/sec    1.00   1179.5Â±3.44Âµs    14.1 MB/sec
linter/default-rules/numpy/globals.py      1.00    123.3Â±0.48Âµs    23.9 MB/sec    1.01    125.2Â±1.79Âµs    23.6 MB/sec
linter/default-rules/pydantic/types.py     1.01      2.5Â±0.03ms    10.1 MB/sec    1.00      2.5Â±0.01ms    10.1 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                    pr
-----                                      ----                                    --
formatter/large/dataset.py                 1.00      4.2Â±0.27ms     9.7 MB/sec     1.14      4.7Â±0.30ms     8.6 MB/sec
formatter/numpy/ctypeslib.py               1.00   859.5Â±44.50Âµs    19.4 MB/sec     1.14   980.8Â±74.39Âµs    17.0 MB/sec
formatter/numpy/globals.py                 1.00     91.6Â±9.00Âµs    32.2 MB/sec     1.04     95.2Â±6.78Âµs    31.0 MB/sec
formatter/pydantic/types.py                1.00  1810.5Â±124.71Âµs    14.1 MB/sec    1.08  1954.3Â±152.00Âµs    13.0 MB/sec
linter/all-rules/large/dataset.py          1.03     17.3Â±0.96ms     2.4 MB/sec     1.00     16.8Â±0.57ms     2.4 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.5Â±0.22ms     3.7 MB/sec     1.00      4.5Â±0.22ms     3.7 MB/sec
linter/all-rules/numpy/globals.py          1.04   606.3Â±44.76Âµs     4.9 MB/sec     1.00   584.6Â±72.40Âµs     5.0 MB/sec
linter/all-rules/pydantic/types.py         1.01      8.7Â±0.44ms     2.9 MB/sec     1.00      8.6Â±0.31ms     3.0 MB/sec
linter/default-rules/large/dataset.py      1.00      9.0Â±0.41ms     4.5 MB/sec     1.09      9.8Â±0.74ms     4.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1884.6Â±109.84Âµs     8.8 MB/sec    1.07      2.0Â±0.11ms     8.2 MB/sec
linter/default-rules/numpy/globals.py      1.00   224.4Â±14.22Âµs    13.1 MB/sec     1.10   246.2Â±12.56Âµs    12.0 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.9Â±0.15ms     6.5 MB/sec     1.06      4.1Â±0.19ms     6.2 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-08-21 17:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/expression/mod.rs</code>:226 on 2023-08-21 17:35</div>
            <div class="timeline-body"><p><code>BetterFitOnly</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-21 17:52</div>
            <div class="timeline-body"><p>Ouch, this is, not too surprisingly, not good for performance.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-08-21 18:01</div>
            <div class="timeline-body"><p>Is that mostly due to the <code>best_fitting!</code> or is there something else going on?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-21 18:27</div>
            <div class="timeline-body"><p>It&#x27;s a combination of memoized and best fitting, both of them allocate, and best fitting requires a <code>fits</code> pass for every variant except the last.</p>
<p>The solution is to limit the condition of when to use this layout. It should only be necessary if the content length is close to the max line length (I have to do some math tomorrow)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-23 12:10</div>
            <div class="timeline-body"><p>Splitting the PR must have confused graphite. See <a href="https://github.com/astral-sh/ruff/pull/6816">astral-sh/ruff#6816</a></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-08-23 12:10</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-01-16 10:04</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:56:31 UTC
    </footer>
</body>
</html>
