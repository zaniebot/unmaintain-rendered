```yaml
number: 6912
title: "Use dyn dispatch for `any_over_*`"
type: pull_request
state: merged
author: MichaReiser
labels:
  - internal
assignees: []
merged: true
base: main
head: any-over-dyn-dispatch
created_at: 2023-08-27T09:40:15Z
updated_at: 2023-08-27T13:54:02Z
url: https://github.com/astral-sh/ruff/pull/6912
synced_at: 2026-01-12T15:55:22Z
```

# Use dyn dispatch for `any_over_*`

---

_@MichaReiser_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This PR changes our `any_over_` functions to use dynamic dispatch over static dispatch because the use of `F: Fn(&Expr) -> bool` results in Rust monomorphizing the `any_over` function body for every passed closure. Resulting in `any_over_expr` being our 4th largest function in ruff:

```
Lines                  Copies               Function name
  -----                  ------               -------------
  1801126                36446                (TOTAL)
    33699 (1.9%,  1.9%)    141 (0.4%,  0.4%)  alloc::raw_vec::RawVec<T,A>::grow_amortized
    30284 (1.7%,  3.6%)    383 (1.1%,  1.4%)  core::iter::traits::iterator::Iterator::try_fold
    23751 (1.3%,  4.9%)      3 (0.0%,  1.4%)  <ruff::settings::options::_::<impl serde::de::Deserialize for ruff::settings::options::Options>::deserialize::__Visitor as serde::de::Visitor>::visit_map
    19173 (1.1%,  5.9%)     21 (0.1%,  1.5%)  ruff_python_ast::helpers::any_over_expr
```

The ideal solution would be inverse control by having an `expression` iterator. However, I haven't been able to come up with a fast implementation that doesn't require writing the child expressions to a temporary vec. 

## Test Plan

`cargo test`. This removes about 1% of llvm lines from the ruff crate. 

<!-- How was it tested? -->


---

_Comment by @MichaReiser on 2023-08-27 09:40_

Current dependencies on/for this PR:
* main
  * **PR #6912** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6912" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6912?utm_source=stack-comment).

---

_Comment by @codspeed-hq[bot] on 2023-08-27 09:48_

## [CodSpeed Performance Report](https://codspeed.io/astral-sh/ruff/branches/any-over-dyn-dispatch)

### Merging #6912 will **not alter performance**

<sub>Comparing <code>any-over-dyn-dispatch</code> (4925032) with <code>main</code> (f33277a)</sub>



### Summary

`âœ… 16` untouched benchmarks






---

_Comment by @github-actions[bot] on 2023-08-27 09:51_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Label `internal` added by @MichaReiser on 2023-08-27 09:52_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-08-27 12:14_

---

_Marked ready for review by @MichaReiser on 2023-08-27 12:14_

---

_@charliermarsh approved on 2023-08-27 13:43_

---

_Merged by @MichaReiser on 2023-08-27 13:54_

---

_Closed by @MichaReiser on 2023-08-27 13:54_

---

_Branch deleted on 2023-08-27 13:54_

---
