<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Fix edge cases for autocomplete suppressions in variable bindings - astral-sh/ruff #21576</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Fix edge cases for autocomplete suppressions in variable bindings</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/21576">#21576</a>
        opened by <a href="https://github.com/RasmusNygren">@RasmusNygren</a>
        on 2025-11-22 12:22
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/RasmusNygren">@RasmusNygren</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This handles a few edge cases related to https://github.com/astral-sh/ty/issues/1563  that was not fully handled in https://github.com/astral-sh/ruff/pull/21549</p>
<p>Only using the individual <code>Parameter</code> nodes in the AST to determine parameter bindings is not enough when you're in a state where the syntax is invalid. For example when the name of the parameter clashes with a keyword. In those scenarios we now go up a level and inspect the <code>Parameters</code> node to determine if we're still binding variables.</p>
<h2>Test Plan</h2>
<p>New tests and ty-playground sanity-check.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @RasmusNygren on 2025-11-22 12:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @RasmusNygren on 2025-11-22 12:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @RasmusNygren on 2025-11-22 12:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @RasmusNygren on 2025-11-22 12:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @RasmusNygren on 2025-11-22 12:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by @AlexWaygood on 2025-11-22 12:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-11-22 12:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-22 12:24</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/9f6d8ced7cd1c8d92687a4e9c96d7716452e471e/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/astral-sh-bot[bot]">@astral-sh-bot[bot]</a> on 2025-11-22 12:26</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">scikit-build-core (https://github.com/scikit-build/scikit-build-core)
- src/scikit_build_core/build/wheel.py:98:20: error[no-matching-overload] No overload of bound method `__init__` matches arguments
- Found 45 diagnostics
+ Found 44 diagnostics


</code></pre>
</details>

<p>No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/RasmusNygren">@RasmusNygren</a> on <code>crates/ty_ide/src/completion.rs</code>:1355 on 2025-11-22 12:26</div>
            <div class="timeline-body"><p>This is technically not relevant to this PR but I realised from https://github.com/astral-sh/ruff/pull/21570 that this calculation was logically incorrect. <code>typed.textlen()</code> is the length of the entire token, even if the cursor is currently in the middle of the token which is not quite what we want.</p>
<p>I have not managed to write a test based on suggestions that highlights this bug, but by calling <code>is_in_variable_binding</code> directly with different inputs it became obvious that it was previously incorrect.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/RasmusNygren">@RasmusNygren</a> reviewed on 2025-11-22 12:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @AlexWaygood on 2025-11-22 12:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @dcreager removed by @MichaReiser on 2025-11-22 14:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @MichaReiser on 2025-11-22 14:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @sharkdp removed by @MichaReiser on 2025-11-22 14:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @MichaReiser on 2025-11-22 14:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:1349 on 2025-11-24 20:05</div>
            <div class="timeline-body"><p>This actually wasn't my intent, but maybe I was wrong. In particular, rust-analyzer and pylance work how you describe: it only considers the characters before the cursor when the cursor splits a token. ty doesn't. It uses the entire token as the query.</p>
<p>I initially went this route because when you select a completion, clients seem to usually replace the <em>entire</em> token with the selected suggestion. So in my mind, it made sense for the query to also correspond to the entire token. With that said, while rust-analyzer replaces the entire token, pylance does not.</p>
<p>I do kind of feel like only taking the text before the cursor is perhaps more intuitive and even more useful. (I'm undecided on the token replacement strategy though.)</p>
<p>So to that end, perhaps the code that extracts the typed text should cut itself off based on the offset? Then I think that would fix this without needing to do this extra arithmetic here.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:1427 on 2025-11-24 20:11</div>
            <div class="timeline-body"><p>This makes sense to me. Nice find!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-11-24 20:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/RasmusNygren">@RasmusNygren</a> reviewed on 2025-11-24 21:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/RasmusNygren">@RasmusNygren</a> on <code>crates/ty_ide/src/completion.rs</code>:1349 on 2025-11-24 21:13</div>
            <div class="timeline-body"><p>Right, I agree with you that only considering text to the left of the cursor feels more intuitive, independently from whether the client replaces the entire token or not. Given that, it would be quite nice to only extract the relevant bit from the start, so we can be consistent without any special handling.</p>
<p>Would you like me to open a separate PR (maybe even an issue) for that (as I jumbled two issues into one PR here) or are you fine if I execute on that directly here?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-11-24 21:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_ide/src/completion.rs</code>:1349 on 2025-11-24 21:15</div>
            <div class="timeline-body"><p>I think just doing that directly here is fine. :-) Thank you!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @BurntSushi by @RasmusNygren on 2025-11-24 21:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> approved on 2025-11-25 13:25</div>
            <div class="timeline-body"><p>Beautiful. I also added a test that <code>foo&lt;CURSOR&gt;bar</code> only takes <code>foo</code> into account when offering suggestions.</p>
<p>Before:</p>
<p>https://github.com/user-attachments/assets/a771f855-f54e-41ae-93a4-8b69b2a56eee</p>
<p>After:</p>
<p>https://github.com/user-attachments/assets/641f2f34-12ef-46f9-9ca0-3ee8cddc758d</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @BurntSushi on 2025-11-25 14:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @BurntSushi on 2025-11-25 14:09</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2026-01-15 18:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-15 18:52:19 UTC
    </footer>
</body>
</html>
