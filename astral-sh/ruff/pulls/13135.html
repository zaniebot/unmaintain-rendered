<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Reduce some repetitiveness in tests - astral-sh/ruff #13135</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Reduce some repetitiveness in tests</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13135">#13135</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-08-28 09:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>~~This PR derives <code>is_macro::Is</code> on the <code>Type</code> enum, to reduce repetitiveness across our red-knot test suite. The <code>expect_*</code> methods that the macro generates for us are particularly useful for testing: we can remove quite a lot of duplication now, and I expect that we'll have a need to add similar tests in the future.~~</p>
<p>~~<code>is-macro</code> is an existing dependency of Ruff, and I doubt we'll be getting rid of it from Ruff anytime soon, as its use in Ruff is quite widespread.~~</p>
<p>Following discussion on this PR, it now just adds handwritten methods that are the equivalent of what <code>is-macro</code> would generate for us.</p>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @AlexWaygood on 2024-08-28 09:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2024-08-28 09:47</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-08-28 09:47</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-08-28 10:06</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:292 on 2024-08-28 12:09</div>
            <div class="timeline-body"><p>What's the rationale for this name change?</p>
<p>Looking at https://rust-lang.github.io/api-guidelines/naming.html#ad-hoc-conversions-follow-as_-to_-into_-conventions-c-conv it seems to me that if we are adding a conventional prefix here, the appropriate one would be <code>to_</code>, as this is a conversion that stays at the same level of abstraction, and also doesn't consume <code>self</code> (<code>Type</code> is <code>Copy</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-08-28 12:12</div>
            <div class="timeline-body"><p>This looks pretty nice to me! The only part I don't understand the reason for is the rename from <code>instance</code> to <code>into_instance</code>.</p>
<p>I know @MichaReiser has objections to <code>is-macro</code>, but I don't understand them, so it'd probably be nice to wait for his review so we can discuss before merging.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-28 12:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:292 on 2024-08-28 12:16</div>
            <div class="timeline-body"><p>The name of the method has to change because it now conflicts with a generated <code>instance()</code> method that deriving <code>is_macro::Is</code> adds to the class: <code>ty.instance()</code> would produce <code>Some(&lt;inner class type&gt;)</code> if <code>ty</code> was a <code>Type::Instance</code> variant, or <code>None</code> if not.</p>
<blockquote>
<p>it seems to me that if we are adding a conventional prefix here, the appropriate one would be <code>to_</code>, as this is a conversion that stays at the same level of abstraction, and also doesn't consume <code>self</code> (<code>Type</code> is <code>Copy</code>).</p>
</blockquote>
<p>Ahh, good point, <code>to_</code> is the better prefix here. I'll make that change, thanks!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-28 12:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:292 on 2024-08-28 12:18</div>
            <div class="timeline-body"><p>See https://docs.rs/is-macro/latest/is_macro/derive.Is.html#example. It's possible to rename the <code>is-macro</code>-generated methods, but here it feels easier to rename the custom method we already have</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-08-29 11:33</div>
            <div class="timeline-body"><p>This doesn't necessarily need to block this PR but one drawback that I've faced a couple of times in the past is that rust-analyzer won't be able to update the method references when a variant is renamed using the rename capability. Using explicit methods allows us to do that by simply renaming the references of the variants and the method. From that point onwards, I've usually tried to avoid using <code>is-macro</code> unless it provides a net benefit.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-08-29 11:41</div>
            <div class="timeline-body"><blockquote>
<p>This doesn't necessarily need to block this PR but one drawback that I've faced a couple of times in the past is that rust-analyzer won't be able to update the method references when a variant is renamed using the rename capability. Using explicit methods allows us to do that by simply renaming the references of the variants and the method. From that point onwards, I've usually tried to avoid using <code>is-macro</code> unless it provides a net benefit.</p>
</blockquote>
<p>Ah, thanks. That's a great point and definitely worth keeping in mind. For this case specifically, I still feel like the usefulness of the generated methods outweighs that cost, especially since it's a large enum already which is likely to continue growing as we add support for more typing features. But I absolutely agree that we should in general try to check whether we actually <em>need</em> <code>is-macro</code> on a given enum before deriving it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-09-02 06:40</div>
            <div class="timeline-body"><blockquote>
<p>This doesn't necessarily need to block this PR but one drawback that I've faced a couple of times in the past is that rust-analyzer won't be able to update the method references when a variant is renamed using the rename capability. Using explicit methods allows us to do that by simply renaming the references of the variants and the method. From that point onwards, I've usually tried to avoid using <code>is-macro</code> unless it provides a net benefit.</p>
</blockquote>
<p>This, and it also has the downside that I can't search for references. E.g. find all references to <code>is_any</code> won't work because there's no such method that I can select in the IDE. I only recently ran into this again when searching for all usages of <code>PreviewMode.is_enabled</code> which I couldn't. I had to remove the <code>is_macro</code> and add the method manually to find all referneces.</p>
<p>It's also important to note that the <code>is-macro</code> adds many more methods:</p>
<ul>
<li><code>as_*</code></li>
<li><code>as_mut_*</code></li>
<li><code>expect_*</code></li>
<li><code>*</code> (which should be named <code>into_*</code> to follow ruff's/rust's naming convention)</li>
</ul>
<p>I still prefer not to use the is-macro because it just got in my way in the past when it make refactors or finding references more painful at the mere benefit that adding the methods becomes cheaper. Making adding the methods cheap also comes at the downside that we don't think about whether we want all these methods and how the methods should be named.</p>
<p>I won't block this change but I keep my preference. If you go ahead with this, please rename the take methods to <code>into_</code>. I would love to link you to some documentation but it seems the macro is entirely undocumented and it seems that renaming the <code>take</code> method isn't possible. Which is kind of a deal breaker to me because it means that all types using the <code>is-macro</code> don't follow our naming convention (<a href="https://docs.rs/is-macro/latest/src/is_macro/lib.rs.html#284-291">source</a>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-09-02 06:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:432 on 2024-09-02 06:58</div>
            <div class="timeline-body"><p>I do like the rename from <code>instance</code> to <code>to_instance</code> or <code>as_instance</code> because it is a conversion method and not a simple getter.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[red-knot] Use `is-macro` to reduce repetitiveness in tests" to "[red-knot] Reduce some repetitiveness in tests" by @AlexWaygood on 2024-09-02 15:29</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-09-02 15:30</div>
            <div class="timeline-body"><p>I still think we may want to use <code>is-macro</code> at some point, as I expect this enum will continue to grow in the coming months. But for now I've switched the PR so that it just writes out by hand the methods we'd find useful.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @AlexWaygood on 2024-09-02 15:30</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:300 on 2024-09-02 16:22</div>
            <div class="timeline-body"><p>Nit: My preferred way here is:</p>
<pre><code>let function =  ty.into_function().unwrap();
</code></pre>
<p>I do find <code>into_*</code> helpers generally useful and I'm fine if tests simply fail with an <code>unwrap</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-09-02 16:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-09-03 09:51</div>
            <div class="timeline-body"><h2><a href="https://codspeed.io/astral-sh/ruff/branches/AlexWaygood:is-macro">CodSpeed Performance Report</a></h2>
<h3>Merging #13135 will <strong>degrade performances by 4.45%</strong></h3>
<p><sub>Comparing <code>AlexWaygood:is-macro</code> (64df49b) with <code>main</code> (facf6fe)</sub></p>
<h3>Summary</h3>
<p><code>❌ 1</code> regressions
<code>✅ 31</code> untouched benchmarks</p>
<blockquote>
<p>:warning: <em>Please fix the performance issues or <a href="https://codspeed.io/astral-sh/ruff/branches/AlexWaygood:is-macro">acknowledge them on CodSpeed</a>.</em></p>
</blockquote>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>main</code> | <code>AlexWaygood:is-macro</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ❌ | <code>linter/default-rules[pydantic/types.py]</code> | 1.8 ms | 1.9 ms | -4.45% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2024-09-03 10:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-09-03 10:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-09-03 10:26</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:06:14 UTC
    </footer>
</body>
</html>
