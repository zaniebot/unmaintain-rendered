<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insert empty line between suite and alternative branch after def/class - astral-sh/ruff #12294</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Insert empty line between suite and alternative branch after def/class</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12294">#12294</a>
        opened by <a href="https://github.com/konstin">@konstin</a>
        on 2024-07-12 08:26
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a></div>
            <div class="timeline-body"><p>When there is a function or class definition at the end of a suite followed by the beginning of an alternative block, we have to insert a single empty line between them.</p>
<p>In the if-else-statement example below, we insert an empty line after the <code>foo</code> in the if-block, but none after the else-block <code>foo</code>, since in the latter case the enclosing suite already adds empty lines.</p>
<pre><code>if sys.version_info &gt;= (3, 10):
    def foo():
        return &quot;new&quot;
else:
    def foo():
        return &quot;old&quot;
class Bar:
    pass
</code></pre>
<p>To do so, we track whether the current suite is the last one in the current statement with a new option on the suite kind.</p>
<p>Fixes #12199</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/konstin">@konstin</a> on 2024-07-12 08:26</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">formatter</span> added by <a href="https://github.com/konstin">@konstin</a> on 2024-07-12 08:26</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-07-12 08:36</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Formatter (stable)
<p>ℹ️ ecosystem check <strong>encountered format errors</strong>. (no format changes; 1 project error)</p>
<a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to parse examples/chatgpt/gpt_actions_library/.gpt_action_getting_started.ipynb:11:1:1: Expected an expression
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_bigquery.ipynb:13:1:1: Expected an expression
</code></pre>
</p>


Formatter (preview)
<p>ℹ️ ecosystem check <strong>detected format changes</strong>. (+15 -0 lines in 14 files in 5 projects; 1 project error; 48 projects unchanged)</p>
<a href="https://github.com/bokeh/bokeh">bokeh/bokeh</a> (+5 -0 lines across 5 files)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<p><a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/setup.py#L42">setup.py~L42</a></p>
<pre><code> 
     def yellow(text: str) -&gt; str:
         return f&quot;{colorama.Fore.YELLOW}{text}{colorama.Style.RESET_ALL}&quot;
+
 except ModuleNotFoundError:
 
     def _plain(text: str) -&gt; str:
</code></pre>
<p><a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/command/subcommands/file_output.py#L193">src/bokeh/command/subcommands/file_output.py~L193</a></p>
<pre><code> 
                 def indexed(i: int) -&gt; str:
                     return filename
+
             else:
 
                 def indexed(i: int) -&gt; str:
</code></pre>
<p><a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/core/has_props.py#L49">src/bokeh/core/has_props.py~L49</a></p>
<pre><code>     F = TypeVar(&quot;F&quot;, bound=Callable[..., Any])
 
     def lru_cache(arg: int | None) -&gt; Callable[[F], F]: ...
+
 else:
     from functools import lru_cache
 
</code></pre>
<p><a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/src/bokeh/document/locking.py#L93">src/bokeh/document/locking.py~L93</a></p>
<pre><code>         @wraps(func)
         async def _wrapper(*args: Any, **kw: Any) -&gt; None:
             await func(*args, **kw)
+
     else:
 
         @wraps(func)
</code></pre>
<p><a href="https://github.com/bokeh/bokeh/blob/829b2a75c402d0d0abd7e37ff201fbdfd949d857/tests/unit/bokeh/core/test_has_props.py#L556">tests/unit/bokeh/core/test_has_props.py~L556</a></p>
<pre><code>         class DupeProps(hp.HasProps):
             bar = AngleSpec()
             bar_units = String()
+
     except RuntimeError as e:
         assert str(e) == &quot;Two property generators both created DupeProps.bar_units&quot;
     else:
</code></pre>
</p>

<a href="https://github.com/langchain-ai/langchain">langchain-ai/langchain</a> (+2 -0 lines across 2 files)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<p><a href="https://github.com/langchain-ai/langchain/blob/0da5078cad3a689e51cd451c7cac63ac35b5accd/libs/community/tests/unit_tests/chat_message_histories/test_sql.py#L10">libs/community/tests/unit_tests/chat_message_histories/test_sql.py~L10</a></p>
<pre><code> 
     class Base(DeclarativeBase):
         pass
+
 except ImportError:
     # for sqlalchemy &lt; 2
     from sqlalchemy.ext.declarative import declarative_base
</code></pre>
<p><a href="https://github.com/langchain-ai/langchain/blob/0da5078cad3a689e51cd451c7cac63ac35b5accd/libs/core/langchain_core/messages/utils.py#L765">libs/core/langchain_core/messages/utils.py~L765</a></p>
<pre><code> 
         def list_token_counter(messages: Sequence[BaseMessage]) -&gt; int:
             return sum(token_counter(msg) for msg in messages)  # type: ignore[arg-type, misc]
+
     else:
         list_token_counter = token_counter  # type: ignore[assignment]
 
</code></pre>
</p>

<a href="https://github.com/python/typeshed">python/typeshed</a> (+4 -0 lines across 3 files)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<p><a href="https://github.com/python/typeshed/blob/f863db6bc5242348ceaa6a3bca4e59aa9e62faaa/stdlib/dbm/gnu.pyi#L44">stdlib/dbm/gnu.pyi~L44</a></p>
<pre><code> 
     if sys.version_info &gt;= (3, 11):
         def open(filename: StrOrBytesPath, flags: str = &quot;r&quot;, mode: int = 0o666, /) -&gt; _gdbm: ...
+
     else:
         def open(filename: str, flags: str = &quot;r&quot;, mode: int = 0o666, /) -&gt; _gdbm: ...
</code></pre>
<p><a href="https://github.com/python/typeshed/blob/f863db6bc5242348ceaa6a3bca4e59aa9e62faaa/stdlib/inspect.pyi#L334">stdlib/inspect.pyi~L334</a></p>
<pre><code>             locals: Mapping[str, Any] | None = None,
             eval_str: bool = False,
         ) -&gt; Self: ...
+
     else:
         @classmethod
         def from_callable(cls, obj: _IntrospectableCallable, *, follow_wrapped: bool = True) -&gt; Self: ...
</code></pre>
<p><a href="https://github.com/python/typeshed/blob/f863db6bc5242348ceaa6a3bca4e59aa9e62faaa/stdlib/ipaddress.pyi#L46">stdlib/ipaddress.pyi~L46</a></p>
<pre><code>         def __ge__(self, other: Self) -&gt; bool: ...
         def __gt__(self, other: Self) -&gt; bool: ...
         def __le__(self, other: Self) -&gt; bool: ...
+
     else:
         def __ge__(self, other: Self, NotImplemented: Any = ...) -&gt; bool: ...
         def __gt__(self, other: Self, NotImplemented: Any = ...) -&gt; bool: ...
</code></pre>
<p><a href="https://github.com/python/typeshed/blob/f863db6bc5242348ceaa6a3bca4e59aa9e62faaa/stdlib/ipaddress.pyi#L84">stdlib/ipaddress.pyi~L84</a></p>
<pre><code>         def __ge__(self, other: Self) -&gt; bool: ...
         def __gt__(self, other: Self) -&gt; bool: ...
         def __le__(self, other: Self) -&gt; bool: ...
+
     else:
         def __ge__(self, other: Self, NotImplemented: Any = ...) -&gt; bool: ...
         def __gt__(self, other: Self, NotImplemented: Any = ...) -&gt; bool: ...
</code></pre>
</p>

<a href="https://github.com/indico/indico">indico/indico</a> (+3 -0 lines across 3 files)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<p><a href="https://github.com/indico/indico/blob/b5c193fb11a8d2e399352160a7b60153ac906907/indico/modules/events/contributions/util.py#L110">indico/modules/events/contributions/util.py~L110</a></p>
<pre><code>             if not c.speakers:
                 return True, None
             return False, speakers[0].get_full_name(last_name_upper=False, abbrev_first_name=False).lower()
+
     elif sort_by == BOASortField.board_number:
         key_func = attrgetter(&#x27;board_number&#x27;)
     elif sort_by == BOASortField.session_board_number:
</code></pre>
<p><a href="https://github.com/indico/indico/blob/b5c193fb11a8d2e399352160a7b60153ac906907/indico/web/flask/templating.py#L63">indico/web/flask/templating.py~L63</a></p>
<pre><code>             if isinstance(item, str):
                 item = item.lower()
             return natural_sort_key(item)
+
     else:
         sort_func = natural_sort_key
 
</code></pre>
<p><a href="https://github.com/indico/indico/blob/b5c193fb11a8d2e399352160a7b60153ac906907/indico/web/flask/util.py#L78">indico/web/flask/util.py~L78</a></p>
<pre><code>             # Indico RH
             def wrapper(**kwargs):
                 return obj().process()
+
         else:
             # Some class we didn&#x27;t expect.
             raise ValueError(f&#x27;Unexpected view func class: {obj!r}&#x27;)
</code></pre>
</p>

<a href="https://github.com/mesonbuild/meson-python">mesonbuild/meson-python</a> (+1 -0 lines across 1 file)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<p><a href="https://github.com/mesonbuild/meson-python/blob/063fe8bc8ad6984c29b24a0f72a14e1ced091a9c/mesonpy/_compat.py#L29">mesonpy/_compat.py~L29</a></p>
<pre><code> 
     def read_binary(package: str, resource: str) -&gt; bytes:
         return importlib.resources.files(package).joinpath(resource).read_bytes()
+
 else:
     read_binary = importlib.resources.read_binary
 
</code></pre>
</p>

<a href="https://github.com/openai/openai-cookbook">openai/openai-cookbook</a> (error)
<p>
<pre>ruff format --preview</pre>
</p>
<p>

<pre><code>warning: Detected debug build without --no-cache.
error: Failed to parse examples/chatgpt/gpt_actions_library/.gpt_action_getting_started.ipynb:11:1:1: Expected an expression
error: Failed to parse examples/chatgpt/gpt_actions_library/gpt_action_bigquery.ipynb:13:1:1: Expected an expression
</code></pre>
</p>


</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/konstin">@konstin</a> on 2024-07-12 08:38</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2024-07-12 09:03</div>
            <div class="timeline-body"><p>Not sure if this counts as bugfix or breaking change, i&#x27;m fine with merging it before the next breaking release.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-12 09:10</div>
            <div class="timeline-body"><blockquote>
<p>Not sure if this counts as bugfix or breaking change, i&#x27;m fine with merging it before the next breaking release.</p>
</blockquote>
<p>I think we have to gate this behind preview according to our version policy. The version policy only allows formatting style changes that address instabilities or formatting that lead to invalid syntax.</p>
<p>The ecosystem checks look good :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/konstin">@konstin</a> on 2024-07-12 10:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/MichaReiser">@MichaReiser</a> removed by <a href="https://github.com/konstin">@konstin</a> on 2024-07-12 10:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/konstin">@konstin</a> on 2024-07-12 10:02</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-07-15 07:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/other/except_handler_except_handler.rs</code>:49 on 2024-07-15 07:22</div>
            <div class="timeline-body"><p>Nit: Any specific reason why you decide to introduce a <code>format</code> function for except handlers rather than adding a field to the options? I&#x27;m fine with either, I&#x27;m mainly surprised that you went with a format function here, but decided to introduce an <code>Options</code> struct for <code>match_case</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_match.rs</code>:39 on 2024-07-15 07:25</div>
            <div class="timeline-body"><p>I&#x27;m probably blind but what do we need the <code>peekable</code> for?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_match.rs</code>:51 on 2024-07-15 07:26</div>
            <div class="timeline-body"><pre><code>            let last_suite_in_statement = Some(case) == cases.last();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/stmt_try.rs</code>:71 on 2024-07-15 07:27</div>
            <div class="timeline-body"><p>I don&#x27;t think that&#x27;s technically possible. A try statement must always have an <code>except</code> handler or a <code>finally</code> body. That&#x27;s why it should be fine to assume <code>false</code> for <code>Try</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/suite.rs</code>:35 on 2024-07-15 07:29</div>
            <div class="timeline-body"><p>It&#x27;s not just statements, e.g. it&#x27;s also includes <code>case</code> in match statements. Maybe <code>WithSuite</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/suite.rs</code>:67 on 2024-07-15 07:40</div>
            <div class="timeline-body"><p>I find this a surprising default. I think we should remove it and update the remaining call sites to be explicit about it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/suite.rs</code>:504 on 2024-07-15 07:47</div>
            <div class="timeline-body"><p>This seems to be a 1:1 copy from</p>
<p>https://github.com/astral-sh/ruff/blob/5f4f4d89710228dfa3908fdaf0de669e9ef81426/crates/ruff_python_formatter/src/statement/suite.rs#L200-L249</p>
<p>It would be great if we can avoid copying the code here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/newlines.py</code>:255 on 2024-07-15 07:48</div>
            <div class="timeline-body"><p>Can we add a few tests related to suppression comments?</p>
<p>I&#x27;m worried that we now add empty lines even if the entire suite is suppressed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-07-15 07:50</div>
            <div class="timeline-body"><p>Nice and thanks for working on this!</p>
<p>This overall looks good to me. We should add a few tests around suppression comments to make sure we don&#x27;t add new lines into suppressed ranges</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-07-15 08:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/statement/stmt_match.rs</code>:39 on 2024-07-15 08:24</div>
            <div class="timeline-body"><p>Good catch, not needed anymore</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-07-15 08:30</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/statement/suite.rs</code>:35 on 2024-07-15 08:30</div>
            <div class="timeline-body"><p>I find last suite in statement describes it well; the rule is that we insert empty lines except when the statement ends directly after it, because then it&#x27;s the task of whatever contains the suite to insert empty lines. A different name would be <code>ends_at_end_of_statement</code>. For match-case, we capture whether the end of the (case-)suite ends at the end of the match-statement.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-07-15 08:33</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/statement/suite.rs</code>:67 on 2024-07-15 08:33</div>
            <div class="timeline-body"><p>We unfortunately need a default for <code>AsFormat</code>, otherwise i&#x27;m all for making this explicit in call sites.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/newlines.py</code>:255 on 2024-07-15 08:42</div>
            <div class="timeline-body"><p>I added one, is that what you had in mind?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-07-15 08:42</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2024-07-15 10:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff_python_formatter/src/other/except_handler_except_handler.rs</code>:49 on 2024-07-15 10:54</div>
            <div class="timeline-body"><p>It&#x27;s now <code>Options</code> everywhere.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-15 10:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/src/statement/suite.rs</code>:67 on 2024-07-15 10:57</div>
            <div class="timeline-body"><p>Hmm, that&#x27;s unfortunate but fair enough.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-15 10:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_python_formatter/resources/test/fixtures/ruff/newlines.py</code>:255 on 2024-07-15 10:59</div>
            <div class="timeline-body"><p>Looks good, thanks</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/konstin">@konstin</a> on 2024-07-15 10:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/konstin">@konstin</a> on 2024-07-15 10:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-15 10:59</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:05:11 UTC
    </footer>
</body>
</html>
