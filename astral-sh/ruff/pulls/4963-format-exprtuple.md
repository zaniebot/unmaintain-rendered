```yaml
number: 4963
title: Format ExprTuple
type: pull_request
state: merged
author: konstin
labels: []
assignees: []
merged: true
base: main
head: format-expr-tupl-try-2
created_at: 2023-06-08T15:21:20Z
updated_at: 2023-06-17T13:40:29Z
url: https://github.com/astral-sh/ruff/pull/4963
synced_at: 2026-01-12T03:43:29Z
```

# Format ExprTuple

---

_Pull request opened by @konstin on 2023-06-08 15:21_

This implements formatting ExprTuple, including magic trailing comma. I intentionally didn't change the settings mechanism but just added a dummy global const flag.

Besides the snapshots, I added custom breaking/joining tests and a deeply nested test case. The diffs look better than previously, proper black compatibility depends on parentheses handling.


---

_Comment by @konstin on 2023-06-08 15:21_

Current dependencies on/for this PR:
* main
  * **PR #4963** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4963" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/4963?utm_source=stack-comment).

---

_@konstin reviewed on 2023-06-08 15:23_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_tuple.rs`:146 on 2023-06-08 15:23_



not sure if this would be useful anywhere else


---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_tuple.rs`:31 on 2023-06-08 15:41_

Can you add a test for an empty tuple that contains a comment: 

```python
(
	# empty
)
```

You'll need to handle that case manually by:

* overriding `fmt_dangling_comments` on `FormatNodeRule`
* Use `block_indent(&dangling_node_comments(item.into())` here to format the dangling comments proper

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_tuple.rs`:39 on 2023-06-08 15:42_

Do we need the inner group? 

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/resources/test/fixtures/ruff/expression/tuple_expression.py`:10 on 2023-06-08 15:42_

Can you add some cases where the elements have comments (leading, trailing)

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_tuple.rs`:49 on 2023-06-08 15:42_

Shouldn't this not already always be true? Because the Expr formatting sets the level to `NodeLevel::Expression`

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_tuple.rs`:69 on 2023-06-08 15:44_

The group here is useless because you'll always force it to `expand` by writing the `block_indent` and the `hard_line_break`. 

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_tuple.rs`:77 on 2023-06-08 15:44_

We don't need to solve this here but we probably need to preserve the right amount of parentheses. 

Isn't the `Expr` parentheses handling already covering this case?

---

_Comment by @github-actions[bot] on 2023-06-08 15:44_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      6.7Â±0.30ms     6.1 MB/sec    1.04      6.9Â±0.31ms     5.9 MB/sec
formatter/numpy/ctypeslib.py               1.00  1440.3Â±81.39Âµs    11.6 MB/sec    1.01  1451.6Â±84.92Âµs    11.5 MB/sec
formatter/numpy/globals.py                 1.06   145.2Â±11.10Âµs    20.3 MB/sec    1.00    137.5Â±7.88Âµs    21.5 MB/sec
formatter/pydantic/types.py                1.01      2.8Â±0.20ms     9.0 MB/sec    1.00      2.8Â±0.19ms     9.1 MB/sec
linter/all-rules/large/dataset.py          1.02     15.4Â±0.59ms     2.6 MB/sec    1.00     15.1Â±0.56ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.6Â±0.15ms     4.6 MB/sec    1.00      3.6Â±0.16ms     4.6 MB/sec
linter/all-rules/numpy/globals.py          1.11   489.9Â±39.21Âµs     6.0 MB/sec    1.00   442.0Â±19.43Âµs     6.7 MB/sec
linter/all-rules/pydantic/types.py         1.05      6.6Â±0.28ms     3.9 MB/sec    1.00      6.3Â±0.37ms     4.0 MB/sec
linter/default-rules/large/dataset.py      1.08      7.9Â±0.30ms     5.2 MB/sec    1.00      7.3Â±0.30ms     5.6 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.13  1691.7Â±95.99Âµs     9.8 MB/sec    1.00  1503.3Â±68.99Âµs    11.1 MB/sec
linter/default-rules/numpy/globals.py      1.06   189.2Â±11.69Âµs    15.6 MB/sec    1.00   177.8Â±10.22Âµs    16.6 MB/sec
linter/default-rules/pydantic/types.py     1.11      3.5Â±0.15ms     7.2 MB/sec    1.00      3.2Â±0.13ms     8.0 MB/sec
```

#### Windows
```
group                                      main                                    pr
-----                                      ----                                    --
formatter/large/dataset.py                 1.02      9.8Â±0.62ms     4.2 MB/sec     1.00      9.6Â±0.51ms     4.2 MB/sec
formatter/numpy/ctypeslib.py               1.00  1956.9Â±114.95Âµs     8.5 MB/sec    1.01  1971.6Â±180.69Âµs     8.4 MB/sec
formatter/numpy/globals.py                 1.00   194.8Â±15.50Âµs    15.1 MB/sec     1.03   201.3Â±16.65Âµs    14.7 MB/sec
formatter/pydantic/types.py                1.03      4.1Â±0.21ms     6.3 MB/sec     1.00      3.9Â±0.21ms     6.5 MB/sec
linter/all-rules/large/dataset.py          1.00     20.5Â±0.73ms  2036.9 KB/sec     1.00     20.5Â±0.88ms  2028.7 KB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      5.2Â±0.23ms     3.2 MB/sec     1.00      5.1Â±0.28ms     3.2 MB/sec
linter/all-rules/numpy/globals.py          1.00   612.9Â±39.56Âµs     4.8 MB/sec     1.03   628.4Â±44.22Âµs     4.7 MB/sec
linter/all-rules/pydantic/types.py         1.00      8.6Â±0.46ms     3.0 MB/sec     1.01      8.7Â±0.46ms     2.9 MB/sec
linter/default-rules/large/dataset.py      1.05     10.6Â±0.49ms     3.8 MB/sec     1.00     10.0Â±0.45ms     4.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.1Â±0.10ms     7.9 MB/sec     1.03      2.2Â±0.12ms     7.6 MB/sec
linter/default-rules/numpy/globals.py      1.02   253.9Â±19.17Âµs    11.6 MB/sec     1.00   249.2Â±15.07Âµs    11.8 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.6Â±0.28ms     5.5 MB/sec     1.00      4.6Â±0.38ms     5.5 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_tuple.rs`:124 on 2023-06-08 15:46_

Nit: You can simplify this by always writing the trailing comma after having written all elements. 

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_tuple.rs`:127 on 2023-06-08 15:47_

You can simplify this by using `joiner`:

```suggestion
		let separator = format_with(|f| write!(f[text(","), soft_line_break_or_space()]));
		f.join_with(separator).entries(self.elts.iter().formatted()).finish()?;
		
		// Write the trailing comma 
		write!(f, [if_group_breaks(&text(","))])?;
```

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_tuple.rs`:146 on 2023-06-08 15:48_

It's good to know that it exists. We can pull it out if it is used elsewhere.

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_tuple.rs`:135 on 2023-06-08 15:51_

```suggestion
    tuple_range: TextRange,
```

I had to look it up on the call side to know what range this is.It could even make sense to pass the whole tuple

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_tuple.rs`:140 on 2023-06-08 15:53_

I believe this panics if the first character is a non-ascii character. 

It's probably safe to use `&f.context().contents(usize::from(range.start())..].chars().next()

---

_@MichaReiser requested changes on 2023-06-08 15:54_

Looks good. Putting it back into your queue to add some tests around comment handling.

---

_@konstin reviewed on 2023-06-09 09:24_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_tuple.rs`:49 on 2023-06-09 09:24_

yep, forgot to update that code

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_tuple.rs`:77 on 2023-06-09 09:28_

yep, also didn't realize that this is now handled

---

_@konstin reviewed on 2023-06-09 09:28_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_tuple.rs`:77 on 2023-06-09 10:40_

on second test, surprisingly not:

```
((1))
# item.range() = 2..3
```

```
((1,))
# item.range() = 1..5
# item.range() = 2..3
```

---

_@konstin reviewed on 2023-06-09 10:40_

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_tuple.rs`:77 on 2023-06-09 10:50_

Ah that makes sense. The expr handling doesn't preserve tuple parentheses. Can we end up with too many parentheses if the expr and tuple ends up adding them (maybe return Never in needs_parentheses when they are optional)

---

_@MichaReiser reviewed on 2023-06-09 10:50_

---

_@konstin reviewed on 2023-06-09 10:54_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_tuple.rs`:31 on 2023-06-09 10:54_

didn't realize earlier, but it's neat that block_ident is a noop when empty

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_tuple.rs`:40 on 2023-06-09 11:00_

It's not necessary to use a `group` here because the `block_indent` emits a `hard_line_break` that always forces the `group` to expand

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_tuple.rs`:60 on 2023-06-09 11:01_

Nit
```suggestion
            && matches!(first_non_trivia_token(last.range().end(), f.context().contents()), Some(Token { kind: TokenKind::Comma }))
```

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_tuple.rs`:72 on 2023-06-09 11:02_

The `hard_line_breaks` are not necessary. The `block_indent` adds the line breaks for you (unlike `indent` that never renders line breaks and relies on you to add the appropriate line breaks)

```suggestion
                    block_indent(&ExprSequence::new(elts)),
```

You can't see the extra `hard_line_breaks` in the output because the `Printer` optimizes them away.

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_tuple.rs`:127 on 2023-06-09 11:04_

```suggestion
        write!(f, [if_group_breaks(&text(","))])
```

Adding a trailing line break should be handled by the code wrapping the sequence. I assume that's already the case because you always use `block_indent` and `soft_block_indent`

---

_@MichaReiser approved on 2023-06-09 11:04_

---

_Merged by @konstin on 2023-06-12 12:55_

---

_Closed by @konstin on 2023-06-12 12:55_

---

_Branch deleted on 2023-06-12 12:55_

---

_@davidszotten reviewed on 2023-06-17 13:40_

---

_Review comment by @davidszotten on `crates/ruff_python_formatter/src/expression/expr_tuple.rs`:77 on 2023-06-17 13:40_

ðŸ‘‹ looking here after trying to implement `StmtFor`. for `for` loops, it seems black removes existing parens around the target `for (x, y) in z` -> `for x, y in z`

see e.g. https://github.com/astral-sh/ruff/blob/be107dad64510e3e34fdd322ba333da06b61be6c/crates/ruff_python_formatter/resources/test/fixtures/black/simple_cases/remove_for_brackets.py#L1

i'm still trying to learn by way around this codebase but i guess this needs to check the parenthesize options or something?

---
