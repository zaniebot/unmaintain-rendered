<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add an evaluation for completions - astral-sh/ruff #20746</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add an evaluation for completions</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20746">#20746</a>
        opened by <a href="https://github.com/BurntSushi">@BurntSushi</a>
        on 2025-10-07 15:11
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a></div>
            <div class="timeline-body"><p>This is still early days, but I hope the framework introduced here makes
it very easy to add new truth data. Truth data should be seen as a form
of regression test for non-ideal ranking of completion suggestions.</p>
<p>I think it would help to read <code>crates/ty_completion_eval/README.md</code>
first to get an idea of what you&#x27;re reviewing.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-10-07 15:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-10-07 15:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-10-07 15:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-10-07 15:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-10-07 15:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/dcreager">@dcreager</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-10-07 15:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/carljm">@carljm</a> removed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-10-07 15:11</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-07 15:13</div>
            <div class="timeline-body">

Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a>
<p>No changes detected when running ty on typing conformance tests âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-07 15:14</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected âœ…
No memory usage changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-07 15:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-10-07 15:25</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>âœ… ecosystem check detected no linter changes.</p>
Linter (preview)
<p>âœ… ecosystem check detected no linter changes.</p>
Formatter (stable)
<p>âœ… ecosystem check detected no format changes.</p>
Formatter (preview)
<p>âœ… ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-10-07 16:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_completion_eval/truth/type-var-typing-over-ast/main.py</code>:11 on 2025-10-07 16:58</div>
            <div class="timeline-body"><p>A slightly more principled way of doing this might be to get <a href="https://github.com/python/typeshed/blob/main/stdlib/VERSIONS">a list of standard library modules</a>, and then do some statistics across the ecosystem to see which modules are often imported from. We&#x27;d probably not want to break alphabetical order completely, but if some modules are used a lot more (orders of magnitude more), this might be an argument for putting them in an extra section on top of the other completions, or similar?</p>
<p>For example, comparing <code>ast</code> to <code>typing</code> across all mypy_primer projects, we can see that the latter is imported 370x more often:</p>
<pre><code>â–¶ rg &#x27;from (typing|ast) import&#x27; --only-matching --no-filename | sort | uniq -c
     76 from ast import
  28146 from typing import
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-07 17:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_completion_eval/truth/type-var-typing-over-ast/main.py</code>:11 on 2025-10-07 17:00</div>
            <div class="timeline-body"><blockquote>
<p>For example, comparing <code>ast</code> to <code>typing</code> across all mypy_primer projects, we can see that the latter is imported 370x more often:</p>
</blockquote>
<p>although, mypy_primer <em>is</em> somewhat intentionally biased towards projects with type annotations, so that we can see how well type checkers do on reasonably well-typed code ðŸ˜„</p>
<p>though there are a lot of exceptions to that rule, to ensure well-rounded coverage for various edge cases</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-10-07 17:24</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_completion_eval/truth/type-var-typing-over-ast/main.py</code>:11 on 2025-10-07 17:24</div>
            <div class="timeline-body"><p>Fair, but ty users will also work on sample of python projects that is biased towards more <code>typing</code> usage ;-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-07 17:48</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_completion_eval/truth/type-var-typing-over-ast/main.py</code>:11 on 2025-10-07 17:48</div>
            <div class="timeline-body"><p>well, maybe, but that&#x27;s less true for autocompletion users than for our other users!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-10-07 18:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_completion_eval/truth/type-var-typing-over-ast/main.py</code>:11 on 2025-10-07 18:02</div>
            <div class="timeline-body"><p>I think using some kind of background frequency distribution to influence ranking is a plausibly good idea. At least worth a try. It&#x27;s hard to know how often it will produce sub-optimal results though. We could perhaps limit it to <em>just</em> standard library modules to keep it restricted in scope. (And reading @sharkdp&#x27;s comments again, I think this is perhaps what is meant.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>.github/workflows/ci.yaml</code>:714 on 2025-10-07 19:14</div>
            <div class="timeline-body"><p>Should we limit this task to only run on ty changes</p>
<pre><code>    if: ${{ needs.determine_changes.outputs.ty == &#x27;true&#x27; || github.ref == &#x27;refs/heads/main&#x27; }}
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_completion_eval/src/main.rs</code>:138 on 2025-10-07 19:19</div>
            <div class="timeline-body"><p>Could we use the <code>tempdir</code> crate here, which works cross platform and cleans up once it&#x27;s done</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-10-07 19:23</div>
            <div class="timeline-body"><p>This is great. I didn&#x27;t review the CLI code in detail.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_completion_eval/truth/higher-level-symbols-preferred/uv.lock</code>:1 on 2025-10-07 20:56</div>
            <div class="timeline-body"><p>why is numpy listed in this uv.lock file? It doesn&#x27;t seem to be listed as a dependency in <code>higher-level-symbols-preferred/pyproject.toml</code>.</p>
<p>Was this accidentally copied and pasted from the example that does include numpy as a dependency, by any chance? ;)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_completion_eval/truth/internal-typeshed-hidden/main.py</code>:6 on 2025-10-07 20:58</div>
            <div class="timeline-body"><p>GitHub is adding a weird link here to a non-existent webpage :/</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_completion_eval/truth/internal-typeshed-hidden/main.py</code>:9 on 2025-10-07 21:01</div>
            <div class="timeline-body"><p><code>typing.AwaitableGenerator</code> is a bit of a weird one because it doesn&#x27;t actually exist at runtime -- and it&#x27;s decorated with <code>@type_check_only</code>, so we should actually suppress it from autocompletions altogether (<a href="https://github.com/astral-sh/ty/issues/816">astral-sh/ty#816</a>).</p>
<p><code>NoneType</code> might be quite a good one here? It exists in <code>_typeshed/__init__.pyi</code> and <code>types.pyi</code>, but (assuming you&#x27;re using Python 3.10+), you&#x27;d never want it to be imported from the <code>_typeshed</code> module (which doesn&#x27;t exist at runtime). You&#x27;d always want it imported from <code>types</code> (which does).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_completion_eval/src/main.rs</code>:53 on 2025-10-07 21:04</div>
            <div class="timeline-body"><pre><code>    /// The mean recriprocal rank threshold that the evaluation must
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> approved on 2025-10-07 21:05</div>
            <div class="timeline-body"><p>Very cool! I also haven&#x27;t reviewed the CLI code in depth</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">testing</span> added by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-10-07 21:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-10-08 07:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_completion_eval/src/main.rs</code>:53 on 2025-10-08 07:02</div>
            <div class="timeline-body"><p><img alt="image" src="https://github.com/user-attachments/assets/c03420bf-1423-48e8-aaaa-45b343775014"></p>
<p>Almost, but not quite :smile:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_completion_eval/src/main.rs</code>:53 on 2025-10-08 07:14</div>
            <div class="timeline-body"><p>Dang</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-08 07:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_completion_eval/src/main.rs</code>:210 on 2025-10-08 07:42</div>
            <div class="timeline-body"><p>The inner physicist in me always gets slightly nervous if statistical measures are presented to full numerical precision (<em>&quot;mean reciprocal rank: 0.20409790112917506&quot;</em>) :smile:. The actual precision of the MRR measure could be estimated by computing the standard deviation alongside the mean, but that obviously seems like overkill here. Given that individual reciprocal ranks can have values like 1/100 = 0.01, and given that we only have ~10 tasks, three or four decimal digits seem more than enough, so maybe</p>
<pre><code>            writeln!(out, &quot;mean reciprocal rank: {mrr:.4}&quot;)?;
</code></pre>
<p>(Due to the large spread in reciprocal ranks and the small number of tasks, the actual standard deviation is around 0.34 at the moment, higher than the MRR. That would mean that even one digit is enough)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_completion_eval/src/main.rs</code>:204 on 2025-10-08 07:45</div>
            <div class="timeline-body"><p>This seems wrong to me? Shouldn&#x27;t we be normalizing by the total number of tasks, instead of the number of source files? If I split a file with multiple tasks across several files, the MRR should stay the same?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty_completion_eval/src/main.rs</code>:215 on 2025-10-08 07:46</div>
            <div class="timeline-body"><p>If someone is not familiar with the MRR measure, this message could read like a failure, so maybe:</p>
<pre><code>                writeln!(out, &quot;Success: MRR exceeds threshold of {threshold}&quot;)?;
</code></pre>
<p>(and similarly, <em>&quot;Failure: MRR does not exceed threshold â€¦&quot;</em> above)?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> approved on 2025-10-08 07:48</div>
            <div class="timeline-body"><p>Very nice! Since Micha and Alex didn&#x27;t review the CLI tool, I did the opposite, and only reviewed the actual MRR computation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-10-08 12:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_completion_eval/src/main.rs</code>:138 on 2025-10-08 12:13</div>
            <div class="timeline-body"><p>I did it this way intentionally to avoid clean-up so that <code>uv sync</code> doesn&#x27;t have to do as much work on repeated runs. It&#x27;s also easier to debug when something goes wrong. But maybe that is a premature optimization.</p>
<p>I&#x27;ve updated this to use <code>tempfile</code> and added a flag that lets you opt into keeping the temporary directory around after the eval is done.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-10-08 12:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_completion_eval/truth/higher-level-symbols-preferred/uv.lock</code>:1 on 2025-10-08 12:16</div>
            <div class="timeline-body"><p>Oh nice catch. And yes, it was a copy-and-paste error!</p>
<p>But actually, this also revealed that I didn&#x27;t have <code>uv.lock</code> files in each of the project directories and we probably should. So I fixed that as well.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-10-08 12:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_completion_eval/truth/internal-typeshed-hidden/main.py</code>:6 on 2025-10-08 12:17</div>
            <div class="timeline-body"><p>Where do you see the link rendered? Anyway, I tried to fix this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_completion_eval/truth/internal-typeshed-hidden/main.py</code>:9 on 2025-10-08 12:19</div>
            <div class="timeline-body"><p>Yes, perfect! Thank you for catching this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-10-08 12:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-10-08 12:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_completion_eval/src/main.rs</code>:210 on 2025-10-08 12:23</div>
            <div class="timeline-body"><p>Thanks! I&#x27;ll do <code>.4</code> for now. And yeah, definitely plan to add more tasks. Hopefully lots more.</p>
<p>The thing driving the higher standard deviation here is that completion requests (aside from auto-import) don&#x27;t take what has been typed into account. Instead, that work is done by the client. I haven&#x27;t yet decided whether non-auto-import completions should do this on the server side (in which case, the eval as it exists is correct), or if we should continue relying on the client (in which case, the eval should mimic the client).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_completion_eval/truth/internal-typeshed-hidden/main.py</code>:6 on 2025-10-08 12:25</div>
            <div class="timeline-body"><p>Right here, on the PR view (and I think it would also be rendered if I was just browsing the file on GitHub):</p>
<hr>
<p><img alt="image" src="https://github.com/user-attachments/assets/90f01507-0280-4491-a96d-c6cf0b5e2c93"></p>
<hr>
<p>if I click on that link, it takes me to a 404 page</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-10-08 12:25</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-10-08 12:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_completion_eval/src/main.rs</code>:210 on 2025-10-08 12:26</div>
            <div class="timeline-body"><p>Also, we have 16 evaluation tasks right now. Each truth directory can contain 1 or more tasks.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-10-08 12:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_completion_eval/src/main.rs</code>:204 on 2025-10-08 12:26</div>
            <div class="timeline-body"><p>Nice catch. My original eval had one task per source. But I refactored to permit each source project to be able to have multiple tasks. And of course, forgot to fix this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-10-08 12:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ty_completion_eval/src/main.rs</code>:215 on 2025-10-08 12:28</div>
            <div class="timeline-body"><p>Yup that&#x27;s fair. I also added &quot;minimum threshold&quot; to make it clear that we want to be above the set threshold.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-10-08 12:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/BurntSushi">@BurntSushi</a> on 2025-10-08 12:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-10-08 12:44</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:19:18 UTC
    </footer>
</body>
</html>
