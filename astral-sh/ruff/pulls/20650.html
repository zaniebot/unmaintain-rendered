<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Fix subtyping of invariant generics specialized with `Any` - astral-sh/ruff #20650</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Fix subtyping of invariant generics specialized with <code>Any</code></h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20650">#20650</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2025-09-30 16:14
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Currently we consider <code>list[Any]</code> a subtype of <code>list[Any]</code>. But we shouldn't, for the same reason that we shouldn't consider <code>Any</code> a subtype of <code>Any</code>: the two <code>Any</code>s might materialize to different types.</p>
<p>The reason why we make this mistake on <code>main</code> is that we (correctly) consider <code>list[Any]</code> to be equivalent to <code>list[Any]</code>, but then incorrectly assume that if <code>T</code> is equivalent to <code>S</code> then <code>T</code> will necessarily be a subtype of <code>S</code>.</p>
<h2>Test Plan</h2>
<ul>
<li>Added mdtests that fail on <code>main</code>.</li>
<li>Ran <code>QUICKCHECK_TESTS=1000000 cargo test --release -p ty_python_semantic -- --ignored types::property_tests::stable</code></li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2025-09-30 16:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @AlexWaygood on 2025-09-30 16:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @AlexWaygood on 2025-09-30 16:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by @AlexWaygood on 2025-09-30 16:14</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-09-30 16:14</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-30 16:17</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-30 16:18</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<details>
<summary>Changes were detected when running on open source projects</summary>

<pre><code class="language-diff">mongo-python-driver (https://github.com/mongodb/mongo-python-driver)
- bson/json_util.py:1015:9: error[invalid-assignment] Method `__setitem__` of type `bound method dict[int, (Any, JSONOptions, /) -&gt; Any].__setitem__(key: int, value: (Any, JSONOptions, /) -&gt; Any, /) -&gt; None` cannot be called with a key of type `object` and a value of type `((Any, JSONOptions, /) -&gt; Any) | ((obj: Any, dummy0: Any) -&gt; Any) | ((obj: Binary, json_options: JSONOptions) -&gt; dict[Unknown, Unknown]) | ((obj: datetime, json_options: JSONOptions) -&gt; dict[Unknown, Unknown]) | ((obj: Any, json_options: JSONOptions) -&gt; dict[Unknown, Unknown]) | ((obj: int | float, json_options: JSONOptions) -&gt; Any) | ((obj: int, json_options: JSONOptions) -&gt; Any) | ((obj: UUID, json_options: JSONOptions) -&gt; dict[Unknown, Unknown]) | ((obj: Int64, json_options: JSONOptions) -&gt; Any) | ((obj: Code, json_options: JSONOptions) -&gt; dict[Unknown, Unknown]) | ((obj: DBRef, json_options: JSONOptions) -&gt; dict[Unknown, Unknown]) | ((dummy0: Any, dummy1: Any) -&gt; dict[Unknown, Unknown]) | ((obj: ObjectId, dummy0: Any) -&gt; dict[Unknown, Unknown]) | ((obj: Timestamp, dummy0: Any) -&gt; dict[Unknown, Unknown])` on object of type `dict[int, (Any, JSONOptions, /) -&gt; Any]`
+ bson/json_util.py:1015:9: error[invalid-assignment] Method `__setitem__` of type `bound method dict[int, (Any, JSONOptions, /) -&gt; Any].__setitem__(key: int, value: (Any, JSONOptions, /) -&gt; Any, /) -&gt; None` cannot be called with a key of type `object` and a value of type `((Any, JSONOptions, /) -&gt; Any) | ((obj: Any, dummy0: Any) -&gt; Any) | ((obj: bytes, json_options: JSONOptions) -&gt; dict[Unknown, Unknown]) | ((obj: datetime, json_options: JSONOptions) -&gt; dict[Unknown, Unknown]) | ((obj: Any, json_options: JSONOptions) -&gt; dict[Unknown, Unknown]) | ((obj: int | float, json_options: JSONOptions) -&gt; Any) | ((obj: int, json_options: JSONOptions) -&gt; Any) | ((obj: UUID, json_options: JSONOptions) -&gt; dict[Unknown, Unknown]) | ((obj: Binary, json_options: JSONOptions) -&gt; dict[Unknown, Unknown]) | ((obj: Int64, json_options: JSONOptions) -&gt; Any) | ((obj: Code, json_options: JSONOptions) -&gt; dict[Unknown, Unknown]) | ((obj: DBRef, json_options: JSONOptions) -&gt; dict[Unknown, Unknown]) | ((dummy0: Any, dummy1: Any) -&gt; dict[Unknown, Unknown]) | ((obj: ObjectId, dummy0: Any) -&gt; dict[Unknown, Unknown]) | ((obj: Timestamp, dummy0: Any) -&gt; dict[Unknown, Unknown])` on object of type `dict[int, (Any, JSONOptions, /) -&gt; Any]`

static-frame (https://github.com/static-frame/static-frame)
- static_frame/test/property/strategies.py:927:17: error[invalid-argument-type] Argument to function `get_index_hierarchy` is incorrect: Expected `(...) -&gt; IndexHierarchy`, found `bound method type[Index[Any]].from_labels(labels: Iterable[Unknown], *, /, name: Unknown = None) -&gt; Index[Any]`
+ static_frame/test/property/strategies.py:927:17: error[invalid-argument-type] Argument to function `get_index_hierarchy` is incorrect: Expected `(...) -&gt; IndexHierarchy`, found `(bound method type[Index[Any]].from_labels(labels: Iterable[Unknown], *, /, name: Unknown = None) -&gt; Index[Any]) | (bound method &lt;class 'Index'&gt;.from_labels(labels: Iterable[Unknown], *, /, name: Unknown = None) -&gt; Index[Any])`

jax (https://github.com/google/jax)
- jax/_src/interpreters/partial_eval.py:2513:15: warning[possibly-missing-attribute] Attribute `frame` on type `Trace[Unknown] | Unknown` may be missing
+ jax/_src/interpreters/partial_eval.py:2513:15: warning[possibly-missing-attribute] Attribute `frame` on type `Trace[Unknown] | Unknown | DynamicJaxprTrace` may be missing

</code></pre>
</details>
No memory usage changes detected ✅

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2025-09-30 16:28</div>
            <div class="timeline-body"><!-- __CODSPEED_PERFORMANCE_REPORT_COMMENT__ -->

<!-- __CODSPEED_WALLTIME_PERFORMANCE_REPORT_COMMENT__ -->

<h2><a href="https://codspeed.io/astral-sh/ruff/branches/alex%2Fnon-fully-static-subtyping?runnerMode=WallTime">CodSpeed WallTime Performance Report</a></h2>
<h3>Merging #20650 will <strong>improve performances by 68.52%</strong></h3>
<p><sub>Comparing <code>alex/non-fully-static-subtyping</code> (e790951) with <code>main</code> (d9473a2)</sub></p>
<h3>Summary</h3>
<p><code>⚡ 1</code> improvement<br />
<code>✅ 7</code> untouched</p>
<h3>Benchmarks breakdown</h3>
<p>|     | Benchmark | <code>BASE</code> | <code>HEAD</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| ⚡ | <code>small[freqtrade]</code> | 9.2 s | 5.5 s | +68.52% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/generics.rs</code>:620 on 2025-09-30 17:22</div>
            <div class="timeline-body"><p>This might deserve a comment why we can't use <code>when_equivalent_to</code> here. (I was confused at first, at least.) My understanding is that it's because <code>when_equivalent_to</code> specifically checks <em>gradual</em> equivalence, which won't give the right answer for <code>TypeRelation::Subtyping</code>. (If that's right, it suggests that the old code was wrong for the <code>Subtyping</code> case?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> approved on 2025-09-30 17:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dcreager">@dcreager</a> on <code>crates/ty_python_semantic/src/types/generics.rs</code>:620 on 2025-09-30 17:23</div>
            <div class="timeline-body"><p>(Or maybe based on your Discord comment it's because it's faster? That would also deserve a comment)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dcreager">@dcreager</a> reviewed on 2025-09-30 17:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-09-30 17:35</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_python_semantic/src/types/generics.rs</code>:620 on 2025-09-30 17:35</div>
            <div class="timeline-body"><p>Heh, no, the motivation was correctness and the speed improvement was a pleasant surprise!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2025-10-01 10:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2025-10-01 10:05</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-10-01 10:05</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:16:08 UTC
    </footer>
</body>
</html>
