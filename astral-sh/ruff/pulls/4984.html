<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix line numbers in source frames - astral-sh/ruff #4984</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Fix line numbers in source frames</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4984">#4984</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-06-09 14:02
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">

Summary
<p>This bug fixes that the line numbers are off by 1-2 lines when the code diff shows additional context lines before the line with the violation.</p>
<p>The way the source frame works is that it starts from the violating line and then tries to include up to two lines before, at least if they are not whitespace only.</p>
<p>https://github.com/charliermarsh/ruff/blob/574a57d60634da3e9c68b7bfdc093b05b30486f3/crates/ruff/src/message/text.rs#L173-L182</p>
<p>The bug was that I incorrectly used the line number from <code>content_start_index</code> which is the line number of the violating line. Meaning, the row number is always off by the number of context lines shown above.</p>
<p>The fix is easy, just use <code>start_index</code>.</p>
Test Plan
<p>I reviewed the <code>text</code> emitter snapshot diffs.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-09 14:02</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #4984</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4984"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite"></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4984?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-06-09 14:10</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>âœ… ecosystem check detected no changes.</p>
Benchmark
Linux
<pre><code>group                                      main                                    pr
-----                                      ----                                    --
formatter/large/dataset.py                 1.00      6.6Â±0.33ms     6.2 MB/sec     1.00      6.6Â±0.29ms     6.2 MB/sec
formatter/numpy/ctypeslib.py               1.05  1486.2Â±103.01Âµs    11.2 MB/sec    1.00  1410.7Â±110.55Âµs    11.8 MB/sec
formatter/numpy/globals.py                 1.00    132.2Â±5.73Âµs    22.3 MB/sec     1.09   144.7Â±14.72Âµs    20.4 MB/sec
formatter/pydantic/types.py                1.00      2.7Â±0.10ms     9.6 MB/sec     1.03      2.7Â±0.09ms     9.3 MB/sec
linter/all-rules/large/dataset.py          1.00     14.7Â±0.47ms     2.8 MB/sec     1.03     15.1Â±0.43ms     2.7 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.01      3.6Â±0.11ms     4.6 MB/sec     1.00      3.6Â±0.13ms     4.6 MB/sec
linter/all-rules/numpy/globals.py          1.02   458.1Â±20.01Âµs     6.4 MB/sec     1.00   447.7Â±21.05Âµs     6.6 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.3Â±0.26ms     4.0 MB/sec     1.00      6.3Â±0.35ms     4.0 MB/sec
linter/default-rules/large/dataset.py      1.06      7.1Â±0.17ms     5.7 MB/sec     1.00      6.7Â±0.23ms     6.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.05  1511.3Â±53.85Âµs    11.0 MB/sec     1.00  1443.8Â±54.72Âµs    11.5 MB/sec
linter/default-rules/numpy/globals.py      1.00    168.1Â±7.84Âµs    17.5 MB/sec     1.12   187.7Â±16.71Âµs    15.7 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.2Â±0.19ms     8.0 MB/sec     1.00      3.2Â±0.25ms     8.0 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.0Â±0.12ms     5.1 MB/sec    1.01      8.1Â±0.06ms     5.0 MB/sec
formatter/numpy/ctypeslib.py               1.00  1619.4Â±13.82Âµs    10.3 MB/sec    1.01  1628.1Â±15.97Âµs    10.2 MB/sec
formatter/numpy/globals.py                 1.00    158.0Â±1.58Âµs    18.7 MB/sec    1.01    159.9Â±2.90Âµs    18.5 MB/sec
formatter/pydantic/types.py                1.00      3.3Â±0.02ms     7.8 MB/sec    1.02      3.3Â±0.04ms     7.7 MB/sec
linter/all-rules/large/dataset.py          1.00     17.3Â±0.21ms     2.3 MB/sec    1.00     17.3Â±0.12ms     2.3 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.4Â±0.06ms     3.8 MB/sec    1.00      4.4Â±0.03ms     3.8 MB/sec
linter/all-rules/numpy/globals.py          1.00    442.8Â±7.29Âµs     6.7 MB/sec    1.00    441.0Â±8.88Âµs     6.7 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.5Â±0.10ms     3.4 MB/sec    1.00      7.5Â±0.17ms     3.4 MB/sec
linter/default-rules/large/dataset.py      1.01      8.7Â±0.08ms     4.7 MB/sec    1.00      8.6Â±0.10ms     4.8 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1789.5Â±14.44Âµs     9.3 MB/sec    1.00  1793.5Â±18.63Âµs     9.3 MB/sec
linter/default-rules/numpy/globals.py      1.01    190.4Â±2.00Âµs    15.5 MB/sec    1.00    188.5Â±1.87Âµs    15.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.9Â±0.03ms     6.5 MB/sec    1.00      3.9Â±0.04ms     6.5 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/message/text.rs</code>:218 on 2023-06-09 14:20</div>
            <div class="timeline-body"><p>Impressive work</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2023-06-09 14:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-09 15:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-09 15:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-09 15:21</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-06-09 15:21</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:54:22 UTC
    </footer>
</body>
</html>
