<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Vendor typeshed's stdlib - astral-sh/ruff #11340</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Vendor typeshed's stdlib</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/11340">#11340</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-05-08 14:45
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-05-08 14:45</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>This PR vendors typeshed!</p>
<ul>
<li>The first commit vendors the <code>stdlib</code> directory from typeshed into a new <code>crates/red_knot/vendored_typeshed</code> directory.</li>
<li>The second commit adjusts various linting config files to make sure that the vendored code is excluded from typo checks, formatting checks, etc.</li>
<li>The <code>LICENSE</code> and <code>README.md</code> files are also vendored, but all other directories and files (<code>stubs</code>, <code>scripts</code>, <code>tests</code>, <code>test_cases</code>, etc.) are excluded. We should have no need for them (except possibly <code>stubs/</code>, discussed in more depth below).</li>
<li>Similar to the way pyright has a <code>commit.txt</code> file in its vendored copy of typeshed, to indicate which typeshed commit the vendored code corresponds to, I've also added a <code>crates/red_knot/vendored_typeshed/source_commit.txt</code> file in the third commit of this PR.</li>
</ul>
<p>One open question is: should we vendor the <code>stdlib</code> <em>and</em> <code>stubs</code> directories, or just the <code>stdlib</code> directory? The <code>stubs/</code> directory contains stubs for 162 third-party packages outside the stdlib. Mypy and <a href="https://github.com/JelleZijlstra/typeshed_client/tree/master">typeshed_client</a>[^1] only vendor the <code>stdlib</code> directory; pyright and pyre vendor both the <code>stdlib</code> and <code>stubs</code> directories; pytype vendors the entire typeshed repo (<code>scripts/</code>, <code>tests/</code> and all).</p>
<p>In this PR, I've chosen to copy mypy and typeshed_client. Unlike vendoring the <code>stdlib</code>, which is unavoidable if we want to do typechecking of the stdlib, it's not <em>strictly</em> necessary to vendor the <code>stubs</code> directory: each subdirectory in <code>stubs</code> is published to PyPI as a standalone stubs distribution that can be (uv)-pip-installed into a virtual environment. It <em>might</em> be <em>useful</em> for our users if we vendored those stubs anyway, but there are costs as well as benefits to doing so (apart from just the sheer amount of vendored code in the <code>ruff</code> repository), so I'd rather consider it separately.</p>
<p>It will be necessary to add infrastructure to keep our vendored copy of typeshed up to date with the upstream repo. I will add this in a followup PR.</p>
<h2>Test Plan</h2>
<p><code>pre-commit run -a</code></p>
<p>[^1]: typeshed_client is used by Quora's type checker <a href="https://github.com/quora/pyanalyze">pyanalyze</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @AlexWaygood on 2024-05-08 14:45</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-05-08 14:48</div>
            <div class="timeline-body"><p>@carljm I'm expecting a line-by-line review</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-05-08 15:03</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2024-05-08 15:04</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-05-08 15:06</div>
            <div class="timeline-body"><blockquote>
<p>@carljm I'm expecting a line-by-line review</p>
</blockquote>
<p>What would be helpful is if you could maybe add a few comments of the code that you want to get reviewed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-08 15:08</div>
            <div class="timeline-body"><p>I defer to you all, but I personally would wait to have a PR (with this PR as the base) that leverages these stubs before merging this into main. It ensures that we have everything wired up correctly, and also prevents against us merging these stubs only to have them never be used in the event that we reprioritize or make some other decision.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-05-08 15:09</div>
            <div class="timeline-body"><blockquote>
<blockquote>
<p>@carljm I'm expecting a line-by-line review</p>
</blockquote>
<p>What would be helpful is if you could maybe add a few comments of the code that you want to get reviewed.</p>
</blockquote>
<p>Sorry, that was meant to be a joke :(</p>
<p>I tried to provide a guide to this in the PR description. I don't expect any code in the first commit to be reviewed, as that code is all vendored. I would appreciate a review on the design decisions I outlined in the PR description, and the (very small) configuration changes made in the second and third commit. (One question with the third commit is: did I miss anything? Do any other configuration files need to be updated?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-05-08 15:10</div>
            <div class="timeline-body"><blockquote>
<p>I defer to you all, but I personally would wait to have a PR (with this PR as the base) that leverages these stubs before merging this into main. It ensures that we have everything wired up correctly, and also prevents against us merging these stubs only to have them never be used in the event that we reprioritize or make some other decision.</p>
</blockquote>
<p>We can wait; this isn't urgent. I discussed with Carl on Monday and we thought this might be an easy first step, but we can hold off with this for now, I think.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-05-08 15:15</div>
            <div class="timeline-body"><p>LGTM: I think we should add a READMe on how to update typeshed. For example, I wouldn't have known about the commit.txt file.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-05-08 15:29</div>
            <div class="timeline-body"><blockquote>
<p>LGTM: I think we should add a READMe on how to update typeshed. For example, I wouldn't have known about the commit.txt file.</p>
</blockquote>
<p>Sure... Where should I put those docs, do you think? Typeshed's README.md file is one of the few files that I'm vendoring as part of this PR that lies outside the <code>stdlib/</code> directory. Would you prefer that I replace that with a README.md of our own explaining that this is vendored code and how to update it? Or should I put those docs somewhere else? (<code>crates/red_knot/README.md</code>, maybe?)</p>
<p>As I mentioned in the PR description, I want to add automation to update typeshed on a regular basis as a followup to this PR. For example, mypy gets an automated PR like this every two weeks: https://github.com/python/mypy/pull/17201.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-05-08 16:00</div>
            <div class="timeline-body"><blockquote>
<p>crates/red_knot/README.md, maybe?)</p>
</blockquote>
<p>Seems fine to me.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-05-08 16:05</div>
            <div class="timeline-body"><p>Minor nit that I prefer <code>vendor/typeshed</code> to <code>vendored_typeshed</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-05-08 16:12</div>
            <div class="timeline-body"><p>This looks fine to me. I think the main thing that's missing that I would probably want to have before we merge this is at least documentation, and ideally automation, for updating the snapshot of typeshed.</p>
<p>Personally with that done, I'd just go ahead and merge, otherwise whenever we come back to this it'll probably require another round of updating our own lint configs etc that have changed in the meantime.</p>
<p>There's really no &quot;wiring-up&quot; of it in this PR yet that might be wrong, it's just the files themselves. And I think it's very unlikely we don't use this (and if we don't, it's easy to pull out again.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-08 17:13</div>
            <div class="timeline-body"><p>What if we decide that it needs to go somewhere else, e.g., in its own crate? Are these strong advantages to merging now vs. waiting to understand how this will actually get used and integrated?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-05-08 17:35</div>
            <div class="timeline-body"><blockquote>
<p>Minor nit that I prefer <code>vendor/typeshed</code> to <code>vendored_typeshed</code></p>
</blockquote>
<p>Done</p>
<blockquote>
<p>I think the main thing that's missing that I would probably want to have before we merge this is at least documentation, and ideally automation, for updating the snapshot of typeshed.</p>
</blockquote>
<p>Added some docs (including instructions for how to update manually) in <code>crates/red_knot/README.md</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot/README.md</code>:11 on 2024-05-08 17:38</div>
            <div class="timeline-body"><p>Should this be prefixed with a <code>rm -r</code>? Otherwise it could result in stray files if a typeshed change removes a file (eg module changing to a package).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-05-08 17:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-05-08 17:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/README.md</code>:11 on 2024-05-08 17:40</div>
            <div class="timeline-body"><p>good point!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-05-08 17:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot/README.md</code>:11 on 2024-05-08 17:49</div>
            <div class="timeline-body"><p>fixed in a force-push</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2024-05-09 08:52</div>
            <div class="timeline-body"><blockquote>
<p>What if we decide that it needs to go somewhere else, e.g., in its own crate? Are these strong advantages to merging now vs. waiting to understand how this will actually get used and integrated?</p>
</blockquote>
<p>I think we should just merge it. I don't see any real disadvantages that would justify not merging now and stacked PRs are still a pain, even if it's just marginal:</p>
<ul>
<li>What if we don't need it: I think that's extremely unlikely and is something that can be fixed easily, just delete the files ;)</li>
<li>What if we need to move the files. I'm sure Alex thought about where to place the files. But even if it turns out that we need to move the files because we learned something new, the fix is easy and a low effort PR.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-05-09 08:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-05-09 11:43</div>
            <div class="timeline-body"><blockquote>
<p>What if we decide that it needs to go somewhere else, e.g., in its own crate?</p>
</blockquote>
<p>It would surprise me quite a lot if code outside of <code>red_knot</code> needed to analyse typeshed's stdlib stubs. I think that would be a sign of bad architecture from us if they did: code from other crates should use high-level APIs provided by red-knot to query the resolved types that red-knot reaches by parsing and analysing the stdlib stubs, rather than analysing the stubs directly from outside red-knot. In any case, I think it will be very easy to move the stubs somewhere else if we decide at a later point in time that it's necessary.</p>
<blockquote>
<p>Are these strong advantages to merging now</p>
</blockquote>
<p>No strong advantages, no, other than being able to easily do work in followup PRs on the basis that this information is available to us inside the Ruff repository. And I'm also not sure I see any strong disadvantages. I don't think this locks us into having the stubs in one particular place, or precludes us from changing the way we vendor typeshed in the future. I'm happy to consider different ways of doing this (a PyPI package, or using a git submodule) in followups. But for now I think I'd rather land this and move onto followup work.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2024-05-09 11:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-05-09 11:44</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-05-09 11:44</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Skylion007">@Skylion007</a> on 2024-05-09 13:42</div>
            <div class="timeline-body"><p>Any reason we didn't vendor it as a git submodule?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/zanieb">@zanieb</a> on 2024-05-09 13:44</div>
            <div class="timeline-body"><p>@Skylion007 we discussed this, but it's simpler to start without a submodule as it introduces changes to contributors' git workflows.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2024-05-09 13:50</div>
            <div class="timeline-body"><blockquote>
<p>Any reason we didn't vendor it as a git submodule?</p>
</blockquote>
<p>I'm open to it, but not sure it's worth the extra complication. As far as I can tell, the chief advantage seems to be that you'd be able to easily see typeshed's history from inside ruff, which might make it easier to bisect specific issues to specific typeshed commits. But my experience at mypy has been that it's rare that you need to do that -- it's usually pretty easy to figure out what typeshed change is to blame for a specific issue if one arises.</p>
<p>Of the four major Python type checkers currently, only one (pytype) uses a git submodule for their vendored typeshed stubs -- that doesn't mean that we <em>shouldn't</em> do something different, but it does suggest that it's not <em>essential</em> to use a git submodule.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-09 13:53</div>
            <div class="timeline-body"><p>Just to respond: I still wouldn't have merged this personally (especially if it were my own change), since (as a rule of thumb) it's unused code without a defined integration point. Maybe the integration is straightforward, but the point is we can't really know until we've taken the next step. Similarly, maybe we change priorities, and then we have a vendored typeshed sitting around.</p>
<p>Regardless, correct for me to defer to others since I'm in the minority. I feel heard, no need to respond!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2024-05-09 13:54</div>
            <div class="timeline-body"><p><em>Separately</em> there are some unknowns to me that I'll be interested to watch, but that would <em>not</em> affect merging: How will we ensure that it gets included in the compiled binary? Will these be embedded in the binary, or somehow installed separately on-disk? How will we expose these to the resolver, if they <em>are</em> embedded in the binary? Etc.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 22:05:57 UTC
    </footer>
</body>
</html>
