<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Increase worker-thread stack size - astral-sh/ruff #17869</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Increase worker-thread stack size</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/17869">#17869</a>
        opened by <a href="https://github.com/sharkdp">@sharkdp</a>
        on 2025-05-05 19:16
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>closes #17472</p>
<p>This is obviously just a band-aid solution to this problem (in that you can always make your <a href="https://github.com/sympy/sympy/blob/28994edd82a18c22a98a52245c173f3c836dcad3/sympy/polys/numberfields/resolvent_lookup.py">pathological inputs</a> bigger and it will still crash), but I think this is not an unreasonable change — even if we add more sophisticated solutions later. I tried using <code>stacker</code> as suggested by @MichaReiser, and it works. But it's unclear where exactly would be the right place to put it, and even for the <code>sympy</code> problem, we would need to add it both in the semantic index builder AST traversal and in type inference. Increasing the default stack size for worker threads, as proposed here, doesn't solve the underlying problem (that there is a hard limit), but it is more universal in the sense that it is not specific to large binary-operator expression chains.</p>
<p>To determine a reasonable stack size, I created files that look like</p>
<p><em>right associative</em>:</p>
<pre><code class="language-py">from typing import reveal_type
total = (1 + (1 + (1 + (1 + (… + 1)))))
reveal_type(total)
</code></pre>
<p><em>left associative</em></p>
<pre><code class="language-py">from typing import reveal_type
total = 1 + 1 + 1 + 1 + … + 1
reveal_type(total)
</code></pre>
<p>with a variable amount of operands (<code>N</code>). I then chose the stack size large enough to still be able to handle cases that existing type checkers can not:</p>
<pre><code>right

  N = 20: mypy takes ~ 1min
  N = 350: pyright crashes with a stack overflow (mypy fails with &quot;too many nested parentheses&quot;)
  N = 800: ty(main) infers Literal[800] instantly
  N = 1000: ty(main) crashes with &quot;thread '&lt;unknown&gt;' has overflowed its stack&quot;

  N = 7000: ty(this branch) infers Literal[7000] instantly
  N = 8000+: ty(this branch) crashes


left

  N = 300: pyright emits &quot;Maximum parse depth exceeded; break expression into smaller sub-expressions&quot;
           total is inferred as Unknown
  N = 5500: mypy crashes with &quot;INTERNAL ERROR&quot;
  N = 2500: ty(main) infers Literal[2500] instantly
  N = 3000: ty(main) crashes with &quot;thread '&lt;unknown&gt;' has overflowed its stack&quot;

  N = 22000: ty(this branch) infers Literal[22000] instantly
  N = 23000+: ty(this branch) crashes
</code></pre>
<h2>Test Plan</h2>
<p>New regression test.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @sharkdp on 2025-05-05 19:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @sharkdp on 2025-05-05 19:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @sharkdp on 2025-05-05 19:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @sharkdp on 2025-05-05 19:16</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @sharkdp on 2025-05-05 19:16</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-05 19:19</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @AlexWaygood removed by @AlexWaygood on 2025-05-05 19:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-05-05 19:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty/src/main.rs</code>:409 on 2025-05-05 19:23</div>
            <div class="timeline-body"><p>It's probably worth noting that this does not generally increase memory usage by 16 MiB × num_threads. It's just the max. available stack space that a single thread can use.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ty/src/main.rs</code>:409 on 2025-05-05 19:25</div>
            <div class="timeline-body"><p>And 16MiB/thread is not even detectable, relative to the memory we need for source texts and AST, for any project large enough to care about memory usage.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-05-05 19:25</div>
            <div class="timeline-body"><p>This looks great, thank you</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/sharkdp">@sharkdp</a> reviewed on 2025-05-05 19:28</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/sharkdp">@sharkdp</a> on <code>crates/ty/tests/cli.rs</code>:1209 on 2025-05-05 19:28</div>
            <div class="timeline-body"><p>I chose a <em>much</em> smaller limit than what we can handle (but still bigger than what we can handle on <code>main</code>) for two reasons:</p>
<ul>
<li>Debug builds take up more stack space and crash at smaller input sizes</li>
<li>We don't want minor increases of stack frame sizes to lead to a test failure here.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @sharkdp on 2025-05-05 19:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @sharkdp on 2025-05-05 19:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-05-05 19:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-05 21:15</div>
            <div class="timeline-body"><p>I think the long term solution here would be to implement binary expression traversal in a loop rather than with recursion. But this is fine for now</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:12:13 UTC
    </footer>
</body>
</html>
