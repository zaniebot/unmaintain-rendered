<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Fix goto definition for relative imports in third-party files - astral-sh/ruff #22457</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Fix goto definition for relative imports in third-party files</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/22457">#22457</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2026-01-08 12:58
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">Summary
<p>This PR removes our default database handling from ty&#x27;s LSP.</p>
<p>We used the default database for files that don&#x27;t belong to any project,
because we want to treat them differently:</p>
<ul>
<li>We shouldn&#x27;t show any diagnsotics (funnily enough, this doesn&#x27;t work today)</li>
<li>In the future, we want to disable formatting</li>
</ul>
<p>This PR removes the default database and:</p>
<ul>
<li>relies on the project inclusion/exlusion to disable diagnostics for non-project files, the same as we do it in the CLI</li>
<li>We can disable formatting and other features that should only run on project files the very same way</li>
</ul>
<p>This fixes an issue where goto definition didn&#x27;t work in files in the project&#x27;s virtual environment
for relative imports because the default database uses different search paths than the project.</p>
<p>The only downside that I see using this approach is that ty doesn&#x27;t warn
about missing imports in non-project files if those modules are available in the project&#x27;s virtual environment.
If this is a concern, than I think we&#x27;ll want to use a similar approach to scripts (TBD). Either way, I don&#x27;t think
we want to use a default database.</p>
<p>Fixes <a href="https://github.com/astral-sh/ty/issues/2290">astral-sh/ty#2290</a></p>
Test Plan
<p>Tested that goto definition now works for projects using <code>venv</code> as their virtual environment (the example in <a href="https://github.com/astral-sh/ty/issues/2290">astral-sh/ty#2290</a>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-08 12:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-08 12:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-08 12:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-08 12:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-08 12:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/Gankra">@Gankra</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-08 12:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-08 12:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-08 12:58</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/dcreager">@dcreager</a> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-08 12:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/carljm">@carljm</a> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-08 12:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/sharkdp">@sharkdp</a> removed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-08 12:59</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-08 12:59</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2026-01-08 13:08</div>
            <div class="timeline-body">

Merging this PR will <strong>not alter performance</strong>
Summary
<p><code>✅ 23</code> untouched benchmarks<br>
<code>⏩ 30</code> skipped benchmarks[^skipped]</p>
<hr>
<p>Comparing <code>micha/remove-default-database</code> (511478e) with <code>main</code> (f9f7a69)</p>
<a href="https://codspeed.io/astral-sh/ruff/branches/micha%2Fremove-default-database?utm_source=github&amp;utm_medium=comment-v2&amp;utm_content=button">
  
    
    
    <img alt="Open in CodSpeed" src="https://codspeed.io/pr-report/open-in-codspeed-light.svg">
  
</a>

<p>[^skipped]: 30 benchmarks were skipped, so the baseline results were used instead. If they were deleted from the codebase, <a href="https://codspeed.io/astral-sh/ruff/branches/micha%2Fremove-default-database?sectionId=benchmark-comparison-section-baseline-result-skipped&amp;utm_source=github&amp;utm_medium=comment-v2&amp;utm_content=archive">click here and archive them to remove them from the performance reports</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-08 13:09</div>
            <div class="timeline-body"><p>Uhm what?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2026-01-08 15:42</div>
            <div class="timeline-body"><p>Uhh wait but we still have the default database for when config handling fails on init right..?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-08 15:52</div>
            <div class="timeline-body"><blockquote>
<p>Uhh wait but we still have the default database for when config handling fails on init right..?</p>
</blockquote>
<p>That&#x27;s different and, confusingly, we used the same term for them. We use a fallback db if the initialization of the project&#x27;s database fails during workspace initialization. But we associate that db with the project&#x27;s path.</p>
<p>The default database was different. We only used it for paths that have no project with which they share a prefix.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/Gankra">@Gankra</a> approved on 2026-01-08 17:33</div>
            <div class="timeline-body"><p>As long as we don&#x27;t produce diagnostics for things-that-would-otherwise-be-default-database this seems relatively reasonable..?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/Gankra">@Gankra</a> on 2026-01-08 17:34</div>
            <div class="timeline-body"><p>Mostly this just leaves me feeling like &quot;god we have to stop tiptoeing around actually handling multiple workspaces in a session&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-09 08:11</div>
            <div class="timeline-body"><blockquote>
<p>Mostly this just leaves me feeling like &quot;god we have to stop tiptoeing around actually handling multiple workspaces in a session&quot;.</p>
</blockquote>
<p>Yeah, I&#x27;m also getting more and more to the conclusion that not having to do that would be great</p>
<blockquote>
<p>As long as we don&#x27;t produce diagnostics for things-that-would-otherwise-be-default-database this seems relatively reasonable..?</p>
</blockquote>
<p>I&#x27;m not aware of a situationb where this would be the case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-09 08:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2026-01-09 08:30</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2026-01-09 08:30</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:22:48 UTC
    </footer>
</body>
</html>
