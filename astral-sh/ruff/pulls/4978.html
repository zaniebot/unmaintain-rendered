<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>perf(formatter): Skip bodies without comments - astral-sh/ruff #4978</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>perf(formatter): Skip bodies without comments</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4978">#4978</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2023-06-09 05:57
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-09 05:57</div>
            <div class="timeline-body"><!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

<h2>Summary</h2>
<p>This PR improves the performance of the comments extraction by skipping over bodies that contain no comments.</p>
<p>The visitor already avoided visiting the children of a node if there are no comments in its range but we aren't doing this yet for bodies because bodies are not nodes.
This PR adds the logic for skipping over bodies if there's no comment in the body range.</p>
<pre><code class="language-python">if test: # a comment 
	... 
</code></pre>
<p>The old implementation did visit the <code>if</code> statement, as well as the <code>body</code> and <code>orelse</code> because it contains a comment in its range. But this is unnecessary
because only the case header has a comment.</p>
<h2>Test Plan</h2>
<p><code>cargo test</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-09 05:57</div>
            <div class="timeline-body"><p>Current dependencies on/for this PR:</p>
<ul>
<li>main<ul>
<li><strong>PR #4954</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4954" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #4921</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4921" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #4922</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4922" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #4951</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4951" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a><ul>
<li><strong>PR #4961</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4961" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>
* <strong>PR #4964</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4964" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>
* <strong>PR #4979</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4979" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>
* <strong>PR #4978</strong> <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4978" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This comment was auto-generated by <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/4978?utm_source=stack-comment">Graphite</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "perf(formatter): Avoid skipping bodies without comments" to "perf(formatter): Skip bodies without comments" by @MichaReiser on 2023-06-09 06:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">internal</span> added by @MichaReiser on 2023-06-09 06:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">performance</span> added by @MichaReiser on 2023-06-09 06:20</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">autoformatter</span> added by @MichaReiser on 2023-06-09 06:20</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-06-09 06:52</div>
            <div class="timeline-body"><h2>PR Check Results</h2>
<h3>Ecosystem</h3>
<p>âœ… ecosystem check detected no changes.</p>
<h3>Benchmark</h3>
<h4>Linux</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.02      6.5Â±0.02ms     6.3 MB/sec    1.00      6.4Â±0.01ms     6.4 MB/sec
formatter/numpy/ctypeslib.py               1.01   1357.2Â±7.20Âµs    12.3 MB/sec    1.00   1339.5Â±2.51Âµs    12.4 MB/sec
formatter/numpy/globals.py                 1.01    131.5Â±0.23Âµs    22.4 MB/sec    1.00    129.9Â±0.17Âµs    22.7 MB/sec
formatter/pydantic/types.py                1.02      2.7Â±0.02ms     9.6 MB/sec    1.00      2.6Â±0.02ms     9.7 MB/sec
linter/all-rules/large/dataset.py          1.00     14.0Â±0.02ms     2.9 MB/sec    1.00     14.0Â±0.04ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.4Â±0.00ms     4.9 MB/sec    1.00      3.4Â±0.01ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    423.2Â±0.61Âµs     7.0 MB/sec    1.00    423.3Â±0.60Âµs     7.0 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.9Â±0.01ms     4.3 MB/sec    1.00      5.9Â±0.01ms     4.3 MB/sec
linter/default-rules/large/dataset.py      1.00      6.7Â±0.01ms     6.0 MB/sec    1.01      6.8Â±0.01ms     6.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00   1471.2Â±3.38Âµs    11.3 MB/sec    1.01   1484.2Â±2.40Âµs    11.2 MB/sec
linter/default-rules/numpy/globals.py      1.00    166.1Â±0.29Âµs    17.8 MB/sec    1.00    166.7Â±0.23Âµs    17.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.1Â±0.01ms     8.3 MB/sec    1.00      3.1Â±0.01ms     8.3 MB/sec
</code></pre>
<h4>Windows</h4>
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      7.6Â±0.06ms     5.3 MB/sec    1.15      8.7Â±0.07ms     4.7 MB/sec
formatter/numpy/ctypeslib.py               1.00  1556.5Â±15.14Âµs    10.7 MB/sec    1.12  1739.9Â±23.82Âµs     9.6 MB/sec
formatter/numpy/globals.py                 1.00    149.3Â±3.21Âµs    19.8 MB/sec    1.11    165.5Â±4.76Âµs    17.8 MB/sec
formatter/pydantic/types.py                1.00      3.1Â±0.04ms     8.2 MB/sec    1.13      3.5Â±0.04ms     7.2 MB/sec
linter/all-rules/large/dataset.py          1.00     16.4Â±0.10ms     2.5 MB/sec    1.01     16.6Â±0.12ms     2.5 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.2Â±0.05ms     4.0 MB/sec    1.01      4.2Â±0.04ms     3.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    497.1Â±5.72Âµs     5.9 MB/sec    1.00    499.3Â±6.78Âµs     5.9 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.0Â±0.05ms     3.6 MB/sec    1.01      7.1Â±0.06ms     3.6 MB/sec
linter/default-rules/large/dataset.py      1.00      8.2Â±0.04ms     5.0 MB/sec    1.00      8.2Â±0.06ms     4.9 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1755.9Â±29.79Âµs     9.5 MB/sec    1.00  1747.9Â±23.44Âµs     9.5 MB/sec
linter/default-rules/numpy/globals.py      1.00    198.1Â±2.83Âµs    14.9 MB/sec    1.01    200.1Â±6.00Âµs    14.7 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7Â±0.03ms     6.8 MB/sec    1.00      3.7Â±0.03ms     6.9 MB/sec
</code></pre>
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-09 07:17</div>
            <div class="timeline-body"><p>The benchmarks compare against <code>main</code> which does not yet have the <code>if statement</code> formatting. But we can see that the increase goes down from 25% slowdown to an at most 18% slowdown.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @konstin by @MichaReiser on 2023-06-09 07:17</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/konstin">@konstin</a> on 2023-06-09 07:37</div>
            <div class="timeline-body"><p>With https://github.com/astral-sh/ruff/pull/4964#issuecomment-1583012574, i don't really see much performance difference</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-06-09 07:39</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2023-06-09 09:33</div>
            <div class="timeline-body"><blockquote>
<p>With <a href="https://github.com/astral-sh/ruff/pull/4964#issuecomment-1583012574">#4964 (comment)</a>, i don't really see much performance difference</p>
</blockquote>
<p>The linux result are in the range of what I expected and was able to reproduce locally. Not sure what happened with the windows run.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2023-06-09 09:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2023-06-09 09:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-06-09 09:33</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 03:44:08 UTC
    </footer>
</body>
</html>
