```yaml
number: 12759
title: "[red-knot] Add support for `--system-site-packages` virtual environments"
type: pull_request
state: merged
author: AlexWaygood
labels:
  - ty
assignees: []
merged: true
base: main
head: alex/system-site-packages
created_at: 2024-08-08T16:32:35Z
updated_at: 2024-08-09T20:02:18Z
url: https://github.com/astral-sh/ruff/pull/12759
synced_at: 2026-01-12T15:55:42Z
```

# [red-knot] Add support for `--system-site-packages` virtual environments

---

_@AlexWaygood_

## Summary

Many things about Python virtual environments are not specified, but the following things are:
- All Python virtual environments have a `pyvenv.cfg` file in the venv root.
- The `pyvenv.cfg` file is guaranteed to have a `home = <path>` key in it, which will point to the parent directory of the system Python installation that was used to create this venv
- The venv will always have its own, isolated `site-packages` directory which will be appended to `sys.path` at runtime by the stdlib `site` module
- If the `pyvenv.cfg` file contains `include-system-site-packages = true`, (or `include-system-site-packages = TrUe`, or any other case variations of the word "true"), Python's stdlib module will also append the system Python's `site-packages` directory _as well as_ the venv's isolated `site-packages` directory.

This PR emulates that runtime behaviour in red-knot.

## Test Plan

Several tests have been added to this PR.

The `pyvenv.cfg` files provided by uv, virtualenv and the stdlib `venv` module are all consistent on the above bullets, but differ in many other subtle aspects. As such, I've added two more venvs to the `resources/test` directory, in addition to the `uv`-created one: one created using `virtualenv` and one created using the stdlib `venv` module.

I haven't added any tests with venvs that actually have `include-system-site-packages = true` in their `pyvenv.cfg` files. I'm not sure how I'd add tests for that without actually committing a complete system Python installation into the `resources/test` directory. I did manual testing with `--system-site-packages` venvs created using all three tools, however, and everything seemed to be working as expected. (I tried using both a `pyenv`-installed Python and a `homebrew`-installed Python.)


---

_Review requested from @carljm by @AlexWaygood on 2024-08-08 16:32_

---

_Review requested from @MichaReiser by @AlexWaygood on 2024-08-08 16:32_

---

_Label `red-knot` added by @AlexWaygood on 2024-08-08 16:32_

---

_@MichaReiser reviewed on 2024-08-08 16:44_

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:1 on 2024-08-08 16:44_

Should this now be moved into the semantic index crate?

---

_@AlexWaygood reviewed on 2024-08-08 16:45_

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:1 on 2024-08-08 16:45_

at some point, yes

---

_@MichaReiser reviewed on 2024-08-08 16:45_

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:47 on 2024-08-08 16:45_

Is it important that we canonicalize the path here or do we need an absolute path? If it is a relative path, is it relative to the directory in which the CLI runs or the workspace?

---

_@MichaReiser reviewed on 2024-08-08 16:47_

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:89 on 2024-08-08 16:47_

Same as above. Do we need an absolute path or do we need to resolve symlinks?

I feel like we should return an `Error` if `canonicalize` fails (if canonicalizing is important)

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:160 on 2024-08-08 16:48_

Nit: Should we implement this as a method on `TargetVersion`?

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:247 on 2024-08-08 16:49_

```suggestion
pub enum PyvenvCfgParseErrorKind {
```

That's the terminology that e.g. `std::io::Error` uses

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:42 on 2024-08-08 16:50_

```suggestion
        path: SystemPathBuf,
```

This is a very large function. We want to avoid monomorphization.

---

_@MichaReiser reviewed on 2024-08-08 16:51_

Looks exciting. I'll take a closer look tomorrow

---

_@AlexWaygood reviewed on 2024-08-08 17:45_

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:160 on 2024-08-08 17:45_

I don't think we should use the `TargetVersion` type here. The user might be using a Python venv constructed creating a Python version we don't support. In theory that's fine as long as they pass `--target-version` with a Python version we _do_ support

---

_@AlexWaygood reviewed on 2024-08-08 17:51_

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:47 on 2024-08-08 17:51_

Yes, it's very important that we resolve symlinks here: see my extended conversation with @carljm on my prior PR: https://github.com/astral-sh/ruff/pull/12716#discussion_r1705853339. System installations created by e.g. homebrew seem to make heavy use of symlinks so that they put `site-packages` in odd places while still nominally adhering to Python's expected installation layout. I can add a comment

---

_Comment by @AlexWaygood on 2024-08-08 18:14_

Ah dang. The existing tests that I previously added in https://github.com/astral-sh/ruff/commit/7fa76a2b2b07f303a18528d4bbdfa89911670b74 now fail, because we now reject a venv as an invalid venv if the venv's `pyvenv.cfg` file contains a `home` key that doesn't point to an actually existing directory. And the virtual environments that I committed to `resources/test` all have `home` keys in their `pyvenv.cfg` files that point to directories that exist for me locally, but that don't exist in CI (because I have not committed my system Python installation to the Ruff repo).

Not sure what to do here... it _would_ be really nice if we could have some way of creating a venv on the fly in the context of our test suite... but the venv would need to depend on some system Python installation, which would mean that our test suite would fail unless you had Python installed...

I guess we could just give up on the idea of testing with "real" venvs and create mock venv-like directory structures in the test? But it still feels unclear to me how valuable a test like that would actually be, since we'd really just be repeating the logic from the implementation in the test

---

_@AlexWaygood reviewed on 2024-08-08 18:17_

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:160 on 2024-08-08 18:17_

I added some more docs to the type

---

_@AlexWaygood reviewed on 2024-08-08 19:15_

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:181 on 2024-08-08 19:15_

In the `ruff_linter` crate I'd use the `warn_user!()` macro for this... what should I use here? A `tracing` call?

---

_@MichaReiser reviewed on 2024-08-08 19:54_

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:181 on 2024-08-08 19:54_

tracing::warn although there's no guarantee that is only shown once if the function is called multiple times. We may also have to return a diagnostic if this is something that runs in a salsa query. See my tracing documentation 

---

_Review comment by @carljm on `crates/red_knot_workspace/src/site_packages.rs`:98 on 2024-08-08 19:56_

FWIW I don't _think_ this is true for Windows. I don't have a Windows machine handy to check, but I have a vague memory (from many years ago) that on Windows the Python binary goes directly in the prefix dir of the installation, not inside `\Scripts`, which is the Windows equivalent to the `bin/` dir.

(This may also explain the lack of clarity in the docs around `bin/` dir vs prefix dir; IIRC Vinay, who wrote the docs, uses Windows, where I think there is no distinction to be made.)

---

_@MichaReiser reviewed on 2024-08-08 19:56_

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:160 on 2024-08-08 19:56_

I don't think unsupported python versions are a concern because constructing the Program settings would fail to construct and red knot aborts immediately (but we may want to design TargetVersion in a way so that this isn't a problem)

---

_Review comment by @carljm on `crates/red_knot_workspace/src/site_packages.rs`:163 on 2024-08-08 20:03_

Not to keep beating the same drum, but this function is not specific to being used from a venv, and there's no need to name the Python minor version this way, it's just a Python minor version no matter where we get it from.
```suggestion
    python_minor_version: Option<PythonMinorVersion>,
```

---

_Review comment by @carljm on `crates/red_knot_workspace/src/site_packages.rs`:308 on 2024-08-08 20:04_

Similar here; it doesn't matter from where we know the Python version, just that we know it.

---

_Review comment by @carljm on `crates/red_knot_workspace/src/site_packages.rs`:255 on 2024-08-08 20:07_

Nit: Does the `Kind` suffix add anything useful to the name of this enum?

---

_Review comment by @carljm on `crates/red_knot_workspace/src/site_packages.rs`:49 on 2024-08-08 20:09_

What's the benefit of splitting this out? (Not a problem, just curious)

---

_Review comment by @carljm on `crates/red_knot_workspace/src/site_packages.rs`:181 on 2024-08-08 20:13_

I think `tracing::warn!` is fine for this kind of thing? I think a settings-related warning like this is somewhat different from a diagnostic. But @MichaReiser might have a different thought.

---

_@carljm approved on 2024-08-08 20:22_

Looks good!

> I guess we could just give up on the idea of testing with "real" venvs and create mock venv-like directory structures in the test? But it still feels unclear to me how valuable a test like that would actually be, since we'd really just be repeating the logic from the implementation in the test

I know we touched on this briefly in the previous PR, but I really think this is a non-issue, and having tests that use (accurate) "mock" venvs is very useful, and in fact is precisely equally useful to using "real" venvs that we've committed directly.

Once we commit the files into our repo, it is for all intents and purposes a mock either way, because we don't have any ongoing validation that it continues to match what the venv module (or whatever other venv creator) does, and because the tests aren't running on the real system where the venv was created and can actually function. It's good to base our mocks carefully on real observed venvs, but it's also totally fine to then strip out known-to-be irrelevant parts, change the home path to point to an actual directory, etc. None of that makes the tests any less useful.

If it were me, I'd remove a bunch more unnecessary cruft from the committed mock venvs (like `pip` scripts and whatnot that are also non-functional because they refer to non-existent directories.)

I think the `home` thing will require (at least partly) switching from pre-committed mocks to written-out-by-the-test mocks, because it should be an absolute path (changing it to a relative path would IMO be too much of a departure from a real venv), and you won't know in advance what absolute path you can write to on some arbitrary system the tests run on.

---

_@AlexWaygood reviewed on 2024-08-08 20:35_

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:160 on 2024-08-08 20:35_

> constructing the Program settings would fail to construct

Why? Again, the Python version that the user is running locally could be a completely different Python version to the one they've specified with `--target-version`. The former is what's relevant here, not the latter.

---

_@AlexWaygood reviewed on 2024-08-08 20:36_

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:49 on 2024-08-08 20:36_

https://github.com/astral-sh/ruff/pull/12759#discussion_r1709913740

---

_@AlexWaygood reviewed on 2024-08-08 20:41_

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:255 on 2024-08-08 20:41_

It indicates that it's not an enum that implements `std::error::Error`; instead, it just stores some additional metadata providing some extra information about one of the variants of `SitePackagesDiscoveryError`. It's similar to `std::io::ErrorKind`

---

_@carljm reviewed on 2024-08-08 20:46_

---

_Review comment by @carljm on `crates/red_knot_workspace/src/site_packages.rs`:49 on 2024-08-08 20:46_

Aha, very interesting, I hadn't considered that!

---

_Review comment by @MichaReiser on `crates/red_knot/src/main.rs`:13 on 2024-08-09 07:05_

It feels a bit surprising that `VirtualEnvironment` is part of the `site_packages` module. Shouldn' we rename the `site_packages` module to `venv`?

---

_Review comment by @MichaReiser on `crates/red_knot/src/main.rs`:168 on 2024-08-09 07:08_

I think it's important that the CLI converts the `path` because IMO, the path should be relative to the CLI's current working directory and not `--current-directory`.

E.g. when I run the following command in `/project/ruff`

```shell
red_knot --current-directory ../test/sub --virtual-env ../venv`  
```

I would expect that `../venv` resolves to `/project/venv` and `current-directory` to `/project/test/sub`. I would be surprised if virtual env resolves to `/project/test/venv`

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:48 on 2024-08-09 07:12_

can you explain why it is `ok` to return `None` if the canonicalize fails. Shouldn't we return an error in that case (or at least log a warning) saying that we skipped that path because we don't have access or the symlink is broken. 

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:43 on 2024-08-09 07:12_

Is it guaranteed that `path` is an absolute path? If not, to what directory is it relative to?

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:40 on 2024-08-09 07:14_

This might be a Python habit of you but I generally prefer to have the public API at the top of the module and move module internal structs and functions further down. I find that it helps reading the code because I'm mostly concerned about the public API and only want to dive into the internals if I have to make changes/fix something. 

I think it can also help reviewers because I'm now forced to first read all internals before I get to the point where I see the external API, which is probably the most interesting thing to review.

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:95 on 2024-08-09 07:15_

Same as above. 

* I think we should either propagate a canonicalize failure or at least log a warning if it is safe to recover. 
* Can `unvalidated_path` be relative, if so, what to is it relative?



---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:106 on 2024-08-09 07:18_

Only representing the minor version here seems problematic to me because this will break with the release of Python 4. 

I still think we should just use `TargetVersion` here and instead change `TargetVersion` so that it can deal with future versions (by e.g. storing two `u8` internally and expose constants for the *known* python versions)

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:318 on 2024-08-09 07:21_

Uh, the `t` is subtle! I had to compare the strings in my text editor to spot the difference

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:292 on 2024-08-09 07:23_


```suggestion
/// The format of this file is not defined in anyway, and exactly which keys are present
```

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:73 on 2024-08-09 07:25_

Do we need to worry about env files that use `\r` file endings? I'm asking because `lines` only supports `\r\n` and `\n`.

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:456 on 2024-08-09 07:28_

Nit: I would use `split_once` in combination with a `contains` here
```suggestion
            if let Some((key, value)) = line.split_once('=') {
                if value.contains('=') {
                    let line_number = index.checked_add(1).and_then(NonZeroUsize::new).unwrap();
                    return Err(SitePackagesDiscoveryError::PyvenvCfgParseError(
                        pyvenv_cfg_path,
                        PyvenvCfgParseErrorKind::TooManyEquals { line_number },
                    ));
                }
                
                let key = key.trim();
                let value = value.trim();
                
                match key {
                    "include-system-site-packages" => {
                        include_system_site_packages = value.eq_ignore_ascii_case("true");
                    }
                    "home" => base_executable_home_path = Some(value),
                    // `virtualenv` and `uv` call this key `version_info`,
                    // but the stdlib venv module calls it `version`
                    "version" | "version_info" => version_info_string = Some(value),
                    _ => continue,
                }
            }
        }

```

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:153 on 2024-08-09 07:31_

Considering that we log `Attempting to...` with level=`debug`, I would expect that we log the "outcome" at the same level. To me, knowing to what the virtual environment resolved to seems more important than knowing that Red Knot is about to resolve it. 

However, That would mean that we might not want log the entire `metadata` struct in debug mode and have to write a slightly more polished message.

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:415 on 2024-08-09 07:32_


```suggestion
    pub fn site_packages_directories(
```

We spell `directories` out almost everywhere else.

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:426 on 2024-08-09 07:33_

I would prefer a `as_u8` method. `as_ref` in combination with `copied` reads strange.

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:542 on 2024-08-09 07:34_

I think it would be good to also have a windows venv. Considering that this is the platform that **we** use the least. Meaning, we won't get any coverage by using red knot ourselves. 

---

_@MichaReiser approved on 2024-08-09 07:35_

This is great. 

I mainly left questions around how we handle errors and how to handle relative paths. 

I'm not too fond of `PythonMinorVersion`. I still think we should just use `TargetVersion`

---

_@AlexWaygood reviewed on 2024-08-09 08:38_

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:318 on 2024-08-09 08:38_

Yes, this is quite annoying... Is there a way of making this more obvious, do you think?

---

_@AlexWaygood reviewed on 2024-08-09 08:40_

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:426 on 2024-08-09 08:40_

I'm not sure it's possible for me to add a new method to `std:: option::Option`

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:426 on 2024-08-09 08:44_

Oh, it's just about converting from `&Option<T>` to `Option<T>`. You can do

```
let minor_version = *minor_version;
```

I would then probably inline the expression

---

_@MichaReiser reviewed on 2024-08-09 08:44_

---

_@AlexWaygood reviewed on 2024-08-09 12:17_

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:106 on 2024-08-09 12:17_

I filed #12782. If we merge that, then we can use the `PythonVersion` type from that PR here.

---

_@AlexWaygood reviewed on 2024-08-09 12:31_

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:153 on 2024-08-09 12:31_

> Considering that we log `Attempting to...` with level=`debug`, I would expect that we log the "outcome" at the same level. To me, knowing to what the virtual environment resolved to seems more important than knowing that Red Knot is about to resolve it.

We do log that with `level=debug`, but we emit one log message once we've collected all `site-packages` directories, at the end of `site_packages_dirs()` (which I'm about to rename to `site_packages_directories()`. This makes for a less busy debug log output that's easier to understand: just one log message that tells you about both `site-packages` entries discovered, instead of two log messages that might have other logs in between them.

---

_@AlexWaygood reviewed on 2024-08-09 12:34_

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:73 on 2024-08-09 12:34_

How do we handle this elsewhere in Ruff? Is there an easy way of iterating line by line that would be resilient to files that have `\r` endings?

My instinct would be to say that there's a 95% chance that we'd never encounter a `pyvenv.cfg` file with `\r` endings, so I'm inclined not to worry about this unless there's an easy fix

---

_@AlexWaygood reviewed on 2024-08-09 12:38_

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:40 on 2024-08-09 12:38_

I don't think this is a particular convention I'm following; I think I'm just not thinking too much about it, which is on me :-)

I'll restructure this module and try to think more about this in the future, thanks.

---

_Review comment by @AlexWaygood on `crates/red_knot/src/main.rs`:13 on 2024-08-09 12:39_

That might make @carljm upset, since he keeps pointing out that several of the routines in this module really work with any Python installation, not just virtual environments ðŸ˜†

---

_@AlexWaygood reviewed on 2024-08-09 12:39_

---

_@AlexWaygood reviewed on 2024-08-09 13:44_

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:48 on 2024-08-09 13:44_

I'm not sure I understand. If canonicalisation fails, we immediately return `None` here, indicating that we failed to construct a `PythonHomePath` or a `SysPrefixPath`. The `.ok()?` call ensures that. At both places where we call `PythonHomePath::new()` or `SysPrefixPath::new()`, `None` being returned is immediately converted into an error. So we're not silently ignoring any errors here if canonicalisation fails.

Would you prefer it if this method return a `Result` rather than an `Option`? Would that make it clearer, in your opinion?

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:43 on 2024-08-09 13:50_

uv, virtualenv and the stdlib `venv` module all use absolute paths for the `home` key. And the stdlib `site` module appears to assume that the `home` key will provide an absolute path. But I have no idea if this is specified anywhere or if it's safe to rely on that. Paging @carljm as the person who invented Python virtual environments xD

---

_@AlexWaygood reviewed on 2024-08-09 13:50_

---

_@AlexWaygood reviewed on 2024-08-09 13:52_

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:318 on 2024-08-09 13:52_

I added a comment

---

_@MichaReiser reviewed on 2024-08-09 13:54_

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:73 on 2024-08-09 13:54_

95% is kind of low haha. There's the `UniversalNewlinesIterator` in `ruff_source_file`.

---

_@MichaReiser reviewed on 2024-08-09 13:56_

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:153 on 2024-08-09 13:56_

Sounds good? Just make sure to not log a struct with multiple fields with level `debug`. The output is intended for users

---

_@MichaReiser reviewed on 2024-08-09 13:58_

---

_Review comment by @MichaReiser on `crates/red_knot_workspace/src/site_packages.rs`:48 on 2024-08-09 13:58_

> Would you prefer it if this method return a Result rather than an Option? Would that make it clearer, in your opinion?

Returning a `Result` has the advantage that we can preserve the failure-cause which would be nice if this is an error that we show the user (or print to logs)

---

_@MichaReiser reviewed on 2024-08-09 13:58_

---

_Review comment by @MichaReiser on `crates/red_knot/src/main.rs`:13 on 2024-08-09 13:58_

Hmm yeah. Not sure. The hierarchy just feels slightly off to me. But we can also revisit this later.

---

_@AlexWaygood reviewed on 2024-08-09 13:58_

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:153 on 2024-08-09 13:58_

Right, that's why I logged this very detailed information here (which is in addition to the tracing::debug!()` call at the end of `site_packages_directories()`) with `tracing::trace!()`

---

_@AlexWaygood reviewed on 2024-08-09 13:59_

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:48 on 2024-08-09 13:59_

Alright, I'll do that

---

_Comment by @github-actions[bot] on 2024-08-09 17:09_

<!-- generated-comment ecosystem -->
## `ruff-ecosystem` results
### Linter (stable)
âœ… ecosystem check detected no linter changes.

### Linter (preview)
âœ… ecosystem check detected no linter changes.




---

_@carljm reviewed on 2024-08-09 17:14_

---

_Review comment by @carljm on `crates/red_knot/src/main.rs`:13 on 2024-08-09 17:14_

Well, it would depend how you do it :) I was actually going to make a similar comment and decided not to. But I would not want to just rename this module, I would want two modules, one which is specific to venvs and one which contains stuff that works on Python installations in general. But I'm also fine with just keeping it all in one module for now, which is why I didn't make that comment :)

---

_@carljm reviewed on 2024-08-09 17:16_

---

_Review comment by @carljm on `crates/red_knot/src/main.rs`:168 on 2024-08-09 17:16_

I wouldn't be entirely sure which of those results to expect, mostly because of the name `--current-directory` for that flag. I think your interpretation is fine, but it would be more obvious to me if instead of a `--current-directory` flag we just accepted the directory to check as an optional positional argument on the CLI, rather than a flag argument. (Also it's less to type :) )

---

_@carljm reviewed on 2024-08-09 17:24_

---

_Review comment by @carljm on `crates/red_knot_workspace/src/site_packages.rs`:43 on 2024-08-09 17:24_

> Paging @carljm as the person who invented Python virtual environments

Not true, that was Ian Bicking! (Or arguably PJ Eby, though his approach didn't catch on and Ian's did.)

> uv, virtualenv and the stdlib `venv` module all use absolute paths for the `home` key. And the stdlib `site` module appears to assume that the `home` key will provide an absolute path. But I have no idea if this is specified anywhere or if it's safe to rely on that.

Sadly this doesn't appear to have been clearly specified in the PEP, and it should have been :/ I think it is safe to rely on, simply because CPython itself won't work correctly with a relative path there (at best it would interpret the relative path as relative to your CWD when you run Python, not as relative to `pyvenv.cfg`, so if it worked at all it would be very fragile based on your CWD), and no venv creator puts a relative path there. But this is definitely something to consider in a potential update of the venv docs.


---

_@AlexWaygood reviewed on 2024-08-09 17:47_

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:73 on 2024-08-09 17:47_

I'm running into some annoying lifetime issues using `universal_newlines`. I tried making this change:

```diff
diff --git a/Cargo.lock b/Cargo.lock
index 970f8db7f..30aeed0c8 100644
--- a/Cargo.lock
+++ b/Cargo.lock
@@ -1961,6 +1961,7 @@ dependencies = [
  "ruff_cache",
  "ruff_db",
  "ruff_python_ast",
+ "ruff_source_file",
  "rustc-hash 2.0.0",
  "salsa",
  "thiserror",
diff --git a/crates/red_knot_workspace/Cargo.toml b/crates/red_knot_workspace/Cargo.toml
index d8d5203f6..dbe031c29 100644
--- a/crates/red_knot_workspace/Cargo.toml
+++ b/crates/red_knot_workspace/Cargo.toml
@@ -17,6 +17,7 @@ red_knot_python_semantic = { workspace = true }
 ruff_cache = { workspace = true }
 ruff_db = { workspace = true, features = ["os", "cache"] }
 ruff_python_ast = { workspace = true }
+ruff_source_file = { workspace = true }
 
 anyhow = { workspace = true }
 crossbeam = { workspace = true }
diff --git a/crates/red_knot_workspace/src/site_packages.rs b/crates/red_knot_workspace/src/site_packages.rs
index 575d7f69a..0c9462ae9 100644
--- a/crates/red_knot_workspace/src/site_packages.rs
+++ b/crates/red_knot_workspace/src/site_packages.rs
@@ -15,6 +15,7 @@ use std::ops::Deref;
 
 use red_knot_python_semantic::PythonVersion;
 use ruff_db::system::{System, SystemPath, SystemPathBuf};
+use ruff_source_file::UniversalNewlines;
 
 type SitePackagesDiscoveryResult<T> = Result<T, SitePackagesDiscoveryError>;
 
@@ -70,7 +71,7 @@ impl VirtualEnvironment {
         // '=' characters, so that's what we should do as well.
         //
         // See also: https://snarky.ca/how-virtual-environments-work/
-        for (index, line) in pyvenv_cfg.lines().enumerate() {
+        for (index, line) in pyvenv_cfg.universal_newlines().enumerate() {
             if let Some((key, value)) = line.split_once('=') {
                 let key = key.trim();
                 if key.is_empty() 
```

But now the borrow checker complains:

```
error[E0597]: `line` does not live long enough
   --> crates/red_knot_workspace/src/site_packages.rs:75:41
    |
74  |         for (index, line) in pyvenv_cfg.universal_newlines().enumerate() {
    |                     ---- binding `line` declared here
75  |             if let Some((key, value)) = line.split_once('=') {
    |                                         ^^^^ borrowed value does not live long enough
...
116 |         }
    |         - `line` dropped here while still borrowed
...
122 |         let Some(base_executable_home_path) = base_executable_home_path else {
    |                                               ------------------------- borrow later used here
```

I don't understand this, as the `line` variable yielded by the `universal_newlines` iterator should surely have the same lifetime as the `line` in my current PR branch. I also don't know how to fix it.

---

_@AlexWaygood reviewed on 2024-08-09 17:48_

---

_Review comment by @AlexWaygood on `crates/red_knot/src/main.rs`:13 on 2024-08-09 17:48_

Okay, I'll leave this for now; we can come back to it later

---

_Comment by @AlexWaygood on 2024-08-09 18:30_

I think I've now addressed everything except for https://github.com/astral-sh/ruff/pull/12759/files#r1711881269. Would appreciate it if somebody could take another quick look, though, as it's changed quite a lot today! In particular, the tests have been completely reworked (which was necessary to make them parse): there's no longer any committed virtual environments; we just create small mocks in tests.

---

_Review requested from @carljm by @AlexWaygood on 2024-08-09 18:32_

---

_Review requested from @MichaReiser by @AlexWaygood on 2024-08-09 18:32_

---

_Review comment by @carljm on `crates/red_knot_workspace/src/site_packages.rs`:411 on 2024-08-09 19:26_

Were you able to verify this, or just trusted my vague years-old memory here? ðŸ˜† 

---

_Review comment by @carljm on `crates/red_knot_workspace/src/site_packages.rs`:540 on 2024-08-09 19:30_

Related to my question above: I think if it hasn't happened already and doesn't happen before merge, we should track a follow-up task for someone with access to a Windows machine to actually audit this and make sure we are testing for behaviors that actually match what a Windows system / venv looks like.

---

_Review comment by @carljm on `crates/red_knot_workspace/src/site_packages.rs`:530 on 2024-08-09 19:31_

Any particular reason we calculate this unconditionally out here, rather than in the non-Windows block below?

---

_@carljm approved on 2024-08-09 19:34_

Looks good to me!

---

_@AlexWaygood reviewed on 2024-08-09 19:35_

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:411 on 2024-08-09 19:35_

I verified it on an extremely slow, very old Windows machine I had lying around. I had to install Python on the machine. It took forever -_-

---

_@AlexWaygood reviewed on 2024-08-09 19:36_

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:540 on 2024-08-09 19:36_

agreed, these tests really need to be supplemented with manual testing

---

_@carljm reviewed on 2024-08-09 19:38_

---

_Review comment by @carljm on `crates/red_knot_workspace/src/site_packages.rs`:540 on 2024-08-09 19:38_

Manual testing would be great, but if you at least validated that this mock setup matches what you see on a real Windows machine with Python installed on it, that's a great start for now.

---

_@AlexWaygood reviewed on 2024-08-09 19:40_

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:540 on 2024-08-09 19:40_

Yeah, I did that much. But considering how long installing Python took, there's no way I'm installing the Rust toolchain and doing manual testing of this PR on that machine ðŸ˜†

---

_@AlexWaygood reviewed on 2024-08-09 20:00_

---

_Review comment by @AlexWaygood on `crates/red_knot_workspace/src/site_packages.rs`:530 on 2024-08-09 20:00_

It's just annoying to have to define such a long variable so many times over and over... and this is a test, so I don't think binary size really matters quite so much here :P

---

_Renamed from "[red-knot] Use the system Python's `site-packages` as an additional search path if `include-system-site-packages = true` is present in a virtual environment's `pyvenv.cfg` file" to "[red-knot] Add support for `--system-site-packages` virtual environments" by @AlexWaygood on 2024-08-09 20:02_

---

_Merged by @AlexWaygood on 2024-08-09 20:02_

---

_Closed by @AlexWaygood on 2024-08-09 20:02_

---

_Branch deleted on 2024-08-09 20:02_

---
