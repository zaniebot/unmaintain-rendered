<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Always refresh diagnostics after a watched files change - astral-sh/ruff #19697</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Always refresh diagnostics after a watched files change</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/19697">#19697</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-08-01 20:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">Summary
<p>I first thought that this is a bug with workspace diagnostics (and precedence between workspace and pull) but later realized that this is also a problem with regular pull and push diagnostics.</p>
<ul>
<li>User opens file A that imports from file B</li>
<li>file B changes in a way so that the import in file A is now invalid</li>
</ul>
<p>The issue is that VS Code doesn&#x27;t fetch diagnostics on an external (file watcher change). It only does so when an open file changes. The fix in this PR is to always send a diagnostic refresh event after an external change. The only downside of this approach is that the client might request diagnostics when not necessary. But this should, overall, be relatively cheap, given that all the requst should be cached.</p>
<p>Closes <a href="https://github.com/astral-sh/ty/issues/925">astral-sh/ty#925</a></p>
Test Plan
<p><strong>Before</strong>:</p>
<p>No diagnostic, because the client doesn&#x27;t fetch diagnostics when non-open files changes</p>
<p>https://github.com/user-attachments/assets/6f68c4d7-efeb-43fd-8d47-87d3e2d97630</p>
<p><strong>Now</strong></p>
<p>Diagnostic appears.</p>
<p>https://github.com/user-attachments/assets/b55196be-9b72-4c1d-9e3e-e715d4a43a61</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">bug</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-01 20:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">server</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-01 20:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-01 20:33</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dhruvmanila">@dhruvmanila</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-01 20:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-01 20:35</div>
            <div class="timeline-body">

Diagnostic diff on typing conformance tests
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-08-01 20:37</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-01 20:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-01 20:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-01 20:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-01 20:37</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-01 20:37</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-08-04 06:50</div>
            <div class="timeline-body"><p>Agreed. Now that we have diagnostics caching and other optimizations, these requests shouldn&#x27;t be expensive if not much has changed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for <a href="https://github.com/AlexWaygood">@AlexWaygood</a> removed by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-08-04 08:39</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-04 10:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-08-04 10:19</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-08-04 10:19</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:17:16 UTC
    </footer>
</body>
</html>
