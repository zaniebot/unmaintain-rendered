```yaml
number: 4938
title: A basic StmtAssign formatter and better dummies for expressions
type: pull_request
state: merged
author: konstin
labels: []
assignees: []
merged: true
base: main
head: stmt-assign-and-expr-dummies
created_at: 2023-06-07T20:27:50Z
updated_at: 2023-06-08T10:20:27Z
url: https://github.com/astral-sh/ruff/pull/4938
synced_at: 2026-01-12T15:55:17Z
```

# A basic StmtAssign formatter and better dummies for expressions

---

_@konstin_

This PR was formatting StmtAssign since many nodes in the black tests (and in python in general) are after an assignment. This caused unstable formatting: The spacing of power op spacing depends on the type of the two involved expressions, but each expression was formatted as dummy string and re-parsed as a ExprName, so in the second round the different rules of ExprName (than say ExprConstant or ExprCall) were applied, causing unstable formatting.

This PR does not necessarily bring us closer to black's style, but it unlocks a good porting of black's test suite and is a basis for implementing the Expr nodes.


---

_Comment by @konstin on 2023-06-07 20:28_

Current dependencies on/for this PR:
* main
  * **PR #4938** <a href="https://app.graphite.dev/github/pr/charliermarsh/ruff/4938" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.png" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/charliermarsh/ruff/4938?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-06-07 20:40_

## PR Check Results
### Ecosystem
âœ… ecosystem check detected no changes.

### Benchmark
#### Linux
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      6.5Â±0.17ms     6.2 MB/sec    1.05      6.9Â±0.25ms     5.9 MB/sec
formatter/numpy/ctypeslib.py               1.00  1341.4Â±76.35Âµs    12.4 MB/sec    1.02  1365.5Â±47.67Âµs    12.2 MB/sec
formatter/numpy/globals.py                 1.00    153.0Â±9.15Âµs    19.3 MB/sec    1.05   160.4Â±16.65Âµs    18.4 MB/sec
formatter/pydantic/types.py                1.00      3.0Â±0.24ms     8.5 MB/sec    1.00      3.0Â±0.10ms     8.5 MB/sec
linter/all-rules/large/dataset.py          1.00     17.0Â±0.35ms     2.4 MB/sec    1.13     19.2Â±0.67ms     2.1 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.1Â±0.13ms     4.1 MB/sec    1.08      4.4Â±0.15ms     3.8 MB/sec
linter/all-rules/numpy/globals.py          1.00   507.7Â±18.92Âµs     5.8 MB/sec    1.06   540.6Â±20.21Âµs     5.5 MB/sec
linter/all-rules/pydantic/types.py         1.00      7.2Â±0.25ms     3.5 MB/sec    1.11      8.0Â±0.31ms     3.2 MB/sec
linter/default-rules/large/dataset.py      1.00      8.0Â±0.18ms     5.1 MB/sec    1.20      9.5Â±0.21ms     4.3 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1723.7Â±58.95Âµs     9.7 MB/sec    1.15  1984.9Â±101.24Âµs     8.4 MB/sec
linter/default-rules/numpy/globals.py      1.00    202.7Â±8.13Âµs    14.6 MB/sec    1.10    222.5Â±9.04Âµs    13.3 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.7Â±0.14ms     7.0 MB/sec    1.13      4.1Â±0.13ms     6.2 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      8.1Â±0.16ms     5.0 MB/sec    1.01      8.2Â±0.21ms     5.0 MB/sec
formatter/numpy/ctypeslib.py               1.00  1566.8Â±43.54Âµs    10.6 MB/sec    1.03  1621.3Â±49.86Âµs    10.3 MB/sec
formatter/numpy/globals.py                 1.00    180.3Â±7.27Âµs    16.4 MB/sec    1.10   198.5Â±12.24Âµs    14.9 MB/sec
formatter/pydantic/types.py                1.00      3.6Â±0.13ms     7.1 MB/sec    1.02      3.7Â±0.09ms     7.0 MB/sec
linter/all-rules/large/dataset.py          1.03     20.8Â±0.59ms  2003.0 KB/sec    1.00     20.2Â±0.42ms     2.0 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.03      5.5Â±0.57ms     3.1 MB/sec    1.00      5.3Â±0.18ms     3.1 MB/sec
linter/all-rules/numpy/globals.py          1.00   599.6Â±39.36Âµs     4.9 MB/sec    1.07   638.6Â±26.70Âµs     4.6 MB/sec
linter/all-rules/pydantic/types.py         1.00      8.7Â±0.42ms     2.9 MB/sec    1.02      8.8Â±0.29ms     2.9 MB/sec
linter/default-rules/large/dataset.py      1.00      9.9Â±0.28ms     4.1 MB/sec    1.00      9.9Â±0.26ms     4.1 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00      2.1Â±0.06ms     8.0 MB/sec    1.00      2.1Â±0.06ms     8.0 MB/sec
linter/default-rules/numpy/globals.py      1.01    246.2Â±9.02Âµs    12.0 MB/sec    1.00    243.8Â±9.78Âµs    12.1 MB/sec
linter/default-rules/pydantic/types.py     1.00      4.4Â±0.12ms     5.8 MB/sec    1.01      4.5Â±0.13ms     5.7 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_constant.rs`:13 on 2023-06-07 20:55_

Should we use verbatim for const to assure that we don't flip between different const types (e.g a docstring becoming a number could lead to different formatting)

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_set.rs`:22 on 2023-06-07 20:57_

Nit: inline a and b (the variable names are more difficult to understand than the actual function calls)

---

_Review comment by @MichaReiser on `crates/ruff_python_formatter/src/expression/expr_set.rs`:23 on 2023-06-07 20:58_

You can use the .formatted() extension method instead of mapping over AsFormat yourself 

---

_@MichaReiser approved on 2023-06-07 21:00_

---

_Marked ready for review by @konstin on 2023-06-08 09:31_

---

_@konstin reviewed on 2023-06-08 10:14_

---

_Review comment by @konstin on `crates/ruff_python_formatter/src/expression/expr_constant.rs`:13 on 2023-06-08 10:14_

not in this PR, this will change all test strings again

---

_Merged by @konstin on 2023-06-08 10:20_

---

_Closed by @konstin on 2023-06-08 10:20_

---

_Branch deleted on 2023-06-08 10:20_

---
