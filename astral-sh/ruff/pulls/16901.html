<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] Goto type definition - astral-sh/ruff #16901</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] Goto type definition</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/16901">#16901</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-03-21 16:36
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header">Pull request opened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-21 16:36</div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Implement basic <em>Goto type definition</em> support for Red Knot's LSP.</p>
<p>This PR also builds the foundation for other LSP operations. E.g., Goto definition, hover, etc., should be able to reuse some, if not most, logic introduced in this PR.</p>
<p>The basic steps of resolving the type definitions are:</p>
<ol>
<li>Find the closest token for the cursor offset. This is a bit more subtle than I first anticipated because the cursor could be positioned right between the callee and the <code>(</code> in <code>call(test)</code>, in which case we want to resolve the type for <code>call</code>.</li>
<li>Find the node with the minimal range that fully encloses the token found in 1. I somewhat suspect that 1 and 2 could be done at the same time but it complicated things because we also need to compute the spine (ancestor chain) for the node and there's no guarantee that the found nodes have the same ancestors</li>
<li>Reduce the node found in 2. to a node that is a valid goto target. This may require traversing upwards to e.g. find the closest expression.</li>
<li>Resolve the type for the goto target</li>
<li>Resolve the location for the type, return it to the LSP</li>
</ol>
<h2>Design decisions</h2>
<p>The current implementation navigates to the inferred type. I think this is what we want because it means that it correctly accounts for narrowing (in which case we want to go to the narrowed type because that's the value's type at the given position). However, it does have the downside that Goto type definition doesn't work whenever we infer <code>T &amp; Unknown</code> because intersection types aren't supported. I'm not sure what to do about this specific case, other than maybe ignoring <code>Unkown</code> in Goto type definition if the type is an intersection?</p>
<h2>Known limitations</h2>
<ul>
<li>Types defined in the vendored typeshed aren't supported because the client can't open files from the red knot binary (we can either implement our own file protocol and handler OR extract the typeshed files and point there). See https://github.com/astral-sh/ty/issues/77</li>
<li>Red Knot only exposes an API to get types for expressions and definitions. However, there are many other nodes with identifiers that can have a type (e.g. go to type of a globals statement, match patterns, ...). We can add support for those in separate PRs (after we figure out how to query the types from the semantic model). See https://github.com/astral-sh/ty/issues/144</li>
<li>We should have a higher-level API for the LSP that doesn't directly call semantic queries. I intentionally decided not to design that API just yet.</li>
</ul>
<h2>Test plan</h2>
<p>https://github.com/user-attachments/assets/fa077297-a42d-4ec8-b71f-90c0802b4edb</p>
<p>Goto type definition on a union</p>
<p><img width="1215" alt="Screenshot 2025-04-01 at 13 02 55" src="https://github.com/user-attachments/assets/689cabcc-4a86-4a18-b14a-c56f56868085" /></p>
<p>Note: I recorded this using a custom typeshed path so that navigating to builtins works.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-03-21 16:40</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_server/src/document/text_document.rs</code>:117 on 2025-03-21 16:40</div>
            <div class="timeline-body"><p>This is a bugfix that I copied over from ruff-server</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-21 16:42</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by @MichaReiser on 2025-03-21 16:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-03-21 16:53</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-01 09:22</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_server/src/document/range.rs</code>:1 on 2025-04-01 09:22</div>
            <div class="timeline-body"><p>The main change here is that I extracted a helper to convert a LSP <code>Position</code> to a <code>TextSize</code> and I then used this logic in <code>to_text_range</code> (which simplifies the code quiet a bit)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-01 09:23</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:252 on 2025-04-01 09:23</div>
            <div class="timeline-body"><p>@BurntSushi I hope you're fine with me making this method public. I need a way to say: Yes, I printed this diagnostic, please don't panic ;)</p>
<p>https://github.com/astral-sh/ruff/blob/54c359b8fc5cc65e41d73f5a4573b5b1a93ca4b0/crates/red_knot_ide/src/goto.rs#L857-L884</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @MichaReiser on 2025-04-01 11:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @MichaReiser on 2025-04-01 11:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @MichaReiser on 2025-04-01 11:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @MichaReiser on 2025-04-01 11:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @MichaReiser on 2025-04-01 11:06</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dhruvmanila by @MichaReiser on 2025-04-01 11:06</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-04-01 14:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:252 on 2025-04-01 14:14</div>
            <div class="timeline-body"><p>I was kinda hoping that we wouldn't export this, but I think it's fine. The panic is ultimately a developer aide, and it should be okay I think for programmers to opt into disabling it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-01 14:17</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:252 on 2025-04-01 14:17</div>
            <div class="timeline-body"><p>I can also change the code to create the <code>source</code> diagnostic in a helper if you prefer. I guess, the most idiomatic way to write this is to have a <code>GotoTypeDefinitionDiagnostic</code> struct that <em>implements</em> <code>into_diagnostic</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/BurntSushi">@BurntSushi</a> reviewed on 2025-04-01 14:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/BurntSushi">@BurntSushi</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:252 on 2025-04-01 14:26</div>
            <div class="timeline-body"><p>Oh I see. OK, I actually looked at how you're using this and see what you mean.</p>
<p>I think for this particular example, one thing that would be nice is to define a <code>Diagnostic::ignore</code>/<code>SubDiagnostic::ignore</code> method that consumes <code>self</code> and calls the crate internal <code>printed()</code> method. That way, it's a declarative and compiler enforced way of &quot;throwing away&quot; a diagnostic intentionally.</p>
<p>It probably doesn't cover everything that the more flexible <code>printed()</code> method does, but I think it's probably nicer if we can get away with it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-01 14:29</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/diagnostic/mod.rs</code>:252 on 2025-04-01 14:29</div>
            <div class="timeline-body"><p>I rewrote it so that the <code>source</code> gets recreated everytime (by having a specific <code>GotoTypeDefinitionDiagnostic</code>) but I also like your idea of having an <code>ignore</code> method which &quot;explicitly&quot; drops a diagnostic (which will be something we need for Ruff where <code>Diagnostic</code>s get created even if they're suppressed and are then filtered out at a later stage)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-04-01 16:42</div>
            <div class="timeline-body"><blockquote>
<p>it does have the downside that Goto type definition doesn't work whenever we infer <code>T &amp; Unknown</code> because intersection types aren't supported. I'm not sure what to do about this specific case, other than maybe ignoring <code>Unkown</code> in Goto type definition if the type is an intersection?</p>
</blockquote>
<p>I do think that we should ideally drill down into both unions and intersections and filter out a number of types: <code>Any</code>, <code>Unknown</code>, <code>Todo</code> (so all <code>Type::Dynamic</code>), as well as <code>Type::AlwaysTruthy</code>, <code>Type::AlwaysFalsy</code>, and possibly others. Basically any type that commonly arises from narrowing that has no useful definition target. This should allow goto features to work better for many narrowed types.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:792 on 2025-04-01 17:32</div>
            <div class="timeline-body"><p>Should we implement <code>focus_range</code> and <code>full_range</code> on <code>Type</code> (and return <code>None</code> for types where we don't know it) so we don't have to expose so many type internals?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:658 on 2025-04-01 17:36</div>
            <div class="timeline-body"><p>I don't really know the parser code so feel free to ignore, but I don't really understand this comment. Tokens are a stream, not a tree, so what does &quot;spine to the root&quot; even mean in terms of tokens?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:666 on 2025-04-01 17:37</div>
            <div class="timeline-body"><p>The use of &quot;node&quot; here feels odd to me, why not just say &quot;token&quot;?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_ide/src/lib.rs</code>:150 on 2025-04-01 17:51</div>
            <div class="timeline-body"><p>If this is a subclass-of a class type (not dynamic), then it should have the navigation targets of that class.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_ide/src/lib.rs</code>:161 on 2025-04-01 17:52</div>
            <div class="timeline-body"><p>Why not handle this the same as union and collect all navigation targets from elements?</p>
<p>(I think we can ignore negative elements.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_ide/src/lib.rs</code>:142 on 2025-04-01 17:53</div>
            <div class="timeline-body"><p>These should probably just not have any navigation targets?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_ide/src/lib.rs</code>:154 on 2025-04-01 17:55</div>
            <div class="timeline-body"><p>I suppose this might as well go to the definition of <code>tuple</code>. (I realize that wouldn't work yet because we don't support typeshed yet, but it would be consistent with the way we handle strings, ints, etc above)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-04-01 17:56</div>
            <div class="timeline-body"><p>Looks good to me! I don't know the LSP or parser code well, so I can't claim to have done a solid review of those parts, but I looked over the goto stuff.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-04-01 17:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:792 on 2025-04-01 17:57</div>
            <div class="timeline-body"><p>(Oh, this comment was before I read the full diff; I've seen now the navigation-targets trait. I understand why we want to keep all the trait implementations of that in one place, but it still does feel odd to me that we do that outside of the semantics crate, meaning we have to make so many type internals public.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-04-01 18:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_ide/src/lib.rs</code>:150 on 2025-04-01 18:01</div>
            <div class="timeline-body"><p>you'll want to do something like</p>
<pre><code class="language-rs">            Type::SubclassOf(subclass_of_type) =&gt; match subclass_of_type.subclass_of() {
                ClassBase::Class(class) =&gt; class.navigation_targets(db),
                ClassBase::Dynamic(_) =&gt; NavigationTargets::empty(),
            }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-01 19:49</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_ide/src/lib.rs</code>:161 on 2025-04-01 19:49</div>
            <div class="timeline-body"><p>The difference is that the value isn't the type of any of the elements in the intersection. Instead, it's the type that intersects with all elements. So I think it's just wrong? I can try and see what typescript does here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-04-01 20:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_ide/src/lib.rs</code>:161 on 2025-04-01 20:18</div>
            <div class="timeline-body"><p>It's the type of <em>all</em> the elements of the intersection; if anything it seems even more correct here than in the union case? In the union case, the actual value only needs to be one of the union elements, the other ones are all &quot;wrong&quot;.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_server/src/session/capabilities.rs</code>:45 on 2025-04-02 02:54</div>
            <div class="timeline-body"><p>What's the reason for querying client capabilities from <code>declaration</code>? Shouldn't it be from <code>type_definition</code>? https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#typeDefinitionClientCapabilities, https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textDocument_typeDefinition suggests the same</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:598 on 2025-04-02 03:05</div>
            <div class="timeline-body"><p>It would be useful to add a couple of test cases for this new method.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:584 on 2025-04-02 03:06</div>
            <div class="timeline-body"><pre><code class="language-suggestion">            // No token found that starts exactly at the given offset. But it's possible that
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/ruff_python_parser/src/lib.rs</code>:685 on 2025-04-02 03:12</div>
            <div class="timeline-body"><p>nit: maybe we can use the same logic as <code>TokenAt::Between</code> to avoid the <code>mem::replace</code> all for every iteration?</p>
<pre><code class="language-suggestion">        match self {
            TokenAt::None =&gt; None,
            TokenAt::Single(token) =&gt; {
                *self = TokenAt::None;
                Some(token)
            }
            TokenAt::Between(first, second) =&gt; {
                *self = TokenAt::Single(second);
                Some(first)
            }
        }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_server/src/session/capabilities.rs</code>:12 on 2025-04-02 03:13</div>
            <div class="timeline-body"><p>I think this should be <code>type_definition_link_support</code>? Refer to my other comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_server/src/server/api/requests/goto_type_definition.rs</code>:65 on 2025-04-02 03:16</div>
            <div class="timeline-body"><p>Should we use <code>GotoDefinitionResponse::Scalar</code> when there's only one location? Do you know or found anything that the client might do different when it's an array v/s a location?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:3497 on 2025-04-02 03:22</div>
            <div class="timeline-body"><p>Note that the <code>target_range</code> method has been mainly used for logging purposes. From what I remember, it always tries to get the identifier range except for in certain cases like unpacking, except clause, etc.. I guess it should be fine here but thought to point it out.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_ide/src/lib.rs</code>:163 on 2025-04-02 03:32</div>
            <div class="timeline-body"><p>Should this go to the <code>Callable</code> definition in <code>collections.abc</code>? Pyright doesn't do it thought.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_ide/src/lib.rs</code>:201 on 2025-04-02 03:33</div>
            <div class="timeline-body"><p>Should this be the entire module range?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_ide/src/goto.rs</code>:10 on 2025-04-02 03:38</div>
            <div class="timeline-body"><p>nit: <code>goto_type_definition</code> as &quot;goto&quot; spelling is being used everywhere?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_ide/src/goto.rs</code>:243 on 2025-04-02 03:53</div>
            <div class="timeline-body"><p>These test cases are really great, interesting use of the new diagnostic system</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> approved on 2025-04-02 03:56</div>
            <div class="timeline-body"><p>This looks really great!</p>
<p>This shouldn't block merging the PR but I want to look at the covering node logic tomorrow morning and also want to play around with it in an editor context.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-02 08:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_ide/src/lib.rs</code>:161 on 2025-04-02 08:07</div>
            <div class="timeline-body"><p>TypeScript doesn't support <em>goto type definition</em> on intersections, which matches my understanding unless Red Knot's intersection types work differently.</p>
<p>The LSP shows one location for each union variant, which very nicely matches how unions work: The value is one of the types shown (see screenshot above).</p>
<p>It would be very surprising if we showed intersections exactly the same as unions because users would then be unable to distinguish them from unions. I'll leave this as is (minus filtering out <code>Unknown</code>) because I'm not convinced that presenting them the same as unions is the right solution and there isn't an obvious alternative.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-04-02 08:08</div>
            <div class="timeline-body"><blockquote>
<p>I do think that we should ideally drill down into both unions and intersections and filter out a number of types: Any, Unknown, Todo (so all Type::Dynamic), as well as Type::AlwaysTruthy, Type::AlwaysFalsy, and possibly others. Basically any type that commonly arises from narrowing that has no useful definition target. This should allow goto features to work better for many narrowed types.</p>
</blockquote>
<p>This already happens for unions (because those types have no navigation targets). I can see if I can refine intersection types further.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-02 08:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_server/src/server/api/requests/goto_type_definition.rs</code>:65 on 2025-04-02 08:44</div>
            <div class="timeline-body"><p>I didn't notice any difference and r-a also uses <code>Array</code> even for single values.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_ide/src/lib.rs</code>:163 on 2025-04-02 08:47</div>
            <div class="timeline-body"><p>Wouldn't that be Goto definition? If so, I thin it should go to <code>type</code> (because this is what <code>to_meta_type</code> returns?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-02 08:47</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-02 08:56</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:792 on 2025-04-02 08:56</div>
            <div class="timeline-body"><p>I agree that it would be great to avoid exposing these internals. I called this out in the summary that we should introduce a new high level API for all those operations. I'm reluctant to do so just now because it's unclear to me how that API would look like.</p>
<p>I'm getting the sense that we lack two APIs:</p>
<ul>
<li>Give a type query its definition: This is roughly what the big match statement does.</li>
<li>Given a node, query its definition: We'll need this for hover (because most IDEs show the signature and not just the type) and to support some of the goto targets that we currently can't retrieve a type for.</li>
</ul>
<p>I also don't consider this a problem specific to semantic indexing. Ideally, the LSP and linter would limit their use of salsa APIs (including APIs from <code>ruff_db</code>, e.g. <code>system_path_to_file</code>). But I'm not sure yet how that would look like. I need some more code to identify a pattern.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-02 08:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_ide/src/lib.rs</code>:201 on 2025-04-02 08:58</div>
            <div class="timeline-body"><p>Possibly. It makes it a bit more awkward to implement because I then need to query the source text (it's not hard). But it's not clear to me if that's more accurate because the module doesn't strictly have a range. It's just the file. That's why I opted for the most trivial solution for now. We can still adjust the ranges if it turns out that we should highlight the entire module</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-02 09:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:792 on 2025-04-02 09:00</div>
            <div class="timeline-body"><p>For example, r-a requires that the ide crate uses its <code>Semantics</code> API</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-04-02 11:00</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/types/class.rs</code>:792 on 2025-04-02 11:00</div>
            <div class="timeline-body"><p>Okay, I have an idea of how to address some of the concerns. But I'll do so in a separate PR</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-04-02 12:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-04-02 12:12</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-04-02 12:12</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/dhruvmanila">@dhruvmanila</a> reviewed on 2025-04-02 14:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on <code>crates/red_knot_ide/src/lib.rs</code>:163 on 2025-04-02 14:46</div>
            <div class="timeline-body"><p>I was referring to a variable that's annotated using <code>typing.Callable</code> similar to how we go to <code>int</code> class for a variable annotated as <code>int</code>. For example, <code>x: Callable[[], None] = lambda: None</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2025-04-02 15:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_ide/src/lib.rs</code>:163 on 2025-04-02 15:11</div>
            <div class="timeline-body"><p>Yeah I think going to the definition of the Callable type for something with a type of <code>Callable</code> would make sense and be consistent with goto-type-definition. But also doesn't really matter until we support navigating to typeshed anyway.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-10 19:41:05 UTC
    </footer>
</body>
</html>
