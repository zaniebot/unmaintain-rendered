<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[ty] Add PYTHONPATH to EnvVars and fix on Windows - astral-sh/ruff #20490</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[ty] Add PYTHONPATH to EnvVars and fix on Windows</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/20490">#20490</a>
        opened by <a href="https://github.com/mmlb">@mmlb</a>
        on 2025-09-20 21:23
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mmlb">@mmlb</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<ul>
<li>Add <code>PYTHONPATH</code> to <code>ty_static::EnvVars</code> so it shows up in envvar docs.</li>
<li>Remove custom env path splitting with hard coded separator and use stdlib instead, fixing windows.</li>
</ul>
<h2>Test Plan</h2>
<p>No new tests added.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @carljm by @mmlb on 2025-09-20 21:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @MichaReiser by @mmlb on 2025-09-20 21:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @sharkdp by @mmlb on 2025-09-20 21:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @dcreager by @mmlb on 2025-09-20 21:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from @AlexWaygood by @mmlb on 2025-09-20 21:23</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mmlb">@mmlb</a> on 2025-09-20 21:25</div>
            <div class="timeline-body"><p>The EnvVar bit came out of https://github.com/astral-sh/ty/issues/1219 and coming up with a doc for that issue I checked CPython's own docs and noted the mention of os.pathsep and :man_facepalming: so fixed it here too. Not sure how to add a windows test and also unsure if the <code>panic!</code> is the right call in system.rs</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mmlb">@mmlb</a> on <code>crates/ruff_db/src/system.rs</code>:196 on 2025-09-20 21:25</div>
            <div class="timeline-body"><p>not sure if there's a better alternative</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-20 21:25</div>
            <div class="timeline-body"><!-- generated-comment typing_conformance_diagnostics_diff -->

<h2>Diagnostic diff on <a href="https://github.com/python/typing/tree/d4f39b27a4a47aac8b6d4019e1b0b5b3156fabdc/conformance">typing conformance tests</a></h2>
<p>No changes detected when running ty on typing conformance tests ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mmlb">@mmlb</a> on <code>crates/ty_project/src/metadata/options.rs</code>:308 on 2025-09-20 21:25</div>
            <div class="timeline-body"><p>should this be <code>to_string_lossy</code> instead?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mmlb">@mmlb</a> reviewed on 2025-09-20 21:26</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by @AlexWaygood on 2025-09-20 21:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-20 21:34</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-09-20 21:35</div>
            <div class="timeline-body"><!-- generated-comment mypy_primer -->

<h2><code>mypy_primer</code> results</h2>
<p>No ecosystem changes detected ✅
No memory usage changes detected ✅</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_db/src/system.rs</code>:196 on 2025-09-22 10:24</div>
            <div class="timeline-body"><p>We shouldn't provide a default implementation that always panics. Instead, each <code>System</code> implementation should add its own implementation.</p>
<ul>
<li>Implementing it for <code>TestSystem</code> is trivial because we can forward to the inner system (the same as all other methods do).</li>
<li>Implementing it for <code>LSPSystem</code> is trivial too, simply forward to the <code>native_system</code></li>
<li>Implementing it for <code>MemorySystem</code> is a bit trickier. I'd be inclined to simply split by <code>:</code></li>
</ul>
<p>The method also can't return <code>std::env::SplitPaths</code> because it means that the only possible implementation is <code>std::env::split_paths</code>. The return type either has to be a <code>vec[SystemPath]</code> or <code>Box&lt;dyn Iterator&lt;Item=&amp;'a SystemPath&gt;&gt;</code></p>
<p>Having said all this. We've only added methods to <code>System</code> when we had a need to abstract over them. For example, we only added <code>env_var</code> because we ran into issues with test isolation. All file system operations exist because we need to &quot;patch&quot; some in the LSP case AND because we wanted to use a memory file system in tests.</p>
<p>That's why I'd suggest removing the method for now. We can always add it to <code>System</code> when the need arises and it simplifies our lifes now :)</p>
<p>There are other platform-specific behaviors we're currently not normalizing by using <code>System</code>. For example, <code>SystemPath</code> uses the underlying <code>Path</code> type. That means Windows and Unix use different path representations. We could normalize all paths to Unix paths but we haven't seen a need for it just yet.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/metadata/options.rs</code>:307 on 2025-09-22 10:24</div>
            <div class="timeline-body"><p>Oh nice find with <code>split_paths</code>. I think we should update our CLI test to correctly set the <code>PYTHONPATH</code> variable depending on the platform (by using <code>std::env::join_paths</code>)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/metadata/options.rs</code>:308 on 2025-09-22 10:28</div>
            <div class="timeline-body"><p>What you have here is fine but I suggest using <code>let Ok(path) = ... else {</code> and using <code>SystemPathBuf::from_std_path</code> instead (which avoids any allocations if the path is a valid UTF8 path)</p>
<pre><code class="language-rust">                let Ok(path) = SystemPathBuf::from_path_buf(path) else {
                    tracing::debug!(
                        &quot;Skipping `{path}` listed in `PYTHONPATH` because it is not a valid UTF-8 path.&quot;
                    );
                    continue;
                };

                let possible_path = SystemPath::absolute(path, system.current_directory());
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/metadata/options.rs</code>:323 on 2025-09-22 10:33</div>
            <div class="timeline-body"><p>Reading this code again. I'm wondering what the precedence between <code>PYTHONPATH</code> and <code>extra_paths</code> should be. What's implemented now is that <code>PYTHONPATH</code> takes precedence over the user-provided <code>extra_paths</code>. This contradicts the extra paths documentation.</p>
<p>https://github.com/astral-sh/ruff/blob/2fec3f75ee42a149ccb39e498470f1300ec93466/crates/ty_project/src/metadata/options.rs#L546-L548</p>
<p>@AlexWaygood do you think it makes sense that <code>PYTHONPATH</code> takes precedence over <code>extra_paths</code>, or should it be the other way round?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_static/src/env_vars.rs</code>:45 on 2025-09-22 10:34</div>
            <div class="timeline-body"><p>I don't think I'd know what this means as a ty user (what does augmented mean in this case?)</p>
<p>uv's documentation for <code>PYTHONPATH</code> is</p>
<pre><code>Adds directories to Python module search path (e.g., PYTHONPATH=/path/to/modules).
</code></pre>
<p>I suggest something similar</p>
<p>Adds additional directories to ty's search paths. The format is the same as the shell’s PATH: one or more directory pathnames separated by <a href="https://docs.python.org/3/library/os.html#os.pathsep">os.pathsep</a> (e.g. colons on Unix or semicolons on Windows).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-09-22 10:35</div>
            <div class="timeline-body"><p>Thank you. A few nits and suggestions around the documentation. I suggest removing <code>split_paths</code> from <code>System</code> for now unless there's a need today (e.g. the wasm tests are failing in CI)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-09-22 11:18</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ty_project/src/metadata/options.rs</code>:323 on 2025-09-22 11:18</div>
            <div class="timeline-body"><p>I agree with you — I think ty's explicit configuration (<code>extra_paths</code>) should take precedence over paths in <code>PYTHONPATH</code>, which is an external environment variable (used for configuring Python itself) that isn't ty-specific</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mmlb">@mmlb</a> reviewed on 2025-09-22 13:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mmlb">@mmlb</a> on <code>crates/ruff_db/src/system.rs</code>:196 on 2025-09-22 13:45</div>
            <div class="timeline-body"><p>my initial thought was to just use os.pathsep equivalent, but its not exposed. I flirted with just defining our own and using with the split I had already but then switched over to the stdlib's function. I'll just go back to my first PR with platform specific separator, that seemed the cleanest way.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mmlb">@mmlb</a> reviewed on 2025-09-22 13:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mmlb">@mmlb</a> on <code>crates/ty_project/src/metadata/options.rs</code>:308 on 2025-09-22 13:58</div>
            <div class="timeline-body"><p>Going back to previous code that was simpler, so this is unnecessary.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mmlb">@mmlb</a> on 2025-09-22 14:35</div>
            <div class="timeline-body"><p>I've updated the PR by using a platform specific separator instead of the hard coded <code>:</code> and added join_paths based test to ensure correctness. I've also switched the precedence between PYTHONPATH and extra-paths as requested. PTAL.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "[ty]: Add PYTHONPATH to EnvVars and fix on Windows" to "[ty] Add PYTHONPATH to EnvVars and fix on Windows" by @mmlb on 2025-09-22 14:49</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mmlb">@mmlb</a> on 2025-09-22 15:16</div>
            <div class="timeline-body"><p>Looks like windows is failing to replace <code>C:\...</code> with <code>&lt;temp_dir&gt;</code>. Not sure if its because <code>insta::with_filters</code> needs <code>C:\</code> or if I did something weird.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-09-22 16:37</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty/tests/cli/python_environment.rs</code>:1934 on 2025-09-22 16:37</div>
            <div class="timeline-body"><p>I'm not sure what's different with this test that the path filtering doesn't work. Can you try splitting this second case into its own test, just to ensure that two <code>CliTest</code> don't interfere with each other (in some unfortunate way?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty/tests/cli/python_environment.rs</code>:1934 on 2025-09-22 17:59</div>
            <div class="timeline-body"><p>Glad that it worked. I'm not sure why because <code>CliTest</code> does use <code>add_filter</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-09-22 17:59</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mmlb">@mmlb</a> reviewed on 2025-09-22 18:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mmlb">@mmlb</a> on <code>crates/ty/tests/cli/python_environment.rs</code>:1934 on 2025-09-22 18:01</div>
            <div class="timeline-body"><p>Hmm looks like that worked for some reason...</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-09-22 18:01</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ty_project/src/metadata/options.rs</code>:313 on 2025-09-22 18:01</div>
            <div class="timeline-body"><p>I think we may still want to use <code>split_paths</code> here for:</p>
<blockquote>
<p>This also performs unquoting on Windows.</p>
</blockquote>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mmlb">@mmlb</a> on <code>crates/ty_project/src/metadata/options.rs</code>:313 on 2025-09-22 18:02</div>
            <div class="timeline-body"><p>Ah I didn't see that previously.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mmlb">@mmlb</a> reviewed on 2025-09-22 18:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/mmlb">@mmlb</a> reviewed on 2025-09-22 18:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/mmlb">@mmlb</a> on <code>crates/ty_project/src/metadata/options.rs</code>:313 on 2025-09-22 18:44</div>
            <div class="timeline-body"><p>So with that known, I'm thinking of going back to std::env::split_paths will that work for wasm (I think that's the only potential issue, LSP, Test, Memory Systems don't really influence here specifically)? I'll convert to SystemPath too.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review request for @carljm removed by @carljm on 2025-09-22 19:43</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/mmlb">@mmlb</a> on 2025-09-22 20:20</div>
            <div class="timeline-body"><p>Ok looks like CI is happy and I've gone back to std::env::split_paths with <code>SystemPath::from_std_path</code> to avoid allocating on valid utf8. If thats all good I'll squash the shouty commits into appropriate parent and re-push.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2025-09-23 08:23</div>
            <div class="timeline-body"><p>Thank you. This is great.</p>
<p>We squash the commits on merge. So there's no need on your end to squash the commits before merging.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-09-23 08:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-09-23 08:27</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-09-23 13:20</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:15:53 UTC
    </footer>
</body>
</html>
