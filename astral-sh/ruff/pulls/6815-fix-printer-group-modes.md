```yaml
number: 6815
title: Fix Printer group modes
type: pull_request
state: merged
author: MichaReiser
labels:
  - formatter
assignees: []
merged: true
base: main
head: fix-printer-group-modes
created_at: 2023-08-23T12:10:09Z
updated_at: 2023-08-24T10:14:12Z
url: https://github.com/astral-sh/ruff/pull/6815
synced_at: 2026-01-12T15:55:22Z
```

# Fix Printer group modes

---

_@MichaReiser_

<!--
Thank you for contributing to Ruff! To help us out with reviewing, please consider the following:

- Does this pull request include a summary of the change? (See below.)
- Does this pull request include a descriptive title?
- Does this pull request include references to any relevant issues?
-->

## Summary

This fixes a bug in the Printer where the mode for a group was stale when testing if some content fits. 

The input must have been of the form

```
group(1, 
	...
)
... (as long as no line break)
group(2, 
	if_group_breaks(2, text("()),
	...
)
```

What happened is:

* The printer measured if group 1 fits
	* The printer sees no line break up to group 2 and, therefore, starts measuring group 2
	* But the printer first writes that the group 2 is printed in `Expanded` mode to the `print_modes` state that is shared between printing and measuring
	* The printer return `Fits::No`, because the line ultimately doesn't fit, but it doesn't undo the written `group_modes[2] = Expand`
* The printer now tests if at least the group 2 fits
	* The `if_group_breaks` looks up the value of group `2` in `group_modes` which still contains the stale `Expand` entry (it breaks)
	* The printer, incorrectly assumes that it will have to print the `(`. It won't print the `(`, but it assumes the layout as if group 2 breaks when measuring if it fits
	* The printer decides that the group fits (when it shouldn't), and renders it in flat mode

This PR implements a fix by always writing `group_modes[group_id] = Flat` of the current group that should be measured. We already do this **after** measuring and inside of `fits_groups`. This only extends it to override any stale entry for the outermost group too. 

This seems to come at a performance cost because there's now one additional write for every group (and there are many!). What would be nice is if there's a cheap way to restore `group_modes` after measuring fits but that would require that the group ids in the document are monotonic. While it's true that group ids are always increasing, it isn't guaranteed that their groups are written in the same order as the ids have been created. 

I used the chance to remove the (last?) `unwrap` in the `Printer` by returning gan `Err` if a document uses a `group_id` that hasn't been seen to this point.



---

_Comment by @MichaReiser on 2023-08-23 12:10_

Current dependencies on/for this PR:
* main
  * **PR #6814** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6814" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a> 
    * **PR #6815** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6815" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a>  ðŸ‘ˆ
      * **PR #6816** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6816" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a> 
        * **PR #6817** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6817" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #6848** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6848" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a> 
          * **PR #6819** <a href="https://app.graphite.dev/github/pr/astral-sh/ruff/6819" target="_blank"><img src="https://static.graphite.dev/graphite-32x32.svg" alt="Graphite" width="10px" height="10px"/></a> 

This comment was auto-generated by [Graphite](https://app.graphite.dev/github/pr/astral-sh/ruff/6815?utm_source=stack-comment).

---

_Comment by @github-actions[bot] on 2023-08-23 12:43_

## PR Check Results
### Benchmark
#### Linux
```
group                                      main                                    pr
-----                                      ----                                    --
formatter/large/dataset.py                 1.00      4.2Â±0.13ms     9.7 MB/sec     1.00      4.2Â±0.21ms     9.7 MB/sec
formatter/numpy/ctypeslib.py               1.00   859.6Â±28.32Âµs    19.4 MB/sec     1.02   875.4Â±55.38Âµs    19.0 MB/sec
formatter/numpy/globals.py                 1.04     88.5Â±5.11Âµs    33.3 MB/sec     1.00     85.2Â±4.07Âµs    34.7 MB/sec
formatter/pydantic/types.py                1.00  1717.0Â±35.70Âµs    14.9 MB/sec     1.00  1710.8Â±69.81Âµs    14.9 MB/sec
linter/all-rules/large/dataset.py          1.02     13.0Â±0.41ms     3.1 MB/sec     1.00     12.7Â±0.56ms     3.2 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.3Â±0.09ms     5.1 MB/sec     1.04      3.4Â±0.11ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.00   484.6Â±13.25Âµs     6.1 MB/sec     1.01   487.5Â±21.99Âµs     6.1 MB/sec
linter/all-rules/pydantic/types.py         1.01      6.6Â±0.22ms     3.8 MB/sec     1.00      6.6Â±0.25ms     3.9 MB/sec
linter/default-rules/large/dataset.py      1.00      6.8Â±0.24ms     6.0 MB/sec     1.05      7.1Â±0.33ms     5.7 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1464.0Â±130.36Âµs    11.4 MB/sec    1.01  1478.6Â±49.64Âµs    11.3 MB/sec
linter/default-rules/numpy/globals.py      1.01    182.9Â±8.64Âµs    16.1 MB/sec     1.00    181.2Â±8.70Âµs    16.3 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.0Â±0.06ms     8.5 MB/sec     1.07      3.2Â±0.11ms     8.0 MB/sec
```

#### Windows
```
group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      4.8Â±0.21ms     8.5 MB/sec    1.01      4.8Â±0.23ms     8.5 MB/sec
formatter/numpy/ctypeslib.py               1.04   979.6Â±70.68Âµs    17.0 MB/sec    1.00   946.0Â±53.84Âµs    17.6 MB/sec
formatter/numpy/globals.py                 1.00     92.6Â±5.63Âµs    31.9 MB/sec    1.04    96.2Â±10.59Âµs    30.7 MB/sec
formatter/pydantic/types.py                1.00  1936.2Â±84.49Âµs    13.2 MB/sec    1.00  1934.1Â±100.69Âµs    13.2 MB/sec
linter/all-rules/large/dataset.py          1.00     15.9Â±0.61ms     2.6 MB/sec    1.00     15.9Â±0.54ms     2.6 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      4.4Â±0.18ms     3.8 MB/sec    1.00      4.4Â±0.16ms     3.8 MB/sec
linter/all-rules/numpy/globals.py          1.02   551.3Â±32.45Âµs     5.4 MB/sec    1.00   541.6Â±30.36Âµs     5.4 MB/sec
linter/all-rules/pydantic/types.py         1.00      8.2Â±0.29ms     3.1 MB/sec    1.01      8.3Â±0.38ms     3.1 MB/sec
linter/default-rules/large/dataset.py      1.04      9.2Â±0.66ms     4.4 MB/sec    1.00      8.8Â±0.39ms     4.6 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1883.2Â±74.42Âµs     8.8 MB/sec    1.01  1910.0Â±90.43Âµs     8.7 MB/sec
linter/default-rules/numpy/globals.py      1.00   232.6Â±36.87Âµs    12.7 MB/sec    1.01   235.3Â±13.48Âµs    12.5 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.9Â±0.14ms     6.6 MB/sec    1.05      4.1Â±0.23ms     6.3 MB/sec
```
<!-- thollander/actions-comment-pull-request "PR Check Results" -->

---

_Marked ready for review by @MichaReiser on 2023-08-23 13:53_

---

_Review requested from @charliermarsh by @MichaReiser on 2023-08-23 17:26_

---

_Label `formatter` added by @MichaReiser on 2023-08-23 17:26_

---

_Review comment by @charliermarsh on `crates/ruff_formatter/src/diagnostics.rs`:92 on 2023-08-23 21:44_

Nice

---

_@charliermarsh approved on 2023-08-23 21:48_

I'm out of my depth here as I've never grappled with the printer -- but I did spend 10 minutes or so reading the PR summary and the code.

---

_Merged by @MichaReiser on 2023-08-24 06:42_

---

_Closed by @MichaReiser on 2023-08-24 06:42_

---

_Branch deleted on 2023-08-24 06:43_

---
