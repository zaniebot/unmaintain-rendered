<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Default `src.root` to `['.', '&lt;project_name&gt;']` if the directory exists - astral-sh/ruff #18141</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Default <code>src.root</code> to <code>[&#x27;.&#x27;, &#x27;&lt;project_name&gt;&#x27;]</code> if the directory exists</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/18141">#18141</a>
        opened by <a href="https://github.com/MichaReiser">@MichaReiser</a>
        on 2025-05-16 17:56
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a></div>
            <div class="timeline-body">Summary
<p>I noticed in #18137 that we fail to resolve all imports for some ecosystem repositories because they don&#x27;t use the &quot;traditional&quot; src or flat layouts. Instead, they use a <code>src</code> layout but they use the project name instead of <code>src</code> for the &quot;src folder name&quot;.</p>
<p>An example is <code>psycopg</code> where all source files are in <code>psycopg/psycopg/_adapters_map.py:279:14</code></p>
<p>This PR extends our heuristics for <code>src.root</code> to recognize if a project has a <code>&lt;project&gt;/&lt;project&gt;</code> folder (and no <code>src</code> folder) and, if so, includes it in the <code>src.root</code>.</p>
<p>The motivation for this change is to support more projects with zero configuration.</p>
<p>I don&#x27;t have a good sense of how common this project layout is, but it seems worth supporting, given that multiple ecosystem projects use it. This also makes our mypy primer results significantely more useful :)</p>
Test plan
<p>See mypy primer results, added unit tests.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">configuration</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-16 17:57</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">ty</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-16 17:57</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-16 18:16</div>
            <div class="timeline-body"><p>and mypy primer hangs here too :( I wonder if it is just because of the too large diff. Any suggestions on how I could try this out?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-05-17 15:40</div>
            <div class="timeline-body">

<code>mypy_primer</code> results
<p>No ecosystem changes detected âœ…</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-17 16:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-17 16:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-17 16:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/sharkdp">@sharkdp</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-17 16:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/dcreager">@dcreager</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-17 16:15</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-17 16:28</div>
            <div class="timeline-body"><blockquote>
<ul>
<li>Found 797 diagnostics</li>
</ul>
<ul>
<li>Found 646 diagnostics</li>
</ul>
</blockquote>
<p>There are no other changes to mypy primer, so maybe it&#x27;s not worth changing the default just for one project. I&#x27;d be interested to hear from people with more knowledge of the Python ecosystem to hear how common this project structure is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-19 09:25</div>
            <div class="timeline-body"><p>I think we should fix this for this specific mypy primer project for now. We can consider changing our heuristics if this comes up more frequently.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-19 09:25</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-19 15:27</div>
            <div class="timeline-body"><p>This proposed change makes a lot of sense to me. The <code>src/</code> convention is encouraged by most common package managers, but it&#x27;s a fairly recent convention. Until relatively recently, it was very common to have the directory structure that this PR adds support for, and it&#x27;s still not uncommon for older projects.</p>
<p>I think we should also add <code>tests/</code> to the <code>src.root</code> default, as discussed in <a href="https://github.com/astral-sh/ty/issues/414">astral-sh/ty#414</a>#issuecomment-2886755988</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-05-19 15:35</div>
            <div class="timeline-body"><p>I also wouldn&#x27;t have any objection to resurrecting and landing this PR; it doesn&#x27;t seem to have any downside.</p>
<p>I&#x27;m not sure it&#x27;s necessary that we check that <code>&lt;project-name&gt;/&lt;project-name&gt;</code> exists, as this PR currently does? That is, it would be fine to do this simply if <code>&lt;project-name&gt;/</code> exists.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-19 15:36</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2025-05-19 15:38</div>
            <div class="timeline-body"><blockquote>
<p>I&#x27;m not sure it&#x27;s necessary that we check that <code>&lt;project-name&gt;/&lt;project-name&gt;</code> exists, as this PR currently does? That is, it would be fine to do this simply if <code>&lt;project-name&gt;/</code> exists.</p>
</blockquote>
<p>Never mind this, Alex pointed out that if just <code>&lt;project-name&gt;/</code> exists, it might be a flat layout, and we probably shouldn&#x27;t add the extra root in that case.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-19 15:47</div>
            <div class="timeline-body"><blockquote>
<p>I think we should also add tests/ to the src.root default, as discussed in <a href="https://github.com/astral-sh/ty/issues/414">astral-sh/ty#414</a>#issuecomment-2886755988</p>
</blockquote>
<p>I&#x27;m up for this but I suggest doing this in a separate PR. While related, it needs to apply to all layouts.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-05-19 15:50</div>
            <div class="timeline-body"><p>sounds good</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2025-05-19 15:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-19 16:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-05-19 16:11</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2025-05-19 16:11</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:14:35 UTC
    </footer>
</body>
</html>
