<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate one fix per statement for flake8-type-checking rules - astral-sh/ruff #4915</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>Generate one fix per statement for flake8-type-checking rules</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/4915">#4915</a>
        opened by <a href="https://github.com/charliermarsh">@charliermarsh</a>
        on 2023-06-07 03:01
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a></div>
            <div class="timeline-body">

Summary
<p>We have special-case handling for the unused imports diagnostic, whereby we generate one diagnostic per import member, but apply a unified fix on a per-statement basis. This strikes the balance between providing granular feedback in the LSP (i.e., being able to highlight individual members as unused), but allowing Code Actions to fix the entire statement in one pass.</p>
<p>This PR applies the same treatment to the flake8-type-checking rules. So, e.g., if you have <code>from pandas import Series, DataFrame</code> and both <code>Series</code> and <code>DataFrame</code> are only used in typing contexts, we&#x27;ll generate two diagnostics (one for each member), but those diagnostics will share a fix, and that fix will move <em>both</em> members.</p>
Test Plan
<p>Added some additional snapshots.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-07 03:01</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/konstin">@konstin</a> by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-07 03:01</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/pyflakes/rules/unused_import.rs</code>:240 on 2023-06-07 03:02</div>
            <div class="timeline-body"><p>I cleaned the implementation here up a bit, to use more of our modern conveniences (like <code>binding.trimmed_range</code>).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-07 03:02</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_type_checking/rules/runtime_import_in_type_checking_block.rs</code>:68 on 2023-06-07 03:05</div>
            <div class="timeline-body"><p>This, <code>typing_only_runtime_import</code>, and <code>unused_import</code> are structurally very similar. They all follow the same pattern:</p>
<ul>
<li>Iterate over individual imports, and group them by statement of origin.</li>
<li>Iterate over the statements, and generate a single fix for all imports (taking into account suppression comments).</li>
<li>Generate a diagnostic for each import in the statement, using that single fix.</li>
<li>(Generate a diagnostic for each suppressed violation, so that the suppression comments aren&#x27;t marked as unused.)</li>
</ul>
<p>A lot of the complexity comes from handling suppression comments, since we need the unified fix to omit those members that are suppressed, and we rarely do that kind of thing in lint rules (we typically leave suppression to the next phase).</p>
<p>Also, while these three files are structurally similar, there are a bunch of nuanced differences between them that make me not want to bother DRYing them up much further. For example, in the typing-only import rule, we have to not only group by statement, but also by import <em>type</em>, since a single import statement can contain imports of multiple types (e.g., <code>import os, pandas</code>), which means we need a fix for each import <em>type</em>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-07 03:05</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2023-06-07 03:23</div>
            <div class="timeline-body">PR Check Results
Ecosystem
<p>ℹ️ ecosystem check <strong>detected changes</strong>. (+5, -0, 0 error(s))</p>
disnake (+5, -0)
<p>

<pre><code>+ disnake/ext/commands/common_bot_base.py:35:12: TCH004 Move import `importlib.machinery` out of type-checking block. Import is used for more than type hinting.
+ tests/ext/commands/test_core.py:9:35: TCH004 Move import `typing_extensions.assert_type` out of type-checking block. Import is used for more than type hinting.
+ tests/ui/test_action_row.py:13:35: TCH004 Move import `typing_extensions.assert_type` out of type-checking block. Import is used for more than type hinting.
+ tests/ui/test_action_row.py:15:28: TCH004 Move import `disnake.ui.MessageUIComponent` out of type-checking block. Import is used for more than type hinting.
+ tests/ui/test_action_row.py:15:48: TCH004 Move import `disnake.ui.ModalUIComponent` out of type-checking block. Import is used for more than type hinting.
</code></pre>
</p>

Rules changed: 1

<p>| Rule | Changes | Additions | Removals |
| ---- | ------- | --------- | -------- |
| TCH004 | 5 | 5 | 0 |</p>
Benchmark
Linux
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      5.5±0.02ms     7.4 MB/sec    1.00      5.5±0.02ms     7.4 MB/sec
formatter/numpy/ctypeslib.py               1.02   1092.4±5.86µs    15.2 MB/sec    1.00   1075.0±1.42µs    15.5 MB/sec
formatter/numpy/globals.py                 1.04    124.3±0.40µs    23.7 MB/sec    1.00    119.7±0.19µs    24.6 MB/sec
formatter/pydantic/types.py                1.01      2.4±0.00ms    10.6 MB/sec    1.00      2.4±0.01ms    10.6 MB/sec
linter/all-rules/large/dataset.py          1.01     14.3±0.05ms     2.8 MB/sec    1.00     14.2±0.09ms     2.9 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.4±0.01ms     4.9 MB/sec    1.00      3.4±0.01ms     4.9 MB/sec
linter/all-rules/numpy/globals.py          1.00    416.2±0.63µs     7.1 MB/sec    1.00    417.9±4.11µs     7.1 MB/sec
linter/all-rules/pydantic/types.py         1.00      5.9±0.03ms     4.3 MB/sec    1.01      6.0±0.06ms     4.3 MB/sec
linter/default-rules/large/dataset.py      1.00      6.8±0.03ms     6.0 MB/sec    1.00      6.8±0.03ms     6.0 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.01   1460.5±1.78µs    11.4 MB/sec    1.00   1451.3±3.94µs    11.5 MB/sec
linter/default-rules/numpy/globals.py      1.01    162.8±0.26µs    18.1 MB/sec    1.00    161.4±0.76µs    18.3 MB/sec
linter/default-rules/pydantic/types.py     1.01      3.0±0.01ms     8.4 MB/sec    1.00      3.0±0.03ms     8.4 MB/sec
</code></pre>
Windows
<pre><code>group                                      main                                   pr
-----                                      ----                                   --
formatter/large/dataset.py                 1.00      5.9±0.08ms     6.8 MB/sec    1.00      6.0±0.07ms     6.8 MB/sec
formatter/numpy/ctypeslib.py               1.00  1145.8±32.68µs    14.5 MB/sec    1.00  1140.4±19.83µs    14.6 MB/sec
formatter/numpy/globals.py                 1.00    126.3±3.50µs    23.4 MB/sec    1.01    127.1±6.49µs    23.2 MB/sec
formatter/pydantic/types.py                1.00      2.6±0.06ms     9.8 MB/sec    1.00      2.6±0.05ms     9.8 MB/sec
linter/all-rules/large/dataset.py          1.00     14.8±0.17ms     2.8 MB/sec    1.00     14.8±0.15ms     2.8 MB/sec
linter/all-rules/numpy/ctypeslib.py        1.00      3.7±0.06ms     4.4 MB/sec    1.00      3.8±0.06ms     4.4 MB/sec
linter/all-rules/numpy/globals.py          1.01    439.3±9.18µs     6.7 MB/sec    1.00    435.6±6.53µs     6.8 MB/sec
linter/all-rules/pydantic/types.py         1.00      6.2±0.10ms     4.1 MB/sec    1.01      6.3±0.09ms     4.1 MB/sec
linter/default-rules/large/dataset.py      1.00      7.3±0.07ms     5.6 MB/sec    1.00      7.3±0.08ms     5.6 MB/sec
linter/default-rules/numpy/ctypeslib.py    1.00  1546.3±59.03µs    10.8 MB/sec    1.00  1551.7±25.40µs    10.7 MB/sec
linter/default-rules/numpy/globals.py      1.01    174.2±3.60µs    16.9 MB/sec    1.00    172.8±4.72µs    17.1 MB/sec
linter/default-rules/pydantic/types.py     1.00      3.3±0.04ms     7.7 MB/sec    1.01      3.3±0.05ms     7.6 MB/sec
</code></pre>


</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff/src/rules/flake8_type_checking/rules/runtime_import_in_type_checking_block.rs</code>:186 on 2023-06-07 11:44</div>
            <div class="timeline-body"><p>Is this like <code>List</code> in <code>from typing import List, Sequence</code>?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> approved on 2023-06-07 11:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/konstin">@konstin</a> reviewed on 2023-06-07 11:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/konstin">@konstin</a> on <code>crates/ruff/src/rules/flake8_type_checking/snapshots/ruff__rules__flake8_type_checking__tests__runtime-import-in-type-checking-block_TCH004_5.py.snap</code>:18 on 2023-06-07 11:52</div>
            <div class="timeline-body"><p>The is an unnecessary pass state; i&#x27;d expected it to be cleaned up by another rule but it seems there is no rule currently that detects extra <code>pass</code> statements? not sure if this is actionable for this PR tough</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-08 02:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_type_checking/snapshots/ruff__rules__flake8_type_checking__tests__runtime-import-in-type-checking-block_TCH004_5.py.snap</code>:18 on 2023-06-08 02:07</div>
            <div class="timeline-body"><p>We do have a rule that detects empty type-checking blocks, so this would be picked up from that at least.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2023-06-08 02:08</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff/src/rules/flake8_type_checking/rules/runtime_import_in_type_checking_block.rs</code>:186 on 2023-06-08 02:08</div>
            <div class="timeline-body"><p>Yeah, I&#x27;ll add a note.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-08 02:10</div>
            <div class="timeline-body"><p>I think the ecosystem CI checks must be stale -- I&#x27;ve checked multiple times locally, and I get those same results on main as on this branch. Perhaps the repo was updated between runs?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-08 02:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-08 02:22</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2023-06-08 02:22</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2023-06-13 02:17</div>
            <div class="timeline-body"><p>I think maybe this PR did it (?), but the following code, setting up a type alias:</p>
<pre><code>if typing.TYPE_CHECKING:
    import numpy.typing

    FloatArray = numpy.typing.NDArray[numpy.float64]
else:
    FloatArray = numpy.ndarray
</code></pre>
<p>Is now being flagged in 0.272, and wasn&#x27;t in 0.270.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-13 02:22</div>
            <div class="timeline-body"><p>Thanks, I&#x27;ll take a look.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-13 02:23</div>
            <div class="timeline-body"><p>Are you able to include a snippet to reproduce whatever you&#x27;re seeing? Or link me to the file?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2023-06-13 02:28</div>
            <div class="timeline-body"><p>Sure, it&#x27;s:</p>
<ul>
<li>PR: <a href="https://github.com/scikit-hep/vector/pull/352">scikit-hep/vector#352</a></li>
<li>CI: https://github.com/scikit-hep/vector/actions/runs/5250301792/jobs/9484106056?pr=352</li>
<li>Code: https://github.com/scikit-hep/vector/blob/8ca75f60e125c3b993da84b297f5636843e3210b/src/vector/_typeutils.py#L79-L84</li>
</ul>
<p>I&#x27;m not sure how the check is setup, but I could make the TypeAlias explicit if needed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-13 02:39</div>
            <div class="timeline-body"><p>It has to do with how we treat submodule imports. Generally, if you <code>import a</code> and <code>import a.b</code>, then if you use <code>a</code> at runtime, we don&#x27;t treat <code>a.b</code> usages as &quot;typing-only&quot; unless you enable the &quot;strict&quot; setting -- since <code>import a</code> typically imports <code>a.b</code> anyway.</p>
<p><code>numpy.typing</code> and a few other modules don&#x27;t behave this way. I honestly might just special-case them.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-13 02:39</div>
            <div class="timeline-body"><p>I don&#x27;t quite know the right language to describe it, but here&#x27;s the same issue in <code>importlib</code>: <a href="https://github.com/astral-sh/ruff/issues/3821">astral-sh/ruff#3821</a>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2023-06-13 02:42</div>
            <div class="timeline-body"><p>It&#x27;s somewhat common to have some typing-only code in a submodule (somewhat often called <code>*.typing</code>). The module above, <code>vector._typeutils</code>, is the same way (though really only intended for internal use).</p>
<p>What strict setting? I usually like strict settings. :)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-13 02:44</div>
            <div class="timeline-body"><p>Hah, I was thinking of https://beta.ruff.rs/docs/settings/#flake8-type-checking-strict, but it doesn&#x27;t actually fix your issue, let me look at it again.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on 2023-06-13 02:46</div>
            <div class="timeline-body"><p>This does fix the specific issue here:</p>
<pre><code>if typing.TYPE_CHECKING:
    import numpy.typing

    FloatArray = numpy.typing.NDArray[numpy.float64]
else:
    import numpy

    FloatArray = numpy.ndarray
</code></pre>
<p>In the end, I think it&#x27;s actually about the lack of branch analysis. Once we see the <code>import numpy.typing</code> in the <code>TYPE_CHECKING</code> block, we then attribute <code>FloatArray = numpy.ndarray</code> to <em>that</em> import, even though it&#x27;s in a different branch.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/henryiii">@henryiii</a> on 2023-06-13 13:19</div>
            <div class="timeline-body"><p>I applied that method to <code>vector</code>, and it&#x27;s passing. I&#x27;m fine with that for now, especially since that&#x27;s the only reason numpy is imported in this case, maybe it could be improved eventually.</p>
</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 18:54:18 UTC
    </footer>
</body>
</html>
