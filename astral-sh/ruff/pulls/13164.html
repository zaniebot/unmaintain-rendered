<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] implement basic call expression inference - astral-sh/ruff #13164</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] implement basic call expression inference</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/13164">#13164</a>
        opened by <a href="https://github.com/chriskrycho">@chriskrycho</a>
        on 2024-08-30 15:31
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/chriskrycho">@chriskrycho</a></div>
            <div class="timeline-body">Summary
<p>Adds basic support for inferring the type resulting from a call expression. This only works for the <em>result</em> of call expressions; it performs no inference on parameters. It also intentionally does nothing with class instantiation, <code>__call__</code> implementors, or lambdas.</p>
Test Plan
<p>Adds a test that it infers the right thing!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/carljm">@carljm</a> by <a href="https://github.com/chriskrycho">@chriskrycho</a> on 2024-08-30 15:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/chriskrycho">@chriskrycho</a> on 2024-08-30 15:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/chriskrycho">@chriskrycho</a> on 2024-08-30 15:31</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1752 on 2024-08-30 15:37</div>
            <div class="timeline-body"><p>We shouldn&#x27;t be matching on the syntactic form of <code>func</code> here; the inner match on the type of <code>func</code> should really be the only one here. And we don&#x27;t need to go digging into <code>self.types.expressions</code> for that type. <code>self.infer_expression(func)</code> already returns the inferred type for <code>func</code> (we just aren&#x27;t using it), and then we can just match on that type. It shouldn&#x27;t matter to us here whether <code>func</code> is a simple <code>Name</code>, or an attribute expression, or whatever else, those details are all handled by <code>infer_expression</code>; all that matters here is the type we infer for it.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1764 on 2024-08-30 15:38</div>
            <div class="timeline-body"><p>This second TODO shouldn&#x27;t be associated with <code>Type::Class</code>, rather it should go with an arm for <code>Type::Instance</code>, which is the type representing an instance of a class (as opposed to the class object itself, which <code>Type::Class</code> represents.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1758 on 2024-08-30 15:40</div>
            <div class="timeline-body"><p>I think we will want to follow the existing pattern of <code>Type::member</code> here, with something like <code>Type::call</code>, so this match on <code>Type</code> variants happens inside <code>Type</code> rather than in type inference (the code here would reduce to basically a one liner like <code>func_ty.call()</code>). The main reason for this is that the definition of <code>call</code> for unions and intersections (which doesn&#x27;t have to be implemented in this PR) will involve recursively calling <code>call</code> on the elements of the union/intersection.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1772 on 2024-08-30 15:43</div>
            <div class="timeline-body"><p>We shouldn&#x27;t use <code>todo!()</code> in cases we aren&#x27;t handling yet, because this will result in panics analyzing some code, which we want to avoid. (I think we are in fact seeing this in the benchmark failure here.) The pattern to use instead for things we don&#x27;t handle yet is <code>Type::Unknown</code> plus a <code>TODO</code> comment.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-08-30 15:45</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>‚úÖ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>‚úÖ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1774 on 2024-08-30 15:46</div>
            <div class="timeline-body"><p>There aren&#x27;t a ton of examples of this in the code yet, because we only recently gained the ability to emit diagnostics -- but we do have that ability now, and I think we should start actually emitting them where it is correct to do so. So here we should emit a diagnostic with the message <code>{type} is not callable</code>. (We could also add a TODO for that instead if you find it adds a lot of complexity for some reason, but I don&#x27;t think it should?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:2835 on 2024-08-30 15:47</div>
            <div class="timeline-body"><p>Fantastic, this is exciting to see happen! Unlocks so much new capability.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> requested changes on 2024-08-30 15:48</div>
            <div class="timeline-body"><p>Looks good! Some things we should adjust in the implementation.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/chriskrycho">@chriskrycho</a> reviewed on 2024-08-30 15:51</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/chriskrycho">@chriskrycho</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1772 on 2024-08-30 15:51</div>
            <div class="timeline-body"><p>Doh! I thought I‚Äôd updated all of those. Thank you. üëçüèº</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/chriskrycho">@chriskrycho</a> reviewed on 2024-08-30 15:52</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/chriskrycho">@chriskrycho</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1774 on 2024-08-30 15:52</div>
            <div class="timeline-body"><p>Ah, interesting ‚Äì from previous discussions with @AlexWaygood I was under the (mistaken! And I don‚Äôt blame Alex for this) impression that we deferred <em>all</em> handling of diagnostics to later in the pipeline. Will update. üëçüèº</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-08-30 15:53</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1768 on 2024-08-30 15:53</div>
            <div class="timeline-body"><p>Oh, I think we should also add an arm for <code>Type::Unknown =&gt; Type::Unknown</code>; that&#x27;ll be important to avoid tons of noise in the short term from the diagnostic I suggested adding below.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/chriskrycho">@chriskrycho</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1752 on 2024-08-30 15:54</div>
            <div class="timeline-body"><p>Ah, excellent. üíØ</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/chriskrycho">@chriskrycho</a> reviewed on 2024-08-30 15:54</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/chriskrycho">@chriskrycho</a> reviewed on 2024-08-30 15:57</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/chriskrycho">@chriskrycho</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1758 on 2024-08-30 15:57</div>
            <div class="timeline-body"><p>Ahhhh, that makes sense. üëçüèº Will move this over there!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-30 15:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/red_knot_python_semantic/src/types/infer.rs</code>:1774 on 2024-08-30 15:58</div>
            <div class="timeline-body"><p>I think it&#x27;s not a priority for us to emit comprehensive diagnosis for all typing errors right now, but I agree with @carljm that it makes sense to start emitting diagnostics where it makes sense to do so üëç it helps us see how things all fit together into a bigger picture</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:327 on 2024-08-30 17:51</div>
            <div class="timeline-body"><p>Let&#x27;s add a doc comment to this function, something like this:</p>
<pre><code>    /// Return the type resulting from calling an object of this type.
    ///
    /// Returns `None` if `self` is not a callable type.
    #[must_use]
    pub fn call(&amp;self, db: &amp;&#x27;db dyn Db) -&gt; Option&lt;Type&lt;&#x27;db&gt;&gt; {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> approved on 2024-08-30 17:53</div>
            <div class="timeline-body"><p>Awesome, thank you!!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-08-30 18:01</div>
            <div class="timeline-body"><p>Looks like we need to adjust the expected diagnostics in the benchmark.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/codspeed-hq[bot]">@codspeed-hq[bot]</a> on 2024-08-30 18:48</div>
            <div class="timeline-body"><a href="https://codspeed.io/astral-sh/ruff/branches/chriskrycho:rk-call-expression-inference">CodSpeed Performance Report</a>
Merging #13164 will <strong>degrade performances by 14.73%</strong>
<p>Comparing <code>chriskrycho:rk-call-expression-inference</code> (4c52a81) with <code>main</code> (a73bebc)</p>
Summary
<p><code>‚ùå 1 (üëÅ 1)</code> regressions
<code>‚úÖ 31</code> untouched benchmarks</p>
Benchmarks breakdown
<p>|     | Benchmark | <code>main</code> | <code>chriskrycho:rk-call-expression-inference</code> | Change |
| --- | --------- | ----------------------- | ------------------- | ------ |
| üëÅ | <code>red_knot_check_file[incremental]</code> | 2.4 ms | 2.8 ms | -14.73% |</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-08-30 19:02</div>
            <div class="timeline-body"><p>Looks like this CodSpeed regression is real, but it&#x27;s expected; we are now looking up the return type of every function called (and apparently doing it twice.) Fixing the double inference part should reduce the size of the regression somewhat.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:27 on 2024-08-30 19:03</div>
            <div class="timeline-body"><p>This feels like not-a-great error message for symbols with type <code>Unbound</code> specifically... but we can probably hone that later. (But maybe we should add a TODO somewhere?)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-30 19:03</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-08-30 19:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:27 on 2024-08-30 19:07</div>
            <div class="timeline-body"><p>I feel like until we are actually making a concerted effort to polish up our diagnostics across red-knot, it&#x27;s a little hard to know how we&#x27;d actually want to implement an improvement here, and thus where to even put the TODO. So I&#x27;m inclined to just leave this alone for now.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-08-30 19:14</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:27 on 2024-08-30 19:14</div>
            <div class="timeline-body"><p>(Especially considering I&#x27;m not 100% convinced that we&#x27;ll even keep <code>Type::Unbound</code> around.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-08-30 19:16</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/types.rs</code>:599 on 2024-08-30 19:16</div>
            <div class="timeline-body"><pre><code></code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-08-30 19:26</div>
            <div class="timeline-body"><p>On closer look, I think a lot of the regression (and why it shows up only in incremental benchmark) is that annotations are deferred in stubs, and now we look up a lot of return types from stubs, which causes us to trigger the <code>infer_deferred_types</code> query on a lot more function definitions, creating more memoized query results that Salsa has to re-validate in an incremental re-check. I still think this is expected and there&#x27;s not a lot we can do about it, short of finding ways to make Salsa more efficient on new revisions when there are a lot of ingredients to re-validate.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-08-30 19:36</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_benchmark/benches/red_knot.rs</code>:27 on 2024-08-30 19:36</div>
            <div class="timeline-body"><p>Fair enough! In general, usability is quite high priority for me, and I worry that this edge case might be harder to spot once our analysis improves (since I&#x27;m guessing the symbol in question here shouldn&#x27;t have <code>Type::Unbound</code> to begin with). But I see your point.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2024-08-30 19:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2024-08-30 19:51</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-08-30 21:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/dhruvmanila">@dhruvmanila</a> on 2024-09-05 15:27</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:06:25 UTC
    </footer>
</body>
</html>
