<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-pyi`] Various improvements to PYI034 - astral-sh/ruff #10807</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-pyi</code>] Various improvements to PYI034</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/10807">#10807</a>
        opened by <a href="https://github.com/AlexWaygood">@AlexWaygood</a>
        on 2024-04-06 21:33
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a></div>
            <div class="timeline-body"><h2>Summary</h2>
<p>Currently, the logic for PYI034 is pretty-much copied straight from the original Y034 implementation in flake8-pyi. As such, the implementation reflects the limited semantic analysis that flake8-pyi is capable of -- but Ruff, with its more sophisticated semantic model, can do better here.</p>
<p>Specific improvements made:</p>
<ul>
<li><code>is_metaclass</code> now recognises that subclasses of subclasses of <code>type</code>/<code>enum.EnumMeta</code>/<code>abc.ABCMeta</code> are also metaclasses. (The current logic only recognises direct subclasses of these subclasses as being metaclasses. Any metaclass should be excluded from PYI034, as PEP 673 specifies that no methods in metaclasses may use <code>Self</code> in annotations.)</li>
<li>Subclasses of subclasses of <code>Iterator[T]</code> are also flagged if their <code>__iter__</code> methods are annotated as returning <code>Iterator[T]</code> rather than <code>Self</code>. Currently only direct subclasses of <code>Iterator</code> are flagged.</li>
<li>Subclasses of subclasses of <code>AsyncIterator[T]</code> are also flagged if their <code>__aiter__</code> methods are annotated as returning <code>AsyncIterator[T]</code> rather than <code>Self</code>. Currently only direct subclasses of <code>AsyncIterator</code> are flagged.</li>
</ul>
<h2>Test Plan</h2>
<p><code>cargo test</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-04-06 21:46</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by @AlexWaygood on 2024-04-06 22:02</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-06 23:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/non_self_return_type.rs</code>:224 on 2024-04-06 23:11</div>
            <div class="timeline-body"><p>IIRC this will recursively resolve subclasses (within the file). I'm not sure if that's intended in those case or not given the bullet in your PR summary.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> approved on 2024-04-06 23:11</div>
            <div class="timeline-body"><p>Great!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2024-04-06 23:12</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/non_self_return_type.rs</code>:224 on 2024-04-06 23:12</div>
            <div class="timeline-body"><p>Superclasses rather than subclasses, right? ;)</p>
<p>But yup, that's what I want! Sorry if theh PR summary was unclear</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/non_self_return_type.rs</code>:224 on 2024-04-06 23:15</div>
            <div class="timeline-body"><p>Uhh yes superclasses.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-06 23:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/charliermarsh">@charliermarsh</a> reviewed on 2024-04-06 23:15</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/charliermarsh">@charliermarsh</a> on <code>crates/ruff_linter/src/rules/flake8_pyi/rules/non_self_return_type.rs</code>:224 on 2024-04-06 23:15</div>
            <div class="timeline-body"><p>Oh right, &quot;The current logic&quot; refers to <code>main</code>, not the current logic of <em>this</em> PR. Of course.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @AlexWaygood on 2024-04-06 23:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @AlexWaygood on 2024-04-06 23:15</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-04-06 23:15</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:03:36 UTC
    </footer>
</body>
</html>
