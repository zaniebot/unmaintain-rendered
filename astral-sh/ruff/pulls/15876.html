<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[`flake8-comprehensions`] Report and fix even when there are multiple iterables (`C417`) - astral-sh/ruff #15876</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[<code>flake8-comprehensions</code>] Report and fix even when there are multiple iterables (<code>C417</code>)</h1>

    <div class="meta">
        <span class="state-icon state-open"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15876">#15876</a>
        opened by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a>
        on 2025-02-02 00:47
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a></div>
            <div class="timeline-body">Summary
<p>Resolves #15809.</p>
<p>Calls with multiple iterables are now reported and fixed in preview mode. A new generator-based fix function is added. According to test results, it is compatible with the old one, now only used in non-preview.</p>
Test Plan
<p><code>cargo nextest run</code> and <code>cargo insta test</code>.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-02-02 00:50</div>
            <div class="timeline-body"><p>The first commit should only contain bugfix-related changes. The PR might still be too big, though; let me know if it needs splitting.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-02-02 00:54</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>‚úÖ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>‚ÑπÔ∏è ecosystem check <strong>detected linter changes</strong>. (+1 -0 violations, +0 -0 fixes in 1 projects; 54 projects unchanged)</p>
<a href="https://github.com/pandas-dev/pandas">pandas-dev/pandas</a> (+1 -0 violations, +0 -0 fixes)
<p>
<pre>ruff check --no-cache --exit-zero --ignore RUF9 --no-fix --output-format concise --preview</pre>
</p>
<p>

<pre>
+ <a href="https://github.com/pandas-dev/pandas/blob/5d9cf431f7b774a6724b1dd4c5e6f6fe95647aff/pandas/tests/io/test_html.py#L57">pandas/tests/io/test_html.py:57:9:</a> C417 Unnecessary `map()` usage (rewrite using a generator expression)
</pre>

</p>

Changes by rule (1 rules affected)
<p>

<p>| code | total | + violation | - violation | + fix | - fix |
| ---- | ------- | --------- | -------- | ----- | ---- |
| C417 | 1 | 1 | 0 | 0 | 0 |</p>
</p>


Formatter (stable)
<p>‚úÖ ecosystem check detected no format changes.</p>
Formatter (preview)
<p>‚úÖ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_comprehensions/fixes.rs</code>:854 on 2025-02-03 12:02</div>
            <div class="timeline-body"><p>theoretically we could try to import <code>builtins</code> and then use the fully qualified <code>builtins.zip</code> here if <code>zip</code> is shadowed. I don&#x27;t think it&#x27;s something for this PR, though, and it may not be worth the complexity to ever do it. Just a thought.</p>
<p>Also, a nitpick: I&#x27;d probably just say &quot;shadowed&quot; rather than &quot;overshadowed&quot;</p>
<pre><code>    } else {
        bail!(&quot;Cannot create fix: `zip` is shadowed locally&quot;);
    };
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_comprehensions/fixes.rs</code>:869 on 2025-02-03 12:04</div>
            <div class="timeline-body"><pre><code>        let mut elements: Vec&lt;Expr&gt; = parameters
            .posonlyargs
            .iter()
            .chain(&amp;parameters.args)
            .map(|parameter| {
                Expr::Name(ast::ExprName {
                    id: parameter.name().id.clone(),
                    ctx: ExprContext::Store,
                    range: TextRange::default(),
                })
            })
            .collect();
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_comprehensions/fixes.rs</code>:941 on 2025-02-03 12:13</div>
            <div class="timeline-body"><p>if we take the first branch here then we end up having to do two allocations: one to convert the argument to a <code>String</code> before passing it into the function, and another allocation in the <code>format!()</code> call. If we have the argument take <code>&amp;str</code> rather than <code>String</code>, we only have to do one allocation no matter which branch is taken:</p>
<pre><code>--- a/crates/ruff_linter/src/rules/flake8_comprehensions/fixes.rs
+++ b/crates/ruff_linter/src/rules/flake8_comprehensions/fixes.rs
@@ -933,11 +933,11 @@ pub(crate) fn fix_unnecessary_map_preview(
 
     let replacements: Vec&lt;String&gt; = match object_type {
         ObjectType::Dict =&gt; {
-            fn parenthesized_if_necessary(expr: &amp;Expr, as_str: String) -&gt; String {
+            fn parenthesized_if_necessary(expr: &amp;Expr, as_str: &amp;str) -&gt; String {
                 if expr.is_named_expr() {
                     format!(&quot;({as_str})&quot;)
                 } else {
-                    as_str
+                    as_str.to_string()
                 }
             }
 
@@ -957,8 +957,8 @@ pub(crate) fn fix_unnecessary_map_preview(
             let original_value = original_expr_in_source(value.into(), body.into());
 
             vec![
-                parenthesized_if_necessary(key, original_key.to_string()),
-                parenthesized_if_necessary(value, original_value.to_string()),
+                parenthesized_if_necessary(key, original_key),
+                parenthesized_if_necessary(value, original_value),
             ]
         }
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_comprehensions/fixes.rs</code>:978 on 2025-02-03 12:15</div>
            <div class="timeline-body"><p>Do we also need to check whether the grandparent expression is an f-string? And the great-grandparent? And the great-great-grandparent? (Etc.)</p>
<p>Iterating over <code>semantic.current_expressions()</code> and checking whether any of them are f-string expressions might be more robust, if so</p>
<p>https://github.com/astral-sh/ruff/blob/638186afbd571c1a618bbcf356dd0f50785370ca/crates/ruff_python_semantic/src/model.rs#L1273-L1280</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_comprehensions/fixes.rs</code>:984 on 2025-02-03 12:17</div>
            <div class="timeline-body"><p>I don&#x27;t feel like I fully understand why we need a regex here rather than using the <code>str::replacen</code> method https://doc.rust-lang.org/std/primitive.str.html#method.replacen</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_comprehensions/rules/unnecessary_map.rs</code>:183 on 2025-02-03 12:19</div>
            <div class="timeline-body"><p>This seems inefficient, because we have to resolve the qualified name multiple times. Something like this might be cheaper:</p>
<pre><code>    semantic
        .resolve_qualified_name(func)
        .is_some_and(|qualified_name| {
            matches!(
                qualified_name.segments(),
                [&quot;&quot; | &quot;buitins&quot;, &quot;list&quot; | &quot;set&quot; | &quot;dict&quot;]
            )
        })
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-03 12:19</div>
            <div class="timeline-body"><p>Some comments from briefly skimming through</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on <code>crates/ruff_linter/src/rules/flake8_comprehensions/fixes.rs</code>:984 on 2025-02-03 15:38</div>
            <div class="timeline-body"><p>The replacements are different depending on the indices. Replacing twice also doesn&#x27;t work, as the replacement might also contain <code>...</code>. There&#x27;s a testcase for this.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> reviewed on 2025-02-03 15:38</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/AlexWaygood">@AlexWaygood</a> reviewed on 2025-02-03 15:45</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on <code>crates/ruff_linter/src/rules/flake8_comprehensions/fixes.rs</code>:984 on 2025-02-03 15:45</div>
            <div class="timeline-body"><p>Could you add a comment to the source code explaining why <code>replacen</code> doesn&#x27;t work here? I think other people reading this code in the future might have the same question I did :-)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-04 10:28</div>
            <div class="timeline-body"><p>@AlexWaygood already started reviewing so I assume he&#x27;s fine leaving the PR as is?</p>
<p>I&#x27;m slightly leaning towards splitting the PR into a) bug fixes and b) preview behavior change. It has the advantage that it results in nicer changelog entries (and might be easier to review)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/AlexWaygood">@AlexWaygood</a> on 2025-02-04 10:33</div>
            <div class="timeline-body"><blockquote>
<p>@AlexWaygood already started reviewing so I assume he&#x27;s fine leaving the PR as is?
I&#x27;m slightly leaning towards splitting the PR into a) bug fixes and b) preview behavior change. It has the advantage that it results in nicer changelog entries (and might be easier to review)</p>
</blockquote>
<p>I only really skimmed; I haven&#x27;t done a proper review. Splitting it up sounds sensible to me too üëç</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-02-05 01:02</div>
            <div class="timeline-body"><p>Submitted #15955. I&#x27;ll rebase this one once that gets merged.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Converted to draft by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-05 08:03</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-05 08:04</div>
            <div class="timeline-body"><p>Thanks. I&#x27;ll convert this PR to draft in the meantime.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from &quot;[`flake8-comprehensions`] Detect overshadowed `list`/`set`/`dict`, ignore variadics and named expressions as well as report and fix even when there are multiple iterables (`C417`)&quot; to &quot;[`flake8-comprehensions`] Report and fix even when there are multiple iterables (`C417`)&quot; by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-02-07 21:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by <a href="https://github.com/InSyncWithFoo">@InSyncWithFoo</a> on 2025-02-07 21:23</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">rule</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-14 07:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">preview</span> added by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-02-14 07:45</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-11 08:52</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-17 07:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Reopened by <a href="https://github.com/MichaReiser">@MichaReiser</a> on 2025-03-17 07:50</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:11:02 UTC
    </footer>
</body>
</html>
