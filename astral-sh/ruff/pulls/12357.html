<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[red-knot] better docs for use-def maps - astral-sh/ruff #12357</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>[red-knot] better docs for use-def maps</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/12357">#12357</a>
        opened by <a href="https://github.com/carljm">@carljm</a>
        on 2024-07-17 06:42
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a></div>
            <div class="timeline-body"><p>Add better doc comments and comments, as well as one debug assertion, to use-def map building.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">red-knot</span> added by <a href="https://github.com/carljm">@carljm</a> on 2024-07-17 06:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/MichaReiser">@MichaReiser</a> by <a href="https://github.com/carljm">@carljm</a> on 2024-07-17 06:42</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Review requested from <a href="https://github.com/AlexWaygood">@AlexWaygood</a> by <a href="https://github.com/carljm">@carljm</a> on 2024-07-17 06:42</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/carljm">@carljm</a> on 2024-07-17 06:50</div>
            <div class="timeline-body"><p>Looks like something in docs build is failing here, I&#x27;ll look at that tomorrow. I can also try adding more links.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def.rs</code>:5 on 2024-07-17 07:07</div>
            <div class="timeline-body"><pre><code>//! ```python
</code></pre>
<p>Or Rust will run this as a doctest :laughing:</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2024-07-17 07:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def.rs</code>:33 on 2024-07-17 07:09</div>
            <div class="timeline-body"><pre><code>//! definition(s) is/are visible from that use. In [`AstIds`] we number all uses (that means a
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def.rs</code>:45 on 2024-07-17 07:11</div>
            <div class="timeline-body"><p>Doesn&#x27;t this apply to any compiler, regardless of whether it is query-based?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def.rs</code>:260 on 2024-07-17 07:17</div>
            <div class="timeline-body"><p>Nit</p>
<pre><code>            .resize(num_symbols, Definitions::unbound());
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def.rs</code>:246 on 2024-07-17 07:19</div>
            <div class="timeline-body"><p>I would call this <code>restore</code> or <code>rewind</code> rather than <code>set</code> to clarify that we&#x27;re returning to a previous state.</p>
<pre><code>    pub(super) fn restore(mut self, state: &amp;FlowSnapshot) {
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def.rs</code>:139 on 2024-07-17 07:30</div>
            <div class="timeline-body"><p>Just for myself: Another way to think about <code>all_definitions</code> is that it is the definitions arena.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def.rs</code>:302 on 2024-07-17 07:44</div>
            <div class="timeline-body"><p>I think it could be helpful to add a short code example of when each branch is possible.</p>
<p>To me it&#x27;s not clear when this branch can be taken. My intuition is that <code>current.definitions</code> is always shorter than the <code>state</code> we merge in? Is this to handle the case when merging multiple branches? Then each branch could add new definitions.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def.rs</code>:246 on 2024-07-17 07:46</div>
            <div class="timeline-body"><p>I suggest changing the method to take an owned <code>FlowSnapshot</code> (should it be called <code>state</code>?).</p>
<p>It pushes the responsibility for cloning the state to the caller. This is beneficial in this case because the code in the semantic index builder can avoid cloning in all cases except one (when iterating over the elif clauses).</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> approved on 2024-07-17 07:58</div>
            <div class="timeline-body"><p>Thanks. This documentation helped me a lot understanding what&#x27;s going on.</p>
<p>Regarding avoiding cloning the <code>definitions_by_symbol</code> on every snapshot. I don&#x27;t think what I propose below will work exactly like this and it&#x27;s not something we have to implement immediately:</p>
<p>The easiest option is to use an immutable vec for <code>definitions_by_symbol</code> because snapshoting is free at the cost of slightly more expensive writing (and reading)</p>
<p>Another alternative is to model the branching more explicitly.</p>
<ul>
<li>The <code>UseDefs</code> tracks an <code>IndexVec&lt;BranchId, Branch&gt;</code></li>
<li><code>Branch</code> has two fields: <code>parent: Option&lt;BranchId&gt;</code> and <code>local_definitions: FxHashMap&lt;ScopedSymbolId, Definitions&gt;</code></li>
<li>The <code>UseDefsBuilder</code> tracks the current <code>Branch</code>. <code>record_definition</code> writes a symbol to the global <code>definitions_by_symbol</code> if it is <code>None</code> and otherwise writes it into <code>branch.local_definitions</code>.</li>
<li>Merging a branch merges the <code>FxHashMap</code>s or merges the <code>FxHashMap</code> into the &quot;global&quot; <code>definitions_by_symbol</code>.</li>
</ul>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-17 20:58</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def.rs</code>:45 on 2024-07-17 20:58</div>
            <div class="timeline-body"><p>Yeah, especially any compiler that is trying to be incremental.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-17 21:07</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def.rs</code>:246 on 2024-07-17 21:07</div>
            <div class="timeline-body"><p>Yep, great point, fixed.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2024-07-17 21:22</div>
            <div class="timeline-body">

<code>ruff-ecosystem</code> results
Linter (stable)
<p>✅ ecosystem check detected no linter changes.</p>
Linter (preview)
<p>✅ ecosystem check detected no linter changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-18 00:20</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def.rs</code>:302 on 2024-07-18 00:20</div>
            <div class="timeline-body"><p>The choice of these branches isn&#x27;t impacted by which definition range is shorter or longer. It&#x27;s about their relative position. If they are adjacent, then we can easily merge them into one range. If they are not adjacent but one is already at the end of <code>all_definitions</code>, we can just copy the other one to the end, and now they are adjacent. If they are not adjacent and neither one is at the end, we have to copy both to the end to make them adjacent.</p>
<p>I don&#x27;t think there are any guarantees we can make about which of these cases are possible that couldn&#x27;t easily be violated when we add support for future branching constructs (or even change the implementation slightly for one of the current branching constructs.) It all depends on which order we merge things in.</p>
<p>In <a href="https://github.com/astral-sh/ruff/pull/12373">astral-sh/ruff#12373</a> for instance I make some efficiency improvements to if-statement visiting which change the order of restores and merges (in order to do fewer overall) and thus change which of these branches are taken for which specific code examples.</p>
<p>In that PR I also expand code coverage of inference examples so that it actually covers all of these branches, at least for now.</p>
<p>What might be ideal would be to have unit tests of this logic, independent of code examples, to verify at a lower level that all the cases here work correctly. But that seems moderately painful to do, since it would require manually creating a bunch of <code>Definition</code>s. I might play around with just how painful it is.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/carljm">@carljm</a> reviewed on 2024-07-18 00:50</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/carljm">@carljm</a> on <code>crates/red_knot_python_semantic/src/semantic_index/use_def.rs</code>:302 on 2024-07-18 00:50</div>
            <div class="timeline-body"><p>(But I don&#x27;t think comments in this code giving code samples per-branch would be helpful, since it depends on exactly how the visit is implemented, which is external to this code.)</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by <a href="https://github.com/carljm">@carljm</a> on 2024-07-18 00:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by <a href="https://github.com/carljm">@carljm</a> on 2024-07-18 00:50</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Branch deleted on 2024-07-18 00:51</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-20 19:05:17 UTC
    </footer>
</body>
</html>
