<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>better error messages while loading configuration `extend`s - astral-sh/ruff #15658</title>
    <link rel="stylesheet" href="../../../style.css">
</head>
<body>
    <div class="back-link">
        <a href="../../../index.html">Back to index</a>
    </div>

    <h1>better error messages while loading configuration <code>extend</code>s</h1>

    <div class="meta">
        <span class="state-icon state-merged"></span>
        <a href="https://github.com/astral-sh/ruff/pull/15658">#15658</a>
        opened by <a href="https://github.com/purajit">@purajit</a>
        on 2025-01-21 22:41
    </div>

    <div class="timeline">
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/purajit">@purajit</a></div>
            <div class="timeline-body"><p>Improves error messages during errors caused while extending a configuration using <code>extend</code>.</p>
<p>In the case of circular dependencies, it actually fixes the error too!</p>
<p>Old error messages:</p>
<pre><code># circular dependency - without even using pyproject.toml!
ruff failed
  Cause: Circular dependency detected in pyproject.toml

# file in &quot;extends&quot; doesn't exist
ruff failed
  Cause: Failed to read &lt;path&gt;/ruff4.toml
  Cause: No such file or directory (os error 2)
</code></pre>
<p>Now:</p>
<pre><code># circular dependency
ruff failed
  Cause: Circular dependency detected: &lt;path&gt;/ruff.toml -&gt; &lt;path&gt;/ruff2.toml -&gt; &lt;path&gt;/ruff3.toml -&gt; &lt;path&gt;/ruff.toml

# circular dependency with a single file!
ruff failed
  Cause: Circular dependency detected: &lt;path&gt;/ruff.toml -&gt; &lt;path&gt;/ruff.toml

# file in &quot;extends&quot; doesn't exist
ruff failed
  Cause: Failed to load last configuration in chain: &lt;path&gt;/ruff.toml -&gt; &lt;path&gt;/ruff2.toml -&gt; &lt;path&gt;/ruff3.toml -&gt; &lt;path&gt;/ruff4.toml
  Cause: Failed to read &lt;path&gt;/ruff4.toml
  Cause: No such file or directory (os error 2)
</code></pre>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Comment by <a href="https://github.com/github-actions[bot]">@github-actions[bot]</a> on 2025-01-21 22:49</div>
            <div class="timeline-body"><!-- generated-comment ecosystem -->

<h2><code>ruff-ecosystem</code> results</h2>
<h3>Linter (stable)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Linter (preview)</h3>
<p>✅ ecosystem check detected no linter changes.</p>
<h3>Formatter (stable)</h3>
<p>✅ ecosystem check detected no format changes.</p>
<h3>Formatter (preview)</h3>
<p>✅ ecosystem check detected no format changes.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Marked ready for review by @purajit on 2025-01-21 22:53</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Label <span class="label">cli</span> added by @MichaReiser on 2025-01-22 07:35</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:318 on 2025-01-22 07:44</div>
            <div class="timeline-body"><p>I find the wording here slightly confusing. It suggests that the path is inherited where it is the configuration.</p>
<p>I also think we should track the entire <code>stack</code> because the message is now inprecise in case there's a inheritance chain like <code>a -&gt; b -&gt; c</code> because the message only mentions that <code>b</code> extends <code>c</code> without mentioning <code>a</code>.</p>
<p>There are also other paths where this method returns an error (e.g. bail) where the inheritance chain will be missing.</p>
<p>That's why I suggest making the following changes:</p>
<ol>
<li>Store the path in the <code>stack</code> so that we get the entire inheritance chain instead of just the last</li>
<li>move the body of the while loop into a function (or lambda) to ensure we attach the context to all errors returned in the while loop</li>
<li>Change the error to <code>Failed to load configuration </code>{path}<code>: error ({chain})</code> where <code>chain</code> is only shown if the stack isn't empty (and it shows <code>a -&gt; b -&gt; c)</code></li>
</ol>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-01-22 07:44</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-01-22 07:45</div>
            <div class="timeline-body"><p>Nice, this is a great improvement. I've some suggestions on how we can improve the message further. It would probably also be good to add a CLI test for it, similar to what we have here</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/purajit">@purajit</a> reviewed on 2025-01-22 09:19</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/purajit">@purajit</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:318 on 2025-01-22 09:19</div>
            <div class="timeline-body"><p>Hmm in the case of <code>a -&gt; b -&gt; c</code>, if <code>c</code> doesn't exist, why do we care about <code>a</code>? Fixing the <code>extends</code> clause in <code>b</code> should be enough, and providing the full chain might be confusing vs just providing the file that caused the error, and which file tried to extend it. The meaning of the direction of the arrow could be confusing too.</p>
<p>However, down to make the changes and my opinion isn't too strong here. I'll take a stab tomorrow.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-01-22 13:46</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:318 on 2025-01-22 13:46</div>
            <div class="timeline-body"><p>That makes sense. I understood that the main motivation is that it's hard to understand why a file gets imported (how does Ruff end up with that given path and where can I change it). That's why I thought it's helpful if we show the entire inheritance chain over letting users guess how Ruff ended uploading that file, but it might go beyond of what the goal of this PR is.</p>
<p>I'm open to use anything other than <code>-&gt;</code> if you consider its meaning ambigious. We could also use <code>a</code> extends <code>b</code></p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/purajit">@purajit</a> reviewed on 2025-01-23 20:11</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/purajit">@purajit</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:318 on 2025-01-23 20:11</div>
            <div class="timeline-body"><p>Definitely makes sense! And like you said, would add context in several cases, including the cyclic one. Will try to have it updated soon!</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/MichaReiser">@MichaReiser</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:318 on 2025-01-23 20:13</div>
            <div class="timeline-body"><p>Thank you. I'll be out next week, so it might be a while before someone does a re-review.</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/MichaReiser">@MichaReiser</a> reviewed on 2025-01-23 20:13</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header"><a href="https://github.com/purajit">@purajit</a> reviewed on 2025-02-16 10:06</div>
            <div class="timeline-body"></div>
        </div>
        <div class="timeline-entry">
            <div class="timeline-header">Review comment by <a href="https://github.com/purajit">@purajit</a> on <code>crates/ruff_workspace/src/resolver.rs</code>:318 on 2025-02-16 10:06</div>
            <div class="timeline-body"><p>Sorry it took a while - updated the PR; since there are only two specific places where we return an error and they're slightly different, I just updated both. LMK if this makes sense.</p>
<p>I also added some tests, and the only issue with them right now is the final system error on Windows (vs unix). What do you think I should do for those? Add an insta filter for it? Conditionally compiled values?</p>
</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Renamed from "better error message when an inherited config path doesn't exist" to "better error messages while loading configuration `extend`s" by @purajit on 2025-02-16 10:31</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Merged by @MichaReiser on 2025-02-17 09:35</div>
        </div>
        <div class="timeline-entry">
            <div class="event">Closed by @MichaReiser on 2025-02-17 09:35</div>
        </div>
    </div>

    <footer>
        Synced at 2026-01-12 17:09:22 UTC
    </footer>
</body>
</html>
